<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lune Phone</title>
    <script src="https://cdn.jsdelivr.net/npm/pinyin@2.11.2/lib/web-pinyin.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/tiny-pinyin/1.3.2/tiny-pinyin.js"></script>
    <style>
        /* å¯¼å…¥é¡¶çº§è‰ºæœ¯å­—ä½“ï¼šCormorant Garamondï¼ˆæè‡´ä¼˜é›…ï¼‰å’Œ Dancing Scriptï¼ˆçµåŠ¨æ„å‘ï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;1,300&family=Dancing+Script:wght@500&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500&family=Great+Vibes&family=Cormorant+Garamond:ital,wght@1,500&display=swap');
        :root {
            /* èƒŒæ™¯ï¼šæ›´æ¸…é€çš„æå…‰è“ */
            --bg-gradient: linear-gradient(160deg, #a1fdd4 0%, #c2fbe5 100%);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.5);
            --blur: saturate(180%) blur(40px);
            --text-main: #1d1d1f;
            --text-sub: #555;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --font-zh-serif: 'Noto Serif SC', serif; /* ä¸­æ–‡å®‹ä½“ */
            --font-en-script: 'Great Vibes', cursive; /* è‹±æ–‡æ‰‹å†™ä½“ */
            --font-en-serif: 'Cormorant Garamond', serif; /* è‹±æ–‡è¡¬çº¿ä½“ */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            width: 100%; height: 100vh; overflow: hidden; 
            background: var(--bg-gradient); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
            display: flex; flex-direction: column;
        }

        /* 1. çŠ¶æ€æ  (å±‚çº§è°ƒåˆ°æœ€é«˜ï¼Œä¿è¯ App æ‰“å¼€æ—¶å®ƒè¿˜åœ¨æœ€ä¸Šé¢) */
        .status-bar {
            height: 48px; padding: 0 24px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--text-main); font-weight: 600; font-size: 15px; 
            z-index: 5000000; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šå±‚çº§æœ€é«˜ */
            position: relative; /* ç¡®ä¿ z-index ç”Ÿæ•ˆ */
        }
        .status-right { display: flex; align-items: center; gap: 6px; }
        .bat-text { font-size: 13px; font-weight: 700; margin-right: 4px; }
        .battery-box { width: 25px; height: 12px; border: 1.5px solid var(--text-main); border-radius: 3px; padding: 1px; position: relative; opacity: 0.8; }
        .bat-fill { height: 100%; background: var(--text-main); border-radius: 1px; width: 60%; }
        .bat-tip { position: absolute; right: -3px; top: 2.5px; width: 2px; height: 3px; background: var(--text-main); border-radius: 0 2px 2px 0; }

        /* 2. æ ¸å¿ƒå¸ƒå±€ */
        .main-container {
            flex: 1; 
            padding: 10px 22px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 2.3fr 1fr 0.7fr 1.1fr 1.1fr; 
            gap: 16px;
            align-items: center;
        }

        /* é€šç”¨å¡ç‰‡ */
        .widget {
            background: var(--glass);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        /* å¢åŠ ç»ç’ƒé«˜å…‰ï¼Œæ˜¾å¾—æ›´é«˜çº§ */
        .widget::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .w-2x2 { grid-column: span 2; }
        .w-4x1 { grid-column: span 4; }

        /* å¤©æ°”ç»„ä»¶ */
        .weather-content { display: flex; flex-direction: column; height: 100%; justify-content: space-between; position: relative; z-index: 2; }
        .w-date-block { display: flex; flex-direction: column; }
        .w-day { font-size: 11px; font-weight: 800; color: #ff3b30; text-transform: uppercase; margin-bottom: 2px; }
        .w-date { font-size: 13px; font-weight: 600; color: #555; text-transform: uppercase; }
        .w-icon-area { width: 60px; height: 60px; margin: 5px 0 0 -5px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .w-temp { font-size: 42px; font-weight: 800; color: #1d1d1f; line-height: 1; letter-spacing: -2px; }
        .w-city { font-size: 13px; font-weight: 600; color: #666; margin-top: 4px; display: flex; align-items: center; gap:4px; }

        /* å›¾ç‰‡ç»„ä»¶ */
        .pic-container { height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }
        .pic-text { font-size: 14px; font-weight: 700; font-style: italic; color: #222; margin-bottom: 10px; line-height: 1.3; }
        .pic-wrapper { flex: 1; width: 100%; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.05); position: relative; }
        .pic-img { width: 100%; height: 100%; object-fit: cover; }

        /* éŸ³ä¹ç»„ä»¶ */
        .music-row { display: flex; align-items: center; justify-content: space-between; height: 100%; position: relative; z-index: 2; }
        .album-cover { width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .track-info { display: flex; flex-direction: column; margin-left: 14px; margin-right: auto; justify-content: center; }
        .track-title { font-size: 15px; font-weight: 700; color: #1d1d1f; }
        .track-artist { font-size: 12px; color: #666; margin-top: 3px; }
        .ctrl-btns { display: flex; gap: 16px; align-items: center; flex-shrink: 0; opacity: 0.8; }

        /* === ä¿®å¤é‡ç‚¹ï¼šè¿›åº¦æ¡ === */
        .prog-stack { display: flex; flex-direction: column; justify-content: center; height: 100%; gap: 10px; position: relative; z-index: 2; }
        .prog-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: #444; text-transform: uppercase; }
        
        /* è½¨é“ï¼šæ·±è‰²åŠé€æ˜ï¼Œç¡®ä¿å¯¹æ¯”åº¦ */
        .prog-bg { 
            width: 100%; height: 14px; 
            background: rgba(0,0,0,0.15); 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        /* å¡«å……ï¼šçº¯ç™½ + å‘å…‰ */
        .prog-fg { 
            height: 100%; 
            min-height: 14px; /* å¼ºåˆ¶ç»™ä¸€ä¸ªå’Œçˆ¶å…ƒç´ ä¸€æ ·çš„é«˜åº¦ */
            background: #057b46; 
            width: 0%; 
            transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); 
            box-shadow: 0 0 15px rgba(255,255,255,0.8); /* å…³é”®ï¼šç™½è‰²å‘å…‰ */
            border-radius: 20px;
        }

        /* App å›¾æ ‡ - ä¼˜åŒ–è´¨æ„Ÿï¼Œå»é™¤å»‰ä»·å‘å…‰ */
        .app-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 8px; }
        .icon-shape { 
            width: 60px; height: 60px; border-radius: 16px; 
            background: rgba(255,255,255,0.85); 
            /* æ›´åƒå®ä½“ç»ç’ƒçš„é˜´å½± */
            box-shadow: 0 4px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,1);
            display: flex; align-items: center; justify-content: center; color: #333;
            backdrop-filter: blur(10px);
        }
        .app-name { font-size: 11px; font-weight: 600; color: #1d1d1f; text-shadow: 0 1px 1px rgba(255,255,255,0.5); }
        .svg-icon { width: 30px; height: 30px; fill: currentColor; }

        /* === ä¿®å¤é‡ç‚¹ï¼šDock & å°ç™½æ¡ === */
        .dock-container { 
            flex-shrink: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-end; 
            padding-bottom: 30px; /* ç»™å°ç™½æ¡ç•™ä½ç½® */
            position: relative; z-index: 50;
        }
        .dock-bar { 
            width: 90%; max-width: 380px; height: 85px; 
            background: rgba(255,255,255,0.01); 
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 42px; 
            display: flex; align-items: center; justify-content: space-evenly; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }
        .dock-app { width: 58px; height: 58px; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* å¼ºåˆ¶æ˜¾å½¢çš„å°ç™½æ¡ */
        .home-indicator { 
            position: absolute; 
            bottom: 8px; /* è·ç¦»åº•éƒ¨ 8px */
            left: 50%; transform: translateX(-50%);
            width: 135px; height: 5px; 
            background: #ffffff; /* çº¯ç™½ */
            border-radius: 10px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            z-index: 9999; /* æœ€é¡¶å±‚ */
            display: block !important;
        }

        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: flex-end; }
        .modal-content { width: 100%; background: #fff; border-radius: 36px 36px 0 0; padding: 25px; padding-bottom: 50px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from {transform:translateY(100%)} to {transform:translateY(0)} }
        .modal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-h1 { font-size: 18px; font-weight: 700; }
        .modal-done { color: #007AFF; font-weight: 700; cursor: pointer; }
        /* --- iOS åˆ†æ®µæ§åˆ¶å™¨æ ·å¼ --- */
.segment-control {
    display: flex;
    background: #eeeeef;
    padding: 3px;
    border-radius: 12px;
    margin-bottom: 15px;
}

.segment-btn {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #636366;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.segment-btn.active {
    background: #ffffff;
    color: #000000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.12);
}

/* --- è§†å›¾åˆ‡æ¢é€»è¾‘ --- */
.city-view {
    display: none; /* é»˜è®¤éšè— */
    animation: fadeIn 0.3s ease;
}

.city-view.active {
    display: block; /* æ¿€æ´»æ—¶æ˜¾ç¤º */
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
        .city-tag { padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; }
        .upload-tools { display: flex; gap: 10px; margin-top: 10px; }
        .tool-btn { flex: 1; padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; color: #007AFF; font-weight: 600; cursor: pointer; }


    /* --- App Window (å…¨å±åº”ç”¨æ¨¡å¼) --- */
.ios-app-window {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #F2F2F7; 
    z-index: 5000; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šæ¯”çŠ¶æ€æ ä½ï¼Œæ¯”æ¡Œé¢é«˜ */
    display: flex; flex-direction: column;
    transform: translateX(100%); 
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    padding-top: 48px; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šç»™çŠ¶æ€æ ç•™å‡ºä½ç½® */
}
.ios-app-window.active { transform: translateX(0); }

/* App Header */
.app-header {
    height: 60px; padding: 0 24px; 
    display: flex; align-items: center; justify-content: space-between;
    background: transparent; /* é€æ˜èƒŒæ™¯ï¼Œæ›´ç°ä»£ */
    flex-shrink: 0;
}
.header-title-big { 
    font-size: 32px; font-weight: 800; color: #000; letter-spacing: -0.5px; 
}
.header-close-btn {
    width: 36px; height: 36px; background: #e5e5ea; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #8e8e93; cursor: pointer;
    font-weight: 700; font-size: 14px;
}
.header-left { display: flex; align-items: center; color: #007AFF; font-size: 16px; cursor: pointer; }
.header-title { font-weight: 600; font-size: 16px; color: #000; }
.header-right { width: 60px; } /* å ä½ */

/* App Body */
.app-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
.app-title-large { font-size: 28px; font-weight: 800; color: #000; align-self: flex-start; margin-bottom: 10px; }

/* é¢„è§ˆæ¡† (æ‰‹æœºæ¯”ä¾‹) */
.preview-stage {
    width: 200px; height: 400px; 
    background: #fff; border-radius: 24px;
    /* é‡ç‚¹ï¼šå±…ä¸­å¸ƒå±€ï¼Œé˜²æ­¢å†…å®¹ä¹±è·‘ */
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    border: 8px solid #fff;
    margin-bottom: 30px;
    overflow: hidden;
    position: relative;
    flex-shrink: 0;
}
.phone-frame { width: 100%; height: 100%; position: relative; }
/* å…³é”®ï¼šé»˜è®¤å…¨éƒ¨éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
.phone-frame img, .phone-frame video { 
    width: 100%; height: 100%; object-fit: cover; display: none; 
}
.preview-placeholder {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: #999; font-weight: 600; font-size: 14px; width: 100%; text-align: center;
}

/* æŒ‰é’®ç»„ */
.action-area { width: 100%; display: flex; flex-direction: column; gap: 12px; }
.ios-btn {
    width: 100%; padding: 16px; border-radius: 14px; border: none;
    font-size: 16px; font-weight: 700; cursor: pointer;
    transition: transform 0.1s;
}
.ios-btn:active { transform: scale(0.98); }
.ios-btn.primary { background: #007AFF; color: #fff; }
.ios-btn.secondary { background: #fff; color: #007AFF; }

/* Toast æç¤º */
.ios-toast {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    background: rgba(25,25,25,0.8); backdrop-filter: blur(10px);
    color: #fff; padding: 20px 40px; border-radius: 20px;
    font-weight: 600; opacity: 0; pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 1000;
}
.ios-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

/* 4. å£çº¸å†å²è®°å½• (æ–°å¢æ ·å¼) */
.history-section { padding: 0 20px 40px 20px; width: 100%; }
.history-title { font-size: 18px; font-weight: 700; color: #000; margin: 30px 0 15px 0; }
.history-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
}
.history-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 9/16; background: #eee; cursor: pointer; }
.history-item.active { border-color: #007AFF; }
.history-item img { width: 100%; height: 100%; object-fit: cover; }
.vid-badge {
    position: absolute; top: 6px; right: 6px;
    background: rgba(0,0,0,0.6); color: #fff;
    font-size: 9px; font-weight: 800; padding: 2px 6px;
    border-radius: 4px; backdrop-filter: blur(4px);
    border: 0.5px solid rgba(255,255,255,0.3);
}
.history-del {
    position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
    background: rgba(255, 59, 48, 0.9); border-radius: 50%; color: #fff;
    display: flex; align-items: center; justify-content: center; font-size: 12px;
}
/* --- 3. iOS é£æ ¼æˆåŠŸå¼¹çª— (Alert) --- */
.ios-alert-mask {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
    z-index: 10000; /* æœ€é«˜å±‚çº§ */
    display: none; align-items: center; justify-content: center;
    animation: fadeIn 0.2s;
}
.ios-alert-box {
    width: 270px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
    border-radius: 14px; text-align: center; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: scale(1.1); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
.alert-title { font-size: 17px; font-weight: 700; margin: 20px 0 5px 0; color: #000; }
.alert-msg { font-size: 13px; color: #000; padding: 0 15px 20px 15px; line-height: 1.4; }
.alert-btn { 
    border-top: 0.5px solid rgba(60,60,67,0.29); 
    padding: 12px; color: #007AFF; font-size: 17px; font-weight: 600; cursor: pointer;
}
.alert-btn:active { background: rgba(0,0,0,0.05); }

@keyframes popIn { to { transform: scale(1); } }
/* --- è§’è‰²ä¹¦ä¸“ç”¨æ ·å¼ --- */

/* 1. è§’è‰²åˆ—è¡¨ç½‘æ ¼ */
.char-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
.char-card {
    background: #fff; border-radius: 16px; overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
    transition: transform 0.2s; cursor: pointer;
}
.char-card:active { transform: scale(0.96); }
.char-card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
.char-card-info { padding: 12px; }
.char-card-name { font-weight: 700; font-size: 15px; color: #000; margin-bottom: 4px; }
.char-card-desc { font-size: 11px; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* 2. è¯¦æƒ…é¡µè§†å›¾ (è¦†ç›–åœ¨åˆ—è¡¨ä¸Š) */
.char-detail-view {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 10; display: none; flex-direction: column; overflow-y: auto;
    animation: slideInRight 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes slideInRight { from {transform: translateX(100%);} to {transform: translateX(0);} }

/* é¡¶éƒ¨èƒŒæ™¯å›¾ */
.char-hero-bg {
    width: 100%; height: 240px; background-color: #ddd; background-size: cover; background-position: center;
    position: relative; flex-shrink: 0; cursor: pointer;
}
.bg-hint {
    position: absolute; bottom: 10px; right: 10px; 
    background: rgba(0,0,0,0.5); color: #fff; font-size: 10px; 
    padding: 4px 8px; border-radius: 12px; backdrop-filter: blur(4px);
}

/* å†…å®¹å®¹å™¨ (å¤„ç†å¤´åƒé‡å ) */
.char-content {
    background: #fff; flex: 1; border-radius: 24px 24px 0 0;
    margin-top: -30px; /* å…³é”®ï¼šè´Ÿè¾¹è·å®ç°é‡å  */
    position: relative; padding: 0 20px 40px 20px;
}

/* è¯¦æƒ…å¤´åƒ */
.char-avatar-container {
    width: 110px; height: 110px; /*ç¨å¾®æ”¹å¤§ä¸€ç‚¹ç‚¹æ›´éœ¸æ°”*/
    border-radius: 50%; 
    border: 4px solid #fff; 
    background: #fff;
    position: absolute; 
    top: -55px; /* ä¸Šæµ®è·ç¦» */
    
    /* ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šæ°´å¹³å±…ä¸­ä¸‡èƒ½å…¬å¼ */
    left: 50%;
    transform: translateX(-50%); 
    
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
    overflow: hidden;
    z-index: 5;
}
#detail-avatar { width: 100%; height: 100%; object-fit: cover; }

/* è¯¦æƒ…ä¿¡æ¯ */
.char-info-block { 
    margin-top: 65px; /* ç•™å‡ºå¤´åƒçš„ä½ç½® */
    display: flex; 
    flex-direction: column; 
    align-items: center; /* è®©åå­—ã€ç®€ä»‹ã€æŒ‰é’®å…¨éƒ¨å±…ä¸­ */
    text-align: center;  /* è®©æ–‡å­—å±…ä¸­å¯¹é½ */
}

.char-name { 
    font-size: 28px; 
    font-weight: 800; 
    color: #000; 
    margin-bottom: 12px; 
    letter-spacing: -0.5px;
}

.char-desc-preview {
    font-size: 15px; 
    line-height: 1.6; 
    color: #555; 
    background: #f2f2f7; 
    padding: 16px 20px; 
    border-radius: 18px;
    cursor: pointer;
    text-align: left; /* ç®€ä»‹å†…å®¹è¿˜æ˜¯é å·¦è¯»èµ·æ¥æ¯”è¾ƒèˆ’æœï¼Œæˆ–è€…æ”¹æˆ center ä¹Ÿå¯ä»¥ */
    width: 100%;      /* æ’‘æ»¡å®½åº¦ */
    max-width: 320px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå®½éš¾çœ‹ */
}

/* æŒ‰é’®ç»„å±…ä¸­ */
.char-actions { 
    display: flex; 
    gap: 12px; 
    margin-top: 30px; 
    width: 100%;
    justify-content: center; /* æŒ‰é’®æ°´å¹³å±…ä¸­ */
}

/* æ‚¬æµ®è¿”å›æŒ‰é’® */
.floating-back {
    position: absolute; top: 50px; left: 20px; width: 40px; height: 40px;
    background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; z-index: 20;
    color: #000;
}

/* 3. ä¸Šä¼ ç›¸å…³ */
.char-upload-circle {
    width: 80px; height: 80px; border-radius: 50%; background: #f2f2f7;
    display: flex; align-items: center; justify-content: center;
    color: #007AFF; font-weight: 600; cursor: pointer; overflow: hidden; position: relative;
}
#edit-avatar-preview { width: 100%; height: 100%; object-fit: cover; }

/* é€šç”¨è¾“å…¥æ¡† */
.ios-input {
    width: 100%; padding: 12px; background: #f2f2f7; border: none; border-radius: 10px;
    font-size: 16px; margin-bottom: 12px; font-family: inherit;
}

/* --- 4. åŸåˆ›é«˜çº§æ‚å¿—é£å¡ç‰‡ (Aesthetic Style) --- */
.aesthetic-card {
    width: 88%; max-width: 360px; height: 80vh;
    background: #fff; 
    border-radius: 32px; 
    position: relative; overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.5) inset;
    display: flex; flex-direction: column;
    animation: floatUp 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}

/* 1. é¡¶éƒ¨æ°›å›´åŒº */
.aes-hero {
    height: 180px; width: 100%; position: relative; flex-shrink: 0;
    overflow: hidden;
}
.aes-blur-bg {
    width: 120%; height: 120%; position: absolute; top: -10%; left: -10%;
    background-size: cover; background-position: center;
    filter: blur(40px) saturate(150%); opacity: 0.8;
}
.aes-noise {
    /* æ·»åŠ ä¸€ç‚¹æ‚è‰²é¢—ç²’æ„Ÿï¼Œå¢åŠ é«˜çº§çº¸è´¨æ„Ÿ */
    position: absolute; inset: 0; opacity: 0.08;
    background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIj48ZmlsdGVyIGlkPSJnoiPjGZlV1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=');
}
.aes-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,1) 100%);
}

/* 2. æ‚¬æµ®å†…å®¹åŒº */
.aes-float-content {
    margin-top: -60px; padding: 0 24px; position: relative; z-index: 2;
    display: flex; flex-direction: column; align-items: center; text-align: center;
}
.aes-avatar-box {
    width: 100px; height: 100px; border-radius: 28px; /* æ›´åŠ ç°ä»£çš„åœ†è§’çŸ©å½¢ */
    padding: 4px; background: #fff;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    transform: rotate(-3deg); /* å¾®å¾®å€¾æ–œï¼Œå¢åŠ è®¾è®¡æ„Ÿ */
    transition: transform 0.3s ease;
}
.aesthetic-card:hover .aes-avatar-box { transform: rotate(0deg) scale(1.05); }

.aes-avatar-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 24px; }

.aes-title-group { margin-top: 15px; margin-bottom: 20px; }
.aes-name { 
    font-family: -apple-system, serif; /* å°è¯•è¡¬çº¿ä½“å¢åŠ é«˜çº§æ„Ÿ */
    font-size: 24px; font-weight: 800; color: #111; letter-spacing: -0.5px; 
}
.aes-tag {
    display: inline-block; margin-top: 6px;
    font-size: 9px; font-weight: 700; letter-spacing: 2px; color: #999;
    border: 1px solid #eee; padding: 4px 10px; border-radius: 20px;
    text-transform: uppercase;
}

/* 3. æ–‡æœ¬æ»šåŠ¨åŒº */
.aes-scroll-area {
    flex: 1; overflow-y: auto; padding: 0 28px 20px 28px;
    -webkit-overflow-scrolling: touch;
    mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
}
.aes-scroll-area::-webkit-scrollbar { display: none; }

.aes-text-body {
    font-size: 15px; line-height: 1.8; color: #444; text-align: justify;
    font-weight: 400; white-space: pre-wrap;
}
.aes-divider { text-align: center; margin-top: 30px; color: #ddd; font-size: 12px; }

/* 4. åº•éƒ¨æ§åˆ¶æ  */
.aes-control-bar {
    padding: 20px 30px 30px 30px; display: flex; gap: 15px;
    background: #fff; z-index: 5;
}
.aes-btn {
    flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px; border-radius: 16px; font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
}
.aes-btn.edit { background: #f5f5f7; color: #333; }
.aes-btn.edit:active { background: #e5e5ea; transform: scale(0.98); }

.aes-btn.delete { background: #fff0f0; color: #ff3b30; }
.aes-btn.delete:active { background: #ffe5e5; transform: scale(0.98); }

@keyframes floatUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
/* --- æ–°å¢ï¼šé¡¶éƒ¨æ‚¬æµ®æŒ‰é’®æ ·å¼ --- */
.aes-top-bar {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 20px; display: flex; justify-content: space-between;
    z-index: 10; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç©ºç™½åŒºåŸŸ */
}

.aes-icon-circle {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,0.2); 
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer; pointer-events: auto; /* æ¢å¤æŒ‰é’®ç‚¹å‡» */
    transition: transform 0.2s, background 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.aes-icon-circle:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
.aes-icon-circle.close { background: rgba(0,0,0,0.15); } /* å…³é—­æŒ‰é’®ç¨å¾®æ·±ä¸€ç‚¹ */
/* --- è™šçº¿æ·»åŠ å¡ç‰‡æ ·å¼ --- */
.char-card.add-new {
    background: rgba(0,0,0,0.02);
    border: 2px dashed #ccc;
    box-shadow: none;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: #999;
    min-height: 200px; /* Ensure same height as others */
}
.char-card.add-new:active { background: rgba(0,0,0,0.05); border-color: #bbb; }

.add-icon-big {
    width: 40px; height: 40px; margin-bottom: 8px; opacity: 0.5;
}
.add-text { font-size: 14px; font-weight: 600; }
/* --- Settings App åˆ—è¡¨æ ·å¼ --- */
.ios-list-group {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.ios-list-item {
    display: flex; align-items: center;
    padding-left: 16px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s;
    height: 48px; /* æ ‡å‡† iOS åˆ—è¡¨é«˜åº¦ */
}
.ios-list-item:active { background: #f2f2f7; }

.item-icon {
    width: 28px; height: 28px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    margin-right: 12px; flex-shrink: 0;
}

.item-content {
    flex: 1; height: 100%;
    display: flex; align-items: center; justify-content: space-between;
    padding-right: 16px;
    border-bottom: 0.5px solid #c6c6c8; /* iOS ç»å…¸åˆ†å‰²çº¿ */
}

.item-label { font-size: 16px; color: #000; font-weight: 400; }

.item-right { display: flex; align-items: center; gap: 6px; }
.item-value { font-size: 16px; color: #8e8e93; }
.chevron { opacity: 0.5; }
/* --- Timezone Search Styles --- */
.ios-search-wrapper {
    background: rgba(118, 118, 128, 0.12); /* iOS æ ‡å‡†æœç´¢æ¡†åº•è‰² */
    border-radius: 10px;
    display: flex; align-items: center;
    padding: 15px 10px;
    transition: background 0.2s;
}
.ios-search-wrapper:focus-within {
    background: rgba(118, 118, 128, 0.18);
}

.search-icon {
    width: 16px; height: 16px; 
    stroke: #8e8e93; stroke-width: 2.5; fill: none;
    margin-right: 8px; flex-shrink: 0;
}

.ios-search-input {
    border: none; background: transparent; outline: none;
    font-size: 16px; color: #000; flex: 1; padding: 0;
    font-family: inherit;
}
.ios-search-input::placeholder { color: #8e8e93; }

/* åˆ—è¡¨æ ‡é¢˜æ ·å¼ */
.tz-group-title {
    padding: 0 16px; margin-bottom: 6px; margin-top: 24px;
    font-size: 12px; font-weight: 600; color: #6e6e73;
    text-transform: uppercase; letter-spacing: 0.5px;
}
/* --- ğŸš‘ ä¿®å¤æ—¶åŒºé¡µé¢æ‰“ä¸å¼€çš„é—®é¢˜ --- */
.ios-sub-page {
    /* é»˜è®¤è—åœ¨å³è¾¹ */
    transform: translateX(100%);
    /* æ·»åŠ ä¸æ»‘åŠ¨ç”» */
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
}

/* --- ğŸš‘ å¼ºåˆ¶ä¿®å¤æ—¶åŒºåˆ—è¡¨å®½åº¦ (è®©å®ƒæ’‘æ»¡å±å¹•) --- */

/* 1. æ ¸å¿ƒä¿®å¤ï¼šæŠŠå®¹å™¨çš„å¯¹é½æ–¹å¼ä»â€œå±…ä¸­â€æ”¹ä¸ºâ€œæ‹‰ä¼¸â€ */
#subpage-timezone .app-body {
    align-items: stretch !important; /* å…³é”®ï¼è®©å­å…ƒç´ æ¨ªå‘æ’‘æ»¡ */
    width: 100% !important;
    padding: 0 16px 80px 16px !important; /* å·¦å³ç•™ 16px çš„èˆ’é€‚è¾¹è· */
    box-sizing: border-box !important;
}

/* 2. ç¡®ä¿åˆ—è¡¨ç»„ä¹Ÿæ˜¯æ»¡å®½çš„ */
#subpage-timezone .ios-list-group {
    width: auto !important; /* è‡ªåŠ¨å¡«æ»¡çˆ¶å®¹å™¨ */
    margin-left: 0 !important;
    margin-right: 0 !important;
    border-radius: 12px !important; /* ä¿æŒåœ†è§’ */
}

/* 3. (å¯é€‰) å¦‚æœä½ è§‰å¾—æœç´¢æ¡†ä¹Ÿå¤ªçª„ï¼ŒåŠ ä¸Šè¿™ä¸ª */
#subpage-timezone .timezone-top-area {
    width: 100% !important;
}
/* --- ğŸš‘ ä¿®å¤æ—¶åŒºé€‰ä¸­å¯¹å‹¾ä¸æ˜¾ç¤ºçš„é—®é¢˜ --- */

/* 1. å®šä¹‰å¯¹å‹¾å®¹å™¨ */
#subpage-timezone .item-check {
    width: 20px; height: 20px;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s;
    
    /* ğŸ‘‡ æ ¸å¿ƒé­”æ³•ï¼šç›´æ¥ç”¨ CSS ç”»å‡ºè“è‰²å¯¹å‹¾èƒŒæ™¯ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23007AFF' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
}

/* 2. æ¿€æ´»æ—¶æ˜¾ç¤º */
#subpage-timezone .item-check.active {
    opacity: 1;
}

/* 3. éšè—åŸæœ¬ HTML é‡Œå¯èƒ½æ®‹ç•™çš„ SVG (é¿å…é‡å½±) */
#subpage-timezone .item-check svg {
    display: none !important;
}
/* =========================================================
   ğŸš‘ ç»ˆæå¼ºåˆ¶ä¿®å¤ï¼šAPI é¡µé¢ (ç»å¯¹å®šä½ç‰ˆ - å«æ–‡å­—é—´è·ä¿®å¤)
   ========================================================= */

/* 1. é¡µé¢å®¹å™¨ï¼šé“ºæ»¡å…¨å±ï¼Œå‰ªè£æº¢å‡º */
#subpage-api {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 20 !important;
    padding-top: 0 !important; /* æ¸…é™¤æ‰€æœ‰å†…è¾¹è·å¹²æ‰° */
    display: block !important; /* âŒ å¼ƒç”¨ Flexï¼Œæ”¹ç”¨å—çº§ */
}

/* 2. å¤´éƒ¨ï¼šé’‰æ­»åœ¨é¡¶éƒ¨ (0px - 110px) */
#subpage-api .app-header {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important;
    height: 110px !important; /* å›ºå®šé«˜åº¦ */
    
    padding-top: 55px !important; /* é¿å¼€åˆ˜æµ· */
    padding-bottom: 10px !important;
    box-sizing: border-box !important;
    
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    z-index: 50 !important;
    
    display: flex !important;
    align-items: flex-end !important;
}

/* 3. å†…å®¹åŒºï¼šé’‰æ­»åœ¨å‰©ä½™ç©ºé—´ (110px - åº•éƒ¨) - æ ¸å¿ƒæ»šåŠ¨åŒº */
#subpage-api .app-body {
    position: absolute !important;
    top: 110px !important;  /* ğŸ‘‡ ç´§æ¥å¤´éƒ¨ä¸‹æ–¹ */
    bottom: 0 !important;   /* ğŸ‘‡ ä¸€ç›´åˆ°åº• */
    left: 0 !important; right: 0 !important;
    
    height: auto !important; /* âŒ ç¦æ­¢å›ºå®šé«˜åº¦ */
    width: 100% !important;
    
    overflow-y: auto !important; /* âœ… å¼€å¯æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch !important; /* ä¸æ»‘æ»šåŠ¨ */
    
    padding: 20px 16px 80px 16px !important; /* åº•éƒ¨ç•™ç™½ç»™æŒ‰é’® */
    box-sizing: border-box !important;
    
    display: block !important; /* åˆ—è¡¨é¡¹è‡ªç„¶å †å  */
}

/* 4. ã€æ ¸å¿ƒä¿®å¤ã€‘ç»™åˆ—è¡¨è¡ŒåŠ å¼ºåˆ¶å†…è¾¹è·ï¼Œè§£å†³æ–‡å­—è´´è¾¹é—®é¢˜ */
#subpage-api .ios-list-item {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    
    /* ğŸ‘‡ è¿™é‡Œï¼å¼ºåˆ¶å·¦å³ç•™å‡º 16px çš„å‘¼å¸ç©ºé—´ */
    padding-left: 16px !important; 
    padding-right: 16px !important; 
    
    box-sizing: border-box !important;
}

/* é’ˆå¯¹è¾“å…¥æ¡†è¡Œçš„ç‰¹æ®Šå¤„ç† */
#subpage-api .input-item {
    /* ç»§æ‰¿ä¸Šé¢çš„ paddingï¼Œä½†å¼ºåˆ¶å¯¹é½ */
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
}

#subpage-api .ios-input-clean {
    text-align: right !important; /* iOS é£æ ¼å³å¯¹é½ */
    width: 60% !important; /* å¼ºåˆ¶å å®½ */
    background: transparent !important;
    border: none !important;
    color: #007AFF !important;
    padding-right: 0 !important; /* è¾“å…¥æ¡†å†…éƒ¨ä¸ç”¨å†paddingäº†ï¼Œå› ä¸ºçˆ¶å…ƒç´ æœ‰äº† */
}

/* 5. ç¡®ä¿åˆ—è¡¨ç»„å®½åº¦æ­£å¸¸ */
#subpage-api .ios-list-group {
    width: 100% !important;
    margin: 0 0 20px 0 !important;
}

/* 6. ä¿®å¤åº•éƒ¨çº¢è‰²æŒ‰é’® */
#subpage-api .ios-btn {
    width: 100% !important;
    display: block !important;
    margin: 20px 0 40px 0 !important; /* åº•éƒ¨å¤šç•™ç‚¹ç©º */
}
/* =========================================================
   ğŸ’„ API é¡µé¢ï¼šç»†èŠ‚ç²¾ä¿®ä¸ä¸‹æ‹‰èœå•ç¾åŒ–
   ========================================================= */

/* 1. ä¿®å¤æ–‡å­—è´´è¾¹ (ç»™æ•´ä¸ªåˆ—è¡¨è¡ŒåŠ â€œå‘¼å¸ç©ºé—´â€) */
#subpage-api .ios-list-item {
    padding-right: 20px !important; /* å³è¾¹å¼ºåˆ¶ç•™å‡º 20px ç©ºéš™ */
    padding-left: 16px !important;
}

/* 2. ä¿®å¤è¾“å…¥æ¡† (å»é™¤è‡ªåŠ¨å¡«å……çš„è“è‰²èƒŒæ™¯ï¼Œå³å¯¹é½) */
#subpage-api .ios-input-clean {
    text-align: right !important;
    padding-right: 0 !important; /* è¾“å…¥æ¡†å†…éƒ¨ä¸ç”¨ç•™ç©ºï¼Œå› ä¸ºçˆ¶å…ƒç´ ç•™äº† */
    color: #007AFF !important;
    background: transparent !important;
    /* ğŸ‘‡ æš´åŠ›å»é™¤æµè§ˆå™¨è‡ªåŠ¨å¡«å……çš„åº•è‰² */
    box-shadow: 0 0 0px 1000px #fff inset !important; 
    -webkit-text-fill-color: #007AFF !important;
}

/* =========================================================
   ğŸ’„ ä¿®å¤ï¼šæ¨¡å‹é€‰æ‹©ä¸‹æ‹‰èœå• (å®Œç¾ä¼ªè£…æˆ iOS æŒ‰é’®)
   ========================================================= */

/* 1. åˆ—è¡¨é¡¹å®¹å™¨ï¼šè®¾ç½®ç›¸å¯¹å®šä½ï¼Œä¸ºäº†æ”¾ç®­å¤´ */
#subpage-api .ios-list-group .ios-list-item:has(select) {
    position: relative !important;
    overflow: hidden !important; /* é˜²æ­¢è¶…å‡º */
}

/* 2. æ ¸å¿ƒï¼šæŠŠ Select å½»åº•é€æ˜åŒ–ï¼Œåªä¿ç•™æ–‡å­— */
#subpage-api select.ios-input-clean {
    /* æŠ¹é™¤æµè§ˆå™¨æ‰€æœ‰é»˜è®¤æ ·å¼ */
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    
    /* èƒŒæ™¯é€æ˜ï¼Œæ— è¾¹æ¡† */
    background-color: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    
    /* å°ºå¯¸ä¸å¯¹é½ */
    width: 100% !important;
    height: 100% !important;
    
    /* ğŸ‘‡ å…³é”®ï¼šè®©æ–‡å­—å¼ºåˆ¶é å³ï¼Œå¹¶ä¸”ç•™å‡ºç®­å¤´çš„ä½ç½® */
    text-align: right !important;
    text-align-last: right !important; /* å…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ */
    direction: ltr !important; /* ä¿æŒä»å·¦åˆ°å³é˜…è¯»ï¼Œé˜²æ­¢æ–‡å­—åè½¬ */
    padding-right: 25px !important; /* å³è¾¹ç•™ç©ºç»™ç®­å¤´ */
    padding-left: 0 !important;
    
    /* å­—ä½“æ ·å¼ */
    color: #007AFF !important; /* iOS è“ */
    font-size: 16px !important;
    font-weight: 500 !important;
    font-family: inherit !important;
    
    /* å±‚çº§ */
    position: relative;
    z-index: 2; /* ä¿è¯èƒ½ç‚¹åˆ° */
    cursor: pointer;
}

/* 3. è‡ªå®šä¹‰ç®­å¤´ (ç”»ä¸€ä¸ªæ¼‚äº®çš„ç°è‰²å°ç®­å¤´) */
#subpage-api .ios-list-group .ios-list-item:has(select)::after {
    content: '' !important;
    position: absolute !important;
    right: 16px !important; /* è·ç¦»å³è¾¹ç¼˜ 16px */
    top: 50% !important;
    
    width: 7px !important;
    height: 7px !important;
    
    /* ç°è‰²çº¿æ¡ */
    border-top: 2px solid #C7C7CC !important;
    border-right: 2px solid #C7C7CC !important;
    
    /* æ—‹è½¬ 45 åº¦å˜æˆç®­å¤´ */
    transform: translateY(-50%) rotate(45deg) !important;
    pointer-events: none !important; /* è®©ç‚¹å‡»ç©¿é€è¿‡å» */
    z-index: 1 !important;
}

/* 4. ä¿®å¤ï¼šé˜²æ­¢é€‰ä¸­æ—¶å‡ºç°ä¸‘é™‹çš„è“è‰²èƒŒæ™¯/é»‘æ¡† */
#subpage-api select.ios-input-clean:focus {
    outline: none !important;
    background-color: transparent !important;
}
/* --- ğŸ’„ iOS åº•éƒ¨èœå• (Action Sheet) æ ·å¼ --- */
.ios-action-sheet {
    width: 96%; 
    max-width: 400px;
    margin-bottom: 12px; /* ç¦»åº•éƒ¨çš„è·ç¦» */
    display: flex; flex-direction: column;
    animation: slideUpSheet 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* æ ‡é¢˜åŒº */
.sheet-title-box {
    background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
    color: #8e8e93; font-size: 13px; font-weight: 600; text-align: center;
    padding: 14px; border-bottom: 0.5px solid rgba(0,0,0,0.1);
    border-radius: 14px 14px 0 0;
}

/* é€‰é¡¹æŒ‰é’® */
.sheet-item {
    background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
    padding: 18px; text-align: center; color: #007AFF; font-size: 17px;
    border-bottom: 0.5px solid rgba(0,0,0,0.1); cursor: pointer;
}
.sheet-item:active { background: rgba(255,255,255,0.5); }
.sheet-item:last-child { border-radius: 0 0 14px 14px; border-bottom: none; }

/* å–æ¶ˆæŒ‰é’® */
.sheet-cancel {
    margin-top: 8px; background: white; border-radius: 14px;
    padding: 16px; text-align: center; font-weight: 600; color: #007AFF; 
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/* =========================================================
   ğŸšï¸ æ»‘åŠ¨æ¡ç»ˆæç¾åŒ– (iOS åŸç”Ÿé£æ ¼)
   ========================================================= */

/* 1. æ»‘åŠ¨æ¡æœ¬ä½“ (è½¨é“) */
#subpage-api .ios-slider {
    -webkit-appearance: none !important; /* æ¸…é™¤é»˜è®¤ä¸‘æ ·å¼ */
    appearance: none !important;
    
    width: 100% !important;    /* ğŸ“ é•¿åº¦ï¼šå¼ºåˆ¶æ’‘æ»¡ï¼ */
    height: 4px !important;    /* é«˜åº¦ï¼šiOS æ ‡å‡†ç»†è½¨é“ */
    
    /* åŠ¨æ€èƒŒæ™¯ï¼šåˆ©ç”¨ CSS å˜é‡å®ç° å·¦è“å³ç° */
    background: linear-gradient(to right, #007AFF 0%, #007AFF var(--percent, 50%), #E5E5EA var(--percent, 50%), #E5E5EA 100%) !important;
    
    border-radius: 2px;
    outline: none;
    margin: 10px 0 0 0 !important; /* è°ƒæ•´é—´è· */
    display: block;
    padding: 0 !important;
    cursor: pointer;
}

/* 2. æ»‘å—å¤´ (é‚£ä¸ªç™½è‰²åœ†çƒ) */
#subpage-api .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    
    height: 28px !important; 
    width: 28px !important;    /* iOS æ ‡å‡†å¤§åœ†çƒ */
    border-radius: 50%;
    
    background: #FFFFFF !important; /* çº¯ç™½ */
    
    /* âœ¨ çµé­‚é˜´å½±ï¼šè®©å®ƒæµ®èµ·æ¥ */
    box-shadow: 0 3px 7px rgba(0,0,0,0.3), 0 0 0 0.5px rgba(0,0,0,0.05) !important;
    
    margin-top: -12px !important; /* å‚ç›´å±…ä¸­ä¿®æ­£: (4 - 28) / 2 = -12 */
    position: relative;
    z-index: 2;
    transition: transform 0.1s;
}

/* æŒ‰ä¸‹æ—¶ç¨å¾®å˜å¤§ */
#subpage-api .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.1);
}
/* =========================================================
   ğŸ’¬ èŠå¤©æµ‹è¯•åŒºç¾åŒ– (iMessage é£æ ¼)
   ========================================================= */

/* 1. èŠå¤©è®°å½•æ˜¾ç¤ºæ¡† */
.chat-log-area {
    background: #ffffff;
    border-radius: 12px;
    padding: 15px;
    height: 160px; /*ç¨å¾®åŠ é«˜ä¸€ç‚¹*/
    overflow-y: auto;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.03);
    -webkit-overflow-scrolling: touch;
    font-size: 14px;
}

/* 2. åº•éƒ¨è¾“å…¥æ å®¹å™¨ */
.chat-input-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

/* 3. è¾“å…¥æ¡† (ç°è‰²èƒ¶å›Š) */
.chat-input-field {
    flex: 1;
    height: 44px;
    background: #E5E5EA; /* iOS ç°è‰²åº• */
    border-radius: 22px; /* èƒ¶å›Šåœ†è§’ */
    border: none;
    padding: 0 18px;
    font-size: 16px;
    color: #000;
    outline: none;
    transition: background 0.2s;
    
    /* ä¿®å¤ä¹‹å‰çš„å¼ºåˆ¶å³å¯¹é½ï¼Œè¿™é‡Œéœ€è¦å·¦å¯¹é½ */
    text-align: left !important; 
    box-shadow: none !important;
}
.chat-input-field:focus {
    background: #D1D1D6; /* èšç„¦æ—¶ç¨å¾®å˜æ·± */
}

/* 4. å‘é€æŒ‰é’® (è“è‰²åœ†å½¢) */
.chat-send-btn {
    width: 44px; height: 44px;
    background: #007AFF;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0,122,255,0.3);
    transition: transform 0.1s;
}
.chat-send-btn:active {
    transform: scale(0.9);
}
/* =========================================================
   ğŸ¯ æ–‡å­—é¢œè‰²ç²¾å‡†é’©å­ (ä»…é’ˆå¯¹æ–‡æœ¬ï¼Œä¸å½±å“å¸ƒå±€)
   ========================================================= */

/* --- 1. æ¡Œé¢ä¸“å±é¢œè‰²é’©å­ --- */
/* çŠ¶æ€æ æ—¶é—´ã€ç™¾åˆ†æ¯”ã€ç”µé‡å›¾æ ‡ã€APPåã€å¤©æ°”æ–‡å­— */
.status-bar, 
.status-bar *, 
.app-name, 
.dock-bar .app-name,
.weather-content .w-day,
.weather-content .w-date,
.weather-content .w-temp,
.weather-content .w-city {
    color: var(--dynamic-desktop-color, #1d1d1f) !important;
    fill: var(--dynamic-desktop-color, #1d1d1f) !important;
}

/* --- 2. APP å†…éƒ¨ä¸“å±é¢œè‰²ä¸å­—ä½“é’©å­ --- */
/* è®¾ç½®åˆ—è¡¨ã€APIé…ç½®ã€èŠå¤©è®°å½•ã€è§’è‰²è¯¦æƒ… */
#settingsApp, 
#settingsApp .item-label, 
#settingsApp .item-value,
.chat-log-area,
.char-detail-view .char-name,
.char-detail-view .char-desc-preview {
    color: var(--dynamic-app-color, #1d1d1f) !important;
    /* åªæœ‰åœ¨è¿™äº›åœ°æ–¹æ‰åº”ç”¨åŠ¨æ€å­—ä½“å’Œå­—å· */
    font-family: var(--dynamic-font-family, inherit) !important;
    font-size: var(--dynamic-app-size, inherit) !important;
    font-weight: var(--dynamic-app-weight, inherit) !important;
}

/* --- 3. é¢„è§ˆåŒºç‹¬ç«‹æ ·å¼ (ç¡®ä¿é¢„è§ˆå’Œè®¾ç½®æ—¶ä¸€è‡´) --- */
#preview-text-main {
    color: var(--temp-app-color, #1d1d1f);
}
#preview-text-desktop {
    color: var(--temp-desktop-color, #1d1d1f);
}
/* è®©è°ƒè‰²ç›˜ input å˜åœ† */
.color-picker-circle {
    -webkit-appearance: none;
    appearance: none;
    border: none;
    width: 34px; height: 34px;
    border-radius: 50%;
    overflow: hidden;
    padding: 0;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 2px solid #fff;
    background: transparent;
}
.color-picker-circle::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker-circle::-webkit-color-swatch { border: none; border-radius: 50%; }
/* å¼ºè¡Œéš”ç¦»æ‰€æœ‰å­é¡µé¢ï¼Œç¡®ä¿å®ƒä»¬é»˜è®¤ä¸æ˜¾ç¤ºåœ¨æ¡Œé¢ä¸Š */
.ios-sub-page {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 100 !important;
    transform: translateX(100%); /* åˆå§‹çŠ¶æ€åœ¨å³è¾¹ */
    transition: transform 0.3s ease;
    display: flex !important; /* ä¿æŒå†…éƒ¨å¸ƒå±€ */
    flex-direction: column !important;
}

.ios-sub-page.active {
    transform: translateX(0) !important; /* æ¿€æ´»æ—¶æ»‘å…¥ */
}

/* ä¿æŠ¤æ¡Œé¢ç½‘æ ¼ä¸è¢«æ’‘å¤§ */
.main-container .app-name, .status-bar span {
    font-size: 11px !important;
    height: auto !important;
}
/* =========================================================
   ğŸ”¥ ç»ˆæé˜²å¾¡ï¼šå¼ºåˆ¶å­é¡µé¢æ»šåŠ¨ä¸å®Œæ•´æ¸²æŸ“
   ========================================================= */

/* 1. å­é¡µé¢å®¹å™¨ï¼šå¿…é¡»æ˜¯å›ºå®šé«˜åº¦ï¼Œä¸èƒ½æº¢å‡º */
#subpage-display {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 100 !important;
    display: flex !important;
    flex-direction: column !important; /* çºµå‘æ’åˆ—å¤´éƒ¨å’Œä¸»ä½“ */
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    padding: 0 !important;
    margin: 0 !important;
    box-sizing: border-box !important;
}

#subpage-display.active { transform: translateX(0) !important; }

/* 2. å¤´éƒ¨ï¼šé«˜åº¦å›ºå®š */
#subpage-display .app-header {
    flex-shrink: 0 !important; /* ç¦æ­¢è¢«å‹ç¼© */
    height: 110px !important;
    padding: 55px 16px 12px 16px !important;
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: flex-end !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. æ ¸å¿ƒï¼šå¼ºåˆ¶ä¸»ä½“åŒºåŸŸå æ®å‰©ä½™ç©ºé—´å¹¶å¼€å¯æ»šåŠ¨ */
#subpage-display .app-body {
    flex: 1 !important; /* å…³é”®ï¼šè‡ªåŠ¨å æ®å¤´éƒ¨ä»¥å¤–çš„æ‰€æœ‰é«˜åº¦ */
    overflow-y: auto !important; /* å…³é”®ï¼šå¼ºåˆ¶å¼€å¯æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch !important; /* ç§»åŠ¨ç«¯ä¸æ»‘ */
    padding: 20px 16px 120px 16px !important; /* åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«å°ç™½æ¡æŒ¡ä½ */
    display: block !important; /* æ¢å¤å—çº§æµï¼Œè®©åˆ—è¡¨æ­£å¸¸å †å  */
    box-sizing: border-box !important;
}

/* 4. ä¿®å¤åˆ—è¡¨é¡¹å¯¹é½ */
.color-item-row {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    min-height: 50px !important;
}
/* =========================================================
   ğŸšï¸ å­—ä½“é¡µæ»‘å—ï¼šç»ˆæç¾åŒ–ä¸å…¨å®½ä¿®å¤
   ========================================================= */

/* 1. å¼ºåˆ¶æ»‘å—è½¨é“æ’‘æ»¡ 100% å®½åº¦ */
#subpage-display .ios-slider {
    -webkit-appearance: none !important;
    appearance: none !important;
    width: 100% !important;   /* ğŸ‘ˆ è§£å†³ä½ è¯´çš„é•¿åº¦ä¸å¯¹ï¼Œå¿…é¡» 100% */
    height: 4px !important;    /* iOS ç»†è½¨é“ */
    border-radius: 2px !important;
    outline: none !important;
    margin: 15px 0 !important; /* ä¸Šä¸‹ç•™ç‚¹ç©ºï¼Œåˆ«æŒ¤ç€å­— */
    cursor: pointer !important;
    
    /* æ ¸å¿ƒï¼šåŠ¨æ€èƒŒæ™¯é€»è¾‘ */
    background: linear-gradient(to right, #007AFF 0%, #007AFF var(--percent, 50%), #E5E5EA var(--percent, 50%), #E5E5EA 100%) !important;
}

/* 2. é‚£ä¸ªç™½è‰²å¤§åœ†å¤´ */
#subpage-display .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    height: 28px !important; 
    width: 28px !important;
    background: #FFFFFF !important;
    border-radius: 50% !important;
    /* iOS çµé­‚é˜´å½± */
    box-shadow: 0 3px 8px rgba(0,0,0,0.2), 0 0 0 0.5px rgba(0,0,0,0.05) !important;
    cursor: pointer !important;
    margin-top: -12px !important; /* å±…ä¸­å¯¹é½è½¨é“ */
    transition: transform 0.1s !important;
}

#subpage-display .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.1) !important;
}

/* å…¼å®¹ Firefox */
#subpage-display .ios-slider::-moz-range-thumb {
    height: 28px; width: 28px; background: #fff; border-radius: 50%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2); border: none;
}
/* =========================================================
   ğŸš¨ ç»ˆæç‰©ç†ä¿®å¤ï¼šInstructions å¤´éƒ¨é‡å ä¸å­—ä½“åŒæ­¥
   ========================================================= */

/* 1. å¼ºåˆ¶é¡µé¢å®¹å™¨é«˜åº¦ä¸èƒŒæ™¯ */
#subpage-instructions {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important; /* é“ºæ»¡åº•è‰² */
    display: flex !important;
    flex-direction: column !important;
    z-index: 100 !important; /* ç¡®ä¿åœ¨æ¡Œé¢ä¹‹ä¸Š */
}

/* 2. å¤´éƒ¨ï¼šç‰©ç†é¡¶å¼€çŠ¶æ€æ  */
#subpage-instructions .app-header {
    flex-shrink: 0 !important;
    /* ğŸ‘‡ å…³é”®ï¼špadding-top å¿…é¡»è¶³å¤Ÿå¤§ï¼Œç‰©ç†é¿å¼€çŠ¶æ€æ  */
    padding: 60px 16px 12px 16px !important; 
    height: auto !important; /* è®© padding æ’‘å¼€é«˜åº¦ */
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. å­—ä½“åŒæ­¥é’©å­ */
#subpage-instructions .app-body {
    flex: 1 !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    padding: 20px 16px 100px 16px !important;
    
    /* ğŸ‘‡ æ ¸å¿ƒï¼šå¼ºåˆ¶åŒæ­¥ä½ è®¾ç½®çš„å­—ä½“å’Œé¢œè‰² */
    font-family: var(--dynamic-font-family, inherit) !important;
    color: var(--dynamic-app-color, #1d1d1f) !important;
}

/* 4. åˆ—è¡¨æ ‡ç­¾åŒæ­¥å­—å· */
#subpage-instructions .item-label {
    font-size: var(--dynamic-app-size, 17px) !important;
    font-weight: var(--dynamic-app-weight, 600) !important;
}

/* 5. ç¡®ä¿çŠ¶æ€æ æ°¸è¿œåœ¨æœ€æœ€æœ€é¡¶å±‚ */
.status-bar {
    z-index: 9999 !important;
}
/* =========================================================
   ğŸš¨ ç‰©ç†é”æ­»ï¼šInstructions é¡µé¢ (è§£å†³ç¼©æ°´ã€æ–­å±‚ã€é‡å )
   ========================================================= */

/* 1. å¼ºåˆ¶é¡µé¢å®¹å™¨é“ºæ»¡æ•´ä¸ªå±å¹•ï¼ŒèƒŒæ™¯å¿…é¡»è¿è´¯ */
#subpage-instructions {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important; /* æ ¸å¿ƒï¼šç¡®ä¿èƒŒæ™¯ä¸ç¢è£‚ */
    display: flex !important;
    flex-direction: column !important;
    z-index: 5000 !important; /* ä¿è¯åœ¨è®¾ç½®é¡µæœ€é¡¶å±‚ */
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
}

#subpage-instructions.active {
    transform: translateX(0) !important;
}

/* 2. å¤´éƒ¨ç¾åŒ–ï¼šå½»åº•é¿å¼€çŠ¶æ€æ ï¼Œæ¨ªå‘æ’‘æ»¡ */
#subpage-instructions .app-header {
    flex-shrink: 0 !important;
    width: 100% !important;
    padding: 60px 16px 12px 16px !important; /* 60px ç‰©ç†é¿å¼€çŠ¶æ€æ  */
    background: rgba(242, 242, 247, 0.9) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. æ»šåŠ¨ä¸»ä½“ï¼šå¼ºåˆ¶å æ® 100% å®½åº¦ï¼Œæ–‡å­—åŒæ­¥è®¾ç½® */
#subpage-instructions .app-body {
    flex: 1 !important;
    width: 100% !important; /* ğŸ‘ˆ è§£å†³ç¼©æ°´å…³é”® */
    overflow-y: auto !important;
    padding: 20px 16px 120px 16px !important;
    box-sizing: border-box !important;
    display: block !important; /* æ¢å¤åˆ—è¡¨å †å æµ */
    
    /* ğŸ”´ åŒæ­¥ä½ çš„å­—ä½“è®¾ç½®å˜é‡ */
    font-family: var(--dynamic-font-family, inherit) !important;
    color: var(--dynamic-app-color, #1d1d1f) !important;
}

/* 4. åˆ—è¡¨ç»„ç¾åŒ–ï¼šç¡®ä¿å®ƒä¸æ˜¯ä¸€ä¸ªå°æ–¹å— */
#subpage-instructions .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 12px !important;
    margin: 0 0 20px 0 !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
}

#subpage-instructions .ios-list-item {
    width: 100% !important;
    height: 64px !important;
    display: flex !important;
    align-items: center !important;
    padding-left: 16px !important;
    box-sizing: border-box !important;
}

/* 5. åˆ—è¡¨æ–‡å­—ï¼šå¼ºåˆ¶åŒæ­¥å­—å· */
#subpage-instructions .item-label {
    font-size: var(--dynamic-app-size, 17px) !important;
    font-weight: var(--dynamic-app-weight, 600) !important;
    margin-left: 14px !important;
}

/* 6. çŠ¶æ€æ å±‚çº§ä¿æŠ¤ */
.status-bar {
    z-index: 9999 !important;
    pointer-events: none !important; /* è®©ç‚¹å‡»ç©¿é€åˆ°ä¸‹é¢çš„ Back æŒ‰é’® */
}
/* =========================================================
   ğŸš¨ æ—¶åŒºé¡µä¸“åœºä¿®å¤ï¼šè§£å†³å®½åº¦ç¼©æ°´ã€èƒŒæ™¯æ–­å±‚ã€å›½å®¶æ¶ˆå¤±
   ========================================================= */

/* 1. å¼ºåŠ›é”æ­»å­é¡µé¢å®¹å™¨ï¼Œç¡®ä¿ 100% å®½åº¦ */
#subpage-timezone {
    width: 100% !important;
    max-width: none !important;
    left: 0 !important;
    padding: 0 !important;
}

/* 2. å¼ºåŠ›ä¿®å¤ app-body å¸ƒå±€ */
#subpage-timezone .app-body {
    display: block !important; /* âŒ ç¦æ­¢ Flexï¼Œé˜²æ­¢å†…å®¹è¢«æ¨ªå‘æŒ¤å‹ */
    width: 100% !important;
    height: auto !important;
    min-height: 100% !important;
    padding: 20px 16px 120px 16px !important; /* ç•™å‡ºè¶³å¤Ÿçš„åº•éƒ¨ç©ºé—´ */
    background: #F2F2F7 !important; /* å¼ºåˆ¶èƒŒæ™¯è‰²é“ºæ»¡ */
    box-sizing: border-box !important;
}

/* 3. å¼ºåŠ›ä¿®å¤åˆ—è¡¨ç»„å®½åº¦ */
#subpage-timezone .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 12px !important;
    margin-bottom: 25px !important;
    display: block !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
}

/* 4. ä¿®å¤æœç´¢æ¡†å®½åº¦ */
.ios-search-wrapper {
    width: 100% !important;
}

/* 5. ä¿®å¤å›½å®¶é¡¹æ¸²æŸ“é«˜åº¦ */
#subpage-timezone .ios-list-item {
    width: 100% !important;
    min-height: 48px !important;
    display: flex !important;
    align-items: center !important;
    padding: 0 16px !important;
}
/* =========================================================
   ğŸš¨ å¤´éƒ¨ç»ˆæé¿è®©è¡¥ä¸ (è§£å†³ 17:43 é‡å é—®é¢˜)
   ========================================================= */

/* 1. ç»Ÿä¸€æ‰€æœ‰å­é¡µé¢çš„å®¹å™¨èƒŒæ™¯å’Œå±‚çº§ */
.ios-sub-page {
    background: #F2F2F7 !important;
    z-index: 5000 !important;
}

/* 2. å¼ºåŠ›é¡¶å¼€å¤´éƒ¨ï¼šå°†é—´è·ä» 60px å¢åŠ åˆ° 80pxï¼Œå¹¶åŠ æ·±èƒŒæ™¯ */
.ios-sub-page .app-header {
    height: auto !important;
    min-height: 100px !important; /* å¼ºåˆ¶ä¿åº•é«˜åº¦ */
    /* ğŸ‘‡ å…³é”®ï¼š80px ç‰©ç†é¡¶å¼€ï¼Œç»å¯¹ä¸ä¼šå†ç¢°åˆ° 17:43 */
    padding: 80px 16px 15px 16px !important; 
    background: rgba(242, 242, 247, 0.98) !important; /* å‡ ä¹ä¸é€æ˜ï¼Œå®Œå…¨æŒ¡ä½åé¢å†…å®¹ */
    backdrop-filter: blur(25px) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
}

/* 3. ä¿®æ­£ Back æŒ‰é’®å¯¹é½ */
.ios-sub-page .header-left-btn, 
.ios-sub-page .app-header div[onclick*="closeSubPage"] {
    display: flex !important;
    align-items: center !important;
    line-height: 1 !important;
}

/* 4. çŠ¶æ€æ å±‚çº§ä¿æŠ¤ï¼šè®©çŠ¶æ€æ æ–‡å­—æ°¸è¿œåœ¨æœ€å‰ï¼Œä½†èƒŒæ™¯é€æ˜ */
.status-bar {
    z-index: 9999 !important;
    background: transparent !important;
    pointer-events: none !important; /* ç¡®ä¿èƒ½ç‚¹åˆ°ä¸‹é¢çš„ Back æŒ‰é’® */
}
/* --- è¯´æ˜ä¹¦å›¾æ ‡ï¼šåŒæ­¥æ¡Œé¢ App æ ·å¼ --- */
.ins-app-icon-sync {
    width: 60px !important;  /* åŒæ­¥æ¡Œé¢å°ºå¯¸ */
    height: 60px !important;
    border-radius: 16px !important; /* åŒæ­¥æ¡Œé¢åœ†è§’ */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    /* æ ¸å¿ƒé˜´å½±ï¼šå¢åŠ ç«‹ä½“ç»ç’ƒæ„Ÿ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 1px rgba(255,255,255,0.8) !important;
    position: relative;
    overflow: hidden;
}

/* ç»Ÿä¸€åˆ—è¡¨è¡Œçš„é«˜åº¦ï¼Œé€‚åº”æ›´å¤§çš„å›¾æ ‡ */
#subpage-instructions .ios-list-item {
    height: 85px !important; 
    padding: 0 16px !important;
}

/* è°ƒæ•´æ–‡å­—é—´è· */
#subpage-instructions .item-label {
    margin-left: 18px !important;
    font-size: 18px !important;
    font-weight: 700 !important;
}
/* --- Ins é£æ ¼é«˜çº§å¡ç‰‡ --- */
.ins-fancy-card {
    width: 85%;
    max-width: 340px;
    /* --- ä¿®æ”¹è¿™é‡Œ --- */
    max-height: 80vh !important; /* é™åˆ¶æ•´ä¸ªå¡ç‰‡æœ€é«˜åªå å±å¹•çš„ 80% */
    display: flex !important;    /* å¿…é¡»å¼€å¯ flexï¼Œå¦åˆ™å†…éƒ¨æ— æ³•æ­£ç¡®æ’‘å¼€æ»šåŠ¨ */
    flex-direction: column !important;
    /* ---------------- */
    background: #ffffff;
    border-radius: 32px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.12);
    overflow: hidden;
    animation: insPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
}

@keyframes insPop {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* é¡¶éƒ¨ç‚¹ç‚¹ä¸æ ‡ç­¾ */
.ins-card-nav {
    padding: 20px 24px 10px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.ins-close-dot {
    width: 12px; height: 12px;
    background: #FF5F57; border-radius: 50%; cursor: pointer;
}
.ins-brand-tag {
    font-size: 10px; letter-spacing: 2px; font-weight: 800; color: #d1d1d6;
}

/* æ¸å˜è£…é¥°å¤´å›¾ */
.ins-card-hero {
    height: 120px; position: relative; margin: 0 24px;
    border-radius: 20px; overflow: hidden;
}
.ins-hero-bg { width: 100%; height: 100%; opacity: 0.8; }
.ins-hero-icon {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
}

/* æ–‡å­—æ’ç‰ˆ */
.ins-card-body { padding: 24px; text-align: center; }
.ins-title-serif {
    font-family: "Times New Roman", Times, serif; /* ç»å…¸çš„è¡¬çº¿ä½“æå‡è´¨æ„Ÿ */
    font-size: 26px; font-weight: 500; color: #1d1d1f; margin-bottom: 4px;
}
.ins-subtitle {
    font-size: 12px; color: #86868b; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 20px;
}
.ins-divider-line {
    width: 40px; height: 1px; background: #eee; margin: 0 auto 20px auto;
}

/* åŠŸèƒ½é¡¹ */
.ins-feature-list { text-align: left; margin-bottom: 30px; }
.ins-feat-item { display: flex; gap: 15px; margin-bottom: 18px; align-items: flex-start; }
.feat-num {
    font-family: serif; font-style: italic; color: #d1d1d6; font-size: 18px;
}
.feat-text strong { display: block; font-size: 14px; color: #1d1d1f; margin-bottom: 2px; }
.feat-text p { font-size: 12px; color: #86868b; line-height: 1.4; }

/* åº•éƒ¨æŒ‰é’® */
.ins-done-btn {
    width: 100%; padding: 16px; border: none; background: #1d1d1f; color: #fff;
    border-radius: 16px; font-size: 12px; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; transition: 0.2s;
}
.ins-done-btn:active { transform: scale(0.96); opacity: 0.8; }
/* ç¡®ä¿å¡ç‰‡å†…å®¹è¾ƒå¤šæ—¶å¯ä»¥å†…éƒ¨æ»šåŠ¨ï¼Œä½†ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ */
.ins-card-body {
    max-height: 450px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
    overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none;
}
.ins-card-body::-webkit-scrollbar {
    display: none;
}

/* å¢åŠ åºå·çš„é—´è·æ„Ÿ */
.feat-num {
    min-width: 24px; /* é˜²æ­¢åŒä½æ•°åºå·å¯¼è‡´é”™ä½ */
}
/* --- é’ˆå¯¹ç²¾ç»†åŒ–å†…å®¹çš„æ’ç‰ˆå¢å¼º --- */
#ins-character-modal .ins-feat-item {
    margin-bottom: 24px !important; /* å¢åŠ é—´è· */
    border-left: 1px solid #f2f2f7; /* åŠ ä¸€æ¡ç»†çº¿å¢åŠ è®¾è®¡æ„Ÿ */
    padding-left: 15px;
}

#ins-character-modal .feat-text p {
    font-size: 13px !important; /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹æ–¹ä¾¿é˜…è¯» */
    line-height: 1.6 !important; /* å¢åŠ è¡Œé«˜ï¼Œè®©é•¿æ®µè½æ›´é€æ°” */
    margin-top: 5px;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½ï¼ŒInsé£ç²¾é«“ */
}

#ins-character-modal .ins-fancy-card {
    max-height: 85vh !important; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢ç”±äºå†…å®¹å¤ªå¤šå†²å‡ºå±å¹• */
    display: flex;
    flex-direction: column;
}

#ins-character-modal .ins-card-body {
    flex: 1;
    overflow-y: auto !important; /* å…è®¸å†…éƒ¨æ»šåŠ¨ */
    padding: 30px 24px !important;
}
/* é’ˆå¯¹å£çº¸è¯´æ˜é¡µçš„ç»†èŠ‚å¼ºåŒ– */
#ins-wallpaper-modal .ins-feat-item {
    margin-bottom: 24px !important;
    border-left: 1px solid #FF9A9E; /* ä¾§è¾¹çº¿ä½¿ç”¨å£çº¸æ¨¡å—çš„ç²‰è‰²ç³» */
    padding-left: 15px;
    transition: all 0.3s ease;
}

#ins-wallpaper-modal .ins-feat-item:hover {
    background: rgba(255, 154, 158, 0.05); /* é¼ æ ‡ç»è¿‡æ—¶æœ‰æ·¡æ·¡çš„å‘¼å¸æ„Ÿ */
    border-left-width: 3px;
}

#ins-wallpaper-modal .feat-text p {
    font-size: 13px;
    line-height: 1.6;
    color: #666;
    margin-top: 5px;
}

#ins-wallpaper-modal .ins-card-body {
    max-height: 50vh;
    overflow-y: auto;
    padding: 30px 24px !important;
}
/* é’ˆå¯¹è®¾ç½®è¯´æ˜é¡µï¼šå»æ‰å¤šä½™è£…é¥°ï¼Œä¿æŒå†…å®¹æ¸…æ™° */
#ins-settings-modal .ins-feat-item {
    margin-bottom: 22px !important;
    border-left: 1.5px solid #d1d1d6; /* ç°/é“¶è‰²ç³»ä¾§çº¿ */
    padding-left: 15px;
}

#ins-settings-modal .feat-text p {
    font-size: 13px !important;
    line-height: 1.5 !important;
    color: #444 !important;
    margin-top: 4px;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½æ›´é«˜çº§ */
}

/* ç‰©ç†é™åˆ¶é«˜åº¦ï¼Œå¤šå‡ºå†…å®¹å¿…é¡»æ»‘åŠ¨ */
#ins-settings-modal .ins-fancy-card {
    max-height: 80vh !important;
    display: flex !important;
    flex-direction: column !important;
}

#ins-settings-modal .ins-card-body {
    flex: 1 !important;
    overflow-y: auto !important;
    padding: 25px 24px !important;
}
/* --- ğŸ  æ»‘åŠ¨ç³»ç»Ÿæ ·å¼ --- */
.home-screen-scroll-container {
    flex: 1;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory; /* æ ¸å¿ƒï¼šå¼€å¯å¸é™„ */
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
    display: block; /* è¦†ç›–é»˜è®¤å¸ƒå±€ */
}
.home-screen-scroll-container::-webkit-scrollbar {
    display: none; /* å½»åº•éšè—æ»šåŠ¨æ¡ */
}

.home-screen-wrapper {
    display: flex;
    width: 300%; /* å› ä¸ºä¸¤é¡µï¼Œæ‰€ä»¥æ˜¯ 200% */
    height: 100%;
}

/* æ¯ä¸€é¡µéƒ½å¿…é¡»å›ºå®š 100% å±å¹•å®½ */
.main-container {
    width: 100vw !important;
    height: 100%;
    flex-shrink: 0;
    scroll-snap-align: start; /* å¸é™„ç‚¹ */
    padding: 10px 22px 20px 22px !important;
    /* ä¿æŒä½ åŸæœ¬çš„ç½‘æ ¼å¸ƒå±€ */
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: 2.3fr 1fr 0.7fr 1.1fr 1.1fr;
    gap: 16px;
    align-items: center;
}
/* --- ç¬¬ä¸€ã€äºŒè¡Œï¼šå°é¢ç»„ä»¶æ ·å¼ --- */
.hero-cover-widget {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 28px;
    overflow: hidden;
    background: #f2f2f7;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.3s ease;
}

.hero-cover-widget:active {
    transform: scale(0.98);
}

.hero-image-wrapper {
    width: 100%;
    height: 100%;
}

.hero-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* æ¸å˜é®ç½©ï¼šç¡®ä¿æ–‡å­—åœ¨ä»»ä½•å›¾ç‰‡ä¸‹éƒ½æ¸…æ™° */
.hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 20%, rgba(0,0,0,0.4) 100%);
}

.hero-content-text {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.hero-tag {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    opacity: 0.9;
}

.hero-content-text h2 {
    margin: 5px 0;
    font-size: 24px;
    font-weight: 700;
    font-family: serif; /* è¡¬çº¿ä½“æå‡é«˜çº§æ„Ÿ */
}

.hero-content-text p {
    font-size: 13px;
    font-style: italic;
    opacity: 0.8;
    margin: 0;
}

.hero-edit-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: 0.3s;
}

.hero-cover-widget:hover .hero-edit-icon {
    opacity: 1;
}
/* é®ç½©å±‚ï¼šå…¨å±åŠé€æ˜ */
.ios-alert-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px); /* èƒŒæ™¯æ¨¡ç³Š */
    display: none; /* åˆå§‹éšè— */
    justify-content: center;
    align-items: flex-end; /* é åº•éƒ¨å¯¹é½ */
    z-index: 9999;
}

/* æŠ½å±‰æ¿ï¼šç™½è‰²åœ†è§’çŸ©å½¢ */
.p2-editor-sheet {
    width: 100%;
    max-width: 500px; /* é™åˆ¶å¤§å±ä¸‹çš„å®½åº¦ */
    background: #ffffff;
    border-top-left-radius: 30px;
    border-top-right-radius: 30px;
    padding: 24px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
    animation: sheetUp 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

@keyframes sheetUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* å¤´éƒ¨å¸ƒå±€ */
.p2-editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}
#p2-editor-title { font-size: 18px; font-weight: 700; color: #1d1d1f; }
.p2-done-btn { color: #007AFF; font-weight: 700; cursor: pointer; font-size: 16px; }

/* è‡ªå®šä¹‰è¾“å…¥æ¡† */
.p2-main-input {
    width: 100%;
    border: none;
    background: #f2f2f7;
    padding: 16px;
    border-radius: 14px;
    font-size: 15px;
    outline: none;
    margin-bottom: 20px;
    box-sizing: border-box;
}

/* éšè—åŸå§‹ä¸‘é™‹çš„ä¸Šä¼ æŒ‰é’®ï¼Œæ”¹ç”¨è‡ªå®šä¹‰æ ‡ç­¾ */
.custom-upload-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    background: #1d1d1f; /* é»‘è‰²æŒ‰é’®æ›´æœ‰ Ins æ„Ÿ */
    color: #fff;
    border-radius: 14px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
}
.custom-upload-btn:active { opacity: 0.8; }
/* --- Row 3 & 4: æ‹ç«‹å¾—å¿ƒæƒ…çœ‹æ¿æ ·å¼ --- */
.moment-card-widget {
    background: #ffffff;
    border-radius: 24px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s ease;
}

.moment-card-widget:active { transform: scale(0.98); }

.moment-photo-area {
    width: 100%;
    aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    background: #f8f8f8;
}

.moment-photo-area img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.moment-edit-hint {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.2);
    color: #fff; font-size: 10px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: 0.3s;
}
.moment-photo-area:hover .moment-edit-hint { opacity: 1; }

.moment-text-area {
    padding: 12px 4px 4px 4px;
    text-align: left;
}

.moment-text-area h3 {
    font-size: 14px; font-weight: 800; color: #1d1d1f;
    margin: 0; letter-spacing: 0.5px;
}

.moment-text-area p {
    font-size: 11px; color: #86868b;
    margin: 4px 0 0 0;
    font-family: "Times New Roman", serif;
    font-style: italic;
    /* é™åˆ¶æ˜¾ç¤ºä¸¤è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* --- è‡ªå®šä¹‰ App è´´çº¸å¢å¼º --- */
.custom-pic-app .pic-app-wrapper {
    width: 60px; height: 60px; /* ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ */
    border-radius: 18px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}
.pic-app-wrapper img { width: 100%; height: 100%; object-fit: cover; }

.pic-app-edit {
    position: absolute; top: 0; right: 0;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
    width: 18px; height: 18px; border-bottom-left-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    color: #fff; opacity: 0; transition: 0.3s;
}
.pic-app-wrapper:hover .pic-app-edit { opacity: 1; }
/* Row 5: æ°›å›´æ¡æ ·å¼ */
.vibe-bar-widget {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    height: 100%;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0,0,0,0.05);
}
.vibe-bg-wrapper { width: 100%; height: 100%; }
.vibe-bg-wrapper img { width: 100%; height: 100%; object-fit: cover; }
.vibe-overlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.2);
    display: flex; align-items: center; justify-content: center;
}
#hub-vibe-text {
    position: absolute;
    width: 100%; text-align: center; top: 50%; transform: translateY(-50%);
    color: #fff; font-size: 13px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase; text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
/* 1. å¼ºåˆ¶çˆ¶å®¹å™¨åœ¨é¡¶éƒ¨ä¸ç•™ç™½ï¼ˆå¯é€‰ï¼Œå¦‚æœä½ å¸Œæœ›å›¾ç‰‡ç›´æ¥è´´åˆ°å±å¹•é¡¶ç«¯ï¼‰ */
#page-2 {
    padding: 0 16px 20px 16px !important; /* å·¦å³ä¿ç•™è¾¹è·ï¼Œä½†é¡¶éƒ¨è®¾ä¸º0 */
    gap: 12px !important; /* ç¼©å°ç»„ä»¶é—´çš„é—´è· */
}

/* --- 1. å¤§ç»„ä»¶ï¼šç¬¬ä¸€ã€äºŒè¡Œ(Hero) å’Œ ç¬¬äº”è¡Œ(Vibe Bar) å½»åº•é“ºæ»¡ --- */
.hero-cover-widget,
.vibe-bar-widget {
    padding: 0 !important;   /* å½»åº•ç§»é™¤å†…è¾¹è· */
    margin: 0 !important;    /* ç§»é™¤å¤–è¾¹è· */
    width: 100%;
    height: 100%;
    overflow: hidden;
    border-radius: 24px;     /* ç»Ÿä¸€åœ†è§’ */
    display: block;
}

/* ç¡®ä¿è¿™ä¸¤è€…çš„èƒŒæ™¯å›¾å®Œå…¨è¦†ç›– */
.hero-image-wrapper img,
.vibe-bg-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;       /* æ ¸å¿ƒï¼šä¸ç•™ç™½ã€ä¸ç¼©æ”¾ã€è‡ªåŠ¨è£å‰ª */
    display: block;
}

/* --- 2. å°å›¾æ ‡ï¼šä¿®å¤ç¬¬ä¸‰ã€å››ã€å…­è¡Œ App å›¾æ ‡è¢«æ’‘å¤§çš„é—®é¢˜ --- */
.custom-pic-app {
    display: flex;
    flex-direction: column;
    align-items: center;     /* ç¡®ä¿å›¾æ ‡åœ¨æ ¼å­é‡Œå±…ä¸­ */
    justify-content: center;
}

.custom-pic-app .pic-app-wrapper {
    /* æ ¸å¿ƒä¿®å¤ï¼šç»™å›¾æ ‡ä¸€ä¸ªå›ºå®šçš„å°ºå¯¸ï¼Œä¸è¦ 100% */
    width: 60px;             /* æ ¹æ®ä½ çš„å–œå¥½è°ƒæ•´ï¼Œæ¯”å¦‚ 60px æˆ– 64px */
    height: 60px;
    padding: 0 !important;   /* å†…éƒ¨å›¾ç‰‡é“ºæ»¡ï¼Œä¸ç•™ç™½è¾¹ */
    border-radius: 15px;     /* å›¾æ ‡åœ†è§’ç¨å°ä¸€ç‚¹æ›´ç²¾è‡´ */
    overflow: hidden;
    background: #eee;        /* å…œåº•èƒŒæ™¯è‰² */
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* ç¡®ä¿ App å›¾æ ‡é‡Œçš„å›¾ç‰‡ä¹Ÿæ˜¯é“ºæ»¡çš„ */
.pic-app-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* --- 3. ä¿®æ­£ Grid å®¹å™¨çš„é—´éš™ --- */
#page-2 {
    gap: 16px;              /* ç»Ÿä¸€ç»„ä»¶ä¹‹é—´çš„é—´è· */
    padding: 20px;          /* é¡µé¢å››å‘¨çš„ç•™ç™½ */
    align-content: start;
}
/* --- Vibe Grid æ¸¸æˆæ ·å¼ --- */
.game-board-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.vibe-board {
    display: grid;
    grid-template-columns: repeat(10, 1fr); /* 10x10 æ£‹ç›˜æ›´é€‚åˆæ‰‹æœº */
    grid-template-rows: repeat(10, 1fr);
    gap: 2px;
    background: rgba(255, 255, 255, 0.2);
    padding: 2px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    width: 100%;
    aspect-ratio: 1 / 1;
}

.vibe-cell {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: pointer;
}

/* æ£‹å­ï¼šå…±é¸£ (è“è‰²ç³») */
.piece-resonance {
    width: 80%; height: 80%;
    border-radius: 50%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    box-shadow: 0 0 15px rgba(79, 172, 254, 0.8);
    animation: piecePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* æ£‹å­ï¼šåå™¬ (çº¢è‰²ç³») */
.piece-devour {
    width: 80%; height: 80%;
    border-radius: 50%;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    box-shadow: 0 0 15px rgba(245, 87, 108, 0.8);
    animation: piecePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes piecePop {
    from { transform: scale(0) rotate(-45deg); opacity: 0; }
    to { transform: scale(1) rotate(0); opacity: 1; }
}

.game-footer-info {
    padding: 20px;
    display: flex;
    justify-content: space-around;
    background: rgba(0,0,0,0.05);
}

.vibe-tag-preview {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 1px;
    padding: 8px 15px;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.1);
}

.vibe-tag-preview.p1 { color: #4facfe; border-color: #4facfe; }
.vibe-tag-preview.p2 { color: #f5576c; border-color: #f5576c; }

/* èƒœåˆ©é—ªçƒæ•ˆ */
.win-flash {
    animation: winGlow 1s infinite alternate;
}
@keyframes winGlow {
    from { filter: brightness(1); }
    to { filter: brightness(1.5) drop-shadow(0 0 20px white); }
}
/* --- ğŸš‘ æ¸¸æˆ App ç»ˆææ˜¾ç¤ºè¡¥ä¸ --- */
#vibe-grid-app {
    z-index: 6000 !important; /* å¿…é¡»é«˜äº 5000ï¼Œæ‰èƒ½ç›–ä½è®¾ç½®é¡µ */
    transform: translateY(100%); /* é»˜è®¤åœ¨ä¸‹é¢ */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s !important;
    opacity: 0;
    display: none; /* åˆå§‹éšè— */
}

/* å½“ App æ¿€æ´»æ—¶çš„çŠ¶æ€ */
#vibe-grid-app.active {
    display: flex !important;
    transform: translateY(0) !important;
    opacity: 1 !important;
}

/* è¡¥å…¨æ¶ˆå¤±çš„åŠ¨ç”»å®šä¹‰ */
@keyframes appOpen {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* å¼ºåˆ¶ç»™æ£‹æ ¼ä¸€ä¸ªæœ€å°å°ºå¯¸ï¼Œé˜²æ­¢å®ƒä»¬ç¼©æˆä¸€å›¢ */
.vibe-cell {
    min-width: 30px;
    min-height: 30px;
}
/* --- ğŸš‘ å¼ºåˆ¶ Vibe Grid è§†è§‰å¯¹é½è¡¥ä¸ --- */
#vibe-grid-app {
    position: fixed !important; /* å¿…é¡»æ˜¯å›ºå®šå®šä½ */
    top: 0 !important; 
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important; /* åŒæ­¥è®¾ç½® App çš„ iOS èƒŒæ™¯è‰² */
    z-index: 6000 !important; /* å¿…é¡»é«˜äºæ¡Œé¢ï¼Œç¡®ä¿ç»å¯¹è¦†ç›– */
    display: none; /* åˆå§‹éšè— */
    flex-direction: column;
    transform: translateY(100%); /* é»˜è®¤è—åœ¨å±å¹•ä¸‹æ–¹ */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s !important;
}

/* æ¿€æ´»æ€ï¼šä»ä¸‹æ–¹æ»‘å…¥ */
#vibe-grid-app.active {
    display: flex !important;
    transform: translateY(0) !important;
}

/* æ£‹ç›˜æ ¼å­ç¾åŒ– */
.vibe-board {
    background: #fff !important; /* æ£‹ç›˜ç”¨çº¯ç™½èƒŒæ™¯ï¼Œæ›´æœ‰ App è´¨æ„Ÿ */
    border-radius: 20px !important;
    padding: 10px !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05) !important;
    border: none !important;
}

.vibe-cell {
    background: #f2f2f7 !important; /* æ ¼å­åº•è‰²ç¨å¾®æ·±ä¸€ç‚¹ */
    border-radius: 6px !important;
}

/* ä¿®å¤åº•éƒ¨æ ‡ç­¾æ ·å¼ */
.game-footer-info {
    display: flex;
    justify-content: center;
    gap: 15px;
    background: transparent !important;
}
/* --- ğŸš‘ å¼¹çª—å±…ä¸­ä¸ UI é™å™ªè¡¥ä¸ --- */

/* 1. å¼ºåˆ¶å±…ä¸­é®ç½©ï¼šè§£å†³å¼¹çª—åœ¨åº•éƒ¨çš„é—®é¢˜ */
.vibe-center-mask {
    position: fixed; inset: 0;
    display: flex; align-items: center; /* å‚ç›´å±…ä¸­ */
    justify-content: center; /* æ°´å¹³å±…ä¸­ */
    background: rgba(0, 0, 0, 0.4); /* åŠ æ·±é®ç½©ï¼Œçªå‡ºé‡ç‚¹ */
    backdrop-filter: blur(10px); /* ç£¨ç ‚æ„Ÿ */
    z-index: 6000000;
}

/* 2. ç§»é™¤å†—ä½™è¾¹è·ï¼Œè§£å†³ç©ºç™½è¿‡å¤šçš„è§†è§‰æ„Ÿ */
#vibe-game-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center; /* è®©å†…å®¹åœ¨å‚ç›´æ–¹å‘ä¹Ÿå±…ä¸­ */
    width: 100%;
    padding-bottom: 60px; /* ç»™åº•éƒ¨æ ç•™ç©ºé—´ */
}

/* 3. æ£‹ç›˜å®¹å™¨é«˜çº§åŒ– */
.vibe-board-wrapper {
    background: #fff;
    padding: 15px;
    border-radius: 32px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255,255,255,1);
    transform: scale(0.95); /* ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œå¢åŠ ç²¾è‡´æ„Ÿ */
}

/* 4. å½»åº•å»æ‰æŒ‰é’®é‡å  */
#vibe-guide-btn {
    position: static !important; /* åˆ«å†æ‚¬æµ®äº† */
    margin: 10px auto;
    padding: 6px 16px;
    background: rgba(0, 122, 255, 0.08);
    border-radius: 12px;
    width: fit-content;
}
/* --- ğŸ¨ AI è¯è¯­æ‚¬æµ®åŠ¨ç”» --- */
.floating-vibe-word {
    position: absolute;
    pointer-events: none;
    z-index: 10000;
    color: #1d1d1f;
    font-family: "Times New Roman", serif;
    font-style: italic;
    font-weight: 600;
    font-size: 18px;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(255,255,255,1), 0 0 10px rgba(0,122,255,0.2);
    animation: vibeRise 2.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
}

@keyframes vibeRise {
    0% { transform: translateY(10px); opacity: 0; filter: blur(5px); }
    20% { transform: translateY(0); opacity: 1; filter: blur(0); }
    80% { transform: translateY(-30px); opacity: 0.8; filter: blur(0); }
    100% { transform: translateY(-50px); opacity: 0; filter: blur(10px); }
}
/* --- ğŸ’ æ¶²æ€ç»ç’ƒçº¿æ¡å›¾æ ‡é£æ ¼ (Liquid Glass & Line Art) --- */

/* --- ğŸ’ ç²¾è‡´ç‰ˆæ¶²æ€ç»ç’ƒå›¾æ ‡å°ºå¯¸è¡¥ä¸ --- */
.glass-icon-bg {
    width: 60px !important;   /* é”å®šå®½åº¦ï¼ŒåŒæ­¥ç³»ç»Ÿæ ‡å‡† */
    height: 60px !important;  /* é”å®šé«˜åº¦ */
    
    /* ä¿æŒåŸæœ‰çš„é«˜çº§è´¨æ„Ÿ */
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.15));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    border-radius: 16px; /* ç¨å¾®å‡å°åœ†è§’ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´ç¡¬æœ—ç²¾è‡´ */
    
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* ç¡®ä¿åœ¨æ ¼å­é‡Œæ°´å¹³å±…ä¸­ */
    transition: transform 0.2s cubic-bezier(0.33, 1, 0.68, 1);
}

/* è°ƒæ•´å†…éƒ¨çº¿æ¡å›¾æ ‡çš„æ¯”ä¾‹ï¼Œè®©å®ƒçœ‹èµ·æ¥ä¸æ‹¥æŒ¤ */
.glass-icon-svg {
    width: 28px; /* é€‚å½“ç¼©å°çº¿æ¡å›¾æ¡ˆï¼Œç•™å‡ºå‘¼å¸æ„Ÿ */
    height: 28px;
    fill: none;
    stroke: #1d1d1f;
    stroke-width: 1.8; /* ç¨å¾®åŠ ç²—ä¸€ç‚¹çº¿æ¡ï¼Œå¢å¼ºè¯†åˆ«åº¦ */
    stroke-linecap: round;
    stroke-linejoin: round;
}
/* --- ğŸ›ï¸ ä¸–ç•Œä¹¦ï¼šæç®€æ¡£æ¡ˆé£æ ¼ --- */

/* 1. åˆ—è¡¨ä¸­çš„å¡ç‰‡ */
.world-card-item {
    background: #fff;
    border-radius: 18px;
    padding: 20px;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    cursor: pointer;
    transition: all 0.2s ease;
}
.world-card-item:active { transform: scale(0.96); background: #fafafa; }
.world-card-item .name { font-size: 18px; font-weight: 800; color: #1d1d1f; }
.world-card-item .hint { font-size: 11px; color: #bbb; margin-top: 8px; font-weight: 600; letter-spacing: 1px; }

/* 2. å±•ç¤ºç”¨çš„ä¸­å¿ƒå¡ç‰‡ */
.world-minimal-card {
    width: 85%; max-width: 320px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 32px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
@keyframes worldPopCenter { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }

.world-minimal-card h1 { font-size: 22px; font-weight: 800; color: #000; margin-bottom: 15px; }
.world-line-decor { width: 30px; height: 3px; background: #007AFF; margin: 0 auto 20px auto; border-radius: 2px; }
.world-viewer-scroll { max-height: 40vh; overflow-y: auto; text-align: left; scrollbar-width: none; }
.world-v-content { font-size: 15px; line-height: 1.7; color: #444; }

/* 3. æŒ‰é’®æ ·å¼ */
.world-action-btn { flex: 1; padding: 12px; border-radius: 12px; background: #f2f2f7; color: #007AFF; font-weight: 700; font-size: 14px; cursor: pointer; text-align: center; }
.world-action-btn.delete { color: #FF3B30; }
.world-action-btn:active { opacity: 0.7; }

/* 4. æ·»åŠ æŒ‰é’® */
.world-add-btn {
    border: 2px dashed #d1d1d6;
    border-radius: 18px;
    display: flex; align-items: center; justify-content: center;
    min-height: 120px; color: #d1d1d6; cursor: pointer;
}
/* --- ğŸ’¬ Chat App ä¸“å±å¤–å£³æ ·å¼ --- */

.chat-tab-panel {
    display: none; /* é»˜è®¤éšè— */
    width: 100%;
    height: 100%;
    animation: fadeIn 0.3s ease;
}
.chat-tab-panel.active { display: block; }

/* æ‚¬æµ®å¯¼èˆªæ å®¹å™¨ */
.chat-nav-wrapper {
    position: absolute;
    bottom: 30px; /* è·ç¦»åº•éƒ¨ç•™ç©ºï¼Œæ˜¾å¾—é«˜çº§ */
    left: 0; width: 100%;
    display: flex; justify-content: center;
    pointer-events: none; /* é˜²æ­¢é®æŒ¡å†…å®¹ç‚¹å‡» */
    z-index: 100;
}

.chat-bottom-nav {
    pointer-events: auto; /* æ¢å¤å¯¼èˆªæ ç‚¹å‡» */
    width: 90%;
    max-width: 380px;
    height: 65px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 0.5px solid rgba(255, 255, 255, 0.3);
    border-radius: 35px; /* è¶…åœ†è§’ */
    display: flex;
    align-items: center;
    justify-content: space-around;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: #8e8e93;
    transition: all 0.2s ease;
    cursor: pointer;
}

.nav-item span { font-size: 10px; font-weight: 600; }
.nav-item.active { color: #007AFF; transform: scale(1.1); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
/* --- ğŸ’¬ Chat: å¥½å‹ç¯æ ·å¼ --- */
.chat-friend-ring-container {
    padding: 15px 0;
    background: #fff;
    border-bottom: 0.5px solid #eee;
    overflow: hidden;
}
.friend-ring-wrapper {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 0 16px;
    scrollbar-width: none;
}
.friend-ring-wrapper::-webkit-scrollbar { display: none; }

.friend-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
    cursor: pointer;
}
.friend-avatar-ring {
    width: 62px; height: 62px;
    border-radius: 50%;
    padding: 2px;
    border: 2px solid #007AFF; /* ç±»ä¼¼æ•…äº‹ç¯çš„é¢œè‰² */
}
.friend-avatar-ring img {
    width: 100%; height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
.friend-item span { font-size: 11px; color: #333; max-width: 65px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* --- ğŸ‘¤ ç¤¾äº¤åç‰‡å¡ç‰‡ --- */
.chat-profile-card {
    width: 85%; max-width: 320px;
    background: #fff; border-radius: 30px;
    padding: 30px 20px; text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    animation: cardScaleUp 0.3s cubic-bezier(0.17, 0.89, 0.32, 1.2);
}
@keyframes cardScaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

.profile-avatar-glow {
    width: 100px; height: 100px;
    margin: 0 auto 15px auto;
    border-radius: 50%;
    position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
#profile-v-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.profile-info h2 { font-size: 22px; font-weight: 800; margin-bottom: 5px; }
.online-tag { font-size: 11px; color: #34C759; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px; }
.profile-motto {
    font-size: 14px; color: #666; font-style: italic;
    background: #f2f2f7; padding: 10px 15px; border-radius: 12px;
    cursor: pointer; transition: 0.2s;
}
.profile-motto:hover { background: #e5e5ea; }

.profile-actions {
    display: flex; justify-content: space-around;
    margin-top: 30px; padding-top: 20px;
    border-top: 0.5px solid #f2f2f7;
}
.action-btn-circle {
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    color: #007AFF; cursor: pointer;
}
.action-btn-circle span { font-size: 11px; font-weight: 600; }
.action-btn-circle:active { opacity: 0.5; }
/* ğŸ’¬ Chat App ç»ˆæè§†è§‰åŠ å›º */
#chatApp {
    background: #F2F2F7 !important; /* å¼ºåˆ¶ iOS ç³»ç»Ÿç°è‰²èƒŒæ™¯ */
    z-index: 7000 !important;       /* ç¡®ä¿å±‚çº§é«˜äº Page 2 çš„æ‰€æœ‰ç»„ä»¶ */
    overflow: hidden;
}

#chatApp .app-body {
    background: #F2F2F7 !important;
    padding: 0 !important;         /* ç§»é™¤å†…è¾¹è·ï¼Œäº¤ç»™é¢æ¿å¤„ç† */
    display: block !important;     /* ç¦ç”¨ Flexï¼Œé˜²æ­¢å†…å®¹æŒ¤å‹ */
    position: relative;
    z-index: 5;
}

/* åˆ—è¡¨è¡Œæ ·å¼ - å¢å¼ºç‰ˆ */
.contact-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #fff;             /* æ¯ä¸€è¡Œå¿…é¡»æ˜¯çº¯ç™½èƒŒæ™¯ */
    border-bottom: 0.5px solid #E5E5EA;
    cursor: pointer;
    transition: background 0.2s;
}
.contact-row:active { background: #E5E5EA; }

.contact-avatar {
    width: 50px; height: 50px;
    margin-right: 15px;
    flex-shrink: 0;
    object-fit: cover;
    background: #eee;
}

.contact-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.contact-name { font-size: 17px; font-weight: 600; color: #000; }
.contact-preview { font-size: 13px; color: #8E8E93; margin-top: 2px; }

/* åº•éƒ¨å¯¼èˆªæ å¼ºåˆ¶ç½®é¡¶ */
.chat-nav-wrapper {
    z-index: 9999 !important;
    pointer-events: none;
}
.chat-bottom-nav { pointer-events: auto; }
/* ==========================================
   ğŸ’ Chat åˆ—è¡¨ï¼šé«˜çº§å•†ç”¨ UI é‡å¡‘
   ========================================== */

/* 1. å¼ºåˆ¶æ¸…ç†é¢æ¿èƒŒæ™¯ï¼Œå½»åº•æ€æ‰å¤§å›¾æº¢å‡º */
#chat-panel-list {
    background-color: #F2F2F7 !important; 
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* 2. åˆ—è¡¨å®¹å™¨ï¼šå››å‘¨ç•™å‡ºå‘¼å¸ä½ */
#chat-list-content {
    padding: 16px !important;
    padding-bottom: 120px !important; /* ç»™åº•éƒ¨æ‚¬æµ®å¯¼èˆªç•™ä½ç½® */
}

/* 3. ã€æ ¸å¿ƒè®¾è®¡ã€‘è”ç³»äººåˆ†ç»„å¡ç‰‡ï¼šæŠŠæ‰€æœ‰è¡ŒåŒ…åœ¨ä¸€ä¸ªå¤§åœ†è§’ç›’å­é‡Œ */
.chat-contact-group {
    background: #ffffff;
    border-radius: 14px; 
    overflow: hidden;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
}

/* 4. è”ç³»äººè¡Œï¼šå»æ‰å¤šä½™çš„ç™½è¾¹ï¼Œæ”¹ç”¨ç²¾è‡´åˆ†å‰²çº¿ */
.contact-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s ease;
    position: relative;
}

/* æ¨¡æ‹Ÿ iOS åˆ†å‰²çº¿ï¼šçº¿æ¡ä»æ–‡å­—å¤„å¼€å§‹ï¼Œä¸åˆ‡æ–­å¤´åƒï¼Œä¿æŒè§†è§‰è¿è´¯ */
.contact-row:not(:last-child)::after {
    content: "";
    position: absolute;
    bottom: 0;
    right: 0;
    left: 80px; 
    height: 0.5px;
    background: #E5E5EA;
}

/* ç‚¹å‡»æ—¶çš„ç°è‰²åé¦ˆï¼Œè®©ç”¨æˆ·çŸ¥é“â€œç‚¹ä¸­äº†â€ */
.contact-row:active {
    background: #F2F2F7;
}

/* 5. å¤´åƒç²¾ä¿®ï¼šå¢åŠ æç»†çš„æè¾¹ï¼Œé˜²æ­¢åœ¨ç™½åº•ä¸Šç³Šæ‰ */
.contact-avatar {
    width: 50px;
    height: 50px;
    margin-right: 14px;
    object-fit: cover;
    background: #f8f8f8;
    box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.1);
}

/* 6. æ–‡å­—æ’ç‰ˆï¼šå±‚çº§åˆ†æ˜ */
.contact-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.contact-name {
    font-size: 17px;
    font-weight: 600;
    color: #000;
    letter-spacing: -0.4px;
}

.contact-preview {
    font-size: 13px;
    color: #8E8E93; /* å‰¯æ ‡é¢˜ç° */
}

/* 7. å³ä¾§ç®­å¤´ï¼šè°ƒæ·¡é¢œè‰²ï¼Œå‡å°‘è§†è§‰å¹²æ‰° */
.contact-chevron {
    color: #C7C7CC;
    margin-left: 8px;
    opacity: 0.8;
}

/* 8. é¡¶éƒ¨åˆ‡æ¢æ  (Segment) ç¾åŒ– */
.segment-control {
    background: #E3E3E8 !important;
    padding: 2px !important;
    border-radius: 10px !important;
    margin-bottom: 5px !important;
}

.segment-btn.active {
    background: #fff !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}
/* --- ğŸ’ Messages é¡µé¢é«˜çº§æ’ç‰ˆ --- */

/* 1. åŒºåŸŸå°æ ‡é¢˜æ ‡ç­¾ */
.chat-section-label {
    font-size: 10px;
    font-weight: 800;
    color: #8E8E93;
    letter-spacing: 1.5px;
    padding: 10px 16px 5px 16px;
    text-transform: uppercase;
    background: #fff; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ */
}

/* 2. æ¶ˆæ¯åˆ—è¡¨å®¹å™¨ï¼šå¢åŠ ç•™ç™½å’ŒèƒŒæ™¯è‰² */
#chat-panel-msg {
    background: #F2F2F7 !important; /* ç³»ç»Ÿç°è‰²èƒŒæ™¯ */
}

.msg-list-container {
    background: #ffffff;
    margin-top: 5px;
    border-top: 0.5px solid #E5E5EA;
    min-height: 100%;
}

/* 3. ç©ºæ¶ˆæ¯çŠ¶æ€ç¾åŒ– */
.empty-msg-placeholder {
    padding: 60px 40px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.empty-msg-visual {
    width: 60px; height: 60px;
    background: #f2f2f7;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #C7C7CC;
}

.empty-msg-text {
    font-size: 14px;
    color: #8E8E93;
    font-family: serif;
    font-style: italic;
    line-height: 1.6;
}

/* 4. æ¨¡æ‹Ÿæ¶ˆæ¯è¡Œæ ·å¼ (è®©é¡µé¢å³ä¾¿ç©ºçš„ä¹Ÿå¥½çœ‹) */
.fake-msg-row {
    display: flex; align-items: center; padding: 12px 16px; opacity: 0.4; filter: blur(0.5px);
}
/* --- ğŸ’¬ Chat App å†…éƒ¨é¢æ¿å¼ºåˆ¶éš”ç¦»è¡¥ä¸ --- */

/* 1. é”å®š ChatApp çš„ä¸»ä½“å®¹å™¨ï¼Œç¦æ­¢å®ƒäº§ç”Ÿæ¨ªå‘æº¢å‡º */
#chatApp .app-body {
    position: relative !important;
    flex: 1 !important;
    overflow: hidden !important; /* æ ¸å¿ƒï¼šç¦æ­¢åœ¨è¿™é‡Œäº§ç”Ÿå¥‡æ€ªçš„æ»‘åŠ¨ */
    background: #F2F2F7 !important;
}

/* 2. å¼ºåˆ¶æ¯ä¸ªé¢æ¿ï¼ˆæ¶ˆæ¯ã€åˆ—è¡¨ç­‰ï¼‰ç‹¬ç«‹é‡å  */
.chat-tab-panel {
    display: none; /* é»˜è®¤å®Œå…¨éšè— */
    position: absolute !important; /* æ ¸å¿ƒï¼šç»å¯¹å®šä½ï¼Œè®©å®ƒä»¬é‡å åœ¨åŒä¸€ä¸ªå‘ä½ */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto !important; /* å…è®¸å†…éƒ¨ä¸Šä¸‹æ»šåŠ¨ï¼Œä½†ä¸å‡†æ¨ªå‘ä¹±è·‘ */
    -webkit-overflow-scrolling: touch;
    background: #F2F2F7; /* ç»Ÿä¸€åº•è‰² */
}

/* 3. åªæœ‰æ¿€æ´»çŠ¶æ€æ‰æ˜¾ç¤ºï¼Œå¹¶ä¸”å¼ºåˆ¶æ’‘æ»¡ */
.chat-tab-panel.active {
    display: flex !important; /* æˆ–è€… blockï¼Œå–å†³äºä½ å†…éƒ¨å¸ƒå±€ */
    flex-direction: column;
    z-index: 10;
}

/* 4. ç‰¹åˆ«ä¿®å¤ï¼šé˜²æ­¢æ¶ˆæ¯é¡µé¢çš„é¡¶éƒ¨å¥½å‹ç¯æ’‘å¤§å®¹å™¨ */
.chat-fixed-header {
    width: 100%;
    flex-shrink: 0;
    z-index: 20;
}
/* --- ğŸ¨ Chat App é¢œè‰²å¤§ç»Ÿä¸€è¡¥ä¸ --- */

/* 1. ç»Ÿä¸€æ¶ˆæ¯é¢æ¿çš„æ•´ä½“åº•è‰² */
#chat-panel-msg, 
.msg-list-container,
.chat-fixed-header,
.chat-friend-ring-container {
    background-color: #F2F2F7 !important; /* å¼ºåˆ¶ç»Ÿä¸€ä¸ºç³»ç»Ÿç°è‰² */
}

/* 2. ç»Ÿä¸€å°æ ‡é¢˜ï¼ˆMoments/Conversationsï¼‰çš„èƒŒæ™¯ */
.chat-section-label {
    background-color: #F2F2F7 !important;
    color: #8E8E93; /* é¡ºä¾¿è°ƒæˆ iOS æ ‡å‡†ç°è‰²æ–‡å­— */
}

/* 3. ç»Ÿä¸€å¥½å‹ç¯åŒºåŸŸçš„èƒŒæ™¯ */
.chat-friend-ring-container {
    border-bottom: none !important; /* å»æ‰å¤šä½™çš„åˆ†å‰²çº¿ï¼Œæ›´æ¸…çˆ½ */
}

/* 4. å¦‚æœä½ å¸Œæœ›åˆ—è¡¨é¡¹ï¼ˆå¦‚æœæœ‰äººçš„è¯ï¼‰æ˜¯ç™½çš„ï¼Œå¯ä»¥ä¿ç•™ã€‚
   ä½†å¦‚æœä½ æƒ³å½»åº•å…¨ç°ï¼Œå¯ä»¥æŠŠä¸‹é¢è¿™è¡Œä¹ŸåŠ ä¸Šï¼š */
/* .contact-row { background-color: #F2F2F7 !important; } */

/* 5. ç¡®ä¿åº•éƒ¨å¯¼èˆªæ ä¹Ÿå’ŒèƒŒæ™¯èåˆ (æ¯›ç»ç’ƒæ•ˆæœ) */
.chat-bottom-nav {
    background: rgba(242, 242, 247, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border-top: 0.5px solid rgba(0,0,0,0.05) !important;
}
/* --- ğŸš‘ å¤´åƒå˜å½¢æ€¥æ•‘ + å¼ºåˆ¶å‘¼å¸å…‰æ™•è¡¥ä¸ --- */

/* --- ğŸ›ï¸ Ins é£æ ¼é«˜çº§åç‰‡å…¨æ¡ˆæ ·å¼ --- */

/* 1. å¡ç‰‡æœ¬ä½“ï¼šé«˜å¯¹æ¯”ã€æŸ”å’Œé˜´å½±ã€å±…ä¸­æ’ç‰ˆ */
.chat-profile-card-aesthetic {
    width: 88%;
    max-width: 340px;
    background: #ffffff;
    border-radius: 40px; /* è¶…å¤§åœ†è§’æ›´ç°ä»£ */
    padding: 45px 25px 35px 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    box-shadow: 0 40px 100px rgba(0,0,0,0.1);
    animation: aesCardFadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

/* 2. å¤´åƒç‰©ç†é”æ­»ï¼šè§£å†³å˜å½¢çš„å…³é”® */
.aes-avatar-ring-wrapper {
    position: relative;
    width: 120px;
    height: 120px;
    margin-bottom: 25px;
    flex-shrink: 0; /* å¼ºåˆ¶ä¸è®¸ç¼©æ°´ */
}

#profile-v-avatar {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    object-fit: cover !important; /* æ ¸å¿ƒï¼šè‡ªåŠ¨å±…ä¸­è£åˆ‡ */
    border: 5px solid #fff;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    position: relative;
    z-index: 5;
}

/* 3. å‘¼å¸åœˆï¼šé«˜çº§æ„ŸæŸ”å…‰ */
.aes-breathing-ring {
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 2px solid rgba(52, 199, 89, 0.4);
    z-index: 1;
    animation: aesHaloPulse 3s infinite ease-in-out;
}

.aes-breathing-ring::after {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(52, 199, 89, 0.3);
    animation: aesHaloPulse 3s infinite ease-in-out 1.5s;
}

/* 4. æ–‡å­—æ’ç‰ˆï¼šè¡¬çº¿ä½“æå‡è´¨æ„Ÿ */
.aes-nickname-serif {
    font-family: "Times New Roman", serif; /* ä½¿ç”¨ç»å…¸è¡¬çº¿ä½“ */
    font-size: 26px;
    font-weight: 800;
    color: #1d1d1f;
    letter-spacing: -0.5px;
    margin-bottom: 5px;
}

.aes-online-tag {
    font-size: 10px;
    font-weight: 800;
    color: #34C759;
    letter-spacing: 2px;
    margin-bottom: 20px;
}

/* 5. ç­¾ååŒºåŸŸï¼šè½»ç›ˆã€æ„å¢ƒ */
.aes-motto-box {
    background: #f8f8f8;
    padding: 18px 20px;
    border-radius: 20px;
    max-width: 260px;
    cursor: pointer;
    transition: background 0.3s;
    margin-bottom: 30px;
}

.aes-motto-box:active { background: #f0f0f0; }

#profile-v-motto {
    font-family: serif;
    font-style: italic;
    color: #666;
    font-size: 14px;
    line-height: 1.6;
    margin: 0;
}

/* 6. æŒ‰é’®ç»„ï¼šæç®€çº¿æ¡é£æ ¼ */
.aes-action-grid {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    border-top: 1px solid #f2f2f7;
    padding-top: 25px;
}

.aes-btn-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.aes-icon-circle {
    width: 48px;
    height: 48px;
    background: #f2f2f7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    transition: all 0.2s;
}

.aes-btn-item span {
    font-size: 11px;
    font-weight: 700;
    color: #8e8e93;
    text-transform: uppercase;
}

.aes-btn-item:active .aes-icon-circle {
    transform: scale(0.9);
    background: #e5e5ea;
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes aesCardFadeIn {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes aesHaloPulse {
    0% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.15); opacity: 0.8; }
    100% { transform: scale(1); opacity: 0.3; }
}
/* é¡¶éƒ¨å·¥å…·æ å®¹å™¨ */
.aes-card-header-tools {
    width: 100%;
    display: flex;
    justify-content: flex-end; /* æŒ‰é’®é å³ */
    position: absolute; /* ç»å¯¹å®šä½ï¼Œä¸å æ’ç‰ˆç©ºé—´ */
    top: 20px;
    right: 20px;
    z-index: 100;
}

/* å…³é—­æŒ‰é’®æœ¬ä½“ */
.aes-close-trigger {
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.05); /* ææ·¡çš„åº•è‰² */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8e8e93;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* ç‚¹å‡»/æ‚¬åœæ•ˆæœ */
.aes-close-trigger:active {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(0.9);
}

/* ç¡®ä¿å¡ç‰‡æœ¬èº«æ˜¯ç›¸å¯¹å®šä½çš„ï¼Œæ–¹ä¾¿æŒ‰é’®å®šä½ */
.chat-profile-card-aesthetic {
    position: relative !important; /* å¿…é¡»åŠ è¿™ä¸€è¡Œ */
}
/* --- ğŸ‘¥ å‘èµ·ç¾¤èŠé¡µé¢é«˜çº§ UI è¡¥ä¸ --- */

/* 1. ç»Ÿä¸€èƒŒæ™¯å’Œåˆ—è¡¨å®¹å™¨ */
#page-add-group .app-body {
    background: #F2F2F7 !important;
    padding: 20px 16px !important;
}

/* 2. é¡¶éƒ¨ç¾¤èµ„æ–™å¡ç‰‡ */
.group-info-card {
    background: #fff;
    border-radius: 14px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* 3. ä¿®å¤äººæ•°è¾“å…¥æ¡†ï¼šå˜æˆ iOS æ ‡å‡†å³ä¾§å°æ¡† */
#page-add-group .ios-list-item input[type="number"] {
    border: none;
    background: #E5E5EA;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 15px;
    font-weight: 600;
    color: #007AFF;
    width: 50px !important; /* é”å®šå®½åº¦ */
    text-align: center;
    outline: none;
}

/* 4. æˆå‘˜é€‰æ‹©ç½‘æ ¼ç¾åŒ– */
#group-member-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* ä¸€è¡Œ4ä¸ªï¼Œé€‚åˆå¤´åƒæ˜¾ç¤º */
    gap: 15px;
    padding: 10px 0;
}

.member-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.member-avatar-box {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 14px; /* é‡‡ç”¨è‹¹æœ App å›¾æ ‡åœ†è§’ */
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.member-avatar-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* å…³é”®ï¼šé€‰ä¸­çŠ¶æ€çš„æ ·å¼ */
.member-item.selected .member-avatar-box {
    border-color: #007AFF;
    transform: scale(0.95);
}

/* é€‰ä¸­åçš„å³ä¸Šè§’å¯¹å‹¾ */
.member-item.selected .member-avatar-box::after {
    content: "âœ“";
    position: absolute;
    top: 2px;
    right: 2px;
    background: #007AFF;
    color: white;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.member-name {
    font-size: 11px;
    color: #3a3a3c;
    font-weight: 500;
    max-width: 65px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
/* --- ğŸ’ èŠå¤©å®¤æ¶²æ€ç»ç’ƒå…¨æ¡ˆæ ·å¼ --- */

/* 1. å¤´éƒ¨å¸ƒå±€ï¼šé€æ˜åº•ç‰ˆ */
.chat-room-header {
    height: 100px;
    padding: 50px 20px 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: transparent; /* å…³é”®ï¼šèƒŒæ™¯é€æ˜ */
    position: absolute;
    top: 0; left: 0; width: 100%;
    z-index: 100;
}

/* 2. æ¶²æ€ç»ç’ƒæŒ‰é’®æ ·å¼ */
.header-glass-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(15px) saturate(180%);
    -webkit-backdrop-filter: blur(15px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    cursor: pointer;
}

/* 3. ä¸­é—´å¤´åƒå’Œæ˜µç§° */
.header-contact-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
}

#room-contact-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-text-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#room-contact-name { font-size: 14px; font-weight: 800; color: #000; }
.room-status-text { font-size: 10px; color: #34C759; font-weight: 700; letter-spacing: 0.5px; }

/* 4. æ¶ˆæ¯æ»šåŠ¨åŒº */
.chat-scroll-area {
    flex: 1;
    margin-top: 100px;
    margin-bottom: 90px;
    padding: 20px;
    overflow-y: auto;
    background: #F2F2F7;
}

/* --- ğŸš‘ èŠå¤©å®¤è¾“å…¥åŒºé«˜çº§é‡å¡‘ --- */

/* 1. åº•éƒ¨å®¹å™¨ï¼šæ”¹ä¸ºæ‚¬æµ®ç»ç’ƒæ„Ÿï¼Œä¸å†æ­»æ¿åœ°è´´åœ¨æœ€åº•ä¸‹ */
#page-chat-room .chat-room-footer {
    position: absolute;
    bottom: 25px; /* è·ç¦»åº•éƒ¨ç•™ç©ºï¼Œäº§ç”Ÿæ‚¬æµ®æ„Ÿ */
    left: 5%;
    width: 90%; /* å®½åº¦ä¸æ’‘æ»¡ï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
    height: 56px; /* ç¨å¾®åŠ é«˜ä¸€ç‚¹ */
    padding: 0 10px 0 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.75); /* æŸ”å’ŒåŠé€æ˜ */
    backdrop-filter: blur(20px) saturate(180%); /* å¼ºåŠ›æ¯›ç»ç’ƒ */
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 28px; /* è¶…å¤§åœ†è§’ */
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* æè½»çš„é˜´å½± */
    z-index: 100;
}

/* 2. å·¦ä¾§ + å·ï¼šè°ƒå°ä¸€ç‚¹ï¼Œé¢œè‰²å˜æ·¡ï¼Œåƒä¸ªç²¾è‡´çš„æ’ä»¶å…¥å£ */
.footer-add-btn {
    color: #8E8E93 !important; /* ç°è°ƒæ›´é«˜çº§ */
    transition: transform 0.2s ease;
}
.footer-add-btn:active { transform: scale(0.9) rotate(90deg); }

/* 3. è¾“å…¥æ¡†ï¼šå½»åº•é€æ˜åŒ–ï¼Œåªç•™æ–‡å­— */
.chat-room-input {
    flex: 1;
    height: 100%;
    background: transparent !important;
    border: none !important;
    font-size: 16px;
    color: #000;
    outline: none;
    padding: 0;
}
.chat-room-input::placeholder {
    color: #C7C7CC;
    font-weight: 400;
}

/* 4. å³ä¾§æŒ‰é’®ç»„ï¼šç¼©å°å°ºå¯¸ï¼Œç»Ÿä¸€é£æ ¼ */
.footer-action-btns {
    display: flex;
    gap: 8px;
    align-items: center;
}

.action-btn {
    width: 36px !important; /* ç»Ÿä¸€ç¼©å°ä¸€ç‚¹ */
    height: 36px !important;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: none !important; /* å»æ‰ä¹‹å‰çš„é‡é˜´å½± */
}

/* AI æŒ‰é’®ï¼šä½è°ƒçš„æ·±ç°è‰²ç»ç’ƒæ„Ÿ */
.action-btn.ai {
    background: rgba(29, 29, 31, 0.05) !important;
    color: #1d1d1f !important;
}
.action-btn.ai:active { background: rgba(29, 29, 31, 0.15) !important; }

/* å‘é€æŒ‰é’®ï¼šç»å…¸çš„ iOS è“è‰²ï¼Œä½†å»æ‰æ‚ä¹±è¾¹æ¡† */
.action-btn.send {
    background: #007AFF !important;
    color: #fff !important;
}
.action-btn.send:active { transform: scale(0.85); opacity: 0.8; }

/* 5. ä¿®æ­£æ¶ˆæ¯åŒºåŸŸçš„åº•éƒ¨é—´è·ï¼Œé˜²æ­¢è¢«æ‚¬æµ®æ¡æŒ¡ä½ */
#page-chat-room .chat-scroll-area {
    padding-bottom: 100px !important;
}
/* --- ğŸš‘ ç¡®ä¿èŠå¤©å®¤èƒŒæ™¯ä¸ç©¿é€ --- */
/* --- ğŸš¨ ç‰©ç†å±‚çº§ç»ˆæé”æ­» --- */
#page-chat-room {
    position: fixed !important; /* å¿…é¡»æ˜¯å›ºå®šå®šä½ï¼Œè„±ç¦»æ‰€æœ‰å®¹å™¨æ§åˆ¶ */
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: #F2F2F7 !important; /* ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
    z-index: 9000 !important;      /* ç»å¯¹çš„æœ€é«˜å±‚çº§ï¼Œç›–è¿‡çŠ¶æ€æ å’Œä¸€åˆ‡ */
    display: none;                  /* åˆå§‹éšè— */
    flex-direction: column;
    transform: translateX(100%);    /* åˆå§‹åœ¨å±å¹•å³ä¾§å¤– */
    transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1) !important;
}
/* å¼ºåˆ¶è®©èŠå¤©é¡µé¢çš„å¤´éƒ¨å¾€ä¸‹æŒªï¼Œåˆ«è·ŸçŠ¶æ€æ æ’è½¦ */
#page-chat-room .chat-room-header {
    padding-top: 50px !important; /* ç‰©ç†é¿å¼€çŠ¶æ€æ é«˜åº¦ */
    background: rgba(242, 242, 247, 0.9) !important; /* ç»™èŠå¤©å®¤å¤´éƒ¨åŠ ç‚¹æ¯›ç»ç’ƒè‰²ï¼Œé˜²æ­¢é€å‡ºåº•ä¸‹çš„æ¡Œé¢æ–‡å­— */
    backdrop-filter: blur(20px) !important;
}

/* æ¿€æ´»çŠ¶æ€ */
#page-chat-room.active-room {
    display: flex !important;
    transform: translateX(0) !important;
}
/* 1. å¼ºè¡Œåˆ é™¤â€œåœ¨çº¿â€çŠ¶æ€æ–‡æœ¬ */
.room-status-text {
    display: none !important;
}

/* 2. æ¶ˆæ¯åŒºåŸŸæ•´ä½“å‘ä¸Šå¹³ç§» */
/* ä¹‹å‰ä¸ºäº†é¿å¼€çŠ¶æ€æ å¯èƒ½è®¾ç½®äº†è¿‡å¤§çš„ 100pxï¼Œç°åœ¨æŠŠå®ƒæ”¹å° */
#page-chat-room .chat-scroll-area {
    margin-top: 70px !important; /* è¿™é‡Œçš„æ•°å€¼è¶Šå°ï¼Œæ¶ˆæ¯å°±è¶Šé ä¸Š */
    padding-top: 0px !important;
}

/* 3. å‹ç¼©å¤´éƒ¨çš„é«˜åº¦ï¼Œè®©å¤´åƒå’Œåå­—æ›´ç´§å‡‘ */
#page-chat-room .chat-room-header {
    min-height: 80px !important;
    height: 80px !important;
    padding-bottom: 0px !important;
}
@keyframes msgFadeUp {
    from { 
        opacity: 0; 
        transform: translateY(10px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}
/* --- ğŸ’ æç®€æ˜Ÿè¾°Â·å…¨åœ†è§’æ°”æ³¡è®¾è®¡ --- */

/* 1. åŸºç¡€å¸ƒå±€ */
.msg-row {
    margin: 20px 0;
    display: flex;
    align-items: flex-end; /* è®©å¤´åƒå’Œæ°”æ³¡åº•éƒ¨å¯¹é½ */
    gap: 10px;
    padding: 0 -10px;
    animation: bubbleEnter 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 2. ç»Ÿä¸€å¤´åƒæ ·å¼ */
.chat-avatar-img {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
    border: 1.5px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* 3. é€šç”¨æ°”æ³¡è®¾è®¡ (æ ¸å¿ƒï¼šå…¨åœ†è§’) */
.bubble {
    position: relative;
    padding: 12px 18px;
    font-size: 15px;
    line-height: 1.6;
    max-width: 70%;
    border-radius: 22px !important; /* å¼ºåˆ¶å…¨åœ†è§’ï¼Œå»æ‰å°–è§’ */
    word-break: break-all;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}

/* 4. ç”¨æˆ·æ°”æ³¡ï¼šæ˜Ÿæµ·æ·±è“ (é å³) */
.msg-row.user {
    justify-content: flex-end;
}
.msg-row.user .bubble {
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%); /* æ·±è‰²ç³»æ›´æ˜¾é«˜çº§ */
    color: #fff;
}

/* 5. è§’è‰²æ°”æ³¡ï¼šä¸ç¼é›¾ç° (é å·¦) */
.msg-row.opponent {
    justify-content: flex-start;
}
.msg-row.opponent .bubble {
    background: #ffffff;
    color: #1d1d1f;
    border: 0.5px solid rgba(0,0,0,0.08);
}

/* 6. æ˜Ÿæ˜Ÿè£…é¥°ï¼šå¾®å…‰ç‰¹æ•ˆ */
.star-decor {
    position: absolute;
    font-size: 12px;
    pointer-events: none;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
    animation: starPulse 2s infinite ease-in-out;
}

.msg-row.user .star-decor {
    top: -8px;
    right: 5px;
    color: #fff;
}

.msg-row.opponent .star-decor {
    bottom: -8px;
    left: 5px;
    color: #8E8E93; /* å¯¹æ–¹æ˜Ÿæ˜Ÿç”¨æ·¡ç°è‰²ï¼Œä¸å–§å®¾å¤ºä¸» */
}

/* 7. ç²¾è‡´åŠ¨ç”» */
@keyframes bubbleEnter {
    from { opacity: 0; transform: translateY(12px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes starPulse {
    0%, 100% { opacity: 0.4; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

/* 1. å¼ºåˆ¶ä¿®å¤ï¼šå¯¹æ–¹æ¶ˆæ¯é å·¦å¯¹é½ */
.msg-row.opponent {
    justify-content: flex-start !important; /* å¼ºåˆ¶é å·¦ */
    margin-right: auto !important; /* ç¡®ä¿ä¸å æ®å³ä¾§ç©ºé—´ */
}
/* ç¡®ä¿å¤´åƒå’Œæ°”æ³¡ç´§æŒ¨ç€ï¼Œæ²¡æœ‰å¤šä½™é—´è· */
.msg-row.opponent {
    gap: 8px !important;
}


/* 2. ç”¨ CSS ç”»ä¸€ä¸ªé«˜çº§çš„å››è§’æ˜Ÿ (æ›¿ä»£ä¸‘ Emoji) */
.star-decor-css {
    position: absolute;
    width: 12px;  /* æ˜Ÿæ˜Ÿå¤§å° */
    height: 12px;
    pointer-events: none;
    animation: starPulseCSS 2s infinite ease-in-out;
}

/* æ ¸å¿ƒé­”æ³•ï¼šç”¨ä¸¤ä¸ªä¼ªå…ƒç´ äº¤å‰åˆ›å»ºä¸€ä¸ªå››è§’æ˜Ÿ */
.star-decor-css::before,
.star-decor-css::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 2px; /* æ˜Ÿæ˜Ÿå…‰èŠ’çš„ç²—ç»† */
    background: currentColor; /* ç»§æ‰¿çˆ¶çº§æ°”æ³¡çš„æ–‡å­—é¢œè‰² */
    border-radius: 2px;
    transform: translate(-50%, -50%);
}
.star-decor-css::after {
    transform: translate(-50%, -50%) rotate(90deg); /* æ—‹è½¬90åº¦å½¢æˆåå­— */
}

/* 3. è®¾ç½®æ˜Ÿæ˜Ÿä½ç½®å’Œé¢œè‰² */
/* ç”¨æˆ·æ˜Ÿæ˜Ÿï¼šç™½è‰²ï¼Œåœ¨å³ä¸Šè§’ */
.msg-row.user .star-decor-css {
    top: -6px;
    right: 6px;
    color: #fff;
    filter: drop-shadow(0 0 4px rgba(255,255,255,0.6)); /* åŠ ç‚¹å‘å…‰æ•ˆæœ */
}
/* å¯¹æ–¹æ˜Ÿæ˜Ÿï¼šé«˜çº§ç°ï¼Œåœ¨å·¦ä¸‹è§’ */
.msg-row.opponent .star-decor-css {
    bottom: -6px;
    left: 6px;
    color: #A1A1A6;
}

/* 4. æ˜Ÿæ˜Ÿé—ªçƒåŠ¨ç”» */
@keyframes starPulseCSS {
    0%, 100% { opacity: 0.5; transform: scale(0.9) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.1) rotate(45deg); } /* ç¨å¾®è½¬ä¸€ä¸‹æ›´çµåŠ¨ */
}
/* --- ğŸš‘ æ¶ˆæ¯åˆ—è¡¨å·¦æ»‘äº¤äº’è¡¥ä¸ --- */

/* 1. æ»‘åŠ¨å®¹å™¨ï¼šéšè—æº¢å‡ºçš„æŒ‰é’® */
.swipe-item-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden; /* å…³é”®ï¼šéšè—å³ä¾§æŒ‰é’® */
    background: #fff;
    border-bottom: 0.5px solid #E5E5EA;
}

/* 2. å†…å®¹å±‚ï¼šçœŸæ­£æ˜¾ç¤ºæ¶ˆæ¯çš„éƒ¨åˆ† */
.swipe-content {
    position: relative;
    width: 100%;
    background: #fff;
    z-index: 2; /* ç›–åœ¨æŒ‰é’®ä¸Šé¢ */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: transform;
}

/* 3. æŒ‰é’®å±‚ï¼šè—åœ¨å³ä¾§ */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    display: flex;
    z-index: 1;
}

/* 4. å•ä¸ªæŒ‰é’®æ ·å¼ */
.swipe-btn {
    width: 75px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    color: #fff;
    cursor: pointer;
}

.btn-pin { background: #8E8E93; } /* ç½®é¡¶ï¼šiOS æ ‡å‡†ç°è‰² */
.btn-delete { background: #FF3B30; } /* åˆ é™¤ï¼šiOS æ ‡å‡†çº¢è‰² */

/* --- ğŸ’ æè‡´é«˜çº§æ„Ÿï¼šç½®é¡¶æ ·å¼é‡å¡‘ --- */

/* 1. ç½®é¡¶è¡Œçš„èƒŒæ™¯ï¼šä½¿ç”¨ææ·¡çš„å†·ç°è‰²ï¼Œè¥é€ â€œé›¾é¢ç»ç’ƒâ€æ„Ÿ */
.is-pinned .swipe-content {
    background: #F8F9FB !important; 
}

/* 2. å·¦ä¾§æµå…‰ä¾§è¾¹æ¡ï¼šåƒå‘¼å¸ä¸€æ ·å­˜åœ¨ */
.swipe-item-wrapper.is-pinned::before {
    content: "";
    position: absolute;
    left: 0;
    top: 15%; /* ä¸å°é¡¶ï¼Œæ›´æœ‰å‘¼å¸æ„Ÿ */
    height: 70%;
    width: 3.5px;
    background: #007AFF;
    border-radius: 0 4px 4px 0;
    z-index: 10;
    box-shadow: 2px 0 8px rgba(0, 122, 255, 0.2);
}

/* 3. æç®€çŸ¢é‡å›ºå®šé’ˆ (æ›¿ä»£ä¸‘å›¾å½¢) */
.pin-tag-ios {
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    margin-right: 4px;
}

.is-pinned .pin-tag-ios {
    display: flex !important;
}

/* ç”¨ CSS ç”»ä¸€ä¸ªæç»†çš„ç«–é’ˆï¼Œéå¸¸æœ‰è´¨æ„Ÿ */
.pin-needle {
    width: 1px;
    height: 10px;
    background: #8E8E93;
    position: relative;
}
.pin-needle::before {
    content: "";
    position: absolute;
    top: -2px;
    left: -3.5px;
    width: 8px;
    height: 1px;
    background: #8E8E93;
}
.pin-needle::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: -0.5px;
    width: 2px;
    height: 2px;
    border-radius: 50%;
    background: #8E8E93;
}

/* 4. ä¼˜åŒ–æ¶ˆæ¯è¡Œçš„æ’ç‰ˆï¼Œä¸ºç½®é¡¶ç•™å‡ºç©ºé—´ */
.is-pinned .contact-name {
    color: #007AFF !important; /* ç½®é¡¶çš„åå­—é¢œè‰²å¾®è°ƒæˆè“è‰²ï¼Œæ›´ç›´è§‚ */
}
/* --- ğŸš‘ å¼¹çª—å¼ºåˆ¶æ­£ä¸­å¿ƒå®šä½è¡¥ä¸ --- */
#iosConfirmModal.ios-alert-mask {
    display: none; /* åˆå§‹ç”± JS æ§åˆ¶æ˜¾ç¤º */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
    
    /* æ ¸å¿ƒå±…ä¸­æŒ‡ä»¤ */
    align-items: center !important; 
    justify-content: center !important;
    z-index: 999999 !important; /* ç¡®ä¿åœ¨æœ€æœ€æœ€é¡¶å±‚ */
}

/* å¼¹çª—æœ¬ä½“çš„å¾®è°ƒ */
#iosConfirmModal .ios-alert-box {
    width: 270px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 14px;
    overflow: hidden;
    animation: alertPopCenter 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    transform: none !important; /* æŠ¹é™¤ä¹‹å‰å¯èƒ½çš„åä½åç§» */
    margin: 0 auto !important;
}

@keyframes alertPopCenter {
    from { opacity: 0; transform: scale(1.1); }
    to { opacity: 1; transform: scale(1); }
}
/* --- ğŸ’ é«˜çº§ç½®é¡¶æ ‡è®°ï¼šçº¯ CSS çŸ¢é‡ç»˜å›¾ --- */

/* ç½®é¡¶çŠ¶æ€ä¸‹çš„èƒŒæ™¯è‰²ï¼šæµ…è“é›¾é¢æ„Ÿ */
.is-pinned .swipe-content {
    background: #F2F8FF !important; 
}

/* çŸ¢é‡æŠ˜è§’æ ‡è®° (æ›¿ä»£ä¸‘ Emoji) */
.pinned-mark {
    display: none;
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border-style: solid;
    /* 16px çš„ä¸‰è§’å½¢æŠ˜è§’ */
    border-width: 0 16px 16px 0; 
    border-color: transparent #007AFF transparent transparent;
    z-index: 5;
    opacity: 0.8;
}

/* åªæœ‰åœ¨ç½®é¡¶çŠ¶æ€ä¸‹æ‰æ˜¾ç¤ºæ ‡è®° */
.is-pinned .pinned-mark {
    display: block !important;
}

/* å¼ºåˆ¶å¼¹çª—å±…ä¸­çš„ä¼˜å…ˆçº§å†åŠ å›º */
#iosConfirmModal.ios-alert-mask {
    display: none;
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    align-items: center !important; /* å‚ç›´å±…ä¸­ */
    justify-content: center !important; /* æ°´å¹³å±…ä¸­ */
    z-index: 1000000 !important;
}
/* --- ğŸ’¬ æ€è€ƒä¸­ï¼šä¸‰ç‚¹è·³åŠ¨åŠ¨ç”» --- */
.typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
    height: 20px;
    padding: 4px 0;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #8E8E93; /* iOS æ ‡å‡†ç°è‰² */
    border-radius: 50%;
    display: inline-block;
    animation: dotPulse 1.4s infinite ease-in-out both;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes dotPulse {
    0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
    40% { transform: scale(1); opacity: 1; }
}
/* --- ğŸš‘ å¸ƒå±€æ€¥æ•‘ï¼šè®©è¾“å…¥æ¡†å’Œæ¶ˆæ¯è´´è¿‘ --- */
#page-chat-room .chat-scroll-area {
    flex: 1 !important;
    margin-top: 80px !important;    /* é¿å¼€é¡¶éƒ¨çš„è·ç¦» */
    margin-bottom: 0 !important;   /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šåˆ æ‰åŸæ¥çš„ 90px å¤–è¾¹è· */
    padding-bottom: 90px !important; /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå†…è¾¹è·è®¾ä¸º 90pxï¼Œåˆšå¥½ç»™æ‚¬æµ®æ¡†ç•™ä½ç½® */
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    display: block !important;
}

/* ç¡®ä¿èŠå¤©é¡µé¢é«˜åº¦é“ºæ»¡ï¼Œä¸äº§ç”Ÿæ–­å±‚ */
#page-chat-room {
    height: 100vh !important;
    display: flex !important;
    flex-direction: column !important;
}
/* --- ğŸ’ æ°”æ³¡é•¿æŒ‰/ç‚¹å‡»èœå• --- */
.bubble-context-menu {
    position: fixed;
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    width: 260px; /* å®½åº¦é€‚é…å››åˆ— */
    animation: menuPop 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

@keyframes menuPop {
    from { opacity: 0; transform: scale(0.8) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* èœå•ä¸»ä½“ */
.menu-box {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    border-radius: 20px;
    padding: 12px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* æ ¸å¿ƒï¼šå››åˆ—å¸ƒå±€ */
    gap: 15px 10px;
}

/* å•ä¸ªå›¾æ ‡æŒ‰é’® */
.menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.1s;
}
.menu-item:active { transform: scale(0.9); }

/* --- ğŸ”³ é»‘ç™½æç®€é£èœå•å›¾æ ‡ --- */
.menu-icon-circle {
    width: 44px; height: 44px;
    background: #f5f5f7; /* åº•è‰²æ”¹æˆæ›´æŸ”å’Œçš„æµ…ç° */
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    /* ç»Ÿä¸€å›¾æ ‡é¢œè‰²ä¸ºæ·±ç°è‰² */
    stroke: #333333 !important; 
    transition: background 0.2s;
}

/* é¼ æ ‡æ”¾ä¸Šå»å˜æ·±ä¸€ç‚¹ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
.menu-item:hover .menu-icon-circle {
    background: #e5e5e7;
}

/* å¼ºåˆ¶æ‰€æœ‰ SVG å›¾æ ‡ä¸ºé»‘ç™½ */
.menu-icon-circle svg {
    stroke: #333333 !important;
    fill: none !important; /* ç¡®ä¿æ²¡æœ‰å¡«å……è‰² */
}

/* èœå•æ–‡å­—é¢œè‰² */
.menu-item span {
    font-size: 10px;
    font-weight: 500;
    color: #666666; /* æ–‡å­—ä¹Ÿç”¨æŸ”å’Œçš„ç°è‰² */
    letter-spacing: 0.5px;
    margin-top: 4px;
}
.menu-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.2); /* ç¨å¾®æ·±ä¸€ç‚¹ç‚¹ï¼Œçªå‡ºèœå• */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 9998; /* å¿…é¡»åœ¨èœå• 10000 çš„ä¸‹é¢ï¼Œä½†åœ¨å…¶ä»–å…ƒç´ ä¸Šé¢ */
    display: none;
    cursor: default; /* ç¡®ä¿èƒ½æ•æ‰åˆ°ç‚¹å‡» */
}
/* --- ğŸ’¬ å¼•ç”¨åŠŸèƒ½ä¸“å±æ ·å¼ --- */
/* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„é¢„è§ˆæ¡ */
.quote-preview-bar {
    display: none; /* é»˜è®¤éšè— */
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-top: 0.5px solid #eee;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: slideUp 0.3s ease;
}

.quote-content-wrapper {
    border-left: 3px solid #007AFF; /* å¼•ç”¨è“æ¡ */
    padding-left: 10px;
    overflow: hidden;
}

.quote-user-name {
    font-size: 11px;
    font-weight: 700;
    color: #007AFF;
    margin-bottom: 2px;
}

.quote-text-preview {
    font-size: 13px;
    color: #666;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    max-width: 200px;
}

/* 2. æ°”æ³¡å†…éƒ¨çš„å¼•ç”¨å— */
.bubble-quote-box {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    padding: 8px 12px;
    margin-bottom: 8px;
    border-left: 2px solid #ddd;
    font-size: 12px;
    color: #8e8e93;
    line-height: 1.4;
}
/* --- å¤šé€‰æ¨¡å¼ä¸‹çš„å®¹å™¨è°ƒæ•´ --- */
.msg-row.multi-selecting {
    padding-left: 50px !important; /* ç»™å·¦ä¾§å¯¹å‹¾ç•™ç©ºé—´ */
    transition: padding 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* éšè—çš„å¯¹å‹¾å®¹å™¨ */
.msg-check-box {
    position: absolute;
    left: -40px; /* åˆå§‹è—åœ¨å·¦è¾¹ */
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    background: #fff;
    cursor: pointer;
}

/* é€‰ä¸­çŠ¶æ€ï¼šèƒŒæ™¯å˜è“ï¼Œæ¡†å˜è“ */
.msg-row.selected .msg-check-box {
    background: #007AFF;
    border-color: #007AFF;
}

/* é€‰ä¸­åçš„å¯¹å‹¾å›¾æ ‡ (ç”¨ CSS ç”»ä¸€ä¸ªç™½è‰²çš„å¯¹å‹¾) */
.msg-row.selected .msg-check-box::after {
    content: '';
    width: 10px;
    height: 5px;
    border-left: 2px solid #fff;
    border-bottom: 2px solid #fff;
    transform: rotate(-45deg);
    margin-top: -2px;
}

/* --- å¤šé€‰åº•æ ï¼šæµ®åŠ¨åœ¨è¾“å…¥æ¡†ä¹‹ä¸Š --- */
.multi-select-footer {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    height: 85px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-top: 0.5px solid #eee;
    display: none; /* é»˜è®¤éšè— */
    justify-content: space-around;
    align-items: center;
    padding-bottom: 20px;
    z-index: 200;
    animation: slideUp 0.3s ease;
}

.multi-action-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    color: #007AFF;
    cursor: pointer;
}
.multi-action-item span { font-size: 10px; font-weight: 600; }
.multi-action-item.danger { color: #FF3B30; } /* åˆ é™¤æŒ‰é’®ç”¨çº¢è‰² */
/* é€‰ä¸­åçš„æ•´è¡ŒèƒŒæ™¯å¾®è°ƒï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
.msg-row.multi-selecting.selected {
    background-color: rgba(0, 122, 255, 0.05); 
}

/* é‡ç‚¹ï¼šé€‰ä¸­çš„æ°”æ³¡åº•è‰²å˜æ·±ï¼Œè®©äººä¸€çœ¼çœ‹å‡ºé€‰äº†è° */
.msg-row.selected .bubble {
    box-shadow: 0 0 0 2px #007AFF inset !important; /* è“è‰²å†…è¾¹æ¡† */
    background: rgba(0, 122, 255, 0.1) !important; /* ææ·¡çš„è“è‰²èƒŒæ™¯ */
}

/* å¼ºåˆ¶æ˜¾ç¤ºå¯¹å‹¾å®¹å™¨ï¼Œå¹¶å¢åŠ åŠ¨ç”» */
.msg-check-box {
    position: absolute;
    left: 15px; /* ç§»åˆ°å¯è§åŒºåŸŸ */
    top: 50%;
    transform: translateY(-50%) scale(0.8);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    background: #fff;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
}

.msg-row.selected .msg-check-box {
    transform: translateY(-50%) scale(1.1); /* é€‰ä¸­æ—¶ç¨å¾®æ”¾å¤§ï¼Œæœ‰å¼¹åŠ›æ„Ÿ */
    background: #007AFF;
    border-color: #007AFF;
}
/* --- æ ¸å¿ƒä¿®å¤ï¼šå¯¹å‹¾åœ†åœˆé»˜è®¤å½»åº•éšè— --- */
.msg-check-box {
    position: absolute;
    left: -40px; /* åˆå§‹èº²åœ¨å±å¹•å¤– */
    top: 50%;
    transform: translateY(-50%) scale(0.5);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    background: #fff;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0; /* é»˜è®¤é€æ˜ */
    pointer-events: none; /* éå¤šé€‰æ¨¡å¼ä¸å¯ç‚¹å‡» */
    z-index: 10;
}

/* --- åªæœ‰è¿›å…¥å¤šé€‰æ¨¡å¼ï¼Œåœ†åœˆæ‰æ»‘å…¥å¹¶æ˜¾å½¢ --- */
.msg-row.multi-selecting .msg-check-box {
    left: 15px; 
    opacity: 1;
    transform: translateY(-50%) scale(1);
    pointer-events: auto;
}

/* é€‰ä¸­åçš„æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼Œä½†ç¡®ä¿å®ƒåªåœ¨ multi-selecting ä¸‹ç”Ÿæ•ˆï¼‰ */
.msg-row.multi-selecting.selected .msg-check-box {
    background: #007AFF;
    border-color: #007AFF;
}

/* é€‰ä¸­åçš„æ°”æ³¡é«˜äº®ï¼šé€€å‡ºæ¨¡å¼åç”±äºå»æ‰äº† selected ç±»ï¼Œè¿™ä¸ªä¼šè‡ªåŠ¨æ¶ˆå¤± */
.msg-row.selected .bubble {
    box-shadow: 0 0 0 2px #007AFF inset !important;
    background: rgba(0, 122, 255, 0.05) !important;
}
/* è½¬å‘æ¶ˆæ¯çš„ç‰¹æ®Šæ ·å¼ */
.is-forwarded .bubble {
    border-left: 3.5px solid #C7C7CC !important; /* å·¦ä¾§æµ…ç°è‰²ç²—çº¿ï¼ŒåŒºåˆ†åŸç”Ÿæ¶ˆæ¯ */
    position: relative;
}

/* è½¬å‘æ ‡è®°å°æ–‡å­— */
.forward-label {
    font-size: 9px;
    color: #8E8E93;
    font-weight: 700;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.forward-label svg { width: 10px; height: 10px; }
/* --- ä¸“é—¨é’ˆå¯¹è½¬å‘é€‰æ‹©é¡µçš„é¿è®©é€»è¾‘ --- */

#page-forward-picker {
    /* 1. æ ¸å¿ƒä¿®å¤ï¼šæŠŠå±‚çº§è°ƒåˆ° 9000ï¼Œç¡®ä¿ä½äºçŠ¶æ€æ çš„ 9999 */
    z-index: 50000 !important; 
    
    /* 2. æ ¸å¿ƒä¿®å¤ï¼šé¡¶éƒ¨ç•™å‡º 48px çš„ç‰©ç†ç©ºé—´ï¼ŒæŠŠé¡µé¢é¡¶ä¸‹å»ï¼Œç»™çŠ¶æ€æ ç•™ä½å­ */
    padding-top: 48px !important; 
    
    /* 3. å¼ºåˆ¶èƒŒæ™¯é“ºæ»¡å…¨å±ï¼Œé˜²æ­¢å‡ºç°æˆªå›¾é‡Œé‚£ç§ç¼©æ°´çš„æƒ…å†µ */
    width: 100vw !important;
    height: 100vh !important;
    background: #F2F2F7 !important;
    display: flex !important;
    flex-direction: column !important;
}

/* 4. ä¿®å¤è½¬å‘é¡µé¢çš„å¤´éƒ¨ï¼šä¸å†é¡¶ç€å±å¹•è¾¹ç¼˜ */
#page-forward-picker .app-header {
    height: 60px !important;
    padding: 0 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    background: #F2F2F7 !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
    flex-shrink: 0 !important;
}

/* 5. ä¿®å¤æˆªå›¾ 3 ä¸­åˆ—è¡¨ç¼©æˆä¸€å›¢çš„é—®é¢˜ï¼šå¼ºåˆ¶å†…å®¹æ’‘æ»¡ */
#page-forward-picker .app-body {
    flex: 1 !important;
    width: 100% !important;
    display: block !important; /* ç¦ç”¨ Flex é˜²æ­¢å†…å®¹æ°´å¹³æŒ¤å‹ */
    overflow-y: auto !important;
    padding: 10px 16px 80px 16px !important; /* åº•éƒ¨ç•™å‡ºç©ºé—´ */
    box-sizing: border-box !important;
}

/* 6. ç¡®ä¿åˆ—è¡¨è¡Œä¹Ÿæ˜¯æ»¡å®½çš„ */
#page-forward-picker .chat-contact-group {
    width: 100% !important;
    margin: 0 !important;
}

#page-forward-picker .contact-row {
    width: 100% !important;
    padding-right: 16px !important;
    box-sizing: border-box !important;
}
/* 1. æ’¤å›æ¶ˆæ¯çš„ç³»ç»Ÿæç¤ºæ ·å¼ */
.recalled-msg-hint {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 12px 0;
    width: 100%;
    animation: msgFadeUp 0.4s ease;
}

.recalled-msg-hint span {
    background: rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(5px);
    color: #8E8E93;
    font-size: 11px;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.recalled-msg-hint span:active {
    background: rgba(0, 0, 0, 0.1);
}

/* 2. æŸ¥é˜…æ’¤å›å†…å®¹çš„ç²¾ç¾å¡ç‰‡ */
.recalled-content-card {
    width: 80%;
    max-width: 300px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: saturate(180%) blur(25px);
    border-radius: 30px;
    padding: 30px 25px;
    text-align: center;
    box-shadow: 0 30px 60px rgba(0,0,0,0.15);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

.recalled-v-label {
    font-size: 10px;
    color: #8E8E93;
    letter-spacing: 2px;
    font-weight: 800;
    margin-bottom: 15px;
}

.recalled-v-text {
    font-size: 16px;
    color: #1d1d1f;
    line-height: 1.6;
    text-align: left;
    margin-bottom: 25px;
    max-height: 200px;
    overflow-y: auto;
    font-family: serif;
    font-style: italic;
}
/* ç¡®ä¿èœå•é¡¹é»˜è®¤æ˜¯æ˜¾ç¤ºçš„ */
.menu-item {
    display: flex !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

/* é’ˆå¯¹æ’¤å›æŒ‰é’®çš„ä¸“å±å›¾æ ‡é¢œè‰² */
#menu-recall .menu-icon-circle {
    stroke: #333 !important;
}

/* éšè—çŠ¶æ€ä¸‹çš„ç±»åï¼ˆå¤‡ç”¨ï¼‰ */
.menu-item.hidden {
    display: none !important;
}
/* --- âš™ï¸ è®¾ç½®é¡µï¼šé«˜çº§æŠ˜å äº¤äº’æ ·å¼ --- */

/* 1. æŠ˜å å®¹å™¨ */
/* --- æ›¿æ¢æ–¹æ¡ˆï¼šæ— æ¨ªçº¿ï¼Œç”±é—´è·åˆ†éš”çš„ç‹¬ç«‹å¡ç‰‡ --- */
.ios-accordion-item {
    background: #fff;
    overflow: hidden;
    transition: all 0.2s ease;
    
    /* 1. å»æ‰æ¨ªçº¿ */
    border-bottom: none; 
    
    /* 2. åŠ ä¸Šåº•éƒ¨é—´è·ï¼Œè®©å®ƒä»¬åˆ†å¼€ */
    margin-bottom: 1px; 
}

/* 3. ç»™æœ€å¤–å±‚çš„å®¹å™¨åŠ ä¸ªèƒŒæ™¯è‰²ï¼Œè¿™æ ·é—´è·å°±ä¼šé€å‡ºèƒŒæ™¯è‰²ï¼Œå½¢æˆè‡ªç„¶çš„åˆ†å‰² */
.ios-list-group {
    background: #F2F2F7 !important; /* ç¡®ä¿åº•è‰²æ˜¯ç°çš„ */
    padding: 0 !important;
    overflow: hidden;
    gap: 1px; /* å¤‡ç”¨æ–¹æ¡ˆ */
}

/* 2. å¤´éƒ¨ç‚¹å‡»åŒº (ä¿æŒåŸæœ¬çš„åˆ—è¡¨è¡Œæ ·å¼ï¼Œä½†å¢åŠ äº†ç‚¹å‡»åé¦ˆ) */
.accordion-header {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    cursor: pointer;
    background: #fff;
    position: relative;
    z-index: 2;
    transition: background 0.2s;
}
.accordion-header:active {
    background: #F2F2F7;
}

/* æ—‹è½¬çš„å°ç®­å¤´ */
.accordion-chevron {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #C7C7CC;
}
/* æ¿€æ´»æ—¶ç®­å¤´å‘ä¸‹è½¬ */
.ios-accordion-item.active .accordion-chevron {
    transform: rotate(90deg);
    color: #007AFF;
}

/* 3. å†…å®¹å±•å¼€åŒº (é»˜è®¤é«˜åº¦0ï¼Œéšè—) */
.accordion-content {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    background: #F9F9F9; /* å±•å¼€åçš„åº•è‰²ç¨å¾®æ·±ä¸€ç‚¹ï¼ŒåŒºåˆ†å±‚çº§ */
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
}

/* æ¿€æ´»æ—¶å±•å¼€ */
.ios-accordion-item.active .accordion-content {
    max-height: 1000px; /* ç»™ä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜åº¦ */
    opacity: 1;
    padding-bottom: 15px; /* åº•éƒ¨ç•™ç™½ */
    border-top: 0.5px solid #eee; /* é¡¶éƒ¨åŠ æ¡çº¿åŒºåˆ† */
}

/* å±•å¼€åŒºåŸŸå†…çš„æ“ä½œæŒ‰é’® */
.sub-setting-btn {
    margin: 10px 16px 0 16px;
    padding: 12px;
    background: #fff;
    border-radius: 10px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: #007AFF;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
    cursor: pointer;
}
.sub-setting-btn:active { transform: scale(0.98); }

/* --- ğŸš« åº•éƒ¨ç‹¬ç«‹æŒ‰é’®ç»„ (Danger Zone) --- */
.danger-zone-container {
    margin-top: 30px;
    padding: 0 10px;
    display: flex;
    flex-direction: column;
    gap: 12px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
}

.standalone-btn {
    width: 100%;
    padding: 16px;
    background: #fff;
    border-radius: 14px; /* æ›´åœ†æ¶¦çš„ç‹¬ç«‹å— */
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03); /* æ·¡æ·¡çš„æµ®èµ·æ„Ÿ */
    cursor: pointer;
    transition: all 0.2s;
}

.standalone-btn:active {
    transform: scale(0.98);
    background: #f2f2f2;
}

/* è“è‰²åŠŸèƒ½æŒ‰é’® */
.btn-blue-text { color: #007AFF; }
/* çº¢è‰²å±é™©æŒ‰é’® */
.btn-red-text { color: #FF3B30; }
/* ==========================================
   ğŸ´ğŸ–¤ ç»ˆæé»‘ç™½Â·å…ˆé”‹æç®€é£æ ¼è¡¥ä¸ ğŸ–¤ğŸ´
   ========================================== */

/* 1. å®¹å™¨ï¼šå½»åº•éšå½¢ï¼Œåªç•™é—´è· */
.ios-list-group {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 4px !important; /* å·¦å³ç¨å¾®ç•™ç‚¹å‘¼å¸æ„Ÿ */
    overflow: visible !important;
}

/* 2. å¡ç‰‡æœ¬ä½“ï¼šçº¯ç™½æ‚¬æµ®å—ï¼Œå¤§åœ†è§’ */
.ios-accordion-item {
    background: #FFFFFF !important;
    margin-bottom: 16px !important; /* ğŸŸ¢ æ˜¾è‘—çš„é—´è·ï¼Œåƒæ¼‚æµ®çš„ç§¯æœ¨ */
    border-radius: 24px !important; /* æ›´ç°ä»£çš„è¶…å¤§åœ†è§’ */
    border: 1px solid rgba(0,0,0,0.03) !important; /* æç»†å¾®çš„è¾¹æ¡†æå‡è´¨æ„Ÿ */
    box-shadow: 0 8px 20px rgba(0,0,0,0.04) !important; /* é«˜çº§æŸ”å…‰é˜´å½± */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
}

/* æ¿€æ´»çŠ¶æ€ï¼ˆå±•å¼€æ—¶ï¼‰ï¼šç¨å¾®æµ®èµ·ä¸€ç‚¹ */
.ios-accordion-item.active {
    box-shadow: 0 12px 30px rgba(0,0,0,0.08) !important;
    transform: translateY(-2px);
}

/* 3. å¤´éƒ¨åŒºåŸŸï¼šåŠ é«˜ï¼Œå‚ç›´å±…ä¸­ */
.accordion-header {
    padding: 18px 20px !important; /* æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
    background: transparent !important;
}

/* 4. å›¾æ ‡é‡å¡‘ï¼šå¼ºåˆ¶é»‘ç™½åŒ– (æ ¸å¿ƒï¼) */
.item-icon {
    /* æŠŠåŸæ¥çš„å½©è‰²èƒŒæ™¯å…¨éƒ¨å¹²æ‰ï¼Œæ¢æˆææ·¡çš„ç°è‰² */
    background: #F2F2F7 !important; 
    border-radius: 50% !important; /* å˜æˆåœ†å½¢ */
    width: 44px !important;
    height: 44px !important;
    box-shadow: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin-right: 16px !important;
}

/* å¼ºåˆ¶æ‰€æœ‰ SVG çº¿æ¡å˜é»‘ */
.item-icon svg {
    stroke: #1d1d1f !important; /* è‹¹æœé»‘ */
    fill: none !important;      /* å»æ‰å¡«å……è‰² */
    width: 20px !important;
    height: 20px !important;
    stroke-width: 2.2 !important; /* çº¿æ¡åŠ ç²—ä¸€ç‚¹ç‚¹ï¼Œæ›´æœ‰åŠ› */
}

/* 5. æ–‡å­—æ’ç‰ˆï¼šåŠ ç²—ï¼Œçº¯é»‘ */
.item-label {
    font-size: 16px !important;
    font-weight: 700 !important; /* åŠ ç²— */
    color: #000000 !important;
    letter-spacing: -0.5px !important; /* ç´§å‡‘ä¸€ç‚¹æ›´ç²¾è‡´ */
}

/* 6. å³ä¾§ç®­å¤´ï¼šé»‘è‰²æç®€ */
.accordion-chevron {
    color: #000 !important;
    opacity: 0.3 !important;
    width: 16px !important;
    height: 16px !important;
    stroke-width: 3 !important;
}
.ios-accordion-item.active .accordion-chevron {
    opacity: 1 !important;
    color: #000 !important; /* æ¿€æ´»ä¹Ÿæ˜¯é»‘è‰² */
}

/* 7. å±•å¼€å†…å®¹åŒºï¼šé»‘ç™½åè½¬ */
.accordion-content {
    background: #fff !important;
    padding: 0 20px 24px 20px !important; /* åº•éƒ¨ç•™è¶³ç©ºé—´ */
    border-top: none !important;
}

/* 8. å†…éƒ¨æ“ä½œæŒ‰é’®ï¼šé»‘åº•ç™½å­— (é…·ï¼) */
.sub-setting-btn {
    background: #1d1d1f !important; /* çº¯é»‘åº• */
    color: #ffffff !important;      /* çº¯ç™½å­— */
    border-radius: 14px !important;
    padding: 14px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    letter-spacing: 0.5px !important;
    border: none !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15) !important; /* é»‘è‰²æŒ‰é’®çš„æŠ•å½± */
    margin-top: 12px !important;
}
.sub-setting-btn:active {
    transform: scale(0.97) !important;
    opacity: 0.8 !important;
}

/* 9. åº•éƒ¨å±é™©åŒºæŒ‰é’®ï¼šä¿æŒé»‘ç™½æç®€ */
.standalone-btn {
    border-radius: 18px !important;
    background: #fff !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03) !important;
    border: 1px solid rgba(0,0,0,0.02) !important;
}
/* å±é™©æŒ‰é’®æ–‡å­—ä¿ç•™çº¢è‰²ï¼Œå…¶ä»–çš„å˜é»‘ */
.btn-blue-text { color: #1d1d1f !important; }
/* --- ğŸ–¤ èŠå¤©èƒŒæ™¯è®¾ç½®é«˜çº§é»‘ç™½ UI --- */
.bg-config-container {
    padding: 20px;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.bg-config-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 18px;
    border: 1px solid #f0f0f0;
}

.bg-label-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.bg-main-title {
    font-size: 15px;
    font-weight: 700;
    color: #1d1d1f;
}

.bg-sub-hint {
    font-size: 11px;
    color: #8e8e93;
}

/* é¢„è§ˆæ¡†ï¼šå¼ºåˆ¶ 9:16 æ¯”ä¾‹ */
.bg-preview-box {
    width: 60px;
    height: 106px;
    background: #eee;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    border: 2px solid #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    cursor: pointer;
    flex-shrink: 0;
}

.bg-preview-box img, .bg-preview-box video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.bg-preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    color: #bbb;
    text-align: center;
    font-weight: 600;
    line-height: 1.2;
}

.bg-edit-badge {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 8px;
    text-align: center;
    padding: 2px 0;
    font-weight: 800;
}

/* åº•éƒ¨æ“ä½œæŒ‰é’® */
.bg-action-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.bg-save-btn {
    flex: 2;
    background: #1d1d1f;
    color: #fff;
    padding: 14px;
    border-radius: 14px;
    text-align: center;
    font-weight: 700;
    font-size: 14px;
}

.bg-reset-btn {
    flex: 1;
    background: #f2f2f7;
    color: #ff3b30;
    padding: 14px;
    border-radius: 14px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
}

/* --- ğŸŒ«ï¸ ä¸‡èƒ½èƒŒæ™¯ä¸Šä¼ å¼¹çª— (é»‘ç™½ç‰ˆ) --- */
#modal-universal-uploader .modal-content {
    background: #fff;
    border-top: 1px solid #eee;
}

.uploader-type-tag {
    display: inline-block;
    padding: 4px 10px;
    background: #1d1d1f;
    color: #fff;
    font-size: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
    font-weight: 800;
}

.url-input-wrapper {
    margin-bottom: 20px;
}
.bg-preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #1d1d1f; /* çº¯é»‘æ–‡å­— */
    background: #f2f2f7; /* æµ…ç°åº• */
    text-align: center;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.bg-edit-badge {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: #1d1d1f; /* çº¯é»‘åº• */
    color: #fff; /* çº¯ç™½å­— */
    font-size: 9px;
    text-align: center;
    padding: 3px 0;
    font-weight: 900;
    letter-spacing: 1px;
}
/* --- ğŸš¨ æ ¸å¿ƒï¼šå¼ºåˆ¶å…¨å±é€è§†è¡¥ä¸ --- */

/* 3. è®©å¤´éƒ¨ä¹Ÿå˜é€æ˜ï¼ˆæˆ–è€…ç»™ä¸ªææ·¡çš„ç£¨ç ‚æ„Ÿï¼‰ */
#page-chat-room .chat-room-header {
    background: rgba(255, 255, 255, 0.2) !important; /* 20% é€æ˜ç™½ */
    backdrop-filter: blur(10px) !important; /* iOS ç£¨ç ‚æ„Ÿ */
}

/* 4. åº•éƒ¨è¾“å…¥æ¡†èƒŒæ™¯ä¹Ÿé€æ˜åŒ– */
#page-chat-room .chat-room-footer {
    background: rgba(255, 255, 255, 0.4) !important;
    backdrop-filter: blur(20px) !important;
}

/* 5. ä¸“é—¨çš„ç‰©ç†èƒŒæ™¯å±‚æ ·å¼ */
#chat-room-full-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* é’‰åœ¨æœ€åº•å±‚ */
    pointer-events: none; /* ä¸å¹²æ‰°ç‚¹å‡»æ¶ˆæ¯ */
    overflow: hidden;
}

#chat-room-full-bg img, #chat-room-full-bg video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* æ ¸å¿ƒï¼šå¼ºåˆ¶è£åˆ‡æ’‘æ»¡ */
}
/* --- ğŸš¨ 1. å½»åº•é€šé€è¡¥ä¸ï¼šè§£å†³é¡¶éƒ¨ä¸é€æ˜é—®é¢˜ --- */
#page-chat-room, 
#page-chat-room .chat-room-header,
#page-chat-room .chat-scroll-area,
.status-bar {
    background: transparent !important; /* ç‰©ç†å¼ºåˆ¶é€æ˜ */
    background-color: transparent !important;
    border: none !important;
    box-shadow: none !important;
}

/* å¦‚æœä½ çš„ app-window æœ‰é»˜è®¤åº•è‰²ï¼Œä¹Ÿè¦å¹²æ‰ */
.ios-app-window.chat-room-layer {
    background: transparent !important;
}

/* --- âœ¨ 2. æ˜µç§°å‘å…‰è¡¥ä¸ï¼šè§£å†³æ·±è‰²èƒŒæ™¯çœ‹ä¸æ¸… --- */
#room-contact-name {
    color: #ffffff !important; /* å¼ºåˆ¶æ”¹ä¸ºç™½è‰² */
    /* æ ¸å¿ƒï¼šåŒå±‚æŠ•å½±ã€‚ä¸€å±‚ç™½è‰²æ‰©æ•£å…‰æ™•ï¼Œä¸€å±‚é»‘è‰²è¾¹ç¼˜æè¾¹ï¼Œç¡®ä¿åœ¨ä»»ä½•èƒŒæ™¯éƒ½æ¸…æ™° */
    text-shadow: 
        0 0 15px rgba(255, 255, 255, 0.6), 
        0 2px 4px rgba(0, 0, 0, 0.8) !important;
    font-weight: 800 !important;
}

/* --- â• 3. åŠ å·æŒ‰é’®è¡¥ä¸ï¼šå¢åŠ å¯è§åº¦ --- */
.footer-add-btn {
    color: #ffffff !important; /* æ”¹ä¸ºç™½è‰² */
    background: rgba(255, 255, 255, 0.2) !important; /* ç»™æŒ‰é’®åŠ ä¸ªæ·¡æ·¡çš„åœ†å½¢åº•è‰² */
    width: 32px !important;
    height: 32px !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px); /* ç»ç’ƒæ„Ÿ */
    transition: all 0.2s;
}

.footer-add-btn:active {
    background: rgba(255, 255, 255, 0.4) !important;
    transform: scale(0.9);
}

/* --- ğŸ“± 4. çŠ¶æ€æ æ–‡å­—é€‚é… --- */
/* å¦‚æœèƒŒæ™¯å¤ªæ·±ï¼ŒçŠ¶æ€æ çš„ 15:58 å’Œç”µé‡ä¹Ÿè¦å˜ç™½ */
#page-chat-room .status-bar,
#page-chat-room .status-bar * {
    color: white !important;
    fill: white !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* é¡ºä¾¿ä¼˜åŒ–ä¸€ä¸‹è¿”å›æŒ‰é’® */
.header-glass-btn.left {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}
/* --- ğŸš¨ ä¿®æ”¹è¿™ä¸€æ®µ --- */
#page-chat-room {
    /* åˆ é™¤åŸæ¥çš„ background-color: transparent !important; */
    background-color: #F2F2F7; /* èµ‹äºˆé»˜è®¤çš„ iOS ç³»ç»Ÿç° */
    position: fixed !important;
}

/* å†…éƒ¨çš„æ»šåŠ¨åŒºåŸŸå’Œå¤´éƒ¨ä¾ç„¶ä¿æŒé€æ˜ï¼Œè¿™æ ·æ‰èƒ½çœ‹åˆ°åº•ä¸‹çš„èƒŒæ™¯èˆ± */
#page-chat-room .chat-scroll-area {
    background-color: transparent !important;
}

/* èƒŒæ™¯èˆ±å±‚çº§ç¨å¾®è°ƒé«˜åˆ° -1ï¼Œç¡®ä¿å®ƒåœ¨å®¹å™¨åº•è‰²ä¹‹ä¸Šï¼Œä½†åœ¨å†…å®¹ä¹‹ä¸‹ */
#chat-room-full-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* è°ƒæˆ 0 */
    pointer-events: none;
    overflow: hidden;
}

/* æ¶ˆæ¯è¡Œéœ€è¦æåˆ°èƒŒæ™¯èˆ±ä¸Šé¢ */
.chat-scroll-area {
    position: relative;
    z-index: 1; 
}
/* --- ğŸš¨ å½»åº•é€šé€è¡¥ä¸ï¼šç§»é™¤æ¨¡ç³Šï¼Œè¿˜åŸæ¸…æ™°èƒŒæ™¯ --- */

/* 1. ç§»é™¤å¤´éƒ¨çš„ç£¨ç ‚ç»ç’ƒæ•ˆæœå’ŒèƒŒæ™¯è‰² */
#page-chat-room .chat-room-header {
    background: transparent !important;
    background-color: transparent !important;
    backdrop-filter: none !important;        /* å…³é”®ï¼šæ’¤é”€æ¨¡ç³Š */
    -webkit-backdrop-filter: none !important; /* å…¼å®¹ iOS */
    border-bottom: none !important;           /* ç§»é™¤ç»†çº¿ */
    box-shadow: none !important;              /* ç§»é™¤é˜´å½± */
}

/* 2. åŒæ—¶ç¡®ä¿çŠ¶æ€æ ä¹Ÿæ˜¯å®Œå…¨æ¸…æ¾ˆé€æ˜çš„ */
#page-chat-room .status-bar {
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

/* 3. ç¡®ä¿èƒŒæ™¯å±‚å»¶ä¼¸åˆ°æœ€é¡¶éƒ¨ï¼ˆé˜²æ­¢é¡¶éƒ¨ç•™ç™½ï¼‰ */
#chat-room-full-bg {
    top: 0 !important;
    height: 100vh !important;
}

/* 4. å†æ¬¡åŠ å›ºæ˜µç§°å’ŒçŠ¶æ€æ æ–‡å­—çš„æ¸…æ™°åº¦ï¼ˆå‘å…‰å¤–æŒ‚ï¼‰ */
#room-contact-name, 
#page-chat-room .status-bar, 
#page-chat-room .status-bar * {
    color: #ffffff !important;
    text-shadow: 
        0 1px 8px rgba(0, 0, 0, 0.6), 
        0 0 12px rgba(255, 255, 255, 0.4) !important;
}
/* --- ğŸ iOS é£æ ¼æˆåŠŸ HUD (é»‘ç™½æç®€) --- */
.ios-hud {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    width: 140px;
    height: 140px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-radius: 28px;
    display: none; 
    flex-direction: column;
    align-items: center;      /* ç¡®ä¿å†…éƒ¨å…ƒç´ æ°´å¹³å±…ä¸­ */
    justify-content: center;   /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´å±…ä¸­ */
    padding: 20px;             /* å¢åŠ ä¸€ç‚¹å†…è¾¹è·ï¼Œé˜²æ­¢å­—è´´è¾¹ */
    box-sizing: border-box;
}

/* æ¿€æ´»çŠ¶æ€ */
.ios-hud.show {
    display: flex;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

/* æˆåŠŸçš„å‹¾å‹¾åŠ¨ç”» */
.hud-checkmark {
    width: 60px;
    height: 60px;
    stroke: #1d1d1f; /* æç®€é»‘ */
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
}

.ios-hud.show .hud-checkmark {
    animation: dash 0.6s ease-in-out forwards 0.2s;
}

@keyframes dash {
    to { stroke-dashoffset: 0; }
}

.hud-text {
    width: 100%;               /* æ’‘æ»¡å®½åº¦ï¼Œå¦åˆ™ text-align æ— æ•ˆ */
    text-align: center;        /* ğŸš¨ å…³é”®ï¼šå¼ºåˆ¶å¤šè¡Œæ–‡å­—ä¹Ÿå±…ä¸­ */
    margin-top: 15px;
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
    line-height: 1.4;          /* å¢åŠ è¡Œé«˜ï¼Œè®©ä¸¤è¡Œå­—ä¹‹é—´ä¸é‚£ä¹ˆæŒ¤ */
    word-break: break-all;     /* é˜²æ­¢é•¿å•è¯æ’‘ç ´å¸ƒå±€ */
}
/* --- 1. å¥½å‹ç¯ä¸“å±ï¼šç¤¾äº¤åç‰‡æ ·å¼ --- */
.social-card {
    width: 280px;
    background: #fff;
    border-radius: 32px;
    padding: 30px 20px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
}
.social-online-tag {
    font-size: 10px; color: #34C759; font-weight: 800; letter-spacing: 1.5px; margin: 8px 0;
}
.social-motto {
    font-size: 13px; color: #666; background: #f2f2f7; padding: 12px; border-radius: 15px; margin: 15px 0 25px 0;
}
.social-actions {
    display: flex; justify-content: space-around; border-top: 0.5px solid #eee; padding-top: 20px;
}
.social-btn-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #007AFF; cursor: pointer; }
.social-btn-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; }

/* --- 2. è®¾ç½®é¡µä¸“å±ï¼šé«˜å®šæ¡£æ¡ˆå¡ç‰‡ --- */
.aesthetic-preview-card {
    width: 320px;
    background: #ffffff;
    border-radius: 40px;
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.2);
}
.aes-pre-header { height: 100px; background: #1d1d1f; position: relative; } /* é»‘ç™½æç®€é¡¶æ  */
.aes-pre-avatar { width: 100px; height: 100px; border: 5px solid #fff; border-radius: 30px; position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%) rotate(-3deg); object-fit: cover; }
.aes-pre-body { padding: 60px 25px 30px 25px; text-align: center; }
.aes-pre-name { font-family: serif; font-size: 26px; font-weight: 800; color: #000; }
.aes-pre-desc-box { background: #f9f9f9; padding: 15px; border-radius: 18px; margin-top: 20px; text-align: left; max-height: 150px; overflow-y: auto; }
.aes-pre-desc-box p { font-size: 13px; color: #444; line-height: 1.6; font-style: italic; }

/* --- 3. å±‚çº§é”æ­» --- */
.modal-top-layer {
    position: fixed !important; inset: 0 !important;
    z-index: 9995 !important; /* ä»…ä½äºçŠ¶æ€æ  */
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(15px);
    display: none; align-items: center; justify-content: center;
}
/* --- ğŸ› ï¸ ç¤¾äº¤å¡ç‰‡å¢å¼ºæ ·å¼ --- */

/* 1. ç‰©ç†å…³é—­æŒ‰é’® */
.social-close-trigger {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 30px;
    height: 30px;
    background: #f2f2f7; /* æµ…ç°åº• */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8e8e93;
    cursor: pointer;
    transition: all 0.2s;
}
.social-close-trigger:active {
    transform: scale(0.9);
    background: #e5e5ea;
}

/* 2. è®©ç­¾ååŒºåŸŸçœ‹èµ·æ¥â€œå¯ç‚¹å‡»â€ */
.social-motto {
    cursor: pointer;
    position: relative;
    transition: background 0.2s, transform 0.1s;
    border: 1px solid transparent;
}
.social-motto:hover {
    background: #ebebee;
}
.social-motto:active {
    transform: scale(0.98);
}

/* 3. ç¡®ä¿ç¤¾äº¤å¡ç‰‡å®¹å™¨å¯ä»¥ç›¸å¯¹å®šä½æŒ‰é’® */
.social-card {
    position: relative; /* å¿…é¡»åŠ è¿™ä¸€è¡Œ */
    width: 290px !important;
}
/* --- ğŸš¨ ç‰©ç†å±‚çº§ç»ˆæé”æ­»è¡¥ä¸ --- */

/* 1. é®ç½©åŸºç¡€æ ·å¼ï¼šç¡®ä¿æ˜¯ fixed ä¸”å…¨å± */
.vibe-center-mask, .modal-top-layer {
    position: fixed !important;
    inset: 0 !important;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
}

/* 2. ç¬¬ä¸€å±‚ï¼šç¤¾äº¤å¡ç‰‡ä¸é¢„è§ˆå¡ç‰‡ */
#modal-social-card, 
#modal-aes-preview {
    z-index: 30000 !important; 
}

/* 3. ç¬¬äºŒå±‚ï¼šä¿®æ”¹å¼¹çª—ï¼ˆå¿…é¡»ç›–è¿‡ä¸Šé¢çš„å¡ç‰‡ï¼‰ */
#modal-motto-edit {
    z-index: 35000 !important; /* ğŸ‘ˆ è¿™é‡Œé«˜å‡º 5000 ç‚¹ï¼Œç»å¯¹å‹åˆ¶ */
}

/* 4. ç¬¬ä¸‰å±‚ï¼šæˆåŠŸæç¤º HUD */
#save-success-hud {
    z-index: 40000 !important;
}

/* 5. é¡¶å±‚ï¼šçŠ¶æ€æ  */
.status-bar {
    z-index: 50000 !important;
}
/* --- ğŸš¨ èµ„æ–™é¡µå¸ƒå±€ç»ˆæä¿®æ­£ï¼šå¼ºåˆ¶å…¨å±æ‹‰ä¼¸ --- */

#subpage-char-profile {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important; 
    z-index: 9990 !important;
    padding-top: 0px !important; /* ç‰©ç†é¿å¼€çŠ¶æ€æ  */
    display: flex !important;
    flex-direction: column;
    box-sizing: border-box !important;
}

/* 1. å¼ºåˆ¶ä¸»ä½“åŒºåŸŸæ’‘æ»¡å·¦å³ */
#subpage-char-profile .app-body {
    width: 100% !important;
    max-width: none !important;
    padding: 10px 16px 120px 16px !important; /* å·¦å³ç•™ 16px æ ‡å‡† iOS å‘¼å¸æ„Ÿ */
    box-sizing: border-box !important;
    display: block !important; /* ç¦ç”¨ Flex é˜²æ­¢æŒ¤å‹ */
}

/* 2. å¼ºåˆ¶å¤´åƒä¸åå­—åŒºåŸŸå±…ä¸­ */
.profile-edit-header {
    width: 100% !important;
    display: flex !important;
    flex-direction: column;
    align-items: center;
    margin-bottom: 25px !important;
}

/* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶æ–‡æœ¬åŸŸå’Œåˆ—è¡¨ç»„æ¨ªå‘æ’‘æ»¡ */
#subpage-char-profile #edit-char-desc,
#subpage-char-profile .ios-list-group {
    width: 100% !important;        /* ç‰©ç†å®½åº¦ 100% */
    max-width: none !important;    /* æ‹†é™¤é™å®½å¢™ */
    margin: 12px 0 !important;     /* ä¸Šä¸‹ç•™ç©ºï¼Œå·¦å³ä¸ç•™ */
    box-sizing: border-box !important;
    display: block !important;
}

/* 4. æ–‡æœ¬åŸŸç»†èŠ‚è°ƒæ•´ï¼šåŠ é«˜å¹¶ä¼˜åŒ–å†…è¾¹è· */
#edit-char-desc {
    min-height: 180px !important;
    padding: 18px !important;
    border-radius: 18px !important;
    border: none !important;
    background: #fff !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.03) !important;
}

/* 5. ä¿®æ­£å…ƒæ•°æ®åˆ—è¡¨é¡¹å¯¹é½ */
#subpage-char-profile .ios-list-item {
    width: 100% !important;
    padding: 16px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    box-sizing: border-box !important;
}

/* 6. ä¿®æ­£æ ‡é¢˜ä½ç½®ï¼šé å·¦å¯¹é½å¡ç‰‡ */
#subpage-char-profile .tz-group-title {
    width: 100% !important;
    text-align: left !important;
    padding-left: 5px !important;
    margin-top: 25px !important;
}
#subpage-char-profile .app-header {
    /* ... å…¶ä»–ä»£ç ä¸å˜ ... */
    /* ğŸš¨ è¿™é‡Œçš„ padding æ”¹ä¸ºä¸‹é¢è¿™ä¸ªï¼Œåªåœ¨é¡¶éƒ¨ç•™å‡º 48px é¿å¼€çŠ¶æ€æ  */
    padding: 48px 16px 0 16px !important; 
    height: auto !important; /* è®©é«˜åº¦ç”±å†…è¾¹è·è‡ªç„¶æ’‘å¼€ */
}
/* --- ğŸ›ï¸ ä¸–ç•Œä¹¦ï¼šé«˜çº§æ„Ÿâ€œæ·»åŠ â€å¡ç‰‡é‡å¡‘ --- */
.world-add-btn {
    /* 1. ç‰©ç†å°ºå¯¸é”å®šï¼šç¡®ä¿å®ƒå’Œæ™®é€šçš„ world-card-item ä¸€æ ·å¤§ */
    grid-column: span 1; 
    height: 140px !important; /* å¢åŠ ä¸€ç‚¹é«˜åº¦ï¼Œæ›´æ˜¾å¤§æ°” */
    width: 100% !important;
    
    /* 2. èƒŒæ™¯ä¸è¾¹æ¡†ï¼šé»‘ç™½æç®€ï¼Œè™šçº¿åŠ ç²— */
    background: rgba(255, 255, 255, 0.6) !important; /* åŠé€æ˜ç™½ */
    border: 2px dashed #d1d1d6 !important; /* ç°ç™½è™šçº¿ */
    border-radius: 28px !important; /* è¶…å¤§åœ†è§’ */
    
    /* 3. å¸ƒå±€ï¼šçºµå‘æ’åˆ—å›¾æ ‡å’Œæ–‡å­— */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 10px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    
    /* 4. è§†è§‰ä¿®é¥° */
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    box-sizing: border-box;
}

/* æ‚¬åœ/ç‚¹å‡»æ—¶çš„åŠ¨æ€åé¦ˆ */
.world-add-btn:hover {
    background: #ffffff !important;
    border-color: #007AFF !important; /* æ‚¬åœæ—¶è™šçº¿å˜è“ */
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

.world-add-btn:active {
    transform: scale(0.96); /* ç‚¹å‡»æ—¶çš„ç‰©ç†å¼¹æ„Ÿ */
}

/* å†…éƒ¨å›¾æ ‡ç¾åŒ– */
.world-add-btn svg {
    width: 32px;
    height: 32px;
    color: #c7c7cc;
    transition: color 0.3s;
}

.world-add-btn:hover svg {
    color: #007AFF; /* æ‚¬åœæ—¶å›¾æ ‡å˜è“ */
}

/* å†…éƒ¨æ–‡å­—è¡¥å…¨ï¼ˆå¯é€‰ï¼Œå¦‚æœä½ çš„ HTML é‡Œæ²¡å†™å­—çš„è¯ï¼‰ */
.world-add-btn::after {
    content: "CREATE WORLD";
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    color: #d1d1d6;
    text-transform: uppercase;
}
/* --- ğŸ›ï¸ World é¡µé¢ï¼šå½»åº•æ¶ˆç­å·¦å³ç©ºéš™ --- */

/* 1. å¼ºåˆ¶ä¸»ä½“åŒºåŸŸä¸å±…ä¸­ï¼Œä¸”å®½åº¦ 100% */
#worldApp .app-body {
    display: block !important;     /* æ ¸å¿ƒï¼šåœç”¨ Flex å±…ä¸­ï¼Œæ¢å¤å—çº§æµ */
    width: 100% !important;
    padding: 20px 16px !important; /* å·¦å³ä¿ç•™ 16px çš„ iOS æ ‡å‡†å‘¼å¸è¾¹è· */
    box-sizing: border-box !important;
}

/* 2. å¼ºåˆ¶ç½‘æ ¼å®¹å™¨å æ»¡å±å¹• */
#world-grid.char-grid {
    width: 100% !important;
    max-width: none !important;
    margin: 0 !important;
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important; /* å¼ºåˆ¶ 50/50 å¹³åˆ†ä¸¤åˆ— */
    gap: 15px !important; /* å¡ç‰‡ä¹‹é—´çš„é—´è· */
}

/* 3. ä¿®æ­£å¡ç‰‡å’ŒæŒ‰é’®çš„å½¢çŠ¶ï¼ˆè§£å†³é‚£ä¸ªç»†é•¿ä¸‘æ ·ï¼‰ */
.world-add-btn, .world-card-item {
    width: 100% !important;
    /* å»ºè®®ä½¿ç”¨æ­£æ–¹å½¢æˆ–å›ºå®šé«˜åº¦ï¼Œæ›´æœ‰ç”»å»Šæ„Ÿ */
    aspect-ratio: 1 / 1.1 !important; 
    border-radius: 28px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}

/* 4. åŠ å¼ºåŠ å·æŒ‰é’®çš„è§†è§‰å­˜åœ¨æ„Ÿ */
.world-add-btn svg {
    width: 35px !important;
    height: 35px !important;
    margin-bottom: 8px;
}
/* --- ğŸ“œ ç»‘å®šåè®®é¡µï¼šå…¨å±æ‹‰ä¼¸ä¸é«˜çº§åˆ—è¡¨é‡å¡‘ --- */

/* 1. ç‰©ç†ç¯å¢ƒé‡ç½®ï¼šå¼ºåˆ¶é“ºæ»¡ */
#subpage-world-bind .app-body {
    display: block !important;     /* åœç”¨ Flex å±…ä¸­ */
    width: 100% !important;
    padding: 20px 16px 100px 16px !important; /* å·¦å³ç•™ 16px å‘¼å¸æ„Ÿ */
    box-sizing: border-box !important;
}

/* 2. åˆ—è¡¨ç»„é‡å¡‘ï¼šå˜æˆæ¨ªè·¨å…¨å±çš„åœ†è§’å¡ç‰‡ */
#subpage-world-bind .ios-list-group {
    width: 100% !important;
    max-width: none !important;
    background: #ffffff !important;
    border-radius: 14px !important;
    margin-bottom: 25px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    overflow: hidden;
    display: block !important;
}

/* 3. åˆ—è¡¨é¡¹ï¼ˆè§„åˆ™è¡Œï¼‰ï¼šæ–‡å­—å·¦ï¼Œå‹¾é€‰å³ */
#subpage-world-bind .ios-list-item {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important; /* æ ¸å¿ƒï¼šæ’‘å¼€ä¸¤å¤´ */
    padding: 14px 16px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    min-height: 52px;
}

/* 4. è¡ç”Ÿæ‰©å±•å…¥å£ç¾åŒ– */
#subpage-world-bind .ios-list-item[onclick*="openRelationsPage"] {
    background: #ffffff !important;
    cursor: pointer;
}

#subpage-world-bind .ios-list-item[onclick*="openRelationsPage"]:active {
    background: #f2f2f7 !important; /* ç‚¹å‡»åé¦ˆ */
}

/* 5. æ ‡é¢˜é å·¦å¯¹é½ */
#subpage-world-bind .tz-group-title {
    width: 100% !important;
    text-align: left !important;
    padding-left: 4px !important;
    margin-bottom: 8px !important;
    font-size: 13px;
    font-weight: 600;
}

/* 6. Checkbox æ ·å¼å¾®è°ƒï¼šå˜åœ†æ¶¦ä¸€ç‚¹ */
.world-checkbox {
    -webkit-appearance: none;
    appearance: none;
    width: 24px !important;
    height: 24px !important;
    border: 2px solid #C7C7CC;
    border-radius: 50% !important; /* å˜æˆåœ†å½¢çš„å‹¾é€‰æ¡† */
    outline: none;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.world-checkbox:checked {
    background-color: #007AFF;
    border-color: #007AFF;
}

.world-checkbox:checked::after {
    content: '';
    position: absolute;
    top: 4px; left: 8px;
    width: 5px; height: 10px;
    border: solid white;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
}
/* --- ğŸŒ€ é‡å­è§£æä¸“ç”¨åŠ¨æ•ˆ --- */
.quantum-loader-overlay {
    position: absolute; inset: 0;
    background: rgba(242, 242, 247, 0.9);
    z-index: 1000; display: none;
    flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}

.quantum-spinner {
    width: 60px; height: 60px;
    border: 3px solid rgba(0, 122, 255, 0.1);
    border-top: 3px solid #007AFF;
    border-radius: 50%;
    animation: qSpin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
}

.quantum-status-text {
    margin-top: 20px; font-size: 13px; font-weight: 700;
    color: #007AFF; letter-spacing: 1px;
    font-family: monospace;
}

/* è¿›åº¦æ¡æ ·å¼ */
.q-progress-container {
    width: 200px; height: 4px; background: #e5e5ea;
    border-radius: 10px; margin-top: 15px; overflow: hidden;
}
.q-progress-bar {
    width: 0%; height: 100%; background: #007AFF;
    transition: width 0.4s ease;
}

@keyframes qSpin { to { transform: rotate(360deg); } }

/* NPC å¡ç‰‡æ»‘å…¥åŠ¨æ•ˆ */
.npc-arrival {
    animation: npcSlideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    opacity: 0; transform: translateY(20px);
}
@keyframes npcSlideIn { to { opacity: 1; transform: translateY(0); } }
/* --- ğŸ­ NPC è¯¦æƒ…èµ„æ–™å¡ --- */
.npc-detail-card {
    width: 320px;
    background: #fff;
    border-radius: 36px;
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.25);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

.npc-pre-header {
    height: 180px;
    background: #1d1d1f;
    position: relative;
    overflow: hidden;
}

.npc-pre-banner {
    width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0.5;
    filter: blur(5px);
}

/* --- ä¿®å¤åçš„å¤´åƒæ ·å¼ --- */
.npc-pre-avatar {
    width: 110px; height: 110px;
    border: 5px solid #fff; /* ç™½è¾¹ä¸€å®šè¦åšï¼Œæ‰èƒ½æŠŠæ·±è‰²èƒŒæ™¯éš”å¼€ */
    border-radius: 32px;
    position: absolute;
    /* ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šä» -40px æ”¹ä¸º -20pxï¼ŒæŠŠå®ƒå¾€ä¸Šæï¼ */
    bottom: -20px !important; 
    left: 30px;
    object-fit: cover;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); /* ç¨å¾®åŠ æ·±ä¸€ç‚¹é˜´å½±ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
    transform: rotate(-3deg); /* ä¿æŒè¿™ä¸ªä¿çš®çš„å€¾æ–œè§’ */
    z-index: 2; /* ç¡®ä¿å®ƒå‹åœ¨ä¸€åˆ‡å†…å®¹ä¸Šé¢ */
}

.npc-pre-body {
    padding: 55px 25px 30px 25px;
}

.npc-pre-name {
    font-family: serif;
    font-size: 24px;
    font-weight: 800;
    color: #000;
}

.npc-pre-role {
    display: inline-block;
    font-size: 10px;
    font-weight: 800;
    color: #007AFF;
    background: rgba(0,122,255,0.08);
    padding: 3px 10px;
    border-radius: 20px;
    margin-top: 5px;
    letter-spacing: 1px;
}

.npc-pre-bio {
    margin-top: 20px;
    font-size: 14px;
    color: #444;
    line-height: 1.7;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 20px;
    font-style: italic;
}

/* --- ğŸ­ NPC åº•éƒ¨å·¥å…·æ ï¼šå½»åº•èåˆç‰ˆ --- */
.npc-pre-footer {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;           /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    padding: 15px 20px;  /* æ•´ä½“å†…è¾¹è· */
    background: #ffffff; /* ğŸ‘ˆ ç¡®ä¿è¿™é‡Œå’Œä½ å¡ç‰‡çš„åº•è‰²å®Œå…¨ä¸€æ · */
    width: 100%;
    box-sizing: border-box;
}

/* æŒ‰é’®åŸºç¡€ï¼šç‰©ç†åŒ…è£¹é€»è¾‘ */
.npc-btn-main {
    flex: 1;             /* å¹³åˆ†å®½åº¦ */
    height: 44px;        /* æ ‡å‡† iOS äº¤äº’é«˜åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;            /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    border-radius: 22px; /* èƒ¶å›Šå½¢çŠ¶ï¼Œç¡®ä¿å…ƒç´ è¢«å®Œæ•´åŒ…è£¹ */
    border: none;
    cursor: pointer;
    overflow: hidden;    /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢å…ƒç´ æº¢å‡º */
    transition: all 0.2s ease;
}

/* æŒ‰é’®å†…çš„æ–‡å­—è®¾ç½® */
.npc-btn-main span {
    font-size: 13px;
    font-weight: 700;
    white-space: nowrap; /* å¼ºåˆ¶æ–‡å­—åœ¨ä¸€è¡Œï¼Œä¸ä¹±è·‘ */
}

/* æŒ‰é’®å†…çš„å›¾æ ‡è®¾ç½® */
.npc-btn-main svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;      /* é˜²æ­¢å›¾æ ‡è¢«æŒ¤å‹å˜å½¢ */
}

/* 1. å·¦ä¾§ï¼šæŸ¥çœ‹å¾€äº‹ï¼ˆä½è°ƒèåˆè‰²ï¼‰ */
.npc-btn-main.past-btn {
    background: #f2f2f7; /* iOS ç³»ç»Ÿæ¬¡è¦è‰²ï¼Œå’Œç™½è‰²èƒŒæ™¯éå¸¸æ­ */
    color: #3a3a3c;
}

/* 2. å³ä¾§ï¼šAdd Friendï¼ˆé«˜äº®å¯¹æ¯”è‰²ï¼‰ */
.npc-btn-main.add {
    background: #1d1d1f; /* çº¯æ·±è‰²ï¼Œçªå‡ºæ ¸å¿ƒæ“ä½œ */
    color: #ffffff;
}

/* çŠ¶æ€åˆ‡æ¢ï¼šç‚¹å‡»æ—¶çš„ç¼©æ”¾åé¦ˆ */
.npc-btn-main:active {
    transform: scale(0.95);
    background-opacity: 0.8;
}

/* æˆåŠŸçŠ¶æ€ */
.npc-btn-main.sent {
    background: #34C759 !important;
    color: white !important;
}
/* --- ğŸš¨ ç¤¾äº¤å…³ç³»è§†è§‰åŒºåˆ†è¡¥ä¸ --- */

/* æ ¸å¿ƒçº½å¸¦ï¼šå¸¦æ·¡æ·¡çš„å‘¼å¸è“å…‰ */
.char-card.npc-core {
    border: 2px solid rgba(0, 122, 255, 0.4) !important;
    box-shadow: 0 10px 25px rgba(0, 122, 255, 0.15) !important;
}
.char-card.npc-core::before {
    content: "CORE BOND";
    position: absolute; top: 8px; left: 8px;
    background: #007AFF; color: #fff;
    font-size: 7px; font-weight: 900; padding: 2px 6px;
    border-radius: 4px; z-index: 5;
}

/* æ‰©å±•å…³ç³»å¡ç‰‡ï¼šæ™®é€šç™½ */
.char-card.npc-associate {
    border: 1px solid rgba(0,0,0,0.05);
}

/* åº•éƒ¨â€œç»§ç»­ç”Ÿæˆâ€æŒ‰é’®æ ·å¼ */
.relation-footer-tools {
    width: 100%; padding: 20px 0 60px 0;
    display: flex; justify-content: center;
}
.btn-extend-network {
    background: #ffffff; color: #1d1d1f;
    border: 1.5px solid #1d1d1f;
    width: 180px; padding: 12px;
    border-radius: 14px; font-size: 13px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-extend-network:active { transform: scale(0.95); }

/* æ•…äº‹æŸ¥çœ‹å™¨å¼¹çª—èƒŒæ™¯ */
.story-reading-layer {
    background: #fff; padding: 30px 25px; border-radius: 30px 30px 0 0;
    height: 70vh; overflow-y: auto; text-align: justify;
}
/* --- ğŸ“¡ å¥½å‹ç”³è¯·ï¼šé‡å­ä¿¡å·ä¼ è¾“åŠ¨æ•ˆåŠ å›º --- */
/* --- ğŸ“¡ é‡å­è§£æåŠ¨æ•ˆåŠ å›º --- */
#npc-add-btn.sending {
    background: #007AFF !important;
    color: white !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

#npc-add-btn.sending::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.4) 50%, 
        transparent 100%);
    animation: signalScan 1.5s infinite linear;
    z-index: 5;
}

@keyframes signalScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

/* æˆåŠŸçŠ¶æ€ */
#npc-add-btn.sent {
    background: #34C759 !important;
    transition: background 0.5s ease;
}
/* --- ğŸ“œ å¾€äº‹è§£å¯†å®¹å™¨ --- */
#npc-past-container {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
    border-left: 3px solid #007AFF; /* ç§‘æŠ€è“è¾¹æ¡† */
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    color: #e0e0e0;
    display: none; /* é»˜è®¤éšè— */
    position: relative;
    overflow: hidden;
}

/* è§£å¯†è¿‡ç¨‹ä¸­çš„æ‰«æçº¿ */
#npc-past-container.decrypting::before {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 2px;
    background: #007AFF;
    box-shadow: 0 0 10px #007AFF;
    animation: scanDown 2s infinite linear;
}

@keyframes scanDown {
    0% { top: 0; opacity: 0; }
    20% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

/* æ–‡å­—å‡ºç°çš„æ‰“å­—æœºæ•ˆæœ */
.typing-effect {
    overflow: hidden; /* ä¿è¯æ–‡å­—ä¸æº¢å‡º */
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
    animation: typing 0.05s steps(1) forwards;
}

/* æŒ‰é’®åŠ è½½æ—¶çš„è„‰å†² */
.btn-pulsing {
    animation: pulseBlue 1.5s infinite;
    pointer-events: none; /* åŠ è½½æ—¶ç¦æ­¢ç‚¹å‡» */
    opacity: 0.8;
}

@keyframes pulseBlue {
    0% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
}
/* ä¿¡å·æ‰«æçŠ¶æ€ - ç»™åŸæœ¬çš„æŒ‰é’®åŠ ç‰¹æ•ˆ */
.npc-btn-main.scanning {
    background: #1d1d1f !important;
    color: #007AFF !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

.npc-btn-main.scanning::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 122, 255, 0.4), transparent);
    animation: btnScan 1.2s infinite linear;
}

@keyframes btnScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

/* æ•…äº‹æ–‡æœ¬è§£å¯†æ‰“å­—æœºæ•ˆæœ */
.decrypt-text {
    font-family: serif;
    line-height: 1.8;
    color: #444;
    white-space: pre-wrap;
}
/* --- ğŸ† å¾€äº‹å¡ç‰‡ç»ˆæå±‚çº§ç½®é¡¶ --- */
#modal-vibe-result {
    display: none; 
    position: fixed !important;
    inset: 0 !important;
    /* ğŸš¨ å…³é”®ï¼šå¿…é¡»æ¯” 40000 è¿˜è¦å¤§ï¼ */
    z-index: 99999 !important; 
    background: rgba(0, 0, 0, 0.7) !important;
    backdrop-filter: blur(15px) !important;
    align-items: center !important;
    justify-content: center !important;
}

/* ç¡®ä¿å†…éƒ¨å¡ç‰‡æ ·å¼æ­£å¸¸ */
#modal-vibe-result .aesthetic-card {
    width: 90% !important;
    max-width: 340px !important;
    height: 75vh !important;
    display: flex !important;
    flex-direction: column !important;
    background: #fff !important;
    border-radius: 32px !important;
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
}
/* æ¡£æ¡ˆå¡ç‰‡ä¸“å±æ ·å¼è¡¥ä¸ */
.past-magazine-style {
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    background: #fff !important;
    animation: magazinePop 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
}

@keyframes magazinePop {
    from { opacity: 0; transform: scale(0.9) translateY(40px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* è§£å¯†ä¸­çš„æŒ‰é’®åŠ¨æ€æ•ˆæœ */
.npc-btn-main.decoding {
    background: #1d1d1f !important;
    color: #007AFF !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

.npc-btn-main.decoding::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 122, 255, 0.3), transparent);
    animation: decodeScan 1.2s infinite linear;
}

@keyframes decodeScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

#past-text-body {
    font-family: "SF Pro Display", serif;
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    padding-bottom: 30px;
}
/* --- ğŸ­ NPC è¯¦æƒ…å¡ï¼šä¸‰æŒ‰é’® UI å®Œç¾è¡¥ä¸ --- */
.npc-pre-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px; 
    padding: 5px 20px 35px 20px; /* ğŸ‘ˆ é¡¶éƒ¨ç¼©å‡ï¼Œåº•éƒ¨ç•™ç™½ */
    background: transparent !important; /* ğŸ‘ˆ æ ¸å¿ƒï¼šç‰©ç†æ¶ˆé™¤ç™½è‰²çªå…€æ–¹å— */
    width: 100%;
    box-sizing: border-box;
}

/* æŒ‰é’®åŸºç¡€å®¹å™¨ */
.npc-btn-action {
    height: 40px;
    border-radius: 12px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 11px;
    font-weight: 800;
    overflow: hidden; /* ç¡®ä¿å†…å®¹è¢«å®Œç¾åŒ…è£¹ */
}

/* å¾€äº‹ & æ„Ÿå…´è¶£ï¼šæµ…è‰²æ ·å¼ */
.npc-btn-action.minor {
    flex: 1;
    background: #f2f2f7;
    color: #1d1d1f;
}

/* åŠ å¯†å‹ï¼šæ·±è‰²é«˜å¯¹æ¯”æ ·å¼ */
.npc-btn-action.main {
    flex: 2; /* è®©åŠ å¯†å‹æŒ‰é’®å®½ä¸€ç‚¹ï¼Œæ›´æœ‰ç‚¹å‡»æ¬² */
    background: #1d1d1f;
    color: #ffffff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.npc-btn-action:active { transform: scale(0.95); opacity: 0.8; }

/* å›¾æ ‡å¤§å°é”å®š */
.npc-btn-action svg { width: 16px; height: 16px; flex-shrink: 0; }

/* ä¿¡å·æ‰«ææ•ˆæœ (åŠ å¯†å‹ä¸“ç”¨) */
.npc-btn-action.syncing {
    background: #007AFF !important;
    pointer-events: none;
}
/* --- ğŸ–¤ æœ¬æˆ‘æ¡£æ¡ˆä¸“å±æ ·å¼è¡¥ä¸ --- */
.user-profile-style {
    border: 1px solid #1d1d1f !important;
    box-shadow: 0 30px 80px rgba(0,0,0,0.3) !important;
}

#subpage-user-profile .app-body {
    display: block !important;
    width: 100% !important;
}

#user-bio-in {
    font-family: "PingFang SC", sans-serif;
    font-size: 15px;
    color: #3a3a3c;
    border-radius: 18px !important;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
}

/* è°ƒæ•´è®¾ç½®é¡µä¸­çš„â€œæˆ‘çš„èµ„æ–™â€å…¥å£ï¼Œç¡®ä¿ç‚¹å‡»æœ‰æ•ˆ */
.standalone-btn.user-entry {
    background: #1d1d1f !important;
    color: #fff !important;
    margin-bottom: 20px;
}
/* è®©æŒ‰é’®çœ‹èµ·æ¥æ›´é«˜çº§ï¼Œå…¨åŒ…è£¹ä¸çªå…€ */
.sub-setting-btn.user-btn-main {
    background: #1d1d1f !important; /* çº¯é»‘ä¸»æŒ‰é’® */
    color: #fff !important;
    border-radius: 12px;
    margin-bottom: 10px !important;
    font-weight: 700;
}

.sub-setting-btn.user-btn-secondary {
    background: #f2f2f7 !important; /* æµ…ç°æ¬¡è¦æŒ‰é’® */
    color: #1d1d1f !important;
    border-radius: 12px;
    margin-top: 0 !important;
    font-weight: 600;
}
/* å¼ºåˆ¶å­é¡µé¢æ˜¾å½±é€»è¾‘ */
#subpage-user-profile.active {
    transform: translateX(0) !important;
    display: flex !important;
}

/* ç¼–è¾‘é¡µå†…æ–‡å­—åŸŸé«˜çº§æ„Ÿ */
#user-bio-in {
    border-radius: 14px !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);
    font-family: inherit;
    resize: none;
}
/* å¼ºåˆ¶è¦†ç›–åŸæœ‰çš„å­é¡µé¢æ¿€æ´»é€»è¾‘ */
.ios-sub-page.active {
    display: flex !important;    /* å¿…é¡»åŠ è¿™ä¸€è¡Œï¼Œå¦åˆ™é¡µé¢æ°¸è¿œæ˜¯éšè—çš„ */
    transform: translateX(0) !important;
    z-index: 15000 !important;   /* ç¡®ä¿å®ƒåœ¨æœ€é¡¶å±‚ï¼Œç›–è¿‡è®¾ç½® App */
}
/* --- ğŸï¸ åˆ—è¡¨é¡µç¾åŒ– --- */
.memory-hero-banner {
    padding: 30px 20px;
    text-align: left;
}
.hero-label { font-size: 10px; font-weight: 900; color: #007AFF; letter-spacing: 3px; }
.hero-title { font-size: 34px; font-weight: 800; color: #1d1d1f; margin-top: 5px; }
.hero-subtitle { font-size: 13px; color: #8e8e93; margin-top: 5px; }

.memory-grid-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    padding: 10px 20px 120px 20px;
}

/* è®°å¿†å¡ç‰‡è®¾è®¡ */
.memory-item-card {
    position: relative;
    background: #fff;
    border-radius: 28px;
    padding: 24px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.02);
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    cursor: pointer;
}
.memory-item-card:active { transform: scale(0.96); }

.card-num {
    position: absolute; right: -10px; top: -10px;
    font-size: 80px; font-weight: 900; color: rgba(0,0,0,0.03);
    font-style: italic; pointer-events: none;
}

/* --- ğŸï¸ åˆ—è¡¨ä¸å¸ƒå±€ --- */
.memory-hero-area { padding: 40px 20px 20px; }
.hero-tag { font-size: 10px; font-weight: 900; color: #007AFF; letter-spacing: 4px; }
.hero-title { font-size: 36px; font-weight: 800; color: #1d1d1f; }
.hero-desc { font-size: 14px; color: #8e8e93; margin-top: 8px; }

.memory-stagger-grid { display: flex; flex-direction: column; gap: 20px; padding: 10px 20px 120px; }

/* è®°å¿†å¡ç‰‡æ ·å¼ */
.memory-item-card {
    background: #fff; border-radius: 30px; padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.04);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    cursor: pointer; position: relative; border: 1px solid rgba(0,0,0,0.02);
}
.memory-item-card:active { transform: scale(0.95) translateY(5px); }

/* --- ğŸ¬ æ²‰æµ¸å¼ç”µå½±è§†å›¾ --- */
.cinema-portal {
    position: fixed !important; inset: 0 !important;
    z-index: 999999 !important; background: #000;
    display: none; opacity: 0; transition: opacity 0.5s ease;
}
.cinema-portal.active { opacity: 1; display: flex; }

.cinema-stage { width: 100%; height: 100%; background: #fff; animation: cinemaSlideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes cinemaSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.cinema-scroll-layer { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.cinema-hero-banner { height: 60vh; width: 100%; position: relative; }
.cinema-hero-banner img { width: 100%; height: 100%; object-fit: cover; }
.cinema-hero-mask { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 40%, #fff 98%); }

.cinema-title-box { position: absolute; bottom: 40px; left: 30px; right: 30px; }
#cinema-title-ui { font-size: 32px; font-weight: 800; color: #1d1d1f; line-height: 1.2; }

.cinema-text-wrapper { padding: 0 30px 100px; }
.cinema-prose { font-family: "PingFang SC", serif; font-size: 18px; line-height: 2; color: #2c2c2e; text-align: justify; white-space: pre-wrap; }

/* --- ğŸŒ€ é‡å­ç»‡ç½‘åŠ¨ç”» --- */
.quantum-overlay {
    position: fixed; inset: 0; background: rgba(255,255,255,0.9);
    z-index: 1000000; display: none; flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}
.weaving-core { width: 50px; height: 50px; position: relative; animation: qRotate 4s linear infinite; }
.spider-line { position: absolute; top: 50%; left: 50%; width: 100%; height: 2px; background: #007AFF; transform-origin: center; animation: qPulse 1.5s ease-in-out infinite; }
@keyframes qRotate { to { transform: rotate(360deg); } }
@keyframes qPulse { 0%, 100% { transform: translate(-50%,-50%) scaleX(0.2); opacity: 0.2; } 50% { transform: translate(-50%,-50%) scaleX(1); opacity: 1; } }
.weaving-text { margin-top: 30px; font-size: 13px; font-weight: 700; color: #007AFF; letter-spacing: 2px; }
/* --- ğŸ’ é«˜çº§æ„Ÿï¼šå”¤é†’æŒ‰é’®ç¾åŒ– --- */
.memory-footer-bar {
    position: absolute; bottom: 30px; left: 0; width: 100%;
    display: flex; justify-content: center; padding: 0 20px; z-index: 100;
}

.btn-awaken-core {
    width: 100%; max-width: 320px; height: 60px;
    background: linear-gradient(135deg, #1d1d1f 0%, #3a3a3c 100%); /* æ·±è‰²æ‹‰ä¸è´¨æ„Ÿ */
    color: #fff; border-radius: 20px; border: none;
    display: flex; align-items: center; justify-content: center;
    gap: 12px; font-size: 16px; font-weight: 700; letter-spacing: 1px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3); /* è¶…æ·±é˜´å½± */
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    position: relative; overflow: hidden;
}

.btn-awaken-core:active {
    transform: scale(0.96) translateY(3px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* æŒ‰é’®æ‰«å…‰ç‰¹æ•ˆ */
.btn-awaken-core::after {
    content: ""; position: absolute; top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: btnShine 3s infinite;
}

@keyframes btnShine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* è®°å¿†å¡ç‰‡å¾®è°ƒ */
.memory-item-card {
    background: #fff; border-radius: 24px; padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.01);
}
/* --- ğŸ’ é«˜çº§æ„Ÿï¼šå”¤é†’æŒ‰é’® --- */
.memory-footer-bar {
    position: absolute; bottom: 35px; left: 0; width: 100%;
    display: flex; justify-content: center; padding: 0 25px; z-index: 100;
}

.btn-awaken-core {
    width: 100%; max-width: 320px; height: 64px;
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%); /* æè‡´ç£¨ç ‚é»‘ */
    color: #fff; border-radius: 22px; border: none;
    display: flex; align-items: center; justify-content: center;
    gap: 15px; font-size: 16px; font-weight: 700; letter-spacing: 2px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.1);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative; overflow: hidden;
    cursor: pointer;
}

/* æŒ‰é’®æ‰«å…‰ç‰¹æ•ˆ */
.btn-awaken-core::after {
    content: ""; position: absolute; top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.08), transparent);
    transform: rotate(45deg);
    animation: btnShine 4s infinite;
}

@keyframes btnShine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

.btn-awaken-core:active {
    transform: scale(0.96) translateY(4px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
/* --- ğŸš¨ çŠ¶æ€æ å¼ºåˆ¶ç½®é¡¶è¡¥ä¸ --- */
.status-bar {
    z-index: 1000005 !important; /* ç»å¯¹æœ€é«˜å±‚çº§ï¼Œç¡®ä¿åœ¨æ•…äº‹é¡µé¢ä¹‹ä¸Š */
    position: relative;
    background: transparent; /* ä¿æŒé€æ˜ï¼Œå¯ä»¥çœ‹åˆ°åé¢çš„å¤§å›¾ */
}

/* --- ğŸ¬ ç”µå½±è¯¦æƒ…é¡µï¼šç‰©ç†ä¸‹ç§»ä¸å±‚çº§è°ƒæ•´ --- */
.cinema-portal {
    position: fixed !important;
    inset: 0 !important;
    background: #ffffff;
    z-index: 1000000 !important; /* ä½äºçŠ¶æ€æ ï¼Œé«˜äºæ™®é€šé¡µé¢ */
    display: none; 
    opacity: 0;
    transition: opacity 0.5s ease;
    flex-direction: column;
}

/* å½“é¡µé¢æ¿€æ´»æ—¶ */
.cinema-portal.active {
    display: flex !important;
    opacity: 1 !important;
}

/* æ ¸å¿ƒæ»šåŠ¨å±‚ï¼šå¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œé¿å¼€çŠ¶æ€æ  */
.cinema-scroll-layer {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 48px; /* ğŸš¨ ç‰©ç†é¿è®©ï¼šè¿™é‡Œçš„é«˜åº¦å¿…é¡»ç­‰äºæˆ–å¤§äºçŠ¶æ€æ é«˜åº¦ */
}

/* --- âŒ å¼ºåŠ›æ˜¾å½¢ï¼šå…³é—­æŒ‰é’® --- */
.cinema-close-trigger {
    position: fixed; /* æ”¹ä¸º fixedï¼Œç¡®ä¿ä¸éšé¡µé¢æ»šåŠ¨æ¶ˆå¤± */
    top: 60px;       /* æ”¾åœ¨çŠ¶æ€æ ä¸‹æ–¹ä¸€ç‚¹ */
    right: 20px;
    z-index: 1000010; /* ç”šè‡³æ¯”çŠ¶æ€æ è¿˜è¦é«˜ï¼Œç¡®ä¿èƒ½ç‚¹åˆ° */
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.5); /* åŠé€æ˜é»‘ï¼Œç¡®ä¿åœ¨ç™½è‰²èƒŒæ™¯æˆ–å›¾ç‰‡ä¸Šéƒ½èƒ½çœ‹æ¸… */
    backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    align-items: center;
    justify-content: center;
    color: #ffffff;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.cinema-close-trigger svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
}

/* æŒ‰é’®ç‚¹å‡»åé¦ˆ */
.cinema-close-trigger:active {
    transform: scale(0.9);
    background: rgba(0, 0, 0, 0.8);
}
/* ğŸš‘ å¤´éƒ¨é—´è·ä¿®æ­£è¡¥ä¸ï¼šè§£å†³é¡¶éƒ¨ç©ºç™½è¿‡å¤§çš„é—®é¢˜ */

/* 1. é’ˆå¯¹æ‰€æœ‰å­é¡µé¢çš„é€šç”¨ä¿®æ­£ */
.ios-sub-page .app-header {
    padding-top: 55px !important;  /* ä» 80px ç¼©å‡åˆ° 55px */
    min-height: 90px !important;   /* ç¼©å°ä¿åº•æ€»é«˜åº¦ */
    padding-bottom: 10px !important;
}

/* 2. ä¸“é—¨é’ˆå¯¹â€œæ—¶ç©ºæ¡£æ¡ˆåº“â€é¡µé¢çš„ç»†èŠ‚å¾®è°ƒ */
#subpage-memory-list .app-header {
    padding-top: 55px !important;
    padding-bottom: 12px !important;
    background: #ffffff !important; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ï¼Œä¸é€å‡ºåº•è‰² */
}

/* 3. é¡ºä¾¿å¾®è°ƒä¸€ä¸‹è¿”å›æŒ‰é’®å’Œæ ‡é¢˜çš„å¯¹é½ï¼Œè®©å®ƒæ›´ç²¾è‡´ */
.ios-sub-page .header-left, 
.ios-sub-page .header-title {
    margin-bottom: 2px !important;
}
/* --- ğŸï¸ ç”µå½±æ„Ÿè§†ç•Œï¼šé»‘ç™½é«˜å®šæ’ç‰ˆ --- */
.cinema-prose {
    font-family: "PingFang SC", "STHeiti", serif;
    font-size: 17px;
    line-height: 2.2; /* æå…¶å®½æ•çš„è¡Œé—´è· */
    color: #000000;
    text-align: justify;
    padding-bottom: 50px;
}

/* ğŸš¨ æ ¸å¿ƒï¼šæ®µè½é—´è· */
.cinema-prose p {
    margin-bottom: 28px; /* ç»™æ®µè½ä¹‹é—´ç•™å‡ºå‘¼å¸ç©ºé—´ */
    display: block;
}

/* ğŸš¨ é‡ç‚¹ï¼šã€ ã€‘å†…çš„æ ¸å¿ƒè¯ï¼ˆé»‘åº•ç™½å­—ï¼‰ */
.memory-highlight {
    background-color: #ffffff !important;
    color: #000000 !important;
    padding: 0px 6px;
    margin: 0 2px;
    border-radius: 2px;
    font-weight: 800;
    display: inline-block;
}

.memory-focus {
    border-bottom: 2px solid #AF52DE;
    font-weight: 800;
    color: #fff;
    padding-bottom: 1px;
}
/* --- ğŸï¸ è®°å¿†å¡ç‰‡å·¦æ»‘åˆ é™¤è¡¥ä¸ --- */
.memory-swipe-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden; /* éšè—æº¢å‡ºçš„åˆ é™¤æŒ‰é’® */
    border-radius: 28px; /* ä¿æŒåœ†è§’ä¸€è‡´ */
    margin-bottom: 18px;
    background-color: #FF3B30; /* æ»‘å¼€åéœ²å‡ºçš„åº•è‰²æ˜¯çº¢è‰² */
}

.memory-swipe-content {
    position: relative;
    width: 100%;
    background: #ffffff;
    z-index: 2; /* ç›–åœ¨æŒ‰é’®ä¸Šé¢ */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: transform;
}

.memory-swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 80px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    color: #fff;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
}
/* --- ğŸšï¸ è®°å¿†æ€»ç»“ä¸“å±æ»‘åŠ¨æ¡ç¾åŒ– --- */
#subpage-memory-summary .ios-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: #e5e5ea;
    border-radius: 10px;
    outline: none;
    /* åŠ¨æ€å¡«å……è‰²ï¼šå·¦é»‘å³ç° */
    background-image: linear-gradient(#000, #000);
    background-size: var(--percent, 20%) 100%;
    background-repeat: no-repeat;
}

#subpage-memory-summary .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 28px;
    width: 28px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2), 0 0 0 0.5px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.1s;
}

#subpage-memory-summary .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.15);
}
/* ==========================================
   ğŸš¨ ç‰©ç†é”æ­»ï¼šè®°å¿†æ€»ç»“é¡µå…¨å®½æ‹‰ä¼¸
   ========================================== */

/* 1. å¼ºåˆ¶ä¸»ä½“å®¹å™¨ä¸è®¸å±…ä¸­ï¼Œå æ»¡ 100% */
#subpage-memory-summary .app-body {
    display: block !important;          /* âŒ åœç”¨ Flex å±…ä¸­ï¼Œæ¢å¤å—çº§æµ */
    width: 100% !important;
    padding: 20px 16px !important;      /* å·¦å³ä¿ç•™ 16px æ ‡å‡†è¾¹è·ï¼Œå…¶ä½™å…¨éƒ¨æ‹‰æ»¡ */
    max-width: none !important;
    box-sizing: border-box !important;
}

/* 2. å¼ºåˆ¶å†…éƒ¨å¡ç‰‡ç»„å æ»¡å±å¹• */
#subpage-memory-summary .ios-list-group {
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    display: block !important;           /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´å †å  */
    box-sizing: border-box !important;
}

/* 3. å¼ºåˆ¶æ»‘å—è½¨é“æ’‘æ»¡ 100% */
#subpage-memory-summary .ios-slider {
    width: 100% !important;
    margin: 30px 0 !important;           /* å¢åŠ ä¸Šä¸‹é—´è·ï¼Œæ›´æ˜¾å¤§æ°” */
    display: block !important;
}

/* 4. ä¿®å¤æ ‡é¢˜æ–‡å­—å¯¹é½ */
#subpage-memory-summary .tz-group-title {
    text-align: left !important;
    padding-left: 4px !important;
    width: 100% !important;
}

/* 5. è°ƒæ•´æ•°å­—æ˜¾ç¤ºçš„ä½ç½® */
#summary-rounds-val {
    font-size: 50px !important;
    font-weight: 800 !important;
    color: #000;
}
/* --- ğŸ““ è®°å¿†æ€»ç»“å¡ç‰‡ï¼šé»‘ç™½æ¡£æ¡ˆé£ --- */
.summary-card {
    background: #fff;
    border: 1.5px solid #000;
    border-radius: 20px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    animation: cardFadeIn 0.4s ease-out;
}

.summary-card::before {
    content: "CORE MEMORY";
    position: absolute;
    top: 10px; right: -25px;
    background: #000;
    color: #fff;
    font-size: 8px;
    font-weight: 900;
    padding: 2px 30px;
    transform: rotate(45deg);
}

.summary-date {
    font-size: 10px;
    color: #8e8e93;
    font-family: monospace;
    margin-bottom: 10px;
    display: block;
}

.summary-content {
    font-size: 14px;
    line-height: 1.7;
    color: #1d1d1f;
    font-family: serif;
    font-style: italic;
}

.btn-delete-summary {
    position: absolute;
    bottom: 15px; right: 20px;
    font-size: 11px;
    color: #FF3B30;
    font-weight: 700;
    cursor: pointer;
}

@keyframes cardFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ“± é€šçŸ¥ä¸­å¿ƒï¼šç‰©ç†å¢å¼ºç‰ˆ --- */
.notification-shade {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.4); /* åŠ æ·±åº•è‰² */
    backdrop-filter: blur(25px) saturate(160%);
    -webkit-backdrop-filter: blur(25px) saturate(160%);
    z-index: 100000; 
    display: none; /* åˆå§‹ç”± JS æ§åˆ¶æ˜¾ç¤º */
    flex-direction: column;
    transform: translateY(-100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    pointer-events: auto;
}

/* æ¿€æ´»çŠ¶æ€ */
.notification-shade.active {
    transform: translateY(0);
}

/* ğŸš¨ å…³é”®ï¼šæ‰‹åŠ¿æ„Ÿåº”åŒº (çŠ¶æ€æ éšå½¢å¤–æŒ‚) */
.status-bar {
    pointer-events: auto !important; /* ç¡®ä¿çŠ¶æ€æ èƒ½æŠ“åˆ°ç‚¹å‡»/æ»‘åŠ¨ */
}

/* é®ç½©å±‚é¡¶éƒ¨çš„æŠŠæ‰‹ */
.shade-handle {
    width: 40px; height: 5px; background: rgba(255,255,255,0.3);
    border-radius: 10px; margin: 15px auto;
}

/* --- ğŸ”” å®æ—¶æ¨é€æ¨ªå¹… (Push Banner) --- */
.ios-banner {
    position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
    width: 92%; max-width: 380px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 24px; padding: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    z-index: 110000; display: flex; align-items: center; gap: 12px;
    transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    cursor: pointer;
}

.ios-banner.show { top: 55px; } /* é¿å¼€çŠ¶æ€æ é«˜åº¦ */

.banner-icon { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
.banner-content { flex: 1; }
.banner-title { font-size: 13px; font-weight: 800; color: #000; margin-bottom: 2px; }
.banner-text { font-size: 12px; color: #333; line-height: 1.3; }
/* --- ğŸ“± é€šçŸ¥ä¸­å¿ƒï¼šå¸ƒå±€ä¸æ ‡é¢˜æ  --- */
.notification-shade {
    /* ...ä¿æŒä½ ä¹‹å‰çš„å›ºå®šå®šä½å’ŒèƒŒæ™¯æ¨¡ç³Šæ ·å¼... */
    display: none;
    flex-direction: column; /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
    justify-content: space-between; /* è®©å†…å®¹å’Œåº•éƒ¨æŠŠæ‰‹åˆ†å¼€ */
    padding-bottom: 20px; /* ç»™åº•éƒ¨æŠŠæ‰‹ç•™ä½ç½® */
    box-sizing: border-box;
}

/* æ–°å¢ï¼šæ¯›ç»ç’ƒæ ‡é¢˜æ  */
.notif-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 45px 20px 15px; /* é¿å¼€çŠ¶æ€æ é«˜åº¦ */
    background: rgba(255, 255, 255, 0.1); /* ææ·¡çš„ç™½è‰²é®ç½© */
    border-bottom: 0.5px solid rgba(255, 255, 255, 0.2); /* ç²¾è‡´åˆ†å‰²çº¿ */
}

.notif-title {
    font-size: 28px;
    font-weight: 800;
    color: #fff;
    letter-spacing: 0.5px;
}

/* æ¸…é™¤æŒ‰é’® */
.notif-clear-btn {
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.2s;
}
.notif-clear-btn:active {
    background: rgba(255,255,255,0.4);
    transform: scale(0.9);
}

/* åˆ—è¡¨å®¹å™¨ï¼šå¯æ»šåŠ¨ */
.notif-list-container {
    flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
    overflow-y: auto;
    padding: 20px 16px;
}

.notif-empty-state {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 14px;
    margin-top: 100px;
    font-weight: 500;
}

/* --- åº•éƒ¨æŠŠæ‰‹ (å–ä»£åŸæ¥çš„é¡¶éƒ¨æŠŠæ‰‹) --- */
.shade-handle-bottom {
    width: 45px;
    height: 5px;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 10px;
    margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
    flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
    cursor: pointer;
}
/* é€šçŸ¥æ¨ªå¹…åŸºç¡€æ ·å¼ */
.ios-banner {
    position: fixed;
    top: -100px; /* åˆå§‹è—åœ¨ä¸Šé¢ */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    z-index: 999999;
    display: flex;
    align-items: center;
    transition: top 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28); /* å¼¹æ€§æ»‘å…¥ */
    cursor: pointer;
}

/* æ˜¾ç¤ºæ—¶çš„çŠ¶æ€ */
.ios-banner.show {
    top: 20px;
}
/* 1. ä¿®å¤æ¶ˆæ¯åˆ—è¡¨æ¡å˜å½¢ï¼šå¼ºåˆ¶å•è¡Œæˆ–åŒè¡Œæˆªæ–­ */
.contact-preview {
    font-size: 13px;
    color: #8E8E93;
    margin-top: 2px;
    /* æ ¸å¿ƒä¿®å¤ï¼šè¶…å‡ºæ–‡å­—å˜çœç•¥å·ï¼Œä¸æ’‘å¼€é«˜åº¦ */
    display: -webkit-box !important;
    -webkit-line-clamp: 1; /* å¼ºåˆ¶åªæ˜¾ç¤º1è¡Œï¼Œä½ å¯ä»¥æ”¹æˆ2 */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal; /* è¦†ç›–å¯èƒ½å†²çªçš„ nowrap */
    word-break: break-all;
    max-height: 18px; /* é”å®šé«˜åº¦ï¼Œé˜²æ­¢æŠ–åŠ¨ */
}

/* 2. ä¿®å¤å¼¹çª—ä½ç½®ï¼šå‘ä¸‹å¹³ç§»ï¼Œé¿å¼€çŠ¶æ€æ (48px) */
.ios-banner {
    top: -120px; /* åˆå§‹ä½ç½®æ›´é ä¸Šï¼Œç¡®ä¿å½»åº•è—ä½ */
    transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
}

.ios-banner.show {
    top: 60px !important; /* çŠ¶æ€æ  48px + 12px ç•™ç™½ï¼Œé»„é‡‘æ¯”ä¾‹ */
}

/* 3. é€šçŸ¥ä¸­å¿ƒé‡Œçš„å¡ç‰‡æ ·å¼å¾®è°ƒï¼Œç¡®ä¿ç¾è§‚ */
.notif-item {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 18px;
    padding: 15px;
    margin-bottom: 12px;
    color: #fff;
    animation: msgFadeUp 0.4s ease;
}
/* ğŸš¨ ç‰©ç†ä¿®å¤ï¼šå­é¡µé¢åˆ—è¡¨å®½åº¦é”å®š */
#subpage-icon-picker .app-body {
    padding: 20px 16px !important; /* è¿˜åŸ iOS æ ‡å‡†ï¼šä¸Šä¸‹ 20pxï¼Œå·¦å³ 16px */
    display: block !important;      /* ç¡®ä¿å†…å®¹æŒ‰å—çº§æ’åˆ—ï¼Œä¸è¢« flex æŒ¤å‹å®½åº¦ */
    overflow-y: auto;
}

#icon-target-list {
    width: 100% !important;         /* å¼ºåˆ¶åˆ—è¡¨å®¹å™¨ 100% å®½åº¦ */
    margin: 0 auto !important;      /* å±…ä¸­å¯¹é½ */
}

/* ç¡®ä¿åˆ—è¡¨é¡¹å†…å®¹ä¹Ÿèƒ½æ’‘å¼€ */
#icon-target-list .ios-list-item {
    width: 100% !important;
}

#icon-target-list .item-content {
    flex: 1;                        /* è®©å†…å®¹åŒºè‡ªåŠ¨å¡«æ»¡å‰©ä½™ç©ºé—´ */
    padding-right: 8px;            /* ç»™å³ä¾§ç®­å¤´ç•™ç‚¹å‘¼å¸æ„Ÿ */
}
/* å­è®¾ç½®è¡ŒåŸºç¡€å¸ƒå±€ */
.sub-setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #fff;
    border-bottom: 0.5px solid #F2F2F7;
    transition: background 0.2s;
}

.sub-setting-row:active { background: #F2F2F7; }

.sub-item-left { display: flex; align-items: center; gap: 8px; }

/* ğŸ•’ æ ¸å¿ƒæ’ç‰ˆçªå‡ºï¼šæ—¶é—´æ„ŸçŸ¥æ ‡è®° */
.time-sense-tag {
    font-size: 10px;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 4px;
    border-left: 3px solid #007AFF; 
    transition: all 0.5s ease;
    position: relative;
    overflow: hidden;
}

/* ğŸ’¡ å®æ—¶æ„ŸçŸ¥çš„ç‰©ç†æ ‡è®°ï¼šå‘¼å¸é—ªçƒçš„å°ç‚¹ */
.time-sense-tag::after {
    content: '';
    position: absolute;
    top: 2px;
    right: 2px;
    width: 3px;
    height: 3px;
    background: currentColor;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}
/* =========================================================
   ğŸš¨ æ„ŸçŸ¥ä¸­å¿ƒï¼šç‰©ç†æ‹‰ä¼¸è¡¥ä¸ (è§£å†³ä¸¤è¾¹ç•™ç™½ã€æŒ‰é’®å¯¹é½é—®é¢˜)
   ========================================================= */

/* 1. å®¹å™¨å¼ºåˆ¶é“ºæ»¡ */
#subpage-weather-perceive {
    width: 100% !important;
    max-width: none !important;
    left: 0 !important;
}

/* 2. ä¸»ä½“åŒºåŸŸæ‹‰ä¼¸ */
#subpage-weather-perceive .app-body {
    display: block !important; /* ç‰©ç†å–æ¶ˆ Flex å±…ä¸­ */
    width: 100% !important;
    padding: 20px 16px 120px 16px !important; /* å·¦å³ç•™ 16px æ ‡å‡†è¾¹è· */
    box-sizing: border-box !important;
}

/* 3. åè®®å¼€å…³è¡Œé‡å¡‘ï¼šå·¦å­—å³é’®ï¼Œæ¨ªè·¨å…¨å± */
#subpage-weather-perceive .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 14px !important;
    margin: 10px 0 25px 0 !important;
    overflow: hidden;
    display: block !important;
}

#subpage-weather-perceive .ios-list-item {
    width: 100% !important;
    padding: 0 16px !important;
    height: 54px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important; /* æ ¸å¿ƒï¼šæ–‡å­—å·¦ï¼Œå¼€å…³å³ */
    box-sizing: border-box !important;
}

/* 4. æŒ‰é’®ç»„é‡ç»˜ï¼šä¸å†æ˜¯ä¸¤ä¸ªæŒ¤åœ¨ä¸€èµ·çš„å°æ–¹å— */
.sense-action-area {
    display: flex !important;
    gap: 12px !important;
    width: 100% !important;
    margin-bottom: 30px !important;
}

/* ç«‹åˆ»æ•è·æŒ‰é’®ï¼šä¸»è‰²è°ƒï¼Œå æ®å¤§éƒ¨åˆ†ç©ºé—´ */
.sense-btn-main {
    flex: 2 !important;
    height: 50px !important;
    background: #1d1d1f !important;
    color: #fff !important;
    border-radius: 14px !important;
    font-weight: 700 !important;
    font-size: 15px !important;
    border: none !important;
}

/* è‡ªåŠ¨é¢‘ç‡æŒ‰é’®ï¼šè¾…åŠ©è‰²è°ƒ */
.sense-btn-sub {
    flex: 1 !important;
    height: 50px !important;
    background: #fff !important;
    color: #007AFF !important;
    border-radius: 14px !important;
    font-weight: 600 !important;
    font-size: 14px !important;
    border: 0.5px solid rgba(0,0,0,0.05) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03) !important;
}

/* 5. æ—¶é—´è½´å¡ç‰‡å…¨å®½ */
#sense-timeline-container {
    width: 100% !important;
}

.sense-card {
    width: 100% !important;
    margin-bottom: 20px !important;
}
/* =========================================================
   âœ¨ æ„ŸçŸ¥ä¸­å¿ƒï¼šç”Ÿæˆè¿‡ç¨‹åŠ¨ç”»è¡¥ä¸
   ========================================================= */

/* å®šä¹‰è„‰å†²åŠ¨ç”»å…³é”®å¸§ï¼šåƒé›·è¾¾æ³¢ä¸€æ ·å‘å¤–æ‰©æ•£ */
@keyframes sensingPulseRipple {
    0% {
        box-shadow: 0 0 0 0 rgba(29, 29, 31, 0.5);
    }
    70% {
        box-shadow: 0 0 0 15px rgba(29, 29, 31, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(29, 29, 31, 0);
    }
}

/* æŒ‰é’®æ¿€æ´»çŠ¶æ€ï¼šåº”ç”¨åŠ¨ç”»ï¼Œå˜è‰²ï¼Œç¦ç”¨é¼ æ ‡ */
.sense-btn-main.sensing-active {
    background-color: #3a3a3c !important; /* ç¨å¾®å˜æµ…ä¸€ç‚¹è¡¨ç¤ºå¿™ç¢Œ */
    color: rgba(255,255,255,0.8) !important;
    cursor: not-allowed !important;
    /* åº”ç”¨ä¸Šé¢çš„è„‰å†²åŠ¨ç”»ï¼Œ1.5ç§’å¾ªç¯ä¸€æ¬¡ */
    animation: sensingPulseRipple 1.5s infinite cubic-bezier(0.66, 0, 0.86, 1);
    transition: all 0.3s ease;
}
/* =========================================================
   ğŸï¸ æç®€æ—¶é—´è½´å¸ƒå±€ (ç‚¹ã€çº¿ã€å¹´æœˆæ—¥)
   ========================================================= */

/* 1. æ—¶é—´è½´å¤–å£³ï¼šå·¦è¾¹ç•™å‡º 25px ç»™çº¿å’Œç‚¹ */
#sense-timeline-container {
    position: relative;
    padding-left: 25px; 
    margin-top: 20px;
}

/* 2. å‚ç›´è½´çº¿ï¼šç”¨ä¼ªå…ƒç´ ç”»ä¸€æ¡ç»†çº¿ */
#sense-timeline-container::before {
    content: '';
    position: absolute;
    left: 5px; top: 10px; bottom: 0;
    width: 1px;
    background: #e5e5ea; /* æ·¡æ·¡çš„ç°è‰²çº¿æ¡ */
    z-index: 0;
}

.timeline-item {
    position: relative;
    margin-bottom: 35px; /* æ¯ä¸ªé¡¹ä¹‹é—´çš„é—´è· */
}

/* 1. å¹´æœˆæ—¥æ ‡é¢˜å¾®è°ƒ */
.timeline-date-label {
    position: relative;
    font-size: 13px;
    font-weight: 800;
    color: #8e8e93;
    margin-bottom: 15px;
    margin-left: -5px; /* å‘å·¦æŒªä¸€ç‚¹ï¼Œé¿å¼€ç«–çº¿ */
    background: #F2F2F7; /* ğŸš¨ è¿™é‡Œçš„èƒŒæ™¯è‰²è¦å’Œé¡µé¢åº•è‰²ä¸€è‡´ï¼Œç›–ä½åé¢çš„ç«–çº¿ */
    padding: 2px 5px;
    display: inline-block;
    z-index: 1;
}

/* 2. ç‚¹çš„ä½ç½®å¾®è°ƒ */
.timeline-dot {
    position: absolute;
    left: -24px; 
    top: 22px; /* ğŸš¨ å› ä¸ºæ²¡æœ‰æ ‡é¢˜æŒ¡ç€äº†ï¼ŒæŠŠç‚¹å¾€ä¸‹æŒªä¸€ç‚¹ç‚¹ï¼Œæ­£å¯¹ç€å¡ç‰‡çš„ä¸ŠåŠéƒ¨ */
    width: 9px; height: 9px;
    background: #1d1d1f; 
    border-radius: 50%;
    border: 2.5px solid #F2F2F7; 
    z-index: 2;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px; /* ç¼©çŸ­å¡ç‰‡ä¹‹é—´çš„å‚ç›´é—´è· */
}

/* =========================================================
   ğŸï¸ æ„ŸçŸ¥å¡ç‰‡ï¼šå¸ƒå±€é¿è®©ä¸é»‘æ¡ç¾åŒ–
   ========================================================= */

.summary-card {
    position: relative; /* å¿…é¡»æ˜¯ relativeï¼Œæ–¹ä¾¿å­å…ƒç´ å®šä½ */
    background: #fff;
    border-radius: 20px;
    padding: 18px;
    padding-bottom: 35px; /* ğŸš¨ åº•éƒ¨ç•™ç™½ï¼Œç»™æ—¶é—´æˆ³è…¾ä½ç½® */
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    overflow: hidden; /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢é»‘æ¡æ–œå‡ºå»æŒ¡ä½å¤–é¢ */
    border: 1px solid rgba(0,0,0,0.03);
}

/* é»‘è‰²æ–œè§’æ¡ç¾åŒ– */
.summary-card::before {
    content: "CORE MEMORY";
    position: absolute;
    top: 6px; 
    right: -32px; /* ç‰©ç†åç§»ï¼Œç¡®ä¿æ–œåº¦å®Œç¾ */
    width: 120px; /* ğŸš¨ é”å®šå®½åº¦ï¼Œè§£å†³å­—åœ¨ä¸åœ¨é‡Œé¢çš„é—®é¢˜ */
    background: #000;
    color: #fff;
    font-size: 8px;
    font-weight: 900;
    line-height: 22px; /* å¢åŠ è¡Œé«˜ï¼Œè®©æ–‡å­—å‚ç›´å±…ä¸­ */
    text-align: center;
    transform: rotate(45deg); /* 45åº¦è§’ */
    z-index: 5;
    letter-spacing: 1px;
}

/* ğŸš¨ é’ˆå¯¹æ—¶é—´æˆ³çš„å…¨æ–°å®šä½ */
.sense-card-time {
    position: absolute;
    bottom: 12px;
    right: 15px;
    font-size: 10px;
    color: #ccc;
    font-family: monospace; /* ç”¨ç­‰å®½å­—ä½“æ›´æœ‰ç§‘æŠ€æ„Ÿ */
}
/* =========================================================
   ğŸï¸ æ„ŸçŸ¥å¡ç‰‡ï¼šé»‘æ¡æ–œè§’ä¿®å¤å®Œç¾ç‰ˆ
   ========================================================= */

/* ç¡®ä¿çˆ¶å®¹å™¨æœ‰è¿™ä¸€æ¡ï¼Œå¦åˆ™é»‘æ¡ä¼šé£å‡ºå» */
.summary-card {
    /* ...ä½ åŸæœ‰çš„å…¶ä»–æ ·å¼... */
    overflow: hidden !important; /* ğŸš¨ æ ¸å¿ƒï¼šå¿…é¡»æœ‰è¿™ä¸ªï¼ŒæŠŠè¶…å‡ºçš„éƒ¨åˆ†åˆ‡æ‰ */
    position: relative; /* ç¡®ä¿æ˜¯å®šä½åŸºå‡† */
}

/* é»‘è‰²æ–œè§’æ¡ - é‡æ–°å®šä¹‰ */
.summary-card::before {
    content: "CORE MEMORY";
    position: absolute;
    /* ğŸš¨ å…³é”®å®šä½ç»„åˆï¼šç»è¿‡è®¡ç®—çš„é»„é‡‘æ¯”ä¾‹ */
    top: 18px;      /* è·ç¦»é¡¶éƒ¨çš„å‚ç›´è·ç¦» */
    right: -48px;   /* å‘å³è´Ÿå‘åç§»ï¼Œè®©å®ƒæŒ‚åœ¨è§’ä¸Š */
    
    /* é”å®šå®½åº¦ï¼Œç¡®ä¿è¶³å¤Ÿå®¹çº³æ–‡å­— */
    width: 140px;
    
    /* æ—‹è½¬ 45 åº¦ */
    transform: rotate(45deg);
    /* è®¾å®šæ—‹è½¬åŸºç‚¹ä¸ºä¸­å¿ƒï¼Œé˜²æ­¢è·‘å */
    transform-origin: center;

    /* æ ·å¼ç¾åŒ– */
    background: #1d1d1f; /* ç”¨æ·±ç°è‰²æ›´æœ‰è´¨æ„Ÿï¼Œæˆ–è€…ä½ ç»§ç»­ç”¨ #000 */
    color: #fff;
    text-align: center; /* æ–‡å­—æ°´å¹³å±…ä¸­ */
    font-size: 9px;     /* å­—ä½“å¤§å° */
    font-weight: 800;   /* å­—ä½“åŠ ç²— */
    
    /* ğŸš¨ ç”¨ padding æ¥æ§åˆ¶æ¡å­çš„åšåº¦ï¼Œæ¯” line-height æ›´ç¨³å®š */
    padding: 5px 0;     
    line-height: 1;     /* é‡ç½®è¡Œé«˜ */
    
    letter-spacing: 0.5px; /* å­—é—´è·ç¨å¾®ç´§ä¸€ç‚¹ */
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* åŠ ä¸€ç‚¹ç‚¹é˜´å½±å¢åŠ ç«‹ä½“æ„Ÿ */
}
/* --- ğŸ—ºï¸ åœ°åŒºæ„ŸçŸ¥å¡ç‰‡é«˜çº§æ ·å¼ --- */
.region-mag-card {
    width: 100% !important;
    height: 280px;
    border-radius: 32px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    margin-bottom: 25px;
    cursor: pointer;
    /* ğŸš¨ è¿™é‡Œç»å¯¹ä¸è¦å†™ background-image: url(...) ğŸš¨ */
    background: #000; /* ç»™ä¸€ä¸ªé»˜è®¤é»‘è‰²å…œåº•å³å¯ */
}

.mag-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 30%, rgba(0,0,0,0.7) 100%);
}

.mag-content {
    position: absolute;
    bottom: 25px; left: 25px; right: 25px;
    color: #fff;
    z-index: 2;
}

.mag-city-name {
    font-size: 32px;
    font-weight: 900;
    letter-spacing: -1px;
    text-transform: uppercase;
}

.mag-divider {
    width: 40px; height: 3px;
    background: #007AFF;
    margin: 8px 0 12px 0;
}

.mag-vibe-text {
    font-size: 14px;
    line-height: 1.5;
    font-family: serif;
    font-style: italic;
    opacity: 0.9;
}

.mag-tag {
    position: absolute; top: -180px; right: 0;
    font-size: 9px; font-weight: 900; letter-spacing: 2px;
    padding: 4px 10px; background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px); border-radius: 20px;
}
/* --- ğŸ—ºï¸ åœ°åŒºå¡ç‰‡é¢œå€¼æ‹¯æ•‘ --- */
.region-mag-card {
    width: 100%; height: 280px; border-radius: 32px;
    background-color: #000; background-size: cover; background-position: center;
    position: relative; overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2); margin-bottom: 25px;
    cursor: pointer; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.region-mag-card:active { transform: scale(0.97); }

.mag-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(180deg, rgba(0,0,0,0) 20%, rgba(0,0,0,0.8) 100%);
}

.mag-content {
    position: absolute; bottom: 30px; left: 25px; right: 25px; color: #fff; z-index: 5;
}

.mag-tag-row { display: flex; align-items: center; gap: 10px; }
.mag-city-name { font-size: 36px; font-weight: 900; letter-spacing: -1.5px; text-transform: uppercase; }
.mag-status-dot { width: 8px; height: 8px; background: #34C759; border-radius: 50%; box-shadow: 0 0 10px #34C759; animation: pulse 2s infinite; }

.mag-divider { width: 30px; height: 4px; background: #007AFF; margin: 12px 0; border-radius: 2px; }

.mag-vibe-text {
    font-size: 16px; line-height: 1.6; font-family: serif; font-style: italic;
    color: rgba(255,255,255,0.95); margin-bottom: 15px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.mag-footer { display: flex; justify-content: space-between; font-size: 10px; font-weight: 800; letter-spacing: 1px; color: rgba(255,255,255,0.4); }

/* åŠ è½½å±‚ */
.vibe-loading-layer {
    position: absolute; inset: 0; background: rgba(0,0,0,0.4);
    backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 10;
}
/* =========================================================
   ğŸš¨ åœ°åŒºæ„ŸçŸ¥é¡µï¼šç‰©ç†æ‹‰ä¼¸ä¸é¢œå€¼é‡å¡‘
   ========================================================= */

/* 1. å®¹å™¨å¼ºåˆ¶é“ºæ»¡ï¼Œå–æ¶ˆå±…ä¸­å¯¹é½ */
#subpage-region-perceive .app-body {
    display: block !important; /* ğŸš¨ æ ¸å¿ƒï¼šå–æ¶ˆ flex å±…ä¸­ */
    width: 100% !important;
    padding: 20px 16px 120px 16px !important; /* æ ‡å‡† iOS ä¸¤ä¾§è¾¹è· */
    box-sizing: border-box !important;
}

.region-mag-card {
    width: 100% !important;
    height: 280px;
    border-radius: 32px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    margin-bottom: 25px;
    background: #1c1c1e; /* ğŸš¨ åªéœ€è¦ä¸€ä¸ªæ·±è‰²åº•è‰²ï¼Œä¸è¦ url() ğŸš¨ */
    cursor: pointer;
}

/* 3. åˆ—è¡¨ç»„é‡å¡‘ï¼šå…¨å®½ + åœ†è§’åŒ…è£¹ */
#subpage-region-perceive .ios-list-group {
    width: 100% !important;
    border-radius: 14px !important; /* å¢åŠ åœ†è§’ */
    overflow: hidden !important;    /* é˜²æ­¢å­å…ƒç´ æº¢å‡ºåœ†è§’ */
    margin-bottom: 30px !important;
    background: #fff !important;    /* ç¡®ä¿æœ‰èƒŒæ™¯è‰² */
}

#subpage-region-perceive .ios-list-item {
    padding-right: 16px !important; /* ç¡®ä¿å¼€å…³ä¸è´´è¾¹ */
}

/* 4. åŸå¸‚ç½‘æ ¼é‡å¡‘ï¼šä»â€œå‡ ä¸ªå­—â€å˜æˆâ€œæ¼‚äº®çš„æŒ‰é’®å—â€ */
.city-grid {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 12px !important;         /* å—ä¹‹é—´çš„é—´è· */
    width: 100% !important;
    margin-top: 15px !important;
    justify-content: flex-start !important; /* å·¦å¯¹é½ï¼Œè€Œä¸æ˜¯å±…ä¸­ */
}

.city-tag {
    /* è®©å®ƒçœ‹èµ·æ¥åƒä¸ªå¯ç‚¹å‡»çš„æŒ‰é’®å— */
    background: #fff !important;
    padding: 14px 20px !important;
    border-radius: 12px !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    color: #1d1d1f !important;
    text-align: center !important;
    
    /* è®©å®ƒä»¬è‡ªåŠ¨å¡«æ»¡ä¸€è¡Œï¼Œçœ‹èµ·æ¥æ›´æ•´é½ */
    flex: 1 0 calc(30% - 12px) !important; /* ä¸€è¡Œå¤§çº¦æ”¾3ä¸ªï¼Œè‡ªåŠ¨æ‹‰ä¼¸ */
    box-shadow: 0 4px 10px rgba(0,0,0,0.03) !important; /* åŠ ä¸€ç‚¹ç‚¹æŠ•å½± */
    transition: all 0.2s ease;
}

/* ç‚¹å‡»æ—¶çš„åé¦ˆæ•ˆæœ */
.city-tag:active {
    background: #f2f2f7 !important;
    transform: scale(0.98);
}

/* åˆ†ç»„æ ‡é¢˜å¾®è°ƒ */
.tz-group-title {
    padding-left: 5px !important; /* ç¨å¾®è·Ÿä¸‹é¢çš„å—å¯¹é½ */
    margin-bottom: 10px !important;
}
/* =========================================================
   ğŸš‘ åœ°åŒºæ„ŸçŸ¥é¡µï¼šåˆ—è¡¨è¡Œå¯¹é½å¼ºåˆ¶ä¿®æ­£
   ========================================================= */

/* 1. å¼ºåˆ¶åˆ—è¡¨é¡¹å·¦å³æ’‘æ»¡ */
#subpage-region-perceive .ios-list-item {
    display: flex !important;
    align-items: center !important;
    /* æ ¸å¿ƒï¼šæ–‡å­—åœ¨å·¦ï¼Œå†…å®¹åœ¨å³ */
    justify-content: space-between !important; 
    
    /* ç‰©ç†è¾¹è·ï¼šå·¦è¾¹ç•™å‡º 16px çš„å‘¼å¸ç©ºé—´ */
    padding-left: 16px !important;
    padding-right: 16px !important;
    
    width: 100% !important;
    box-sizing: border-box !important;
}

/* 2. ç¡®ä¿æ ‡ç­¾æ–‡å­—æœ¬èº«ä¹Ÿæ˜¯é å·¦å¯¹é½ */
#subpage-region-perceive .item-label {
    text-align: left !important;
    flex: 1 !important; /* è®©æ–‡å­—å æ®å‰©ä½™ç©ºé—´ï¼ŒæŠŠå³è¾¹çš„ä¸œè¥¿æ¨è¿‡å» */
}

/* 3. ä¿®æ­£å³ä¾§å†…å®¹åŒºåŸŸ */
#subpage-region-perceive .item-right {
    display: flex !important;
    align-items: center !important;
    justify-content: flex-end !important;
    flex-shrink: 0 !important; /* é˜²æ­¢å³è¾¹å†…å®¹è¢«æŒ¤å‹ */
}
/* --- ğŸ’ åŒè¯­å¯¹ç…§æ°”æ³¡é«˜çº§æ ·å¼ --- */

/* ç¿»è¯‘æŠ˜å å®¹å™¨ */
.bubble-translation-box {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
    opacity: 0;
}

/* æ¿€æ´»æ˜¾ç¤ºè¯‘æ–‡ */
.bubble.show-trans .bubble-translation-box {
    max-height: 200px;
    opacity: 1;
    margin-top: 10px;
}

/* è£…é¥°åˆ†å‰²çº¿ */
.trans-line {
    width: 20px;
    height: 2px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 1px;
    margin-bottom: 8px;
}

.msg-row.user .trans-line { background: rgba(255, 255, 255, 0.3); }

/* è¯‘æ–‡æ–‡å­—æ ·å¼ */
.msg-text-trans {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.5;
    font-family: -apple-system, sans-serif;
    font-style: normal;
}

/* ç¿»è¯‘åˆ‡æ¢æŒ‰é’®ï¼šç‰©ç†éš”ç¦»ç‚¹å‡»çš„å…³é”® */
.trans-toggle-btn {
    position: absolute;
    bottom: -18px;
    right: 10px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    padding: 2px 8px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    color: #8E8E93;
    font-size: 10px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s;
}

.trans-toggle-btn:active { transform: scale(0.9); background: #eee; }

/* å±•å¼€æ—¶çš„å›¾æ ‡æ—‹è½¬ */
.bubble.show-trans .trans-toggle-btn svg { transform: rotate(180deg); }
.bubble.show-trans .trans-toggle-btn { color: #007AFF; }
/* ç¡®ä¿æ°”æ³¡ä¸è£åˆ‡æ‰å¼¹å‡ºçš„ç¿»è¯‘æŒ‰é’® */
.bubble {
    position: relative;
    overflow: visible !important; /* å…è®¸æŒ‰é’®æ‚¬æµ®åœ¨å¤–é¢ */
}

/* å¼ºåˆ¶ç¿»è¯‘æŒ‰é’®å±‚çº§æœ€é«˜ */
.trans-toggle-btn {
    z-index: 100 !important;
    pointer-events: auto !important;
}
/* =========================================================
   ğŸŒ ç¿»è¯‘åŠŸèƒ½ï¼šç‰©ç†æ˜¾å½¢ä¸äº¤äº’ç¾åŒ–
   ========================================================= */

/* 1. æ°”æ³¡å®¹å™¨ï¼šå¿…é¡»å…è®¸å†…å®¹æº¢å‡ºï¼Œå¦åˆ™æŒ‰é’®ä¼šè¢«åˆ‡æ‰ */
.bubble {
    position: relative !important;
    overflow: visible !important; /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢åˆ‡æ‰æŒ‰é’® */
    padding-bottom: 12px !important; /* ç»™åº•éƒ¨ç•™å‡ºå‘¼å¸ç©ºé—´ */
}

/* 2. åŸæ–‡å†…å®¹ï¼šç¡®ä¿ä¸è¢«æŒ‰é’®é®æŒ¡ */
.msg-text-main {
    word-break: break-word;
    line-height: 1.6;
}

/* 3. ç¿»è¯‘æŠ˜å ç›’ï¼šä¸æ»‘æ»‘ä¸‹æ•ˆæœ */
.bubble-translation-box {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease, 
                margin 0.3s ease;
}

/* æ¿€æ´»æ€ï¼šæ˜¾ç¤ºç¿»è¯‘ */
.bubble.show-trans .bubble-translation-box {
    max-height: 500px;
    opacity: 1;
    margin-top: 12px;
    border-top: 0.5px solid rgba(0, 0, 0, 0.08); /* å¢åŠ åˆ†å‰²çº¿ */
    padding-top: 10px;
}

/* 4. è¯‘æ–‡æ–‡å­—æ ·å¼ */
.msg-text-trans {
    font-size: 13px;
    color: #8E8E93; /* iOS æ ‡å‡†å‰¯æ–‡æœ¬ç° */
    font-style: italic; /* æ–œä½“å¢åŠ ç”µå½±æ„Ÿ */
    line-height: 1.5;
}

/* 5. ğŸš¨ ç¿»è¯‘æŒ‰é’®ï¼šç‰©ç†å®šä½è¡¥ä¸ */
.trans-toggle-btn {
    position: absolute;
    bottom: -14px; /* ğŸš¨ ç‰©ç†åç§»ï¼Œè®©å®ƒè·¨åœ¨æ°”æ³¡è¾¹ç¼˜ */
    right: 12px;
    
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    
    padding: 2px 10px;
    border-radius: 10px;
    border: 0.5px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    
    display: flex;
    align-items: center;
    gap: 4px;
    
    color: #8E8E93;
    font-size: 10px;
    font-weight: 800;
    cursor: pointer;
    z-index: 100; /* ç¡®ä¿å®ƒåœ¨æœ€é¡¶å±‚ */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* æŒ‰é’®ç‚¹å‡»/å±•å¼€æ€ */
.trans-toggle-btn:active {
    transform: scale(0.92);
}

.bubble.show-trans .trans-toggle-btn {
    color: #007AFF; /* å±•å¼€åå˜è“ */
    background: #fff;
    bottom: -16px;
}

/* æ—‹è½¬å°ç®­å¤´ */
.trans-toggle-btn svg {
    transition: transform 0.3s ease;
}
.bubble.show-trans .trans-toggle-btn svg {
    transform: rotate(180deg);
}
/* æœç´¢æ¡†å†…çš„æ–‡å­—é¢œè‰²çº å */
#lang-search-in::placeholder {
    color: #8e8e93;
    font-weight: 400;
}

/* ç¡®ä¿åˆ—è¡¨åœ¨æœç´¢æ—¶é«˜åº¦ç¨³å®šï¼Œä¸è·³åŠ¨ */
#model-sheet-list {
    min-height: 200px;
    transition: all 0.3s ease;
}

/* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨ */
#model-sheet-list::-webkit-scrollbar {
    display: none;
}
/* --- ä¸»é¢˜å•†åº—ä¸“ç”¨æ ·å¼ --- */
.theme-preview-box {
    width: 100%; height: 200px; background: #fff; border-radius: 28px;
    margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    border: 6px solid #fff; overflow: hidden; position: relative;
}

.preview-chat-container { padding: 15px; transform: scale(0.9); transform-origin: top; }

.theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }

.theme-card {
    aspect-ratio: 1/1; border-radius: 16px; display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.theme-card:active { transform: scale(0.9); }

.code-editor-textarea {
    width: 100%; height: 160px; background: transparent; color: #34C759;
    border: none; padding: 15px; font-family: 'Courier New', monospace;
    font-size: 13px; line-height: 1.5; outline: none; resize: none;
}
.ui-simulator-box {
    width: 100%; height: 350px; background: #000; border-radius: 36px;
    padding: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); margin-bottom: 25px;
}
.sim-screen {
    width: 100%; height: 100%; background: #F2F2F7; border-radius: 28px;
    display: flex; flex-direction: column; overflow: hidden;
}
.sim-status-bar { height: 25px; display: flex; justify-content: space-between; padding: 5px 15px; font-size: 10px; font-weight: 700; }
.sim-header { height: 40px; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border-bottom: 0.5px solid #eee; }
.sim-content { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.sim-bubble-opp, .sim-bubble-user { padding: 8px 12px; border-radius: 15px; font-size: 12px; max-width: 80%; }
.sim-bubble-opp { background: #fff; align-self: flex-start; }
.sim-bubble-user { background: #007AFF; color: #fff; align-self: flex-end; }
.sim-footer { height: 50px; background: #fff; border-top: 0.5px solid #eee; display: flex; align-items: center; padding: 0 10px; }
.sim-input { flex: 1; background: #f2f2f7; height: 30px; border-radius: 15px; display: flex; align-items: center; padding-left: 15px; color: #ccc; font-size: 11px; }

/* ä»£ç ç¼–è¾‘å™¨ä¸“ç”¨ */
.code-editor-textarea {
    width: 100%; height: 200px; background: transparent; color: #34C759;
    border: none; padding: 15px; font-family: 'Courier New', monospace;
    font-size: 13px; line-height: 1.5; outline: none; resize: none;
}
.ui-phone-container {
    width: 240px; /* å›ºå®šå®½åº¦ï¼Œæ¯”ä¾‹é”å®š */
    height: 426px; 
    margin: 0 auto 30px auto;
    background: #000;
    border-radius: 38px;
    padding: 10px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    position: relative;
    border: 3px solid #333;
}
/* æ¨¡æ‹Ÿåˆ˜æµ· */
.ui-phone-notches {
    position: absolute; top: 18px; left: 50%; transform: translateX(-50%);
    width: 60px; height: 18px; background: #000; border-radius: 10px; z-index: 10;
}
.ui-phone-screen {
    width: 100%; height: 100%; background: #F2F2F7; border-radius: 28px;
    overflow: hidden; position: relative;
}
.sim-wrapper { height: 100%; display: flex; flex-direction: column; }
.sim-status-bar { height: 35px; display: flex; justify-content: space-between; padding: 12px 15px 0; font-size: 9px; font-weight: 700; }
.sim-header { height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; border-bottom: 0.5px solid #ddd; font-size: 11px; font-weight: 600; }
.sim-chat-area { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
.sim-bubble-opp, .sim-bubble-user { padding: 8px 12px; border-radius: 16px; font-size: 11px; max-width: 85%; line-height: 1.4; }
.sim-bubble-opp { background: #fff; align-self: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.sim-bubble-user { background: #007AFF; color: #fff; align-self: flex-end; }
.sim-footer-bar { height: 50px; background: #fff; border-top: 0.5px solid #ddd; display: flex; align-items: center; padding: 0 8px; gap: 6px; }
.sim-input-box { flex: 1; background: #f2f2f7; height: 30px; border-radius: 15px; font-size: 10px; color: #bbb; line-height: 30px; padding-left: 12px; }
.sim-add, .sim-btn { color: #007AFF; font-weight: 700; font-size: 14px; }
.actual-mirror-layer {
    width: 375px; /* ç‰©ç†å®½åº¦é”å®š */
    height: 667px; /* ç‰©ç†é«˜åº¦é”å®š */
    display: flex;
    flex-direction: column;
    transform: scale(0.64); /* ç‰©ç†ç¼©æ”¾æ¯”ä¾‹ (240/375) */
    transform-origin: top left;
    background: #F2F2F7;
    position: absolute;
    top: 0; left: 0;
    pointer-events: none; /* é¢„è§ˆå±‚ç¦æ­¢ç‚¹å‡» */
}

/* ç¡®ä¿é¢„è§ˆé‡Œçš„ç»„ä»¶ä¸ä¼šå› ä¸ºåŸæœ¬çš„ absolute å®šä½è·‘å */
.actual-mirror-layer .chat-room-header,
.actual-mirror-layer .chat-room-footer {
    position: relative !important;
    left: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
}
/* ğŸš¨ ç‰©ç†é•œåƒç¼©æ”¾å¼•æ“ */
.actual-mirror-layer {
    width: 375px; /* æ ‡å‡†é€»è¾‘å®½åº¦ */
    height: 680px; /* è¶³å¤Ÿé•¿ï¼Œä¿è¯ Footer ä¸è¢«åˆ‡æ‰ */
    display: flex;
    flex-direction: column;
    /* è®¡ç®—ç¼©æ”¾ï¼š324 (å†…éƒ¨å®é™…å®½åº¦) / 375 = 0.864 */
    transform: scale(0.864); 
    transform-origin: top left;
    background: transparent; /* ç‰©ç†é€æ˜ */
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
}

/* ç¡®ä¿é¢„è§ˆé‡Œçš„æ‚¬æµ®åº•æ ä¸ä¼šè·‘å */
.actual-mirror-layer .chat-room-footer-wrapper {
    width: 100%;
    margin-top: auto;
}
/* ä¿®æ”¹åº•æ å®¹å™¨ */
.actual-mirror-layer .chat-room-footer {
    background: rgba(255, 255, 255, 0.95) !important; /* æé«˜ä¸é€æ˜åº¦ */
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1) !important; /* å‘ä¸ŠæŠ•å°„é˜´å½±ï¼Œå¢å¼ºç«‹ä½“æ„Ÿ */
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
}
/* ä¿®æ”¹è¾“å…¥æ¡†æ–‡å­—å¯¹é½ */
.actual-mirror-layer .chat-room-input {
    display: flex !important;
    align-items: center !important; /* å‚ç›´å±…ä¸­æ ¸å¿ƒæŒ‡ä»¤ */
    height: 40px !important;       /* é”å®šé«˜åº¦ */
    line-height: 40px !important;  /* ç¡®ä¿è¡Œé«˜ä¸é«˜åº¦ä¸€è‡´ */
    padding: 0 15px !important;    /* å·¦å³ç•™ç™½ï¼Œä¸Šä¸‹è®¾ä¸º0 */
    background: rgba(0, 0, 0, 0.05) !important;
}
/* --- ğŸ’ èŠå¤©å¯¹é½æ ¸å¿ƒï¼šç‰©ç†é”æ­»åè®® --- */

/* 1. åŸºç¡€è¡Œå®¹å™¨ï¼šå¿…é¡»å æ»¡ 100% */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 16px 0 !important;
    padding: 0 5px !important; /* å·¦å³ç•™å‡º iOS æ ‡å‡†è¾¹è· */
    box-sizing: border-box !important;
    align-items: flex-end !important; /* å¤´åƒå¯¹é½æ°”æ³¡åº•éƒ¨ */
    position: relative !important;
}

/* 2. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ï¼šæ­£å¸¸æ’åˆ— */
.msg-row.opponent {
    flex-direction: row !important; 
    justify-content: flex-start !important;
}

/* 3. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ï¼šé•œåƒåè½¬ */
.msg-row.user {
    flex-direction: row-reverse !important; /* ğŸ’¡ æ ¸å¿ƒï¼šå¤´åƒè‡ªåŠ¨å»å³è¾¹ï¼Œæ°”æ³¡å»å·¦è¾¹ */
    justify-content: flex-start !important; /* ğŸ’¡ é…åˆ row-reverseï¼Œå†…å®¹ä¼šä»å³ä¾§å¼€å§‹æ’ */
}

/* 4. å¤´åƒæ ·å¼ï¼šç‰©ç†å°ºå¯¸é”å®š (ä¿®å¤äº†ä½ ä»£ç é‡Œçš„ 10000px é”™è¯¯) */
.chat-avatar-img {
    width: 38px !important;
    height: 38px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important; /* ç¦æ­¢æŒ¤å‹ */
    object-fit: cover !important;
    display: block !important;
}

/* 5. å¤´åƒä¸æ°”æ³¡çš„é—´è· */
.msg-row.opponent .chat-avatar-img { margin-right: 10px !important; }
.msg-row.user .chat-avatar-img { margin-left: 10px !important; }

/* 6. æ°”æ³¡å®½åº¦è‡ªé€‚åº” */
.bubble {
    max-width: 75% !important; /* é™åˆ¶å®½åº¦ï¼Œé˜²æ­¢å¤´åƒè¢«æŒ¤èµ° */
    position: relative !important;
    word-wrap: break-word !important;
}
/* --- ğŸ•°ï¸ æ—¶é—´æˆ³ä¸åˆ†éš”ç¬¦é«˜çº§æ ·å¼ --- */

/* 1. æ°”æ³¡ä¸‹æ–¹çš„è‹±æ–‡æ—¶é—´ */
.bubble-time {
    font-size: 10px;
    color: #A1A1A6;
    margin-top: 5px;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    font-weight: 500;
    text-transform: uppercase; /* ç»Ÿä¸€å¤§å†™ AM/PM */
}

/* å†…å®¹åŒ…è£¹å™¨ï¼šç¡®ä¿æ°”æ³¡å’Œæ—¶é—´æˆ³å‚ç›´æ’åˆ— */
.msg-content-wrapper {
    display: flex;
    flex-direction: column;
    max-width: 75%;
    position: relative;
}

/* ç”¨æˆ·æ°”æ³¡ä¸‹çš„æ—¶é—´é å³å¯¹é½ */
.msg-row.user .msg-content-wrapper {
    align-items: flex-end;
}

/* å¯¹æ–¹æ°”æ³¡ä¸‹çš„æ—¶é—´é å·¦å¯¹é½ */
.msg-row.opponent .msg-content-wrapper {
    align-items: flex-start;
}

/* 2. ä¸­é—´çš„æ—¶é—´åˆ†éš”ç¬¦ï¼ˆå¼ºåŒ–ç‰ˆï¼‰ */
.chat-time-divider {
    text-align: center;
    font-size: 11px;
    font-weight: 700;
    color: #C7C7CC;
    letter-spacing: 0.5px;
    margin: 25px 0 15px 0;
    width: 100%;
    clear: both;
}
/* =========================================================
   ğŸ•°ï¸ èŠå¤©å®¤ç‰©ç†å±‚çº§é”æ­»è¡¥ä¸ (è§£å†³æ°”æ³¡å˜çŸ­ã€å¤´åƒé”™ä½)
   ========================================================= */

/* 1. åŸºç¡€è¡Œå®¹å™¨ï¼šå¿…é¡»å æ»¡å…¨å®½ */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 18px 0 !important;
    padding: 0 12px !important;
    box-sizing: border-box !important;
    align-items: flex-end !important;
    position: relative !important;
    background: transparent !important;
}

/* 2. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ï¼š[å¤´åƒ] + [åŒ…è£¹å™¨] */
.msg-row.opponent {
    flex-direction: row !important;
    justify-content: flex-start !important;
}

/* 3. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ï¼š[åŒ…è£¹å™¨] + [å¤´åƒ] */
.msg-row.user {
    flex-direction: row-reverse !important; /* ğŸ’¡ å…³é”®ï¼šé•œåƒç¿»è½¬å†…å®¹ */
    justify-content: flex-start !important; /* ğŸ’¡ é…åˆé•œåƒå®ç°é å³ */
}

/* 4. å¤´åƒï¼šç‰©ç†é”å®šï¼Œç¦æ­¢å˜å½¢ */
.chat-avatar-img {
    width: 38px !important;
    height: 38px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important; /* ğŸš¨ ç¦æ­¢è¢«æ°”æ³¡æŒ¤æ‰ */
    object-fit: cover !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: block !important;
    margin: 0 !important;
}
/* è®¾ç½®å¤´åƒé—´è· */
.msg-row.opponent .chat-avatar-img { margin-right: 10px !important; }
.msg-row.user .chat-avatar-img { margin-left: 10px !important; }

/* 5. æ ¸å¿ƒå†…å®¹åŒ…è£¹å™¨ï¼šç‰©ç†é”å®šæ°”æ³¡å®½åº¦ */
.msg-content-wrapper {
    display: flex !important;
    flex-direction: column !important;
    max-width: 72% !important; /* ğŸ‘ˆ æ°”æ³¡æœ€å®½åªå å±å¹• 72%ï¼Œç»™å¤´åƒç•™ç©ºé—´ */
    flex-shrink: 1 !important;
}

/* è°ƒæ•´åŒ…è£¹å™¨å†…éƒ¨å¯¹é½ */
.msg-row.opponent .msg-content-wrapper { align-items: flex-start !important; }
.msg-row.user .msg-content-wrapper { align-items: flex-end !important; }

/* 6. æ°”æ³¡æœ¬ä½“ï¼šè§£å†³â€œå˜çŸ­â€é—®é¢˜çš„æ ¸å¿ƒ */
.bubble {
    width: fit-content !important; /* ğŸ‘ˆ å…³é”®ï¼šæ°”æ³¡å®½åº¦éšæ–‡å­—å†…å®¹èµ°ï¼Œä¸è¢«å¼ºåˆ¶å‹ç¼© */
    max-width: 100% !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    white-space: normal !important; /* ç¡®ä¿é•¿æ–‡å­—è‡ªåŠ¨æ¢è¡Œ */
    position: relative !important;
    padding: 12px 16px !important;
    border-radius: 20px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}

/* 7. æ°”æ³¡ä¸‹æ–¹çš„è‹±æ–‡æ—¶é—´æˆ³ */
.bubble-time {
    font-size: 10px;
    color: rgba(142, 142, 147, 0.8);
    margin-top: 5px;
    font-family: -apple-system, sans-serif;
    font-weight: 600;
    text-transform: uppercase;
}

/* 8. ä¸­é—´çš„æ—¶é—´åˆ†éš”ç¬¦ */
.chat-time-divider {
    width: 100% !important;
    text-align: center !important;
    font-size: 11px !important;
    font-weight: 800 !important;
    color: #C7C7CC !important;
    margin: 30px 0 15px 0 !important;
    letter-spacing: 0.5px !important;
}
/* =========================================================
   ğŸš€ ç‰©ç†æ‹‰ä¼¸è¡¥ä¸ï¼šæ¶ˆé™¤ä¸¤ä¾§ç©ºéš™ï¼Œè®©å¤´åƒå’Œæ°”æ³¡è´´è¿‘è¾¹ç¼˜
   ========================================================= */

/* 1. å¼ºåˆ¶æ»šåŠ¨å®¹å™¨ä¸é¢„ç•™è¿‡å¤§çš„ padding */
#chat-messages-container {
    padding: 10px 0 !important; /* ä¸Šä¸‹ç•™ç©ºï¼Œå·¦å³å½’é›¶ */
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    box-sizing: border-box !important;
}

/* 2. æ¶ˆæ¯è¡Œï¼šå æ»¡å…¨å®½ */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 12px 0 !important;
    /* ğŸš¨ å…³é”®ï¼šå·¦å³åªç•™ 8px çš„ç‰©ç†å‘¼å¸æ„Ÿï¼Œè®©å¤´åƒè´´è¾¹ */
    padding: 0 8px !important; 
    box-sizing: border-box !important;
    align-items: flex-end !important;
    position: relative !important;
}

/* 3. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§é è¾¹ï¼‰ */
.msg-row.opponent {
    flex-direction: row !important;
    justify-content: flex-start !important;
}

/* 4. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§é è¾¹ï¼‰ */
.msg-row.user {
    flex-direction: row-reverse !important; /* å¤´åƒåœ¨å³ï¼Œæ°”æ³¡åœ¨å·¦ */
    /* ğŸš¨ å…³é”®ï¼šåœ¨é•œåƒæ¨¡å¼ä¸‹ï¼Œflex-start å®é™…ä¸Šå°±æ˜¯è§†è§‰ä¸Šçš„æœ€å³ä¾§ */
    justify-content: flex-start !important; 
}

/* 5. å¤´åƒç‰©ç†å°ºå¯¸ä¸è´´è¾¹å¾®è°ƒ */
.chat-avatar-img {
    width: 42px !important;
    height: 42px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important;
    object-fit: cover !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* è°ƒæ•´å¤´åƒä¸æ°”æ³¡åŒ…è£¹å™¨çš„â€œç´§å‡‘æ„Ÿâ€ */
.msg-row.opponent .chat-avatar-img {
    margin-right: 8px !important; /* æ°”æ³¡è´´è¿‘å·¦ä¾§å¤´åƒ */
}

.msg-row.user .chat-avatar-img {
    margin-left: 8px !important;  /* æ°”æ³¡è´´è¿‘å³ä¾§å¤´åƒ */
}

/* 6. å†…å®¹åŒ…è£¹å™¨ï¼šæœ€å¤§å®½åº¦æ”¾å®½ï¼Œå…è®¸é•¿å¥å±•ç¤º */
.msg-content-wrapper {
    display: flex !important;
    flex-direction: column !important;
    /* ğŸš¨ å…³é”®ï¼šé™åˆ¶æœ€å¤§å®½åº¦ä¸º 78%ï¼Œç»™å¦ä¸€ä¾§ç•™å‡ºè¶³å¤Ÿçš„ç©ºç™½ï¼Œé˜²æ­¢æ°”æ³¡å æ»¡æ•´è¡Œ */
    max-width: 78% !important; 
}

/* 7. æ°”æ³¡æœ¬ä½“ï¼šè‡ªé€‚åº”å®½åº¦ */
.bubble {
    width: fit-content !important;
    min-width: 30px !important;
    max-width: 100% !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    padding: 12px 14px !important;
    border-radius: 18px !important;
}

/* =========================================================
   ğŸ” é¡¶ç«¯å¯¹é½è¡¥ä¸ï¼šè®©å¤´åƒä¸æ°”æ³¡é¦–è¡Œå®Œç¾å¹³é½
   ========================================================= */

/* 1. æ ¸å¿ƒå®¹å™¨ï¼šæ”¹ä¸ºé¡¶éƒ¨å¯¹é½ */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 12px 0 !important;
    padding: 0 8px !important;
    box-sizing: border-box !important;
    /* ğŸš¨ å…³é”®ä¿®æ”¹ï¼šä» flex-end æ”¹ä¸º flex-start */
    align-items: flex-start !important; 
    position: relative !important;
}

/* 2. å¤´åƒä½ç½®å¾®è°ƒï¼šä¸ºäº†å¯¹é½æ°”æ³¡é¡¶ç«¯ï¼Œé€šå¸¸éœ€è¦å‘ä¸‹åä¸ª 2-4px è§†è§‰æ‰æœ€å‡† */
.chat-avatar-img {
    width: 42px !important;
    height: 42px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important;
    object-fit: cover !important;
    /* ğŸš¨ ç»†èŠ‚ï¼šç¨å¾®ä¸‹ç§»ä¸€ç‚¹ï¼Œç¡®ä¿åœ†å¼§é¡¶éƒ¨å’Œæ°”æ³¡å¹³é½ */
    margin-top: 2px !important; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* 3. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ï¼šå¤´åƒåœ¨å·¦ï¼Œå†…å®¹åœ¨å³ */
.msg-row.opponent {
    flex-direction: row !important;
    justify-content: flex-start !important;
}

/* 4. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ï¼šå†…å®¹åœ¨å·¦ï¼Œå¤´åƒåœ¨å³ */
.msg-row.user {
    flex-direction: row-reverse !important;
    justify-content: flex-start !important;
}

/* 5. å†…å®¹åŒ…è£¹å™¨ï¼šç¡®ä¿æ°”æ³¡å’Œæ—¶é—´æˆ³ä¾ç„¶å‚ç›´æ’åˆ— */
.msg-content-wrapper {
    display: flex !important;
    flex-direction: column !important;
    max-width: 78% !important;
    /* ğŸš¨ è¿™é‡Œçš„ flex-start ä¿è¯æ°”æ³¡é¡¶ç€è¡Œå®¹å™¨ä¸Šæ–¹ */
    justify-content: flex-start !important; 
}

/* 6. è°ƒæ•´é—´è· */
.msg-row.opponent .msg-content-wrapper {
    margin-left: 8px !important;
    align-items: flex-start !important;
}

.msg-row.user .msg-content-wrapper {
    margin-right: 8px !important;
    align-items: flex-end !important;
}

/* 7. æ°”æ³¡æœ¬ä½“ï¼šä¿æŒè‡ªé€‚åº” */
.bubble {
    width: fit-content !important;
    max-width: 100% !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    padding: 12px 14px !important;
    border-radius: 18px !important;
    /* å¼ºåˆ¶å»æ‰å¯èƒ½å½±å“é«˜åº¦çš„æ—§ margin */
    margin-top: 0 !important; 
}

/* 8. æ°”æ³¡æ—¶é—´æˆ³ï¼šä¾ç„¶ç•™åœ¨æ°”æ³¡ä¸‹æ–¹ */
.bubble-time {
    font-size: 10px;
    color: rgba(142, 142, 147, 0.7);
    margin-top: 5px;
    font-family: -apple-system, sans-serif;
}
/* =========================================================
   ç´§å‡‘å¯¹é½è¡¥ä¸ï¼šç¼©å°é—´è· + é¡¶ç«¯ç‰©ç†å¹³é½
   ========================================================= */

/* 1. è°ƒæ•´æ•´è¡Œçš„å·¦å³ç•™ç™½ï¼Œè®©å¤´åƒæ›´è´´è¾¹ */
.msg-row {
    padding: 0 10px !important; /* å·¦å³ä¿ç•™ 10px çš„æ ‡å‡†å‘¼å¸æ„Ÿ */
    align-items: flex-start !important; /* ç¡®ä¿é¡¶ç«¯å¯¹é½ */
    margin: 10px 0 !important; /* ç¨å¾®ç¼©å°è¡Œä¸è¡Œçš„å‚ç›´é—´è· */
}

/* 2. æ ¸å¿ƒï¼šå¤§å¹…ç¼©å°å¤´åƒä¸æ°”æ³¡ä¹‹é—´çš„æ¨ªå‘ç©ºéš™ */
.msg-row.opponent .chat-avatar-img {
    margin-right: 6px !important; /* ğŸ‘ˆ ä» 12px ç¼©å‡åˆ° 6pxï¼Œç´§å‡‘æ„Ÿç«‹ç° */
}

.msg-row.user .chat-avatar-img {
    margin-left: 6px !important;  /* ğŸ‘ˆ ä» 12px ç¼©å‡åˆ° 6px */
}

/* 3. å¤´åƒé«˜åº¦å¾®è°ƒï¼šè§£å†³â€œä¸åœ¨ä¸€ä¸ªé«˜åº¦â€çš„è§†è§‰è¯¯å·® */
.chat-avatar-img {
    width: 40px !important;
    height: 40px !important;
    /* ğŸš¨ å…³é”®ï¼šå¦‚æœä½ çš„æ°”æ³¡æœ‰è¾¹æ¡†æˆ–æŠ•å½±ï¼Œè¿™é‡Œè®¾ä¸º 0px è§†è§‰ä¸Šæœ€å¹³é½ */
    margin-top: 0px !important; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* 4. æ°”æ³¡å®¹å™¨ï¼šç¡®ä¿å†…éƒ¨æ²¡æœ‰å¤šä½™çš„ margin å¹²æ‰°é«˜åº¦ */
.msg-content-wrapper {
    margin-top: 0 !important;
}

.bubble {
    /* è°ƒæ•´æ°”æ³¡åœ†è§’ï¼Œè®©é¡¶ç«¯å¯¹é½æ—¶çœ‹èµ·æ¥æ›´è‡ªç„¶ */
    border-radius: 16px !important;
    padding: 10px 14px !important; /* ç¨å¾®å‹ç¼©ä¸€ç‚¹æ°”æ³¡å†…è¾¹è·ï¼Œæ›´å¹²ç»ƒ */
}

/* 1. å®¿å‘½é¡µå®¹å™¨ï¼šé»˜è®¤ç‰©ç†éšè— */
.destiny-stage-ins {
    position: fixed !important;
    inset: 0 !important;
    display: none; /* ğŸš¨ è¿™é‡Œåˆ æ‰ flex !importantï¼Œé»˜è®¤ä¸æ˜¾ç¤º */
    flex-direction: column !important;
    height: 100vh !important;
    overflow: hidden !important;
    background: #000 !important;
    z-index: 999999;
}

/* 2. åªæœ‰åœ¨ active çŠ¶æ€ä¸‹æ‰æ˜¾å½¢ */
.destiny-stage-ins.active {
    display: flex !important;
}

/* 2. å‹ç¼©å¤´éƒ¨é«˜åº¦ï¼Œè§£å†³ä¸­é—´ç©ºç™½è¿‡å¤§çš„é—®é¢˜ */
.ins-art-header {
    flex-shrink: 0 !important;
    width: 100% !important;
    height: 50vh !important; /* ä» 45vh ç¼©å°åˆ° 38vhï¼Œå†…å®¹è‡ªç„¶å°±å¾€ä¸Šæäº† */
    position: relative !important;
    z-index: 10;
}

/* ğŸš¨ æ ¸å¿ƒæº¶å›¾ï¼šç…§ç‰‡åƒçƒŸé›¾ä¸€æ ·æ¶ˆæ•£ */
.header-hero-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center 20%;
    /* ç‰©ç†æº¶å›¾é®ç½©ï¼šé¡¶éƒ¨å’Œä¸¤ä¾§ç¨å¾®æš—åŒ–ï¼Œåº•éƒ¨å®Œå…¨é€æ˜æ¶ˆå¤± */
    -webkit-mask-image: linear-gradient(to bottom, 
        rgba(0,0,0,1) 0%, 
        rgba(0,0,0,1) 60%, 
        rgba(0,0,0,0) 100%);
    mask-image: linear-gradient(to bottom, 
        rgba(0,0,0,1) 0%, 
        rgba(0,0,0,1) 60%, 
        rgba(0,0,0,0) 100%);
    filter: brightness(0.7) contrast(1.1);
    z-index: 1;
}

/* å†…å®¹å®¹å™¨ */
.header-main-content {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 0 25px 30px 25px;
    z-index: 5;
}

/* å®¿å‘½æ ‡ç­¾ */
.fate-status-tag {
    font-size: 10px;
    font-weight: 900;
    letter-spacing: 3px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    margin-bottom: 8px;
}

/* 1. ç¼©å°æ˜µç§°å­—å·å¹¶å¾€ä¸‹ç§» */
#sync-char-name {
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 2.2rem !important; /* ä» 3.8 è°ƒå°åˆ° 2.2 */
    font-weight: 300 !important;
    font-style: italic !important;
    color: #ffffff !important;
    text-shadow: 0 0 15px rgba(255, 255, 255, 0.2), 0 5px 15px rgba(0, 0, 0, 0.5) !important;
    margin: 25px 0 10px 0 !important; /* å¢åŠ é¡¶éƒ¨ margin (25px) è®©å®ƒå¾€ä¸‹ç§» */
}

/* ğŸš¨ æ ¸å¿ƒï¼šå¤šç»´æ„ŸçŸ¥ç½‘æ ¼ (å®šä½ã€å¤©æ°”ã€å¤©æ•°) */
.perception-grid {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px 0;
    border-top: 0.5px solid rgba(255,255,255,0.1);
    border-bottom: 0.5px solid rgba(255,255,255,0.1);
}

.p-item { display: flex; flex-direction: column; gap: 4px; }
.p-label { font-size: 9px; color: rgba(255,255,255,0.3); font-weight: 800; text-transform: uppercase; }
.p-value { font-size: 13px; color: #fff; font-weight: 500; letter-spacing: 0.5px; }

/* è¿›åº¦æ¡ï¼šæµå…‰é“¶ä¸ */
.mini-progress-track {
    width: 100%;
    height: 1px;
    background: rgba(255,255,255,0.1);
    margin-bottom: 25px;
    position: relative;
}

.progress-glow-line {
    height: 100%;
    background: #fff;
    box-shadow: 0 0 10px rgba(255,255,255,0.8);
}

/* æ•£æ–‡æ–‡æ¡ˆ */
.art-prose-quote {
    font-size: 16px;
    line-height: 1.8;
    color: rgba(255,255,255,0.9);
    font-style: italic;
    font-family: "Noto Serif SC", serif;
    max-width: 90%;
}
.ins-exit-btn {
    position: absolute;
    /* ğŸš¨ ç‰©ç†ä¸‹ç§»ï¼Œç¡®ä¿ä¸å’ŒçŠ¶æ€æ é‡å ï¼Œå»ºè®®è®¾ä¸º 70px */
    top: 70px !important; 
    right: 25px !important;
    
    /* ğŸš¨ å¢åŠ ç‚¹å‡»çƒ­åŒºï¼šç‰©ç†æ”¾å¤§æ„Ÿåº”èŒƒå›´ï¼Œå³ä¾¿ç‚¹åä¸€ç‚¹ä¹Ÿèƒ½è§¦å‘ */
    width: 60px !important;
    height: 60px !important;
    padding: 0 !important;
    
    /* ğŸš¨ å¼ºåŠ›ç½®é¡¶ */
    z-index: 1100000 !important; 
    
    /* ğŸš¨ å…è®¸ç©¿é€ï¼šç¡®ä¿å®ƒèƒ½æ¥æ”¶åˆ°ç‚¹å‡» */
    pointer-events: auto !important; 
    
    background: rgba(255, 255, 255, 0.1) !important; /* ä¸´æ—¶åŠ ä¸ªåº•è‰²ï¼Œæµ‹å‡†äº†å†åˆ  */
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* ğŸš¨ ç‰©ç†æ£€æŸ¥ï¼šç¡®ä¿å¤–å±‚å®¹å™¨æ²¡æœ‰æŠŠç‚¹å‡»äº‹ä»¶ç»™â€œåƒæ‰â€ */
.destiny-stage-ins {
    pointer-events: auto !important;
    z-index: 999999 !important;
}

/* è‰ºæœ¯äº¤å‰ç»†çº¿ */
.exit-cross-icon {
    width: 24px;
    height: 24px;
    position: relative;
    margin-bottom: 5px;
}

.exit-cross-icon::before, 
.exit-cross-icon::after {
    content: "";
    position: absolute;
    top: 50%; left: 0;
    width: 100%;
    height: 1px; /* æç»†çº¿ */
    background: #ffffff; /* çº¯ç™½çº¿ */
}

.exit-cross-icon::before { transform: rotate(45deg); }
.exit-cross-icon::after { transform: rotate(-45deg); }

/* æŒ‰é’®ä¸‹æ–¹çš„è£…é¥°æ–‡å­— */
.exit-label {
    font-family: 'Cormorant Garamond', serif; /* åŒæ­¥æ˜µç§°çš„é«˜çº§å­—ä½“ */
    font-size: 8px;
    font-weight: 300;
    color: rgba(255, 255, 255, 0.5); /* æ·¡æ·¡çš„åŠé€æ˜ç™½ */
    letter-spacing: 4px; /* æå®½é—´è· */
    text-transform: uppercase;
}

.ins-exit-btn:active {
    opacity: 0.4;
    transform: scale(0.9);
}
/* --- ğŸ•¹ï¸ å®¿å‘½åº•éƒ¨ï¼šå…ˆé”‹æç®€æ§åˆ¶å° --- */
.destiny-footer-console {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 30px 25px 50px 25px; /* ç•™å‡ºåº•éƒ¨å®‰å…¨åŒº */
    background: linear-gradient(to top, #000 80%, transparent 100%);
    display: flex;
    align-items: center;
    gap: 0; /* æŒ‰é’®ç‰©ç†ç›¸è¿ */
    z-index: 100;
}

/* æç®€è¾“å…¥æ¡†ï¼šå–æ¶ˆæ‰€æœ‰èƒŒæ™¯ï¼Œåªç•™åº•çº¿ */
.destiny-input-wrapper {
    flex: 1;
    position: relative;
    margin-right: 20px;
}

.destiny-main-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 0.5px solid rgba(255, 255, 255, 0.2); /* æç»†åº•çº¿ */
    padding: 12px 0;
    color: #fff;
    font-family: 'Cormorant Garamond', serif; /* åŒæ­¥é«˜çº§å­—ä½“ */
    font-size: 16px;
    letter-spacing: 1px;
    outline: none;
    transition: border-color 0.4s ease;
}

.destiny-main-input:focus {
    border-bottom-color: #fff; /* èšç„¦æ—¶åº•çº¿äº®èµ· */
}

.destiny-main-input::placeholder {
    color: rgba(255, 255, 255, 0.2);
    font-style: italic;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* --- ğŸ•¹ï¸ å®¿å‘½åº•éƒ¨ï¼šæ˜Ÿéœœæ‚¬æµ®æ§åˆ¶ä½“ (æœ€ç»ˆç‰ˆ) --- */

/* å®¹å™¨ï¼šå½»åº•å»çº¿åŒ–ï¼Œåªä¿ç•™ä½ç½®çº¦æŸ */
.destiny-control-group {
    display: flex;
    align-items: center;
    height: 44px;
    background: transparent;
    border: none;
    /* ğŸš¨ é‡ç‚¹ï¼šå’Œè¾“å…¥æ¡†æ‹‰å¼€è·ç¦»ï¼Œå¹¶è®©ä¸¤ä¸ªæŒ‰é’®ä¹‹é—´ä¹Ÿæœ‰å‘¼å¸æ„Ÿ */
    padding-left: 15px; 
    gap: 8px; 
    position: relative;
}

/* ğŸš¨ ç‰©ç†åˆ é™¤ï¼šå½»åº•åˆ æ‰ä¹‹å‰é‚£ä¸ªå‚ç›´åˆ†å‰²çº¿ */
/* .destiny-control-group::after { content: none; } */ 

/* æŒ‰é’®æœ¬ä½“ï¼šåœ†å½¢èƒ½é‡åœº */
.console-btn {
    width: 42px; /* ç¨å¾®ç¼©å°ä¸€ç‚¹ç‚¹ï¼Œæ›´ç²¾è‡´ */
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.02); /* æå¾®å¼±çš„åº•è‰²ï¼Œå¢åŠ å®ä½“æ„Ÿ */
    border: 0.5px solid rgba(255, 255, 255, 0.05); /* ä¼¼æœ‰ä¼¼æ— çš„æ™¶ä½“è¾¹ç¼˜ */
    color: rgba(255, 255, 255, 0.4); /* é»˜è®¤çŠ¶æ€å¾ˆæš—ï¼Œåƒç†„ç­çš„æ˜Ÿè¾° */
    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* ææ…¢é€Ÿå¥¢ååŠ¨æ•ˆ */
    border-radius: 50%;
    backdrop-filter: blur(2px); /* å¾®å¼±çš„ç£¨ç ‚ç»ç’ƒæ„Ÿ */
}

/* æ‚¬åœï¼šç‚¹äº®æ˜Ÿè¾° */
.console-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.15); /* æŸ”å’Œå…‰æ™•çˆ†å‘ */
    transform: translateY(-1px); /* è½»å¾®ä¸Šæµ® */
}

/* ç‚¹å‡»ï¼šèƒ½é‡åç¼© */
.console-btn:active {
    transform: scale(0.95) translateY(0);
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
}

/* ğŸš¨ æ ¸å¿ƒå›¾æ ‡æ ·å¼ï¼šæè‡´ç²¾ç»†çš„å‡ ä½•çº¿ç¨¿ */
.console-icon {
    width: 18px; /* å°ºå¯¸å…‹åˆ¶ï¼Œæ˜¾è´µ */
    height: 18px;
    stroke: currentColor;
    stroke-width: 0.8; /* ğŸš¨ æç»†ï¼åªæœ‰0.8pxï¼Œè¿™æ˜¯é«˜çº§æ„Ÿçš„å…³é”® */
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
}
/* --- âš™ï¸ å®¿å‘½é¡µé¢ï¼šé‡å­æ ¡å‡†å¼¹çª— (é«˜çº§ç‰ˆ) --- */
.destiny-settings-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(15px); /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
    z-index: 2000000; /* å¿…é¡»ç›–è¿‡æ‰€æœ‰å±‚çº§ */
    display: none;
    align-items: center;
    justify-content: center;
    animation: destinyFadeIn 0.4s ease;
}

.destiny-settings-card {
    width: 85%;
    max-width: 340px;
    background: rgba(15, 15, 15, 0.95);
    border: 0.5px solid rgba(255, 255, 255, 0.15); /* æç»†è¾¹æ¡† */
    padding: 30px 25px;
    position: relative;
    box-shadow: 0 40px 100px rgba(0,0,0,0.8);
}

.settings-title-serif {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 300;
    color: #fff;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 25px;
}

.settings-group {
    margin-bottom: 20px;
}

.settings-label {
    font-size: 10px;
    font-weight: 800;
    color: rgba(255, 255, 255, 0.3);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
    display: block;
}

/* æç®€è¾“å…¥ç»„ä»¶ */
.settings-input-alt {
    width: 100%;
    background: rgba(255, 255, 255, 0.03);
    border: 0.5px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 12px;
    font-size: 14px;
    outline: none;
    font-family: inherit;
    transition: all 0.3s;
}

.settings-input-alt:focus {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.4);
}

/* ç‰©ç†ä¿å­˜æŒ‰é’® */
.settings-sync-btn {
    width: 100%;
    padding: 15px;
    background: #fff;
    color: #000;
    border: none;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 3px;
    text-transform: uppercase;
    cursor: pointer;
    margin-top: 10px;
    transition: transform 0.2s;
}

.settings-sync-btn:active { transform: scale(0.97); }

@keyframes destinyFadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- ğŸ“ ç”¨æˆ·ä»‹å…¥ï¼šç¥è°•/è§‚æµ‹èŠ‚ç‚¹ --- */
.destiny-user-node {
    margin: 30px 0 15px 0;
    padding-left: 15px;
    border-left: 1px solid rgba(255,255,255,0.15);
    animation: nodeRise 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

.node-label {
    font-size: 9px;
    color: rgba(255,255,255,0.25);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 6px;
    font-weight: 800;
}

.node-content {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px;
    color: #fff;
    font-style: italic;
    line-height: 1.5;
}

/* 1. ç‰©ç†å›ºå®šï¼šç¡®ä¿å¤´éƒ¨ç»å¯¹ä¸åŠ¨ */
.destiny-stage-ins {
    position: fixed !important;
    inset: 0 !important;
    display: none;
    flex-direction: column !important;
    height: 100vh !important;
    overflow: hidden !important;
    background: #000 !important;
    z-index: 999999;
}
.destiny-stage-ins.active { display: flex !important; }

/* 2. æ ¸å¿ƒæ»šåŠ¨åŒºï¼šæ‚å¿—çº§å‘¼å¸æ„Ÿ */
#destiny-story-flow {
    flex: 1 !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    padding: 2vh 20px 200px 20px !important; /* ç‰©ç†é¿å¼€é¡¶éƒ¨ */
    display: block !important;
}

/* --- ğŸ“œ å®¿å‘½ï¼šæ— ç•Œé•¿å·æ’ç‰ˆ --- */
.story-fold-card {
    /* å½»åº•å–æ¶ˆé«˜åº¦é™åˆ¶ï¼Œç¡®ä¿æ–‡å­— 100% å®Œæ•´æ˜¾ç¤º */
    height: auto !important;
    max-height: none !important;
    overflow: visible !important;
    mask-image: none !important;
    -webkit-mask-image: none !important;
    
    background: rgba(255, 255, 255, 0.03) !important;
    border-left: 2px solid rgba(175, 82, 222, 0.5) !important; /* ç´«è‰²ä¾§è¾¹ä¸çº¿ */
    margin: 0 0 50px 0 !important;
    padding: 30px 25px !important;
    position: relative;
    transition: transform 0.3s ease;
}

/* æ®µè½å‘¼å¸æ„Ÿæ’ç‰ˆ */
.card-prose-body {
    font-family: "Noto Serif SC", "PingFang SC", serif;
    font-size: 17px;
    line-height: 2.2; /* æå®½è¡Œé«˜ï¼Œé˜…è¯»ä¸ç´¯ */
    color: rgba(255, 255, 255, 0.9);
    text-align: justify;
    margin-top: 20px;
}

.card-prose-body p {
    margin-bottom: 25px !important;
    display: block !important;
}

/* é‡ç‚¹æ ‡è®°ï¼šé»‘åº•ç™½å­— */
.memory-highlight {
    background: #ffffff !important;
    color: #000000 !important;
    padding: 1px 6px;
    margin: 0 4px;
    border-radius: 2px;
    font-weight: 800;
}

/* ç»†èŠ‚æ ‡è®°ï¼šç´«è‰²ä¸‹åˆ’çº¿ */
.memory-focus {
    border-bottom: 2px solid #AF52DE;
    font-weight: 800;
    padding-bottom: 2px;
}

/* é¡¶éƒ¨ä¿¡æ¯ç¾åŒ– */
.card-meta-top {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: rgba(255, 255, 255, 0.2);
    font-weight: 800;
    letter-spacing: 2px;
}

/* åº•éƒ¨æŒ‰é’®åŒºï¼šå®Œç¾èå…¥ */
.card-actions {
    margin-top: 35px;
    padding-top: 20px;
    border-top: 0.5px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* ç‹¬ç«‹åˆ é™¤æŒ‰é’®ï¼šé¿å¼€æ­£æ–‡ */
.card-manager-btn {
    position: absolute;
    top: 25px;
    right: 20px;
    width: 30px;
    height: 30px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #888;
    font-size: 20px;
    cursor: pointer;
}
/* --- ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šå¼ºåˆ¶åŠ è½½åŠ¨ç”»æ˜¾å½¢ --- */

/* ä¸»çº¿ç”ŸæˆåŠ¨ç”» */
.quantum-loading-bar {
    width: 100%; 
    height: 2px; /* ç¨å¾®åŠ ç²—ä¸€ç‚¹ */
    background: linear-gradient(90deg, transparent, #AF52DE, #fff, #AF52DE, transparent);
    background-size: 200% 100%;
    animation: lineScan 1.5s linear infinite !important;
    position: relative;
    z-index: 100;
}

@keyframes lineScan {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* å°å‰§åœºä¸“ç”¨ç»†çº¿åŠ¨ç”» */
.weave-line {
    height: 1.5px !important;
    background: linear-gradient(90deg, #AF52DE, #fff, #AF52DE) !important;
    background-size: 200% 100%;
    animation: lineScan 1.2s linear infinite !important;
    box-shadow: 0 0 8px rgba(175, 82, 222, 0.6);
}

/* æ–‡å­—å‘¼å¸æ„Ÿ */
[style*="WEAVING"], [style*="SIDE THREAD"] {
    animation: textPulse 1.5s ease-in-out infinite;
}

@keyframes textPulse {
    0%, 100% { opacity: 0.4; filter: blur(1px); }
    50% { opacity: 1; filter: blur(0px); }
}
/* --- ğŸšï¸ å®¿å‘½æ ¡å‡†ï¼šä¸“ç”¨æ»‘åŠ¨æ¡ç¾åŒ– --- */
#modal-destiny-settings .settings-group input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px; /* è½¨é“æç»†åŒ–ï¼Œæ˜¾å¾—æ›´é«˜çº§ */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    outline: none;
    margin: 20px 0;
    cursor: pointer;
    /* æ ¸å¿ƒï¼šé€šè¿‡å˜é‡æ§åˆ¶å·¦ä¾§å¡«è‰² */
    background-image: linear-gradient(#fff, #fff); /* æ”¹ä¸ºçº¯ç™½å¡«è‰²ï¼Œå‘¼åº”æŒ‰é’® */
    background-size: var(--percent, 0%) 100%;
    background-repeat: no-repeat;
}

/* è½¨é“åœ†å¤´ (iOSé£æ ¼) */
#modal-destiny-settings .settings-group input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background: #ffffff;
    /* å¢åŠ ä¸€ä¸ªå¤–å‘å…‰ï¼Œæ¨¡æ‹Ÿèƒ½é‡çƒæ„Ÿ */
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 2px 5px rgba(0,0,0,0.5);
    cursor: pointer;
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#modal-destiny-settings .settings-group input[type="range"]:active::-webkit-slider-thumb {
    transform: scale(1.2); /* æŒ‰ä½æ—¶è½»å¾®æ”¾å¤§ */
}

/* å…¼å®¹ Firefox */
#modal-destiny-settings .settings-group input[type="range"]::-moz-range-thumb {
    height: 24px; width: 24px; background: #fff; border: none; border-radius: 50%;
}
/* é’ˆå¯¹â€œSTORY THREAD INITIALIZEDâ€é‚£ä¸ªæç¤ºå®¹å™¨ */
#destiny-story-flow > div:first-child {
    /* æŠŠ 120px æˆ–è€…ä¹‹å‰çš„æ•°å€¼ï¼Œç»Ÿä¸€å¼ºåˆ¶æ”¹ä¸º 10px */
    padding: 10px 0 30px 0 !important; 
    /* é¡ºä¾¿æŠŠè¿™ä¸€è¡Œä¹Ÿç¼©çª„ä¸€ç‚¹ï¼Œè®©ç¬¬ä¸€æ¡å†…å®¹è·Ÿå¾—æ›´ç´§ */
    margin-top: 0 !important;
}

/* ç¡®ä¿æ»šåŠ¨å®¹å™¨æœ¬èº«é¡¶éƒ¨çš„é¢„ç•™ç©ºé—´ä¸è¦å¤ªå¤§ */
#destiny-story-flow {
    /* å°†é¡¶éƒ¨çš„ 2vh æ”¹ä¸º 0ï¼Œè®©å†…å®¹ç›´æ¥è´´ç€å¤´éƒ¨æ»¤é•œè¾¹ç¼˜å¼€å§‹ */
    padding-top: 0 !important; 
}
.card-manager-btn {
    position: absolute;
    /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå°† top ä»åŸæ¥çš„ 25px å¢åŠ åˆ° 40px */
    top: 40px !important; 
    right: 20px;
    
    /* å¢åŠ ä¸€å±‚èƒŒæ™¯ä¿æŠ¤ï¼Œé˜²æ­¢ç”±äºå¡ç‰‡èƒŒæ™¯å¤ªæ‚çœ‹ä¸æ¸…æŒ‰é’® */
    background: rgba(0, 0, 0, 0.3) !important;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20; /* ç¡®ä¿å®ƒåœ¨æ–‡å­—å±‚ä¹‹ä¸Šï¼Œæ–¹ä¾¿ç‚¹å‡» */
}
/* --- ğŸ–¤ æè‡´é»‘ç™½ï¼šNoir Voyage æ ·å¼ --- */

/* è¡¨å•å®¹å™¨ */
.noir-form-container {
    border: 1.5px solid #000;
    background: #FFF;
}

.noir-input-group {
    padding: 20px;
    border-bottom: 1px solid #EEE;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.noir-input-group label {
    font-size: 9px;
    font-weight: 900;
    letter-spacing: 2px;
    color: #AAA;
}

.noir-input-group input, .noir-input-group select {
    border: none;
    outline: none;
    font-size: 18px;
    font-family: serif;
    font-weight: 600;
    color: #000;
    background: transparent;
}

/* é»‘è‰²å®å¿ƒæŒ‰é’® */
.noir-btn-main {
    margin-top: 40px;
    width: 100%;
    background: #000;
    color: #FFF;
    border: none;
    padding: 20px;
    font-size: 12px;
    font-weight: 800;
    letter-spacing: 4px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
}

.noir-btn-main:active {
    background: #444;
    transform: translateY(2px);
}

/* --- ğŸŸï¸ å¥¢å Noirï¼šå·¥ä¸šå®‰å…¨ç‰ˆæœºç¥¨ --- */
.boarding-pass {
    background: #fff !important;
    /* æç»†çš„åŒçº¿è¾¹æ¡†ï¼Œå¤å…¸ä¸”é«˜çº§ */
    border: 3px double #000 !important; 
    padding: 0 !important;
    margin: 30px 0 !important;
    /* ç‰©ç†æ‹‰é•¿ï¼Œä¿æŒä¿®é•¿æ¯”ä¾‹ */
    min-height: 560px !important;
    display: flex;
    flex-direction: column;
    box-shadow: 0 30px 70px rgba(0,0,0,0.08) !important;
    position: relative;
}

/* é¡¶éƒ¨å“ç‰Œæ  */
.pass-header {
    background: #000;
    color: #fff;
    padding: 16px 35px;
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    letter-spacing: 3px;
    font-weight: 800;
    text-transform: uppercase;
}

/* ä¸»ä½“åŒºåŸŸ */
.pass-body {
    padding: 50px 40px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* --- ğŸŸï¸ æè‡´ Noirï¼šèˆªçº¿æ’ç‰ˆå¾®è°ƒ --- */

.flight-route {
    display: flex;
    justify-content: space-between; /* ğŸš¨ ç¡®ä¿ä¸¤ç«¯å¯¹é½ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
    border-bottom: 1.5px solid #000;
    padding: 20px 0 40px 0 !important; /* å¢åŠ åº•éƒ¨é—´è· */
    margin-bottom: 40px;
    position: relative; /* ä¸ºé£æœºå›¾æ ‡ç»å¯¹å®šä½åšå‡†å¤‡ */
}

/* æœºåœºç¼©å†™ï¼šç¼©å°å¹¶æ¨å‘æœ€è¾¹ç¼˜ */
.city-code {
    font-size: 42px !important; /* ğŸš¨ ç¼©å°å­—å·ï¼Œä»72pxé™åˆ°42px */
    font-weight: 900;
    letter-spacing: -1px;
    line-height: 1;
    color: #000;
    /* å¢åŠ ä¸€ä¸ªå›ºå®šçš„å®½åº¦ï¼Œç¡®ä¿å®ƒä»¬èƒ½é¡¶åˆ°æœ€è¾¹ä¸Š */
    min-width: 100px;
}

/* åŸå¸‚åç§°ï¼šç¨å¾®æ”¾å¤§ï¼Œå¢åŠ å­˜åœ¨æ„Ÿ */
.city-name {
    font-family: serif;
    font-style: italic;
    font-size: 18px !important; /* ğŸš¨ è°ƒå¤§å­—å· */
    font-weight: 700;
    margin-top: 8px;
    color: #000;
    letter-spacing: 1px;
}

/* é£æœºå›¾æ ‡ï¼šå®Œç¾å±…ä¸­ä¸”ç²¾è‡´ */
.flight-icon-center {
    position: absolute;
    left: 50%;
    top: 40%; /* å‘ä¸Šå¾®è°ƒï¼Œå¯¹é½å¤§å­—ä¸­å¿ƒçº¿ */
    transform: translate(-50%, -50%) rotate(90deg); /* ğŸš¨ ç‰©ç†å±…ä¸­å¹¶æ—‹è½¬ */
    font-size: 22px;
    color: #000;
    opacity: 0.15; /* ä¿æŒè‹¥éšè‹¥ç°çš„é«˜çº§æ„Ÿ */
}

/* è¯¦ç»†ä¿¡æ¯ç½‘æ ¼ */
.info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px 0;
    margin-top: 45px;
}

.info-item { display: flex; flex-direction: column; }
.info-label { font-size: 9px; color: #999; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
.info-value { font-size: 17px; font-weight: 900; letter-spacing: -0.3px; }

/* ğŸš¨ åº•éƒ¨é‡æ„ï¼šå·¥ä¸šå®‰å…¨éªŒè¯åŒº ğŸš¨ */
.pass-footer {
    /* æç»†çš„è™šçº¿åˆ†å‰² */
    border-top: 1px dashed rgba(0,0,0,0.4);
    padding: 35px 40px;
    background: #fff;
    position: relative;
    display: flex;
    flex-direction: column; /* æ”¹ä¸ºçºµå‘å¸ƒå±€ */
    gap: 25px;
}

/* ä¹˜å®¢ä¿¡æ¯ç®€æ´åŒ– */
.passenger-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}
.passenger-name {
    font-size: 20px;
    font-weight: 900;
    letter-spacing: -0.5px;
    border-bottom: 2px solid #000;
}

/* å·¥ä¸šæ¡å½¢ç å®¹å™¨ */
.security-zone {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* æ ¸å¿ƒï¼šé«˜å¯†åº¦å·¥ä¸š SVG æ¡å½¢ç  */
/* ä½¿ç”¨ SVG data URI ç”Ÿæˆé”åˆ©çš„çŸ¢é‡æ¡ç ï¼Œä¸å†æ˜¯æ¨¡ç³Šçš„ CSS æ¸å˜ */
.industrial-barcode {
    width: 100%;
    height: 55px; /* å¢åŠ é«˜åº¦ï¼Œæ›´æœ‰æ°”åŠ¿ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='50' viewBox='0 0 400 50' preserveAspectRatio='none'%3E%3Cg fill='%23000'%3E%3Crect x='0' width='2' height='50'/%3E%3Crect x='4' width='1' height='50'/%3E%3Crect x='6' width='3' height='50'/%3E%3Crect x='12' width='1' height='50'/%3E%3Crect x='14' width='2' height='50'/%3E%3Crect x='18' width='4' height='50'/%3E%3Crect x='24' width='1' height='50'/%3E%3Crect x='26' width='2' height='50'/%3E%3Crect x='30' width='1' height='50'/%3E%3Crect x='32' width='3' height='50'/%3E%3Crect x='38' width='2' height='50'/%3E%3Crect x='42' width='1' height='50'/%3E%3Crect x='44' width='4' height='50'/%3E%3Crect x='50' width='1' height='50'/%3E%3Crect x='52' width='2' height='50'/%3E%3Crect x='56' width='1' height='50'/%3E%3Crect x='58' width='3' height='50'/%3E%3Crect x='64' width='1' height='50'/%3E%3Crect x='66' width='2' height='50'/%3E%3Crect x='70' width='3' height='50'/%3E%3Crect x='76' width='1' height='50'/%3E%3Crect x='78' width='2' height='50'/%3E%3Crect x='82' width='1' height='50'/%3E%3Crect x='84' width='3' height='50'/%3E%3Crect x='90' width='2' height='50'/%3E%3Crect x='94' width='1' height='50'/%3E%3Crect x='96' width='4' height='50'/%3E%3Crect x='102' width='1' height='50'/%3E%3Crect x='104' width='2' height='50'/%3E%3Crect x='108' width='1' height='50'/%3E%3Crect x='110' width='3' height='50'/%3E%3Crect x='116' width='1' height='50'/%3E%3Crect x='118' width='2' height='50'/%3E%3Crect x='122' width='4' height='50'/%3E%3Crect x='128' width='1' height='50'/%3E%3Crect x='130' width='2' height='50'/%3E%3Crect x='134' width='1' height='50'/%3E%3Crect x='136' width='3' height='50'/%3E%3Crect x='142' width='2' height='50'/%3E%3Crect x='146' width='1' height='50'/%3E%3Crect x='148' width='4' height='50'/%3E%3Crect x='154' width='1' height='50'/%3E%3Crect x='156' width='2' height='50'/%3E%3Crect x='160' width='1' height='50'/%3E%3Crect x='162' width='3' height='50'/%3E%3Crect x='168' width='1' height='50'/%3E%3Crect x='170' width='2' height='50'/%3E%3Crect x='174' width='3' height='50'/%3E%3Crect x='180' width='1' height='50'/%3E%3Crect x='182' width='2' height='50'/%3E%3Crect x='186' width='1' height='50'/%3E%3Crect x='188' width='3' height='50'/%3E%3Crect x='194' width='2' height='50'/%3E%3Crect x='198' width='1' height='50'/%3E%3Crect x='200' width='4' height='50'/%3E%3Crect x='206' width='1' height='50'/%3E%3Crect x='208' width='2' height='50'/%3E%3Crect x='212' width='1' height='50'/%3E%3Crect x='214' width='3' height='50'/%3E%3Crect x='220' width='1' height='50'/%3E%3Crect x='222' width='2' height='50'/%3E%3Crect x='226' width='4' height='50'/%3E%3Crect x='232' width='1' height='50'/%3E%3Crect x='234' width='2' height='50'/%3E%3Crect x='238' width='1' height='50'/%3E%3Crect x='240' width='3' height='50'/%3E%3Crect x='246' width='2' height='50'/%3E%3Crect x='250' width='1' height='50'/%3E%3Crect x='252' width='4' height='50'/%3E%3Crect x='258' width='1' height='50'/%3E%3Crect x='260' width='2' height='50'/%3E%3Crect x='264' width='1' height='50'/%3E%3Crect x='266' width='3' height='50'/%3E%3Crect x='272' width='1' height='50'/%3E%3Crect x='274' width='2' height='50'/%3E%3Crect x='278' width='3' height='50'/%3E%3Crect x='284' width='1' height='50'/%3E%3Crect x='286' width='2' height='50'/%3E%3Crect x='290' width='1' height='50'/%3E%3Crect x='292' width='3' height='50'/%3E%3Crect x='298' width='2' height='50'/%3E%3Crect x='302' width='1' height='50'/%3E%3Crect x='304' width='4' height='50'/%3E%3Crect x='310' width='1' height='50'/%3E%3Crect x='312' width='2' height='50'/%3E%3Crect x='316' width='1' height='50'/%3E%3Crect x='318' width='3' height='50'/%3E%3Crect x='324' width='1' height='50'/%3E%3Crect x='326' width='2' height='50'/%3E%3Crect x='330' width='4' height='50'/%3E%3Crect x='336' width='1' height='50'/%3E%3Crect x='338' width='2' height='50'/%3E%3Crect x='342' width='1' height='50'/%3E%3Crect x='344' width='3' height='50'/%3E%3Crect x='350' width='2' height='50'/%3E%3Crect x='354' width='1' height='50'/%3E%3Crect x='356' width='4' height='50'/%3E%3Crect x='362' width='1' height='50'/%3E%3Crect x='364' width='2' height='50'/%3E%3Crect x='368' width='1' height='50'/%3E%3Crect x='370' width='3' height='50'/%3E%3Crect x='376' width='1' height='50'/%3E%3Crect x='378' width='2' height='50'/%3E%3Crect x='382' width='3' height='50'/%3E%3Crect x='388' width='1' height='50'/%3E%3Crect x='390' width='2' height='50'/%3E%3Crect x='394' width='1' height='50'/%3E%3Crect x='396' width='3' height='50'/%3E%3C/g%3E%3C/svg%3E");
    background-repeat: repeat-x;
}

/* æ¡ç ä¸‹æ–¹çš„æŠ€æœ¯å‚æ•° */
.barcode-data {
    font-family: 'Courier New', monospace; /* å¼ºåˆ¶ç­‰å®½å­—ä½“ */
    font-size: 10px;
    letter-spacing: 1px;
    color: #000;
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    opacity: 0.8;
}

/* æ’•è£‚å£ */
.pass-notch {
    position: absolute;
    width: 16px; height: 16px;
    background: #F5F5F7;
    border: 1px solid rgba(0,0,0,0.4);
    border-radius: 50%;
    top: -9px;
}
.notch-left { left: -9px; }
.notch-right { right: -9px; }

/* åœ°å›¾è¿çº¿ (æç»†é»‘çº¿) */
.travel-line {
    stroke: #000 !important;
    stroke-width: 0.8;
    stroke-dasharray: 4,4;
}
/* --- ğŸ›ï¸ å¥¢å Noirï¼šæ—¥é—´ç‰ˆé‡å¡‘ --- */

/* 1. å…¨å±€èƒŒæ™¯ä¸å­—ä½“åŠ å›º */
#subpage-travel-journal {
    background: #FFFFFF !important; /* çº¯å‡€ç™½ */
    font-family: 'Montserrat', 'PingFang SC', sans-serif;
}

/* 2. èˆªçº¿ç­–åˆ’åŒºï¼šå»é‡ã€å»æ¡†ã€ç•™ç™½ */
#travel-planner {
    padding: 80px 40px !important;
}

.hero-label {
    font-size: 10px;
    letter-spacing: 6px;
    color: #000;
    opacity: 0.3;
    font-weight: 900;
    margin-bottom: 12px;
}

#travel-planner h1 {
    font-family: serif; /* ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦è¡¬çº¿ä½“å¢åŠ å¤å…¸æ„Ÿ */
    font-style: italic;
    font-size: 38px;
    letter-spacing: -1px;
    margin-bottom: 60px;
}

/* è¾“å…¥æ¡†ç»„ï¼šæç»†ä¸‹åˆ’çº¿é£æ ¼ï¼Œä¸å†ç”¨ç™½ç›’å­ */
.ios-list-group.theme-light {
    background: transparent !important;
    box-shadow: none !important;
    border-radius: 0 !important;
}

.ios-list-item.theme-light {
    border-bottom: 1px solid #000 !important; /* åªæœ‰åº•éƒ¨ä¸€æ¡é»‘çº¿ */
    padding: 25px 0 !important;
    background: transparent !important;
    display: flex;
    justify-content: space-between;
}

.item-label {
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
}

.ios-input-clean.theme-light {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}

/* 3. æ ¸å¿ƒæŒ‰é’®ï¼šçª„é•¿ã€å…¨é»‘ã€æç®€ */
.btn-awaken-core.theme-light-btn {
    background: #000 !important;
    color: #FFF !important;
    border-radius: 0 !important; /* æ–¹å½¢æ›´ç¡¬æ ¸ */
    height: 60px;
    font-size: 12px;
    letter-spacing: 5px;
    text-transform: uppercase;
    margin-top: 80px !important;
    box-shadow: none !important;
}

/* 4. æœºç¥¨é‡å¡‘ï¼šç»†é•¿ã€ä»ªå¼æ„Ÿã€æ— å¤šä½™é˜´å½± */
.boarding-pass {
    background: #fff !important;
    border: 1px solid #000 !important;
    min-height: 580px !important; /* ç‰©ç†æ‹‰é•¿ */
    box-shadow: 0 40px 100px rgba(0,0,0,0.05) !important; /* æè½»çš„æŠ•å½± */
    padding: 0 !important;
    margin: 20px 0 !important;
}
/* --- ğŸ—ºï¸ æè‡´ Noirï¼šå…¨æ™¯åœ°ç†æ‰«æå›¾ --- */

/* --- ğŸ—ºï¸ ç»ˆæç‰©ç†è¡¥ä¸ï¼šåœ°å›¾å®¹å™¨é”å®š --- */
#travel-map-box {
    width: 100% !important;
    height: 520px !important;
    position: relative;
    margin-top: 35px;
    background: #0a0a0a !important; /* é”å®šæ·±è‰²åº• */
    border: 1.5px solid #222 !important;
    border-radius: 4px;
    overflow: hidden;
}

/* ğŸš¨ æ ¸å¿ƒï¼šç‰©ç†ç½®é¡¶ï¼Œç¡®ä¿èˆªçº¿åœ¨åœ°å›¾æ‰€æœ‰å›¾å±‚ä¹‹ä¸Š ğŸš¨ */
.leaflet-pane { 
    z-index: 1 !important; 
}

/* --- ğŸ—ºï¸ ç‰©ç†è¡¥ä¸ï¼šäº¤äº’ç©¿é€å±‚çº§ --- */

#travel-svg-map {
    position: absolute !important;
    top: 0; left: 0;
    /* ğŸš¨ å…³é”®ï¼šå¼ºåˆ¶é“ºæ»¡ï¼Œä¸”ç¦æ­¢è¢«ä»»ä½• overflow è£åˆ‡ */
    width: 100% !important;
    height: 100% !important;
    z-index: 1000 !important;
    pointer-events: none !important;
    overflow: visible !important; /* å…è®¸å‘å…‰æ»¤é•œæº¢å‡ºè¾¹æ¡† */
}

#travel-dots-layer {
    pointer-events: none !important; /* ğŸš¨ å±‚æœ¬èº«ä¸æ¥æ”¶ç‚¹å‡» */
}

.travel-dot {
    position: absolute;
    width: 8px; height: 8px;
    background: #fff;
    border-radius: 50%;
    /* ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šå°†åœ†å¿ƒå¯¹å‡†è®¡ç®—å‡ºçš„åæ ‡ç‚¹ */
    transform: translate(-50%, -50%); 
    z-index: 500;
    box-shadow: 0 0 10px #fff;
    cursor: pointer;
    pointer-events: auto !important;
}

/* ä¿®æ­£èˆªçº¿é¢œè‰²ï¼šç™½è‰²å‘å…‰åœ¨é»‘åº•ä¸Šæ‰é«˜çº§ */
.travel-line {
    stroke: #ffffff !important;
    stroke-width: 2;
    fill: none !important;
    stroke-linecap: round;
    stroke-linejoin: round; /* ğŸš¨ æ‹è§’å¹³æ»‘ï¼Œé˜²æ­¢ç”±äºç¼©æ”¾å¯¼è‡´çš„å°–åˆº */
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
    /* è¿™é‡Œåƒä¸‡ä¸è¦å†™ transition: allï¼Œå¦åˆ™ç¼©æ”¾ä¼šå˜æ…¢ */
}

/* ä¿®æ­£ Leaflet å®¹å™¨çš„æƒé‡ */
.leaflet-container {
    width: 100% !important;
    height: 100% !important;
    z-index: 1 !important;
}
/* --- ğŸ“¡ Noir æˆ˜æœ¯åŠ è½½åŠ¨ç”» --- */

/* 1. æŒ‰é’®åŠ è½½çŠ¶æ€ï¼šé»‘æ´å¸ç§¯æ•ˆæœ */
.btn-loading {
    pointer-events: none;
    background: #1a1a1a !important;
    color: rgba(255,255,255,0.3) !important;
    position: relative;
    overflow: hidden;
}

.btn-loading::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: btnScan 1.5s infinite;
}

@keyframes btnScan {
    from { left: -100%; }
    to { left: 100%; }
}

/* 2. åœ°å›¾è§£ç é®ç½©å±‚ */
#map-loader-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #0a0a0a;
    z-index: 100;
    display: none; /* é»˜è®¤éšè— */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Courier New', monospace;
}

/* æ‰«æçº¿åŠ¨ç”» */
.radar-sweep {
    width: 100%; height: 2px;
    background: rgba(255,255,255,0.2);
    box-shadow: 0 0 15px #fff;
    position: absolute;
    top: 0;
    animation: sweep 2s infinite linear;
}

@keyframes sweep {
    0% { top: 0; opacity: 0; }
    50% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

.loading-text {
    color: #fff;
    font-size: 10px;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-top: 20px;
    animation: blink 0.8s infinite;
}

@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
.map-stability-notice {
    position: absolute;
    bottom: 20px; /* è·ç¦»åº•éƒ¨ 20px */
    left: 50%;
    transform: translateX(-50%); /* ç‰©ç†æ°´å¹³å±…ä¸­ */
    
    background: rgba(0, 0, 0, 0.7); /* æ·±è‰²åŠé€æ˜ */
    backdrop-filter: blur(10px); /* ç‰©ç†ç£¨ç ‚æ„Ÿ */
    -webkit-backdrop-filter: blur(10px);
    
    color: rgba(255, 255, 255, 0.6); /* æ·¡æ·¡çš„ç™½å­— */
    font-size: 10px;
    font-weight: 700;
    padding: 8px 18px;
    border-radius: 20px;
    letter-spacing: 1.5px;
    white-space: nowrap; /* å¼ºè¡Œä¸æ¢è¡Œ */
    
    /* ğŸš¨ æ ¸å¿ƒï¼šå¿…é¡»æ¯”åœ°å›¾å›¾å±‚é«˜ï¼Œä½†æ¯”ç«™ç‚¹ç‚¹ä½ä½ */
    z-index: 500; 
    border: 0.5px solid rgba(255, 255, 255, 0.15);
    pointer-events: none; /* é¼ æ ‡å¯ä»¥ç©¿é€å®ƒå»æ‹–åœ°å›¾ï¼Œä¸äº§ç”Ÿäº¤äº’å¹²æ‰° */
}
/* --- ğŸŸï¸ Noir ç‰©ç†å°ç« åè®® --- */
.pass-stamp {
    position: absolute;
    top: 50%;
    left: 65%; /* ç‰©ç†åç§»ï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
    width: 140px;
    height: 140px;
    border: 4px solid #8B0000; /* æ·±çº¢è‰²å¢¨è¿¹ */
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #8B0000;
    font-family: 'Montserrat', sans-serif;
    text-transform: uppercase;
    opacity: 0; /* åˆå§‹ä¸å¯è§ */
    z-index: 100;
    pointer-events: none;
    user-select: none;
    /* ğŸš¨ æ ¸å¿ƒï¼šæ¨¡æ‹Ÿå¢¨æ°´ä¸å‡åŒ€çš„æ»¤é•œ */
    filter: url(#ink-noise) contrast(1.2) rotate(-15deg);
}

.pass-stamp strong {
    font-size: 24px;
    font-weight: 900;
    letter-spacing: 2px;
    line-height: 1;
}

.pass-stamp span {
    font-size: 10px;
    font-weight: 700;
    margin-top: 5px;
    border-top: 1px solid #8B0000;
    padding-top: 2px;
}

/* ğŸš¨ ç‰©ç†æ’å‡»åŠ¨ç”» ğŸš¨ */
@keyframes stamp-slam {
    0% {
        opacity: 0;
        transform: scale(3) rotate(-45deg); /* ä»é«˜å¤„è½ä¸‹ */
    }
    80% {
        opacity: 1;
        transform: scale(0.9) rotate(-12deg); /* æ’å‡»ç¬é—´åå¼¹ */
    }
    100% {
        opacity: 0.85; /* æ¨¡æ‹Ÿå¢¨è¿¹æ¸—å…¥çº¸å¼ çš„åŠé€æ˜æ„Ÿ */
        transform: scale(1) rotate(-15deg); /* æœ€ç»ˆåœå®š */
    }
}

.stamp-active {
    animation: stamp-slam 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
/* --- ğŸ›ï¸ ç‰©ç†çº§é‡å¡‘ï¼šé‡‘åº“å­˜æ ¹é«˜çº§ç‰ˆ --- */
.travel-stub-card {
    background: #ffffff;
    margin-bottom: 24px;
    border: 1px solid #1d1d1f;
    border-radius: 2px; /* è¶‹è¿‘ç›´è§’ï¼Œæ›´æœ‰ç¥¨æ®æ„Ÿ */
    position: relative;
    display: flex;
    height: 140px; /* å›ºå®šé«˜åº¦ï¼Œä¿æŒæ’ç‰ˆç¨³å®š */
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
}

.travel-stub-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

/* å·¦ä¾§ï¼šé»‘è‰²å·¥ä¸šä¿¡æ¯åŒº */
.stub-left {
    width: 35px;
    background: #1d1d1f;
    color: rgba(255,255,255,0.4);
    writing-mode: vertical-lr;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: 800;
    letter-spacing: 2px;
    border-right: 1px dashed rgba(255,255,255,0.2);
}

/* å³ä¾§ï¼šä¸»ä½“è®¾è®¡ */
.stub-main {
    flex: 1;
    padding: 15px;
    display: flex;
    flex-direction: column;
    position: relative;
    background-image: 
        radial-gradient(#eee 1px, transparent 1px);
    background-size: 15px 15px; /* ææ·¡çš„ç‚¹é˜µæ°´å°åº•çº¹ */
}

/* èˆªçº¿å¤§å­—ï¼šä½¿ç”¨è¡¬çº¿ä½“ä¸éè¡¬çº¿ä½“ç¢°æ’ */
.stub-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.stub-codes {
    font-size: 24px;
    font-weight: 900;
    letter-spacing: -1px;
    color: #1d1d1f;
}

.stub-qr {
    width: 45px;
    height: 45px;
    border: 1px solid #1d1d1f;
    padding: 2px; /* æ¨¡æ‹Ÿé˜²ä¼ªäºŒç»´ç  */
}

.stub-cities {
    font-family: serif;
    font-style: italic;
    font-size: 14px;
    color: #555;
    margin-top: -5px;
}

/* åº•éƒ¨æ•°æ®ç½‘æ ¼ */
.stub-footer {
    margin-top: auto;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    border-top: 0.5px solid #eee;
    padding-top: 10px;
}

.f-item { display: flex; flex-direction: column; }
.f-label { font-size: 7px; color: #aaa; font-weight: 800; text-transform: uppercase; }
.f-val { font-size: 11px; font-weight: 700; color: #1d1d1f; }

/* ğŸš¨ ç‰©ç†æ’•è£‚çº¿æ•ˆæœ ğŸš¨ */
.stub-tear {
    position: absolute;
    right: 70px; top: -10px; bottom: -10px;
    width: 1px;
    border-left: 1px dashed #ddd;
}
/* --- ğŸ§­ æ‚¬æµ®èƒ¶å›Šå¯¼èˆªæ  --- */
.voyage-nav-wrapper {
    position: absolute;
    bottom: 35px;
    left: 0; width: 100%;
    display: flex; justify-content: center;
    z-index: 5000;
    pointer-events: none;
}

.voyage-capsule-nav {
    pointer-events: auto;
    display: flex;
    background: rgba(0, 0, 0, 0.88); /* æè‡´Noiré»‘ */
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    padding: 6px;
    border-radius: 40px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    border: 0.5px solid rgba(255,255,255,0.15);
}

.v-nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 22px;
    border-radius: 30px;
    color: rgba(255,255,255,0.4);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
}

.v-nav-item span {
    font-size: 10px; font-weight: 800; letter-spacing: 2px;
}

/* æ¿€æ´»æ€ï¼šç™½åº•é»‘å­—ï¼Œåè‰²ç¾å­¦ */
.v-nav-item.active {
    background: #FFFFFF;
    color: #000000;
    box-shadow: 0 4px 15px rgba(255,255,255,0.2);
}

/* é¢æ¿å¸ƒå±€é€»è¾‘ */
.voyage-panel {
    display: none;
    width: 100%; height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}
.voyage-panel.active { display: block; animation: panelSlideUp 0.4s ease forwards; }

@keyframes panelSlideUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ä¹‹å‰ç¼ºå¤±çš„ä¿å­˜æŒ‰é’®æ ·å¼ */
.btn-save-voyage {
    margin-top: 30px; width: 100%;
    border: 1.5px solid #000; background: transparent;
    color: #000; padding: 16px;
    font-size: 11px; font-weight: 900; letter-spacing: 4px;
    cursor: pointer; transition: all 0.3s;
    text-transform: uppercase;
}
.btn-save-voyage:active { background: #000; color: #fff; }
/* --- ğŸŸï¸ äº¤äº’å¼æ’•ç¥¨æ ¹ç‰©ç†å¼•æ“ (å·¦ä¾§å‰¥ç¦»ç‰ˆ) --- */

/* å®Œæ•´ç¥¨æ ¹å®¹å™¨ - ä¿æŒä¸å˜ */
.interactive-ticket {
    display: flex;
    width: 340px; height: 150px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.5s ease;
    filter: drop-shadow(0 15px 30px rgba(0,0,0,0.5));
    cursor: pointer;
}
.interactive-ticket:hover { transform: rotateX(5deg) translateY(-5px); }

/* å·¦ä¾§ï¼šé»‘è‰²å›ºå®šå­˜æ ¹ - å®ƒæ˜¯è¦è¢«æ’•æ‰çš„éƒ¨åˆ† */
.ticket-stub-part {
    width: 90px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹ç‚¹ï¼Œæ’•èµ·æ¥æ›´æœ‰åˆ†é‡ */
    background: #1a1a1a; color: #555;
    display: flex; flex-direction: column; justify-content: space-between;
    padding: 20px 10px;
    border-radius: 4px 0 0 4px;
    position: relative; z-index: 2;
    /* æ’•è£‚çº¿åœ¨å³è¾¹ï¼Œæ­£å¥½ */
    border-right: 2px dashed rgba(255,255,255,0.15);
    transform-origin: right center; /* ğŸš¨ æ ¸å¿ƒï¼šæ—‹è½¬è½´å¿ƒè®¾ç½®åœ¨æ’•è£‚å¤„ */
    box-shadow: inset -5px 0 15px rgba(0,0,0,0.5);
}

/* å³ä¾§ï¼šç™½è‰²ä¸»ä½“ - å®ƒæ˜¯è¦ç•™ä¸‹çš„éƒ¨åˆ† */
.ticket-main-part {
    flex: 1;
    background: #e0e0e0; color: #1d1d1f;
    padding: 20px 25px;
    border-radius: 0 4px 4px 0;
    position: relative;
    z-index: 1;
    background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 12px 12px;
    box-shadow: inset 5px 0 10px rgba(0,0,0,0.05); /* å¢åŠ ä¸€ç‚¹ç«‹ä½“æ„Ÿ */
}

/* ğŸš¨ è§¦å‘çŠ¶æ€ï¼šæ ¸å¿ƒé€»è¾‘äº’æ¢ ğŸš¨ */

/* 1. é»‘è‰²å­˜æ ¹ï¼šæ‰§è¡Œæ’•è£‚é£å‡ºåŠ¨ç”» */
.interactive-ticket.is-torn .ticket-stub-part {
    animation: tearOffLeft 1.1s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
    pointer-events: none;
}

/* 2. ç™½è‰²ä¸»ä½“ï¼šæ‰§è¡Œåä½œç”¨åŠ›å¼¹åŠ¨ */
.interactive-ticket.is-torn .ticket-main-part {
    animation: mainRecoil 0.8s ease-out forwards;
}

/* ğŸš¨ å…¨æ–°ç‰©ç†åŠ¨ç”»å…³é”®å¸§ ğŸš¨ */

/* å‘å·¦æ’•è£‚é£å‡º */
@keyframes tearOffLeft {
    0% { transform: rotateY(0); opacity: 1; }
    30% { transform: rotateY(10deg) skewY(-3deg) translateX(5px); } /* å‘å³åå‘è“„åŠ› */
    100% { 
        /* å‘å·¦åæ–¹å¤§å¹…åº¦æ—‹è½¬å¹¶é£å‡ºå±å¹• */
        transform: rotateY(-90deg) translateX(-200px) rotateZ(-20deg) scale(0.8); 
        opacity: 0; 
    }
}

/* ä¸»ä½“å—åŠ›åå¼¹ (å‘å³å¼¹ä¸€ä¸‹) */
@keyframes mainRecoil {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(5px) rotate(1deg); } /* å—åˆ°å‘å·¦æ’•è£‚åŠ›çš„åä½œç”¨ï¼Œå‘å³å¼¹ */
}

/* (ç¥¨é¢å†…éƒ¨å…ƒç´ çš„æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ç”¨æ”¹) */
.tm-code { font-size: 28px; font-weight: 900; letter-spacing: -1px; line-height: 1; }
.tm-city { font-size: 13px; font-weight: 600; color: #666; font-family: serif; font-style: italic; margin-top: 5px; }
.tm-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px;}
.tm-label { font-size: 7px; font-weight: 900; color: #999; text-transform: uppercase; letter-spacing: 1px; }
.tm-val { font-size: 12px; font-weight: 800; color: #000; margin-top: 3px; }
.tm-seal {
    position: absolute; right: 20px; bottom: 20px;
    width: 60px; height: 60px;
    border: 3px solid #8B0000; border-radius: 50%; color: #8B0000;
    font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center;
    transform: rotate(-25deg); opacity: 0; /* åˆå§‹éšè—ï¼Œç­‰æ’•å¼€åå†æ˜¾ç¤ºæˆ–è€…ä¿æŒéšè— */
    filter: url(#ink-noise);
}
/* --- ğŸ—ºï¸ ä»ªå¼å…å…‰ç‚¹å‘¼å¸æ•ˆ --- */
.reveal-dot-glow {
    filter: drop-shadow(0 0 5px #fff);
    cursor: pointer !important;
    outline: none;
}

/* ç¡®ä¿å¼¹çª—åœ¨é»‘è‰²ä»ªå¼å…ä¸Šé¢ */
#modal-travel-log {
    background: rgba(0, 0, 0, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    z-index: 40000 !important;
}
/* --- ğŸ›ï¸ æ„Ÿå®˜éšç¬”ï¼šé«˜çº§æ»‘åŠ¨æ’ç‰ˆ --- */

.aesthetic-card {
    width: 85%;
    max-height: 75vh; /* ç¨å¾®è°ƒé«˜ä¸€ç‚¹ï¼Œè§†é‡æ›´å¼€é˜” */
    background: #FFFFFF;
    border-radius: 30px;
    padding: 30px;
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ— */
    box-shadow: 0 30px 60px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.05);
}

.log-fixed-header {
    flex-shrink: 0; /* ç¦æ­¢å¤´éƒ¨å‹ç¼© */
    margin-bottom: 20px;
}

/* ğŸš¨ æ ¸å¿ƒï¼šæ»‘åŠ¨åŒºåŸŸé€»è¾‘ ğŸš¨ */
.log-scroll-area {
    flex-grow: 1; /* è‡ªåŠ¨æ’‘å¼€å‰©ä½™ç©ºé—´ */
    overflow-y: auto; /* å¼€å¯ç‰©ç†æ»šåŠ¨ */
    padding-right: 10px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºéš™ */
    
    /* é¡ºæ»‘æ»šåŠ¨ï¼šiOS æƒ¯æ€§æ”¯æŒ */
    -webkit-overflow-scrolling: touch; 
}

/* ğŸš¨ æç®€æ»šåŠ¨æ¡é«˜å®šæ ·å¼ ğŸš¨ */
.log-scroll-area::-webkit-scrollbar {
    width: 2px; /* æç»†ï¼Œåƒä¸€æ¡ä¸çº¿ */
}

.log-scroll-area::-webkit-scrollbar-track {
    background: transparent;
}

.log-scroll-area::-webkit-scrollbar-thumb {
    background: #1d1d1f; /* çº¯é»‘ï¼Œç¬¦åˆ Noir å®¡ç¾ */
    border-radius: 10px;
}

#log-content-body {
    font-size: 16px;
    line-height: 2; /* å®½è¡Œè·ï¼Œèˆ’ç¼“è§†è§‰ */
    color: #1d1d1f;
    text-align: justify;
    font-family: serif;
    font-style: italic;
}

#log-mood-tag {
    flex-shrink: 0; /* ç¦æ­¢åº•éƒ¨å‹ç¼© */
    margin-top: 25px;
    font-size: 10px;
    color: #999;
    border-top: 0.5px solid #eee;
    padding-top: 15px;
    letter-spacing: 2px;
}
/* --- ğŸ—‘ï¸ ç¥¨æ ¹ç‰©ç†é”€æ¯åè®® --- */

/* --- ğŸ—‘ï¸ ç¥¨æ ¹ç‰©ç†é”€æ¯æŒ‰é’® (æ˜¾å½¢ç‰ˆ) --- */
.stub-delete-tag {
    position: absolute;
    top: 10px;    /* è·ç¦»é¡¶éƒ¨ 10px */
    right: 10px;  /* è·ç¦»å³ä¾§ 10px */
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* ğŸš¨ ç‰©ç†æ”¹è¿›ï¼šæé«˜åˆå§‹å¯¹æ¯”åº¦ */
    background: rgba(0, 0, 0, 0.05); 
    color: #888; /* é¢œè‰²åŠ æ·±ï¼Œç¡®ä¿èƒ½çœ‹è§ */
    border: 1px solid rgba(0, 0, 0, 0.1); 
    
    border-radius: 50%;
    font-size: 10px;
    font-weight: 900;
    cursor: pointer;
    z-index: 1000; /* ç‰©ç†ç½®é¡¶ï¼Œç¡®ä¿ä¸è¢«å›¾ç‰‡é®æŒ¡ */
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
}

/* æ‚¬åœæ•ˆæœï¼šå˜æˆé†’ç›®çš„åè‰² */
.stub-delete-tag:hover {
    background: #000;
    color: #FFF;
    transform: rotate(90deg); /* æ—‹è½¬åŠ¨æ•ˆæš—ç¤ºé”€æ¯ */
}

/* ç‰©ç†ç²‰ç¢åŠ¨ç”»ï¼šåˆ é™¤æ—¶çš„ç¼©æ”¾æ¶ˆå¤±æ•ˆæœ */
.stub-shredding {
    transform: scale(0.8) translateY(20px) !important;
    opacity: 0 !important;
    filter: blur(10px) !important;
    pointer-events: none;
}
/* --- ğŸšï¸ Noir å·¥ä¸šæ»‘åŠ¨æ¡é«˜å®š --- */
.noir-range-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 2px; /* æç»†è½¨é“ */
    background: #EEE;
    outline: none;
    cursor: pointer;
    /* æ ¸å¿ƒï¼šåŠ¨æ€å¡«å……è‰²é€»è¾‘ */
    background-image: linear-gradient(#000, #000);
    background-size: 0% 100%; /* åˆå§‹ç”± JS åŠ¨æ€è®¡ç®— */
    background-repeat: no-repeat;
}

/* æ»‘å—å¤´ (é‚£ä¸ªé»‘ç‚¹) */
.noir-range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 22px;
    width: 22px;
    background: #000;
    border-radius: 50%;
    border: 4px solid #FFF; /* å¢åŠ ç™½è¾¹ï¼Œåƒä¸ªé¶ç‚¹ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: transform 0.2s;
}

.noir-range-slider::-webkit-slider-thumb:active {
    transform: scale(1.2); /* æŒ‰ä½æ—¶äº§ç”Ÿç‰©ç†å‹è¿«æ„Ÿ */
}
/* æœç´¢ç»“æœå¡ç‰‡ï¼šè®°å¿†èƒ¶ç‰‡æ„Ÿ */
.search-result-item {
    background: #fff;
    border-radius: 18px;
    padding: 15px;
    border-left: 4px solid #EEE;
    transition: all 0.2s;
    animation: msgFadeUp 0.4s ease;
}
.search-result-item:active { transform: scale(0.98); background: #F9F9F9; }

/* ç”¨æˆ·å’Œå¯¹æ–¹çš„è‰²å½©åŒºåˆ† */
.search-result-item.user { border-left-color: #007AFF; }
.search-result-item.opponent { border-left-color: #AF52DE; }

.search-meta {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: #C7C7CC;
    margin-bottom: 8px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.search-text-preview {
    font-size: 14px;
    color: #1d1d1f;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* é«˜äº®æœåˆ°çš„è¯ */
.highlight-word {
    color: #007AFF;
    font-weight: 800;
    background: rgba(0, 122, 255, 0.1);
    padding: 0 2px;
    border-radius: 2px;
}
/* --- ğŸ’ åŠŸèƒ½é¢æ¿ï¼šé«˜åº¦ä¸å¯¹é½æ ¡å‡†ç‰ˆ --- */
/* --- ğŸš¨ ç‰©ç†å †å ä¿®æ­£ï¼šåŠŸèƒ½é¢æ¿ --- */
.feature-panel-container {
    width: 100%;
    height: 0; /* é»˜è®¤å…³é—­æ—¶ä¸å ä½ */
    background: transparent !important;
    overflow: hidden; /* æš‚æ—¶éšè—ï¼Œé˜²æ­¢å±•å¼€è¿‡ç¨‹é—ªçƒ */
    transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    position: relative;
    /* ğŸš¨ ç§»é™¤ä¹‹å‰çš„ margin-top: -120px */
}

/* --- ğŸš¨ ç‰©ç†å¯¹é½ä¿®æ­£ï¼šç»å¯¹å•è¡Œæ¨ªå‘ç‰ˆ --- */
.feature-panel-container {
    width: 100%;
    height: 0;
    background: transparent !important;
    overflow: hidden;
    transition: height 0.4s cubic-bezier(0.3, 1, 0.3, 1);
    flex-shrink: 0;
}

.feature-panel-container.active {
    height: 90px; /* ğŸš¨ å› ä¸ºåªæœ‰ä¸€è¡Œï¼Œé«˜åº¦å¯ä»¥ç¼©å‡ï¼Œæ›´ç²¾è‡´ */
}

.feature-list-wrapper {
    /* ğŸš¨ æ ¸å¿ƒä¿®æ­£ï¼šå¼ºåˆ¶å•è¡Œæ’å¸ƒ */
    display: flex !important;
    flex-direction: row !important; 
    flex-wrap: nowrap !important;   /* ğŸš¨ ç»å¯¹ç¦æ­¢æ¢è¡Œ */
    
    /* å…è®¸æ¨ªå‘æº¢å‡ºæ»šåŠ¨ */
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
    
    gap: 12px;
    padding: 15px 20px;
    width: 100%;
    box-sizing: border-box;
    justify-content: flex-start;
}

/* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
.feature-list-wrapper::-webkit-scrollbar { display: none; }

/* ğŸ’ æ¯ä¸ªç‹¬ç«‹çš„æ¶²æ€ç»ç’ƒèƒ¶å›Š */
.feature-glass-capsule {
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    
    /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢å®½åº¦è¢« Flex å‹ç¼©å˜å½¢ */
    flex-shrink: 0 !important; 
    
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.25) !important;
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    
    height: 44px;
    width: auto; /* å®½åº¦éšæ–‡å­—è‡ªåŠ¨æ’‘å¼€ */
}

.capsule-icon {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.capsule-label {
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
    letter-spacing: -0.3px;
    white-space: nowrap; /* ğŸš¨ ç¡®ä¿æ–‡å­—ä¸æ¢è¡Œ */
}
/* --- ğŸš¨ ç‰©ç†å¼ºæ¨ï¼šå¼ºåˆ¶ç½®äºè¾“å…¥æ¡†ä¸Šæ–¹ç‰ˆ --- */
.feature-panel-container {
    width: 100%;
    height: 0;
    background: transparent !important;
    overflow: visible !important; /* ğŸš¨ å…è®¸æº¢å‡ºæ˜¾ç¤º */
    transition: height 0.4s cubic-bezier(0.3, 1, 0.3, 1);
    
    /* ğŸš¨ æ ¸å¿ƒä½ç§»é­”æ³• ğŸš¨ */
    position: relative;
    top: -10px; /* å‘ä¸Šç§»åŠ¨ï¼Œä¸é®æŒ¡è¾“å…¥æ¡†è¾¹æ¡† */
    transform: translateY(-100%); /* ç‰©ç†å¼ºåˆ¶ï¼šå‘ä¸Šå¹³ç§»è‡ªèº«é«˜åº¦çš„100% */
    z-index: 2000;
}

.feature-panel-container.active {
    height: 70px; /* é”å®šå•è¡Œé«˜åº¦ */
    margin-bottom: 0;
}

.feature-list-wrapper {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: nowrap !important; /* ğŸš¨ ç»ä¸æ¢è¡Œ */
    overflow-x: auto !important; /* ğŸš¨ å¼€å¯å·¦å³æ»‘åŠ¨ */
    -webkit-overflow-scrolling: touch;
    
    gap: 12px;
    padding: 10px 20px;
    width: 100%;
    box-sizing: border-box;
}

/* éšè—æ»šåŠ¨æ¡ */
.feature-list-wrapper::-webkit-scrollbar { display: none; }

/* ğŸ’ æ¯ä¸€ä¸ªç‹¬ç«‹çš„æ¶²æ€ç»ç’ƒèƒ¶å›Š */
.feature-glass-capsule {
    flex-shrink: 0 !important; /* ğŸš¨ é˜²æ­¢è¢«æŒ¤å‹å˜çª„ */
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    
    padding: 8px 18px;
    background: rgba(255, 255, 255, 0.3) !important;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    
    height: 44px;
    transition: transform 0.2s;
}

.capsule-icon svg {
    width: 20px;
    height: 20px;
    stroke: #1d1d1f;
    stroke-width: 2;
    margin-right: 10px;
}

.capsule-label {
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
    white-space: nowrap;
}
/* ğŸ–¼ï¸ å›¾ç‰‡æ°”æ³¡ä¸“ç”¨æ ·å¼ */
.bubble.image-bubble {
    padding: 0 !important;
    background: transparent !important;
    border: none !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
    max-width: 240px; /* é™åˆ¶å›¾ç‰‡æœ€å¤§å®½åº¦ */
}

.chat-msg-img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 18px;
    border: 0.5px solid rgba(255,255,255,0.2);
    cursor: pointer;
    transition: transform 0.2s;
}

.chat-msg-img:active { transform: scale(0.98); }
/* --- ğŸ’ å¼•ç”¨ç›’é«˜çº§é‡å¡‘ --- */
.bubble-quote-box {
    background: rgba(0, 0, 0, 0.06) !important; /* ææ¸…é€çš„é®ç½© */
    border-left: 2px solid rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 8px 12px;
    margin-bottom: 8px;
    font-size: 12px;
    color: inherit;
    position: relative;
}

/* ç”¨æˆ·æ°”æ³¡é‡Œçš„å¼•ç”¨ç›’ï¼ˆå˜äº®ï¼‰ */
.msg-row.user .bubble-quote-box {
    background: rgba(255, 255, 255, 0.15) !important;
    border-left-color: rgba(255, 255, 255, 0.4);
}
/* =========================================
   ğŸ–¤ Emoji æŠ½å±‰ï¼šåº•ç«¯å¯¹é½ç‰©ç†è¡¥ä¸
   ========================================= */
#emoji-modal-mask {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    z-index: 20000;
    display: none;        /* åˆå§‹éšè— */
    align-items: flex-end; /* ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šå¼ºåˆ¶å­å…ƒç´ æ²‰åˆ°åº•éƒ¨ */
    justify-content: center;
}

#emoji-modal-mask.active {
    display: flex; /* æ¿€æ´»æ—¶æ˜¾ç¤º */
}

.emoji-modal-card {
    width: 100%;
    max-width: 500px;
    background: #FFFFFF;
    border-radius: 30px 30px 0 0; /* ä»…é¡¶éƒ¨åœ†è§’ï¼Œé€‚é…åº•ç«¯ */
    padding: 24px;
    padding-bottom: 60px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
    
    /* æ»‘å…¥åŠ¨ç”» */
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

#emoji-modal-mask.active .emoji-modal-card {
    transform: translateY(0); /* æ¿€æ´»æ—¶æ»‘å…¥è§†é‡ */
}

#emoji-grid-list {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    max-height: 280px;
    overflow-y: auto;
    padding: 10px 0;
}
#emoji-grid-list::-webkit-scrollbar { display: none; }

.emoji-grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
}
/* --- ğŸ˜Š ä¿®å¤è¡¨æƒ…å¼¹çª—å¤´éƒ¨ï¼šæ ‡é¢˜å±…å·¦ï¼Œå–æ¶ˆå±…å³ --- */
.emoji-header {
    display: flex !important;
    justify-content: space-between !important; /* ğŸš¨ æ ¸å¿ƒï¼šæŠŠä¸¤ç«¯æ’‘å¼€ */
    align-items: center !important;
    width: 100% !important;
    margin-bottom: 25px !important; /* å¢åŠ ä¸€ç‚¹ä¸‹è¾¹è·ï¼Œå‘¼å¸æ„Ÿæ›´å¥½ */
}

.emoji-title {
    font-family: serif; /* ä¿æŒä½ çš„è¡¬çº¿ä½“é«˜çº§æ„Ÿ */
    font-weight: 800;
    font-size: 18px;
    color: #1d1d1f;
}

.emoji-cancel {
    color: #007AFF !important;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    padding: 5px 0 5px 10px; /* å¢åŠ ç‚¹å‡»çƒ­åŒº */
}
/* --- ğŸ’ è¡¨æƒ…ç®¡ç†å™¨é«˜çº§è§†è§‰è¡¥ä¸ --- */
#emoji-pre-box {
    width: 120px !important;
    height: 120px !important;
    background: #FFF !important;
    border: 1.5px solid #000 !important; /* å·¥ä¸šæ„Ÿé»‘è¾¹ */
    border-radius: 20px !important;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#emoji-pre-box:active {
    transform: scale(0.96);
    background: #f8f8f8 !important;
}

#emoji-tag-in:focus {
    background: #FFF !important;
    border-color: #000 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
}

/* é€‚é…ä½ åŸæœ¬çš„æŠ½å±‰æ ·å¼ */
.p2-editor-sheet {
    width: 100%;
    background: #fff;
    border-radius: 30px 30px 0 0;
    padding: 25px;
    animation: sheetUp 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}
/* =========================================
   ğŸ“ æ°”æ³¡æ¯”ä¾‹é‡å¡‘ï¼šä¸‹é¢Œéª¨ç²¾å‡†å¾®è°ƒ
   ========================================= */

/* 1. å…¨å±€æ°”æ³¡åº•åº§å¾®è°ƒ */
.bubble {
    position: relative !important;
    padding: 10px 14px !important; /* ç¼©å°ä¸Šä¸‹å†…è¾¹è·ï¼Œè®©æ–‡å­—å±…ä¸­æ„Ÿæ›´å¼º */
    font-size: 15px !important;
    line-height: 1.5 !important;
    word-wrap: break-word;
    word-break: break-all;
    /* é»˜è®¤åœ†è§’è®¾ä¸ºæ ‡å‡† 16px */
    border-radius: 16px !important; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.02) !important;
}

/* 2. ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè§’è‰²å›å¤ï¼ˆå·¦ä¾§æ°”æ³¡ï¼‰çš„ä¸‹é¢Œéª¨ */
.msg-row.opponent .bubble {
    background: #FFFFFF !important;
    color: #1d1d1f !important;
    /* ç‰©ç†é€»è¾‘ï¼šå·¦ä¸‹è§’ï¼ˆé è¿‘å¤´åƒï¼‰çš„åœ†è§’è®¾ä¸º 4pxï¼Œäº§ç”Ÿâ€œå°–è§’â€æŒ‡å‘å¤´åƒï¼Œå…¶ä½™ä¸‰è§’åœ†æ¶¦ */
    /* è¿™æ ·å°±ä¸ä¼šæ˜¾å¾—åº•éƒ¨æ˜¯ä¸€ä¸ªæ²‰é‡çš„åœ†å¼§äº† */
    border-radius: 16px 16px 16px 4px !important; 
    border: 0.5px solid rgba(0,0,0,0.05) !important;
    margin-top: 2px !important;
}

/* 3. å¯¹åº”ä¿®æ”¹ï¼šç”¨æˆ·å›å¤ï¼ˆå³ä¾§æ°”æ³¡ï¼‰çš„å¯¹ç§°é€»è¾‘ */
.msg-row.user .bubble {
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%) !important;
    color: #FFFFFF !important;
    /* å³ä¸‹è§’è®¾ä¸º 4pxï¼ŒæŒ‡å‘å³ä¾§ç”¨æˆ·å¤´åƒ */
    border-radius: 16px 16px 4px 16px !important;
}

/* 4. æ¶ˆé™¤è¡¨æƒ…åŒ…æ°”æ³¡çš„èƒŒæ™¯å½±å“ï¼Œé˜²æ­¢â€œä¸‹å·´â€æº¢å‡º */
.bubble.emoji-bubble {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    border-radius: 0 !important; /* è´´çº¸æ¨¡å¼ä¸éœ€è¦æ°”æ³¡åœ†è§’ */
}

/* =========================================
   ğŸ“ å…¨åŸŸè¡¨æƒ…åè®®ï¼šç”¨æˆ· & è§’è‰²ç»å¯¹å¯¹é½
   ========================================= */

/* 1. å¼ºåˆ¶æŠ¹é™¤æ‰€æœ‰èƒŒæ™¯ã€é˜´å½±ã€åœ†è§’å’Œè¾¹è· */
.bubble.emoji-bubble, 
.msg-row.opponent .bubble.image-bubble,
.msg-row.user .bubble.image-bubble {
    background: transparent !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
    padding: 0 !important;
    border-radius: 0 !important;
    
    /* ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šé”å®šç»Ÿä¸€å®½åº¦ */
    width: 130px !important; 
    max-width: 130px !important;
    
    /* é¿å¼€æ°”æ³¡ä¸Šæ–¹å¯èƒ½å­˜åœ¨çš„é—´è· */
    margin-top: 5px !important;
}

/* 2. å¼ºåˆ¶å†…éƒ¨å›¾ç‰‡æ’‘æ»¡è¿™ä¸ª 130px çš„æ¡† */
.bubble.emoji-bubble .chat-msg-img,
.msg-row.opponent .bubble.image-bubble .chat-msg-img,
.msg-row.user .bubble.image-bubble .chat-msg-img {
    width: 100% !important;
    height: auto !important;
    display: block !important;
    /* å¢åŠ å¾®å¼±æŠ•å½±è®©è´´çº¸æ›´æœ‰å±‚æ¬¡æ„Ÿ */
    filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); 
}

/* 3. é’ˆå¯¹å°å±å¹•(å¦‚ iPhone SE)çš„æè‡´ç¼©æ”¾ */
@media screen and (max-width: 380px) {
    .bubble.emoji-bubble,
    .msg-row.opponent .bubble.image-bubble {
        width: 110px !important;
        max-width: 110px !important;
    }
}
/* =========================================
   ğŸ–¤ Noir Voice Engine æ——èˆ°çº§è§†è§‰åè®®
   ========================================= */

.noir-voice-gate { background: #f4f4f7 !important; }

/* 1. å¤´éƒ¨ç»„ä»¶ */
.noir-header-fix {
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
}
.noir-h-btn { color: #007AFF !important; font-size: 16px; font-weight: 500; cursor: pointer; }
.noir-h-btn.bold { font-weight: 700; }
.noir-h-title { font-size: 14px; font-weight: 800; letter-spacing: 1px; color: #1d1d1f; }

/* 2. é€šæ åˆ—è¡¨æ¶æ„ */
.noir-section-label {
    font-size: 10px; font-weight: 900; color: #8e8e93; padding: 25px 20px 8px;
    letter-spacing: 2px; text-transform: uppercase;
}
.noir-full-list {
    background: #fff !important; width: 100% !important; 
    border-top: 0.5px solid rgba(0,0,0,0.08); border-bottom: 0.5px solid rgba(0,0,0,0.08);
}
.noir-row {
    display: flex; justify-content: space-between; align-items: center;
    min-height: 54px; margin-left: 20px; padding-right: 20px; border-bottom: 0.5px solid #F2F2F7;
}
.noir-row.last { border-bottom: none; }
.noir-row .n-label { font-size: 16px; font-weight: 600; color: #000; }

/* 3. å» Select åŒ–ï¼šæ¨¡æ‹Ÿé“¾æ¥ä¸è¾“å…¥æ¡† */
.n-value-link {
    color: #007AFF !important; font-size: 16px; font-weight: 600; padding-right: 20px; position: relative; cursor: pointer;
}
.n-value-link::after {
    content: ""; width: 7px; height: 7px; border-right: 2.5px solid #C7C7CC; border-bottom: 2.5px solid #C7C7CC;
    transform: rotate(-45deg); position: absolute; right: 0; top: 6px;
}
.noir-clean-input {
    border: none; background: transparent; text-align: right;
    color: #007AFF; font-size: 16px; font-weight: 600; outline: none; width: 60%;
}

/* 4. é‡å·¥ä¸šåŒæ­¥æŒ‰é’® */
.noir-action-full { padding: 10px 0; }
.noir-sync-trigger {
    background: #1d1d1f !important; color: #fff !important; height: 58px; width: 100%;
    display: flex; align-items: center; justify-content: center; gap: 12px;
    font-weight: 800; font-size: 13px; letter-spacing: 2.5px; cursor: pointer;
}
.noir-sync-trigger:active { background: #333 !important; }

/* 5. å‚æ•°è°ƒèŠ‚åŒºåŸŸ */
.noir-param-card {
    background: #fff; width: 100%; padding: 35px 25px;
    border-top: 0.5px solid rgba(0,0,0,0.08); border-bottom: 0.5px solid rgba(0,0,0,0.08);
}
.n-param-info { display: flex; justify-content: space-between; margin-bottom: 15px; }
.n-p-tag { font-size: 11px; font-weight: 900; color: #3a3a3c; letter-spacing: 1px; }
.n-p-num { font-family: 'Courier New', monospace; color: #007AFF; font-weight: 900; font-size: 14px; }

/* 6. ç‰©ç†çº§æ»‘å—é‡å¡‘ */
.noir-range-pro {
    -webkit-appearance: none; width: 100%; height: 2px; background: #E5E5EA; border-radius: 2px; outline: none; margin: 15px 0;
}
.noir-range-pro::-webkit-slider-thumb {
    -webkit-appearance: none; width: 28px; height: 28px; background: #fff; border-radius: 50%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 0 0 0.5px rgba(0,0,0,0.05); cursor: pointer;
}

/* 7. è‡ªå®šä¹‰ Action Sheet */
.noir-picker-box {
    width: 96%; max-width: 450px; background: rgba(255,255,255,0.9);
    backdrop-filter: blur(25px) saturate(180%); border-radius: 24px;
    margin-bottom: 12px; display: flex; flex-direction: column;
    animation: nSheetUp 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes nSheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.n-picker-header { padding: 16px; text-align: center; font-size: 11px; font-weight: 900; color: #8e8e93; letter-spacing: 2px; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
.n-picker-scroll { max-height: 45vh; overflow-y: auto; }
.n-opt-item { padding: 18px; text-align: center; color: #007AFF; font-size: 18px; font-weight: 500; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
.n-opt-item:active { background: rgba(0,0,0,0.05); }
.n-picker-cancel { background: #fff; padding: 16px; border-radius: 14px; text-align: center; color: #FF3B30; font-weight: 700; font-size: 18px; margin: 8px 16px 25px; }

.noir-footer-hint { text-align: center; font-size: 10px; font-weight: 700; color: #c7c7cc; padding: 40px 20px; letter-spacing: 2px; }
/* --- ğŸ™ï¸ è¯­éŸ³æ¶ˆæ¯æ°”æ³¡ä¸“å±æ ·å¼ --- */

/* 1. åŸºç¡€å®¹å™¨ */
.bubble.voice-bubble {
    width: 160px; /* å›ºå®šå®½åº¦ï¼Œåƒå¾®ä¿¡è¯­éŸ³ä¸€æ · */
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px !important;
    cursor: pointer;
    position: relative;
    overflow: visible !important;
}

/* 2. æ’­æ”¾å›¾æ ‡æ—‹è½¬ */
.voice-play-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

/* 3. å£°æ³¢åŠ¨ç”»çº¿ */
.voice-waves {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 15px;
    flex: 1;
}

.voice-waves span {
    width: 2px;
    height: 6px;
    background: currentColor;
    border-radius: 1px;
    opacity: 0.4;
    transition: height 0.2s;
}

/* æ’­æ”¾æ—¶çš„è·³åŠ¨åŠ¨ç”» */
.bubble.playing .voice-waves span {
    animation: waveRise 0.5s infinite ease-in-out;
}

.bubble.playing .voice-waves span:nth-child(2) { animation-delay: 0.1s; }
.bubble.playing .voice-waves span:nth-child(3) { animation-delay: 0.2s; }
.bubble.playing .voice-waves span:nth-child(4) { animation-delay: 0.3s; }

@keyframes waveRise {
    0%, 100% { height: 6px; }
    50% { height: 14px; }
}

/* 4. æ—¶é•¿æ–‡å­— */
.voice-duration {
    font-size: 11px;
    font-weight: 700;
    opacity: 0.6;
    font-family: monospace;
}

/* 5. æœªè¯»çº¢ç‚¹ */
.voice-unread-dot {
    position: absolute;
    top: 0;
    right: -10px;
    width: 8px;
    height: 8px;
    background: #FF3B30;
    border-radius: 50%;
    display: block;
}
.is-read .voice-unread-dot { display: none; }
/* è¯­éŸ³æ°”æ³¡å†…éƒ¨å¸ƒå±€ */
.voice-layout-grid {
    display: flex;
    flex-direction: column;
    width: 100%;
}

/* ä¸ŠåŠéƒ¨åˆ†ï¼šæ³¢çº¹æ’­æ”¾å™¨ */
.voice-player-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ä¸‹åŠéƒ¨åˆ†ï¼šè½¬æ–‡å­—å†…å®¹ (é»˜è®¤éšè—) */
.voice-text-transcription {
    display: none; /* é»˜è®¤ä¸æ˜¾ç¤º */
    margin-top: 12px;
    padding-top: 10px;
    border-top: 0.5px solid rgba(0,0,0,0.1);
    font-size: 14px;
    line-height: 1.5;
    color: inherit;
    text-align: left;
    animation: slideDown 0.3s ease;
}

/* è‡ªå·±çš„è¯­éŸ³æ¡å±•å¼€æ—¶çš„åˆ†å‰²çº¿é¢œè‰² */
.msg-row.user .voice-text-transcription {
    border-top-color: rgba(255,255,255,0.2);
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤ºæ–‡å­— */
.bubble.voice-expanded .voice-text-transcription {
    display: block;
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ°”æ³¡å˜å®½ä¸€ç‚¹ä»¥å®¹çº³æ–‡å­— */
.bubble.voice-expanded {
    width: auto !important; /* è§£é™¤å®½åº¦é™åˆ¶ */
    min-width: 160px;
    max-width: 260px !important;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ™ï¸ ç»ˆæè¯­éŸ³æ°”æ³¡æ ·å¼ (ä¸‰æ®µå¼ + æ·±æµ…é€‚é…) --- */

/* 1. åŸºç¡€å®¹å™¨ */
.voice-layout-grid {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-width: 140px; /* ç»™è¯­éŸ³æ¡ä¸€ä¸ªåŸºç¡€å®½åº¦ */
}

/* 2. æ’­æ”¾å™¨è¡Œ (ä»…å›¾æ ‡+æ—¶é•¿) */
.voice-player-row {
    display: flex;
    align-items: center;
    gap: 8px; /* å›¾æ ‡å’Œæ–‡å­—é—´è· */
    height: 24px;
    position: relative;
}

/* æ’­æ”¾å›¾æ ‡æ—‹è½¬ */
.voice-play-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

/* æ—¶é•¿æ–‡å­— */
.voice-duration {
    font-size: 11px;
    font-weight: 700;
    opacity: 0.6;
    font-family: monospace;
}


/* 3. å†…å®¹å®¹å™¨ (é»˜è®¤éšè—) */
.voice-content-box {
    display: none;
    margin-top: 10px;
    padding-top: 8px;
    border-top: 0.5px solid rgba(0,0,0,0.1); /* é»˜è®¤æµ…è‰²åˆ†å‰²çº¿ */
    animation: slideDown 0.3s ease;
    flex-direction: column;
    align-items: flex-start;
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤ºå†…å®¹ */
.bubble.voice-expanded .voice-content-box {
    display: flex;
}
.bubble.voice-expanded {
    width: auto !important;
    max-width: 260px !important;
}

/* 4. åŸæ–‡æ ·å¼ */
.voice-origin-text {
    font-size: 15px;
    line-height: 1.5;
    margin-bottom: 4px;
}

/* 5. ç¿»è¯‘æŒ‰é’® (é€šç”¨æ ·å¼) */
.voice-trans-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 6px;
    align-self: flex-end; /* é å³å¯¹é½ */
    transition: all 0.2s;
}

/* 6. è¯‘æ–‡åŒºåŸŸ */
.voice-trans-result {
    display: none; /* é»˜è®¤éšè— */
    width: 100%;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 0.5px dotted rgba(0,0,0,0.1);
    font-size: 13px;
    line-height: 1.5;
}

/* æ¿€æ´»æ˜¾ç¤ºè¯‘æ–‡ */
.voice-content-box.show-trans .voice-trans-result {
    display: block;
}
.voice-content-box.show-trans .voice-trans-btn {
    display: none; /* å±•å¼€åéšè—æŒ‰é’® */
}

/* --- ğŸ­ æ·±æµ…è‰²é€‚é… (æ ¸å¿ƒ) --- */

/* è§’è‰² (æµ…è‰²æ°”æ³¡) */
.msg-row.opponent .voice-trans-btn {
    background: rgba(0,0,0,0.05);
    color: #007AFF;
}
.msg-row.opponent .voice-trans-result {
    color: #666;
    border-top-color: rgba(0,0,0,0.1);
}

/* ç”¨æˆ· (æ·±è‰²æ°”æ³¡) */
.msg-row.user .voice-content-box {
    border-top-color: rgba(255,255,255,0.2); /* ç¬¬ä¸€é“åˆ†å‰²çº¿å˜ç™½ */
}
.msg-row.user .voice-trans-btn {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255,255,255,0.3);
}
.msg-row.user .voice-trans-btn svg {
    stroke: #FFFFFF;
}
.msg-row.user .voice-trans-result {
    color: rgba(255, 255, 255, 0.95);
    border-top-color: rgba(255, 255, 255, 0.3); /* ç¬¬äºŒé“åˆ†å‰²çº¿å˜ç™½ */
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
/* =========================================================
   ğŸš‘ æ–‡æœ¬æ¶ˆæ¯ç¿»è¯‘æ ·å¼ä¿®å¤ (å¼ºåˆ¶è¦†ç›–ç‰ˆ)
   ========================================================= */

/* 1. ç¿»è¯‘å®¹å™¨ï¼šå»æ‰å¤šä½™çš„é—´éš”ï¼Œä½¿ç”¨å¹²å‡€çš„é¡¶è¾¹æ¡† */
.bubble:not(.voice-bubble) .bubble-translation-box {
    display: block; /* ä¿æŒæ˜¾ç¤º */
    margin-top: 10px !important;
    padding-top: 8px !important;
    /* ç”¨æç»†çš„åˆ†å‰²çº¿ä»£æ›¿åŸæ¥çš„ .trans-line */
    border-top: 0.5px solid rgba(0, 0, 0, 0.1) !important; 
    width: 100% !important;
}

/* 2. éšè—ä¹‹å‰é‚£ä¸ªéš¾çœ‹çš„ç²—çº¿æ¡ div */
.bubble:not(.voice-bubble) .trans-line {
    display: none !important; 
}

/* 3. è¯‘æ–‡æ–‡å­—ï¼šå­—ä½“è°ƒå°ï¼Œé¢œè‰²å¯¹é½ */
.bubble:not(.voice-bubble) .msg-text-trans {
    font-size: 14px !important;
    line-height: 1.5 !important;
    color: inherit !important;
    opacity: 0.85 !important;
    font-style: normal !important; /* å»æ‰æ–œä½“ï¼Œæ›´æ˜“è¯» */
    margin-bottom: 5px !important;
}

/* 4. ç¿»è¯‘æŒ‰é’®ï¼šç¼©å°ã€é å³ã€èƒ¶å›ŠåŒ– */
.bubble:not(.voice-bubble) .trans-toggle-btn {
    /* å˜æˆä¸€ä¸ªå°æ ‡ç­¾ */
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    margin-top: 4px !important;
    padding: 3px 8px !important;
    border-radius: 8px !important;
    
    font-size: 10px !important;
    font-weight: 700 !important;
    
    /* å¼ºåˆ¶é å³å¯¹é½ */
    float: right !important; 
    clear: both !important;
    
    /* é»˜è®¤æµ…è‰²æ°”æ³¡çš„æŒ‰é’®æ ·å¼ */
    color: #000000 !important;
    border: none !important;
    box-shadow: none !important;
}

/* æ¸…é™¤æµ®åŠ¨ï¼Œé˜²æ­¢é«˜åº¦å¡Œé™· */
.bubble:not(.voice-bubble)::after {
    content: "";
    display: block;
    clear: both;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
/* =========================================================
   ğŸ”´ ç»ˆæç£¨åœ†ï¼šå»é™¤æ‰€æœ‰å°–è§’ï¼Œå˜æˆå®Œç¾èƒ¶å›Š
   ========================================================= */

/* 1. å¯¹æ–¹çš„æ°”æ³¡ (å·¦è¾¹)ï¼šå·¦ä¸‹è§’å¼ºåˆ¶å˜åœ† */
.msg-row.opponent .bubble {
    border-bottom-left-radius: 18px !important; /* å½»åº•ç£¨åœ† */
}

/* 2. è‡ªå·±çš„æ°”æ³¡ (å³è¾¹)ï¼šå³ä¸‹è§’å¼ºåˆ¶å˜åœ† (å¦‚æœä½ ä¹Ÿæƒ³æ”¹çš„è¯) */
.msg-row.user .bubble {
    border-bottom-right-radius: 18px !important;
}

/* 3. ä¿®å¤ç¿»è¯‘å±‚çš„åœ†è§’ (é˜²æ­¢ç¿»è¯‘èƒŒæ™¯åˆ‡æ–­åœ†è§’) */
.msg-row.opponent .bubble-translation-box {
    border-bottom-left-radius: 18px !important;
}
.msg-row.user .bubble-translation-box {
    border-bottom-right-radius: 18px !important;
}

/* 4. ç¡®ä¿å›¾ç‰‡ä¹Ÿæ˜¯å®Œç¾åœ†è§’ */
.chat-msg-img {
    border-radius: 18px !important;
}
/* =========================================================
   ğŸ”˜ iOS å¼€å…³ç»„ä»¶æ ·å¼ (ç¾åŒ–è¡¥ä¸)
   ========================================================= */

/* 1. å¼€å…³å®¹å™¨ */
.ios-switch {
    position: relative;
    display: inline-block;
    width: 51px;  /* æ ‡å‡†å®½åº¦ */
    height: 31px; /* æ ‡å‡†é«˜åº¦ */
    vertical-align: middle;
}

/* 2. éšè—åŸå§‹çš„æ–¹å—å‹¾é€‰æ¡† */
.ios-switch input { 
    opacity: 0;
    width: 0;
    height: 0;
}

/* 3. æ»‘å—è½¨é“ (èƒŒæ™¯) */
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e9e9ea; /* é»˜è®¤ç°è‰² (å…³é—­çŠ¶æ€) */
    transition: .4s;
    border-radius: 34px; /* åœ†è§’èƒ¶å›Š */
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„è½¨é“èƒŒæ™¯ */
@media (prefers-color-scheme: dark) {
    .slider { background-color: #39393d; }
}

/* 4. æ»‘å—åœ†é’® (ä¸­é—´é‚£ä¸ªç™½åœ†åœˆ) */
.slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%; /* æ­£åœ† */
    box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 3px 1px rgba(0,0,0,0.06); /* é˜´å½±å¢åŠ ç«‹ä½“æ„Ÿ */
}

/* 5. æ¿€æ´»çŠ¶æ€ (å¼€å¯) */
input:checked + .slider {
    background-color: #34C759; /* iOS å®˜æ–¹ç»¿ */
}

/* 6. æ¿€æ´»æ—¶çš„åœ†é’®ç§»åŠ¨åŠ¨ç”» */
input:checked + .slider:before {
    transform: translateX(20px);
}
/* =========================================================
   ğŸ“ iOS åˆ—è¡¨åº•éƒ¨æ³¨é‡Šæ ·å¼
   ========================================================= */

.ios-list-note {
    font-size: 13px;          /* æ ‡å‡†æ³¨é‡Šå­—å· */
    color: #8e8e93;           /* iOS æ ‡å‡†æ¬¡çº§ç°è‰² */
    margin-top: 8px;          /* ç¦»ä¸Šé¢çš„å¼€å…³ç¨å¾®è¿œä¸€ç‚¹ */
    margin-bottom: 15px;      /* ç¦»åº•éƒ¨ç•™ç™½ */
    padding: 0 16px;          /* å·¦å³å¯¹é½ç¼©è¿›ï¼Œå’Œä¸Šé¢çš„åˆ—è¡¨å†…å®¹å¯¹é½ */
    line-height: 1.4;         /* å¢åŠ è¡Œé«˜ï¼Œé˜²æ­¢å¤šè¡Œæ–‡å­—æŒ¤åœ¨ä¸€èµ· */
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
@media (prefers-color-scheme: dark) {
    .ios-list-note {
        color: #98989d;       /* æ·±è‰²æ¨¡å¼ä¸‹ç¨å¾®äº®ä¸€ç‚¹çš„ç° */
    }
}
/* --- ğŸ–¼ï¸ ç›¸å†Œ App ä¸»ä½“ --- */
#app-photos {
    background: var(--bg-color); /* è·Ÿéšç³»ç»Ÿé»‘ç™½æ¨¡å¼ */
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
    color: var(--text-color);
}

/* é¡¶éƒ¨æ  */
.photos-header {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    font-weight: 600;
    font-size: 17px;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(20px);
    z-index: 10;
    position: sticky;
    top: 0;
}
.dark-mode .photos-header { background: rgba(0,0,0,0.8); }

.photos-add-btn { cursor: pointer; color: #007AFF; }

/* å†…å®¹ç½‘æ ¼ (1:1 ç¼©ç•¥å›¾) */
.photos-content-area {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 80px; /* ç»™åº•éƒ¨å¯¼èˆªç•™ä½ç½® */
}

.photos-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3åˆ— */
    gap: 2px; /* æç»†é—´è·ï¼Œç±»ä¼¼ iOS */
}

.photo-item {
    aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    background: #eee;
    overflow: hidden;
    position: relative;
    cursor: pointer;
}
.photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* è£å‰ªå¡«å…… */
    transition: transform 0.3s;
}
.photo-item:active img { transform: scale(0.95); opacity: 0.8; }

/* åº•éƒ¨æ‚¬æµ®å¯¼èˆª (èƒ¶å›Š) */
.photos-bottom-nav-container {
    position: absolute;
    bottom: 30px;
    left: 0; 
    right: 0;
    display: flex;
    justify-content: center;
    z-index: 20;
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç©ºç™½å¤„ */
}
.photos-bottom-capsule {
    pointer-events: auto;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(20px);
    padding: 6px;
    border-radius: 30px;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 0.5px solid rgba(0,0,0,0.1);
}
.dark-mode .photos-bottom-capsule {
    background: rgba(30,30,30,0.85);
    border-color: rgba(255,255,255,0.1);
}

.photos-bottom-capsule .nav-item {
    padding: 8px 24px;
    font-size: 13px;
    font-weight: 600;
    color: #999;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
}
.photos-bottom-capsule .nav-item.active {
    background: #000;
    color: #fff;
}
.dark-mode .photos-bottom-capsule .nav-item.active {
    background: #fff;
    color: #000;
}

/* --- ğŸ“¤ ä¸Šä¼ å¼¹çª—æ ·å¼ --- */
.upload-preview-container {
    width: 100%;
    min-height: 200px;
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 15px;
    position: relative;
}
#upload-img-preview {
    width: 100%;
    height: auto;
    display: block;
}
#upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #999;
    gap: 8px;
    font-size: 13px;
}
.photo-text-area {
    width: 100%;
    height: 80px;
    border: none;
    background: rgba(0,0,0,0.05);
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    resize: none;
    margin-bottom: 15px;
    color: inherit;
}
.photo-setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    padding: 10px 0;
    border-top: 0.5px solid rgba(0,0,0,0.1);
}

/* --- ğŸ–¼ï¸ é«˜å®šå¡ç‰‡æ ·å¼ --- */
.ios-fullscreen-modal {
    position: relative; /* ç›¸å¯¹äº mask å±…ä¸­ */
    width: 92%;
    max-width: 400px;
    height: 82vh;
    background: #ffffff;
    z-index: 10001;
    border-radius: 38px;
    box-shadow: 0 40px 100px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: translateY(50px) scale(0.9);
    transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}
.dark-mode .ios-fullscreen-modal { background: #000; }

/* è¿›åœºåŠ¨ç”»ï¼šç”±å°å˜å¤§å¹¶å‡èµ· */
@keyframes cardPopIn {
    from { opacity: 0; transform: scale(0.9) translateY(40px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* è°ƒæ•´è¯¦æƒ…é¡µçš„é¡¶æ ï¼Œè®©å®ƒæ›´åƒå¡ç‰‡çš„å¤´éƒ¨ */
.detail-top-bar {
    height: 55px;
    padding: 0 20px;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
    background: #fff;
    border-radius: 30px 30px 0 0; /* å¤´éƒ¨åœ†è§’åŒæ­¥ */
}
.dark-mode .detail-top-bar { background: rgba(0,0,0,0.9); }

.detail-scroll-content {
    flex: 1;
    overflow-y: auto;
}
/* è¯¦æƒ…å›¾ç‰‡åŒºåŸŸå¾®è°ƒï¼Œé˜²æ­¢æ’‘ç ´åœ†è§’ */
.detail-img-wrapper {
    width: 100%;
    background: #f2f2f7;
    max-height: 45vh; /* é™åˆ¶å›¾ç‰‡é«˜åº¦ï¼Œç»™è¯„è®ºåŒºç•™ç©ºé—´ */
}
.detail-img-wrapper img {
    width: 100%;
    height: auto;
    max-height: 500px;
    object-fit: contain;
}

.detail-info-section {
    padding: 16px;
}
.detail-user-desc {
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 15px;
}
.name-tag { font-weight: 700; margin-right: 6px; }

.detail-action-bar {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
    color: #666;
    font-size: 13px;
}
.detail-action-bar .act-item {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

/* è¯„è®ºåŒº */
.comment-row {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
    font-size: 13px;
}
.comment-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    object-fit: cover;
}
.comment-bubble {
    background: rgba(0,0,0,0.05);
    padding: 8px 12px;
    border-radius: 12px;
    border-top-left-radius: 2px;
    flex: 1;
}
.dark-mode .comment-bubble { background: rgba(255,255,255,0.1); }

.comment-name { font-weight: 700; margin-bottom: 2px; font-size: 12px; opacity: 0.8; }
.comment-time { font-size: 10px; opacity: 0.5; float: right; }

/* åº•éƒ¨è¾“å…¥æ¡† */
.detail-input-bar {
    height: 50px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-top: 0.5px solid rgba(0,0,0,0.1);
    background: var(--bg-color);
}
.detail-input-bar input {
    flex: 1;
    height: 36px;
    border-radius: 18px;
    border: 0.5px solid rgba(0,0,0,0.1);
    padding: 0 12px;
    background: rgba(0,0,0,0.05);
    color: inherit;
}
.send-icon {
    width: 30px; height: 30px;
    background: #007AFF;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
}

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
/* --- ğŸ­ é«˜çº§å¤´åƒé€‰æ‹©å™¨æ ·å¼ --- */

/* å®¹å™¨ï¼šæ¨ªå‘æ’åˆ—ï¼Œå…è®¸æ»‘åŠ¨ */
.char-selector-scroll {
    display: flex;
    gap: 15px; /* å¤´åƒä¹‹é—´çš„é—´è· */
    overflow-x: auto; /* å…è®¸æ¨ªå‘æ»‘åŠ¨ */
    padding: 10px 5px 20px 5px; /* ç•™å‡ºé˜´å½±ç©ºé—´ */
    scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ (Firefox) */
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
}
.char-selector-scroll::-webkit-scrollbar { display: none; } /* éšè—æ»šåŠ¨æ¡ (Chrome/Safari) */

/* å•ä¸ªé€‰é¡¹ï¼šé»˜è®¤å˜ç° */
.char-select-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0.5; /* ğŸ‘» é»˜è®¤åŠé€æ˜ï¼ˆå˜ç°ï¼‰ */
    filter: grayscale(100%); /* ğŸ–¤ é»˜è®¤é»‘ç™½ */
    transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    cursor: pointer;
    min-width: 60px; /* ä¿è¯ç‚¹å‡»åŒºåŸŸ */
}

/* é€‰ä¸­çŠ¶æ€ï¼šå˜äº®ã€ä¸Šæµ®ã€å½©è‰² */
.char-select-item.active {
    opacity: 1; /* ğŸ’¡ å˜äº® */
    filter: grayscale(0%); /* ğŸŒˆ æ¢å¤å½©è‰² */
    transform: translateY(-5px) scale(1.05); /* ä¸Šæµ® + æ”¾å¤§ */
}

/* å¤´åƒå®¹å™¨ */
.char-select-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid transparent; /* é¢„ç•™è¾¹æ¡† */
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    transition: all 0.3s;
}

/* é€‰ä¸­æ—¶çš„å¤´åƒå…‰åœˆ */
.char-select-item.active .char-select-avatar {
    border-color: #007AFF; /* ğŸ”µ iOS è“åœˆ */
    box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3); /* è“è‰²è¾‰å…‰ */
}

/* åå­—æ–‡å­— */
.char-select-name {
    font-size: 11px;
    color: #1d1d1f;
    font-weight: 500;
    text-align: center;
    width: 64px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é•¿åå­—è‡ªåŠ¨çœç•¥å· */
}
/* é€‰ä¸­æ—¶æ–‡å­—åŠ ç²—å˜è“ */
.char-select-item.active .char-select-name {
    color: #007AFF;
    font-weight: 700;
}

/* --- ğŸ’ é«˜çº§å¡ç‰‡æ ·å¼ --- */
#modal-photo-detail {
    position: relative;
    width: 92%;
    max-width: 400px;
    height: 82vh;
    background: rgba(255, 255, 255, 0.95); /* å¾®å¾®é€è‰² */
    border-radius: 38px; /* æ›´åœ†æ¶¦çš„è¾¹ç¼˜ */
    box-shadow: 0 30px 100px rgba(0,0,0,0.4); /* æ·±é‚ƒé˜´å½± */
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: iosPop 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); /* ç‰©ç†å¼¹æ€§å¼¹å‡º */
}

@keyframes iosPop {
    from { opacity: 0; transform: scale(0.9) translateY(40px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* --- ğŸ› ï¸ æ‚¬æµ®å·¥å…·æŒ‰é’® --- */
.card-float-tools {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 12px;
    z-index: 100;
}

.tool-circle-btn {
    width: 40px; height: 40px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.2s;
    border: 0.5px solid rgba(255,255,255,0.2);
}

.tool-circle-btn:active { transform: scale(0.9); opacity: 0.7; }
.tool-circle-btn.btn-delete-red { color: #FF3B30; }

/* å†…éƒ¨æ»šåŠ¨ä¸å›¾ç‰‡ */
.detail-img-wrapper { width: 100%; max-height: 50%; overflow: hidden; }
.detail-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
.detail-scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
/* --- ğŸ–¤ é®ç½©å±‚ï¼šæ›´è‡ªç„¶çš„æ™¯æ·± --- */
.photo-detail-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(15px) saturate(150%);
    -webkit-backdrop-filter: blur(15px) saturate(150%);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.photo-detail-mask.active { opacity: 1; }
/* --- ğŸ’ æ‚å¿—æ„Ÿå¡ç‰‡æœ¬ä½“ (ç‰©ç†åŠ å›ºç‰ˆ) --- */
.ios-card-viewer {
    position: relative; 
    width: 90%;
    max-width: 400px;
    height: 82vh;
    background: #fff;
    border-radius: 40px; 
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.5);
    
    /* ğŸš¨ åˆå§‹çŠ¶æ€è®¾ä¸ºä¸å¯è§ */
    display: none; 
    flex-direction: column;
    
    /* ğŸš¨ åˆå§‹ç¼©æ”¾è®¾ä¸º 0.85 */
    transform: scale(0.85) translateY(60px);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.18, 1, 0.32, 1.1);
}

/* ğŸš¨ æ¿€æ´»æ€ï¼šå¼ºåˆ¶æ˜¾ç¤ºå¹¶æ¢å¤æ¯”ä¾‹ */
.photo-detail-mask.active .ios-card-viewer {
    display: flex !important; /* å¼ºåˆ¶å˜ä¸º Flex å¸ƒå±€ */
    transform: scale(1) translateY(0);
    opacity: 1;
}

/* æ‚¬æµ®å·¥å…·æ  */
.card-header-tools {
    position: absolute;
    top: 20px; left: 0; right: 0;
    padding: 0 20px;
    display: flex; justify-content: space-between; align-items: center;
    z-index: 100;
}
.tool-btn-back { color: #fff; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); cursor: pointer; }
.card-actions-group { display: flex; gap: 12px; }
.tool-btn-circle {
    width: 38px; height: 38px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; border: 0.5px solid rgba(255,255,255,0.3);
}
.tool-btn-circle.danger { color: #FF3B30; }

/* å†…å®¹å¸ƒå±€ */
.card-main-scroller { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.card-hero-img { width: 100%; min-height: 300px; background: #000; }
.card-hero-img img { width: 100%; height: 100%; object-fit: cover; }

.card-content-body { padding: 25px; }
.user-info-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
.user-name { font-size: 22px; font-weight: 800; color: #1d1d1f; }
.post-time { font-size: 12px; color: #8E8E93; font-weight: 600; }
.post-desc { font-size: 16px; line-height: 1.6; color: #3a3a3c; margin-bottom: 30px; }
.comment-section-title { font-size: 11px; font-weight: 800; color: #8E8E93; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 20px; }

/* åº•éƒ¨è¾“å…¥æ¡† */
.card-input-bar {
    position: absolute; bottom: 0; left: 0; width: 100%;
    padding: 15px 20px 35px; /* åº•éƒ¨é¢„ç•™å®‰å…¨åŒº */
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(20px);
    display: flex; align-items: center; gap: 12px;
}
.card-input-bar input {
    flex: 1; height: 44px; background: #F2F2F7; border-radius: 22px;
    border: none; padding: 0 18px; font-size: 15px; outline: none;
}
.send-btn-circle {
    width: 44px; height: 44px; background: #007AFF; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
}
/* --- ğŸ—“ï¸ ç›¸å†Œæ—¶é—´è½´æ ·å¼ --- */
.photos-timeline-section {
    margin-bottom: 30px;
}
.timeline-header {
    padding: 15px 16px 10px;
    font-size: 20px;
    font-weight: 800;
    color: #1d1d1f;
    display: flex;
    align-items: baseline;
    gap: 8px;
}
.timeline-header span {
    font-size: 13px;
    color: #8E8E93;
    font-weight: 600;
}

/* --- ğŸ–¼ï¸ ç‰©ç†ç½®é¡¶ï¼šå…¨å±å¤§å›¾æµè§ˆå™¨ --- */
#photo-fullscreen-browser {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 100000; /* ğŸš¨ ç»å¯¹æœ€é«˜å±‚çº§ï¼Œç›–è¿‡ä¸€åˆ‡ */
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#photo-fullscreen-browser.active {
    display: flex;
    opacity: 1;
}
.fullscreen-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
}
.close-fullscreen {
    position: absolute;
    top: 60px; right: 25px;
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer;
}
/* --- ğŸ­ Taçš„ç›¸å†Œï¼šé¡¶çº§ç”»å»Šé•¿è½´å¡ç‰‡ --- */
.char-gallery-card {
    position: relative;
    width: 100%;
    height: 200px;
    margin-bottom: 25px;
    border-radius: 32px;
    background: #000;
    overflow: visible; /* ğŸš¨ å…è®¸é˜´å½±æº¢å‡º */
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
}

/* æ¨¡æ‹Ÿå¤šå±‚ç›¸å†Œå †å æ„Ÿ (è£…é¥°åº•å±‚) */
.char-gallery-card::after {
    content: "";
    position: absolute;
    bottom: -8px; left: 5%; right: 5%;
    height: 20px;
    background: rgba(255,255,255,0.3);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    z-index: -1;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

/* æ ¸å¿ƒå®¹å™¨ */
.gallery-inner-container {
    position: relative;
    width: 100%; height: 100%;
    border-radius: 32px;
    overflow: hidden;
    z-index: 2;
}

/* èƒŒæ™¯å¤§å›¾ï¼šé«˜å¯¹æ¯”åº¦ç”µå½±æ„Ÿ */
.gallery-card-bg {
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center 20%;
    filter: brightness(0.8) contrast(1.1);
    transition: transform 0.6s ease;
}

.char-gallery-card:hover .gallery-card-bg {
    transform: scale(1.08);
}

/* é¡¶éƒ¨ï¼šç²¾è‡´è§’æ ‡ */
.gallery-top-info {
    position: absolute;
    top: 20px; left: 20px; right: 20px;
    display: flex; justify-content: space-between;
    z-index: 5;
}

.gallery-type-tag {
    font-size: 9px;
    font-weight: 900;
    color: rgba(255,255,255,0.6);
    letter-spacing: 2px;
    text-transform: uppercase;
}

/* åº•éƒ¨ï¼šæ¯›ç»ç’ƒä¿¡æ¯èˆ± */
.gallery-info-pod {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    padding: 20px 25px;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

.gallery-char-name {
    font-family: 'Cinzel', serif; /* ä½¿ç”¨é«˜çº§è¡¬çº¿ä½“ */
    font-size: 26px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 15px rgba(0,0,0,0.5);
}

/* ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šåŠ¨æ€è®¡æ•°èŠ¯ç‰‡ */
.gallery-stat-chip {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 0.5px solid rgba(255,255,255,0.3);
    padding: 6px 14px;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-num {
    font-size: 14px;
    font-weight: 900;
    color: #fff;
    line-height: 1;
}

.stat-label {
    font-size: 8px;
    font-weight: 800;
    color: rgba(255,255,255,0.5);
    letter-spacing: 1px;
    margin-top: 2px;
}
/* --- ğŸ›ï¸ è§’è‰²ç›¸å†Œå±•å…ï¼šé«˜çº§æ’ç‰ˆ --- */
.gallery-viewer-window {
    background: #F2F2F7;
    z-index: 12000;
}

/* é¡¶éƒ¨èµ„æ–™å¡ */
.gallery-header-profile {
    padding: 60px 25px 30px;
    background: #fff;
    border-radius: 0 0 40px 40px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    text-align: center;
}
.header-char-name { font-family: 'Cinzel', serif; font-size: 28px; font-weight: 800; color: #000; }
.header-char-bio { font-size: 13px; color: #8E8E93; line-height: 1.6; margin-top: 10px; padding: 0 20px; }

/* ğŸ•¹ï¸ æ§åˆ¶å°æŒ‰é’®ç»„ */
.gallery-console {
    display: flex; gap: 15px; padding: 25px 20px;
}
.console-btn-luxe {
    flex: 1; height: 100px;
    background: #fff; border-radius: 24px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 8px; border: 1px solid rgba(0,0,0,0.03);
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}
.console-btn-luxe:active { transform: scale(0.95); background: #f2f2f7; }
.console-btn-luxe svg { color: #007AFF; }
.console-btn-luxe span { font-size: 10px; font-weight: 800; letter-spacing: 1px; color: #1d1d1f; }

/* --- ğŸï¸ æ‹ç«‹å¾—ï¼šæè‡´è‰ºæœ¯ç”»æ¡† --- */
.ai-portrait-frame {
    width: 100%;
    aspect-ratio: 3 / 4;
    background: #ffffff; /* ç»å…¸ç›¸çº¸ç™½ */
    padding: 15px 15px 60px 15px; /* åº•éƒ¨ç•™ç™½ç”¨äºæ‰‹å†™ä½“ */
    border-radius: 4px; /* æ‹ç«‹å¾—é€šå¸¸æ˜¯å¾®åœ†è§’æˆ–ç›´è§’ */
    box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
    margin-bottom: 25px;
}

/* å†…éƒ¨çœŸæ­£çš„â€œåº•ç‰‡â€åŒºåŸŸ */
.ai-prose-overlay {
    width: 100%;
    height: 100%;
    background: #1a1a1a; /* åº•ç‰‡è‰² */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #fff;
    border-radius: 2px;
}

/* åº•éƒ¨æ‰‹å†™ä½“ä½ç½® */
.ai-portrait-frame::after {
    content: "POLAROID MOMENT";
    position: absolute;
    bottom: 20px;
    left: 0;
    width: 100%;
    text-align: center;
    font-family: 'Dancing Script', cursive; /* å»ºè®®åœ¨é¡¶éƒ¨å¯¼å…¥æ­¤å­—ä½“ */
    font-size: 18px;
    color: #333;
    opacity: 0.6;
}

/* --- ğŸ–¼ï¸ ç¼©ç•¥å›¾ï¼šè¿·ä½ æ‹ç«‹å¾—ç½‘æ ¼ --- */
.char-history-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* æ”¹ä¸º2åˆ—ï¼Œæ›´æœ‰æ’ç‰ˆæ„Ÿ */
    gap: 20px;
    padding: 20px;
}

.history-thumb {
    background: #fff;
    padding: 8px 8px 30px 8px; /* åº•éƒ¨ç•™ç™½å†™å­— */
    border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
    cursor: pointer;
    position: relative;
}

.history-thumb:hover { transform: rotate(-2deg) scale(1.05); }

.history-thumb-img {
    width: 100%;
    aspect-ratio: 1/1; /* ç¼©ç•¥å›¾ç”¨ 1:1 çš„å†…æ¡† */
    background: #eee;
    object-fit: cover;
    display: block;
}

/* ç¼©ç•¥å›¾ä¸‹æ–¹çš„å¾®å‹æè¿° */
.thumb-caption {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    font-size: 10px;
    color: #999;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºçœç•¥å· */
    text-align: center;
    font-style: italic;
}

/* ğŸŒ€ æ‰«æåŠ¨ç”» */
.scanning-line {
    position: absolute; top: 0; left: 0; width: 100%; height: 2px;
    background: #007AFF; box-shadow: 0 0 15px #007AFF;
    animation: scanMove 2s infinite linear;
    z-index: 10; display: none;
}
@keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
/* --- ğŸ­ Taçš„ç›¸å†Œï¼šæ²‰æµ¸å¼è‰ºæœ¯è§†ç•Œ (éš”ç¦»ä¿®æ­£ç‰ˆ) --- */
#modal-theirs-photo-detail {
    position: fixed !important; 
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000; /* é»‘è‰²åº•è‰²ï¼Œé˜²æ­¢é€å‡ºæ¡Œé¢ */
    z-index: 100000;  /* ğŸš¨ æå…¶é‡è¦ï¼šå¿…é¡»é«˜äºæ‰€æœ‰ä¸»é¡µç»„ä»¶ */
    display: none;
    flex-direction: column;
    overflow: hidden;
}

@keyframes theirsFadeIn {
    from { opacity: 0; transform: scale(1.1); }
    to { opacity: 1; transform: scale(1); }
}

/* é®ç½©å±‚èƒŒæ™¯ï¼šç¡®ä¿åªæ˜¾ç¤ºè§’è‰²çš„å…‰å½± */
.theirs-detail-bg-blur {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(50px) brightness(0.4); /* å¢åŠ æ¨¡ç³Šåº¦å’Œæš—åº¦ */
    z-index: 1;
}

/* æ»šåŠ¨åŒºåŸŸï¼šé¿å¼€é¡¶éƒ¨çŠ¶æ€æ å’Œåº•éƒ¨è¾“å…¥æ¡† */
.theirs-detail-scroller {
    position: relative;
    z-index: 10;
    flex: 1;
    overflow-y: auto;
    padding: 80px 20px 150px; /* ğŸš¨ å¢åŠ é—´è·ï¼Œç¡®ä¿å†…å®¹ä¸è¢«è¦†ç›– */
    -webkit-overflow-scrolling: touch;
}

/* ğŸš¨ ç‰©ç†ä¿®å¤ï¼šè¾“å…¥æ¡†ç½®é¡¶æ‚¬æµ® */
#modal-theirs-photo-detail .card-input-bar {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    z-index: 110000 !important; /* æ¯”è¯¦æƒ…é¡µæ›´é«˜ */
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(20px);
    padding: 15px 20px 35px !important;
    display: flex !important;
}

/* 3:4 æ–‡å­—å†™çœŸï¼šé«˜çº§çº¸è´¨æ„Ÿ */
.theirs-portrait-card {
    width: 100%;
    aspect-ratio: 3 / 4;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 24px;
    padding: 40px 30px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    position: relative;
}

.theirs-prose-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px;
    line-height: 2.2;
    color: #1d1d1f;
    font-style: italic;
    white-space: pre-wrap;
}

/* åº•éƒ¨äº¤äº’åŒºï¼šç™½è‰²åŠé€æ˜é®ç½© */
.theirs-interaction-pod {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 32px 32px 0 0;
    padding: 25px;
    margin-top: -30px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
}
/* --- ğŸ­ Taçš„ç›¸å†Œè¯¦æƒ…ï¼šæè‡´ç»“æ„ä¼˜åŒ– --- */

/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šå“ç‰ŒåŒ–æ¡£æ¡ˆç•Œé¢ --- */
#modal-footprints {
    position: fixed; inset: 0;
    background: #0c0c0c; /* æ›´æ·±é‚ƒçš„çº¯é»‘åº• */
    z-index: 16000; display: none;
    flex-direction: column;
    /* æ·»åŠ å¾®å¼±çš„æ•°ç å™ªç‚¹çº¹ç†ï¼Œå¢åŠ è´¨æ„Ÿ */
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
}

/* å¤´éƒ¨å“ç‰Œæ  */
.footprints-header {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 20px 25px;
    display: flex; justify-content: space-between; align-items: center;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
    z-index: 10;
}

.brand-title {
    font-family: 'Montserrat', sans-serif; /* å»ºè®®ç”¨æ— è¡¬çº¿ä½“å¢åŠ ç°ä»£æ„Ÿ */
    font-weight: 800; font-size: 16px; color: #fff;
    letter-spacing: 4px; text-transform: uppercase;
    display: flex; align-items: center; gap: 10px;
}
.brand-title::before {
    content: ""; display: block; width: 8px; height: 8px;
    background: #007AFF; border-radius: 50%; box-shadow: 0 0 10px #007AFF;
}

.close-archive-btn {
    font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.6);
    cursor: pointer; letter-spacing: 1px; padding: 10px;
    border: 1px solid rgba(255,255,255,0.2); border-radius: 20px;
    transition: all 0.3s;
}
.close-archive-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #fff; }

/* æ»šåŠ¨åŒºåŸŸä¸èƒ¶ç‰‡è½¨é“ */
.footprints-scroller {
    flex: 1; overflow-y: auto; padding: 100px 0 150px;
    /* ä¼˜åŒ–èƒ¶ç‰‡é½¿å­”è½¨é“ï¼šæ›´ç²¾è‡´ */
    background-image: 
        radial-gradient(circle, rgba(255,255,255,0.1) 30%, transparent 31%),
        radial-gradient(circle, rgba(255,255,255,0.1) 30%, transparent 31%);
    background-size: 16px 32px;
    background-position: 15px 0, calc(100% - 15px) 0;
    background-repeat: repeat-y;
    border-left: 1px solid rgba(255,255,255,0.05);
    border-right: 1px solid rgba(255,255,255,0.05);
    margin: 0 10px; /* è½¨é“å†…ç¼© */
}

/* æ¡£æ¡ˆå•å…ƒæ ¼ (æ–°çš„ AI æ€»ç»“æ ·å¼) */
.archive-cell {
    margin: 40px 35px; position: relative;
    background: rgba(20,20,20,0.8);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 25px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

/* å·¦ä¾§æ—¶é—´æˆ³ - ç§‘æŠ€æ„Ÿ */
.archive-timestamp {
    position: absolute; left: -55px; top: 20px;
    writing-mode: vertical-lr; transform: rotate(180deg);
    font-family: 'Courier New', monospace; font-size: 10px;
    color: #007AFF; letter-spacing: 3px; opacity: 0.8;
}

/* AI æ€»ç»“æ–‡æœ¬ */
.archive-summary-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.9);
    font-style: italic; text-align: justify;
}

/* åº•éƒ¨å“ç‰Œæ ‡è¯† */
.footprints-footer {
    position: absolute; bottom: 40px; width: 100%; text-align: center;
    font-family: monospace; font-size: 9px; color: rgba(255,255,255,0.3);
    letter-spacing: 6px; pointer-events: none;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
/* --- ğŸï¸ AI å¿ƒåƒåº•ç‰‡æ ·å¼ --- */

/* å¤ç”¨èƒ¶ç‰‡å¤–æ¡†ï¼Œå¢åŠ å†…éƒ¨å¸ƒå±€ */
.ai-visual-frame {
    background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 25px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.08);
}

/* å¢åŠ ä¸€ç‚¹åº•ç‰‡çš„é¢—ç²’è´¨æ„Ÿ */
.ai-visual-frame::before {
    content: ""; position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='[http://www.w3.org/2000/svg'%3E%3Cfilter](http://www.w3.org/2000/svg'%3E%3Cfilter) id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
    pointer-events: none;
    mix-blend-mode: overlay;
}

/* é¡¶éƒ¨å°å›¾æ ‡å’Œæ ‡é¢˜ */
.ai-visual-icon {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 20px; opacity: 0.6;
}
.ai-visual-icon span {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
}

/* AI ç”Ÿæˆçš„æ ¸å¿ƒæè¿°æ–‡å­— */
.ai-visual-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px; line-height: 1.6;
    color: rgba(255,255,255,0.9);
    text-align: center; font-style: italic;
    padding: 0 20px;
}
/* ğŸš¨ ç‰©ç†ä¿®æ­£ï¼šå¼ºåŠ›å‹ä½æ ‡é¢˜æ ï¼Œé¿å¼€çŠ¶æ€æ  */
#modal-footprints .footprints-header {
    /* å¢åŠ é¡¶éƒ¨é—´è·ï¼š65px æ˜¯é¿å¼€åˆ˜æµ·å±/çŠ¶æ€æ çš„é»„é‡‘é«˜åº¦ */
    padding-top: 65px !important; 
    height: auto !important;
    padding-bottom: 20px !important;
    background: linear-gradient(to bottom, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 70%, transparent 100%) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding-left: 25px !important;
    padding-right: 25px !important;
}

/* ä¿®æ­£å…³é—­æŒ‰é’®çš„å‚ç›´å¯¹é½ï¼Œç¡®ä¿å®ƒè·Ÿæ ‡é¢˜åœ¨ä¸€æ¡çº¿ä¸Š */
#modal-footprints .close-archive-btn {
    margin-top: 0 !important; 
    transform: translateY(0) !important;
}

/* ğŸš¨ é‡ç‚¹ï¼šèƒ¶ç‰‡å†…å®¹åŒºä¹Ÿå¿…é¡»åŒæ­¥ä¸‹ç§»ï¼Œå¦åˆ™ä¼šé’»åˆ°æ ‡é¢˜æ ä¸‹é¢ */
#modal-footprints .footprints-scroller {
    padding-top: 150px !important; /* ç¡®ä¿ç¬¬ä¸€æ ¼èƒ¶ç‰‡ä»æ ‡é¢˜ä¸‹æ–¹å¼€å§‹ */
}
/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šå“ç‰Œçº§ UI ä¿®æ­£ --- */

/* 1. é¡¶éƒ¨é¿è®©ç³»ç»ŸçŠ¶æ€æ  */
#modal-footprints .footprints-header {
    padding-top: 65px !important; /* å¼ºåˆ¶ä¸‹å‹ï¼Œé¿å¼€ç”µé‡å’Œæ—¶é—´ */
    background: linear-gradient(to bottom, #0c0c0c 80%, transparent) !important;
}

/* 2. æ—¶é—´è½´æ–‡å­—ï¼šç¾åŒ–ä¸ºè“è‰²éœ“è™¹åˆ»åº¦ */
.film-time-axis {
    position: absolute !important;
    left: 12px !important; /* é å·¦å¯¹é½ */
    top: 0 !important;
    font-family: 'Courier New', monospace !important;
    font-size: 12px !important;
    font-weight: 900 !important;
    color: #007AFF !important; /* ç»å…¸ iOS è“è‰² */
    text-shadow: 0 0 8px rgba(0,122,255,0.8) !important; /* å¢åŠ å‘å…‰æ„Ÿ */
    letter-spacing: 1px !important;
    opacity: 1 !important;
}

/* 3. èƒ¶ç‰‡å¡ç‰‡ï¼šå¼ºåˆ¶åµŒå…¥è½¨é“ä¸­å¿ƒ */
.film-frame {
    padding: 0 45px !important; /* å·¦å³ç•™å‡ºèƒ¶ç‰‡é½¿å­”çš„ä½ç½® */
    margin-bottom: 60px !important;
}

.ai-visual-frame {
    background: rgba(25, 25, 25, 0.95) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    padding: 30px 20px !important;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 10px 30px rgba(0,0,0,0.5) !important;
    width: 100% !important;
    position: relative !important;
}

/* 4. å¡ç‰‡å†…æ–‡å­—æè¿°ç¾åŒ– */
.ai-visual-text {
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 16px !important;
    line-height: 1.8 !important;
    color: #e5e5e5 !important;
    font-style: italic !important;
    text-align: justify !important;
    margin-top: 15px !important;
}

/* 5. é¡¶éƒ¨çš„ MEMORIZED TRACE è£…é¥° */
.ai-visual-icon {
    border-bottom: 1px solid rgba(0, 122, 255, 0.3) !important;
    padding-bottom: 10px !important;
    margin-bottom: 15px !important;
    justify-content: flex-start !important;
}

.ai-visual-icon span {
    color: #007AFF !important;
    font-size: 9px !important;
    font-weight: 800 !important;
    letter-spacing: 3px !important;
}
/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šä¼‘æ¯çŠ¶æ€ä¸“å±æ ·å¼ --- */

/* ä¼‘æ¯çŠ¶æ€çš„å¡ç‰‡ï¼šè‰²è°ƒæ›´æš—ï¼Œå¸¦ä¸€ç‚¹ç´«è‰²çš„æ¢¦å¹»æ„Ÿ */
.ai-visual-frame.resting-mode {
    background: linear-gradient(135deg, #0f0f12 0%, #050505 100%) !important;
    border: 1px dashed rgba(255, 255, 255, 0.05) !important; /* è™šçº¿è¾¹æ¡†è¡¨ç¤ºéæ´»è·ƒ */
    opacity: 0.7;
}

/* ä¼‘æ¯çŠ¶æ€çš„æ—¶é—´è½´ï¼šç°è‰²åˆ»åº¦ */
.resting-mode .film-time-axis {
    color: #8E8E93 !important;
    text-shadow: none !important;
}

/* ä¼‘æ¯çŠ¶æ€çš„æ ‡ç­¾ */
.resting-mode .ai-visual-icon span {
    color: #8E8E93 !important;
}

.resting-mode .ai-visual-icon svg {
    stroke: #8E8E93 !important;
}

/* ä¼‘æ¯çŠ¶æ€çš„æ–‡å­—ï¼šæ›´æ¨¡ç³Šã€æ›´è½»æŸ” */
.resting-mode .ai-visual-text {
    color: rgba(255, 255, 255, 0.4) !important;
    filter: blur(0.3px);
}
/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šå­˜æ¡£æŒ‰é’®ç¾åŒ– --- */

.footprints-header-btns {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* ä¿å­˜æŒ‰é’®ï¼šå¸¦å‘¼å¸æ„Ÿçš„è“è‰²è¾¹æ¡† */
.save-archive-btn {
    font-size: 10px;
    font-weight: 800;
    color: #007AFF;
    letter-spacing: 2px;
    padding: 8px 15px;
    border: 1px solid rgba(0,122,255,0.4);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.save-archive-btn.active {
    background: #007AFF;
    color: #fff;
    border-color: #007AFF;
    box-shadow: 0 0 15px rgba(0,122,255,0.4);
}

/* å­˜æ¡£æ ‡è®°ï¼šå¡ç‰‡å³ä¸Šè§’çš„å·²ä¿å­˜å›¾æ ‡ */
.saved-tag {
    position: absolute;
    top: 15px;
    right: 15px;
    opacity: 0.3;
}

/* =========================================================
   ğŸš¨ æ‹ç«‹å¾—å¼¹çª—ï¼šç‰©ç†éš”ç¦»å±‚ (è§£å†³é€è§†ä¸»é¡µé—®é¢˜)
   ========================================================= */

/* 1. å¤–å±‚å®¹å™¨ï¼šå…¨å±é»‘åº•ç£¨ç ‚ï¼ŒæŒ¡ä½åé¢ä¹±ä¸ƒå…«ç³Ÿçš„æ¡Œé¢ */
#modal-footprint-single-detail {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    
    /* ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ·±è‰²ä¸é€æ˜èƒŒæ™¯ï¼Œå½»åº•æŒ¡ä½ä¸»é¡µ */
    background: rgba(10, 10, 10, 0.95) !important; 
    backdrop-filter: blur(25px) !important; /* å¼ºåŠ›æ¨¡ç³ŠèƒŒæ™¯ */
    -webkit-backdrop-filter: blur(25px) !important;
    
    z-index: 999999 !important; /* ç»å¯¹æœ€é«˜å±‚çº§ */
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

/* æ¿€æ´»çŠ¶æ€ */
#modal-footprint-single-detail.active {
    display: flex !important;
    animation: fadeIn 0.4s ease-out;
}

/* 2. æ‹ç«‹å¾—æœ¬ä½“ï¼šä¼˜åŒ–è´¨æ„Ÿä¸æ¯”ä¾‹ */
.polaroid-detail-frame {
    /* ç‰©ç†å°ºå¯¸é”å®šï¼šæ›´åƒçœŸå®çš„ Fuji Instax å®½å¹… */
    width: 300px !important;
    height: auto !important; /* é«˜åº¦è‡ªé€‚åº”ï¼Œä¸å†å†™æ­» */
    min-height: 420px;
    
    padding: 16px 16px 70px 16px !important; /* åº•éƒ¨ç•™å‡ºå¤§ç‰‡ç©ºç™½ç»™ç­¾å */
    
    /* çº¸å¼ è´¨æ„Ÿï¼šæš–ç™½ + çº¹ç† */
    background-color: #fdfbf7 !important;
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    
    border-radius: 4px !important;
    box-shadow: 
        0 30px 80px rgba(0,0,0,0.6), /* æ·±é‚ƒæŠ•å½±ï¼Œåˆ¶é€ æ‚¬æµ®æ„Ÿ */
        inset 0 0 20px rgba(255,255,255,0.5);
    
    position: relative !important;
    display: flex !important;
    flex-direction: column;
    transform: rotate(-3deg); /* å¾®å¾®å€¾æ–œï¼Œæ›´æœ‰è‰ºæœ¯æ„Ÿ */
}

/* 3. å†…éƒ¨é»‘åº•ç‰‡åŒºï¼šå†…é™·æ•ˆæœ */
.polaroid-inner-content {
    width: 100% !important;
    aspect-ratio: 4/5 !important; /* ç»å…¸çš„åº•ç‰‡æ¯”ä¾‹ */
    background: #080808 !important;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); /* å†…é™·é˜´å½± */
    
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 25px;
    position: relative;
    overflow: hidden;
}

/* æ–‡å­—æ’ç‰ˆä¼˜åŒ– */
.polaroid-inner-content span {
    color: rgba(255,255,255,0.85);
    font-family: "Songti SC", serif; /* å®‹ä½“æ›´æœ‰è¯—æ„ */
    font-size: 15px;
    line-height: 1.8;
    text-align: justify;
    font-style: italic;
    letter-spacing: 0.5px;
    text-shadow: 0 0 5px rgba(255,255,255,0.2);
}

/* 4. åº•éƒ¨æ—¥æœŸï¼šæœºæ¢°æ‰“ç é£æ ¼ */
.polaroid-full-timestamp {
    position: absolute !important;
    bottom: 12px !important;
    left: 18px !important;
    
    font-family: 'Courier New', monospace !important; /* æ‰“å­—æœºå­—ä½“ */
    font-size: 9px !important;
    font-weight: 600 !important;
    letter-spacing: 1px !important;
    color: #a0a0a0 !important; /* æµ…ç°è‰²ï¼Œåƒå°ä¸Šå»çš„ */
    
    background: transparent !important; 
    padding: 0 !important;
    z-index: 50 !important;
    opacity: 0.8;
}

/* --- âœ¨ çƒ«é‡‘å‡çº§ï¼šé«˜äº®é“‚é‡‘é£æ ¼ --- */
.signature-img-wrapper {
    /* ... ä¿æŒå®½é«˜å’Œ mask å±æ€§ä¸å˜ ... */
    width: 100% !important;
    height: 100% !important;
    -webkit-mask-size: contain !important;
    mask-size: contain !important;
    -webkit-mask-repeat: no-repeat !important;
    mask-repeat: no-repeat !important;
    -webkit-mask-position: center bottom !important;
    mask-position: center bottom !important;

    /* ğŸš¨ è°ƒæ•´ï¼šåŠ æ·±é‡‘è‰²çš„å¯¹æ¯”åº¦ï¼Œè®©ç»†çº¿æ›´æ˜æ˜¾ */
    background: linear-gradient(
        120deg, 
        #8a6e2f 0%,     /* æš—é‡‘ */
        #eecfa1 25%,    /* äº®é‡‘ */
        #b38728 50%,    /* çº¯é‡‘ */
        #fbf5b7 75%,    /* é“‚é‡‘é«˜å…‰ */
        #8a6e2f 100%    /* æš—é‡‘ */
    ) !important;
    
    background-size: 200% 200% !important;
    animation: goldShimmer 4s linear infinite !important;
    
    /* ğŸš¨ å…³é”®ï¼šç»™ç»†çº¿åŠ ä¸€ç‚¹ç‚¹æŠ•å½±ï¼Œè®©å®ƒæµ®èµ·æ¥ */
    filter: drop-shadow(0 1px 0 rgba(0,0,0,0.5)); 
}

@keyframes sharpShine {
    0% { background-position: 200% 0%; }
    100% { background-position: -200% 0%; }
}

/* --- ğŸ–‹ï¸ Luna å®šåˆ¶ç­¾åä¸“ç”¨å®¹å™¨ --- */
.gold-signature-container {
    position: absolute !important;
    bottom: 15px !important; 
    right: 10px !important;
    
    /* é€‚é…è¿™ä¸ªæ–°ç­¾åçš„å®Œç¾æ¯”ä¾‹ */
    width: 240px !important; 
    height: 96px !important;
    
    z-index: 100 !important;
    pointer-events: none;
    
    /* å¾®å¾®å€¾æ–œï¼Œæ¨¡æ‹Ÿæ‰‹å†™æ—¶çš„è‡ªç„¶è§’åº¦ï¼Œéå¸¸æ½‡æ´’ */
    transform: rotate(-4deg) !important; 
    
    display: flex;
    align-items: center;
    justify-content: center;
}

/* å…³é—­æç¤º */
.close-hint-text {
    margin-top: 40px;
    color: rgba(255,255,255,0.4);
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-weight: 700;
}
/* --- ğŸ“‚ å¾€æœŸæ¡£æ¡ˆå…¥å£æŒ‰é’®åŒºåŸŸ --- */
.history-access-zone {
    padding: 40px 35px 120px 35px; /* åº•éƒ¨ç•™è¶³ç©ºé—´ï¼Œé˜²æ­¢è¢« Footer é®æŒ¡ */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    opacity: 0;
    animation: fadeInUp 0.8s ease forwards 0.5s; /* å»¶è¿Ÿå‡ºç°ï¼Œå¢åŠ æœŸå¾…æ„Ÿ */
}

.btn-history-trigger {
    width: 100%;
    padding: 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.8);
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
}

.btn-history-trigger:active {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(0.97);
}

/* æŒ‰é’®å†…çš„å°å›¾æ ‡ */
.btn-history-trigger svg {
    width: 16px;
    height: 16px;
    opacity: 0.7;
}

/* åˆ†å‰²çº¿è£…é¥° */
.history-divider {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.2);
    letter-spacing: 4px;
    font-weight: 900;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ³ï¸ ç™½å¤œé•¿å·ï¼šæè‡´æç®€ç¾å­¦ --- */

/* æ—¶é—´è½´å®¹å™¨ */
.white-timeline {
    padding: 10px 20px 100px 20px;
    position: relative;
    /* å·¦ä¾§è´¯ç©¿çš„ä¸€æ¡æç»†é“¶çº¿ */
    border-left: 1px solid rgba(0,0,0,0.06);
    margin-left: 30px;
}

/* æ¯ä¸€å¤©çš„å¡ç‰‡å®¹å™¨ */
.white-day-card {
    position: relative;
    margin-bottom: 40px;
    padding-left: 25px; /* ç»™å·¦ä¾§çš„æ—¶é—´ç‚¹ç•™ä½ç½® */
    animation: fadeSlideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    opacity: 0;
    transform: translateY(20px);
}

/* å·¦ä¾§çš„æ—¶é—´èŠ‚ç‚¹ï¼ˆåœ†ç‚¹ï¼‰ */
.white-day-card::before {
    content: "";
    position: absolute;
    left: -5px; /* æ­£å¥½å‹åœ¨å·¦ä¾§é“¶çº¿ä¸Š */
    top: 25px;
    width: 9px;
    height: 9px;
    background: #fff;
    border: 2px solid #1d1d1f; /* é»‘åœˆç™½å¿ƒ */
    border-radius: 50%;
    z-index: 2;
}

/* å¡ç‰‡æœ¬ä½“ï¼šåƒä¸€å¼ ç²¾è‡´çš„ä¿¡çº¸ */
.day-card-inner {
    background: #ffffff;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 
        0 10px 30px rgba(0,0,0,0.03), /* ææ·¡çš„å¼¥æ•£é˜´å½± */
        0 1px 3px rgba(0,0,0,0.02);
    border: 1px solid rgba(0,0,0,0.02);
    cursor: pointer;
    transition: all 0.3s ease;
}

/* æ‚¬åœ/ç‚¹å‡»åé¦ˆï¼šè½»å¾®ä¸Šæµ® */
.day-card-inner:active {
    transform: translateY(-2px) scale(0.98);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

/* æ—¥æœŸæ’ç‰ˆ */
.day-meta-date {
    font-family: 'Cormorant Garamond', serif;
    font-size: 28px;
    font-weight: 500; /* ç»†å­—ä½“æ›´ä¼˜é›… */
    color: #1d1d1f;
    line-height: 1;
    margin-bottom: 5px;
}

.day-meta-month {
    font-size: 10px;
    font-weight: 700;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 20px;
}

/* æ‘˜è¦æ–‡å­— */
.day-summary-preview {
    font-family: "Songti SC", serif; /* å®‹ä½“ */
    font-size: 14px;
    line-height: 1.8;
    color: #555;
    /* é™åˆ¶æ˜¾ç¤º 2 è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* åº•éƒ¨çŠ¶æ€æ  */
.day-footer {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px dashed #eee; /* è™šçº¿åˆ†å‰² */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.day-status-pill {
    font-size: 9px;
    color: #1d1d1f;
    background: #f2f2f7;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 600;
}

.view-btn-text {
    font-size: 11px;
    color: #007AFF; /* iOS è“ç‚¹ç¼€ */
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
}

@keyframes fadeSlideUp {
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ“‚ å¾€æœŸæ¡£æ¡ˆåº“ï¼šç‰©ç†å±‚çº§ä¿®æ­£è¡¥ä¸ --- */
#subpage-history-vault {
    /* 1. å¼ºåˆ¶å›ºå®šå®šä½ï¼Œè„±ç¦»æ–‡æ¡£æµ */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    
    /* 2. çº¯ç™½èƒŒæ™¯ï¼Œé˜²æ­¢é€è‰² */
    background: #ffffff !important;
    
    /* 3. ğŸš¨ æ ¸å¿ƒï¼šå±‚çº§å¿…é¡»é«˜äº #modal-footprints (16000) */
    z-index: 50000 !important; 
    
    /* 4. åˆå§‹çŠ¶æ€ï¼šéšè—åœ¨å³ä¾§ */
    display: none; /* é»˜è®¤ä¸æ˜¾ç¤º */
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

/* æ¿€æ´»çŠ¶æ€ */
#subpage-history-vault.active {
    display: flex !important; /* å¼ºåˆ¶å˜æˆ Flex å¸ƒå±€ */
    flex-direction: column !important;
    transform: translateX(0) !important; /* æ»‘å…¥å±å¹• */
}
/* --- ğŸ“¡ åŒæ­¥æŒ‰é’®ï¼šä¿¡å·æ‰«æç‰¹æ•ˆ --- */
.btn-history-trigger {
    position: relative;
    overflow: hidden;
    /* å¢åŠ è¿‡æ¸¡æ•ˆæœï¼Œè®©å˜è‰²æ›´ä¸æ»‘ */
    transition: all 0.3s ease;
}

/* æ¿€æ´»æ‰«æçŠ¶æ€ */
.btn-history-trigger.syncing {
    background: rgba(0, 122, 255, 0.1) !important;
    color: #007AFF !important;
    border-color: #007AFF !important;
    pointer-events: none; /* ç¦æ­¢é‡å¤ç‚¹å‡» */
}

/* æ‰«æå…‰æ³¢ */
.btn-history-trigger.syncing::after {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    /* è“è‰²çš„æ‰«æå…‰æŸ */
    background: linear-gradient(
        90deg, 
        transparent 0%, 
        rgba(0, 122, 255, 0.2) 50%, 
        transparent 100%
    );
    animation: syncScan 1.5s infinite linear;
}

@keyframes syncScan {
    from { transform: translateX(0); }
    to { transform: translateX(100%); }
}

/* èƒ¶ç‰‡æ’å…¥åŠ¨ç”»ï¼šæ–°ç”Ÿæˆçš„èƒ¶ç‰‡ä¼šä»åº•éƒ¨å¼¹ä¸Šæ¥ */
@keyframes slideInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}
.film-frame.new-entry {
    animation: slideInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}
/* --- ğŸ“– ç™½æ˜¼Â·å…‰å° (Archive Reader) --- */

/* 2. ç™½æ˜¼Â·å…‰å° (è¯¦æƒ…é˜…è¯»å™¨) - å¿…é¡»ç‰©ç†å‹åˆ¶åˆ—è¡¨é¡µ */
#subpage-archive-reader {
    z-index: 60000 !important; /* ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè°ƒé«˜åˆ° 60000 */
    background: #ffffff !important; /* ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
    display: none;
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
}

#subpage-archive-reader.active {
    transform: translateX(0);
}

.archive-body-scroller {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 20px 30px 100px 30px; /* ç•™è¶³å‘¼å¸æ„Ÿ */
}

/* 1. åˆŠå¤´è®¾è®¡ */
.archive-magazine-header {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    margin-top: 20px;
}
.archive-date-big {
    font-family: 'Cormorant Garamond', serif;
    font-size: 80px;
    line-height: 0.8;
    font-weight: 300;
    color: #1d1d1f;
    margin-right: 15px;
}
.archive-date-meta {
    display: flex;
    flex-direction: column;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 3px;
    color: #8E8E93;
    border-left: 2px solid #1d1d1f;
    padding-left: 10px;
    height: 40px;
    justify-content: center;
}

/* 2. AI æ‘˜è¦åŒº */
.archive-ai-summary {
    position: relative;
    padding: 0 10px;
    margin-bottom: 40px;
}
.summary-quote-icon {
    font-family: serif;
    font-size: 60px;
    color: #f2f2f7;
    position: absolute;
    top: -30px; left: -20px;
    z-index: 0;
}
.summary-text-content {
    position: relative;
    z-index: 1;
    font-family: "Songti SC", serif; /* å®‹ä½“ */
    font-size: 16px;
    line-height: 1.8;
    color: #444;
    font-style: italic;
}

.archive-divider-line {
    width: 100%;
    height: 1px;
    background: #eee;
    margin-bottom: 40px;
}

/* 3. é»‘è‰²èƒ¶ç‰‡å—åˆ—è¡¨ */
.archive-timeline-box {
    border-left: 1px solid #e5e5ea;
    padding-left: 25px;
    margin-left: 10px;
}

.archive-film-item {
    position: relative;
    margin-bottom: 35px;
    cursor: pointer;
}

/* å·¦ä¾§æ—¶é—´ç‚¹ */
.archive-film-item::before {
    content: "";
    position: absolute;
    left: -30px; top: 18px;
    width: 9px; height: 9px;
    background: #1d1d1f;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px #e5e5ea;
}

.archive-time-label {
    font-family: 'Courier New', monospace;
    font-size: 11px;
    color: #8E8E93;
    font-weight: 700;
    margin-bottom: 8px;
    display: block;
}

/* é»‘è‰²èƒ¶ç‰‡æœ¬ä½“ */
.black-film-strip {
    background: #000;
    color: #fff;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    position: relative;
    overflow: hidden;
}
.black-film-strip:active {
    transform: scale(0.98);
}

/* èƒ¶ç‰‡æ–‡å­— */
.film-text-preview {
    font-size: 13px;
    line-height: 1.6;
    color: rgba(255,255,255,0.9);
    display: -webkit-box;
    -webkit-line-clamp: 2; /* æœ€å¤šæ˜¾ç¤º2è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* 4. åº•éƒ¨å°ç«  */
.archive-footer-seal {
    margin-top: 60px;
    display: flex;
    justify-content: center;
    opacity: 0.6;
}
.seal-box {
    border: 2px solid #d4af37; /* çƒ«é‡‘è‰² */
    color: #d4af37;
    padding: 10px 20px;
    text-align: center;
    transform: rotate(-5deg);
    border-radius: 4px;
    display: flex;
    flex-direction: column;
}
/* =========================================================
   ğŸš¨ ç‰©ç†é”æ­»è¡¥ä¸ï¼šå¤§å›¾å›ºå®š + ä»…è¯„è®ºåŒºæ»‘åŠ¨
   ========================================================= */

/* 1. å½»åº•ç¦ç”¨å¤–å±‚å®¹å™¨çš„æ»šåŠ¨ï¼Œé˜²æ­¢æ•´ä½“ä½ç§» */
#modal-theirs-photo-detail .theirs-detail-scroller {
    display: flex !important;
    flex-direction: column !important;
    height: 100vh !important; /* é”å®šè§†å£é«˜åº¦ */
    overflow-y: hidden !important; /* ğŸš¨ ç‰©ç†ç¦æ­¢æ•´ä½“æ»‘åŠ¨ */
    padding: 0 !important;
}

/* 2. é¡¶éƒ¨å¤§å›¾å¡ç‰‡ï¼šç‰©ç†å®šæ ¼ */
#modal-theirs-photo-detail .theirs-portrait-card {
    width: calc(100% - 40px) !important;
    margin: 80px 20px 0 20px !important; /* é¿å¼€é¡¶éƒ¨çŠ¶æ€æ  */
    aspect-ratio: 3 / 4 !important; 
    flex-shrink: 0 !important; /* ğŸš¨ ç¦æ­¢è¢«æŒ¤å‹ */
    z-index: 10 !important;
    position: relative !important;
}

/* 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¯„è®ºé¢æ¿ï¼šå¼€å¯ç‹¬ç«‹æ»‘åŠ¨å¼•æ“ */
#modal-theirs-photo-detail .theirs-interaction-pod {
    margin-top: -30px !important; /* ä¿æŒä¸å¤§å›¾çš„é‡å ç¾æ„Ÿ */
    padding: 40px 25px 120px 25px !important; /* åº•éƒ¨ç•™ç™½ç»™è¾“å…¥æ¡† */
    
    background: rgba(255, 255, 255, 0.98) !important;
    border-radius: 32px 32px 0 0 !important;
    box-shadow: 0 -15px 30px rgba(0,0,0,0.2) !important;

    /* ğŸš¨ ç‹¬ç«‹æ»‘åŠ¨æ ¸å¿ƒæŒ‡ä»¤ */
    flex: 1 !important; /* å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
    overflow-y: auto !important; /* ğŸš¨ å…è®¸å†…éƒ¨æ»‘åŠ¨ */
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨åè®® */
}

/* 4. å¼ºåˆ¶éšè—è¯„è®ºåŒºå†…å¯èƒ½å†²çªçš„æ»šåŠ¨æ¡ï¼Œä¿æŒæè‡´ç®€æ´ */
#modal-theirs-photo-detail .theirs-interaction-pod::-webkit-scrollbar {
    display: none;
}

/* 5. ç¡®ä¿è¯„è®ºåˆ—è¡¨å†…å®¹ä¸è¢«æˆªæ–­ */
#modal-theirs-photo-detail #theirs-comments-list {
    display: block !important;
    height: auto !important;
    padding-bottom: 20px;
}

/* 6. è¿”å›æŒ‰é’®ï¼šç‰©ç†ç½®é¡¶ï¼Œä¸éšæ»‘åŠ¨æ¶ˆå¤± */
#modal-theirs-photo-detail .card-header-tools {
    position: fixed !important;
    top: 55px !important;
    left: 20px !important;
    z-index: 120000 !important;
}
/* --- ğŸï¸ å†å²ç¼©ç•¥å›¾æ—¶é—´è½´æ ‡ç­¾æ ·å¼ --- */
.history-thumb {
    /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œç»™æ—¥æœŸç•™ä½å­ */
    padding: 22px 8px 30px 8px !important; 
    position: relative;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.05);
}

.thumb-date-tag {
    position: absolute;
    top: 6px;
    left: 8px;
    
    /* æè‡´é«˜çº§æ„Ÿï¼šçª„é—´è·ç­‰å®½å­—ä½“ */
    font-family: "Courier New", Courier, monospace;
    font-size: 8px;
    font-weight: 900;
    color: #007AFF; /* è“è‰²ç‚¹ç¼€ï¼Œå‘¼åº”ç³»ç»Ÿè‰² */
    letter-spacing: 1px;
    
    /* æ¨¡æ‹Ÿæ‰“ç æ•ˆæœ */
    opacity: 0.8;
}

/* è°ƒæ•´ç¼©ç•¥å›¾å›¾ç‰‡çš„æ¯”ä¾‹ï¼Œç¡®ä¿æ—¥æœŸä¸é®æŒ¡å›¾ç‰‡å†…å®¹ */
.history-thumb-img {
    border: 0.5px solid rgba(0,0,0,0.05);
    border-radius: 1px;
}
/* =========================================================
   ğŸ–‹ï¸ è§’è‰²æ¡£æ¡ˆå·é¦–è¯­ï¼šé«˜çº§å™äº‹æ„Ÿè£…ä¿®
   ========================================================= */
.header-char-bio {
    /* 1. å­—ä½“ä¸æ’ç‰ˆï¼šè¥é€ é«˜çº§å™äº‹æ„Ÿ */
    /* ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„é«˜çº§è¡¬çº¿ä½“ï¼Œæ²¡æœ‰åˆ™å›é€€åˆ°é€šç”¨è¡¬çº¿ä½“ */
    font-family: -apple-system-ui-serif, ui-serif, "Cormorant Garamond", Georgia, serif;
    font-size: 15px; /* å­—å·é€‚ä¸­ï¼Œæ˜¾ç²¾è‡´ */
    font-weight: 500;
    font-style: italic; /* æ–œä½“å¢åŠ æ–‡å­¦æ„Ÿ */
    color: #4a4a4a; /* æ·±ç°è€Œéçº¯é»‘ï¼Œæ›´æŸ”å’Œ */
    
    text-align: center;
    letter-spacing: 0.8px; /* å¢åŠ å­—é—´è·ï¼Œé€æ°”æ„Ÿ */
    line-height: 1.5;

    /* 2. å®¹å™¨è£…é¥°ï¼šå¾®å¦™çš„å…‰å½±èˆå° */
    margin: 12px auto 24px auto; /* ä¸Šä¸‹ç•™ç™½ */
    padding: 14px 24px;
    max-width: 85%; /* é™åˆ¶å®½åº¦ï¼Œè®©æ–‡å­—æ›´ç´§å‡‘ */
    
    /* æå¾®å¦™çš„çºµå‘æ¸å˜èƒŒæ™¯ï¼Œåƒä¸€å¼ æ—§çº¸ */
    background: linear-gradient(to bottom, rgba(0,0,0,0.01), rgba(0,0,0,0.03));
    /* é¡¶éƒ¨å’Œåº•éƒ¨çš„æç»†è£…é¥°çº¿ */
    border-top: 0.5px solid rgba(0,0,0,0.04);
    border-bottom: 0.5px solid rgba(0,0,0,0.06);
    border-radius: 4px;

    /* 3. çŠ¶æ€ä¸è¿‡æ¸¡ */
    min-height: 40px; /* å ä½é«˜åº¦ï¼Œé˜²æ­¢ç”Ÿæˆæ—¶é¡µé¢æŠ–åŠ¨ */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.5s ease;
}

/* åŠ è½½æ—¶çš„å ä½ç¬¦åŠ¨ç”»æ•ˆæœ */
.bio-scanning {
    font-family: monospace; /*åŠ è½½æ—¶ç”¨ç­‰å®½å­—ä½“ï¼Œæ˜¾ç§‘æŠ€æ„Ÿ*/
    font-size: 12px;
    font-style: normal;
    color: #999;
    display: flex;
    align-items: center;
    gap: 6px;
}
.bio-scanning::before {
    content: "";
    display: block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #007AFF;
    animation: pulse 1s infinite alternate;
}
@keyframes pulse { from { opacity: 0.3; transform: scale(0.8); } to { opacity: 1; transform: scale(1.1); } }
/* ä¸“é—¨ç»™æˆªå›¾å®¹å™¨ç”¨çš„è¡¥ä¸ */
#screenshot-temp-container .message-content {
    /* ç¡®ä¿åŒè¯­æ–‡æœ¬éƒ½èƒ½å¼ºåˆ¶æ¢è¡Œï¼Œä¸ä¼šæ’‘ç ´å›¾ç‰‡å®½åº¦ */
    word-break: break-word;
    white-space: pre-wrap;
}

/* å¦‚æœä½ çš„åŒè¯­æ˜¯ flex å¸ƒå±€ï¼Œç¡®ä¿æˆªå›¾æ—¶ä¾ç„¶ä¿æŒ */
#screenshot-temp-container .bilingual-row {
    display: block !important; /* æˆ–è€… keep flex */
}

/* ğŸš¨ ç¼©ç•¥å›¾ï¼šé•¿æˆªå›¾ä¸“å±æ ·å¼ */
.photo-item.is-snapshot-item {
    background: #1c1c1e !important; /* æ·±è‰²èƒŒæ™¯ï¼Œåƒç”µå½±èƒ¶ç‰‡ */
    border: 1px solid rgba(255,255,255,0.1);
}

.photo-item.is-snapshot-item img {
    object-fit: contain !important; /* æ ¸å¿ƒï¼šä¸å‰ªè£ï¼Œå®Œæ•´æ˜¾ç¤ºé•¿å›¾ */
    padding: 2px;
}

/* è“è‰²ä¸­æ–‡æ ‡ç­¾ */
.snap-badge {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: #007AFF;
    color: white;
    font-size: 8px;
    padding: 2px 5px;
    border-radius: 3px;
    font-weight: bold;
    z-index: 10;
}
/* å›¾ç‰‡ç½‘æ ¼å®¹å™¨ */
.photo-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* ä¸€è¡Œä¸¤ä¸ªï¼Œé«˜çº§æ„Ÿ */
    gap: 15px;
    padding: 15px;
}

/* æ¯ä¸€ä¸ªå›¾ç‰‡å¡ç‰‡ */
.photo-card {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.photo-card:active {
    transform: scale(0.95); /* ç‚¹å‡»æ—¶çš„ç¼©æ”¾æ•ˆæœ */
}

/* å›¾ç‰‡æœ¬èº« */
.photo-card img {
    width: 100%;
    height: 200px; /* å›ºå®šé«˜åº¦ï¼Œç»Ÿä¸€æ•´é½ */
    object-fit: cover; /* è‡ªåŠ¨è£å‰ªå¡«å…… */
    display: block;
}

/* åˆ é™¤æŒ‰é’® - æ‚¬æµ®åœ¨å³ä¸Šè§’ */
.photo-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: rgba(255, 59, 48, 0.9); /* iOS è­¦ç¤ºçº¢ */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    z-index: 10;
    border: none;
}

/* æ—¶é—´æ ‡ç­¾ */
.photo-time-tag {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.6));
    color: white;
    font-size: 10px;
    padding: 10px 8px 5px;
    text-align: left;
}
/* å…¨å±é®ç½© */
#snapshot-fullscreen-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000; /* çº¯é»‘åº•è‰² */
}

#snapshot-fullscreen-overlay.active {
    opacity: 1;
}

/* æ¯›ç»ç’ƒèƒŒæ™¯å±‚ */
.ins-glass-blur {
    position: absolute;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

/* é¢„è§ˆå®¹å™¨ */
.snap-preview-container {
    position: relative;
    width: 90%;
    max-width: 400px;
    height: 80vh;
    display: flex;
    flex-direction: column;
    animation: snapSlideUp 0.4s cubic-bezier(0.2, 1, 0.3, 1);
}

@keyframes snapSlideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* é¡¶éƒ¨æ“ä½œæ  */
.snap-top-bar {
    display: flex;
    justify-content: space-between;
    padding: 15px 5px;
    color: #fff;
}

.snap-action-btn {
    background: none; border: none;
    color: #fff; display: flex; align-items: center; gap: 6px;
    font-size: 14px; font-family: 'Montserrat', sans-serif;
    letter-spacing: 1px; opacity: 0.8;
}

.snap-action-btn.delete-btn { color: #ff3b30; } /* å”¯ä¸€çš„ä¸€æŠ¹çº¢ï¼Œè­¦ç¤ºæ„Ÿ */

/* å›¾ç‰‡åŒ…è£…å™¨ - å…³é”®åœ¨äºè¿™é‡Œçš„é»‘ç™½è‰ºæœ¯æ„Ÿ */
.snap-content-wrapper {
    flex: 1;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,0.1);
    background: #111;
    border-radius: 4px;
    padding: 10px;
}

.snap-main-img {
    width: 100%;
    height: auto;
    display: block;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* åº•éƒ¨æ–‡æ¡ˆ */
.snap-bottom-info {
    padding: 20px 0;
    text-align: center;
    color: #fff;
    border-top: 1px solid rgba(255,255,255,0.05);
}

.snap-label { font-size: 10px; letter-spacing: 4px; opacity: 0.4; margin-bottom: 5px; }
.snap-date { font-family: 'Cinzel', serif; font-size: 16px; font-weight: 700; }
/* Action Sheet å®¹å™¨ */
#custom-action-sheet {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 11000; /* å¿…é¡»é«˜äºé¢„è§ˆå±‚çš„ 10000 */
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    visibility: hidden;
}

#custom-action-sheet.active {
    visibility: visible;
}

/* åŠé€æ˜é®ç½© - è°ƒæµ…äº†é¢œè‰² */
.sheet-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.2); 
    opacity: 0;
    transition: opacity 0.3s ease;
}

#custom-action-sheet.active .sheet-overlay {
    opacity: 1;
}

/* å†…å®¹é¢æ¿ - æ”¹ä¸ºçº¯ç™½è‰² */
.sheet-content {
    position: relative;
    background: #ffffff; 
    border-radius: 20px 20px 0 0;
    padding: 20px 16px calc(20px + env(safe-area-inset-bottom));
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    border-top: 1px solid rgba(0,0,0,0.05);
}

#custom-action-sheet.active .sheet-content {
    transform: translateY(0);
}

/* å¤´éƒ¨æ–‡æ¡ˆ - æ”¹ä¸ºæ·±ç°è‰² */
.sheet-header {
    text-align: center;
    color: rgba(0, 0, 0, 0.4); 
    font-size: 13px;
    margin-bottom: 20px;
    letter-spacing: 1px;
    font-family: 'Montserrat', sans-serif;
}

/* æŒ‰é’®é€šç”¨æ ·å¼ */
.sheet-btn {
    width: 100%;
    height: 56px;
    border-radius: 14px;
    border: none;
    font-size: 17px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

/* ä¸¢å¼ƒæŒ‰é’® - æ”¹ä¸ºçº¯é»‘èƒŒæ™¯/ç™½è‰²æ–‡å­— */
.sheet-btn.destructive {
    background: #000000; 
    color: #fff;
    margin-bottom: 8px;
}

.sheet-btn.destructive:active {
    background: #333333;
}

/* å–æ¶ˆæŒ‰é’® - æ”¹ä¸ºæµ…ç°èƒŒæ™¯/é»‘è‰²æ–‡å­— */
.sheet-btn.cancel {
    background: #f2f2f7; 
    color: #000;
}

.sheet-btn.cancel:active {
    background: #e5e5ea;
}

.sheet-gap {
    height: 8px;
}
/* æ¯æ—¥çŠ¶æ€æµå®¹å™¨ */
.daily-status-container { padding: 0 20px; margin-top: 15px; }
.status-flow-list { display: flex; flex-direction: column; gap: 25px; padding-bottom: 50px; }

/* æç®€ç™½é‡‘å¡ç‰‡ */
.status-day-card {
    display: flex; gap: 12px;
    animation: slideInRight 0.5s cubic-bezier(0.1, 0.9, 0.2, 1);
}

.card-date-side { display: flex; flex-direction: column; align-items: center; min-width: 40px; }
.card-date-side .day { font-family: 'Cinzel', serif; font-size: 26px; font-weight: 700; color: #1a1a1a; }
.card-date-side .month { font-size: 9px; letter-spacing: 2px; color: #999; transform: rotate(-90deg) translateX(-10px); margin-top: 10px; }

.card-main-content {
    flex: 1; background: #ffffff; border-radius: 20px; overflow: hidden;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.03); /* æè½»çš„æŠ•å½±ï¼Œåç™½é£æ ¼ */
    border: 1px solid rgba(0, 0, 0, 0.04);
}

.status-img-wrapper { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #fdfdfd; }
.status-img-wrapper img { width: 100%; height: 100%; object-fit: cover; filter: saturate(0.8) contrast(1.05); }
.img-overlay-soft { position: absolute; inset: 0; background: linear-gradient(to top, rgba(255,255,255,0.4), transparent); }

.snap-type-tag {
    position: absolute; top: 15px; right: 15px;
    background: #000; color: #fff; padding: 3px 8px;
    font-size: 8px; font-weight: 800; letter-spacing: 1px; border-radius: 2px;
}

.status-text-area { padding: 15px 20px; }
.status-mood { font-size: 10px; color: #aaa; letter-spacing: 1px; margin-bottom: 6px; font-family: 'Montserrat', sans-serif; font-weight: 600; }
.status-brief { font-size: 14px; color: #222; line-height: 1.6; font-weight: 400; margin: 0; }

@keyframes slideInRight { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
/* å¼ºåˆ¶å°é¢å›¾çš„æ¯”ä¾‹ï¼Œä¿æŒæ•´é½ */
.status-reflect-img {
    aspect-ratio: 16 / 9;
    object-fit: cover;
    filter: grayscale(1) contrast(1.1); /* å°é¢å›¾ä¿æŒé«˜çº§é»‘ç™½ */
}

.status-day-card:hover .status-reflect-img {
    filter: grayscale(0) contrast(1); /* é¼ æ ‡æ‚¬æµ®æ¢å¤å½©è‰²ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
}

/* è¯¦æƒ…é¡µå…¥å£æç¤ºæ„Ÿ */
.tap-hint {
    margin-top: 12px;
    font-size: 9px;
    letter-spacing: 1px;
    color: #000;
    font-weight: 800;
    text-align: right;
    text-decoration: underline;
    text-underline-offset: 4px;
    opacity: 0.3;
}

/* å¡ç‰‡ç‚¹å‡»æ€ */
.status-day-card:active {
    transform: translateY(2px) scale(0.98);
}
/* å…¨å±é®ç½© */
.reflection-overlay {
    position: fixed;
    inset: 0; z-index: 12000;
    visibility: hidden; opacity: 0;
    transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1);
}
.reflection-overlay.active { visibility: visible; opacity: 1; }

.reflection-glass-bg {
    position: absolute; inset: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
}

.reflection-wrapper {
    position: relative; width: 100%; height: 100%;
    display: flex; flex-direction: column;
}

/* å…¨å±å®¹å™¨ï¼šè§£å†³é«˜åº¦ä¸å¯¹çš„é—®é¢˜ */
.daily-collection-overlay {
    position: fixed;
    inset: 0;
    z-index: 15000;
    background: #fff;
    visibility: hidden;
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column; /* å‚ç›´æ’å¸ƒ */
}

.daily-collection-overlay.active {
    visibility: visible;
    opacity: 1;
}

/* é¡¶éƒ¨å¯¼èˆªï¼šç²¾è‡´ç•™ç™½ */
.collection-nav {
    height: 100px;
    padding: 40px 25px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    z-index: 10;
}

.nav-main-title { font-family: 'Cinzel', serif; font-size: 14px; font-weight: 900; letter-spacing: 4px; color: #000; }
.nav-sub-date { font-size: 10px; color: #bbb; letter-spacing: 2px; margin-top: 4px; text-align: center; }

/* æ»šåŠ¨åŒºåŸŸï¼šè‡ªåŠ¨å¡«æ»¡å‰©ä½™é«˜åº¦ */
.collection-scroll-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px 25px 100px;
    -webkit-overflow-scrolling: touch;
}

/* å¢åŠ å¡ç‰‡ä¸‹æ–¹çš„ç•™ç™½ï¼Œé˜²æ­¢é•¿å›¾å †å å¤ªç´§ */
.text-vibe-card {
    min-height: 200px; /* è®¾ç½®æœ€å°é«˜åº¦ */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* æ¯ä¸€å¼ çš„åºå·æ°´å° */
.vibe-card-no {
    position: absolute;
    top: 20px;
    right: 25px;
    font-family: 'Cinzel', serif;
    font-size: 40px;
    font-weight: 900;
    color: rgba(0,0,0,0.03);
    line-height: 1;
}

/* æ–‡å­—å›¾å†…çš„æ’ç‰ˆ */
.vibe-card-header {
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.char-badge {
    background: #000;
    color: #fff;
    font-size: 9px;
    padding: 2px 8px;
    font-weight: 700;
    letter-spacing: 1px;
}

.vibe-time { font-size: 10px; color: #ccc; letter-spacing: 1px; }

/* ä¿®æ”¹å¡ç‰‡å†…çš„æ–‡æ¡ˆæ’ç‰ˆ */
.vibe-content-prose {
    font-size: 16px; /* å­—æ•°å¤šæ—¶ï¼Œç¨å¾®è°ƒå°å­—å·ï¼Œæ›´æœ‰å‘¼å¸æ„Ÿ */
    line-height: 2;   /* å¢åŠ è¡Œé«˜ï¼Œè®©é•¿æ–‡æ¡ˆä¸æ‹¥æŒ¤ */
    color: #333;
    font-family: 'Montserrat', sans-serif;
    font-weight: 400;
    font-style: italic;
    margin: 0;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½ï¼Œåƒä¹¦é¡µä¸€æ ·æ•´é½ */
    letter-spacing: 0.5px;
}

.vibe-content-prose::first-letter {
    font-size: 24px;
    font-family: 'Cinzel', serif;
    margin-right: 5px;
}

/* åº•éƒ¨æƒ…ç»ªå‚æ•°çº¿ */
.vibe-card-footer {
    margin-top: 35px;
    padding-top: 20px;
    border-top: 0.5px solid #f5f5f5;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vibe-mood-tag { font-size: 10px; font-weight: 700; color: #000; letter-spacing: 1px; }

/* è¿›åœºåŠ¨ç”» */
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

.collection-footer-tag {
    padding-bottom: 30px;
    text-align: center;
    font-size: 8px;
    color: #ddd;
    letter-spacing: 3px;
}
/* éŸ³ä¹ App æ€»å®¹å™¨ */
.music-app-container {
    background: #ffffff !important;
    display: flex;
    flex-direction: column;
    z-index: 9999;
}

/* ğŸ› ï¸ å¤´éƒ¨ç˜¦èº«ï¼šå‹ç¼©çŠ¶æ€æ ä¸‹æ–¹çš„è·ç¦» */
.music-app-header {
    padding: 30px 20px 15px; /* é¡¶éƒ¨ä» 60px ç¼©å‡åˆ° 30px */
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    position: sticky; /* ä¿æŒå¸é¡¶ï¼Œå¢åŠ é«˜çº§æ„Ÿ */
    top: 0;
    z-index: 1000;
}

.header-main-title {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 13px;
    letter-spacing: 4px;
    color: #000;
}

/* ç»Ÿä¸€å›¾æ ‡æŒ‰é’®çš„å¤§å°å’Œå±…ä¸­ */
.header-side-btn {
    width: 32px; /* ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œæ›´æ˜¾ç²¾è‡´ */
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

/* è§†å›¾åŒºåŸŸ */
.music-view-viewport {
    flex: 1;
    position: relative;
    overflow: hidden;
}

.music-view-page {
    position: absolute;
    inset: 0;
    padding: 0 20px;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: scale(0.98);
    transition: all 0.5s cubic-bezier(0.2, 1, 0.3, 1);
}

.music-view-page.active {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
}

/* ğŸ’Š æ‚¬æµ®èƒ¶å›Šå¯¼èˆªæ  */
.music-navigation-bar {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    width: 320px;
    height: 60px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border-radius: 30px; /* è¶…å¤§åœ†è§’ */
    display: flex;
    align-items: center;
    padding: 6px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.03);
    z-index: 100;
}

.nav-capsule-item {
    flex: 1;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 25px;
    transition: all 0.4s ease;
    cursor: pointer;
}

.nav-capsule-item span {
    font-family: 'Montserrat', sans-serif;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 1px;
    color: #bbb;
}

/* æ¿€æ´»çŠ¶æ€ï¼šé»‘ç™½åè½¬ */
.nav-capsule-item.active {
    background: #000;
}

.nav-capsule-item.active span {
    color: #fff;
}
/* 1. ç­–å±•å¤´è®¾è®¡ */
.archive-curated-header { padding: 40px 0 30px; border-bottom: 0.5px solid #f0f0f0; margin-bottom: 30px; }
.header-main-info h1 { font-family: 'Cinzel', serif; font-size: 32px; letter-spacing: 8px; margin: 0; }
.vault-stats { font-size: 9px; color: #bbb; letter-spacing: 2px; margin-top: 10px; font-weight: 700; }
.archive-search-bar { margin-top: 25px; }
.archive-search-bar input {
    width: 100%; background: #f9f9f9; border: none; padding: 12px 20px;
    border-radius: 12px; font-size: 11px; letter-spacing: 1px; outline: none;
}

/* 2. é”™è½ç½‘æ ¼æ ¸å¿ƒ - å‘Šåˆ«å•è°ƒ */
.music-vault-staggered-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
    padding-bottom: 150px;
}

/* è®©ç¬¬ 1, 4, 7... ä¸ªå¡ç‰‡å æ®æ•´è¡Œ (æ¨ªå‘å¤§å›¾) */
.music-gallery-card:nth-child(3n+1) { grid-column: span 2; }

.music-gallery-card {
    position: relative;
    animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) both;
}

/* 4. ä¿®æ­£å›¾ç‰‡åŒºï¼šç¡®ä¿å›¾ç‰‡æ˜¯çº¯å‡€çš„ */
.card-visual-box {
    border-radius: 4px; /* ç¨å¾®ç»™å°é¢ä¸€ç‚¹åœ†è§’ï¼Œæ›´æŸ”å’Œ */
    overflow: hidden;
    border: 0.5px solid #f0f0f0;
}

/* é»˜è®¤æ¯”ä¾‹ */
.card-visual-box { aspect-ratio: 1; }
.music-gallery-card:nth-child(3n+1) .card-visual-box { aspect-ratio: 16/9; }

.card-visual-box img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    /* filter: grayscale(1);  <-- å·²åˆ é™¤æˆ–æ³¨é‡Šæ‰ */
    transition: 0.8s; 
}
.music-gallery-card:hover img { filter: grayscale(0); transform: scale(1.05); }

/* 2. æŒ‰é’®ä½ç½®ï¼šç§»å‡ºå›¾ç‰‡ï¼Œç²¾å‡†å¯¹é½åˆ°æ–‡å­—å³ä¾§ */
.card-actions {
    position: absolute;
    right: 0;
    bottom: 2px; /* å®Œç¾å¯¹é½æ­Œæ‰‹åçš„åŸºå‡†çº¿ */
    top: auto;   /* è¦†ç›–ä¹‹å‰çš„ top: 12px */
    display: flex;
    gap: 8px;    /* ä¸¤ä¸ªæŒ‰é’®ç´§å‡‘æ’åˆ— */
    opacity: 1;  /* æ°¸è¿œå¯è§ï¼Œä¸ç”¨æ‰¾ */
}

/* 3. æŒ‰é’®ç˜¦èº«ï¼šä»â€œå¤§åœ†ç›˜â€å˜æˆâ€œç²¾è‡´å°ä»¶â€ */
.action-dot {
    width: 26px;  /* ç¼©å°å°ºå¯¸ï¼Œä¸å†æŠ¢æˆ */
    height: 26px;
    background: #f7f7f7; /* æ”¹ç”¨ææµ…ç°è‰²ï¼Œèå…¥èƒŒæ™¯ */
    border-radius: 6px;  /* æ”¹ä¸ºå°åœ†è§’æ–¹å—ï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;     /* å›¾æ ‡ç¼©å° */
    color: #333;
    box-shadow: none;    /* å»æ‰åšé‡çš„é˜´å½± */
    border: 0.5px solid #eee; /* ç”¨æç»†è¾¹æ¡†ä»£æ›¿é˜´å½± */
    transition: all 0.2s;
}

/* ç‚¹å‡»æ—¶çš„å°åé¦ˆ */
.action-dot:active {
    background: #000;
    color: #fff;
    transform: scale(0.9);
}
/* åºåˆ—å·ä¸æ ‡ç­¾ */
.card-serial { font-family: 'Cinzel'; font-size: 30px; position: absolute; bottom: 10px; right: 10px; color: rgba(0,0,0,0.03); font-weight: 900; }
/* 1. æ ¸å¿ƒä¿®æ”¹ï¼šè®©æ–‡å­—åŒºå…·å¤‡æ‰¿è½½æŒ‰é’®çš„èƒ½åŠ› */
.card-info {
    position: relative; /* ä½œä¸ºå®šä½åŸºå‡† */
    margin-top: 15px;
    padding-right: 70px; /* ä¸ºå³ä¾§æŒ‰é’®ç•™å‡ºä¸“å±ç©ºé—´ */
}
.card-title { font-size: 13px; font-weight: 800; color: #000; letter-spacing: 0.5px; display: block; }
.card-artist { font-size: 10px; color: #bbb; text-transform: uppercase; margin-top: 2px; }

/* 3. æ‚¬æµ®å¿«é—¨æŒ‰é’® */
.shutter-upload-btn {
    position: fixed; bottom: 120px; right: 25px;
    width: 64px; height: 64px; background: #000; border-radius: 50%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; transition: 0.3s;
}
.shutter-inner { width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; }
.shutter-label { font-size: 7px; color: #fff; font-weight: 900; margin-top: 4px; letter-spacing: 1px; }

/* 1. æ¨¡æ€æ¡†èƒŒæ™¯å±‚ - æ²‰æµ¸å¼æ¯›ç»ç’ƒ */
.music-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.4); /* æµ…è‰²åŠé€æ˜èƒŒæ™¯ */
    backdrop-filter: blur(25px) saturate(180%); /* æ ¸å¿ƒï¼šè¶…å¼ºæ¨¡ç³Šä¸è‰²å½©é¥±å’Œ */
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    z-index: 20000;
    display: flex;
    align-items: center;
    justify-content: center;
    visibility: hidden;
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

.music-modal-overlay.active {
    visibility: visible;
    opacity: 1;
}

/* 2. æ¨¡æ€æ¡†ä¸»ä½“å¡ç‰‡ - è‰ºæœ¯å±•ä½æ„Ÿ */
.modal-glass-card {
    width: 90%;
    max-width: 400px;
    max-height: 85vh;
    background: rgba(255, 255, 255, 0.85); /* æ¨¡æ‹Ÿç™½ç“·ç»ç’ƒ */
    border-radius: 40px; /* è¶…å¤§åœ†è§’ */
    border: 1px solid rgba(255, 255, 255, 0.6); /* äº®è¾¹çº¿å¢åŠ è´¨æ„Ÿ */
    box-shadow: 0 40px 100px rgba(0, 0, 0, 0.1); /* æ·±åº¦æŸ”å’Œé˜´å½± */
    padding: 30px;
    display: flex;
    flex-direction: column;
    transform: scale(0.9) translateY(40px); /* åˆå§‹è¿›åœºä½ç§» */
    transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

.music-modal-overlay.active .modal-glass-card {
    transform: scale(1) translateY(0);
}

/* 3. å¤´éƒ¨æ’ç‰ˆ */
.modal-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.modal-top span {
    font-family: 'Cinzel', serif;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 3px;
    color: #000;
}

.modal-close-btn {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 1px;
    padding: 8px 15px;
    border-radius: 20px;
    background: #f0f0f0;
    cursor: pointer;
}

/* 4. æ»šåŠ¨åŒºåŸŸä¸è¡¨å• */
.upload-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
}

/* 5. å°é¢ä¸Šä¼ åŒºï¼šåƒä¸€å¼ ç«‹èµ·æ¥çš„é»‘èƒ¶ */
.cover-upload-zone {
    width: 100%;
    aspect-ratio: 1;
    background: #f7f7f7;
    border-radius: 25px;
    margin-bottom: 30px;
    overflow: hidden;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px dashed #ddd;
}

.cover-upload-zone img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none; /* åˆå§‹éšè— */
}

#cover-tips {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

#cover-tips span {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    color: #bbb;
}

/* 6. è¾“å…¥æ¡†è®¾è®¡ï¼šæè‡´æç®€ */
.input-group-vault {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.input-item label {
    display: block;
    font-size: 9px;
    font-weight: 900;
    letter-spacing: 2px;
    color: #ddd;
    margin-bottom: 8px;
}

.input-item input {
    width: 100%;
    border: none;
    border-bottom: 1px solid #f0f0f0;
    background: transparent;
    padding: 10px 0;
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    font-weight: 500;
    outline: none;
    transition: 0.3s;
}

.input-item input:focus {
    border-bottom-color: #000;
}

/* 7. éŸ³é¢‘é€‰æ‹©æŒ‰é’® */
.custom-file-btn {
    width: 100%;
    padding: 15px;
    background: #000;
    color: #fff;
    border-radius: 12px;
    text-align: center;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 1px;
    margin-top: 5px;
}

/* 8. æäº¤æŒ‰é’®ï¼šç»å¯¹ç»Ÿæ²»åŠ› */
.commit-btn {
    width: 100%;
    background: #000;
    color: #fff;
    border: none;
    padding: 20px;
    border-radius: 40px;
    margin-top: 40px;
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 12px;
    letter-spacing: 4px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: 0.3s;
}

.commit-btn:active {
    transform: scale(0.96);
}
/* ğŸ’¿ CORE å½»åº•æ²‰æµ¸åŒ– */
#music-tab-core {
    position: fixed; /* é”å®šä½ç½® */
    inset: 0;
    height: 100vh;
    width: 100vw;
    padding: 0;
    overflow: hidden; /* æ ¸å¿ƒï¼šç¦æ­¢é¡µé¢æ»‘åŠ¨ */
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* å†…å®¹ä¸¤ç«¯å¯¹é½ */
    background: #000; /* èƒŒæ™¯é»‘åº•ï¼Œé…åˆå°é¢æ¨¡ç³Š */
}

/* èƒŒæ™¯è™šåŒ–å±‚ï¼šè¦†ç›–å…¨å± */
.player-ambient-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(100px) brightness(0.7); /* å¢å¼ºè™šåŒ–å’Œæš—åº¦ */
    transform: scale(1.3);
    z-index: 0;
    opacity: 0.8;
}

/* 2. å°é¢å‘¼å¸åŠ¨ç”» */
.breathing-cover-wrapper {
    width: 280px;
    height: 280px;
    margin: 40px auto;
    position: relative;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    animation: coverBreath 8s infinite ease-in-out;
}

@keyframes coverBreath {
    0%, 100% { transform: scale(1); box-shadow: 0 30px 60px rgba(0,0,0,0.2); }
    50% { transform: scale(1.03); box-shadow: 0 45px 90px rgba(0,0,0,0.15); }
}

.breathing-cover-wrapper img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }

/* 3. æ­Œè¯æµ */
.core-lyrics-section {
    height: 120px;
    margin: 20px 0;
    overflow: hidden;
    text-align: center;
}

.lyrics-scroller { transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1); }

.lyric-line {
    font-size: 15px;
    font-weight: 500;
    color: rgba(0,0,0,0.2);
    margin: 15px 0;
    transition: all 0.4s;
    letter-spacing: 1px;
}

.lyric-line.active {
    color: #000;
    font-weight: 800;
    transform: scale(1.1);
}

/* 4. è¿›åº¦æ¡ä¸æŒ‰é’® */
.progress-bar-wrap {
    flex: 1; height: 2px; background: rgba(0,0,0,0.05);
    margin: 0 15px; position: relative; cursor: pointer;
}
.progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: #000; width: 0%; }

.main-buttons { display: flex; align-items: center; justify-content: center; gap: 40px; margin-top: 30px; }
.ctrl-btn { font-family: 'Cinzel'; font-weight: 900; font-size: 12px; letter-spacing: 2px; cursor: pointer; }
.ctrl-btn-play {
    width: 70px; height: 70px; border: 1px solid #000; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Cinzel'; font-weight: 900; cursor: pointer;
}

/* æ­Œè¯è¾“å…¥æ¡†ç‰¹åŒ– */
#lyric-text-input {
    width: 100%; background: #f9f9f9; border: 1px solid #eee; border-radius: 15px;
    padding: 15px; font-family: 'Montserrat'; font-size: 12px; resize: none; outline: none;
}
.or-divider { text-align: center; margin: 15px 0; position: relative; }
.or-divider::before { content: ""; position: absolute; left: 0; top: 50%; width: 45%; height: 1px; background: #eee; }
.or-divider::after { content: ""; position: absolute; right: 0; top: 50%; width: 45%; height: 1px; background: #eee; }
.or-divider span { font-size: 9px; color: #ccc; font-weight: 900; }
/* ğŸ’¿ CORE å½»åº•æ²‰æµ¸åŒ– */
#music-tab-core {
    position: fixed; /* é”å®šä½ç½® */
    inset: 0;
    height: 100vh;
    width: 100vw;
    padding: 0;
    overflow: hidden; /* æ ¸å¿ƒï¼šç¦æ­¢é¡µé¢æ»‘åŠ¨ */
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* å†…å®¹ä¸¤ç«¯å¯¹é½ */
    background: #000; /* èƒŒæ™¯é»‘åº•ï¼Œé…åˆå°é¢æ¨¡ç³Š */
}

/* èƒŒæ™¯è™šåŒ–å±‚ï¼šè¦†ç›–å…¨å± */
.player-ambient-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(100px) brightness(0.7); /* å¢å¼ºè™šåŒ–å’Œæš—åº¦ */
    transform: scale(1.3);
    z-index: 0;
    opacity: 0.8;
}

/* ä¸»å®¹å™¨ï¼šå±…ä¸­ä¸”æ’‘å¼€ */
.core-main-container {
    position: relative;
    z-index: 10;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 60px 30px 40px; /* é¢„ç•™é¡¶éƒ¨å’Œåº•éƒ¨çš„å‘¼å¸æ„Ÿ */
}

/* å°é¢ï¼šåœ¨å¤§å±ä¸­å¿ƒæ›´æ˜¾çœ¼ */
.core-visual-section {
    flex: 2; /* å æ®æ›´å¤šç©ºé—´ */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.breathing-cover-wrapper {
    width: 80vw; /* å®½åº¦éšå±å¹•è‡ªé€‚åº” */
    max-width: 320px;
    aspect-ratio: 1;
    border-radius: 12px;
    box-shadow: 0 50px 100px rgba(0,0,0,0.5);
}

/* æ­Œè¯åŒºï¼šå±…ä¸­ï¼Œåªç•™ä¸‰è¡Œï¼Œæè‡´ç„¦ç‚¹ */
.core-lyrics-section {
    flex: 1;
    height: 100px;
    mask-image: linear-gradient(to bottom, transparent, #000 20%, #000 80%, transparent);
    -webkit-mask-image: linear-gradient(to bottom, transparent, #000 20%, #000 80%, transparent);
}

/* æ§åˆ¶å°ï¼šç§»åˆ°æœ€åº•éƒ¨ï¼Œæ‚¬æµ®æ„Ÿ */
.core-controls-section {
    padding-bottom: 20px;
}

/* ğŸ”™ å¢åŠ ä¸€ä¸ªé€€å‡º CORE çš„æŒ‰é’®ï¼ˆå› ä¸ºéšè—äº†å¯¼èˆªæ ï¼‰ */
.core-exit-btn {
    position: absolute;
    top: 50px;
    left: 25px;
    color: rgba(255,255,255,0.6);
    z-index: 100;
    font-size: 24px;
}
/* ğŸ–¼ï¸ CORE ä¸“ç”¨èƒŒæ™¯å±‚ï¼šå½»åº•å»æ¨¡ç³Šï¼Œè¿˜åŸé«˜æ¸…è´¨æ„Ÿ */
.core-persistent-bg {
    position: absolute;
    inset: 0;
    z-index: 0; /* ä¾ç„¶åœ¨å†…å®¹å±‚ä¸‹æ–¹ï¼Œä½†å› ä¸ºå»æ‰äº†é®ç½©ï¼Œå®ƒä¼šéå¸¸æ¸…æ™° */
    background-size: cover;
    background-position: center;
    
    /* æ ¸å¿ƒä¿®æ”¹ï¼šåˆ é™¤åŸæœ¬çš„ filter: blur(40px) brightness(0.6) */
    filter: none !important; 
    
    /* åˆ é™¤åŸæœ¬çš„ scale(1.1)ï¼Œè¿˜åŸåŸå§‹æ¯”ä¾‹ */
    transform: none !important; 
    
    opacity: 0;
    transition: opacity 0.8s ease;
    pointer-events: none;
}

/* æ¿€æ´»çŠ¶æ€ */
.core-persistent-bg.has-bg {
    opacity: 1 !important;
}

/* ğŸ›¡ï¸ ç¡®ä¿ä¸Šå±‚å®¹å™¨é€æ˜ï¼Œä¸é®æŒ¡é«˜æ¸…èƒŒæ™¯ */
.core-main-container {
    position: relative;
    z-index: 5;
    background: transparent !important; /* å½»åº•é€æ˜ */
}
/* 1. æ‰©å……æ§åˆ¶æ¡ç©ºé—´ */
.main-buttons-console {
    display: flex;
    align-items: center;
    justify-content: space-around; /* å‡åŒ€åˆ†å¸ƒï¼Œä¸å†æ‹¥æŒ¤ */
    padding: 0 5px;
    margin-top: 50px;
}

/* 2. å›¾æ ‡æŒ‰é’®ï¼šä»â€œç»†å°â€å˜ä¸ºâ€œæ¸…æ™°â€ */
.ctrl-icon-btn {
    width: 52px;  /* å¢å¤§ç‚¹å‡»çƒ­åŒº */
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFFFFF; /* å¼ºåˆ¶çº¯ç™½ï¼Œé«˜æ¸…ä¸é€ */
    cursor: pointer;
    transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 3. ä¸­é—´ä¸»æŒ‰é’®ï¼šç»´æŒç»å¯¹ç»Ÿé¢†åœ°ä½ */
.ctrl-play-shutter {
    width: 82px; /* è¿›ä¸€æ­¥åŠ å¤§ */
    height: 82px;
    background: #FFFFFF;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000000;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4); /* å¢å¼ºé˜´å½±ï¼Œæ›´æœ‰å®ä½“æ„Ÿ */
    transition: all 0.2s ease;
}

/* 4. ç‚¹å‡»åé¦ˆï¼šæ›´æœ‰åŠ›çš„ç‰©ç†æ„Ÿ */
.ctrl-icon-btn:active {
    transform: scale(0.8); /* ç‚¹å‡»åé¦ˆæ›´æ˜æ˜¾ */
}
.ctrl-play-shutter:active {
    transform: scale(0.9);
}

/* 5. ä¸¤ä¾§æŒ‰é’®ç¨å¾®å‡å¼±ä¸€ç‚¹é€æ˜åº¦ï¼Œå½¢æˆè§†è§‰é‡å¿ƒå±‚çº§ */
.mode-btn, .list-btn {
    opacity: 0.7;
}
/* 1. å®¹å™¨ï¼šå¼ºåˆ¶æ¨ªå‘æ’åˆ—å¹¶å‚ç›´å±…ä¸­ */
.progress-container {
    display: flex;
    align-items: center; /* å‚ç›´å¯¹é½ */
    justify-content: space-between;
    width: 100%;
    margin: 30px 0; /* ç•™å‡ºä¸Šä¸‹å‘¼å¸ç©ºé—´ */
}

/* 2. æ—¶é—´æˆ³ï¼šå¾®å‹å¤§å†™ï¼Œå¢åŠ é«˜çº§æ„Ÿ */
.time-stamp {
    font-family: 'Montserrat', sans-serif;
    font-size: 10px; /* æå°å­—ä½“æ˜¯å•†ç”¨çº§çš„ç²¾é«“ */
    letter-spacing: 1px;
    color: rgba(255, 255, 255, 0.6); /* åŠé€æ˜ç™½è‰²ï¼Œä¸æŠ¢æˆ */
    min-width: 40px; /* é”å®šå®½åº¦ï¼Œé˜²æ­¢æ•°å­—è·³åŠ¨æ—¶æ¡é•¿ç¼©æ”¾ */
}

#curr-time { text-align: left; }
#total-time { text-align: right; }

/* 3. è¿›åº¦æ¡è½¨é“ï¼šæç»†çº¿æ¡ */
.progress-bar-wrap {
    flex: 1; /* è‡ªåŠ¨å æ®ä¸­é—´æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    height: 2px; /* æç»†çº¿æ‰æ˜¾å¾—â€œè´µâ€ */
    background: rgba(255, 255, 255, 0.15); /* è½¨é“é¢œè‰² */
    margin: 0 15px; /* å·¦å³é—´è· */
    position: relative;
    cursor: pointer;
    border-radius: 4px;
}

/* 4. è¿›åº¦å¡«å……ï¼šçº¯ç™½è´¨æ„Ÿ */
.progress-fill {
    height: 100%;
    background: #FFFFFF; /* çº¯ç™½å¡«å…… */
    width: 0%;
    border-radius: 4px;
    position: relative;
    transition: width 0.1s linear; /* å¹³æ»‘è¿‡æ¸¡ï¼Œä¸å¡é¡¿ */
}

/* 5. è¿›é˜¶ï¼šåŠ ä¸€ä¸ªå¾®å°çš„è¿›åº¦çƒï¼ˆå¯é€‰ï¼Œå»ºè®®åŠ ä¸Šå¢åŠ ç‚¹å‡»æ¬²æœ›ï¼‰ */
.progress-fill::after {
    content: "";
    position: absolute;
    right: -4px;
    top: -3px;
    width: 8px;
    height: 8px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
/* ğŸ’¿ åœ†å½¢å°é¢å®¹å™¨ */
.ripple-wrapper {
    position: relative;
    width: 260px;
    height: 260px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px 0 40px;
}

/* æ ¸å¿ƒåœ†å½¢ï¼šå¼ºåˆ¶ 1:1 å¹¶è£åˆ‡ */
.circular-cover-box {
    width: 240px;
    height: 240px;
    border-radius: 50%;
    overflow: hidden;
    z-index: 10;
    box-shadow: 0 25px 60px rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.1);
}

.circular-cover-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ğŸŒŠ å‘¼å¸åœˆç‰¹æ•ˆ */
.ripple-ring {
    position: absolute;
    border-radius: 50%;
    border: 1.5px solid rgba(255,255,255,0.25);
    z-index: 1;
    animation: ripplePulse 4s infinite cubic-bezier(0.4, 0, 0.2, 1);
}

.r1 { width: 240px; height: 240px; animation-delay: 0s; }
.r2 { width: 240px; height: 240px; animation-delay: 2s; }

@keyframes ripplePulse {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(1.6); opacity: 0; }
}

/* ğŸ–‹ï¸ æ­Œè¯ç”»å¸ƒï¼šæè‡´ç„¦è· */
.core-lyrics-canvas {
    flex: 1;
    width: 100%;
    overflow: hidden;
    cursor: pointer;
    /* ä¸Šä¸‹ç¾½åŒ–æ¸å˜ï¼šè®©æ­Œè¯çœ‹èµ·æ¥æ˜¯åœ¨æ— é™ç©ºé—´é‡Œæ¼‚æµ® */
    mask-image: linear-gradient(to bottom, transparent, #000 30%, #000 70%, transparent);
    -webkit-mask-image: linear-gradient(to bottom, transparent, #000 30%, #000 70%, transparent);
}

.lyric-placeholder {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 5px;
    color: rgba(255,255,255,0.4);
    margin-top: 50px;
    text-align: center;
    text-transform: uppercase;
}

/* æ­Œæ›²ååŠ ç²—å¯¹é½ */
.meta-text h2 {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: 1px;
    margin: 0;
}

.meta-text p {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    margin-top: 5px;
    letter-spacing: 2px;
}
.lyric-line.active {
    /* åŸæœ‰çš„æ ·å¼ä¿ç•™ (é¢œè‰²ã€å­—é‡ã€ç¼©æ”¾ç­‰) */
    color: #FFFFFF;
    font-weight: 800;
    transform: scale(1.15);
    
    /* âœ¨ æ ¸å¿ƒå‘å…‰ä»£ç ï¼šå¤šå±‚æŸ”å…‰å åŠ ï¼Œè¥é€ ç©ºæ°”æ„Ÿå…‰æ™• */
    text-shadow: 
        0 0 15px rgba(255, 255, 255, 0.8), /* å†…å±‚é«˜å…‰ï¼šäº®ä¸”å® */
        0 0 30px rgba(255, 255, 255, 0.4), /* ä¸­å±‚æŸ”å…‰ï¼šæ‰©æ•£ */
        0 0 50px rgba(255, 255, 255, 0.2); /* å¤–å±‚æ°›å›´ï¼šææ·¡çš„æ™•æŸ“ */
}
/* 1. ç¡®ä¿æ»šåŠ¨å®¹å™¨å¼€å¯ Flex å¹¶æ¨ªå‘å±…ä¸­ */
.lyrics-scroller {
    display: flex;
    flex-direction: column;
    align-items: center; /* ğŸ‘ˆ æ ¸å¿ƒï¼šè®©æ‰€æœ‰å­å…ƒç´ åœ¨äº¤å‰è½´ï¼ˆæ¨ªå‘ï¼‰å±…ä¸­ */
    width: 100%;
}

/* 2. ç¡®ä¿æ¯ä¸€è¡Œæ–‡å­—æœ¬èº«ä¹Ÿæ˜¯å±…ä¸­çš„ */
.lyric-line {
    width: 100%;
    text-align: center; /* ğŸ‘ˆ æ ¸å¿ƒï¼šæ–‡å­—å†…å®¹æ°´å¹³å±…ä¸­ */
    /* å…¶ä»–æ ·å¼ä¿ç•™... */
}
/* 1. æŠ½å±‰é®ç½©å±‚ */
.playlist-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    z-index: 30000;
    visibility: hidden;
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

.playlist-overlay.active {
    visibility: visible;
    opacity: 1;
}

/* 2. æŠ½å±‰å†…å®¹å®¹å™¨ï¼šä»å³ä¾§åˆ’å…¥ */
.playlist-content {
    position: absolute;
    top: 0;
    right: -100%; /* åˆå§‹åœ¨å±å¹•å¤– */
    width: 85%;
    max-width: 360px;
    height: 100%;
    background: rgba(255, 255, 255, 0.85); /* ç£¨ç ‚ç»ç’ƒåº•è‰² */
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    box-shadow: -20px 0 60px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    transition: right 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

.playlist-overlay.active .playlist-content {
    right: 0;
}

/* 3. åˆ—è¡¨å¤´éƒ¨ */
.playlist-header { padding: 40px 30px 20px; }
.header-line { width: 40px; height: 3px; background: #000; margin-bottom: 15px; }
.header-text-row { display: flex; justify-content: space-between; align-items: baseline; }
.header-text-row span:first-child { font-family: 'Cinzel', serif; font-size: 16px; font-weight: 900; letter-spacing: 2px; }
.header-text-row span:last-child { font-size: 9px; color: #888; font-weight: 700; }

/* 4. åˆ—è¡¨æ»šåŠ¨åŒº */
.playlist-items-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 10px 20px;
}

/* 5. å•ä¸ªåˆ—è¡¨é¡¹ï¼šé»‘ç™½æç®€ */
.playlist-item {
    display: flex;
    align-items: center;
    padding: 15px 10px;
    margin-bottom: 5px;
    border-radius: 12px;
    transition: all 0.3s;
    cursor: pointer;
}

.playlist-item.playing {
    background: rgba(0, 0, 0, 0.05);
}

.item-num {
    font-family: 'Cinzel';
    font-size: 11px;
    color: #bbb;
    width: 30px;
}

.item-info-row { flex: 1; }
.item-name {
    display: block;
    font-size: 13px;
    font-weight: 700;
    color: #444;
    letter-spacing: 0.5px;
}
.item-artist-sub {
    font-size: 9px;
    color: #bbb;
    text-transform: uppercase;
}

/* æ­£åœ¨æ’­æ”¾çš„ç‰¹æ®ŠçŠ¶æ€ */
.playlist-item.playing .item-name { color: #000; font-weight: 900; }
.playlist-item.playing .item-num { color: #000; }

/* 6. åº•éƒ¨å…³é—­ */
.playlist-footer { padding: 30px; }
.close-drawer-btn {
    width: 100%;
    padding: 18px;
    background: transparent;
    border: 1px solid #000;
    font-family: 'Cinzel';
    font-size: 10px;
    font-weight: 900;
    letter-spacing: 3px;
    cursor: pointer;
}
/* --- ğŸš‘ å¼ºåˆ¶æ¶ˆé™¤ App å†…éƒ¨æº¢å‡º --- */
.music-app-container, 
.music-view-viewport, 
.music-view-page {
    width: 100% !important;
    max-width: 100vw !important;
    overflow-x: hidden !important; /* ğŸš¨ ç‰©ç†åˆ‡é™¤æ¨ªå‘æº¢å‡º */
    box-sizing: border-box !important;
}
/* --- SYNERGY FIELD ä¸“å±æ ·å¼ --- */

.synergy-field-page {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    background-color: #000; /* èƒŒæ™¯ä¸ºçº¯é»‘ï¼Œçªå‡ºå†…å®¹ */
    color: #FFF;
    font-family: 'Inter', sans-serif; /* å‡è®¾ä½ å¼•å…¥äº†Interå­—ä½“ */
    position: relative;
    overflow: hidden; /* é˜²æ­¢å†…éƒ¨å…ƒç´ æº¢å‡ºå¯¼è‡´é¡µé¢æ»‘åŠ¨ */
}

/* é¡¶éƒ¨çŠ¶æ€æ å ä½ï¼Œç¡®ä¿å†…å®¹ä¸è¢«çŠ¶æ€æ é®æŒ¡ */
.synergy-status-bar-placeholder {
    height: 44px; /* æ ¹æ® iOS çŠ¶æ€æ é«˜åº¦è°ƒæ•´ */
    width: 100%;
    flex-shrink: 0;
}

.synergy-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0 15px 0;
    position: relative;
    z-index: 10;
}

.character-avatar-wrapper {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* é˜²æ­¢å…‰ç¯æº¢å‡º */
}

.character-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    filter: grayscale(100%) brightness(80%) contrast(120%); /* Lo-fi é»‘ç™½æ»¤é•œ */
    opacity: 0.8;
}

/* å‘¼å¸å…‰ç¯åŠ¨ç”» */
.avatar-breathing-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 80px; /* æ¯”å¤´åƒå¤§ä¸€ç‚¹ */
    height: 80px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
    animation: breathingGlow 3s ease-in-out infinite alternate;
    z-index: -1;
}

@keyframes breathingGlow {
    0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.2; }
    100% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.4; }
}

/* --- ğŸ›ï¸ Synergy 2.0 å·¥ä¸šç¾å­¦è¡¥ä¸ --- */
.synergy-fixed-layout {
    background: #FFF !important; /* åç™½åº•è‰² */
    color: #1d1d1f;
    overflow: hidden;
}

/* 1. è¦†ç›–å±‚é¢æ¿ */
.synergy-overlay-panel {
    position: absolute; inset: 0; padding: 60px 25px;
    display: flex; flex-direction: column; align-items: center;
    background: #FFF; z-index: 100;
}

.synergy-hero-text { text-align: center; margin-bottom: 50px; }
.synergy-hero-text .label { font-size: 10px; font-weight: 900; letter-spacing: 4px; color: #CCC; }
.synergy-hero-text h1 { font-family: 'Cinzel', serif; font-size: 32px; margin: 10px 0; }
.synergy-hero-text p { font-size: 12px; color: #8E8E93; letter-spacing: 1px; }

/* 2. å¥½å‹ç¯ (æ¨ªå‘ç‰©ç†æ„Ÿ) */
.synergy-friend-dial {
    width: 100%; display: flex; gap: 30px; overflow-x: auto;
    padding: 20px 0; scrollbar-width: none;
    mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
}
.synergy-friend-dial::-webkit-scrollbar { display: none; }

.dial-item {
    flex-shrink: 0; width: 100px; text-align: center;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.dial-item:active { transform: scale(0.9); }
.dial-avatar-box {
    width: 80px; height: 80px; border-radius: 50%; padding: 4px;
    border: 1px solid #EEE; margin: 0 auto 12px;
}
.dial-avatar-box img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; filter: grayscale(100%); }
.dial-item span { font-size: 12px; font-weight: 700; color: #1d1d1f; }

/* 3. èŠå¤©ä¸»åœº */
.synergy-chat-active {
    position: absolute; inset: 0; display: none; /* åˆå§‹éšè— */
    flex-direction: column; background: #FFF; z-index: 200;
}

.synergy-chat-header {
    padding: 50px 25px 15px; display: flex; justify-content: space-between;
    border-bottom: 0.5px solid #F2F2F7;
}
.header-user { display: flex; align-items: center; gap: 12px; }
.header-user img { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #1d1d1f; }
.header-info h2 { font-size: 17px; font-weight: 800; }
.status-dot { font-size: 10px; color: #34C759; font-weight: 700; letter-spacing: 1px; }

/* 4. æ°”æ³¡é‡å¡‘ï¼šé»‘ç™½é«˜çº§æ„Ÿ */
.synergy-flow-container { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; }

.syn-bubble { 
    max-width: 85%; padding: 12px 18px; font-size: 15px; line-height: 1.6;
    border-radius: 20px; position: relative;
}
.syn-bubble.ai { 
    background: #F2F2F7; color: #1d1d1f; align-self: flex-start; 
    border-bottom-left-radius: 4px; font-family: 'Montserrat', serif; font-style: italic;
}
.syn-bubble.user { 
    background: #1d1d1f; color: #FFF; align-self: flex-end; 
    border-bottom-right-radius: 4px; font-weight: 500;
}

/* 5. è¾“å…¥æ¡† */
.synergy-footer { padding: 15px 20px 40px; }
#syn-memory-micro-tag { font-size: 9px; color: #BBB; letter-spacing: 1px; margin-bottom: 10px; text-align: center; }
.input-row { display: flex; gap: 10px; }
.input-row input { 
    flex: 1; height: 48px; border-radius: 24px; border: 1.5px solid #1d1d1f;
    padding: 0 20px; font-size: 15px; outline: none;
}
.input-row button { 
    width: 48px; height: 48px; background: #000; border-radius: 50%; border: none;
}
/* --- ğŸ›ï¸ é‚€çº¦ & æˆåŠŸå¼¹çª—é«˜å®šæ ·å¼ --- */

/* ç¡®è®¤å¡ç‰‡ */
.resonance-invite-card {
    width: 300px !important;
    background: #FFF !important;
    border-radius: 28px !important;
    padding: 30px 20px !important;
    border: 1px solid #F2F2F7 !important;
}
.invite-card-header { text-align: center; margin-bottom: 20px; }
.invite-card-header .brand-line { width: 30px; height: 3px; background: #000; margin: 0 auto 10px; }
.invite-card-header span { font-size: 9px; font-weight: 900; letter-spacing: 3px; color: #CCC; }

.invite-card-body { text-align: center; margin-bottom: 30px; }
.invite-card-body img { width: 80px; height: 80px; border-radius: 50%; border: 1.5px solid #1d1d1f; margin-bottom: 15px; padding: 3px; }
.invite-card-body h2 { font-family: 'Cinzel', serif; font-size: 22px; color: #000; margin-bottom: 10px; }
.invite-card-body p { font-size: 11px; color: #8E8E93; line-height: 1.6; padding: 0 10px; }

.invite-card-footer { display: flex; gap: 10px; }
.invite-btn { flex: 1; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; }
.invite-btn.cancel { background: #F2F2F7; color: #1d1d1f; }
.invite-btn.confirm { background: #1d1d1f; color: #FFF; }

/* æˆåŠŸå…¨å±æé†’ */
.synergy-success-content { text-align: center; animation: successPop 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes successPop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

.success-glow { width: 120px; height: 120px; background: radial-gradient(circle, rgba(52, 199, 89, 0.2) 0%, transparent 70%); margin: 0 auto; position: relative; }
.success-glow::after { content: "âœ“"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: #34C759; }

.success-info { margin: 30px 0 50px; }
.success-info .label { font-size: 10px; font-weight: 900; letter-spacing: 4px; color: #CCC; }
.success-info h1 { font-family: 'Cinzel', serif; font-size: 38px; margin: 10px 0; color: #000; }
.success-info p { font-style: italic; font-family: 'Montserrat', serif; font-size: 15px; color: #555; padding: 0 40px; }

.enter-synergy-btn { 
    background: #000; color: #FFF; border: none; padding: 18px 45px; 
    border-radius: 35px; font-size: 13px; font-weight: 900; letter-spacing: 3px; 
    text-transform: uppercase; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
/* =========================================================
   ğŸ“» SYNERGY RADIO OS 3.0 - ç»ˆæå·¥ä¸šç¾å­¦åè®®
   ========================================================= */

/* 1. åŸºç¡€ç‰©ç†å®¹å™¨ï¼šå¼ºåˆ¶å…¨å±å‹åˆ¶ */
.synergy-master-fixed {
    position: fixed !important;
    inset: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 3000000 !important; /* ğŸš¨ ç»å¯¹é¡¶çº§å±‚çº§ */
    background: #FFFFFF !important; /* æç®€ç™½åŸºè°ƒ */
    display: flex;
    flex-direction: column;
    font-family: 'Montserrat', 'Roboto Mono', monospace;
    overflow: hidden;
    color: #1d1d1f;
}

/* 2. ä¿¡å·æ‰«æåŠ è½½å±‚ */
.synergy-loading-overlay {
    position: absolute; inset: 0;
    background: #FFFFFF;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 6000000;
}
.radar-scanner {
    width: 160px; height: 160px;
    border: 1px solid #F0F0F0;
    border-radius: 50%;
    position: relative;
    background: radial-gradient(circle, #FAFAFA 0%, #FFFFFF 70%);
}
.radar-beam {
    position: absolute; inset: 0;
    background: conic-gradient(from 0deg, transparent 0%, rgba(0, 122, 255, 0.1) 50%, transparent 100%);
    animation: qRotate 2s infinite linear;
}
.radar-grid {
    position: absolute; inset: 0;
    background-image: radial-gradient(rgba(0,0,0,0.05) 1px, transparent 1px);
    background-size: 20px 20px;
}
.loading-metadata { margin-top: 40px; text-align: center; }
.code-line { font-family: monospace; font-size: 10px; font-weight: 900; letter-spacing: 3px; color: #000; margin-bottom: 10px; }
.percent-num { font-family: 'Cinzel', serif; font-size: 24px; font-weight: 900; color: #007AFF; }

/* 3. ç”µå°ä¸»æ¶æ„ - è§£å†³ç•™ç™½çš„æ ¸å¿ƒ */
.radio-main-scaffold {
    flex: 1; 
    display: flex; 
    flex-direction: column;
    background: #FDFDFD;
    height: 100%;
}

/* é¡¶éƒ¨è°ƒé¢‘å° */
.radio-header-tuner {
    padding: 65px 25px 20px; /* é¿å¼€ç³»ç»Ÿåˆ˜æµ· */
    background: #FFF;
    border-bottom: 1.5px solid #000;
    display: flex; justify-content: space-between; align-items: center;
}
.tuner-action { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; }
.tuner-action label { font-size: 8px; font-weight: 900; color: #BBB; letter-spacing: 2px; }
.btn-min-icon { width: 22px; height: 2px; background: #000; margin: 10px 0; }
.btn-close-icon { width: 20px; height: 20px; position: relative; }
.btn-close-icon::before, .btn-close-icon::after { content:""; position: absolute; top:50%; left:0; width:100%; height:2px; background:#000; }
.btn-close-icon::before { transform: rotate(45deg); }
.btn-close-icon::after { transform: rotate(-45deg); }

.freq-readout { font-family: 'Cinzel', serif; font-size: 34px; font-weight: 900; letter-spacing: -1px; color: #000; }
.freq-readout small { font-size: 12px; color: #BBB; margin-left: 5px; }

/* 4. è§†è§‰å…±é¸£åŒºï¼šç¤ºæ³¢å™¨ç¾å­¦ */
.radio-body-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 0 25px;
    overflow: hidden;
}
.oscilloscope-module { padding: 40px 0; text-align: center; }
.avatar-scope-wrap {
    position: relative; width: 160px; height: 160px; margin: 0 auto;
    display: flex; align-items: center; justify-content: center;
}
.avatar-scope-wrap img {
    width: 110px; height: 110px; border-radius: 50%; z-index: 10;
    filter: grayscale(100%) contrast(1.1); border: 3px solid #000;
    background: #FFF;
}
.wave-circle {
    position: absolute; border: 1.5px solid #007AFF; border-radius: 50%; opacity: 0;
    animation: waveOut 4s infinite cubic-bezier(0.36, 0, 0.64, 1);
}
.wave-circle:nth-child(2) { animation-delay: 2s; }
@keyframes waveOut {
    0% { width: 110px; height: 110px; opacity: 0.8; }
    100% { width: 220px; height: 220px; opacity: 0; }
}

.partner-meta h2 { font-family: 'Cinzel'; font-size: 24px; letter-spacing: 3px; margin-top: 20px; }
.id-hash { font-family: monospace; font-size: 9px; color: #007AFF; font-weight: 900; margin-top: 5px; opacity: 0.6; }

/* 5. é€šè®¯ç»ˆç«¯ï¼šæ•°æ®æµé£æ ¼ */
.terminal-scroller {
    flex: 1; overflow-y: auto; padding: 20px 0;
    mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
}
.log-entry { margin-bottom: 25px; font-size: 14px; line-height: 1.8; animation: logFade 0.5s ease forwards; }
.log-entry.ai { border-left: 2px solid #000; padding-left: 20px; font-family: 'Noto Serif SC', serif; font-style: italic; color: #333; }
.log-entry.user { border-right: 2px solid #007AFF; padding-right: 20px; text-align: right; font-weight: 600; color: #000; }
.log-meta { font-family: monospace; font-size: 9px; color: #BBB; letter-spacing: 1.5px; margin-bottom: 8px; }

/* 6. åº•éƒ¨å·¥ä¸šåŸºåº§ï¼šå½»åº•å°æ­»åº•éƒ¨ */
.radio-bottom-dock {
    padding: 20px 25px 50px; /* ğŸš¨ åº•éƒ¨ç•™ç™½ç”¨äº iOS Home Bar */
    background: #FFF;
    border-top: 2px solid #000;
}
.metadata-strip {
    background: #F9F9F9; padding: 6px 15px; border-radius: 4px;
    margin-bottom: 20px; overflow: hidden; white-space: nowrap;
}
#radio-memory-strip { font-size: 10px; font-weight: 700; color: #BBB; letter-spacing: 1px; }

/* 1. è°ƒæ•´åº•åº§å®¹å™¨ï¼šç¡®ä¿å®ƒä¸æ¢è¡Œï¼Œä¸”èƒ½åŒ…å«æ‰€æœ‰å­å…ƒç´  */
.console-input-bay {
    display: flex !important;
    align-items: center !important; 
    background: #111; 
    padding: 6px 12px; /* é€‚å½“å‡å°å†…è¾¹è· */
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    width: 100%;       /* å¼ºåˆ¶å æ»¡å®½åº¦ */
    box-sizing: border-box !important; /* å…³é”®ï¼šé˜²æ­¢ padding æ’‘å¼€å®½åº¦ */
    overflow: hidden;  /* å…³é”®ï¼šé˜²æ­¢å†…å®¹æº¢å‡º */
}

/* 2. å‰ç¼€ä¿æŒä¸åŠ¨ */
.input-prefix { 
    color: #34C759; 
    font-weight: 900; 
    margin-right: 8px; 
    font-family: monospace; 
    flex-shrink: 0;   /* å¼ºåˆ¶ä¸è¢«æŒ¤å‹ */
}

/* 3. è¾“å…¥æ¡†ï¼šæ ¸å¿ƒä¿®å¤ç‚¹ */
#radio-cmd-input {
    flex: 1 !important; /* å…³é”®ï¼šå æ®å‰©ä½™å…¨éƒ¨ç©ºé—´ */
    min-width: 0 !important; /* ğŸš¨ ç‰©ç†ä¿®å¤ï¼šè¿™æ˜¯é˜²æ­¢ input æ’‘ç ´ Flex çš„ç¥è¯ */
    height: 40px; 
    background: transparent; 
    border: none !important;
    color: #FFF; 
    font-family: 'Roboto Mono', monospace; 
    font-size: 15px; 
    outline: none;
    padding: 0 5px;
}
.transmit-btn {
    background: #FFF; color: #000; border: none; padding: 0 15px;
    height: 36px; border-radius: 4px; font-weight: 900; font-size: 11px;
    display: flex; align-items: center; gap: 8px; cursor: pointer;
}

.industrial-footer-labels {
    display: flex; justify-content: space-between; margin-top: 20px;
    font-size: 8px; font-weight: 900; color: #DDD; letter-spacing: 3px;
}

/* 7. é»‘èƒ¶æ‚¬æµ®çƒï¼šç‹¬ç«‹ç½®é¡¶å±‚ */
.floating-vinyl-ball {
    position: fixed; bottom: 120px; right: 25px;
    width: 68px; height: 68px;
    z-index: 3000001; display: none; cursor: pointer;
}
.vinyl-record {
    width: 100%; height: 100%; border-radius: 50%;
    background: repeating-radial-gradient(#111, #111 2px, #222 3px, #222 4px);
    border: 3px solid #000; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
}
.vinyl-record img { width: 45%; height: 45%; border-radius: 50%; border: 1px solid #FFF; object-fit: cover; }
.status-dot-active {
    position: absolute; top: 0; right: 0; width: 14px; height: 14px;
    background: #34C759; border: 2px solid #FFF; border-radius: 50%;
    box-shadow: 0 0 10px #34C759; animation: qPulse 2s infinite;
}

/* åŠ¨ç”»åº“ */
@keyframes qRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes qPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes logFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* é€‚åº”çª„å± */
@media screen and (max-height: 700px) {
    .oscilloscope-module { padding: 20px 0; }
    .avatar-scope-wrap { width: 120px; height: 120px; }
    .avatar-scope-wrap img { width: 90px; height: 90px; }
}
/* --- ğŸ”˜ AI è¿½é—®æŒ‰é’®é«˜å®šæ ·å¼ --- */

/* 1. ç¡®ä¿æŒ‰é’®ç»„æ°´å¹³æ’åˆ— */
.action-group {
    display: flex !important;
    align-items: center !important;
    gap: 8px;          /* ç¼©å°æŒ‰é’®é—´è· */
    flex-shrink: 0;    /* å¼ºåˆ¶æŒ‰é’®ç»„ä¸è¢«æŒ¤å‹ */
    margin-left: 5px;
}

/* 2. REPLY æŒ‰é’®ï¼šå·¥ä¸šé€æ˜è´¨æ„Ÿ */
.reply-btn {
    background: transparent;
    color: #FFFFFF;
    border: 1px solid rgba(255, 255, 255, 0.3); /* åŠé€æ˜è¾¹æ¡† */
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.reply-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #FFFFFF;
}

/* ç‚¹å‡»æ—¶çš„ç‰©ç†ç¼©æ”¾åé¦ˆ */
.reply-btn:active {
    transform: scale(0.9);
    background: #FFFFFF;
    color: #000;
}

/* 3. å…¼å®¹è°ƒæ•´ï¼šç¡®ä¿ SEND æŒ‰é’®é«˜åº¦ä¸€è‡´ */
.transmit-btn {
    height: 36px;
    padding: 0 15px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 1px;
}

/* 4. è¿™é‡Œçš„å›¾æ ‡ç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œæ˜¾å¾—ç²¾è‡´ */
.reply-btn svg {
    opacity: 0.8;
}
/* ä¿¡å·ä¼ è¾“ä¸­çš„å‘¼å¸åŠ¨ç”» */
.dot-loading {
    display: inline-block;
    animation: dotBlink 1.4s infinite both;
}
@keyframes dotBlink {
    0% { opacity: .2; }
    20% { opacity: 1; }
    100% { opacity: .2; }
}

/* ç³»ç»Ÿæ¶ˆæ¯ç¨å¾®åŒºåˆ†ä¸€ä¸‹é¢œè‰² */
.system-msg .log-content {
    color: #007AFF !important;
    font-size: 11px;
    font-weight: 800;
}
/* ğŸš¨ ç‰©ç†é‡ç½®ï¼šè®©ç¡®è®¤å¼¹çª—ç»å¯¹å‡Œé©¾äºé»‘èƒ¶çƒå’ŒçŠ¶æ€æ ä¹‹ä¸Š */
.ios-alert-mask, 
#iosConfirmModal.ios-alert-mask, 
.vibe-center-mask {
    z-index: 9999999 !important; /* ç‰©ç†é”å®šï¼šä¹ç™¾ä¸‡æƒå€¼ï¼Œç»å¯¹ç»Ÿæ²» */
    backdrop-filter: blur(15px) saturate(180%) !important; /* å¢å¼ºèƒŒæ™¯ç£¨ç ‚æ„Ÿï¼Œå½»åº•éš”ç¦»ä¸‹æ–¹å¹²æ‰° */
}

/* ç¡®ä¿é»‘èƒ¶æ‚¬æµ®çƒåœ¨å¼¹çª—å‡ºç°æ—¶ä¸ä¼šäº§ç”Ÿäº¤äº’å¹²æ‰° */
#synergy-floating-disc {
    z-index: 3000001; /* ä¿æŒåœ¨æ™®é€š App ä¹‹ä¸Šï¼Œä½†å¿…é¡»ä½äºå¼¹çª— */
}
/* ğŸš¨ ç‰©ç†çº§ï¼šå…¨åŸŸè‰²å½©è§£å†»åè®® ğŸš¨ */

/* 1. å¼ºåˆ¶æ´—ç™½æ‰€æœ‰å¯èƒ½çš„çˆ¶çº§å®¹å™¨æ»¤é•œ */
.film-photo-wrapper,
.ai-visual-frame,
.history-thumb,
.avatar-scope-wrap,
.gallery-inner-container,
.gallery-card-bg,
.status-day-card,
.status-img-wrapper,
.dial-avatar-box {
    filter: none !important;
    -webkit-filter: none !important;
}

/* 2. ç‰©ç†çˆ†ç ´ï¼šé’ˆå¯¹ä½ ä»£ç é‡Œé‚£äº›â€œä¼‘æ¯æ¨¡å¼â€æˆ–â€œå°é¢â€çš„é»‘ç™½å¼ºåˆ¶æŒ‡ä»¤ */
.resting-mode, 
.resting-mode *,
.status-reflect-img,
.gallery-card-bg,
.character-avatar {
    filter: none !important;
    -webkit-filter: none !important;
    grayscale: 0 !important; /* å¼ºåˆ¶ç°åº¦å½’é›¶ */
}

/* 3. é”å®šæ‰€æœ‰å¤´åƒå’Œç…§ç‰‡æ ‡ç­¾çš„è‰²å½© */
.film-photo-wrapper img,
.ai-visual-frame img,
.history-thumb-img,
.character-avatar,
.dial-avatar-box img,
.status-reflect-img,
#radio-avatar,
#disc-avatar,
img[src*="avatar"] {
    filter: none !important;
    -webkit-filter: none !important;
    mix-blend-mode: normal !important;
    opacity: 1 !important;
}

/* 4. ç§»é™¤å¯èƒ½å­˜åœ¨çš„é®ç½©å±‚å½±å“ï¼ˆå¦‚ Noir é£æ ¼çš„åŠé€æ˜å‹æš—ï¼‰ */
.mag-overlay,
.hero-overlay,
.vibe-overlay {
    background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.6) 100%) !important;
    /* ä»…ä¿ç•™åº•éƒ¨é®ç½©ç¡®ä¿æ–‡å­—æ¸…æ™°ï¼Œç§»é™¤æ•´ä½“çš„æš—è‰²æ»¤é•œ */
}
/* ğŸš¨ å¼ºåˆ¶æ˜¾å½¢ï¼šé‚€çº¦åŠ è½½åŠ¨ç”»åè®® */
#synergy-invite-loading {
    position: fixed !important;
    inset: 0 !important;
    display: none; /* ç”± JS æ§åˆ¶åˆ‡æ¢ flex */
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.8) !important;
    backdrop-filter: blur(20px) saturate(180%) !important;
    -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
    /* æƒå€¼ç‰©ç†ç½®é¡¶ï¼Œç¡®ä¿ç›–è¿‡é‚€çº¦å¡ç‰‡ */
    z-index: 3000000 !important; 
}

#synergy-invite-loading .radar-scanner {
    width: 120px !important;
    height: 120px !important;
    border: 1px solid rgba(0, 122, 255, 0.2) !important;
    box-shadow: 0 0 30px rgba(0, 122, 255, 0.1);
}

/* ä¿¡å·æ‰«ææ¡åŠ¨ç”»å¢å¼º */
#synergy-invite-loading .radar-beam {
    background: conic-gradient(from 0deg, transparent 0%, rgba(0, 122, 255, 0.3) 50%, transparent 100%) !important;
}
/* ğŸš¨ ç‰©ç†ç¾åŒ–ï¼šç”µå°æŒ‡ä»¤åŒº */
.dial-instruction {
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace !important;
    font-size: 11px !important;
    letter-spacing: 3px !important;
    color: #007AFF !important; /* ç»å…¸ä¿¡å·è“ */
    text-transform: uppercase !important;
    padding: 15px 0 10px 0;
    border-bottom: 1px solid rgba(0, 122, 255, 0.2);
    margin-bottom: 20px;
    font-weight: 600 !important;
    text-shadow: 0 0 8px rgba(0, 122, 255, 0.4); /* è§å…‰æ„Ÿ */
    display: flex;
    align-items: center;
}

.dial-instruction::before {
    content: "â—";
    margin-right: 8px;
    animation: signal-blink 1.5s infinite;
}

@keyframes signal-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* ğŸš¨ NPC ç¤¾åŒºå®¹å™¨ */
#npc-community-zone {
    width: 100%;
    margin-top: 10px;
    padding-bottom: 50px;
    padding: 10px 15px;
    background: transparent;
}

.npc-community-card {
    background: rgba(255, 255, 255, 0.03);
    border-left: 2px solid rgba(255, 255, 255, 0.1);
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.npc-community-card:hover {
    background: rgba(0, 122, 255, 0.05);
    border-left-color: #007AFF;
}

.npc-meta {
    font-size: 10px;
    color: #8E8E93;
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-family: monospace;
}

.npc-comment {
    font-size: 13px;
    color: #333;
    line-height: 1.6;
    font-weight: 400;
}

.npc-genre-tag {
    font-size: 9px;
    padding: 2px 6px;
    background: rgba(0, 0, 0, 0.05);
    color: #555;
    border-radius: 4px;
}

/* ğŸŒ€ æ‰«é¢‘æŒ‰é’®ç¾åŒ– */
.btn-signal-sync {
    width: 100%;
    padding: 12px;
    background: rgba(0, 122, 255, 0.05);
    border: 1px dashed rgba(0, 122, 255, 0.4);
    color: #007AFF;
    font-family: monospace;
    font-size: 11px;
    letter-spacing: 2px;
    margin-bottom: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-signal-sync:active {
    background: rgba(0, 122, 255, 0.15);
    transform: scale(0.98);
}

/* ğŸšï¸ ç»´åº¦æ ‡ç­¾é¡µ (Tabs) */
.npc-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 10px;
}

.npc-tab-item {
    font-size: 10px;
    color: #8E8E93;
    cursor: pointer;
    font-family: monospace;
    padding: 5px 10px;
    border: 1px solid transparent;
}

.npc-tab-item.active {
    color: #007AFF;
    border: 1px solid rgba(0, 122, 255, 0.3);
    background: rgba(0, 122, 255, 0.05);
}

/* ğŸš¨ ç‰©ç†é‡æ„ï¼šæ¡£æ¡ˆå¼å¸–å­å¡ç‰‡ */
.npc-post-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(0, 122, 255, 0.1); /* æå…¶ç»†å¾®çš„è“è‰²è¾¹æ¡† */
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    backdrop-filter: blur(5px);
    border-radius: 2px; /* ä¿æŒç¡¬æœ— */
    isolation: isolate; 
    z-index: 2 !important;
}

.npc-post-card:hover {
    background: rgba(0, 122, 255, 0.05);
    border-color: rgba(0, 122, 255, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

/* è£…é¥°ï¼šå·¦ä¸Šè§’çš„ä¿¡å·èŠ‚ç‚¹å· */
.npc-post-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: #007AFF;
    opacity: 0.3;
}

.npc-post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.npc-identity-group {
    display: flex;
    flex-direction: column;
}

.npc-post-id {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    color: #007AFF;
    letter-spacing: 1px;
    margin-bottom: 4px;
}

.npc-post-name {
    font-size: 14px;
    font-weight: 700;
    color: #333;
    letter-spacing: -0.5px;
}

/* å†…å®¹åŒºç¾åŒ– */
.npc-post-content {
    font-size: 14px;
    color: #444;
    line-height: 1.6;
    margin-bottom: 20px;
    font-weight: 400;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-align: justify;
}

/* åº•éƒ¨äº’åŠ¨åŒºï¼šæ¨ªå‘åˆ†å¸ƒå¼æ’ç‰ˆ */
.npc-post-stats {
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding-top: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.stats-left {
    display: flex;
    gap: 15px;
}

.stat-item {
    display: flex;
    align-items: center;
    color: #8E8E93;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
}

/* ä¿¡å·å¼ºåº¦è§†è§‰æ¡ */
.signal-strength-viz {
    display: flex;
    gap: 2px;
    align-items: flex-end;
}

.sig-bar {
    width: 2px;
    background: #007AFF;
    opacity: 0.2;
}

.sig-bar.active {
    opacity: 1;
}

/* ğŸ“ å¸–å­è¯¦æƒ…é¡µ (æ¡£æ¡ˆæ¨¡å¼) */
#npc-post-detail-overlay {
    position: fixed;
    inset: 0;
    background: #fff; /* ä¿æŒä½ çš„ç™½è‰²ç®€çº¦åŸºè°ƒ */
    z-index: 3000005;
    display: none;
    flex-direction: column;
    padding: 25px;
    overflow-y: auto;
}

.detail-archive-header {
    border-bottom: 2px solid #000;
    padding-bottom: 15px;
    margin-bottom: 25px;
}

.detail-id-tag {
    display: inline-block;
    background: #000;
    color: #fff;
    padding: 4px 8px;
    font-size: 10px;
    font-family: monospace;
    margin-bottom: 10px;
}

.detail-main-text {
    font-size: 18px;
    line-height: 1.8;
    color: #000;
    font-weight: 500;
    margin-bottom: 40px;
    letter-spacing: -0.02em;
}

.detail-metadata-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    border-top: 1px solid #E5E5E5;
    padding-top: 20px;
    font-family: monospace;
    font-size: 11px;
    color: #8E8E93;
}

.metadata-item b { color: #000; }
/* ğŸš¨ ç‰©ç†å¼ºåˆ¶ï¼šé‡Šæ”¾ç¤¾åŒºé¡µé¢çºµå‘æ»‘åŠ¨æƒ */
#npc-community-zone {
    /* 1. ç‰©ç†å°ºå¯¸é”å®š */
    height: auto !important;
    max-height: 80vh !important; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢æ’‘çˆ†å®¹å™¨ */
    
    /* 2. çºµå‘æ»‘åŠ¨å¼ºåˆ¶ç‚¹ç« */
    overflow-y: auto !important;
    overflow-x: hidden !important; /* ç¦æ­¢å·¦å³æ™ƒåŠ¨ */
    
    /* 3. è§¦æ‘¸åè®®ä¿®æ­£ */
    touch-action: pan-y !important; /* å‘Šè¯‰æµè§ˆå™¨ï¼šåœ¨è¿™ä¸ªåŒºåŸŸï¼Œåªå‡†ä¸Šä¸‹æ»‘ */
    
    /* 4. iOS ä¸æ»‘æ»šåŠ¨è¡¥ä¸ */
    -webkit-overflow-scrolling: touch !important; 
    
    padding-bottom: 300px !important; /* ç»™åº•éƒ¨ç•™å‡ºå‘¼å¸ç©ºé—´ */
}

/* ğŸš¨ åµŒå¥—å®¹å™¨æ»šåŠ¨ä¿æŠ¤ */
#npc-feed-container {
    display: block !important;
    height: auto !important;
}

/* ğŸš¨ è¯¦æƒ…é¡µå…¨å±æ»šåŠ¨é”å®š */
#npc-post-detail-overlay {
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    touch-action: pan-y !important;
    padding-bottom: 50px !important;
}

/* éšè—æ»šåŠ¨æ¡ç¾åŒ–ï¼ˆå¯é€‰ï¼Œä¿æŒå¹²å‡€æ„Ÿï¼‰ */
#npc-community-zone::-webkit-scrollbar {
    display: none; /* è®©æ»‘åŠ¨æ›´åƒåŸç”Ÿ App */
}
/* ğŸš¨ ç‰©ç†å‡çº§ï¼šæç®€å·¥ä¸šé£æ ‡ç­¾é¡µ */
.npc-tabs {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 10px 0 20px 0;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE */
}

.npc-tabs::-webkit-scrollbar { display: none; } /* Chrome/Safari */

.npc-tab-item {
    flex-shrink: 0;
    padding: 6px 14px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #8E8E93;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

/* æ¿€æ´»çŠ¶æ€ï¼šè“è‰²è§å…‰ç¼éš™æ„Ÿ */
.npc-tab-item.active {
    color: #007AFF;
    background: rgba(0, 122, 255, 0.08);
    border-color: #007AFF;
    box-shadow: 0 0 10px rgba(0, 122, 255, 0.15);
}

/* è£…é¥°æ€§çš„å°ç‚¹ï¼Œä»£æ›¿ä¸‘ Emoji */
.npc-tab-item::before {
    content: "â—‡";
    margin-right: 6px;
    font-size: 8px;
    vertical-align: middle;
}

.npc-tab-item.active::before {
    content: "â—†";
    color: #007AFF;
}

/* å¸–å­è¯¦æƒ…é¡µçš„è¯„è®ºç¾åŒ–ï¼šæ›´åƒä¸“ä¸šè®ºå› */
.comment-item {
    background: #fcfcfc;
    padding: 12px;
    border-radius: 2px;
    border-left: 2px solid #EEE;
    margin-bottom: 12px;
}
/* ğŸš¨ ç‰©ç†çº åï¼šé˜²æ­¢ç¤¾åŒºå¡ç‰‡é®æŒ¡å¥½å‹é€‰æ‹©åŒº */

/* ğŸš¨ æ‰¾åˆ°ä½ çš„é¡¶éƒ¨å®¹å™¨ï¼ˆåŒ…å«æ ‡é¢˜å’Œå¥½å‹ç¯çš„é‚£ä¸ªï¼‰ */
.dial-instruction, 
#synergy-radio-interface .contact-list-container {
    flex-shrink: 0 !important;   /* æ ¸å¿ƒï¼šå¼ºåˆ¶ä¸è®¸è¢«æŒ¤å‹ */
    position: sticky !important;  /* ç²˜æ€§å®šä½ */
    top: 0;
    z-index: 10000;              /* ç¡®ä¿å±‚çº§æœ€é«˜ */
    background: #fff;            /* å¿…é¡»ç»™èƒŒæ™¯è‰²ï¼Œå¦åˆ™æ»šåŠ¨æ—¶åé¢å¸–å­ä¼šé€å‡ºæ¥ */
}

/* ğŸš¨ ä¿®æ”¹ä½ åŸæ¥çš„ #npc-community-zone æ ·å¼ */
#npc-community-zone {
    /* 1. é”æ­»é«˜åº¦ï¼Œä¸è®©å®ƒæ’‘å¼€å¤–éƒ¨é¡µé¢ */
    flex: 1 !important;          /* å æ®å‰©ä¸‹çš„æ‰€æœ‰ç©ºé—´ */
    height: 400px !important;    /* å®è´ï¼Œè¿™é‡Œç»™ä¸ªå›ºå®šé«˜åº¦ï¼ˆæ ¹æ®ä½ æ‰‹æœºç•Œé¢è°ƒæ•´ï¼‰ */
    
    /* 2. å†…éƒ¨æ»šåŠ¨ */
    overflow-y: auto !important; 
    overflow-x: hidden !important;
    
    /* 3. ç‰©ç†éš”ç¦» */
    position: relative !important;
    margin-top: 10px !important;
    
    /* 4. æ¶ˆé™¤é—ªçƒ */
    -webkit-overflow-scrolling: touch;
}

/* ç¡®ä¿å¸–å­å®¹å™¨æœ¬èº«ä¸è¦ä¹±è·³ */
#npc-feed-container {
    padding-top: 5px;
}

/* 3. é’ˆå¯¹å¡ç‰‡çš„ç‰©ç†å±‚çº§ä¿®æ­£ */
.npc-post-card {
    /* ç¡®ä¿ç£¨ç ‚æ»¤é•œä¸ä¼šäº§ç”Ÿæ–°çš„å †å ä¸Šä¸‹æ–‡å¹²æ‰°åˆ°çˆ¶çº§ */
    isolation: isolate; 
    z-index: 2 !important;
}
/* ğŸš¨ è¯¦æƒ…é¡µä¸“ç”¨ç‰©ç†æ ·å¼ */
#npc-post-detail-overlay {
    padding: 25px !important;
    background: #ffffff !important;
    font-family: 'Montserrat', sans-serif;
}

.detail-nav-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
}

.detail-back-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    color: #000;
}

/* äº’åŠ¨ä»ªè¡¨ç›˜ */
.detail-stats-dashboard {
    display: flex;
    justify-content: space-around;
    padding: 20px 0;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
    margin: 30px 0;
}

.dashboard-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.dashboard-item span {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 700;
    color: #000;
}

.dashboard-item label {
    font-size: 9px;
    color: #8E8E93;
    letter-spacing: 1px;
}

.detail-main-text {
    font-size: 17px;
    line-height: 1.8;
    color: #1c1c1e;
    letter-spacing: -0.01em;
    margin-bottom: 40px;
    text-align: justify;
}

.comment-header-strip {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: #007AFF;
    background: rgba(0, 122, 255, 0.05);
    padding: 5px 10px;
    margin-bottom: 20px;
    display: inline-block;
}
/* ğŸš¨ å¢å¼ºï¼šå…±é¸£æŒ‰é’®ç¾åŒ– */
.btn-boost {
    background: transparent;
    border: 1px solid #007AFF;
    color: #007AFF;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    padding: 8px 20px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
    overflow: hidden;
    text-transform: uppercase;
}

.btn-boost:hover {
    background: rgba(0, 122, 255, 0.1);
    box-shadow: 0 0 15px rgba(0, 122, 255, 0.3);
}

/* æŒ‰é’®ç‚¹å‡»æ—¶çš„è„‰å†²æ³¢çº¹ */
.btn-boost:active::after {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0, 122, 255, 0.2);
    animation: pulse 0.4s ease-out;
}

@keyframes pulse {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(1.5); }
}
/* ğŸ’¬ NPC è¯„è®ºæ¡ç›®å¢å¼º */
.npc-comment-item {
    background: rgba(0, 0, 0, 0.02);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    border-left: 3px solid #007AFF;
    animation: fadeInUp 0.4s ease-out;
}

.comment-user-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.comment-uid {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: #007AFF;
    font-weight: 800;
}

.comment-text {
    font-size: 14px;
    color: #1c1c1e;
    line-height: 1.6;
    margin-bottom: 12px;
}

/* ğŸ“Š è¯„è®ºäº’åŠ¨æ•°æ®è¡Œ */
.comment-interact-bar {
    display: flex;
    gap: 15px;
    border-top: 0.5px solid rgba(0,0,0,0.05);
    padding-top: 10px;
}

.comment-stat-unit {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: #8E8E93;
    font-weight: 600;
}

.comment-stat-unit svg {
    opacity: 0.6;
}
/* ğŸ—„ï¸ å›å¤æŠ½å±‰å®¹å™¨ */
.npc-reply-sheet {
    width: 100%;
    background: #fff;
    border-radius: 24px 24px 0 0;
    max-height: 80vh; /* æœ€é«˜å æ®å±å¹• 80% */
    display: flex;
    flex-direction: column;
    animation: sheetSlideUp 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

@keyframes sheetSlideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.sheet-handle {
    width: 40px; height: 5px; background: #e5e5ea;
    border-radius: 10px; margin: 12px auto;
}

.sheet-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 20px 15px; border-bottom: 0.5px solid #f2f2f7;
}

.sheet-title { font-size: 15px; font-weight: 800; color: #1c1c1e; }
.sheet-close { color: #007AFF; font-weight: 700; cursor: pointer; font-size: 15px; }

.sheet-body {
    flex: 1; overflow-y: auto; padding: 20px;
    -webkit-overflow-scrolling: touch;
}

/* æŠ½å±‰é‡Œçš„åŸè¯„è®ºç½®é¡¶æ ·å¼ */
.original-comment-box {
    background: #f8f8f8; padding: 15px; border-radius: 12px;
    margin-bottom: 25px; border-left: 4px solid #007AFF;
}

.reply-divider {
    font-size: 10px; color: #bbb; font-weight: 800;
    letter-spacing: 2px; margin-bottom: 15px; text-transform: uppercase;
}

/* ğŸ”» å­å›å¤è¾“å…¥æ¡†å®¹å™¨ï¼šé»˜è®¤é«˜åº¦ä¸º0 */
.nested-reply-box {
    height: 0;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    background: #f9f9f9;
    border-radius: 12px;
    margin-top: 0;
    opacity: 0;
}

/* æ¿€æ´»çŠ¶æ€ */
.nested-reply-box.active {
    height: 130px; /* å±•å¼€é«˜åº¦ */
    margin-top: 10px;
    padding: 12px;
    opacity: 1;
}

/* æŠ½å±‰é¡¶éƒ¨æ•°æ®æ¡ */
.sheet-stats-bar {
    display: flex;
    gap: 15px;
    padding: 10px 0;
    margin-bottom: 15px;
    border-bottom: 0.5px solid #f2f2f7;
}

/* å­å›å¤çš„æ“ä½œæŒ‰é’® */
.sub-interact-btns {
    display: flex;
    gap: 12px;
    margin-top: 8px;
}

.sub-btn {
    font-size: 10px;
    font-weight: 700;
    color: #007AFF;
    background: rgba(0, 122, 255, 0.05);
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
}
.view-more-replies-btn {
    display: inline-flex;
    align-items: center;
    margin-top: 10px;
    color: #8E8E93;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    padding: 5px 0;
}

.view-more-replies-btn::before {
    content: "";
    width: 20px;
    height: 1px;
    background: #eee;
    margin-right: 8px;
}

.view-more-replies-btn:active {
    opacity: 0.5;
}
/* é«˜çº§å·¥ä¸šé£ HOT æ ‡ç­¾ */
.hot-tag-luxe {
    font-size: 8px;
    color: #FF3B30;
    border: 1px solid #FF3B30;
    padding: 1px 5px;
    border-radius: 4px;
    font-weight: 900;
    margin-left: 10px;
    letter-spacing: 0.5px;
    background: rgba(255, 59, 48, 0.05); /* æ·¡æ·¡çš„çº¢åº•ï¼Œæ›´æœ‰è´¨æ„Ÿ */
    vertical-align: middle;
    display: inline-block;
}
/* 5. ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
.reply-btn, .transmit-btn {
    flex-shrink: 0 !important; /* ç¡®ä¿æŒ‰é’®å½¢çŠ¶ä¸å˜ */
    white-space: nowrap;      /* ç¡®ä¿æ–‡å­—ä¸æ¢è¡Œ */
}

/* é’ˆå¯¹ SEND æŒ‰é’®çš„ç‰¹å®šè°ƒæ•´ */
.transmit-btn {
    height: 32px;      /* ç¨å¾®è°ƒä½é«˜åº¦é€‚é…æ¯”ä¾‹ */
    padding: 0 12px;
    font-size: 10px;
}
/* ä¸“è¾‘å°é¢æ—‹è½¬åŠ¨ç”» */
@keyframes spinCover {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.album-cover.playing {
    animation: spinCover 12s linear infinite;
    border: 2px solid #fff;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
}
/* ğŸš¨ ç‰©ç†å¼ºåˆ¶è¡¥ä¸ï¼šåº•éƒ¨é˜²é®æŒ¡ä¸“ç”¨ */
#npc-community-zone,          /* ç¤¾åŒºåˆ—è¡¨é¡µ */
#npc-post-detail-overlay,     /* å¸–å­è¯¦æƒ…é¡µ */
#npc-feed-container,          /* å¸–å­å®¹å™¨ */
.sheet-body                   /* åº•éƒ¨å›å¤æŠ½å±‰ */ 
{
    /* æš´åŠ›ç»™ 220pxï¼Œè¶³ä»¥é¿å¼€ä»»ä½•å¯¼èˆªæ ã€è¾“å…¥æ¡†å’Œ iPhone åº•éƒ¨æ¨ªæ¡ */
    padding-bottom: 85px !important; 
    
    /* ç¡®ä¿æœ€åä¸€æ¡å†…å®¹èƒ½å®Œæ•´éœ²å‡ºæ¥ */
    box-sizing: border-box !important;
}

/* --- ğŸ“ Phone App ä¸“å±æ ·å¼ --- */

/* 1. ç”µè¯ä¸»å®¹å™¨ */
.phone-view-container {
    width: 100%;
    height: 100%;
    display: none; /* é»˜è®¤éšè—ï¼Œç”± JS æ§åˆ¶ */
    flex-direction: column;
    animation: fadeIn 0.3s ease;
}
.phone-view-container.active {
    display: flex;
}

/* 2. æ‹¨å·é”®ç›˜ (Keypad) - æç®€åœ†çƒ */
.keypad-display-area {
    flex: 1;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 20px;
}
#keypad-number-display {
    font-size: 36px;
    font-weight: 300;
    color: #000;
    letter-spacing: 2px;
    min-height: 50px;
}

.keypad-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px 25px;
    padding: 0 40px 120px 40px; /* åº•éƒ¨ç•™ç™½ç»™å¯¼èˆªæ  */
    justify-items: center;
}

.keypad-btn {
    width: 72px;
    height: 72px;
    background: #E5E5EA; /* iOS æµ…ç° */
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
}
.keypad-btn:active { background: #D1D1D6; }

.key-num { font-size: 28px; font-weight: 500; color: #000; line-height: 1; }
.key-alpha { font-size: 9px; font-weight: 700; color: #000; letter-spacing: 1px; margin-top: 2px; }

/* å‘¼å«æŒ‰é’® */
.keypad-call-btn {
    width: 72px; height: 72px;
    background: #34C759; /* ç”µè¯ç»¿ */
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff;
    box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4);
    cursor: pointer;
    transition: transform 0.2s;
}
.keypad-call-btn:active { transform: scale(0.95); }

/* 3. é€šè¯è®°å½• (Recents) - çº¢é»‘é£æ ¼ */
.recents-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px 0 100px 0;
}
.recent-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
    cursor: pointer;
}
.recent-item:active { background: #F2F2F7; }
.call-type-icon { width: 16px; margin-right: 12px; }
.call-info { flex: 1; }
.caller-name { font-size: 17px; font-weight: 600; color: #000; }
.caller-name.missed { color: #FF3B30; } /* æœªæ¥æ¥ç”µçº¢è‰² */
.call-meta { font-size: 12px; color: #8E8E93; margin-top: 2px; }
.call-time { font-size: 14px; color: #8E8E93; }
.info-icon { color: #007AFF; margin-left: 10px; }

/* 4. æ¶²æ€ç»ç’ƒå¯¼èˆªæ  (Bottom Nav) */
.phone-glass-nav-wrapper {
    position: absolute;
    bottom: 35px;
    left: 0; 
    width: 100%;
    display: flex; 
    justify-content: center;
    z-index: 100;
    pointer-events: none; /* ç©¿é€ç©ºç™½åŒºåŸŸ */
}

.phone-glass-nav {
    pointer-events: auto;
    display: flex;
    gap: 30px;
    padding: 12px 35px;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    border-radius: 40px; /* å®Œç¾çš„åœ†è§’èƒ¶å›Š */
    box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    border: 0.5px solid rgba(255,255,255,0.4);
}

.p-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: #C7C7CC; /* æœªé€‰ä¸­ç°è‰² */
    transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    cursor: pointer;
}

.p-nav-item svg {
    width: 24px; height: 24px;
    fill: currentColor;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05));
}

.p-nav-item span {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ·±è“ + ä¸Šæµ® */
.p-nav-item.active {
    color: #007AFF; 
    transform: translateY(-2px);
}
.p-nav-item.active svg {
    filter: drop-shadow(0 4px 8px rgba(0, 122, 255, 0.25));
}
/* ğŸš¨ å¼ºåˆ¶è¦†ç›–ï¼šç”µè¯ App çš„å¤´éƒ¨æ ·å¼ */
#phoneApp .app-header {
    justify-content: flex-start !important; /* å¼ºåˆ¶é å·¦ */
    padding-left: 25px !important;         /* å·¦è¾¹ç•™å‡ºå‘¼å¸æ„Ÿ */
    padding-top: 50px !important;          /* é¿å¼€çŠ¶æ€æ  */
    height: auto !important;               /* é«˜åº¦è‡ªé€‚åº” */
    margin-bottom: 10px;
}

#phoneApp .header-title-big {
    font-family: -apple-system, sans-serif;
    font-size: 34px !important;     /* è¶…å¤§å­—å· */
    font-weight: 800 !important;    /* ç‰¹ç²— */
    color: #000000 !important;      /* çº¯é»‘ */
    text-align: left !important;    /* æ–‡å­—å·¦å¯¹é½ */
    letter-spacing: -1px;           /* iOS é£æ ¼ç´§å‡‘é—´è· */
    flex: none !important;          /* ä¸è¦è‡ªåŠ¨ä¼¸ç¼© */
}

/* éšè—å·¦è¾¹çš„å ä½å—ï¼Œé˜²æ­¢å®ƒæŠŠæ ‡é¢˜æŒ¤èµ° */
#phoneApp .app-header > div:first-child {
    display: none !important; 
}
/* ğŸš¨ ç´§æ€¥ä¿®å¤ï¼šå°†å¯¼èˆªæ æ”¹ä¸ºå…¨å®½ã€è´´åº•çš„åŸç”Ÿæ ·å¼ */

/* 1. ä¿®æ”¹å¤–å±‚åŒ…è£…å™¨ï¼šè®©å®ƒä¸å†æ‚¬æµ®ï¼Œè€Œæ˜¯å¡«æ»¡åº•éƒ¨ */
.phone-glass-nav-wrapper {
    bottom: 0 !important;       /* å¼ºåˆ¶è´´åˆ°åº•éƒ¨ */
    left: 0 !important;
    width: 100% !important;     /* å¼ºåˆ¶å æ»¡å…¨å®½ */
    padding: 0 !important;      /* å»æ‰å·¦å³çš„ç•™ç™½ */
    display: block !important;  /* ä¸éœ€è¦ flex å±…ä¸­äº† */
}

/* 2. ä¿®æ”¹å¯¼èˆªæ æœ¬ä½“ï¼šå»æ‰åœ†è§’å’Œè¾¹æ¡†ï¼Œå˜æˆé€šæ  */
.phone-glass-nav {
    width: 100% !important;
    border-radius: 0 !important; /* âŒ å»æ‰åœ†è§’ï¼Œå˜ç›´è§’ */
    margin: 0 !important;        /* å»æ‰å¤–è¾¹è· */
    padding: 10px 0 20px 0 !important; /* è°ƒæ•´å†…è¾¹è· (åº•éƒ¨ç•™ç‚¹ç©ºé—´ç»™ iPhone æ¨ªæ¡) */
    
    box-shadow: none !important; /* âŒ å»æ‰æµ®èµ·æ¥çš„é˜´å½± */
    border: none !important;     /* âŒ å»æ‰è¾¹æ¡† */
    border-top: 0.5px solid rgba(0, 0, 0, 0.1) !important; /* âœ… åŠ ä¸€æ¡ç»†çš„é¡¶éƒ¨åˆ†å‰²çº¿ */
    
    justify-content: space-around !important; /* âœ… è®©ä¸‰ä¸ªå›¾æ ‡åœ¨æ¨ªå‘ä¸Šå‡åŒ€åˆ†å¸ƒ */
    gap: 0 !important; /* å»æ‰ä¹‹å‰çš„å›ºå®šé—´è· */
    
    /* ä¿æŒæ¯›ç»ç’ƒèƒŒæ™¯ï¼Œçœ‹èµ·æ¥æ›´é«˜çº§ */
    background: rgba(255, 255, 255, 0.9) !important;
}

/* 3. è®©æ¯ä¸ªå¯¼èˆªé¡¹å¹³åˆ†å®½åº¦ */
.p-nav-item {
    flex: 1 !important; /* æ¯ä¸ªé¡¹å  1/3 å®½åº¦ */
    padding: 0 !important;
}
/* ğŸš¨ æš´åŠ›ä¿®æ­£ï¼šæŠŠç”µè¯ App çš„æ ‡é¢˜å¾€ä¸Šæ */
#phoneApp .app-header {
    /* æ ¸å¿ƒï¼šæŠŠä¹‹å‰çš„ 50px ç æ‰ï¼Œæ”¹æˆ 15px å°±å¾ˆç´§å‡‘äº† */
    padding-top: 15px !important; 
    
    /* ç¡®ä¿é«˜åº¦ä¸ä¼šè¢«æ’‘å¾—å¤ªç¦»è°± */
    height: auto !important;
    min-height: 50px !important;
    
    /* å¼ºåˆ¶å‚ç›´å±…ä¸­ï¼Œé˜²æ­¢æ–‡å­—åä¸‹ */
    align-items: center !important;
    
    /* ä¿æŒå·¦å¯¹é½ */
    justify-content: flex-start !important;
    padding-left: 25px !important;
}

/* é¡ºæ‰‹æŠŠæ ‡é¢˜æ–‡å­—çš„ä¸Šä¸‹è¾¹è·ä¹Ÿæ¸…é›¶ï¼Œç¡®ä¿å®ƒè´´é¡¶ */
#phoneApp .header-title-big {
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1 !important; /* ç´§å‡‘è¡Œé«˜ */
    transform: translateY(0) !important; /* é˜²æ­¢æœ‰ä½ç§» */
}
/* ğŸš¨ ç”µè¯ App å¤´éƒ¨ç»ˆæä¿®æ­£ï¼šå·¦æ ‡é¢˜ï¼Œå³æŒ‰é’® */
#phoneApp .app-header {
    display: flex !important;
    justify-content: space-between !important; /* æ ¸å¿ƒï¼šæ’‘å¼€ä¸¤å¤´ */
    align-items: center !important;
    
    /* é—´è·å¾®è°ƒ */
    padding-top: 15px !important;  /* ç´§å‡‘é«˜åº¦ */
    padding-left: 25px !important; /* æ ‡é¢˜å·¦è¾¹è· */
    padding-right: 25px !important;/* æŒ‰é’®å³è¾¹è· */
    height: 50px !important;       /* é”å®šé«˜åº¦ï¼Œé˜²æ­¢ä¹±è·³ */
}

/* æ ‡é¢˜æ ·å¼ï¼šé å·¦ï¼Œé»‘è‰²ï¼Œå·¨å¤§ */
#phoneApp .header-title-big {
    text-align: left !important;
    flex: 1 !important;            /* å æ®ä¸­é—´æ‰€æœ‰ç©ºç™½ï¼ŒæŠŠæŒ‰é’®æŒ¤åˆ°æœ€å³ */
    font-size: 34px !important;
    font-weight: 800 !important;
    color: #000 !important;
    margin: 0 !important;
    line-height: 1 !important;
}

/* éšè—å·¦ä¾§é‚£ä¸ªæ²¡ç”¨çš„é€æ˜å ä½å—ï¼Œé˜²æ­¢å®ƒæ£ä¹± */
#phoneApp .app-header > div:first-child {
    display: none !important;
}

/* ç¡®ä¿å…³é—­æŒ‰é’®å¯è§ä¸”ä½ç½®æ­£ç¡® */
#phone-close-btn {
    width: 32px !important;
    height: 32px !important;
    background: #e5e5ea !important; /* ç»™ä¸ªæµ…ç°èƒŒæ™¯ï¼Œæ›´åƒåŸç”ŸæŒ‰é’® */
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}
/* ğŸš¨ ç‰©ç†ä¸‹æ²‰è¡¥ä¸ï¼šè®©é”®ç›˜è´´è¿‘åº•éƒ¨å¯¼èˆª */
.keypad-grid {
    /* æ ¸å¿ƒï¼šä»åŸæ¥çš„ 120px å‡å°‘åˆ° 90px */
    /* 90px å¤§çº¦æ˜¯å¯¼èˆªæ çš„é«˜åº¦+ä¸€ç‚¹ç‚¹ç©ºéš™ï¼Œæ—¢ä¸ä¼šè¢«é®ä½ï¼Œåˆç¦»å¾—å¾ˆè¿‘ */
    padding-bottom: 30px !important; 
    
    /* å¢åŠ ä¸€ç‚¹é¡¶éƒ¨çš„æ¨åŠ›ï¼ŒæŠŠæ•´ä¸ªé”®ç›˜åŒºå¾€ä¸‹å‹ */
    margin-top: auto !important; 
}

/* é…åˆè°ƒæ•´ï¼šè®©ä¸Šé¢çš„æ•°å­—æ˜¾ç¤ºåŒºä¸è¦å å¤ªå¤šç©ºé—´ï¼Œå…è®¸é”®ç›˜ä¸Šæ¥ */
.keypad-display-area {
    /* ä» flex:1 æ”¹ä¸º flex:0.6ï¼Œé‡Šæ”¾ç©ºé—´ç»™ä¸‹æ²‰ */
    flex: 0.8 !important; 
    padding-bottom: 10px !important; /* å‡å°‘æ•°å­—å’Œé”®ç›˜ä¹‹é—´çš„ç©ºéš™ */
}
/* --- ğŸš¨ æ‹¨å·é¡µï¼šé¡¶éƒ¨é€Ÿæ‹¨æ  (Quick Dial) --- */
.quick-dial-section {
    padding: 10px 0 0 0;
    width: 100%;
    display: flex;
    flex-direction: column;
    height: 110px; /* å›ºå®šé«˜åº¦åŒº */
    flex-shrink: 0;
}

.quick-label {
    padding-left: 25px;
    font-size: 10px;
    font-weight: 800;
    color: #C7C7CC;
    letter-spacing: 2px;
    margin-bottom: 12px;
    text-transform: uppercase;
}

.quick-scroll-wrapper {
    display: flex;
    overflow-x: auto;
    padding: 0 20px;
    gap: 20px;
    scrollbar-width: none; /* Firefox */
    -webkit-overflow-scrolling: touch;
}
.quick-scroll-wrapper::-webkit-scrollbar { display: none; } /* Chrome/Safari */

.quick-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    flex-shrink: 0;
    width: 60px;
    transition: transform 0.2s;
}

.quick-item:active { transform: scale(0.95); opacity: 0.7; }

/* å¤´åƒï¼šæç®€é»‘ç™½é£ */
.quick-avatar {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    object-fit: cover;
    background: #F2F2F7;
    border: 1.5px solid #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    filter: grayscale(100%); /* ğŸš¨ æ ¸å¿ƒï¼šå¼ºåˆ¶é»‘ç™½ï¼Œæ˜¾å¾—é«˜çº§ */
}

.quick-name {
    font-size: 10px;
    font-weight: 700;
    color: #1d1d1f;
    text-align: center;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- ğŸ”¢ æ•°å­—æ˜¾ç¤ºåŒºå¾®è°ƒ --- */
.keypad-display-area {
    position: relative;
    padding: 0 40px 20px 40px;
    align-items: center; /* å‚ç›´å±…ä¸­ */
    justify-content: center;
}

#keypad-number-display {
    font-size: 38px;
    font-weight: 600;
    letter-spacing: 1px;
    color: #000;
    height: 50px;
    line-height: 50px;
}

/* éšè—çš„å°åˆ é™¤æŒ‰é’® */
.mini-del-btn {
    position: absolute;
    right: 30px; /* æ”¾åœ¨æ•°å­—å³è¾¹ */
    color: #C7C7CC;
    cursor: pointer;
    display: none; /* é»˜è®¤éšè—ï¼Œæœ‰æ•°å­—æ‰æ˜¾ç¤º */
    padding: 10px;
}
.mini-del-btn:active { color: #000; }
/* ğŸš¨ ç‰©ç†ä¸‹æ²‰è¡¥ä¸ï¼šè®©å·ç æ˜¾ç¤ºåŒºâ€œå â€åˆ°åº•éƒ¨ */
.keypad-display-area {
    /* 1. æ”¹å˜å¯¹é½æ–¹å¼ï¼šä»å±…ä¸­(center)æ”¹ä¸ºåº•éƒ¨å¯¹é½(flex-end) */
    align-items: flex-end !important;
    
    /* 2. å¾®è°ƒåº•éƒ¨é—´è·ï¼šæ§åˆ¶æ•°å­—å’Œé”®ç›˜ç¬¬ä¸€æ’çš„ç‰©ç†è·ç¦» */
    /* è§‰å¾—å¤ªè¿‘å°±æ”¹æˆ 20pxï¼Œå¤ªè¿œå°±æ”¹æˆ 0px */
    padding-bottom: 10px !important; 
    
    /* 3. ç¡®ä¿å®¹å™¨ä¾ç„¶å æ»¡ä¸­é—´çš„ç©ºéš™ */
    flex: 1 !important; 
    display: flex !important;
    justify-content: center !important;
    position: relative !important; /* ç¡®ä¿åˆ é™¤æŒ‰é’®èƒ½å®šä½ */
}

/* ğŸš¨ åŒæ­¥ä¿®æ­£åˆ é™¤æŒ‰é’®çš„ä½ç½® */
/* å› ä¸ºæ•°å­—ä¸‹æ²‰äº†ï¼Œåˆ é™¤æŒ‰é’®ä¹Ÿå¾—è·Ÿç€æ²‰ä¸‹æ¥ï¼Œä¸ç„¶ä¼šå¯¹ä¸é½ */
.mini-del-btn {
    top: auto !important;     /* å–æ¶ˆé¡¶éƒ¨å®šä½ */
    bottom: 20px !important;  /* ğŸš¨ ç‰©ç†é”å®šåˆ°åº•éƒ¨ (æ ¹æ® padding-bottom å¾®è°ƒ) */
    /* å‚ç›´å±…ä¸­ä¿®æ­£ï¼ˆå¦‚æœæ•°å­—å¤ªé«˜ï¼‰ */
    transform: translateY(-5px) !important; 
}
/* --- ğŸ“ ç”µè¯æ·»åŠ å¼¹çª—ï¼šNoir White é£æ ¼ (å¼ºåˆ¶æ‹‰ä¼¸ç‰ˆ) --- */

/* 1. å¼¹çª—å®¹å™¨ï¼šæ ¸å¿ƒä¿®æ”¹ï¼å»æ‰å››å‘¨å†…è¾¹è·ï¼Œè®©å®ƒç‰©ç†æ’‘æ»¡ */
.phone-add-sheet {
    width: 100vw !important;        /* ğŸš¨ å¼ºåˆ¶å æ»¡å±å¹•å®½åº¦ */
    max-width: none !important;     /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ */
    background: #ffffff;
    border-radius: 24px 24px 0 0;
    
    /* ğŸš¨ å…³é”®ï¼šè¿™é‡Œæ”¹æˆ 0ï¼Œä¸è¦è®©çˆ¶å®¹å™¨æŒ¤å‹å­å…ƒç´  */
    padding: 0 !important;          
    
    box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
    animation: sheetSlideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex;
    flex-direction: column;
    max-height: 85vh;
    overflow: hidden; /* é˜²æ­¢åœ†è§’è¢«ç›´è§’å­å…ƒç´ é®æŒ¡ */
}

.sheet-handle-bar {
    width: 36px; height: 4px; background: #E5E5EA; border-radius: 2px;
    margin: 12px auto; /* ç¨å¾®è°ƒæ•´ä¸€ä¸‹ä¸Šä¸‹ä½ç½® */
}

/* 2. å¤´éƒ¨ï¼šå› ä¸ºçˆ¶å®¹å™¨æ²¡äº† paddingï¼Œè¿™é‡Œè¦è‡ªå·±åŠ å›æ¥ */
.phone-add-header {
    display: flex; justify-content: space-between; align-items: center;
    /* ğŸš¨ å…³é”®ï¼šç»™å¤´éƒ¨å•ç‹¬åŠ å·¦å³è¾¹è· (24px) */
    padding: 0 24px 15px 24px !important; 
    margin-bottom: 10px;
    border-bottom: 0.5px solid rgba(0,0,0,0.05); /* åŠ ä¸€æ¡æç»†çš„åˆ†å‰²çº¿å¢åŠ ç²¾è‡´æ„Ÿ */
}
.header-cancel { font-size: 16px; color: #8E8E93; cursor: pointer; }
.header-title { font-size: 17px; font-weight: 700; color: #000; }
.header-save { font-size: 16px; font-weight: 700; color: #007AFF; cursor: pointer; }

/* 3. æ»šåŠ¨åŒºåŸŸï¼šå•ç‹¬æ§åˆ¶ï¼Œé˜²æ­¢æ’‘ç ´å¸ƒå±€ */
/* è¿™é‡Œçš„ padding-bottom æ˜¯ä¸ºäº†é˜²æ­¢è¢«åº•éƒ¨é»‘æ¡é®æŒ¡ */
#phone-add-scroll-area, .phone-add-panel {
    width: 100%;
    padding: 10px 0 100px 0 !important; 
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

/* 4. åˆ†æ®µæ§åˆ¶å™¨ (Create/Import) */
/* åªè¦ä½ åœ¨ HTML é‡Œç»™å®ƒåŠ ä¸Š style="width: auto; margin: 0 20px 25px 20px;" å°±èƒ½å¯¹é½ */
/* æˆ–è€…åœ¨è¿™é‡Œå¼ºåˆ¶å†™æ­»ï¼š */
.phone-add-sheet .segment-control {
    margin: 0 20px 25px 20px !important; /* å·¦å³ç•™ 20px */
    width: auto !important;
}

/* å¤´åƒä¸Šä¼ å™¨ */
.phone-avatar-uploader {
    width: 80px; height: 80px;
    background: #F2F2F7;
    border-radius: 50%;
    margin: 0 auto 25px auto;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
}
#phone-avatar-pre { width: 100%; height: 100%; object-fit: cover; }
#phone-avatar-placeholder {
    display: flex; flex-direction: column; align-items: center;
    gap: 4px; font-size: 10px; color: #ccc; font-weight: 600;
}

/* 5. æç®€è¡¨å•ç»„ï¼šæ ¸å¿ƒä¿®æ”¹ï¼è®©å®ƒæ’‘å¼€ */
.noir-form-group {
    background: #F9F9F9;
    border-radius: 12px;
    padding-left: 16px;
    
    /* ğŸš¨ å…³é”®ï¼šå·¦å³åªç•™ 20px çš„ç©ºéš™ */
    margin-left: 20px !important;
    margin-right: 20px !important;
    margin-bottom: 20px !important;
    width: auto !important; /* è‡ªåŠ¨å¡«æ»¡å‰©ä½™ç©ºé—´ */
    box-sizing: border-box; /* é˜²æ­¢è¾¹æ¡†æ’‘å¤§ */
}

.noir-input-row {
    display: flex; align-items: center;
    padding: 12px 16px 12px 0;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
}
/* å»æ‰æœ€åä¸€è¡Œçš„çº¿ */
.noir-input-row:last-child {
    border-bottom: none;
}

.noir-input-row label {
    width: 70px;
    font-size: 10px; font-weight: 700; color: #8E8E93; letter-spacing: 1px;
}
.noir-input-row input {
    flex: 1; border: none; background: transparent;
    font-size: 16px; color: #000; outline: none; font-weight: 500;
}
.noir-input-row input::placeholder { color: #D1D1D6; font-weight: 400; }

/* å¼€å…³è¡Œï¼šå¯¹é½æ–‡å­— */
.noir-toggle-row {
    display: flex; justify-content: space-between; align-items: center;
    /* ğŸš¨ å…³é”®ï¼šå·¦å³ç•™ 24pxï¼Œè·Ÿæ ‡é¢˜å¯¹é½ */
    padding: 0 24px !important; 
    font-size: 14px; font-weight: 600; color: #333;
}

/* å¯¼å…¥ç½‘æ ¼ */
.import-grid-wrapper {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
    max-height: 300px; overflow-y: auto; 
    padding: 10px 20px; /* ğŸš¨ ç»™ç½‘æ ¼åŠ å·¦å³å†…è¾¹è·ï¼Œé˜²æ­¢è´´è¾¹ */
}
.import-item {
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer;
}
.import-avatar {
    width: 56px; height: 56px; border-radius: 50%; object-fit: cover;
    border: 2px solid transparent; transition: all 0.2s;
    background: #eee;
}
.import-name { font-size: 11px; color: #333; text-align: center; }

/* é€‰ä¸­æ€ */
.import-item.selected .import-avatar {
    border-color: #007AFF;
    transform: scale(0.95);
    opacity: 0.8;
}
.import-item.selected .import-name { color: #007AFF; font-weight: 700; }
/* ==========================================
   ğŸš¨ ç»ˆææ’ç‰ˆä¿®æ­£ï¼šæ‹’ç»ç¼©æ°´ï¼Œå¼ºåˆ¶æ’‘æ»¡
   ========================================== */

/* --- 1. è”ç³»äººåˆ—è¡¨ (Contacts) --- */

/* é¡µé¢å®¹å™¨ï¼šå½»åº•å»è¾¹è· */
#phone-view-contacts {
    padding: 0 !important;
    width: 100% !important;
    overflow-x: hidden !important;
}

/* é¡¶éƒ¨æœç´¢æ å®¹å™¨ï¼šä¿æŒæ ‡å‡†è¾¹è· */
#phone-view-contacts > div:first-child {
    padding: 10px 16px !important; /* ä¸Šä¸‹10ï¼Œå·¦å³16 */
    width: 100% !important;
    box-sizing: border-box !important;
}

/* åˆ—è¡¨å®¹å™¨ï¼šå¡«æ»¡ */
#contacts-list-container {
    width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* åˆ—è¡¨å•é¡¹ï¼šæ’‘æ»¡å®½åº¦ï¼Œå†…å®¹å†…ç¼© */
.recent-item {
    width: 100% !important;
    box-sizing: border-box !important;
    padding: 14px 20px !important; /* å†…å®¹ç¦»è¾¹æ¡†20pxï¼Œèˆ’æœ */
    border-bottom: 0.5px solid rgba(0,0,0,0.05) !important;
}

/* =========================================================
   ğŸš¨ ç»ˆæå…¨å®½ç‰ˆï¼šå½»åº•æ¶ˆé™¤å·¦å³ç•™ç™½ (Edge-to-Edge)
   ========================================================= */

/* 1. å¼¹çª—å®¹å™¨ï¼šç¡®ä¿æ²¡æœ‰å†…è¾¹è· */
#modal-phone-add-contact .phone-add-sheet {
    width: 100% !important;
    padding: 0 !important;
    background: #F2F2F7 !important; /* ä¿æŒç°åº• */
}

/* 2. å¤´éƒ¨ï¼šä¸¤è¾¹åŠ ä¸€ç‚¹ç‚¹è·ç¦»ï¼Œä¸ç„¶æ–‡å­—è´´è¾¹å¤ªéš¾çœ‹ */
#modal-phone-add-contact .phone-add-header {
    padding: 15px 16px !important;
    background: #fff !important;
}

/* 3. æ ¸å¿ƒï¼šæŠŠè¾“å…¥æ¡†ç»„ä»â€œå¡ç‰‡â€å˜æˆâ€œé€šæ â€ */
#modal-phone-add-contact .noir-form-group,
#modal-phone-add-contact #phone-world-list {
    /* ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šè¾¹è·å½’é›¶ï¼Œå®½åº¦ 100% */
    margin-left: 0 !important;
    margin-right: 0 !important;
    width: 100% !important;
    
    /* å»æ‰åœ†è§’ï¼Œå˜æˆç›´è§’ */
    border-radius: 0 !important; 
    
    /* åŠ ä¸Šä¸Šä¸‹è¾¹æ¡†ï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
    border-top: 0.5px solid rgba(0,0,0,0.1) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    
    background: #FFFFFF !important;
    box-shadow: none !important;
}

/* 4. åˆ†æ®µæ§åˆ¶å™¨ï¼šè¿™ä¸ªé€šå¸¸è¦ç•™ä¸€ç‚¹è¾¹è·æ‰å¥½çœ‹ï¼Œå¦‚æœä½ æƒ³é“ºæ»¡ä¹Ÿå¯ä»¥æ”¹æˆ 0 */
#modal-phone-add-contact .segment-control {
    margin: 0 16px 20px 16px !important; /* ä¿æŒæ‚¬æµ®ï¼Œæ¯”è¾ƒå¥½çœ‹ */
    width: auto !important;
}

/* 5. ä¿®å¤è¾“å…¥è¡Œ */
#modal-phone-add-contact .noir-input-row {
    padding-right: 16px !important;
    margin-left: 16px !important; /* æ–‡å­—å·¦å¯¹é½ */
}

/* 6. æ»šåŠ¨åŒºåŸŸ */
#modal-phone-add-contact .app-body,
#modal-phone-add-contact .phone-add-panel {
    padding: 0 !important; /* å»æ‰å¤šä½™çš„ä¸Šä¸‹ç©ºéš™ */
    width: 100% !important;
}

/* 7. ç»™è¡¨å•ç»„ä¸Šé¢ç•™ä¸€ç‚¹ç‚¹ç°è‰²çš„ç©ºéš™ */
#modal-phone-add-contact .noir-form-group {
    margin-bottom: 30px !important;
}

/* 1. åˆ†æ®µæ§åˆ¶å™¨ (New Persona / Import Role) */
/* å¼ºåˆ¶è®©å®ƒæ’‘æ»¡æ•´è¡Œï¼Œå˜æˆç›´è§’ */
#modal-phone-add-contact .segment-control {
    width: 100% !important;
    margin: 0 !important;       /* æ€æ‰æ‰€æœ‰å¤–è¾¹è· */
    border-radius: 0 !important; /* æ€æ‰åœ†è§’ */
    padding: 10px 16px !important; /* å†…éƒ¨ç•™ç‚¹ç©ºéš™ï¼Œä¸ç„¶æŒ‰é’®å¤ªä¸‘ */
    background: #F2F2F7 !important; /* è·ŸèƒŒæ™¯èä¸ºä¸€ä½“ */
    box-sizing: border-box !important;
}

/* 2. è§’è‰²ä¿¡æ¯å¡«å†™åŒº (Name/Bio/Phone) */
/* å¼ºåˆ¶æŠŠç™½è‰²è¾“å…¥å—å˜æˆâ€œé€šæ â€ */
#modal-phone-add-contact .noir-form-group {
    width: 100% !important;
    margin: 0 !important;       /* æ€æ‰å·¦å³è¾¹è· */
    margin-bottom: 30px !important; /* åªä¿ç•™åº•éƒ¨é—´è· */
    
    border-radius: 0 !important; /* å˜ç›´è§’ */
    border-left: none !important;
    border-right: none !important;
    
    /* ä¸Šä¸‹åŠ è¾¹æ¡†ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
    border-top: 0.5px solid rgba(0,0,0,0.1) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    
    background: #FFFFFF !important;
}

/* 3. ä¿®å¤è¾“å…¥æ¡†å†…éƒ¨çš„æ–‡å­—å¯¹é½ */
/* è®©æ–‡å­—ä¸è¦ç´§è´´ç€å±å¹•è¾¹ç¼˜ï¼Œç•™å‡º 16px çš„å‘¼å¸ç©ºé—´ */
#modal-phone-add-contact .noir-input-row {
    padding-left: 16px !important;
    padding-right: 16px !important;
}

/* 4. ä¿®å¤å¤´åƒåŒºåŸŸ */
/* å¤´åƒä¿æŒå±…ä¸­ï¼Œä½†å®¹å™¨æ’‘æ»¡ */
#modal-phone-add-contact .phone-avatar-uploader {
    margin-top: 20px !important;
    margin-bottom: 20px !important;
    /* å¤´åƒæœ¬èº«è¿˜æ˜¯åœ†çš„ï¼Œä½†ä½ç½®è¦æ‘†æ­£ */
}
/* ==================================================
   ğŸš¨ é€šè®¯å½•é«˜çº§åŠŸèƒ½ï¼šå­—æ¯ç´¢å¼• + å³ä¾§èœå•
   ================================================== */

/* 1. åˆ—è¡¨é¡¹å¸ƒå±€è°ƒæ•´ï¼šè®©å³è¾¹çš„æŒ‰é’®é è¾¹ç«™ */
.recent-item {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important; /* å…³é”®ï¼šæ’‘å¼€å·¦å³ */
    position: relative !important; /* ä¸ºäº†å®šä½ä¸‹æ‹‰èœå• */
    padding-right: 10px !important; /* å³è¾¹ç»™æŒ‰é’®ç•™ç‚¹ç©º */
}

/* å·¦ä¾§ä¿¡æ¯åŒº (å¤´åƒ+åå­—) */
.contact-left-info {
    display: flex;
    align-items: center;
    flex: 1; /* å æ»¡å‰©ä¸‹çš„ç©ºé—´ */
    overflow: hidden; /* é˜²æ­¢åå­—å¤ªé•¿æ’‘ç ´ */
}

/* 2. å³ä¾§æ›´å¤šæŒ‰é’® (ä¸‰ä¸ªç‚¹) */
.contact-more-btn {
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    color: #C7C7CC;
    cursor: pointer;
    transition: background 0.2s;
}
.contact-more-btn:active { background: #E5E5EA; color: #000; }

/* 3. ä¸‹æ‹‰èœå• (Popover) - é»˜è®¤éšè— */
.contact-popover-menu {
    display: none; /* JS æ§åˆ¶æ˜¾ç¤º */
    position: absolute;
    right: 16px; /* é å³å¯¹é½ */
    top: 50px;   /* åœ¨æŒ‰é’®ä¸‹æ–¹ */
    width: 160px;
    background: #FFFFFF; /* å¿…é¡»çº¯ç™½ */
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15); /* é«˜çº§æŠ•å½± */
    z-index: 1000;
    overflow: hidden;
    flex-direction: column;
    animation: popIn 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes popIn {
    from { opacity: 0; transform: scale(0.95) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* èœå•é¡¹ */
.pop-item {
    padding: 12px 16px;
    font-size: 14px;
    color: #000;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
    display: flex; align-items: center; gap: 10px;
}
.pop-item:active { background: #F2F2F7; }
.pop-item:last-child { border-bottom: none; }
.pop-item.danger { color: #FF3B30; } /* åˆ é™¤æŒ‰é’®æ ‡çº¢ */

/* 4. A-Z åˆ†ç»„æ ‡é¢˜ (Section Header) */
.az-section-header {
    background: #F2F2F7;
    padding: 6px 16px;
    font-size: 12px;
    font-weight: 700;
    color: #8E8E93;
    width: 100%;
}

/* ğŸš¨ ä¾§è¾¹æ å¼ºåˆ¶æ˜¾ç¤ºè¡¥ä¸ */
.az-sidebar {
    position: fixed !important; /* å¼ºåˆ¶å›ºå®šå®šä½ */
    right: 5px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    z-index: 10000 !important; /* å±‚çº§è®¾ä¸ºæœ€é«˜ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
    
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    
    width: 20px !important;
    padding: 10px 0 !important;
    
    background: rgba(255, 255, 255, 0.6) !important; /* åŠ æ·±ä¸€ç‚¹èƒŒæ™¯ */
    backdrop-filter: blur(5px) !important;
    border-radius: 10px !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
}

.az-char {
    font-size: 10px !important;
    line-height: 14px !important; /* å¼ºåˆ¶è¡Œé«˜ */
    color: #007AFF !important;
    font-weight: 600 !important;
    width: 100% !important;
    text-align: center !important;
    display: block !important; /* ç¡®ä¿æ˜¯å—çº§å…ƒç´  */
    height: auto !important;
}
.az-char.active { background: #007AFF; color: #fff; }
/* =======================================================
   ğŸš¨ åˆ—è¡¨æ ·å¼å‡çº§ï¼šåœ†è§’å¡ç‰‡ + ä¾§è¾¹æ é¿è®©é€šé“
   ======================================================= */

/* 1. åˆ—è¡¨é¡¹å¤§æ”¹é€ ï¼šä»â€œé•¿æ¡â€å˜æˆâ€œåœ†è§’å¡ç‰‡â€ */
#contacts-list-container .recent-item {
    /* A. æ ¸å¿ƒï¼šå˜åœ† */
    border-radius: 16px !important;
    
    /* B. æ ¸å¿ƒï¼šç»™å³è¾¹ç•™å‡º 35px çš„â€œå­—æ¯ä¸“ç”¨é€šé“â€ */
    margin-right: 35px !important; 
    
    /* å·¦è¾¹ä¹Ÿç•™ç‚¹ç©ºï¼Œå¯¹ç§°å¥½çœ‹ */
    margin-left: 16px !important;
    
    /* ä¸Šä¸‹ç»™ç‚¹é—´è·ï¼Œè®©å¡ç‰‡ä¹‹é—´æœ‰å‘¼å¸æ„Ÿ */
    margin-bottom: 10px !important;
    
    /* C. èƒŒæ™¯è‰²ï¼šç»™ä¸ªææ·¡çš„ç°è‰²ï¼Œè®©å¡ç‰‡æ˜¾ç°å‡ºæ¥ */
    background: #F9F9F9 !important; 
    
    /* å»æ‰ä¹‹å‰çš„ä¸‹åˆ’çº¿ï¼Œå› ä¸ºå·²ç»æ˜¯ç‹¬ç«‹å¡ç‰‡äº† */
    border-bottom: none !important;
    
    /* å†…éƒ¨é—´è·è°ƒæ•´ */
    padding: 12px 10px 12px 16px !important;
    
    /* åŠ ä¸€ç‚¹ç‚¹æŠ•å½±ï¼Œæ›´æœ‰è´¨æ„Ÿï¼ˆå¯é€‰ï¼‰ */
    box-shadow: 0 2px 8px rgba(0,0,0,0.02) !important;
}

/* 2. ä¿®æ­£ä¸‰ä¸ªç‚¹æŒ‰é’®çš„ä½ç½® */
/* ç°åœ¨çš„æŒ‰é’®åœ¨å¡ç‰‡å†…éƒ¨çš„æœ€å³è¾¹ï¼Œéå¸¸å®‰å…¨ï¼Œç»å¯¹ç¢°ä¸åˆ°å­—æ¯è¡¨ */
.contact-more-btn {
    margin-right: 0 !important; 
    width: 36px !important; 
    height: 36px !important;
    background: rgba(0,0,0,0.03) !important; /* ç»™æŒ‰é’®åŠ ä¸ªæµ…åº•è‰²ï¼Œæ›´å¥½ç‚¹ */
}

/* 3. åˆ†ç»„æ ‡é¢˜ (A, B, C...) ä¹Ÿå¾—è·Ÿç€ç¼©è¿›ï¼Œä¿æŒå¯¹é½ */
.az-section-header {
    margin-left: 16px !important;
    margin-right: 35px !important; /* æ ‡é¢˜å³è¾¹ä¹Ÿç¼©å›æ¥ */
    background: transparent !important; /* æ ‡é¢˜å»æ‰èƒŒæ™¯ç°æ¡ï¼Œæ›´æ¸…çˆ½ */
    padding-left: 5px !important;
    margin-bottom: 5px !important;
}

/* 4. ç¡®ä¿ A-Z ä¾§è¾¹æ å®‰ç¨³åœ°å¾…åœ¨æœ€å³è¾¹çš„ç©ºåœ°é‡Œ */
.az-sidebar {
    right: 5px !important; /* ç´§è´´å±å¹•å³è¾¹ç¼˜ */
    width: 20px !important;
    background: transparent !important;
}

/* =======================================================
   ğŸš¨ åˆ—è¡¨æ ·å¼ä¿®å¤ï¼šåœ†è§’å¡ç‰‡ + å®½åº¦è‡ªé€‚åº” (è§£å†³æ¨ªå‘æ»šåŠ¨)
   ======================================================= */

/* 1. åˆ—è¡¨å®¹å™¨ï¼šå¼ºåˆ¶ç¦æ­¢æ¨ªå‘æ»šåŠ¨ */
#contacts-list-container {
    overflow-x: hidden !important; /* åŒé‡ä¿é™© */
    width: 100% !important;
    box-sizing: border-box !important;
}

/* 2. åˆ—è¡¨é¡¹å¤§æ”¹é€  */
#contacts-list-container .recent-item {
    /* ğŸš¨ğŸš¨ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç»å¯¹ä¸èƒ½å†™ 100%ï¼ä¸€å®šè¦å†™ autoï¼ ğŸš¨ğŸš¨ğŸš¨ */
    /* auto çš„æ„æ€å°±æ˜¯ï¼šçˆ¶å®¹å™¨å®½åº¦ - å·¦å³ margin = æˆ‘çš„å®½åº¦ */
    width: auto !important; 
    
    /* å·¦å³è¾¹è·ä¿æŒä¸å˜ */
    margin-left: 16px !important;
    margin-right: 35px !important; /* å³è¾¹ç•™ç©ºç»™å­—æ¯è¡¨ */
    margin-bottom: 10px !important;
    
    /* åœ†è§’å’ŒèƒŒæ™¯ */
    border-radius: 12px !important;
    background: #F9F9F9 !important;
    border-bottom: none !important;
    
    /* å†…éƒ¨é—´è· */
    padding: 12px 10px 12px 16px !important;
    box-shadow: 0 1px 4px rgba(0,0,0,0.03) !important;
    
    /* å¸ƒå±€ */
    display: flex !important;
    align-items: center !important;
    box-sizing: border-box !important;
}

/* 3. ä¸‰ä¸ªç‚¹æŒ‰é’® */
.contact-more-btn {
    margin-right: 0 !important;
    width: 32px !important; /* ç¨å¾®è°ƒå°ä¸€ç‚¹ç‚¹æ›´ç²¾è‡´ */
    height: 32px !important;
    background: rgba(0,0,0,0.03) !important;
    border-radius: 50%;
}

/* 4. åˆ†ç»„æ ‡é¢˜ä¹Ÿåšé˜²æº¢å‡ºå¤„ç† */
.az-section-header {
    width: auto !important;
    margin-left: 16px !important;
    margin-right: 35px !important;
    background: transparent !important;
}
/* ğŸš¨ ä¾§è¾¹æ äº¤äº’å¢å¼º */
.az-char {
    /* å¢åŠ ç‚¹å‡»çƒ­åŒºï¼Œé˜²æ­¢ç‚¹ä¸ä¸­ */
    padding: 2px 0 !important; 
    cursor: pointer !important;
    
    /* å³ä½¿æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿè¦æ˜¾ç¤ºæˆè“è‰²ï¼Œè®©äººçŸ¥é“å¯ä»¥ç‚¹ */
    color: #007AFF !important; 
    opacity: 0.7 !important; 
}

/* æœ‰æ•°æ®çš„å­—æ¯ç¨å¾®æ·±ä¸€ç‚¹ï¼ŒåŒºåˆ†ä¸€ä¸‹ */
.az-char.has-data {
    font-weight: 700 !important;
    opacity: 1 !important;
}

/* ç¡®ä¿ä¾§è¾¹æ åœ¨æœ€æœ€ä¸Šå±‚ï¼Œä¸è¢«ä»»ä½•ä¸œè¥¿æŒ¡ä½ */
.az-sidebar {
    z-index: 99999 !important;
    /* ç¡®ä¿é¼ æ ‡å˜å°æ‰‹ */
    cursor: pointer !important;
    pointer-events: auto !important; 
}

/* =======================================================
   ğŸš¨ äº¤äº’åŠ¨ç”»ï¼šå±å¹•ä¸­å¿ƒçš„å¤§å­—æ¯æç¤º (Toast)
   ======================================================= */
#az-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8); /* åˆå§‹ç¨å¾®ç¼©å° */
    width: 80px;
    height: 80px;
    background: rgba(200, 200, 200, 0.9); /* æµ…ç°åŠé€æ˜ */
    backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒç‰¹æ•ˆ */
    border-radius: 20px;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    font-size: 40px;
    font-weight: 700;
    color: #333;
    
    opacity: 0; /* é»˜è®¤éšè— */
    pointer-events: none; /* è®©å®ƒä¸æŒ¡é¼ æ ‡ç‚¹å‡» */
    z-index: 100000; /* æœ€é«˜å±‚çº§ */
    transition: opacity 0.3s, transform 0.3s;
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤ºå¹¶æ”¾å¤§ */
#az-toast.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}
/* ç¡®ä¿ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œæ²¡æœ‰åˆ‡æ¢æ¡æ—¶ï¼Œå¤´åƒä¹Ÿä¸ä¼šè´´é¡¶ */
.phone-avatar-uploader {
    /* ä¸Šä¸‹ä¿æŒèˆ’é€‚çš„é—´è· */
    margin-top: 25px !important;
    margin-bottom: 25px !important;
    
    /* å…¶ä»–ä¿æŒä¸å˜ */
    width: 80px; height: 80px;
    background: #F2F2F7;
    border-radius: 50%;
    margin-left: auto; margin-right: auto;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    position: relative;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
}
/* =======================================================
   ğŸš¨ åˆ é™¤ç¡®è®¤å¼¹çª—æ ·å¼ (iOS Action Sheet Style)
   ======================================================= */

/* 1. é®ç½©å±‚ (æš—èƒŒæ™¯) */
#modal-delete-confirm {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 20000; /* ç¡®ä¿åœ¨æœ€æœ€ä¸Šå±‚ */
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* å†…å®¹åœ¨åº•éƒ¨ */
}

/* èƒŒæ™¯é¢œè‰²æ¸å˜åŠ¨ç”» */
#modal-delete-confirm .modal-backdrop {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4);
    animation: fadeIn 0.2s ease-out;
}

/* 2. åº•éƒ¨é¢æ¿å®¹å™¨ */
.delete-action-sheet {
    position: relative;
    z-index: 20001;
    width: 100%;
    padding: 10px 10px 30px 10px; /* åº•éƒ¨ç•™ç™½ç»™ Home Bar */
    box-sizing: border-box;
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 3. æç¤ºæ–‡å­—åŒºåŸŸ */
.delete-title-box {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 14px;
    padding: 15px;
    text-align: center;
    margin-bottom: 10px;
}
.delete-main-title {
    font-size: 13px;
    font-weight: 600;
    color: #8E8E93;
    margin-bottom: 5px;
}
.delete-sub-desc {
    font-size: 13px;
    color: #8E8E93;
}

/* 4. æŒ‰é’®ç»„ */
.delete-btn-group {
    margin-bottom: 10px;
}

/* 5. é€šç”¨æŒ‰é’®æ ·å¼ */
.ios-action-btn {
    width: 100%;
    height: 56px;
    border: none;
    border-radius: 14px;
    font-size: 20px;
    font-weight: 500;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    transition: background 0.1s;
}
.ios-action-btn:active {
    background: rgba(255, 255, 255, 0.6);
}

/* çº¢è‰²åˆ é™¤æ–‡å­— */
.ios-action-btn.danger {
    color: #FF3B30; 
    font-weight: 600;
}
/* è“è‰²/é»‘è‰²å–æ¶ˆæ–‡å­— */
.ios-action-btn.cancel {
    color: #007AFF;
    font-weight: 600;
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
/* =======================================================
   âš™ï¸ è”ç³»äººç‹¬ç«‹è®¾ç½®é¢æ¿ (iOS Style)
   ======================================================= */

/* é¢æ¿å®¹å™¨ */
.settings-sheet-panel {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    height: 85%; /* å æ®å±å¹• 85% é«˜åº¦ */
    background: #F2F2F7; /* é«˜çº§ç°åº• */
    border-radius: 20px 20px 0 0;
    display: flex;
    flex-direction: column;
    animation: slideUpSheet 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
}

/* å¤´éƒ¨ */
.settings-header {
    height: 60px;
    background: #fff;
    border-radius: 20px 20px 0 0;
    display: flex; align-items: center; justify-content: center;
    position: relative;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
    flex-shrink: 0;
}
.sheet-handle {
    position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    width: 40px; height: 5px; background: #E5E5EA; border-radius: 3px;
}
.settings-title { font-weight: 700; font-size: 17px; }
.settings-close {
    position: absolute; right: 16px; top: 20px;
    font-size: 16px; font-weight: 600; color: #007AFF; cursor: pointer;
}

/* å†…å®¹åŒº */
.settings-content {
    flex: 1; overflow-y: auto; padding: 20px 16px;
}
.settings-section-title {
    font-size: 13px; color: #8E8E93; margin: 20px 0 8px 16px; font-weight: 500;
}

/* iOS åˆ†ç»„å¡ç‰‡ */
.ios-group-card {
    background: #fff; border-radius: 12px; overflow: hidden;
    margin-bottom: 10px;
}
.ios-cell {
    padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
    min-height: 24px;
}
.ios-divider {
    height: 0.5px; background: #E5E5EA; margin-left: 16px;
}

/* æ–‡æœ¬å’Œè¾“å…¥ */
.cell-label { font-size: 16px; color: #000; }
.text-btn { color: #007AFF; font-size: 16px; cursor: pointer; }
.ios-select {
    border: none; background: transparent; font-size: 16px; color: #8E8E93; outline: none; text-align: right;
}
.ios-input-right {
    border: none; outline: none; text-align: right; font-size: 16px; color: #007AFF; flex: 1;
}

/* éšè—åŒºåŸŸåŠ¨ç”» */
.hidden-options {
    display: none; background: #fff;
    animation: fadeIn 0.2s;
}
.setting-tip {
    font-size: 12px; color: #8E8E93; padding: 8px 16px; background: #F9F9F9;
}

/* ğŸ–¼ï¸ èƒŒæ™¯é¢„è§ˆï¼šç«–å±æ¯”ä¾‹ (9:16) */
.bg-preview-container {
    width: 100px; /* å®½åº¦å›ºå®š */
    height: 178px; /* é«˜åº¦æŒ‰ 9:16 æ¯”ä¾‹ */
    background: #E5E5EA;
    border-radius: 12px;
    margin-top: 10px;
    overflow: hidden;
    position: relative;
    border: 1px solid rgba(0,0,0,0.1);
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    display: flex; align-items: center; justify-content: center;
}
#set-bg-preview {
    width: 100%; height: 100%; object-fit: cover; /* å……æ»¡ä¸”è£å‰ª */
}
#set-bg-placeholder {
    font-size: 12px; color: #8E8E93; text-align: center; padding: 10px;
}

/* å¼€å…³æ ·å¼ */
.ios-switch {
    position: relative; display: inline-block; width: 50px; height: 30px;
}
.ios-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #E5E5EA; transition: .4s;
}
.slider:before {
    position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px;
    background-color: white; transition: .4s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
input:checked + .slider { background-color: #34C759; } /* ç»¿è‰²å¼€å¯ */
input:checked + .slider:before { transform: translateX(20px); }
.slider.round { border-radius: 34px; }
.slider.round:before { border-radius: 50%; }

@keyframes slideUpSheet {
    from { transform: translateY(100%); } to { transform: translateY(0); }
}
/* =======================================================
   ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè®¾ç½®å¼¹çª—çš„å¤–å£³å®¹å™¨ (ä¹‹å‰æ¼æ‰äº†è¿™æ®µ)
   ======================================================= */

#modal-contact-settings {
    position: fixed !important; /* å¼ºåˆ¶å›ºå®šåœ¨å±å¹•ä¸Š */
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    
    /* ç¡®ä¿å±‚çº§æœ€é«˜ï¼Œç›–ä½åˆ—è¡¨ */
    z-index: 20000 !important; 
    
    /* å¸ƒå±€ï¼šè®©å†…éƒ¨é¢æ¿æ²‰åº• */
    display: none; /* é»˜è®¤éšè—ï¼ŒJS ä¼šæ”¹æˆ flex */
    flex-direction: column !important;
    justify-content: flex-end !important; /* æ ¸å¿ƒï¼šè®©ç™½è‰²é¢æ¿åœåœ¨åº•éƒ¨ */
}

/* æ¿€æ´»çŠ¶æ€ (JS ä¼šæ·»åŠ  style="display:flex") */
#modal-contact-settings[style*="display: flex"] {
    display: flex !important;
}

/* é»‘è‰²åŠé€æ˜é®ç½©èƒŒæ™¯ */
#modal-contact-settings .modal-backdrop {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(2px);
    z-index: 1; /* åœ¨é¢æ¿ä¸‹é¢ */
    animation: fadeIn 0.2s ease-out;
}

/* ç¡®ä¿é¢æ¿åœ¨é®ç½©ä¸Šé¢ */
.settings-sheet-panel {
    z-index: 10 !important;
    position: relative !important;
}
/* =======================================================
   âš™ï¸ äºŒçº§é¡µé¢æ»‘åŠ¨ç³»ç»Ÿ (iOS Navigation Style)
   ======================================================= */

/* é¢æ¿å†…éƒ¨å˜ä¸ºç›¸å¯¹å®šä½ï¼Œæ–¹ä¾¿é¡µé¢æ»‘åŠ¨ */
.settings-sheet-panel {
    position: relative;
    overflow: hidden; /* éšè—æ»‘å‡ºå»çš„éƒ¨åˆ† */
}

/* é¡µé¢é€šç”¨æ ·å¼ */
.settings-view {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    background: #F2F2F7;
}

/* çŠ¶æ€ï¼šå½“å‰é¡µ */
.settings-view.active {
    transform: translateX(0);
}
/* çŠ¶æ€ï¼šä¸‹ä¸€é¡µ (åœ¨å³è¾¹ç­‰å¾…) */
.settings-view.next {
    transform: translateX(100%);
}
/* çŠ¶æ€ï¼šä¸Šä¸€é¡µ (æ»‘åˆ°å·¦è¾¹å»äº†) */
.settings-view.prev {
    transform: translateX(-30%); /* iOSä¹ æƒ¯ï¼šä¸»é¡µç¨å¾®å‘å·¦åŠ¨ä¸€ç‚¹ç‚¹ */
    filter: brightness(0.95); /* ç¨å¾®å˜æš— */
}

/* è·³è½¬è¡Œæ ·å¼ */
.ios-nav-link {
    cursor: pointer;
}
.ios-nav-link:active {
    background: #E5E5EA; /* ç‚¹å‡»åé¦ˆ */
}
.cell-value-row {
    display: flex; align-items: center; gap: 5px;
    color: #8E8E93; font-size: 16px;
}

/* è¿”å›æŒ‰é’® */
.settings-back-btn {
    position: absolute; left: 8px; top: 0; bottom: 0;
    display: flex; align-items: center;
    color: #007AFF; font-size: 16px; font-weight: 500;
    cursor: pointer;
}

/* âœ… è¯­è¨€åˆ—è¡¨é¡¹æ ·å¼ (å¸¦å¯¹å‹¾) */
.lang-option-item {
    padding: 12px 16px;
    display: flex; align-items: center; justify-content: space-between;
    font-size: 16px; color: #000;
    cursor: pointer;
}
.lang-option-item:active { background: #E5E5EA; }
/* å¯¹å‹¾å›¾æ ‡ */
.check-icon {
    display: none; /* é»˜è®¤éšè— */
    color: #007AFF;
}
/* é€‰ä¸­çŠ¶æ€ */
.lang-option-item.selected .check-icon {
    display: block;
}
.lang-option-item.selected {
    color: #007AFF; /* é€‰ä¸­çš„æ–‡å­—ä¹Ÿå˜è“ */
}
/* =======================================================
   ğŸ”¢ æ‹¨å·é”®ç›˜æ ·å¼å¢å¼ºï¼šè”ç³»äººåŒ¹é…æ˜¾ç¤º
   ======================================================= */

.keypad-display-area {
    /* å¢åŠ ä¸€ç‚¹é«˜åº¦ï¼Œå®¹çº³ä¸¤è¡Œæ–‡å­— */
    min-height: 100px !important; 
    display: flex !important;
    flex-direction: column !important; /* ä¸Šä¸‹æ’å¸ƒ */
    justify-content: center !important;
    align-items: center !important;
    padding-bottom: 20px !important;
}

/* åŒ¹é…åˆ°çš„åå­—æ ·å¼ */
.keypad-match-name {
    height: 20px; /* å›ºå®šé«˜åº¦ï¼Œé˜²æ­¢æ²¡åå­—æ—¶é¡µé¢è·³åŠ¨ */
    font-size: 14px !important;
    color: #8E8E93 !important; /* ç°è‰² */
    font-weight: 500 !important;
    margin-bottom: 5px !important;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s;
}

/* æœ‰åå­—æ—¶æ˜¾ç¤º */
.keypad-match-name.show {
    opacity: 1;
}

/* æ•°å­—æ˜¾ç¤ºç¨å¾®è°ƒæ•´ä¸€ä¸‹ï¼Œä¸è¦å¤ªå¤§ */
#keypad-number-display {
    font-size: 32px !important;
    font-weight: 600 !important;
    color: #000 !important;
    letter-spacing: 1px;
}
/* =======================================================
   ğŸ”¢ æ™ºèƒ½æ‹¨å·ç»“æœæ ·å¼ (åœ¨é”®ç›˜ä¸Šæ–¹æ˜¾ç¤º)
   ======================================================= */

/* é”®ç›˜ä¸Šæ–¹çš„åˆ—è¡¨åŒºåŸŸ */
#quick-dial-list {
    padding: 10px 16px;
    overflow-y: auto;
    max-height: 200px; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢æŒ¡ä½é”®ç›˜ */
}

/* å¼ºåˆ¶å¤ç”¨è”ç³»äººå¡ç‰‡çš„æ ·å¼ï¼Œä½†åšå¾®è°ƒ */
#quick-dial-list .recent-item {
    margin-right: 0 !important; /* è¿™é‡Œä¸éœ€è¦ç»™å­—æ¯è¡¨ç•™ç©ºä½ */
    margin-left: 0 !important;
    width: 100% !important;
    background: #fff !important; /* çº¯ç™½åº•è‰²æ›´å¹²å‡€ */
    box-shadow: 0 2px 10px rgba(0,0,0,0.05) !important;
    animation: fadeIn 0.2s ease-out;
}

/* åŒ¹é…é«˜äº®æ–‡å­— (å¯é€‰) */
.match-highlight {
    color: #007AFF;
    font-weight: 700;
}
/* =======================================================
   ğŸ“ å‘¼å«ç•Œé¢ (Nebula Style) - ç‹¬ç‰¹ä¸”å•†ç”¨å®‰å…¨
   ======================================================= */

/* 1. å…¨å±å®¹å™¨ */
.call-screen {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 99999; /* æœ€é«˜å±‚çº§ */
    background: #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    overflow: hidden;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

/* 2. èƒŒæ™¯å±‚ (æ¨¡ç³Šå¤„ç†) */
.call-bg-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    filter: blur(40px) brightness(0.6); /* æ·±åº¦æ¨¡ç³Š+å‹æš— */
    transform: scale(1.1); /* æ”¾å¤§ä¸€ç‚¹é˜²æ­¢ç™½è¾¹ */
    z-index: 1;
}
.call-bg-mask {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.3); /* é¢å¤–å åŠ ä¸€å±‚é»‘è‰²ï¼Œä¿è¯æ–‡å­—æ¸…æ™° */
    z-index: 2;
}

/* 3. è§†è§‰ä¸­å¿ƒ (å¤´åƒ+å‘¼å¸åœˆ) */
.call-visual-center {
    position: relative;
    z-index: 10;
    margin-top: 15vh; /* è·ç¦»é¡¶éƒ¨ */
    width: 160px; height: 160px;
    display: flex; align-items: center; justify-content: center;
}

/* å¤´åƒå®¹å™¨ */
.call-avatar-container {
    width: 100px; height: 100px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid rgba(255,255,255,0.2);
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    position: relative;
    z-index: 5; /* åœ¨åœˆåœˆä¸Šé¢ */
    background: #333;
}
.call-avatar-container img {
    width: 100%; height: 100%; object-fit: cover;
}

/* ğŸ’¨ æ ¸å¿ƒï¼šå‘¼å¸å…‰åœˆåŠ¨ç”» */
.breath-ring {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 0 10px rgba(255,255,255, 0.1);
    opacity: 0;
    z-index: 1;
}

/* å®šä¹‰ä¸‰ä¸ªåœˆçš„ä¸åŒå¤§å°å’Œå»¶è¿Ÿï¼Œåˆ¶é€ å±‚æ¬¡æ„Ÿ */
.ring-1 { width: 100px; height: 100px; animation: ripple 2s infinite ease-out; }
.ring-2 { width: 100px; height: 100px; animation: ripple 2s infinite ease-out 0.6s; }
.ring-3 { width: 100px; height: 100px; animation: ripple 2s infinite ease-out 1.2s; }

/* åŠ¨ç”»å…³é”®å¸§ï¼šæ‰©å¤§å¹¶æ¸éš */
@keyframes ripple {
    0% {
        width: 100px; height: 100px;
        opacity: 0.6;
        border-color: rgba(255, 255, 255, 0.5);
    }
    100% {
        width: 260px; height: 260px; /* æ‰©æ•£åˆ°è¿™ä¹ˆå¤§ */
        opacity: 0;
        border-color: rgba(255, 255, 255, 0);
    }
}

/* 4. ä¿¡æ¯æ–‡å­— */
.call-info-area {
    position: relative;
    z-index: 10;
    text-align: center;
    margin-top: 20px;
}
.call-name {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.call-status {
    font-size: 16px;
    color: rgba(255,255,255,0.7);
    font-weight: 400;
}

/* 5. åº•éƒ¨æŒ‰é’®åŒº */
.call-action-area {
    position: relative;
    z-index: 10;
    margin-bottom: 80px; /* è·ç¦»åº•éƒ¨ */
    display: flex;
    justify-content: center;
    width: 100%;
}

.end-call-btn {
    width: 70px; height: 70px;
    background: #FF3B30; /* iOS æ ‡å‡†æŒ‚æ–­çº¢ */
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(255, 59, 48, 0.4); /* çº¢è‰²æŠ•å½± */
    transition: transform 0.1s;
}
.end-call-btn:active {
    transform: scale(0.95);
    background: #D70015;
}
/* =======================================================
   ğŸš¨ æŒ‚æ–­æŒ‰é’®ç»ˆæå®šä½è¡¥ä¸ (å¼ºåˆ¶å±…ä¸­)
   ======================================================= */

/* 1. çˆ¶å®¹å™¨ï¼šè´Ÿè´£å®šä½ (é’‰åœ¨å±å¹•ä¸‹æ–¹) */
.call-action-area {
    position: fixed !important;  /* ä½¿ç”¨ fixedï¼Œç›¸å¯¹äºå±å¹•çª—å£å®šä½ */
    bottom: 10px !important;     /* è·ç¦»åº•éƒ¨ 80px */
    left: 0 !important;
    width: 100% !important;      /* å®½åº¦å æ»¡ */
    height: 100px !important;    /* ç»™ä¸ªé«˜åº¦ */
    
    display: flex !important;    /* å¼€å¯å¼¹æ€§å¸ƒå±€ */
    justify-content: center !important; /* æ°´å¹³å±…ä¸­ (å…³é”®) */
    align-items: center !important;     /* å‚ç›´å±…ä¸­ */
    
    z-index: 20002 !important;   /* å±‚çº§æœ€é«˜ï¼Œé˜²æ­¢è¢«èƒŒæ™¯æŒ¡ä½ */
    pointer-events: none !important; /* è®©ç©ºç™½åŒºåŸŸä¸æŒ¡ç‚¹å‡» */
}

/* 2. æŒ‰é’®æœ¬ä½“ï¼šè´Ÿè´£é•¿ç›¸ */
.end-call-btn {
    width: 72px !important;
    height: 72px !important;
    background: #FF3B30 !important;
    border-radius: 50% !important;
    
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    box-shadow: 0 6px 18px rgba(255, 59, 48, 0.5) !important;
    cursor: pointer !important;
    pointer-events: auto !important; /* æ¢å¤æŒ‰é’®çš„ç‚¹å‡» */
    
    /* ç¡®ä¿ SVG ä¸ä¼šè·‘å */
    padding: 0 !important;
    margin: 0 !important;
}

/* 3. ä¿®å¤ SVG å›¾æ ‡ä½ç½® */
.end-call-btn svg {
    display: block !important;
    margin: 0 auto !important;
}

/* =======================================================
   ğŸš¨ å‘¼å«ç•Œé¢æ–‡å­—å®šä½ä¿®å¤ (è®©åå­—ä¹–ä¹–å¾…åœ¨ä¸­é—´)
   ======================================================= */

/* 1. å¼ºåˆ¶å®šä½æ–‡å­—åŒºåŸŸ */
.call-info-area {
    position: absolute !important; /* ç»å¯¹å®šä½ */
    top: 52% !important;           /* æ”¾åœ¨å±å¹•é«˜åº¦ 52% çš„ä½ç½® (æ­£ä¸­åä¸‹ä¸€ç‚¹ç‚¹) */
    left: 0 !important;
    width: 100% !important;        /* å®½åº¦å æ»¡ */
    
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    
    z-index: 20 !important;        /* å±‚çº§é«˜ä¸€ç‚¹ï¼Œåˆ«è¢«çƒŸé›¾æŒ¡ä½ */
    pointer-events: none !important; /* ä¸æŒ¡ç‚¹å‡» */
}

/* 2. åå­—æ ·å¼å¾®è°ƒ (æ›´é†’ç›®) */
.call-name {
    font-size: 34px !important;
    font-weight: 700 !important;
    color: #fff !important;
    margin-bottom: 8px !important;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5) !important; /* åŠ ç‚¹é˜´å½±é˜²çœ‹ä¸æ¸… */
    letter-spacing: 0.5px !important;
}

/* 3. çŠ¶æ€æ–‡å­— (Calling...) */
.call-status {
    font-size: 17px !important;
    color: rgba(255,255,255,0.8) !important;
    font-weight: 400 !important;
    background: rgba(0,0,0,0.2) !important; /* åŠ ä¸ªæ·¡é»‘åº•ï¼Œæ›´æ¸…æ™° */
    padding: 4px 12px !important;
    border-radius: 20px !important;
}

/* 4. åŒæ—¶ä¹ŸæŠŠå¤´åƒåŒºåŸŸå›ºå®šä¸€ä¸‹ï¼Œé˜²æ­¢å®ƒä¹±è·‘ */
.call-visual-center {
    position: absolute !important;
    top: 20% !important;    /* å¤´åƒå›ºå®šåœ¨å±å¹•ä¸Šæ–¹çš„ 20% å¤„ */
    left: 0 !important;
    width: 100% !important;
    margin-top: 0 !important; /* å»æ‰ä¹‹å‰çš„ margin */
}
/* =======================================================
   ğŸ¥ æ——èˆ°çº§é€šè¯ UI (Cinematic Style)
   ======================================================= */

/* 1. èƒŒæ™¯å±‚ï¼šç»å¯¹é«˜æ¸…ï¼Œæ— æ¨¡ç³Š */
.cinema-bg-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; 
    background-position: center;
    z-index: 1;
    animation: none !important; /* ğŸš« ç¦æ­¢ä¹±åŠ¨ */
    transform: none !important; /* ğŸš« ç¦æ­¢ç¼©æ”¾ */
    filter: none !important;    /* ğŸš« ç¦æ­¢æ¨¡ç³Š */
}
@keyframes bgBreathe {
    from { transform: scale(1.0); } to { transform: scale(1.1); }
}

/* 2. é®ç½©å±‚ï¼šåªè´Ÿè´£å‹æš—å››å‘¨ï¼Œç»ä¸æ¨¡ç³ŠèƒŒæ™¯ */
.cinema-vignette-mask {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    /* é¡¶éƒ¨å’Œåº•éƒ¨æ¸é»‘ï¼Œä¸­é—´é€æ˜ï¼Œä¿è¯äººè„¸æ¸…æ™° */
    background: linear-gradient(
        to bottom, 
        rgba(0,0,0,0.6) 0%, 
        rgba(0,0,0,0.05) 30%, 
        rgba(0,0,0,0.05) 60%, 
        rgba(0,0,0,0.8) 100%
    );
    z-index: 2;
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
    backdrop-filter: none !important; /* ğŸš« ç¦æ­¢ä»»ä½•æ¯›ç»ç’ƒæ•ˆæœ */
}

/* 3. é¡¶éƒ¨çµåŠ¨å²› (Pill) */
/* 1. é¡¶éƒ¨å®¹å™¨ï¼šå¼ºåˆ¶å±…ä¸­ï¼Œå±‚çº§æ‹‰é«˜ */
.dynamic-status-pill {
    /* ä¸å†æ˜¯èƒ¶å›Šäº†ï¼Œæ”¹æˆé€æ˜å®¹å™¨ */
    position: absolute !important;
    top: 10% !important; /* è·ç¦»é¡¶éƒ¨ 10%ï¼Œé¿å¼€åˆ˜æµ· */
    left: 0 !important;
    width: 100% !important;
    
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important; /* å‚ç›´å±…ä¸­ */
    justify-content: flex-start !important;
    
    background: transparent !important; /* å»æ‰èƒŒæ™¯è‰² */
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    z-index: 50 !important; /* ğŸŒ ç¡®ä¿åœ¨æœ€ä¸Šå±‚ï¼Œä¸è¢«èƒŒæ™¯æŒ¡ä½ */
}

/* 2. å¤´åƒï¼šåŠ å¤§ï¼ŒåŠ å…‰æ™• */
.status-dot { display: none !important; } /* åˆ æ‰é‚£ä¸ªç»¿ç‚¹ */
.status-divider { display: none !important; } /* åˆ æ‰åˆ†éš”çº¿ */
.status-name {
    font-size: 32px !important;
    font-weight: 700 !important;
    color: #fff !important;
    text-shadow: 0 4px 15px rgba(0,0,0,0.5) !important;
    margin-bottom: 8px !important;
    margin-top: 15px !important; /* ç»™å¤´åƒç•™ç‚¹ç©º */
    letter-spacing: 0.5px !important;
}

.status-timer {
    font-size: 16px !important;
    color: rgba(255,255,255,0.7) !important;
    font-weight: 500 !important;
    font-family: -apple-system, monospace !important;
    background: rgba(0,0,0,0.2) !important;
    padding: 4px 12px !important;
    border-radius: 20px !important;
    backdrop-filter: blur(5px) !important;
}
.dynamic-status-pill::before {
    /* è¿™é‡Œæˆ‘ä»¬è¦åŠ¨æ€æ’å…¥å¤´åƒï¼Œä½† HTML ç»“æ„é‡Œæ²¡ç»™å¤´åƒç•™ä½ç½®ï¼Ÿ
       åˆ«æ€¥ï¼ŒJS ä¼šæŠŠå¤´åƒæ’åˆ°è¿™é‡Œï¼Œæˆ–è€…æˆ‘ä»¬åˆ©ç”¨ç°æœ‰çš„ç»“æ„æ”¹é€  */
    content: '';
    display: none;
}

/* ğŸš¨ æ ¸å¿ƒï¼šç»™å¤´åƒåŠ ä¸€ä¸ªä¸“é—¨çš„æ ·å¼ (JS ä¼šç”¨åˆ°) */
.connected-top-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid rgba(255,255,255,0.2);
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    object-fit: cover;
    animation: floatAvatar 6s ease-in-out infinite;
}

@keyframes floatAvatar {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* 4. ğŸ”Š å£°æ³¢å¯è§†åŒ– (The Soul) */
.audio-visualizer-container {
    position: absolute; top: 35%; left: 0; width: 100%;
    display: flex; justify-content: center; align-items: center; gap: 6px;
    height: 60px; z-index: 5;
    opacity: 0.8;
}
.wave-bar {
    width: 6px; background: #fff; border-radius: 4px;
    animation: soundWave 1.2s infinite ease-in-out;
    box-shadow: 0 0 15px rgba(255,255,255,0.5);
}
/* è®©æ¯æ ¹æŸ±å­è·³åŠ¨èŠ‚å¥ä¸ä¸€æ · */
.wave-bar:nth-child(1) { height: 20px; animation-delay: 0.0s; }
.wave-bar:nth-child(2) { height: 40px; animation-delay: 0.2s; }
.wave-bar:nth-child(3) { height: 50px; animation-delay: 0.4s; }
.wave-bar:nth-child(4) { height: 30px; animation-delay: 0.1s; }
.wave-bar:nth-child(5) { height: 20px; animation-delay: 0.3s; }

@keyframes soundWave {
    0%, 100% { height: 10px; opacity: 0.3; }
    50% { height: 50px; opacity: 1; }
}

/* 5. ğŸ“œ ç”µå½±å­—å¹•åŒº */
.cinema-caption-area {
    position: absolute; bottom: 180px; left: 20px; right: 20px;
    text-align: center; z-index: 10;
    display: flex; flex-direction: column; justify-content: flex-end;
    min-height: 100px;
}
.caption-empty-state {
    font-size: 14px; color: rgba(255,255,255,0.4); letter-spacing: 1px;
    text-transform: uppercase;
}
.caption-text-bubble {
    font-size: 20px; font-weight: 500; color: #fff;
    line-height: 1.4;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    background: rgba(0,0,0,0.3); /* æ–‡å­—èƒŒæ™¯ï¼Œé˜²å£çº¸å¤ªèŠ±çœ‹ä¸æ¸… */
    padding: 10px 16px; border-radius: 16px;
    display: inline-block;
    align-self: center; /* å±…ä¸­ */
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.05);
    animation: fadeInUp 0.4s ease-out;
}

/* 6. åº•éƒ¨æ§åˆ¶å */
.call-dock-wrapper {
    position: absolute; bottom: 50px; width: 100%;
    display: flex; justify-content: center; z-index: 20;
}
.call-control-dock {
    background: rgba(30,30,30,0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.1);
    /* ä¹‹å‰çš„ gap å¯èƒ½å¤ªå®½å¯¼è‡´ç¬¬ä¸‰ä¸ªè¢«æŒ¤å‡ºå»äº†ï¼Œæ”¹å°ä¸€ç‚¹ */
    gap: 25px !important; 
    padding: 12px 30px !important;
    min-width: 200px; /* ä¿è¯å®½åº¦è¶³å¤Ÿ */
    justify-content: space-between !important;
    border-radius: 40px;
    display: flex; align-items: center; gap: 30px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.dock-btn {
    width: 50px; height: 50px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s;
}
.dock-btn.secondary {
    color: #fff; background: rgba(255,255,255,0.1);
}
.dock-btn.secondary:active { background: rgba(255,255,255,0.3); }

/* æŒ‚æ–­æŒ‰é’®ç‰¹æ•ˆ */
.dock-btn.danger-pulse {
    width: 64px; height: 64px;
    background: #FF3B30; color: #fff;
    box-shadow: 0 5px 20px rgba(255, 59, 48, 0.4);
}
.dock-btn.danger-pulse:active { transform: scale(0.9); }

/* 7. è¾“å…¥æ¡†ç¾åŒ– */
.call-input-drawer textarea {
    background: rgba(255,255,255,0.1);
    border-radius: 20px; padding: 12px 16px;
    height: 50px; /* å•è¡Œé«˜åº¦ */
}
.drawer-send-btn {
    width: 44px; height: 44px; background: #007AFF;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; margin-left: 10px;
}
/* ğŸš¨ å¼ºåˆ¶ä¿®å¤ï¼šé€šè¯ç•Œé¢çš„å±‚çº§é¡ºåº */

/* 1. èƒŒæ™¯å±‚æ¨åˆ°æœ€ä¸‹é¢ */
.call-bg-layer, 
.cinema-bg-layer, 
#connected-bg-layer {
    z-index: 1 !important;
}

/* 2. é»‘è‰²é®ç½©å±‚æ¨åˆ°ç¬¬äºŒå±‚ */
.call-bg-mask, 
.cinema-vignette-mask {
    z-index: 2 !important;
    pointer-events: none !important; /* å…³é”®ï¼šå…è®¸ç‚¹å‡»ç©¿é€ */
}

/* 3. æŒ‰é’®å®¹å™¨æ¨åˆ°æœ€ä¸Šé¢ï¼Œå¹¶ä¸”å…è®¸ç‚¹å‡» */
.call-dock-wrapper, 
.call-action-area {
    z-index: 99999 !important; /* æé«˜çš„å±‚çº§ */
    pointer-events: none; /* å®¹å™¨æœ¬èº«ä¸æŒ¡ç‚¹å‡»ï¼Œè®©é‡Œé¢çš„æŒ‰é’®æŒ¡ */
}

/* 4. æŒ‰é’®æœ¬ä½“å…è®¸ç‚¹å‡» */
.call-control-dock, 
.dock-btn, 
.end-call-btn {
    pointer-events: auto !important;
}

/* ==========================================
   ğŸš¨ ç”µè¯ç•Œé¢ç»ˆæä¿®å¤è¡¥ä¸
   ========================================== */

/* 1. ä¿®å¤å­—å¹•ä½ç½®ï¼šç§»åˆ°å£°æ³¢ä¸‹æ–¹ */
.cinema-caption-area {
    bottom: auto !important;       /* å–æ¶ˆåº•éƒ¨å›ºå®š */
    top: 48% !important;           /* è®¾å®šåœ¨å±å¹•ä¸­é—´åä¸‹ (å£°æ³¢åœ¨35%) */
    height: auto !important;
    min-height: 60px !important;
    justify-content: flex-start !important; /* æ–‡å­—ä»ä¸Šå¾€ä¸‹æ’ */
    padding-top: 20px !important;
    z-index: 20 !important;
    pointer-events: none !important; /* è®©ç‚¹å‡»ç©¿é€æ–‡å­—åŒºåŸŸ */
}

/* 2. ä¿®å¤ç‚¹å‡»å¤±æ•ˆï¼šèƒŒæ™¯å±‚ç¦æ­¢æ‹¦æˆªé¼ æ ‡ */
.cinema-bg-layer, 
.cinema-vignette-mask, 
#connected-bg-layer {
    pointer-events: none !important; /* ğŸš¨ æ ¸å¿ƒï¼šè®©ç‚¹å‡»ç©¿é€èƒŒæ™¯ */
}

/* 3. ä¿®å¤åº•éƒ¨æŒ‰é’®ï¼šå¼ºåˆ¶ç½®é¡¶å¹¶å…è®¸ç‚¹å‡» */
.call-dock-wrapper {
    z-index: 99999 !important;      /* å±‚çº§æœ€é«˜ */
    pointer-events: none !important; /* å®¹å™¨æœ¬èº«ä¸æŒ¡ */
    bottom: 40px !important;        /* ç¨å¾®å¾€ä¸Šæä¸€ç‚¹ */
}

.call-control-dock {
    pointer-events: auto !important; /* ğŸš¨ æ ¸å¿ƒï¼šæŒ‰é’®åŒºåŸŸæ¢å¤ç‚¹å‡» */
    background: rgba(30, 30, 30, 0.85) !important; /* åŠ æ·±èƒŒæ™¯ï¼Œçœ‹æ¸…æŒ‰é’® */
    box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
}

/* 4. ä¿®å¤è¾“å…¥æ¡†æŠ½å±‰ï¼šç¡®ä¿å®ƒåœ¨æœ€æœ€ä¸Šé¢ */
.call-input-drawer {
    position: absolute !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    background: #1c1c1e !important; /* æ·±è‰²åº• */
    border-radius: 20px 20px 0 0 !important;
    padding: 15px !important;
    z-index: 999999 !important; /* æ¯”æŒ‰é’®è¿˜é«˜ */
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex !important;
    gap: 10px;
    box-sizing: border-box;
}

.call-input-drawer.active {
    transform: translateY(0) !important; /* æ»‘å‡ºæ¥ */
}

/* 5. ä¿®å¤æŒ‚æ–­æŒ‰é’®è§†è§‰ */
.dock-btn.danger-pulse {
    background: #FF3B30 !important;
    box-shadow: 0 4px 15px rgba(255, 59, 48, 0.5) !important;
    z-index: 100000 !important;
}


/* ==========================================
   ğŸš¨ é¡¶éƒ¨é€Ÿæ‹¨æ ï¼šç«–å‘è¯¦ç»†æ¸…å• (å¸ƒå±€ä¿®å¤ç‰ˆ)
   ========================================== */

/* 1. å®¹å™¨è°ƒæ•´ï¼šæ ¸å¿ƒä¿®å¤ */
.quick-dial-section {
    /* ğŸš¨ å…³é”®ï¼šflex: 1 è®©å®ƒè‡ªåŠ¨å æ»¡é”®ç›˜ä¸Šæ–¹çš„æ‰€æœ‰å‰©ä½™ç©ºé—´ */
    flex: 1 !important; 
    
    /* ğŸš¨ å…³é”®ï¼šå¿…é¡»è®¾ä¸º hiddenï¼Œé™åˆ¶å®ƒä¸èƒ½æ— é™é•¿ï¼Œå¦åˆ™ä¼šæŠŠé”®ç›˜é¡¶é£ */
    overflow: hidden !important; 
    
    
    background: #ffffff !important;
    display: flex !important;
    flex-direction: column !important;
    padding-bottom: 0 !important;
    border-bottom: 1px solid rgba(0,0,0,0.05) !important; /* åŠ ä¸ªåº•çº¿å¥½çœ‹ç‚¹ */
}

/* 2. æ»šåŠ¨åŒºåŸŸï¼šå‚ç›´æ’åˆ— + å¼€å¯æ»šåŠ¨ */
.quick-scroll-wrapper {
    /* æ’‘æ»¡çˆ¶å®¹å™¨ */
    flex: 1 !important; 
    height: 100% !important;
    
    display: flex !important;
    flex-direction: column !important; 
    
    /* ğŸš¨ æ ¸å¿ƒï¼šåªæœ‰è¿™é‡Œå¼€å¯æ»šåŠ¨æ¡ */
    overflow-y: auto !important; 
    overflow-x: hidden !important;
    
    padding: 0 !important;
    padding-bottom: 20px !important; /* åº•éƒ¨ç•™ç‚¹ç©ºéš™ï¼Œé˜²é®æŒ¡ */
    gap: 0 !important; 
}

/* 3. åˆ—è¡¨å•é¡¹ï¼šé€šæ å¸ƒå±€ (ä¿æŒä¸å˜) */
.quick-record-card {
    width: 100% !important;
    height: auto !important;
    min-height: 65px !important;
    background: #FFFFFF !important;
    border-radius: 0 !important; 
    padding: 12px 20px !important;
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
    box-shadow: none !important;
    border: none !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.05) !important; 
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0 !important; /* é˜²æ­¢è¢«æŒ¤å‹ */
}

.quick-record-card:active {
    background: #F2F2F7 !important;
}

/* å¤´åƒ */
.quick-card-avatar {
    width: 42px !important; 
    height: 42px !important; 
    border-radius: 50% !important;
    object-fit: cover;
    flex-shrink: 0 !important;
}

/* ä¸­é—´æ–‡å­—åŒº */
.quick-card-info {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: flex-start !important; 
    overflow: hidden !important;
}

/* åå­—è¡Œ */
.quick-card-name {
    font-size: 16px !important;
    font-weight: 600 !important;
    color: #000 !important;
    text-align: left !important;
    width: 100% !important;
    margin-bottom: 4px !important;
    white-space: nowrap !important;
    text-overflow: ellipsis !important;
    overflow: hidden !important;
}
/* æœªæ¥å˜çº¢ */
.quick-record-card.missed .quick-card-name {
    color: #FF3B30 !important;
}

/* è¯¦æƒ…è¡Œ (æ—¥æœŸ + æ—¶é•¿) */
.quick-card-meta-row {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    font-size: 12px !important;
    color: #8E8E93 !important;
    width: 100% !important;
}

/* å›¾æ ‡å¾®è°ƒ */
.status-icon {
    width: 14px !important; 
    height: 14px !important;
    flex-shrink: 0 !important;
}
/* ==========================================
   ğŸš¨ ç©ºé—´æ‰©å®¹è¡¥ä¸ï¼šè®©åˆ—è¡¨å æ®å¤§åŠä¸ªå±å¹•
   ========================================== */

/* 1. åˆ—è¡¨å®¹å™¨ï¼šå¼ºåˆ¶æ‹‰ä¼¸ï¼Œå æ®ä¸»å¯¼åœ°ä½ */
.quick-dial-section {
    flex: 1 !important; 
    /* ğŸš¨ æ ¸å¿ƒï¼šç»™ä¸€ä¸ªè¾ƒå¤§çš„æœ€å°é«˜åº¦ï¼Œä¿è¯å®ƒè‡³å°‘å å±å¹•çš„ä¸€åŠ */
    min-height: 15vh !important; 
    background: #ffffff !important;
    display: flex !important;
    flex-direction: column !important;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* 2. æ•°å­—æ˜¾ç¤ºåŒºï¼šå‹ç¼©é«˜åº¦ */
.keypad-display-area {
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    /* ğŸš¨ æ ¸å¿ƒï¼šé«˜åº¦æ”¹å°ï¼Œç»™ä¸Šé¢è…¾åœ°æ–¹ */
    min-height: 65px !important; 
    height: auto !important;
    background: #ffffff !important;
    z-index: 10 !important;
    padding-top: 5px !important;
    padding-bottom: 5px !important;
}

/* 3. æ‹¨å·æ•°å­—å­—ä½“ï¼šç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œé€‚é…æ–°é«˜åº¦ */
#keypad-number-display {
    font-size: 32px !important; /* åŸæ¥å¯èƒ½æ˜¯ 38px */
    height: 40px !important;
    line-height: 40px !important;
}

/* 4. é”®ç›˜åŒºåŸŸï¼šä¿æŒç´§å‡‘ */
.keypad-grid {
    padding-bottom: 5px !important; /* ä¿æŒåº•éƒ¨å®‰å…¨åŒº */
    padding-top: 10px !important;
    background: #fff !important;
}
/* --- ğŸ¥ ç”µå½±çº§å­—å¹•æµå®¹å™¨ (ç‰©ç†ä¿®å¤ç‰ˆ) --- */
.cinema-caption-area {
    /* 1. ç‰©ç†å®šä½ï¼šç»å¯¹ä½äºå£°æ³¢(35%)ä¸‹æ–¹ï¼Œä¸é®æŒ¡æŒ‚æ–­æŒ‰é’® */
    position: absolute !important;
    top: 45% !important; 
    bottom: 120px !important; /* åº•éƒ¨ç•™ç™½ç»™æŒ‰é’® */
    left: 15px !important;
    right: 15px !important;
    height: auto !important;
    
    /* 2. å¸ƒå±€é€»è¾‘ï¼šä»ä¸Šå¾€ä¸‹æ’ï¼Œæ”¯æŒæ»‘åŠ¨ */
    display: flex !important;
    flex-direction: column !important;
    justify-content: flex-start !important; /* å†…å®¹ä»é¡¶éƒ¨å¼€å§‹ */
    align-items: center !important;
    
    /* 3. æ»šåŠ¨äº¤äº’æ ¸å¿ƒ */
    overflow-y: auto !important; /* å¼€å¯å‚ç›´æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch; /* iOSä¸æ»‘æ»šåŠ¨ */
    padding: 10px 0 !important;
    gap: 12px; /* æ°”æ³¡ä¹‹é—´çš„é—´è· */
    
    /* 4. ç©¿é€ä¸äº¤äº’ */
    z-index: 50 !important;
    pointer-events: auto !important; /* ğŸš¨ å…³é”®ï¼šå…è®¸æ‰‹æŒ‡åœ¨åŒºåŸŸå†…æ»‘åŠ¨ */
    /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œé˜²æ­¢æœ€åä¸€ä¸ªæ°”æ³¡è´´åº• */
    padding-bottom: 40px !important; 
}

/* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
.cinema-caption-area::-webkit-scrollbar { display: none; }

/* å•ä¸ªå­—å¹•å¡ç‰‡ (ç‹¬ç«‹èƒ¶å›Š) */
.caption-card {
    width: auto;
    max-width: 95%; /* ç¨å¾®å®½ä¸€ç‚¹ */
    background: rgba(20, 20, 20, 0.75); /* æ·±è‰²ç£¨ç ‚åº• */
    backdrop-filter: blur(15px);    
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 18px;
    padding: 14px 20px;
    
    display: flex;
    flex-direction: column;
    gap: 6px;
    
    /* è¿›åœºåŠ¨ç”» */
    animation: captionSlideIn 0.5s cubic-bezier(0.19, 1, 0.22, 1) both;
    flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* åŸæ–‡æ ·å¼ */
.cap-text-main {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    line-height: 1.5;
    text-align: center;
    font-family: -apple-system, sans-serif;
    letter-spacing: 0.3px;
}

/* ç¿»è¯‘æ ·å¼ (å¸¦åˆ†å‰²çº¿) */
.cap-text-sub {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.85); /* ç¨å¾®äº®ä¸€ç‚¹ï¼Œæ˜“è¯» */
    font-weight: 400;
    font-style: normal;
    font-family: "PingFang SC", sans-serif;
    text-align: center;
    
    /* åˆ†å‰²çº¿ */
    border-top: 1px solid rgba(255,255,255,0.15);
    padding-top: 8px;
    margin-top: 4px;
    line-height: 1.5;
}

@keyframes captionSlideIn {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* --- ğŸ“± å…¨å± APP é£æ ¼ (ä¿®å¤çŠ¶æ€æ  + ç²—æ ‡é¢˜) --- */

/* --- ç‰©ç†å¤–å£³ï¼šå½»åº•éš”ç¦»æ¡Œé¢ --- */
.archive-app-container {
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: #ffffff !important; /* ğŸš¨ çº¯ç™½å¼ºåŠ›é®æŒ¡ */
    z-index: 9999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    display: none;
    flex-direction: column;
    overflow: hidden;
}

.archive-app-container.active { display: flex !important; }

/* --- é¡¶éƒ¨é¿è®©ï¼šè§£å†³çŠ¶æ€æ é‡å  --- */
.archive-header {
    background: #ffffff;
    flex-shrink: 0;
    z-index: 100;
}

.ios-status-bar-spacer {
    /* ğŸš¨ å…³é”®ï¼šé«˜åº¦è®¾ä¸º 44pxï¼ˆåˆ˜æµ·å±æ ‡å‡†ï¼‰æˆ–ä½¿ç”¨ç³»ç»Ÿå˜é‡ */
    height: env(safe-area-inset-top, 44px); 
    width: 100%;
}

.archive-nav-bar {
    padding: 10px 24px 15px 24px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end; /* æ ‡é¢˜é ä¸‹ï¼Œè¿œç¦»æ—¶é—´ */
}

.archive-title-stack { display: flex; flex-direction: column; }

.archive-subtitle {
    font-size: 9px;
    font-weight: 900;
    color: #ccc;
    letter-spacing: 3px;
    margin-bottom: 4px;
}

.archive-main-title {
    font-size: 32px;
    font-weight: 800;
    color: #000;
    letter-spacing: -1px;
}

.archive-close-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: #f2f2f7;
    border: none;
    display: flex; align-items: center; justify-content: center;
    color: #8e8e93;
    margin-bottom: 5px;
}

.archive-search-wrap { padding: 0 24px 20px; }
.archive-search-wrap input {
    width: 100%; height: 42px;
    background: #f2f2f7;
    border: none; border-radius: 12px;
    padding: 0 15px; font-size: 16px; outline: none;
}

/* --- åˆ—è¡¨ä¸å¡ç‰‡ --- */
.archive-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px 24px;
    -webkit-overflow-scrolling: touch;
}

.noir-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.card-init {
    aspect-ratio: 3/4;
    background: #fff;
    border: 1.5px dashed #e5e5ea;
    border-radius: 20px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: #aaa;
}

.init-cross { font-size: 30px; font-weight: 200; margin-bottom: 5px; }
.card-init span { font-size: 10px; font-weight: 800; letter-spacing: 2px; }

/* --- åº•éƒ¨èƒ¶å›Šå¯¼èˆª --- */
.archive-footer {
    padding: 20px 24px 45px 24px; /* ç•™å‡ºåº•éƒ¨æ¨ªæ¡ç©ºé—´ */
    display: flex; justify-content: center;
    background: linear-gradient(to top, #fff 70%, transparent);
    position: absolute; bottom: 0; width: 100%;
    pointer-events: none;
}

.capsule-nav {
    pointer-events: auto;
    background: #1d1d1f;
    padding: 6px;
    border-radius: 35px;
    display: flex;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.nav-tab {
    padding: 10px 25px;
    border-radius: 30px;
    color: rgba(255,255,255,0.4);
    transition: all 0.3s;
    cursor: pointer;
}

.nav-tab.active {
    background: rgba(255,255,255,0.1);
    color: #fff;
}

.nav-label { font-size: 10px; font-weight: 800; letter-spacing: 1px; }
.safe-bottom-padding { height: 120px; }

/* ğŸš¨ å¼ºæ•ˆç‰©ç†éš”ç¦»è¡¥ä¸ - å¼ºåˆ¶è§£å†³æ ‡é¢˜é‡å  */

.archive-header {
    /* 1. ç‰©ç†ä¸‹ç§»ï¼šå¢åŠ é¡¶éƒ¨çš„å†…è¾¹è· */
    padding-top: 35px !important; /* è¿™é‡Œå›ºå®šç»™ 55pxï¼Œè¶³ä»¥é¿å¼€çŠ¶æ€æ  */
    
    /* 2. å¸ƒå±€é”å®šï¼šç¡®ä¿èƒŒæ™¯é¢œè‰²èƒ½è¦†ç›–åˆ°æœ€é¡¶ç«¯ */
    background: #ffffff !important; 
    position: relative !important;
    display: flex !important;
    flex-direction: column !important;
    z-index: 1000 !important;
}

/* å¼ºåˆ¶ä¿®æ­£å®‰å…¨åŒºå ä½ç¬¦çš„é«˜åº¦ */
.ios-status-bar-spacer {
    height: 25px !important; 
    display: block !important;
    background: #ffffff !important;
    flex-shrink: 0 !important;
}

/* è°ƒæ•´æ ‡é¢˜æ å†…å®¹ï¼Œç¡®ä¿å®ƒåœ¨å ä½ç¬¦ä¸‹æ–¹å¯¹é½ */
.archive-nav-bar {
    padding-top: 10px !important;
    align-items: center !important;
    height: auto !important;
}

/* --- ğŸ› ï¸ æ¡£æ¡ˆå±•ç¤ºé¡µå…¨å±€é‡å¡‘ --- */

/* 1. å•è¡Œæ·»åŠ æŒ‰é’®ï¼šå·¥ä¸šç¾å­¦é£æ ¼ */
.add-entry-row {
    width: 100%;
    height: 60px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-core {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 0 20px;
    color: #000;
}

.add-line-left, .add-line-right {
    flex: 1;
    height: 1px;
    background: linear-gradient(to right, transparent, #eeeeef);
}
.add-line-right { background: linear-gradient(to left, transparent, #eeeeef); }

.add-text {
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 3px;
    color: #8e8e93;
}

.add-entry-row:active { transform: scale(0.98); opacity: 0.6; }

/* 2. æ¡£æ¡ˆå¡ç‰‡ï¼šç‹¬ç«‹å­˜æ ¹æ„Ÿ */
.archive-card-luxe {
    position: relative;
    background: #ffffff;
    border-radius: 20px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    border: 1px solid rgba(0,0,0,0.03);
    box-shadow: 0 10px 30px rgba(0,0,0,0.03);
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    overflow: hidden;
}

.archive-card-luxe:active {
    transform: translateY(5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

/* å¡ç‰‡é¡¶éƒ¨çŠ¶æ€æ  */
.card-status-bar {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.serial-no {
    font-family: monospace;
    font-size: 9px;
    font-weight: 700;
    color: #d1d1d6;
    letter-spacing: 1px;
}

.status-dot {
    width: 6px; height: 6px;
    background: #34C759; /* æ´»è·ƒçŠ¶æ€ç»¿ */
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(52, 199, 89, 0.5);
}

/* å¤´åƒï¼šåœ†å½¢å¸¦è¾¹æ¡† */
.card-avatar-wrap {
    width: 75px; height: 75px;
    border-radius: 50%;
    border: 2px solid #f2f2f7;
    padding: 4px;
    margin-bottom: 15px;
}

.card-avatar-wrap img {
    width: 100%; height: 100%;
    border-radius: 50%;
    object-fit: cover;
    filter: grayscale(20%); /* æ·¡æ·¡çš„é»‘ç™½æ»¤é•œå¢åŠ è´¨æ„Ÿ */
}

/* æ–‡æœ¬å †å  */
.char-name {
    font-size: 17px;
    font-weight: 800;
    color: #000;
    margin-bottom: 4px;
    letter-spacing: 0.5px;
}

.char-meta {
    font-size: 9px;
    font-weight: 700;
    color: #007AFF; /* è“è‰²ç‚¹ç¼€ä»£è¡¨æ•°æ®é“¾è·¯ */
    letter-spacing: 1px;
}

/* è£…é¥°è¾¹è§’ */
.card-edge-decor {
    position: absolute;
    bottom: -10px;
    right: -10px;
    width: 40px; height: 40px;
    background: #f2f2f7;
    transform: rotate(45deg);
    opacity: 0.5;
}

/* åŸºç¡€å®¹å™¨å¾®è°ƒ - ç¡®ä¿ä½ çš„å®¹å™¨æœ‰ overflow: hidden */
.phone-view-container {
    position: relative;
    overflow: hidden;
    background: #fff;
}

/* å¼¹çª—é®ç½©ï¼šç‰©ç†å‹åˆ¶ä¸€åˆ‡ */
.ins-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    display: none; align-items: flex-end;
}
.ins-modal-overlay.active { display: flex; }
.ins-modal-overlay.second-layer { background: #ffffff; } /* ç¬¬äºŒå±‚å…¨ç™½ï¼Œæ›´çº¯å‡€ */

/* åº•éƒ¨æ»‘å—ä¸»ä½“ */
.ins-modal-sheet {
    width: 100%; background: #ffffff;
    border-radius: 32px 32px 0 0;
    padding: 20px 24px 60px 24px;
    box-shadow: 0 -15px 40px rgba(0,0,0,0.05);
    transform: translateY(100%);
    transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}
.active .ins-modal-sheet { transform: translateY(0); }

/* å¤´éƒ¨æ’ç‰ˆ */
.ins-sheet-handle { width: 36px; height: 4px; background: #EEE; border-radius: 2px; margin: 0 auto 15px; }
.ins-sheet-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; }
.ins-title-stack { display: flex; flex-direction: column; }
.ins-sub-label { font-size: 9px; font-weight: 900; color: #CCC; letter-spacing: 3px; }
.ins-sheet-title { font-size: 28px; font-weight: 800; color: #000; letter-spacing: -1px; margin-top: 4px; }
.ins-close-text { color: #007AFF; font-weight: 700; font-size: 15px; cursor: pointer; padding-bottom: 5px; }

/* ğŸ’ æ ¸å¿ƒï¼šé«˜çº§æ„Ÿå¡ç‰‡è®¾è®¡ */
.ins-history-scroller { max-height: 60vh; overflow-y: auto; padding: 10px 2px; }

.ins-log-card {
    background: #ffffff;
    border-radius: 24px;
    padding: 24px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 10px 30px rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.02);
    transition: all 0.3s ease;
    cursor: pointer;
}
.ins-log-card:active { transform: scale(0.96); background: #FAFAFA; }

.card-left { display: flex; flex-direction: column; gap: 4px; }
.date-tag { font-size: 11px; font-weight: 900; color: #000; letter-spacing: 1.5px; }
.time-meta { font-size: 13px; color: #8E8E93; }

.card-center { flex: 1; padding-left: 25px; position: relative; }
.record-title { font-size: 16px; font-weight: 700; color: #000; margin-bottom: 6px; }
.duration-badge { 
    display: inline-block; font-size: 10px; font-weight: 800; 
    background: #000; color: #fff; padding: 3px 10px; 
    border-radius: 6px; font-family: monospace;
}

.arrow-icon { font-size: 20px; color: #D1D1D6; font-weight: 200; }

/* èŠå¤©æµå®¹å™¨ */
.ins-chat-flow-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    padding: 10px 0 40px 0;
    max-height: 70vh;
    overflow-y: auto;
    scroll-behavior: smooth;
}

/* åŸºç¡€æ°”æ³¡ */
.ins-bubble {
    max-width: 85%;
    padding: 14px 18px;
    font-size: 15px;
    line-height: 1.6;
    letter-spacing: -0.2px;
    position: relative;
}

/* è§’è‰²æ°”æ³¡ (å·¦ä¾§ - æµ…ç°) */
.bubble-assistant {
    align-self: flex-start;
    background: #F2F2F7;
    color: #1C1C1E;
    border-radius: 20px 20px 20px 4px; /* è¿™ç§ä¸å¯¹ç§°åœ†è§’å¾ˆIns */
}

/* ç”¨æˆ·æ°”æ³¡ (å³ä¾§ - çº¯é»‘) */
.bubble-user {
    align-self: flex-end;
    background: #000000;
    color: #FFFFFF;
    border-radius: 20px 20px 4px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* æ°”æ³¡å†…çš„æ—¶é—´ */
.bubble-meta {
    font-size: 10px;
    margin-top: 6px;
    display: block;
    opacity: 0.4;
    font-family: monospace;
}
.bubble-user .bubble-meta { opacity: 0.6; text-align: right; }

/* å¤´éƒ¨å°æ ‡é¢˜ */
.ins-detail-title-small {
    font-size: 10px;
    font-weight: 900;
    letter-spacing: 2px;
    color: #AEAEB2;
}
/* åŒè¯­æ’ç‰ˆå®šåˆ¶ */
.msg-original {
    font-size: 15px;
    font-weight: 500;
    margin-bottom: 4px;
}

.msg-translated {
    font-size: 12px;
    opacity: 0.7;
    font-weight: 400;
    line-height: 1.4;
    border-top: 1px solid rgba(0,0,0,0.05);
    padding-top: 4px;
    margin-top: 4px;
}

/* ç”¨æˆ·ä¾§ï¼ˆé»‘è‰²æ°”æ³¡ï¼‰çš„ç¿»è¯‘æ–‡å­—é¢œè‰²è°ƒæ•´ */
.bubble-user .msg-translated {
    border-top: 1px solid rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.8);
}

/* æ°”æ³¡ä¹‹é—´çš„å±‚æ¬¡æ„Ÿ */
.ins-bubble {
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    margin-bottom: 8px; /* ç´§å‡‘ä¸€ç‚¹ */
}

/* æ—¥æœŸåˆ†ç»„æ ‡é¢˜ */
.recent-date-group-header {
    font-size: 11px;
    font-weight: 800;
    color: #AEAEB2;
    letter-spacing: 1.5px;
    padding: 20px 16px 8px 16px;
    text-transform: uppercase;
}

/* è®°å½•å¡ç‰‡ */
.recent-item {
    background: #fff;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 0.5px solid #F2F2F7;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.recent-item:active { background: #FAFAFA; }

/* å·¦ä¾§ï¼šå¤´åƒä¸åŸºç¡€ä¿¡æ¯ */
.recent-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.recent-avatar {
    width: 48px;
    height: 48px;
    border-radius: 16px;
    object-fit: cover;
    background: #F2F2F7;
}

.recent-main-info {
    display: flex;
    flex-direction: column;
}

/* é€šè¯ç±»å‹å›¾æ ‡ */
.call-type-icon {
    display: inline-flex;
    margin-right: 4px;
    vertical-align: middle;
}

.name-row {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 4px;
}

/* æœªæ¥æ¥ç”µçŠ¶æ€ */
.type-missed { color: #FF3B30 !important; }

.meta-row {
    font-size: 13px;
    color: #8E8E93;
    display: flex;
    align-items: center;
}

/* å³ä¾§ï¼šåˆ é™¤è§¦å‘å™¨ */
.recent-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.delete-circle-btn {
    width: 24px;
    height: 24px;
    background: #F2F2F7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8E8E93;
    cursor: pointer;
    transition: all 0.2s;
}

.delete-circle-btn:hover {
    background: #000;
    color: #fff;
}

/* å¼¹çª—é®ç½©å±‚ */
.ins-confirm-overlay {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.2); /* ææµ…é»‘è‰²é®ç½© */
    backdrop-filter: blur(10px); /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
    -webkit-backdrop-filter: blur(10px);
    display: none; /* åˆå§‹éšè— */
    align-items: center;
    justify-content: center;
    z-index: 5000000; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
    animation: fadeIn 0.3s ease;
}

/* ç¡®è®¤å¡ç‰‡ä¸»ä½“ */
.ins-confirm-card {
    width: 280px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    transform: scale(0.9);
    animation: zoomIn 0.3s cubic-bezier(0.17, 0.89, 0.32, 1.28) forwards;
}

.ins-confirm-content {
    padding: 24px 20px;
    text-align: center;
}

.ins-confirm-title {
    font-size: 17px;
    font-weight: 700;
    color: #000;
    margin-bottom: 8px;
}

.ins-confirm-desc {
    font-size: 13px;
    color: #3A3A3C;
    line-height: 1.4;
}

/* æŒ‰é’®åŒºåŸŸï¼šiOS åˆ†å‰²çº¿é£æ ¼ */
.ins-confirm-footer {
    display: flex;
    border-top: 0.5px solid rgba(0,0,0,0.1);
}

.ins-conf-btn {
    flex: 1;
    padding: 14px 0;
    border: none;
    background: transparent;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.ins-conf-btn:active { background: rgba(0,0,0,0.05); }

.ins-conf-btn.cancel {
    border-right: 0.5px solid rgba(0,0,0,0.1);
    color: #007AFF; /* ç»å…¸ iOS è“ */
}

.ins-conf-btn.danger {
    color: #FF3B30; /* è­¦å‘Šçº¢ */
    font-weight: 700;
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* å¡ç‰‡åˆ é™¤æŒ‰é’®ï¼šåˆå§‹è¿‘ä¹é€æ˜ï¼Œåªæœ‰é«˜çº§æ„Ÿ */
.ins-card-delete {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #D1D1D6;
    border-radius: 50%;
    transition: all 0.2s;
    z-index: 10;
}

.ins-card-delete:hover {
    background: #F2F2F7;
    color: #FF3B30;
}

/* å¼ºåˆ¶ç»™å¡ç‰‡åŠ ä¸ªç›¸å¯¹å®šä½ï¼Œä¸ç„¶åˆ é™¤æŒ‰é’®ä¼šä¹±è·‘ */
.ins-log-card {
    position: relative !important;
}

/* ------------------------------------------------------------
   LUNE MESSAGES - COMMERCIAL GRADE UI (WHITEOUT VERSION)
   ------------------------------------------------------------ */

#page-messageApp {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: #FFFFFF;
    z-index: 10000;
    display: none; /* ç”±é€»è¾‘æ§åˆ¶æ˜¾ç¤º */
    flex-direction: column;
    overflow: hidden;
    /* è°ƒç”¨ä½ å·²æœ‰çš„é«˜çº§å­—ä½“ */
    font-family: 'Montserrat', sans-serif;
    -webkit-font-smoothing: antialiased;
}

/* ç•™å‡ºçŠ¶æ€æ ç©ºéš™ */
.lmsg-status-bar { height: 47px; flex-shrink: 0; background: #FFF; }

.lmsg-header {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    padding: 0 20px;
    border-bottom: 0.5px solid rgba(0,0,0,0.06);
}

.lmsg-upper-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 54px;
}

/* å®¹å™¨ï¼šæ”¹ä¸ºåº•éƒ¨å¯¹é½ */
.lmsg-title-container {
    display: flex;
    align-items: flex-end; /* ğŸš€ æ ¸å¿ƒï¼šè®©å†…å®¹å¯¹é½åˆ°æ ‡é¢˜åº•éƒ¨ */
    gap: 6px;              /* æ ‡é¢˜å’Œæ‹¬å·ä¹‹é—´çš„å‘¼å¸æ„Ÿé—´è· */
}

/* æ ‡é¢˜æ ·å¼ä¿æŒä¸å˜ */
.lmsg-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.7rem;
    font-weight: 800;
    margin: 0;
    line-height: 1;        /* ç¡®ä¿æ²¡æœ‰å¤šä½™çš„è¡Œé«˜å¹²æ‰°å¯¹é½ */
}

/* ğŸš€ é‡æ–°è®¾è®¡çš„å³ä¸‹è§’ç°è‰²æ‹¬å·è§’æ ‡ */
.lmsg-main-badge {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;     /* è°ƒå°ä¸€ç‚¹ï¼Œå½¢æˆè§†è§‰ä¸»æ¬¡ */
    font-weight: 500;
    color: #8E8E93;        /* é«˜çº§å•†ç”¨ç° */
    margin-bottom: 2px;    /* æç»†å¾®è°ƒï¼Œè®©æ‹¬å·åº•éƒ¨å®Œç¾è´´åˆæ ‡é¢˜åŸºå‡†çº¿ */
    letter-spacing: 0.5px;
}

.lmsg-btn-text {
    background: none; border: none;
    color: #007AFF; font-size: 1rem;
    font-weight: 500; cursor: pointer;
}

.lmsg-btn-icon {
    background: none; border: none;
    color: #007AFF; cursor: pointer;
    padding: 0; display: flex;
}

/* æœç´¢æ¡†ï¼šInsé£æç®€ */
.lmsg-search-area { padding: 8px 0 15px; }
.lmsg-search-inner {
    background: #F2F2F7;
    border-radius: 12px;
    height: 40px;
    display: flex;
    align-items: center;
    padding: 0 14px;
}
.lmsg-search-input {
    border: none; background: transparent;
    margin-left: 10px; flex: 1;
    font-size: 0.95rem; outline: none;
    color: #000;
}

/* å¯¼èˆªåˆ†ç±»ï¼šèƒ¶å›Šå½¢æ€ */
/* å¯¼èˆªå®¹å™¨ï¼šæ”¯æŒæ¨ªå‘æ»‘åŠ¨ä½†éšè—æ»šåŠ¨æ¡ */
.lmsg-nav {
    display: flex;
    align-items: center;
    gap: 28px;             /* å¢åŠ é—´è·ï¼Œäº§ç”Ÿç”»æŠ¥çš„ç•™ç™½æ„Ÿ */
    padding: 10px 20px 15px;
    overflow-x: auto;      /* å…è®¸æ¨ªå‘æ»‘åŠ¨ */
    scrollbar-width: none; /* Firefox éšè—æ»šåŠ¨æ¡ */
    -ms-overflow-style: none; /* IE éšè—æ»šåŠ¨æ¡ */
    border-bottom: 0.5px solid rgba(0,0,0,0.05); /* ææ·¡çš„åº•éƒ¨åˆ†å‰² */
}

/* éšè— Webkit å†…æ ¸æµè§ˆå™¨çš„æ»šåŠ¨æ¡ */
.lmsg-nav::-webkit-scrollbar {
    display: none;
}

/* å•ä¸ªæ ‡ç­¾é¡¹æ ·å¼ */
.lmsg-nav-item {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.88rem;
    font-weight: 700;      /* ç²—ä½“å¢åŠ æƒé‡ */
    color: #BCBCC2;        /* æœªé€‰ä¸­çŠ¶æ€ä¸ºé«˜çº§å†·ç° */
    cursor: pointer;
    position: relative;
    white-space: nowrap;   /* é˜²æ­¢æ¢è¡Œ */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: 0.5px;
}

/* æ¿€æ´»çŠ¶æ€ï¼šå˜æˆçº¯é»‘å¹¶å¸¦ä¸Šä¸‹åˆ’çº¿ */
.lmsg-nav-item.active {
    color: #000000;
    transform: translateY(-1px); /* è½»å¾®ä¸Šæµ®æ„Ÿ */
}

/* æ¿€æ´»çŠ¶æ€ä¸‹çš„ä¸‹åˆ’çº¿ï¼šæ”¹ä¸ºæç»†é•¿æ¡ */
.lmsg-nav-item.active::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0;
    width: 100%;
    height: 2.5px;
    background: #000000;
    border-radius: 4px;
    animation: lmsgNavLine 0.3s ease-out; /* å¢åŠ è¿›åœºåŠ¨ç”» */
}

/* æœªè¯»çŠ¶æ€çš„å°çº¢ç‚¹ï¼šæ”¹ä¸ºç²¾è‡´çš„è“ç‚¹æˆ–é»‘ç‚¹ */
.lmsg-nav-dot {
    display: inline-block;
    width: 5px;
    height: 5px;
    background: #007AFF; /* å¯¹åº” iMessage è“ */
    border-radius: 50%;
    margin-left: 2px;
    vertical-align: top;
}

/* ä¸‹åˆ’çº¿è¿›åœºåŠ¨æ•ˆ */
@keyframes lmsgNavLine {
    from { width: 0; left: 50%; opacity: 0; }
    to { width: 100%; left: 0; opacity: 1; }
}

/* æ¶ˆæ¯åˆ—è¡¨å®¹å™¨ */
.lmsg-body {
    flex: 1; overflow-y: auto;
    padding-bottom: 40px;
}

.lmsg-group-title {
    font-size: 0.65rem;
    font-weight: 800;
    color: #BCBCC2;
    padding: 25px 20px 10px;
    letter-spacing: 1.5px;
}

/* æ¶ˆæ¯è¡ŒåŸºç¡€ï¼šç™½ç“·æ„Ÿ */
.lmsg-item {
    display: flex;
    padding: 14px 20px;
    gap: 15px;
    position: relative;
    transition: background 0.3s;
    cursor: pointer;
}
.lmsg-item:active { background: #F9F9F9; }

/* èº«ä»½è¯†åˆ«æ¡ï¼šç²¾é«“æ‰€åœ¨ */
.lmsg-identity-strip {
    position: absolute;
    left: 0; top: 15%; height: 70%;
    width: 3.5px;
    border-radius: 0 4px 4px 0;
}

.lmsg-avatar, .lmsg-avatar-placeholder {
    width: 56px; height: 56px;
    border-radius: 50%;
    flex-shrink: 0; overflow: hidden;
}
.lmsg-avatar img { width: 100%; height: 100%; object-fit: cover; }
.lmsg-avatar-placeholder {
    background: #E5E5EA; color: #FFF;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; font-weight: 700;
}

.lmsg-info {
    flex: 1; min-width: 0;
    display: flex; flex-direction: column;
    justify-content: center;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
    padding-bottom: 14px;
}

.lmsg-info-top {
    display: flex; justify-content: space-between;
    align-items: baseline; margin-bottom: 4px;
}

.lmsg-sender-name {
    font-weight: 700; font-size: 1.05rem; color: #000;
}
.lmsg-sender-name small { font-weight: 400; font-size: 0.7rem; color: #8E8E93; }

.lmsg-meta-time { font-size: 0.85rem; color: #8E8E93; }

.lmsg-info-bottom {
    display: flex; justify-content: space-between; align-items: flex-start;
}
.lmsg-msg-preview {
    font-size: 0.92rem; color: #8E8E93;
    line-height: 1.3; margin: 0;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

.lmsg-unread-indicator {
    width: 10px; height: 10px;
    background: #007AFF; border-radius: 50%;
    flex-shrink: 0; margin-left: 10px; margin-top: 4px;
}

/* ------------------------------------------------------------
   BLUE & GREEN LOGIC - æ·±åº¦è®¾è®¡
   ------------------------------------------------------------ */

/* è“ç³»ï¼šæ·±åº¦è¿æ¥ (iMessage é£æ ¼) */
.lmsg-identity-blue .lmsg-identity-strip {
    background: #007AFF;
    box-shadow: 2px 0 10px rgba(0, 122, 255, 0.4); /* å‘¼å¸å¾®å…‰ */
}
.lmsg-identity-blue .lmsg-sender-name { color: #007AFF; }

/* ç»¿ç³»ï¼šç³»ç»Ÿé€šè®¯ (SMS é£æ ¼) */
.lmsg-identity-green .lmsg-identity-strip {
    background: #34C759;
}

/* æ‹‰é»‘çŠ¶æ€ï¼šæ­»å¯‚æ„Ÿ */
.lmsg-is-blocked { opacity: 0.5; filter: grayscale(1); }
.lmsg-is-blocked .lmsg-sender-name { text-decoration: line-through; }
.lmsg-is-blocked .lmsg-msg-preview { color: #FF3B30; }

.lmsg-bottom-safe-area { height: 34px; flex-shrink: 0; }

/* --- æ’°å†™æŒ‰é’®ï¼šæè‡´ç»†èŠ‚ç¾åŒ– --- */
.lmsg-compose-btn {
    background: none;
    border: none;
    padding: 10px;        /* æ‰©å¤§ç‚¹å‡»çƒ­åŒºï¼Œæå‡æ‰‹æ„Ÿ */
    color: #007AFF;       /* æ ¸å¿ƒäº¤äº’è“ï¼Œéå¸¸æœ‰å•†ä¸šè´¨æ„Ÿ */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.33, 1, 0.68, 1); /* ä¸æ»‘è¿‡æ¸¡ */
    -webkit-tap-highlight-color: transparent; /* å»é™¤ç§»åŠ¨ç«¯è“è‰²å¤–æ¡† */
}

/* æ¨¡æ‹ŸçœŸæœºç‚¹å‡»çš„ä¸‹å‹æ„Ÿ (å•†ç”¨çº§äº¤äº’ç»†èŠ‚) */
.lmsg-compose-btn:active {
    transform: scale(0.85); /* ç‚¹å‡»æ—¶è½»å¾®ç¼©å° */
    opacity: 0.6;           /* é€æ˜åº¦é™ä½ï¼Œæ¨¡æ‹ŸæŒ‰ä¸‹å»çš„æ•ˆæœ */
    background: rgba(0, 122, 255, 0.08); /* ææ·¡çš„åœ†å½¢åº•è‰²åé¦ˆ */
    border-radius: 50%;
}

/* å¦‚æœä½ çš„ Messages æ ‡é¢˜å¾ˆå¤§ï¼Œè¿™ä¸ªæŒ‰é’®éœ€è¦å‚ç›´å¯¹é½ */
.lmsg-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 4px; /* ç»™å·¦å³ç•™ç‚¹å‘¼å¸æ„Ÿ */
}
/* ------------------------------------------------------------
   LUNE MESSAGE - COMPOSE VIEW (COMMERCIAL GRADE)
   ------------------------------------------------------------ */

.lmsg-compose-overlay {
    position: fixed;
    top: 100%; /* åˆå§‹åœ¨å±å¹•ä¸‹æ–¹ */
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #FFFFFF;
    z-index: 11000; /* é«˜äºæ™®é€š App */
    display: flex;
    flex-direction: column;
    transition: transform 0.4s cubic-bezier(0.32, 1, 0.23, 1);
    font-family: 'Montserrat', sans-serif;
}

/* æ¿€æ´»çŠ¶æ€ï¼šå‘ä¸Šæ»‘å‡º */
.lmsg-compose-overlay.active {
    transform: translateY(-100%);
}

.lmsg-compose-header {
    padding: 60px 20px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
}

.lmsg-comp-title {
    font-size: 1rem;
    font-weight: 700;
    color: #000;
    margin: 0;
}

.lmsg-comp-cancel, .lmsg-comp-send {
    background: none; border: none;
    font-size: 1rem; font-weight: 500;
    color: #007AFF; cursor: pointer;
}
.lmsg-comp-send:disabled { opacity: 0.3; cursor: default; }

/* æ”¶ä»¶äººæ ï¼šæè‡´æç®€ */
.lmsg-recipient-bar {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    gap: 10px;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
}

.lmsg-to-label { color: #8E8E93; font-size: 0.95rem; }

.lmsg-input-wrapper { flex: 1; display: flex; align-items: center; }

#lmsg-to-input {
    flex: 1; border: none; outline: none;
    font-size: 0.95rem; font-weight: 500;
}

.lmsg-add-contact-btn {
    background: none; border: none; color: #007AFF;
    cursor: pointer; padding: 0 5px;
}

/* ğŸ’¡ è”æƒ³ç»“æœå¡ç‰‡ï¼šå•†ç”¨ç²¾é«“ */
.lmsg-results-area {
    max-height: 200px;
    overflow-y: auto;
    background: #F9F9F9;
}

.lmsg-recipient-card {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    gap: 15px;
    border-bottom: 0.5px solid rgba(0,0,0,0.03);
    cursor: pointer;
    transition: background 0.2s;
}
.lmsg-recipient-card:active { background: #EEE; }

.lmsg-card-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    object-fit: cover;
    background: #007AFF; /* é»˜è®¤è“è‰² */
    color: #FFF; display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 0.8rem;
}

.lmsg-card-info { display: flex; flex-direction: column; }
.lmsg-card-name { font-size: 0.9rem; font-weight: 700; color: #000; }
.lmsg-card-phone { font-size: 0.75rem; color: #8E8E93; margin-top: 1px; }

/* ç¼–è¾‘åŒº */
.lmsg-editor-area { flex: 1; padding: 20px; }
#lmsg-main-editor {
    width: 100%; height: 100%;
    border: none; outline: none;
    resize: none; font-size: 1.1rem;
    line-height: 1.5; font-family: inherit;
    color: #333;
}

/* åº•éƒ¨å·¥å…·æ  */
.lmsg-compose-toolbar {
    padding: 10px 20px 40px;
    display: flex; align-items: center; gap: 20px;
    border-top: 0.5px solid rgba(0,0,0,0.05);
}
.lmsg-tool-item { color: #8E8E93; cursor: pointer; }
/* --- æ’°å†™é¡µåº•éƒ¨å·¥å…·æ  --- */
.lmsg-compose-footer {
    padding: 10px 16px calc(20px + env(safe-area-inset-bottom)); /* é€‚é…åˆ˜æµ·å±åº•éƒ¨å®‰å…¨åŒº */
    background: #FFFFFF;
    border-top: 0.5px solid rgba(0,0,0,0.05);
    position: absolute;
    bottom: 0;
    width: 100%;
}

.lmsg-input-pill {
    background: rgba(255, 255, 255, 0) !important; /* è°ƒæˆ 10% é€æ˜ç™½ */
    backdrop-filter: blur(5px) !important; /* è°ƒä½æ¨¡ç³Š */
    -webkit-backdrop-filter: blur(5px) !important;
    border: 0.5px solid rgba(255, 255, 255, 0.1) !important; /* è¾¹æ¡†å‡å¼± */
    border-radius: 28px;
    display: flex; align-items: center; padding: 6px 8px; gap: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

.lmsg-input-pill:focus-within {
    border-color: #007AFF; /* èšç„¦æ—¶æ·¡æ·¡çš„è“è‰²è¾¹æ¡† */
}

/* é™„ä»¶æŒ‰é’® */
.lmsg-attach-btn {
    background: none; border: none;
    color: #8E8E93; cursor: pointer;
    display: flex; align-items: center;
    transition: transform 0.2s;
}
.lmsg-attach-btn:active { transform: scale(0.9); }

/* è¾“å…¥æ¡† */
#lmsg-message-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 1rem;
    font-family: 'Montserrat', sans-serif;
    background: transparent;
    padding: 8px 0;
}

/* å‘é€æŒ‰é’® (åœ†å½¢è“è‰²å›¾æ ‡) */
.lmsg-send-trigger {
    width: 32px;
    height: 32px;
    background: #007AFF;
    color: #FFFFFF;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.3; /* é»˜è®¤ç¦ç”¨çŠ¶æ€ */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: scale(0.8);
}

/* æ¿€æ´»æ€ï¼šå½“è¾“å…¥æ¡†æœ‰æ–‡å­—æ—¶ */
.lmsg-send-trigger.ready {
    opacity: 1;
    transform: scale(1);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
}

.lmsg-send-trigger:active {
    transform: scale(0.9);
}
/* ä¸­é—´é¢„è§ˆåŒºæ ·å¼ */
.lmsg-preview-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: #FFF;
}

.lmsg-preview-hint {
    text-align: center;
    color: #CCC;
    font-size: 0.75rem;
    letter-spacing: 2px;
    margin-top: 40px;
    text-transform: uppercase;
}

/* --- ğŸš€ æ°”æ³¡ç¾åŒ–ï¼šå•†ç”¨çº§æœˆå…‰è“ --- */
.lmsg-draft-bubble {
    align-self: flex-end;
    background: linear-gradient(135deg, #007AFF 0%, #0056D2 100%); /* æ·±æµ…è“å¾®æ¸å˜ */
    color: #FFFFFF;
    padding: 12px 18px;
    border-radius: 20px 20px 4px 20px; /* å³ä¸‹è§’ç›´è§’ï¼Œå…¶ä½™åœ†è§’ */
    font-size: 0.95rem;
    max-width: 75%;
    line-height: 1.45;
    position: relative; /* å¿…é¡»ä¸º relativeï¼Œä¾›å…ƒæ•°æ®å®šä½ */
    margin-left: 60px;   /* é¢„ç•™å·¦ä¾§å…ƒæ•°æ®ç©ºé—´ */
    box-shadow: 0 4px 15px rgba(0, 122, 255, 0.2); /* æŸ”å’Œçš„è“è‰²æŠ•å½± */
    animation: bubbleUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    margin-left: 70px; /* ç¨å¾®å¢åŠ ä¸€ç‚¹é—´è·ï¼Œé˜²æ­¢æ—¶é—´æˆ³é‡å  */
}

/* --- ğŸš€ å·¦ä¸‹è§’å…ƒæ•°æ®å †å  (æ—¶é—´ + æœªè¯») --- */
.lmsg-bubble-meta-stack {
    position: absolute;
    left: -65px;       /* å¯¹åº”è°ƒæ•´ä½ç½® */
    bottom: 4px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

/* æœªè¯»çŠ¶æ€ï¼šæ”¹ä¸ºå•†ç”¨é«˜çº§ç° */
.lmsg-meta-status {
    font-size: 0.6rem; /* ä¸­æ–‡å­—ä½“å¯ä»¥ç¨å¾®å°ä¸€ç‚¹ï¼Œæ˜¾å¾—ç²¾è‡´ */
    font-weight: 500;
    color: #8E8E93;    /* ğŸš€ æ ‡å‡†ç°è‰² */
    letter-spacing: 0.5px;
    margin-bottom: 1px;
}

/* æ—¶é—´æˆ³ï¼šAM/PM å­—ä½“ä¿æŒ Montserrat */
.lmsg-meta-time {
    font-size: 0.65rem;
    color: #BCBCC2;
    font-family: 'Montserrat', sans-serif;
    text-transform: uppercase;
    white-space: nowrap; /* é˜²æ­¢ AM/PM æ¢è¡Œ */
}

@keyframes bubbleUp {
    from { opacity: 0; transform: translateY(20px) scale(0.8); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* åº•éƒ¨è¾“å…¥æ¡†ä½ç½®å¾®è°ƒ */
.lmsg-compose-footer {
    position: relative; /* æ”¹å›ç›¸å¯¹å®šä½ï¼Œå› ä¸ºé¢„è§ˆåŒºæ˜¯ flex:1 */
    padding-bottom: 40px;
}

/* --- ğŸš€ è¯¦æƒ…é¡µå…¨å±å®¹å™¨ --- */
.lmsg-chat-overlay {
    position: fixed; top: 0; left: 100%; width: 100%; height: 100%;
    background: transparent !important; /* æ ¸å¿ƒï¼šå…¨é€æ˜ï¼Œé€å‡ºåº•å±‚å£çº¸ */
    z-index: 12000;
    display: flex; flex-direction: column;
    transition: left 0.4s cubic-bezier(0.32, 1, 0.23, 1);
    font-family: 'Montserrat', sans-serif;
    background: #FFFFFF !important; /* å¼ºåˆ¶å…¨å±€ç™½è‰² */
}
.lmsg-chat-overlay.active { left: 0; }

/* --- ğŸš€ Header æ•´ä½“å¸ƒå±€ï¼šå‘ä¸¤ä¾§æ‹‰å¼€ --- */
.lmsg-chat-header {
    display: flex;
    align-items: center;
    padding: 60px 16px 15px;
    background: rgba(255, 255, 255, 0.1) !important; /* 0.1 ä»£è¡¨åªæœ‰ 10% çš„ç™½è‰²ï¼Œéå¸¸é€æ˜ */
    backdrop-filter: blur(5px) !important; /* 5px åªæœ‰è½»å¾®ç£¨ç ‚æ„Ÿï¼Œ25px ä¼šå®Œå…¨çœ‹ä¸æ¸…èƒŒæ™¯ */
    -webkit-backdrop-filter: blur(5px) !important;
    border-bottom: 0.5px solid rgba(255, 255, 255, 0.05); /* è¾¹æ¡†ä¹Ÿè°ƒæ·¡ */
}

/* ç›®æ ‡ä¿¡æ¯å®¹å™¨ï¼šç´§è·Ÿåœ¨è¿”å›é”®åé¢ */
.lmsg-chat-target {
    display: flex;
    align-items: center;
    flex: 1; /* æ’‘å¼€ä¸­é—´ç©ºé—´ */
    margin-left: 8px; /* ä¸è¿”å›é”®çš„é—´è· */
    gap: 12px;
    cursor: pointer;
}

/* ğŸš€ å¤´åƒé˜²å˜å½¢ä¿®å¤ */
#chat-target-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #F2F2F7;
    object-fit: cover; /* å…³é”®ï¼šé˜²æ­¢å›¾ç‰‡è¢«æ‹‰ä¼¸æˆ–å‹ç¼© */
    flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«æŒ¤å‹ */
}

/* æ–‡å­—ä¿¡æ¯æµ */
.lmsg-chat-target-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.lmsg-name-phone-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

#chat-target-name {
    font-size: 16px;
    font-weight: 700;
    color: #000;
    letter-spacing: -0.5px;
}

/* ğŸš€ ç”µè¯å·ç å°æ ‡ç­¾ */
.lmsg-phone-tag {
    font-size: 10px;
    font-family: 'Montserrat', sans-serif;
    color: #8E8E93;
    background: rgba(142, 142, 147, 0.12); /* æ·¡æ·¡çš„ç“·ç°èƒŒæ™¯ */
    padding: 2px 6px;
    border-radius: 5px;
    font-weight: 600;
}

.lmsg-status-text {
    font-size: 10px;
    color: #34C759;
    font-weight: 600;
}

/* ğŸš€ ä¿®å¤ï¼šå¼ºåˆ¶å»æ‰ç”µè¯æŒ‰é’®çš„é»˜è®¤ç°è‰²èƒŒæ™¯ */
.lmsg-header-call-btn {
    background: none !important; /* å¼ºåˆ¶å»æ‰èƒŒæ™¯ */
    background-color: transparent !important; /* ç¡®ä¿å®Œå…¨é€æ˜ */
    border: none !important; /* å»æ‰è¾¹æ¡† */
    box-shadow: none !important; /* å»æ‰å¯èƒ½çš„é˜´å½± */
    outline: none !important;
    padding: 0 !important;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    width: 44px; /* ä¿æŒç‚¹å‡»åŒºåŸŸ */
    height: 44px;
    color: #007AFF; /* æ¢å¤è“è‰² */
}

/* ğŸš€ ä¿®å¤ï¼šå¤´åƒé˜²å˜å½¢è¡¥ä¸ (é˜²æ­¢ç¾åŒ–å¤±æ•ˆ) */
#chat-target-avatar {
    width: 38px !important;
    height: 38px !important;
    border-radius: 50% !important;
    object-fit: cover !important; /* å…³é”®ï¼šé˜²æ‹‰ä¼¸ */
    flex-shrink: 0 !important;
}

/* --- ğŸš€ å¯¹è¯æµåŒºåŸŸ --- */
.lmsg-chat-body {
    flex: 1; overflow-y: auto; padding: 20px 15px;
    display: flex; flex-direction: column; gap: 10px;
}

/* --- ğŸš€ æ—¶é—´æˆ³åˆ†éš”ç¬¦ç¾åŒ– --- */
.lmsg-date-divider {
    text-align: center;
    font-size: 10px;
    color: #BCBCC2; /* æ·¡æ·¡çš„ç°è‰² */
    font-family: 'Montserrat', sans-serif;
    letter-spacing: 1.5px; /* å­—é—´è·æ‹‰å¼€ä¸€ç‚¹ */
    margin: 25px 0 15px;
    font-weight: 600;
    text-transform: uppercase;
    display: block;
    width: 100%;
}

/* --- ğŸš€ åº•éƒ¨æ‹Ÿç¨¿æ§½ (æ¯›ç»ç’ƒèƒ¶å›Š) --- */
.lmsg-chat-footer {
    padding: 10px 16px 40px;
    background: transparent;
}

#lmsg-chat-input {
    flex: 1; border: none; background: transparent; outline: none;
    font-size: 0.95rem; font-weight: 500; color: #000;
}

.lmsg-ai-btn {
    background: none; border: none; color: #AF52DE; /* AI ä¸“å±ç´«è‰² */
    cursor: pointer; padding: 5px; opacity: 0.7; transition: 0.3s;
}
.lmsg-ai-btn:hover { opacity: 1; transform: rotate(15deg); }

.lmsg-send-trigger {
    width: 32px; height: 32px; border-radius: 50%; border: none;
    background: #007AFF; color: #fff; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.3s;
}
.lmsg-send-trigger:disabled { background: #E5E5EA; color: #BCBCC2; }

/* --- ğŸš€ æ°”æ³¡å®½åº¦é™åˆ¶ä¸æ’ç‰ˆ --- */
.lmsg-bubble-wrapper {
    display: flex;
    flex-direction: column;
    margin-bottom: 24px; /* å¢åŠ é—´è·ï¼Œé˜²æ­¢æ—¶é—´æˆ³æŒ¤åœ¨ä¸€èµ· */
    position: relative;
    width: 100%;
}

/* --- ğŸš€ ç”¨æˆ·æ°”æ³¡ï¼šåˆ‡æ¢ä¸º iOS ç»å…¸ç»¿ --- */
.lmsg-user-bubble {
    align-self: flex-end;
    max-width: 68%;
    /* ğŸ¨ æ¢æˆæ›´æœ‰å±‚æ¬¡æ„Ÿçš„ç»¿è‰²æ¸å˜ */
    background: linear-gradient(135deg, #34C759, #28A745) !important; 
    color: #FFFFFF; /* ç¡®ä¿æ–‡å­—æ˜¯çº¯ç™½ */
    padding: 12px 16px;
    border-radius: 18px 18px 4px 18px; /* iOS é£æ ¼åœ†è§’ï¼šå·¦ä¸‹è§’å¤§ï¼Œå³ä¸‹è§’å°– */
    position: relative;
    word-wrap: break-word;
    line-height: 1.4;
    /* ğŸ’¡ é˜´å½±ä¹ŸåŒæ­¥è°ƒæˆæ·¡æ·¡çš„ç»¿è‰²ï¼Œå¢åŠ é€šé€æ„Ÿ */
    box-shadow: 0 4px 15px rgba(52, 199, 89, 0.2); 
    margin-left: 80px; /* ä¸ºå·¦ä¾§æ—¶é—´æˆ³ç•™ä½ */
}

/* ğŸš€ å…ƒæ•°æ®å †å ï¼šæ”¾åœ¨æ°”æ³¡å·¦ä¸‹è§’å¤–ä¾§ */
.lmsg-bubble-meta {
    position: absolute;
    left: -40px; /* è°ƒæ•´åˆ°æ°”æ³¡å·¦ä¾§ */
    bottom: 2px; /* åº•éƒ¨å¯¹é½ */
    display: flex;
    flex-direction: column; /* ä¸Šä¸‹å †å  */
    align-items: flex-end; /* é æ°”æ³¡å¯¹é½ */
    gap: 1px;
    pointer-events: none;
}

/* æœªè¯»/å·²å‘é€æ ‡ç­¾ */
.lmsg-meta-status {
    font-size: 10px;
    color: #8E8E93; /* é«˜çº§ç° */
    font-weight: 500;
}

/* æ—¶é—´æˆ³æ ‡ç­¾ */
.lmsg-meta-time {
    font-size: 10px;
    font-family: 'Montserrat', sans-serif;
    color: #BCBCC2;
    text-transform: uppercase;
    white-space: nowrap;
}

/* å®ä½“æ°”æ³¡ (å¯¹æ–¹) ä¹Ÿè¦é™åˆ¶å®½åº¦ */
.lmsg-entity-bubble {
    align-self: flex-start;
    max-width: 68%;
    background: #F2F2F7;
    color: #000;
    padding: 12px 16px;
    border-radius: 18px 18px 18px 4px;
    word-wrap: break-word;
}

/* --- ğŸš€ è¿”å›æŒ‰é’®ï¼šiOS çº§äº¤äº’ç¾åŒ– --- */
.lmsg-chat-back {
    background: none;
    border: none;
    outline: none;
    display: flex;
    align-items: center;
    padding: 0;
    cursor: pointer;
    color: #007AFF; /* ç»å…¸ iOS è“è‰² */
    transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1), transform 0.2s ease;
    z-index: 10;
    -webkit-tap-highlight-color: transparent; /* å»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»è“æ¡† */
}

/* æŒ‰é’®ç‚¹å‡»ç¬é—´çš„åé¦ˆï¼ˆiOS æ ‡å‡†ï¼šå˜æ·¡ + å¾®ç¼©ï¼‰ */
.lmsg-chat-back:active {
    opacity: 0.2;
    transform: scale(0.96);
}

/* å›¾æ ‡å¾®è°ƒï¼šç¡®ä¿çº¿æ¡åœ†æ¶¦ */
.lmsg-chat-back svg {
    display: block;
    width: 26px; /* ç¨å¾®æ”¾å¤§ä¸€ç‚¹æ›´å…·å¼ åŠ› */
    height: 26px;
    stroke: currentColor; /* é¢œè‰²éšæ–‡å­—åŒæ­¥ */
    stroke-linecap: round;
    stroke-linejoin: round;
}

/* ğŸš€ æ ¸å¿ƒç¾åŒ–ï¼šä½¿ç”¨ä¼ªå…ƒç´ å¢åŠ  "Back" æ–‡å­—ï¼Œæ— éœ€ä¿®æ”¹ HTML */
.lmsg-chat-back::after {
    content: "Back";
    font-family: 'Montserrat', sans-serif;
    font-size: 17px;
    font-weight: 400;
    margin-left: -3px; /* è®©æ–‡å­—ä¸æŠ˜çº¿å›¾æ ‡åœ¨è§†è§‰ä¸Šè´´åˆ */
    letter-spacing: -0.5px;
}
/* --- ğŸš€ å¼¹çª—å®¹å™¨ï¼šå…¨å±æ¨¡ç³Š --- */
.lmsg-profile-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 15000; display: none; align-items: center; justify-content: center;
}

.lmsg-profile-overlay {
    position: absolute; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px);
}

.lmsg-profile-content {
    position: relative; width: 85%; max-width: 400px; max-height: 80vh;
    background: #FFF; border-radius: 2px; /* æç®€ç›´è§’æˆ–å¾®åœ†è§’ */
    display: flex; flex-direction: column; overflow: hidden;
    animation: lmsgModalIn 0.4s cubic-bezier(0.2, 1, 0.3, 1);
}

@keyframes lmsgModalIn {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* --- ğŸš€ å¤´éƒ¨ä¸æ ‡é¢˜ --- */
.lmsg-profile-header {
    padding: 20px; border-bottom: 1px solid #000;
    display: flex; justify-content: space-between; align-items: center;
    font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 12px; letter-spacing: 2px;
}

.lmsg-profile-close {
    background: #000; color: #FFF; border: none; padding: 5px 12px;
    font-size: 10px; cursor: pointer;
}

.lmsg-profile-scroll-area { padding: 20px; overflow-y: auto; flex: 1; }

.lmsg-section-title {
    font-size: 10px; font-weight: 700; color: #888; margin-bottom: 12px;
    letter-spacing: 1px; border-left: 3px solid #000; padding-left: 8px;
}

/* --- ğŸš€ é¢„è§ˆåŒº (æ‰‹æœºæ¯”ä¾‹) --- */
.lmsg-preview-container {
    width: 100%; display: flex; justify-content: center; margin-bottom: 25px;
}

.lmsg-bg-preview {
    width: 140px; height: 260px; /* çº¦ 9:16.7 æ¯”ä¾‹ */
    background: #F0F0F0; border: 1px solid #000; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    position: relative;
}

.lmsg-bg-preview img, .lmsg-bg-preview video {
    width: 100%; height: 100%; object-fit: cover;
}

/* --- ğŸš€ æŒ‰é’®ä¸é€‰æ‹©å™¨ --- */
.lmsg-upload-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 25px; }

.lmsg-upload-btn, .lmsg-reset-btn {
    width: 100%; height: 44px; border: 1px solid #000; background: transparent;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 600; cursor: pointer; transition: 0.3s;
}

.lmsg-upload-btn:hover, .lmsg-reset-btn:hover { background: #000; color: #FFF; }

.lmsg-lang-selector { display: flex; gap: 10px; }

.lmsg-lang-option {
    flex: 1; height: 60px; border: 1px solid #EEE;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.3s;
}

.lmsg-lang-option.active { border-color: #000; background: #000; color: #FFF; }

.lang-code { font-size: 16px; font-weight: 800; }
.lang-label { font-size: 8px; opacity: 0.6; }
/* ğŸš€ å…¨å±€èƒŒæ™¯å®¹å™¨æ ·å¼ï¼šé“ºæ»¡æ•´ä¸ªå±å¹•ï¼Œz-index æœ€å° */
.lmsg-custom-bg-global {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* ä¿è¯åœ¨æ‰€æœ‰ Header, Footer, Body ä¹‹ä¸‹ */
    pointer-events: none; /* ä¸å¹²æ‰°ç‚¹å‡» */
    overflow: hidden;
}

/* ğŸš€ å…³é”®ï¼šç¡®ä¿è¯¦æƒ…é¡µçª—å£æœ¬èº«æ˜¯é€æ˜çš„ */
.lmsg-chat-overlay {
    background: transparent !important;
}

/* ğŸš€ å…³é”®ï¼šç¡®ä¿ä¸­é—´çš„æ¶ˆæ¯æµåŒºåŸŸä¸å¸¦èƒŒæ™¯è‰² */
.lmsg-chat-body {
    background: transparent !important;
}

/* ğŸš€ å¦‚æœä½ å¸Œæœ› Header å’Œ Footer æœ‰é‚£ç§ç£¨ç ‚é€å…‰æ„Ÿï¼Œè€Œä¸æ˜¯çº¯é€æ˜ */
.lmsg-chat-header, .lmsg-chat-footer {
    background: rgba(255, 255, 255, 0.1) !important; /* é™ä½ä¸é€æ˜åº¦ */
    backdrop-filter: blur(20px); /* ç»´æŒé«˜çº§æ¯›ç»ç’ƒæ„Ÿ */
    -webkit-backdrop-filter: blur(20px);
}
/* --- ğŸš€ è¯­è¨€é€‰æ‹©å™¨ï¼šä¹å®«æ ¼å¸ƒå±€ --- */
.lmsg-lang-selector-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* å®Œç¾çš„ 3x3 å¸ƒå±€ */
    gap: 8px;
    margin-top: 10px;
}

.lmsg-lang-option {
    aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    border: 1px solid #E5E5E5;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: #FFF;
}

/* æ‚¬åœåé¦ˆ */
.lmsg-lang-option:hover {
    border-color: #000;
}

/* ğŸš€ æ¿€æ´»çŠ¶æ€ï¼šåè‰²é»‘ç™½æ„Ÿ */
.lmsg-lang-option.active {
    background: #000 !important;
    border-color: #000 !important;
}

.lmsg-lang-option.active .lang-code,
.lmsg-lang-option.active .lang-label {
    color: #FFF !important;
}

.lang-code {
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    font-weight: 900;
    color: #000;
    letter-spacing: 1px;
}

.lang-label {
    font-family: 'Montserrat', sans-serif;
    font-size: 7px;
    font-weight: 500;
    color: #8E8E93;
    margin-top: 4px;
    text-transform: uppercase;
}

/* è‡ªåŠ¨/åŒè¯­æ¨¡å¼çš„ç‰¹æ®Šè§†è§‰ */
.lmsg-lang-option.mode-auto {
    border-style: dashed; /* è™šçº¿æ¡†è¡¨ç¤ºè‡ªåŠ¨ */
}

/* ğŸš€ ç¡®ä¿æ¶ˆæ¯å®¹å™¨åœ¨èƒŒæ™¯ä¹‹ä¸Šï¼Œä¸”èƒŒæ™¯æ˜¯é€æ˜çš„ */
#chat-messages-container {
    position: relative !important;
    z-index: 5 !important; /* é«˜äºèƒŒæ™¯çš„ -1 */
    background: transparent !important; /* å¿…é¡»é€æ˜ï¼Œå¦åˆ™ä¼šæŒ¡ä½å…¨å±å£çº¸ */
}

/* ğŸš€ ä¿®å¤å¯èƒ½å­˜åœ¨çš„ç©ºç™½è¦†ç›–å±‚ */
.chat-scroll-area {
    background: transparent !important;
}
/* --- ğŸš€ çŸ­ä¿¡ App ä¸“å±æ°”æ³¡ç³»ç»Ÿ --- */
.lmsg-bubble-row {
    display: flex;
    flex-direction: column;
    margin-bottom: 12px;
    width: 100%;
    animation: lmsgPop 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
}

.row-user { align-items: flex-end; }
.row-opp { align-items: flex-start; }

/* --- ğŸš€ è§’è‰²ï¼ˆå¯¹æ–¹ï¼‰æ°”æ³¡æ ·å¼è¡¥å…¨ --- */

/* --- ğŸš€ åŸºç¡€å®¹å™¨ï¼šä¿æŒæº¢å‡ºå¯è§ï¼Œé˜²æ­¢ Meta æ¶ˆå¤± --- */
.lmsg-bubble-wrapper {
    display: flex;
    flex-direction: column;
    margin-bottom: 28px;
    position: relative;
    width: 100%;
    overflow: visible !important; /* ğŸ‘ˆ å¿…é¡»ï¼šé˜²æ­¢åˆ·æ–°å Meta æ ‡ç­¾è¢«åˆ‡æ‰ */
}

/* ğŸš€ è§’è‰²ä¾§ï¼šå½»åº•é•œåƒä¿®å¤ --- */
.row-opp { align-items: flex-start; }
.lmsg-entity-wrapper {
    display: flex; /* ğŸ‘ˆ æ ¸å¿ƒï¼šè®©å®¹å™¨è‡ªé€‚åº”å†…å®¹ */
    flex-direction: column;
    align-items: flex-start;
    width: fit-content; /* ğŸ‘ˆ æ ¸å¿ƒï¼šå®½åº¦éšæ–‡å­—èµ°ï¼Œä¸ä¹±æ’‘å¼€ */
    max-width: 68%;
    position: relative;
}

.lmsg-entity-bubble {
    background: #F2F2F7;
    color: #000;
    padding: 12px 16px;
    border-radius: 18px 18px 18px 4px;
    word-wrap: break-word;
    width: 100%; /* å¡«æ»¡ wrapper */
}

/* è§’è‰²å…ƒæ•°æ®ï¼šç´§è´´æ°”æ³¡å³ä¾§å¤– */
.lmsg-entity-meta {
    position: absolute;
    right: -70px; /* ğŸ‘ˆ è·ç¦»è°ƒä¼˜ï¼šå’Œç”¨æˆ·ä¾§å®Œå…¨å¯¹ç§° */
    bottom: 2px;
    display: flex;
    flex-direction: column; /* ğŸ’¡ çŠ¶æ€åœ¨ä¸Šï¼Œæ—¶é—´åœ¨ä¸‹ */
    align-items: flex-start;
    gap: 1px;
    pointer-events: none;
}

/* ç»Ÿä¸€æ ·å¼ */
.lmsg-meta-status { font-size: 9px; color: #8E8E93; font-weight: 700; text-transform: uppercase; }
.lmsg-meta-time { font-size: 9px; color: #BCBCC2; font-family: 'Montserrat'; text-transform: uppercase; }
/* ğŸš€ æ€è€ƒä¸­åŠ¨ç”» */
.lmsg-typing-bubble {
    background: #E5E5EA;
    width: 45px; height: 28px;
    border-radius: 15px;
    display: flex; align-items: center; justify-content: center;
    gap: 3px; margin-left: 5px;
}
.lmsg-dot {
    width: 5px; height: 5px; background: #8E8E93; border-radius: 50%;
    animation: lmsgDot 1.4s infinite;
}
.lmsg-dot:nth-child(2) { animation-delay: 0.2s; }
.lmsg-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes lmsgDot { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1.1); opacity: 1; } }
@keyframes lmsgPop { from { opacity: 0; transform: translateY(5px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
/* --- ğŸš€ çŸ­ä¿¡ Appï¼šç»ˆææ’ç‰ˆè¡¥ä¸ --- */

/* åŸºç¡€å®¹å™¨ï¼šå¿…é¡»æº¢å‡ºå¯è§ï¼Œå¦åˆ™åˆ·æ–°åæ—¶é—´æˆ³ä¼šè¢«åˆ‡æ‰ */
.lmsg-bubble-wrapper {
    display: flex;
    flex-direction: column;
    margin-bottom: 25px; /* å¢åŠ è¡Œé—´è· */
    position: relative;
    width: 100%;
    overflow: visible !important; 
}

/* --- ğŸš€ è§’è‰²ä¾§ (å·¦ä¾§) é•œåƒä¿®å¤ --- */

.row-opp { 
    align-items: flex-start !important; 
}

/* è§’è‰²æ°”æ³¡ï¼šå¼ºåˆ¶éšæ–‡å­—é•¿åº¦æ”¶ç¼©ï¼Œè§£å†³å¤§çŸ©å½¢é—®é¢˜ */
.lmsg-entity-bubble {
    align-self: flex-start;
    width: fit-content;      /* ğŸ’¡ æ ¸å¿ƒï¼šæ°”æ³¡å®½åº¦éšå­—èµ° */
    min-width: 40px;         /* ğŸ’¡ é˜²æ­¢è¿‡çŸ­ */
    max-width: 68%;
    background: #F2F2F7;
    color: #000;
    padding: 12px 16px;
    border-radius: 18px 18px 18px 4px;
    word-wrap: break-word;
    position: relative;
    margin-right: 80px;      /* ğŸ’¡ ä¸ºå³ä¾§å…ƒæ•°æ®ç•™å‡ºå›ºå®šå®‰å…¨åŒº */
}

/* è§’è‰²å…ƒæ•°æ®ï¼šæ”¾åœ¨æ°”æ³¡å³ä¾§å¤–ï¼Œä¸Šä¸‹å †å  */
.lmsg-entity-meta {
    position: absolute;
    left: 100%;             /* ğŸ’¡ ç‰©ç†é”å®šï¼šä»æ°”æ³¡ç»“æŸçš„åœ°æ–¹å¼€å§‹ */
    margin-left: 8px;       /* ğŸ’¡ è¿™é‡Œçš„ 8px å†³å®šäº†ç¦»æ°”æ³¡æœ‰å¤šè¿‘ï¼Œä½ å¯ä»¥æŒ‰éœ€è°ƒå° */
    bottom: 2px;
    display: flex;
    flex-direction: column; /* ğŸ’¡ çŠ¶æ€åœ¨ä¸Šï¼Œæ—¶é—´åœ¨ä¸‹ */
    align-items: flex-start;/* ğŸ’¡ é å·¦å¯¹é½æ°”æ³¡è¾¹ç¼˜ */
    gap: 1px;
    pointer-events: none;
}

/* ç»Ÿä¸€æ ·å¼æƒé‡ (ç¡®ä¿åˆ·æ–°åä¸æ¶ˆå¤±) */
.lmsg-meta-status { 
    font-size: 8px; 
    color: #8E8E93; 
    font-weight: 800; 
    text-transform: uppercase; 
    display: block; 
}
.lmsg-meta-time { 
    font-size: 8px; 
    font-family: 'Montserrat', sans-serif; 
    color: #BCBCC2; 
    text-transform: uppercase; 
    white-space: nowrap; 
    display: block; 
}
/* ğŸš¨ è¯¦æƒ…é¡µçª—å£ï¼šç‰©ç†çº¯ç™½åº•è‰²ï¼Œç»å¯¹ä¸é€æ˜ */
#lmsg-chat-window {
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: #FFFFFF !important; /* æ ¸å¿ƒï¼šé˜²æ­¢é‡å  */
    z-index: 9000 !important;
    display: none; /* åˆå§‹ç”± active æ§åˆ¶ */
    flex-direction: column;
}

/* å½“ active æ—¶æ‰æ˜¾ç¤ºï¼Œä¸”è¦†ç›–çŠ¶æ€æ  */
#lmsg-chat-window.active {
    display: flex !important;
    transform: translateX(0);
}

/* èƒŒæ™¯å±‚ï¼šåªæœ‰åœ¨ JS æ’å…¥å†…å®¹æ—¶æ‰ä¼šç›–åœ¨ç™½åº•ä¸Š */
.lmsg-custom-bg-global {
    position: absolute;
    inset: 0;
    width: 100%; height: 100%;
    z-index: 0; 
    pointer-events: none;
    display: block !important;
}

/* æ¶ˆæ¯æµåŒºåŸŸï¼šå¿…é¡»é€æ˜ï¼Œå¦åˆ™çœ‹ä¸åˆ°åº•ä¸‹çš„èƒŒæ™¯å›¾ */
#lmsg-chat-flow {
    background: transparent !important;
    position: relative;
    z-index: 5;
    flex: 1;
}

/* ğŸš¨ è¯¦æƒ…é¡µçª—å£ï¼šç‰©ç†çº¯ç™½åº•è‰²ï¼Œç»å¯¹ä¸é€æ˜ï¼Œé˜²æ­¢çœ‹ç©¿ä¸»é¡µ */
#lmsg-chat-window {
    position: fixed !important;
    top: 0; left: 100%; /* åˆå§‹è—åœ¨å³è¾¹ */
    width: 100vw; height: 100vh;
    background-color: #FFFFFF !important; 
    z-index: 12000 !important;
    display: flex !important; /* ğŸš¨ æ ¸å¿ƒï¼šåˆ«ç”¨ noneï¼Œç”¨ transform ä½ç§»ï¼Œè¿™æ ·æ°¸è¿œèƒ½æ‰“å¼€ */
    flex-direction: column;
    transition: transform 0.4s cubic-bezier(0.32, 1, 0.23, 1);
}

/* æ¿€æ´»æ€ï¼šæ»‘å…¥å±å¹• */
#lmsg-chat-window.active {
    transform: translateX(-100%);
}

/* èƒŒæ™¯å®¹å™¨å±‚çº§ç½®åº• */
.lmsg-custom-bg-global {
    position: absolute;
    inset: 0;
    width: 100%; height: 100%;
    z-index: 0; 
    pointer-events: none;
}

/* æ¶ˆæ¯åŒºé€æ˜ï¼Œé€å‡ºèƒŒæ™¯ */
#lmsg-chat-flow {
    background: transparent !important;
    position: relative;
    z-index: 5;
    flex: 1;
}

/* --- ğŸš€ æ¶ˆæ¯åˆ—è¡¨ç©ºçŠ¶æ€ç¾åŒ– --- */
.lmsg-empty-hint {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding-top: 120px; /* ç¨å¾®é ä¸Šä¸€ç‚¹ï¼Œè§†è§‰é‡å¿ƒæ›´ç¨³ */
    
    /* æ–‡å­—æ ·å¼ï¼šMontserrat å­—ä½“ + é«˜çº§å†·ç° */
    font-family: 'Montserrat', sans-serif;
    font-size: 11px;
    font-weight: 700;
    color: #BCBCC2;
    
    /* å•†ä¸šæ’ç‰ˆç²¾é«“ï¼šå¤§å†™ + å®½é—´è· */
    text-transform: uppercase;
    letter-spacing: 2.5px;
    opacity: 0.6;
    
    /* å¢åŠ ä¸€ä¸ªæå…¶æ·¡çš„è¿›åœºåŠ¨ç”» */
    animation: lmsgHintFade 0.8s ease-out;
}

/* å¦‚æœæƒ³æ›´æœ‰ç»†èŠ‚ï¼Œå¯ä»¥åŠ ä¸€ä¸ªå¾®å°çš„è£…é¥°çº¿ */
.lmsg-empty-hint::after {
    content: '';
    display: block;
    width: 20px;
    height: 1px;
    background: #E5E5EA;
    margin-top: 15px;
}

@keyframes lmsgHintFade {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 0.6; transform: translateY(0); }
}
/* --- ğŸš€ PROFILES APP - COMMERCIAL GRADE UI --- */
#page-profilesApp {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: #FFFFFF;
    z-index: 10000;
    display: none; 
    flex-direction: column;
    font-family: 'Montserrat', sans-serif;
    color: #000;
}

/* é¡¶éƒ¨çŠ¶æ€ä¸æ ‡é¢˜ */
.prof-header {
    padding: 60px 25px 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}
.prof-app-title {
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -1px;
    text-transform: uppercase;
}
/* --- ğŸš€ ç»è¿‡ç¾åŒ–çš„å…³é—­æŒ‰é’® (Profiles ä¸“å±) --- */
.prof-edit-btn {
    background: none;
    border: 1px solid #000; /* æç®€é»‘è¾¹æ¡† */
    padding: 6px 16px;
    border-radius: 30px;    /* èƒ¶å›Šå½¢çŠ¶ */
    font-family: 'Montserrat', sans-serif;
    font-size: 10px;
    font-weight: 800;
    color: #000;
    text-transform: uppercase;
    letter-spacing: 1.5px;   /* æ‹‰å¼€å­—é—´è·æ›´æœ‰ç”»æŠ¥æ„Ÿ */
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    outline: none;
    -webkit-tap-highlight-color: transparent;
}

/* ç‚¹å‡»æ—¶çš„é»‘åŒ–åè‰²æ•ˆæœ */
.prof-edit-btn:active {
    background: #000;
    color: #FFF;
    transform: scale(0.9); /* ç‰©ç†ç¼©å°çš„ä¸‹å‹æ„Ÿ */
}

/* ğŸš€ æ ¸å¿ƒï¼šå¤´åƒç¯æ»‘åŠ¨åˆ‡æ¢åŒº */
.prof-avatar-slider {
    width: 100%;
    overflow-x: auto;
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 10px 25px 25px;
    scrollbar-width: none;
}
.prof-avatar-slider::-webkit-scrollbar { display: none; }

.prof-avatar-item {
    flex-shrink: 0;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1);
    border: 1px solid transparent;
}
.prof-avatar-item img {
    width: 100%; height: 100%;
    border-radius: 50%;
    object-fit: cover;
    padding: 3px;
    background: #FFF;
}
/* æ¿€æ´»çŠ¶æ€ï¼šé»‘ç¯ + æ”¾å¤§ */
.prof-avatar-item.active {
    transform: scale(1.15);
    border-color: #000;
}

/* å®ä½“å±•ç¤ºå¡ç‰‡ */
.prof-viewer {
    flex: 1;
    overflow-y: auto;
    padding: 0 25px 120px;
}
.prof-card {
    border-top: 1px solid #000;
    padding-top: 30px;
    animation: profFadeUp 0.6s cubic-bezier(0.2, 1, 0.3, 1);
}
.prof-entity-name {
    font-size: 42px;
    font-weight: 900;
    line-height: 0.9;
    margin-bottom: 10px;
    letter-spacing: -2px;
}
.prof-entity-tag {
    display: inline-block;
    padding: 4px 12px;
    background: #000;
    color: #FFF;
    font-size: 10px;
    font-weight: 700;
    margin-bottom: 25px;
}
.prof-entity-desc {
    font-size: 15px;
    line-height: 1.6;
    color: #333;
    margin-bottom: 30px;
    white-space: pre-wrap;
}

/* å‚æ•°ç½‘æ ¼ */
.prof-attr-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}
.prof-attr-item {
    border-bottom: 0.5px solid #EEE;
    padding-bottom: 8px;
}
.prof-attr-label { font-size: 9px; color: #8E8E93; font-weight: 700; text-transform: uppercase; }
.prof-attr-value { font-size: 13px; font-weight: 600; margin-top: 2px; }

/* ğŸš€ åº•éƒ¨å¯¼èˆªæ  */
.prof-bottom-nav {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    height: 84px;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(20px);
    border-top: 0.5px solid rgba(0,0,0,0.05);
    display: flex;
    justify-content: center;
    gap: 60px;
    padding-bottom: env(safe-area-inset-bottom);
}
.prof-nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: none; border: none;
    cursor: pointer;
    transition: 0.3s;
}
.prof-nav-label {
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 1px;
    color: #BCBCC2;
}
.prof-nav-btn.active .prof-nav-label {
    color: #000;
}
.prof-nav-btn.active::after {
    content: '';
    width: 4px; height: 4px;
    background: #000;
    border-radius: 50%;
    margin-top: 6px;
}

@keyframes profFadeUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸš€ PROFILES ä¸“å±æ‚¬æµ®æ·»åŠ æŒ‰é’® --- */
.prof-fab-btn {
    position: absolute;
    right: 25px;
    bottom: 110px; /* 84px(å¯¼èˆªæ ) + 26px(å‘¼å¸é—´è·) */
    width: 56px;
    height: 56px;
    background: #000;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 101;
    transition: all 0.3s cubic-bezier(0.2, 1, 0.3, 1);
    border: none;
    outline: none;
}

/* æŒ‰é’®å†…éƒ¨çš„åŠ å· */
.prof-fab-btn::before,
.prof-fab-btn::after {
    content: '';
    position: absolute;
    background: #FFF;
    border-radius: 2px;
}
/* æ¨ªçº¿ */
.prof-fab-btn::before { width: 18px; height: 2px; }
/* ç«–çº¿ */
.prof-fab-btn::after { width: 2px; height: 18px; }

/* äº¤äº’åé¦ˆï¼šç‚¹å‡»ä¸‹å‹å¹¶è½»å¾®å‘å…‰ */
.prof-fab-btn:active {
    transform: scale(0.85) translateY(2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    background: #333; /* ç‚¹å‡»æ—¶ç¨å¾®å˜æµ…ä¸€ç‚¹ç‚¹ */
}
/* --- ğŸš€ NPC åˆ›å»ºé¡µé¢ - å…¨å±ç”»æŠ¥é£ --- */
#prof-create-page {
    position: fixed;
    top: 0; left: 100%; /* åˆå§‹åœ¨å³ä¾§éšè— */
    width: 100vw; height: 100vh;
    background: #FFFFFF;
    z-index: 10005;
    display: flex;
    flex-direction: column;
    transition: left 0.5s cubic-bezier(0.32, 1, 0.23, 1);
    font-family: 'Montserrat', sans-serif;
}
#prof-create-page.active { left: 0; }

/* é¡¶éƒ¨å¯¼èˆª */
.prof-create-header {
    padding: 60px 25px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
}
.prof-create-back { background: none; border: none; font-size: 20px; cursor: pointer; }
.prof-create-title { font-size: 14px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
.prof-create-save { background: #000; color: #FFF; border: none; padding: 6px 18px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; }

/* å†…éƒ¨ Tab åˆ‡æ¢ */
.prof-create-tabs {
    display: flex;
    padding: 20px 25px;
    gap: 30px;
    border-bottom: 0.5px solid rgba(0,0,0,0.03);
}
.prof-tab-item {
    font-size: 12px;
    font-weight: 700;
    color: #BCBCC2;
    cursor: pointer;
    position: relative;
    text-transform: uppercase;
}
.prof-tab-item.active { color: #000; }
.prof-tab-item.active::after {
    content: ''; position: absolute; bottom: -8px; left: 0; width: 100%; height: 2px; background: #000;
}

/* è¡¨å•æ»šåŠ¨åŒº */
.prof-create-body {
    flex: 1;
    overflow-y: auto;
    padding: 25px;
}
.prof-form-section { display: none; animation: profFadeIn 0.4s ease; }
.prof-form-section.active { display: block; }

/* è¾“å…¥æ¡†æ ·å¼ */
.prof-input-group { margin-bottom: 25px; }
.prof-label { font-size: 9px; font-weight: 800; color: #8E8E93; text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 1px; }
.prof-input {
    width: 100%; border: none; border-bottom: 1px solid #EEE;
    padding: 10px 0; font-size: 15px; font-weight: 500; outline: none;
    transition: border-color 0.3s;
}
.prof-input:focus { border-color: #000; }
.prof-textarea {
    width: 100%; height: 80px; border: 1px solid #EEE; padding: 12px;
    font-size: 14px; outline: none; resize: none; margin-top: 5px;
}

/* AI ç”Ÿæˆä¸“ç”¨ç»„ä»¶ */
.prof-ai-box {
    background: #F9F9F9;
    padding: 20px;
    border-radius: 2px;
    margin-bottom: 25px;
}
.prof-regen-btn {
    width: 100%; padding: 12px; background: transparent; border: 1px dashed #CCC;
    font-size: 11px; font-weight: 700; cursor: pointer; margin-top: 15px;
}

/* å¤´åƒç”Ÿæˆè¯é¢„è§ˆåŒº */
.prof-prompt-preview {
    font-size: 11px; color: #8E8E93; font-style: italic; line-height: 1.5;
    background: #F0F0F0; padding: 10px; border-left: 3px solid #000; margin-top: 10px;
}

@keyframes profFadeIn { from { opacity: 0; } to { opacity: 1; } }
/* --- ğŸš€ çœŸæ­£çš„å•†ç”¨çº§æ¨¡æ‹Ÿä¸‹æ‹‰æ¡† (Profiles ä¸“å±) --- */
.prof-custom-select {
    position: relative;
    width: 100%;
    border-bottom: 0.5px solid #000;
    cursor: pointer;
    font-family: 'Montserrat', sans-serif;
}

/* é€‰ä¸­çš„æ–‡å­—æ˜¾ç¤ºåŒº */
.prof-select-trigger {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    font-size: 15px;
    font-weight: 500;
}

/* æç®€ç®­å¤´ */
.prof-select-trigger::after {
    content: '';
    width: 0; height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid #000;
    transition: transform 0.3s;
}
.prof-custom-select.active .prof-select-trigger::after {
    transform: rotate(180deg); /* å±•å¼€æ—¶ç®­å¤´åè½¬ */
}

/* ğŸš€ ä¸‹æ‹‰é€‰é¡¹åˆ—è¡¨ (è¿™æ‰æ˜¯å…³é”®ï¼Œç°åœ¨å®ƒå®Œå…¨åœ¨é¡µé¢é‡Œï¼Œä¸æ˜¯æµè§ˆå™¨çš„äº†) */
.prof-select-options {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: #FFF;
    border: 1px solid #EEE;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none; /* åˆå§‹éšè— */
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}
.prof-custom-select.active .prof-select-options {
    display: block;
}

/* å•ä¸ªé€‰é¡¹æ ·å¼ */
.prof-option-item {
    padding: 12px 15px;
    font-size: 13px;
    color: #333;
    transition: background 0.2s;
}
.prof-option-item:hover {
    background: #F9F9F9;
}
.prof-option-item.selected {
    font-weight: 800;
    background: #F0F0F0;
}
/* --- ğŸš€ NPC ç”Ÿæˆè¿›åº¦åŠ¨ç”» (Profiles ä¸“å±) --- */
.prof-loading-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜ç™½ï¼Œç›–ä½è¾“å…¥æ¡† */
    z-index: 10;
    display: none; /* åˆå§‹éšè— */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    animation: profFadeIn 0.3s ease;
}

.prof-progress-container {
    width: 60%;
    text-align: center;
}

/* æ•°å­—ç™¾åˆ†æ¯” */
.prof-percent-text {
    font-size: 48px;
    font-weight: 900;
    letter-spacing: -2px;
    margin-bottom: 10px;
    font-family: 'Montserrat', sans-serif;
}

/* æç»†è¿›åº¦æ¡è½¨é“ */
.prof-progress-bar-bg {
    width: 100%;
    height: 1px;
    background: #EEE;
    position: relative;
    overflow: hidden;
}

/* é»‘è‰²è¿›åº¦æ¡å¡«å…… */
.prof-progress-fill {
    position: absolute;
    top: 0; left: 0;
    height: 100%;
    width: 0%; /* ç”± JS æ§åˆ¶ */
    background: #000;
    transition: width 0.4s cubic-bezier(0.1, 0.5, 0.5, 1);
}

.prof-loading-hint {
    margin-top: 15px;
    font-size: 9px;
    font-weight: 800;
    letter-spacing: 2px;
    color: #BCBCC2;
    text-transform: uppercase;
}
/* --- ğŸš€ PROMPT å¤åˆ¶å¡ç‰‡ç¾åŒ– --- */
.prof-prompt-container {
    background: #F2F2F7; /* ææ·¡çš„ç“·ç°è‰² */
    padding: 20px;
    border-radius: 2px;
    position: relative;
    margin-top: 15px;
    border-left: 2px solid #000;
}

.prof-prompt-text {
    font-size: 12px;
    color: #444;
    line-height: 1.6;
    font-style: italic;
    word-break: break-all;
    padding-right: 40px; /* ä¸ºæŒ‰é’®ç•™ä½ */
}

/* ä¸€é”®å¤åˆ¶æŒ‰é’® */
.prof-copy-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #000;
    color: #FFF;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s cubic-bezier(0.2, 1, 0.3, 1);
}

.prof-copy-btn:active {
    transform: scale(0.8);
    background: #34C759; /* å¤åˆ¶æˆåŠŸç¬æ—¶å˜ç»¿ */
}

.prof-copy-hint {
    font-size: 9px;
    color: #BCBCC2;
    margin-top: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* --- ğŸš€ å¤åˆ¶æŒ‰é’®æˆåŠŸæ€ --- */
.prof-copy-btn.success {
    background: #34C759 !important; /* iOS æ ‡å‡†æˆåŠŸç»¿ */
    transform: scale(1.1); /* æˆåŠŸæ—¶è½»å¾®æ”¾å¤§ */
}

/* æˆåŠŸæ—¶å°†åŸæœ¬çš„ SVG æ¢æˆå‹¾é€‰æ ·å¼ï¼ˆå¯é€‰ï¼Œæˆ–è€…ç›´æ¥å˜è‰²ä¹Ÿå¤Ÿé«˜çº§ï¼‰ */
.prof-copy-btn.success svg {
    stroke: #FFF;
    animation: profCheckScale 0.3s ease-out;
}

@keyframes profCheckScale {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
/* é«˜çº§ NPC å¡ç‰‡æ ·å¼ */
.prof-linked-section {
    margin-top: 25px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 15px;
}

.prof-section-title {
    font-size: 10px;
    letter-spacing: 2px;
    color: #888;
    margin-bottom: 15px;
}

.prof-npc-mini-card {
    display: flex;
    background: #FFF;
    border: 1px solid #EEE;
    border-radius: 4px; /* åæ–¹æ­£ä¸€ç‚¹æ›´é«˜çº§ */
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    transition: transform 0.3s;
}

.npc-card-side {
    width: 60px;
    background: #000;
}

.npc-card-side img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: grayscale(1); /* å¼ºåˆ¶é»‘ç™½å¤´åƒå¢åŠ è‰ºæœ¯æ„Ÿ */
}

.npc-card-main {
    flex: 1;
    padding: 12px;
}

.npc-card-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
}

.npc-card-name {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 14px;
    color: #000;
}

.npc-card-id {
    font-size: 9px;
    color: #CCC;
}

.npc-card-rel {
    font-size: 10px;
    color: #555;
    background: #F5F5F5;
    display: inline-block;
    padding: 2px 6px;
    margin-bottom: 8px;
}

.npc-card-bio {
    font-size: 12px;
    line-height: 1.4;
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
}

.npc-card-user-rel {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #999;
}

.prof-no-links {
    text-align: center;
    font-size: 11px;
    color: #CCC;
    padding: 20px;
    border: 1px dashed #EEE;
}
/* NPC è¯¦æƒ…å¼¹çª—åŸºç¡€ */
.prof-npc-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100000;
    display: none; /* åˆå§‹éšè— */
    justify-content: center; align-items: flex-end; /* ä»åº•éƒ¨å¼¹å‡ºçš„æ—¢è§†æ„Ÿ */
}

.npc-modal-glass {
    position: absolute;
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
}

.npc-modal-content {
    position: relative;
    width: 100%; height: 92%;
    background: #FFF;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
    display: flex; flex-direction: column;
    animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.npc-modal-header {
    padding: 20px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #EEE;
}

.npc-modal-title { font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 3px; font-weight: 900; }

.npc-close-btn, .npc-edit-toggle {
    background: none; border: none; font-size: 14px; font-weight: 600; cursor: pointer;
}

/* å†…å®¹åŒºåŸŸ */
.npc-modal-body { flex: 1; overflow-y: auto; padding: 30px 20px; }

.npc-detail-avatar {
    width: 100px; height: 100px; background: #000; margin: 0 auto 20px;
    border-radius: 4px; overflow: hidden; border: 4px solid #FFF; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.npc-detail-avatar img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(1); }

.npc-info-group { margin-bottom: 25px; }
.npc-info-label { font-size: 10px; color: #AAA; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
.npc-info-value { font-size: 15px; color: #000; line-height: 1.6; }

/* ç¼–è¾‘æ¨¡å¼è¾“å…¥æ¡† */
.npc-edit-input { 
    width: 100%; background: #F9F9F9; border: 1px solid #EEE; padding: 10px; 
    font-size: 14px; font-family: inherit; margin-bottom: 10px;
}
.npc-edit-textarea { width: 100%; height: 120px; background: #F9F9F9; border: 1px solid #EEE; padding: 10px; font-size: 14px; }

/* åº•éƒ¨æŒ‰é’® */
.npc-modal-footer { padding: 20px; display: flex; gap: 10px; border-top: 1px solid #EEE; }
.npc-delete-btn { flex: 1; background: none; border: 1px solid #FF3B30; color: #FF3B30; padding: 15px; border-radius: 8px; font-size: 12px; font-weight: 600; letter-spacing: 1px; }
.npc-save-btn { flex: 2; background: #000; border: none; color: #FFF; padding: 15px; border-radius: 8px; font-size: 12px; font-weight: 600; letter-spacing: 1px; }

/* è‡ªå®šä¹‰ç¡®è®¤æ¡† */
.prof-confirm-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100000; background: rgba(0,0,0,0.4);
    display: none; justify-content: center; align-items: center;
}
.prof-confirm-box {
    background: #FFF; width: 80%; padding: 25px; border-radius: 12px; text-align: center;
}
.confirm-title { font-weight: 800; margin-bottom: 10px; font-size: 16px; }
.confirm-btns { display: flex; gap: 10px; margin-top: 20px; }
.confirm-cancel { flex: 1; padding: 12px; border: 1px solid #EEE; background: none; border-radius: 6px; }
.confirm-ok { flex: 1; padding: 12px; background: #FF3B30; color: #FFF; border: none; border-radius: 6px; }

/* é’±åŒ…å…¨å±€ä¸»é¢˜ - è‰ºæœ¯æ„Ÿé»‘ç™½ */
.wallet-premium-theme {
    background: #FFFFFF !important;
    /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ é«˜åº¦ï¼Œå»ºè®® 60px - 65px ä¹‹é—´ --- */
    padding-top: 60px !important; 
    overflow: hidden;
    z-index: 5000;
    /* ç¡®ä¿å†…è¾¹è·ä¸ä¼šå¢åŠ å®¹å™¨çš„æ€»é«˜åº¦ */
    box-sizing: border-box; 
}

.wallet-main-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: #121212;
}

/* å¤´éƒ¨è®¾è®¡ */
.wallet-art-header {
    height: 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 25px;
    border-bottom: 0.5px solid #eee;
    background: #ffffff !important;
}

/* å“ç‰Œæ ‡é¢˜ä¸å†å±…ä¸­ï¼Œè‡ªç„¶é å·¦ */
.brand-title {
    font-family: 'Cinzel', serif;
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 2px;
    margin: 0;
    color: #000000 !important;
}

.wallet-close-btn {
    background: none; border: none; padding: 5px; cursor: pointer;
}

/* è‰ºæœ¯ç”»å¸ƒåŒº */
.wallet-canvas {
    flex: 1;
    position: relative;
    overflow-y: auto;
}

.wallet-section {
    display: none;
    padding: 30px 20px;
    animation: contentFadeIn 0.6s cubic-bezier(0.23, 1, 0.32, 1);
}

.wallet-section.active { display: block; }

@keyframes contentFadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

/* åˆ›æ„å¡ç‰‡è®¾è®¡ */
.section-label {
    font-size: 0.65rem;
    letter-spacing: 2px;
    color: #999;
    margin-bottom: 20px;
}

.luxury-card-container {
    perspective: 1000px;
    margin-bottom: 40px;
}

.luxury-card {
    width: 100%;
    height: 200px;
    background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
    border-radius: 16px;
    position: relative;
    padding: 25px;
    color: #fff;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    overflow: hidden;
}

/* å¡ç‰‡ä¸Šçš„è£…é¥°çº¹ç† */
.card-glass-layer {
    position: absolute;
    top: -50%; right: -20%;
    width: 150%; height: 150%;
    background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
    transform: rotate(-20deg);
}

.card-type { font-size: 0.6rem; letter-spacing: 1px; opacity: 0.5; }
.card-number { font-size: 1.4rem; margin-top: 60px; font-family: 'Courier New', monospace; letter-spacing: 2px; }
.card-footer { display: flex; justify-content: space-between; margin-top: 30px; font-size: 0.7rem; opacity: 0.8; }

/* ä½™é¢æ˜¾ç¤º */
.balance-display { text-align: center; margin-top: 20px; }
.currency-label { font-size: 0.7rem; color: #999; letter-spacing: 1px; }
.amount-val { font-size: 3rem; font-weight: 300; margin-top: 10px; font-family: 'Montserrat', sans-serif; }
.amount-val small { font-size: 1rem; margin-left: 5px; }

/* ç­‰å¾…é¡µå ä½ */
.waiting-canvas {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.art-placeholder h3 { font-family: 'Cinzel', serif; font-size: 1.2rem; margin-bottom: 10px; }
.art-placeholder p { font-size: 0.85rem; color: #888; }
.wait-tag { display: inline-block; margin-top: 25px; font-size: 0.6rem; border: 0.5px solid #ddd; padding: 4px 12px; border-radius: 50px; color: #aaa; text-transform: uppercase; }

/* åº•éƒ¨å¯¼èˆªæ  - é«˜çº§äº¤äº’ */
.wallet-bottom-nav {
    height: 85px;
    background: #fff;
    border-top: 0.5px solid #f0f0f0;
    display: flex;
    justify-content: space-around;
    padding-bottom: 20px;
    position: relative;
}

.nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    z-index: 2;
    transition: all 0.3s;
}

.nav-icon svg { width: 22px; height: 22px; stroke-width: 1.2; color: #bbb; transition: all 0.3s; }
.nav-text { font-size: 0.6rem; font-weight: 600; margin-top: 6px; color: #bbb; letter-spacing: 0.5px; }

.nav-btn.active .nav-icon svg { color: #000; transform: translateY(-2px); }
.nav-btn.active .nav-text { color: #000; }

/* å¯¼èˆªæŒ‡ç¤ºå™¨ï¼šä¸€ä¸ªå°é»‘ç‚¹ï¼Œä¼˜é›…æ»‘åŠ¨ */
.nav-indicator {
    position: absolute;
    top: 0;
    width: 20px;
    height: 2px;
    background: #000;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transform: translateX(calc(var(--active-index) * 20vw + 10vw - 10px));
}

/* --- CARD é¡µé¢ä¸“å±ç¾åŒ– --- */

/* 1. ä½™é¢åŒºï¼šéå¯¹ç§°è‰ºæœ¯æ„Ÿ */
.vogue-balance-container {
    padding: 20px 0 40px;
    border-bottom: 0.5px solid #f0f0f0;
    margin-bottom: 30px;
}

.balance-meta .cinzel-font {
    font-size: 0.65rem;
    letter-spacing: 3px;
    color: #888;
    display: block;
    margin-bottom: 10px;
}

.balance-main {
    display: flex;
    align-items: baseline;
}

.balance-main .unit {
    font-size: 1.2rem;
    font-weight: 300;
    margin-right: 8px;
}

.amount-number {
    font-size: 3.2rem;
    font-weight: 200;
    font-family: 'Montserrat', sans-serif;
    letter-spacing: -1px;
    margin: 0;
}

.trend-tag {
    font-size: 0.6rem;
    background: #f5f5f5;
    padding: 2px 8px;
    border-radius: 4px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* 2. åˆ›å»ºå¡ç‰‡æŒ‰é’®ï¼šè“å›¾è®¾è®¡ */
.section-subtitle {
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 2px;
    color: #1a1a1a;
    margin-bottom: 15px;
    display: block;
}

.create-card-blueprint {
    width: 100%;
    height: 180px;
    border: 1px dashed #d1d1d1;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: pointer;
    transition: all 0.4s ease;
    background: transparent;
}

.create-card-blueprint:hover {
    border-color: #000;
    background: #fafafa;
}

.blueprint-inner {
    text-align: center;
}

.plus-icon svg {
    width: 32px;
    height: 32px;
    color: #999;
    margin-bottom: 12px;
    stroke-width: 0.8;
}

.blueprint-text {
    font-size: 0.75rem;
    letter-spacing: 1px;
    color: #888;
    font-weight: 500;
}

.blueprint-deco {
    position: absolute;
    bottom: 15px;
    right: 20px;
    font-family: monospace;
    font-size: 0.55rem;
    color: #ccc;
}

/* 3. äº¤æ˜“å†å²åˆ—è¡¨ */
.history-gallery {
    margin-top: 40px;
}

.history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.view-all {
    font-size: 0.65rem;
    color: #999;
    text-decoration: underline;
    cursor: pointer;
}

/* è§£å†³æ»‘åŠ¨é—®é¢˜çš„æ ¸å¿ƒ */
.history-scroll-list {
    max-height: 350px; /* è®¾ç½®ä¸€ä¸ªåˆé€‚çš„é«˜åº¦ */
    overflow-y: auto;
    padding-right: 5px;
    /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ (å¯é€‰) */
    -webkit-overflow-scrolling: touch;
}

.history-scroll-list::-webkit-scrollbar {
    width: 2px;
}
.history-scroll-list::-webkit-scrollbar-thumb {
    background: #eee;
}

.history-entry {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 0.5px solid #f9f9f9;
    animation: entryFade 0.5s ease backwards;
}

.entry-date {
    font-size: 0.6rem;
    font-family: monospace;
    color: #bbb;
    width: 50px;
}

.entry-info {
    flex: 1;
}

.entry-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: #1a1a1a;
    margin-bottom: 2px;
}

.entry-category {
    font-size: 0.65rem;
    color: #aaa;
}

.entry-amount {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
}

.entry-amount.outflow { color: #000; }
.entry-amount.inflow { color: #007AFF; } /* å”¯ä¸€çš„å½©è‰²ç‚¹ï¼Œä»£è¡¨å¢åŠ  */

@keyframes entryFade {
    from { opacity: 0; transform: translateX(5px); }
    to { opacity: 1; transform: translateX(0); }
}

/* é€è¡Œå»¶è¿ŸåŠ¨ç”» */
.history-entry:nth-child(1) { animation-delay: 0.1s; }
.history-entry:nth-child(2) { animation-delay: 0.15s; }
.history-entry:nth-child(3) { animation-delay: 0.2s; }
.history-entry:nth-child(4) { animation-delay: 0.25s; }
.history-entry:nth-child(5) { animation-delay: 0.3s; }
.filter-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border: 0.5px solid #e0e0e0; /* æç»†è¾¹æ¡† */
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-btn span {
    font-size: 0.65rem;
    letter-spacing: 1px;
    font-weight: 500;
    color: #666;
}

.filter-btn svg {
    color: #999;
}

.filter-btn:hover {
    background: #f9f9f9;
    border-color: #000;
}
.empty-history-state {
    padding: 60px 0;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.empty-icon-deco {
    width: 30px;
    height: 1px;
    background: #eee;
    margin-bottom: 20px;
}

.empty-history-state p {
    font-family: 'Cinzel', serif;
    font-size: 0.7rem;
    letter-spacing: 3px;
    color: #ccc;
    margin-bottom: 8px;
}

.empty-history-state span {
    font-size: 0.6rem;
    color: #ddd;
    letter-spacing: 1px;
}

/* ç¼–è¾‘å™¨å›¾å±‚ */
.card-editor-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 6000;
    display: flex; flex-direction: column;
}

.editor-content { flex: 1; overflow-y: auto; padding: 20px; }

/* é¢„è§ˆåŒºå›ºå®šåœ¨é¡¶éƒ¨ */
.preview-area {
    padding: 20px 0;
    perspective: 1000px;
}

/* é…ç½®ç»„ */
.config-group { margin-bottom: 35px; }
.config-group input {
    width: 100%; border: none; border-bottom: 0.5px solid #eee;
    padding: 12px 0; font-size: 0.9rem; font-family: 'Montserrat';
    margin-bottom: 10px; outline: none;
}

/* æ’ç‰ˆé€‰æ‹©å™¨ */
.layout-selector { display: flex; gap: 10px; }
.layout-opt {
    flex: 1; padding: 10px; border: 0.5px solid #eee; text-align: center;
    font-size: 0.7rem; letter-spacing: 1px; cursor: pointer;
}
.layout-opt.active { background: #000; color: #fff; border-color: #000; }

/* èƒŒæ™¯é€‰æ‹©å™¨ */
.bg-selector { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
.bg-opt { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #eee; cursor: pointer; flex-shrink: 0; }

/* è‰²ç›¸ç¯ */
.color-wheel-container {
    position: relative; width: 180px; height: 180px; margin: 20px auto;
}
#colorWheel { cursor: crosshair; }
#colorCursor {
    position: absolute; width: 12px; height: 12px; border: 2px solid white;
    border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%);
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
}

/* è§’è‰²é€‰æ‹©åˆ—è¡¨ */
.char-scroll-x { display: flex; gap: 15px; overflow-x: auto; padding: 15px 0; }
.char-item {
    flex-shrink: 0; width: 60px; text-align: center; cursor: pointer; opacity: 0.5; transition: 0.3s;
}
.char-item.active { opacity: 1; transform: scale(1.1); }
.char-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #000; }
.char-item span { font-size: 0.6rem; display: block; margin-top: 5px; }

/* ä¿å­˜æŒ‰é’® */
.save-card-btn {
    width: 100%; padding: 18px; background: #000; color: #fff; border: none;
    font-family: 'Cinzel'; letter-spacing: 2px; border-radius: 4px; margin: 40px 0;
}

/* ä¸åŒæ’ç‰ˆçš„é¢„è§ˆé€»è¾‘ */
.layout-1 .preview-number { font-size: 1.4rem; margin-top: 60px; }
.layout-2 .preview-number { font-size: 1.2rem; text-align: right; margin-top: 80px; }
.layout-3 .preview-name { position: absolute; bottom: 25px; left: 25px; }
.card-editor-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #fff;
    z-index: 6000;
    display: none; /* åˆå§‹éšè— */
    flex-direction: column;
    /* å¢åŠ æ»‘å…¥åŠ¨ç”» */
    animation: slideUp 0.4s cubic-bezier(0.32, 0.72, 0, 1);
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* --- ç²¾å‡†ä¿®å¤å¼€å…³æŒ‰é’®å¤ªå¤§çš„é—®é¢˜ --- */

.lune-switch {
    position: relative;
    display: inline-block;
    width: 42px;    /* å›ºå®šå®½åº¦ï¼šå°å·§ç²¾è‡´ */
    height: 22px;   /* å›ºå®šé«˜åº¦ */
}

/* éšè—åŸç”Ÿ checkbox */
.lune-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

/* å¼€å…³è½¨é“ (æ»‘å—èƒŒæ™¯) */
.lune-switch .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #f0f0f0; /* å…³é—­æ—¶çš„æµ…ç°è‰² */
    transition: .4s;
    border-radius: 34px;
    border: 0.5px solid #eee; /* æç»†è¾¹æ¡†å¢åŠ è´¨æ„Ÿ */
}

/* åœ†å½¢æŒ‰é’®æœ¬èº« */
.lune-switch .slider:before {
    position: absolute;
    content: "";
    height: 18px;   /* æŒ‰é’®æ¯”è½¨é“å°ä¸€ç‚¹ï¼Œç•™å‡ºè¾¹è· */
    width: 18px;
    left: 2px;
    bottom: 1.5px;
    background-color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* å¢åŠ ä¸€ç‚¹æ‚¬æµ®æ„Ÿ */
    transition: .4s;
    border-radius: 50%;
}

/* å¼€å¯çŠ¶æ€çš„é¢œè‰²ï¼šçº¯é»‘ï¼Œç¬¦åˆæˆ‘ä»¬çš„é»‘ç™½é«˜çº§æ„Ÿ */
.lune-switch input:checked + .slider {
    background-color: #000;
    border-color: #000;
}

/* å¼€å¯çŠ¶æ€æ—¶æŒ‰é’®çš„ä½ç§» */
.lune-switch input:checked + .slider:before {
    transform: translateX(20px); /* 42mm - 18mm - è¾¹è· */
}

/* è°ƒæ•´æ•´è¡Œå¸ƒå±€ï¼Œè®©æ–‡å­—å’Œå¼€å…³å¯¹é½ */
.toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.toggle-row .section-subtitle {
    margin-bottom: 0; /* æŠµæ¶ˆæ‰ä¹‹å‰è®¾ç½®çš„ä¸‹è¾¹è· */
}
/* ä»…é’ˆå¯¹åˆ›å»ºå¡ç‰‡ç¼–è¾‘å™¨çš„å¤´éƒ¨è¿›è¡Œå¼ºåˆ¶ä¸‹ç§» */
#card-editor-layer .wallet-art-header {
    /* å¢åŠ é¡¶éƒ¨å¤–è¾¹è·ï¼Œå¼ºåˆ¶é¿å¼€çŠ¶æ€æ  */
    /* å¦‚æœ 20px è¿˜æ˜¯é‡å ï¼Œå¯ä»¥æ”¹ä¸º 30px æˆ– 40px */
    margin-top: 25px !important; 
    
    /* ç¡®ä¿èƒŒæ™¯å»¶ä¼¸åˆ°é¡¶éƒ¨ï¼Œä¸å‡ºç°æ–­å±‚ */
    border-top: 25px solid #fff; 
    
    /* é‡æ–°æ ¡å‡†é«˜åº¦ï¼Œé˜²æ­¢å†…å®¹è¢«å‹ç¼© */
    height: 85px !important; 
    align-items: flex-end !important; /* è®©æ ‡é¢˜å’ŒæŒ‰é’®é ä¸‹å¯¹é½ */
    padding-bottom: 10px !important;
}

/* è°ƒæ•´ç¼–è¾‘å™¨çš„å†…å®¹åŒºåŸŸï¼Œé˜²æ­¢è¢«ä¸‹ç§»çš„å¤´éƒ¨é®æŒ¡ */
#card-editor-layer .editor-content {
    padding-top: 10px !important;
}

.luxury-card {
    position: relative; /* ç¡®ä¿åˆ é™¤æŒ‰é’®èƒ½å®šä½ */
}

.delete-card-trigger {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 20px;
    height: 20px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(5px);
    color: inherit; /* è·Ÿéšå¡ç‰‡æ–‡å­—é¢œè‰² */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.3s;
}

.luxury-card:hover .delete-card-trigger {
    opacity: 0.6;
}

.delete-card-trigger:hover {
    opacity: 1 !important;
    background: rgba(255,0,0,0.2);
}
.lune-modal-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
    z-index: 7000; display: flex; align-items: center; justify-content: center;
}
.lune-modal-content {
    width: 80%; text-align: center; padding: 40px 20px;
    background: #fff; border: 0.5px solid #eee; box-shadow: 0 30px 60px rgba(0,0,0,0.1);
}
.modal-art-line { width: 40px; height: 1px; background: #000; margin: 0 auto 20px; }
.lune-modal-content h3 { font-family: 'Cinzel'; letter-spacing: 2px; margin-bottom: 15px; }
.lune-modal-content p { font-size: 0.75rem; color: #888; line-height: 1.6; margin-bottom: 30px; }
.modal-actions { display: flex; flex-direction: column; gap: 10px; }
.modal-actions button {
    padding: 15px; border: none; font-size: 0.7rem; letter-spacing: 1px; cursor: pointer;
}
.modal-btn-confirm { background: #000; color: #fff; }
.modal-btn-cancel { background: transparent; color: #aaa; border: 0.5px solid #eee; }
.balance-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.scope-switch-btn {
    display: flex; align-items: center; gap: 5px; cursor: pointer;
    border: 0.5px solid #ddd; padding: 4px 8px; border-radius: 4px;
}
.scope-switch-btn span { font-size: 0.6rem; color: #999; letter-spacing: 1px; }

.scope-dropdown {
    position: absolute; top: 60px; right: 20px; width: 180px;
    background: #fff; border: 0.5px solid #eee; z-index: 100;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}
.scope-item {
    padding: 12px 15px; font-size: 0.65rem; color: #666; cursor: pointer;
    border-bottom: 0.5px solid #f9f9f9;
}
.scope-item:hover { background: #f9f9f9; color: #000; }
.scope-item.active { color: #000; font-weight: bold; }
/* ç­›é€‰å¼¹çª—ä¸“ç”¨æ ·å¼ */
.filter-modal-box {
    width: 90% !important;
    max-height: 80vh;
    padding: 30px 25px !important;
    display: flex;
    flex-direction: column;
}

.modal-art-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-bottom: 0.5px solid #eee;
    padding-bottom: 15px;
}

.close-modal-icon {
    font-size: 24px;
    cursor: pointer;
    color: #ccc;
}

.filter-body {
    flex: 1;
    overflow-y: auto;
    text-align: left;
}

.filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 12px;
    margin-bottom: 25px;
}

.chip {
    padding: 8px 16px;
    border: 0.5px solid #eee;
    font-size: 0.65rem;
    letter-spacing: 1px;
    color: #999;
    cursor: pointer;
    transition: all 0.3s;
}

.chip.active {
    background: #000;
    color: #fff;
    border-color: #000;
}

.apply-filter-btn {
    width: 100%;
    padding: 18px;
    background: #000;
    color: #fff;
    border: none;
    font-family: 'Cinzel';
    letter-spacing: 2px;
    font-size: 0.75rem;
    margin-top: 20px;
    cursor: pointer;
}
/* å­å¯¼èˆª */
.send-sub-nav {
    display: flex;
    position: relative;
    background: #f9f9f9;
    padding: 4px;
    border-radius: 8px;
    margin-bottom: 30px;
}
.sub-nav-item {
    flex: 1; text-align: center; padding: 10px 0; font-size: 0.65rem;
    letter-spacing: 2px; color: #999; cursor: pointer; z-index: 2;
    transition: 0.3s;
}
.sub-nav-item.active { color: #000; font-weight: bold; }
.sub-nav-slider {
    position: absolute; top: 4px; left: 4px; width: calc(50% - 4px);
    height: calc(100% - 8px); background: #fff; border-radius: 6px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

/* æ‹¾å–å™¨æ ·å¼ */
.picker-scroll-x {
    display: flex; gap: 12px; overflow-x: auto; padding: 10px 0 20px;
    scrollbar-width: none;
}
.picker-scroll-x::-webkit-scrollbar { display: none; }

.card-mini-opt {
    flex-shrink: 0; width: 120px; height: 70px; border-radius: 8px;
    padding: 10px; position: relative; border: 1px solid transparent;
    cursor: pointer; opacity: 0.4; transition: 0.3s;
}
.card-mini-opt.active { opacity: 1; transform: scale(1.05); border-color: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.card-mini-opt .mini-name { font-size: 0.5rem; letter-spacing: 1px; }
.card-mini-opt .mini-num { font-size: 0.6rem; margin-top: 15px; font-family: monospace; }

.char-mini-opt {
    flex-shrink: 0; text-align: center; width: 60px; cursor: pointer; opacity: 0.4; transition: 0.3s;
}
.char-mini-opt.active { opacity: 1; transform: translateY(-5px); }
.char-mini-opt img { width: 45px; height: 45px; border-radius: 50%; border: 1px solid #000; object-fit: cover; }
.char-mini-opt span { font-size: 0.5rem; display: block; margin-top: 5px; color: #666; }

/* è¾“å…¥æ¡†ç¾åŒ– */
.premium-amount-input {
    display: flex; align-items: baseline; border-bottom: 0.5px solid #eee; padding: 10px 0;
}
.premium-amount-input .curr { font-size: 1.2rem; margin-right: 10px; font-weight: 300; }
.premium-amount-input input {
    border: none; outline: none; font-size: 2.4rem; width: 100%;
    font-family: 'Montserrat'; font-weight: 200; background: transparent;
}
.memo-input {
    width: 100%; border: none; border-bottom: 0.5px solid #eee; padding: 12px 0;
    font-size: 0.8rem; outline: none; background: transparent;
}

/* æ‰§è¡ŒæŒ‰é’® */
.execute-btn {
    width: 100%; background: #000; color: #fff; border: none; padding: 20px;
    margin-top: 40px; cursor: pointer; position: relative; overflow: hidden;
}
.btn-label { font-family: 'Cinzel'; letter-spacing: 3px; font-size: 0.8rem; }
.btn-line { position: absolute; bottom: 0; left: 0; width: 0%; height: 2px; background: #fff; transition: 0.5s; }
.execute-btn:active .btn-line { width: 100%; }

/* æˆåŠŸå¼¹çª— */
.success-box {
    background: #fff; width: 80%; padding: 40px 20px; text-align: center;
}
.success-icon {
    width: 50px; height: 50px; border: 1px solid #000; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;
}

/* ç³»ç»ŸçŸ­ä¿¡æ°”æ³¡æ ·å¼ */
.sms-complex-wrapper {
    background: #fdfdfd;
    border: 1px solid #eee;
    padding: 15px;
    margin: 10px 0;
    width: 90%;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    position: relative;
    font-family: 'Montserrat', sans-serif;
}

.sms-complex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 0.5px solid #f0f0f0;
    padding-bottom: 8px;
    margin-bottom: 10px;
}

.sms-tag {
    font-size: 0.55rem;
    letter-spacing: 2px;
    color: #999;
    font-weight: 700;
}

.sms-time {
    font-size: 0.5rem;
    color: #ccc;
    font-family: monospace;
}

.sms-complex-body {
    font-size: 0.75rem;
    line-height: 1.6;
    color: #222;
    letter-spacing: 0.5px;
    white-space: pre-wrap;
}

.sms-complex-footer {
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

.sms-seal {
    font-family: 'Cinzel';
    font-size: 0.45rem;
    color: #000;
    border: 0.5px solid #000;
    padding: 2px 5px;
    letter-spacing: 1px;
}

.sms-id {
    font-size: 0.4rem;
    color: #ddd;
    font-family: monospace;
}

/* ç³»ç»Ÿé€šçŸ¥æ¨ªå¹…æ ·å¼ - çµåŠ¨å²›/æ¨ªå¹…é£æ ¼ */
.lune-notification-banner {
    position: fixed;
    top: -100px; /* åˆå§‹éšè—åœ¨ä¸Šæ–¹ */
    left: 10px;
    right: 10px;
    height: 70px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 20px;
    z-index: 9999;
    display: flex;
    align-items: center;
    padding: 0 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
    border: 0.5px solid rgba(255,255,255,0.5);
    cursor: pointer;
}

.lune-notification-banner.active {
    top: 50px; /* ä¸‹æ»‘ä½ç½®ï¼Œè€ƒè™‘çŠ¶æ€æ é«˜åº¦ */
}

.notif-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    margin-right: 12px;
}

.notif-body {
    flex: 1;
    overflow: hidden;
}

.notif-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: #000;
    margin-bottom: 2px;
}

.notif-text {
    font-size: 0.65rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- æ¡£æ¡ˆåº“èƒŒæ™¯ä¸ç½‘æ ¼ --- */
#archive-grid-container {
    display: flex;
    flex-direction: column;
    gap: 25px;
    padding: 20px;
    background: #f4f4f4; /* æ¨¡æ‹Ÿæ¡Œé¢èƒŒæ™¯ */
}

/* --- é«˜çº§é•¿ç¥¨æ®å®ä½“ --- */
.ticket-row {
    display: flex;
    width: 100%;
    min-height: 160px; /* é”å®šæœ€å°é«˜åº¦ */
    background: #fff;
    border: 1.5px solid #000;
    position: relative;
    box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
    transition: 0.2s;
}

.ticket-row:hover {
    transform: translate(-2px, -2px);
    box-shadow: 12px 12px 0px rgba(0,0,0,0.15);
}

/* å·¦ä¾§ï¼šèº«ä»½è¯†åˆ«åŒº */
.ticket-section.identity {
    flex: 0 0 150px;
    border-right: 1.5px dashed #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 15px;
    background: #fafafa;
}

.ticket-photo-wrap {
    width: 60px;
    height: 60px;
    border: 1.5px solid #000;
    padding: 2px;
    background: #fff;
    margin-bottom: 10px;
}

.ticket-avatar {
    width: 100%; height: 100%;
    object-fit: cover;
    filter: grayscale(100%);
}

.ticket-name {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 13px;
    text-transform: uppercase;
    text-align: center;
}

/* ä¸­é—´ï¼šæ ¸å¿ƒè´¦åŠ¡ç»ˆç«¯ */
.ticket-section.data-terminal {
    flex: 1;
    padding: 20px 30px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.data-point { display: flex; flex-direction: column; }
.data-label { 
    font-size: 9px; 
    color: #999; 
    font-weight: 800; 
    letter-spacing: 1px;
    margin-bottom: 4px;
}
.data-value { font-family: monospace; font-size: 16px; font-weight: 700; color: #000; }

/* å³ä¾§ï¼šå­˜æ ¹ã€æ¡å½¢ç ä¸å°ç« åŒº */
.ticket-section.stub {
    flex: 0 0 140px;
    border-left: 2px dotted #000;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    background: #fff;
}

/* âš¡ ç‰©ç†çº§æ¡å½¢ç ï¼šä¿®å¤é«˜åº¦ä¸æ˜¾ç¤ºé—®é¢˜ */
.barcode-container {
    width: 100%;
    height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.barcode-strip {
    width: 100%;
    height: 45px;
    /* ä½¿ç”¨æ›´å¤æ‚çš„çº¿æ€§æ¸å˜æ¨¡æ‹ŸçœŸå®ä¸ç­‰å®½æ¡å½¢ç  */
    background: linear-gradient(90deg, 
        #000 0, #000 10%, transparent 10%, transparent 15%, 
        #000 15%, #000 18%, transparent 18%, transparent 22%,
        #000 22%, #000 35%, transparent 35%, transparent 40%,
        #000 40%, #000 42%, transparent 42%, transparent 55%,
        #000 55%, #000 70%, transparent 70%, transparent 75%,
        #000 75%, #000 78%, transparent 78%, transparent 85%,
        #000 85%, #000 100%
    );
    background-size: 40px 100%; /* å…³é”®ï¼šæ§åˆ¶æ¡çº¹å¯†åº¦ */
}

.barcode-num { font-family: monospace; font-size: 8px; margin-top: 4px; letter-spacing: 1px; }

/* âš¡ Luna Bank å®˜æ–¹å°ç«  */
.luna-bank-stamp {
    width: 70px;
    height: 70px;
    border: 3px double #000; /* åŒåœˆè¾¹æ¡† */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    bottom: 10px;
    right: 10px;
    transform: rotate(-15deg); /* ç›–ç« çš„éšæ„æ„Ÿ */
    pointer-events: none;
    opacity: 0.8;
}

.stamp-inner {
    width: 55px;
    height: 55px;
    border: 1px solid #000;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Cinzel', serif;
}

.stamp-text { font-size: 8px; font-weight: 900; line-height: 1; text-align: center; }
.stamp-core { font-size: 10px; border-top: 1px solid #000; margin-top: 2px; padding-top: 2px; }
/* --- æ¡£æ¡ˆé¦†å¤´éƒ¨ç»ˆç«¯æ ·å¼ --- */
.archive-header-terminal {
    padding: 30px 20px;
    background: #fff;
    border-bottom: 3px solid #000; /* å¼ºç¡¬çš„é»‘çº¿åˆ†å‰² */
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 25px;
}

.cinzel-title {
    font-family: 'Cinzel', serif;
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: 5px;
    margin: 0;
    color: #000;
    line-height: 1;
}

.protocol-line {
    display: flex;
    align-items: center;
    margin-top: 8px;
}

/* å‘¼å¸ç¯æ•ˆæœçš„å°ç‚¹ */
.status-dot {
    width: 6px;
    height: 6px;
    background: #000;
    border-radius: 50%;
    margin-right: 10px;
    animation: pulse-blink 1.5s infinite;
}

@keyframes pulse-blink {
    0% { opacity: 1; }
    50% { opacity: 0.2; }
    100% { opacity: 1; }
}

.mono-subtitle {
    font-family: monospace;
    font-size: 11px;
    color: #666;
    margin: 0;
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* å³ä¾§è£…é¥°ï¼šç³»ç»Ÿç‰ˆæœ¬å·ä¸æ‰«ææ¡ */
.terminal-right {
    text-align: right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.system-id {
    font-family: monospace;
    font-size: 10px;
    font-weight: 700;
    color: #ccc;
    margin-bottom: 5px;
}

.scan-line-decor {
    width: 60px;
    height: 4px;
    background: #000;
    position: relative;
    overflow: hidden;
}

/* æ‰«æåŠ¨ç”» */
.scan-line-decor::after {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, #fff, transparent);
    animation: scan-move 2s infinite linear;
}

@keyframes scan-move {
    0% { left: -100%; }
    100% { left: 100%; }
}
/* ä¼˜åŒ–ä¸­é—´çš„æ•°æ®ç»ˆç«¯ */
.ticket-section.data-terminal {
    flex: 1;
    padding: 20px 25px;
    display: grid;
    grid-template-columns: 1.2fr 1fr; /* è°ƒæ•´åˆ—å®½æ¯”ä¾‹ */
    gap: 15px;
    overflow: hidden; /* âš¡ å¼ºåˆ¶å‰ªè£æº¢å‡ºå†…å®¹ */
}

.data-point {
    min-width: 0; /* âš¡ å…³é”®ï¼šå…è®¸ Flex/Grid å­å…ƒç´ æ”¶ç¼© */
    display: flex;
    flex-direction: column;
}

.data-value {
    font-family: monospace;
    font-size: 15px;
    font-weight: 700;
    color: #000;
    /* âš¡ å¦‚æœå†…å®¹å¤ªé•¿ï¼Œæ˜¾ç¤ºçœç•¥å·ï¼Œä¸è®¸è¶…å‡ºè¾¹ç•Œ */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* --- 1. æ¡£æ¡ˆé¦†åº•å±‚å®¹å™¨ï¼šæ¸…ç†å¤–å±‚é—´è· --- */
#archive-grid-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px 5px; /* æçª„è¾¹è·ï¼ŒæŠŠç©ºé—´å…¨ç»™ç¥¨æ® */
    width: 100%;
    box-sizing: border-box;
}

/* --- 1. ç¥¨æ®å®¹å™¨ï¼šå»æ‰é«˜åº¦é™åˆ¶ï¼Œå…è®¸çºµå‘æ’‘å¼€ --- */
.ticket-row {
    display: flex;
    width: 100%;
    min-height: 180px; /* å¢åŠ æœ€å°é«˜åº¦ä»¥å®¹çº³çºµå‘åˆ—è¡¨ */
    height: auto;
    background: #fff;
    border: 2px solid #000;
    margin-bottom: 20px;
    box-shadow: 4px 4px 0px #000;
    box-sizing: border-box;
}

/* --- 2. èº«ä»½åŒºï¼šä¿æŒæ¯”ä¾‹ --- */
.ticket-section.identity {
    flex: 0 0 100px;
    border-right: 2px dashed #000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
}

/* --- 3. æ•°æ®ç»ˆç«¯ï¼šæ”¹ä¸ºçºµå‘åˆ—è¡¨åè®® --- */
.ticket-section.data-terminal {
    flex: 1;
    padding: 15px 25px;
    display: flex;
    flex-direction: column; /* âš¡ å…³é”®ï¼šç«–ç€æ’å¸ƒ */
    gap: 10px;             /* æ¯ä¸€é¡¹ä¹‹é—´çš„é—´è· */
    justify-content: center;
}

/* --- 4. æ•°æ®ç‚¹ï¼šå·¦å¯¹é½æ ‡ç­¾ï¼Œå³å¯¹é½æ•°å€¼ --- */
.data-point {
    display: flex;
    flex-direction: row;    /* âš¡ è¿™ä¸€è¡Œå†…ï¼šæ ‡ç­¾å’Œå€¼å·¦å³åˆ†å¸ƒ */
    justify-content: space-between; 
    align-items: center;
    border-bottom: 1px dotted #eee; /* å¢åŠ ç»†å¾®åˆ†å‰²çº¿å¢å¼ºç¥¨æ®æ„Ÿ */
    padding-bottom: 4px;
}

.data-label {
    font-size: 10px;
    color: #999;
    font-weight: 800;
    text-transform: uppercase;
}

.data-value {
    font-family: monospace;
    font-size: 15px;
    font-weight: 800;
    color: #000;
    text-align: right;
}

/* --- 5. å­˜æ ¹åŒºï¼šç¡®ä¿æ¡å½¢ç ä¸è¢«å‹ç¼© --- */
.ticket-section.stub {
    flex: 0 0 110px;
    border-left: 2px dotted #000;
    padding: 15px 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
}
/* --- 1. ç¥¨æ®å®¹å™¨ï¼šç´§å‡‘åŒ–å¤„ç† --- */
.ticket-row {
    display: flex;
    width: 100%;
    min-height: 140px; /* ç¼©å°æœ€å°é«˜åº¦ï¼Œå› ä¸ºå­—å˜å°äº† */
    height: auto;
    background: #fff;
    border: 1.5px solid #000;
    margin-bottom: 15px;
    box-shadow: 3px 3px 0px #000;
    box-sizing: border-box;
}

/* --- 2. èº«ä»½åŒºï¼šç¼©å°å°ºå¯¸ --- */
.ticket-section.identity {
    flex: 0 0 85px; /* ä» 100px ç¼©å° */
    border-right: 1.5px dashed #000;
    padding: 8px;
    background: #fafafa;
}

.ticket-photo-wrap {
    width: 42px; /* ç¼©å°å¤´åƒæ¡† */
    height: 42px;
    border: 1.2px solid #000;
    margin-bottom: 6px;
}

.ticket-name {
    font-family: 'Cinzel', serif;
    font-size: 10px; /* ç¼©å°å§“å */
    font-weight: 900;
    text-align: center;
    line-height: 1.2;
}

/* --- 3. æ•°æ®ç»ˆç«¯ï¼šç²¾å¯†åˆ—è¡¨æ’ç‰ˆ --- */
.ticket-section.data-terminal {
    flex: 1;
    padding: 12px 18px; /* è°ƒæ•´å†…è¾¹è· */
    display: flex;
    flex-direction: column;
    gap: 6px; /* ç¼©å°è¡Œé—´è· */
    justify-content: center;
}

/* --- 4. æ•°æ®ç‚¹ï¼šæå°å­—ä¸é«˜å¯¹æ¯”æ•°å€¼ --- */
.data-point {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dotted #ddd;
    padding-bottom: 2px;
}

.data-label {
    font-size: 8px; /* âš¡ æå°å­—ä½“ */
    color: #aaa;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px; /* å¢åŠ å­—é—´è·ï¼Œå°å­—æ‰æ¸…æ™° */
}

.data-value {
    font-family: monospace;
    font-size: 11px; /* âš¡ ç¼©å°æ•°å€¼å­—ä½“ */
    font-weight: 700;
    color: #000;
    text-align: right;
}

/* --- 5. å­˜æ ¹åŒºï¼šç´§å‡‘å¯¹é½ --- */
.ticket-section.stub {
    flex: 0 0 95px; /* ç¼©å°å®½åº¦ */
    border-left: 2px dotted #000;
    padding: 10px 5px;
}

.barcode-strip {
    height: 35px; /* ç¼©å°æ¡å½¢ç é«˜åº¦ */
    background-size: 25px 100%; /* è°ƒå¯†æ¡çº¹ */
}

.barcode-num {
    font-size: 7px; /* æå°æ•°å­— */
    color: #888;
}

/* Luna Bank å°ç« ç¼©å° */
.luna-bank-stamp {
    width: 50px;
    height: 50px;
    border-width: 1.5px;
    bottom: 2px;
    right: 2px;
}

/* --- èº«ä»½åŒºå¤´åƒï¼šå–æ¶ˆé»‘ç™½ï¼Œæ¢å¤å½©è‰² --- */
.ticket-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
    /* âš¡ æ ¸å¿ƒæ”¹åŠ¨ï¼šå»æ‰ grayscale(100%) */
    filter: none; 
    /* å¦‚æœä½ è§‰å¾—é¢œè‰²å¤ªäº®ï¼Œå¯ä»¥ç¨å¾®åŠ ä¸€ç‚¹å¯¹æ¯”åº¦è®©å®ƒæ›´æœ‰è´¨æ„Ÿ */
    /* filter: contrast(1.1); */
    display: block;
}

.ticket-photo-wrap {
    width: 42px;
    height: 42px;
    border: 1.5px solid #000; /* ä¿æŒç¡¬æ ¸é»‘è¾¹ */
    padding: 1px;
    background: #fff;
    margin-bottom: 6px;
    /* ä¹Ÿå¯ä»¥ç»™å¤´åƒæ¡†åŠ ä¸€ç‚¹é˜´å½±ï¼Œè®©å½©è‰²çš„ç…§ç‰‡æ›´æœ‰ç«‹ä½“æ„Ÿ */
    box-shadow: 2px 2px 0px rgba(0,0,0,0.05);
}

/* --- 1. å®¹å™¨ï¼šæ¯”ä¾‹é”å®šä¸å¼¹æ€§åˆ†é… --- */
/* å…¨å±é®ç½©å®¹å™¨ */
.luna-subpage-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: #ffffff; /* çº¯ç™½èƒŒæ™¯ */
    z-index: 200000; /* æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨æ‰€æœ‰æ¨¡æ€æ¡†ä¹‹ä¸Š */
    transform: translateY(100%); /* åˆå§‹ä½ç½®åœ¨å±å¹•å¤– */
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    color: #000;
}

.luna-subpage-overlay.show { transform: translateY(0); }

.safe-area-inset { height: 44px; flex-shrink: 0; background: #fff; }

/* å¤´éƒ¨å¯¼èˆª */
.bank-nav-header {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    border-bottom: 2px solid #000;
}
.header-title { font-weight: 900; letter-spacing: 2px; font-size: 15px; }

/* ä½™é¢åŒº */
.bank-balance-section {
    padding: 30px 20px;
    border-bottom: 1px solid #eee;
}
.balance-label { font-size: 10px; font-weight: bold; color: #999; }
.balance-main { font-size: 40px; font-weight: 900; font-family: 'Cinzel', serif; margin-top: 5px; }
.balance-footer-line { width: 40px; height: 4px; background: #000; margin-top: 15px; }

/* å†…å®¹åŒºåˆ‡æ¢ */
.bank-viewport { flex: 1; position: relative; overflow: hidden; background: #fafafa; }
.bank-tab-panel {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0; pointer-events: none;
    transition: 0.3s opacity;
    padding: 20px;
}
.bank-tab-panel.active { opacity: 1; pointer-events: auto; overflow-y: auto; }

/* å·¥ä¸šé£ç™½å¡ç‰‡ */
.white-industrial-card {
    background: #fff;
    border: 2px solid #000;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 5px 5px 0px #000;
    position: relative;
}
.card-tag { font-size: 9px; font-weight: 900; background: #000; color: #fff; padding: 2px 5px; }
.card-content { margin-top: 10px; font-size: 13px; font-weight: bold; }
.card-val { font-family: 'Cinzel'; font-size: 20px; font-weight: 900; margin-top: 5px; }

.dual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

/* åˆ—è¡¨é¡¹ */
.list-item-white {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 5px;
    border-bottom: 1.5px solid #000;
}
.item-title { display: block; font-size: 13px; font-weight: bold; }
.item-meta { font-size: 10px; color: #888; }
.item-price { font-family: 'Cinzel'; font-weight: 900; }

/* åº•éƒ¨å¯¼èˆª */
.bank-bottom-nav {
    height: 85px;
    background: #fff;
    border-top: 2px solid #000;
    display: flex;
    padding-bottom: 25px;
}
.nav-b-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0.3;
}
.nav-b-item.active { opacity: 1; }
.nav-icon-dot { width: 6px; height: 6px; background: #000; margin-bottom: 6px; transform: scale(0); transition: 0.2s; }
.nav-b-item.active .nav-icon-dot { transform: scale(1); }
.nav-b-item span { font-size: 9px; font-weight: bold; }

/* è¿›åº¦æ¡ */
.progress-bar-industrial { height: 10px; background: #eee; border: 1.5px solid #000; margin: 15px 0; }
.progress-inner { height: 100%; background: #000; }
/* ä½™é¢ç¼–è¾‘åŒº */
.dashboard-balance-editor {
    background: #000; /* é»‘ç™½å¯¹æ¯”ï¼šä½™é¢åŒºç”¨é»‘åº•ç™½å­—çªæ˜¾ */
    color: #fff;
    padding: 25px 20px;
    margin: -20px -20px 20px -20px; /* æ’‘æ»¡é¡¶éƒ¨ */
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
.display-row { display: flex; align-items: baseline; gap: 8px; margin-top: 5px; }
#current-balance-num { font-size: 36px; font-weight: 900; font-family: 'Cinzel'; }
.edit-balance-btn {
    background: #fff; color: #000; border: none;
    width: 28px; height: 28px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; margin-left: 10px;
}

/* å¡åŒ…åŒæ­¥åŒº */
.section-header-bw { margin: 20px 0 10px; display: flex; align-items: center; gap: 10px; }
.header-line { flex: 1; height: 1.5px; background: #000; }

.card-sync-container { margin-bottom: 25px; }
.horizontal-scroll-cards {
    display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px;
}
.mini-card-skeleton {
    min-width: 140px; height: 80px; border: 1.5px dashed #ccc;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: #999;
}
.add-protocol-btn {
    width: 100%; padding: 12px; border: 1.5px solid #000;
    background: #fff; font-weight: 900; font-size: 11px;
    margin-top: 10px; box-shadow: 3px 3px 0px #000;
}

/* æ¶ˆè´¹åˆ‡æ¢å™¨ */
.consumption-module {
    border: 1.5px solid #000; background: #fff;
    box-shadow: 5px 5px 0px #000;
}
.consumption-switcher-tabs {
    display: flex; border-bottom: 1.5px solid #000;
}
.con-tab {
    flex: 1; text-align: center; padding: 10px;
    font-size: 11px; font-weight: 900; cursor: pointer;
    background: #eee; border-right: 1.5px solid #000;
}
.con-tab:last-child { border-right: none; }
.con-tab.active { background: #fff; }

.consumption-sub-panel { display: none; padding: 15px; }
.consumption-sub-panel.active { display: block; }

.stat-item-bw .tag { font-size: 9px; font-weight: 900; background: #000; color: #fff; padding: 2px 4px; }
.stat-item-bw .val { font-family: 'Cinzel'; font-size: 24px; font-weight: 900; margin-top: 5px; }
.module-action-btn {
    margin-top: 10px; width: 100%; padding: 8px;
    background: #000; color: #fff; border: none; font-size: 10px;
}
/* æ¨¡æ€æ¡†èƒŒæ™¯é®ç½© */
.industrial-modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(255, 255, 255, 0.85); /* åŠé€æ˜ç™½ */
    backdrop-filter: blur(8px);
    z-index: 300000; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
}

/* æ¨¡æ€æ¡†ä¸»ä½“ */
.industrial-modal-box {
    width: 85%;
    max-width: 320px;
    background: #fff;
    border: 3px solid #000;
    box-shadow: 10px 10px 0px #000;
    animation: modalSlideUp 0.3s cubic-bezier(0.2, 1, 0.2, 1);
}

@keyframes modalSlideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* å¤´éƒ¨ */
.modal-header-bw {
    padding: 15px;
    border-bottom: 2px solid #000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #000;
    color: #fff;
}
.modal-header-bw span { font-weight: 900; letter-spacing: 1px; font-size: 13px; }
.close-x { cursor: pointer; font-size: 20px; }

/* èº«ä½“éƒ¨åˆ† */
.modal-body { padding: 30px 20px; }
.input-container-bw { position: relative; }
.input-label { font-size: 9px; font-weight: 900; background: #000; color: #fff; padding: 2px 5px; position: absolute; top: -10px; left: 10px; }

#new-balance-input {
    width: 100%;
    border: 2px solid #000;
    padding: 15px;
    font-family: 'Cinzel', serif;
    font-size: 24px;
    font-weight: 900;
    outline: none;
    background: #fafafa;
    text-align: center;
}

.input-decoration { font-size: 8px; color: #aaa; text-align: right; margin-top: 5px; font-family: monospace; }

/* åº•éƒ¨æŒ‰é’® */
.modal-footer-bw {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-top: 2px solid #000;
}
.modal-footer-bw button {
    padding: 15px;
    border: none;
    font-weight: 900;
    font-size: 12px;
    cursor: pointer;
    transition: 0.2s;
}
.modal-btn-cancel { background: #fff; color: #000; border-right: 2px solid #000 !important; }
.modal-btn-confirm { background: #000; color: #fff; }
.modal-btn-confirm:active { background: #333; }
/* åè®®æ¡†ç‰¹å®šæ ·å¼ */
.protocol-box {
    max-width: 360px !important; /* ç¨å¾®å®½ä¸€ç‚¹ï¼Œæ˜¾å¾—æ›´æ­£å¼ */
}

.protocol-body {
    padding: 25px 15px !important;
    background: linear-gradient(180deg, #fff 0%, #f2f2f2 100%);
}

.header-content { display: flex; flex-direction: column; }
.subtitle-en { font-size: 8px; opacity: 0.6; letter-spacing: 1px; }

.protocol-deco-line {
    width: 100%;
    height: 1px;
    background: repeating-linear-gradient(90deg, #000 0, #000 5px, transparent 5px, transparent 10px);
    margin-bottom: 20px;
}

.protocol-hint {
    font-size: 10px;
    font-weight: bold;
    color: #666;
    margin-bottom: 15px;
}

/* ä½ è¦æ±‚çš„å¤§æŒ‰é’®æ ·å¼ï¼šæè‡´å·¥ä¸šé£ */
.protocol-main-btn {
    width: 100%;
    background: #fff;
    border: 2.5px solid #000;
    display: flex;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
    box-shadow: 6px 6px 0px #000;
}

.protocol-main-btn:active {
    transform: translate(3px, 3px);
    box-shadow: 2px 2px 0px #000;
}

.btn-icon { font-size: 20px; margin-right: 15px; filter: grayscale(1); }

.btn-text-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    flex: 1;
}

.btn-main-title {
    font-size: 15px;
    font-weight: 900;
    color: #000;
}

.btn-sub-title {
    font-size: 8px;
    font-weight: 700;
    color: #888;
    margin-top: 2px;
}

.btn-arrow {
    font-size: 18px;
    font-weight: 900;
    opacity: 0.3;
}

.protocol-footer-info {
    margin-top: 25px;
    display: flex;
    justify-content: space-between;
    font-size: 8px;
    font-family: monospace;
    font-weight: bold;
    color: #aaa;
    border-top: 1px solid #ddd;
    padding-top: 10px;
}
/* è®°å½•åˆ—è¡¨ */
.npc-record-list { max-height: 300px; overflow-y: auto; margin-bottom: 20px; }

/* æ¯ä¸€æ¡ NPC è®°å½•å¡ç‰‡ */
.npc-record-item {
    background: #fff; border: 1.5px solid #000;
    padding: 12px; margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; transition: 0.2s;
    box-shadow: 3px 3px 0px #000;
}
.npc-record-item:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }
.npc-name { font-weight: 900; font-size: 14px; }
.npc-card-type { font-size: 9px; opacity: 0.5; background: #eee; padding: 2px 4px; margin-left: 5px; }

/* AI ç”ŸæˆæŒ‰é’® */
.ai-generate-btn {
    width: 100%; padding: 12px; background: #000; color: #fff;
    border: none; font-weight: 900; font-size: 11px; letter-spacing: 1px;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
}

/* æ•…äº‹è¯¦æƒ…å¼¹çª—ä¸“ç”¨ */
.story-box { max-width: 340px !important; }
.story-body { padding: 25px !important; background: #fdfdfd; }
.story-content-box {
    font-size: 13px; line-height: 1.8; color: #333;
    border-left: 3px solid #000; padding-left: 15px;
    margin: 15px 0; font-family: "Noto Serif SC", serif;
}
.story-footer-deco { font-size: 8px; font-family: monospace; opacity: 0.3; text-align: right; margin-top: 20px; }
/* --- 1. è§£å¯†æ‰«æåŠ¨ç”» --- */
.decoding-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.9);
    z-index: 100;
    display: none; /* åˆå§‹éšè— */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

/* æ‰«æçº¿ */
.scan-line {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 2px;
    background: #000;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    animation: scanMove 2s linear infinite;
}

@keyframes scanMove {
    0% { top: 0%; }
    100% { top: 100%; }
}

/* è¿›åº¦æ¡å¤–æ¡† */
.loading-progress-container {
    width: 200px;
    height: 4px;
    border: 1px solid #000;
    margin-top: 20px;
    position: relative;
    overflow: hidden;
}

/* è¿›åº¦æ¡å¡«å…… */
.loading-progress-bar {
    width: 0%;
    height: 100%;
    background: #000;
}

/* æ–‡å­—é—ªçƒ */
.flicker-text {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 14px;
    letter-spacing: 2px;
    animation: textFlicker 1s steps(2) infinite;
}

@keyframes textFlicker {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
/* æ•…äº‹å¼¹çª—ä¸“ç”¨ï¼šæè‡´é«˜ç©ºå±‚çº§ */
#binding-story-modal.industrial-modal-overlay {
    display: none; /* é»˜è®¤éšè—ï¼Œç”± JS æ§åˆ¶ */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.9); /* é«˜äº®èƒŒæ™¯ */
    backdrop-filter: blur(10px); /* ç£¨ç ‚æ•ˆæœ */
    
    /* âš¡ æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥æ‹‰åˆ° 50 ä¸‡ï¼Œçœ‹è°è¿˜æ•¢æŒ¡ */
    z-index: 300000 !important; 
    
    align-items: center;
    justify-content: center;
}

/* ç¡®ä¿å†…éƒ¨ç›’å­ä¹Ÿæ˜¯å¯è§çš„ */
#binding-story-modal .story-box {
    position: relative;
    z-index: 500001; /* æ¯”é®ç½©å†é«˜ä¸€å±‚ */
    background: #fff;
    border: 3px solid #000;
}

.config-item { margin-bottom: 25px; }
.config-item input[type="number"] {
    width: 100%; border: 2px solid #000; padding: 10px;
    font-family: 'Cinzel'; font-weight: 900; outline: none;
}
input[type="range"] { width: 100%; accent-color: #000; cursor: pointer; }

/* å…¨å±é£æ ¼å±•ç¤ºæ¡† */
.full-box { width: 95% !important; max-width: 450px !important; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
.scroll-body { flex: 1; overflow-y: auto; padding: 20px; }

/* å›¾è¡¨å®¹å™¨ */
.chart-container-bw {
    background: #fff; border: 2px solid #000;
    padding: 10px; margin-bottom: 20px;
    box-shadow: 4px 4px 0px #eee;
}

.report-list { margin-top: 15px; }
.report-entry {
    border-bottom: 1.5px solid #000; padding: 12px 0;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer;
}
.report-entry .m-name { font-weight: 900; font-family: 'Cinzel'; }
.report-entry .m-val { font-family: monospace; font-weight: bold; }

.section-title-bw { font-size: 10px; opacity: 0.5; text-align: center; margin: 20px 0; }
.re-generate-trigger {
    width: 100%;
    background: none;
    border: 1.5px dashed #ccc;
    color: #999;
    padding: 10px;
    font-size: 10px;
    font-family: 'Cinzel';
    margin-top: 20px;
    cursor: pointer;
}
.re-generate-trigger:hover {
    border-color: #000;
    color: #000;
}
/* åˆ—è¡¨é¡¹ç¾åŒ–ï¼šé“¶è¡Œå›æ‰§å•é£æ ¼ */
.report-entry-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 10px;
    border-bottom: 1px dashed #ccc; /* è™šçº¿æ›´æœ‰æ¡£æ¡ˆæ„Ÿ */
    position: relative;
    transition: background 0.3s;
}
.report-entry-row:hover { background: #f9f9f9; }
.m-title { font-family: 'Cinzel', serif; font-weight: 900; font-size: 15px; color: #000; }
.m-desc { font-size: 10px; color: #666; font-family: monospace; line-height: 1.4; margin-top: 4px; }
.m-price { font-family: 'Cinzel'; font-weight: 900; font-size: 18px; color: #000; }

/* æŒ‰é’®ç»„ç¾åŒ– */
.report-footer-actions {
    display: flex; gap: 10px; padding: 20px 0;
}
.save-archive-btn {
    flex: 2; background: #000; color: #fff; border: none;
    padding: 15px; font-family: 'Cinzel'; font-weight: 900;
    letter-spacing: 1px; cursor: pointer; transition: 0.3s;
}
.re-gen-btn {
    flex: 1; background: #fff; color: #000; border: 2px solid #000;
    padding: 15px; font-family: 'Cinzel'; font-weight: 900; font-size: 10px;
    cursor: pointer;
}
.save-archive-btn:active { transform: scale(0.98); opacity: 0.8; }

/* å›¾è¡¨å®¹å™¨å¢åŠ å¤–å‘å…‰ */
.chart-wrapper-bw {
    background: #fff; border: 3px solid #000;
    padding: 15px; margin-bottom: 25px;
    box-shadow: 8px 8px 0px #eee;
}
/* ä¸“å±ç”ŸæˆåŠ¨ç”»ï¼šæ‰«æçº¿æ•ˆæœ */
.scanning-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 100;
}

.scan-line {
    width: 80%; height: 2px; background: #000;
    position: absolute; top: 0;
    animation: scanMove 1.5s infinite linear;
}

@keyframes scanMove {
    0% { top: 0; opacity: 0; }
    50% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

.loading-text {
    font-family: 'Cinzel', serif; font-weight: 900; font-size: 12px;
    letter-spacing: 2px; margin-top: 15px; animation: blink 1s infinite;
}

@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
/* è¯¦æƒ…æ–‡å­—æ·¡å…¥åŠ¨ç”» */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* è¯¦æƒ…æ»šåŠ¨æ¡ç¾åŒ– */
.scroll-body::-webkit-scrollbar { width: 4px; }
.scroll-body::-webkit-scrollbar-track { background: #f1f1f1; }
.scroll-body::-webkit-scrollbar-thumb { background: #000; }

/* å“åº”å¼è°ƒæ•´ */
#detail-story-container span {
    display: inline-block;
    transition: all 0.3s;
}
#detail-story-container span:hover {
    background: #000; color: #fff;
}

/* ä¿®å¤ï¼šæ‰«æé®ç½©å±‚å¿…é¡»æ’‘æ»¡ */
.scanning-overlay {
    position: absolute; 
    top: 0; left: 0; 
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.95);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 100;
    overflow: hidden; /* é˜²æ­¢çº¿æ¡é£å‡º */
}

/* ä¿®å¤ï¼šçº¿æ¡å®½åº¦è®¾ä¸º 100%ï¼Œå¹¶å¢åŠ å…‰æ™•æ„Ÿ */
.scan-line {
    width: 100%; /* çº¿æ¡æ‹‰æ»¡ */
    height: 3px; 
    background: linear-gradient(90deg, transparent, #000, transparent); /* æ¸å˜çº¿ï¼Œæ›´æœ‰è´¨æ„Ÿ */
    position: absolute; 
    left: 0; /* é å·¦å¯¹é½ */
    animation: scanMove 2s infinite ease-in-out;
    box-shadow: 0 0 8px rgba(0,0,0,0.3); /* å¢åŠ ä¸€ç‚¹é˜´å½±ï¼Œè®©çº¿æ¡å˜é‡ */
}

@keyframes scanMove {
    0% { top: 0; }
    100% { top: 100%; }
}
.archive-list-header {
    margin: 20px 0 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.header-line { flex: 1; height: 1px; background: #eee; }
.entry-arrow {
    font-size: 10px;
    color: #ccc;
    font-weight: 100;
}
.records-box-white {
    border: 2px solid #000;
    background: #fff;
    margin-bottom: 15px;
}
/* ç”Ÿæˆæ€»è¡¨ä¸“å±ï¼šå…¨å±è§£å¯†é®ç½© */
.vault-decrypting-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 999999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}

/* åŠ¨æ€æ‰«æçº¿ */
.v-scan-line {
    width: 100%; height: 4px;
    background: rgba(0,0,0,0.8);
    position: absolute;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    animation: vScanMove 2s infinite ease-in-out;
}

@keyframes vScanMove {
    0% { top: 0; }
    100% { top: 100%; }
}

/* é—ªçƒçš„ç»ˆç«¯æ–‡å­— */
.v-loading-text {
    font-family: 'Cinzel', serif; font-weight: 900; font-size: 16px;
    color: #000; letter-spacing: 4px;
    text-shadow: 2px 2px 0px #eee;
    animation: vBlink 0.8s infinite;
}

.v-status-sub {
    font-family: monospace; font-size: 10px; color: #888; margin-top: 15px;
}

@keyframes vBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
/* å®æ—¶è´¦ç›®æµæ ‡ç­¾ï¼šå·¥ä¸šé“­ç‰Œé£æ ¼ */
.tiny-label {
    font-family: 'Courier New', monospace; /* ç¨‹åºå‘˜æœ€çˆ±çš„ç­‰å®½å­—ä½“ */
    font-size: 9px;
    font-weight: 900;
    color: #000;
    text-transform: uppercase; /* å¼ºåˆ¶å¤§å†™ï¼Œå¢åŠ ä»ªå¼æ„Ÿ */
    letter-spacing: 3px;       /* æ ¸å¿ƒï¼šæå®½å­—é—´è·ï¼Œè¥é€ é«˜çº§æ„Ÿ */
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
    opacity: 0.8;
}

/* ç»™æ ‡ç­¾å‰é¢åŠ ä¸€ä¸ªâ€œé—ªçƒçš„çŠ¶æ€ç‚¹â€ï¼Œæ›´æœ‰åŠ¨æ€æ„Ÿ */
.tiny-label::before {
    content: "";
    width: 6px;
    height: 6px;
    background: #000;
    display: inline-block;
    border-radius: 50%; /* åœ†å½¢ */
    animation: statusBlink 1.5s infinite; /* å‘¼å¸ç¯åŠ¨ç”» */
}

@keyframes statusBlink {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.3; transform: scale(0.8); }
}
/* å¡ç‰‡å®¹å™¨ï¼šæ”¯æŒæ¨ªå‘æ»šåŠ¨ */
.history-cards-scroll {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 10px 0;
    min-height: 120px;
}
.history-cards-scroll::-webkit-scrollbar { display: none; }

/* å•å¼ å­˜æ¡£å¡ç‰‡æ ·å¼ */
.archive-card-bw {
    flex: 0 0 140px; /* å›ºå®šå®½åº¦ */
    background: #fff;
    border: 2px solid #000;
    padding: 12px;
    position: relative;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.archive-card-bw:hover {
    transform: translateY(-5px);
    box-shadow: 6px 6px 0px rgba(0,0,0,0.1);
}
.card-tag { font-family: monospace; font-size: 8px; color: #888; display: block; }
.card-month { font-family: 'Cinzel'; font-weight: 900; font-size: 14px; margin: 5px 0; }
.card-val { font-family: 'Cinzel'; font-weight: 900; font-size: 16px; border-top: 1px dashed #eee; padding-top: 5px; }

/* ç©ºçŠ¶æ€æ–‡å­— */
.empty-placeholder { font-size: 9px; color: #ccc; letter-spacing: 2px; padding: 20px; text-align: center; width: 100%; }
/* æ–°å»ºç”ŸæˆæŒ‰é’®ï¼šå·¥ä¸šåè®®é£æ ¼ */
.mini-add-btn {
    background: #000;          /* é»‘è‰²åº• */
    color: #fff;               /* ç™½è‰²å­— */
    border: 1.5px solid #000;
    padding: 4px 12px;
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 10px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
}

/* æ‚¬åœæ•ˆæœï¼šé»‘ç™½åè½¬ */
.mini-add-btn:hover {
    background: #fff;
    color: #000;
    box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
    transform: translate(-2px, -2px); /* æ‚¬æµ®æ„Ÿ */
}

/* ç‚¹å‡»åé¦ˆï¼šæ·±é™·æ„Ÿ */
.mini-add-btn:active {
    transform: translate(0, 0);
    box-shadow: 0px 0px 0px transparent;
}

/* æŒ‰é’®å‰é¢çš„ "+" å·ç¨å¾®åŠ ç²— */
.mini-add-btn::before {
    margin-right: 4px;
    font-weight: 100;
    opacity: 0.7;
}
/* 1. å¤´éƒ¨å®¹å™¨ï¼šå¼ºåˆ¶ä¸¤ç«¯å¯¹é½ */
.dash-section-header {
    display: flex;
    justify-content: space-between; /* è¿™ä¸€è¡Œè®©æ ‡ç­¾å¾€å·¦ï¼ŒæŒ‰é’®å¾€å³ */
    align-items: center;
    width: 100%;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee; /* åŠ ä¸€æ¡ç»†çº¿ï¼Œå¢åŠ åˆ†åŒºæ„Ÿ */
    padding-bottom: 8px;
}

/* 2. å·¦ä¾§æ ‡ç­¾ç¾åŒ–ï¼šå·¥ä¸šé“­ç‰Œé£æ ¼ */
.tiny-label {
    font-family: 'Courier New', monospace;
    font-size: 9px;
    font-weight: 900;
    letter-spacing: 2px;
    color: #000;
    display: flex;
    align-items: center;
    gap: 8px;
}
.tiny-label::before {
    content: "";
    width: 6px;
    height: 6px;
    background: #000;
    border-radius: 50%;
    animation: blink 1.5s infinite;
}

/* 3. å³ä¾§æŒ‰é’®ï¼šç¡¬æ ¸é»‘è‰²æ–¹å— */
.mini-add-btn {
    background: #000;
    color: #fff;
    border: none;
    padding: 6px 14px; /* å¢åŠ å®½åº¦ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´ç¨³ */
    font-family: 'Cinzel', serif;
    font-size: 10px;
    font-weight: 900;
    letter-spacing: 1px;
    cursor: pointer;
    transition: 0.2s;
    white-space: nowrap; /* ä¿è¯æ–‡å­—ä¸æ¢è¡Œ */
}
.mini-add-btn:hover {
    background: #444; /* æ‚¬åœæ—¶ç¨å¾®å˜ç°ï¼Œå¢åŠ åé¦ˆ */
    transform: translateY(-1px);
}
.mini-add-btn:active {
    transform: translateY(0);
}

@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
.report-footer-actions {
    display: flex; gap: 10px; margin-top: 25px;
}

.save-archive-btn {
    flex: 2; background: #000; color: #fff; border: none;
    padding: 15px; font-family: 'Cinzel', serif; font-weight: 900;
    font-size: 12px; cursor: pointer; letter-spacing: 2px;
    /* å¢åŠ ä¸€ä¸ªç»†å¾®çš„æ‰«å…‰åŠ¨ç”»ï¼Œè¯±å¯¼ç‚¹å‡» */
    background: linear-gradient(135deg, #000 0%, #333 50%, #000 100%);
    background-size: 200% 100%;
    animation: buttonGlow 3s infinite;
}

.re-gen-btn-alt {
    flex: 1; background: #fff; color: #000; border: 2px solid #000;
    padding: 15px; font-family: 'Cinzel'; font-weight: 900; font-size: 10px;
    cursor: pointer;
}

@keyframes buttonGlow {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
/* ç¡®è®¤å­˜æ¡£æŒ‰é’®ï¼šçº¯é»‘é«˜å®šæ„Ÿ */
.save-archive-btn {
    background: #000 !important;
    color: #fff !important;
    border: none;
    padding: 15px;
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 12px;
    letter-spacing: 2px;
    cursor: pointer;
    text-transform: uppercase;
}

/* é‡æ–°ç”ŸæˆæŒ‰é’®ï¼šç™½åº•é»‘æ¡† */
.re-gen-btn {
    background: #fff !important;
    color: #000 !important;
    border: 2px solid #000 !important;
    padding: 15px;
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 10px;
    cursor: pointer;
}

/* æ‚¬åœåé¦ˆ */
.save-archive-btn:hover { background: #333 !important; }
.re-gen-btn:hover { background: #eee !important; }

.full-box { 
    width: 95% !important; 
    max-width: 450px !important; 
    height: 85vh; /* å»ºè®®ç»™ 85%ï¼Œç•™ä¸€ç‚¹è¾¹è· */
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
}

/* ç¡®ä¿ä¸­é—´çš„å†…å®¹åŒºå¯ä»¥æ»šåŠ¨ï¼Œä¸æŠŠåº•éƒ¨çš„æŒ‰é’®é¡¶å‡ºå» */
.scroll-body { 
    flex: 1; 
    overflow-y: auto; 
    padding: 20px; 
}

/* åº•éƒ¨æŒ‰é’®åŒºå›ºå®š */
.report-footer-actions {
    flex: 0 0 auto; /* ç¦æ­¢æ”¶ç¼© */
    background: #fff;
    border-top: 2px solid #000;
    padding: 15px;
    display: flex;
    gap: 10px;
}
/* ç«–å¼è´¦å•å°ç¥¨æ ·å¼ */
.industrial-receipt {
    background: #fff;
    border: 1px solid #000;
    margin-bottom: 30px;
    padding: 20px;
    position: relative;
    box-shadow: 8px 8px 0px rgba(0,0,0,0.05);
}

.receipt-header {
    text-align: center;
    border-bottom: 2px dashed #000;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.receipt-row {
    display: flex;
    justify-content: space-between;
    font-family: monospace;
    font-size: 12px;
    padding: 5px 0;
    border-bottom: 1px dotted #eee;
}

.receipt-total-row {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 2px solid #000;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
}

.receipt-total-label { font-family: 'Cinzel'; font-weight: 900; font-size: 14px; }
.receipt-total-val { font-family: 'Cinzel'; font-weight: 900; font-size: 20px; }

/* é”¯é½¿è¾¹ç¼˜æ„Ÿ (ä¼ªå…ƒç´ è£…é¥°) */
.industrial-receipt::after {
    content: "";
    position: absolute;
    bottom: -10px; left: 0; width: 100%; height: 10px;
    background-image: linear-gradient(135deg, #f4f4f4 25%, transparent 25%), linear-gradient(225deg, #f4f4f4 25%, transparent 25%);
    background-size: 10px 20px;
}
/* ğŸš¨ å¼ºåˆ¶éš”ç¦»åè®®ï¼šæœªæ¿€æ´»çš„é¢æ¿å¿…é¡»ç‰©ç†æ¶ˆå¤± */
.consumption-sub-panel {
    display: none !important; /* é»˜è®¤å…¨éƒ¨éšè— */
    opacity: 0;
    transition: opacity 0.3s ease;
}

.consumption-sub-panel.active {
    display: block !important; /* åªæœ‰åŠ äº† active æ‰æ˜¾ç¤º */
    opacity: 1;
    animation: fadeInPanel 0.4s ease forwards;
}

@keyframes fadeInPanel {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ç¡®ä¿å¹´åº¦å®¹å™¨ä¹Ÿæ˜¯æ¨ªå‘æ’åˆ— */
#dash-yearly-cards-container {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 10px 0;
    min-height: 120px;
}
/* --- ğŸ“œ å¹´åº¦å†å²å·å®—ä¸“ç”¨æ ·å¼ (Yearly History) --- */

/* 1. å…¨å±é®ç½©ï¼šæé«˜å±‚çº§ï¼Œæ·±è‰²èƒŒæ™¯ */
#yearly-history-modal.industrial-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9); /* 90% é»‘ */
    backdrop-filter: blur(5px);      /* æ¯›ç»ç’ƒ */
    z-index: 999999;                 /* ç¡®ä¿ç›–ä½ä¸€åˆ‡ */
    display: none;                   /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶ flex */
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.2s ease-out;
}

/* 2. å¼¹çª—ä¸»ä½“ï¼šå…¨å±æˆ–å¤§å¡ç‰‡é£æ ¼ */
.industrial-modal-box.full-box {
    width: 100%;
    max-width: 500px; /* æ‰‹æœºç«¯é™åˆ¶æœ€å¤§å®½åº¦ */
    height: 90vh;     /* å æ®å±å¹•é«˜åº¦çš„ 90% */
    background: #f4f4f4;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 50px rgba(0,0,0,0.8);
    border: 1px solid #333;
    animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

/* 3. é»‘ç™½è¡¨å¤´ */
.modal-header-bw {
    background: #000;
    color: #fff;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
    border-bottom: 2px solid #333;
}

/* å…³é—­æŒ‰é’® (X) */
.close-x {
    font-size: 28px;
    font-weight: 100;
    cursor: pointer;
    line-height: 1;
    padding: 0 10px;
    transition: transform 0.2s;
}
.close-x:active {
    transform: scale(0.8);
}

/* 4. æ»šåŠ¨å†…å®¹åŒº */
.scroll-body {
    flex: 1;           /* å æ»¡å‰©ä½™ç©ºé—´ */
    overflow-y: auto;  /* å…è®¸æ»šåŠ¨ */
    padding: 20px;
    background-color: #f4f4f4; /* åº•è‰² */
    /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE */
}
.scroll-body::-webkit-scrollbar {
    width: 0;
    height: 0;
}

/* 5. é•¿æ¡æ”¶æ®æ ·å¼ (æ ¸å¿ƒè§†è§‰) */
.industrial-receipt {
    background: #fff;
    border: 2px solid #000;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 8px 8px 0 rgba(0,0,0,0.15); /* ç¡¬æœ—çš„é˜´å½± */
    position: relative;
}

/* æ”¶æ®å†…çš„è¡Œå¸ƒå±€ */
.receipt-row {
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
    margin-bottom: 15px; 
    padding-bottom: 10px; 
    border-bottom: 1px solid #eee;
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* å­—ä½“è¾…åŠ©ç±» (é˜²æ­¢ä½ æ²¡æœ‰å®šä¹‰) */
.cinzel-font {
    font-family: 'Cinzel', serif; /* å¦‚æœæ²¡æœ‰å¼•å…¥ Cinzelï¼Œä¼šå›é€€åˆ° serif */
    font-weight: 900;
}
/* --- ğŸ–‹ï¸ æ•…äº‹æ¨¡å¼ä¸“ç”¨æ ·å¼ (Story Mode) --- */

/* æ•…äº‹æ–‡æœ¬æ’ç‰ˆï¼šæ•£æ–‡é£ */
.story-prose-text {
    font-family: "Songti SC", "SimSun", serif; /* å®‹ä½“æ›´é€‚åˆæ•£æ–‡ */
    font-size: 15px;
    line-height: 2.2; /* å®½è¡Œé«˜ï¼Œå‘¼å¸æ„Ÿ */
    text-align: justify;
    color: #222;
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
    letter-spacing: 1px;
}

/* å¼¹çª—æ ‡é¢˜ä¿®é¥° */
.story-header-title {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 24px;
    border-bottom: 2px solid #000;
    padding-bottom: 15px;
    margin-bottom: 20px;
    text-align: center;
}

/* --- â³ AI ç”Ÿæˆæ—¶çš„åŠ è½½åŠ¨ç”» --- */
.ai-generating-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    text-align: center;
}

.scan-bar-anim {
    width: 100%;
    height: 2px;
    background: #000;
    animation: scanMove 1.5s infinite ease-in-out;
    margin-bottom: 20px;
}

.loading-log {
    font-family: monospace;
    font-size: 10px;
    color: #666;
    margin-top: 5px;
}

@keyframes scanMove {
    0% { transform: scaleX(0); opacity: 0; }
    50% { transform: scaleX(1); opacity: 1; }
    100% { transform: scaleX(0); opacity: 0; }
}

/* æ·¡å…¥åŠ¨ç”» */
.fade-in-text {
    animation: fadeIn 1s ease-out;
}

/* --- ğŸ´ æ— æ¡†å·¥ä¸šé£Â·é‡åˆ¶ç‰ˆ (Open Industrial) --- */

/* 1. å¼€æ”¾å¼æ¿å—å®¹å™¨ */
.open-section {
    background: #fff;
    margin-bottom: 0;
    padding-bottom: 20px;
}

/* 2. å¤´éƒ¨è®¾è®¡ï¼šå¤§ç¼–å· + æ ‡é¢˜ */
.open-header {
    display: flex;
    align-items: baseline;
    padding: 30px 20px 15px 20px;
    border-bottom: 4px solid #000; /* åªæœ‰ä¸€æ¡ç²—é»‘çº¿ */
}

.big-index {
    font-family: 'Cinzel', serif;
    font-size: 50px;
    font-weight: 900;
    color: #000;
    margin-right: 15px;
    line-height: 0.8;
    opacity: 0.1; /* è®©ç¼–å·æ·¡æ·¡åœ°æ˜¾ç¤ºåœ¨èƒŒæ™¯é‡Œ */
}

.header-text {
    flex: 1;
}

.ht-main {
    font-size: 18px;
    font-weight: 900;
    color: #000;
    letter-spacing: 1px;
}

.ht-sub {
    font-family: monospace;
    font-size: 9px;
    color: #666;
    margin-top: 2px;
    text-transform: uppercase;
}

/* 3. åˆ—è¡¨å®¹å™¨ */
.open-list-container {
    min-height: 80px;
    padding: 0; /* è´´è¾¹ */
}

/* ç©ºçŠ¶æ€å ä½å­— */
.empty-text-mark {
    padding: 40px;
    text-align: center;
    font-family: monospace;
    font-size: 10px;
    color: #ccc;
    letter-spacing: 1px;
}

/* 4. æŒ‰é’®è®¾è®¡ï¼šæç®€é»‘è‰²é€šæ  */
.minimal-black-btn {
    display: block;
    width: calc(100% - 40px); /* å·¦å³ç•™ä¸€ç‚¹è¾¹è·ï¼Œæˆ–è€… width: 100% å…¨é€šæ ä¹Ÿå¯ä»¥ */
    margin: 10px auto;
    background: #000;
    color: #fff;
    border: none;
    padding: 16px;
    font-family: 'Cinzel', serif;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 2px;
    text-align: left; /* æ–‡å­—é å·¦æ›´æœ‰ç»ˆç«¯æ„Ÿ */
    padding-left: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.minimal-black-btn:active {
    background: #333;
    transform: scale(0.99);
}

.blink-symbol {
    animation: blink 1s infinite;
    color: #fff;
    margin-right: 10px;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

/* 5. å·¨å¤§çš„åˆ†å‰²åŒºå— */
.giant-divider {
    height: 10px;
    background: repeating-linear-gradient(
        45deg,
        #f0f0f0,
        #f0f0f0 10px,
        #fff 10px,
        #fff 20px
    ); /* å·¥ä¸šæ–œçº¹åˆ†å‰² */
    border-top: 1px solid #000;
    border-bottom: 1px solid #000;
}

/* --- åˆ—è¡¨é¡¹çš„å…·ä½“æ ·å¼ (Row Styles) --- */

/* A. è§’è‰²è¡Œ (Avatar Row) */
.char-row-open {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee; /* æç»†çš„åˆ†å‰²çº¿ */
}

.char-img-open {
    width: 40px;
    height: 40px;
    background: #000;
    border-radius: 50%;
    margin-right: 15px;
    overflow: hidden;
}
.char-img-open img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); }

.char-info-open { flex: 1; }
.char-name-open { font-weight: bold; font-size: 14px; color: #000; }
.char-tag-open { font-size: 8px; font-family: monospace; background: #000; color: #fff; padding: 1px 4px; display: inline-block; margin-top: 2px; }

.char-money-open { font-family: 'Cinzel'; font-weight: 900; font-size: 16px; }

/* B. è´¦å•è¡Œ (Bill Row) */
.receipt-mode {
    background: #fff;
}
.bill-row-open {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px dashed #000; /* è™šçº¿åˆ†å‰² */
    font-family: monospace;
}
.bill-date-open { color: #666; font-size: 10px; width: 80px; }
.bill-desc-open { flex: 1; font-weight: bold; font-size: 12px; }
.bill-cost-open { font-family: 'Cinzel'; font-weight: 900; font-size: 14px; }
/* --- â™Ÿ å®ä½“æ—¥ç»“å•æ ·å¼ (Entity Daily) --- */

/* ä¸»é¡µåˆ—è¡¨é‡Œçš„å¡ç‰‡æ ·å¼ */
.entity-log-card {
    border-bottom: 1px solid #eee;
    padding: 20px;
    transition: background 0.2s;
}
.entity-log-card:last-child {
    border-bottom: none;
}
.entity-log-card:hover {
    background: #fafafa;
}

/* å¡ç‰‡å¤´éƒ¨ï¼šæ—¥æœŸä¸æ€»é¢ */
.elc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}
.elc-date {
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 16px;
    color: #000;
}
.elc-total {
    font-family: monospace;
    font-size: 12px;
    background: #000;
    color: #fff;
    padding: 2px 6px;
}

/* å…·ä½“çš„æ”¶æ”¯è¡Œ */
.elc-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 13px;
    line-height: 1.6;
    color: #333;
}
.elc-desc {
    flex: 1;
    padding-right: 15px;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½ï¼Œæ›´æœ‰è´¨æ„Ÿ */
}
.elc-amount {
    font-weight: bold;
    white-space: nowrap;
    font-family: 'Cinzel';
}
.elc-income { color: #000; } /* æ”¶å…¥é»‘è‰² */
.elc-expense { color: #666; } /* æ”¯å‡ºç°è‰² */

/* å¼¹çª—é‡Œçš„è½¬è´¦æ¡ç›® */
.transfer-item-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    border-bottom: 1px solid #eee;
    padding: 5px 0;
}
@keyframes popIn {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
#industrial-alert-modal button:active {
    background: #000 !important;
    color: #fff !important;
}
/* --- ğŸ¦ é‡‘åº“ä¸“ç”¨æ ·å¼ --- */

/* ç›–ç« åŠ¨ç”»å®¹å™¨ */
.stamp-box {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-15deg);
    pointer-events: none; /* ç›–ç« åä¸æŒ¡å­— */
    z-index: 10;
}

/* å°ç« æœ¬ä½“ */
.stamp-circle {
    width: 120px;
    height: 120px;
    border: 5px solid #d00; /* çº¢è‰²å°ç«  */
    border-radius: 50%;
    color: #d00;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Cinzel', serif;
    font-weight: 900;
    font-size: 18px;
    letter-spacing: 2px;
    opacity: 0; /* é»˜è®¤éšè— */
    transform: scale(2); /* é»˜è®¤æ”¾å¤§ */
    box-shadow: inset 0 0 0 2px #d00;
    background: rgba(221, 0, 0, 0.05);
}

/* ç›–ä¸‹å»çš„åŠ¨ç”»ç±» */
.stamp-active .stamp-circle {
    animation: stampDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

@keyframes stampDown {
    0% { opacity: 0; transform: scale(3); }
    100% { opacity: 0.8; transform: scale(1); }
}

/* è®°å½•åˆ—è¡¨é¡¹ */
.vault-log-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px dashed #eee;
}
.vl-date { font-size: 10px; color: #999; font-family: monospace; }
.vl-note { font-size: 12px; color: #333; margin-top: 2px; }
.vl-amount { font-family: 'Cinzel'; font-weight: 900; font-size: 14px; }
.vl-plus { color: #000; }
/* --- ğŸ¹ æç®€ç™½åº•å·¥ä¸šæŒ‰é’® (Minimal White Btn) --- */
.minimal-white-btn {
    /* ğŸ“¦ ç›’å­æ¨¡å‹ */
    background: #ffffff;       /* çº¯ç™½èƒŒæ™¯ */
    color: #000000;            /* çº¯é»‘æ–‡å­— */
    border: 2px solid #000;    /* æ ¸å¿ƒï¼š2px ç²—é»‘è¾¹æ¡† */
    padding: 16px 0;           /* ä¸Šä¸‹ç•™ç™½ï¼Œé«˜åº¦èˆ’é€‚ */
    width: 100%;               /* å¼ºåˆ¶æ’‘æ»¡å®¹å™¨ */
    box-sizing: border-box;    /* é˜²æ­¢ padding æ’‘å¤§å®½åº¦ */

    /* ğŸ”  å­—ä½“æ’ç‰ˆ */
    font-family: 'Cinzel', serif; /* ä½ çš„æ ‡å¿—æ€§å­—ä½“ */
    font-weight: 900;          /* æœ€ç²—å­—é‡ */
    font-size: 13px;
    letter-spacing: 2px;       /* å®½å­—é—´è·ï¼Œæ›´æœ‰é«˜çº§æ„Ÿ */
    text-transform: uppercase; /* å¼ºåˆ¶å¤§å†™ */
    text-align: center;

    /* ğŸ¨ äº¤äº’è´¨æ„Ÿ */
    cursor: pointer;
    transition: all 0.1s;      /* æé€Ÿå“åº”ï¼Œä¸æ‹–æ³¥å¸¦æ°´ */
    box-shadow: 4px 4px 0 rgba(0,0,0,0.1); /* ç¡¬æœ—çš„æŠ•å½±ï¼Œå¢åŠ åšåº¦æ„Ÿ */
    
    /* å¸ƒå±€ */
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px; /* å¦‚æœé‡Œé¢æœ‰å›¾æ ‡ï¼Œä¿æŒé—´è· */
}

/* ğŸ–±ï¸ æ‚¬åœçŠ¶æ€ (Hover) */
.minimal-white-btn:hover {
    background: #fcfcfc;       /* å¾®å¾®å˜ç° */
    box-shadow: 4px 4px 0 #000; /* æŠ•å½±å˜å…¨é»‘ï¼Œå¼ºè°ƒâ€œå¯ç‚¹å‡»â€ */
}

/* ğŸ‘‡ æŒ‰ä¸‹çŠ¶æ€ (Active - ç‰©ç†å›å¼¹) */
.minimal-white-btn:active {
    transform: translate(3px, 3px); /* å‘å³ä¸‹ä½ç§»ï¼Œæ¨¡æ‹ŸæŒ‰ä¸‹ */
    box-shadow: 1px 1px 0 #000;     /* æŠ•å½±ç¼©çŸ­ */
    background: #f0f0f0;
    border-color: #000;
}
/* --- ğŸ¦ å­˜é’±æ—¥è®°å¡ç‰‡ (Vault Diary Card) --- */
.vault-log-card {
    background: #fff;
    border: 2px solid #000;
    margin-bottom: 20px;
    padding: 0;
    box-shadow: 6px 6px 0 rgba(0,0,0,0.1);
    animation: slideUp 0.3s ease-out;
    position: relative;
}

/* å¡ç‰‡å¤´éƒ¨ï¼šæ—¥æœŸä¸é‡‘é¢ */
.vlc-header {
    background: #000;
    color: #fff;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: 'Cinzel', serif;
}

.vlc-date { font-size: 12px; letter-spacing: 1px; }
.vlc-amount { font-size: 16px; font-weight: 900; color: #4ade80; } /* ç»¿è‰²å¼ºè°ƒé‡‘é¢ */

/* å¡ç‰‡å†…å®¹ï¼šAI ç”Ÿæˆçš„æ•…äº‹ */
.vlc-body {
    padding: 20px 15px;
    font-size: 13px;
    line-height: 1.8;
    color: #333;
    text-align: justify;
    font-family: sans-serif;
    border-bottom: 1px dashed #ccc;
}

/* å¡ç‰‡åº•éƒ¨ï¼šè£…é¥°æ€§ç¼–å· */
.vlc-footer {
    padding: 8px 15px;
    font-size: 9px;
    color: #999;
    font-family: monospace;
    text-transform: uppercase;
    display: flex;
    justify-content: space-between;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* --- ğŸ“± SIM å¡æ§½æ ·å¼ --- */
.sim-scroll-wrapper {
    display: flex;
    overflow-x: auto;
    gap: 15px;
    padding: 10px 5px 20px 5px; /* åº•éƒ¨ç•™ç©ºé—´ç»™æŠ•å½± */
    scroll-snap-type: x mandatory;
}

/* Lune ä¸“å± SIM å¡è®¾è®¡ */
.lune-sim-card {
    flex: 0 0 160px; /* å›ºå®šå®½åº¦ */
    height: 240px;
    background: #000;
    border: 2px solid #fff;
    border-radius: 10px; /* ç¨å¾®åœ†è§’ */
    position: relative;
    padding: 15px;
    color: #fff;
    cursor: pointer;
    scroll-snap-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 5px 5px 0 rgba(0,0,0,0.2);
    overflow: hidden;
}

/* é€‰ä¸­çŠ¶æ€ */
.lune-sim-card.active {
    border: 3px solid #000;
    background: #fff;
    color: #000;
    transform: translateY(-5px);
    box-shadow: 8px 8px 0 rgba(0,0,0,0.8);
}

/* èŠ¯ç‰‡æ ·å¼ */
.sim-chip {
    width: 40px;
    height: 30px;
    /* ä¿®æ­£ç‚¹ï¼šå°† #fwd700 æ”¹ä¸º #ffd700 */
    background: linear-gradient(135deg, #d4af37 0%, #ffd700 100%); 
    border-radius: 4px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

/* é»‘ç™½é£æ ¼èŠ¯ç‰‡ (é€‰ä¸­æ€) */
.lune-sim-card.active .sim-chip {
    background: #000; 
    border: 1px solid #ccc;
}
.sim-chip::after {
    content: '';
    position: absolute;
    left: 0; top: 50%; width: 100%; height: 1px; background: rgba(0,0,0,0.2);
}
.sim-chip::before {
    content: '';
    position: absolute;
    left: 30%; top: 0; width: 1px; height: 100%; background: rgba(0,0,0,0.2);
}

/* å¡é¢æ–‡å­— */
.sim-number {
    font-family: 'Cinzel', monospace;
    font-size: 16px;
    font-weight: 900;
    letter-spacing: 1px;
    margin-bottom: 5px;
    word-break: break-all;
}
.sim-label { font-size: 8px; opacity: 0.6; font-family: monospace; }
.sim-bal {
    position: absolute;
    bottom: 15px;
    right: 15px;
    font-weight: bold;
    font-size: 18px;
}

/* é€‰å·çŸ©é˜µ */
.matrix-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.matrix-num-btn {
    background: #111;
    border: 1px solid #333;
    color: #0f0; /* é»‘å®¢ç»¿ */
    padding: 15px 5px;
    font-family: monospace;
    font-size: 14px;
    cursor: pointer;
    text-align: center;
}
.matrix-num-btn:active {
    background: #0f0;
    color: #000;
}

/* AI å¥—é¤å¡ç‰‡ */
.ai-plan-card {
    background: #fff;
    border: 2px solid #000;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
}
.ai-plan-card:hover {
    background: #000;
    color: #fff;
    transform: scale(1.02);
}
.plan-name { font-weight: 900; font-size: 14px; margin-bottom: 4px; }
.plan-price { float: right; font-family: 'Cinzel'; font-weight: bold; }
.plan-desc { font-size: 10px; opacity: 0.7; line-height: 1.4; margin-top: 5px; font-style: italic; }
/* --- âš ï¸ å±é™©/æ¬¡çº§æ“ä½œæŒ‰é’® (Danger Text Button) --- */
.danger-text-btn {
    background: transparent;    /* é€æ˜èƒŒæ™¯ */
    border: 1px dashed #333;    /* è™šçº¿è¾¹æ¡†ï¼Œåƒå¾…æ’•å¼€çš„å°æ¡ */
    color: #666;                /* é»˜è®¤æ·±ç°ï¼Œè¡¨ç¤ºéä¸»è¦æ“ä½œ */
    font-family: 'Montserrat', sans-serif; /* æœºæ¢°æ„Ÿå­—ä½“ */
    font-size: 10px;
    font-weight: 700;           /* åŠ ç²— */
    letter-spacing: 2px;        /* å­—é—´è·æ‹‰å¼€ */
    text-transform: uppercase;  /* å…¨å¤§å†™ */
    padding: 12px 0;            /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* é¡ºæ»‘åŠ¨ç”» */
    position: relative;
    overflow: hidden;
}

/* ğŸ–±ï¸ æ‚¬åœçŠ¶æ€ï¼šèµ›åšæ•…éšœçº¢ */
.danger-text-btn:hover {
    color: #ff3b30;             /* ç»å…¸çš„ç³»ç»Ÿè­¦å‘Šçº¢ */
    border-color: #ff3b30;      /* è¾¹æ¡†ä¹Ÿå˜çº¢ */
    background: rgba(255, 59, 48, 0.05); /* å¾®å¾®çš„çº¢è‰²èƒŒæ™¯å…‰ */
    letter-spacing: 4px;        /* æ–‡å­—å‘ä¸¤è¾¹å±•å¼€ï¼Œéå¸¸æœ‰ç§‘æŠ€æ„Ÿ */
    text-shadow: 0 0 5px rgba(255, 59, 48, 0.5); /* æ–‡å­—å‘å…‰ */
    box-shadow: inset 0 0 10px rgba(255, 59, 48, 0.1); /* å†…å‘å…‰ */
}

/* ğŸ–±ï¸ ç‚¹å‡»çŠ¶æ€ï¼šæ›´æ·±ä¸€ç‚¹ */
.danger-text-btn:active {
    transform: scale(0.98);
    opacity: 0.8;
}

/* âœ¨ è£…é¥°ï¼šå‰é¢çš„å°æ–¹å— */
.danger-text-btn::before {
    content: 'â– ';
    display: inline-block;
    font-size: 8px;
    margin-right: 5px;
    opacity: 0;
    transform: translateX(-10px);
    transition: all 0.3s;
}

.danger-text-btn:hover::before {
    opacity: 1;
    transform: translateX(0);
    color: #ff3b30;
}
/* =========================================
   ğŸ“± ç”µè¯å¡ç»ˆæç¾åŒ– (Cyberpunk SIM Card)
   ========================================= */

/* 1. å¡ç‰‡å®¹å™¨ï¼šé»‘å¡è´¨æ„Ÿ */
.lune-sim-card {
    /* å°ºå¯¸ä¸å¸ƒå±€ */
    flex: 0 0 170px; /* å›ºå®šå®½åº¦ï¼Œé˜²æ­¢æŒ¤å‹ */
    height: 260px;
    background: #111; /* å“‘å…‰é»‘èƒŒæ™¯ */
    border: 2px solid #333; /* æš—ç°è¾¹æ¡† */
    border-radius: 12px; /* åœ†è§’ */
    padding: 20px;
    margin: 10px; /* é—´è· */
    
    /* å®šä½ä¸ç‰¹æ•ˆ */
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer;
    overflow: hidden;
    
    /* é˜´å½±ï¼šè®©å¡ç‰‡æµ®èµ·æ¥ */
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

/* 2. é€‰ä¸­çŠ¶æ€ï¼šé«˜äº®ç™½è¾¹ + ä¸Šæµ® */
.lune-sim-card.active {
    background: #1a1a1a;
    border-color: #fff; /* é€‰ä¸­å˜ç™½è¾¹ */
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 30px rgba(0,0,0,0.6), 0 0 0 2px rgba(255,255,255,0.1);
    z-index: 10;
}

/* 3. è£…é¥°ï¼šå³ä¸Šè§’çš„â€œç¼ºå£â€æŠ˜è§’è®¾è®¡ */
.lune-sim-card::after {
    content: '';
    position: absolute;
    top: -20px;
    right: -20px;
    width: 40px;
    height: 40px;
    background: #333;
    transform: rotate(45deg);
    opacity: 0.5;
}
.lune-sim-card.active::after {
    background: #fff; /* é€‰ä¸­æ—¶æŠ˜è§’å˜ç™½ */
}

/* 4. èŠ¯ç‰‡ï¼šé»‘é‡‘ç”µè·¯é£æ ¼ */
.sim-chip {
    width: 48px;
    height: 36px;
    background: linear-gradient(135deg, #eebb55 0%, #d4af37 50%, #aa7722 100%); /* é‡‘è‰²æµå…‰ */
    border-radius: 6px;
    position: relative;
    border: 1px solid #8a6d3b;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.4);
    margin-bottom: 15px;
}

/* èŠ¯ç‰‡ä¸Šçš„ç”µè·¯çº¹ç† (çº¯CSSç”»çº¿) */
.sim-chip::before {
    content: ''; position: absolute;
    top: 50%; left: 0; width: 100%; height: 1px;
    background: rgba(0,0,0,0.25);
    box-shadow: 0 -9px 0 rgba(0,0,0,0.25), 0 9px 0 rgba(0,0,0,0.25);
}
.sim-chip::after {
    content: ''; position: absolute;
    left: 40%; top: 0; width: 1px; height: 100%;
    background: rgba(0,0,0,0.25);
    box-shadow: 15px 0 0 rgba(0,0,0,0.25);
}

/* 5. æ–‡å­—æ’ç‰ˆç¾åŒ– */
.sim-label {
    font-size: 9px;
    color: #666;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 2px;
}

.sim-number {
    font-family: 'Cinzel', serif; /* åªæœ‰æ•°å­—ç”¨è¿™ç§è¡¬çº¿ä½“ */
    font-size: 20px;
    font-weight: 900;
    color: #fff;
    letter-spacing: 1px;
    margin-bottom: 20px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    word-break: break-all;
}

/* 6. åº•éƒ¨ä¿¡æ¯æ  */
.sim-footer {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    border-top: 1px dashed #333; /* è™šçº¿åˆ†å‰² */
    padding-top: 10px;
}

.sim-plan-name {
    font-size: 9px;
    color: #888;
    background: #222;
    padding: 3px 6px;
    border-radius: 3px;
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.sim-bal {
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: #4ade80; /* è§å…‰ç»¿æ˜¾ç¤ºä½™é¢ */
}
/* --- ğŸ“  SIM å¡æµæ°´åˆ—è¡¨æ ·å¼ --- */

/* å•æ¡è®°å½• */
.sim-log-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px dashed #333; /* è™šçº¿åˆ†å‰²ï¼Œåƒæ‰“å°çº¸ */
    font-family: 'Montserrat', sans-serif;
    transition: background 0.2s;
}

.sim-log-item:hover {
    background: #111;
}

/* å·¦ä¾§ï¼šä¿¡æ¯ */
.sl-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.sl-type {
    font-size: 9px;
    font-weight: 700;
    color: #666;
    background: #222;
    padding: 2px 6px;
    border-radius: 2px;
    align-self: flex-start;
    font-family: monospace;
}

.sl-desc {
    font-size: 13px;
    color: #ddd;
    font-weight: 500;
}

.sl-date {
    font-size: 10px;
    color: #555;
}

/* å³ä¾§ï¼šé‡‘é¢ */
.sl-amount {
    font-family: 'Cinzel', serif;
    font-size: 16px;
    font-weight: 900;
    text-align: right;
}

/* ğŸŸ¢ å……å€¼ (Topup) ç»¿è‰² */
.sl-amount.plus {
    color: #4ade80;
    text-shadow: 0 0 5px rgba(74, 222, 128, 0.3);
}

/* ğŸ”´ æ¶ˆè´¹ (Plan) çº¢è‰² */
.sl-amount.minus {
    color: #ff3b30;
}

/* ç©ºçŠ¶æ€ */
.sim-log-empty {
    padding: 50px;
    text-align: center;
    color: #444;
    font-family: monospace;
    font-size: 12px;
}

/* --- SIM å¡åˆ—è¡¨å®¹å™¨ (æ¨ªå‘æ»‘åŠ¨) --- */
#sim-cards-list {
    display: flex;
    flex-direction: row;
    gap: 15px;
    overflow-x: auto;       /* æ¨ªå‘æ»šåŠ¨ */
    padding: 10px 5px;
    scroll-snap-type: x mandatory; /* å¸é™„æ•ˆæœ */
    scrollbar-width: none;  /* éšè—æ»šåŠ¨æ¡ */
    min-height: 180px;      /* ç»™å¡ç‰‡ç•™å¤Ÿé«˜åº¦ */
    align-items: center;
}

#sim-cards-list::-webkit-scrollbar {
    display: none;
}

/* --- SIM å¡åˆ—è¡¨å®¹å™¨ (æ¨ªå‘æ»‘åŠ¨) --- */
#sim-cards-list {
    display: flex;
    flex-direction: row;    /* å¼ºåˆ¶æ¨ªå‘ */
    flex-wrap: nowrap;      /* ç¦æ­¢æ¢è¡Œ */
    gap: 15px;              /* å¡ç‰‡é—´è· */
    overflow-x: auto;       /* å…è®¸æ¨ªå‘æ»‘åŠ¨ */
    padding: 10px 5px;
    scroll-snap-type: x mandatory; /* æ»‘åŠ¨å¸é™„ */
    scrollbar-width: none;  /* éšè—æ»šåŠ¨æ¡ */
    align-items: center;
    min-height: 180px;      /* ä¿è¯é«˜åº¦ */
}

/* éšè—æ»šåŠ¨æ¡ (Chrome/Safari) */
#sim-cards-list::-webkit-scrollbar {
    display: none;
}

/* --- SIM å¡ç‰‡æ ·å¼ --- */
.lune-sim-card {
    flex-shrink: 0;         /* ç¦æ­¢å‹ç¼©å®½åº¦ */
    width: 280px;           /* å›ºå®šå®½åº¦ */
    height: 160px;
    background: #0a0a0a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 15px;
    position: relative;
    scroll-snap-align: center; /* å±…ä¸­å¸é™„ */
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* é€‰ä¸­é«˜äº®çŠ¶æ€ */
.lune-sim-card.active {
    border-color: #fff;
    background: #141414;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.15);
    transform: scale(1.02); /* å¾®å¾®æ”¾å¤§ */
}

.sim-chip {
    width: 35px;
    height: 24px;
    background: linear-gradient(135deg, #ffd700, #b8860b);
    border-radius: 4px;
    margin-bottom: 5px;
    opacity: 0.9;
}
/* å¼ºåˆ¶é€šçŸ¥æ¡å±‚çº§æœ€é«˜ */
#lune-top-banner {
    z-index: 999999 !important; /* ç¡®ä¿æ¯”æ‰€æœ‰ modal éƒ½é«˜ */
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px); /* é»˜è®¤éšè—åœ¨ä¸Šé¢ */
    /* ... å…¶ä»–åŸæœ‰æ ·å¼ ... */
}

/* æ¿€æ´»çŠ¶æ€ */
#lune-top-banner.active {
    transform: translateX(-50%) translateY(0);
}
/* --- ğŸš€ LUNE ä¸“å±çµåŠ¨å²›å¼¹çª— (Top Banner) --- */
#lune-island-notification {
    position: fixed;
    top: -100px; /* é»˜è®¤è—åœ¨å±å¹•ä¸Šé¢ */
    left: 50%;
    transform: translateX(-50%);
    width: 92%;
    max-width: 380px;
    height: auto;
    min-height: 60px;
    background: rgba(15, 15, 15, 0.95); /* æ·±é»‘ç£¨ç ‚åº• */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 30px; /* èƒ¶å›Šåœ†è§’ */
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    z-index: 9999999 !important; /* ğŸ”¥ æ ¸å¼¹çº§å±‚çº§ï¼Œä¿è¯åœ¨æœ€é¡¶å±‚ */
    
    display: flex;
    align-items: center;
    padding: 12px 20px;
    gap: 15px;
    
    transition: top 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹æ€§ç‰©ç†åŠ¨ç”» */
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ï¼Œä¸æŒ¡æ“ä½œ */
}

/* æ¿€æ´»çŠ¶æ€ï¼šå¼¹ä¸‹æ¥ */
#lune-island-notification.active {
    top: 40px;
}

/* å›¾æ ‡åŒºåŸŸ */
.island-icon-box {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #34c759, #30b34a); /* æˆåŠŸçš„ç»¿è‰² */
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #fff;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
}

/* æ–‡å­—åŒºåŸŸ */
.island-text-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.island-title {
    color: #fff;
    font-family: 'Cinzel', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.island-desc {
    color: #aaa;
    font-size: 11px;
    margin-top: 2px;
    font-family: sans-serif;
}
/* è§’è‰² SIM å¡æ ·å¼ */
.char-sim-card {
    flex: 0 0 260px; /* å®½åº¦ */
    height: 140px;
    border: 1px solid rgba(0, 122, 255, 0.3);
    background: linear-gradient(135deg, rgba(0, 20, 40, 0.9), rgba(0, 0, 0, 0.95));
    border-radius: 12px;
    margin-right: 15px;
    padding: 15px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: 0.2s;
}

.char-sim-card:active { transform: scale(0.98); }

/* è£…é¥°çº¿ */
.char-sim-card::before {
    content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
    background: #007aff;
}

.csc-header {
    display: flex; justify-content: space-between; align-items: flex-start;
}
.csc-avatar {
    width: 32px; height: 32px; border-radius: 50%; object-fit: cover;
    border: 1px solid #007aff;
}
.csc-name { font-family: 'Cinzel'; font-size: 14px; color: #fff; }
.csc-role { font-size: 8px; color: #007aff; letter-spacing: 1px; }

.csc-number {
    font-family: 'Cinzel'; font-size: 18px; color: #fff; margin-top: 15px;
    text-shadow: 0 0 5px rgba(0, 122, 255, 0.5);
}

.csc-footer {
    position: absolute; bottom: 15px; left: 15px; right: 15px;
    display: flex; justify-content: space-between; align-items: flex-end;
}
.csc-bal-label { font-size: 8px; color: #666; }
.csc-balance { font-size: 14px; color: #007aff; font-weight: bold; }
/* =========================================
   ğŸ’  è§’è‰²ä¸“å±å……å€¼å¼¹çª— - ç‹¬ç«‹æ ·å¼ (Char Topup)
   ========================================= */

/* 1. ä¸“å±é®ç½© (å±‚çº§è®¾ä¸º 99999ï¼Œç¡®ä¿æœ€é¡¶å±‚) */
.char-topup-overlay {
    position: fixed;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(5, 5, 5, 0.92); /* æ¯”æ™®é€šå¼¹çª—æ›´é»‘ä¸€ç‚¹ */
    backdrop-filter: blur(12px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999 !important; /* ğŸ”¥ å¼ºåˆ¶æœ€é«˜å±‚çº§ */
    animation: ctFadeIn 0.2s ease-out;
}

/* 2. ä¸“å±å¼¹çª—ä¸»ä½“ */
.char-topup-box {
    background: #000000;
    width: 85%;
    max-width: 340px;
    border: 1px solid #333;
    /* æ ¸å¿ƒåŒºåˆ«ï¼šä¸“å±çš„æ·±è“å…‰æ™• */
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9), 0 0 0 1px rgba(0, 122, 255, 0.3);
    padding: 25px;
    position: relative;
    border-radius: 4px; /* ç¨å¾®ç¡¬æœ—ä¸€ç‚¹çš„åœ†è§’ */
    animation: ctScaleUp 0.3s cubic-bezier(0.19, 1, 0.22, 1);
}

/* 3. ä¸“å±å¤´éƒ¨ */
.char-topup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #333;
    padding-bottom: 15px;
    margin-bottom: 5px;
}

.ct-title-text {
    font-family: 'Cinzel', serif;
    font-weight: 800;
    color: #fff;
    font-size: 14px;
    letter-spacing: 2px;
}

.ct-close-btn {
    font-family: monospace;
    font-size: 24px;
    line-height: 1;
    color: #666;
    cursor: pointer;
    transition: 0.2s;
}
.ct-close-btn:hover { color: #fff; transform: rotate(90deg); }

/* 4. ä¸“å±å¤´åƒåŠ¨æ•ˆ */
#ct-avatar {
    transition: transform 0.5s ease-in-out;
    border: 2px solid #fff; 
    box-shadow: 0 0 15px rgba(255,255,255,0.2);
}
/* æ‚¬åœæ—¶ç¨å¾®æ”¾å¤§ */
.char-topup-box:hover #ct-avatar {
    transform: scale(1.05);
    border-color: #007aff;
    box-shadow: 0 0 20px rgba(0, 122, 255, 0.4);
}

/* 5. ä¸“å±è¾“å…¥æ¡† */
.ct-input-group {
    text-align: left;
    margin-top: 25px;
}

.ct-input-group label {
    display: block;
    font-size: 9px;
    color: #007aff; 
    font-family: monospace;
    margin-bottom: 8px;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.ct-input {
    width: 100%;
    background: #0a0a0a;
    border: 1px solid #333;
    color: #fff;
    padding: 15px;
    font-family: 'Cinzel', monospace;
    font-size: 24px;
    font-weight: bold;
    outline: none;
    text-align: center;
    transition: 0.3s;
}

.ct-input:focus {
    border-color: #007aff;
    background: #000;
    box-shadow: 0 0 25px rgba(0, 122, 255, 0.2);
}

/* 6. ä¸“å±æŒ‰é’® */
.ct-confirm-btn {
    width: 100%;
    padding: 16px;
    font-family: 'Montserrat', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    color: #fff;
    background: #007aff; /* çº¯è“èƒŒæ™¯ */
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
    margin-top: 20px;
}

.ct-confirm-btn:active {
    transform: scale(0.98);
    opacity: 0.8;
}

/* ç‹¬ç«‹åŠ¨ç”» */
@keyframes ctFadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes ctScaleUp { 
    from { transform: translateY(20px) scale(0.95); opacity: 0; } 
    to { transform: translateY(0) scale(1); opacity: 1; } 
}
/* --- ğŸ§¾ è´¦å•åˆ—è¡¨ (Receipt Mode) --- */
.receipt-mode {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.bill-item {
    background: #fff;
    color: #000;
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    position: relative;
    /* æ¨¡æ‹Ÿæ’•çº¸è¾¹ç¼˜æ•ˆæœ */
    clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 98% 98%, 96% 100%, 94% 98%, 92% 100%, 90% 98%, 88% 100%, 86% 98%, 84% 100%, 82% 98%, 80% 100%, 78% 98%, 76% 100%, 74% 98%, 72% 100%, 70% 98%, 68% 100%, 66% 98%, 64% 100%, 62% 98%, 60% 100%, 58% 98%, 56% 100%, 54% 98%, 52% 100%, 50% 98%, 48% 100%, 46% 98%, 44% 100%, 42% 98%, 40% 100%, 38% 98%, 36% 100%, 34% 98%, 32% 100%, 30% 98%, 28% 100%, 26% 98%, 24% 100%, 22% 98%, 20% 100%, 18% 98%, 16% 100%, 14% 98%, 12% 100%, 10% 98%, 8% 100%, 6% 98%, 4% 100%, 2% 98%, 0% 100%);
    cursor: pointer;
    transition: transform 0.2s;
}
.bill-item:active { transform: scale(0.98); }

.bill-row {
    display: flex; justify-content: space-between; align-items: center;
}
.bill-date { font-family: monospace; font-size: 10px; color: #666; letter-spacing: 1px; }
.bill-cost { font-family: 'Cinzel'; font-weight: 900; font-size: 16px; }
.bill-meta { font-size: 10px; color: #333; margin-top: 5px; display: flex; gap: 10px; }

/* =========================================
   ğŸ§¾ è´¦å•è¯¦æƒ…å¼¹çª— (Thermal Receipt Style)
   ========================================= */

/* 1. é®ç½©å±‚ï¼šç‰©ç†æœ€é«˜å±‚çº§ */
#modal-bill-detail.industrial-modal-overlay {
    z-index: 2000000 !important; /* ğŸ”¥ æµè§ˆå™¨å…è®¸çš„æœ€å¤§æ•´æ•°ï¼Œç»å¯¹ç½®é¡¶ */
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
}

/* 2. å¼¹çª—ä¸»ä½“ï¼šæ¨¡æ‹Ÿé•¿æ¡å°ç¥¨ */
#modal-bill-detail .industrial-modal-box {
    background: #f8f8f8; /* çƒ­æ•çº¸çš„ç°ç™½è‰² */
    width: 90%;
    max-width: 340px;
    padding: 0; /* å†…éƒ¨è‡ªå·±æ§åˆ¶ padding */
    border: none;
    border-radius: 2px;
    box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
    position: relative;
    color: #333;
    font-family: 'Courier New', Courier, monospace; /* æ‰“å°æœºå­—ä½“ */
    overflow: hidden;
    animation: receiptSlideUp 0.4s cubic-bezier(0.23, 1, 0.32, 1);
}

/* å°ç¥¨é¡¶éƒ¨çš„é”¯é½¿æ•ˆæœ (ç”¨ CSS ç”») */
#modal-bill-detail .industrial-modal-box::before {
    content: "";
    position: absolute;
    top: -5px; left: 0; width: 100%; height: 10px;
    background: linear-gradient(135deg, #f8f8f8 5px, transparent 0) 0 5px,
                linear-gradient(-135deg, #f8f8f8 5px, transparent 0) 0 5px;
    background-color: transparent;
    background-position: left bottom;
    background-repeat: repeat-x;
    background-size: 10px 10px;
}
/* å°ç¥¨åº•éƒ¨çš„é”¯é½¿æ•ˆæœ */
#modal-bill-detail .industrial-modal-box::after {
    content: "";
    position: absolute;
    bottom: -5px; left: 0; width: 100%; height: 10px;
    background: linear-gradient(45deg, #f8f8f8 5px, transparent 0) 0 5px,
                linear-gradient(-45deg, #f8f8f8 5px, transparent 0) 0 5px;
    background-color: transparent;
    background-position: left top;
    background-repeat: repeat-x;
    background-size: 10px 10px;
}

/* 3. å¤´éƒ¨åŒºåŸŸ */
.receipt-header-area {
    text-align: center;
    padding: 30px 20px 20px 20px;
    border-bottom: 2px dashed #ccc;
}

/* 4. å†…å®¹åˆ—è¡¨åŒºåŸŸ */
#bill-detail-content {
    padding: 20px;
    max-height: 50vh; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢å¤ªé•¿ */
    overflow-y: auto;
}

/* å•æ¡è®°å½•æ ·å¼ä¼˜åŒ– */
.log-detail-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dotted #e0e0e0;
}
.log-detail-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.log-left { flex: 1; padding-right: 10px; }
.log-right { text-align: right; min-width: 80px; }

/* 5. åº•éƒ¨æ€»è®¡ */
.receipt-footer-area {
    background: #eee;
    padding: 20px;
    border-top: 2px dashed #ccc;
}

/* åŠ¨ç”» */
@keyframes receiptSlideUp {
    from { transform: translateY(50px) scale(0.95); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
}
/* =========================================
   ğŸ“ é€šè¯å†…å®¹è¯¦æƒ…å¼¹çª— (Call Content Modal)
   ========================================= */

#modal-call-content {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    z-index: 30000000 !important; /* ğŸ”¥ è¦æ±‚çš„ 50ä¸‡å±‚çº§ */
    justify-content: center;
    align-items: center;
    font-family: 'Segoe UI', sans-serif;
}

.call-content-box {
    width: 90%;
    max-width: 400px;
    height: 80vh;
    background: #111;
    border: 1px solid #333;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 50px rgba(0, 122, 255, 0.1);
    position: relative;
    overflow: hidden;
}

/* å¤´éƒ¨ä¿¡æ¯ */
.cc-header {
    padding: 20px;
    border-bottom: 1px solid #222;
    background: #080808;
    z-index: 2;
}
.cc-caller-name {
    font-size: 18px; color: #fff; font-weight: bold; letter-spacing: 1px;
}
.cc-meta-row {
    display: flex; justify-content: space-between; margin-top: 5px;
    font-size: 10px; color: #666; font-family: monospace;
}

/* æ»šåŠ¨åŒºåŸŸ */
.cc-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #000;
    /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
    scrollbar-width: none; 
}
.cc-body::-webkit-scrollbar { display: none; }

/* --- ğŸ’¬ æ¨¡å¼A: èŠå¤©æ°”æ³¡ --- */
.chat-bubble-row {
    display: flex; margin-bottom: 15px; width: 100%;
}
.chat-bubble-row.left { justify-content: flex-start; }
.chat-bubble-row.right { justify-content: flex-end; }

.chat-bubble {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.5;
    position: relative;
}
.left .chat-bubble {
    background: #222; color: #ddd;
    border-bottom-left-radius: 2px;
}
.right .chat-bubble {
    background: #007aff; color: #fff;
    border-bottom-right-radius: 2px;
}
.bubble-name {
    font-size: 8px; color: #555; margin-bottom: 2px; text-transform: uppercase;
}
.right .bubble-name { text-align: right; color: rgba(255,255,255,0.6); }

/* --- ğŸ“ æ¨¡å¼B: éšç¬”/æœªæ¥æ—¥è®° --- */
.diary-text-layout {
    color: #ccc;
    font-size: 14px;
    line-height: 2.0; /* å®½æ¾è¡Œé«˜ */
    text-align: justify;
    font-family: 'Georgia', serif; /* è¡¬çº¿ä½“æ›´æœ‰æ–‡å­¦æ„Ÿ */
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
}
.diary-text-layout p { margin-bottom: 20px; } /* æ®µè½é—´è· */

/* --- ğŸ”„ åŠ è½½åŠ¨ç”»: ä¿¡å·è§£å¯† --- */
.decrypt-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #000;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 10;
}
.decrypt-text {
    color: #00ff00; font-family: monospace; font-size: 10px; margin-top: 10px;
}
.sound-wave {
    display: flex; gap: 3px; height: 30px; align-items: center;
}
.wave-bar {
    width: 3px; background: #00ff00;
    animation: waveAnim 1s infinite ease-in-out;
}
@keyframes waveAnim {
    0%, 100% { height: 5px; opacity: 0.5; }
    50% { height: 25px; opacity: 1; }
}

/* å…³é—­æŒ‰é’® */
.cc-close-btn {
    padding: 15px;
    text-align: center;
    background: #111;
    color: #fff;
    border-top: 1px solid #222;
    cursor: pointer;
    font-size: 12px;
    letter-spacing: 2px;
}
.cc-close-btn:active { background: #222; }
/* =========================================
   ğŸ“¨ æ¶ˆæ¯å‘é€åé¦ˆæ¸…å• (Message Sent Log)
   ========================================= */
#modal-reminder-sent {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    z-index: 20000; /* ä¸éœ€è¦å‡ åä¸‡ï¼Œå¤Ÿç”¨å°±è¡Œ */
    justify-content: center;
    align-items: center;
}

.sent-log-box {
    width: 85%; max-width: 360px;
    background: #fff;
    border: 2px solid #000;
    box-shadow: 10px 10px 0 rgba(0,0,0,0.2);
    padding: 0;
    animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.sent-header {
    background: #000; color: #fff; padding: 15px;
    font-family: 'Cinzel', serif; font-weight: bold;
    display: flex; justify-content: space-between; align-items: center;
}

.sent-list {
    padding: 15px;
    max-height: 60vh; overflow-y: auto;
    background: #f4f4f4;
}

.sent-item {
    display: flex; gap: 10px; margin-bottom: 12px;
}
.sent-avatar {
    width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ccc;
}
.sent-bubble {
    background: #fff; padding: 8px 12px; border-radius: 8px;
    font-size: 12px; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    max-width: 80%; line-height: 1.4;
}
.sent-card-preview {
    background: #000; color: #fff; padding: 10px; border-radius: 6px;
    font-size: 10px; margin-top: 5px; text-align: center;
}

.sent-close-btn {
    display: block; width: 100%; padding: 15px;
    background: #fff; border: none; border-top: 2px solid #000;
    font-weight: bold; cursor: pointer;
    text-transform: uppercase; letter-spacing: 1px;
}
.sent-close-btn:hover { background: #eee; }

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
/* Moments ä¸“ç”¨æ ·å¼è¡¥ä¸ */
.moments-header {
    padding: 15px 20px;
    background: #F2F2F7;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.moments-title {
    font-size: 28px;
    font-weight: 800;
    color: #1c1c1e;
    letter-spacing: -0.5px;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.moment-action-btn {
    width: 36px;
    height: 36px;
    background: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8e8e93;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: all 0.2s ease;
}

.moment-action-btn:active {
    transform: scale(0.9);
}

.moments-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 80px;
}

/* Echoes (Stories) æ ·å¼ - å‚ç›´èƒ¶å›Šè®¾è®¡ */
.stories-section {
    padding: 10px 0 20px 0;
}

.section-top {
    padding: 0 20px 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

.section-label {
    font-size: 17px;
    font-weight: 700;
    color: #1c1c1e;
}

.section-count {
    font-size: 12px;
    color: #007AFF;
    font-weight: 600;
}

.stories-container {
    display: flex;
    gap: 12px;
    padding: 0 20px;
    overflow-x: auto;
    scrollbar-width: none;
}

.stories-container::-webkit-scrollbar { display: none; }

.story-capsule {
    width: 85px;
    height: 125px;
    flex-shrink: 0;
    background: #fff;
    border-radius: 18px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    border: 1px solid rgba(255,255,255,0.8);
}

.story-preview-bg {
    position: absolute;
    inset: 0;
    background: #E5E5EA; /* é»˜è®¤ç° */
    background-size: cover;
    background-position: center;
}

.story-info {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.4));
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    padding-bottom: 12px;
    color: #fff;
}

.story-info span {
    font-size: 10px;
    font-weight: 600;
    opacity: 0.9;
}

.story-add-icon {
    width: 24px;
    height: 24px;
    background: #007AFF;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 6px;
    border: 2px solid #fff;
}

/* è®¿å®¢è®°å½•æ¡ */
.moments-trace-bar {
    margin: 0 20px 20px 20px;
    background: #fff;
    border-radius: 14px;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.02);
}

.trace-info {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 600;
    color: #1c1c1e;
}

.trace-avatars {
    flex: 1;
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
}

.trace-mini-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #fff;
    margin-left: -8px;
    background: #ddd;
}

/* ç©ºçŠ¶æ€æ ·å¼ */
.moments-empty-state {
    padding: 60px 40px;
    text-align: center;
}

.empty-icon-box {
    width: 80px;
    height: 80px;
    background: #fff;
    border-radius: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px auto;
    box-shadow: 0 10px 20px rgba(0,0,0,0.03);
}

.moments-empty-state h3 {
    font-size: 18px;
    color: #1c1c1e;
    margin-bottom: 8px;
}

.moments-empty-state p {
    font-size: 14px;
    color: #8e8e93;
    margin-bottom: 25px;
}

.empty-refresh-trigger {
    background: #007AFF;
    color: #fff;
    border: none;
    padding: 10px 24px;
    border-radius: 20px;
    font-size: 15px;
    font-weight: 600;
    transition: opacity 0.2s;
}

.empty-refresh-trigger:active { opacity: 0.7; }

/* =========================================
   ğŸ­ é©¬å¡é¾™è‰²ç³»ï¼šæˆ‘çš„ Echo èƒŒæ™¯æ¸²æŸ“
   ========================================= */

/* 1. æ ¸å¿ƒèƒŒæ™¯ï¼šæ¢¦å¹»é©¬å¡é¾™ä¸‰è‰²æ¸å˜ */
.story-capsule.me .story-preview-bg {
    /* ç§»é™¤é»˜è®¤çš„ç°è‰² */
    background-color: transparent;

    /* é‡‡ç”¨ 135åº¦æ–œå‘çº¿æ€§æ¸å˜ï¼Œèåˆä¸‰ç§æŸ”å’Œè‰²è°ƒ */
    background-image: linear-gradient(
        135deg,
        #FFD1FF 0%,   /* èµ·å§‹ï¼šæŸ”é›¾ç²‰ (Soft Pink) */
        #FAD0C4 45%,  /* ä¸­é—´ï¼šå¥¶æ²¹èœœæ¡ƒ (Creamy Peach) */
        #D4FFEC 100%  /* ç»“æŸï¼šæ¸…æ–°è–„è· (Fresh Mint) */
    );
    
    /* å¢åŠ ä¸€ç‚¹ç‚¹é¥±å’Œåº¦ï¼Œè®©é¢œè‰²æ›´â€œç”œâ€ */
    filter: saturate(110%);
}

/* 2. é…å¥—ä¼˜åŒ–ï¼šè°ƒæ•´å‰æ™¯é®ç½©çš„é¢œè‰² */
/* åŸæœ¬çš„é»‘è‰²é®ç½©åœ¨é©¬å¡é¾™èƒŒæ™¯ä¸Šä¼šæ˜¾å¾—å¤ªè„ï¼Œæ”¹æˆå¸¦ç´«è°ƒçš„é€æ˜é®ç½©æ›´å¥½çœ‹ */
.story-capsule.me .story-info {
    background: linear-gradient(
        to bottom, 
        transparent 50%, 
        rgba(151, 139, 197, 0.3) /* æ·¡æ·¡çš„ç´«è°ƒé®ç½© */
    ) !important; /* ä½¿ç”¨ important è¦†ç›–æ‰é€šç”¨çš„æ ·å¼ */
}

/* 3. é…å¥—ä¼˜åŒ–ï¼šè®© "+" å·å›¾æ ‡ä¹Ÿæ›´æœ‰è´¨æ„Ÿ */
.story-capsule.me .story-add-icon {
    /* ç»™è“è‰²æŒ‰é’®ä¹ŸåŠ ä¸ªå¾®æ¸å˜ï¼Œå‘¼åº”æ•´ä½“é£æ ¼ */
    background: linear-gradient(135deg, #007AFF, #5AC8FA) !important;
    /* è¾¹æ¡†ç¨å¾®é€æ˜ä¸€ç‚¹ï¼ŒèåˆèƒŒæ™¯ */
    border-color: rgba(255, 255, 255, 0.7) !important;
    box-shadow: 0 2px 6px rgba(90, 200, 250, 0.3); /* åŠ ä¸€ç‚¹è“è‰²è¾‰å…‰ */
}
/* è§’è‰²å¤´åƒåœ¨å¡ç‰‡ä¸­å¿ƒç¨å¾®åä¸Šçš„ä½ç½® */
.story-char-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    position: absolute;
    top: 35%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 2.5px solid #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 2;
}

/* åŠ¨æ€æœªè¯»çŠ¶æ€çš„å½©è‰²åœ†ç¯ */
.story-ring-status {
    position: absolute;
    top: 35%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: 2px solid transparent;
    /* å•†ç”¨çº§æ¸å˜ï¼šç²‰è“æ©™ä¸‰è‰² */
    background-image: linear-gradient(#fff, #fff), 
                      linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    background-origin: border-box;
    background-clip: content-box, border-box;
    z-index: 1;
}

/* è§’è‰²åå­—çš„æ–‡å­—æ ·å¼ä¼˜åŒ– */
.story-info span {
    font-size: 11px;
    font-weight: 700;
    text-shadow: 0 1px 4px rgba(0,0,0,0.3);
    max-width: 75px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
/* ç¤¾äº¤æ•°æ®ä¸­å¿ƒå®¹å™¨ */
.moments-data-dashboard {
    margin: 0 16px 20px 16px;
    background: #fff;
    border-radius: 20px;
    padding: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
}

/* å››ä¸ªå…¥å£æŒ‰é’®çš„ç½‘æ ¼ */
.data-entry-grid {
    display: flex;
    justify-content: space-between;
    padding-bottom: 16px;
    margin-bottom: 16px;
    border-bottom: 0.5px solid #F2F2F7;
}

.data-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    flex: 1;
}

.data-icon {
    width: 42px;
    height: 42px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

.data-item span {
    font-size: 11px;
    font-weight: 700;
    color: #3A3A3C;
}

.data-item:active .data-icon {
    transform: scale(0.9);
}

/* è®¿å®¢æ¡æ•´åˆæ ·å¼ */
.moments-trace-bar {
    display: flex;
    align-items: center;
    gap: 10px;
}

.trace-info {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 700;
    color: #1c1c1e;
}

.trace-count {
    font-size: 12px;
    color: #8E8E93;
    font-weight: 600;
}

.trace-avatars {
    flex: 1;
    display: flex;
    flex-direction: row-reverse; /* å¤´åƒä»å³å¾€å·¦å †å  */
    justify-content: flex-end;
}
/* ==========================================
   ğŸ’ Moments Card: Modernist Fluid UI
   ========================================== */

/* 1. åŸºç¡€å¡ç‰‡å®¹å™¨ */
.modern-card {
    margin: 25px 16px;
    background: #fff;
    border-radius: 38px; /* æè‡´å¤§åœ†è§’ */
    padding: 24px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.04);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    position: relative;
    transition: transform 0.3s ease;
}

/* 2. å¤´éƒ¨ç”¨æˆ·ä¿¡æ¯åŒº */
.m-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.m-user-box {
    display: flex;
    align-items: center;
    gap: 14px;
}

/* æ–¹åœ†å½¢å¤´åƒæ¡† */
.m-avatar-wrapper {
    width: 52px;
    height: 52px;
    border-radius: 20px;
    padding: 2px;
    background: linear-gradient(135deg, #f2f2f7, #d1d1d6);
    position: relative;
    flex-shrink: 0;
}

.m-avatar {
    width: 100%;
    height: 100%;
    border-radius: 18px;
    object-fit: cover;
    border: 2px solid #fff;
}

/* æ—¶é—´æ—¥æœŸä¸æ ‡ç­¾ */
.m-time-stamp {
    font-size: 11px;
    color: #8e8e93;
    font-weight: 600;
    letter-spacing: 0.3px;
    margin-top: 2px;
}

.m-location-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #F2F2F7;
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 800;
    color: #007AFF;
    margin-top: 6px;
}

/* 3. å›¾åƒä¸åª’ä½“å±•ç¤º */
.m-img-wrapper {
    position: relative;
    margin-bottom: 20px;
    border-radius: 30px;
    overflow: hidden;
    background: #f8f8f8;
}

.m-img-single {
    width: 100%;
    height: 420px;
    object-fit: cover;
    display: block;
}

/* å¤šå›¾ç½‘æ ¼ (1å¤§2å°éå¯¹ç§°) */
.m-grid-multi {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 200px 120px;
    gap: 12px;
    margin-bottom: 20px;
}

.m-grid-main { grid-column: span 2; width: 100%; height: 100%; object-fit: cover; border-radius: 28px; }
.m-grid-sub { width: 100%; height: 100%; object-fit: cover; border-radius: 24px; }

.m-type-badge {
    position: absolute;
    bottom: 15px;
    left: 15px;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    padding: 6px 12px;
    border-radius: 14px;
    color: #fff;
    font-size: 10px;
    font-weight: 900;
    text-transform: uppercase;
}

/* 4. éŸ³ä¹/æ°›å›´ç»„ä»¶ */
.m-ambient-box {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #1c1c1e; /* çº¯é»‘è´¨æ„Ÿ */
    color: #fff;
    padding: 10px 16px;
    border-radius: 20px;
    margin-bottom: 18px;
}

.m-music-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    font-weight: 600;
}

/* è·³åŠ¨éŸ³è½¨åŠ¨ç”» */
.m-visualizer {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 12px;
}

.m-v-bar {
    width: 2px;
    background: #fff;
    border-radius: 1px;
}

/* 5. ç¤¾äº¤å †å åŒº */
.m-social-stack {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding-left: 5px;
}

.m-stack-avatars {
    display: flex;
    margin-right: 10px;
}

.m-stack-img {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #fff;
    margin-left: -6px;
    background: #eee;
}

.m-stack-text {
    font-size: 11px;
    color: #8e8e93;
    font-weight: 500;
}

/* 6. åº•éƒ¨äº¤äº’æ¡ (åº•è‰²èƒ¶å›Š) */
.m-action-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f2f2f7;
    border-radius: 24px;
    padding: 12px 20px;
}

.m-interaction-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #1c1c1e;
    cursor: pointer;
    transition: opacity 0.2s;
}

.m-interaction-item:active { opacity: 0.5; }
.m-interaction-item span { font-size: 13px; font-weight: 800; }

/* åŠ¨ç”»å®šä¹‰ */
@keyframes music-bars {
    0% { height: 4px; }
    100% { height: 12px; }
}
.data-item { position: relative; } /* å¿…é¡»è®¾ä¸ºç›¸å¯¹å®šä½ */
.badge-count {
    position: absolute;
    top: -5px; right: 5px;
    background: #FF3B30; /* è‹¹æœçº¢ */
    color: white;
    font-size: 10px;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 10px;
    border: 2px solid #fff;
    display: none; /* é»˜è®¤éšè— */
}
/* --- ğŸ’ çº¯å‡€ç‰ˆï¼šé™æ­¢é€æ˜æ¶²æ€ç»ç’ƒæ ·å¼ --- */

/* ç»„ä»¶ä¸»å®¹å™¨ */
.widget-liquid {
    grid-column: span 4;  /* å æ»¡æ¨ªå‘4æ ¼ */
    
    /* ğŸ‘‡ è¿™ä¸€è¡Œå†³å®šäº†å®ƒåœ¨ç¬¬å‡ è¡Œï¼ */
    /* 1 / span 2 æ„æ€å°±æ˜¯ï¼šå¼ºåˆ¶é”æ­»åœ¨ç¬¬ 1 è¡Œå¼€å§‹ï¼Œé«˜åº¦å  2 è¡Œ */
    grid-row: 1 / span 2; 
    
    position: relative;
    border-radius: 28px;
    overflow: hidden;

    /* ğŸ‘‡ ä¿®æ­£äº†è¿™é‡Œï¼šå¦‚æœä½ æƒ³ç´§è´´é¡¶éƒ¨ï¼Œå°±å†™ 0ï¼›å¦‚æœæƒ³å¾€ä¸‹æŒªä¸€ç‚¹ï¼Œå°±å†™ 20px */
    margin-top: 0; 
    
    /* âœ¨ æ ¸å¿ƒï¼šé™æ€é€æ˜èƒŒæ™¯ + å¼ºåŠ›ç£¨ç ‚ */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(30px) saturate(110%);
    -webkit-backdrop-filter: blur(30px) saturate(110%);
    
    /* âœ¨ æ ¸å¿ƒï¼šç»ç’ƒè´¨æ„Ÿè¾¹æ¡† */
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 
        0 20px 40px rgba(0,0,0,0.08),
        inset 0 0 20px rgba(255,255,255,0.2);
    
    display: flex;
    flex-direction: column;
    padding: 20px;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.widget-liquid:active {
    transform: scale(0.98); /* ç‚¹å‡»æ—¶çš„å¾®ç¼©åé¦ˆ */
}

/* å†…å®¹å±‚å¸ƒå±€ */
.wl-content {
    position: relative;
    z-index: 2;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

/* é¡¶éƒ¨ä¸ªäººä¿¡æ¯åŒº */
.wl-header {
    display: flex;
    align-items: center;
    gap: 18px;
}

.wl-avatar {
    width: 58px;
    height: 58px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(255,255,255,0.9);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    cursor: pointer;
}

.wl-text-box {
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.wl-name {
    font-family: 'Times New Roman', serif; /* é«˜çº§è¡¬çº¿ä½“ */
    font-size: 22px;
    font-weight: 700;
    color: #1a1a1a; 
    letter-spacing: 0.5px;
    cursor: pointer;
}

.wl-sign {
    font-family: sans-serif;
    font-size: 12px;
    color: #4a5568;
    opacity: 0.9;
    margin-top: 4px;
    font-weight: 500;
    /* é€šé€çš„æ ‡ç­¾èƒŒæ™¯ */
    background: rgba(255,255,255,0.3);
    padding: 4px 8px;
    border-radius: 12px;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.2);
    cursor: pointer;
}

/* åº•éƒ¨å›¾ç‰‡å±•ç¤ºåŒº */
.wl-gallery {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3ç­‰åˆ† */
    gap: 12px;
    margin-top: 10px;
}

.wl-img-box {
    width: 100%;
    aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.6);
    cursor: pointer;
}

.wl-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.wl-img-box:hover .wl-img {
    transform: scale(1.15); /* æ‚¬åœæ”¾å¤§æ•ˆæœ */
}
/* --- âœ¨ ç¼–è¾‘å™¨å¼¹çª—æ ·å¼ --- */
.editor-modal {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.4); /* èƒŒæ™¯é®ç½© */
    backdrop-filter: blur(8px);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.2s ease;
}

.editor-content {
    width: 80%;
    max-width: 320px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.editor-content h3 {
    margin: 0;
    text-align: center;
    color: #333;
    font-size: 18px;
}

.editor-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 12px;
    font-size: 16px;
    outline: none;
    box-sizing: border-box;
    transition: border 0.2s;
}
.editor-input:focus {
    border-color: #007AFF;
}

/* æŒ‰é’®ç»„ */
.editor-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
.editor-buttons button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
.btn-cancel { background: #f2f2f7; color: #000; }
.btn-save { background: #007AFF; color: #fff; }

/* Tab åˆ‡æ¢æ ·å¼ */
.tab-group {
    display: flex;
    margin-bottom: 12px;
    background: #eee;
    padding: 2px;
    border-radius: 8px;
}
.tab-btn {
    flex: 1;
    padding: 6px;
    border: none;
    background: transparent;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
}
.tab-btn.active {
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.file-upload-btn {
    display: inline-block;
    padding: 10px 20px;
    background: #34c759;
    color: white;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
/* --- ğŸ–‹ï¸ Lost & Found V2 æ¡†æ¶æ ·å¼ --- */

/* å…¨å±å®¹å™¨ */
#app-lost-found-v2 {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: #f7f7fa; /* é«˜çº§ç°ç™½åº• */
    z-index: 99999;
    display: flex;
    flex-direction: column;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: #333;
}

/* --- é¡¶éƒ¨å¯¼èˆªæ  (é€‚é…çŠ¶æ€æ ç‰ˆ) --- */
.lf-v2-nav {
    /* ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šå¢åŠ é«˜åº¦å’Œé¡¶éƒ¨å†…è¾¹è· */
    height: 100px;          /* æ€»é«˜åº¦å¢åŠ  (44pxçŠ¶æ€æ  + 56pxå¯¼èˆªæ ) */
    padding-top: 44px;      /* é¿å¼€åˆ˜æµ·/çŠ¶æ€æ åŒºåŸŸ */
    box-sizing: border-box; /* ç¡®ä¿ padding å«åœ¨é«˜åº¦å†… */
    
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-left: 20px;     /* å·¦å³è¾¹è·ä¿æŒä¸å˜ */
    padding-right: 20px;
    
    position: sticky; 
    top: 0; 
    z-index: 100;
}
.lf-v2-logo {
    font-family: 'Times New Roman', serif;
    font-size: 20px; font-weight: 800; color: #000;
}
.lf-v2-close {
    width: 32px; height: 32px; background: #f0f0f2;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 18px; color: #666;
}

/* å†…å®¹æ»šåŠ¨åŒº */
.lf-v2-main {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 90px; /* åº•éƒ¨ç•™ç™½ç»™Tabæ  */
}

/* é¡µé¢åˆ‡æ¢é€»è¾‘ */
.lf-v2-page { display: none; padding: 20px; }
/* ä¿®æ”¹é¡µé¢æ¿€æ´»æ—¶çš„æ ·å¼ */
.lf-v2-page.active { 
    display: block; 
    /* ğŸ‘‡ è¿™é‡Œçš„åŠ¨ç”»æ—¶é—´å¯ä»¥ç¨å¾®æ”¹çŸ­ä¸€ç‚¹ç‚¹ï¼Œæ›´å¹²è„† */
    animation: lf-fadeIn 0.2s ease; 
}

/* ğŸ‘‡ ä¿®æ”¹åŠ¨ç”»å…³é”®å¸§ï¼šå»æ‰ transformï¼Œåªä¿ç•™ opacity */
@keyframes lf-fadeIn { 
    from { 
        opacity: 0; 
        /* transform: translateY(10px);  <-- æŠŠè¿™ä¸€è¡Œåˆ æ‰ï¼å°±æ˜¯å®ƒåœ¨æ£ä¹±ï¼ */
    } 
    to { 
        opacity: 1; 
        /* transform: translateY(0);     <-- è¿™ä¸€è¡Œä¹Ÿåˆ æ‰ï¼ */
    } 
}

/* é€šç”¨æ ‡é¢˜æ ·å¼ */
.lf-v2-section-title {
    font-size: 18px; font-weight: 700; margin-bottom: 16px;
    font-family: 'Songti SC', serif;
}

/* åº•éƒ¨ Tab æ  (æ‚¬æµ®) */
.lf-v2-tabbar {
    position: absolute; bottom: 20px; left: 20px; right: 20px;
    height: 64px;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    display: flex; justify-content: space-around; align-items: center;
    z-index: 200;
}
.lf-v2-tab-item {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    color: #ccc; cursor: pointer; transition: 0.2s; width: 60px;
}
.lf-v2-tab-item.active { color: #000; transform: translateY(-2px); }
.lf-v2-tab-icon svg { width: 24px; height: 24px; }
.lf-v2-tab-dot {
    width: 4px; height: 4px; background: #000; border-radius: 50%;
    opacity: 0; transition: 0.2s;
}
.lf-v2-tab-item.active .lf-v2-tab-dot { opacity: 1; }

/* --- âœï¸ åˆ›ä½œä¸­å¿ƒä¸“å±æ ·å¼ (æœ€ç»ˆç‰ˆ) --- */
.lf-studio-header {
    display: flex; justify-content: space-between; align-items: flex-end;
    margin-bottom: 24px; padding-top: 10px;
}
.lf-studio-title {
    font-family: 'Songti SC', serif; font-size: 28px; font-weight: 700; color: #000;
}
/* ä»ªè¡¨ç›˜ */
.lf-studio-stats {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
    margin-bottom: 30px;
}
.lf-stat-card {
    background: #fff; padding: 16px; border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    border: 1px solid rgba(0,0,0,0.02);
}
.lf-stat-num { font-size: 22px; font-weight: 800; color: #000; margin-bottom: 4px; font-family: -apple-system; }
.lf-stat-label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }

/* åˆ—è¡¨å®¹å™¨ */
.lf-draft-list { display: flex; flex-direction: column; gap: 16px; padding-bottom: 100px; }

/* ä½œå“å¡ç‰‡ */
.lf-draft-card {
    background: #fff; border-radius: 16px; padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative; cursor: pointer; overflow: hidden;
}
.lf-draft-card:active { transform: scale(0.98); }

/* âœ¨ å®Œç»“çŠ¶æ€ç‰¹æœ‰æ ·å¼ âœ¨ */
.lf-draft-card.lf-is-completed {
    border: 1px solid #d4af37; /* æš—é‡‘è‰²è¾¹æ¡† */
    background: #fffcf5; /* ææ·¡çš„æš–è‰²åº• */
}
.lf-draft-card.lf-is-completed::after {
    content: "FINISHED";
    position: absolute; right: -10px; top: 15px;
    font-size: 40px; font-weight: 900; color: rgba(212, 175, 55, 0.1); /* å·¨å¤§çš„æ°´å° */
    transform: rotate(15deg); pointer-events: none;
}

/* å¡ç‰‡å†…éƒ¨å¸ƒå±€ */
.lf-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.lf-draft-title { font-size: 16px; font-weight: 700; color: #333; z-index: 2; position: relative; }
.lf-draft-status {
    font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase;
}
/* è¿è½½ä¸­æ ‡ç­¾ */
.status-on { background: #f0f0f2; color: #666; }
/* å®Œç»“æ ‡ç­¾ */
.status-end { background: #d4af37; color: #fff; }

.lf-draft-info {
    font-size: 12px; color: #888; margin-bottom: 12px; font-family: monospace;
}

/* è¿›åº¦æ¡ */
.lf-progress-bg {
    height: 4px; background: #eee; border-radius: 2px; overflow: hidden; margin-top: 12px;
}
.lf-progress-bar {
    height: 100%; background: #000; border-radius: 2px;
}
.lf-is-completed .lf-progress-bar { background: #d4af37; } /* å®Œç»“å˜æˆé‡‘è‰²è¿›åº¦æ¡ */

/* æ‰¾åˆ°è¿™æ®µ CSS å¹¶ä¿®æ”¹ */
.lf-fab-create {
    /* ğŸ‘‡ 1. è¿™é‡Œçš„ absolute æ”¹æˆ fixed */
    position: fixed; 
    
    /* ğŸ‘‡ 2. è°ƒæ•´ä¸€ä¸‹ä½ç½®ï¼Œé˜²æ­¢è¢«åº•éƒ¨ Tab æ æŒ¡ä½ */
    bottom: 90px; 
    right: 24px;
    
    /* å…¶ä»–ä¿æŒä¸å˜ */
    width: 56px; height: 56px;
    background: #000; color: #fff;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    font-size: 28px; cursor: pointer;
    transition: transform 0.2s; 
    z-index: 999; /* ç¡®ä¿å±‚çº§æœ€é«˜ */
}
/* --- ğŸš€ Lost & Found: Genesis åˆ›ä½œå‘å¯¼æ ·å¼ --- */

/* å…¨å±å®¹å™¨ (é»˜è®¤éšè—) */
#lf-wizard-page {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: #f4f4f7; 
    z-index: 100000; /* æœ€é«˜å±‚çº§ */
    display: flex; flex-direction: column;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: #1a1a1a;
    overflow: hidden; /* ç¦æ­¢å®¹å™¨æœ¬èº«æ»šåŠ¨ */
    opacity: 0; pointer-events: none; transition: opacity 0.3s; /* æ¸éšæ¸æ˜¾ */
}
#lf-wizard-page.active {
    opacity: 1; pointer-events: auto;
}

/* --- é¡¶éƒ¨å¯¼èˆª (é€‚é…çŠ¶æ€æ ) --- */
.lfw-header {
    height: 100px; /* å¢åŠ é«˜åº¦ */
    padding-top: 44px; /* é¿å¼€çŠ¶æ€æ  */
    background: #fff; 
    border-bottom: 1px solid #eee;
    display: flex; align-items: center; justify-content: space-between;
    padding-left: 20px; padding-right: 20px;
    z-index: 10; box-sizing: border-box;
}
.lfw-back-btn { 
    cursor: pointer; padding: 8px; margin-left: -8px;
    display: flex; align-items: center; justify-content: center;
}
.lfw-title { font-family: 'Songti SC', serif; font-weight: 700; font-size: 16px; }
.lfw-create-btn {
    background: #e0e0e0; color: #fff; border: none; padding: 8px 20px;
    border-radius: 30px; font-size: 13px; font-weight: 600; cursor: not-allowed;
    transition: 0.3s;
}
.lfw-create-btn.ready {
    background: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
}

/* --- è¿›åº¦æ¡ --- */
.lfw-progress-track { width: 100%; height: 2px; background: #eee; position: relative; }
.lfw-progress-bar { 
    height: 100%; background: #000; width: 14%; /* åˆå§‹ 1/7 */
    transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

/* --- æ»‘åŠ¨è½¨é“ --- */
.lfw-track {
    display: flex; flex: 1; height: 100%;
    transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    width: 700vw; /* 7ä¸ªæ­¥éª¤ */
}

/* --- å•ä¸ªæ­¥éª¤é¡µ --- */
.lfw-step {
    width: 100vw; height: 100%; 
    overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
    padding: 24px; box-sizing: border-box;
    display: flex; flex-direction: column; align-items: center; 
}
.lfw-step-inner { width: 100%; max-width: 500px; padding-bottom: 100px; }

/* æ ‡é¢˜åŒº */
.lfw-step-header { margin-bottom: 30px; text-align: left; width: 100%; }
.lfw-step-num { font-size: 12px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; display: block; }
.lfw-step-title { font-size: 28px; font-weight: 800; color: #000; line-height: 1.2; font-family: 'Songti SC', serif; }
.lfw-step-desc { font-size: 14px; color: #666; margin-top: 8px; line-height: 1.5; }

/* é€šç”¨ç»„ä»¶ */
.lfw-card {
    background: #fff; border-radius: 16px; padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03);
    margin-bottom: 20px; transition: 0.3s; cursor: pointer;
}
.lfw-card.selected {
    background: #1a1a1a; color: #fff; border-color: #000;
}
.lfw-card.selected .lfw-sub-text { color: #888; }
.lfw-card.selected button { border-color: #555; color: #fff; }

.lfw-input {
    width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 12px;
    font-size: 15px; margin-bottom: 16px; box-sizing: border-box; outline: none; transition: border 0.3s;
}
.lfw-input:focus { border-color: #000; }

/* æŒ‰é’®ç»„ */
.lfw-btn-row { display: flex; gap: 12px; margin-top: 12px; }
.lfw-btn {
    flex: 1; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
    transition: 0.2s;
}
.lfw-btn-black { background: #000; color: #fff; border: 1px solid #000; }
.lfw-btn-outline { background: #fff; color: #000; border: 1px solid #ddd; }
.lfw-btn-outline:hover { border-color: #000; }

/* --- åº•éƒ¨æ‚¬æµ®æ“ä½œæ  --- */
.lfw-bottom-bar {
    position: fixed; bottom: 0; left: 0; width: 100vw;
    background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
    border-top: 1px solid #eee; padding: 16px 24px;
    display: flex; justify-content: flex-end;
    z-index: 100; box-sizing: border-box;
    transition: transform 0.3s; /* ç”¨äºéšè—/æ˜¾ç¤º */
}
.lfw-next-btn {
    background: #000; color: #fff; padding: 14px 32px; border-radius: 30px;
    font-size: 16px; font-weight: 600; border: none; cursor: pointer;
    display: flex; align-items: center; gap: 8px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}
.lfw-next-btn:active { transform: scale(0.98); }

/* SVG é€šç”¨ */
.lfw-icon { width: 18px; height: 18px; stroke-width: 2px; }

/* --- ç‰¹æ®Šç»„ä»¶ --- */
.lfw-title-tag {
    background: #fffcf0; border: 1px solid #e6dcc0; padding: 24px;
    text-align: center; border-radius: 8px; position: relative; margin-top: 20px;
}
.lfw-cp-card {
    display: flex; align-items: center; gap: 16px; padding: 16px;
    background: linear-gradient(135deg, #fff 0%, #fffbfb 100%);
}
.lfw-avatar { 
    width: 44px; height: 44px; border-radius: 50%; background: #eee; 
    border: 2px solid #fff; margin-right: -10px; display: flex; 
    align-items: center; justify-content: center; font-size: 12px; font-weight:bold;
}
.lfw-relation-box {
    height: 240px; background: #fff; border: 1px solid #eee; border-radius: 16px;
    position: relative; margin-bottom: 16px; overflow: hidden;
}
.lfw-node {
    width: 32px; height: 32px; background: #111; color: #fff; border-radius: 50%;
    position: absolute; display: flex; align-items: center; justify-content: center; font-size: 12px;
    z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.lfw-line {
    position: absolute; height: 1px; background: #ccc; z-index: 1; transform-origin: left center;
}
.lfw-slider-row { margin-bottom: 24px; }
.lfw-slider-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; font-weight: 600; }
.lfw-slider { width: 100%; accent-color: #000; height: 4px; }
/* --- æ–°å¢ï¼šä¸Šä¸€æ­¥æŒ‰é’®æ ·å¼ --- */
.lfw-prev-btn {
    background: #fff;      /* ç™½åº• */
    color: #000;           /* é»‘å­— */
    border: 1px solid #ddd;/* æµ…ç°è¾¹æ¡† */
    padding: 14px 24px;    /* å¤§å°å’Œä¸‹ä¸€æ­¥æŒ‰é’®å·®ä¸å¤š */
    border-radius: 30px;   /* åœ†è§’ */
    font-size: 16px; 
    font-weight: 600; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    gap: 8px;
    transition: 0.2s;
}

.lfw-prev-btn:active {
    background: #f0f0f0;   /* ç‚¹å‡»æ—¶å˜ç°ä¸€ç‚¹ */
    transform: scale(0.98);
}
/* --- Step 4 ä¸“å±æ ·å¼ --- */
.lfw-char-row {
    display: flex; gap: 12px; align-items: flex-start;
}
.lfw-avatar-lg {
    width: 60px; height: 60px; border-radius: 50%; 
    object-fit: cover; /* å…³é”®ï¼šä¸é™å¤§å°ï¼Œè‡ªåŠ¨è£å‰ª */
    border: 2px solid #eee; cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
}
.lfw-avatar-lg:hover {
    transform: scale(1.05);
    border-color: #000;
}
.lfw-bio-box {
    font-size: 12px; color: #555; line-height: 1.5;
    background: #f9f9f9; padding: 8px; border-radius: 6px;
    margin-top: 6px; font-family: 'Songti SC', serif;
    max-height: 100px; overflow-y: auto; /* é•¿æ–‡æ»šåŠ¨ */
}
/* --- Step 5 ä¸“å±æ ·å¼ --- */

/* ç”»å¸ƒå®¹å™¨ */
.lfw-relation-box {
    height: 300px; /* ç”»å¸ƒé«˜ä¸€ç‚¹ï¼Œå®¹çº³åœ†ç¯ */
    background: #fdfdfd; 
    border: 1px solid #eee; 
    border-radius: 16px;
    position: relative; 
    margin-bottom: 16px; 
    overflow: hidden;
}

/* èŠ‚ç‚¹ (å¤´åƒ) */
.lfw-graph-node {
    position: absolute;
    width: 40px; height: 40px;
    transform: translate(-50%, -50%); /* å±…ä¸­å®šä½ */
    z-index: 2;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    border: 2px solid #fff;
}
.lfw-graph-node img {
    width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
}
.lfw-graph-name {
    position: absolute;
    transform: translateX(-50%);
    font-size: 10px; font-weight: 700; color: #333;
    white-space: nowrap;
    text-shadow: 0 1px 2px #fff;
    z-index: 3;
}

/* çº¿æ¡æ ·å¼ */
.lfw-graph-line {
    position: absolute;
    height: 1px;
    background: #ccc; /* ç°è‰²çº¿ */
    z-index: 1;
    transform-origin: center center;
    pointer-events: none;
}

/* çº¿ä¸Šæ–‡å­—æ ‡ç­¾æ ·å¼ */
.lfw-graph-label {
    position: absolute;
    transform: translate(-50%, -50%);
    background: #fff;
    border: 1px solid #eee;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 9px;
    color: #666;
    z-index: 4;
    white-space: nowrap;
    pointer-events: none;
}

/* æ–‡å­—å¡ç‰‡åˆ—è¡¨ */
.lfw-rel-card {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}
.lfw-rel-head {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 6px;
}
.lfw-rel-avatar {
    width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #eee;
}
.lfw-rel-arrow {
    flex: 1; margin: 0 12px; display: flex; align-items: center; gap: 4px; color: #ddd; position: relative;
}
.lfw-rel-line { flex: 1; height: 1px; background: #eee; }
.lfw-rel-tag {
    position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
    font-size: 10px; color: #000; font-weight: 700;
}
.lfw-rel-names {
    display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: #555;
}
/* --- Step 6 ä¸“å±æ ·å¼ --- */

/* é¢å¤–èŠ‚ç‚¹ (ç©ºå¿ƒ) */
.lfw-graph-node.extra {
    background: #fff;
    border: 2px solid #ccc; /* ç°è‰²è¾¹æ¡† */
    color: #999;
    font-size: 14px;
    font-weight: 700;
    display: flex;
    align-items: center; 
    justify-content: center;
    box-shadow: none; /* å»æ‰é˜´å½±ï¼Œæ˜¾å¾—æ¬¡è¦ */
    z-index: 1; /* å±‚çº§æ¯”ä¸»è§’ä½ */
}

/* é¢å¤–èŠ‚ç‚¹çš„åå­— */
.lfw-graph-node.extra + .lfw-graph-name {
    color: #999; /* ç°è‰²å­— */
}

/* åˆ—è¡¨å¡ç‰‡å¾®è°ƒ */
.lf-draft-card {
    /* ä¿æŒåŸæœ‰æ ·å¼ */
    background: #fff; border-radius: 16px; padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.05);
    transition: transform 0.2s;
    margin-bottom: 16px; /* å¢åŠ é—´è· */
    cursor: pointer;
}

/* è¿›åº¦æ¡èƒŒæ™¯ä¼˜åŒ– */
.lf-progress-bg {
    height: 4px; 
    background: #f0f0f2; /* æµ…ç°åº•è‰² */
    border-radius: 2px; 
    overflow: hidden; 
    margin-top: 12px;
}

/* è¿›åº¦æ¡æœ¬ä½“ */
.lf-progress-bar {
    height: 100%; 
    background: #000; /* çº¯é»‘è¿›åº¦ */
    border-radius: 2px;
    transition: width 0.5s ease; /* å¢åŠ åŠ¨ç”» */
}
/* --- ğŸ¬ ä¹¦ç±æ§åˆ¶å°æ ·å¼ --- */
#lf-editor-dashboard {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: #fff; z-index: 200000; /* ç¡®ä¿å±‚çº§æœ€é«˜ */
    display: flex; flex-direction: column;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Songti SC", sans-serif;
    color: #1a1a1a;
    transform: translateX(100%); /* é»˜è®¤éšè—åœ¨å³ä¾§ */
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
#lf-editor-dashboard.active { transform: translateX(0); }

/* å¯¼èˆª */
/* --- ğŸ¬ ä¹¦ç±æ§åˆ¶å°å¯¼èˆªæ ä¿®å¤ --- */
.lfe-nav {
    /* 1. æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ é¡¶éƒ¨å†…è¾¹è· */
    /* 44px æ˜¯åŸºç¡€é«˜åº¦ï¼ŒåŠ ä¸Š env(...) ç¡®ä¿åœ¨æœ‰åˆ˜æµ·çš„ iPhone ä¸Šè‡ªåŠ¨é¿å¼€ */
    padding-top: calc(44px + env(safe-area-inset-top, 20px)) !important; 
    
    /* 2. ç›¸åº”å¢åŠ æ€»é«˜åº¦ï¼Œé˜²æ­¢å†…å®¹è¢«æŒ¤å‹ */
    height: auto !important; 
    min-height: 100px; 
    
    /* 3. ä¿æŒåŸæœ¬çš„å·¦å³å¯¹é½å’Œè¾¹æ¡† */
    padding-left: 20px; 
    padding-right: 20px;
    padding-bottom: 12px;
    background: rgba(255,255,255,0.98); 
    border-bottom: 1px solid #f5f5f5; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    z-index: 100;
    box-sizing: border-box; /* ç¡®ä¿é«˜åº¦è®¡ç®—åŒ…å« padding */
}

/* å¦‚æœä½ çš„è¿”å›æŒ‰é’®æˆ–å‘å¸ƒæŒ‰é’®ä½ç½®è¿˜æ˜¯å¤ªé ä¸Šï¼Œå¯ä»¥å¾®è°ƒå®ƒä»¬ */
.lfe-icon-btn, .lfe-pub-btn {
    margin-top: 5px; /* è¿™é‡Œå¯ä»¥æ ¹æ®è§†è§‰å¾®è°ƒ */
}
.lfe-icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; }
.lfe-icon-btn:active { background: #f5f5f5; }

/* å‘å¸ƒæŒ‰é’®çŠ¶æ€ */
.lfe-pub-btn {
    padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
    border: 1px solid transparent;
}
.lfe-pub-btn.draft { background: #000; color: #fff; }
.lfe-pub-btn.published { background: #fff; color: #000; border-color: #ddd; }
.lfe-pub-badge { width: 6px; height: 6px; border-radius: 50%; background: #4cd964; display: none; }
.lfe-pub-btn.published .lfe-pub-badge { display: block; }

/* å†…å®¹åŒº */
.lfe-scroll { flex: 1; overflow-y: auto; padding: 24px; }
.lfe-hero { display: flex; gap: 20px; margin-bottom: 30px; }

/* å°é¢ */
.lfe-cover-box {
    width: 110px; height: 154px; flex-shrink: 0;
    background: #f0f0f2; border-radius: 6px; overflow: hidden;
    position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    cursor: pointer; background-size: cover; background-position: center;
}
#lfe-cover-placeholder { width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#ccc; font-weight:700; font-size:10px; }
.lfe-cover-overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.4);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    opacity: 0; transition: 0.2s; color: #fff; font-size: 10px; font-weight: 700;
}
.lfe-cover-box:hover .lfe-cover-overlay { opacity: 1; }

/* ä¿¡æ¯ */
.lfe-meta-col { flex: 1; display: flex; flex-direction: column; }
.lfe-book-title {
    font-family: 'Songti SC', serif; font-size: 22px; font-weight: 900;
    line-height: 1.3; color: #000; margin-bottom: 8px; outline: none;
}
.lfe-synopsis-box {
    background: #fafafa; border-radius: 8px; padding: 12px;
    font-size: 13px; color: #555; line-height: 1.6;
    margin-bottom: 12px; position: relative; cursor: text;
    border: 1px solid transparent; transition: 0.2s;
}
.lfe-synopsis-box:hover { background: #fff; border-color: #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
.lfe-synopsis-text { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.lfe-edit-hint { position: absolute; right: 8px; bottom: 8px; opacity: 0; transition: 0.2s; }
.lfe-synopsis-box:hover .lfe-edit-hint { opacity: 0.5; }

/* æ ‡ç­¾ */
.lfe-tag-row { display: flex; gap: 8px; flex-wrap: wrap; }
.lfe-tag { font-size: 10px; color: #666; background: #fff; border: 1px solid #ddd; padding: 3px 8px; border-radius: 4px; }
.lfe-tag-add { border-style: dashed; cursor: pointer; color: #000; border-color: #999; }

/* è§’è‰²åŒº */
.lfe-section-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px; margin-top: 30px;
    padding-bottom: 8px; border-bottom: 1px solid #f5f5f5;
}
.lfe-sec-title { font-size: 12px; font-weight: 700; color: #000; letter-spacing: 1px; }
.lfe-sec-action { font-size: 10px; color: #999; display: flex; align-items: center; gap: 4px; }

.lfe-char-rail {
    display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px;
    margin: 0 -24px; padding-left: 24px; scrollbar-width: none;
}
.lfe-char-card { flex: 0 0 70px; display: flex; flex-direction: column; align-items: center; }
.lfe-char-img-box {
    width: 60px; height: 60px; border-radius: 50%; padding: 2px; border: 1px solid #eee;
    margin-bottom: 8px; position: relative;
}
.lfe-char-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.lfe-char-badge {
    position: absolute; bottom: 0; right: 0; background: #000; color: #fff;
    font-size: 9px; padding: 1px 4px; border-radius: 4px;
}
.lfe-char-name { font-size: 12px; font-weight: 600; color: #333; }
.lfe-char-role { font-size: 10px; color: #999; margin-top: 2px; }

/* æ‚¬æµ®æŒ‰é’® */
.lfe-fab {
    position: fixed; bottom: 30px; right: 24px;
    background: #000; color: #fff; width: 56px; height: 56px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s;
}
.lfe-fab:hover { transform: scale(1.05); }
.lfe-icon { width: 18px; height: 18px; stroke-width: 1.5px; }
/* --- ğŸ¬ Immersive Reader Styles (Scoped & Safe) --- */

/* 1. å°†å˜é‡å®šä¹‰ä¸‹æ²‰åˆ°å®¹å™¨ IDï¼Œä¸è§¦ç¢°å…¨å±€ :root */
#lf-immersive-container {
    /* --- Local Variables Definition --- */
    --lfw-bg: #f4f5f7;
    --lfw-me-bg: #111;
    --lfw-me-text: #fff;
    --lfw-other-bg: #fff;
    --lfw-other-text: #333;
    --lfw-accent: #1a1a1a;
    
    /* --- Base Layout --- */
    position: fixed; 
    top: 0; left: 0; 
    width: 100vw; height: 100vh;
    background: var(--lfw-bg); 
    z-index: 9999;
    display: flex; 
    flex-direction: column;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    box-sizing: border-box; /* ç¡®ä¿ç›’å­æ¨¡å‹ç»Ÿä¸€ */
}

/* é˜²æ­¢æ ·å¼å¤–æ³„ï¼Œæ‰€æœ‰é€‰æ‹©å™¨å‰ç¼€å»ºè®®åŠ ä¸Šçˆ¶çº§IDæƒé‡ (Optional but recommended) */
#lf-immersive-container * {
    box-sizing: border-box;
}

/* --- Header (Transparent) --- */
.lfw-header {
    padding: 50px 24px 20px 24px;
    background: transparent;
    display: flex; align-items: flex-start; gap: 16px;
    z-index: 100; pointer-events: none;
}
.lfw-header > * { pointer-events: auto; }

.lfw-cover-wrap {
    width: 60px; height: 60px; border-radius: 10px; flex-shrink: 0;
    overflow: hidden; 
    box-shadow: 0 8px 24px rgba(0,0,0,0.15); 
    border: 1px solid rgba(255,255,255,0.5); 
    background: #fff;
}
.lfw-cover-img { width: 100%; height: 100%; object-fit: cover; }

.lfw-info { flex: 1; display: flex; flex-direction: column; justify-content: center; height: 60px; }
.lfw-title { font-size: 18px; font-weight: 800; color: #1a1a1a; margin: 0 0 4px 0; text-shadow: 0 2px 10px rgba(255,255,255,0.5); }
.lfw-meta { font-size: 11px; color: #888; font-weight: 600; display: flex; align-items: center; gap: 6px; }
.lfw-tag { background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px; border: 1px solid #eee; }

/* --- Stage Area --- */
.lfw-stage {
    flex: 1; overflow-y: auto; 
    padding: 20px 24px 140px 24px;
    display: flex; flex-direction: column; gap: 28px;
    mask-image: linear-gradient(to bottom, transparent 0%, black 80px);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 80px);
}

/* --- Dialogue Rows --- */
.lfw-avatar {
    width: 40px; height: 40px; border-radius: 12px; object-fit: cover;
    border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0;
}
.lfw-bubble-wrap { display: flex; flex-direction: column; max-width: 68%; position: relative; }
.lfw-name { font-size: 10px; font-weight: 700; color: #999; margin-bottom: 4px; letter-spacing: 0.5px; }
.lfw-row.right .lfw-name { text-align: right; }

/* --- Film Deco (Sprockets) --- */
.lfw-film-deco {
    display: flex; flex-direction: column; gap: 3px; justify-content: center;
    padding-bottom: 6px; opacity: 0.3; min-width: 4px;
}
.lfw-sprocket { width: 4px; height: 4px; background: #000; border-radius: 50%; }

/* --- Aside (Transparent Phantom Film) --- */
.lfw-aside-row { display: flex; justify-content: center; width: 100%; margin: 24px 0; opacity: 0; animation: lfwFadeIn 0.8s forwards; }
.lfw-trans-film { width: 90%; display: flex; flex-direction: column; align-items: center; position: relative; padding: 10px 0; }
.lfw-tf-meta { 
    width: 100%; display: flex; justify-content: space-between; 
    font-family: Courier, monospace; font-size: 9px; color: #999; 
    letter-spacing: 1px; margin-bottom: 6px; text-transform: uppercase; 
    border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 4px; 
}
.lfw-tf-rec { display: flex; align-items: center; gap: 4px; color: #ff4757; font-weight: 700; }
.lfw-tf-dot { width: 6px; height: 6px; background: #ff4757; border-radius: 50%; animation: lfwPulse 2s infinite; }
.lfw-tf-content { 
    font-family: "Songti SC", serif; font-size: 14px; color: #444; 
    font-weight: 600; font-style: italic; text-align: center; 
    line-height: 1.6; padding: 4px 10px; max-width: 90%; 
    text-shadow: 1px 1px 0px rgba(255,255,255,0.8); 
}
.lfw-tf-line { width: 100%; height: 1px; background: linear-gradient(90deg, transparent, rgba(0,0,0,0.2), transparent); margin-top: 8px; }

/* --- Bottom Dock --- */
.lfw-dock-layer { 
    position: absolute; bottom: 0; left: 0; width: 100%; 
    padding: 0 24px 40px 24px; 
    background: linear-gradient(to top, var(--lfw-bg) 60%, transparent 100%); 
    pointer-events: none; z-index: 200; 
}
.lfw-dock { 
    pointer-events: auto; background: #fff; padding: 10px; 
    border-radius: 20px; display: flex; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.12); 
    border: 1px solid rgba(0,0,0,0.05); 
}
.lfw-main-btn {
    flex: 1; height: 56px; border-radius: 16px; border: none; 
    font-size: 14px; font-weight: 800; color: #fff;
    background: var(--lfw-accent);
    cursor: pointer; display: flex; align-items: center; justify-content: center; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s;
    letter-spacing: 2px; text-transform: uppercase;
}
.lfw-main-btn:active { transform: scale(0.98); background: #000; }
.lfw-main-btn.disabled { background: #ccc; box-shadow: none; pointer-events: none; }

/* --- Role Selection Overlay --- */
.lfw-overlay { 
    position: absolute; inset: 0; background: #fff; z-index: 500; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    transition: opacity 0.3s; 
}
.lfw-role-grid { display: flex; gap: 30px; margin-top: 40px; }
.lfw-role-card { text-align: center; cursor: pointer; transition: 0.2s; }
.lfw-role-card:hover { transform: scale(1.1); }
.lfw-role-card img { 
    width: 90px; height: 90px; border-radius: 24px; object-fit: cover; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 12px; border: 4px solid #fff; 
}

/* Animations */
@keyframes lfwPulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
@keyframes lfwFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
/* --- ğŸš¨ ç»ˆæä¿®å¤ï¼šæ»šåŠ¨ä¸åº•éƒ¨é®æŒ¡ --- */

/* 1. å¤–å±‚å®¹å™¨ï¼šæ”¹ä¸º Flex åˆ—å¸ƒå±€ */
#lf-wizard-page {
    display: flex; 
    flex-direction: column;
    height: 100vh; /* å æ»¡å±å¹• */
    overflow: hidden; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ */
}

/* 2. å¤´éƒ¨å›ºå®š */
.lfw-header {
    flex-shrink: 0; /* ç¦æ­¢å¤´éƒ¨å‹ç¼© */
    /* height: ... (ä¿æŒä½ åŸæœ‰çš„é«˜åº¦) */
}

/* 3. è½¨é“å®¹å™¨ï¼šå æ»¡å‰©ä½™ç©ºé—´ */
#lfw-track {
    flex: 1; /* è‡ªåŠ¨å æ®å¤´éƒ¨å’Œåº•éƒ¨ä¹‹å¤–çš„æ‰€æœ‰ç©ºé—´ */
    height: auto; /* è¦†ç›–ä¹‹å‰çš„ calc */
    overflow: hidden; /* è½¨é“æœ¬èº«ä¸æ»š */
}

/* 4. å•ä¸ªæ­¥éª¤é¡µï¼šç‹¬ç«‹æ»šåŠ¨ */
.lfw-step {
    height: 100%;       
    overflow-y: auto;   /* å¼€å¯å‚ç›´æ»šåŠ¨ */
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
    padding: 24px;      /* ä¿æŒåŸæœ‰å†…è¾¹è· */
    box-sizing: border-box;
}

/* 5. æ ¸å¿ƒä¿®å¤ï¼šå†…å®¹åº•éƒ¨å«é«˜ */
/* è¿™æ ·å†…å®¹çš„æœ€åº•ç«¯å°±ä¼šæ¯”åº•éƒ¨å¯¼èˆªæ è¿˜è¦é«˜ 120pxï¼Œç»å¯¹ä¸ä¼šè¢«æŒ¡ä½ */
.lfw-step-inner {
    padding-bottom: 120px !important; 
    min-height: auto; /* å…è®¸å†…å®¹è‡ªç„¶æ’‘å¼€ */
}

/* 6. åº•éƒ¨å¯¼èˆªæ ï¼šç»å¯¹æ‚¬æµ® */
.lfw-bottom-bar {
    position: fixed; /* å¿…é¡»æ˜¯ fixed */
    bottom: 0; 
    left: 0; 
    width: 100%;
    z-index: 1000 !important; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    /* å¢åŠ ä¸€ç‚¹é˜´å½±ï¼Œè®©å±‚æ¬¡æ›´åˆ†æ˜ */
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05); 
}
/* --- Step 4: è§’è‰²å¡ç‰‡å¼ºåŒ–æ ·å¼ --- */
.lfw-cp-container {
    background: #fff; border: 1px solid #eee; border-radius: 16px;
    padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.04);
}

.lfw-cp-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
}

/* CP å·¦å³å¸ƒå±€ */
.lfw-cp-row {
    display: flex; gap: 16px; align-items: flex-start;
}
.lfw-char-col {
    flex: 1; display: flex; flex-direction: column; align-items: center;
}

/* å¤´åƒå®¹å™¨ */
.lfw-avatar-box {
    width: 80px; height: 80px; position: relative; margin-bottom: 10px; cursor: pointer;
}
.lfw-avatar-img {
    width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.lfw-edit-badge {
    position: absolute; bottom: 0; right: 0; background: #000; color: #fff; 
    width: 24px; height: 24px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; font-size: 12px;
}

/* è¾“å…¥æ¡†ç¾åŒ– */
.lfw-bare-input {
    width: 100%; border: none; border-bottom: 1px dashed #ddd; 
    text-align: center; padding: 4px; font-weight: 700; font-size: 15px; color: #333;
    background: transparent; margin-bottom: 4px;
}
.lfw-bare-input:focus { border-bottom-color: #000; outline: none; }

.lfw-bare-role {
    width: 100%; border: none; text-align: center; font-size: 12px; color: #999; background: transparent;
}

/* äººè®¾ç¼–è¾‘æ¡† (å…³é”®ï¼) */
.lfw-bio-area {
    width: 100%; margin-top: 12px;
    background: #f9f9f9; border: 1px solid #eee; border-radius: 8px;
    padding: 10px; font-size: 12px; color: #555; line-height: 1.5;
    resize: none; font-family: -apple-system, sans-serif;
    min-height: 120px; /* ç»™äººè®¾ç•™å¤Ÿé«˜åº¦ */
}
.lfw-bio-area:focus { background: #fff; border-color: #000; outline: none; }

/* å…³ç³»ä¸æŒ‰é’® */
.lfw-relation-input {
    width: 100%; background: #fffcf0; border: 1px solid #e6dcc0; 
    padding: 12px; border-radius: 8px; margin-top: 20px; 
    font-size: 13px; color: #555; text-align: center;
}

.lfw-action-bar {
    display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #eee;
}
/* --- ğŸ“ ç« èŠ‚å¡ç‰‡é«˜çº§æ„Ÿæ ·å¼ --- */
.lfe-chapter-card {
    background: #fff;
    border-radius: 16px;
    padding: 16px 20px;
    margin-bottom: 12px;
    border: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
    cursor: pointer;
    animation: lfeFadeSlideIn 0.4s ease forwards;
}

.lfe-chapter-card:active {
    transform: scale(0.98);
    background: #fafafa;
}

.lfe-ch-left {
    display: flex;
    align-items: center;
    gap: 16px;
    min-width: 0;
}

.lfe-ch-num {
    font-family: 'Urbanist', sans-serif;
    font-size: 11px;
    font-weight: 800;
    color: #bbb;
    text-transform: uppercase;
    letter-spacing: 1px;
    width: 32px;
}

.lfe-ch-title {
    font-family: 'Songti SC', serif;
    font-size: 16px;
    font-weight: 700;
    color: #1a1a1a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.lfe-ch-meta {
    font-size: 10px;
    color: #999;
    margin-top: 4px;
}

.lfe-ch-right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.lfe-status-pill {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 9px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.lfe-status-draft { background: #f5f5f7; color: #8e8e93; }
.lfe-status-done { background: #e8f5e9; color: #2e7d32; }

@keyframes lfeFadeSlideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* AI æ‰«æåŠ¨ç”» */
.ai-scan-circle {
    width: 100%; height: 100%; border-radius: 50%;
    border: 2px solid transparent;
    border-top-color: #fff;
    border-bottom-color: #fff;
    animation: aiRotate 2s linear infinite;
}
@keyframes aiRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* æˆåŠŸå¼¹çª— */
.lfe-success-popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: #fff; color: #000; padding: 30px; border-radius: 24px;
    z-index: 300001; width: 80%; max-width: 320px; text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
/* ç¡®ä¿é˜…è¯»å™¨å®¹å™¨å¼ºåˆ¶å æ»¡å±å¹• */
#lf-immersive-container {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: #fff !important;
    display: flex !important;
    flex-direction: column !important;
}

/* èˆå°åŒºï¼ˆå¯¹è¯åŒºåŸŸï¼‰å¿…é¡»æœ‰é«˜åº¦ä¸”èƒ½æ»šåŠ¨ */
.lfw-stage {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    padding-bottom: 120px; /* ç•™å‡ºåº•éƒ¨æŒ‰é’®ä½ç½® */
    background: #fafafa;
    -webkit-overflow-scrolling: touch;
}

/* ç®€å•çš„è¿›å…¥åŠ¨ç”» */
@keyframes lfwFadeIn {
    from { opacity: 0; transform: scale(1.05); }
    to { opacity: 1; transform: scale(1); }
}
/* --- ğŸï¸ æ²‰æµ¸å¼å‰§æœ¬æ°”æ³¡ï¼šç¡¬æ ¸çŸ©å½¢ç‰ˆ --- */

/* 1. åŸºç¡€è¡Œå¸ƒå±€ */
.lfw-row {
    display: flex;
    gap: 14px;
    margin-bottom: 30px;
    width: 100%;
    box-sizing: border-box;
    align-items: flex-start;
}

/* 2. æ°”æ³¡é€šç”¨æ ·å¼ï¼šå»åœ†è§’ã€å¼ºåˆ¶å·¦å¯¹é½ */
.lfw-bubble {
    position: relative;
    padding: 14px 18px;
    font-size: 15px;
    line-height: 1.6;
    text-align: left !important; /* æ–‡å­—å§‹ç»ˆæ­£å¸¸æ’åˆ— */
    border: 2px solid #1a1a1a;
    border-radius: 18px !important;  /* ğŸ‘ˆ æ”¹æˆè¿™ä¸ªï¼Œæ•°å€¼è¶Šå¤§è¶Šåœ† */
    border: none !important;         /* ğŸ‘ˆ å»æ‰é»‘è¾¹ï¼Œåœ†è§’é…æ— è¾¹æ¡†æ›´å¥½çœ‹ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* ğŸ‘ˆ æ¢æˆæŸ”å’Œçš„é˜´å½± */
    min-width: 60px;
    word-break: break-all;
}

/* ----------------------------------
   ğŸ­ è§’è‰²æ ·å¼å·®å¼‚åŒ– (åŒºåˆ†ä¸»è§’ä¸NPC)
   ---------------------------------- */

/* âšª å·¦ä¾§ï¼šå…¶ä»–è§’è‰² (ç™½åº•é»‘å­—) */
.lfw-row.left .lfw-bubble {
    background: #ffffff;
    color: #1a1a1a;
    box-shadow: 4px 4px 0px rgba(0,0,0,0.05); /* æµ…è‰²æŠ•å½± */
}

/* âš« å³ä¾§ï¼šä½ é€‰æ‹©çš„è§’è‰² (é»‘åº•ç™½å­— - ä¸»è§’å…‰ç¯) */
.lfw-row.right {
    justify-content: flex-end;
}
.lfw-row.right .lfw-bubble {
    background: #1a1a1a; /* ç¿»è½¬èƒŒæ™¯è‰² */
    color: #ffffff;      /* ç¿»è½¬æ–‡å­—é¢œè‰² */
    box-shadow: -4px 4px 0px rgba(0,0,0,0.15); /* æ·±è‰²æŠ•å½± */
}
.lfw-row.right .lfw-bubble::before, 
.lfw-row.right .lfw-bubble::after {
    /* ä¸»è§’æ°”æ³¡çš„é½¿å­”ç”¨åŠé€æ˜ç™½ */
    background-image: linear-gradient(to right, rgba(255,255,255,0.4) 0px, rgba(255,255,255,0.4) 4px, transparent 4px, transparent 8px);
}

/* 4. å¤´åƒä¹Ÿæ”¹æ–¹ï¼Œç»Ÿä¸€è§†è§‰é£æ ¼ */
.lfw-avatar {
    width: 44px;
    height: 44px;
    border: 2px solid #1a1a1a;
    border-radius: 0 !important;
    object-fit: cover;
    background: #f0f0f0;
}
/* --- ğŸ›°ï¸ Lune OS: å®šä½ç³»ç»Ÿè§†è§‰è§„èŒƒ (Ins Industrial) --- */

/* 1. å…¨åŸŸé®ç½© */
#lune-location-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    z-index: 100000; display: none; align-items: center; justify-content: center;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}

/* 2. å¼¹çª—ä¸»ä½“ï¼šç™½åº•é»‘æ¡†ï¼Œé«˜è€¸ç¡¬æœ— */
.loc-modal {
    width: 360px; min-height: 540px; background: #FFFFFF;
    border: 1.5px solid #000; border-radius: 0px; /* çº¯ç›´è§’æ›´æœ‰å·¥ä¸šæ„Ÿ */
    padding: 35px; box-shadow: 15px 15px 0px rgba(0,0,0,0.2);
    display: flex; flex-direction: column;
    animation: insSlideUp 0.4s cubic-bezier(0.2, 1, 0.3, 1);
}

@keyframes insSlideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }

/* 3. å¤´éƒ¨æ’ç‰ˆ */
.loc-header { 
    margin-bottom: 30px; border-bottom: 2px solid #000; 
    padding-bottom: 10px;
}
.loc-title { font-size: 26px; font-weight: 900; color: #000; text-transform: uppercase; letter-spacing: 2px; }

/* 4. æ¨¡å¼åˆ‡æ¢å™¨ */
.loc-type-toggle {
    display: flex; border: 1.5px solid #000; margin-bottom: 25px;
}
.loc-tab { 
    flex: 1; text-align: center; padding: 14px; font-size: 11px; 
    font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
}
.loc-tab.active { background: #000; color: #fff; }

/* 5. æœç´¢åŒºåŸŸ */
.loc-search-box { 
    border: 1.5px solid #000; padding: 16px;
    display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
}
.loc-input { 
    flex: 1; border: none; background: transparent; outline: none; 
    font-size: 14px; color: #000; font-weight: 600;
}

/* 6. ç»“æœåˆ—è¡¨ */
.loc-results { flex: 1; overflow-y: auto; scrollbar-width: none; }
.loc-results::-webkit-scrollbar { display: none; }
.loc-item {
    padding: 16px 0; border-bottom: 1px solid #EEE;
    cursor: pointer; transition: 0.2s;
}
.loc-item:hover { transform: translateX(5px); }

/* 7. åº•éƒ¨æŒ‰é’® */
.loc-footer { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
.loc-btn { 
    width: 100%; padding: 18px; border: 1.5px solid #000;
    font-weight: 900; font-size: 12px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
}
.loc-btn-confirm { background: #000; color: #fff; }
.loc-btn-cancel { background: #fff; color: #000; }
/* å¼ºè¡Œè®©ä½ç½®å¡ç‰‡è„±ç¦»æ°”æ³¡çš„è§†è§‰æŸç¼š */
.msg-location-card {
    width: 270px;
    background: #FFFFFF !important;
    border: 1.5px solid #000000 !important;
    box-shadow: 10px 10px 0px rgba(0,0,0,0.1); /* æ ‡å¿—æ€§çš„ç¡¬æ ¸æŠ•å½± */
    margin: 8px 0;
    cursor: pointer;
}

/* è°ƒæ•´å¤´åƒä¸å¡ç‰‡çš„é—´è·ï¼Œé˜²æ­¢è´´å¾—å¤ªæ­» */
.msg-row.user .msg-location-card { margin-left: auto; margin-right: 0; }
.msg-row.opponent .msg-location-card { margin-right: auto; margin-left: 0; }

/* å†…éƒ¨åœ°å›¾çº¹è·¯å¢å¼ºï¼ˆIns åç™½é£æ ¼ï¼‰ */
.loc-card-map-preview {
    background-color: #FAFAFA;
    background-image: 
        linear-gradient(90deg, transparent 49%, #E0E0E0 49%, #E0E0E0 51%, transparent 51%),
        linear-gradient(0deg, transparent 49%, #E0E0E0 49%, #E0E0E0 51%, transparent 51%);
    background-size: 30px 30px;
}
/* ä¸“å±ï¼šä½ç½®å¡ç‰‡å¤–å±‚å®¹å™¨ï¼ˆæ¶ˆé™¤æ°”æ³¡æ ·å¼ï¼‰ */
.location-exclusive-wrap {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    overflow: visible !important;
}

/* å†…éƒ¨å¡ç‰‡æ ·å¼ï¼ˆä¿æŒ Ins å·¥ä¸šé£ï¼‰ */
.msg-location-card {
    width: 260px;
    background: #FFFFFF !important;
    border: 1.5px solid #000000 !important;
    box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
    margin: 4px 0;
    cursor: pointer;
}
/* --- ğŸ›°ï¸ Lune OS: ä½ç½®å¡ç‰‡ä¸“å±å·¥ä¸šè§†è§‰è§„èŒƒ --- */

/* 1. å½»åº•æŠ¹é™¤ä½ç½®æ¶ˆæ¯çš„å¤–å±‚æ°”æ³¡æ ·å¼ï¼Œåªåšå®šä½å®¹å™¨ */
.bubble.location-exclusive-wrap {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    overflow: visible !important;
    max-width: 270px;
}

/* 2. å†…éƒ¨ç¡¬æ ¸é»‘ç™½å¡ç‰‡ */
.msg-location-card {
    width: 270px;
    background: #FFFFFF !important;
    border: 1.5px solid #000000 !important;
    border-radius: 12px !important; /* å·¥ä¸šçº§é”åˆ©è¾¹è§’ */
    box-shadow: 10px 10px 0px rgba(0,0,0,0.08); /* ç¡¬æŠ•å½± */
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s;
}
.msg-location-card:active { transform: scale(0.98); }

/* 3. åœ°å›¾çº¹è·¯é¢„è§ˆåŒº (è§£å†³ä½ å›¾ä¸­æ²¡åœ°å›¾æ„Ÿçš„é—®é¢˜) */
.loc-card-map-preview {
    width: 100%; height: 130px; background-color: #f9f9f9;
    background-image: 
        linear-gradient(90deg, transparent 49%, #e0e0e0 49%, #e0e0e0 51%, transparent 51%),
        linear-gradient(0deg, transparent 49%, #e0e0e0 49%, #e0e0e0 51%, transparent 51%);
    background-size: 30px 30px; /* å·¥ä¸šç½‘æ ¼æ„Ÿ */
    display: flex; align-items: center; justify-content: center;
    border-bottom: 1.5px solid #000;
    position: relative;
}

/* åŠ¨æ€æ‰«æé›·è¾¾ */
.loc-radar-ping {
    position: absolute; width: 60px; height: 60px;
    border: 1px solid rgba(0,0,0,0.1); border-radius: 50%;
    animation: radarPulse 2s infinite linear;
}
@keyframes radarPulse { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.6); opacity: 0; } }

.loc-card-pin {
    width: 20px; height: 20px; background: #000; border: 3px solid #fff;
    border-radius: 50% 50% 50% 0; transform: rotate(-45deg); z-index: 5;
}

/* 4. ä¿¡æ¯æ’ç‰ˆåŒº */
.loc-card-info { padding: 15px; position: relative; }
.loc-card-address { 
    font-size: 16px; font-weight: 900; color: #000; 
    text-transform: uppercase; line-height: 1.2;
}
.loc-card-coords { 
    font-family: monospace; font-size: 9px; color: #AAA; 
    margin-top: 6px; letter-spacing: 0.5px;
}
.loc-card-footer {
    margin-top: 12px; padding-top: 8px; border-top: 1px dashed #EEE;
    display: flex; justify-content: space-between;
    font-size: 8px; font-weight: 800; color: #CCC; text-transform: uppercase;
}
/* å½»åº•æ¸…é™¤ä½ç½®å¡ç‰‡çš„æ‰€æœ‰æ°”æ³¡ç—•è¿¹ */
.location-exclusive-wrap {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    margin: 5px 0 !important;
    width: fit-content;
}

/* ğŸš¨ å…³é”®ï¼šå¼ºåˆ¶éšè—æ°”æ³¡çš„å°å°–è§’/å°¾å·´ */
.location-exclusive-wrap::after,
.location-exclusive-wrap::before {
    display: none !important;
    content: none !important;
}

/* è°ƒæ•´å¤´åƒé—´è·ï¼šå› ä¸ºæ²¡äº†æ°”æ³¡ï¼Œéœ€è¦æ‰‹åŠ¨ç»™å¡ç‰‡åšå¯¹é½ */
.msg-row.user .location-exclusive-wrap {
    margin-left: auto !important;
    margin-right: 0 !important;
}
.msg-row.opponent .location-exclusive-wrap {
    margin-right: auto !important;
    margin-left: 0 !important;
}
/* --- ğŸ“š è—çé˜ (Bookshelf) æ ¸å¿ƒæ ·å¼ --- */
#lf-page-shelf {
    background: #ffffff !important;
    padding: 60px 24px 120px !important;
    min-height: 100vh;
    font-family: 'Urbanist', 'Noto Serif SC', serif;
}

/* é¡¶éƒ¨çœ‹æ¿ */
.lfs-top-dashboard {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 50px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0;
}
.lfs-brand { font-size: 10px; font-weight: 800; letter-spacing: 4px; color: #000; text-transform: uppercase; }
.lfs-total-stats { display: flex; gap: 24px; }
.lfs-stat-box { text-align: right; }
.lfs-stat-num { font-size: 20px; font-weight: 900; color: #1a1a1a; line-height: 1; }
.lfs-stat-lab { font-size: 9px; color: #999; font-weight: 700; margin-top: 4px; }

/* æ ‡é¢˜è®¾è®¡ */
#lf-page-shelf .lf-v2-section-title {
    font-size: 42px !important; font-weight: 900 !important;
    color: #1a1a1a; letter-spacing: -2px; margin-bottom: 8px;
}
.lfs-desc-line { font-size: 14px; color: #666; margin-bottom: 40px; font-style: italic; opacity: 0.7; }

/* å¯Œåª’ä½“æ¨ªå‘å¡ç‰‡æµ */
.lfs-collection-flow { display: flex; flex-direction: column; gap: 30px; }

.lfs-rich-card {
    display: flex; gap: 20px; background: #fff;
    padding: 16px; border-radius: 24px;
    transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    border: 1px solid #f5f5f7;
    box-shadow: 0 10px 30px rgba(0,0,0,0.03);
}
.lfs-rich-card:active { transform: scale(0.97); background: #fafafa; }

/* å°é¢åŒºï¼šä¹¦è„Šæ•ˆæœ */
.lfs-book-vessel {
    width: 110px; height: 155px; flex-shrink: 0;
    position: relative; border-radius: 8px;
    overflow: hidden; box-shadow: 8px 10px 20px rgba(0,0,0,0.15);
    background: #eee;
}
.lfs-book-vessel img { width: 100%; height: 100%; object-fit: cover; }
.lfs-book-spine {
    position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
    background: linear-gradient(to right, rgba(255,255,255,0.3), rgba(0,0,0,0.2));
    z-index: 2;
}

/* å†…å®¹åŒºæ’ç‰ˆ */
.lfs-content-vessel { flex: 1; display: flex; flex-direction: column; justify-content: space-between; min-width: 0; }
.lfs-book-title { font-size: 18px; font-weight: 900; color: #1a1a1a; margin-bottom: 6px; }
.lfs-book-synopsis {
    font-size: 12px; color: #888; line-height: 1.6;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden; margin-bottom: 10px;
}

/* æ ‡ç­¾äº‘ */
.lfs-tag-cloud { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
.lfs-mini-tag {
    font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 6px;
    background: rgba(0,122,255,0.05); color: #007AFF;
}

/* åº•éƒ¨è¿›åº¦ */
.lfs-card-footer {
    display: flex; align-items: center; justify-content: space-between;
    padding-top: 10px; border-top: 1px solid #f9f9f9;
}
.lfs-meta-data { font-size: 10px; color: #bbb; font-weight: 700; text-transform: uppercase; }
.lfs-progress-container { width: 60px; height: 4px; background: #f0f0f0; border-radius: 2px; overflow: hidden; }
.lfs-progress-bar { height: 100%; background: #000; border-radius: 2px; }

</style>
</head>
<body>
    <script src="https://cdn.bootcdn.net/ajax/libs/tiny-pinyin/1.3.2/tiny-pinyin.js"></script>
    <div class="status-bar">
        <div id="clock">12:00</div>
        <div class="status-right">
            <svg width="18" height="12" viewBox="0 0 18 12" fill="currentColor"><path d="M1 9h2v2H1zm4-3h2v5H5zm4-3h2v8H9zm4-3h2v11h-2z"/></svg>
            <div style="display:flex; align-items:center;">
                <span class="bat-text" id="bat-num">--%</span>
                <div class="battery-box"><div class="bat-fill" id="bat-bar"></div><div class="bat-tip"></div></div>
            </div>
        </div>
    </div>

    <div class="home-screen-scroll-container">
        <div class="home-screen-wrapper">
            
            <div class="main-container" id="page-1">
                <div class="widget w-2x2" onclick="showM('weatherM')">
                    <div class="weather-content">
                        <div class="w-date-block">
                            <span class="w-day" id="ui-day">MONDAY</span>
                            <span class="w-date" id="ui-date">JANUARY 1</span>
                        </div>
                        <div class="w-data-stack">
                            <div class="w-icon-area" id="ui-icon"></div>
                            <div class="w-temp" id="ui-temp">--Â°</div>
                            <div class="w-city">
                                <svg style="width:12px;height:12px;fill:#007AFF" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
                                <span id="ui-city">Updating...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="widget w-2x2" onclick="showM('photoM')">
                    <div class="pic-container">
                        <div class="pic-text" id="ui-quote">"Thinking Different."</div>
                        <div class="pic-wrapper">
                            <img id="ui-img" class="pic-img" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23f0f0f0'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-weight='bold' font-family='sans-serif'>Tap to Upload</text></svg>">
                        </div>
                    </div>
                </div>

                <div class="widget w-4x1" onclick="openApp('musicApp')" style="cursor: pointer;">
                    <div class="music-row">
                        <div style="display:flex; align-items:center;">
                            <div class="album-cover"></div>
                            <div class="track-info">
                                <span class="track-title">Luxury Vibe</span>
                                <span class="track-artist">Lossless Audio</span>
                            </div>
                        </div>
                        <div class="ctrl-btns">
                            <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                            <svg style="width:32px;height:32px;fill:#333" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                        </div>
                    </div>
                </div>

                <div class="widget w-4x1">
                    <div class="prog-stack">
                        <div class="prog-header"><span>Daily Progress</span><span id="prog-txt">0.0%</span></div>
                        <div class="prog-bg"><div class="prog-fg" id="prog-bar"></div></div>
                    </div>
                </div>

                <div class="app-cell" onclick="openApp('wallApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><polyline points="21 15 16 10 5 21" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                    </div>
                    <span class="app-name">Wallpaper</span>
                </div>
                
                <div class="app-cell" onclick="openApp('settingsApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%); color: #3a3a3c;">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:34px; height:34px;"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" fill="currentColor"/></svg>
                    </div>
                    <span class="app-name">Settings</span>
                </div>

                <div class="app-cell" onclick="openChatApp()">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #007AFF 0%, #00C6FF 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="currentColor"/>
                        </svg>
                    </div>
                    <span class="app-name">Chat</span>
                </div>
                <div class="app-cell" onclick="openPhotosApp()">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #FFD3A5 0%, #FD6585 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                    </div>
                    <span class="app-name">Photos</span>
                </div>

                <div class="app-cell" onclick="openApp('musicApp')">
                    <dThemeiv class="icon-shape" style="background: linear-gradient(135deg, #fb3a4d 0%, #fb6470 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
                        </svg>
                    </dThemeiv>
                    <span class="app-name">Music</span>
                </div>

                <div class="app-cell" onclick="openProfilesApp()">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <span class="app-name">Profiles</span>
                </div>

                <div class="app-cell" onclick="openApp('phoneApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #28C940 0%, #5ee172 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    </div>
                    <span class="app-name">Phone</span>
                </div>

                <div class="app-cell" onclick="openApp('messageApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #21d4fd 0%, #b721ff 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <span class="app-name">Messages</span>
                </div>
            </div>

            <div class="main-container" id="page-2" style="display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr); gap: 16px; padding: 20px;">
    
                <div class="widget hero-cover-widget" style="grid-area: 1 / 1 / 3 / 5;" onclick="window.editHubField('hero')">
                    <div class="hero-image-wrapper">
                        <img id="hub-hero-img" src="https://images.unsplash.com/photo-1494438639946-1ebd1d20bf85?w=800&auto=format&fit=crop" alt="Hero">
                        <div class="hero-overlay"></div>
                    </div>
                    <div class="hero-content-text">
                        <span class="hero-tag" id="hub-hero-tag" onclick="event.stopPropagation(); window.editHubField('hero_tag')">FEATURED MOMENT</span>
                        
                        <h2 id="hub-hero-title" onclick="event.stopPropagation(); window.editHubField('hero_title')">Aesthetic Essence</h2>
                        
                        <p id="hub-hero-desc" onclick="event.stopPropagation(); window.editHubField('hero_desc')">"Design is intelligence made visible."</p>
                    </div>
                    
                    <div class="hero-edit-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    </div>
                </div>
                <div class="widget moment-card-widget" style="grid-area: 3 / 1 / 5 / 3;" onclick="window.editHubField('moment_img')">
                    <div class="moment-photo-area">
                        <img id="hub-moment-img" src="https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&auto=format&fit=crop" alt="Moment">
                        <div class="moment-edit-hint">Change Photo</div>
                    </div>
                    <div class="moment-text-area">
                        <h3 id="hub-moment-title" onclick="event.stopPropagation(); window.editHubField('moment_title')">Daily Focus</h3>
                        <p id="hub-moment-desc" onclick="event.stopPropagation(); window.editHubField('moment_desc')">Keep it simple, keep it real.</p>
                    </div>
                </div>

                <div class="app-cell" style="grid-area: 3 / 3 / 4 / 4;" onclick="window.openApp('vibe-grid-app')">
                    <div class="glass-icon-bg">
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                        </svg>
                    </div>
                    <span class="app-name">Vibe Grid</span>
                </div>

                <div class="app-cell" style="grid-area: 3 / 4 / 4 / 5;" onclick="openApp('diaryApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Diary</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                    </div>
                    <span class="app-name">Diary</span>
                </div>

                <div class="app-cell" style="grid-area: 4 / 3 / 5 / 4;" onclick="openApp('walletApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Wallet</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20M7 15h.01"/>
                        </svg>
                    </div>
                    <span class="app-name">Wallet</span>
                </div>

                <div class="app-cell" style="grid-area: 4 / 4 / 5 / 5;" onclick="openApp('notesApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Notes</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/>
                        </svg>
                    </div>
                    <span class="app-name">Notes</span>
                </div>

                <div class="widget vibe-bar-widget" style="grid-area: 5 / 1 / 6 / 5;" onclick="window.editHubField('vibe_img')">
                    <div class="vibe-bg-wrapper">
                        <img id="hub-vibe-img" src="https://images.unsplash.com/photo-1502759683299-cdcc6974244f?w=800&auto=format&fit=crop" alt="Vibe">
                        <div class="vibe-overlay"></div>
                    </div>
                    <span id="hub-vibe-text" onclick="event.stopPropagation(); window.editHubField('vibe_text')">Current Vibe: Serenity</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 1 / 7 / 2;" onclick="openApp('shoppingApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Shopping</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                    </div>
                    <span class="app-name">Shopping</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 2 / 7 / 3;" onclick="openApp('forumApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Forum</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                        </svg>
                    </div>
                    <span class="app-name">Forum</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 3 / 7 / 4;" onclick="openApp('novelApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Novels</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20V2H6.5A2.5 2.5 0 0 0 4 4.5v15z"/>
                        </svg>
                    </div>
                    <span class="app-name">Novels</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 4 / 7 / 5;" onclick="openApp('liveApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Live</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/>
                        </svg>
                    </div>
                    <span class="app-name">Live</span>
                </div>

                </div>

            <div class="main-container" id="page-3" style="display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr); gap: 16px; padding: 20px;">
                <div class="widget-liquid" style="grid-area: 1 / 1 / 3 / 5;">
                    <div class="wl-content">
                        <div class="wl-header">
                            <div id="p3-avatar" class="wl-avatar" 
                                style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); background-size: cover; background-position: center;" 
                                onclick="openEditModal('p3-avatar', 'image')" title="ç‚¹å‡»ä¿®æ”¹å¤´åƒ"></div>
                            
                            <div class="wl-text-box">
                                <div id="p3-name" class="wl-name" onclick="openEditModal('p3-name', 'text')">Pure UI</div>
                                <div id="p3-sign" class="wl-sign" onclick="openEditModal('p3-sign', 'text')">No images, just pure code.</div>
                            </div>
                        </div>

                        <div class="wl-gallery">
                            <div class="wl-img-box">
                                <div id="p3-img-1" class="wl-img" 
                                    style="background: #ff9a9e; background-size: cover; background-position: center;" 
                                    onclick="openEditModal('p3-img-1', 'image')"></div>
                            </div>
                            <div class="wl-img-box">
                                <div id="p3-img-2" class="wl-img" 
                                    style="background: #a18cd1; background-size: cover; background-position: center;" 
                                    onclick="openEditModal('p3-img-2', 'image')"></div>
                            </div>
                            <div class="wl-img-box">
                                <div id="p3-img-3" class="wl-img" 
                                    style="background: #84fab0; background-size: cover; background-position: center;" 
                                    onclick="openEditModal('p3-img-3', 'image')"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="app-cell" style="grid-area: 3 / 1 / 4 / 2;" onclick="openLostFoundApp()">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Lost & Found</span>
                        
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="6" y="3" width="12" height="18" rx="2" ry="2"></rect>
                            <path d="M15 7l-6 6l3 3"></path>
                            <path d="M12 17h.01"></path>
                        </svg>
                    </div>
                    <span class="app-name">Lost & Found</span>
                </div>
            </div>
        </div>
    </div>

    <div class="dock-container">
        <div class="dock-bar">
            <div class="dock-app" data-app="RoleBook" onclick="openApp('charApp')" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                <span class="app-name" style="display: none;">RoleBook</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </div>

            <div class="dock-app" data-app="WorldBook" onclick="openApp('worldApp')" style="background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);">
                <span class="app-name" style="display: none;">WorldBook</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <circle cx="12" cy="12" r="3" fill="rgba(255,255,255,0.2)"/>
                </svg>
            </div>

            <div class="dock-app" data-app="Beautify" onclick="openApp('beautifyApp')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); position: relative;">
                <span class="app-name" style="display: none;">Beautify</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 8l-2 4h4l-2 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 2v2M12 20v2M2 12h2M20 12h2" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
                </svg>
            </div>

            <div class="dock-app" data-app="Icons" onclick="openApp('iconApp')" style="background: linear-gradient(135deg, #2af598 0%, #009efd 100%);">
                <span class="app-name" style="display: none;">Icons</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M17.5 14v7M14 17.5h7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        <div class="home-indicator"></div>
    </div>

    <div class="modal-overlay" id="weatherM" onclick="hideM('weatherM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top">
                <span class="modal-h1">Select City</span>
                <span class="modal-done" onclick="hideM('weatherM')">Done</span>
            </div>

            <div class="segment-control">
                <div class="segment-btn active" id="tab-cn" onclick="switchTab('cn')">China</div>
                <div class="segment-btn" id="tab-global" onclick="switchTab('global')">Global</div>
            </div>
            
            <div style="max-height: 55vh; overflow-y: auto; padding-right: 2px;">
                
                <div id="view-cn" class="city-view active">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">MAINLAND & HK/TW</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(39.9042, 116.4074, 'Beijing')">åŒ—äº¬</div>
                        <div class="city-tag" onclick="fetchW(31.2304, 121.4737, 'Shanghai')">ä¸Šæµ·</div>
                        <div class="city-tag" onclick="fetchW(23.1291, 113.2644, 'Guangzhou')">å¹¿å·</div>
                        <div class="city-tag" onclick="fetchW(22.5431, 114.0579, 'Shenzhen')">æ·±åœ³</div>
                        <div class="city-tag" onclick="fetchW(30.5728, 104.0668, 'Chengdu')">æˆéƒ½</div>
                        <div class="city-tag" onclick="fetchW(30.2741, 120.1551, 'Hangzhou')">æ­å·</div>
                        <div class="city-tag" onclick="fetchW(29.5630, 106.5516, 'Chongqing')">é‡åº†</div>
                        <div class="city-tag" onclick="fetchW(34.3416, 108.9398, 'Xi\'an')">è¥¿å®‰</div>
                        <div class="city-tag" onclick="fetchW(30.5928, 114.3055, 'Wuhan')">æ­¦æ±‰</div>
                        <div class="city-tag" onclick="fetchW(32.0603, 118.7969, 'Nanjing')">å—äº¬</div>
                        <div class="city-tag" onclick="fetchW(22.3193, 114.1694, 'Hong Kong')">é¦™æ¸¯</div>
                        <div class="city-tag" onclick="fetchW(25.0330, 121.5654, 'Taipei')">å°åŒ—</div>
                    </div>
                </div>

                <div id="view-global" class="city-view">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">ASIA & PACIFIC</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(35.6762, 139.6503, 'Tokyo')">Tokyo</div>
                        <div class="city-tag" onclick="fetchW(37.5665, 126.9780, 'Seoul')">Seoul</div>
                        <div class="city-tag" onclick="fetchW(1.3521, 103.8198, 'Singapore')">Singapore</div>
                        <div class="city-tag" onclick="fetchW(13.7563, 100.5018, 'Bangkok')">Bangkok</div>
                        <div class="city-tag" onclick="fetchW(-33.8688, 151.2093, 'Sydney')">Sydney</div>
                        <div class="city-tag" onclick="fetchW(25.2048, 55.2708, 'Dubai')">Dubai</div>
                    </div>

                    <div style="font-size:12px; color:#999; margin: 15px 0 8px 0; font-weight:700;">AMERICAS & EUROPE</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(40.7128, -74.0060, 'New York')">New York</div>
                        <div class="city-tag" onclick="fetchW(34.0522, -118.2437, 'Los Angeles')">L.A.</div>
                        <div class="city-tag" onclick="fetchW(43.6532, -79.3832, 'Toronto')">Toronto</div>
                        <div class="city-tag" onclick="fetchW(51.5074, -0.1278, 'London')">London</div>
                        <div class="city-tag" onclick="fetchW(48.8566, 2.3522, 'Paris')">Paris</div>
                        <div class="city-tag" onclick="fetchW(52.5200, 13.4050, 'Berlin')">Berlin</div>
                        <div class="city-tag" onclick="fetchW(55.7558, 37.6173, 'Moscow')">Moscow</div>
                        <div class="city-tag" onclick="fetchW(41.9028, 12.4964, 'Rome')">Rome</div>
                        <div class="city-tag" onclick="fetchW(40.4168, -3.7038, 'Madrid')">Madrid</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal-overlay" id="photoM" onclick="hideM('photoM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top"><span class="modal-h1">Customize</span><span class="modal-done" onclick="hideM('photoM')">Save</span></div>
            <input type="text" id="q-in" placeholder="Type your quote..." style="width:100%; padding:16px; background:#f2f2f7; border:none; border-radius:14px; font-size:16px;">
            <div class="upload-tools">
                <input type="file" id="f-in" style="display:none" accept="image/*" onchange="loadF(this)">
                <div class="tool-btn" onclick="document.getElementById('f-in').click()">Photo Library</div>
                <div class="tool-btn" onclick="loadU()">Paste URL</div>
            </div>
        </div>
    </div>

<video id="bg-video" autoplay loop muted playsinline style="position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; display:none;"></video>

<div id="wallApp" class="ios-app-window">
    <div class="app-header">
        <div class="header-title-big">Wallpaper</div>
        <div class="header-close-btn" onclick="closeApp('wallApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body">
        
        <div class="preview-stage" style="margin-top: 10px;">
            <div class="phone-frame">
                <img id="preview-img" src="" style="display:none;">
                <video id="preview-vid" autoplay loop muted playsinline style="display:none;"></video>
                <div class="preview-placeholder" id="preview-hint">Preview</div>
            </div>
        </div>

        <div class="segment-control" style="width: 100%; max-width: 300px;">
            <div class="segment-btn active" id="seg-img" onclick="switchWallTab('img')">Image</div>
            <div class="segment-btn" id="seg-vid" onclick="switchWallTab('vid')">Video</div>
        </div>

        <div class="action-area" id="panel-img" style="max-width: 300px;">
            <input type="file" id="upload-img" accept="image/*" style="display:none" onchange="handleWallFile(this, 'img')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-img').click()">+ New Image</button>
            <button class="ios-btn primary" onclick="setWallpaper('img')">Set Current</button>
        </div>

        <div class="action-area" id="panel-vid" style="display:none; max-width: 300px;">
            <input type="file" id="upload-vid" accept="video/*" style="display:none" onchange="handleWallFile(this, 'vid')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-vid').click()">+ New Video</button>
            <button class="ios-btn primary" onclick="setWallpaper('vid')">Set Current</button>
        </div>

        <div class="history-section">
            <div class="history-title">My Collection</div>
            <div class="history-grid" id="wall-history-grid">
                </div>
            <div style="text-align:center; color:#999; font-size:12px; margin-top:15px;">
                Tap to apply. Latest 6 items saved.
            </div>
        </div>

    </div>
</div>

<div id="toast" class="ios-toast">Settings Saved</div>

<div id="successAlert" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Success</div>
        <div class="alert-msg" id="alert-msg">Wallpaper Updated Successfully</div>
        <div class="alert-btn" onclick="closeAlert()">OK</div>
    </div>
</div>

<div id="charApp" class="ios-app-window">
    <div id="char-list-view" style="height:100%; display:flex; flex-direction:column;">
        <div class="app-header">
            <div class="header-title-big" style="flex:1; text-align: left; padding-left: -5px;">Character</div>
            
            <div class="header-close-btn" onclick="closeApp('charApp')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
        
        <div class="app-body">
            <div id="char-grid" class="char-grid">
                </div>
            </div>
    </div>

    <div id="char-detail-view" class="char-detail-view">
        <div class="char-hero-bg" id="detail-bg" onclick="openBgModal()">
            <div class="bg-hint">Tap to Change Cover</div>
        </div>
        
        <div class="char-content">
            <div class="char-avatar-container">
                <img id="detail-avatar" src="">
            </div>
            
            <div class="char-info-block">
                <div class="char-name" id="detail-name">Character Name</div>
                
                <div class="char-desc-preview" onclick="openFullDesc()">
                    <span id="detail-desc">Description goes here...</span>
                    <span style="color:#007AFF; font-weight:600; font-size:12px;"> more</span>
                </div>

                <div class="char-actions">
                    <button class="ios-btn secondary" onclick="editCurrentChar()">Edit Profile</button>
                    <button class="ios-btn" style="background:#FF3B30; color:white;" onclick="openDelConfirm()">Delete Character</button>
                </div>
            </div>
        </div>

        <div class="floating-back" onclick="closeDetailView()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </div>
    </div>
</div>

<div id="charEditModal" class="ios-alert-mask" style="align-items:flex-end;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-top">
            <span class="modal-h1" id="modal-title">New Character</span>
            <span class="modal-done" onclick="saveCharacter()">Save</span>
        </div>
        
        <div style="display:flex; justify-content:center; margin-bottom:20px;">
            <div class="char-upload-circle" onclick="document.getElementById('char-avatar-in').click()">
                <img id="edit-avatar-preview" src="" style="display:none;">
                <span id="edit-avatar-hint">+ Avatar</span>
            </div>
            <input type="file" id="char-avatar-in" accept="image/*" style="display:none" onchange="previewCharAvatar(this)">
        </div>

        <input type="text" id="char-name-in" class="ios-input" placeholder="Nickname">
        <textarea id="char-desc-in" class="ios-input" style="height:120px; resize:none; padding-top:12px;" placeholder="Character Description / Setting..."></textarea>
        
        <div class="tool-btn" onclick="closeCharModal()" style="margin-top:10px; color:#FF3B30;">Cancel</div>
    </div>
</div>

<div id="bgChangeModal" class="ios-alert-mask">
    <div class="ios-alert-box" style="padding:20px; text-align:left;">
        <div class="alert-title" style="margin-top:0; margin-bottom:15px; text-align:center;">Change Cover</div>
        
        <div class="segment-control">
            <div class="segment-btn active" id="bg-seg-file" onclick="switchBgMode('file')">File</div>
            <div class="segment-btn" id="bg-seg-url" onclick="switchBgMode('url')">URL</div>
        </div>

        <div id="bg-panel-file">
            <input type="file" id="bg-file-in" style="display:none" accept="image/*" onchange="handleBgFile(this)">
            <button class="ios-btn secondary" onclick="document.getElementById('bg-file-in').click()">Choose Image</button>
        </div>
        <div id="bg-panel-url" style="display:none;">
            <input type="text" id="bg-url-in" class="ios-input" placeholder="https://..." style="margin-bottom:10px;">
            <button class="ios-btn secondary" onclick="handleBgUrl()">Use URL</button>
        </div>

        <div class="alert-btn" style="border:none; margin-top:10px; color:#FF3B30;" onclick="document.getElementById('bgChangeModal').style.display='none'">Cancel</div>
    </div>
</div>

<div id="fullDescModal" class="ios-alert-mask" onclick="closeInsModal()" style="backdrop-filter: blur(15px); background: rgba(0,0,0,0.2);">
    
    <div class="aesthetic-card" onclick="event.stopPropagation()">
        
        <div class="aes-top-bar">
            <div class="aes-icon-circle close" onclick="closeInsModal()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="aes-hero">
            <div class="aes-blur-bg" id="aes-bg-layer"></div>
            <div class="aes-noise"></div>
            <div class="aes-overlay"></div>
        </div>

        <div class="aes-float-content">
            <div class="aes-avatar-box">
                <img id="aes-avatar-img" src="">
            </div>
            <div class="aes-title-group">
                <div class="aes-name" id="aes-name-txt">Character Name</div>
                <div class="aes-tag">ORIGINAL CHARACTER</div>
            </div>
        </div>

        <div class="aes-scroll-area">
            <div class="aes-text-body" id="aes-full-desc">
                </div>
            <div class="aes-divider">âœ¦</div>
        </div>

        </div>
</div>

<div id="delConfirmModal" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Delete Character?</div>
        <div class="alert-msg">This action cannot be undone.</div>
        <div class="alert-btn" style="color:#FF3B30;" onclick="confirmDelete()">Delete</div>
        <div class="alert-btn" onclick="document.getElementById('delConfirmModal').style.display='none'">Cancel</div>
    </div>
</div>

<div id="settingsApp" class="ios-app-window" style="background:#F2F2F7; z-index: 5000;">
    
    <div class="app-header" style="background: rgba(242,242,247,0.85); backdrop-filter: saturate(180%) blur(20px); z-index: 10;">
        <div class="header-title-big" style="flex:1; text-align: left; padding-left: 10px;">Settings</div>
        <div class="header-close-btn" onclick="closeApp('settingsApp')" style="background:#e5e5ea;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body" style="padding: 20px 16px; align-items: stretch;">
        <div class="ios-list-group">
            
            <div class="ios-list-item" onclick="openSubPage('subpage-timezone')">
                <div class="item-icon" style="background: #FF9500;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div class="item-content">
                    <span class="item-label">Timezone</span>
                    <div class="item-right">
                        <span class="item-value" id="val-timezone">Automatic</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-api'); loadApiSettingsUI();">
                <divCON class="item-icon" style="background: #34C759;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                </divCON>
                <div class="item-content">
                    <span class="item-label">AI Configuration</span>
                    <div class="item-right">
                        <span class="item-value" id="api-status-preview">Default</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-display'); loadFontSettings();">
                <div class="item-icon" style="background: #007AFF;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
                </div>
                <div class="item-content" style="border-bottom: none;">
                    <span class="item-label">Display & Brightness</span>
                    <div class="item-right">
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-instructions')">
                <div class="item-icon" style="background: #8E8E93;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <div class="item-content" style="border-bottom: none;">
                    <span class="item-label">Instructions</span>
                    <div class="item-right">
                        <span class="item-value">Guide</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-voice-settings'); loadVoiceSettingsUI();">
                <div class="item-icon" style="background: #007AFF;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </div>
                <div class="item-content">
                    <span class="item-label">Voice Engine</span>
                    <div class="item-right">
                        <span class="item-value" id="voice-model-preview">TTS-1</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

        </div>
        <div style="font-size:12px; color:#8e8e93; margin-top:10px; margin-left:16px;">iOS Pro Ultimate v1.0</div>
    </div>

    <div id="subpage-timezone" class="ios-sub-page" style="display: flex; flex-direction: column; height: 100%; width: 100%; background: #F2F2F7; position: absolute; top: 0; left: 0; z-index: 20;">
        <div class="app-header" style="flex-shrink: 0; height: 60px; background: rgba(242,242,247,0.85); backdrop-filter: saturate(180%) blur(20px); z-index: 999; position: relative;">
            <div class="header-left-btn" onclick="closeSubPage('subpage-timezone')" style="margin-left: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                <span style="color:#007AFF; font-size:16px; font-weight:500;">Back</span>
            </div>
            <div class="header-title-big" style="font-size:17px; text-align:center; flex:1;">Time Zone</div>
            <div style="width:60px;"></div> 
        </div>

        <div class="app-body" style="flex: 1; overflow-y: auto; padding: 0 16px 80px 16px; width: 100%; align-items: stretch; -webkit-overflow-scrolling: touch;">
            <div style="padding: 10px 0;">
                <div class="ios-search-wrapper" style="padding: 12px 10px;">
                    <svg class="search-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="tz-search-input" class="ios-search-input" placeholder="Search City or Region" oninput="filterTimezoneList(this.value)">
                </div>
            </div>

            <div class="tz-group-title">Current Location</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="setTimezone('')">
                    <div class="item-content" style="border-bottom:none;"><span class="item-label">Automatic (System)</span><div class="item-check" id="check-auto"></div></div>
                </div>
            </div>

            <div id="tz-city-container">
                <div class="tz-group-title">ASIA & PACIFIC</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="beijing china" onclick="setTimezone('Asia/Shanghai', 'Beijing')">
                        <div class="item-content"><span class="item-label">Beijing</span><div class="item-check" id="check-Asia/Shanghai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="shanghai china" onclick="setTimezone('Asia/Shanghai', 'Shanghai')">
                        <div class="item-content"><span class="item-label">Shanghai</span><div class="item-check" id="check-Asia/Shanghai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="hong kong hk" onclick="setTimezone('Asia/Hong_Kong', 'Hong Kong')">
                        <div class="item-content"><span class="item-label">Hong Kong</span><div class="item-check" id="check-Asia/Hong_Kong"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="taipei taiwan" onclick="setTimezone('Asia/Taipei', 'Taipei')">
                        <div class="item-content"><span class="item-label">Taipei</span><div class="item-check" id="check-Asia/Taipei"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="tokyo japan" onclick="setTimezone('Asia/Tokyo', 'Tokyo')">
                        <div class="item-content"><span class="item-label">Tokyo</span><div class="item-check" id="check-Asia/Tokyo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="seoul korea" onclick="setTimezone('Asia/Seoul', 'Seoul')">
                        <div class="item-content"><span class="item-label">Seoul</span><div class="item-check" id="check-Asia/Seoul"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="singapore" onclick="setTimezone('Asia/Singapore', 'Singapore')">
                        <div class="item-content"><span class="item-label">Singapore</span><div class="item-check" id="check-Asia/Singapore"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="bangkok thailand" onclick="setTimezone('Asia/Bangkok', 'Bangkok')">
                        <div class="item-content"><span class="item-label">Bangkok</span><div class="item-check" id="check-Asia/Bangkok"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="dubai uae" onclick="setTimezone('Asia/Dubai', 'Dubai')">
                        <div class="item-content"><span class="item-label">Dubai</span><div class="item-check" id="check-Asia/Dubai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="mumbai india" onclick="setTimezone('Asia/Kolkata', 'Mumbai')">
                        <div class="item-content"><span class="item-label">Mumbai</span><div class="item-check" id="check-Asia/Kolkata"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="jakarta indonesia" onclick="setTimezone('Asia/Jakarta', 'Jakarta')">
                        <div class="item-content"><span class="item-label">Jakarta</span><div class="item-check" id="check-Asia/Jakarta"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="sydney australia" onclick="setTimezone('Australia/Sydney', 'Sydney')">
                        <div class="item-content"><span class="item-label">Sydney</span><div class="item-check" id="check-Australia/Sydney"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="melbourne australia" onclick="setTimezone('Australia/Melbourne', 'Melbourne')">
                        <div class="item-content"><span class="item-label">Melbourne</span><div class="item-check" id="check-Australia/Melbourne"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="auckland new zealand" onclick="setTimezone('Pacific/Auckland', 'Auckland')">
                        <div class="item-content"><span class="item-label">Auckland</span><div class="item-check" id="check-Pacific/Auckland"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="manila philippines" onclick="setTimezone('Asia/Manila', 'Manila')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Manila</span><div class="item-check" id="check-Asia/Manila"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">EUROPE</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="london uk" onclick="setTimezone('Europe/London', 'London')">
                        <div class="item-content"><span class="item-label">London</span><div class="item-check" id="check-Europe/London"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="paris france" onclick="setTimezone('Europe/Paris', 'Paris')">
                        <div class="item-content"><span class="item-label">Paris</span><div class="item-check" id="check-Europe/Paris"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="berlin germany" onclick="setTimezone('Europe/Berlin', 'Berlin')">
                        <div class="item-content"><span class="item-label">Berlin</span><div class="item-check" id="check-Europe/Berlin"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="rome italy" onclick="setTimezone('Europe/Rome', 'Rome')">
                        <div class="item-content"><span class="item-label">Rome</span><div class="item-check" id="check-Europe/Rome"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="madrid spain" onclick="setTimezone('Europe/Madrid', 'Madrid')">
                        <div class="item-content"><span class="item-label">Madrid</span><div class="item-check" id="check-Europe/Madrid"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="amsterdam netherlands" onclick="setTimezone('Europe/Amsterdam', 'Amsterdam')">
                        <div class="item-content"><span class="item-label">Amsterdam</span><div class="item-check" id="check-Europe/Amsterdam"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="zurich switzerland" onclick="setTimezone('Europe/Zurich', 'Zurich')">
                        <div class="item-content"><span class="item-label">Zurich</span><div class="item-check" id="check-Europe/Zurich"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="vienna austria" onclick="setTimezone('Europe/Vienna', 'Vienna')">
                        <div class="item-content"><span class="item-label">Vienna</span><div class="item-check" id="check-Europe/Vienna"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="stockholm sweden" onclick="setTimezone('Europe/Stockholm', 'Stockholm')">
                        <div class="item-content"><span class="item-label">Stockholm</span><div class="item-check" id="check-Europe/Stockholm"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="athens greece" onclick="setTimezone('Europe/Athens', 'Athens')">
                        <div class="item-content"><span class="item-label">Athens</span><div class="item-check" id="check-Europe/Athens"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="moscow russia" onclick="setTimezone('Europe/Moscow', 'Moscow')">
                        <div class="item-content"><span class="item-label">Moscow</span><div class="item-check" id="check-Europe/Moscow"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="istanbul turkey" onclick="setTimezone('Europe/Istanbul', 'Istanbul')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Istanbul</span><div class="item-check" id="check-Europe/Istanbul"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">AMERICAS</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="new york usa" onclick="setTimezone('America/New_York', 'New York')">
                        <div class="item-content"><span class="item-label">New York</span><div class="item-check" id="check-America/New_York"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="los angeles la usa" onclick="setTimezone('America/Los_Angeles', 'Los Angeles')">
                        <div class="item-content"><span class="item-label">Los Angeles</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="chicago usa" onclick="setTimezone('America/Chicago', 'Chicago')">
                        <div class="item-content"><span class="item-label">Chicago</span><div class="item-check" id="check-America/Chicago"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="toronto canada" onclick="setTimezone('America/Toronto', 'Toronto')">
                        <div class="item-content"><span class="item-label">Toronto</span><div class="item-check" id="check-America/Toronto"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="vancouver canada" onclick="setTimezone('America/Vancouver', 'Vancouver')">
                        <div class="item-content"><span class="item-label">Vancouver</span><div class="item-check" id="check-America/Vancouver"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="mexico city" onclick="setTimezone('America/Mexico_City', 'Mexico City')">
                        <div class="item-content"><span class="item-label">Mexico City</span><div class="item-check" id="check-America/Mexico_City"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="sao paulo brazil" onclick="setTimezone('America/Sao_Paulo', 'Sao Paulo')">
                        <div class="item-content"><span class="item-label">Sao Paulo</span><div class="item-check" id="check-America/Sao_Paulo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="buenos aires argentina" onclick="setTimezone('America/Argentina/Buenos_Aires', 'Buenos Aires')">
                        <div class="item-content"><span class="item-label">Buenos Aires</span><div class="item-check" id="check-America/Argentina/Buenos_Aires"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="san francisco usa" onclick="setTimezone('America/Los_Angeles', 'San Francisco')">
                        <div class="item-content"><span class="item-label">San Francisco</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="seattle usa" onclick="setTimezone('America/Los_Angeles', 'Seattle')">
                        <div class="item-content"><span class="item-label">Seattle</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="miami usa" onclick="setTimezone('America/New_York', 'Miami')">
                        <div class="item-content"><span class="item-label">Miami</span><div class="item-check" id="check-America/New_York"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="honolulu hawaii" onclick="setTimezone('Pacific/Honolulu', 'Honolulu')">
                        <div class="item-content"><span class="item-label">Honolulu</span><div class="item-check" id="check-Pacific/Honolulu"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="anchorage alaska" onclick="setTimezone('America/Anchorage', 'Anchorage')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Anchorage</span><div class="item-check" id="check-America/Anchorage"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">MIDDLE EAST & AFRICA</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="riyadh saudi arabia" onclick="setTimezone('Asia/Riyadh', 'Riyadh')">
                        <div class="item-content"><span class="item-label">Riyadh</span><div class="item-check" id="check-Asia/Riyadh"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="cairo egypt" onclick="setTimezone('Africa/Cairo', 'Cairo')">
                        <div class="item-content"><span class="item-label">Cairo</span><div class="item-check" id="check-Africa/Cairo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="johannesburg south africa" onclick="setTimezone('Africa/Johannesburg', 'Johannesburg')">
                        <div class="item-content"><span class="item-label">Johannesburg</span><div class="item-check" id="check-Africa/Johannesburg"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="nairobi kenya" onclick="setTimezone('Africa/Nairobi', 'Nairobi')">
                        <div class="item-content"><span class="item-label">Nairobi</span><div class="item-check" id="check-Africa/Nairobi"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="tehran iran" onclick="setTimezone('Asia/Tehran', 'Tehran')">
                        <div class="item-content"><span class="item-label">Tehran</span><div class="item-check" id="check-Asia/Tehran"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="jerusalem israel" onclick="setTimezone('Asia/Jerusalem', 'Jerusalem')">
                        <div class="item-content"><span class="item-label">Jerusalem</span><div class="item-check" id="check-Asia/Jerusalem"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="qatar doha" onclick="setTimezone('Asia/Qatar', 'Doha')">
                        <div class="item-content"><span class="item-label">Doha</span><div class="item-check" id="check-Asia/Qatar"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="casablanca morocco" onclick="setTimezone('Africa/Casablanca', 'Casablanca')">
                        <div class="item-content"><span class="item-label">Casablanca</span><div class="item-check" id="check-Africa/Casablanca"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="lagos nigeria" onclick="setTimezone('Africa/Lagos', 'Lagos')">
                        <div class="item-content"><span class="item-label">Lagos</span><div class="item-check" id="check-Africa/Lagos"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="cape town" onclick="setTimezone('Africa/Johannesburg', 'Cape Town')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Cape Town</span><div class="item-check" id="check-Africa/Johannesburg"></div></div>
                    </div>
                </div>

                <div id="tz-no-result" style="display:none; text-align:center; padding:40px; color:#999; font-size:14px;">
                    No Results Found
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-api" class="ios-sub-page" style="display: flex; flex-direction: column; height: 100%; width: 100%; background: #F2F2F7; position: absolute; top: 0; left: 0; z-index: 20;">
        
        <div class="app-header" style="flex-shrink: 0; height: 110px; padding-top: 55px; padding-bottom: 12px; background: rgba(242,242,247,0.95); backdrop-filter: saturate(180%) blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: flex-end; justify-content: space-between; padding-left: 16px; padding-right: 16px; z-index: 50; box-sizing: border-box;">
            
            <div onclick="closeSubPage('subpage-api')" style="color: #007AFF; font-size: 16px; display: flex; align-items: center; cursor: pointer; width: 70px; height: 30px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: -2px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                Back
            </div>
            
            <div style="font-size: 17px; font-weight: 600; text-align: center; flex: 1; padding-bottom: 5px;">AI Config</div>
            
            <div onclick="openSavePresetModal()" style="color: #007AFF; font-size: 16px; font-weight: 600; cursor: pointer; width: 70px; text-align: right; height: 30px; line-height: 30px;">
                Save
            </div>
        </div>

        <div class="app-body" style="flex: 1; overflow-y: auto; padding: 10px 16px 100px 16px; -webkit-overflow-scrolling: touch; width: 100%; display: flex; flex-direction: column; align-items: stretch; box-sizing: border-box;">
            
            <div class="tz-group-title" style="margin-top: 20px;">CONNECTION</div>
            <div class="ios-list-group">
                <div class="ios-list-item input-item">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Host</span>
                    <input type="text" id="api-url" class="ios-input-clean" placeholder="https://api.openai.com/v1">
                </div>
                <div class="ios-list-item input-item">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Key</span>
                    <input type="password" id="api-key" class="ios-input-clean" placeholder="sk-...">
                </div>
            </div>

            <div class="tz-group-title">MODEL</div>
            <div class="ios-list-group" style="padding: 0;">
                <div class="ios-list-item" style="padding-right: 16px;" onclick="openModelPicker()">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Name</span>
                    
                    <div id="api-model-display" style="flex:1; text-align:right; color:#007AFF; font-size:16px; display:flex; align-items:center; justify-content:flex-end;">
                        gpt-3.5-turbo
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>

                    <input type="hidden" id="api-model-select" value="gpt-3.5-turbo">
                </div>
                
                <div class="ios-list-item" style="justify-content: center; color: #007AFF; font-weight: 600; cursor: pointer;" onclick="fetchModelList()">
                    Fetch Models from Server
                </div>
            </div>

            <div class="tz-group-title">PARAMETERS</div>
            <div class="ios-list-group" style="padding: 20px 16px; display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Temperature</span>
                    <span id="temp-display" style="font-weight:700;">0.7</span>
                </div>
                <input type="range" id="api-temp" min="0" max="2" step="0.1" value="0.7" class="ios-slider" 
                    oninput="document.getElementById('temp-display').textContent = this.value; updateSliderFill(this)">
                <div style="height:25px;"></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Context Limit</span>
                    <span id="context-display" style="font-weight:700;">10</span>
                </div>
                <input type="range" id="api-context" min="2" max="30" step="2" value="10" class="ios-slider" 
                    oninput="document.getElementById('context-display').textContent = this.value; updateSliderFill(this)">
            </div>

            <div class="tz-group-title">TEST CONNECTION</div>
            <div id="test-chat-log" class="chat-log-area">
                <div style="color:#999; text-align:center; margin-top:50px; font-size:13px;">
                    Test your connection here...
                </div>
            </div>
            
            <div class="chat-input-bar">
                <input type="text" id="test-chat-input" class="chat-input-field" placeholder="Say hello...">
                <div class="chat-send-btn" onclick="sendTestChat()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
            </div>

            <div class="tz-group-title">SAVED PRESETS</div>
            <div id="preset-list" class="ios-list-group">
                <div class="ios-list-item" style="color:#999; justify-content:center;">No presets saved</div>
            </div>

            <button class="ios-btn" style="background: #FF3B30; color: #fff; margin-top: 30px; margin-bottom: 20px; flex-shrink: 0;" onclick="openResetConfirm()">
                Reset All Settings
            </button>

        </div>
    </div>
    <div id="subpage-display" class="ios-sub-page">
        <div class="app-header">
            <div onclick="closeSubPage('subpage-display')" style="color:#007AFF; font-size:17px; cursor:pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:-6px;"><polyline points="15 18 9 12 15 6"></polyline></svg> Back
            </div>
            <div style="font-size:17px; font-weight:600;">Display & Font</div>
            <div onclick="window.saveFontSettings()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">Save</div>
        </div>

        <div class="app-body">
            <div class="tz-group-title">Real-time Preview</div>
            <div style="display:flex; gap:10px; margin-bottom:24px;">
                <div style="flex:1; background:#fff; border-radius:14px; padding:15px; height:100px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div id="preview-text-main">App Text</div>
                </div>
                <div style="flex:1; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:14px; padding:15px; height:100px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div id="preview-text-desktop">Home Text</div>
                </div>
            </div>

            <div class="tz-group-title">Color Palettes</div>
            <div class="ios-list-group">
                <div class="ios-list-item color-item-row">
                    <span class="item-label">App Interface</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="color-val-main" style="font-size:12px; color:#8e8e93; font-family:monospace;">#1D1D1F</span>
                        <input type="color" id="color-picker-main" class="color-picker-circle" oninput="window.updateColorPreview('main', this.value)">
                    </div>
                </div>
                <div class="ios-list-item color-item-row" style="border-bottom:none;">
                    <span class="item-label">Home Screen</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="color-val-desktop" style="font-size:12px; color:#8e8e93; font-family:monospace;">#1D1D1F</span>
                        <input type="color" id="color-picker-desktop" class="color-picker-circle" oninput="window.updateColorPreview('desktop', this.value)">
                    </div>
                </div>
            </div>

            <div class="tz-group-title" style="margin-top:24px;">Font Style</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openFontPicker()">
                    <span class="item-label">Font Family</span>
                    <div id="font-family-display" style="flex:1; text-align:right; color:#007AFF; display:flex; align-items:center; justify-content:flex-end;">System Default <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                </div>
                <div class="ios-list-item" style="color:#007AFF; justify-content:center; font-weight:600;" onclick="document.getElementById('upload-font-file').click()">Import .ttf Font</div>
                <input type="file" id="upload-font-file" accept=".ttf,.otf" style="display:none;" onchange="window.handleFontUpload(this)">
            </div>

            <div class="tz-group-title">Typography</div>
            <div class="ios-list-group" style="padding: 20px 16px; display: block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Size</span>
                    <span id="size-display" style="font-weight:700;">16px</span>
                </div>
                <input type="range" id="font-size-slider" min="12" max="24" step="1" value="16" class="ios-slider" 
                    oninput="window.updateFontPreview('size', this.value); updateSliderFill(this)">
                
                <div style="height:30px;"></div>

                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Weight</span>
                    <span id="weight-display" style="font-weight:700;">400</span>
                </div>
                <input type="range" id="font-weight-slider" min="100" max="900" step="100" value="400" class="ios-slider" 
                    oninput="window.updateFontPreview('weight', this.value); updateSliderFill(this)">
            </div>

            <button class="ios-btn" style="background:#FF3B30; color:#fff; margin-top:30px;" onclick="window.resetFontSettings()">Reset to Default</button>
        </div>
    </div>
    <div id="subpage-instructions" class="ios-sub-page">
        <div class="app-header">
            <div onclick="closeSubPage('subpage-instructions')" style="color: #007AFF; font-size: 17px; cursor:pointer; display:flex; align-items:center; width: 70px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:-2px;"><polyline points="15 18 9 12 15 6"></polyline></svg> Back
            </div>
            <div style="font-size:17px; font-weight:600; text-align:center; flex:1;">Instructions</div>
            <div style="width:70px;"></div>
        </div>

        <div class="app-body">
            <div class="tz-group-title">SYSTEM MODULES</div>
            
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openInsAppModal('ins-wallpaper-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5" fill="white"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: 0.5px solid rgba(0,0,0,0.05);">
                        <span class="item-label">Wallpaper Engine</span>
                    </div>
                </div>

                <div class="ios-list-item" onclick="openInsAppModal('ins-character-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: 0.5px solid rgba(0,0,0,0.05);">
                        <span class="item-label">Character Book</span>
                    </div>
                </div>

                <div class="ios-list-item" onclick="openInsAppModal('ins-settings-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="#3a3a3c">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: none;">
                        <span class="item-label">System Settings</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px; opacity: 0.3; font-size: 11px;">
                iOS Pro Ultimate System Edition
            </div>
        </div>
    </div>

</div>
<div id="iosInputModal" class="ios-alert-mask" style="z-index: 20000;">
    <div class="ios-alert-box">
        <div class="alert-title" id="input-modal-title">Name This Preset</div>
        <div style="padding: 0 15px 15px 15px;">
            <input type="text" id="input-modal-val" class="ios-input" style="margin:0; text-align:center;" placeholder="e.g. GPT-4">
        </div>
        <div style="display:flex; border-top:0.5px solid rgba(60,60,67,0.29);">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid rgba(60,60,67,0.29); color:#007AFF; font-weight:400;" onclick="closeInputModal()">Cancel</div>
            <div class="alert-btn" style="flex:1; color:#007AFF;" onclick="confirmInputModal()">Save</div>
        </div>
    </div>
</div>

<div id="iosConfirmModal" class="ios-alert-mask" style="z-index: 20000;">
    <div class="ios-alert-box">
        <div class="alert-title" id="confirm-modal-title">Are you sure?</div>
        <div class="alert-msg" id="confirm-modal-msg">This action cannot be undone.</div>
        <div style="display:flex; border-top:0.5px solid rgba(60,60,67,0.29);">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid rgba(60,60,67,0.29); color:#007AFF; font-weight:400;" onclick="closeConfirmModal()">Cancel</div>
            <div class="alert-btn" id="confirm-modal-btn" style="flex:1; color:#FF3B30;" onclick="executeConfirmAction()">Delete</div>
        </div>
    </div>
</div>
<div id="modelPickerSheet" class="ios-alert-mask" style="display:none; align-items:flex-end; background:rgba(0,0,0,0.4); z-index: 99999;" onclick="closeModelPicker()">
    <div class="ios-action-sheet" onclick="event.stopPropagation()">
        <div class="sheet-title-box">Select AI Model</div>
        
        <div id="model-sheet-list" style="max-height:300px; overflow-y:auto; -webkit-overflow-scrolling:touch;">
            <div class="sheet-item" onclick="selectModel('gpt-3.5-turbo')">gpt-3.5-turbo</div>
            <div class="sheet-item" onclick="selectModel('gpt-4o')">gpt-4o</div>
            <div class="sheet-item" onclick="selectModel('claude-3-5-sonnet')">claude-3-5-sonnet</div>
        </div>
        
        <div class="sheet-cancel" onclick="closeModelPicker()">Cancel</div>
    </div>
</div>
<div id="ins-wallpaper-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px);">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-wallpaper-modal')"></div>
            <div class="ins-brand-tag">MODULE INFO</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5" fill="white"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">Wallpaper Engine</h2>
            <p class="ins-subtitle">Personalization & Visual Core</p>
            
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Hybrid Rendering</strong>
                        <p>å†…ç½®æ··åˆæ¸²æŸ“æŠ€æœ¯ã€‚æ”¯æŒ 8K è¶…é«˜æ¸…é™æ€å›¾åƒï¼ˆJPG/PNGï¼‰ä¸åŠ¨æ€è§†é¢‘æµï¼ˆMP4/WebMï¼‰ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶åç¼€å¹¶æ™ºèƒ½åˆ‡æ¢ Canvas æˆ– Video æ¸²æŸ“å±‚ï¼Œç¡®ä¿ç”»è´¨é›¶æŸè€—ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>Binary Storage Logic</strong>
                        <p>æ‘’å¼ƒä¼ ç»Ÿçš„ URL å¼•ç”¨æ–¹å¼ï¼Œé‡‡ç”¨ Blob äºŒè¿›åˆ¶æŠ€æœ¯å°†å£çº¸å­˜å…¥æµè§ˆå™¨åº•å±‚çš„ IndexedDBã€‚è¿™æ„å‘³ç€å³ä¾¿ä½ å…³é—­ç½‘é¡µæˆ–å¤„äºç¦»çº¿çŠ¶æ€ï¼Œå‡ ç™¾å…†çš„åŠ¨æ€å£çº¸ä¾ç„¶èƒ½å®ç°â€œç§’å¼€â€è€Œä¸æ¶ˆè€—ç½‘ç»œæµé‡ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Interactive Selection</strong>
                        <p>ç‚¹å‡»â€œSelect Fileâ€å”¤èµ·ç³»ç»Ÿçº§æ–‡ä»¶é€‰æ‹©å™¨ã€‚é€‰æ‹©åï¼Œç³»ç»Ÿå°†è¿›å…¥â€œé¢„è½½å…¥æ€ï¼ˆPre-loadingï¼‰â€ï¼Œé¢„è§ˆæ»¡æ„åç‚¹å‡»åº•éƒ¨ç¡®è®¤é”®ï¼Œå£çº¸å°†é€šè¿‡å…¨å±€æ€»çº¿ï¼ˆEvent Busï¼‰å®æ—¶æ¨é€åˆ°èƒŒæ™¯å±‚ï¼Œæ— éœ€åˆ·æ–°é¡µé¢ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Layer Compositing</strong>
                        <p>å£çº¸å±‚ä¸ UI å±‚é‡‡ç”¨ç‰©ç†éš”ç¦»ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºå£çº¸ä¸Šæ–¹è¦†ç›–ä¸€å±‚åŠ¨æ€é®ç½©ï¼ˆOverlayï¼‰ï¼Œæ ¹æ®å£çº¸äº®åº¦è‡ªåŠ¨å¾®è°ƒå¯¹æ¯”åº¦ï¼Œç¡®ä¿å³ä¾¿æ˜¯åœ¨å…¨ç™½å£çº¸ä¸‹ï¼ŒçŠ¶æ€æ å’Œ App ä¾ç„¶æ¸…æ™°å¯è§ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Memory Cleaning</strong>
                        <p>ç³»ç»Ÿå®æ—¶ç›‘æ§å£çº¸å ç”¨çš„ç¼“å­˜ç©ºé—´ã€‚å½“ä½ æƒ³æ›´æ¢é£æ ¼æ—¶ï¼Œç‚¹å‡»â€œResetâ€å°†æ‰§è¡Œæ·±åº¦åƒåœ¾å›æ”¶ï¼ˆGCï¼‰é€»è¾‘ï¼Œå½»åº•æŠ¹é™¤æ—§å£çº¸æ®‹ç•™çš„å†…å­˜ç¢ç‰‡ï¼Œä¿æŒç³»ç»Ÿæé€Ÿè¿è¡Œã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-wallpaper-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>
<div id="ins-character-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); display:none;">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-character-modal')" style="background: #FFBD2E;"></div>
            <div class="ins-brand-tag">CHARACTER CORE</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">Character Book</h2>
            <p class="ins-subtitle">Identity & Interactive Logic</p>
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Lifecycle Management</strong>
                        <p>ç‚¹å‡»åˆ—è¡¨é¦–ä½çš„â€œè™šçº¿æ–¹æ¡†â€å³å¯è¿›å…¥åˆ›ä½œæ¨¡å¼ã€‚ç³»ç»Ÿæ”¯æŒæ— é™é‡åˆ›å»ºè™šæ‹Ÿè§’è‰²ï¼Œæ¯ä¸ªè§’è‰²æ‹¥æœ‰ç‹¬ç«‹çš„å”¯ä¸€ IDï¼Œç¡®ä¿æ•°æ®åœ¨å¤æ‚çš„è”è§‰é€»è¾‘ä¸­äº’ä¸å¹²æ‰°ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>Aesthetic Skinning</strong>
                        <p>è¿›å…¥è¯¦æƒ…é¡µåï¼Œç‚¹å‡»é¡¶éƒ¨åŒºåŸŸå¯å”¤èµ·â€œå°é¢é‡‡é›†å™¨â€ï¼Œæ”¯æŒæœ¬åœ°æ–‡ä»¶ä¸Šä¼ æˆ–ç²˜è´´ 4K URLã€‚å¤´åƒæ¡†é‡‡ç”¨ç‰©ç†é‡å è§†è§‰ç®—æ³•ï¼Œé…åˆæ¯›ç»ç’ƒæ»¤é•œï¼Œè¥é€ é¡¶çº§æ‚å¿—å°é¢æ„Ÿã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Interaction Protocol</strong>
                        <p>ç‚¹å‡»ç®€ä»‹åŒºçš„â€œMoreâ€å¯è§¦å‘å…¨å±æ²‰æµ¸å¼é˜…è¯»æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šæ ¹æ®è§’è‰²èƒŒæ™¯è‡ªåŠ¨è°ƒæ•´å…‰å½±æ°›å›´ï¼Œç‚¹å‡»æ‚¬æµ®è¿”å›é”®å³å¯æ— ç¼åˆ‡å›ç®¡ç†ç½‘æ ¼ï¼Œä½“éªŒä¸æ»‘ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Persistent Core</strong>
                        <p>æ‰€æœ‰è§’è‰²è®¾å®šï¼ˆå§“åã€ç®€ä»‹ã€å°é¢å›¾ã€å¤´åƒï¼‰å‡é‡‡ç”¨å¼‚æ­¥å†™å…¥æŠ€æœ¯å­˜å…¥æµè§ˆå™¨åº•å±‚æ•°æ®åº“ï¼ˆIndexedDBï¼‰ã€‚å³ä¾¿æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–ç¦»çº¿ä½¿ç”¨ï¼Œä½ çš„è§’è‰²ä¹¦ä¾ç„¶æ°¸å­˜ã€‚</p>
                    </div>
                </div>
                
                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Operations Guide</strong>
                        <p>é•¿æŒ‰æˆ–ç‚¹å‡»â€œEdit Profileâ€å¯å®æ—¶ä¿®æ”¹è§’è‰²é…ç½®ï¼›ç‚¹å‡»å±é™©çº¢åŒºçš„â€œDeleteâ€å°†è§¦å‘åŒé‡ç”Ÿç‰©ç¡®è®¤é€»è¾‘ï¼Œé˜²æ­¢çè´µæ•°æ®è¯¯åˆ ã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-character-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>

<div id="ins-settings-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); display:none;">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-settings-modal')" style="background: #28C940;"></div>
            <div class="ins-brand-tag">SYSTEM KERNEL</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="#3a3a3c">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">System Settings</h2>
            <p class="ins-subtitle">Global Environment Tuning</p>
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Global Timezone Sync</strong>
                        <p>é›†æˆ 50 ä¸ªå…¨çƒæ ¸å¿ƒåŸå¸‚æ—¶åŒºæ•°æ®ã€‚æ”¯æŒæ¨¡ç³Šæœç´¢è¿‡æ»¤ï¼Œé€‰ä¸­åŸå¸‚åç³»ç»Ÿå°†æ ¹æ® Intl åè®®æ¯«ç§’çº§åŒæ­¥æ¡Œé¢å¤©æ°”ç»„ä»¶ä¸çŠ¶æ€æ çš„æ—¶é—´æ˜¾ç¤ºã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>AI Configuration</strong>
                        <p>æ”¯æŒæ¥å…¥ OpenAI æ ‡å‡†æ¥å£ã€‚ä½ å¯ä»¥åœ¨æ­¤é…ç½® Host ä¸ API Keyï¼Œå¹¶è°ƒèŠ‚ Temperatureï¼ˆåˆ›é€ åŠ›ï¼‰å’Œ Contextï¼ˆè®°å¿†æ·±åº¦ï¼‰ã€‚å†…ç½® iMessage é£æ ¼çš„æµ‹è¯•æ²™ç›’ï¼Œç”¨äºéªŒè¯è¿æ¥æ˜¯å¦æˆåŠŸã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Display & Font Settings</strong>
                        <p>æ”¯æŒå…¨å±€å­—å·ï¼ˆ12px-24pxï¼‰ä¸ç²—ç»†ï¼ˆ100-900ï¼‰è°ƒèŠ‚ã€‚æä¾› .ttf æ–‡ä»¶ä¸Šä¼ æ¥å£ã€‚é€šè¿‡ CSS å˜é‡æŠ€æœ¯å®ç°å®æ—¶é¢„è§ˆï¼Œä¸”å…·å¤‡æ¡Œé¢å¸ƒå±€ä¿æŠ¤åŠŸèƒ½ï¼Œé˜²æ­¢å›¾æ ‡æ–‡å­—è¢«æŒ¤ä¹±ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Color Customization</strong>
                        <p>é‡‡ç”¨ç‰©ç†åˆ†ç¦»è°ƒè‰²é€»è¾‘ã€‚ä½ å¯ä»¥ç‹¬ç«‹å®šä¹‰ App å†…éƒ¨åˆ—è¡¨çš„æ–‡å­—é¢œè‰²ï¼Œä»¥åŠä¸»å±å¹•ï¼ˆçŠ¶æ€æ ã€å›¾æ ‡åã€å¤©æ°”ï¼‰çš„æ–‡å­—é¢œè‰²ã€‚æ”¯æŒå®æ—¶ HEX ç åé¦ˆä¸ä¿å­˜åŒæ­¥ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Persistence & Reset</strong>
                        <p>æ‰€æœ‰è®¾ç½®å˜æ›´å‡é€šè¿‡ LocalStorage å®æ—¶ä¿å­˜ã€‚ç³»ç»Ÿåº•éƒ¨æä¾›çº¢è‰²â€œReset to Defaultsâ€æŒ‰é’®ï¼Œå¯ä¸€é”®æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰é…ç½®å¹¶æ¢å¤åˆ°åˆå§‹è“é»‘ä¸»é¢˜ã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-settings-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>
<div id="p2-editor-modal" class="ios-alert-mask" onclick="if(event.target==this) window.closeP2Editor()">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span id="p2-editor-title">Update Hero Cover</span>
            <div class="p2-done-btn" onclick="window.closeP2Editor()">Done</div>
        </div>
        
        <div class="p2-editor-body">
            <input type="text" id="p2-main-input" class="p2-main-input" placeholder="Paste image link here...">
            
            <div id="p2-upload-area">
                <div style="text-align:center; color:#d1d1d6; font-size:12px; margin-bottom:15px; font-weight:800;">OR</div>
                
                <label class="custom-upload-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span>Upload from Gallery</span>
                    <input type="file" id="p2-file-input" hidden accept="image/*" onchange="window.handleP2File(this)">
                </label>
            </div>
        </div>
    </div>
</div>
<div id="cipher-web-app" class="full-app-screen" style="display:none; background:#000;">
    <div class="app-header">
        <div class="back-btn" onclick="closeApp('cipherWebApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </div>
        <div class="app-title-group">
            <span class="main-title">Cipher Web</span>
            <span class="sub-status" id="web-ai-status">Connected to RoleBook</span>
        </div>
        <div class="header-action" onclick="resetWeb()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L19 10M1 14l1.64 4.36A9 9 0 0 0 17.51 15"/></svg></div>
    </div>

    <div class="web-canvas-container" id="web-canvas">
        <svg id="web-svg-layer" width="100%" height="100%">
            </svg>
        <div id="web-nodes-layer">
            </div>
    </div>

    <div class="web-input-bar">
        <input type="text" id="cipher-input" placeholder="Whisper a word..." onkeypress="if(event.key==='Enter') sendCipher()">
        <button class="send-cipher-btn" onclick="sendCipher()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
    </div>
</div>
<div id="vibe-grid-app" class="ios-app-window" style="background: #F2F2F7;">
    <div class="app-header">
    <div class="header-title-big">Vibe Grid</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span onclick="openVibeHistory()" style="font-size: 13px; color: #8e8e93; font-weight: 600; cursor: pointer;">å†å²</span>
            <span onclick="openVibeGuide()" style="font-size: 13px; color: #007AFF; font-weight: 600; cursor: pointer;">åè®®</span>
            <div class="header-close-btn" onclick="closeApp('vibe-grid-app')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <div class="app-body" style="display:flex; flex-direction:column;">
        
        <div id="vibe-start-screen" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:100px; height:100px; background:linear-gradient(135deg, #1d1d1f, #434343); border-radius:24px; display:flex; align-items:center; justify-content:center; box-shadow:0 15px 30px rgba(0,0,0,0.1); margin-bottom:30px;">
                <svg width="45" height="45" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            </div>
            <h2 style="font-weight:800; font-size:26px; color:#1d1d1f; margin-bottom:8px;">åšå¼ˆå›å“</h2>
            <p style="color:#8e8e93; font-size:14px; margin-bottom:40px;">åœ¨æ–¹å¯¸ä¹‹é—´ï¼Œä¸äººæ ¼ç¢ç‰‡å¯¹å¼ˆ</p>
            <button class="ios-btn primary" onclick="openVibeCharPicker()">é€‰æ‹©åšå¼ˆå¯¹è±¡</button>
            <div onclick="openVibeGuide()" style="margin-top:25px; font-size:13px; color:#007AFF; font-weight:600; cursor:pointer;">é˜…è¯»å¯¹å±€åè®®</div>
        </div>

        <div id="vibe-game-main" style="display:none; opacity:0;">
            <div id="vibe-turn-indicator" style="text-align:center; padding:20px 0; font-weight:700; color:#8e8e93; font-size:12px; letter-spacing:2px;">
                RESONANCE PHASE
            </div>
            
            <div class="vibe-board-wrapper">
                <div id="vibe-board" class="vibe-board"></div>
            </div>

            <div id="opponent-bar" style="margin: 30px auto; width: 85%; display: flex; align-items: center; background: #fff; padding: 12px 18px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); position: relative;">
                <img id="opp-avatar" src="" style="width:44px; height:44px; border-radius:50%; object-fit:cover; background:#eee;">
                <div style="margin-left:15px; text-align:left; flex: 1;">
                    <div id="opp-name" style="font-weight:800; font-size:15px;">å¯¹æ‰‹</div>
                    <div id="opp-last-word" style="font-size: 13px; color: #007AFF; font-family: serif; font-style: italic; font-weight: 500; margin-top: 2px; opacity: 0; transition: opacity 0.5s;">
                        ç­‰å¾…æ³¨é­‚...
                    </div>
                </div>
                <div style="font-size:10px; color:#d1d1d6; font-weight:700; letter-spacing:1px;">ACTIVE</div>
            </div>
        </div>
    </div>

    <div id="modal-vibe-picker" class="ios-alert-mask" style="display: none; align-items: flex-end; z-index: 8000;">
        <div class="p2-editor-sheet">
            <div class="p2-editor-header">
                <span style="font-weight: 800; font-size: 17px;">é€‰æ‹©åšå¼ˆå¯¹è±¡</span>
                <span class="p2-done-btn" onclick="document.getElementById('modal-vibe-picker').style.display='none'">å–æ¶ˆ</span>
            </div>
            <div id="vibe-char-scroll-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-height: 55vh; overflow-y: auto; padding: 0 20px 40px 20px;">
                </div>
        </div>
    </div>

    <div id="modal-vibe-word-input" class="vibe-center-mask" style="display:none;">
        <div class="ios-alert-box" style="width:280px; border-radius:24px;">
            <div style="padding:25px 20px 15px 20px;">
                <div style="font-weight:800; font-size:17px; margin-bottom:8px;">æ³¨é­‚</div>
                <div style="font-size:12px; color:#8e8e93; margin-bottom:20px;">è¯·ä¸ºæ­¤å¤„æ³¨å…¥ä¸€ä¸ªæƒ…ç»ªè¯æ±‡</div>
                <input type="text" id="vibe-user-word" class="ios-input" style="text-align:center; background:#f2f2f7;" placeholder="è¾“å…¥è¯è¯­">
            </div>
            <div style="display:flex; border-top:0.5px solid #eee;">
                <div class="alert-btn" style="flex:1; border-right:0.5px solid #eee; color:#8e8e93;" onclick="document.getElementById('modal-vibe-word-input').style.display='none'">æ”¾å¼ƒ</div>
                <div class="alert-btn" style="flex:1; color:#007AFF; font-weight:700;" onclick="confirmVibeStep()">ç¡®å®š</div>
            </div>
        </div>
    </div>

    <div id="modal-vibe-guide" class="ios-alert-mask" style="display:none; z-index:9000; background:rgba(0,0,0,0.2); backdrop-filter:blur(15px);">
        <div class="ins-fancy-card" style="max-width:320px; border: 1px solid rgba(255,255,255,0.3);">
            <div class="ins-card-body" style="text-align:left; padding:35px 25px;">
                <h2 class="ins-title-serif" style="text-align:center; font-size:22px; margin-bottom:25px; letter-spacing:1px;">å¯¹å±€åè®® (PROTOCOL)</h2>
                
                <div class="ins-feature-list" style="margin-bottom:30px;">
                    <div class="ins-feat-item" style="border-left: 1.5px solid #007AFF; padding-left:15px; margin-bottom:20px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">æ³¨é­‚ä¸å›å“</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">æ¯è½ä¸€å­ï¼Œéœ€æ³¨å…¥ä¸€ä¸ªæƒ…ç»ªè¯æ±‡ã€‚ä½ çš„äººæ ¼å¯¹æ‰‹å°†æ ¹æ®å…¶å›ºæœ‰é€»è¾‘ï¼Œå›ä»¥å¯¹åº”çš„è¯è¯­å…±é¸£ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="ins-feat-item" style="border-left: 1.5px solid #1d1d1f; padding-left:15px; margin-bottom:20px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">èƒœè´Ÿçš„å¼•åŠ›</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">äº”å­è¿ç å³ä¸ºèƒœã€‚è‹¥æ£‹ç›˜æ»¡æº¢è€Œå¹³è¡¡æœªç ´ï¼Œå¯¹å±€å°†å½’äºâ€œç©ºå¯‚â€ç»“å±€ã€‚</p>
                        </div>
                    </div>

                    <div class="ins-feat-item" style="border-left: 1.5px solid #d1d1d6; padding-left:15px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">å™äº‹é‡å¡‘</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">å¯¹å±€ç»ˆäº†ï¼Œæ‰€æœ‰çš„è¯è¯­ç¢ç‰‡å°†æ±‡èšæˆä¸€æ®µç‹¬å±äºæ­¤åˆ»çš„ç§å¯†å›å“ã€‚é‚£æ˜¯ä½ ä»¬åšå¼ˆåçš„ä½™æ¸©ã€‚</p>
                        </div>
                    </div>
                </div>

                <button class="ins-done-btn" style="background:#1d1d1f; color:#fff; border-radius:12px;" onclick="closeVibeGuide()">è¿›å…¥åšå¼ˆ</button>
            </div>
        </div>
    </div>

    <div id="modal-vibe-result" class="ios-alert-mask vibe-center-box" style="display: none; z-index: 8000; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px);">
        <div class="aesthetic-card" style="height: auto; max-height: 80vh; width: 90%; max-width: 340px; background: #fff; border-radius: 32px; overflow: hidden; display: flex; flex-direction: column;">
            <div class="aes-hero" style="height: 120px; position: relative; overflow: hidden;">
                <div class="aes-blur-bg" id="res-hero-bg" style="position: absolute; inset: -10%; background-size: cover; background-position: center; filter: blur(20px); opacity: 0.6;"></div>
                <div class="aes-overlay" style="position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, #fff);"></div>
            </div>

            <div class="aes-float-content" style="margin-top: -40px; position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; text-align: center;">
                <div class="aes-avatar-box" style="width: 80px; height: 80px; border-radius: 20px; background: #fff; padding: 4px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: rotate(-2deg);">
                    <img id="res-avatar" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                </div>
                <div class="aes-title-group" style="margin-top: 15px;">
                    <div class="aes-name" id="res-title" style="font-size: 20px; font-weight: 800; color: #1d1d1f;">å¯¹å¼ˆå›å“</div>
                    <div class="aes-tag" id="res-outcome" style="margin-top: 5px; font-size: 10px; color: #007AFF; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;">MATCH ENDED</div>
                </div>
            </div>

            <div class="aes-scroll-area" style="flex: 1; padding: 20px 30px; overflow-y: auto; text-align: justify;">
                <div id="res-story" class="aes-text-body" style="font-family: serif; color: #444; line-height: 1.8; white-space: pre-wrap;">
                    æ­£åœ¨ç¼–ç»‡åšå¼ˆç•™ä¸‹çš„ä½™æ¸©...
                </div>
                <div style="border-top: 1px solid #f2f2f7; margin-top: 20px; padding-top: 15px; font-size: 10px; color: #ccc; text-align: center; letter-spacing: 1px;">
                    TRACES: <span id="res-words"></span>
                </div>
            </div>

            <div class="aes-control-bar" style="padding: 20px 30px 30px; display: flex; gap: 12px;">
                <div class="aes-btn edit" style="background: #f2f2f7; color: #1d1d1f; flex: 1; font-weight: 600;" onclick="archiveAndClose()">
                    å°å­˜å›å“
                </div>
                <div class="aes-btn edit" style="background: #007AFF; color: #fff; flex: 1; font-weight: 600;" onclick="restartVibeGame()">
                    å†æ¥ä¸€å±€
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-vibe-history" class="ios-sub-page" style="z-index: 8500; background: #F2F2F7;">
        <div class="app-header">
            <div onclick="closeVibeHistory()" style="color:#007AFF; font-size:17px; cursor:pointer; display:flex; align-items:center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>è¿”å›
            </div>
            <div style="font-size:17px; font-weight:600;">è¿‡å¾€å›å“</div>
            <div style="width:50px;"></div>
        </div>
        <div class="app-body" id="vibe-history-list" style="padding: 20px 16px;">
            </div>
    </div>
</div>
<div id="worldApp" class="ios-app-window" style="background:#F2F2F7;">
    <div class="app-header">
        <div class="header-title-big">World</div>
        <div class="header-close-btn" onclick="closeApp('worldApp')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div id="world-grid" class="char-grid">
            </div>
    </div>
</div>

<div id="modal-world-viewer" class="ios-alert-mask" style="display:none; align-items:center; z-index:9500;" onclick="this.style.display='none'">
    <div class="world-minimal-card" onclick="event.stopPropagation()">
        <h1 id="world-v-title">ä¸–ç•Œåç§°</h1>
        <div class="world-line-decor"></div>
        <div class="world-viewer-scroll">
            <p id="world-v-content">è¿™é‡Œæ˜¯è¯¦ç»†çš„å†…å®¹æè¿°...</p>
        </div>
        <div style="display:flex; gap:12px; margin-top:25px;">
            <div class="world-action-btn" onclick="editWorld()">ç¼–è¾‘</div>
            <div class="world-action-btn delete" onclick="deleteWorld()">æŠ¹é™¤</div>
        </div>
    </div>
</div>

<div id="worldEditModal" class="ios-alert-mask" style="align-items:flex-end; z-index:9600;">
    <div class="modal-content" style="border-radius: 30px 30px 0 0; padding-bottom: 50px;">
        <div class="modal-top">
            <span class="modal-h1" id="world-modal-title">æ–°è®¾å®š</span>
            <span class="modal-done" onclick="saveWorld()">å®Œæˆ</span>
        </div>
        <input type="text" id="world-name-in" class="ios-input" placeholder="è¾“å…¥åç§°...">
        <textarea id="world-content-in" class="ios-input" style="height:150px; padding-top:12px;" placeholder="æè¿°å†…å®¹..."></textarea>
        <div class="tool-btn" onclick="document.getElementById('worldEditModal').style.display='none'" style="color:#FF3B30;">å–æ¶ˆ</div>
    </div>
</div>
<div id="chatApp" class="ios-app-window" style="background: #F2F2F7; z-index: 5500;">
    <div class="app-header" id="chat-header">
        <div class="header-title-big" id="chat-tab-title">Chat</div>
        <div style="display: flex; align-items: center; gap: 12px;"> 
            
            <div class="moment-action-btn" id="moment-refresh-btn" style="display: none; width: 34px; height: 34px; align-items: center; justify-content: center;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </div>

            <div class="moment-action-btn" id="moment-post-btn" style="display: none; width: 34px; height: 34px; background: #007AFF; color: #fff; align-items: center; justify-content: center;" onclick="openStudioPublisher()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>

            <div id="chat-add-btn" style="display: none; cursor:pointer; color:#007AFF; width: 34px; height: 34px; align-items: center; justify-content: center;" onclick="openChatAddChoice()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>

            <div id="chat-close-btn" class="header-close-btn" style="display: flex; width: 34px; height: 34px; align-items: center; justify-content: center;" onclick="closeApp('chatApp')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <div class="app-body" style="padding: 0; position: relative;">
        
        <div id="chat-panel-msg" class="chat-tab-panel active" style="display: flex; flex-direction: column; overflow: hidden !important;">
    
            <div class="chat-fixed-header" style="background: #fff; z-index: 10;">
                <div class="chat-section-label">Moments</div>
                <div class="chat-friend-ring-container" style="border-bottom:none; padding-bottom:10px;">
                    <div id="chat-friend-ring" class="friend-ring-wrapper">
                        </div>
                </div>
                <div class="chat-section-label" style="border-top: 0.5px solid #F2F2F7; padding-top:15px;">Conversations</div>
            </div>

            <div id="chat-msg-list" class="msg-list-container" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                </div>
        </div>

        <div id="chat-panel-list" class="chat-tab-panel">
            <div style="padding: 10px 16px; background:#F2F2F7;">
                <div class="segment-control" style="margin-bottom:0;">
                    <div class="segment-btn active" id="chat-subtab-friends" onclick="switchChatSubTab('friends')">å¥½å‹</div>
                    <div class="segment-btn" id="chat-subtab-groups" onclick="switchChatSubTab('groups')">ç¾¤èŠ</div>
                </div>
            </div>

            <div id="chat-list-content" style="padding: 0 16px; height: calc(100% - 60px); overflow-y: auto;">
                </div>
        </div>

        <div id="chat-panel-moments" class="chat-tab-panel" style="background: #F2F2F7; display: none; flex-direction: column;">

            <div class="moments-scroll-area">
                <div class="stories-section">
                    <div class="section-top">
                        <span class="section-label">Echoes</span>
                        <span class="section-count">Recent</span>
                    </div>
                    <div class="stories-container" id="moments-story-track">
                        <div class="story-capsule me" onclick="window.openCreatorStudio()">
                            <div class="story-preview-bg" id="my-story-preview"></div>
                            <div class="story-info">
                                <div class="story-add-icon">+</div>
                                <span>My Echo</span>
                            </div>
                        </div>
                        </div>
                </div>

                <div class="moments-data-dashboard">
                    <div class="data-entry-grid">
                        <div class="data-item" onclick="handleOpenLikes()">
                            <div class="badge-count" id="like-badge">0</div> <div class="data-icon" style="color: #1c1c1e; background: #f2f2f7;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </div>
                            <span>èµè¿‡</span>
                        </div>

                        <div class="data-item" onclick="handleOpenComments()" style="position: relative;">
                            <div class="badge-count" id="comment-badge" style="display: none;">0</div>
                            
                            <div class="data-icon" style="color: #1c1c1e; background: #f2f2f7;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                                </svg>
                            </div>
                            <span>è¯„è®º</span>
                        </div>

                        <div class="data-item" onclick="handleOpenSaves()" style="position: relative;">
                            <div class="badge-count" id="save-badge" style="display: none;">0</div>
                            
                            <div class="data-icon" style="color: #1c1c1e; background: #f2f2f7;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                            </div>
                            <span>æ”¶è—</span>
                        </div>

                        <div class="data-item" onclick="handleOpenShares()" style="position: relative;">
                            <div class="badge-count" id="share-badge" style="display: none;">0</div>

                            <div class="data-icon" style="color: #1c1c1e; background: #f2f2f7;">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </div>
                            <span>è½¬å‘</span>
                        </div>
                    </div>

                    <div class="moments-trace-bar" onclick="handleOpenVisitors()" style="position: relative;">
                        <div class="badge-count" id="visitor-badge" style="display: none;">0</div>
                        
                        <div class="trace-info">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span>æœ€è¿‘è®¿å®¢</span>
                        </div>
                        <div class="trace-avatars" id="trace-avatars-list">
                            </div>
                        <div class="trace-count" id="trace-count-val">0</div>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>

                <div class="moments-feed" id="moments-feed-container">
                    <div class="moments-empty-state">
                        <div class="empty-icon-box">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#D1D1D6" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <h3>æš‚æ— ç”Ÿæ´»ç¢ç‰‡</h3>
                        <p>åˆ·ä¸‹çœ‹çœ‹å¤§å®¶éƒ½åœ¨å¿™ä»€ä¹ˆ</p>
                        <button class="empty-refresh-trigger" onclick="/* è§¦å‘åˆ·æ–°é€»è¾‘ */">æ¢ç´¢ä¸–ç•Œ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-panel-me" class="chat-tab-panel">
        
        </div>
    </div>

    <div class="chat-nav-wrapper">
        <div class="chat-bottom-nav">
            <div class="nav-item active" onclick="switchChatTab('msg', 'Messages', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                <span>æ¶ˆæ¯</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('list', 'Contacts', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>åˆ—è¡¨</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('moments', 'Moments', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                <span>åŠ¨æ€</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('me', 'Profile', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>æˆ‘çš„</span>
            </div>
        </div>
    </div>
</div>
<div id="modal-chat-add-choice" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index:9800;">
    <div class="ios-action-sheet">
        <div class="sheet-title-box">æ–°è”ç³»äºº/è®¨è®ºç»„</div>
        <div class="sheet-item" onclick="openAddFriendPage()">æ·»åŠ å•ä¸ªå¥½å‹</div>
        <div class="sheet-item" onclick="openAddGroupPage()">å‘èµ·ç¾¤ç»„èŠ</div>
        <div class="sheet-cancel" onclick="document.getElementById('modal-chat-add-choice').style.display='none'">å–æ¶ˆ</div>
    </div>
</div>

<div id="page-add-friend" class="ios-app-window" style="background:#F2F2F7; z-index:9900; transform:translateY(100%);">
    <div class="app-header">
        <div onclick="closeChatSubPage('page-add-friend')" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">æ·»åŠ å¥½å‹</div>
        <div class="modal-done" onclick="saveChatFriend()">å®Œæˆ</div>
    </div>
    <div class="app-body">
        <div class="segment-control" style="width:100%; margin-bottom:20px;">
            <div class="segment-btn active" id="add-mode-create" onclick="setAddMode('create')">æ‰‹åŠ¨åˆ›å»º</div>
            <div class="segment-btn" id="add-mode-role" onclick="setAddMode('role')">è§’è‰²ä¹¦å¯¼å…¥</div>
        </div>
        <div id="panel-add-create" style="width:100%; text-align:center;">
            <div class="char-upload-circle" style="margin:0 auto 20px auto;" onclick="document.getElementById('in-f-avatar').click()">
                <img id="pre-f-avatar" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:50%;">
                <span id="hint-f-avatar">+ å¤´åƒ</span>
            </div>
            <input type="file" id="in-f-avatar" hidden accept="image/*" onchange="handleAvatarPre(this, 'pre-f-avatar', 'hint-f-avatar')">
            <input type="text" id="in-f-name" class="ios-input" placeholder="è¾“å…¥æ˜µç§°">
        </div>
        <div id="panel-add-role" style="display:none; width:100%;">
            <div id="role-picker-grid" class="char-grid"></div>
        </div>
    </div>
</div>

<div id="page-add-group" class="ios-app-window" style="background:#F2F2F7; z-index:9910; transform:translateY(100%);">
    <div class="app-header">
        <div onclick="closeChatSubPage('page-add-group')" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">å‘èµ·ç¾¤èŠ</div>
        <div id="group-submit-btn" style="color:#ccc; font-weight:700;">åˆ›å»º</div>
    </div>
    <div class="app-body">
        <div class="group-info-card">
            <div class="char-upload-circle" style="width:70px; height:70px; flex-shrink:0;" onclick="document.getElementById('in-g-avatar').click()">
                <img id="pre-g-avatar" style="display:none; width:100%; height:100%; object-fit:cover;">
                <span style="font-size:12px; color:#007AFF; font-weight:700;">+ å¤´åƒ</span>
            </div>
            <input type="file" id="in-g-avatar" hidden accept="image/*" onchange="handleAvatarPre(this, 'pre-g-avatar')">
            <input type="text" id="in-g-name" class="ios-input" style="margin:0; border-radius:10px; background:#F2F2F7;" placeholder="è¾“å…¥ç¾¤èŠåç§°...">
        </div>

        <div class="ios-list-group">
            <div class="ios-list-item">
                <span class="item-label">æœŸæœ›äººæ•°</span>
                <div class="item-right">
                    <input type="number" id="in-g-count" value="3" min="2" max="50">
                </div>
            </div>
        </div>

        <div class="tz-group-title">é€‰å–æˆå‘˜ (<span id="g-curr-count">0</span>/<span id="g-need-count">3</span>)</div>
        <div id="group-member-grid">
            </div>
    </div>
</div>
<div id="page-chat-room" class="ios-app-window chat-room-layer" style="background: #F2F2F7; transform: translateX(100%);">
    <div class="chat-room-header">
        <div class="header-glass-btn left" onclick="closeChatRoom()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </div>
        
        <div class="header-contact-info" onclick="openChatProfileFromRoom()">
            <img id="room-contact-avatar" src="" alt="avatar">
            <div class="header-text-stack">
                <span id="room-contact-name">Nickname</span>
                <span class="room-status-text">Online</span>
            </div>
        </div>

        <div class="header-glass-btn right" onclick="openChatSettings()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="19" cy="12" r="1"></circle>
                <circle cx="5" cy="12" r="1"></circle>
            </svg>
        </div>
    </div>

    <div id="chat-messages-container" class="chat-scroll-area">
        <div class="chat-time-divider">TODAY</div>
        </div>

    <div class="chat-room-footer" style="flex-direction: column; height: auto; min-height: 56px; padding: 0;">
        <div id="quote-preview" class="quote-preview-bar" style="display:none; width: 100%; border-radius: 20px 20px 0 0;">
            <div class="quote-content-wrapper">
                <div id="quote-preview-user" class="quote-user-name">Nickname</div>
                <div id="quote-preview-text" class="quote-text-preview">Message content...</div>
            </div>
            <div onclick="cancelQuote()" style="cursor:pointer; padding:5px; color:#8e8e93;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div style="display: flex; align-items: center; width: 100%; padding: 10px 15px; gap: 12px;">
            <div class="footer-add-btn" onclick="toggleFeaturePanel()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <input type="text" id="chat-input-main" class="chat-room-input" placeholder="Type something...">
            <div class="footer-action-btns">
                <div class="action-btn ai" onclick="triggerAiGenerate()"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>
                <div class="action-btn send" onclick="handleSendMessage()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div>
            </div>
        </div>
    </div>

    <div id="chat-feature-panel" class="feature-panel-container">
        <div class="feature-list-wrapper">
            <div class="feature-row-item" onclick="handleFeature('Gallery')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    </div>
                    <span class="capsule-label">Gallery</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleEmojiButtonClick(event)">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                    </div>
                    <span class="capsule-label">Emoji</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Voice')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </div>
                    <span class="capsule-label">Voice</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Video')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                    </div>
                    <span class="capsule-label">Video</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Location')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    </div>
                    <span class="capsule-label">Location</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Transfer')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/><path d="M7 15h.01M11 15h.01"/></svg>
                    </div>
                    <span class="capsule-label">Transfer</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('InnerVoice')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </div>
                    <span class="capsule-label">InnerVoice</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Phone')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
                    </div>
                    <span class="capsule-label">Phone</span>
                </div>
            </div>
        </div>
    </div>

    <div id="multi-select-count" style="position:absolute; top:-30px; left:0; width:100%; text-align:center; font-size:13px; color:#8e8e93; font-weight:600;">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</div>
    <div id="multi-select-bar" class="multi-select-footer">
        <div class="multi-action-item danger" onclick="batchDelete()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            <span>åˆ é™¤</span>
        </div>
        <div class="multi-action-item" onclick="batchScreenshot()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            <span>æˆªå›¾</span>
        </div>
        <div class="multi-action-item" onclick="batchForward()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></svg>
            <span>è½¬å‘</span>
        </div>
        <div class="multi-action-item" style="color:#8e8e93;" onclick="exitMultiSelect()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
</div>
<div id="menu-overlay" class="menu-overlay" onclick="hideBubbleMenu()"></div>

<div id="bubble-menu" class="bubble-context-menu">
    <div class="menu-box">
        <div class="menu-item" onclick="doAction('copy')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></div>
            <span>å¤åˆ¶</span>
        </div>
        <div class="menu-item" onclick="doAction('quote')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
            <span>å¼•ç”¨</span>
        </div>
        <div class="menu-item" onclick="doAction('fav')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></div>
            <span>æ”¶è—</span>
        </div>
        <div class="menu-item" onclick="doAction('multi')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div>
            <span>å¤šé€‰</span>
        </div>
        
        <div id="menu-recall" class="menu-item" onclick="doAction('recall')">
            <div class="menu-icon-circle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M12 7v5l4 2"></path></svg>
            </div>
            <span>æ’¤å›</span>
        </div>
        <div class="menu-item" onclick="doAction('forward')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></svg></div>
            <span>è½¬å‘</span>
        </div>
        <div class="menu-item" onclick="doAction('delete')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>
            <span>åˆ é™¤</span>
        </div>
        <div class="menu-item" onclick="hideBubbleMenu()">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
    <div class="menu-arrow"></div>
</div>
<div id="page-forward-picker" class="ios-app-window" style="z-index: 9999; transform: translateY(100%); background: #F2F2F7;">
    <div class="app-header">
        <div onclick="closeForwardPicker()" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">é€‰æ‹©æ”¶ä»¶äºº</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 0;">
        <div style="padding: 10px 16px; background:#F2F2F7;">
            <div class="segment-control" style="margin-bottom:0;">
                <div class="segment-btn active" id="fwd-tab-friends" onclick="switchForwardTab('friends')">æœ€è¿‘è”ç³»äºº</div>
                <div class="segment-btn" id="fwd-tab-groups" onclick="switchForwardTab('groups')">æˆ‘çš„ç¾¤èŠ</div>
            </div>
        </div>
        
        <div id="forward-list-content" style="padding: 0 16px; height: calc(100% - 60px); overflow-y: auto;">
            </div>
    </div>
</div>
<div id="modal-recalled-viewer" class="ios-alert-mask" style="display:none; align-items:center; z-index:10001;" onclick="this.style.display='none'">
    <div class="recalled-content-card" onclick="event.stopPropagation()">
        <div class="recalled-v-label">RECALLED TRACE</div>
        <div id="recalled-v-text"></div>
        <div class="alert-btn" style="border-top: 0.5px solid #eee; margin: 0 -25px -25px -25px; padding: 16px; color: #007AFF; font-weight: 700; cursor: pointer;" onclick="document.getElementById('modal-recalled-viewer').style.display='none'">Done</div>
    </div>
</div>
<div id="page-chat-settings" class="ios-app-window" style="background: #F2F2F7; z-index: 9200; transform: translateX(100%);">
    
    <div class="app-header" style="background: transparent;">
    
        <div onclick="closeChatSettings()" style="color:#007AFF; font-size:16px; display:flex; align-items:center; cursor:pointer; width:60px; text-shadow: 0 0 10px rgba(255,255,255,0.9);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left:-5px; filter: drop-shadow(0 0 3px rgba(255,255,255,0.8));">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Back
        </div>

        <div style="font-size:17px; font-weight:600; flex:1; text-align:center; color:#000; text-shadow: 0 0 15px rgba(255,255,255,1), 0 0 5px rgba(255,255,255,0.8);">
            è¯¦ç»†è®¾ç½®
        </div>

        <div style="width:60px;"></div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display:block; overflow-y:auto; padding-bottom: 50px;">
    
        <div class="tz-group-title">GENERAL</div>
        
        <div class="ios-list-group" style="padding: 0; overflow: hidden;">

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #007AFF;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">èƒŒæ™¯è®¾ç½®</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content" style="padding: 0;">
                    <div class="bg-config-container">
                        <div class="bg-config-row">
                            <div class="bg-label-group">
                                <span class="bg-main-title">èŠå¤©çª—å£èƒŒæ™¯</span>
                                <span class="bg-sub-hint">æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€ç½‘ç»œé“¾æ¥</span>
                            </div>
                            <div class="bg-preview-box" onclick="openUniversalBgModal('chat')">
                                <div id="preview-thumb-chat" class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>
                                <div class="bg-edit-badge">CHAT</div>
                            </div>
                        </div>

                        <div class="bg-config-row">
                            <div class="bg-label-group">
                                <span class="bg-main-title">è®¾ç½®èœå•èƒŒæ™¯</span>
                                <span class="bg-sub-hint">ä»…æ”¯æŒå›¾ç‰‡ï¼ˆæ–‡ä»¶/URLï¼‰</span>
                            </div>
                            <div class="bg-preview-box" onclick="openUniversalBgModal('settings')">
                                <div id="preview-thumb-settings" class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>
                                <div class="bg-edit-badge">MENU</div>
                            </div>
                        </div>

                        <div class="bg-action-group">
                            <div class="bg-reset-btn" onclick="resetChatBackgrounds()">é‡ç½®</div>
                            <div class="bg-save-btn" onclick="saveChatBackgroundSettings()">ä¿å­˜æ›´æ”¹</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #34C759;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">Ta çš„èµ„æ–™</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openCharProfileEditPage()">ç¼–è¾‘è¯¦ç»†èµ„æ–™</div>
                    <div class="sub-setting-btn" onclick="openChatProfileFromSettings()">æŸ¥çœ‹é¢„è§ˆåç‰‡</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #AF52DE;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M12 6v10M9 9l3-3 3 3"/></svg>
                    </div>
                    <div class="item-content" style="border:none;">
                        <span class="item-label">ä¸–ç•Œä¹¦å…³è”</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openWorldBindPage()">ä¸–ç•Œä¹¦åè®®é€‰å®š</div>
                    <div class="sub-setting-btn" onclick="openRelationsPage()">æ„å»ºäººé™…å…³ç³»ç½‘</div>
                    
                    <div style="font-size:10px; color:#bbb; text-align:center; margin-top:10px; padding:0 15px;">
                        æç¤ºï¼šå…ˆé€‰å®šä¸–ç•Œåè®®ï¼ŒAI æ‰èƒ½ç²¾å‡†ç”Ÿæˆå…³ç³»ç½‘ã€‚
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #1d1d1f;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">æˆ‘çš„èµ„æ–™</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content" style="padding: 10px 16px 20px 16px;">
                    <div class="sub-setting-btn user-btn-main" onclick="openUserProfileEdit()">ç¼–è¾‘æˆ‘çš„èµ„æ–™</div>
                    <div class="sub-setting-btn user-btn-secondary" onclick="openUserCardPreview()">é¢„è§ˆæˆ‘çš„èµ„æ–™å¡</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #FF9500;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-label">è®°å¿†</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openExclusiveMemories()">ä¸“å±å›å¿†</div>
                    <div class="sub-setting-btn" onclick="openMemorySummary()">è®°å¿†æ€»ç»“</div>
                    
                    <div style="font-size:10px; color:#bbb; text-align:center; margin-top:10px; padding:0 15px;">
                        æç¤ºï¼šåŸºäºé‡å­çº ç¼ åè®®ï¼Œè®°å¿†å°†éšäº’åŠ¨æ·±åº¦è‡ªåŠ¨è§£é”ã€‚
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #AF52DE;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-label">ç¾åŒ–</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openSubPage('subpage-language-settings'); initLanguageConfig();">
                        è¯­è¨€è®¾ç½® (Language)
                    </div>
                    
                    <div class="sub-setting-btn" onclick="openSubPage('subpage-theme-store'); initThemeStore();">
                        é¡µé¢å¸ƒå±€ (Layout)
                    </div>

                    <div class="sub-setting-btn" onclick="openSubPage('subpage-voice-calibrate'); loadVoiceCalibrateUI();">
                        è¯­éŸ³å¼•æ“ (Voice Engine)
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #5856D6;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M1 1l22 22"/><path d="M1 23L23 1"/><path d="M12 6a6 6 0 0 0-6 6"/><path d="M18 12a6 6 0 0 0-6-6"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">æ„ŸçŸ¥</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-row" onclick="openWeatherPerception()">
                        <div class="sub-item-left">
                            <span class="item-label">å¤©æ°”æ„ŸçŸ¥</span>
                            <span class="time-sense-tag sense-time-label">åŒæ­¥ä¸­...</span>
                        </div>
                        <div class="sub-item-right">
                            <span class="status-highlight" id="val-weather-text">å¤šäº‘ 24Â°C</span>
                            <svg class="chevron-right" width="12" height="12" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>

                    <div class="sub-setting-row" onclick="openRegionPerception()">
                        <div class="sub-item-left">
                            <span class="item-label">åœ°åŒºæ„ŸçŸ¥</span>
                            <span class="time-sense-tag sense-time-label">åŒæ­¥ä¸­...</span>
                        </div>
                        <div class="sub-item-right">
                            <span class="status-highlight" id="val-region-text">åŒ—äº¬å¸‚ Â· æµ·æ·€åŒº</span>
                            <svg class="chevron-right" width="12" height="12" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #8E8E93;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-label">çº¿ä¸‹</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openTravelJournal()">è¡Œæ—…è§é—»</div>
                    
                    <div class="sub-setting-btn" onclick="openDestinyPage()">å› æœç¾ç»Š</div>
                
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #FF2D55;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                    <div class="item-content" style="border:none;">
                        <span class="item-label">èŠå¤©è®°å½•</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="window.openChatSearchPage()">æŸ¥æ‰¾å†…å®¹</div>
                    <div class="sub-setting-btn" onclick="showToast('è®°å½•å·²æ‰“åŒ…å¯¼å‡º')">å¯¼å‡ºå¤‡ä»½</div>
                </div>
            </div>

        </div>

        <div class="danger-zone-container">
            <div class="standalone-btn btn-blue-text" onclick="triggerClearHistory()">
                æ¸…ç©ºèŠå¤©è®°å½•
            </div>
            
            <div class="standalone-btn btn-blue-text" onclick="showToast('å·²æ‹‰é»‘è¯¥ç”¨æˆ·')">
                æ‹‰é»‘å¥½å‹
            </div>
            
            <div class="standalone-btn btn-red-text" onclick="triggerDeleteFriend()">
                åˆ é™¤å¥½å‹
            </div>
        </div>

        <div style="text-align:center; font-size:11px; color:#C7C7CC; margin-top:25px; padding-bottom:40px;">
            SECURE CONNECTION v4.2<br>ID: <span id="setting-uid-display">UNKNOWN</span>
        </div>

    </div>

    <div id="subpage-world-bind" class="ios-sub-page">
        <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
            <div onclick="closeSubPage('subpage-world-bind')" style="color:#007AFF;">å–æ¶ˆ</div>
            <div style="font-weight:800;">ç»‘å®šåè®®</div>
            <div onclick="saveWorldBinding()" style="color:#007AFF; font-weight:800;">ä¿å­˜</div>
        </div>
        <div class="app-body" style="padding: 20px 16px;">
            <div class="tz-group-title">é€‰æ‹©æ³¨å…¥çš„è§„åˆ™</div>
            <div id="world-bind-list" class="ios-list-group"></div>
            <div class="tz-group-title">è¡ç”Ÿæ‰©å±•</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openRelationsPage()">
                    <div class="item-content" style="border:none;">
                        <span class="item-label" style="color:#007AFF; font-weight:700;">æŸ¥çœ‹/æ„å»ºäººé™…å…³ç³»ç½‘</span>
                        <div class="item-right"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-relations" class="ios-sub-page">
        <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
            <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
            <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
            <div style="width:40px;"></div>
        </div>
        <div class="app-body" style="padding: 20px 16px;">
            <div id="quantum-loader" class="quantum-loader-overlay">
                <div class="quantum-spinner"></div>
                <div class="quantum-status-text" id="q-status">INITIALIZING...</div>
                <div class="q-progress-container">
                    <div id="q-progress-bar" class="q-progress-bar"></div>
                </div>
            </div>
            <div id="relation-empty-state" style="text-align:center; padding:60px 20px; display:none;">
                <div style="font-size:50px; margin-bottom:20px; filter: grayscale(100%);">ğŸŒ</div>
                <h3 style="color:#1d1d1f; margin-bottom:10px;">å°šæœªè§£æå…³ç³»ç½‘</h3>
                <p style="color:#8e8e93; font-size:13px; line-height:1.6;">AI éœ€è¦æ ¹æ®å·²ç»‘å®šçš„ä¸–ç•Œåè®®<br>ä¸ºè¯¥è§’è‰²ç¼–ç»‡åº•å±‚ç¤¾ä¼šå…³ç³»ã€‚</p>
                <button class="ios-btn primary" style="margin-top:30px; width:180px;" onclick="generateRelationsWithAI()">å¼€å§‹é‡å­è§£æ</button>
            </div>
            <div id="npc-grid" class="char-grid"></div>
            <div id="subpage-relations" class="ios-sub-page">
                <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
                    <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
                    <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
                    <div style="width:40px;"></div>
                </div>
                <div class="app-body" style="padding: 20px 16px;">
                    <div id="relation-empty-state"> ... </div>

                    <div id="npc-grid" class="char-grid"></div>

                    <div id="relation-footer" class="relation-footer-tools" style="display:none;">
                        <div class="btn-extend-network" onclick="generateRelationsWithAI(true)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            æ‰©å±•å…³ç³»åœˆ
                        </div>
                    </div>
                </div>
            </div>

            <div class="npc-pre-footer">              
                <div class="npc-btn-main add" id="npc-add-btn" onclick="handleNPCFriendRequest()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                    <span id="npc-add-text">Add Friend</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modal-universal-uploader" class="ios-alert-mask" style="align-items:flex-end; z-index:20000;">
    <div class="modal-content">
        <div class="modal-top">
            <div style="display:flex; flex-direction:column;">
                <span class="modal-h1" id="uploader-title">è®¾ç½®èƒŒæ™¯</span>
                <span id="uploader-target-tag" class="uploader-type-tag">CHAT WINDOW</span>
            </div>
            <span class="modal-done" onclick="closeUniversalUploader()">å–æ¶ˆ</span>
        </div>

        <div class="url-input-wrapper">
            <input type="text" id="universal-url-in" class="ios-input" placeholder="è¾“å…¥å›¾ç‰‡æˆ–è§†é¢‘çš„ URL...">
            <button class="ios-btn secondary" style="margin-top:8px;" onclick="handleUniversalUrl()">ä½¿ç”¨æ­¤é“¾æ¥</button>
        </div>

        <div style="text-align:center; color:#ccc; font-size:12px; margin-bottom:15px; font-weight:800;">æˆ–</div>

        <input type="file" id="universal-file-in" hidden onchange="handleUniversalFile(this)">
        <button class="ios-btn primary" onclick="document.getElementById('universal-file-in').click()">ä»ç›¸å†Œé€‰æ‹©æ–‡ä»¶</button>
        
        <div style="height:30px;"></div>
    </div>
</div>
<div id="save-success-hud" class="ios-hud">
    <svg class="hud-checkmark" viewBox="0 0 52 52">
        <path d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>
    <div class="hud-text">å·²ä¿å­˜</div>
</div>
<div id="subpage-char-profile" class="ios-sub-page">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-char-profile')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> å–æ¶ˆ
        </div>
        <div style="font-size:17px; font-weight:600;">Taçš„èµ„æ–™</div>
        <div onclick="saveCharProfileChanges()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">ä¿å­˜</div>
    </div>

    <div class="app-body" style="padding: 20px 16px;">
        <div class="profile-edit-header" style="text-align:center; margin-bottom:30px;">
            <div class="char-upload-circle" style="width:100px; height:100px; margin:0 auto 15px auto; box-shadow:0 8px 25px rgba(0,0,0,0.1);" onclick="document.getElementById('edit-char-avatar-file').click()">
                <img id="edit-char-avatar-pre" src="" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
                <div class="bg-edit-badge" style="border-radius:0 0 50px 50px; font-size:8px;">CHANGE</div>
            </div>
            <input type="file" id="edit-char-avatar-file" hidden accept="image/*" onchange="previewProfileAvatar(this)">
            <input type="text" id="edit-char-name" class="ios-input" style="text-align:center; font-size:24px; font-weight:800; background:transparent; border:none;" placeholder="è¾“å…¥æ˜µç§°">
        </div>

        <div class="tz-group-title">äººè®¾èƒŒæ™¯ (BIOGRAPHY)</div>
        <div class="ios-list-group">
            <textarea id="edit-char-desc" class="ios-input" style="height:200px; padding:15px; background:#fff; border:none; margin:0; line-height:1.6;" placeholder="åœ¨è¿™é‡Œå®šä¹‰è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯ã€ä»¥åŠä½ ä»¬çš„æ•…äº‹..."></textarea>
        </div>
        <div class="tz-group-title">ç³»ç»Ÿå…ƒæ•°æ® (METADATA)</div>
            <div class="ios-list-group">
                <div class="ios-list-item">
                    <span class="item-label">è§’è‰² ID</span>
                    <div class="item-right"><span class="item-value" id="meta-char-id">--</span></div>
                </div>
                <div class="ios-list-item" style="border:none;">
                    <span class="item-label">æ ¸å¿ƒåè®®</span>
                    <div class="item-right"><span class="item-value">Encrypted v4.2</span></div>
                </div>
            </div>
        
        <div style="font-size:11px; color:#bbb; padding:10px 16px;">
            æç¤ºï¼šåœ¨æ­¤å¤„ä¿®æ”¹çš„èµ„æ–™å°†åŒæ­¥è‡³è§’è‰²ä¹¦ã€å¥½å‹åˆ—è¡¨åŠ AI è®°å¿†åº“ã€‚
        </div>

    </div>
</div>
<div id="modal-social-card" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="social-card" onclick="event.stopPropagation()">
        
        <div class="social-close-trigger" onclick="document.getElementById('modal-social-card').style.display='none'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>

        <img id="social-v-avatar" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
        
        <h2 id="social-v-name" style="margin-top:12px; font-size:24px; font-weight:800; color:#1d1d1f; letter-spacing:-0.5px;">Name</h2>
        <div class="social-online-tag">ONLINE</div>

        <div class="social-motto" id="social-v-motto" onclick="openEditMottoFromCard()">Signature goes here...</div>

        <div class="social-actions">
            <div class="social-btn-item" onclick="showToast('Message feature is encrypted...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg></div>
                <span>Message</span>
            </div>
            <div class="social-btn-item" onclick="showToast('Voice protocol error...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></div>
                <span>Call</span>
            </div>
            <div class="social-btn-item" onclick="showToast('Video stream unavailable...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></div>
                <span>Video</span>
            </div>
        </div>
    </div>
</div>

<div id="modal-aes-preview" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="aesthetic-preview-card" onclick="event.stopPropagation()">
        <div class="aes-pre-header"><img id="aes-v-avatar" class="aes-pre-avatar" src=""></div>
        <div class="aes-pre-body">
            <h2 id="aes-v-name" class="aes-pre-name">Character</h2>
            <div class="aes-pre-desc-box"><p id="aes-v-desc">Description sync...</p></div>
            <div style="display:flex; gap:12px; margin-top:30px;">
                <div class="aes-footer-btn light" style="flex:1; padding:12px; border-radius:12px; background:#f2f2f7; text-align:center; font-weight:700;" onclick="document.getElementById('modal-aes-preview').style.display='none'">Close</div>
                <div class="aes-footer-btn dark" style="flex:1; padding:12px; border-radius:12px; background:#1d1d1f; color:#fff; text-align:center; font-weight:700;" onclick="openCharProfileEditPage(); document.getElementById('modal-aes-preview').style.display='none';">Edit Profile</div>
            </div>
        </div>
    </div>
</div>
<div id="modal-motto-edit" class="vibe-center-mask" style="display:none; z-index:9700;">
    <div class="ios-alert-box">
        <div class="alert-title">ä¿®æ”¹ç­¾å</div>
        <div style="padding: 15px;">
            <input type="text" id="motto-input" class="ios-input" placeholder="è¾“å…¥æ–°çš„å¿ƒæƒ…..." style="text-align:center;">
        </div>
        <div style="display:flex; border-top:0.5px solid #eee;">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid #eee;" onclick="document.getElementById('modal-motto-edit').style.display='none'">å–æ¶ˆ</div>
            <div class="alert-btn" style="flex:1; font-weight:800;" onclick="saveMotto()">ä¿å­˜</div>
        </div>
    </div>
</div>
<div id="subpage-world-bind" class="ios-sub-page">
    <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
        <div onclick="closeSubPage('subpage-world-bind')" style="color:#007AFF;">å–æ¶ˆ</div>
        <div style="font-weight:800;">ç»‘å®šåè®®</div>
        <div onclick="saveWorldBinding()" style="color:#007AFF; font-weight:800;">ä¿å­˜</div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">é€‰æ‹©æ³¨å…¥çš„è§„åˆ™</div>
        <div id="world-bind-list" class="ios-list-group">
            </div>

        <div class="tz-group-title">è¡ç”Ÿæ‰©å±•</div>
        <div class="ios-list-group">
            <div class="ios-list-item" onclick="openRelationsPage()">
                <div class="item-content" style="border:none;">
                    <span class="item-label" style="color:#007AFF; font-weight:700;">æŸ¥çœ‹/æ„å»ºäººé™…å…³ç³»ç½‘</span>
                    <div class="item-right">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>
        <div style="font-size:11px; color:#bbb; padding:10px; line-height:1.4;">
            æ³¨æ„ï¼šæ„å»ºå…³ç³»ç½‘å‰è¯·ç¡®ä¿å·²å‹¾é€‰å¹¶ä¿å­˜ä¸Šæ–¹ä¸–ç•Œåè®®ï¼Œä»¥ä¾¿ AI ç²¾å‡†ç¼–ç»‡è§’è‰²çº½å¸¦ã€‚
        </div>
    </div>
</div>

<div id="subpage-relations" class="ios-sub-page"> 
    </div>

<div id="subpage-relations" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
        <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 20px 16px;">
        <div id="quantum-loader" class="quantum-loader-overlay">
            <div class="quantum-spinner"></div>
            <div class="quantum-status-text" id="q-status">INITIALIZING...</div>
            <div class="q-progress-container">
                <div id="q-progress-bar" class="q-progress-bar"></div>
            </div>
        </div>

        <div id="relation-empty-state" style="text-align:center; padding:60px 20px; display:none;">
            <div style="font-size:50px; margin-bottom:20px; filter: grayscale(100%);">ğŸŒ</div>
            <h3 style="color:#1d1d1f; margin-bottom:10px;">å°šæœªè§£æå…³ç³»ç½‘</h3>
            <p style="color:#8e8e93; font-size:13px; line-height:1.6;">AI å°†æ ¹æ®å·²ç»‘å®šçš„ä¸–ç•Œåè®®<br>ä¸ºè¯¥è§’è‰²ç¼–ç»‡åº•å±‚ç¤¾ä¼šå…³ç³»ã€‚</p>
            <button class="ios-btn primary" style="margin-top:30px; width:180px;" onclick="generateRelationsWithAI(false)">å¼€å§‹é‡å­è§£æ</button>
        </div>

        <div id="npc-grid" class="char-grid"></div>

        <div id="relation-footer" class="relation-footer-tools" style="display:none;">
            <div class="btn-extend-network" onclick="generateRelationsWithAI(true)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                æ‰©å±•å…³ç³»åœˆ
            </div>
        </div>
    </div>
</div>

<div id="modal-npc-detail" class="vibe-center-mask" style="display:none; z-index:40000;" onclick="this.style.display='none'">
    <div class="npc-detail-card" onclick="event.stopPropagation()">
        <div class="aes-top-bar" style="position: absolute; top: 15px; right: 15px; z-index: 100;">
            <div class="aes-icon-circle close" onclick="document.getElementById('modal-npc-detail').style.display='none'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="npc-pre-header">
            <img id="npc-v-banner" class="npc-pre-banner" src="">
            <img id="npc-v-avatar" class="npc-pre-avatar" src="">
        </div>

        <div class="npc-pre-body">
            <div id="npc-v-name" class="npc-pre-name">NPC Name</div>
            <div id="npc-v-role" class="npc-pre-role">RELATIONSHIP</div>
            <div class="npc-pre-bio" id="npc-v-bio">Loading dossier...</div>
        </div>

        <div class="npc-pre-footer">
            <button class="npc-btn-action minor" onclick="traceNPCStory()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span>å¾€äº‹</span>
            </button>

            <button class="npc-btn-action minor" onclick="handleLikeNPC()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                <span>æ„Ÿå…´è¶£</span>
            </button>
            
            <button class="npc-btn-action main" id="npc-add-btn" onclick="handleSocialSync()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M19 11h6m-3-3v6"/></svg>
                <span id="npc-add-text">ADD CLOSE FRIEND</span>
            </button>
        </div>
    </div>
</div>
<div id="subpage-npc-story" class="ios-sub-page" style="z-index: 50000; background: #F2F2F7;">
    <div class="app-header">
        <div onclick="document.getElementById('subpage-npc-story').classList.remove('active')" style="color:#007AFF; font-size:16px; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:700;">å¾€äº‹å›æº¯</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 20px 16px;">
        <div class="npc-story-header">
            <h2 id="story-npc-name" style="margin-bottom:8px;">è§’è‰²å¾€äº‹</h2>
            <div id="story-npc-tag" style="font-size:12px; color:#8E8E93; margin-bottom:20px;">MEMORIES & RECORDS</div>
        </div>
        
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content" style="flex-direction: column; align-items: flex-start; padding: 15px 0;">
                    <span style="font-size:13px; color:#007AFF; margin-bottom:5px;">æ ¸å¿ƒæ¢—æ¦‚</span>
                    <p id="story-npc-content" style="font-size:15px; color:#333; line-height:1.6; margin:0;">
                        æ­£åœ¨è¯»å–æ¡£æ¡ˆæ•°æ®...
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modal-past-decoder" class="ios-alert-mask" style="display:none; z-index:99999;">
    <div class="aesthetic-card past-magazine-style">
        <div class="aes-top-bar">
            <div class="aes-icon-circle close" onclick="closePastDecoder()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="aes-hero">
            <div id="past-hero-blur" class="aes-blur-bg"></div>
            <div class="aes-overlay" style="background: linear-gradient(to bottom, transparent, #fff);"></div>
        </div>

        <div class="aes-float-content">
            <div class="aes-avatar-box">
                <img id="past-avatar-img" src="" alt="avatar">
            </div>
            <div class="aes-title-group">
                <div id="past-name-txt" class="aes-name">åŠ è½½ä¸­...</div>
                <div class="aes-tag">CLASSIFIED MEMORY</div>
            </div>
        </div>

        <div class="aes-scroll-area">
            <div id="past-text-body" class="aes-text-body">
                </div>
            <div class="aes-divider">THE END</div>
        </div>

        <div class="aes-control-bar">
            <button class="aes-btn edit" onclick="closePastDecoder()">å…³é—­æ¡£æ¡ˆ</button>
        </div>
    </div>
</div>
<div id="subpage-user-profile" class="ios-sub-page" style="background:#F2F2F7; z-index: 10000;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-user-profile')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> å–æ¶ˆ
        </div>
        <div style="font-size:17px; font-weight:600;">æœ¬æˆ‘æ¡£æ¡ˆ</div>
        <div onclick="saveUserProfile()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display: block; width: 100%;">
        <div style="text-align:center; margin-bottom:30px;">
            <div class="char-upload-circle" style="width:100px; height:100px; margin:0 auto 15px auto; position:relative; overflow:hidden; border-radius:50%; background:#e5e5ea;" onclick="document.getElementById('user-avatar-file').click()">
                <img id="user-avatar-pre" src="" style="width:100%; height:100%; object-fit:cover; display:block;">
                <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; padding:2px 0;">EDIT</div>
            </div>
            <input type="file" id="user-avatar-file" hidden accept="image/*" onchange="previewUserAvatar(this)">
            <input type="text" id="user-name-in" class="ios-input" style="text-align:center; font-size:22px; font-weight:800; background:transparent;" placeholder="ä½ çš„ç§°å‘¼">
        </div>

        <div class="tz-group-title">é‡å­äººæ ¼è®¾å®š (PERSONA)</div>
        <div class="ios-list-group">
            <textarea id="user-bio-in" class="ios-input" style="height:200px; padding:15px; background:#fff; border:none; margin:0; line-height:1.6;" 
                placeholder="æè¿°ä½ æ˜¯è°ï¼Œä½ ä¸è§’è‰²ä»¬çš„å…±æœ‰å¾€äº‹..."></textarea>
        </div>
        <div style="font-size:11px; color:#bbb; padding:10px 16px;">
            æç¤ºï¼šæ­¤æè¿°å°†ä½œä¸ºæ ¸å¿ƒåè®®åŒæ­¥è‡³ AI äº¤äº’é€»è¾‘ã€‚
        </div>
    </div>
</div>

<div id="modal-user-card" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="aesthetic-preview-card" style="border: 1px solid #1d1d1f; box-shadow: 0 40px 100px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div class="aes-pre-header" style="background: #1d1d1f; height: 120px; position: relative;">
            <img id="user-card-avatar" class="aes-pre-avatar" src="" style="border: 4px solid #fff; border-radius: 20px; transform: translateX(-50%) rotate(2deg);">
        </div>
        <div class="aes-pre-body" style="padding: 70px 25px 35px 25px;">
            <h2 id="user-card-name" class="aes-pre-name">Creator</h2>
            <div class="aes-tag" style="color: #007AFF; border-color: #007AFF; margin-bottom: 25px;">MASTER PROTOCOL</div>
            <div class="aes-pre-desc-box" style="background: #f8f8f9; text-align: left; padding: 18px; border-radius: 18px;">
                <p id="user-card-bio" style="font-family: serif; font-style: italic; color: #444; line-height: 1.6;">å°šæœªè§‰é†’äººæ ¼...</p>
            </div>
            <div class="aes-footer-btn dark" style="margin-top: 30px; padding: 14px; border-radius: 14px; background: #1d1d1f; color: #fff; font-weight: 700; cursor: pointer; text-align: center;" onclick="openUserProfileEdit()">
                ä¿®æ”¹æœ¬æˆ‘æ¡£æ¡ˆ
            </div>
        </div>
    </div>
</div>
<div id="subpage-memory-list" class="ios-sub-page">
    <div class="app-header">
        <div class="header-left" onclick="closeSubPage('subpage-memory-list')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
            <span>è¿”å›</span>
        </div>
        <div class="header-title">æ—¶ç©ºæ¡£æ¡ˆåº“</div>
        <div class="header-right" onclick="window.clearAllMemories()" style="color:#FF3B30; font-size:14px; font-weight:600; cursor:pointer;">
            æ¸…ç©º
        </div>
    </div>
    
    <div class="app-body">
        <div class="memory-hero-area">
            <span class="hero-tag">MEMORIES</span>
            <h1 class="hero-title">æ„Ÿå®˜ç¢ç‰‡</h1>
            <p class="hero-desc">åœ¨æ­¤å¤„å”¤é†’ä¸ Ta è¢«å°å­˜çš„é‡å­ç¾ç»Š</p>
        </div>

        <div id="memory-list-container" class="memory-stagger-grid"></div>

        <div class="memory-footer-bar">
            <button class="btn-awaken-core" onclick="window.triggerGenerateMemory()">
                <div class="ripple-effect"></div>
                <span>å”¤é†’æ–°è®°å¿†</span>
            </button>
        </div>
    </div>
</div>

<div id="modal-memory-cinema" class="cinema-portal">
    <div class="cinema-stage">
        <div class="cinema-close-trigger" onclick="window.closeCinemaMemory()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
        
        <div class="cinema-scroll-layer">
            <div class="cinema-hero-banner">
                <img id="cinema-img" src="" alt="scene">
                <div class="cinema-hero-mask"></div>
                <div class="cinema-title-box">
                    <span id="cinema-tag-ui">LATEST TRACE</span>
                    <h1 id="cinema-title-ui">è½½å…¥ä¸­...</h1>
                </div>
            </div>
            
            <div class="cinema-text-wrapper">
                <div id="cinema-text-content" class="cinema-prose"></div>
                <div class="cinema-footer-decor">âœ¦ FIN âœ¦</div>
            </div>
        </div>
    </div>
</div>

<div id="quantum-loader-overlay" class="quantum-overlay">
    <div class="weaving-core">
        <div class="spider-line"></div>
        <div class="spider-line"></div>
        <div class="spider-line"></div>
    </div>
    <div class="weaving-text">æ­£åœ¨ä»é‡å­çº ç¼ ä¸­ç¼–ç»‡å™äº‹...</div>
</div>
<div id="subpage-memory-summary" class="ios-sub-page">
    <div class="app-header">
        <div class="header-left" onclick="closeSubPage('subpage-memory-summary')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
            <span>è¿”å›</span>
        </div>
        <div class="header-title">è®°å¿†æ€»ç»“åè®®</div>
        <div class="header-right" onclick="window.saveSummarySettings()" style="color:#000; font-weight:800; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">è‡ªåŠ¨æ€»ç»“è§¦å‘é¢‘ç‡</div>
        
        <div class="ios-list-group" style="padding: 25px 20px; display: block;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <span style="font-size:16px; font-weight:700; color:#000;">å¯¹è¯è½®æ•°</span>
                    <span style="font-size:11px; color:#8e8e93; letter-spacing:1px;">ROUNDS PER CYCLE</span>
                </div>
                <span id="summary-rounds-val" style="font-size:32px; font-weight:800; font-family:serif; color:#000;">10</span>
            </div>
            
            <input type="range" id="summary-rounds-slider" min="5" max="50" step="5" value="10" class="ios-slider" 
                oninput="window.updateSummarySlider(this.value)">
            
            <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:10px; color:#ccc; font-weight:700;">
                <span>é«˜é¢‘ç‡ (5)</span>
                <span>æ·±åº¦è®°å¿† (50)</span>
            </div>
        </div>

        <div class="tz-group-title">åè®®è¯´æ˜</div>
        <div class="ios-list-group" style="padding:20px; font-size:13px; line-height:1.6; color:#444; text-align:justify;">
            <p>å½“å¯¹è¯è¾¾åˆ°è®¾å®šè½®æ•°åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¯åŠ¨â€œé‡å­åç¼©â€ç¨‹åºï¼Œå°†å†—é•¿çš„åŸå§‹è®°å½•å‹ç¼©ä¸ºã€æ ¸å¿ƒè®°å¿†ç‚¹ã€‘ã€‚è¿™èƒ½æœ‰æ•ˆèŠ‚çœ AI çš„ Token æ¶ˆè€—ï¼Œå¹¶é˜²æ­¢è§’è‰²å› è®°å¿†è¿‡è½½è€Œäº§ç”Ÿçš„é€»è¾‘æ¼‚ç§»ã€‚</p>
        </div>

        <button class="ios-btn primary" style="background:#000; color:#fff; margin-top:20px;" onclick="window.manualTriggerSummary()">
            æ‰‹åŠ¨æ‰§è¡Œå³æ—¶æ€»ç»“
        </button>

        <div class="tz-group-title">å·²åç¼©çš„æ ¸å¿ƒè®°å¿† (CHRONICLES)</div>
        <div id="summary-cards-container" style="width:100%; display:flex; flex-direction:column; gap:15px;">
            </div>

        <div style="height:50px;"></div>
    </div>
</div>
<div id="ios-notification-shade" class="notification-shade">
    <div class="notif-header-bar">
        <div class="notif-title">é€šçŸ¥ä¸­å¿ƒ</div>
        <div class="notif-clear-btn" onclick="window.clearAllNotifications()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div id="notification-list" class="notif-list-container">
        <div class="notif-empty-state">æ²¡æœ‰æ›´æ—©çš„é€šçŸ¥äº†</div>
    </div>

    <div class="shade-handle-bottom" onclick="window.closeNotificationShade()"></div>
</div>
<div id="iconApp" class="ios-app-window" style="background:#F2F2F7; z-index: 6000;">
    <div class="app-header">
        <div class="header-title-big">Icon Studio</div>
        <div class="header-close-btn" onclick="closeApp('iconApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body" style="padding: 20px 16px; align-items: center;">
        <div id="icon-preview-box" style="width: 120px; height: 120px; background: #fff; border-radius: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 15px 35px rgba(0,0,0,0.1); margin-bottom: 30px; overflow: hidden; border: 4px solid #fff;">
            <img id="icon-pre-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
            <div id="icon-pre-placeholder" style="text-align:center; color:#ccc; font-size:12px; font-weight:700;">PREVIEW</div>
        </div>

        <div class="tz-group-title" style="width:100%; text-align:left;">TARGET APP</div>
        <div class="ios-list-group" style="width:100%;">
            <div class="ios-list-item" onclick="window.openIconTargetPicker()">
                <div class="item-content" style="border:none;">
                    <span class="item-label">ä¿®æ”¹å¯¹è±¡</span>
                    <div class="item-right">
                        <span class="item-value" id="val-icon-target">è¯·é€‰æ‹©...</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="segment-control" style="width: 100%; margin: 20px 0;">
            <div class="segment-btn active" id="icon-tab-file" onclick="switchIconInputMode('file')">æœ¬åœ°æ–‡ä»¶</div>
            <div class="segment-btn" id="icon-tab-url" onclick="switchIconInputMode('url')">ç½‘ç»œé“¾æ¥</div>
        </div>

        <div id="icon-panel-file" style="width:100%;">
            <input type="file" id="icon-file-input" accept="image/*" onchange="handleIconFile(this)" style="display:none;">
            
            <button class="ios-btn primary" style="background:#000;" onclick="document.getElementById('icon-file-input').click()">ä»ç›¸å†Œä¸Šä¼ </button>
        </div>

        <div id="icon-panel-url" style="width:100%; display:none;">
            <input type="text" id="icon-url-in" class="ios-input" placeholder="ç²˜è´´å›¾æ ‡å›¾ç‰‡ URL..." style="background:#fff; border-radius:12px;">
            <button class="ios-btn primary" style="background:#000;" onclick="window.handleIconUrl()">åŒæ­¥ URL</button>
        </div>

        <button class="ios-btn primary" style="margin-top: 30px; background:#007AFF;" onclick="window.saveIconCustomization()">åº”ç”¨å¹¶ä¿å­˜åˆ°æ¡Œé¢</button>
        
        <div style="font-size:11px; color:#bbb; margin-top:20px; text-align:center; line-height:1.5;">
            æç¤ºï¼šå»ºè®®ä½¿ç”¨æ­£æ–¹å½¢å›¾ç‰‡ä»¥è·å¾—æœ€ä½³æ•ˆæœã€‚<br>ä¿å­˜åå°†ç«‹å³è¦†ç›–ç³»ç»Ÿé¢„è®¾å›¾æ ‡ã€‚
        </div>
    </div>
</div>
<div id="subpage-icon-picker" class="ios-sub-page" style="z-index: 7000; background: #F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-icon-picker')" style="color:#007AFF; font-size:16px; cursor:pointer;">å–æ¶ˆ</div>
        <div style="font-weight:700;">é€‰æ‹©ç›®æ ‡ App</div>
        <div style="width:40px;"></div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">SYSTEM & INSTALLED</div>
        <div id="icon-target-list" class="ios-list-group">
            </div>
    </div>
</div>
<div id="subpage-weather-perceive" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-weather-perceive')" style="color:#007AFF; font-size:16px; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:800;">æ„ŸçŸ¥ä¸­å¿ƒ</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">AI è”è§‰åè®®</div>
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content" style="border:none;">
                    <span class="item-label">èŠå¤©æ—¶å¸¦å…¥å®æ—¶å¤©æ°”</span>
                    <div class="item-right">
                        <input type="checkbox" id="sync-weather-toggle" class="world-checkbox" onchange="toggleWeatherSync()">
                    </div>
                </div>
            </div>
        </div>
        <div style="font-size:11px; color:#bbb; padding:0 10px 15px;">å¼€å¯åï¼ŒTa åœ¨èŠå¤©æ—¶ä¼šæ„ŸçŸ¥åˆ°ä½ é‚£é‡Œçš„å®æ—¶æ°”æ¸©ä¸å¤©æ°”ã€‚</div>

        <div class="sense-action-area">
            <button class="sense-btn-main" onclick="triggerManualSense()">ç«‹åˆ»æ•è·ç¢ç‰‡</button>
            <button class="sense-btn-sub" onclick="openSenseFrequencyPicker()">è‡ªåŠ¨é¢‘ç‡</button>
        </div>

        <div class="tz-group-title">æ—¶ç©ºæ¡£æ¡ˆ (TIMELINE)</div>
        <div id="sense-timeline-container" style="display:flex; flex-direction:column; gap:20px; padding-bottom:100px;">
            </div>
    </div>
</div>
<div id="senseFrequencyPicker" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index: 100000;" onclick="closeSenseFrequencyPicker()">
    <div class="ios-action-sheet" onclick="event.stopPropagation()">
        <div class="sheet-title-box">é€‰æ‹©è‡ªåŠ¨æ„Ÿåº”é¢‘ç‡</div>
        
        <div class="sheet-item" onclick="setSenseFrequency(60000, '1 åˆ†é’Ÿ (æµ‹è¯•)')">1 åˆ†é’Ÿ (æµ‹è¯•ä¸“ç”¨)</div>
        <div class="sheet-item" onclick="setSenseFrequency(3600000, '1 å°æ—¶')">æ¯ 1 å°æ—¶</div>
        <div class="sheet-item" onclick="setSenseFrequency(14400000, '4 å°æ—¶')">æ¯ 4 å°æ—¶</div>
        <div class="sheet-item" onclick="setSenseFrequency(43200000, '12 å°æ—¶')">æ¯ 12 å°æ—¶</div>
        <div class="sheet-item" onclick="setSenseFrequency(86400000, '24 å°æ—¶')">æ¯ 24 å°æ—¶</div>
        
        <div class="sheet-cancel" onclick="closeSenseFrequencyPicker()">å–æ¶ˆ</div>
    </div>
</div>
<div id="subpage-region-perceive" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-region-perceive')" style="color:#007AFF; font-size:16px; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:800;">åœ°åŒºæ„ŸçŸ¥</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 10px 16px 120px 16px;">
        <div id="region-vibe-card" class="region-mag-card" onclick="regenerateRegionVibe()">
            <div class="mag-overlay"></div>
            <div class="mag-content">
                <div class="mag-tag-row">
                    <span class="mag-city-name" id="mag-city-display">Beijing</span>
                    <span class="mag-status-dot"></span>
                </div>
                <div class="mag-divider"></div>
                <div class="mag-vibe-text" id="mag-vibe-display">æ­£åœ¨æ„Ÿåº”æ—¶ç©º...</div>
                <div class="mag-footer">
                    <span>ç‚¹å‡»å¡ç‰‡é‡åˆ·</span>
                    <span id="mag-char-name">FROM TA</span>
                </div>
            </div>
            <div id="region-loading" class="vibe-loading-layer">
                <div class="quantum-spinner"></div>
            </div>
        </div>

        <div class="ios-list-group">
            <div class="ios-list-item">
                <span class="item-label">å…è®¸ Ta æ¢æµ‹æˆ‘çš„åŸå¸‚ç‰¹è´¨</span>
                <div class="item-right">
                    <input type="checkbox" id="sync-region-toggle" class="world-checkbox" onchange="toggleRegionSync()">
                </div>
            </div>
            <div class="ios-list-item" style="border-top:0.5px solid #eee;">
                <span class="item-label">å½“å‰ä½ç½®</span>
                <div class="item-right">
                    <span class="item-value" id="val-region-city">Beijing</span>
                </div>
            </div>
        </div>

        <div class="tz-group-title">åŒ—å›½é£å…‰ä¸æ±Ÿæµ™æ¸©å©‰ (NORTH & EAST)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(39.9, 116.4, 'Beijing')">åŒ—äº¬</div>
            <div class="city-tag" onclick="quickSwitchCity(31.2, 121.4, 'Shanghai')">ä¸Šæµ·</div>
            <div class="city-tag" onclick="quickSwitchCity(39.1, 117.2, 'Tianjin')">å¤©æ´¥</div>
            <div class="city-tag" onclick="quickSwitchCity(38.9, 121.6, 'Dalian')">å¤§è¿</div>
            <div class="city-tag" onclick="quickSwitchCity(41.8, 123.4, 'Shenyang')">æ²ˆé˜³</div>
            <div class="city-tag" onclick="quickSwitchCity(45.7, 126.6, 'Harbin')">å“ˆå°”æ»¨</div>
            <div class="city-tag" onclick="quickSwitchCity(43.8, 125.3, 'Changchun')">é•¿æ˜¥</div>
            <div class="city-tag" onclick="quickSwitchCity(36.7, 117.0, 'Jinan')">æµå—</div>
            <div class="city-tag" onclick="quickSwitchCity(36.1, 120.3, 'Qingdao')">é’å²›</div>
            <div class="city-tag" onclick="quickSwitchCity(37.5, 121.4, 'Yantai')">çƒŸå°</div>
            <div class="city-tag" onclick="quickSwitchCity(31.3, 120.6, 'Suzhou')">è‹å·</div>
            <div class="city-tag" onclick="quickSwitchCity(30.2, 120.2, 'Hangzhou')">æ­å·</div>
            <div class="city-tag" onclick="quickSwitchCity(29.9, 121.5, 'Ningbo')">å®æ³¢</div>
            <div class="city-tag" onclick="quickSwitchCity(32.0, 118.8, 'Nanjing')">å—äº¬</div>
            <div class="city-tag" onclick="quickSwitchCity(31.5, 120.3, 'Wuxi')">æ— é”¡</div>
            <div class="city-tag" onclick="quickSwitchCity(32.4, 119.4, 'Yangzhou')">æ‰¬å·</div>
            <div class="city-tag" onclick="quickSwitchCity(38.0, 114.5, 'Shijiazhuang')">çŸ³å®¶åº„</div>
            <div class="city-tag" onclick="quickSwitchCity(37.9, 112.5, 'Taiyuan')">å¤ªåŸ</div>
            <div class="city-tag" onclick="quickSwitchCity(40.8, 111.7, 'Hohhot')">å‘¼å’Œæµ©ç‰¹</div>
        </div>

        <div class="tz-group-title">å—æ–¹çš„æ½®æ¹¿ä¸é”¦ç»£å·´èœ€ (SOUTH & WEST)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(23.1, 113.3, 'Guangzhou')">å¹¿å·</div>
            <div class="city-tag" onclick="quickSwitchCity(22.5, 114.1, 'Shenzhen')">æ·±åœ³</div>
            <div class="city-tag" onclick="quickSwitchCity(22.3, 113.5, 'Zhuhai')">ç æµ·</div>
            <div class="city-tag" onclick="quickSwitchCity(23.0, 113.1, 'Foshan')">ä½›å±±</div>
            <div class="city-tag" onclick="quickSwitchCity(23.0, 113.8, 'Dongguan')">ä¸œè</div>
            <div class="city-tag" onclick="quickSwitchCity(22.4, 114.2, 'HongKong')">é¦™æ¸¯</div>
            <div class="city-tag" onclick="quickSwitchCity(22.2, 113.5, 'Macau')">æ¾³é—¨</div>
            <div class="city-tag" onclick="quickSwitchCity(24.5, 118.1, 'Xiamen')">å¦é—¨</div>
            <div class="city-tag" onclick="quickSwitchCity(26.1, 119.3, 'Fuzhou')">ç¦å·</div>
            <div class="city-tag" onclick="quickSwitchCity(24.9, 118.6, 'Quanzhou')">æ³‰å·</div>
            <div class="city-tag" onclick="quickSwitchCity(30.6, 114.3, 'Wuhan')">æ­¦æ±‰</div>
            <div class="city-tag" onclick="quickSwitchCity(28.2, 113.0, 'Changsha')">é•¿æ²™</div>
            <div class="city-tag" onclick="quickSwitchCity(28.7, 115.9, 'Nanchang')">å—æ˜Œ</div>
            <div class="city-tag" onclick="quickSwitchCity(31.8, 117.3, 'Hefei')">åˆè‚¥</div>
            <div class="city-tag" onclick="quickSwitchCity(34.8, 113.7, 'Zhengzhou')">éƒ‘å·</div>
            <div class="city-tag" onclick="quickSwitchCity(30.7, 104.1, 'Chengdu')">æˆéƒ½</div>
            <div class="city-tag" onclick="quickSwitchCity(29.6, 106.6, 'Chongqing')">é‡åº†</div>
            <div class="city-tag" onclick="quickSwitchCity(25.1, 110.3, 'Guilin')">æ¡‚æ—</div>
            <div class="city-tag" onclick="quickSwitchCity(22.8, 108.3, 'Nanning')">å—å®</div>
            <div class="city-tag" onclick="quickSwitchCity(26.6, 106.6, 'Guiyang')">è´µé˜³</div>
            <div class="city-tag" onclick="quickSwitchCity(25.0, 102.7, 'Kunming')">æ˜†æ˜</div>
            <div class="city-tag" onclick="quickSwitchCity(20.0, 110.3, 'Haikou')">æµ·å£</div>
            <div class="city-tag" onclick="quickSwitchCity(18.3, 109.5, 'Sanya')">ä¸‰äºš</div>
        </div>

        <div class="tz-group-title">ä¸è·¯é•¿æ­Œä¸æ—¥å…‰ä¹‹åŸ (FRONTIER)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(34.3, 108.9, 'Xi\'an')">è¥¿å®‰</div>
            <div class="city-tag" onclick="quickSwitchCity(34.6, 112.4, 'Luoyang')">æ´›é˜³</div>
            <div class="city-tag" onclick="quickSwitchCity(36.1, 103.8, 'Lanzhou')">å…°å·</div>
            <div class="city-tag" onclick="quickSwitchCity(36.6, 101.8, 'Xining')">è¥¿å®</div>
            <div class="city-tag" onclick="quickSwitchCity(38.5, 106.3, 'Yinchuan')">é“¶å·</div>
            <div class="city-tag" onclick="quickSwitchCity(43.8, 87.6, 'Urumqi')">ä¹Œé²æœ¨é½</div>
            <div class="city-tag" onclick="quickSwitchCity(29.7, 91.1, 'Lhasa')">æ‹‰è¨</div>
            <div class="city-tag" onclick="quickSwitchCity(39.5, 75.9, 'Kashgar')">å–€ä»€</div>
        </div>

        <div class="tz-group-title">æš¹ç½—æ™šé£ä¸äºšæ´²æ„Ÿåº” (ASIA)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(13.7, 100.5, 'Bangkok')">æ›¼è°·</div>
            <div class="city-tag" onclick="quickSwitchCity(18.8, 99.0, 'Chiang Mai')">æ¸…è¿ˆ</div>
            <div class="city-tag" onclick="quickSwitchCity(7.9, 98.3, 'Phuket')">æ™®å‰</div>
            <div class="city-tag" onclick="quickSwitchCity(12.9, 100.9, 'Pattaya')">èŠ­æé›…</div>
            <div class="city-tag" onclick="quickSwitchCity(9.5, 100.0, 'Koh Samui')">è‹æ¢…å²›</div>
            <div class="city-tag" onclick="quickSwitchCity(35.7, 139.7, 'Tokyo')">ä¸œäº¬</div>
            <div class="city-tag" onclick="quickSwitchCity(34.7, 135.5, 'Osaka')">å¤§é˜ª</div>
            <div class="city-tag" onclick="quickSwitchCity(35.0, 135.8, 'Kyoto')">äº¬éƒ½</div>
            <div class="city-tag" onclick="quickSwitchCity(37.6, 127.0, 'Seoul')">é¦–å°”</div>
            <div class="city-tag" onclick="quickSwitchCity(1.3, 103.8, 'Singapore')">æ–°åŠ å¡</div>
            <div class="city-tag" onclick="quickSwitchCity(3.1, 101.7, 'Kuala Lumpur')">å‰éš†å¡</div>
            <div class="city-tag" onclick="quickSwitchCity(10.8, 106.6, 'Ho Chi Minh City')">èƒ¡å¿—æ˜å¸‚</div>
            <div class="city-tag" onclick="quickSwitchCity(21.0, 105.8, 'Hanoi')">æ²³å†…</div>
            <div class="city-tag" onclick="quickSwitchCity(-8.4, 115.2, 'Bali')">å·´å˜å²›</div>
            <div class="city-tag" onclick="quickSwitchCity(14.6, 121.0, 'Manila')">é©¬å°¼æ‹‰</div>
            <div class="city-tag" onclick="quickSwitchCity(-6.2, 106.8, 'Jakarta')">é›…åŠ è¾¾</div>
            <div class="city-tag" onclick="quickSwitchCity(25.0, 121.5, 'Taipei')">å°åŒ—</div>
            <div class="city-tag" onclick="quickSwitchCity(19.1, 72.9, 'Mumbai')">å­Ÿä¹°</div>
            <div class="city-tag" onclick="quickSwitchCity(17.9, 102.6, 'Vientiane')">ä¸‡è±¡</div>
            <div class="city-tag" onclick="quickSwitchCity(22.6, 120.3, 'Kaohsiung')">é«˜é›„</div>
        </div>

        <div class="tz-group-title">æ¬§é™†æ—§æ¢¦ä¸é›¾éƒ½å­¤æ—… (EUROPE)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(48.9, 2.3, 'Paris')">å·´é»</div>
            <div class="city-tag" onclick="quickSwitchCity(51.5, -0.1, 'London')">ä¼¦æ•¦</div>
            <div class="city-tag" onclick="quickSwitchCity(41.9, 12.5, 'Rome')">ç½—é©¬</div>
            <div class="city-tag" onclick="quickSwitchCity(52.5, 13.4, 'Berlin')">æŸæ—</div>
            <div class="city-tag" onclick="quickSwitchCity(52.4, 4.9, 'Amsterdam')">é˜¿å§†æ–¯ç‰¹ä¸¹</div>
            <div class="city-tag" onclick="quickSwitchCity(45.4, 12.3, 'Venice')">å¨å°¼æ–¯</div>
            <div class="city-tag" onclick="quickSwitchCity(50.1, 14.4, 'Prague')">å¸ƒæ‹‰æ ¼</div>
            <div class="city-tag" onclick="quickSwitchCity(48.2, 16.4, 'Vienna')">ç»´ä¹Ÿçº³</div>
            <div class="city-tag" onclick="quickSwitchCity(40.4, -3.7, 'Madrid')">é©¬å¾·é‡Œ</div>
            <div class="city-tag" onclick="quickSwitchCity(41.4, 2.2, 'Barcelona')">å·´å¡ç½—é‚£</div>
            <div class="city-tag" onclick="quickSwitchCity(38.0, 23.7, 'Athens')">é›…å…¸</div>
            <div class="city-tag" onclick="quickSwitchCity(41.0, 29.0, 'Istanbul')">ä¼Šæ–¯å¦å¸ƒå°”</div>
            <div class="city-tag" onclick="quickSwitchCity(38.7, -9.1, 'Lisbon')">é‡Œæ–¯æœ¬</div>
            <div class="city-tag" onclick="quickSwitchCity(47.4, 8.5, 'Zurich')">è‹é»ä¸–</div>
            <div class="city-tag" onclick="quickSwitchCity(50.8, 4.3, 'Brussels')">å¸ƒé²å¡å°”</div>
            <div class="city-tag" onclick="quickSwitchCity(60.2, 24.9, 'Helsinki')">èµ«å°”è¾›åŸº</div>
            <div class="city-tag" onclick="quickSwitchCity(64.1, -21.9, 'Reykjavik')">é›·å…‹é›…æœªå…‹</div>
            <div class="city-tag" onclick="quickSwitchCity(55.8, 37.6, 'Moscow')">è«æ–¯ç§‘</div>
        </div>

        <div class="tz-group-title">è·¨è¶Šç»çº¬çš„è¿œæ–¹ (AMERICAS & OTHERS)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(40.7, -74.0, 'New York')">çº½çº¦</div>
            <div class="city-tag" onclick="quickSwitchCity(34.1, -118.2, 'Los Angeles')">æ´›æ‰çŸ¶</div>
            <div class="city-tag" onclick="quickSwitchCity(37.8, -122.4, 'San Francisco')">æ—§é‡‘å±±</div>
            <div class="city-tag" onclick="quickSwitchCity(49.3, -123.1, 'Vancouver')">æ¸©å“¥å</div>
            <div class="city-tag" onclick="quickSwitchCity(43.7, -79.4, 'Toronto')">å¤šä¼¦å¤š</div>
            <div class="city-tag" onclick="quickSwitchCity(25.7, -80.2, 'Miami')">è¿ˆé˜¿å¯†</div>
            <div class="city-tag" onclick="quickSwitchCity(19.4, -99.1, 'Mexico City')">å¢¨è¥¿å“¥åŸ</div>
            <div class="city-tag" onclick="quickSwitchCity(-22.9, -43.2, 'Rio de Janeiro')">é‡Œçº¦çƒ­å†…å¢</div>
            <div class="city-tag" onclick="quickSwitchCity(-34.6, -58.4, 'Buenos Aires')">å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯</div>
            <div class="city-tag" onclick="quickSwitchCity(25.2, 55.3, 'Dubai')">è¿ªæ‹œ</div>
            <div class="city-tag" onclick="quickSwitchCity(30.0, 31.2, 'Cairo')">å¼€ç½—</div>
            <div class="city-tag" onclick="quickSwitchCity(-33.9, 18.4, 'Cape Town')">å¼€æ™®æ•¦</div>
            <div class="city-tag" onclick="quickSwitchCity(-33.9, 151.2, 'Sydney')">æ‚‰å°¼</div>
            <div class="city-tag" onclick="quickSwitchCity(-37.8, 145.0, 'Melbourne')">å¢¨å°”æœ¬</div>
        </div>

        <div class="standalone-btn user-btn-secondary" style="margin-top:20px;" onclick="openSubPage('subpage-timezone')">é€‰æ‹©æ›´å¤šæ—¶åŒºåŸå¸‚...</div>
    </div>
</div>
<div id="subpage-language-settings" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-language-settings')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> è¿”å›
        </div>
        <div style="font-size:17px; font-weight:600;">è¯­è¨€ä¸ç¿»è¯‘</div>
        <div onclick="window.saveLanguageSettings()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display: block; width: 100%;">
        <div class="tz-group-title">å®æ—¶ç¿»è¯‘åè®® (TRANSLATION)</div>
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content">
                    <span class="item-label">å¼€å¯åŒè¯­å¯¹ç…§</span>
                    <input type="checkbox" id="lang-sync-toggle" class="world-checkbox" onchange="window.updateLangPreview()">
                </div>
            </div>
            <div class="ios-list-item" onclick="window.openLangPicker()">
                <div class="item-content" style="border:none;">
                    <span class="item-label">ç›®æ ‡è¯­è¨€</span>
                    <div class="item-right">
                        <span class="item-value" id="val-target-lang">è‹±è¯­ (English)</span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>

        <div id="lang-reset-tip" style="margin: 10px 10px 25px 10px; padding: 15px; background: rgba(255, 59, 48, 0.05); border-radius: 14px; border: 1px dashed rgba(255, 59, 48, 0.2); display: none;">
            <div style="display:flex; align-items:center; gap:8px; color: #FF3B30; font-weight: 700; font-size: 13px; margin-bottom: 5px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                çŠ¶æ€å¼‚å¸¸æé†’
            </div>
            <p style="font-size: 12px; color: #666; line-height: 1.5;">
                è‹¥å…³é—­å AI ä»å›å¤å¤–è¯­ï¼Œè¯´æ˜å…¶å¤„äºâ€œè®°å¿†æƒ¯æ€§â€ä¸­ã€‚è¯·åœ¨èŠå¤©æ¡†å‘é€ï¼š<br>
                <b style="color:#1d1d1f; user-select: all;">ç³»ç»ŸæŒ‡ä»¤ï¼šæ¢å¤æ¯è¯­äº¤æµ</b><br>
                å‘é€åå³å¯å½»åº•åˆ‡å›çº¯ä¸­æ–‡ã€‚
            </p>
        </div>

        <div class="tz-group-title">æ ·å¼é¢„è§ˆ (UI PREVIEW)</div>
        <div id="lang-preview-container" style="padding: 20px; background: #fff; border-radius: 20px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px;">
            <div class="msg-row opponent">
                <div class="bubble dual-lang show-trans" id="sample-bubble">
                    <div class="msg-text-main">I will always be by your side, through the starlight and the deep sea.</div>
                    <div class="bubble-translation-box">
                        <div class="trans-line"></div>
                        <div class="msg-text-trans">æˆ‘ä¼šæ°¸è¿œåœ¨ä½ èº«è¾¹ï¼Œç©¿è¿‡æ˜Ÿå…‰ä¸æ·±æµ·ã€‚</div>
                    </div>
                    <div class="trans-toggle-btn">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        <span>ç¿»è¯‘</span>
                    </div>
                </div>
            </div>
        </div>

        <div style="font-size:12px; color:#bbb; padding: 0 10px; line-height: 1.6;">
            æç¤ºï¼šå¼€å¯åï¼ŒAI å°†æ ¹æ®ä½ é€‰æ‹©çš„è¯­è¨€è¿›è¡Œå›å¤ï¼Œå¹¶è‡ªåŠ¨é™„å¸¦ä¸­æ–‡ç¿»è¯‘ã€‚ç‚¹å‡»æ°”æ³¡å³ä¸‹è§’çš„â€œç¿»è¯‘â€æŒ‰é’®å¯å±•å¼€/æŠ˜å è¯‘æ–‡ï¼Œé•¿æŒ‰æ°”æ³¡å”¤èµ·åŠŸèƒ½èœå•ã€‚
        </div>
    </div>
</div>
<div id="subpage-theme-store" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-theme-store')" style="color:#007AFF; font-size:16px; cursor:pointer; display:flex; align-items:center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:-2px;"><polyline points="15 18 9 12 15 6"></polyline></svg> è®¾ç½®
        </div>
        <div style="font-size:17px; font-weight:600;">å¸ƒå±€æ¶æ„</div>
        <div onclick="window.applyFinalTheme()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">åº”ç”¨</div>
    </div>

    <div class="app-body" style="padding: 10px 16px 120px 16px; display:block;">

    <div class="tz-group-title">å…¨åŸŸ 1:1 ç‰©ç†é•œåƒé¢„è§ˆ (æ— æŸå¤åˆ»)</div>

    <div class="ui-phone-container" style="width: 340px; height: 620px; background: #111; padding: 8px; border-radius: 48px; position: relative;">
        <div class="ui-phone-notches"></div>
        
        <div id="theme-preview-window" class="ui-phone-screen" style="background: #F2F2F7; border-radius: 40px; overflow: hidden; position: relative;">
            <div class="actual-mirror-layer" id="actual-mirror-layer">
                
                <div class="status-bar" style="background: transparent !important; height: 44px; padding: 0 24px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 14px; font-weight: 700;">16:31</span>
                    <div class="status-right" style="display:flex; align-items:center; gap:5px;">
                        <svg width="18" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M1 9h2v2H1zm4-3h2v5H5zm4-3h2v8H9zm4-3h2v11h-2z"/></svg>
                        <div class="battery-box" style="width:25px; height:12px; border:1.5px solid currentColor; border-radius:3px; position:relative;"><div class="bat-fill" style="width:46%; background:currentColor; height:100%;"></div></div>
                    </div>
                </div>

                <div class="chat-room-header" style="background: transparent !important; border: none !important; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px;">
                    <div class="header-glass-btn left" style="width:40px; height:40px; border-radius:50%; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </div>
                    <div class="header-contact-info">
                        <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Felix" style="width:36px; height:36px; border-radius:50%; border:2px solid #fff;">
                        <div class="header-text-stack"><span style="font-size:14px; font-weight:800;">æµ‹è¯• (Preview)</span></div>
                    </div>
                    <div class="header-glass-btn right" style="width:40px; height:40px; border-radius:50%; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                    </div>
                </div>

                <div class="chat-scroll-area" style="flex:1; padding:20px; display:flex; flex-direction:column; gap:12px;">
                    <div class="msg-row opponent">
                        <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Felix" class="chat-avatar-img" style="width:34px; height:34px;">
                        <div class="bubble">
                            <div class="msg-text-main">å¦‚æœä½ èƒ½å¬åˆ°æˆ‘çš„å›å“ã€‚</div>
                        </div>
                    </div>
                    <div class="msg-row user">
                        <div class="bubble"><div class="msg-text-main">æˆ‘ä¸€ç›´éƒ½åœ¨ã€‚</div></div>
                    </div>
                </div>

                <div class="chat-room-footer-wrapper" style="padding: 0 15px 25px 15px;">
                    <div class="chat-room-footer" style="position: relative !important; width: 100% !important; height: 56px !important; border-radius: 28px !important; background: rgba(255,255,255,0.8) !important; backdrop-filter: blur(20px) !important; display: flex !important; align-items: center !important; padding: 0 10px 0 15px !important; gap: 12px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.05) !important;">
                        <div class="footer-add-btn" style="color: #8E8E93; font-size: 24px;">+</div>
                        <div class="chat-room-input" style="flex: 1; color: #C7C7CC; font-size: 15px;">Type something...</div>
                        <div style="display:flex; gap:8px;">
                            <div class="action-btn ai" style="width:36px; height:36px; border-radius:50%; background:rgba(0,0,0,0.05); display:flex; align-items:center; justify-content:center; color:#333;">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                            </div>
                            <div class="action-btn send" style="width:36px; height:36px; border-radius:50%; background:#007AFF; display:flex; align-items:center; justify-content:center; color:#fff;">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="3"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="tz-group-title">å†…æ ¸ä»£ç  (CORE CSS)</div>
        <div class="ios-list-group" style="background:#1d1d1f; border-radius:18px;">
            <textarea id="theme-custom-code" class="code-editor-textarea" 
                placeholder="/* å¯ä»¥åœ¨æ­¤é’ˆå¯¹ .bubble, .status-bar, .chat-room-footer ç¼–å†™æ ·å¼ */"
                oninput="window.livePreviewTheme(this.value)"></textarea>
        </div>
        
        <button class="ios-btn" style="background:#fff; color:#FF3B30; margin-top:30px; border:0.5px solid rgba(0,0,0,0.1);" onclick="window.resetTheme()">
            æŠ¹é™¤æ‰€æœ‰è£…é¥°ä»£ç 
        </button>
    </div>
</div>
<div id="destiny-overlay" class="destiny-stage-ins">
    <button class="ins-exit-btn" onclick="window.closeDestinyPage()">
        <div class="exit-cross-icon"></div>
        <span class="exit-label">Close</span>
    </button>

    <div class="status-bar-safe-area"></div>

    <header class="ins-art-header">
        <div id="fate-hero-img" class="header-hero-bg" onclick="triggerAvatarUpload()"></div>
        
        <div class="header-main-content">
            <div class="fate-status-tag">Destiny Bond Protocol</div>
            <h1 id="sync-char-name" class="art-char-name">NAME</h1>

            <div class="perception-grid">
                <div class="p-item">
                    <span class="p-label">Location</span>
                    <span id="fate-location" class="p-value">æ›¼è°· Â· æ¹„å—æ²³</span>
                </div>
                <div class="p-item">
                    <span class="p-label">Weather</span>
                    <span id="fate-weather" class="p-value">Thunderstorm 24Â°C</span>
                </div>
                <div class="p-item">
                    <span class="p-label">Bonded Days</span>
                    <span id="fate-days" class="p-value">0 Days</span>
                </div>
            </div>

            <div class="mini-progress-track">
                <div id="sync-progress-line" class="progress-glow-line" style="width: 60%;"></div>
            </div>

            <blockquote id="sync-prose-bio" class="art-prose-quote" style="position:relative;">
                â€œæ­£åœ¨æ„Ÿåº”æ—¶ç©ºç•™ç™½...â€
                <div onclick="window.refreshDestinyProse()" style="position:absolute; bottom:-25px; right:0; font-size:10px; opacity:0.3; cursor:pointer; letter-spacing:1px;">RE-WEAVE</div>
            </blockquote>
        </div>
    </header>

    <div id="destiny-story-flow">
        <div style="text-align:center; padding: 0px 0 50px 0; color:rgba(255,255,255,0.05); font-size:10px; letter-spacing:5px;">
            STORY THREAD INITIALIZEDSTO
        </div>
        </div>

    <footer class="destiny-footer-console">
        <div class="destiny-input-wrapper">
            <input type="text" 
                id="destiny-input-field" 
                class="destiny-main-input" 
                placeholder="Whisper to fate / å‘é€ç©ºæ ¼è®© AI æ¨åŠ¨..."
                onkeypress="if(event.key==='Enter') window.sendDestinyCommand()">
        </div>

        <div class="destiny-control-group">
            <button class="console-btn settings" onclick="window.openDestinySettings()" title="Fate Calibration">
                <svg class="console-icon" viewBox="0 0 24 24">
                    <path d="M12 22v-6M12 8V2M20.66 17l-5.2-3M8.54 10l-5.2-3M3.34 17l5.2-3M15.46 10l5.2-3"></path>
                    <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
                </svg>
            </button>

            <button class="console-btn send" onclick="window.sendDestinyCommand()" title="Synchronize Destiny">
                <svg class="console-icon" viewBox="0 0 24 24">
                    <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"></path>
                </svg>
            </button>
        </div>
    </footer>

    <div id="modal-destiny-settings" class="destiny-settings-mask" onclick="if(event.target==this) window.closeDestinySettings()">
        <div class="destiny-settings-card" onclick="event.stopPropagation()">
            <h2 class="settings-title-serif">Protocol Calibration</h2>
            
            <div class="settings-group">
                <span class="settings-label">Writing Style / æ–‡é£</span>
                <input type="text" id="destiny-style-in" class="settings-input-alt" placeholder="ä¾‹å¦‚ï¼šç°ä»£æ•£æ–‡ã€ç ´ç¢ã€æš§æ˜§">
            </div>

            <div class="settings-group">
                <span class="settings-label">Story Thread / å¼ºåˆ¶å‰§æƒ…ç‚¹</span>
                <textarea id="destiny-plot-in" class="settings-input-alt" style="height: 100px; resize: none;" placeholder="å¡«å†™å AI å°†å¼ºåˆ¶æ‰§è¡Œæ­¤æƒ…èŠ‚..."></textarea>
            </div>

            <div class="settings-group">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span class="settings-label">Narrative Length / ç¯‡å¹…</span>
                    <span id="destiny-word-val" style="font-size:12px; color:#fff; font-weight:800;">500</span>
                </div>
                <input type="range" id="destiny-wordcount-in" min="500" max="5000" step="100" value="500" 
                    oninput="window.updateDestinySlider(this)">
            </div>

            <button class="settings-sync-btn" onclick="window.saveDestinyProtocol()">Synchronize Protocol</button>
            <div onclick="window.closeDestinySettings()" style="text-align:center; color:rgba(255,255,255,0.2); font-size:9px; margin-top:20px; cursor:pointer; letter-spacing:1px;">DISMISS</div>
        </div>
    </div>

    <input type="file" id="avatar-input" hidden accept="image/*" onchange="window.updateAvatar(this)">
</div>
<div id="subpage-travel-journal" class="ios-sub-page" style="background:#FFFFFF; z-index: 8000;">
    <div class="app-header" style="background: #FFFFFF; border-bottom: 1px solid #000000;">
        <div onclick="closeSubPage('subpage-travel-journal')" style="color:#000; font-size:14px; cursor:pointer; display:flex; align-items:center; font-weight:700; letter-spacing:1px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>BACK
        </div>
        <div style="font-size:15px; font-weight:900; color:#000; letter-spacing:4px; text-transform:uppercase;">Voyage Journal</div>
        <div id="travel-reset-btn" style="color:#888; font-size:12px; font-weight:700; letter-spacing:1px;" onclick="resetTravelLog()">RESET</div>
    </div>

    <div class="app-body" style="padding:0; display:flex; flex-direction:column; background:#FFFFFF; position:relative; overflow:hidden;">
        
        <div id="view-journal-panel" class="voyage-panel active">
            <div id="travel-planner" style="padding: 60px 30px;">
                <div style="font-size:10px; font-weight:800; letter-spacing:5px; color:#CCC; margin-bottom:10px;">FLIGHT PREPARATION</div>
                <h1 style="color:#000; font-size:36px; font-weight:300; font-family:serif; font-style:italic;">Seek your destiny.</h1>
                <div class="noir-form-container" style="margin-top:50px;">
                    <div class="noir-input-group">
                        <label>ORIGIN / å‡ºå‘åœ°</label>
                        <input type="text" id="travel-from" placeholder="Enter City">
                    </div>
                    <div class="noir-input-group">
                        <label>DESTINATION / ç›®çš„åœ°</label>
                        <input type="text" id="travel-to" placeholder="Enter City">
                    </div>
                    <div class="noir-input-group" style="border:none;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <label>STOPS / åœç•™ç«™ç‚¹</label>
                            <span id="stops-val-display" style="font-size:16px; font-weight:900; color:#000; font-family:serif; letter-spacing:1px;">05 SESSIONS</span>
                        </div>
                        
                        <div class="slider-wrapper" style="padding: 10px 0;">
                            <input type="range" id="travel-stops-slider"Â 
                                min="3" max="50" step="1" value="5"Â 
                                class="noir-range-slider"
                                oninput="updateStopsUI(this)">
                            
                            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:9px; color:#AAA; font-weight:800; letter-spacing:1px;">
                                <span>MIN: 03</span>
                                <span>MAX: 20</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="noir-btn-main" onclick="startTravelMapping()">GENERATE TRAJECTORY</button>
            </div>

            <div id="travel-canvas-area" style="display:none; padding:30px 20px 100px;">
                <div id="boarding-pass-container"></div>
                <div style="font-size:10px; font-weight:800; color:#000; margin-top:50px; letter-spacing:3px; border-bottom:1px solid #000; padding-bottom:10px;">MAP DECODING</div>
                <div id="travel-map-box">
                    <div class="map-stability-notice">NAV-PROTOCOL: STABLE VIEW RECOMMENDED</div>
                    <svg id="travel-svg-map" width="100%" height="100%"></svg>
                    <div id="travel-dots-layer"></div>
                </div>
                <button class="btn-save-voyage" onclick="window.saveTravelStub()">ARCHIVE THIS VOYAGE / å°å­˜æ­¤è¡Œæ—…</button>
            </div>
        </div>

        <div id="view-vault-panel" class="voyage-panel">
            <div style="padding: 40px 20px 120px;">
                <div class="hero-label" style="color:#CCC; font-size:10px; font-weight:900; letter-spacing:4px; margin-bottom:10px;">TEMPORAL RECORDS</div>
                <h1 style="font-family:serif; font-style:italic; font-size:32px; margin-bottom:40px;">Memory Vault.</h1>
                <div id="archive-list-container">
                    </div>
            </div>
        </div>

        <div class="voyage-nav-wrapper">
            <div class="voyage-capsule-nav">
                <div class="v-nav-item active" id="btn-nav-journal" onclick="switchVoyageTab('journal')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    <span>JOURNAL</span>
                </div>
                <div class="v-nav-item" id="btn-nav-vault" onclick="switchVoyageTab('vault')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <span>VAULT</span>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="modal-travel-log" class="destiny-settings-mask" onclick="this.style.display='none'">
    <div class="aesthetic-card" onclick="event.stopPropagation()">
        
        <div class="log-fixed-header">
            <div id="log-location-tag">LOCATION</div>
            <h2 id="log-city-name">åŸå¸‚åç§°</h2>
        </div>

        <div class="log-scroll-area">
            <div id="log-content-body">
                æ­£åœ¨åŒæ­¥é‡å­æ„Ÿå®˜é¢‘ç‡...
            </div>
        </div>

        <div id="log-mood-tag">
            MOOD: å®é™
        </div>

    </div>
</div>

<svg style="position: absolute; width: 0; height: 0;">
    <filter id="ink-noise">
        <feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
    </filter>
</svg>

<div id="subpage-voyage-archive" class="ios-sub-page" style="background:#F5F5F7;">
    <div class="app-header" style="background: #FFF; border-bottom: 1px solid #000;">
        <div onclick="closeSubPage('subpage-voyage-archive')" style="color:#000; font-size:14px; font-weight:700; cursor:pointer;">CLOSE</div>
        <div style="font-size:15px; font-weight:900; letter-spacing:4px;">VAULT</div>
        <div style="width:40px;"></div>
    </div>
    <div class="app-body" style="padding: 30px 20px;">
        <div class="hero-label">HISTORICAL TRAJECTORIES</div>
        <h1 style="font-family:serif; font-style:italic; font-size:32px; margin-bottom:40px;">Memory Vault.</h1>
        <div id="archive-list-container">
            </div>
    </div>
</div>
<div id="subpage-ticket-reveal" class="ios-sub-page" style="background:#121212; z-index: 9500; display: none; color: #fff;">
    <div class="app-header" style="background: transparent; border-bottom: none; position: absolute; top:0; left:0; width:100%; z-index:10;">
        <div onclick="closeSubPage('subpage-ticket-reveal')" style="color:rgba(255,255,255,0.7); font-size:12px; font-weight:700; cursor:pointer; background: rgba(0,0,0,0.6); padding: 6px 14px; border-radius: 30px; backdrop-filter: blur(10px); margin-top: 10px; border: 1px solid rgba(255,255,255,0.1);">
            CLOSE ARCHIVE
        </div>
    </div>

    <div class="app-body" style="padding: 100px 20px 40px; display: flex; flex-direction: column; align-items: center;">
        
        <div style="font-size:10px; font-weight:800; color:#555; letter-spacing:4px; margin-bottom:20px;">TAP TICKET TO VALIDATE</div>

        <div id="reveal-ticket-container" style="perspective: 1200px; cursor: pointer; margin-bottom: 50px; z-index: 5;">
            </div>

        <div id="reveal-map-section" style="width: 100%; opacity: 0; filter: blur(10px); transition: all 1s cubic-bezier(0.19, 1, 0.22, 1); pointer-events: none; transform: translateY(30px);">
             <div style="font-size:9px; font-weight:800; color:#888; margin-bottom:15px; letter-spacing:3px; text-align: center; display: flex; align-items: center; justify-content: center; gap:10px;">
                 <span style="display:inline-block; width:20px; height:1px; background:#333;"></span>
                 TRAJECTORY DECODED
                 <span style="display:inline-block; width:20px; height:1px; background:#333;"></span>
             </div>
             <div id="reveal-map-box" style="width:100%; height:360px; border-radius: 4px; overflow: hidden; position: relative; border: 1px solid #333; background: #000;">
                 </div>
        </div>
    </div>
</div>
<div id="subpage-chat-search" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-chat-search')" style="color:#007AFF; font-size:16px; cursor:pointer; display:flex; align-items:center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> è¿”å›
        </div>
        <div style="font-size:17px; font-weight:600;">æŸ¥æ‰¾èŠå¤©å†…å®¹</div>
        <div style="width:50px;"></div>
    </div>

    <div class="app-body" style="padding: 15px 16px; display:block;">
        <div class="ios-search-wrapper" style="margin-bottom: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3" style="margin-right: 10px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="chat-search-input" placeholder="å…³é”®è¯ã€æ—¥æœŸã€æ„è±¡..." style="border:none; background:transparent; outline:none; font-size:16px; flex:1; color:#000;" oninput="window.executeChatSearch()">
        </div>

        <div style="display:flex; gap:8px; margin-bottom:25px; overflow-x:auto; padding-bottom:5px;" class="hide-scrollbar">
            <div class="city-tag" style="flex:none; padding:8px 15px; font-size:12px; background:#fff;" onclick="window.setSearchFilter('all')">å…¨éƒ¨</div>
            <div class="city-tag" style="flex:none; padding:8px 15px; font-size:12px; background:#fff;" onclick="window.setSearchFilter('user')">æˆ‘çš„è¨€è¯­</div>
            <div class="city-tag" style="flex:none; padding:8px 15px; font-size:12px; background:#fff;" onclick="window.setSearchFilter('opponent')">Ta çš„å›åº”</div>
        </div>

        <div id="search-result-count" style="font-size:12px; color:#8e8e93; margin-bottom:15px; padding-left:5px;">è¾“å…¥å…³é”®è¯å¼€å§‹æ£€ç´¢...</div>

        <div id="chat-search-results" style="display:flex; flex-direction:column; gap:12px;">
            </div>
        
        <div style="height:50px;"></div>
    </div>
</div>
<div id="modal-image-picker" class="ios-alert-mask" style="align-items: flex-end; z-index: 20001;" onclick="if(event.target==this) this.style.display='none'">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span style="font-weight: 800; font-size: 17px;">å‘é€å›¾ç‰‡</span>
            <div class="p2-done-btn" onclick="document.getElementById('modal-image-picker').style.display='none'">å–æ¶ˆ</div>
        </div>
        <div class="p2-editor-body">
            <input type="text" id="chat-img-url-in" class="p2-main-input" placeholder="ç²˜è´´å›¾ç‰‡ URL...">
            <button class="ios-btn primary" style="background:#1d1d1f; margin-bottom:15px;" onclick="sendImageMessage('url')">å‘é€é“¾æ¥å›¾ç‰‡</button>
            
            <div style="text-align:center; color:#d1d1d6; font-size:10px; margin-bottom:15px; font-weight:800; letter-spacing:2px;">OR</div>
            
            <label class="custom-upload-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                <span>ä»ç›¸å†Œé€‰æ‹©</span>
                <input type="file" id="chat-img-file-in" hidden accept="image/*" onchange="sendImageMessage('file')">
            </label>
        </div>
    </div>
</div>

<div id="emoji-modal-mask" class="ios-alert-mask" onclick="window.closeEmojiModal(event)">
    <div class="emoji-modal-card" onclick="event.stopPropagation()">
        <div class="emoji-header">
            <span class="emoji-title" style="font-family: serif; font-weight: 800;">æˆ‘çš„è¡¨æƒ…</span>
            <span class="emoji-cancel" style="color: #007AFF; font-weight: 600; cursor: pointer;" onclick="window.closeEmojiModal()">å–æ¶ˆ</span>
        </div>
        
        <div id="emoji-grid-list"></div>

        <div class="emoji-footer" style="text-align: center; margin-top: 20px;">
            <div style="font-size: 10px; color: #ddd; font-weight: 900; letter-spacing: 3px; margin-bottom: 15px;">OR</div>
            <div class="emoji-add-btn" onclick="openEmojiManager(); window.closeEmojiModal();" style="background: #1d1d1f; color: #fff; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; cursor: pointer;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>æ·»åŠ æ–°è¡¨æƒ…</span>
            </div>
        </div>
    </div>
</div>
<div id="modal-emoji-manager" class="ios-alert-mask" style="display:none; align-items: flex-end; z-index: 30001;" onclick="if(event.target==this) this.style.display='none'">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span style="font-family: serif; font-weight: 800; font-size: 18px; letter-spacing: 1px;">NEW_EMOJI_TRACE</span>
            <div class="p2-done-btn" onclick="window.saveNewEmoji()" style="color: #007AFF; font-weight: 700; cursor: pointer;">å®Œæˆ</div>
        </div>

        <div class="p2-editor-body" style="display: flex; flex-direction: column; align-items: center; padding-top: 10px;">
            <div id="emoji-pre-box" onclick="document.getElementById('emoji-file-in').click()">
                <img id="emoji-pre-img" style="display:none; width:100%; height:100%; object-fit:cover;">
                <div id="emoji-pre-placeholder" style="text-align:center;">
                    <div style="font-size: 24px; color: #000; margin-bottom: 5px;">+</div>
                    <div style="font-size: 9px; font-weight: 900; color: #AAA; letter-spacing: 2px;">SELECT_IMAGE</div>
                </div>
            </div>

            <div style="width: 100%; margin-top: 25px;">
                <div style="font-size: 9px; font-weight: 900; color: #AAA; letter-spacing: 2px; margin-bottom: 8px; margin-left: 5px;">TAG / è§¦å‘æŒ‡ä»¤</div>
                <input type="text" id="emoji-tag-in" class="p2-main-input" placeholder="è¾“å…¥è¯†åˆ«å…³é”®è¯ (å¦‚: å‚²å¨‡, å“­å“­)..." style="margin-bottom: 10px; background: #f2f2f7; border: 1px solid transparent; transition: all 0.3s;">
            </div>

            <input type="file" id="emoji-file-in" hidden accept="image/*" onchange="window.handleEmojiPre(this)">
            
            <div class="tool-btn" onclick="document.getElementById('modal-emoji-manager').style.display='none'" style="color:#FF3B30; font-weight: 600; margin-top: 10px; cursor: pointer; font-size: 14px;">æ”¾å¼ƒæ­¤ç‰‡æ®µ</div>
        </div>
    </div>
</div>
<div id="subpage-voice-settings" class="ios-sub-page noir-voice-gate">
    <div class="app-header noir-header-fix">
        <div onclick="closeSubPage('subpage-voice-settings')" class="noir-h-btn">CANCEL</div>
        <div class="noir-h-title">SPEECH ENGINE</div>
        <div onclick="window.saveVoiceSettings()" class="noir-h-btn bold">DONE</div>
    </div>

    <div class="app-body" style="padding:0; display:block; overflow-y:auto;">
        <div class="noir-section-label">AUTHORIZATION / æˆæƒ</div>
        <div class="noir-full-list">
            <div class="noir-row">
                <span class="n-label">API Key</span>
                <input type="password" id="voice-key-in" class="noir-clean-input" placeholder="Secret Key">
            </div>
            <div class="noir-row last">
                <span class="n-label">Group ID</span>
                <input type="text" id="voice-group-in" class="noir-clean-input" placeholder="Group ID">
            </div>
        </div>

        <div class="noir-section-label">CORE MODEL / æ ¸å¿ƒæ¨¡å‹</div>
        <div class="noir-full-list">
            <div class="noir-row" onclick="window.openVoiceModelPicker()">
                <span class="n-label">å½“å‰é€‰æ‹©</span>
                <div class="n-value-link" id="voice-model-display">ç­‰å¾…è·å–...</div>
            </div>
            <div class="noir-row last" onclick="window.fetchAllMiniMaxModels()" style="justify-content: center; background: #fafafa;">
                <span id="fetch-model-btn-text" style="color: #007AFF; font-size: 14px; font-weight: 700; letter-spacing: 1px;">
                    âœ¦ FETCH MODELS FROM SERVER
                </span>
            </div>
        </div>
        
        <div class="noir-footer-hint">PROTOCOL: MINIMAX T2A V2.0 // NOIR KERNEL</div>
    </div>
</div>
<div id="custom-voice-picker" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index: 1000001;" onclick="this.style.display='none'">
    <div class="noir-picker-box" onclick="event.stopPropagation()">
        <div class="n-picker-header" id="picker-title">SELECT OPTION</div>
        <div id="picker-options-list" class="n-picker-scroll">
            </div>
        <div class="n-picker-cancel" onclick="document.getElementById('custom-voice-picker').style.display='none'">CANCEL</div>
    </div>
</div>
<div id="subpage-voice-calibrate" class="ios-sub-page" style="background:#F2F2F7; z-index: 11000;">
    <div class="app-header" style="background: rgba(242,242,247,0.95); backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.1);">
        <div onclick="closeSubPage('subpage-voice-calibrate')" style="color:#007AFF; font-size:17px; cursor:pointer; display:flex; align-items:center; width: 80px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> è¿”å›
        </div>
        <div style="font-size:17px; font-weight:600; flex:1; text-align:center;">è¯­éŸ³åè®®æ ¡å‡†</div>
        <div onclick="window.saveVoiceCalibrate()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer; width: 80px; text-align: right;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display: block; width: 100%; box-sizing: border-box;">
        
        <div class="tz-group-title">TIMBRE / éŸ³è‰²æŒ‡çº¹</div>
        <div class="ios-list-group">
            <div class="ios-list-item" style="height: auto; padding: 15px 16px;">
                <div style="display:flex; flex-direction:column; width:100%;">
                    <span style="font-size:12px; color:#8e8e93; font-weight:700; margin-bottom:8px; letter-spacing:1px;">VOICE ID</span>
                    <input type="text" id="calib-voice-id-in" class="ios-input" style="margin:0; background:#f2f2f7; border:none; text-align:left;" placeholder="ç²˜è´´å…‹éš†éŸ³è‰² ID">
                </div>
            </div>
        </div>

        <div class="tz-group-title">NATIVE LANGUAGE / æ¯è¯­è®¾å®š</div>
        <div class="ios-list-group">
            <div class="ios-list-item" onclick="window.openVoiceLangPicker()">
                <div class="item-content" style="border:none;">
                    <span class="item-label">è¯´è¯è¯­è¨€</span>
                    <div class="item-right">
                        <span class="item-value" id="calib-lang-display">è‡ªåŠ¨ (Auto)</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="tz-group-title">MULTILINGUAL / åŒè¯­ç­–ç•¥</div>
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content" style="border:none;">
                    <span class="item-label">æœ—è¯»åŒè¯­å¯¹ç…§å†…å®¹</span>
                    <div class="item-right">
                        <input type="checkbox" id="calib-dual-toggle" class="world-checkbox" style="width:24px; height:24px;">
                    </div>
                </div>
            </div>
        </div>

        <div class="ios-list-item">
            <div class="item-content">
                <span class="item-label">å¯ç”¨è¯­éŸ³åˆæˆ (Enable TTS)</span>
                <div class="item-right">
                    <label class="ios-switch">
                        <input type="checkbox" id="calib-tts-toggle" checked> 
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="ios-list-note">å…³é—­åç‚¹å‡»è¯­éŸ³æ¡ä»…å±•ç¤ºæ–‡å­—ï¼Œä¸ä¼šæ¶ˆè€—è¯­éŸ³é¢åº¦ã€‚</div>

        <div style="font-size:11px; color:#bbb; padding:15px 5px; line-height:1.6;">
            æç¤ºï¼šå½“å‰æ ¡å‡†é’ˆå¯¹ [ <span id="calib-target-name" style="color:#888; font-weight:800;">...</span> ] ç”Ÿæ•ˆã€‚
        </div>
    </div>
</div>
<div id="modal-voice-input" class="ios-alert-mask" style="align-items: flex-end; z-index: 20002;" onclick="if(event.target==this) this.style.display='none'">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span style="font-weight: 800; font-size: 17px;">å½•åˆ¶è¯­éŸ³ (æ¨¡æ‹Ÿ)</span>
            <div class="p2-done-btn" onclick="document.getElementById('modal-voice-input').style.display='none'">å–æ¶ˆ</div>
        </div>
        <div class="p2-editor-body">
            <textarea id="voice-text-in" class="p2-main-input" style="height:100px; resize:none; line-height:1.5;" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯­éŸ³å†…å®¹..."></textarea>
            
            <button class="ios-btn primary" style="background:#007AFF; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:8px;" onclick="window.sendSimulatedVoice()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                <span>å‘é€è¯­éŸ³</span>
            </button>
            
            <div style="font-size:11px; color:#8e8e93; text-align:center; margin-top:15px;">
                ç³»ç»Ÿå°†æ ¹æ®æ–‡æœ¬é•¿åº¦è‡ªåŠ¨ä¼°ç®—è¯­éŸ³æ—¶é•¿
            </div>
        </div>
    </div>
</div>
<div id="app-photos" class="ios-app-window" style="background: #F2F2F7; z-index: 6000; display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;">
    
    <div class="photos-header-large" style="
        padding: 30px 20px 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: transparent;
        flex-shrink: 0;
    ">
        <div class="photos-title-large" style="
            font-size: 34px;
            font-weight: 800;
            color: #000000;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: -0.5px;
            line-height: 1.1;
        ">
            Photos
        </div>

        <div class="header-actions" style="display: flex; align-items: center; gap: 12px;">
            
            <div class="header-btn-circle" onclick="window.openPhotoUploadModal()" style="
                width: 32px; height: 32px;
                background: rgba(120, 120, 128, 0.16);
                border-radius: 50%;
                display: flex; justify-content: center; align-items: center;
                cursor: pointer;
                transition: background 0.2s;
            " onmousedown="this.style.background='rgba(120, 120, 128, 0.3)'" onmouseup="this.style.background='rgba(120, 120, 128, 0.16)'" onmouseleave="this.style.background='rgba(120, 120, 128, 0.16)'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>

            <div class="header-btn-circle" onclick="closeApp('app-photos')" style="
                width: 32px; height: 32px;
                background: rgba(120, 120, 128, 0.16);
                border-radius: 50%;
                display: flex; justify-content: center; align-items: center;
                cursor: pointer;
                transition: background 0.2s;
            " onmousedown="this.style.background='rgba(120, 120, 128, 0.3)'" onmouseup="this.style.background='rgba(120, 120, 128, 0.16)'" onmouseleave="this.style.background='rgba(120, 120, 128, 0.16)'">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8E8E93" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>

        </div>
    </div>

    <div class="photos-content-area" style="padding: 10px 2px;">
        <div id="photos-grid-view" class="photos-grid">
            </div>
        
        <div id="photos-empty-state" class="empty-state" style="display:none; flex-direction:column; align-items:center; margin-top:100px; color:#C7C7CC;">
            <div style="opacity: 0.6;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
            </div>
            <p style="font-size:14px; margin-top:15px; font-weight:500; letter-spacing:0.5px;">æš‚æ— ç…§ç‰‡</p>
        </div>
    </div>

    <div class="photos-bottom-nav-container">
        <div class="photos-bottom-capsule">
            <div class="nav-item active" onclick="switchPhotoTab('mine')">æˆ‘çš„</div>
            <div style="width:1px; height:15px; background:#ddd; margin:0 10px;"></div>
            <div class="nav-item" onclick="switchPhotoTab('theirs')">Taçš„</div>
        </div>
    </div>
</div>

<div id="modal-photo-upload" class="ios-modal-mask" style="
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
    z-index: 20000; align-items: flex-end; justify-content: center;
">
    <div class="ios-modal-card" style="
        width: 100%; max-width: 500px; background: #fff;
        border-radius: 24px 24px 0 0; padding: 25px; padding-bottom: 40px;
        animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        max-height: 85vh; display: flex; flex-direction: column;
    ">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-shrink: 0;">
            <span onclick="document.getElementById('modal-photo-upload').style.display='none'" style="color: #8E8E93; font-size: 16px; font-weight: 600; cursor: pointer;">å–æ¶ˆ</span>
            <span class="modal-title" style="font-size: 17px; font-weight: 700;">æ–°ç…§ç‰‡</span>
            <span class="highlight-btn" onclick="submitPhotoUpload()" style="color: #007AFF; font-size: 16px; font-weight: 700; cursor: pointer;">å‘å¸ƒ</span>
        </div>

        <div style="overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch;">
            
            <div class="upload-preview-container" onclick="document.getElementById('photo-file-input').click()" style="
                width: 100%; aspect-ratio: 16/9; background: #F2F2F7;
                border-radius: 18px; display: flex; align-items: center; justify-content: center;
                overflow: hidden; margin-bottom: 25px; position: relative; cursor: pointer;
                border: 1px dashed rgba(0,0,0,0.1);
            ">
                <img id="upload-img-preview" src="" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                <div id="upload-placeholder" style="display: flex; flex-direction: column; align-items: center; color: #C7C7CC;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <span style="font-size: 13px; margin-top: 8px; font-weight: 500;">ç‚¹å‡»é€‰æ‹©ç…§ç‰‡</span>
                </div>
                <input type="file" id="photo-file-input" accept="image/*" style="display:none" onchange="handlePhotoFileSelect(this)">
            </div>

            <textarea id="upload-desc-input" placeholder="å†™ä¸‹æ­¤åˆ»çš„æ„Ÿå—... (AI å°†æ ¹æ®æ­¤å†…å®¹è¿›è¡Œé‰´èµ)" style="
                width: 100%; height: 80px; padding: 15px; background: #F9F9F9;
                border: none; border-radius: 16px; font-size: 15px; resize: none;
                font-family: inherit; margin-bottom: 25px; outline: none; box-sizing: border-box;
            "></textarea>
            
            <div style="margin-bottom: 10px;">
                <div style="font-size: 13px; font-weight: 600; color: #8E8E93; margin-bottom: 12px; letter-spacing: 0.5px; text-transform: uppercase;">
                    é‚€è¯·ç‚¹è¯„ (INVITE)
                </div>
                <div id="char-selector-container" class="char-selector-scroll">
                    </div>
            </div>

        </div>
    </div>
</div>

<div id="photo-detail-mask" class="photo-detail-mask" onclick="closePhotoDetailModal()">
    <div id="modal-photo-detail" class="ios-card-viewer" onclick="event.stopPropagation()">
        <div class="card-header-tools">
            <div class="tool-btn-back" onclick="closePhotoDetailModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"/></svg>
            </div>
            <div class="card-actions-group">
                <div class="tool-btn-circle" onclick="forwardCurrentPhoto()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></svg>
                </div>
                <div class="tool-btn-circle danger" onclick="showPhotoActions()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </div>
            </div>
        </div>

        <div class="card-main-scroller">
            <div class="card-hero-img">
                <img id="detail-main-img" src="">
            </div>
            
            <div class="card-content-body">
                <div class="user-info-row">
                    <span id="detail-user-name" class="user-name">æˆ‘</span>
                    <span class="post-time" id="detail-date-title">2026/1/26</span>
                </div>
                <p id="detail-desc-text" class="post-desc"></p>
                
                <div class="comment-section-title">äº’åŠ¨å›å“</div>
                <div id="detail-comments-list" class="comments-container">
                    </div>
            </div>
            <div style="height: 100px;"></div> </div>

        <div class="card-input-bar">
            <input type="text" id="detail-reply-input" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•...">
            <div class="send-btn-circle" onclick="sendPhotoComment()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
            </div>
        </div>
    </div>
</div>
<div id="photo-fullscreen-browser" onclick="closeFullscreenPhoto()">
    <div class="close-fullscreen">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
    <img id="fullscreen-img-target" class="fullscreen-img" src="">
</div>
<div id="page-char-gallery" class="ios-app-window gallery-viewer-window">
    <header class="wallet-header">
        <div class="wallet-top-bar">
            <div class="wallet-chip-line"></div>
            <div class="wallet-exit-btn" onclick="closeApp('page-walletApp')">EXIT âœ•</div>
        </div>
        
        <div class="wallet-user-info">
            <span class="wallet-id-label">PROTOCOL ID:</span>
            <span class="wallet-id-value">#LC-9920-X</span>
        </div>
        
        <div class="wallet-balance-section">
            <div class="balance-label">TOTAL ASSETS</div>
            <div class="balance-value">84,290.00 <small>LC</small></div>
        </div>
    </header>

    <div class="app-body" style="padding:0; display:block; overflow-y:auto;">
        <div class="gallery-header-profile">
            <div class="header-char-name" id="gallery-char-name-ui">Dunk</div>
            <div class="header-char-bio" id="gallery-char-bio-ui">æ­£åœ¨è¯»å–åº•å±‚æ¡£æ¡ˆ...</div>
        </div>

        <div class="gallery-console">
            <div class="console-btn-luxe" id="btn-ai-portrait" onclick="generateAIPortrait()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                <span>GENERATE SNAP</span>
            </div>
            <div class="console-btn-luxe" id="btn-footprint" onclick="generateRetroFootprints()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                <span>FOOTPRINTS</span>
            </div>
        </div>

        <div id="gallery-display-area" style="padding: 0 20px;">
            <div id="ai-portrait-container" style="display:none;">
                 <div class="ai-portrait-frame">
                    <div class="scanning-line" id="ai-scan-line"></div>
                    <img id="ai-portrait-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                    <div class="ai-prose-overlay" id="ai-prose-ui">
                        <div class="ai-prose-text">æ­£åœ¨æ•è·å½“å‰ç»´åº¦çš„è§†è§‰æ®‹å½±...</div>
                    </div>
                 </div>
            </div>
        </div>

        <div class="daily-status-container">
            <div class="tz-group-title">æ¯æ—¥é•œåƒ (DAILY REFLECTIONS)</div>
            
            <div id="status-flow-list" class="status-flow-list"></div>
        </div>

        <div class="tz-group-title">å†å²ç¬é—´ (ARCHIVES)</div>
        <div id="char-gallery-history" class="char-history-grid"></div>
    </div>
</div>
<div id="modal-theirs-photo-detail">
    <div id="theirs-detail-bg" class="theirs-detail-bg-blur"></div>
    
    <div class="card-header-tools" style="position:fixed; top:50px; left:0; right:0; padding:0 20px; display:flex; justify-content:space-between; align-items:center;">
        <div class="tool-btn-back" onclick="closeTheirsPhotoDetail()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="15 18 9 12 15 6"/></svg>
        </div>
        
        <div class="card-actions-group" style="display:flex; gap:12px;">
            <div class="tool-btn-circle" onclick="forwardTheirsSnap()" style="width:38px; height:38px; background:rgba(255,255,255,0.2); backdrop-filter:blur(15px); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; border:0.5px solid rgba(255,255,255,0.3); cursor:pointer;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></svg>
            </div>
            <div class="tool-btn-circle" onclick="deleteTheirsSnap()" style="width:38px; height:38px; background:rgba(255,255,255,0.2); backdrop-filter:blur(15px); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#FF3B30; border:0.5px solid rgba(255,255,255,0.3); cursor:pointer;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
        </div>
    </div>

    <div class="theirs-detail-scroller">
        <div class="theirs-portrait-card">
            <div class="theirs-prose-text" id="theirs-prose-body">æ­£åœ¨åŒæ­¥æ„Ÿå®˜æ–‡å­—...</div>
            <div style="font-size:10px; color:#8e8e93; letter-spacing:4px; margin-top:30px;">FRAGMENT_ARCHIVE</div>
        </div>

        <div class="theirs-interaction-pod">
            <div class="user-info-row">
                <span id="theirs-char-name" class="user-name" style="font-size:22px; color:#000;">Dunk</span>
                <span class="post-time" id="theirs-date-title">2026/1/26</span>
            </div>
            <div class="comment-section-title" style="margin-top:20px;">äº’åŠ¨å›å“</div>
            <div id="theirs-comments-list"></div>
        </div>
    </div>

    <div class="card-input-bar">
        <input type="text" id="theirs-reply-input" placeholder="å›åº” Ta çš„ç¬é—´...">
        <div class="send-btn-circle" onclick="sendCommentToTheirs()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
        </div>
    </div>
</div>
<div id="modal-footprints">
    <div class="footprints-header">
        <div class="brand-title">TEMPORAL ARCHIVE</div>
        <div class="footprints-header-btns">
            <div id="btn-save-footprints" class="save-archive-btn" onclick="saveCurrentFootprints()">SAVE ARCHIVE</div>
            <div class="close-archive-btn" onclick="document.getElementById('modal-footprints').style.display='none'">CLOSE</div>
        </div>
    </div>
    
    <div class="footprints-scroller" id="footprints-list"></div>
    <div class="footprints-footer">SYSTEM_Ready // 2026.01.26</div>
</div>
<div id="modal-footprint-single-detail" onclick="closeFootprintSingle()">
    <div class="polaroid-detail-frame" onclick="event.stopPropagation()">
        <div class="polaroid-inner-content" id="single-polaroid-text">
            â€œè¿™æ˜¯ä¸€æ®µè¢«åˆ»å½•çš„è®°å¿†...â€
        </div>
        <div class="polaroid-footer-time" id="single-polaroid-time">
            20:00
        </div>
    </div>
</div>
<div id="subpage-history-vault" class="ios-sub-page" style="background: #ffffff; z-index: 20000;">
    <div class="app-header" style="background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.05);">
        <div onclick="closeSubPage('subpage-history-vault')" style="color:#1d1d1f; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            BACK
        </div>
        <div style="font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 700; color:#1d1d1f; letter-spacing: 1px;">
            Memories
        </div>
        <div style="width:60px;"></div>
    </div>

    <div class="app-body" style="padding: 0; background: #fcfcfc;">
        <div style="padding: 40px 30px 20px 30px;">
            <div style="font-size:10px; color:#999; letter-spacing:3px; font-weight:800; margin-bottom:10px;">TIMELINE ARCHIVE</div>
            <h1 style="font-family: 'Noto Serif SC', serif; font-size: 32px; color:#1d1d1f; font-weight: 300;">æ—¶å…‰çš„æŠ˜ç—•</h1>
        </div>

        <div id="white-timeline-container" class="white-timeline">
            </div>
    </div>
</div>
<div id="subpage-archive-reader" class="ios-sub-page" style="background: #fdfdfd; z-index: 25000; display: none;">
    <div class="app-header" style="background: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(0,0,0,0.05);">
        <div onclick="closeArchiveReader()" style="color:#1d1d1f; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            LIST
        </div>
        <div style="font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 700; color:#000; letter-spacing: 2px; text-transform: uppercase;">
            Archive
        </div>
        <div style="width:60px;"></div>
    </div>

    <div class="archive-body-scroller">
        <div class="archive-magazine-header">
            <div class="archive-date-big" id="reader-day">26</div>
            <div class="archive-date-meta">
                <span id="reader-month">JANUARY</span>
                <span id="reader-year">2026</span>
            </div>
        </div>

        <div class="archive-ai-summary">
            <div class="summary-quote-icon">â€œ</div>
            <div id="reader-summary-text" class="summary-text-content">
                æ­£åœ¨å›æº¯å½“å¤©çš„è®°å¿†æµ...
            </div>
        </div>

        <div class="archive-divider-line"></div>

        <div id="reader-timeline-container" class="archive-timeline-box">
            </div>

        <div class="archive-footer-seal">
            <div class="seal-box">
                <span>SEALED BY</span>
                <span id="reader-seal-name" style="font-family:'Dancing Script',cursive; font-size:24px; margin:5px 0;">Luna</span>
                <span style="font-size:9px; letter-spacing:2px;">TEMPORAL ARCHIVE</span>
            </div>
        </div>
    </div>
</div>
<div id="daily-collection-overlay" class="daily-collection-overlay">
    <div class="collection-bg"></div>
    
    <div class="collection-nav">
        <div class="nav-back" onclick="closeDailyCollection()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </div>
        <div class="nav-title-group">
            <div class="nav-main-title">DIMENSION ARCHIVE</div>
            <div class="nav-sub-date" id="collection-date-title">JAN 27, 2026</div>
        </div>
        <div style="width:24px;"></div>
    </div>

    <div class="collection-scroll-body" id="daily-fragments-container">
        </div>
    
    <div class="collection-footer-tag">LUNE PHONE / ENCRYPTED LOG / NO.027</div>
</div>
<div id="page-musicApp" class="ios-app-window music-app-container" style="display: none;">
    <div class="music-app-header">
        <div class="header-side-btn" onclick="closeSubPage('page-musicApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.2"><path d="M15 18l-6-6 6-6"/></svg>
        </div>

        <div class="header-main-title" id="music-nav-title">ARCHIVE</div>

        <div class="header-side-btn" onclick="document.getElementById('core-bg-input').click()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
            </svg>
        </div>
        <input type="file" id="core-bg-input" accept="image/*" hidden onchange="changeCoreBackground(this)">
    </div>

    <div class="music-view-viewport">
        <div id="music-tab-archive" class="music-view-page active">
            <div class="archive-curated-header">
                <div class="header-main-info">
                    <h1 class="glitch-text" data-text="SONIC VAULT">SONIC VAULT</h1>
                    <div class="vault-stats">
                        <span id="stat-count">00 TRACKS</span> â€¢ 
                        <span id="stat-storage">LOCAL ENCRYPTED</span>
                    </div>
                </div>
                <div class="archive-search-bar">
                    <input type="text" id="music-search" placeholder="SEARCH ARCHIVE..." oninput="filterMusicArchive()">
                </div>
            </div>

            <div id="music-vault-list" class="music-vault-staggered-grid">
                </div>

            <div class="shutter-upload-btn" onclick="openMusicModal()">
                <div class="shutter-inner"></div>
                <span class="shutter-label">REGISTER</span>
            </div>
        </div>

        <div id="music-upload-modal" class="music-modal-overlay">
            <div class="modal-glass-card">
                <div class="modal-top">
                    <span id="modal-mode-title">DATA REGISTRATION</span>
                    <div class="modal-close-btn" onclick="closeMusicModal()">CLOSE</div>
                </div>
                
                <div class="upload-scroll-area">
                    <div class="cover-upload-zone" onclick="document.getElementById('input-music-cover').click()">
                        <img id="preview-cover" src="">
                        <div id="cover-tips">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.2"><path d="M12 5v14M5 12h14"/></svg>
                            <span>VISUAL DATA</span>
                        </div>
                        <input type="file" id="input-music-cover" accept="image/*" hidden onchange="previewMusicImage(this)">
                    </div>

                    <div class="input-group-vault">
                        <div class="input-item">
                            <label>TITLE</label>
                            <input type="text" id="music-title" placeholder="ENTER NAME">
                        </div>
                        <div class="input-item">
                            <label>ARTIST</label>
                            <input type="text" id="music-artist" placeholder="ENTITY NAME">
                        </div>
                        <div class="input-item file-item">
                            <label>SOURCE FILE</label>
                            <div class="custom-file-btn" onclick="document.getElementById('input-music-file').click()">
                                <span id="file-name-display">SELECT AUDIO</span>
                            </div>
                            <input type="file" id="input-music-file" accept="audio/*" hidden onchange="updateFileName(this)">
                        </div>
                    </div>
                    
                    <input type="hidden" id="editing-song-id">
                    
                    <button class="commit-btn" onclick="handleArchiveCommit()">COMMIT TO ARCHIVE</button>
                </div>
            </div>
        </div>

        <div id="music-tab-core" class="music-view-page">
            <div class="core-exit-btn" onclick="switchMusicTab('archive', document.querySelector('.nav-capsule-item:nth-child(1)'))">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m6 9 6 6 6-6"/></svg>
            </div>

            <div id="player-bg-visual" class="player-ambient-bg"></div>
            <div id="core-custom-bg-layer" class="core-persistent-bg"></div>

            <div class="core-main-container">
                <div class="core-visual-section">
                    <div class="ripple-wrapper">
                        <div class="ripple-ring r1"></div>
                        <div class="ripple-ring r2"></div>
                        <div class="circular-cover-box">
                            <img id="player-cover" src="" alt="Album Cover">
                        </div>
                    </div>
                    <div class="core-status-tag">
                        <div class="pulse-dot"></div>
                    </div>
                </div>

                <div class="core-lyrics-canvas" onclick="openLyricModal()">
                    <div id="lyrics-scroller" class="lyrics-scroller">
                        <p class="lyric-placeholder">NO DATA // CLICK TO ALIGN LYRICS</p>
                    </div>
                </div>

                <div class="core-meta-section">
                    <div class="meta-text">
                        <h2 id="player-title">SILENCE</h2>
                        <p id="player-artist">UNKNOWN ENTITY</p>
                    </div>
                </div>

                <div class="core-controls-section">
                    <div class="progress-container">
                        <span id="curr-time" class="time-stamp">00:00</span>
                        
                        <div class="progress-bar-wrap" onclick="seekAudio(event)">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        
                        <span id="total-time" class="time-stamp">00:00</span>
                    </div>
                    
                    <div class="main-buttons-console">
                    <div class="ctrl-icon-btn mode-btn" onclick="togglePlaybackMode()" id="play-mode-trigger">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M7 7h10v10H7z"/><path d="M7 12h10M7 15h10M7 18h10"/>
                        </svg>
                    </div>

                    <div class="ctrl-icon-btn" onclick="playPrevSong()">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 19 2 12 11 5 11 19"/><polygon points="22 19 13 12 22 5 22 19"/>
                        </svg>
                    </div>

                    <div class="ctrl-play-shutter" onclick="togglePlay()">
                        <div id="play-state-icon" class="shutter-icon-wrap">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                    </div>

                    <div class="ctrl-icon-btn" onclick="playNextSong()">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/>
                        </svg>
                    </div>

                    <div class="ctrl-icon-btn list-btn" onclick="togglePlaylistDrawer()">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/>
                        </svg>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div id="lyric-upload-modal" class="music-modal-overlay">
            <div class="modal-glass-card" style="max-width: 450px;">
                <div class="modal-top">
                    <span>LYRIC ARCHIVING</span>
                    <div class="modal-close-btn" onclick="closeLyricModal()">CLOSE</div>
                </div>

                <div class="upload-scroll-area">
                    <div class="input-group-vault">
                        <div class="input-item">
                            <label>PASTE LYRICS TEXT</label>
                            <textarea id="lyric-text-input" rows="8" placeholder="PASTE YOUR LYRICS HERE (SUPPORT [00:00.00] TIMESTAMPS)"></textarea>
                        </div>
                        
                        <div class="or-divider"><span>OR</span></div>

                        <div class="file-item">
                            <label>UPLOAD .LRC FILE</label>
                            <div class="custom-file-btn" onclick="document.getElementById('input-lrc-file').click()">
                                <span id="lrc-file-name">SELECT LRC FILE</span>
                            </div>
                            <input type="file" id="input-lrc-file" accept=".lrc,.txt" hidden onchange="handleLrcUpload(this)">
                        </div>
                    </div>

                    <button class="commit-btn" onclick="commitLyrics()">LINK TO TRACK</button>
                </div>
            </div>
        </div>

        <audio id="main-audio-engine" ontimeupdate="updateProgress()" onended="playNextSong()"></audio>

        <div id="music-tab-synergy" class="music-view-page synergy-fixed-layout">
            <div id="synergy-selection-zone" class="synergy-overlay-panel">
                <div class="synergy-hero-text">
                    <span class="label">CO-RESONANCE</span>
                    <h1>é‚€è¯·åŒé¢‘è€…</h1>
                    <p>é€‰æ‹©ä¸€ä¸ªçµé­‚ï¼Œå¼€å¯è¿™æ®µéŸ³é¢‘ç»´åº¦çš„çº ç¼ </p>
                </div>
                
                <div class="synergy-friend-dial" id="synergy-friend-dial">
                    </div>

                <div class="dial-instruction">TUNING KNOB // SELECT TARGET</div>
                <div id="npc-community-zone">
                    <div class="btn-signal-sync" onclick="syncCommunitySignals()">
                        <span>[ ğŸ›°ï¸ DEEP_SCAN: 50+ DIMENSION_SIGNALS ]</span>
                    </div>

                    <div class="npc-tabs">
                        <div class="npc-tab-item active" onclick="switchNpcTab('fragile', this)">FRAGILE // ç ´ç¢</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('midnight', this)">MIDNIGHT // æ·±å¤œ</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('wasteland', this)">WASTELAND // åºŸåœŸ</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('pluvial', this)">PLUVIAL // é›¨é™</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('critique', this)">CRITIQUE // ä¹è¯„</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('minimal', this)">MINIMAL // æç®€</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('analog', this)">ANALOG // æ¨¡æ‹Ÿ</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('dreamcore', this)">DREAMCORE // æ¢¦æ ¸</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('glitch', this)">GLITCH // æ•…éšœ</div>
                        <div class="npc-tab-item" onclick="switchNpcTab('ambient', this)">AMBIENT // æ°›å›´</div>
                    </div>

                    <div id="npc-feed-container"></div>
                </div>

                <div id="npc-post-detail-overlay">
                    <div class="detail-nav-bar">
                        <div onclick="closeNpcDetail()" class="detail-back-btn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                            <span>BACK_TO_FEED</span>
                        </div>
                    </div>
                    
                    <div class="detail-archive-header">
                        <div id="detail-npc-id" class="detail-id-tag">--</div>
                        <h2 id="detail-npc-name">--</h2>
                        <div style="font-size:10px; color:#007AFF; font-family:monospace; margin-top:5px;">
                            TIME: <b id="detail-time">--</b>
                        </div>
                    </div>

                    <article id="detail-content" class="detail-main-text"></article>

                    <div class="detail-stats-dashboard">
                        <div class="dashboard-item">
                            <span id="detail-views">0</span>
                            <label>VIEWS</label>
                        </div>
                        <div class="dashboard-item">
                            <span id="detail-likes">0</span>
                            <label>LIKES</label>
                        </div>
                        <div class="dashboard-item">
                            <span id="detail-com-count">0</span>
                            <label>COMMS</label>
                        </div>
                    </div>

                    <div style="text-align:center; margin-bottom:20px;">
                        <button onclick="boostPostStats()" class="btn-boost">[ AMPLIFY_RESONANCE ]</button>
                    </div>

                    <div class="detail-comment-section">
                        <div class="comment-header-strip">RESONANCE_LOGS // ä¿¡å·å…±é¸£</div>
                        <div id="npc-detail-comments-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-synergy-reject" class="vibe-center-mask" style="display:none; z-index:11000; background:rgba(255,255,255,0.9);">
            <div class="synergy-reject-card">
                <div class="reject-header">
                    <span class="error-code">ERROR_CODE: 403</span>
                    <span class="error-label">SIGNAL_DIVERGED</span>
                </div>
                <div class="reject-body">
                    <h1 class="reject-title">é‚€çº¦å·²å¤±æ•ˆ</h1>
                    <p id="reject-ai-msg" class="reject-text">â€œæˆ‘ç°åœ¨åªæƒ³ç‹¬è‡ªå¾…ä¼šå„¿ã€‚â€</p>
                </div>
                <button class="reject-close-btn" onclick="closeRejectModal()">è¿”å›ç»´åº¦åˆ—è¡¨</button>
            </div>
        </div>

        <div id="modal-synergy-success" class="vibe-center-mask" style="display:none; z-index:11000; background:rgba(255,255,255,0.98);">
            <div class="synergy-success-content">
                <div class="success-glow"></div>
                <div class="success-info">
                    <span class="label">CONNECTION ESTABLISHED</span>
                    <h1 id="success-target-name">Dunk</h1>
                    <p id="success-ai-msg">â€œæ—¢ç„¶æ˜¯ä½ é‚€è¯·ï¼Œé‚£å°±ä¸€èµ·å¬å¬çœ‹å§ã€‚â€</p>
                </div>
                <button class="enter-synergy-btn" onclick="enterSynergyChat()">è¿›å…¥å…±é¸£åœº</button>
            </div>
        </div>
    </div>

    <div class="music-navigation-bar">
        <div class="nav-capsule-item active" onclick="switchMusicTab('archive', this)">
            <span>ARCHIVE</span>
        </div>
        <div class="nav-capsule-item" onclick="switchMusicTab('core', this)">
            <span>CORE</span>
        </div>
        <div class="nav-capsule-item" onclick="switchMusicTab('synergy', this)">
            <span>SYNERGY</span>
        </div>
    </div>

    <div id="playlist-drawer" class="playlist-overlay" onclick="togglePlaylistDrawer()">
        <div class="playlist-content" onclick="event.stopPropagation()">
            <div class="playlist-header">
                <div class="header-line"></div>
                <div class="header-text-row">
                    <span>PLAYBACK QUEUE</span>
                    <span id="queue-count">00 TRACKS</span>
                </div>
            </div>

            <div id="playlist-items" class="playlist-items-scroll">
                </div>

            <div class="playlist-footer">
                <button class="close-drawer-btn" onclick="togglePlaylistDrawer()">CLOSE QUEUE</button>
            </div>
        </div>
    </div>
</div>
<div id="delete-confirm-modal" class="music-modal-overlay">
    <div class="modal-glass-card" style="max-width: 320px; text-align: center;">
        <div style="margin-bottom: 25px;">
            <div style="font-family: 'Cinzel', serif; font-size: 14px; font-weight: 900; letter-spacing: 3px; color: #000; margin-bottom: 15px;">
                PURGE DATA?
            </div>
            <div style="font-size: 11px; color: #888; line-height: 1.6; letter-spacing: 1px;">
                ARE YOU SURE YOU WANT TO ERASE THIS RECORD FROM THE VAULT? THIS ACTION IS IRREVERSIBLE.
            </div>
        </div>

        <input type="hidden" id="pending-delete-id">

        <div style="display: flex; gap: 15px;">
            <button class="commit-btn" style="margin-top: 0; background: #f0f0f0; color: #000; flex: 1; padding: 15px;" onclick="closeDeleteModal()">
                CANCEL
            </button>
            <button class="commit-btn" style="margin-top: 0; background: #000; color: #fff; flex: 1; padding: 15px;" onclick="executeDelete()">
                PURGE
            </button>
        </div>
    </div>
</div>
<div id="synergy-master-portal" class="synergy-master-fixed" style="display:none;">
    
    <div id="synergy-loading-screen" class="synergy-loading-overlay">
        <div class="radar-scanner">
            <div class="radar-beam"></div>
            <div class="radar-grid"></div>
        </div>
        <div class="loading-metadata">
            <div class="code-line">SYNCING_CORE_PROTOCOL...</div>
            <div class="progress-box">
                <div class="progress-label">DIMENSION_SYNC</div>
                <div class="percent-num"><span id="sync-percent">0</span>%</div>
            </div>
        </div>
    </div>

    <div id="synergy-radio-interface" class="radio-main-scaffold">
        <header class="radio-header-tuner">
            <div class="tuner-action" onclick="window.minimizeToDisc()">
                <div class="btn-min-icon"></div>
                <label>MINIMIZE</label>
            </div>
            <div class="tuner-display-center">
                <div class="sys-label">MASTER_VOYAGE_RADIO</div>
                <div class="freq-readout"><span id="live-freq">108.0</span><small>MHz</small></div>
                <div class="signal-visual">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
            </div>
            <div class="tuner-action" onclick="window.terminateSynergy()">
                <div class="btn-close-icon"></div>
                <label>ABORT</label>
            </div>
        </header>

        <main class="radio-body-panel" id="radio-scroll-container">
        
            <div class="oscilloscope-module">
                <div class="module-label">OSCILLOSCOPE / VISUALIZER</div>
                <div class="avatar-scope-wrap">
                    <img id="radio-avatar" src="" alt="">
                    <div class="wave-circle"></div>
                    <div class="wave-circle"></div>
                </div>
                <div class="partner-meta">
                    <h2 id="radio-name">IDENTIFYING...</h2>
                    <div class="id-hash">HASH_UUID: <span id="partner-uuid">--</span></div>
                </div>
            </div>

            <div class="dial-instruction">TUNING KNOB // SELECT TARGET</div>
            
            <div id="radio-terminal-log" class="terminal-scroller"></div>
        </main>

        <footer class="radio-bottom-dock">
            <div class="metadata-strip">
                <div class="marquee-wrap">
                    <span id="radio-memory-strip">>>> æ­£åœ¨åŒæ­¥è·¨æ¬¡å…ƒç¤¾åŒºæ³¢æ®µ...</span>
                </div>
            </div>
            <div class="console-input-bay">
                <div class="input-prefix">CMD_</div>
                <input type="text" id="radio-cmd-input" placeholder="é”®å…¥é€šè®¯æŒ‡ä»¤...">
                <div class="action-group">
                    <button class="reply-btn" onclick="window.requestAIReply()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></button>
                    <button class="transmit-btn" onclick="window.transmitCommand()">SEND</button>
                </div>
            </div>
            <div class="industrial-footer-labels">
                <span onclick="window.openChatSearchPage()" style="cursor:pointer; color:#007AFF;">[ ACCESS_HISTORY ]</span>
                <span>STABILITY: 98.4%</span>
            </div>
        </footer>
    </div>
</div>

<div id="synergy-floating-disc" class="floating-vinyl-ball" onclick="window.restoreFromDisc()">
    <div class="vinyl-record spinning">
        <img id="disc-avatar" src="" alt="">
    </div>
    <div class="status-dot-active"></div>
</div>

<div id="modal-resonance-invite" class="vibe-center-mask" style="display:none; z-index:100001;">
    <div class="ios-alert-box resonance-invite-card">
        <div class="invite-card-header">
            <div class="brand-line"></div>
            <span>SYNERGY REQUEST</span>
        </div>
        <div class="invite-card-body">
            <img id="invite-target-avatar" src="" alt="">
            <h2 id="invite-target-name">Character</h2>
            <p>å‘èµ·è”è§‰é‚€çº¦åï¼Œå¯¹æ–¹å°†æ„ŸçŸ¥ä½ æ­¤åˆ»çš„æ—‹å¾‹å¹¶å°è¯•å»ºç«‹ç»´åº¦è¿æ¥ã€‚</p>
        </div>
        <div class="invite-card-footer">
            <div class="invite-btn cancel" onclick="closeResonanceModal()">æš‚ç¼“</div>
            <div class="invite-btn confirm" onclick="executeInviteProtocol()">å‘èµ·é‚€çº¦</div>
        </div>
    </div>
</div>
<div id="synergy-invite-loading" class="vibe-center-mask" style="display:none; z-index:2000000; background:rgba(255,255,255,0.9);">
    <div class="synergy-loading-content" style="text-align:center;">
        <div class="radar-scanner" style="margin:0 auto;">
            <div class="radar-beam"></div>
            <div class="radar-grid"></div>
        </div>
        <div class="loading-metadata" style="margin-top:30px;">
            <div class="code-line">ALIGNING_PHASE_SIGNALS...</div>
            <div class="percent-num" style="font-size:14px; color:#007AFF; letter-spacing:2px;">MATCHING FREQUENCY</div>
        </div>
    </div>
</div>
<div id="npc-reply-sheet-mask" class="ios-alert-mask" onclick="closeReplySheet()" style="align-items: flex-end; display: none; z-index: 400001;">
    <div class="npc-reply-sheet" onclick="event.stopPropagation()">
        <div class="sheet-handle"></div>
        
        <div class="sheet-header">
            <span class="sheet-title">å›å¤è¯¦æƒ…</span>
            <div class="sheet-close" onclick="closeReplySheet()">å®Œæˆ</div>
        </div>

        <div id="reply-sheet-content" class="sheet-body">
            </div>
    </div>
</div>
<div id="phoneApp" class="ios-app-window" style="background: #ffffff; z-index: 6000;">
    <div class="app-header" style="background: transparent; z-index: 20;">
        <div style="width: 40px;"></div> <div class="header-title-big" id="phone-header-title" style="font-size: 17px; text-align: center; flex: 1;">Keypad</div>

        <div id="recents-clear-btn" onclick="showClearRecentsModal()" style="display:none; cursor: pointer; color: #000; opacity: 0.8; margin-right: 10px;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </div>
        
        <div id="phone-close-btn" class="header-close-btn" onclick="closeApp('phoneApp')" 
             style="opacity: 0; pointer-events: none; transition: opacity 0.3s ease;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </div>
    </div>

    <div class="app-body" style="padding: 0;">
        
        <div id="phone-view-recents" class="phone-view-container">

            <div class="segment-control" style="margin: 10px 16px 15px 16px;">
                <div id="seg-all" class="segment-btn active" onclick="filterRecents('all')">All</div>
                <div id="seg-missed" class="segment-btn" onclick="filterRecents('missed')">Missed</div>
            </div>


            <div id="recents-list-container" class="recents-list">
                </div>
        </div>

        <div id="phone-view-keypad" class="phone-view-container active">
    
            <div class="quick-dial-section">
                <div class="quick-label">RECENT HISTORY / æœ€è¿‘è®°å½•</div>
                <div id="quick-dial-list" class="quick-scroll-wrapper">
                    </div>
            </div>

            <div class="keypad-display-area">
                <div id="keypad-match-name" class="keypad-match-name"></div>
                
                <div id="keypad-number-display"></div>
                
                <div id="keypad-del-btn" class="mini-del-btn" onclick="delKey()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                </div>
            </div>

            <div class="keypad-grid">
                <div class="keypad-btn" onclick="tapKey('1')"><div class="key-num">1</div><div class="key-alpha"> </div></div>
                <div class="keypad-btn" onclick="tapKey('2')"><div class="key-num">2</div><div class="key-alpha">ABC</div></div>
                <div class="keypad-btn" onclick="tapKey('3')"><div class="key-num">3</div><div class="key-alpha">DEF</div></div>
                <div class="keypad-btn" onclick="tapKey('4')"><div class="key-num">4</div><div class="key-alpha">GHI</div></div>
                <div class="keypad-btn" onclick="tapKey('5')"><div class="key-num">5</div><div class="key-alpha">JKL</div></div>
                <div class="keypad-btn" onclick="tapKey('6')"><div class="key-num">6</div><div class="key-alpha">MNO</div></div>
                <div class="keypad-btn" onclick="tapKey('7')"><div class="key-num">7</div><div class="key-alpha">PQRS</div></div>
                <div class="keypad-btn" onclick="tapKey('8')"><div class="key-num">8</div><div class="key-alpha">TUV</div></div>
                <div class="keypad-btn" onclick="tapKey('9')"><div class="key-num">9</div><div class="key-alpha">WXYZ</div></div>
                <div class="keypad-btn" onclick="tapKey('*')"><div class="key-num" style="font-size:36px; padding-top:10px;">*</div></div>
                <div class="keypad-btn" onclick="tapKey('0')"><div class="key-num">0</div><div class="key-alpha">+</div></div>
                <div class="keypad-btn" onclick="tapKey('#')"><div class="key-num" style="font-size:30px; padding-top:5px;">#</div></div>
                
                <div></div>
                <div class="keypad-call-btn" onclick="makeCall()">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.59a.996.996 0 00-1.01.24l-2.2 2.2a15.05 15.05 0 01-6.59-6.59l2.2-2.21a.96.96 0 00.25-1A11.36 11.36 0 018.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/></svg>
                </div>
                <div></div>
            </div>
        </div>

        <div id="phone-view-contacts" class="phone-view-container">
    
            <div style="padding: 15px 16px 10px 16px; display: flex; align-items: center; gap: 10px; background: #fff; z-index: 10;">
                
                <div class="ios-search-wrapper" style="margin: 0; flex: 1; background: #E5E5EA;">
                    <svg class="search-icon" viewBox="0 0 24 24" style="width: 16px; height: 16px; opacity: 0.5;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="ios-search-input" placeholder="Search" style="font-size: 15px;">
                </div>
                
                <div onclick="addContact()" style="cursor: pointer; color: #007AFF;">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </div>

            </div> 
            <div id="contacts-list-container" class="recents-list" style="padding-bottom: 80px;">
                </div>

            <div id="ins-modal-history" class="ins-modal-overlay" style="z-index: 1000000;" onclick="closeInsModal('ins-modal-history')">
                <div class="ins-modal-sheet" onclick="event.stopPropagation()">
                    <div class="ins-sheet-handle"></div>
                    <div class="ins-sheet-header">
                        <div class="ins-title-stack">
                            <span class="ins-sub-label">TEMPORAL_RECORDS</span>
                            <h2 class="ins-sheet-title">Call History</h2>
                        </div>
                        <div class="ins-close-text" onclick="closeInsModal('ins-modal-history')">Done</div>
                    </div>
                    
                    <div id="ins-history-list" class="ins-history-scroller">
                        </div>
                </div>
            </div>

            <div id="ins-modal-detail" class="ins-modal-overlay second-layer" style="z-index: 2000000;" onclick="closeInsModal('ins-modal-detail')">
                <div class="ins-modal-sheet detail-sheet" onclick="event.stopPropagation()">
                    <div class="ins-sheet-handle"></div>
                    <div class="ins-sheet-header">
                        <div class="ins-back-btn" onclick="closeInsModal('ins-modal-detail')">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            <span>BACK</span>
                        </div>
                        <div class="ins-detail-title-small">CALL_TRANSCRIPT</div>
                    </div>

                    <div id="ins-chat-flow" class="ins-chat-flow-container">
                        </div>

                    <div id="ins-detail-meta" class="ins-detail-footer-meta"></div>
                </div>
            </div>

        </div>
    </div>

    <div class="phone-glass-nav" style="gap: 50px; padding: 15px 40px; width: auto;">
    
        <div class="p-nav-item" id="p-nav-recents" onclick="switchPhoneTab('recents')">
            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            <span>Recents</span>
        </div>

        <div class="p-nav-item active" id="p-nav-keypad" onclick="switchPhoneTab('keypad')">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <circle cx="6" cy="6" r="2.5"/><circle cx="12" cy="6" r="2.5"/><circle cx="18" cy="6" r="2.5"/>
                <circle cx="6" cy="12" r="2.5"/><circle cx="12" cy="12" r="2.5"/><circle cx="18" cy="12" r="2.5"/>
                <circle cx="6" cy="18" r="2.5"/><circle cx="12" cy="18" r="2.5"/><circle cx="18" cy="18" r="2.5"/>
            </svg>
            <span>Keypad</span>
        </div>

        <div class="p-nav-item" id="p-nav-contacts" onclick="switchPhoneTab('contacts')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>Contacts</span>
        </div>
    </div>
</div>
<div id="modal-phone-add-contact" class="ios-alert-mask" style="align-items: flex-end; z-index: 6500; display: none;" onclick="if(event.target==this) closePhoneAddModal()">
    <div class="phone-add-sheet">
        
        <div class="sheet-handle-bar"></div>

        <div class="phone-add-header">
            <span class="header-cancel" onclick="closePhoneAddModal()">Cancel</span>
            <span class="header-title">New Contact</span>
            <span class="header-save" onclick="submitPhoneContact()">Done</span>
        </div>

        <div class="app-body" style="overflow-y: auto; padding: 0 5px 40px 5px;">
            
            <div class="segment-control" style="margin-bottom: 20px;">
                <div class="segment-btn active" id="p-seg-create" onclick="switchPhoneAddTab('create')">New Persona</div>
                <div class="segment-btn" id="p-seg-import" onclick="switchPhoneAddTab('import')">Import Role</div>
            </div>

            <div id="panel-phone-create">
                <div class="phone-avatar-uploader" onclick="document.getElementById('phone-avatar-in').click()">
                    <img id="phone-avatar-pre" src="" style="display:none;">
                    <div id="phone-avatar-placeholder">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    </div>
                </div>
                <input type="file" id="phone-avatar-in" hidden accept="image/*" onchange="previewPhoneAvatar(this)">

                <div class="noir-form-group">
                    <div class="noir-input-row">
                        <label>NAME</label>
                        <input type="text" id="phone-name-in" placeholder="Enter Name">
                    </div>
                    <div class="noir-input-row" style="border:none;">
                        <label>BIO</label>
                        <input type="text" id="phone-desc-in" placeholder="Description...">
                    </div>
                </div>
            </div>

            <div id="panel-phone-import" style="display:none;">
                <div style="font-size:10px; font-weight:700; color:#8E8E93; margin-bottom:10px; letter-spacing:1px;">SELECT FROM ROLEBOOK</div>
                <div id="phone-import-grid" class="import-grid-wrapper">
                    </div>
                <div id="import-selection-hint" style="text-align:center; color:#007AFF; font-size:12px; font-weight:600; margin:10px 0; display:none;">
                    Selected: <span id="import-selected-name">--</span>
                </div>
            </div>

            <div class="tz-group-title" style="margin-top:20px; color:#000;">CONNECTION DETAILS</div>
            
            <div class="noir-form-group">
                <div class="noir-input-row" style="border:none;">
                    <label>PHONE</label>
                    <input type="tel" id="common-phone-in" placeholder="138-0000-0000 (Required)">
                </div>
            </div>

            <div class="tz-group-title" style="color:#000;">LINK WORLD (OPTIONAL)</div>
            <div id="phone-world-list" class="ios-list-group" style="background:#F9F9F9; border-radius:12px; overflow:hidden;">
                </div>
            <div style="font-size:10px; color:#ccc; padding:10px; line-height:1.4;">
                å‹¾é€‰åï¼Œè¯¥è§’è‰²çš„è®°å¿†å°†è‡ªåŠ¨å…³è”é€‰ä¸­çš„ä¸–ç•Œè§‚è®¾å®šã€‚
            </div>

        </div>
    </div>
</div>
<div id="modal-delete-confirm" class="ios-modal-overlay" style="display: none;">
    <div class="modal-backdrop" onclick="closeDeleteModal()"></div>
    
    <div class="delete-action-sheet">
        <div class="delete-title-box">
            <div class="delete-main-title">Delete Contact?</div>
            <div class="delete-sub-desc">Are you sure you want to delete this contact? This action cannot be undone.</div>
        </div>

        <div class="delete-btn-group">
            <button class="ios-action-btn danger" onclick="confirmRealDelete()">Delete Contact</button>
        </div>

        <div class="delete-btn-group">
            <button class="ios-action-btn cancel" onclick="closeDeleteModal()">Cancel</button>
        </div>
    </div>
</div>
<div id="modal-contact-settings" class="ios-modal-overlay" style="display: none;">
    <div class="modal-backdrop" onclick="closeContactSettings()"></div>
    
    <div class="settings-sheet-panel">
    
        <div id="settings-view-main" class="settings-view active">
            <div class="settings-header">
                <div class="sheet-handle"></div>
                <div class="settings-title">Chat Settings</div>
                <div class="settings-close" onclick="closeContactSettings()">Done</div>
            </div>

            <div class="settings-content">
                <div class="settings-section-title">LANGUAGE</div>
                <div class="ios-group-card">
                    <div class="ios-cell">
                        <div class="cell-label">Bilingual Mode</div>
                        <label class="ios-switch">
                            <input type="checkbox" id="set-bilingual-toggle" onchange="toggleSettingGroup('bilingual')">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    
                    <div id="group-bilingual-options" class="hidden-options">
                        <div class="ios-divider"></div>
                        
                        <div class="ios-cell ios-nav-link" onclick="openLangPage('user')">
                            <div class="cell-label">Your Language</div>
                            <div class="cell-value-row">
                                <span id="disp-user-lang">Chinese</span>
                                <svg class="chevron-right" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </div>
                        </div>

                        <div class="ios-divider"></div>

                        <div class="ios-cell ios-nav-link" onclick="openLangPage('char')">
                            <div class="cell-label">Char Language</div>
                            <div class="cell-value-row">
                                <span id="disp-char-lang">English</span>
                                <svg class="chevron-right" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section-title">APPEARANCE</div>
                <div class="ios-group-card">
                    <div class="ios-cell" style="flex-direction: column; align-items: flex-start; padding: 15px;">
                        <div class="cell-top-row" style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
                            <div class="cell-label">Chat Background</div>
                            <label for="bg-upload-input" class="text-btn">Change</label>
                            <input type="file" id="bg-upload-input" style="display: none;" accept="image/*" onchange="previewChatBg(this)">
                        </div>
                        <div class="bg-preview-container">
                            <img id="set-bg-preview" src="" style="display:none;">
                            <div id="set-bg-placeholder">Default</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section-title">AUDIO & VOICE</div>
                <div class="ios-group-card">
                    <div class="ios-cell">
                        <div class="cell-label">Minimax TTS</div>
                        <label class="ios-switch">
                            <input type="checkbox" id="set-minimax-toggle" onchange="toggleSettingGroup('minimax')">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div id="group-minimax-options" class="hidden-options">
                        <div class="ios-divider"></div>
                        <div class="ios-cell">
                            <div class="cell-label" style="width: 80px;">Voice ID</div>
                            <input type="text" id="set-voice-id" class="ios-input-right" placeholder="Voice ID...">
                        </div>
                        <div class="setting-tip">API Key linked globally.</div>
                    </div>
                </div>
                
                <div style="height: 50px;"></div>
            </div>
        </div>

        <div id="settings-view-sub" class="settings-view next">
            <div class="settings-header">
                <div class="settings-back-btn" onclick="backToMainSettings()">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    Back
                </div>
                <div class="settings-title" id="sub-page-title">Select Language</div>
                <div style="width: 60px;"></div> </div>
            <div class="settings-content">
                <div class="settings-section-title">OPTIONS</div>
                <div id="lang-options-list" class="ios-group-card">
                    </div>
            </div>
        </div>

    </div>
</div>
<div id="call-overlay-screen" class="call-screen" style="display: none;">
    
    <div id="call-bg-layer" class="call-bg-layer"></div>
    <div class="call-bg-mask"></div> <div class="call-visual-center">
        <div class="breath-ring ring-1"></div>
        <div class="breath-ring ring-2"></div>
        <div class="breath-ring ring-3"></div>
        
        <div class="call-avatar-container">
            <img id="call-current-avatar" src="" alt="Avatar">
        </div>
    </div>

    <div class="call-info-area">
        <div id="call-current-name" class="call-name">Unknown</div>
        <div class="call-status">Calling mobile...</div>
    </div>

    <div class="call-action-area">
        <div class="end-call-btn" onclick="endCallAction()">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.36 7.46 6.5 12 6.5s8.66 1.86 11.71 5.17c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"></path>
            </svg>
        </div>
    </div>
</div>
<div id="call-connected-screen" class="call-screen" style="display: none;">
    
    <div id="connected-bg-layer" class="cinema-bg-layer"></div>
    <div class="cinema-vignette-mask"></div>

    <div class="dynamic-status-pill">
        <div class="status-dot"></div>
        <span id="connected-name" class="status-name">Dunk</span>
        <span class="status-divider">|</span>
        <span id="call-timer" class="status-timer">00:00</span>
    </div>

    <div class="audio-visualizer-container">
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
    </div>

    <div id="call-caption-area" class="cinema-caption-area">
        <div class="caption-empty-state">AI is listening...</div>
        </div>

    <div class="call-dock-wrapper" style="position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; z-index: 99999; pointer-events: none;">
    
        <div class="call-control-dock" style="
            background: rgba(20, 20, 20, 0.75) !important; 
            backdrop-filter: blur(25px) !important;
            -webkit-backdrop-filter: blur(25px) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 40px !important;
            padding: 15px 35px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 40px !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5) !important;
            pointer-events: auto !important;
        ">
            
            <div class="dock-btn secondary" onclick="toggleCallInput()" style="
                width: 50px; height: 50px; border-radius: 50%;
                background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                    <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M7 16h10"></path>
                </svg>
            </div>

            <div class="dock-btn danger-pulse" onclick="endCallAction()" style="
                width: 68px; height: 68px; border-radius: 50%;
                background: #FF3B30; display: flex; align-items: center; justify-content: center; cursor: pointer;
                box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                    <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.36 7.46 6.5 12 6.5s8.66 1.86 11.71 5.17c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"></path>
                </svg>
            </div>

            <div class="dock-btn secondary" onclick="goToMessageApp()" style="
                width: 50px; height: 50px; border-radius: 50%;
                background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
            </div>

        </div>
    </div>

    <div id="call-input-drawer" class="call-input-drawer">
        <input type="text" id="call-text-input" 
            style="flex:1; height:44px; border-radius:22px; border:none; padding:0 15px; font-size:16px; background:#2c2c2e; color:white; outline:none;" 
            placeholder="Type to speak...">
        
        <div onclick="sendTextToAI()" 
            style="width:44px; height:44px; background:#007AFF; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; cursor:pointer;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </div>
    </div>
</div>


<div id="modal-clear-confirm" class="ins-confirm-overlay">
    <div class="ins-confirm-card">
        <div class="ins-confirm-content">
            <h3 class="ins-confirm-title">Clear All Recents?</h3>
            <p class="ins-confirm-desc">This action will permanently delete your entire call history. It cannot be undone.</p>
        </div>
        <div class="ins-confirm-footer">
            <button class="ins-conf-btn cancel" onclick="closeClearRecentsModal()">Cancel</button>
            <button class="ins-conf-btn danger" onclick="executeClearAllRecents()">Clear All</button>
        </div>
    </div>
</div>
<div id="modal-session-delete-confirm" class="ins-confirm-overlay">
    <div class="ins-confirm-card">
        <div class="ins-confirm-content">
            <h3 class="ins-confirm-title">Delete Session?</h3>
            <p class="ins-confirm-desc">This call trace and all its transcripts will be erased from all logs.</p>
        </div>
        <div class="ins-confirm-footer">
            <button class="ins-conf-btn cancel" onclick="closeSessionDeleteModal()">Cancel</button>
            <button class="ins-conf-btn danger" onclick="confirmDeleteSession()">Delete</button>
        </div>
    </div>
</div>
<div id="page-messageApp" class="lmsg-wrapper">
    <div class="lmsg-status-bar"></div>

    <header class="lmsg-header">
        <div class="lmsg-upper-bar">
            <button class="lmsg-btn-text" onclick="closeApp('page-messageApp')">Back</button>
            <div class="lmsg-title-container">
                <h1 class="lmsg-title">Messages</h1>
                <span class="lmsg-main-badge" id="lmsg-total-count">(14)</span>
            </div>
            <button class="lmsg-compose-btn" onclick="lmsgNewMessage()" title="New Message">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
        </div>

        <div class="lmsg-search-area">
            <div class="lmsg-search-inner">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <input type="text" placeholder="Search" class="lmsg-search-input">
            </div>
        </div>

        <nav class="lmsg-nav" id="lmsg-nav-scroll">
            <div class="lmsg-nav-item active" onclick="lmsgSwitchTab('all', this)">All</div>
            
            <div class="lmsg-nav-item" onclick="lmsgSwitchTab('unread', this)">
                Unread <span class="lmsg-nav-dot"></span>
            </div>
            
            <div class="lmsg-nav-item" onclick="lmsgSwitchTab('direct', this)">Direct</div>
            
            <div class="lmsg-nav-item" onclick="lmsgSwitchTab('groups', this)">Groups</div>
            
            <div class="lmsg-nav-item" onclick="lmsgSwitchTab('strangers', this)">Strangers</div>
            
            <div class="lmsg-nav-item" onclick="lmsgSwitchTab('system', this)">System</div>
        </nav>
    </header>

    <div class="lmsg-body" id="lmsg-realtime-list">
        </div>

    <div class="lmsg-bottom-safe-area"></div>
</div>

<div id="lmsg-compose-window" class="lmsg-compose-overlay">
    <div class="lmsg-compose-header">
        <button class="lmsg-comp-cancel" onclick="lmsgCloseCompose()">Cancel</button>
        <h2 class="lmsg-comp-title">New Message</h2>
        <button class="lmsg-comp-send" id="lmsg-send-btn" onclick="lmsgFinalCommit()" disabled>Send</button>
    </div>

    <div class="lmsg-recipient-bar">
        <span class="lmsg-to-label">To:</span>
        <div class="lmsg-input-wrapper">
            <input type="text" id="lmsg-to-input" autocomplete="off" placeholder="Name or number" oninput="lmsgSearchRecipient(this.value)">
            <button class="lmsg-add-contact-btn" onclick="openApp('phoneApp')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            </button>
        </div>
    </div>

    <div id="lmsg-recipient-results" class="lmsg-results-area"></div>

    <div id="lmsg-preview-flow" class="lmsg-preview-area">
        <div class="lmsg-preview-hint">Drafting area...</div>
    </div>

    <div class="lmsg-compose-footer">
        <div class="lmsg-input-pill">
            <button class="lmsg-attach-btn">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            </button>
            
            <input type="text" id="lmsg-message-input" placeholder="Lune Message" oninput="lmsgCheckCanSend()">
            
            <button id="lmsg-actual-send-btn" class="lmsg-send-trigger" onclick="lmsgAddToPreview()" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>
<div id="lmsg-chat-window" class="lmsg-chat-overlay">
    <header class="lmsg-chat-header">
        <button class="lmsg-chat-back" onclick="closeChatWindow()"></button>
        
        <div class="lmsg-chat-target" onclick="openEntityProfile()">
            <img id="chat-target-avatar" src="" alt="">
            <div class="lmsg-chat-target-info">
                <div class="lmsg-name-phone-row">
                    <span id="chat-target-name">Entity</span>
                    <span id="chat-target-phone" class="lmsg-phone-tag">000-0000</span>
                </div>
                <small class="lmsg-status-text">Signal Synchronized</small>
            </div>
        </div>

        <button class="lmsg-header-call-btn" onclick="startCallFromChat()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l2.29-2.29a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
        </button>
    </header>

    <main id="lmsg-chat-flow" class="lmsg-chat-body">
        <div class="lmsg-date-divider">TRANSMISSION START</div>
    </main>

    <footer class="lmsg-chat-footer">
        <div class="lmsg-input-pill">
            <button class="lmsg-attach-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
            </button>
            
            <input type="text" id="lmsg-chat-input" placeholder="Draft a message..." oninput="checkDraftStatus()">

            <button id="lmsg-ai-magic-btn" class="lmsg-ai-btn" onclick="triggerAiReply()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
            </button>

            <button id="lmsg-detail-send-trigger" class="lmsg-send-trigger" onclick="lmsgDetailSendMessage()" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </footer>
</div>
<div id="lmsg-entity-profile-modal" class="lmsg-profile-modal">
    <div class="lmsg-profile-overlay" onclick="closeEntityProfile()"></div>
    <div class="lmsg-profile-content">
        <header class="lmsg-profile-header">
            <div style="display:flex; gap:12px; align-items:center;">
                <button id="lmsg-save-config-btn" onclick="saveIndividualSettings()" 
                    style="background:#007AFF; color:#fff; border:none; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:700; cursor:pointer; transition: opacity 0.2s;">
                    SAVE
                </button>
                <button class="lmsg-profile-close" onclick="closeEntityProfile()">CLOSE</button>
            </div>
            <span style="letter-spacing: 1px;">ENTITY CONFIG</span>
        </header>

        <div class="lmsg-profile-scroll-area">
            <section class="lmsg-profile-section">
                <div class="lmsg-section-title">VISUAL PREVIEW</div>
                <div class="lmsg-preview-container">
                    <div id="lmsg-bg-preview-box" class="lmsg-bg-preview">
                        <div class="lmsg-preview-placeholder">NO BACKGROUND</div>
                    </div>
                </div>
            </section>

            <section class="lmsg-profile-section">
                <div class="lmsg-section-title">BACKGROUND AMBIENCE</div>
                <div class="lmsg-upload-group">
                    <label class="lmsg-upload-btn">
                        <span>UPLOAD IMAGE</span>
                        <input type="file" accept="image/*" onchange="handleBgUpload(this, 'image')" hidden>
                    </label>
                    <label class="lmsg-upload-btn">
                        <span>UPLOAD VIDEO</span>
                        <input type="file" accept="video/*" onchange="handleBgUpload(this, 'video')" hidden>
                    </label>
                    <button class="lmsg-reset-btn" onclick="resetChatBg()">RESET DEFAULT</button>
                </div>
            </section>

            <section class="lmsg-profile-section">
                <div class="lmsg-section-title">è¯­è¨€æ¨¡å¼ (AI PRESETS)</div>
                <div class="lmsg-lang-selector-grid">
                    <div class="lmsg-lang-option active" onclick="setAiLang('CN', this)">
                        <span class="lang-code">CN</span>
                        <span class="lang-label">æ™®é€šè¯</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('HK', this)">
                        <span class="lang-code">HK</span>
                        <span class="lang-label">ç²¤è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('EN', this)">
                        <span class="lang-code">EN</span>
                        <span class="lang-label">è‹±è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('JP', this)">
                        <span class="lang-code">JP</span>
                        <span class="lang-label">æ—¥è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('KR', this)">
                        <span class="lang-code">KR</span>
                        <span class="lang-label">éŸ©è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('TH', this)">
                        <span class="lang-code">TH</span>
                        <span class="lang-label">æ³°è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('FR', this)">
                        <span class="lang-code">FR</span>
                        <span class="lang-label">æ³•è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('RU', this)">
                        <span class="lang-code">RU</span>
                        <span class="lang-label">ä¿„è¯­</span>
                    </div>
                    
                    <div class="lmsg-lang-option" onclick="setAiLang('DE', this)">
                        <span class="lang-code">DE</span>
                        <span class="lang-label">å¾·è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('ES', this)">
                        <span class="lang-code">ES</span>
                        <span class="lang-label">è¥¿è¯­</span>
                    </div>

                    <div class="lmsg-lang-option" onclick="setAiLang('IT', this)">
                        <span class="lang-code">IT</span>
                        <span class="lang-label">æ„è¯­</span>
                    </div>

                    <div class="lmsg-lang-option mode-auto" onclick="setAiLang('MIX', this)">
                        <span class="lang-code">MIX</span>
                        <span class="lang-label">åŒè¯­æ··åˆ</span>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
<div id="page-profilesApp">
    <header class="prof-header">
        <div class="prof-app-title" id="prof-tab-title">ENTITIES</div>
        <button class="prof-edit-btn" onclick="closeApp('page-profilesApp')">Exit &ensp; âœ•</button>
    </header>

    <div class="prof-avatar-slider" id="prof-avatar-ring">
        </div>

    <main class="prof-viewer" id="prof-main-viewer">
        </main>

    <nav class="prof-bottom-nav">
        <button class="prof-nav-btn active" onclick="profSwitchTab('ENTITIES', this)">
            <span class="prof-nav-label">ENTITIES</span>
        </button>
        <button class="prof-nav-btn" onclick="profSwitchTab('SYSTEM', this)">
            <span class="prof-nav-label">SYSTEM</span>
        </button>
    </nav>
    <button class="prof-fab-btn" onclick="profCreateNewEntity()" title="Add New"></button>

</div>
<div id="prof-create-page">
    <header class="prof-create-header">
        <button class="prof-create-back" onclick="profToggleCreatePage(false)">âœ•</button>
        <div class="prof-create-title">Creation Protocol</div>
        <button class="prof-create-save" onclick="profSaveEntity()">Commit</button>
    </header>

    <div class="prof-create-tabs">
        <div class="prof-tab-item active" onclick="profSwitchCreateTab('manual', this)">Manual</div>
        <div class="prof-tab-item" onclick="profSwitchCreateTab('intelligence', this)">Intelligence</div>
    </div>

    <main class="prof-create-body">
        <section id="prof-sec-manual" class="prof-form-section active">
            <div class="prof-input-group">
                <label class="prof-label">Full Name</label>
                <input type="text" id="prof-in-name" class="prof-input" placeholder="Enter entity name...">
            </div>
            
            <div class="prof-input-group">
                <label class="prof-label">Gender & Age</label>
                <input type="text" id="prof-in-bio-basic" class="prof-input" placeholder="e.g. Female, 24 years old">
            </div>

            <div class="prof-input-group" style="margin-top: 30px; border-top: 1px solid #000; padding-top: 20px;">
                <label class="prof-label">Link to Character (Association)</label>
                <div class="prof-custom-select" id="prof-select-manual-char">
                    <div class="prof-select-trigger" onclick="profToggleDropdown('prof-select-manual-char')">
                        <span class="prof-val-text">None / Standalone</span>
                    </div>
                    <div class="prof-select-options" id="prof-opts-manual-char"></div>
                    <input type="hidden" id="prof-in-bind-char" value=""> 
                </div>
            </div>

            <div class="prof-input-group">
                <label class="prof-label">Character Relationship (Detail)</label>
                <input type="text" id="prof-in-rel-char" class="prof-input" placeholder="e.g. Secret informant for Elias...">
            </div>

            <div class="prof-input-group">
                <label class="prof-label">User Relationship (Detail)</label>
                <input type="text" id="prof-in-rel-user" class="prof-input" placeholder="e.g. Observer / Strategic Partner...">
            </div>

            <div class="prof-input-group">
                <label class="prof-label">Physical Appearance (For AI Avatar)</label>
                <textarea id="prof-in-appearance" class="prof-textarea" placeholder="Silver hair, sharp blue eyes, wearing a black veil..."></textarea>
            </div>
        </section>

        <section id="prof-sec-intelligence" class="prof-form-section">
            <div id="prof-ai-loader" class="prof-loading-overlay">
                <div class="prof-progress-container">
                    <div class="prof-percent-text" id="prof-progress-num">0%</div>
                    <div class="prof-progress-bar-bg">
                        <div class="prof-progress-fill" id="prof-progress-bar"></div>
                    </div>
                    <div class="prof-loading-hint">Synchronizing with World Core...</div>
                </div>
            </div>

            <div class="prof-ai-box">
                <label class="prof-label">Select Source World</label>
                <div class="prof-custom-select" id="prof-select-ai-world">
                    <div class="prof-select-trigger" onclick="profToggleDropdown('prof-select-ai-world')">
                        <span class="prof-val-text">Select a World...</span>
                    </div>
                    <div class="prof-select-options" id="prof-opts-ai-world"></div>
                    <input type="hidden" id="prof-ai-world-id" value="">
                </div>
                <button class="prof-regen-btn" style="background:#000; color:#fff; border:none; margin-top:20px;" onclick="profRunAiGen()">GENERATE ENTITY FROM WORLD</button>
            </div>

            <div id="prof-ai-result-area" style="display:none;">
                <div class="prof-input-group">
                    <label class="prof-label">Generated Name (Editable)</label>
                    <input type="text" id="prof-ai-res-name" class="prof-input">
                </div>
                
                <div class="prof-input-group">
                    <label class="prof-label">Identity & Story (Editable)</label>
                    <textarea id="prof-ai-res-desc" class="prof-textarea" style="height: 180px;"></textarea>
                </div>

                <div class="prof-input-group" style="margin-top: 30px; border-top: 1px solid #EEE; padding-top: 20px;">
                    <label class="prof-label">Link to Character (Association)</label>
                    <div class="prof-custom-select" id="prof-sel-ai-bind">
                        <div class="prof-select-trigger" onclick="profToggleDropdown('prof-sel-ai-bind')">
                            <span class="prof-val-text">None / Standalone</span>
                        </div>
                        <div class="prof-select-options"></div>
                        <input type="hidden" id="prof-ai-bind-char" value="">
                    </div>
                </div>

                <div class="prof-input-group">
                    <label class="prof-label">Character Relationship</label>
                    <input type="text" id="prof-ai-rel-char" class="prof-input" placeholder="Relation to linked character...">
                </div>

                <div class="prof-input-group">
                    <label class="prof-label">User Relationship</label>
                    <input type="text" id="prof-ai-rel-user" class="prof-input" placeholder="Relation to you (user)...">
                </div>

                <div class="prof-input-group">
                    <label class="prof-label">Avatar Generation Prompt (Thick Paint Style)</label>
                    <div id="prof-ai-res-prompt" class="prof-prompt-preview"></div>
                </div>

                <div class="prof-avatar-gen-box" style="margin-bottom: 30px; text-align: center;">
                    <div class="prof-label" style="text-align: left;">Identity Visualization</div>
                    <div id="prof-avatar-preview" class="prof-avatar-frame" onclick="profUploadAvatar()">
                        <div class="prof-avatar-placeholder">CLICK TO UPLOAD GENERATED IMAGE</div>
                    </div>
                </div>

                <div class="prof-input-group">
                    <label class="prof-label">Visual Logic (Copy to External AI)</label>
                    <div class="prof-prompt-container">
                        <div id="prof-ai-res-prompt" class="prof-prompt-text">
                            Awaiting manifest...
                        </div>
                        <button class="prof-copy-btn" onclick="profCopyPrompt()" title="Copy Prompt">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                        </button>
                    </div>
                    <div class="prof-copy-hint">Transfer this protocol to your preferred AI Artist.</div>
                </div>

                <button class="prof-regen-btn" onclick="profRunAiGen()">RE-GENERATE</button>
            </div>
        </section>
    </main>
</div>
<div id="prof-npc-detail-page" class="prof-npc-modal">
    <div class="npc-modal-glass"></div>
    <div class="npc-modal-content">
        <header class="npc-modal-header">
            <button class="npc-close-btn" onclick="profCloseNpcDetail()">âœ•</button>
            <div class="npc-modal-title">ENTITY PROTOCOL</div>
            <button class="npc-edit-toggle" onclick="profToggleNpcEdit()">EDIT</button>
        </header>

        <main class="npc-modal-body" id="npc-detail-main">
            </main>

        <footer class="npc-modal-footer">
            <button class="npc-delete-btn" onclick="profConfirmDeleteNpc()">TERMINATE NODE</button>
            <button class="npc-save-btn" style="display:none;" onclick="profUpdateNpcData()">COMMIT CHANGES</button>
        </footer>
    </div>
</div>

<div id="prof-npc-confirm-modal" class="prof-confirm-overlay">
    <div class="prof-confirm-box">
        <div class="confirm-title">DELETION WARNING</div>
        <p>æ­¤æ“ä½œå°†æ°¸ä¹…æŠ¹é™¤è¯¥å®ä½“èŠ‚ç‚¹ï¼Œæ•°æ®ä¸å¯æ¢å¤ã€‚ç¡®å®šæ‰§è¡Œï¼Ÿ</p>
        <div class="confirm-btns">
            <button class="confirm-cancel" onclick="profCloseConfirm()">ABORT</button>
            <button class="confirm-ok" onclick="profExecuteDeleteNpc()">EXECUTE</button>
        </div>
    </div>
</div>
<div id="page-wallet" class="ios-app-window wallet-premium-theme">
    <div class="wallet-main-wrapper">
        <header class="wallet-art-header">
            <h1 class="brand-title">LUNE RESERVE</h1>
            <button class="wallet-close-btn" onclick="exitLuneWallet()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </header>

        <main class="wallet-canvas">
            <section id="w-tab-card" class="wallet-section active">
                <div class="vogue-balance-container">
                    <div class="balance-header-row">
                        <span class="cinzel-font" id="balance-scope-label">TOTAL ASSETS</span>
                        <div class="scope-switch-btn" onclick="toggleScopeMenu()">
                            <span>SELECT SCOPE</span>
                            <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                    </div>
                    <div class="balance-main">
                        <span class="unit">Â¥</span>
                        <h2 class="amount-number" id="main-balance-val">0.00</h2>
                    </div>
                    <div id="scope-menu" class="scope-dropdown" style="display:none;">
                        <div class="scope-item active" onclick="selectBalanceScope('all')">ALL (å…¨éƒ¨èµ„äº§)</div>
                        <div id="card-scope-list"></div>
                    </div>
                </div>

                <div class="card-action-gallery">
                    <div class="section-subtitle">MY METHODS</div>
                    <div id="saved-cards-container"></div>
                    <div class="create-card-blueprint" onclick="handleCreateCard()">
                        <div class="blueprint-inner">
                            <div class="plus-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </div>
                            <span class="blueprint-text">ISSUE NEW VIRTUAL CARD</span>
                        </div>
                        <div class="blueprint-deco">NO. 0000-RESERVE</div>
                    </div>
                </div>

                <div class="history-gallery">
                    <div class="history-header">
                        <span class="section-subtitle">RECENT ACTIVITY</span>
                        <div class="filter-btn" onclick="handleFilter()">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            <span>ç­›é€‰</span>
                        </div>
                    </div>
                                        
                    <div class="history-scroll-list">
                        <div class="empty-history-state">
                            <div class="empty-icon-deco"></div>
                            <p>NULL DATA ARCHIVE</p>
                            <span>æš‚æ— ä»»ä½•å‡ºå…¥è´¦è®°å½•</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="w-tab-send" class="wallet-section">
                <div class="send-sub-nav">
                    <div class="sub-nav-item active" onclick="switchSendMode('recharge', this)">RECHARGE (å……å€¼)</div>
                    <div class="sub-nav-item" onclick="switchSendMode('transfer', this)">TRANSFER (è½¬è´¦)</div>
                    <div class="sub-nav-slider"></div>
                </div>

                <div class="send-canvas">
                    <div class="send-form-group">
                        
                        <div id="area-recharge-target" class="form-section mode-content">
                            <span class="section-subtitle">SELECT CARD TO RECHARGE (é€‰æ‹©å……å€¼å¡)</span>
                            <div id="recharge-card-picker" class="picker-scroll-x">
                                </div>
                        </div>

                        <div id="area-transfer-source" class="form-section mode-content" style="display:none;">
                            <span class="section-subtitle">SOURCE ASSET (é€‰æ‹©æ”¯ä»˜å¡)</span>
                            <div id="transfer-source-picker" class="picker-scroll-x">
                                </div>
                        </div>

                        <div id="area-transfer-char" class="form-section mode-content" style="display:none;">
                            <span class="section-subtitle">TRANSFER TO CHARACTER (è½¬è´¦ç»™è§’è‰²)</span>
                            <div id="send-char-picker" class="picker-scroll-x">
                                </div>
                        </div>

                        <div class="form-section">
                            <span class="section-subtitle">AMOUNT (æ•°é¢)</span>
                            <div class="premium-amount-input">
                                <span class="curr">Â¥</span>
                                <input type="number" id="send-amount" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <span class="section-subtitle">MEMO (å¤‡æ³¨)</span>
                            <input type="text" id="send-memo" class="memo-input" placeholder="åè®®å¤‡æ³¨...">
                        </div>
                    </div>

                    <button class="execute-btn" onclick="processTransfer()">
                        <span class="btn-label" id="execute-btn-text">INITIALIZE RECHARGE</span>
                        <div class="btn-line"></div>
                    </button>
                </div>
            </section>

            <div id="transfer-success-layer" class="lune-modal-overlay" style="display:none;">
                <div class="success-box">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="1"><path d="M20 6L9 17l-5-5"/></svg>
                    </div>
                    <h3>PROTOCOL SUCCESS</h3>
                    <p>èµ„äº§è°ƒé…åè®®æ‰§è¡Œå®Œæ¯•ï¼Œè´¦ç›®å·²åŒæ­¥è‡³ç³»ç»Ÿæ¡£æ¡ˆã€‚</p>
                    <button class="modal-btn-confirm" onclick="closeSuccessLayer()">CONFIRMED</button>
                </div>
            </div>

            <section id="w-tab-log" class="wallet-section">
                <div class="archive-header-terminal">
                    <div class="terminal-left">
                        <h2 class="cinzel-title">ENTITY ARCHIVES</h2>
                        <div class="protocol-line">
                            <span class="status-dot"></span>
                            <p class="mono-subtitle">PROTOCOL: INDEPENDENT ASSET STORAGE</p>
                        </div>
                    </div>
                    <div class="terminal-right">
                        <div class="system-id">LUNE_OS v2.6.0</div>
                        <div class="scan-line-decor"></div>
                    </div>
                </div>

                <div id="archive-grid-container" class="receipt-grid">
                    </div>
            </section>

            <section id="w-tab-topup" class="wallet-section" style="display:none;">
                <div class="sim-deck-container">
                    <div class="open-header" style="margin-bottom: 15px;">
                        <span class="big-index">MY NODES</span>
                        <div class="header-text">
                            <div class="ht-main cinzel-font">LOCAL SIMs</div>
                            <div class="ht-sub">USER ACCESS POINTS</div>
                        </div>
                        <div class="add-sim-btn" onclick="openSimCreateModal()">+</div>
                    </div>

                    <div id="sim-cards-list" class="sim-scroll-wrapper"></div>
                    
                    <div id="sim-empty-state" style="text-align:center; padding: 30px; color: #666; display:none;">
                        <div style="font-size:10px;">NO LOCAL SIM DETECTED</div>
                    </div>

                    <div class="dashed-divider" style="margin: 30px 0; opacity: 0.3;"></div>

                    <div class="open-header" style="margin-bottom: 15px;">
                        <span class="big-index">LINKS</span>
                        <div class="header-text">
                            <div class="ht-main cinzel-font">ENTITY LINES</div>
                            <div class="ht-sub">CONNECTED CHARACTER NUMBERS</div>
                        </div>
                    </div>

                    <div id="char-sim-list" class="sim-scroll-wrapper">
                        </div>
                </div>

                <div id="sim-control-panel" style="display:none; padding: 20px; animation: slideUp 0.3s ease;">
                    <div class="action-btn-row">
                        <button onclick="openDirectTopUp()" class="minimal-white-btn">
                            <span>â†‘</span> CHARGE SELF
                        </button>
                        <button onclick="openSimHistory()" class="minimal-white-btn">
                            <span>â‰¡</span> LOGS
                        </button>
                    </div>
                    <button onclick="triggerAiPlanGen()" class="minimal-black-btn" style="width:100%; margin-top:10px;">
                        <span class="blink-symbol"></span> GENERATE PROTOCOL
                    </button>
                    <div style="margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 15px;">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="editSimNumber()" class="danger-text-btn">MODIFY_ID</button>
                            <button onclick="deleteSimCard()" class="danger-text-btn" style="color: #ff3b30;">TERMINATE</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="w-tab-trade" class="wallet-section">
                <div class="waiting-canvas">
                    <div class="art-placeholder">
                        <h3>MARKET TRADE</h3>
                        <p>Real-time exchange rate service offline.</p>
                        <span class="wait-tag">Pending Update</span>
                    </div>
                </div>
            </section>
        </main>

        <nav class="wallet-bottom-nav">
            <div class="nav-btn active" onclick="switchWTab(0, 'CARD')">
                <div class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="5" width="18" height="14" rx="1"/></svg></div>
                <span class="nav-text">CARD</span>
            </div>
            <div class="nav-btn" onclick="switchWTab(1, 'SEND')">
                <div class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg></div>
                <span class="nav-text">SEND</span>
            </div>
            <div class="nav-btn" onclick="switchWTab(2, 'LOG')">
                <div class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20V10M18 20V4M6 20v-4"/></svg></div>
                <span class="nav-text">LOG</span>
            </div>
            <div class="nav-btn" onclick="switchWTab(3, 'TOPUP')">
                <div class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 5v14M5 12h14"/></svg></div>
                <span class="nav-text">TOPUP</span>
            </div>
            <div class="nav-btn" onclick="switchWTab(4, 'TRADE')">
                <div class="nav-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 8l4 4-4 4M8 12h8"/></svg></div>
                <span class="nav-text">TRADE</span>
            </div>
        </nav>
    </div>
</div>
<div id="card-editor-layer" class="card-editor-layer" style="display: none;">
    <header class="wallet-art-header">
        <h1 class="brand-title">DESIGN STUDIO</h1>
        <button class="wallet-close-btn" onclick="toggleCardEditor(false)">
            <svg viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="1.5" width="24" height="24"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
    </header>

    <div class="editor-content">
        <div class="preview-area">
            <div id="live-card-preview" class="luxury-card layout-1" style="background: #1a1a1a; color: #ffffff;">
                <div class="card-glass-layer"></div>
                <div class="card-content-grid">
                    <div class="preview-chip"></div>
                    <div class="preview-name" id="p-name">CARD HOLDER</div>
                    <div class="preview-number" id="p-number">**** **** **** 0000</div>
                    <div class="preview-deco" id="p-deco">RESERVE ENTITY</div>
                </div>
            </div>
        </div>

        <div class="config-scroller">
            <div class="config-group">
                <span class="section-subtitle">IDENTIFICATION</span>
                <input type="text" id="input-card-name" placeholder="å¡ç‰‡åç§° (Card Name)" oninput="updatePreview()">
                <input type="text" id="input-card-number" placeholder="å¡å· (Card Number)" maxlength="19" oninput="updatePreview()">
            </div>

            <div class="config-group">
                <span class="section-subtitle">LAYOUT COMPOSITION</span>
                <div class="layout-selector">
                    <div class="layout-opt active" onclick="setLayout(1)">Minimal</div>
                    <div class="layout-opt" onclick="setLayout(2)">Modern</div>
                    <div class="layout-opt" onclick="setLayout(3)">Classic</div>
                </div>
            </div>

            <div class="config-group">
                <span class="section-subtitle">BACKGROUND ART</span>
                <div class="bg-selector">
                    <div class="bg-opt" style="background: #1a1a1a;" onclick="setBg('#1a1a1a')"></div>
                    <div class="bg-opt" style="background: linear-gradient(135deg, #2c3e50, #000);" onclick="setBg('linear-gradient(135deg, #2c3e50, #000)')"></div>
                    <div class="bg-opt" style="background: radial-gradient(circle, #434343, #000);" onclick="setBg('radial-gradient(circle, #434343, #000)')"></div>
                    <div class="bg-opt" style="background: #e0e0e0;" onclick="setBg('#e0e0e0')"></div>
                    <div class="bg-opt" style="background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'), #111;" onclick="setBg('carbon')"></div>
                </div>
            </div>

            <div class="config-group">
                <span class="section-subtitle">TEXT CHROMATICITY</span>
                <div class="color-wheel-container">
                    <canvas id="colorWheel" width="180" height="180"></canvas>
                    <div id="colorCursor"></div>
                </div>
                <div class="color-info">SELECTED: <span id="colorHex">#FFFFFF</span></div>
            </div>

            <div class="config-group">
                <div class="toggle-row">
                    <span class="section-subtitle">CHARACTER BINDING</span>
                    <label class="lune-switch">
                        <input type="checkbox" id="bind-toggle" onchange="toggleCharList()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="char-selection-area" class="char-scroll-x" style="display: none;">
                    </div>
            </div>

            <button class="save-card-btn" onclick="saveNewCard()">INITIALIZE ASSET</button>
        </div>
    </div>
</div>
<div id="wallet-modal-overlay" class="lune-modal-overlay" style="display: none;">
    <div class="lune-modal-content">
        <div class="modal-art-line"></div>
        <h3>æ³¨é”€ç¡®è®¤</h3>
        <p>æ‚¨æ­£åœ¨ç”³è¯·æ³¨é”€è¯¥é¡¹èµ„äº§åè®®ã€‚æ³¨é”€åï¼Œæ‰€æœ‰å…³è”çš„è´¢åŠ¡æ¡£æ¡ˆå°†è¿›å…¥ä¸å¯é€†çš„é”€æ¯ç¨‹åºã€‚</p>
        <div class="modal-actions">
            <button class="modal-btn-cancel" onclick="closeWalletModal()">RETAIN (ä¿ç•™)</button>
            <button class="modal-btn-confirm" id="modal-confirm-action">TERMINATE (æ³¨é”€)</button>
        </div>
    </div>
</div>

<div id="wallet-filter-modal" class="lune-modal-overlay" style="display: none;">
    <div class="lune-modal-content filter-modal-box">
        <header class="modal-art-header">
            <span class="cinzel-font">FILTER ARCHIVE</span>
            <div class="close-modal-icon" onclick="closeFilterModal()">Ã—</div>
        </header>

        <div class="filter-body">
            <div class="filter-group">
                <span class="section-subtitle">ACCOUNT SCOPE</span>
                <div class="filter-chips" id="filter-card-chips">
                    <div class="chip active" onclick="selectFilterChip('scope', 'all', this)">ALL ASSETS</div>
                    </div>
            </div>

            <div class="filter-group">
                <span class="section-subtitle">TRANSACTION TYPE</span>
                <div class="filter-chips">
                    <div class="chip active" onclick="selectFilterChip('type', 'all', this)">ALL</div>
                    <div class="chip" onclick="selectFilterChip('type', 'inflow', this)">INFLOW (æ”¶å…¥)</div>
                    <div class="chip" onclick="selectFilterChip('type', 'outflow', this)">OUTFLOW (æ”¯å‡º)</div>
                </div>
            </div>
        </div>

        <button class="apply-filter-btn" onclick="applyFilterProtocol()">APPLY PROTOCOL</button>
    </div>
</div>

<div id="wallet-notice-layer" class="lune-modal-overlay" style="display:none;">
    <div class="lune-modal-content">
        <div class="modal-art-line" style="background: #ff3b30;"></div>
        <h3 id="notice-title">PROTOCOL ERROR</h3>
        <p id="notice-msg">æ— æ³•æ‰§è¡Œè¯¥é¡¹åè®®ã€‚</p>
        <button class="modal-btn-confirm" onclick="closeWalletNotice()">UNDERSTOOD</button>
    </div>
</div>
<div id="bank-detail-overlay" class="luna-subpage-overlay">
    <div class="safe-area-inset"></div>

    <header class="bank-nav-header">
        <div class="back-btn" onclick="closeBankDetail()">
            <svg viewBox="0 0 24 24" width="24" height="24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="black"/></svg>
        </div>
        <div class="header-title cinzel-font">CENTRAL VAULT</div>
        <div class="header-extra">ARCHIVE-v2.0</div>
    </header>

    <div class="bank-viewport">
        <section class="bank-tab-panel active" id="tab-dashboard">
            <div class="scroll-box">
                
                <div class="dashboard-balance-editor">
                    <div class="balance-info">
                        <span class="tiny-label">LIQUID ASSETS</span>
                        <div class="display-row">
                            <span class="currency">ï¿¥</span>
                            <span id="current-balance-num">2,840.00</span>
                            <button class="edit-balance-btn" onclick="triggerBalanceEdit()">
                                <svg viewBox="0 0 24 24" width="16" height="16"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="section-header-bw">
                    <span class="cinzel-font">CARD ENCRYPTED PACK</span>
                    <div class="header-line"></div>
                </div>
                <div class="card-sync-container">
                    <div id="synced-card-list" class="horizontal-scroll-cards">
                        <div class="mini-card-skeleton">EMPTY_SLOT</div>
                    </div>
                    <button class="add-protocol-btn" onclick="customProtocolAction()">
                        <span>+ ADD_PROTOCOL_LINK</span>
                    </button>
                </div>

                <div class="consumption-module">
                    <nav class="consumption-switcher-tabs">
                        <div class="con-tab active" onclick="toggleConsumptionView('monthly', this); window.syncVaultDataToUI();">
                            MONTHLY (æœˆåº¦)
                        </div>
                        <div class="con-tab" onclick="toggleConsumptionView('yearly', this); window.syncVaultDataToUI();">
                            ANNUAL (å¹´åº¦)
                        </div>
                    </nav>

                    <div id="view-monthly" class="consumption-sub-panel active" style="padding: 10px;">
                        <div class="dash-section-header">
                            <span class="tiny-label">ARCHIVED_LOGS / å†å²å­˜æ¡£</span>
                            <button class="mini-add-btn" onclick="monthlyDetailAction()">+ NEW_GEN</button>
                        </div>

                        <div id="dash-monthly-cards-container" class="history-cards-scroll">
                            <div class="empty-placeholder">NO_DATA_FOUND // ç­‰å¾…æŒ‡ä»¤ä¸‹å‘</div>
                        </div>
                    </div>

                    <div id="view-yearly" class="consumption-sub-panel" style="padding: 10px;">
                        <div class="dash-section-header">
                            <span class="tiny-label">ANNUAL_ARCHIVES / å¹´åº¦å·å®—</span>
                            <button class="mini-add-btn" onclick="yearlyDetailAction()">+ NEW_ANNUAL</button>
                        </div>

                        <div id="dash-yearly-cards-container" class="history-cards-scroll">
                            <div class="empty-placeholder">NO_ANNUAL_DATA // ç­‰å¾…å¹´åº¦æŒ‡ä»¤</div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <section class="bank-tab-panel" id="tab-records" style="display: none;">
            <div class="scroll-box" style="padding: 0 !important; padding-bottom: 100px;">
                
                <div class="open-section">
                    <div class="open-header">
                        <span class="big-index">01</span>
                        <div class="header-text">
                            <div class="ht-main cinzel-font">ENTITY_MATRIX</div>
                            <div class="ht-sub">ACTIVE_CHARACTERS_COST // è§’è‰²æ”¯å‡ºæµ</div>
                        </div>
                    </div>

                    <div id="char-expense-list" class="open-list-container">
                        <div class="empty-text-mark">WAITING_FOR_DATA_STREAM...</div>
                    </div>

                    <button onclick="manualSyncTransfers()" class="minimal-black-btn" style="width: 100%; margin-bottom: 10px; background: #fff; color: #000; border: 2px solid #000; text-align: center;">
                        â†» SYNC_TRANSFERS (åˆ·æ–°ç”¨æˆ·è½¬è´¦)
                    </button>

                    <button onclick="window.triggerCharExpenseAI()" class="minimal-black-btn">
                        <span class="blink-symbol">_</span> ANALYZE_ENTITIES
                    </button>
                </div>

                <div class="giant-divider"></div>

                <div class="open-section">
                    <div class="open-header">
                        <span class="big-index">02</span>
                        <div class="header-text">
                            <div class="ht-main cinzel-font">SIGNAL_LOGS</div>
                            <div class="ht-sub">DEVICE_SIM_BILLING // è¯è´¹è´¦å•</div>
                        </div>
                    </div>

                    <div id="phone-bill-list" class="open-list-container receipt-mode">
                        <div class="empty-text-mark">NO_SIGNAL_RECORD...</div>
                    </div>

                    <button onclick="window.triggerPhoneBillAI()" class="minimal-black-btn">
                        <span class="blink-symbol">_</span> GENERATE_BILL
                    </button>
                </div>

                <div style="margin-top: 50px; text-align: center; opacity: 0.2;">
                    <div style="font-family: 'Cinzel'; font-weight: 900; font-size: 24px;">LUNE</div>
                    <div style="font-family: monospace; font-size: 9px; letter-spacing: 5px;">PROTOCOL_V2</div>
                </div>

            </div>
        </section>

        <section class="bank-tab-panel" id="tab-vault" style="display: none;">
            <div class="scroll-box" style="padding: 20px;">

                <div id="vault-state-empty" style="display: none;">
                    <div class="open-header">
                        <span class="big-index">00</span>
                        <div class="header-text">
                            <div class="ht-main cinzel-font">PROTOCOL_INIT</div>
                            <div class="ht-sub">ESTABLISH NEW SAVING GOAL // å»ºç«‹å¥‘çº¦</div>
                        </div>
                    </div>

                    <div class="record-section-block" style="padding: 30px 20px; text-align: center; margin-top: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 20px;">
                            å½“å‰æœªæ£€æµ‹åˆ°æ´»è·ƒçš„å‚¨è“„åè®®ã€‚<br>ä½ å¯ä»¥æ‰‹åŠ¨è®¾å®šï¼Œæˆ–è®©å¯¹æ–¹æ ¹æ®å½“å‰å¤„å¢ƒå‘èµ·ææ¡ˆã€‚
                        </div>

                        <button onclick="openManualSetModal()" class="minimal-white-btn" style="margin-bottom: 15px; width: 100%;">
                            [ MANUAL INPUT ] æ‰‹åŠ¨è®¾å®š
                        </button>
                        
                        <button onclick="triggerAiSavingPlan()" class="minimal-black-btn" style="width: 100%;">
                            <span class="blink-symbol"> </span> REQUEST_PROPOSAL (AI ææ¡ˆ)
                        </button>
                    </div>
                </div>

                <div id="vault-state-active" style="display: none;">
                    
                    <div class="plan-card-white" style="border: 2px solid #000; padding: 20px; margin-top: 20px; position: relative; overflow: hidden;">
                        <div style="position: absolute; right: -10px; top: -10px; font-size: 80px; opacity: 0.05; font-weight: 900; font-family: 'Cinzel'; pointer-events: none;">$</div>

                        <div class="plan-header cinzel-font" style="font-size: 18px; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                            ACTIVE PROTOCOL
                        </div>

                        <div id="active-goal-name" style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">GOAL_NAME</div>
                        <div id="active-goal-desc" style="font-size: 10px; color: #666; margin-bottom: 20px; line-height: 1.4;">Goal description...</div>

                        <div class="progress-bar-industrial" style="height: 15px; background: #eee; border: 1px solid #000; position: relative;">
                            <div id="vault-progress-fill" class="progress-inner" style="width: 0%; background: #000; height: 100%; transition: width 0.5s ease;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-family: 'Cinzel'; font-weight: 900;">
                            <span id="vault-current-val">ï¿¥0</span>
                            <span id="vault-target-val">/ ï¿¥50,000</span>
                        </div>
                    </div>

                    <div class="action-btn-row" style="margin-top: 30px;">
                        <button onclick="openDepositModal()" class="minimal-black-btn">
                            INJECT FUNDS (å­˜å…¥)
                        </button>
                    </div>

                    <button onclick="openVaultLogs()" class="minimal-white-btn" style="width: 100%; margin-top: 10px;">
                        VIEW_LOGS (æŸ¥çœ‹è®°å½•)
                    </button>

                </div>

            </div>
        </section>
    </div>

    <nav class="bank-bottom-nav">
        <div class="nav-b-item active" onclick="switchBankTab(0, this)">
            <div class="nav-icon-dot"></div>
            <span>DASHBOARD</span>
        </div>
        <div class="nav-b-item" onclick="switchBankTab(1, this)">
            <div class="nav-icon-dot"></div>
            <span>RECORDS</span>
        </div>
        <div class="nav-b-item" onclick="switchBankTab(2, this)">
            <div class="nav-icon-dot"></div>
            <span>PLAN</span>
        </div>
    </nav>
</div>
<div id="balance-edit-modal" class="industrial-modal-overlay">
    <div class="industrial-modal-box">
        <header class="modal-header-bw">
            <span class="cinzel-font">RECALIBRATE CAPITAL</span>
            <div class="close-x" onclick="closeBalanceEditor()">Ã—</div>
        </header>
        
        <div class="modal-body">
            <div class="input-container-bw">
                <span class="input-label">NEW_VALUE</span>
                <input type="number" id="new-balance-input" placeholder="0.00" step="0.01">
                <div class="input-decoration">PROTOCOL_REQUIRED</div>
            </div>
        </div>

        <footer class="modal-footer-bw">
            <button class="modal-btn-cancel" onclick="closeBalanceEditor()">ABORT</button>
            <button class="modal-btn-confirm" onclick="confirmBalanceEdit()">EXECUTE</button>
        </footer>
    </div>
</div>
<div id="protocol-link-overlay" class="industrial-modal-overlay">
    <div class="industrial-modal-box protocol-box">
        <header class="modal-header-bw">
            <div class="header-content">
                <span class="cinzel-font">PROTOCOL LINK SYSTEM</span>
                <span class="subtitle-en">EXTERNAL_DATA_BRIDGE</span>
            </div>
            <div class="close-x" onclick="closeProtocolModal()">Ã—</div>
        </header>
        
        <div class="modal-body protocol-body">
            <div class="protocol-deco-line"></div>
            
            <div class="protocol-action-container">
                <p class="protocol-hint">è¯·é€‰æ‹©éœ€è¦åŒæ­¥æˆ–è°ƒç”¨çš„å¤–éƒ¨åè®®æŒ‡ä»¤ï¼š</p>
                
                <button class="protocol-main-btn" onclick="handleCharacterBindingRecord()">
                    <div class="btn-icon">ğŸ“</div>
                    <div class="btn-text-group">
                        <span class="btn-main-title">è§’è‰²ç»‘å¡è®°å½•</span>
                        <span class="btn-sub-title">CHARACTER_CARD_BINDING_RECORDS</span>
                    </div>
                    <div class="btn-arrow">â†’</div>
                </button>
            </div>

            <div class="protocol-footer-info">
                <span>ENCRYPTED_LINK: ACTIVE</span>
                <span>NODE: 0x882_LUNE</span>
            </div>
        </div>
    </div>
</div>
<div id="npc-binding-list-overlay" class="industrial-modal-overlay">
    <div class="industrial-modal-box record-list-box">
        <header class="modal-header-bw">
            <span class="cinzel-font">BINDING RECORDS / ç»‘å¡å†å²</span>
            <div class="close-x" onclick="closeNPCList()">Ã—</div>
        </header>
        <div class="modal-body">
            <div id="npc-record-container" class="npc-record-list">
                </div>
            <button class="ai-generate-btn" onclick="generateNPCCardWithAI()">
                <span class="ai-icon">âœ¦</span> GENERATE NEW LINK (AI)
            </button>
        </div>
    </div>

    <div id="ai-loading-overlay" class="decoding-overlay">
        <div class="scan-line"></div>
        <div class="flicker-text" id="loading-status-text">DECRYPTING_ARCHIVE</div>
        <div class="loading-progress-container">
            <div id="ai-progress-bar" class="loading-progress-bar"></div>
        </div>
        <div style="font-size: 8px; margin-top: 10px; font-family: monospace;">ACCESSING_LUNE_SERVERS...</div>
    </div>
</div>

<div id="binding-story-modal" class="industrial-modal-overlay" style="z-index: 20000; display: none;">
    <div class="industrial-modal-box story-box" style="background: #fff; border: 3px solid #000; box-shadow: 10px 10px 0px #000;">
        <header class="modal-header-bw" style="background: #000; color: #fff; padding: 15px; display: flex; justify-content: space-between;">
            <span class="cinzel-font">DECODED_STORY_LORE</span>
            <div class="close-x" onclick="closeStoryModal()" style="cursor:pointer;">Ã—</div>
        </header>
        <div class="modal-body" style="padding: 25px;">
            <div id="story-text-content" style="font-size: 14px; line-height: 1.8; color: #000; border-left: 4px solid #000; padding-left: 15px; min-height: 60px;">
                æ­£åœ¨è¯»å–è§£å¯†è®°å½•...
            </div>
            <div style="font-size: 8px; font-family: monospace; opacity: 0.4; text-align: right; margin-top: 20px;">
                SECURITY_CLEARANCE: AUTHORIZED
            </div>
        </div>
    </div>
</div>
<div id="monthly-config-modal" class="industrial-modal-overlay" style="z-index: 400000;">
    <div class="industrial-modal-box">
        <header class="modal-header-bw">
            <span class="cinzel-font">MONTHLY_REPORT_CONFIG</span>
            <div class="close-x" onclick="closeMonthlyConfig()">Ã—</div>
        </header>
        <div class="modal-body">
            <div class="config-item">
                <span class="tiny-label">SELECT YEAR</span>
                <input type="number" id="config-year" value="2026" min="1990" max="2099">
            </div>
            <div class="config-item">
                <span class="tiny-label">DURATION (MONTHS)</span>
                <input type="range" id="config-months-range" min="1" max="12" value="6" oninput="updateRangeText(this.value)">
                <div id="range-val" style="text-align:right; font-weight:900;">6 MONTHS</div>
            </div>
        </div>
        <footer class="modal-footer-bw">
            <button class="modal-btn-cancel" onclick="closeMonthlyConfig()">ABORT</button>
            <button class="modal-btn-confirm" onclick="generateMonthlyReport()">EXECUTE</button>
        </footer>
    </div>
</div>

<div id="monthly-report-display" class="industrial-modal-overlay" style="z-index: 400001; display: none;">
    <div class="industrial-modal-box full-box" style="display: flex; flex-direction: column; height: 85vh; max-height: 700px; background: #fff;">
        
        <header class="modal-header-bw" style="flex: 0 0 auto;">
            <span class="cinzel-font">EXPENDITURE_VISUALIZATION</span>
            <div class="close-x" onclick="closeMonthlyReport()">Ã—</div>
        </header>

        <div class="modal-body scroll-body" style="flex: 1; overflow-y: auto; padding: 20px;">
            <div class="chart-container-bw">
                <canvas id="monthly-chart-canvas" width="300" height="150"></canvas>
            </div>
            <div class="archive-list-header">
                <span class="tiny-label">DATA_STREAM | å®æ—¶è´¦ç›®æµ</span>
                <div class="header-line"></div>
            </div>
            <div id="monthly-records-list"></div>
        </div>

        <footer class="report-footer-actions" style="flex: 0 0 auto; padding: 15px; background: #fff; border-top: 2px solid #000; display: flex; gap: 10px;">
            <button class="save-archive-btn" onclick="window.manualSaveArchive()" style="flex: 2; background: #000; color: #fff; padding: 12px; font-family: 'Cinzel'; font-weight: 900; border: none; cursor: pointer; border-radius: 0;">
                COMMIT_TO_VAULT
            </button>
            <button class="re-gen-btn" onclick="window.reTriggerConfig()" style="flex: 1; background: #fff; color: #000; padding: 12px; font-family: 'Cinzel'; font-weight: 900; border: 2px solid #000; cursor: pointer; border-radius: 0;">
                RE-GEN
            </button>
        </footer>
    </div>
</div>

<div id="month-record-detail" class="industrial-modal-overlay" style="z-index: 400002; display: none;">
    <div class="industrial-modal-box full-box">
        <header class="modal-header-bw" style="background: #000; color: #fff; padding: 15px; display: flex; justify-content: space-between;">
            <div>
                <span class="cinzel-font">DEEP_LOG_ANALYSIS</span>
                <div id="detail-month-label" style="font-size: 9px; opacity: 0.5; font-family: monospace;"></div>
            </div>
            <div class="close-x" onclick="window.closeMonthEntryDetail()" style="cursor:pointer;">Ã—</div>
        </header>

        <div class="modal-body scroll-body" id="detail-story-container" style="padding: 25px; min-height: 300px; position: relative;">
            </div>

        <footer style="padding: 15px 25px; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center;">
            <button class="re-gen-btn" onclick="window.regenerateStory()" style="flex:1;">â†» RE-GEN</button>
            <button class="save-archive-btn" onclick="window.confirmSaveStory()" style="flex:2;">COMMIT_ARCHIVE</button>
            <span id="detail-amount-tag" style="font-family: 'Cinzel'; font-weight: 900; margin-left: 10px;"></span>
        </footer>
    </div>
</div>
<div id="yearly-config-modal" class="industrial-modal-overlay" style="z-index: 500000;">
    <div class="industrial-modal-box">
        <header class="modal-header-bw">
            <span class="cinzel-font">ANNUAL_PROTOCOL_CONFIG</span>
            <div class="close-x" onclick="closeYearlyConfig()">Ã—</div>
        </header>
        <div class="modal-body">
            <div class="config-item">
                <span class="tiny-label">START_YEAR (èµ·å§‹å¹´ä»½)</span>
                <input type="number" id="y-config-year" value="2026" min="1990" max="2099">
            </div>
            <div class="config-item">
                <span class="tiny-label">TIME_SPAN (è·¨åº¦: 1-10å¹´)</span>
                <input type="range" id="y-config-range" min="1" max="10" value="1" oninput="updateYearRangeText(this.value)">
                <div id="y-range-val" style="text-align:right; font-weight:900; font-family:'Cinzel';">1 YEAR(S)</div>
            </div>
        </div>
        <footer class="modal-footer-bw">
            <button class="modal-btn-cancel" onclick="closeYearlyConfig()">ABORT</button>
            <button class="modal-btn-confirm" onclick="generateYearlyReport()">DECRYPT_ANNUAL</button>
        </footer>
    </div>
</div>

<div id="yearly-report-display" class="industrial-modal-overlay" style="z-index: 500001; display: none;">
    <div class="industrial-modal-box full-box" style="height: 90vh; background: #f4f4f4;">
        <header class="modal-header-bw">
            <span class="cinzel-font">ANNUAL_RECEIPT_STREAM</span>
            <div class="close-x" onclick="closeYearlyReport()">Ã—</div>
        </header>

        <div class="modal-body scroll-body" id="yearly-bill-container" style="padding: 15px;">
            </div>

        <footer class="report-footer-actions" style="background: #fff; border-top: 2px solid #000; padding: 15px; display: flex !important; gap: 10px;">
            <button class="save-archive-btn" onclick="window.saveYearlyArchive()" style="flex: 2; background: #000 !important; color:#fff !important; display:block !important;">
                COMMIT_ANNUAL_VAULT (æ°¸ä¹…å°å­˜å¹´åº¦æ¡£æ¡ˆ)
            </button>
            <button class="re-gen-btn" onclick="closeYearlyReport(); yearlyDetailAction();" style="flex: 1; display:block !important;">RE-CONFIG</button>
        </footer>
    </div>
</div>
<div id="yearly-success-modal" class="industrial-modal-overlay" style="z-index: 600000; display: none;">
    <div class="industrial-modal-box" style="max-width: 300px; border: 3px solid #000; box-shadow: 15px 15px 0px #eee;">
        <div style="background: #000; height: 12px; width: 100%;"></div>
        
        <div class="modal-body" style="text-align: center; padding: 40px 20px;">
            <div style="width: 60px; height: 60px; border: 2px solid #000; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; transform: rotate(45deg);">
                <span style="transform: rotate(-45deg); font-size: 30px; font-weight: 100;">âœ“</span>
            </div>
            
            <div class="cinzel-font" style="font-weight: 900; font-size: 18px; letter-spacing: 3px; color: #000;">
                PROTOCOL_SEALED
            </div>
            
            <div style="font-family: monospace; font-size: 9px; margin-top: 15px; color: #666; line-height: 1.6; text-transform: uppercase;">
                å¹´åº¦å·å®—å·²æ­£å¼åˆ‡ç‰‡å¹¶å½’æ¡£<br>
                AUTH_CODE: 0x882_LUNE_VAULT<br>
                STATUS: ENCRYPTED // é”å®šä¸­
            </div>

            <button onclick="closeYearlySuccess()" style="width: 100%; margin-top: 30px; padding: 15px; background: #000; color: #fff; border: none; font-family: 'Cinzel'; font-weight: 900; cursor: pointer; letter-spacing: 2px;">
                UNDERSTOOD
            </button>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 5px 10px; font-family: monospace; font-size: 7px; opacity: 0.3;">
            <span>BLOCK_CHAIN_SECURED</span>
            <span>v2.0_ARCHIVE</span>
        </div>
    </div>
</div>

<div id="yearly-overview-modal" class="industrial-modal-overlay" style="z-index: 550000; display: none;">
    <div class="industrial-modal-box full-box" style="height: 90vh; background: #f4f4f4;">
        
        <header class="modal-header-bw">
            <span class="cinzel-font">YEARLY_OVERVIEW // å¹´åº¦æ€»è§ˆ</span>
            <div class="close-x" onclick="closeYearlyOverview()">Ã—</div>
        </header>

        <div class="modal-body scroll-body" id="yearly-overview-container" style="padding: 15px; overflow-y: auto;">
            </div>

        <footer class="report-footer-actions" style="background: #fff; border-top: 2px solid #000; padding: 15px; display: flex !important;">
            <button onclick="enterYearlySecondLayer()" style="width: 100%; background: #000 !important; color:#fff !important; padding: 18px; font-family: 'Cinzel'; font-weight: 900; border: none; cursor: pointer; letter-spacing: 2px; font-size: 16px;">
                VIEW MONTHLY BREAKDOWN (æŸ¥çœ‹æœˆåº¦æ‹†è§£)
            </button>
        </footer>
    </div>
</div>

<div id="yearly-history-modal" class="industrial-modal-overlay" style="z-index: 550000; display: none;">
    <div class="industrial-modal-box full-box" style="height: 90vh; background: #f4f4f4;">
        
        <header class="modal-header-bw">
            <span class="cinzel-font">ARCHIVED_YEAR_LOG</span>
            <div class="close-x" onclick="closeYearlyHistory()">Ã—</div>
        </header>

        <div class="modal-body scroll-body" id="yearly-history-container" style="padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;">
            </div>

        <footer class="report-footer-actions" style="background: #fff; border-top: 2px solid #000; padding: 15px; display: flex !important;">
            <button onclick="handleAnnualConsumption()" style="width: 100%; background: #000 !important; color:#fff !important; padding: 18px; font-family: 'Cinzel'; font-weight: 900; border: none; cursor: pointer; letter-spacing: 2px; font-size: 16px;">
                ANNUAL EXPENDITURE (å¹´åº¦æ¶ˆè´¹)
            </button>
        </footer>
    </div>
</div>
<div id="annual-story-modal" class="industrial-modal-overlay" style="z-index: 600000; display: none;">
    <div class="industrial-modal-box full-box" style="height: 85vh; background: #fff; border: 4px solid #000; max-width: 500px;">
        
        <div style="background:#000; color:#fff; padding:10px; font-family:monospace; font-size:9px; display:flex; justify-content:space-between;">
            <span>CLASSIFIED_ARCHIVE</span>
            <span>LEVEL_5_ACCESS</span>
        </div>

        <div class="modal-body scroll-body" style="padding: 30px;">
            <div class="story-header-title">ANNUAL REPORT</div>
            
            <div id="annual-story-content">
                </div>
        </div>

        <div onclick="closeAnnualStory()" style="padding: 20px; text-align: center; cursor: pointer; border-top: 1px solid #eee; font-family: 'Cinzel'; font-weight: 900; letter-spacing: 2px;">
            CLOSE_DOSSIER (å…³é—­æ¡£æ¡ˆ)
        </div>
    </div>
</div>

<div id="monthly-story-modal" class="industrial-modal-overlay" style="z-index: 600000; display: none;">
    <div class="industrial-modal-box" style="width: 90%; max-width: 400px; background: #f4f4f4; border: 2px solid #000; box-shadow: 15px 15px 0 rgba(0,0,0,0.8);">
        
        <div style="position:absolute; left:10px; top:10px; bottom:10px; width:2px; background:#000; opacity:0.1;"></div>

        <div class="modal-body" style="padding: 30px 20px 30px 30px; max-height: 70vh; overflow-y: auto;">
            
            <div id="month-story-title" style="font-family:'Cinzel'; font-size:40px; font-weight:900; opacity:0.1; position:absolute; right:20px; top:10px;">01</div>
            
            <div style="font-family:monospace; font-size:10px; margin-bottom:15px; color:#666;">MEMORY_FRAGMENT_RECOVERY...</div>

            <div id="month-story-content" class="story-prose-text" style="font-size: 14px;">
                </div>
        </div>

        <div onclick="closeMonthlyStory()" style="background:#000; color:#fff; text-align:center; padding:15px; font-weight:bold; cursor:pointer;">
            RETURN (è¿”å›)
        </div>
    </div>
</div>

<div id="entity-daily-modal" class="industrial-modal-overlay" style="z-index: 600000; display: none;">
    <div class="industrial-modal-box" style="width: 90%; max-width: 450px; background: #fff; border: 4px solid #000; box-shadow: 15px 15px 0 rgba(0,0,0,0.2);">
        
        <div style="background: #000; color: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div class="cinzel-font" style="font-size: 18px; font-weight: 900;">DAILY SETTLEMENT</div>
                <div id="daily-date-label" style="font-family: monospace; font-size: 10px; opacity: 0.7;">YYYY-MM-DD</div>
            </div>
            <div onclick="closeEntityDailyModal()" style="cursor: pointer; font-size: 24px;">Ã—</div>
        </div>

        <div style="padding: 25px;">
            
            <div id="pending-transfer-box" style="margin-bottom: 25px; padding: 15px; border: 1px dashed #000; display: none;">
                <div style="font-size: 10px; font-weight: bold; margin-bottom: 10px;">âš¡ INCOMING TRANSFERS (æ£€æµ‹åˆ°èµ„é‡‘æµå…¥)</div>
                <div id="transfer-list-content">
                    </div>
            </div>

            <div id="daily-status-text" style="text-align: center; margin-bottom: 25px; font-family: monospace; font-size: 12px; line-height: 1.6;">
                READY TO ANALYZE ENTITY ACTIVITY...<br>
                å‡†å¤‡ç”Ÿæˆä»Šæ—¥æ”¶æ”¯æµæ°´
            </div>

            <button id="btn-gen-daily" onclick="runEntityDailyAI()" class="minimal-black-btn" style="width: 100%;">
                [ EXECUTE_PROTOCOL ] ç”Ÿæˆæ—¥è®°å½•
            </button>
            
            <div id="daily-done-msg" style="display: none; text-align: center; color: #666; font-size: 12px; padding: 20px;">
                âœ“ ä»Šæ—¥è®°å½•å·²å½’æ¡£ (ARCHIVED)
            </div>

        </div>
    </div>
</div>
<div id="industrial-alert-modal" class="industrial-modal-overlay" style="display: none; z-index: 999999; justify-content: center; align-items: center;">
    <div class="industrial-modal-box" style="width: 80%; max-width: 320px; background: #fff; border: 3px solid #000; box-shadow: 12px 12px 0 rgba(0,0,0,0.9); padding: 0; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        
        <div style="background: #000; color: #fff; padding: 12px; font-family: 'Cinzel', serif; font-weight: 900; letter-spacing: 2px; font-size: 12px; display: flex; justify-content: space-between;">
            <span>SYSTEM_NOTICE</span>
            <span>///</span>
        </div>

        <div id="industrial-alert-msg" style="padding: 35px 25px; font-size: 14px; font-weight: bold; line-height: 1.6; color: #000; text-align: center;">
            </div>

        <button onclick="closeIndustrialAlert()" style="width: 100%; padding: 18px; background: #fff; color: #000; border: none; border-top: 3px solid #000; font-family: 'Cinzel'; font-weight: 900; cursor: pointer; font-size: 14px; transition: background 0.2s;">
            [ CONFIRM_RECEIPT ]
        </button>
    </div>
</div>
<div id="modal-ai-proposal" class="industrial-modal-overlay" style="z-index: 700000; display: none;">
    <div class="industrial-modal-box" style="background: #fdfbf7; border: 2px solid #000; padding: 0; max-width: 350px;">
        
        <div style="padding: 20px; border-bottom: 1px dashed #000; text-align: center;">
            <div class="cinzel-font" style="font-weight: 900; font-size: 18px;">SAVING AGREEMENT</div>
            <div style="font-family: monospace; font-size: 10px; margin-top: 5px;">DRAFTED BY: <span id="proposal-char-name">UNKOWN</span></div>
        </div>

        <div style="padding: 25px; position: relative;">
            <div id="proposal-loader" style="text-align: center; padding: 20px;">
                <div class="scan-bar-anim" style="background:#000;"></div>
                <div style="font-size: 10px; margin-top: 10px;">NEGOTIATING...</div>
            </div>

            <div id="proposal-content" style="display: none;">
                <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;" id="prop-title"></div>
                <div style="font-size: 13px; line-height: 1.8; text-align: justify; margin-bottom: 20px;" id="prop-desc"></div>
                
                <div style="background: #eee; padding: 10px; text-align: center; font-family: 'Cinzel'; font-weight: 900;">
                    TARGET: ï¿¥<span id="prop-amount">0</span>
                </div>
            </div>

            <div id="stamp-container" class="stamp-box" style="display: none;">
                <div class="stamp-circle">APPROVED</div>
            </div>
        </div>

        <div id="proposal-actions" style="display: none; border-top: 2px solid #000; display: flex;">
            <button onclick="rejectProposal()" style="flex: 1; padding: 15px; border: none; background: #fff; color: #000; border-right: 1px solid #000; cursor: pointer; font-weight: bold;">REJECT</button>
            <button onclick="approveProposal()" style="flex: 1; padding: 15px; border: none; background: #000; color: #fff; cursor: pointer; font-weight: bold;">SIGN (æ‰¹å‡†)</button>
        </div>
    </div>
</div>

<div id="modal-vault-logs" class="industrial-modal-overlay" style="z-index: 650000; display: none;">
    <div class="industrial-modal-box full-box" style="height: 85vh; background: #fdfbf9; display: flex; flex-direction: column;">
        
        <header class="modal-header-bw" style="flex-shrink: 0;">
            <span>SAVING_LOGS // å­˜è“„æ¡£æ¡ˆ</span>
            <div class="close-x" onclick="document.getElementById('modal-vault-logs').style.display='none'">Ã—</div>
        </header>

        <div id="vault-action-area" style="padding: 15px; border-bottom: 2px solid #000; background: #fff; flex-shrink: 0;">
            <button id="btn-daily-deposit" onclick="triggerDailyDepositAI()" class="minimal-black-btn" style="width: 100%;">
                <span class="blink-symbol">+</span> EXECUTE_DAILY_DEPOSIT (æ¯æ—¥å­˜å…¥)
            </button>
            <div id="daily-deposit-hint" style="font-size: 10px; color: #666; text-align: center; margin-top: 8px; font-family: monospace;">
                STATUS: READY // ä»Šæ—¥å°šæœªæ‰“å¡
            </div>
        </div>

        <div class="modal-body scroll-body" id="vault-logs-container" style="padding: 15px; flex: 1; overflow-y: auto; background: #f4f4f4;">
            </div>
    </div>
</div>

<div id="modal-deposit" class="industrial-modal-overlay" style="z-index: 660000; display: none;">
    <div class="industrial-modal-box" style="width: 80%; max-width: 300px; background: #fff; border: 3px solid #000;">
        <div style="padding: 20px;">
            <div style="font-weight: 900; margin-bottom: 15px;">INJECT FUNDS</div>
            <input type="number" id="deposit-amount" placeholder="Amount (ï¿¥)" style="width: 100%; padding: 10px; border: 1px solid #000; font-family: 'Cinzel'; font-weight: bold; font-size: 16px; margin-bottom: 10px;">
            <input type="text" id="deposit-note" placeholder="Memo (Optional)" style="width: 100%; padding: 10px; border: 1px solid #ccc; font-size: 12px; margin-bottom: 15px;">
            <button onclick="executeDeposit()" class="minimal-black-btn" style="width: 100%;">CONFIRM</button>
        </div>
    </div>
</div>
<div id="modal-manual-goal" class="industrial-modal-overlay" style="z-index: 710000; display: none;">
    <div class="industrial-modal-box" style="width: 85%; max-width: 350px; background: #fff; border: 3px solid #000; padding: 25px;">
        
        <div style="font-family: 'Cinzel'; font-weight: 900; font-size: 18px; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
            DEFINE PROTOCOL
        </div>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <label style="font-size: 10px; font-weight: bold; display: block; margin-bottom: 5px;">PROTOCOL NAME (è®¡åˆ’åç§°)</label>
                <input type="text" id="manual-goal-title" placeholder="Ex: é€ƒç¦»åœ°çƒåŸºé‡‘" style="width: 100%; padding: 12px; border: 1px solid #000; font-size: 14px;">
            </div>

            <div>
                <label style="font-size: 10px; font-weight: bold; display: block; margin-bottom: 5px;">TARGET AMOUNT (ç›®æ ‡é‡‘é¢)</label>
                <div style="position: relative;">
                    <span style="position: absolute; left: 12px; top: 12px; font-weight: bold;">ï¿¥</span>
                    <input type="number" id="manual-goal-target" placeholder="50000" style="width: 100%; padding: 12px 12px 12px 30px; border: 1px solid #000; font-family: 'Cinzel'; font-weight: bold; font-size: 16px;">
                </div>
            </div>

            <div>
                <label style="font-size: 10px; font-weight: bold; display: block; margin-bottom: 5px;">DESCRIPTION (å¤‡æ³¨)</label>
                <textarea id="manual-goal-desc" rows="3" placeholder="å†™ç»™è‡ªå·±çš„ä¸€å¥è¯..." style="width: 100%; padding: 10px; border: 1px solid #ccc; font-size: 12px; resize: none;"></textarea>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button onclick="document.getElementById('modal-manual-goal').style.display='none'" class="minimal-white-btn" style="flex: 1;">CANCEL</button>
            <button onclick="confirmManualGoal()" class="minimal-black-btn" style="flex: 1;">CONFIRM</button>
        </div>

    </div>
</div>

<div id="modal-sim-create" class="industrial-modal-overlay" style="z-index: 800000; display: none;">
    <div class="industrial-modal-box full-box" style="height: auto; max-height: 80vh; background: #000; color: #fff; border: 2px solid #fff;">
        <header class="modal-header-bw" style="background:#000; color:#fff; border-bottom: 1px solid #333;">
            <span>ACCESS_REQUEST</span>
            <div class="close-x" onclick="closeSimCreateModal()">Ã—</div>
        </header>
        
        <div style="padding: 20px;">
            <div id="sim-mode-random">
                <div class="matrix-grid" id="random-number-grid">
                    </div>
                <button onclick="generateRandomBatch()" class="minimal-white-btn" style="margin-top:20px;">
                    â†» REFRESH_BATCH (æ¢ä¸€æ‰¹)
                </button>
                <div style="text-align:center; margin: 15px 0; font-size: 10px; opacity: 0.5;">- OR -</div>
                <button onclick="switchSimMode('manual')" class="minimal-black-btn" style="border:1px solid #fff;">
                    MANUAL INPUT (æ‰‹åŠ¨è¾“å…¥)
                </button>
            </div>

            <div id="sim-mode-manual" style="display:none;">
                <input type="text" id="manual-sim-input" placeholder="Enter 8-15 digits..." maxlength="15" 
                       style="width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 15px; font-family: 'Cinzel'; font-size: 18px; text-align: center;">
                <button onclick="saveNewSim(document.getElementById('manual-sim-input').value)" class="minimal-white-btn" style="margin-top: 20px;">
                    CONFIRM ACTIVATION
                </button>
                <button onclick="switchSimMode('random')" class="danger-text-btn" style="margin-top: 10px; width:100%; text-align:center;">BACK TO RANDOM</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-ai-plans" class="industrial-modal-overlay" style="z-index: 810000; display: none;">
    <div class="industrial-modal-box" style="width: 90%; max-width: 400px; background: #f4f4f4; border: 3px solid #000;">
        <div style="padding: 15px; border-bottom: 2px solid #000; background: #fff;">
            <div class="cinzel-font" style="font-weight:900;">PROTOCOL_GENERATOR</div>
            <div style="font-size: 10px; color: #666;">Linking to Entity Persona...</div>
        </div>
        
        <div id="ai-plan-container" style="padding: 15px; display: flex; flex-direction: column; gap: 10px; min-height: 200px;">
            <div class="scan-bar-anim" style="margin: 50px auto;"></div>
        </div>

        <div style="padding: 15px; border-top: 2px solid #000; display: flex; gap: 10px;">
            <button onclick="closeAiPlans()" class="minimal-white-btn" style="flex:1;">CANCEL</button>
            <button onclick="triggerAiPlanGen()" class="minimal-black-btn" style="flex:1;">â†» REGENERATE</button>
        </div>
    </div>
</div>

<div id="modal-direct-topup" class="industrial-modal-overlay" style="z-index: 820000; display: none;">
    <div class="industrial-modal-box" style="width: 80%; background: #fff; border: 3px solid #000; padding: 20px;">
        <div class="cinzel-font" style="font-size:18px; margin-bottom:15px;">DIRECT CHARGE</div>
        <input type="number" id="topup-amount-inp" placeholder="Amount (ï¿¥)" class="npc-edit-input" style="font-size: 20px; font-weight: bold;">
        <button onclick="executeDirectTopUp()" class="minimal-black-btn" style="margin-top: 15px;">PAY NOW</button>
        <button onclick="document.getElementById('modal-direct-topup').style.display='none'" class="minimal-white-btn" style="margin-top: 10px; border:none;">CANCEL</button>
    </div>
</div>

<div id="modal-sim-history" class="industrial-modal-overlay" style="z-index: 850000; display: none;">
    <div class="industrial-modal-box full-box" style="height: 70vh; background: #0a0a0a; border: 2px solid #333; color: #ccc;">
        
        <header class="modal-header-bw" style="background: #111; border-bottom: 1px solid #333; padding: 15px;">
            <div style="display:flex; flex-direction:column;">
                <span style="font-family:'Cinzel'; color:#fff; font-size:16px;">DATA_LOGS</span>
                <span style="font-size:10px; color:#666; font-family:monospace;" id="sh-sim-number">TARGET: UNKNOWN</span>
            </div>
            <div class="close-x" onclick="document.getElementById('modal-sim-history').style.display='none'" style="color:#fff;">Ã—</div>
        </header>

        <div class="modal-body scroll-body" id="sim-history-list" style="padding: 0; background: #000;">
            </div>

        <div style="padding: 15px; border-top: 1px solid #333; background: #111; display:flex; justify-content:space-between; font-family:monospace; font-size:10px;">
            <span>STATUS: CONNECTED</span>
            <span style="color: #4ade80;">END_OF_STREAM</span>
        </div>
    </div>
</div>
<div id="modal-char-topup" class="char-topup-overlay" style="display: none;">
    <div class="char-topup-box">
        <div class="char-topup-header">
            <div class="ct-title-text">ENTITY RECHARGE</div>
            <div class="ct-close-btn" onclick="closeCharTopUp()">Ã—</div>
        </div>
        
        <div style="text-align:center; margin: 25px 0;">
            <img id="ct-avatar" src="" style="width: 60px; height: 60px; border-radius: 50%;">
            <div id="ct-name" style="font-family:'Cinzel'; font-size:18px; margin-top:12px; color:#fff;">CHARACTER</div>
            <div id="ct-number" style="font-family:monospace; color:#007aff; letter-spacing:2px; font-size:10px; margin-top:5px;">NO_SIGNAL</div>
        </div>

        <div class="ct-input-group">
            <label>TRANSFER AMOUNT (ï¿¥)</label>
            <input type="number" id="ct-amount-inp" placeholder="100.00" class="ct-input">
        </div>

        <button onclick="executeCharTopUp()" class="ct-confirm-btn">
            INITIATE TRANSFER
        </button>
    </div>
</div>
<div id="modal-bill-detail" class="industrial-modal-overlay" style="display: none;">
    <div class="industrial-modal-box">
        
        <div class="receipt-header-area">
            <div style="font-family: 'Cinzel'; font-weight: 900; font-size: 22px; color: #000;">LUNE TELECOM</div>
            <div style="font-size: 10px; letter-spacing: 2px; margin-top: 5px; color: #555;">OFFICIAL INVOICE</div>
            <div style="margin-top: 15px; font-size: 10px; color: #888;">
                DATE: <span id="receipt-date">--/--</span><br>
                REF: <span id="receipt-ref">#0000</span>
            </div>
        </div>

        <div id="bill-detail-content">
            </div>

        <div class="receipt-footer-area">
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; color: #000;">
                <span>TOTAL</span>
                <span id="bill-detail-total">ï¿¥0.00</span>
            </div>
            <div style="font-size: 9px; text-align: center; margin-top: 15px; color: #888;">
                THANK YOU FOR USING LUNE NET<br>
                KEEP THIS RECEIPT FOR YOUR RECORDS
            </div>
            
            <button onclick="closeBillDetail()" style="width: 100%; margin-top: 15px; background: #000; color: #fff; border: none; padding: 12px; font-family: monospace; cursor: pointer;">
                CLOSE RECEIPT
            </button>
        </div>

    </div>
</div>

<div id="modal-low-balance" class="industrial-modal-overlay" style="z-index: 1000000; display: none;">
    <div class="industrial-modal-box" style="width: 85%; max-width: 320px; border: 2px solid #ff3b30; background: #000;">
        <div style="text-align: center; color: #ff3b30;">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <div style="font-family: 'Cinzel'; font-weight: 900; font-size: 18px; margin-top: 10px;">TRANSACTION FAILED</div>
            <div style="font-size: 10px; color: #fff; margin-top: 5px; opacity: 0.8;">
                INSUFFICIENT SIM BALANCE<br>
                æ‰£è´¹å¤±è´¥ï¼šè§’è‰² SIM å¡ä½™é¢ä¸è¶³
            </div>
        </div>

        <div style="margin-top: 20px; font-size: 12px; color: #ccc; text-align: center; line-height: 1.4;">
            æ— æ³•ç”Ÿæˆä»Šæ—¥è´¦å•ã€‚<br>æ‚¨å¯ä»¥å‘é€æé†’ï¼Œè¦æ±‚å¯¹æ–¹å……å€¼ã€‚
        </div>

        <div style="margin-top: 25px; display: flex; gap: 10px;">
            <button onclick="closeLowBalanceModal()" class="minimal-white-btn" style="flex: 1; border: 1px solid #333;">CANCEL</button>
            <button onclick="sendTopUpReminder()" class="minimal-black-btn" style="flex: 1; background: #ff3b30; border: none; color: #fff;">
                REMIND (æé†’)
            </button>
        </div>
    </div>
</div>
<div id="modal-call-content">
    <div class="call-content-box">
        <div class="cc-header">
            <div id="cc-caller" class="cc-caller-name">UNKNOWN</div>
            <div class="cc-meta-row">
                <span id="cc-number">NO. ---</span>
                <span id="cc-duration">00:00</span>
            </div>
            <div style="font-size:9px; color:#444; margin-top:5px; text-transform:uppercase;">
                SECURE_LINE_ID: <span id="cc-id">...</span>
            </div>
        </div>

        <div id="cc-body-container" class="cc-body">
            </div>

        <div id="cc-loader" class="decrypt-overlay" style="display:none;">
            <div class="sound-wave">
                <div class="wave-bar" style="animation-delay: 0.1s"></div>
                <div class="wave-bar" style="animation-delay: 0.2s"></div>
                <div class="wave-bar" style="animation-delay: 0.3s"></div>
                <div class="wave-bar" style="animation-delay: 0.4s"></div>
                <div class="wave-bar" style="animation-delay: 0.5s"></div>
            </div>
            <div id="cc-loading-text" class="decrypt-text">DECRYPTING AUDIO STREAM...</div>
        </div>

        <div class="cc-close-btn" onclick="document.getElementById('modal-call-content').style.display='none'">
            TERMINATE_CONNECTION
        </div>
    </div>
</div>
<div id="modal-reminder-sent">
    <div class="sent-log-box">
        <div class="sent-header">
            <span>TRANSMISSION LOG</span>
            <span style="font-size:10px; opacity:0.7;">âœ“ SENT</span>
        </div>
        <div id="sent-log-list" class="sent-list">
            </div>
        <button class="sent-close-btn" onclick="document.getElementById('modal-reminder-sent').style.display='none'">
            CONFIRM & CLOSE
        </button>
    </div>
</div>
<div id="universal-modal" class="editor-modal" style="display: none;">
    <div class="editor-content">
        <h3 id="editor-title">Edit Content</h3>
        
        <div id="editor-type-text" style="display: none;">
            <input type="text" id="editor-input-text" placeholder="è¯·è¾“å…¥å†…å®¹..." class="editor-input">
        </div>

        <div id="editor-type-image" style="display: none;">
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchTab('url')">ç½‘ç»œé“¾æ¥</button>
                <button class="tab-btn" onclick="switchTab('file')">æœ¬åœ°æ–‡ä»¶</button>
            </div>
            
            <div id="tab-content-url">
                <input type="text" id="editor-input-url" placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥ (https://...)" class="editor-input">
            </div>
            
            <div id="tab-content-file" style="display: none; text-align: center; padding: 10px;">
                <input type="file" id="editor-input-file" accept="image/*" style="display: none;" onchange="previewFile()">
                <label for="editor-input-file" class="file-upload-btn">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
                <div id="file-name-display" style="font-size: 12px; color: #666; margin-top: 8px;">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>
        </div>

        <div class="editor-buttons">
            <button class="btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn-save" onclick="saveEditorData()">ä¿å­˜</button>
        </div>
    </div>
</div>
<div id="app-lost-found-v2" style="display: none;">
    
    <div class="lf-v2-nav">
        <div class="lf-v2-logo">Lost & Found</div>
        <div class="lf-v2-close" onclick="closeLostFoundApp()">Ã—</div>
    </div>

    <div class="lf-v2-main">
        
        <div id="lf-page-shelf" class="lf-v2-page">
            <div class="lf-v2-section-title">æˆ‘çš„ä¹¦æ¶</div>
            </div>

        <div id="lf-page-studio" class="lf-v2-page active">
    
        <div class="lf-studio-header">
            <div class="lf-studio-title">å·¥ä½œå°</div>
            <div style="font-size:12px; color:#999; font-family:monospace;">ID: AUTHOR_001</div>
        </div>

        <div class="lf-studio-stats">
            <div class="lf-stat-card">
                <div class="lf-stat-num" id="stat-books">0</div>
                <div class="lf-stat-label">BOOKS CREATED</div>
            </div>
            <div class="lf-stat-card">
                <div class="lf-stat-num" id="stat-words">0</div>
                <div class="lf-stat-label">TOTAL WORDS</div>
            </div>
            <div class="lf-stat-card">
                <div class="lf-stat-num" id="stat-chapters">0</div>
                <div class="lf-stat-label">TOTALCHAPTERS</div>
            </div>
        </div>

        <div class="lf-v2-section-title">æˆ‘çš„ä½œå“</div>
        
        <div class="lf-draft-list" id="lf-draft-list-container">
            </div>

        <div class="lf-fab-create" onclick="openWizard()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </div>

    </div>

    <div class="lf-v2-tabbar">
        <div class="lf-v2-tab-item" onclick="switchLfTab('shelf', this)">
            <div class="lf-v2-tab-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
            </div>
            <div class="lf-v2-tab-dot"></div>
        </div>

        <div class="lf-v2-tab-item active" onclick="switchLfTab('studio', this)">
            <div class="lf-v2-tab-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </div>
            <div class="lf-v2-tab-dot"></div>
        </div>

        <div class="lf-v2-tab-item" onclick="switchLfTab('forum', this)">
            <div class="lf-v2-tab-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </div>
            <div class="lf-v2-tab-dot"></div>
        </div>
    </div>

</div>
<div id="lf-wizard-page">
    
    <div class="lfw-header">
        <div class="lfw-back-btn" onclick="wizardPrevStep()">
            <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </div>
        <div class="lfw-title">New Project</div>
        
        <button class="lfw-create-btn" id="lfw-final-btn" onclick="finishBookCreation()">
            Create
        </button>
    </div>
    
    <div class="lfw-progress-track">
        <div class="lfw-progress-bar" id="lfw-progress"></div>
    </div>

    <div class="lfw-track" id="lfw-track">
        
        <div class="lfw-step">
            <div class="lfw-step-inner">
                <div class="lfw-step-header">
                    <span class="lfw-step-num">Step 01</span>
                    <div class="lfw-step-title">Story Core</div>
                    <div class="lfw-step-desc">ä¸€åˆ‡å§‹äºä¸€ä¸ªå¿µå¤´ã€‚æè¿°ä½ çš„æ•…äº‹ï¼Œæˆ–è®© AI ä¸ºä½ æä¾›çµæ„Ÿã€‚</div>
                </div>

                <textarea class="lfw-input" rows="4" placeholder="e.g. A detective discovers his own name on the victim list..."></textarea>

                <div class="lfw-btn-row">
                    <button class="lfw-btn lfw-btn-outline" onclick="generateStoryCore()">
                        <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M12 2a10 10 0 0 1 10 10h-10z" opacity="0.5"></path></svg>
                        AI Generate
                    </button>
                    
                    <button class="lfw-btn lfw-btn-black" onclick="useMyStoryCore()">Use Mine</button>
                </div>

                <div class="lfw-card" style="margin-top:24px; display:none;" id="card-step1">
                </div>
            </div>
        </div>

        <div class="lfw-step">
            <div class="lfw-step-inner">
                <div class="lfw-step-header">
                    <span class="lfw-step-num">Step 02</span>
                    <div class="lfw-step-title">Book Title</div>
                    <div class="lfw-step-desc">ä¸€ä¸ªå¥½çš„ä¹¦åæ˜¯æˆåŠŸçš„ä¸€åŠã€‚è®© AI åŸºäºä½ çš„ç®€ä»‹æä¾›çµæ„Ÿã€‚</div>
                </div>

                <input type="text" id="step2-input-title" class="lfw-input" placeholder="æ‰‹åŠ¨è¾“å…¥ä¹¦å (æˆ–ç‚¹å‡»ä¸‹æ–¹ç”Ÿæˆ)..." oninput="resetStep2Selection()">
                
                <button class="lfw-btn lfw-btn-outline" style="width:100%" onclick="generateBookTitles()">
                    <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path></svg>
                    Generate Title by Story
                </button>

                <div class="lfw-title-tag" id="card-step2" style="display:none;">
                    <div style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#000; color:#fff; font-size:10px; padding:2px 8px; border-radius:4px;">AI RECOMMENDED</div>
                    
                    <div class="lfw-title-text" id="step2-result-text">...</div>
                    
                    <div class="lfw-btn-row" style="margin-top:20px;">
                        <button class="lfw-btn lfw-btn-outline" style="border:none; background:transparent;" onclick="swapBookTitle()">
                            <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                            Swap
                        </button>
                        <button class="lfw-btn lfw-btn-black" onclick="confirmBookTitle()">
                            <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            Confirm
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="lfw-step">
            <div class="lfw-step-inner">
                <div class="lfw-step-header">
                    <span class="lfw-step-num">Step 03</span>
                    <div class="lfw-step-title">Tone & Style</div>
                    <div class="lfw-step-desc">å†³å®šæ–‡å­—çš„è´¨æ„Ÿã€‚è¿™æ˜¯æœªæ¥å†™ä½œçš„<b>æœ€é«˜æŒ‡ä»¤</b>ã€‚</div>
                </div>

                <div style="background:#fff; padding:16px; border-radius:12px; border:1px solid #eee; margin-bottom:20px;">
                    <label style="font-size:11px; font-weight:700; color:#999; margin-bottom:8px; display:block;">CUSTOM STYLE (OPTIONAL)</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="step3-input-style" class="lfw-input" style="margin:0;" placeholder="e.g. èµ›åšæœ‹å…‹ / åƒæ‘ä¸Šæ˜¥æ ‘ / å“¥ç‰¹å¼æ‚¬ç–‘...">
                        <button class="lfw-btn lfw-btn-black" style="flex:0 0 100px;" onclick="generateManualStyle()">
                            è¯•å†™
                        </button>
                    </div>
                    <div style="text-align:center; margin:10px 0; font-size:12px; color:#ccc;">â€” OR â€”</div>
                    <button class="lfw-btn lfw-btn-outline" style="width:100%" onclick="generateAutoStyle()">
                        <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path></svg>
                        Auto-Recommend based on Story
                    </button>
                </div>

                <div class="lfw-card" id="card-step3" style="display:none; transition:0.3s;">
                    </div>
                
                <div id="step3-status-bar" style="margin-top:12px; padding:10px; background:#e8f5e9; color:#2e7d32; border-radius:8px; font-size:12px; display:none; align-items:center; gap:8px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    <span>å·²é€‰æ‹©ï¼š<b id="step3-selected-name"></b></span>
                </div>
            </div>
        </div>

        <div class="lfw-step">
            <div class="lfw-step-inner">
                <div class="lfw-step-header">
                    <span class="lfw-step-num">Step 04</span>
                    <div class="lfw-step-title">Cast & Characters</div>
                    <div class="lfw-step-desc">æ„å»ºä½ çš„æ ¸å¿ƒç­åº•ã€‚è¯·æ³¨æ„ï¼š<b>é‡è¦äººç‰©æ€»æ•°</b> å¿…é¡»åŒ…å« CP ä¸­çš„æ‰€æœ‰äººæ•°ï¼ˆ1å¯¹CP = 2äººï¼‰ã€‚</div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:11px; font-weight:700;">CP PAIRS (å¯¹)</label>
                        <input type="number" id="step4-cp-count" class="lfw-input" value="1" min="0" style="margin-top:4px;">
                    </div>
                    <div>
                        <label style="font-size:11px; font-weight:700;">TOTAL VIPs (äºº)</label>
                        <input type="number" id="step4-total-count" class="lfw-input" value="3" min="1" style="margin-top:4px;">
                    </div>
                </div>
                
                <div id="step4-warning" style="color:#ff3b30; font-size:12px; margin-bottom:12px; display:none;">
                    âš ï¸ é€»è¾‘é”™è¯¯ï¼šæ€»äººæ•°ä¸èƒ½å°‘äº CP äººæ•° (CPå¯¹æ•° Ã— 2)ã€‚
                </div>

                <button class="lfw-btn lfw-btn-black" style="width:100%; margin-bottom:24px;" onclick="startCharGeneration()">
                    Start Generation Sequence
                </button>

                <div id="step4-dynamic-area">
                    <div style="text-align:center; color:#ccc; font-size:12px; padding:40px; border:2px dashed #eee; border-radius:12px;">
                        Waiting to start...
                    </div>
                </div>

                <input type="file" id="step4-avatar-upload" style="display:none;" accept="image/*" onchange="handleAvatarUpload(this)">
            </div>
        </div>

        <div class="lfw-step">
            <div class="lfw-step-inner">
                <div class="lfw-step-header">
                    <span class="lfw-step-num">Step 05</span>
                    <div class="lfw-step-title">Relation Web</div>
                    <div class="lfw-step-desc">åŸºäº Step 4 å…¥åº“çš„è§’è‰²ï¼ŒAI å°†åˆ†æå¹¶æ„å»ºä»–ä»¬ä¹‹é—´çš„ç¾ç»Šã€‚</div>
                </div>

                <button class="lfw-btn lfw-btn-black" style="width:100%; margin-bottom:20px;" onclick="generateRelationWeb()">
                    <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    Analyze & Build Web
                </button>

                <div class="lfw-relation-box" id="lfw-relation-canvas">
                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:#ccc;">
                        <div style="font-size:30px; opacity:0.3;">ğŸ•¸ï¸</div>
                        <div style="font-size:12px; margin-top:5px;">Waiting for analysis...</div>
                    </div>
                </div>

                <div style="font-size:10px; font-weight:700; color:#999; margin:20px 0 8px 0; letter-spacing:1px;">RELATIONSHIP DETAILS</div>
                <div id="lfw-relation-list">
                    </div>

                <button class="lfw-btn lfw-btn-outline" style="width:100%; margin-top:20px;" onclick="wizardNextStep()">
                    Looks Good, Next Step
                </button>
            </div>
        </div>

        <div class="lfw-step">
            <div class="lfw-step-inner">
                <div class="lfw-step-header">
                    <span class="lfw-step-num">Step 06</span>
                    <div class="lfw-step-title">World Optimization</div>
                    <div class="lfw-step-desc">æ˜¯å¦éœ€è¦ AI è¡¥å……æ½œåœ¨çš„ç¤¾ä¼šå…³ç³»èŠ‚ç‚¹ï¼ˆå¦‚çˆ¶æ¯ã€ä¸Šå¸ã€å®¿æ•Œï¼‰ä»¥ä¸°æ»¡ä¸–ç•Œè§‚ï¼Ÿ</div>
                </div>

                <div class="lfw-relation-box" id="lfw-opt-canvas" style="height:320px;">
                    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:#ccc;">
                        <div style="font-size:12px;">Waiting for command...</div>
                    </div>
                </div>

                <div id="lfw-opt-list" style="margin-top:10px;"></div>

                <div class="lfw-btn-row" style="margin-top:20px;">
                    <button class="lfw-btn lfw-btn-outline" onclick="skipOptimization()">
                        Skip (Keep Basic)
                    </button>
                    <button class="lfw-btn lfw-btn-black" onclick="generateOptimization()">
                        <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                        AI Deep Expand
                    </button>
                </div>

                <button id="lfw-step6-confirm" class="lfw-btn lfw-btn-black" style="width:100%; margin-top:12px; display:none;" onclick="confirmStep6()">
                    Confirm & Save
                </button>
            </div>
        </div>

        <div class="lfw-step">
            <div class="lfw-step-inner">
                <div class="lfw-step-header">
                    <span class="lfw-step-num">Step 07</span>
                    <div class="lfw-step-title">Final Specs</div>
                    <div class="lfw-step-desc">è®¾å®šç¯‡å¹…è§„æ ¼ã€‚ç¡®è®¤æ— è¯¯åï¼Œç‚¹å‡»å³ä¸Šè§’ "Create" å¯åŠ¨ä¸–ç•Œã€‚</div>
                </div>

                <div class="lfw-slider-row">
                    <div class="lfw-slider-label">
                        <span>Total Chapters</span>
                        <span id="disp-chapters" style="font-family:monospace; font-size:16px;">50</span>
                    </div>
                    <input type="range" id="input-chapters" class="lfw-slider" 
                        min="10" max="500" step="10" value="50" 
                        oninput="updateSpecData()">
                    <div style="display:flex; justify-content:space-between; font-size:10px; color:#ccc; margin-top:4px;">
                        <span>10</span>
                        <span>500</span>
                    </div>
                </div>

                <div class="lfw-slider-row" style="margin-top:30px;">
                    <div class="lfw-slider-label">
                        <span>Words per Chapter</span>
                        <span id="disp-words" style="font-family:monospace; font-size:16px;">3,000</span>
                    </div>
                    <input type="range" id="input-words" class="lfw-slider" 
                        min="1000" max="10000" step="500" value="3000" 
                        oninput="updateSpecData()">
                    <div style="display:flex; justify-content:space-between; font-size:10px; color:#ccc; margin-top:4px;">
                        <span>1k</span>
                        <span>10k</span>
                    </div>
                </div>

                <div style="background:#f9f9f9; border:1px dashed #ccc; padding:16px; border-radius:12px; margin-top:20px; text-align:center;">
                    <div style="font-size:10px; font-weight:700; color:#999; letter-spacing:1px; margin-bottom:4px;">ESTIMATED TOTAL LENGTH</div>
                    <div id="disp-total" style="font-size:24px; font-weight:800; color:#333; font-family:'Songti SC', serif;">150,000 å­—</div>
                </div>

                <div style="margin-top:50px; text-align:center; opacity:0.5; transition:opacity 0.5s;" id="lfw-ready-area">
                    <div style="width:60px; height:60px; margin:0 auto; border-radius:50%; border:2px solid #000; display:flex; align-items:center; justify-content:center; margin-bottom:16px;">
                        <svg class="lfw-icon" style="width:30px; height:30px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
                            <path d="M12 15l-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
                            <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
                            <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
                        </svg>
                    </div>
                    <div style="font-weight:700; font-size:16px;">System Ready</div>
                    <div style="font-size:12px; color:#999; margin-top:4px;">Settings Saved to Database</div>
                </div>
                
                <div style="height:60px;"></div>
            </div>
        </div>

    </div>

    <div class="lfw-bottom-bar" style="justify-content: space-between;">
    
        <button class="lfw-prev-btn" onclick="wizardPrevStep()">
            <svg class="lfw-icon" style="width:20px; height:20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back
        </button>

        <button class="lfw-next-btn" onclick="wizardNextStep()">
            Next Step
            <svg class="lfw-icon" style="width:20px; height:20px;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline>
            </svg>
        </button>
    </div>

</div>
<div id="lf-editor-dashboard">
    
    <div class="lfe-nav">
        <div class="lfe-icon-btn" onclick="closeDashboard()">
            <svg class="lfe-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </div>
        
        <button class="lfe-pub-btn draft" id="lfe-publish-toggle" onclick="togglePublishStatus()">
            <span class="lfe-pub-badge"></span>
            <span id="lfe-pub-text">Publish</span>
            <svg class="lfe-icon" id="lfe-pub-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
        </button>
    </div>

    <div class="lfe-scroll">
        
        <div class="lfe-hero">
            <div class="lfe-cover-box" id="lfe-cover-box" onclick="document.getElementById('lfe-cover-input').click()">
                <div id="lfe-cover-placeholder">COVER</div>
                <div class="lfe-cover-overlay">
                    <svg class="lfe-icon" style="color:#fff;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                    <span style="margin-top:4px;">CHANGE</span>
                </div>
            </div>
            <input type="file" id="lfe-cover-input" hidden accept="image/*" onchange="uploadCover(this)">

            <div class="lfe-meta-col">
                <div class="lfe-book-title" id="lfe-book-title" contenteditable="true" spellcheck="false" onblur="saveDashboardTitle(this)"></div>
                
                <div class="lfe-synopsis-box" onclick="editDashboardSynopsis()">
                    <div class="lfe-synopsis-text" id="lfe-synopsis-text"></div>
                    <div class="lfe-edit-hint">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </div>
                </div>

                <div class="lfe-tag-row" id="lfe-tags-container">
                    </div>
            </div>
        </div>

        <div class="lfe-section-header">
            <span class="lfe-sec-title">CAST & CHARACTERS</span>
            <span class="lfe-sec-action">Synced <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg></span>
        </div>
        
        <div class="lfe-char-rail" id="lfe-char-rail">
            </div>

        <div class="lfe-section-header">
            <span class="lfe-sec-title">TABLE OF CONTENTS</span>
        </div>
        
        <div class="lfe-toc-list" id="lfe-toc-list">
             <div style="text-align:center; padding:30px; color:#ccc; font-size:12px; border:1px dashed #eee; border-radius:8px;">
                Start writing Chapter 1...
            </div>
        </div>
        
        <div style="height:80px;"></div>
    </div>

    <div class="lfe-fab" onclick="window.addNewChapter()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </div>
</div>
<div id="lfe-ai-writing-overlay" style="display:none; position:fixed; inset:0; z-index:300000; background:#000; color:#fff; flex-direction:column; align-items:center; justify-content:center; font-family:'Songti SC', serif;">
    <div class="chamber-bg" style="position:absolute; inset:0; opacity:0.3; background:radial-gradient(circle at center, #222 0%, #000 100%);"></div>
    
    <div id="ai-status-tag" style="font-size:10px; border:1px solid #444; padding:4px 12px; border-radius:20px; letter-spacing:2px; color:#888; margin-bottom:20px; z-index:10;">INITIALIZING NEURAL ENGINE</div>
    
    <div style="position:relative; width:200px; height:200px; z-index:10;">
        <div class="ai-scan-circle"></div> <div id="ai-progress-text" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:800; font-family:monospace;">0%</div>
    </div>

    <div id="ai-writing-log" style="margin-top:30px; font-size:13px; color:#666; height:20px; text-align:center; z-index:10;">Loading story world...</div>
</div>

<script>
class ImmersiveReader {
    constructor(config) {
        this.bookInfo = config.bookInfo || { title: "æœªå‘½åä½œå“", cover: "", chapter: "Chapter 1", wordCount: "0 Words" };
        this.characters = config.characters || []; 
        this.script = config.script || []; 
        
        this.state = {
            pov: null,     
            head: 0,       
            isFinished: false
        };

        this.containerId = 'lf-immersive-container';
        this.init();
    }

    init() {
        const old = document.getElementById(this.containerId);
        if (old) old.remove();

        this.el = document.createElement('div');
        this.el.id = this.containerId;

        // ğŸš€ ä¿æŒæè‡´å±‚çº§
        Object.assign(this.el.style, {
            position: 'fixed',
            inset: '0',
            zIndex: '5000000',
            background: '#FFFFFF',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden'
        });

        document.body.appendChild(this.el);
        this.renderStructure();
    }

    renderStructure() {
        this.el.innerHTML = `
            <div class="lfw-header">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="lfw-cover-wrap" onclick="document.getElementById('lf-immersive-container').remove()">
                        <img src="${this.bookInfo.cover}" class="lfw-cover-img" onerror="this.style.display='none'">
                    </div>
                    <div class="lfw-info">
                        <div class="lfw-title">${this.bookInfo.title}</div>
                        <div class="lfw-meta">
                            <span class="lfw-tag">${this.bookInfo.chapter}</span>
                            <span>${this.bookInfo.wordCount}</span>
                        </div>
                    </div>
                </div>
                <div class="lfw-header-right">
                    <div class="lfw-star-btn" onclick="this.classList.toggle('active')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="lfw-stage" id="lfw-main-stage"></div>

            <div class="lfw-dock-layer">
                <div class="lfw-dock">
                    <button class="lfw-main-btn" id="lfw-act-btn">PROCEED</button>
                </div>
            </div>

            <div class="lfw-overlay" id="lfw-pov-layer">
                <div style="font-size:24px; font-weight:800; color:#111;">Choose Your POV</div>
                <div style="color:#888; margin-top:5px;">Who are you in this scene?</div>
                <div class="lfw-role-grid" id="lfw-role-list"></div>
            </div>
        `;

        document.getElementById('lfw-act-btn').onclick = () => this.playNext();

        const roleList = document.getElementById('lfw-role-list');
        this.characters.forEach(char => {
            const card = document.createElement('div');
            card.className = 'lfw-role-card';
            card.innerHTML = `<img src="${char.avatar}"><div style="font-weight:700; color:#333;">${char.name}</div>`;
            card.onclick = () => this.startGame(char.name);
            roleList.appendChild(card);
        });
    }

    startGame(roleName) {
        this.state.pov = roleName;
        const layer = document.getElementById('lfw-pov-layer');
        layer.style.opacity = '0';
        setTimeout(() => layer.style.display = 'none', 300);
        const stage = document.getElementById('lfw-main-stage');
        stage.innerHTML = ''; 
        setTimeout(() => this.playNext(), 50);
    }

    playNext() {
        if (this.state.head >= this.script.length) {
            document.getElementById('lfw-act-btn').innerText = "CHAPTER FINISHED";
            return;
        }

        const item = this.script[this.state.head];
        const stage = document.getElementById('lfw-main-stage');
        
        if (item.type === 'aside') {
            // æ—ç™½æ¸²æŸ“ (ä¿æŒåŸèƒ¶ç‰‡è®¾è®¡)
            const timeCode = `00:${(10 + this.state.head).toString().padStart(2,'0')}:${Math.floor(Math.random()*60).toString().padStart(2,'0')}`;
            stage.insertAdjacentHTML('beforeend', `
                <div class="lfw-aside-row">
                    <div class="lfw-trans-film">
                        <div class="lfw-tf-meta">
                            <div>REC <span class="lfw-tf-dot"></span></div>
                            <div>TC ${timeCode}</div>
                        </div>
                        <div class="lfw-tf-content">${item.text}</div>
                    </div>
                </div>
            `);
        } else {
            // --- æ ¸å¿ƒï¼šå¯¹è¯æ¸²æŸ“ ---
            const scriptName = (item.char || "").trim();
            const myPov = (this.state.pov || "").trim();
            
            // åˆ¤å®šï¼šå½“å‰è¯´è¯çš„äººæ˜¯ä¸æ˜¯ç”¨æˆ·é€‰æ‹©çš„è§’è‰²
            const isMe = scriptName === myPov;
            
            // è·å–å¤´åƒ
            const charObj = this.characters.find(c => (c.name || "").trim() === scriptName);
            let avatarHtml = "";
            if (charObj && charObj.avatar) {
                avatarHtml = `<img src="${charObj.avatar}" class="lfw-avatar">`;
            } else {
                // NPC é€»è¾‘
                const init = scriptName.charAt(0);
                avatarHtml = `<div class="lfw-avatar" style="display:flex;align-items:center;justify-content:center;font-weight:900;">${init}</div>`;
            }

            // æ„é€  HTMLï¼šisMe ä¸º true æ—¶åŠ ä¸Š "right" class
            const rowHtml = `
                <div class="lfw-row ${isMe ? 'right' : 'left'}">
                    ${!isMe ? avatarHtml : ''} 
                    <div class="lfw-bubble-wrap">
                        <div class="lfw-name" style="${isMe ? 'text-align:right' : ''}">${item.char}</div>
                        <div class="lfw-bubble">${item.text}</div>
                    </div>
                    ${isMe ? avatarHtml : ''}
                </div>
            `;
            stage.insertAdjacentHTML('beforeend', rowHtml);
        }

        stage.scrollTo({ top: stage.scrollHeight, behavior: 'smooth' });
        this.state.head++;
        
        const btn = document.getElementById('lfw-act-btn');
        if(btn) btn.innerText = `PROCEED (${this.script.length - this.state.head})`;
    }
}

/**
 * ğŸ›°ï¸ å¼•ç”¨å‡†å¤‡åè®® (é’ˆå¯¹ä½ çš„ HTML ç»“æ„å®šåˆ¶)
 */
window.prepareQuote = function(text, sender) {
    console.log("System: æ­£åœ¨æ ¡å‡†å¼•ç”¨è½¨é“...", {sender, text});

    // 1. æš‚å­˜æ•°æ®
    window.currentQuoteData = { text: text, sender: sender };

    // 2. ç²¾å‡†å®šä½ä½ çš„ HTML å…ƒç´ 
    const bar = document.getElementById('quote-preview');      // ä½ çš„æ€»å®¹å™¨ ID
    const userEl = document.getElementById('quote-preview-user'); // ä½ çš„æ˜µç§° ID
    const textEl = document.getElementById('quote-preview-text'); // ä½ çš„å†…å®¹ ID

    if (bar && userEl && textEl) {
        // 3. ç‰©ç†å¡«å€¼
        userEl.innerText = sender;
        textEl.innerText = text;
        
        // 4. å¼ºåˆ¶æ˜¾ç¤º (æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ flex ç¡®ä¿ä½ çš„æ ·å¼ä¸èµ°æ ·)
        bar.style.display = 'flex'; 
        
        // 5. è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
        const input = document.getElementById('chat-input-main');
        if (input) input.focus();
    } else {
        console.error("âŒ å¼•ç”¨å¤±è´¥ï¼šè¯·æ£€æŸ¥ HTML ä¸­æ˜¯å¦å­˜åœ¨ id='quote-preview'");
    }
};

/**
 * ğŸ›°ï¸ å–æ¶ˆå¼•ç”¨åè®®
 */
window.cancelQuote = function() {
    window.currentQuoteData = null;
    const bar = document.getElementById('quote-preview');
    if (bar) bar.style.display = 'none'; // éšè—é¢„è§ˆæ¡
};

/**
 * ğŸ“š 1. è—çé˜æ¸²æŸ“å¼•æ“ï¼šåŒæ­¥æ•°æ®åº“å¹¶æ¸²æŸ“å†…å®¹
 */
window.renderBookshelf = async function() {
    const shelfPage = document.getElementById('lf-page-shelf');
    if (!shelfPage) return;

    // A. ä» IndexedDB è¯»å–æœ€æ–°æ•°æ®
    const works = await window.ib.getItem('lf_global_works_v1') || [];
    
    // B. æ•°æ®ç»Ÿè®¡ (ç”¨äºé¡¶éƒ¨çœ‹æ¿)
    const publishedWorks = works.filter(w => w.status === 'published' || w.status === 'serial');
    const totalChapters = publishedWorks.reduce((s, w) => s + (w.chapters ? w.chapters.length : 0), 0);

    // C. æ„é€ å¡ç‰‡ HTML
    const cardHtml = publishedWorks.map((book, originalIndex) => {
        // æŸ¥æ‰¾åœ¨åŸå§‹æ•°ç»„ä¸­çš„çœŸå®ç´¢å¼• (ç”¨äº openDashboard)
        const realIndex = works.findIndex(w => w.id === book.id);
        const progress = book.totalChapter > 0 ? (book.currentChapter / book.totalChapter) * 100 : 0;
        const tags = book.tags && book.tags.length > 0 ? book.tags : ["Lune", "Archive"];
        
        return `
            <div class="lfs-rich-card" onclick="openDashboard(${realIndex})">
                <div class="lfs-book-vessel">
                    <div class="lfs-book-spine"></div>
                    ${book.coverImage ? `<img src="${book.coverImage}">` : `<div style="height:100%;background:#f0f0f0;"></div>`}
                </div>
                <div class="lfs-content-vessel">
                    <div>
                        <div style="display:flex; justify-content:space-between;">
                            <div class="lfs-book-title">${book.title}</div>
                            <div style="font-size:10px; color:#ccc;">#${book.id.substring(book.id.length-4)}</div>
                        </div>
                        <div class="lfs-book-synopsis">${book.fullSynopsis || book.synopsis || "è¿™ä¸ªä¸–ç•Œçš„æ•…äº‹å°šæœªè¢«è®°å½•..."}</div>
                        <div class="lfs-tag-cloud">
                            ${tags.slice(0,3).map(t => `<span class="lfs-mini-tag">${t}</span>`).join('')}
                        </div>
                    </div>
                    <div class="lfs-card-footer">
                        <div class="lfs-meta-data">${book.currentChapter} / ${book.totalChapter} CHAPS</div>
                        <div class="lfs-progress-container">
                            <div class="lfs-progress-bar" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // D. å®Œæ•´ç»„è£…æ¸²æŸ“
    shelfPage.innerHTML = `
        <div class="lfs-top-dashboard">
            <div class="lfs-brand">LUNE ARCHIVE</div>
            <div class="lfs-total-stats">
                <div class="lfs-stat-box">
                    <div class="lfs-stat-num">${publishedWorks.length}</div>
                    <div class="lfs-stat-lab">Worlds</div>
                </div>
                <div class="lfs-stat-box">
                    <div class="lfs-stat-num">${totalChapters}</div>
                    <div class="lfs-stat-lab">Chaps</div>
                </div>
            </div>
        </div>
        <div class="lf-v2-section-title">Collections</div>
        <div class="lfs-desc-line">â€œEvery world is a vessel of thought, waiting to be sailed.â€</div>
        <div class="lfs-collection-flow">
            ${cardHtml || '<div style="text-align:center; color:#ccc; padding:100px 0;">è—çé˜æš‚æ— è—å“ï¼Œè¯·å…ˆåœ¨å·¥ä½œå®¤å‘å¸ƒä½œå“</div>'}
        </div>
    `;
};

/**
 * ğŸš€ 2. å‘å¸ƒæŒ‰é’®é€»è¾‘ï¼šä¿®æ”¹çŠ¶æ€å¹¶åŒæ­¥ä¹¦æ¶
 */
window.handlePublishAction = async function() {
    if (currentBookIndex === -1) return;
    
    // 1. è·å–å½“å‰ä¹¦ç±å¹¶æ ‡è®°çŠ¶æ€
    const works = await window.ib.getItem('lf_global_works_v1') || [];
    const book = works[currentBookIndex];
    
    book.status = "published"; // æ ‡è®°ä¸ºå‘å¸ƒçŠ¶æ€
    
    // 2. å­˜å…¥æ•°æ®åº“
    await window.ib.setItem('lf_global_works_v1', works);
    
    // 3. ğŸš€ åŒæ­¥æ¸²æŸ“ï¼šåˆ·æ–°ä¹¦æ¶é¡µé¢å†…å®¹
    await window.renderBookshelf();
    
    // 4. UI åé¦ˆ
    if (typeof showToast === 'function') showToast("ğŸ‰ å·²å‘å¸ƒè‡³è—çé˜");
    
    // å¯é€‰ï¼šå‘å¸ƒåè‡ªåŠ¨è·³è½¬åˆ°ä¹¦æ¶é¡µé¢
    // showPage('shelf'); 
};

// --- [ å…¨å±€çŠ¶æ€å®šä¹‰ ] ---
window.currentLocMode = 'real'; 
window.selectedLocData = { name: "", lat: "0.0000", lng: "0.0000" };
let locTimer = null;

/**
 * 1. æ ¸å¿ƒæ¥ç®¡å‡½æ•°ï¼šhandleFeature
 * å½“ä½ ç‚¹å‡» HTML é‡Œçš„ onclick="handleFeature('Location')" æ—¶ï¼Œä¼šè¿è¡Œè¿™é‡Œ
 */
window.handleFeature = function(type) {
    if (type === 'Location') {
        // A. ç¡®ä¿å¼¹çª— HTML å·²ç»å­˜åœ¨äºé¡µé¢
        ensureLocationHTML();
        
        // B. æ˜¾ç¤ºå¼¹çª—
        const overlay = document.getElementById('lune-location-overlay');
        overlay.style.display = 'flex';
        
        // C. è§¦æ„Ÿåé¦ˆ
        if (window.navigator.vibrate) window.navigator.vibrate(15);
        console.log("ğŸ“ Location Protocol: Engaged.");
    }
};

/**
 * 2. æ¨¡å¼åˆ‡æ¢ï¼šçœŸå®æ¨¡å¼æœ‰æœç´¢ï¼Œè™šæ‹Ÿæ¨¡å¼ä»…è¾“å…¥
 */
window.switchLocTab = function(mode) {
    window.currentLocMode = mode;
    const input = document.getElementById('loc-main-input');
    const list = document.getElementById('loc-results-list');

    document.getElementById('tab-real').classList.toggle('active', mode === 'real');
    document.getElementById('tab-virtual').classList.toggle('active', mode === 'virtual');

    list.innerHTML = "";
    input.value = "";
    
    if (mode === 'virtual') {
        input.placeholder = "ENTER VIRTUAL DIMENSION...";
        list.innerHTML = `<div style="margin-top:50px; text-align:center; color:#CCC; font-size:10px; font-weight:800; letter-spacing:1px;">[ MANUAL_OVERRIDE_ENABLED ]</div>`;
    } else {
        input.placeholder = "SEARCH SATELLITE DATA...";
        list.innerHTML = `<div style="margin-top:50px; text-align:center; color:#8E8E8E; font-size:10px; font-weight:800; letter-spacing:1px;">WAITING FOR SIGNAL...</div>`;
    }
};

window.pickLocProtocol = (name, lat, lng) => {
    const short = name.split(',')[0];
    window.selectedLocData = { name: short, lat, lng };
    document.getElementById('loc-main-input').value = short.toUpperCase();
    document.getElementById('loc-results-list').innerHTML = `<div style="margin-top:20px; color:#000; font-weight:900; font-size:12px; letter-spacing:1px;">âœ“ COORDINATES_LOCKED</div>`;
};

window.closeLocModal = () => document.getElementById('lune-location-overlay').style.display = 'none';

/**
 * ğŸ¬ çœŸæ­£è¿›å…¥å‰§åœºæ¨¡å¼çš„å…¥å£
 */
window.enterImmersiveReaderById = function(chapterId) {
    const book = window.lfGlobalWorks[currentBookIndex];
    if (!book) return alert("Data error: book not found");
    
    const chapter = book.chapters.find(c => c.id === chapterId);
    if (!chapter || !chapter.content) return alert("Content not ready");

    // 1. å¼ºåˆ¶å…³é—­ AI å†™ä½œçš„å¤§èƒŒæ™¯é®ç½© (å¦‚æœæœ‰çš„è¯)
    const writingOverlay = document.getElementById('lfe-ai-writing-overlay');
    if (writingOverlay) writingOverlay.style.display = 'none';
    
    // 2. ç§»é™¤æ—§çš„æˆåŠŸå¼¹çª—
    const oldPopup = document.querySelector('.lfe-success-popup');
    if (oldPopup) oldPopup.remove();

    console.log("ğŸš€ Initializing Immersive Reader for:", chapter.title);

    // 3. å®ä¾‹åŒ–é˜…è¯»å™¨ (å‰ææ˜¯ Class å·²ç»å®šä¹‰åœ¨ä¸Šæ–¹äº†)
    try {
        new ImmersiveReader({
            bookInfo: {
                title: book.title,
                cover: book.coverImage || "",
                chapter: `Chapter ${chapter.num}`,
                wordCount: chapter.wordCount
            },
            // 7 æ­¥è®¾å®šçš„æ ¸å¿ƒäººè®¾
            characters: book.chars.map(c => ({
                name: c.name,
                avatar: c.avatar
            })),
            // AI ç”Ÿæˆçš„å†…å®¹
            script: chapter.content
        });
    } catch (e) {
        console.error("Reader Boot Error:", e);
        alert("å‰§åœºå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Class å®šä¹‰é¡ºåºã€‚");
    }
};

/**
 * 1. æ–°å¢ç« èŠ‚åŠŸèƒ½
 */
window.addNewChapter = async function() {
    if (currentBookIndex === -1 || !window.lfGlobalWorks[currentBookIndex]) {
        return alert("è¯·å…ˆé€‰æ‹©ä¸€éƒ¨ä½œå“");
    }

    const book = window.lfGlobalWorks[currentBookIndex];
    
    // åˆå§‹åŒ–ç« èŠ‚æ•°ç»„ (å¦‚æœä»¥å‰æ²¡æœ‰)
    if (!book.chapters) book.chapters = [];

    // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ ç« 
    const chNumber = book.chapters.length + 1;
    
    // åˆ›å»ºæ–°ç« èŠ‚å¯¹è±¡
    const newChapter = {
        id: "ch_" + Date.now(),
        num: chNumber,
        title: `Untitled Chapter ${chNumber}`, // é»˜è®¤æ ‡é¢˜
        content: "", // å†™ä½œå†…å®¹
        status: "draft", // draft æˆ– done
        wordCount: 0,
        lastModified: new Date().getTime()
    };

    // å‹å…¥æ•°ç»„ (ä½ å¯ä»¥ç”¨ push æ”¾åœ¨æœ€åï¼Œæˆ–è€… unshift æ”¾åœ¨æœ€å‰)
    book.chapters.push(newChapter);
    
    // æ›´æ–°ä¹¦ç±çš„æ€»ç« èŠ‚æ•°ç»Ÿè®¡
    book.currentChapter = book.chapters.length;

    // ğŸš€ æŒä¹…åŒ–åˆ° ib
    try {
        await window.ib.setItem('lf_global_works_v1', window.lfGlobalWorks);
        
        // åˆ·æ–° UI
        renderChapterList(book.chapters);
        if (window.renderStudioList) window.renderStudioList(); // åˆ·æ–°å¤–å±‚å·¥ä½œå®¤åˆ—è¡¨çš„è¿›åº¦
        
        showToast(`Chapter ${chNumber} Created`);
    } catch (e) {
        console.error("ç« èŠ‚ä¿å­˜å¤±è´¥:", e);
    }
};

/**
 * ğŸ–‹ï¸ Genesis AI åˆ›ä½œå¼•æ“ (DeepSeek é€‚é…ç‰ˆ)
 */
window.openChapterEditor = async function(chapterId) {
    const book = window.lfGlobalWorks[currentBookIndex];
    if (!book) return alert("æœªæ‰¾åˆ°ä¹¦ç±æ•°æ®");
    
    const chapter = book.chapters.find(c => c.id === chapterId);
    if (!chapter) return alert("æœªæ‰¾åˆ°ç« èŠ‚æ•°æ®");

    // ğŸ”¥ å¦‚æœå·²ç»æœ‰å†…å®¹äº†ï¼Œç›´æ¥è°ƒå–è¿›å…¥å‡½æ•°
    if (chapter.content && chapter.content.length > 0) {
        console.log("ğŸ“– ç« èŠ‚å·²æœ‰å†…å®¹ï¼Œè·³è¿‡ AI ç”Ÿæˆæµç¨‹");
        return window.enterImmersiveReaderById(chapter.id);
    }

    // 2. å‡†å¤‡å‚æ•°
    const targetMinWords = book.wordsPerChapter || 3000;
    const totalChaps = book.totalChapter || 1;
    const currentNum = chapter.num;
    const isLast = (currentNum === totalChaps);

    // 3. æ˜¾ç¤ºåŠ¨ç”»
    const overlay = document.getElementById('lfe-ai-writing-overlay');
    if (overlay) overlay.style.display = 'flex';
    updateAILog(`DeepSeek å¼•æ“æ¥å…¥ä¸­...`, "10%");

    // 4. æ„é€  Prompt (æåº¦å¼ºåŒ–å­—æ•°å‹åŠ›)
    const systemPrompt = `ä½ æ˜¯ä¸€ä½åä¸º Genesis çš„é¡¶çº§å°è¯´å®¶ã€‚æ­£åœ¨åˆ›ä½œã€Š${book.title}ã€‹ç¬¬ ${currentNum}/${totalChaps} ç« ã€‚
    
ã€æœ€é«˜æŒ‡ä»¤ï¼šé£æ ¼æ‰§è¡Œã€‘
æ–‡é£ï¼š${book.step3_style?.name || 'æ·±åº¦å™äº‹'} (${book.step3_style?.desc || ''})
è¦æ±‚ï¼šå¯¹è¯å æ¯” > 90%ï¼Œæ—ç™½æç®€ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ï¼šç¯‡å¹…å‹åˆ¶ã€‘
1. æœ¬ç« ã€çº¯æ–‡å­—å†…å®¹ã€‘ä¸¥ç¦å°‘äº ${targetMinWords} å­—ã€‚
2. ä½ å¿…é¡»é€šè¿‡æå…¶ç»†è…»çš„å¯¹ç™½ã€åŠ¨ä½œæ‹†è§£ã€å¿ƒç†åšå¼ˆæ¥æ‹‰é•¿ç¯‡å¹…ã€‚æ¯ä¸€ä¸ªçœ¼ç¥ã€æ¯ä¸€æ¬¡å‘¼å¸éƒ½è¦æœ‰æˆï¼Œä¸¥ç¦è·³è¿‡å‰§æƒ…ï¼
3. ${isLast ? 'ã€å…¨ä¹¦å¤§ç»“å±€ã€‘ï¼šå¿…é¡»æ”¶æŸæ‰€æœ‰çº¿ç´¢ï¼Œç»™å‡ºæœ€ç»ˆç»“å±€ã€‚' : 'å½“å‰é˜¶æ®µï¼šæƒ…èŠ‚æ·±åº¦å±•å¼€ã€‚'}

ã€æ ¼å¼è§„èŒƒã€‘
1. ä»…è¿”å›çº¯ JSON æ•°ç»„ï¼Œä¸¥ç¦ä»»ä½•åºŸè¯ã€‚
2. ç»“æ„ï¼š[{"type":"aside","text":"..."},{"type":"dialogue","char":"...","text":"..."}]ã€‚

ä¸–ç•Œè§‚èƒŒæ™¯ï¼š${book.fullSynopsis}
äººç‰©åå•ï¼š${book.chars.map(c => `${c.name}(${c.role})`).join(', ')}`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šè§£å†³ 400 é”™è¯¯
        // DeepSeek çš„ max_tokens å¿…é¡»åœ¨ [1, 8192] ä¹‹é—´
        let tokenLimit = Math.min(Math.floor(targetMinWords * 2.2) + 1000, 8192); 
        
        // å¦‚æœæ˜¯ GPT-4 ç­‰å…¶ä»–æ¨¡å‹ï¼Œå¯ä»¥æ”¾å®½åˆ° 128000ï¼Œä½† DeepSeek å¿…é¡»å°é¡¶ 8192
        if (apiUrl.includes("deepseek")) {
            tokenLimit = 8192; 
        }

        updateAILog(`AI æ­£åœ¨å†²å‡» ${targetMinWords} å­—åº•çº¿ (Tokenä¸Šé™: ${tokenLimit})...`, "45%");

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "deepseek-chat",
                messages: [
                    {role: "system", content: systemPrompt},
                    {role: "user", content: `å¼€å§‹åˆ›ä½œã€‚å­—æ•°å¿…é¡»è¶…è¿‡ ${targetMinWords} å­—ï¼Œè¯·å°½æƒ…æŒ¥æ´’ç»†èŠ‚ã€‚`}
                ],
                temperature: 0.8,
                max_tokens: tokenLimit // è¿™é‡Œçš„æ•°å€¼ç°åœ¨æ°¸è¿œä¸ä¼šè¶…è¿‡ 8192
            })
        });

        const data = await res.json();
        
        // å¢åŠ é”™è¯¯æ•è·ï¼Œç›´æ¥æ˜¾ç¤º API æŠ¥é”™å†…å®¹
        if (data.error) {
            throw new Error(`API è¿”å›é”™è¯¯: ${data.error.message || data.error.code}`);
        }

        let content = data.choices[0].message.content;
        
        // æ¸…æ´— JSON
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI è¾“å‡ºæ ¼å¼å´©æºƒï¼Œè¯·å°è¯•å‡å°‘å•ç« å­—æ•°è¦æ±‚æˆ–é‡è¯•ã€‚");
        
        let cleanedJson = jsonMatch[0]
            .replace(/[\u0000-\u001F\u007F-\u009F]/g, "")
            .replace(/[\u2028\u2029]/g, "");

        const scriptData = JSON.parse(cleanedJson);

        // 5. ç»“æœæŒä¹…åŒ–
        chapter.content = scriptData;
        chapter.wordCount = scriptData.reduce((acc, curr) => acc + (curr.text ? curr.text.length : 0), 0);
        chapter.status = "done";
        
        await window.ib.setItem('lf_global_works_v1', window.lfGlobalWorks);
        
        updateAILog(`å®Œæˆï¼æœ¬ç« äº§å‡º ${chapter.wordCount} å­—ã€‚`, "100%");
        showWritingSuccessPopup(chapter);

    } catch (e) {
        console.error("AI Writing Error:", e);
        alert(`åˆ›ä½œä¸­æ–­: ${e.message}`);
        if (overlay) overlay.style.display = 'none';
    }
};

/**
 * ğŸš€ ç»ˆæï¼šå®Œæˆåˆ›å»º (å½»åº•è§£å†³åˆ·æ–°æ¶ˆå¤±)
 */
window.finishBookCreation = async function() {
    const data = window.lfProjectData;
    
    // å®¹é”™æ ¡éªŒ
    if (!data.step2_title) return alert("è¯·å…ˆå®Œæˆä¹¦åç¡®è®¤");

    const newBook = {
        id: "book_" + Date.now(),
        title: data.step2_title,
        status: "serial",
        synopsis: data.step1_core ? data.step1_core.synopsis.substring(0, 30) + "..." : "æ— ",
        fullSynopsis: data.step1_core ? data.step1_core.synopsis : "",
        chars: data.step4_chars || [], // ç¡®ä¿è¿™é‡ŒåŒ…å«äº† CP å’Œ Solo çš„æ‰€æœ‰äºº
        totalChapter: data.step7_specs ? data.step7_specs.totalChapters : 50,
        words: 0,
        currentChapter: 0,
        lastUpdate: "Just Now",
        tags: ["New World"]
    };

    // 1. è·å–æ—§åˆ—è¡¨å¹¶è¿½åŠ 
    let currentWorks = await window.ib.getItem(WORKS_KEY) || [];
    currentWorks.unshift(newBook);

    // 2. å­˜å…¥ ib ç¡¬ç›˜
    try {
        await window.ib.setItem(WORKS_KEY, currentWorks);
        window.lfGlobalWorks = currentWorks; // åŒæ­¥å†…å­˜
        
        console.log("âœ… ä½œå“å·²å…¥åº“:", newBook.title);

        // 3. æ¸…é™¤è‰ç¨¿
        await clearWizardDraft();

        // 4. åˆ·æ–°åˆ—è¡¨å¹¶å…³é—­å‘å¯¼
        if(window.renderStudioList) window.renderStudioList();
        closeWizard();
        
        alert(`ğŸ‰ ã€Š${newBook.title}ã€‹å·²æˆåŠŸé™ä¸´ï¼`);
    } catch (e) {
        alert("æ•°æ®åº“å†™å…¥å¤±è´¥: " + e.message);
    }
};

const DRAFT_KEY = 'lf_wizard_draft_v1';
const WORKS_KEY = 'lf_global_works_v1';

// é¡µé¢åŠ è½½å®Œæˆåç«‹å³å¯åŠ¨
window.addEventListener('load', () => {
    initStudioData();
});

/**
 * âœ… ç¡®è®¤ CP ä»»åŠ¡
 * é€»è¾‘ï¼šæŠ“å–è¾“å…¥æ¡†æ•°æ® -> å­˜å…¥ state -> è§¦å‘ä¸‹ä¸€ä¸ªä»»åŠ¡
 */
window.confirmCPTask = function(index) {
    // 1. è·å– DOM æ•°æ®
    const charA = {
        name: document.getElementById(`input-${index}-nameA`).value.trim(),
        role: document.getElementById(`input-${index}-roleA`).value.trim(),
        bio: document.getElementById(`input-${index}-bioA`).value,
        avatar: document.getElementById(`img-${index}-charA`).src,
        type: 'MAIN_CP_A',
        pairId: index
    };
    const charB = {
        name: document.getElementById(`input-${index}-nameB`).value.trim(),
        role: document.getElementById(`input-${index}-roleB`).value.trim(),
        bio: document.getElementById(`input-${index}-bioB`).value,
        avatar: document.getElementById(`img-${index}-charB`).src,
        type: 'MAIN_CP_B',
        pairId: index
    };

    // 2. æ ¸å¿ƒï¼šæ¨å…¥å…¨å±€åˆ—è¡¨ (ç¡®ä¿ä¸¤ä¸ªäººæ˜¯ç‹¬ç«‹çš„èŠ‚ç‚¹)
    if (!window.lfCharState.generatedList) window.lfCharState.generatedList = [];
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜è¿‡ (é˜²æ­¢é‡å¤ç‚¹å‡»ç¡®è®¤)
    window.lfCharState.generatedList.push(charA);
    window.lfCharState.generatedList.push(charB);

    // 3. é”å®š UI
    const card = document.getElementById(`cp-card-${index}`);
    const btns = card.querySelector('.lfw-action-bar');
    if(btns) btns.remove();
    card.style.opacity = '0.6';
    card.style.pointerEvents = 'none';

    // 4. åŒæ­¥åˆ°å…¨å±€ ProjectData (è¿™æ­¥å¾ˆé‡è¦ï¼Œå…³ç³»ç½‘æ¸²æŸ“é å®ƒ)
    window.lfProjectData.step4_chars = window.lfCharState.generatedList;

    saveWizardDraft();
    processNextCharTask(); // æ¨è¿›åˆ°ä¸‹ä¸€ä¸ª Solo æˆ–ç»“æŸ
};

/**
 * âœ… ç¡®è®¤ Solo ä»»åŠ¡
 */
window.confirmSoloTask = function(index) {
    // 1. æŠ“å–æ•°æ®
    const char = {
        name: document.getElementById(`input-${index}-name`).value,
        role: document.getElementById(`input-${index}-role`).value,
        bio: document.getElementById(`input-${index}-bio`).value,
        avatar: document.getElementById(`img-${index}-solo`).src,
        type: 'VIP_SOLO'
    };

    // 2. å­˜å…¥
    if (!window.lfCharState.generatedList) window.lfCharState.generatedList = [];
    window.lfCharState.generatedList.push(char);

    // 3. é”å®š UI
    const card = document.getElementById(`solo-card-${index}`);
    const btns = card.querySelector('.lfw-action-bar');
    if(btns) btns.remove();
    card.style.opacity = '0.6';
    card.style.pointerEvents = 'none';

    // 4. ä¿å­˜
    saveWizardDraft();

    // 5. æ¨è¿›
    processNextCharTask();
};

/**
 * ğŸ”„ è°ƒåº¦ä¸­å¿ƒ (Process Pipeline)
 * é€»è¾‘ï¼šæ¯æ¬¡ç‚¹å‡»â€œç¡®è®¤â€åï¼Œè¿™é‡Œä¼šè¢«è°ƒç”¨ï¼Œåˆ¤æ–­æ˜¯å¦è¿˜æœ‰åé¢
 */
window.processNextCharTask = function() {
    const state = window.lfCharState;
    const area = document.getElementById('step4-dynamic-area');

    // è®¡ç®—å½“å‰å·²ç”Ÿæˆäººæ•° (state.generatedList.length)
    const currentCount = state.generatedList.length;
    const targetCount = state.targetTotal;
    
    console.log(`[Flow] Current: ${currentCount} / Target: ${targetCount}`);

    // A. ä¼˜å…ˆç”Ÿæˆ CP (å¦‚æœå½“å‰ CPæ•° < ç›®æ ‡ CPæ•°)
    // æ³¨æ„ï¼šæ¯æ¬¡ç”Ÿæˆ CP å¢åŠ  2 äººã€‚æˆ‘ä»¬ç”¨ currentCP è®¡æ•°å™¨æ¥åˆ¤æ–­ç”Ÿæˆäº†å‡ å¯¹ã€‚
    if (state.currentCP < state.targetCP) {
        state.currentCP++; // å¢åŠ  CP è®¡æ•°
        const cpIndex = state.currentCP;
        
        // æ¸²æŸ“éª¨æ¶ + å‘¼å« AI
        renderCPCardSkeleton(cpIndex);
        callAIForCP(cpIndex);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => area.lastElementChild.scrollIntoView({ behavior: 'smooth' }), 100);
        return; 
    }

    // B. CP ç”Ÿæˆå¤Ÿäº†ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜éœ€è¦ Solo è§’è‰²
    // é€»è¾‘ï¼šå¦‚æœ (å·²ç”Ÿæˆäººæ•° < ç›®æ ‡æ€»äººæ•°) -> ç”Ÿæˆ Solo
    // è¿™é‡Œçš„è®¡æ•°å™¨æ˜¯ currentSolo
    if (currentCount < targetCount) {
        state.currentSolo++;
        const soloIndex = state.currentSolo; // è¿™é‡Œçš„ index åªæ˜¯ä¸ºäº† ID ä¸é‡å¤
        
        renderSoloCardSkeleton(soloIndex);
        callAIForSolo(soloIndex);
        
        setTimeout(() => area.lastElementChild.scrollIntoView({ behavior: 'smooth' }), 100);
        return;
    }

    // C. å…¨éƒ¨ç”Ÿæˆå®Œæ¯•
    if (currentCount >= targetCount) {
        // é˜²æ­¢é‡å¤æ˜¾ç¤ºå®Œæˆç•Œé¢
        if (document.getElementById('step4-finish-msg')) return;

        area.insertAdjacentHTML('beforeend', `
            <div id="step4-finish-msg" style="text-align:center; margin-top:40px; animation: lfwFadeIn 0.5s;">
                <div style="font-size:50px;">ğŸ‰</div>
                <div style="font-weight:800; font-size:20px; margin-top:10px;">Cast Complete</div>
                <div style="font-size:14px; color:#666; margin-bottom:24px;">
                    ${currentCount} characters have been created.
                </div>
                <button class="lfw-btn lfw-btn-black" onclick="wizardNextStep()">
                    Proceed to Relationship Web
                </button>
            </div>
        `);
        setTimeout(() => area.lastElementChild.scrollIntoView({ behavior: 'smooth' }), 100);
        
        // åŒæ­¥æœ€ç»ˆæ•°æ®åˆ°å…¨å±€
        window.lfProjectData.step4_chars = state.generatedList;
    }
};

// --- ğŸ¨ Step 4 ä¸“ç”¨ï¼šå¤´åƒä¸Šä¼ é€»è¾‘ ---

// ä¸´æ—¶å˜é‡ï¼šè®°å½•å½“å‰æ­£åœ¨ä¿®æ”¹å“ªä¸ªè§’è‰²çš„å¤´åƒ
// æ ¼å¼ï¼š{ index: 0, subKey: 'charA' } æˆ– { index: 2, subKey: 'solo' }
window.lfCurrentUploadTarget = null;

/**
 * 1. è§¦å‘ä¸Šä¼  (ç»‘å®šåœ¨ img çš„ onclick ä¸Š)
 * index: ç¬¬å‡ ç»„æ•°æ®çš„ç´¢å¼•
 * subKey: 'charA', 'charB' (å¦‚æœæ˜¯CP) æˆ– 'solo' (å¦‚æœæ˜¯å•äºº)
 */
window.triggerCharAvatarUpload = function(index, subKey) {
    // è®°å½•ç›®æ ‡
    window.lfCurrentUploadTarget = { index, subKey };
    
    // è§¦å‘éšè—çš„æ–‡ä»¶è¾“å…¥æ¡†
    const input = document.getElementById('step4-avatar-upload');
    if (input) input.click();
};

/**
 * 2. å¤„ç†æ–‡ä»¶é€‰æ‹© (ä¿®å¤ç‰ˆï¼šè§†è§‰+æ•°æ®åŒåŒæ­¥)
 */
window.handleAvatarUpload = function(input) {
    // 1. åŸºç¡€æ£€æŸ¥
    if (!input.files || !input.files[0]) return;
    if (!window.lfCurrentUploadTarget) {
        console.error("âŒ æœªæ‰¾åˆ°ä¸Šä¼ ç›®æ ‡ï¼Œè¯·é‡æ–°ç‚¹å‡»å¤´åƒ");
        return;
    }

    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const newBase64 = e.target.result;
        const { index, subKey } = window.lfCurrentUploadTarget;

        console.log(`[Upload] Updating: Index ${index}, Key ${subKey}`);

        // --- A. è§†è§‰æ›´æ–° (DOM) ---
        // æ‹¼è£… IDï¼šå¿…é¡»ä¸ fillCPCard/fillSoloCard é‡Œç”Ÿæˆçš„ ID å®Œå…¨ä¸€è‡´
        const imgDomId = `img-${index}-${subKey}`; 
        const imgEl = document.getElementById(imgDomId);
        
        if (imgEl) {
            imgEl.src = newBase64; // å¼ºåˆ¶æ›¿æ¢å›¾ç‰‡
            console.log("âœ… DOM å›¾ç‰‡å·²æ›´æ–°");
        } else {
            console.error("âŒ æ‰¾ä¸åˆ°å›¾ç‰‡å…ƒç´  ID:", imgDomId);
        }

        // --- B. æ•°æ®æ›´æ–° (Memory) ---
        // è¿™ä¸€æ­¥å¦‚æœä¸åšï¼Œä½ ç‚¹â€œä¸‹ä¸€æ­¥â€æˆ–è€…â€œç”Ÿæˆâ€æ—¶ï¼Œæ•°æ®è¿˜æ˜¯æ—§çš„
        if (window.lfCharState && window.lfCharState.generatedList) {
            // æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å¯¹è±¡
            // é€»è¾‘ï¼šgeneratedList æ˜¯æŒ‰ç”Ÿæˆé¡ºåºå­˜çš„ã€‚
            // å‡è®¾ fillCPCard æŠŠç»“æœå­˜å…¥äº† generatedList[index]
            const targetData = window.lfCharState.generatedList[index];
            
            if (targetData) {
                if (subKey === 'solo') {
                    // å•äººæ¨¡å¼
                    targetData.avatar = newBase64;
                } else if (subKey === 'charA') {
                    // CP æ¨¡å¼ A
                    if(targetData.charA) targetData.charA.avatar = newBase64;
                } else if (subKey === 'charB') {
                    // CP æ¨¡å¼ B
                    if(targetData.charB) targetData.charB.avatar = newBase64;
                }
                console.log("âœ… å†…å­˜æ•°æ®å·²æ›´æ–°");
            }
        }

        // --- C. è‡ªåŠ¨ä¿å­˜ ---
        if (typeof saveWizardDraft === 'function') saveWizardDraft();
    };

    reader.readAsDataURL(file);
    
    // æ¸…ç©º inputï¼Œé˜²æ­¢è¿ç»­é€‰åŒä¸€å¼ å›¾ä¸è§¦å‘ change äº‹ä»¶
    input.value = '';
};

// 1. å¦‚æœè¿™ä¸ªå…¨å±€å˜é‡ä¸å­˜åœ¨ï¼Œå°±ç»™å®ƒä¸€ä¸ªç©ºæ•°ç»„ï¼Œé˜²æ­¢æŠ¥é”™
if (!window.lfGlobalWorks) {
    window.lfGlobalWorks = [];
}

// --- äº¤äº’é€»è¾‘ (æ•°æ®åŒå‘ç»‘å®š) ---

/**
 * A. ä¸Šä¼ å°é¢å¹¶æŒä¹…åŒ–ä¿å­˜ (ä¿®å¤åˆ·æ–°æ¶ˆå¤±é—®é¢˜)
 */
window.uploadCover = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        // UI åé¦ˆ
        const coverBox = document.getElementById('lfe-cover-box');
        const placeholder = document.getElementById('lfe-cover-placeholder');
        
        reader.onload = async function(e) {
            const base64 = e.target.result;
            
            // 1. ç«‹å³æ›´æ–°å½“å‰é¡µé¢çš„ UI è§†è§‰
            coverBox.style.backgroundImage = `url(${base64})`;
            coverBox.style.backgroundColor = 'transparent';
            if (placeholder) placeholder.style.display = 'none';

            // 2. æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®å¯¹è±¡
            if (currentBookIndex > -1 && window.lfGlobalWorks[currentBookIndex]) {
                window.lfGlobalWorks[currentBookIndex].coverImage = base64;
                
                // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šæŠŠæ•´ä¸ªåˆ—è¡¨é‡æ–°å­˜å…¥ IndexedDB
                try {
                    const WORKS_KEY = 'lf_global_works_v1';
                    await window.ib.setItem(WORKS_KEY, window.lfGlobalWorks);
                    console.log("âœ… å°é¢å·²æˆåŠŸåŒæ­¥è‡³æ•°æ®åº“");
                    
                    // 3. åŒæ­¥åˆ·æ–°åå°çš„â€œå·¥ä½œå®¤åˆ—è¡¨â€ï¼Œè®©å¤–é¢ä¹Ÿèƒ½çœ‹åˆ°æ–°å°é¢
                    if (window.renderStudioList) window.renderStudioList();
                    
                    if (typeof showToast === 'function') showToast("Cover Updated");
                } catch (err) {
                    console.error("å°é¢ä¿å­˜å¤±è´¥:", err);
                    alert("å­˜å‚¨ç©ºé—´å¯èƒ½å·²æ»¡ï¼Œæ— æ³•ä¿å­˜å›¾ç‰‡");
                }
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// ä¿®æ”¹ä¹¦åä¿å­˜
window.saveDashboardTitle = async function(el) {
    const newTitle = el.innerText.trim();
    if (newTitle && currentBookIndex > -1) {
        window.lfGlobalWorks[currentBookIndex].title = newTitle;
        await window.ib.setItem('lf_global_works_v1', window.lfGlobalWorks);
        if (window.renderStudioList) window.renderStudioList();
        console.log("âœ… æ ‡é¢˜å·²åŒæ­¥");
    }
};

// ä¿®æ”¹ç®€ä»‹ä¿å­˜
window.editDashboardSynopsis = async function() {
    const el = document.getElementById('lfe-synopsis-text');
    const oldText = el.innerText;
    const newText = prompt("ä¿®æ”¹æ•…äº‹ç®€ä»‹ï¼š", oldText);
    
    if (newText !== null && newText.trim() !== "") {
        el.innerText = newText;
        if (currentBookIndex > -1) {
            window.lfGlobalWorks[currentBookIndex].fullSynopsis = newText;
            window.lfGlobalWorks[currentBookIndex].synopsis = newText.substring(0, 30) + "...";
            // å­˜å…¥æ•°æ®åº“
            await window.ib.setItem('lf_global_works_v1', window.lfGlobalWorks);
            if (window.renderStudioList) window.renderStudioList();
            showToast("Synopsis Saved");
        }
    }
};

/**
 * D. AI ç”Ÿæˆæ ‡ç­¾ (åŸºäºç®€ä»‹å†…å®¹)
 */
window.generateTagsAI = async function() {
    // 1. åŸºç¡€æ ¡éªŒ
    if (currentBookIndex === -1 || !window.lfGlobalWorks[currentBookIndex]) {
        alert("æœªæ‰¾åˆ°ä¹¦ç±æ•°æ®");
        return;
    }

    const book = window.lfGlobalWorks[currentBookIndex];
    const synopsis = book.fullSynopsis || book.synopsis || "";
    
    if (synopsis.length < 10) {
        alert("ç®€ä»‹å†…å®¹å¤ªå°‘ï¼ŒAI æ— æ³•åˆ†ææ ‡ç­¾ï¼Œè¯·å…ˆå®Œå–„ç®€ä»‹ã€‚");
        return;
    }

    // 2. UI è¿›å…¥åŠ è½½çŠ¶æ€
    const tagAddBtn = document.querySelector('.lfe-tag-add');
    const originalText = tagAddBtn.innerText;
    tagAddBtn.innerText = "Analyzing...";
    tagAddBtn.style.opacity = "0.5";
    tagAddBtn.style.pointerEvents = "none";

    // 3. å‡†å¤‡ AI é…ç½®
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    if (!apiKey) {
        alert("è¯·å…ˆé…ç½® AI Key");
        tagAddBtn.innerText = originalText;
        tagAddBtn.style.opacity = "1";
        tagAddBtn.style.pointerEvents = "auto";
        return;
    }

    // 4. Prompt è®¾è®¡
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèµ„æ·±ç½‘æ–‡ç¼–è¾‘ã€‚è¯·æ ¹æ®æä¾›çš„å°è¯´ç®€ä»‹ï¼Œæç‚¼å‡º 5 ä¸ªæ ¸å¿ƒæ ‡ç­¾ã€‚
    æ ‡ç­¾åº”æ¶µç›–ï¼šé¢˜æï¼ˆå¦‚ï¼šæ— é™æµï¼‰ã€äººè®¾å±æ€§ï¼ˆå¦‚ï¼šå¼ºå¼ºï¼‰ã€æƒ…æ„ŸåŸºè°ƒï¼ˆå¦‚ï¼šç ´é•œé‡åœ†ï¼‰æˆ–æ ¸å¿ƒåˆ›æ„ã€‚
    
    ã€æ³¨æ„ã€‘
    1. å¿…é¡»è¿”å›çº¯ JSON å­—ç¬¦ä¸²æ•°ç»„ã€‚
    2. ä¸è¦åŒ…å« Markdown ä»£ç å—æ ‡è®°ã€‚
    3. æ¯ä¸ªæ ‡ç­¾ä¸è¶…è¿‡ 6 ä¸ªå­—ã€‚
    
    ç¤ºä¾‹æ ¼å¼ï¼š["èµ›åšæœ‹å…‹", "å®¿å‘½æ„Ÿ", "åŒå¼ºåšå¼ˆ", "åè½¬", "é«˜ç‡ƒ"]`;

    const userPrompt = `å°è¯´æ ‡é¢˜ï¼šã€Š${book.title}ã€‹\nå°è¯´ç®€ä»‹ï¼š${synopsis}\nè¯·ç”Ÿæˆ 5 ä¸ªæœ€å¸å¼•äººçš„æ ‡ç­¾ã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 0.8
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        let content = data.choices[0].message.content;
        
        // æ¸…æ´—æ•°æ®
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) content = jsonMatch[0];
        content = content.replace(/```json/g, '').replace(/```/g, '');
        
        const newTags = JSON.parse(content);

        // 5. æ›´æ–°æ•°æ®å¹¶æŒä¹…åŒ–
        // æ›´æ–°å†…å­˜
        window.lfGlobalWorks[currentBookIndex].tags = newTags;

        // ğŸš€ æ ¸å¿ƒæŒä¹…åŒ–ï¼šå­˜å…¥ ib ç¡¬ç›˜
        await window.ib.setItem('lf_global_works_v1', window.lfGlobalWorks);
        console.log("âœ… æ ‡ç­¾å·²æ›´æ–°å¹¶å…¥åº“");

        // 6. åˆ·æ–° UI
        renderDashboardTags(newTags);
        showToast("âœ¨ Tags Synchronized");

    } catch (e) {
        console.error("AI Tags Error:", e);
        alert("ç”Ÿæˆæ ‡ç­¾å¤±è´¥: " + e.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        tagAddBtn.innerText = "+ AI Tag";
        tagAddBtn.style.opacity = "1";
        tagAddBtn.style.pointerEvents = "auto";
    }
};

// E. å‘å¸ƒ/ä¸‹æ¶åˆ‡æ¢
window.togglePublishStatus = function() {
    const btn = document.getElementById('lfe-publish-toggle');
    const isPublished = btn.classList.contains('published');
    
    // åˆ‡æ¢çŠ¶æ€
    updatePublishBtnState(!isPublished);
    
    // æ›´æ–°æ•°æ®
    if (currentBookIndex > -1) {
        window.lfGlobalWorks[currentBookIndex].status = !isPublished ? 'published' : 'serial';
    }
    
    if (!isPublished) {
        alert("ğŸ“š æˆåŠŸå‘å¸ƒï¼å·²åŒæ­¥è‡³ä¹¦æ¶ã€‚");
    }
};

// --- ğŸ  Studio & Wizard è”åŠ¨æ ¸å¿ƒé€»è¾‘ ---

/**
 * 2. æ¸²æŸ“å·¥ä½œå®¤åˆ—è¡¨ (æ ¸å¿ƒåˆ·æ–°å‡½æ•°)
 * æ— è®ºæ˜¯åˆå§‹åŒ–ï¼Œè¿˜æ˜¯æ–°å»ºå®Œæˆåï¼Œéƒ½è°ƒè¿™ä¸ªåˆ·æ–°ç•Œé¢
 */
window.renderStudioList = function() {
    const listContainer = document.getElementById('lf-draft-list-container');
    if (!listContainer) return;

    const works = window.lfGlobalWorks || [];
    
    // å¦‚æœæ²¡æœ‰ä¹¦ï¼Œæ˜¾ç¤ºå ä½ç¬¦
    if (works.length === 0) {
        listContainer.innerHTML = `<div style="text-align:center; padding:50px; color:#ccc;">ç‚¹å‡»â€œ+â€å·å¼€å¯ä½ çš„ç¬¬ä¸€ä¸ªä¸–ç•Œ</div>`;
        return;
    }

    let html = works.map((w, index) => {
        // è®¡ç®—è¿›åº¦... (ä¿æŒä½ ä¹‹å‰çš„é€»è¾‘)
        let progressPercent = w.totalChapter > 0 ? Math.round((w.currentChapter / w.totalChapter) * 100) : 0;
        const statusClass = w.status === 'end' ? 'status-end' : 'status-on';

        return `
            <div class="lf-draft-card" onclick="openDashboard(${index})">
                <div class="lf-card-top">
                    <div class="lf-draft-title">${w.title}</div>
                    <div class="lf-draft-status ${statusClass}">${w.status === 'end' ? 'FIN' : 'ON'}</div>
                </div>
                <div style="font-size:12px; color:#666; margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    ${w.synopsis}
                </div>
                <div class="lf-draft-info">
                    ${w.currentChapter}/${w.totalChapter} Chapters Â· ${w.words} Words
                </div>
                <div class="lf-progress-bg">
                    <div class="lf-progress-bar" style="width: ${progressPercent}%"></div>
                </div>
            </div>
        `;
    }).join('');

    listContainer.innerHTML = html;
};

// --- åˆå§‹åŒ–è°ƒç”¨ ---
// é¡µé¢åŠ è½½å®Œè°ƒä¸€æ¬¡ï¼Œæ˜¾ç¤ºé»˜è®¤æ•°æ®
renderStudioList();

// --- âš™ï¸ Step 7: è§„æ ¼è®¾å®šé€»è¾‘ ---

/**
 * ğŸ“Š Step 7 åˆå§‹åŒ–ä¸æ•°æ®è”åŠ¨
 */
window.initStep7 = function() {
    console.log("[Step 7] Initializing specs...");
    // å¼ºåˆ¶è°ƒç”¨ä¸€æ¬¡æ›´æ–°ï¼Œè®©é»˜è®¤å€¼ç”Ÿæ•ˆ
    updateSpecData();
};

/**
 * ğŸ“Š æ¸²æŸ“ Step 07 çš„è§„æ ¼æ•°æ®
 */
window.updateSpecData = function() {
    // å¯¹åº”ä½  HTML é‡Œçš„ id="input-chapters" å’Œ id="input-words"
    const elChapters = document.getElementById('input-chapters');
    const elWords = document.getElementById('input-words');
    
    const dispChapters = document.getElementById('disp-chapters');
    const dispWords = document.getElementById('disp-words');
    const dispTotal = document.getElementById('disp-total');

    if (!elChapters || !elWords) return;

    const chapters = parseInt(elChapters.value);
    const words = parseInt(elWords.value);
    const total = chapters * words;

    // æ›´æ–° UI
    if (dispChapters) dispChapters.innerText = chapters;
    if (dispWords) dispWords.innerText = words.toLocaleString();
    if (dispTotal) {
        dispTotal.innerText = total >= 10000 ? (total / 10000).toFixed(1) + " ä¸‡å­—" : total + " å­—";
    }

    // å†™å…¥æ•°æ®åŒ…
    window.lfProjectData.step7_specs = { chapters, wordsPerChapter: words, totalWords: total };
};

// --- ğŸ§¬ Step 6: å…³ç³»ç½‘ä¼˜åŒ–é€»è¾‘ ---

var lfStep6Data = {
    finalNodes: [], // æœ€ç»ˆçš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆå«ä¸»è§’+é…è§’ï¼‰
    finalLinks: []  // æœ€ç»ˆçš„æ‰€æœ‰è¿çº¿
};

/**
 * 2. è·³è¿‡ä¼˜åŒ– (Skip)
 */
window.skipOptimization = function() {
    // ç›´æ¥å¤ç”¨ Step 4 å’Œ 5 çš„æ•°æ®
    lfStep6Data.finalNodes = window.lfProjectData.step4_chars;
    lfStep6Data.finalLinks = window.lfProjectData.step5_relations;
    
    // UI åé¦ˆ
    alert("å·²ä¿ç•™åŸºç¡€å…³ç³»ç½‘ã€‚");
    document.getElementById('lfw-step6-confirm').style.display = 'block';
    
    // é‡æ–°æ¸²æŸ“ä¸€ä¸‹ç¡®è®¤è§†è§‰
    renderOptVisuals(lfStep6Data.finalNodes, lfStep6Data.finalLinks, []);
};

/**
 * 3. AI æ·±åº¦æ‰©å±• (Deep Expand)
 */
window.generateOptimization = async function() {
    const chars = window.lfProjectData.step4_chars;
    const baseLinks = window.lfProjectData.step5_relations;
    const story = window.lfProjectData.step1_core;

    // UI Loading
    const canvas = document.getElementById('lfw-opt-canvas');
    canvas.innerHTML = `<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;"><div class="lfw-loading-scan"></div><div style="font-size:10px; margin-top:10px;">EXPANDING UNIVERSE...</div></div>`;

    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    // Prompt: è¦æ±‚ AI å¢åŠ  2-3 ä¸ªèƒŒæ™¯èŠ‚ç‚¹
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå°è¯´ä¸–ç•Œè§‚æ¶æ„å¸ˆã€‚åŸºäºå·²æœ‰çš„äººç‰©å…³ç³»ç½‘ï¼Œè¯·è¡¥å…… 2-3 ä¸ªã€å…³é”®èƒŒæ™¯äººç‰©ã€‘ï¼ˆExtra Nodesï¼‰ã€‚
    è¿™äº›äººç‰©é€šå¸¸ä¸ç›´æ¥å‚ä¸ä¸»çº¿ï¼Œä½†æ„æˆäº†ä¸»è§’çš„èƒŒæ™¯å‹åŠ›ï¼ˆå¦‚ï¼šå·²æ•…çš„çˆ¶äº²ã€ä¸¥å‰çš„ä¸Šå¸ã€ä¼ è¯´ä¸­çš„æ€æ‰‹ï¼‰ã€‚
    
    å¿…é¡»è¿”å›çº¯ JSON å¯¹è±¡:
    {
        "extras": [
            { "name": "æ–°äººç‰©å", "role": "èº«ä»½", "desc": "ä½œç”¨ç®€è¿°" }
        ],
        "links": [
            { "source": "æ–°äººç‰©å", "target": "å·²æœ‰ä¸»è§’å", "desc": "å…³ç³»(å¦‚:æ§åˆ¶ã€ææƒ§)" }
        ]
    }`;

    const charListStr = chars.map(c => c.name).join(', ');
    const userPrompt = `æ•…äº‹ï¼šã€Š${window.lfProjectData.step2_title}ã€‹\nç®€ä»‹ï¼š${story.synopsis}\nå·²æœ‰ä¸»è§’ï¼š${charListStr}\nè¯·è¡¥å……èƒŒæ™¯å…³ç³»ç½‘ã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 0.8
            })
        });

        // åœ¨ window.callAIForCP å†…éƒ¨æ‰¾åˆ°è§£æé€»è¾‘ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹ä»£ç ï¼š
        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        let rawContent = data.choices[0].message.content;

        // --- ğŸ›¡ï¸ ç»ˆææ¸…æ´—é€»è¾‘ ---
        // 1. æå– JSON éƒ¨åˆ†
        const jsonMatch = rawContent.match(/\{[\s\S]*\}/);
        if (jsonMatch) rawContent = jsonMatch[0];

        // 2. æ¸…é™¤ Markdown æ ‡è®°
        rawContent = rawContent.replace(/```json/g, '').replace(/```/g, '');

        // 3. å¤„ç†éæ³•æ§åˆ¶å­—ç¬¦ (å…³é”®ä¿®å¤ç‚¹ï¼)
        // å°†çœŸæ­£çš„æ¢è¡Œç¬¦æ›¿æ¢ä¸ºè½¬ä¹‰åçš„ \nï¼Œé˜²æ­¢ JSON.parse å´©æºƒ
        rawContent = rawContent.replace(/[\u0000-\u001F\u007F-\u009F]/g, ""); 

        try {
            const result = JSON.parse(rawContent);
            fillCPCard(index, result); // æ¸²æŸ“
        } catch (e) {
            console.error("JSONæ¸…æ´—åä¾ç„¶å¤±è´¥:", rawContent);
            throw e;
        }

        // åˆå¹¶æ•°æ®
        const extraNodes = result.extras;
        const extraLinks = result.links;
        
        // æ¸²æŸ“å›¾è°± (æ ¸å¿ƒä¸»è§’ + é¢å¤–é…è§’)
        renderOptVisuals(chars, baseLinks.concat(extraLinks), extraNodes);
        
        // æ¸²æŸ“å¡ç‰‡åˆ—è¡¨
        renderOptCards(extraLinks);

        // å­˜å…¥æš‚å­˜
        lfStep6Data.finalNodes = chars.concat(extraNodes.map(e => ({...e, type:'EXTRA', avatar:''}))); // æ ‡è®°ä¸º extra
        lfStep6Data.finalLinks = baseLinks.concat(extraLinks);

        // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
        document.getElementById('lfw-step6-confirm').style.display = 'block';

    } catch (e) {
        console.error(e);
        canvas.innerHTML = `<div style="color:red; text-align:center; padding-top:140px;">Error: ${e.message}</div>`;
    }
};

/**
 * 6. ç¡®è®¤ä¿å­˜
 */
window.confirmStep6 = function() {
    // æœ€ç»ˆå…¥åº“ (è¿™é‡Œå¹¶æ²¡æœ‰æ–°çš„å­—æ®µï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯æŠŠä¼˜åŒ–åçš„ç»“æœåˆå¹¶å›äº† 4 å’Œ 5ï¼Œæˆ–è€…å¦å­˜ä¸º step6_optimized)
    // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å­˜åœ¨ step6_final é‡Œ
    window.lfProjectData.step6_final = lfStep6Data;
    
    console.log("[Step 6] Optimization Saved.", lfStep6Data);
    wizardNextStep(); // å» Step 7
};

// --- ğŸ•¸ï¸ Step 5: å…³ç³»ç½‘ç”Ÿæˆé€»è¾‘ ---

/**
 * 1. æ ¸å¿ƒå…¥å£ï¼šè°ƒç”¨ AI åˆ†æå…³ç³»
 */
window.generateRelationWeb = async function() {
    // 1. è·å– Step 4 çš„è§’è‰²æ•°æ®
    const chars = window.lfProjectData.step4_chars;
    if (!chars || chars.length < 2) {
        alert("è¯·å…ˆå®Œæˆ Step 4ï¼Œè‡³å°‘éœ€è¦ç”Ÿæˆ 2 ä¸ªè§’è‰²æ‰èƒ½æ„å»ºå…³ç³»ç½‘ï¼");
        wizardPrevStep();
        return;
    }

    // UI Loading
    const canvas = document.getElementById('lfw-relation-canvas');
    const list = document.getElementById('lfw-relation-list');
    canvas.innerHTML = `<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;"><div class="lfw-loading-scan"></div><div style="font-size:10px; color:#999; margin-top:10px;">ANALYZING BONDS...</div></div>`;
    list.innerHTML = '';

    // 2. å‡†å¤‡ Prompt æ•°æ®
    // åªå‘é€åå­—ã€è§’è‰²å’Œ Bioï¼Œå‡å°‘ token æ¶ˆè€—
    const charSummary = chars.map(c => `- ${c.name} (${c.role}): ${c.bio.substring(0, 50)}...`).join('\n');

    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå°è¯´å…³ç³»æ¶æ„å¸ˆã€‚è¯·æ ¹æ®æä¾›çš„äººç‰©åˆ—è¡¨ï¼Œåˆ†æä»–ä»¬ä¹‹é—´æœ€æ ¸å¿ƒçš„äººç‰©å…³ç³»ã€‚
    å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼Œä¸¥ç¦ Markdownã€‚
    
    ã€è¦æ±‚ã€‘
    1. æ‰¾å‡º 3-6 ç»„æœ€é‡è¦çš„å…³ç³»ï¼ˆä¸è¦æ‰€æœ‰äººéƒ½ä¸¤ä¸¤ç›¸è¿ï¼Œå¤ªä¹±ï¼‰ã€‚
    2. "desc" æ˜¯å…³ç³»ç®€è¿°ï¼ˆå¦‚ï¼šæš—æ‹ã€æ€çˆ¶ä¹‹ä»‡ã€åˆ©ç”¨ï¼‰ï¼Œä¸è¶…è¿‡ 6 ä¸ªå­—ã€‚
    3. å¿…é¡»ä½¿ç”¨æä¾›çš„å‡†ç¡®äººåã€‚
    
    ã€JSON æ ¼å¼ã€‘
    [
        { "source": "è§’è‰²Aåå­—", "target": "è§’è‰²Båå­—", "desc": "å…³ç³»æè¿°" },
        ...
    ]`;

    const userPrompt = `äººç‰©åˆ—è¡¨ï¼š\n${charSummary}\nè¯·ç”Ÿæˆå…³ç³»ç½‘æ•°æ®ã€‚`;

    try {
        // 3. API è¯·æ±‚
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 0.5 // é™ä½éšæœºæ€§ï¼Œä¿è¯å…³ç³»ç¨³å›º
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        let rawContent = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '');
        const relationships = JSON.parse(rawContent);

        // 4. æ•°æ®å…¥åº“
        window.lfProjectData.step5_relations = relationships;
        console.log("[Step 5] Relations:", relationships);

        // 5. æ¸²æŸ“è§†è§‰å›¾è°± & æ–‡å­—å¡ç‰‡
        renderVisualGraph(chars, relationships);
        renderRelationCards(chars, relationships);

    } catch (e) {
        console.error(e);
        canvas.innerHTML = `<div style="color:red; text-align:center; padding-top:100px;">Error: ${e.message}</div>`;
    }
};

// --- ğŸ­ Step 4: è§’è‰²ç”Ÿæˆæµæ°´çº¿ ---

// çŠ¶æ€æœºå˜é‡
var lfCharState = {
    targetCP: 0,      // ç›®æ ‡CPå¯¹æ•°
    targetTotal: 0,   // ç›®æ ‡æ€»äººæ•°
    currentCP: 0,     // å½“å‰å·²ç”ŸæˆCPæ•°
    currentSolo: 0,   // å½“å‰å·²ç”Ÿæˆå•äººæ•°
    generatedList: [], // å·²å…¥åº“çš„è§’è‰²åˆ—è¡¨ [{name, role, avatar, bio...}]
    isGenerating: false,
    tempAvatarTarget: null // å½“å‰æ­£åœ¨æ¢å¤´åƒçš„ img å…ƒç´ 
};

/**
 * 1. å¯åŠ¨ç”Ÿæˆæµæ°´çº¿
 */
window.startCharGeneration = function() {
    const cpInput = parseInt(document.getElementById('step4-cp-count').value) || 0;
    const totalInput = parseInt(document.getElementById('step4-total-count').value) || 0;
    const warningEl = document.getElementById('step4-warning');

    // é€»è¾‘æ ¡éªŒ
    if (totalInput < cpInput * 2) {
        warningEl.style.display = 'block';
        warningEl.innerText = `âš ï¸ é€»è¾‘é”™è¯¯ï¼š${cpInput} å¯¹ CP è‡³å°‘éœ€è¦ ${cpInput * 2} ä¸ªäººã€‚è¯·å¢åŠ æ€»äººæ•°ã€‚`;
        return;
    }
    warningEl.style.display = 'none';

    // åˆå§‹åŒ–çŠ¶æ€
    lfCharState = {
        targetCP: cpInput,
        targetTotal: totalInput,
        currentCP: 0,
        currentSolo: 0,
        generatedList: [],
        isGenerating: false
    };

    // æ¸…ç©ºåŒºåŸŸ
    document.getElementById('step4-dynamic-area').innerHTML = '';

    // å¼€å§‹ç¬¬ä¸€æ³¢ä»»åŠ¡
    processNextCharTask();
};

/**
 * 3. çœŸå® AI è°ƒç”¨ï¼šç”Ÿæˆ CP (ä¸€å¯¹) - [å·²ä¿®å¤ç©ºå€¼æŠ¥é”™]
 */
window.callAIForCP = async function(index) {
    // --- ğŸ›¡ï¸ é²æ£’æ€§æ£€æŸ¥ ---
    // é˜²æ­¢ step3_style ä¸º null å¯¼è‡´ .name æŠ¥é”™
    const step1 = window.lfProjectData.step1_core || { synopsis: "æš‚æ— ç®€ä»‹" };
    const step2 = window.lfProjectData.step2_title || "æœªå‘½åä½œå“";
    const step3 = window.lfProjectData.step3_style || { name: "é€šç”¨é£æ ¼", desc: "æ ‡å‡†å™äº‹" }; 

    // å¦‚æœæ•°æ®ä¸¥é‡ç¼ºå¤±ï¼Œç»™ä¸ªè­¦å‘Šï¼ˆä½†ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç»™äº†ä¸Šé¢çš„é»˜è®¤å€¼ï¼Œæ‰€ä»¥ä¸ä¼šå´©ï¼‰
    if (!window.lfProjectData.step1_core) console.warn("âš ï¸ Warning: Step 1 data is missing.");

    // 2. è·å– API é…ç½®
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® AI Keyï¼");
    if (apiUrl.includes("deepseek")) model = "deepseek-chat"; 

    // 3. æ„é€  Prompt
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèµ„æ·±å°è¯´äººè®¾å¸ˆã€‚è¯·åŸºäºç”¨æˆ·æä¾›çš„å°è¯´è®¾å®šï¼Œè®¾è®¡ç¬¬ ${index} å¯¹æ ¸å¿ƒ CP (Couple)ã€‚
    
    ã€å°è¯´è®¾å®šã€‘
    ä¹¦åï¼šã€Š${step2}ã€‹
    ç®€ä»‹ï¼š${step1.synopsis}
    æ–‡é£ï¼š${step3.name} (${step3.desc})

    ã€è¾“å‡ºè¦æ±‚ã€‘
    1. å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸¥ç¦ Markdownã€‚
    2. æ¯ä¸ªäººç‰©çš„äººè®¾ (bio) å¿…é¡»**ä¸å°‘äº 300 å­—**ï¼ŒåŒ…å«ï¼šå¤–è²Œç‰¹å¾ã€æ€§æ ¼ç¼ºé™·ã€æ ¸å¿ƒç§˜å¯†ã€ä»¥åŠå¯¹å¦ä¸€åŠçš„å¤æ‚æƒ…æ„Ÿã€‚
    3. ä¸¤äººå…³ç³» (relation) è¦å¼ åŠ›åè¶³ï¼Œç¬¦åˆæ–‡é£ã€‚

    ã€JSON æ ¼å¼ã€‘
    {
        "charA": { "name": "å§“å", "role": "èº«ä»½", "bio": "è¯¦ç»†äººè®¾..." },
        "charB": { "name": "å§“å", "role": "èº«ä»½", "bio": "è¯¦ç»†äººè®¾..." },
        "relation": "å…³ç³»ç®€è¿°"
    }`;

    const userPrompt = `è¯·ç”Ÿæˆç¬¬ ${index} å¯¹ CP çš„è¯¦ç»†äººè®¾æ•°æ®ã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 0.85
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        // 5. è§£ææ•°æ®
        let rawContent = data.choices[0].message.content;
        rawContent = rawContent.replace(/```json/g, '').replace(/```/g, ''); 
        const result = JSON.parse(rawContent);

        // 6. æˆåŠŸï¼æ¸²æŸ“å¡ç‰‡
        fillCPCard(index, result);
        
        // âœ¨ æ–°å¢ï¼šæ¯ç”ŸæˆæˆåŠŸä¸€ä¸ªï¼Œè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡è¿›åº¦
        saveWizardDraft(); 

    } catch (e) {
        console.error(e);
        const card = document.getElementById(`cp-card-${index}`);
        if(card) {
            card.innerHTML = `
                <div style="text-align:center; padding:20px; color:red;">
                    ç”Ÿæˆå¤±è´¥: ${e.message}<br>
                    <button class="lfw-btn lfw-btn-outline" style="margin-top:10px;" onclick="callAIForCP(${index})">é‡è¯• (Retry)</button>
                </div>
            `;
        }
    }
};

/**
 * 4. çœŸå® AI è°ƒç”¨ï¼šç”Ÿæˆå•äºº (Solo) - [å·²ä¿®å¤é‡åé—®é¢˜]
 */
window.callAIForSolo = async function(index) {
    const step1 = window.lfProjectData.step1_core || { synopsis: "æš‚æ— ç®€ä»‹" };
    const step2 = window.lfProjectData.step2_title || "æœªå‘½åä½œå“";
    const step3 = window.lfProjectData.step3_style || { name: "é€šç”¨é£æ ¼", desc: "æ ‡å‡†å™äº‹" };
    
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    if (!apiKey) return alert("è¯·é…ç½® AI Key");

    // --- ğŸ›¡ï¸ æ ¸å¿ƒä¿®å¤ï¼šè·å–å·²å­˜åœ¨çš„åå­—åˆ—è¡¨ ---
    let existingNames = [];
    if (window.lfCharState && window.lfCharState.generatedList) {
        window.lfCharState.generatedList.forEach(item => {
            if (item.name) existingNames.push(item.name); // å•äºº
            if (item.charA) existingNames.push(item.charA.name); // CP A
            if (item.charB) existingNames.push(item.charB.name); // CP B
        });
    }
    const banList = existingNames.length > 0 ? existingNames.join("ã€") : "æ— ";
    // ---------------------------------------

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèµ„æ·±å°è¯´äººè®¾å¸ˆã€‚è¯·åŸºäºå°è¯´ã€Š${step2}ã€‹çš„è®¾å®šï¼Œè®¾è®¡ä¸€ä½**å•äººé‡è¦è§’è‰²** (éCPä½)ã€‚
    
    ã€å°è¯´è®¾å®šã€‘
    ç®€ä»‹ï¼š${step1.synopsis}
    æ–‡é£ï¼š${step3.name}

    ã€ğŸš¨ ç»å¯¹ç¦å¿Œã€‘
    **ä¸¥ç¦ä½¿ç”¨ä»¥ä¸‹åå­—ï¼ˆå› ä¸ºå·²å­˜åœ¨ï¼‰ï¼š${banList}**ã€‚è¯·åŠ¡å¿…èµ·ä¸€ä¸ªå…¨æ–°çš„åå­—ï¼

    ã€è¾“å‡ºè¦æ±‚ã€‘
    1. å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸¥ç¦ Markdownã€‚
    2. äººè®¾ (bio) å¿…é¡»**ä¸å°‘äº 300 å­—**ï¼Œè¯¦è¿°å…¶åœ¨æ•…äº‹ä¸­çš„åŠŸèƒ½ã€‚

    ã€JSON æ ¼å¼ã€‘
    {
        "name": "å§“å",
        "role": "èº«ä»½/åŠŸèƒ½",
        "bio": "300å­—ä»¥ä¸Šçš„è¯¦ç»†äººè®¾..."
    }`;

    const userPrompt = `è¯·ç”Ÿæˆç¬¬ ${index} å·é‡è¦é…è§’çš„è¯¦ç»†äººè®¾æ•°æ®ã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 0.9 // è°ƒé«˜ä¸€ç‚¹ï¼Œé¿å…é‡å¤
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        let content = data.choices[0].message.content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) content = jsonMatch[0];
        content = content.replace(/```json/g, '').replace(/```/g, '');
        
        const result = JSON.parse(content);

        fillSoloCard(index, result);
        saveWizardDraft();

    } catch (e) {
        console.error(e);
        const card = document.getElementById(`solo-card-${index}`);
        if(card) {
            card.innerHTML = `<div style="text-align:center; padding:20px; color:red;">ç”Ÿæˆå¤±è´¥: ${e.message}<br><button class="lfw-btn lfw-btn-outline" onclick="callAIForSolo(${index})">é‡è¯•</button></div>`;
        }
    }
};

// --- ä¿å­˜ä¸æµè½¬é€»è¾‘ ---

window.saveCPAndNext = function(index, dataStr) {
    const data = JSON.parse(unescape(dataStr));
    const card = document.getElementById(`cp-card-${index}`);
    
    // è·å–æœ€æ–°å¤´åƒ (å¯èƒ½ç”¨æˆ·æ”¹è¿‡)
    const imgs = card.querySelectorAll('img');
    
    // å…¥åº“ A
    lfCharState.generatedList.push({
        name: data.charA.name,
        role: data.charA.role,
        bio: data.charA.bio,
        avatar: imgs[0].src,
        type: 'CP_A',
        pairId: index
    });
    // å…¥åº“ B
    lfCharState.generatedList.push({
        name: data.charB.name,
        role: data.charB.role,
        bio: data.charB.bio,
        avatar: imgs[1].src,
        type: 'CP_B',
        pairId: index
    });

    // è§†è§‰åé¦ˆï¼šé”å®šå¡ç‰‡
    lockCardUI(card);
    
    // ç»§ç»­æµç¨‹
    processNextCharTask();
};

window.saveSoloAndNext = function(index, dataStr) {
    const data = JSON.parse(unescape(dataStr));
    const card = document.getElementById(`solo-card-${index}`);
    const img = card.querySelector('img');

    // å…¥åº“
    lfCharState.generatedList.push({
        name: data.name,
        role: data.role,
        bio: data.bio,
        avatar: img.src,
        type: 'SOLO'
    });

    lockCardUI(card);
    processNextCharTask();
};

function lockCardUI(cardEl) {
    cardEl.style.opacity = '0.6';
    cardEl.style.pointerEvents = 'none'; // ç¦æ­¢å†æ¬¡ä¿®æ”¹
    cardEl.querySelector('.lfw-btn-black').innerText = "Saved";
    cardEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// --- å¤´åƒä¸Šä¼ é€»è¾‘ ---
window.triggerAvatarUpload = function(imgEl) {
    lfCharState.tempAvatarTarget = imgEl;
    document.getElementById('step4-avatar-upload').click();
};

// --- ğŸ¨ Step 3: æ–‡é£ä¸åŸºè°ƒé€»è¾‘ ---

// æš‚å­˜åŒº
var lfStep3Cache = [];
var lfStep3Index = 0;

// è¾…åŠ©å‡½æ•°ï¼šåˆ‡æ¢é£æ ¼ (éœ€è¦åŠ åˆ°ä»£ç é‡Œ)
window.changeStyleIndex = function(delta) {
    if (!lfStep3Cache) return;
    const newIndex = lfStep3Index + delta;
    if (newIndex >= 0 && newIndex < lfStep3Cache.length) {
        lfStep3Index = newIndex;
        renderStyleCard();
    }
};

/**
 * 4. è‡ªåŠ¨æ¨èå…¥å£ (æ— éœ€å¤§æ”¹)
 */
window.generateAutoStyle = async function() {
    // ç¡®ä¿æœ‰ window.lfProjectData å¯¹è±¡ï¼Œé˜²æ­¢æŠ¥é”™
    if (!window.lfProjectData || !window.lfProjectData.step1_core) {
        return alert("è¯·å…ˆå®Œæˆ Step 1 çš„ç®€ä»‹å¡«å†™ï¼");
    }

    const step1Data = window.lfProjectData.step1_core;
    showStyleLoading();

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ–‡å­¦é£æ ¼å¤§å¸ˆã€‚è¯·æ ¹æ®ç”¨æˆ·çš„æ•…äº‹ç®€ä»‹ï¼Œæ¨è 3 ç§æœ€é€‚åˆçš„å™äº‹é£æ ¼ï¼ˆå¦‚ï¼šå†·ç¡¬æ´¾ã€æ„è¯†æµã€è½»å°è¯´ç­‰ï¼‰ã€‚
    å¹¶é’ˆå¯¹è¯¥æ•…äº‹å†™ä¸€æ®µ 200 å­—å·¦å³çš„ã€å¼€åœºç™½è¯•å†™ã€‘ã€‚
    
    å¿…é¡»åªè¿”å›çº¯ JSON æ•°ç»„ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ï¼Œæ ¼å¼å¦‚ä¸‹:
    [
        { "name": "é£æ ¼åç§°", "desc": "é£æ ¼ç‰¹ç‚¹æè¿°", "sample": "åŸºäºæ•…äº‹çš„è¯•å†™ç‰‡æ®µ..." }
    ]`;
    
    const userPrompt = `æ•…äº‹ç®€ä»‹ï¼š${step1Data.synopsis}ã€‚è¯·æ¨èæ–‡é£å¹¶è¯•å†™ã€‚`;
    
    await callAIForStyle(systemPrompt, userPrompt);
};

/**
 * 2. ç”¨æˆ·æŒ‡å®šæ–‡é£ (Manual)
 * ç”¨æˆ·è¾“å…¥"èµ›åšæœ‹å…‹"ï¼ŒAI ç”Ÿæˆè¯¥é£æ ¼çš„è¯•å†™
 */
window.generateManualStyle = async function() {
    const step1Data = window.lfProjectData.step1_core;
    const inputStyle = document.getElementById('step3-input-style').value.trim();
    
    if (!step1Data) return alert("è¯·å…ˆå®Œæˆ Step 1ï¼");
    if (!inputStyle) return alert("è¯·è¾“å…¥ä½ æƒ³è¦çš„é£æ ¼ï¼Œä¾‹å¦‚'åºŸåœŸé£'ã€'ç‹å®¶å«é£æ ¼'...");

    showStyleLoading();

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ–‡å­¦æ¨¡ä»¿å¤§å¸ˆã€‚ç”¨æˆ·ä¼šæŒ‡å®šä¸€ç§é£æ ¼ï¼Œè¯·ç”¨è¿™ç§é£æ ¼ä¸ºç”¨æˆ·çš„æ•…äº‹å†™ä¸€æ®µ 200 å­—å·¦å³çš„ã€å¼€åœºç™½è¯•å†™ã€‘ã€‚
    
    å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼ˆè™½ç„¶åªæœ‰1ä¸ªï¼Œä½†ä¿æŒæ ¼å¼ç»Ÿä¸€ï¼‰ï¼Œæ ¼å¼:
    [
        { "name": "${inputStyle}", "desc": "AIå¯¹è¯¥é£æ ¼çš„ç†è§£ä¸è§£æ", "sample": "ä½¿ç”¨è¯¥é£æ ¼çš„è¯•å†™ç‰‡æ®µ..." }
    ]`;
    
    const userPrompt = `æ•…äº‹ç®€ä»‹ï¼š${step1Data.synopsis}ã€‚æŒ‡å®šé£æ ¼ï¼š${inputStyle}ã€‚`;

    await callAIForStyle(systemPrompt, userPrompt);
};

/**
 * 3. åˆ‡æ¢å€™é€‰é£æ ¼ (Swap)
 */
window.swapStyle = function() {
    if (!lfStep3Cache || lfStep3Cache.length <= 1) return;
    lfStep3Index = (lfStep3Index + 1) % lfStep3Cache.length;
    renderStyleCard();
};

/**
 * 4. ç¡®è®¤é€‰æ‹©é£æ ¼ (Confirm) - [å…³é”®ä¿®å¤ï¼]
 * å°†å½“å‰æ˜¾ç¤ºçš„é£æ ¼å†™å…¥å…¨å±€æ•°æ®
 */
window.confirmStyle = function() {
    if (!lfStep3Cache || lfStep3Cache.length === 0) return;
    
    // 1. è·å–å½“å‰æ•°æ®
    const selectedStyle = lfStep3Cache[lfStep3Index];
    
    // 2. å†™å…¥å…¨å±€åº“ (Step 4 å°±ä¸æŠ¥é”™äº†ï¼)
    window.lfProjectData.step3_style = selectedStyle;
    
    // 3. UI åé¦ˆ
    document.getElementById('step3-status-bar').style.display = 'flex';
    document.getElementById('step3-selected-name').innerText = selectedStyle.name;
    
    // 4. è‡ªåŠ¨ä¿å­˜
    saveWizardDraft();
    
    // 5. æç¤ºç”¨æˆ·å¯ä»¥ä¸‹ä¸€æ­¥äº†
    // è¿™é‡Œä½ å¯ä»¥åšä¸€ä¸ªå°åŠ¨ç”»ï¼Œæˆ–è€…è®© Next Step æŒ‰é’®é«˜äº®
    console.log("âœ… Style Confirmed:", selectedStyle);
};

// --- ğŸ“š Step 2: ä¹¦åç”Ÿæˆé€»è¾‘ ---

// æš‚å­˜ Step 2 çš„ AI ç»“æœåˆ—è¡¨ (ç”¨äºâ€œæ¢ä¸€æ¢â€ç§’åˆ‡)
var lfStep2Cache = [];
var lfStep2Index = 0;

/**
 * 2. è°ƒç”¨ AI ç”Ÿæˆ (ä¸€æ¬¡ç”Ÿæˆ5ä¸ª)
 */
window.generateBookTitles = async function() {
    // æ£€æŸ¥ Step 1 æ˜¯å¦å®Œæˆ
    const step1Data = window.lfProjectData.step1_core;
    if (!step1Data || !step1Data.synopsis) {
        alert("è¯·å…ˆå®Œæˆ Step 1 çš„æ•…äº‹ç®€ä»‹ï¼AI éœ€è¦æ ¹æ®ç®€ä»‹æ¥å–åã€‚");
        // è‡ªåŠ¨åˆ‡å›ä¸Šä¸€é¡µ
        wizardPrevStep();
        return;
    }

    // UI Loading
    const card = document.getElementById('card-step2');
    const titleText = document.getElementById('step2-result-text');
    card.style.display = 'block';
    titleText.innerHTML = `<span style="font-size:14px; color:#999;">Thinking...</span>`;

    // API é…ç½®
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    // Prompt: è¦æ±‚è¿”å›çº¯æ•°ç»„
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå‡ºç‰ˆç•Œçš„èµ·åå¤§å¸ˆã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„æ•…äº‹ç®€ä»‹ï¼Œæ„æ€ 5 ä¸ªä¸åŒé£æ ¼çš„ä¹¦åï¼ˆå¦‚ï¼šæ–‡è‰ºé£ã€æ‚¬ç–‘é£ã€è½»å°è¯´é£ï¼‰ã€‚
    å¿…é¡»è¿”å›çº¯ JSON å­—ç¬¦ä¸²æ•°ç»„ï¼Œä¸è¦Markdownã€‚
    æ ¼å¼: ["ä¹¦å1", "ä¹¦å2", "ä¹¦å3", "ä¹¦å4", "ä¹¦å5"]`;

    const userPrompt = `æ•…äº‹ç®€ä»‹ï¼š${step1Data.synopsis}ã€‚è¯·ç”Ÿæˆ 5 ä¸ªå¸å¼•äººçš„ä¹¦åã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 0.9 // è„‘æ´å¤§ä¸€ç‚¹
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        // è§£ææ•°ç»„
        let content = data.choices[0].message.content;
        content = content.replace(/```json/g, '').replace(/```/g, ''); // æ¸…ç†
        lfStep2Cache = JSON.parse(content);
        
        // é»˜è®¤æ˜¾ç¤ºç¬¬1ä¸ª
        lfStep2Index = 0;
        renderCurrentTitle();

    } catch (e) {
        console.error(e);
        titleText.innerHTML = `<span style="font-size:12px; color:red;">ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</span>`;
    }
};

/**
 * 3. æ¢ä¸€æ¢ (æœ¬åœ°è½®æ’­ï¼Œä¸æ¶ˆè€— token)
 */
window.swapBookTitle = function() {
    if (lfStep2Cache.length === 0) return;
    lfStep2Index = (lfStep2Index + 1) % lfStep2Cache.length; // å¾ªç¯ç´¢å¼•
    renderCurrentTitle();
};

/**
 * 4. æ ¸å¿ƒï¼šç¡®è®¤å¹¶å…¥åº“ (Confirm)
 */
window.confirmBookTitle = function() {
    // ä¼˜å…ˆå– AI ç”Ÿæˆçš„å½“å‰å±•ç¤ºå€¼
    let finalTitle = "";
    
    // å¦‚æœå¡ç‰‡æ˜¾ç¤ºäº†ï¼Œå°±å–å¡ç‰‡é‡Œçš„
    const card = document.getElementById('card-step2');
    if (card.style.display !== 'none' && lfStep2Cache.length > 0) {
        finalTitle = lfStep2Cache[lfStep2Index];
    } 
    // å¦åˆ™å–è¾“å…¥æ¡†çš„
    else {
        finalTitle = document.getElementById('step2-input-title').value.trim();
    }

    if (!finalTitle) return alert("è¯·å…ˆç”Ÿæˆæˆ–è¾“å…¥ä¸€ä¸ªä¹¦åï¼");

    // å»é™¤å¯èƒ½é‡å¤çš„ä¹¦åå·
    finalTitle = finalTitle.replace(/ã€Š|ã€‹/g, '');

    // --- ğŸ’¾ å­˜å…¥å…¨å±€æ•°æ®åº“ ---
    window.lfProjectData.step2_title = finalTitle;
    
    // UI åé¦ˆ
    const cardEl = document.getElementById('card-step2');
    cardEl.style.background = "#000"; // å˜é»‘
    cardEl.style.color = "#fff";
    cardEl.querySelector('.lfw-title-text').style.color = "#fff";
    
    // æ§åˆ¶å°æ—¥å¿— (ä½ è¦çš„éƒ¨åˆ†)
    console.log("-------------------------------------");
    console.log("[DB Save] Step 2 Completed.");
    console.log("[Field] Title: ã€Š" + finalTitle + "ã€‹");
    console.log("[Status] Saved to window.lfProjectData");
    console.log("Current Data Snapshot:", window.lfProjectData);
    console.log("-------------------------------------");

    // å¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨è·³åˆ°ä¸‹ä¸€æ­¥ (å¯é€‰)
    // setTimeout(wizardNextStep, 800);
};

/**
 * è¾…åŠ©ï¼šå¦‚æœç”¨æˆ·æ‰‹åŠ¨æ‰“å­—ï¼Œå°±é‡ç½® AI å¡ç‰‡çš„é€‰ä¸­çŠ¶æ€
 */
window.resetStep2Selection = function() {
    const card = document.getElementById('card-step2');
    // å¦‚æœç”¨æˆ·å¼€å§‹æ‰“å­—ï¼ŒæŠŠAIæ¨èå¡ç‰‡å˜å›æœªé€‰ä¸­æ ·å¼çš„é¢œè‰²ï¼Œæˆ–è€…ç›´æ¥éšè—
    // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©è®©å®ƒå˜å›é»˜è®¤é¢œè‰²ï¼Œè¡¨ç¤º"æœªç¡®è®¤"
    card.style.background = "#fffcf0";
    card.style.color = "#000";
    card.querySelector('.lfw-title-text').style.color = "#000";
};

// --- ğŸ’¾ å…¨å±€é¡¹ç›®æ•°æ®å­˜å‚¨ (æš‚å­˜åŒº) ---
window.lfProjectData = {
    step1_core: null,  // æ•…äº‹æ ¸å¿ƒ { hook, content }
    step2_title: null,
    step3_style: null,
    step4_chars: [],
    step5_relations: [],
    step7_specs: null
};

/**
 * ğŸ§  Step 1: AI ç”Ÿæˆæ•…äº‹ç®€ä»‹
 */
window.generateStoryCore = async function() {
    // 1. è·å–é…ç½® (å¤ç”¨ä½ çš„é€»è¾‘)
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    
    // è·å–ç”¨æˆ·è¾“å…¥
    const userInput = document.querySelector('#lf-wizard-page textarea').value.trim();
    
    if (!apiKey) return alert("PROTOCOL_ERROR: è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® AI å¯†é’¥");

    // 2. UI å˜ä¸ºåŠ è½½çŠ¶æ€
    const card = document.getElementById('card-step1');
    card.style.display = 'block'; // æ˜¾ç¤ºå¡ç‰‡
    card.innerHTML = `
        <div style="padding:20px; text-align:center; color:#999; font-family:monospace;">
            <div class="lfw-loading-scan"></div> <div>CONNECTING_TO_NEURAL_NETWORK...</div>
            <div style="font-size:10px; margin-top:5px;">ANALYZING_INPUT_VECTORS</div>
        </div>
    `;

    // 3. è‡ªåŠ¨ä¿®æ­£æ¨¡å‹ (DeepSeek å…¼å®¹)
    if (apiUrl.includes("deepseek")) {
        console.log("æ£€æµ‹åˆ° DeepSeek ç¯å¢ƒï¼Œè‡ªåŠ¨ä¿®æ­£æ¨¡å‹åç§°...");
        model = "deepseek-chat"; 
    }

    // 4. Prompt è®¾è®¡ (å¤§å¸ˆçº§Â·æ¶æ„å¸ˆæ¨¡å¼)
    const systemPrompt = `ä½ æ˜¯ä¸€ä½æ‹¥æœ‰æ•é”å¸‚åœºå—…è§‰çš„èµ„æ·±å°è¯´ä¸»ç¼–å’Œæ¶æ„å¸ˆã€‚
    ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„è¾“å…¥ï¼ˆå¯èƒ½æ˜¯ç ´ç¢çš„çµæ„Ÿã€å…·ä½“çš„è®¾å®šï¼Œä¹Ÿå¯èƒ½ä»…ä»…æ˜¯å‡ ä¸ªé£æ ¼æ ‡ç­¾ï¼Œå¦‚"å¹´ä¸Š"ã€"é…¸æ¶©"ã€"èµ›åšæœ‹å…‹"ï¼‰ï¼Œæ„å»ºä¸€ä¸ªå®Œæ•´ã€è¿·äººä¸”é€»è¾‘è‡ªæ´½çš„æ•…äº‹é›å½¢ã€‚

    ã€å¤„ç†é€»è¾‘ã€‘
    1. **æ ‡ç­¾åŒ–å¤„ç†**ï¼šå¦‚æœç”¨æˆ·åªè¾“å…¥äº†é£æ ¼/äººè®¾æ ‡ç­¾ï¼ˆå¦‚â€œç ´é•œé‡åœ†â€ã€â€œé«˜å¹²æ–‡â€ï¼‰ï¼Œè¯·åŠ¡å¿…å…·ä½“åŒ–ï¼Œåˆ›é€ ä¸€ä¸ªç¬¦åˆè¯¥æ ‡ç­¾çš„ç»å…¸ä¸”æœ‰æ–°æ„çš„å…·ä½“æ•…äº‹ï¼Œä¸è¦åªå†™ç©ºæ³›çš„è®¾å®šã€‚
    2. **æ·±åº¦æ‰©å†™**ï¼šå¦‚æœç”¨æˆ·è¾“å…¥äº†å…·ä½“æƒ…èŠ‚ï¼Œè¯·ä»¥æ­¤ä¸ºéª¨æ¶ï¼Œä¸°æ»¡è¡€è‚‰ï¼Œè¡¥å……åŠ¨æœºã€è½¬æŠ˜å’Œæ·±å±‚å†²çªã€‚
    3. **æ°›å›´è¥é€ **ï¼šæ ¹æ®é¢˜æè°ƒæ•´æ–‡é£ã€‚æ‚¬ç–‘è¦å†·å³»ï¼Œè¨€æƒ…è¦ç»†è…»ï¼Œç§‘å¹»è¦å®å¤§ã€‚

    ã€è¾“å‡ºè¦æ±‚ã€‘
    å¿…é¡»è¿”å›ä¸¥æ ¼çš„çº¯ JSON æ ¼å¼ï¼Œä¸¥ç¦åŒ…å« Markdownï¼ˆå¦‚ \`\`\`jsonï¼‰ã€‚
    JSON ç»“æ„å¦‚ä¸‹ï¼š
    {
        "hook": "ä¸€å¥æå…·å¼ åŠ›çš„ä¸­æ–‡é«˜æ¦‚å¿µæ–‡æ¡ˆï¼ˆç±»ä¼¼ä¹¦è…°æ¨èè¯­ï¼‰ï¼Œè¦ç›´å‡»ç—›ç‚¹ï¼Œä¸è¶…è¿‡30å­—ã€‚",
        "synopsis": "ä¸å°‘äº 200 å­—çš„è¯¦ç»†æ•…äº‹ç®€ä»‹ã€‚å¿…é¡»åŒ…å«ï¼šä¸»è§’èº«ä»½ä¸ç°çŠ¶ -> æ ¸å¿ƒäº‹ä»¶(èµ·å› ) -> æƒ…æ„Ÿ/åˆ©ç›Šå†²çª(ç»è¿‡) -> å·¨å¤§çš„æ‚¬å¿µæˆ–ä¸¤éš¾å›°å¢ƒ(é«˜æ½®æš—ç¤º)ã€‚æ‹’ç»æµæ°´è´¦ï¼Œè¦æœ‰æ–‡å­¦æ€§ã€‚"
    }`;

    const userPrompt = userInput ? 
        `ã€ç”¨æˆ·è¾“å…¥çµæ„Ÿã€‘ï¼š"${userInput}"\nè¯·ä»¥æ­¤ä¸ºæ ¸å¿ƒï¼Œæ„æ¶ä¸€éƒ¨é«˜è´¨é‡çš„å°è¯´ç®€ä»‹ã€‚` : 
        `ã€ç”¨æˆ·æœªè¾“å…¥ã€‘ï¼šè¯·éšæœºç”Ÿæˆä¸€ä¸ªç›®å‰å¸‚åœºä¸Šç¨€ç¼ºä¸”é«˜æ¦‚å¿µçš„æ‚¬ç–‘æˆ–éƒ½å¸‚æƒ…æ„Ÿæ•…äº‹ï¼ˆå¦‚ï¼šå…¨å‘˜æ¶äººã€åŒå¼ºåšå¼ˆç­‰ï¼‰ï¼Œè¦æ±‚è®¾å®šæƒŠè‰³ã€‚`;
        
    try {
        // 5. å‘èµ·è¯·æ±‚
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [
                    {role: "system", content: systemPrompt}, 
                    {role: "user", content: userPrompt}
                ],
                temperature: 0.8 // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œè®©æ•…äº‹æ›´æœ‰åˆ›æ„
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        
        // 6. è§£ææ•°æ®
        let rawContent = data.choices[0].message.content;
        // æ¸…ç†å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
        rawContent = rawContent.replace(/```json/g, '').replace(/```/g, '');
        
        const result = JSON.parse(rawContent);

        // 7. æ¸²æŸ“ç»“æœå¡ç‰‡
        renderStep1Result(result);

        // 8. å­˜å…¥å…¨å±€æš‚å­˜åŒº
        window.lfProjectData.step1_core = result;

    } catch (e) {
        console.error(e);
        card.innerHTML = `
            <div style="color:red; text-align:center; padding:10px;">
                ERROR: ${e.message}<br>
                <button class="lfw-btn lfw-btn-outline" onclick="generateStoryCore()" style="margin-top:10px;">Retry</button>
            </div>
        `;
    }
};

/**
 * ğŸ¨ æ¸²æŸ“ Step 1 ç»“æœå¡ç‰‡
 */
function renderStep1Result(data) {
    const card = document.getElementById('card-step1');
    
    // SVG å›¾æ ‡å®šä¹‰ (å¤ç”¨ä¹‹å‰çš„)
    const iconRefresh = `<svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>`;
    const iconCheck = `<svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

    card.innerHTML = `
        <div style="font-weight:700; margin-bottom:8px; display:flex; justify-content:space-between;">
            <span>AI Proposal</span>
            <span style="font-size:10px; background:#f0f0f2; padding:2px 6px; border-radius:4px;">Draft</span>
        </div>
        <div class="lfw-sub-text" style="font-size:14px; line-height:1.6; color:#555; font-family:'Songti SC',serif;">
            "${data.hook}"<br><br>
            ${data.synopsis}
        </div>
        <div class="lfw-btn-row">
            <button class="lfw-btn lfw-btn-outline" onclick="event.stopPropagation(); generateStoryCore()">
                ${iconRefresh} Swap
            </button>
            <button class="lfw-btn lfw-btn-black" onclick="event.stopPropagation(); wizardSelectCard('card-step1')">
                ${iconCheck} Adopt
            </button>
        </div>
    `;
}

/**
 * âœï¸ æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ (Use Mine æŒ‰é’®é€»è¾‘)
 */
window.useMyStoryCore = function() {
    const userInput = document.querySelector('#lf-wizard-page textarea').value.trim();
    if (!userInput) return alert("è¯·è¾“å…¥ä½ çš„æ•…äº‹æè¿°");

    const manualData = {
        hook: "ORIGINAL CONCEPT",
        synopsis: userInput
    };

    const card = document.getElementById('card-step1');
    card.style.display = 'block';
    renderStep1Result(manualData);
    
    // è‡ªåŠ¨é€‰ä¸­
    wizardSelectCard('card-step1');
    window.lfProjectData.step1_core = manualData;
};

/* --- ğŸš€ Lost & Found: åˆ›ä½œå‘å¯¼é€»è¾‘ --- */

// çŠ¶æ€å˜é‡
var lfWizardCurrentStep = 0;
var lfWizardTotalSteps = 7;

// --- ğŸ’ ç»ˆæç‰ˆï¼šIndexedDB æ•°æ®åº“é©±åŠ¨ (æ— å¤§å°é™åˆ¶) ---

    // å…¨å±€å˜é‡
    var currentEditId = null;
    var currentEditType = null;
    var db; // æ•°æ®åº“å®ä¾‹

    // 1. åˆå§‹åŒ–æ•°æ®åº“
    var request = indexedDB.open("LunePhoneDB", 1);

    request.onupgradeneeded = function(event) {
        db = event.target.result;
        // åˆ›å»ºä¸€ä¸ªå« 'images' çš„ä»“åº“ï¼Œä¸ç”¨è‡ªå¢IDï¼Œç›´æ¥ç”¨å…ƒç´ IDä½œä¸ºé”®
        if (!db.objectStoreNames.contains('images')) {
            db.createObjectStore('images');
        }
        // åˆ›å»ºä¸€ä¸ªå« 'texts' çš„ä»“åº“å­˜æ–‡å­—
        if (!db.objectStoreNames.contains('texts')) {
            db.createObjectStore('texts');
        }
    };

    request.onsuccess = function(event) {
        db = event.target.result;
        console.log("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼");
        loadAllData(); // æ•°æ®åº“è¿ä¸Šåï¼Œç«‹å³åŠ è½½æ•°æ®
    };

    request.onerror = function(event) {
        console.error("âŒ æ•°æ®åº“æ‰“å¼€å¤±è´¥:", event.target.errorCode);
    };

    // 2. åŠ è½½æ‰€æœ‰æ•°æ® (æ–‡å­— + å›¾ç‰‡)
    function loadAllData() {
        var ids = ['p3-avatar', 'p3-name', 'p3-sign', 'p3-img-1', 'p3-img-2', 'p3-img-3'];
        
        ids.forEach(function(id) {
            var el = document.getElementById(id);
            if (!el) return;

            // A. åŠ è½½æ–‡å­—
            var textTx = db.transaction(['texts'], 'readonly');
            var textStore = textTx.objectStore('texts');
            var textReq = textStore.get(id);
            textReq.onsuccess = function() {
                if (textReq.result) el.innerText = textReq.result;
            };

            // B. åŠ è½½å›¾ç‰‡/é¢œè‰²
            var imgTx = db.transaction(['images'], 'readonly');
            var imgStore = imgTx.objectStore('images');
            var imgReq = imgStore.get(id);
            imgReq.onsuccess = function() {
                var data = imgReq.result;
                if (data) {
                    // å¦‚æœæ˜¯ Blob/File å¯¹è±¡ (æœ¬åœ°ä¸Šä¼ çš„å¤§å›¾)
                    if (data instanceof Blob) {
                        var url = URL.createObjectURL(data);
                        el.style.background = "url('" + url + "')";
                        el.style.backgroundSize = 'cover';
                        el.style.backgroundPosition = 'center';
                    } 
                    // å¦‚æœæ˜¯å­—ç¬¦ä¸² (é¢œè‰²ä»£ç  æˆ– ç½‘ç»œURL)
                    else if (typeof data === 'string') {
                        if (data.startsWith('#') || data.startsWith('rgb') || data.includes('gradient')) {
                            el.style.background = data;
                        } else {
                            el.style.background = "url('" + data + "')";
                            el.style.backgroundSize = 'cover';
                            el.style.backgroundPosition = 'center';
                        }
                    }
                }
            };
        });
    }

    // 3. æ‰“å¼€å¼¹çª—
    window.openEditModal = function(elementId, type) {
        currentEditId = elementId;
        currentEditType = type;
        
        var modal = document.getElementById('universal-modal');
        var title = document.getElementById('editor-title');
        var textSection = document.getElementById('editor-type-text');
        var imageSection = document.getElementById('editor-type-image');
        
        if(modal) modal.style.display = 'flex';
        
        var el = document.getElementById(elementId);
        
        if (type === 'text') {
            title.innerText = "ä¿®æ”¹æ–‡å­—";
            textSection.style.display = 'block';
            imageSection.style.display = 'none';
            document.getElementById('editor-input-text').value = el.innerText;
        } else {
            title.innerText = "æ›´æ¢å›¾ç‰‡/é¢œè‰²";
            textSection.style.display = 'none';
            imageSection.style.display = 'block';
            document.getElementById('file-name-display').innerText = "æœªé€‰æ‹©æ–‡ä»¶";
            document.getElementById('editor-input-url').value = ""; 
        }
    };

    // 4. å…³é—­å¼¹çª—
    window.closeEditModal = function() {
        document.getElementById('universal-modal').style.display = 'none';
    };

    // 5. Tab åˆ‡æ¢
    window.switchTab = function(mode) {
        var urlContent = document.getElementById('tab-content-url');
        var fileContent = document.getElementById('tab-content-file');
        var btns = document.querySelectorAll('.tab-btn');
        
        if (mode === 'url') {
            urlContent.style.display = 'block';
            fileContent.style.display = 'none';
            if(btns[0]) btns[0].classList.add('active');
            if(btns[1]) btns[1].classList.remove('active');
        } else {
            urlContent.style.display = 'none';
            fileContent.style.display = 'block';
            if(btns[0]) btns[0].classList.remove('active');
            if(btns[1]) btns[1].classList.add('active');
        }
    };

    // 6. æ–‡ä»¶é¢„è§ˆ
    window.previewFile = function() {
        var fileInput = document.getElementById('editor-input-file');
        if (fileInput.files && fileInput.files[0]) {
            document.getElementById('file-name-display').innerText = "å·²é€‰: " + fileInput.files[0].name;
        }
    };

    // 7. ä¿å­˜æ•°æ® (æ ¸å¿ƒä¿®æ”¹ï¼šå­˜å…¥ IndexedDB)
    window.saveEditorData = function() {
        var el = document.getElementById(currentEditId);
        if (!el) return;

        if (currentEditType === 'text') {
            // --- ä¿å­˜æ–‡å­— ---
            var newVal = document.getElementById('editor-input-text').value;
            if (newVal) {
                el.innerText = newVal;
                // å­˜å…¥ texts ä»“åº“
                var tx = db.transaction(['texts'], 'readwrite');
                tx.objectStore('texts').put(newVal, currentEditId);
            }
        } else {
            // --- ä¿å­˜å›¾ç‰‡/é¢œè‰² ---
            var fileInput = document.getElementById('editor-input-file');
            var urlInput = document.getElementById('editor-input-url');
            var isFileMode = document.getElementById('tab-content-file').style.display !== 'none';
            
            // A. æ–‡ä»¶æ¨¡å¼ (å­˜ Blob å¯¹è±¡ï¼Œæ— å¤§å°é™åˆ¶)
            if (isFileMode && fileInput.files && fileInput.files[0]) {
                var file = fileInput.files[0];
                
                // ç«‹å³æ˜¾ç¤º
                var url = URL.createObjectURL(file);
                el.style.background = "url('" + url + "')";
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';

                // å­˜å…¥ images ä»“åº“ (ç›´æ¥å­˜æ–‡ä»¶å¯¹è±¡ï¼Œä¸ç”¨è½¬ Base64ï¼Œé€Ÿåº¦å¿«ä¸”ä¸é™å¤§å°)
                var tx = db.transaction(['images'], 'readwrite');
                var req = tx.objectStore('images').put(file, currentEditId);
                
                req.onsuccess = function() {
                    console.log("âœ… å¤§æ–‡ä»¶å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼");
                };
                req.onerror = function() {
                    alert("âŒ ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç¡¬ç›˜æ»¡äº†ï¼Ÿ");
                };

            } else if (urlInput.value.trim() !== "") {
                // B. URL/é¢œè‰²æ¨¡å¼ (å­˜å­—ç¬¦ä¸²)
                var newUrl = urlInput.value.trim();
                
                if (newUrl.startsWith('#') || newUrl.startsWith('rgb') || newUrl.includes('gradient')) {
                    el.style.background = newUrl;
                } else {
                    el.style.background = "url('" + newUrl + "')";
                    el.style.backgroundSize = 'cover';
                    el.style.backgroundPosition = 'center';
                }

                // å­˜å…¥ images ä»“åº“
                var tx = db.transaction(['images'], 'readwrite');
                tx.objectStore('images').put(newUrl, currentEditId);
            }
        }
        closeEditModal();
    };

    // 8. é¢œè‰²ä¿®æ”¹è¾…åŠ©
    window.fnEditColor = function(el, label) {
        event.stopPropagation();
        openEditModal(el.id || el.parentElement.id, 'image');
    };
    
// ğŸ¨ ä¸“é—¨ç”¨æ¥æ”¹é¢œè‰²çš„å‡½æ•°
window.fnEditColor = function(el, label) {
    event.stopPropagation(); // é˜²æ­¢è¯¯è§¦èƒŒæ™¯
    // è·å–å½“å‰çš„é¢œè‰²
    var current = el.style.background;
    // å¼¹çª—è¯¢é—®
    var newColor = prompt("ğŸ¨ ä¿®æ”¹[" + label + "] (è¯·è¾“å…¥é¢œè‰²ä»£ç ï¼Œå¦‚ #FF0000):", current);
    
    if (newColor && newColor.trim() !== "") {
        el.style.background = newColor;
    }
};

/**
 * ğŸš€ Lune Essence - è½¬å‘è¯¦æƒ…é¡µ
 */
window.openLuneShares = function(totalCount, items = [], mediaUrl = '', storyText = '') {
    const old = document.getElementById('lune-shares-page');
    if (old) old.remove();

    const style = document.createElement('style');
    style.id = 'lune-shares-style';
    style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap');
        #lune-shares-page {
            position: fixed; inset: 0; z-index: 2147483654; background: #fff;
            font-family: 'Urbanist', sans-serif; display: flex; flex-direction: column;
            animation: luneSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .lsh-header { padding: 70px 30px 20px 30px; border-bottom: 1px solid #f2f2f2; display: flex; justify-content: space-between; align-items: flex-end; }
        .lsh-title-box h1 { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -2px; }
        .lsh-title-box span { font-size: 14px; color: #aaa; font-weight: 600; text-transform: uppercase; }
        .lsh-close { width: 40px; height: 40px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .lsh-main { flex: 1; overflow-y: auto; padding: 10px 0 100px 0; }
        .lsh-item { display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; padding: 18px 30px; border-bottom: 1px solid #f9f9f9; }
        .lsh-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .lsh-info { display: flex; flex-direction: column; padding-right: 10px; }
        .lsh-user { font-weight: 800; font-size: 16px; }
        .lsh-action { color: #666; font-size: 14px; margin-top: 2px; }

        /* å³ä¾§ç¼©ç•¥å›¾ï¼šå¸–å­æ˜¯æ­£æ–¹å½¢ */
        .lsh-media-window {
            width: 50px; height: 50px; background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            border-radius: 6px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center; color: #fff; font-size: 8px;
        }
        .lsh-media-img { width: 100%; height: 100%; object-fit: cover; }
    `;
    document.head.appendChild(style);

    const isImg = mediaUrl && mediaUrl.startsWith('http');
    const thumbHtml = isImg 
        ? `<img src="${mediaUrl}" class="lsh-media-img" onerror="this.style.opacity='0'">` 
        : `<span style="padding:4px; transform: scale(0.8);">TEXT</span>`;

    const html = `
        <div id="lune-shares-page">
            <div class="lsh-header">
                <div class="lsh-title-box">
                    <span>${totalCount.toLocaleString()} Shares</span>
                    <h1>Forward</h1>
                </div>
                <div class="lsh-close" onclick="document.getElementById('lune-shares-page').remove()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div class="lsh-main">
                ${items.map(item => `
                    <div class="lsh-item">
                        <div style="display:flex; justify-content:center;">
                            <img src="${item.avatar}" class="lsh-avatar">
                        </div>
                        <div class="lsh-info">
                            <span class="lsh-user">${item.name}</span>
                            <span class="lsh-action">Forwarded to Chat</span>
                        </div>
                        <div class="lsh-media-window">${thumbHtml}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
};

/**
 * ğŸ› ï¸ è¿›å…¥è½¬å‘åˆ—è¡¨ï¼Œæ¸…é™¤çº¢ç‚¹
 */
window.handleOpenShares = async function() {
    const activeIdx = window.currentLuneStoryIndex || 0;
    let stories = await window.ib.getItem('my_active_story');
    if (!stories || !stories[activeIdx]) return;
    
    let story = stories[activeIdx];

    // 1. ğŸ”¥ åŒæ­¥å·²è¯»çŠ¶æ€
    story.lastSeenShares = story.shares || 0;
    
    // ä¿å­˜
    stories[activeIdx] = story;
    await window.ib.setItem('my_active_story', stories);
    
    // 2. éšè—çº¢ç‚¹
    const badge = document.getElementById('share-badge');
    if (badge) badge.style.display = 'none';

    // 3. å‡†å¤‡æ•°æ® (æ¨¡æ‹Ÿè½¬å‘ç”¨æˆ·åˆ—è¡¨ï¼Œå› ä¸ºé€šå¸¸åç«¯æ²¡è¿™ä¸ªæ•°æ®)
    // è¿™é‡Œæˆ‘ä»¬åŸºäº shares æ•°é‡ç”Ÿæˆ mock ç”¨æˆ·ï¼Œä¸ºäº†çœ‹èµ·æ¥çœŸå®
    const count = story.shares || 0;
    const items = [];
    for(let i=0; i < Math.min(count, 20); i++) {
        items.push({
            name: `User_${Math.floor(Math.random()*999)}`,
            avatar: `https://api.dicebear.com/7.x/notionists/svg?seed=${i}`
        });
    }

    window.openLuneShares(count, items, story.media || '', story.text || '');
};

/**
 * ğŸŒŸ Lune Essence - æ”¶è—è¯¦æƒ…é¡µ
 */
window.openLuneSaves = function(totalCount, items = [], mediaUrl = '', storyText = '') {
    const old = document.getElementById('lune-saves-page');
    if (old) old.remove();

    const style = document.createElement('style');
    style.id = 'lune-saves-style';
    style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap');
        #lune-saves-page {
            position: fixed; inset: 0; z-index: 2147483653; background: #fff;
            font-family: 'Urbanist', sans-serif; display: flex; flex-direction: column;
            animation: luneSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ls-header { padding: 70px 30px 20px 30px; border-bottom: 1px solid #f2f2f2; display: flex; justify-content: space-between; align-items: flex-end; }
        .ls-title-box h1 { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -2px; }
        .ls-title-box span { font-size: 14px; color: #888; font-weight: 600; text-transform: uppercase; }
        .ls-close { width: 40px; height: 40px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .ls-main { flex: 1; overflow-y: auto; padding: 10px 0 100px 0; }
        .ls-item { display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; padding: 18px 30px; border-bottom: 1px solid #f9f9f9; }
        .ls-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .ls-info { display: flex; flex-direction: column; padding-right: 10px; }
        .ls-user { font-weight: 800; font-size: 16px; }
        .ls-action { color: #666; font-size: 14px; margin-top: 2px; }

        /* å³ä¾§ç¼©ç•¥å›¾ */
        .ls-media-window {
            width: 44px; height: 66px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center; color: #fff; font-size: 8px;
        }
        .ls-media-img { width: 100%; height: 100%; object-fit: cover; }
    `;
    document.head.appendChild(style);

    const isImg = mediaUrl && mediaUrl.startsWith('http');
    const thumbHtml = isImg 
        ? `<img src="${mediaUrl}" class="ls-media-img" onerror="this.style.opacity='0'">` 
        : `<span style="padding:4px; transform: scale(0.8);">${storyText.substring(0, 8)}</span>`;

    const html = `
        <div id="lune-saves-page">
            <div class="ls-header">
                <div class="ls-title-box">
                    <span>${totalCount.toLocaleString()} Collections</span>
                    <h1>Saves</h1>
                </div>
                <div class="ls-close" onclick="document.getElementById('lune-saves-page').remove()">âœ•</div>
            </div>
            <div class="ls-main">
                ${items.map(item => `
                    <div class="ls-item">
                        <div style="display:flex; justify-content:center;">
                            <img src="${item.avatar}" class="ls-avatar">
                        </div>
                        <div class="ls-info">
                            <span class="ls-user">${item.name}</span>
                            <span class="ls-action">Saved to collection</span>
                        </div>
                        <div class="ls-media-window">${thumbHtml}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
};

/**
 * ğŸ› ï¸ è¿›å…¥æ”¶è—åˆ—è¡¨ï¼Œæ¸…é™¤æ”¶è—çº¢ç‚¹
 */
window.handleOpenSaves = async function() {
    const activeIdx = window.currentLuneStoryIndex || 0;
    let stories = await window.ib.getItem('my_active_story');
    if (!stories || !stories[activeIdx]) return;
    
    let story = stories[activeIdx];

    // 1. ğŸ”¥ åŒæ­¥å·²è¯»æ”¶è—æ•°
    story.lastSeenSaves = story.saves || 0;
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    stories[activeIdx] = story;
    await window.ib.setItem('my_active_story', stories);
    
    // 2. éšè—çº¢ç‚¹
    const badge = document.getElementById('save-badge');
    if (badge) badge.style.display = 'none';

    // 3. å‡†å¤‡æ•°æ®å¹¶æ‰“å¼€é¡µé¢ (æ¨¡æ‹Ÿæ•°æ®ä»¥ä¿è¯é¡µé¢ä¸ç©º)
    const mockSavers = (story.comments || []).slice(0, 5).map(c => ({
        name: c.name,
        avatar: c.avatar
    }));

    window.openLuneSaves(story.saves || 0, mockSavers, story.media || '', story.text || '');
};

/**
 * ğŸ‘¤ Lune Essence - è®¿å®¢è¯¦æƒ…é¡µ
 */
window.openLuneVisitors = function(totalCount, visitors = []) {
    const old = document.getElementById('lune-visitors-page');
    if (old) old.remove();

    const style = document.createElement('style');
    style.id = 'lune-visitors-style';
    style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap');
        #lune-visitors-page {
            position: fixed; inset: 0; z-index: 2147483652; background: #fff;
            font-family: 'Urbanist', sans-serif; display: flex; flex-direction: column;
            animation: luneFadeIn 0.3s ease-out;
        }
        .lv-header { padding: 70px 30px 20px 30px; border-bottom: 1px solid #f2f2f2; display: flex; justify-content: space-between; align-items: flex-end; }
        .lv-title-box h1 { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -2px; }
        .lv-title-box span { font-size: 14px; color: #888; font-weight: 600; text-transform: uppercase; }
        .lv-close { width: 40px; height: 40px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .lv-main { flex: 1; overflow-y: auto; padding: 10px 30px 100px 30px; }
        .lv-main::-webkit-scrollbar { width: 0; }

        .lv-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f9f9f9; }
        .lv-left { display: flex; align-items: center; gap: 15px; }
        .lv-avatar { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .lv-info { display: flex; flex-direction: column; }
        .lv-name { font-weight: 800; font-size: 16px; }
        .lv-time { font-size: 12px; color: #bbb; margin-top: 2px; }

        /* å…³æ³¨æŒ‰é’® */
        .lv-btn-follow {
            padding: 8px 18px; background: #000; color: #fff; border-radius: 8px;
            font-size: 12px; font-weight: 800; cursor: pointer; transition: 0.2s;
            border: 1px solid #000;
        }
        .lv-btn-follow.active { background: #fff; color: #000; border-color: #ddd; }

        @keyframes luneFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    `;
    document.head.appendChild(style);

    const html = `
        <div id="lune-visitors-page">
            <div class="lv-header">
                <div class="lv-title-box">
                    <span>${totalCount.toLocaleString()} Total Views</span>
                    <h1>Views</h1>
                </div>
                <div class="lv-close" onclick="document.getElementById('lune-visitors-page').remove()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div class="lv-main">
                ${visitors.map(v => `
                    <div class="lv-item">
                        <div class="lv-left">
                            <img src="${v.avatar}" class="lv-avatar">
                            <div class="lv-info">
                                <span class="lv-name">${v.name}</span>
                                <span class="lv-time">${v.time || 'JUST NOW'}</span>
                            </div>
                        </div>
                        <div class="lv-btn-follow" onclick="this.classList.toggle('active'); this.innerText = this.classList.contains('active') ? 'FOLLOWING' : 'FOLLOW';">
                            FOLLOW
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
};

/**
 * ğŸ› ï¸ è¿›å…¥è®¿å®¢åˆ—è¡¨ï¼Œæ¸…é™¤çº¢ç‚¹
 */
window.handleOpenVisitors = async function() {
    const activeIdx = window.currentLuneStoryIndex || 0;
    let stories = await window.ib.getItem('my_active_story');
    if (!stories || !stories[activeIdx]) return;
    
    let story = stories[activeIdx];

    // 1. ğŸ”¥ åŒæ­¥å·²è¯»è®¿å®¢æ•°
    story.lastSeenViewers = story.viewers || 0;
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    stories[activeIdx] = story;
    await window.ib.setItem('my_active_story', stories);
    
    // 2. éšè—çº¢ç‚¹
    const badge = document.getElementById('visitor-badge');
    if (badge) badge.style.display = 'none';

    // 3. å‡†å¤‡è®¿å®¢æ•°æ® (æå–æ‰€æœ‰è¯„è®ºè¿‡çš„äººä½œä¸ºçœŸå®è®¿å®¢)
    const visitors = (story.comments || []).map(c => ({
        name: c.name,
        avatar: c.avatar,
        time: 'STORY VISITOR'
    }));

    // 4. æ‰“å¼€é¡µé¢ (ä¼ å…¥æ€»æµè§ˆé‡å’Œåˆ—è¡¨)
    window.openLuneVisitors(story.viewers || 0, visitors);
};

window.handleInteraction = async function(mode) {
    const activeIdx = window.currentLuneStoryIndex || 0;
    let stories = await window.ib.getItem('my_active_story');
    if (!stories || !stories[activeIdx]) return;
    
    let story = stories[activeIdx];

    // åŒæ­¥åª’ä½“å†…å®¹
    const media = story.media || ''; // å›¾ç‰‡é“¾æ¥
    const text = story.text || '';   // æ–‡å­—å†…å®¹

    if (mode === 'likes') {
        story.lastSeenLikes = story.likes || 0;
        document.getElementById('like-badge').style.display = 'none';
        const likers = (story.comments || []).map(c => ({ name: c.name, avatar: c.avatar, text: 'Liked this' }));
        
        window.openLuneDetail({
            title: 'Likes',
            count: story.likes || 0,
            items: likers,
            type: 'story',
            mediaUrl: media,
            storyText: text
        });
    } else {
        story.lastSeenComments = (story.comments || []).length;
        document.getElementById('comment-badge').style.display = 'none';
        
        window.openLuneDetail({
            title: 'Comments',
            count: (story.comments || []).length,
            items: story.comments || [],
            type: 'story',
            mediaUrl: media,
            storyText: text
        });
    }

    stories[activeIdx] = story;
    await window.ib.setItem('my_active_story', stories);
};

window.openLuneDetail = function({ title, count, items, type = 'story', mediaUrl = '', storyText = '' }) {
    const old = document.getElementById('lune-detail-page');
    if (old) old.remove();

    const style = document.createElement('style');
    style.id = 'lune-detail-style';
    style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap');
        #lune-detail-page {
            position: fixed; inset: 0; z-index: 2147483650;
            background: #FAFAFA; font-family: 'Urbanist', sans-serif;
            display: flex; flex-direction: column;
            animation: luneSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ld-header { padding: 70px 30px 30px 30px; display: flex; justify-content: space-between; align-items: flex-end; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .ld-title-box h1 { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -2px; line-height: 1; }
        .ld-title-box span { font-size: 14px; color: #aaa; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .ld-exit { width: 40px; height: 40px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .ld-main { flex: 1; overflow-y: auto; padding: 20px 0 100px 0; }
        .ld-item { display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; padding: 20px 30px; }
        .ld-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1.5px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .ld-info { display: flex; flex-direction: column; gap: 4px; padding-right: 10px; }
        .ld-user { font-weight: 800; font-size: 16px; color: #000; }
        .ld-text { font-size: 14px; color: #666; line-height: 1.4; }
        .ld-time { font-size: 11px; color: #ccc; font-weight: 600; }

        /* ğŸ”¥ ç¼©ç•¥å›¾å¢å¼ºï¼šæ”¯æŒæ–‡å­—é¢„è§ˆ */
        .ld-media-window {
            width: 50px; height: ${type === 'story' ? '75px' : '50px'};
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px; overflow: hidden; border: 1px solid rgba(0,0,0,0.08);
            display: flex; align-items: center; justify-content: center; color: #fff; font-size: 8px; font-weight: 800; text-align: center;
        }
        .ld-media-img { width: 100%; height: 100%; object-fit: cover; }
    `;
    document.head.appendChild(style);

    // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯çº¯æ–‡å­—
    const isImg = mediaUrl && mediaUrl.startsWith('http');
    const thumbHtml = isImg 
        ? `<img src="${mediaUrl}" class="ld-media-img" onerror="this.style.display='none'">` 
        : `<span style="padding:4px">${storyText.substring(0, 10)}...</span>`;

    const html = `
        <div id="lune-detail-page">
            <div class="ld-header">
                <div class="ld-title-box">
                    <span>${count} Interactions</span>
                    <h1>${title}</h1>
                </div>
                <div class="ld-exit" onclick="document.getElementById('lune-detail-page').remove()">âœ•</div>
            </div>
            <div class="ld-main">
                ${items.map(item => `
                    <div class="ld-item">
                        <div style="display:flex; justify-content:center;">
                            <img src="${item.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed='+item.name}" class="ld-avatar">
                        </div>
                        <div class="ld-info">
                            <span class="ld-user">${item.name}</span>
                            <span class="ld-text">${item.text}</span>
                            <span class="ld-time">SYNCED NOW</span>
                        </div>
                        <div class="ld-media-window">${thumbHtml}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
};

/**
 * ğŸ› ï¸ è¿›å…¥è¯„è®ºåˆ—è¡¨ (æ•°æ®ä¼ è¾“ä¿®å¤ç‰ˆ)
 */
window.handleOpenComments = async function() {
    const activeIdx = window.currentLuneStoryIndex || 0;
    let stories = await window.ib.getItem('my_active_story');
    if (!stories || !stories[activeIdx]) return;
    
    let story = stories[activeIdx];

    // 1. åŒæ­¥å·²è¯»
    story.lastSeenComments = (story.comments || []).length;
    
    // ä¿å­˜
    stories[activeIdx] = story;
    await window.ib.setItem('my_active_story', stories);
    
    // 2. éšè—çº¢ç‚¹
    const badge = document.getElementById('comment-badge');
    if (badge) badge.style.display = 'none';

    // 3. ğŸ”¥ å…³é”®ï¼šä¼ å…¥ media å’Œ text
    window.openCommentsEssence(
        story.comments || [], 
        story.media || '', 
        story.text || '' // ä¼ å…¥æ–‡å­—ï¼Œé˜²æ­¢å›¾æŒ‚æ—¶æ²¡ä¸œè¥¿æ˜¾ç¤º
    );
};

/**
 * ğŸ’¬ Lune Essence - è¯„è®ºè¯¦æƒ…é¡µ (ç¼©ç•¥å›¾å®Œç¾åŒæ­¥ç‰ˆ)
 */
window.openCommentsEssence = function(comments = [], mediaUrl = '', storyText = '') {
    // 1. æ¸…ç†
    const old = document.getElementById('lune-comments-page');
    if (old) old.remove();

    // 2. æ ·å¼ (è·Ÿæ”¶è—é¡µä¿æŒé«˜åº¦ä¸€è‡´)
    const style = document.createElement('style');
    style.id = 'lune-comments-style';
    style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap');
        #lune-comments-page {
            position: fixed; inset: 0; z-index: 2147483651; background: #fff;
            font-family: 'Urbanist', sans-serif; display: flex; flex-direction: column;
            animation: luneSlideIn 0.3s ease-out;
        }
        .cm-header { padding: 70px 30px 20px 30px; border-bottom: 1px solid #f2f2f2; display: flex; justify-content: space-between; align-items: flex-end; }
        .cm-title-box h1 { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -2px; }
        .cm-title-box span { font-size: 14px; color: #888; font-weight: 600; text-transform: uppercase; }
        .cm-close { width: 40px; height: 40px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .cm-main { flex: 1; overflow-y: auto; padding: 10px 0 100px 0; }
        .cm-item { display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; padding: 18px 30px; border-bottom: 1px solid #f9f9f9; }
        .cm-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .cm-info { display: flex; flex-direction: column; padding-right: 10px; }
        .cm-user { font-weight: 800; font-size: 15px; color: #000; }
        .cm-text { font-size: 14px; color: #444; margin-top: 3px; line-height: 1.4; }
        .cm-time { font-size: 11px; color: #ccc; margin-top: 4px; font-weight: 600; }

        /* ğŸ”¥ å³ä¾§ç¼©ç•¥å›¾ï¼šå®Œå…¨å¤ç”¨æ”¶è—é¡µé€»è¾‘ */
        .cm-media-window {
            width: 44px; height: 66px; 
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            border-radius: 4px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center; color: #fff; font-size: 8px; font-weight: 700;
        }
        .cm-media-img { width: 100%; height: 100%; object-fit: cover; }
        
        @keyframes luneSlideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    `;
    document.head.appendChild(style);

    // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šæœ‰å›¾æ˜¾ç¤ºå›¾ï¼Œæ— å›¾æ˜¾ç¤º Story çš„æ–‡å­—
    const isImg = mediaUrl && mediaUrl.startsWith('http');
    const thumbHtml = isImg 
        ? `<img src="${mediaUrl}" class="cm-media-img" onerror="this.style.opacity='0'">` 
        : `<span style="padding:4px; transform: scale(0.8); text-align:center;">${storyText.substring(0, 8)}</span>`;

    const html = `
        <div id="lune-comments-page">
            <div class="cm-header">
                <div class="cm-title-box">
                    <span>${comments.length} Responses</span>
                    <h1>Comments</h1>
                </div>
                <div class="cm-close" onclick="document.getElementById('lune-comments-page').remove()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div class="cm-main">
                ${comments.map(c => `
                    <div class="cm-item">
                        <div style="display:flex; justify-content:center;">
                            <img src="${c.avatar}" class="cm-avatar">
                        </div>
                        <div class="cm-info">
                            <span class="cm-user">${c.name}</span>
                            <span class="cm-text">${c.text}</span>
                            <span class="cm-time">Just now</span>
                        </div>
                        <div class="cm-media-window">${thumbHtml}</div>
                    </div>
                `).reverse().join('')}
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
};

/**
 * ğŸ› ï¸ è¿›å…¥ç‚¹èµåˆ—è¡¨ (æ•°æ®ä¼ è¾“ä¿®å¤ç‰ˆ)
 */
window.handleOpenLikes = async function() {
    const activeIdx = window.currentLuneStoryIndex || 0;
    let stories = await window.ib.getItem('my_active_story');
    if (!stories || !stories[activeIdx]) return;
    
    let story = stories[activeIdx];

    // 1. åŒæ­¥å·²è¯»
    story.lastSeenLikes = story.likes || 0;
    
    // ä¿å­˜
    stories[activeIdx] = story;
    await window.ib.setItem('my_active_story', stories);
    
    // 2. éšè—çº¢ç‚¹
    const badge = document.getElementById('like-badge');
    if (badge) badge.style.display = 'none';

    // 3. æå–ç†Ÿäºº (è¯„è®ºè¿‡çš„äºº)
    const realLikers = (story.comments || []).map(c => ({
        user: c.name, avatar: c.avatar, action: 'Liked this', time: 'Just now'
    }));

    // 4. ğŸ”¥ å…³é”®ï¼šä¼ å…¥ media å’Œ text
    window.openLikesEssence(
        story.likes || 0,
        realLikers,
        story.media || '', 
        story.text || '' // ä¼ å…¥æ–‡å­—ï¼Œé˜²æ­¢å›¾æŒ‚æ—¶æ²¡ä¸œè¥¿æ˜¾ç¤º
    );
};

/**
 * ğŸ¤ Lune Essence - ç‚¹èµè¯¦æƒ…é¡µ (ç¼©ç•¥å›¾å®Œç¾åŒæ­¥ç‰ˆ)
 */
window.openLikesEssence = function(totalCount, realLikers = [], mediaUrl = '', storyText = '') {
    // 1. æ¸…ç†
    const old = document.getElementById('lune-likes-page');
    if (old) old.remove();

    // 2. æ ·å¼ (å¤ç”¨æ”¶è—é¡µçš„é«˜çº§æ„Ÿ)
    const style = document.createElement('style');
    style.id = 'lune-likes-style';
    style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap');
        #lune-likes-page {
            position: fixed; inset: 0; z-index: 2147483650; background: #fff;
            font-family: 'Urbanist', sans-serif; display: flex; flex-direction: column;
            animation: luneSlideIn 0.3s ease-out;
        }
        .lk-header { padding: 70px 30px 20px 30px; border-bottom: 1px solid #f2f2f2; display: flex; justify-content: space-between; align-items: flex-end; }
        .lk-title-box h1 { font-size: 40px; font-weight: 800; margin: 0; letter-spacing: -2px; }
        .lk-title-box span { font-size: 14px; color: #888; font-weight: 600; text-transform: uppercase; }
        .lk-close { width: 40px; height: 40px; background: #000; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .lk-main { flex: 1; overflow-y: auto; padding: 10px 0 100px 0; }
        .lk-item { display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; padding: 18px 30px; border-bottom: 1px solid #f9f9f9; }
        .lk-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .lk-info { display: flex; flex-direction: column; padding-right: 10px; }
        .lk-user { font-weight: 800; font-size: 15px; color: #000; }
        .lk-action { font-size: 14px; color: #666; margin-top: 2px; }
        .lk-time { font-size: 11px; color: #ccc; margin-top: 3px; font-weight: 600; }

        /* ğŸ”¥ å³ä¾§ç¼©ç•¥å›¾ï¼šç‚¹èµé¡µä¸“å±æ¸å˜ */
        .lk-media-window {
            width: 44px; height: 66px; 
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            border-radius: 4px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center; color: #fff; font-size: 8px; font-weight: 700;
        }
        .lk-media-img { width: 100%; height: 100%; object-fit: cover; }

        @keyframes luneSlideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    `;
    document.head.appendChild(style);

    // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­å›¾æŒ‚æ²¡æŒ‚
    const isImg = mediaUrl && mediaUrl.startsWith('http');
    const thumbHtml = isImg 
        ? `<img src="${mediaUrl}" class="lk-media-img" onerror="this.style.opacity='0'">` 
        : `<span style="padding:4px; transform: scale(0.8); text-align:center;">${storyText.substring(0, 8)}</span>`;

    // è¡¥å……ä¸€äº› NPC æ•°æ®è®©åˆ—è¡¨çœ‹èµ·æ¥ä¸°å¯Œ
    let displayList = [...realLikers];
    const fillCount = Math.min(totalCount - displayList.length, 30);
    for (let i = 0; i < fillCount; i++) {
        displayList.push({ user: "user_" + (Math.floor(Math.random()*900)+100), action: 'Liked this', time: (i+1) + "m" });
    }

    const html = `
        <div id="lune-likes-page">
            <div class="lk-header">
                <div class="lk-title-box">
                    <span>${totalCount.toLocaleString()} Likes</span>
                    <h1>Likes</h1>
                </div>
                <div class="lk-close" onclick="document.getElementById('lune-likes-page').remove()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div class="lk-main">
                ${displayList.map(item => `
                    <div class="lk-item">
                        <div style="display:flex; justify-content:center;">
                            <img src="${item.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed='+item.user}" class="lk-avatar">
                        </div>
                        <div class="lk-info">
                            <span class="lk-user">${item.user}</span>
                            <span class="lk-action">Liked your story</span>
                            <span class="lk-time">${item.time} ago</span>
                        </div>
                        <div class="lk-media-window">${thumbHtml}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
};

// ==========================================
// ğŸ› ï¸ å¼¹å¹•æ¨é€å‡½æ•°
// ==========================================
window.pushMockDm = function(textInput) {
    const text = textInput || "New interaction...";
    const zone = document.getElementById('lf-dm-zone');
    if(!zone) return;
    
    const dm = document.createElement('div');
    dm.className = 'lf-dm-bubble';
    dm.innerText = text;
    zone.appendChild(dm);
    
    // ä¿æŒç•Œé¢æ•´æ´ï¼Œè¶…è¿‡ 6 æ¡åˆ é™¤æœ€æ—©çš„
    if(zone.children.length > 6) zone.removeChild(zone.firstChild);
}

// ==========================================
// 1ï¸âƒ£ å¥½å‹å…¨å‘˜è¯„è®º (å¼ºåŠ›ä¿®å¤ç‰ˆ)
// ==========================================
window.triggerFriendReaction = async function(story) {
    console.log("ğŸš€ [Debug] è§¦å‘å¥½å‹è¯„è®ºé€»è¾‘...");
    
    // 1. æ£€æŸ¥ API Key
    const apiKey = localStorage.getItem('gpt_key');
    if (!apiKey) {
        alert("âŒ å¥½å‹è¯„è®ºå¤±è´¥ï¼šæœªé…ç½® GPT API Keyï¼");
        return;
    }

    // 2. è·å–å¥½å‹åˆ—è¡¨
    const charList = await loadFromDB('char_list') || [];
    console.log(`ğŸ“‹ [Debug] è¯»å–åˆ°å¥½å‹æ•°é‡: ${charList.length}`);

    if (charList.length === 0) {
        console.warn("âš ï¸ [Debug] å¥½å‹åˆ—è¡¨ä¸ºç©ºï¼Œæ— äººå¯è¯„è®º");
        return;
    }

    // 3. éå†æ¯ä¸€ä¸ªå¥½å‹ (ä¸²è¡Œæ‰§è¡Œï¼Œé˜²æ­¢ API å¹¶å‘æŠ¥é”™)
    let successCount = 0;
    
    for (const char of charList) {
        console.log(`ğŸ¤– [Debug] æ­£åœ¨è¯·æ±‚ AI: ${char.name} ...`);

        // æ„å»º Prompt
        const systemPrompt = `ä½ æ­£åœ¨æ‰®æ¼”ç”¨æˆ·çš„æœ‹å‹ã€‚
        è§’è‰²åï¼š${char.name}
        äººè®¾ï¼š${char.desc || char.bio || "æ™®é€šæœ‹å‹"}
        
        ä½ çš„æœ‹å‹åˆšåˆšå‘äº†ä¸€æ¡é™æ—¶åŠ¨æ€ã€‚
        ã€åŠ¨æ€å†…å®¹ã€‘ï¼š${story.text || "[ä¸€å¼ å›¾ç‰‡]"}
        
        ä»»åŠ¡ï¼šè¯·ä»¥${char.name}çš„å£å»å†™ä¸€æ¡ç®€çŸ­çš„è¯„è®ºã€‚
        è¦æ±‚ï¼š
        1. å¿…é¡»ç¬¦åˆäººè®¾è¯­æ°”ï¼ˆå‚²å¨‡/æ¸©æŸ”/æç¬‘ç­‰ï¼‰ã€‚
        2. å­—æ•°æ§åˆ¶åœ¨ 20 å­—ä»¥å†…ã€‚
        3. ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å¸¦å¼•å·ã€‚`;

        // è°ƒç”¨ AI
        const commentText = await callSocialAI(systemPrompt, "ç”Ÿæˆè¯„è®º");

        if (commentText) {
            // å†™å…¥æ•°æ®åº“
            await addCommentToStory(story.id, {
                name: char.name,
                avatar: char.avatar, // ç¡®ä¿è¿™é‡Œç”¨çš„æ˜¯è§’è‰²çœŸå®å¤´åƒ
                text: commentText,
                isFriend: true,
                time: Date.now()
            });
            
            successCount++;
            console.log(`âœ… [Debug] ${char.name} è¯„è®ºæˆåŠŸ: ${commentText}`);
        } else {
            console.error(`âŒ [Debug] ${char.name} AI è¿”å›ä¸ºç©º`);
        }

        // â³ ç¨å¾®åœé¡¿ 300msï¼Œé˜²æ­¢ API é€Ÿç‡é™åˆ¶
        await new Promise(r => setTimeout(r, 300));
    }

    console.log(`ğŸ‰ [Debug] å…¨éƒ¨å¥½å‹è¯„è®ºç»“æŸï¼ŒæˆåŠŸ: ${successCount}/${charList.length}`);
};

// ==========================================
// ğŸš€ AI åˆ·æ–°é€»è¾‘ (ä¿®å¤æš´æ¶¨ + æ™ºèƒ½è½¬åŒ–ç‡)
// ==========================================
window.triggerStrangerRefresh = async function() {
    // 1. è·å–å½“å‰ Story
    const activeIdx = window.currentLuneStoryIndex || 0;
    let stories = await window.ib.getItem('my_active_story');
    const charList = await loadFromDB('char_list') || [];
    
    if (!stories || !stories[activeIdx]) return alert("æ•°æ®åŒæ­¥é”™è¯¯");
    
    let story = stories[activeIdx]; 
    const friendCount = charList.length;

    // --- åˆ†æ”¯ A: é™Œç”Ÿäººæ¨¡å¼å…³é—­ ---
    if (!story.strangerMode) {
        // å¼ºåˆ¶è½¬ä¸º Numberï¼Œé˜²æ­¢å‡ºé”™
        story.viewers = Number(friendCount) + 1; 
        // ä¿®æ­£ï¼šå¦‚æœç‚¹èµæ•°ä¹Ÿåäº†ï¼Œé‡ç½®ä¸€ä¸‹
        if (typeof story.likes !== 'number') story.likes = 0;
        
        stories[activeIdx] = story;
        await window.ib.setItem('my_active_story', stories);
        if (window.updateViewerUI) window.updateViewerUI(story);
        return;
    }

    // --- åˆ†æ”¯ B: é™Œç”Ÿäººæ¨¡å¼å¼€å¯ ---
    console.log("ğŸŒŠ [Stranger] æµé‡æ¨¡æ‹Ÿä¸­...");

    // =================================================
    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢ T/B æš´æ¶¨ & åŒ¹é…è½¬åŒ–ç‡
    // =================================================
    
    // 1. ç¡®ä¿åŸå§‹æ•°æ®æ˜¯æ•°å­— (Number)ï¼Œå¦‚æœä¸æ˜¯ï¼Œè½¬ä¸º 0
    let currentView = parseInt(story.viewers) || friendCount;
    let currentLike = parseInt(story.likes) || 0;
    let currentSave = parseInt(story.saves) || 0;

    // 2. ç”Ÿæˆã€æ–°å¢ã€‘æµé‡ (æ§åˆ¶å¹…åº¦ï¼Œæ¯æ¬¡ +100 åˆ° +300ï¼Œä¸ä¼šå¤ªå¤¸å¼ )
    const newViews = Math.floor(Math.random() * 200) + 100;

    // 3. æ ¹æ®ã€æ–°å¢ã€‘æµé‡è®¡ç®— ç‚¹èµ/æ”¶è— (ç¬¦åˆæ¼æ–—æ¨¡å‹)
    // ç‚¹èµç‡ï¼š15% - 30%
    const likeRate = 0.15 + (Math.random() * 0.15); 
    const newLikes = Math.floor(newViews * likeRate);

    // æ”¶è—ç‡ï¼š2% - 8%
    const saveRate = 0.02 + (Math.random() * 0.06);
    const newSaves = Math.floor(newViews * saveRate);

    // 4. ç´¯åŠ  (ç»å¯¹å®‰å…¨çš„æ•°å­¦åŠ æ³•)
    story.viewers = currentView + newViews;
    story.likes = currentLike + newLikes;
    story.saves = currentSave + newSaves;

    console.log(`ğŸ“Š æ•°æ®å¢é•¿: æµè§ˆ+${newViews}, ç‚¹èµ+${newLikes}, æ”¶è—+${newSaves}`);
    // =================================================

    // 2. AI ç”Ÿæˆè¯„è®º (ä¿æŒåŸé€»è¾‘)
    const count = 5;
    const context = story.text ? `ç”¨æˆ·è¯´ï¼šâ€œ${story.text}â€` : "ä¸€å¼ å¾ˆæœ‰æ°›å›´æ„Ÿçš„å›¾ç‰‡";
    
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿç¤¾äº¤ç½‘ç»œç”Ÿæˆå™¨ã€‚
    ã€å†…å®¹ã€‘ï¼š${context}
    ã€ä»»åŠ¡ã€‘ï¼šç”Ÿæˆ ${count} æ¡è¯„è®ºã€‚
    ã€è¦æ±‚ã€‘ï¼š
    1. å¿…é¡»ä¸å†…å®¹ç›¸å…³ã€‚
    2. åŒ…å« "name" å’Œ "comment"ã€‚
    3. é£æ ¼ï¼šè·¯äººã€ç²‰ä¸ã€ç®€çŸ­æ„Ÿå¹ã€‚
    4. æ ¼å¼ï¼šçº¯JSONæ•°ç»„ã€‚`;

    callSocialAI(systemPrompt, "ç”ŸæˆJSON").then(async (jsonStr) => {
        try {
            const match = jsonStr.match(/\[[\s\S]*\]/);
            const npcList = match ? JSON.parse(match[0]) : [];

            if (npcList.length > 0) {
                for (const npc of npcList) {
                    const newComment = {
                        name: npc.name,
                        avatar: `https://api.dicebear.com/7.x/identicon/svg?seed=${npc.name}`, 
                        text: npc.comment,
                        isFriend: false,
                        time: Date.now()
                    };
                    if (!story.comments) story.comments = [];
                    story.comments.push(newComment);
                }
                
                stories[activeIdx] = story;
                await window.ib.setItem('my_active_story', stories);
                if (window.updateViewerUI) window.updateViewerUI(story);
            }
        } catch (e) { console.error("AI Error", e); }
    });

    // å…ˆä¿å­˜åŸºç¡€æ•°æ®
    stories[activeIdx] = story;
    await window.ib.setItem('my_active_story', stories);
    if (window.updateViewerUI) window.updateViewerUI(story);
};

/**
 * ğŸ¬ Lune Creator Studio: é™æ—¶åŠ¨æ€å‘å¸ƒå™¨
 * è°ƒç”¨æ–¹å¼: window.openCreatorStudio()
 */
window.openCreatorStudio = function() {
    // 1. æ³¨å…¥æ ·å¼ (å•æ¬¡è¿è¡Œ)
    if (!document.getElementById('lune-editor-style')) {
        const style = document.createElement('style');
        style.id = 'lune-editor-style';
        style.innerHTML = `
            @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700;800&display=swap');
            
            #lune-story-editor {
                position: fixed; inset: 0; z-index: 2147483647;
                background: #000; font-family: 'Urbanist', sans-serif;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            }

            /* å¤´éƒ¨ (é€‚é…çŠ¶æ€æ ) */
            .le-header {
                position: absolute; top: 0; left: 0; right: 0; height: 90px; /* å¢åŠ é«˜åº¦ */
                display: flex; justify-content: space-between; align-items: flex-end; /* åº•éƒ¨å¯¹é½ */
                padding: 0 20px 15px 20px; z-index: 50;
                background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            }
            .le-btn-cancel { color: #fff; font-size: 16px; opacity: 0.8; cursor: pointer; padding: 10px; }
            .le-btn-post { 
                background: #fff; color: #000; padding: 8px 24px; 
                border-radius: 20px; font-weight: 800; font-size: 14px; 
                cursor: pointer; transition: 0.2s;
            }
            .le-btn-post:active { transform: scale(0.95); opacity: 0.8; }

            /* ç”»å¸ƒåŒºåŸŸ (9:16) */
            .le-canvas-wrapper {
                position: relative;
                width: 100%; max-width: 380px; aspect-ratio: 9/16;
                background: #1a1a1a; border-radius: 24px;
                overflow: hidden;
                box-shadow: 0 0 40px rgba(0,0,0,0.5);
                border: 1px solid rgba(255,255,255,0.1);
            }

            .le-bg-layer {
                width: 100%; height: 100%; object-fit: cover;
                background: #333; transition: opacity 0.3s;
            }
            .le-bg-gradient {
                position: absolute; inset: 0; opacity: 0; transition: opacity 0.3s;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .le-text-layer {
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                min-width: 200px; text-align: center;
                cursor: move; user-select: none; touch-action: none;
                padding: 10px; border: 1px dashed rgba(255,255,255,0.3); border-radius: 8px;
                transition: border 0.2s;
            }
            .le-text-layer:active, .le-text-layer.dragging { border-color: #fff; background: rgba(255,255,255,0.1); }
            .le-text-content {
                font-size: 24px; font-weight: 700; color: #fff; line-height: 1.4;
                text-shadow: 0 2px 10px rgba(0,0,0,0.5); pointer-events: none;
            }

            /* åº•éƒ¨æ§åˆ¶é¢æ¿ */
            .le-controls {
                position: absolute; bottom: 0; left: 0; right: 0;
                background: #111; padding: 20px 20px 40px 20px;
                border-top-left-radius: 24px; border-top-right-radius: 24px;
                border-top: 1px solid rgba(255,255,255,0.1);
            }

            .le-input-row { margin-bottom: 20px; }
            .le-input {
                width: 100%; background: #222; border: none; padding: 12px 16px;
                border-radius: 12px; color: #fff; font-size: 16px;
                outline: none; box-sizing: border-box;
            }

            .le-option-row {
                display: flex; justify-content: space-between; align-items: center;
                margin-bottom: 20px;
            }
            .le-label { color: #888; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

            .le-duration-group { display: flex; background: #222; border-radius: 12px; padding: 4px; }
            .le-chip {
                padding: 6px 12px; font-size: 12px; color: #666; font-weight: 700;
                border-radius: 8px; cursor: pointer; transition: 0.2s;
            }
            .le-chip.active { background: #333; color: #fff; }

            .le-switch {
                position: relative; width: 50px; height: 28px;
                background: #333; border-radius: 14px; cursor: pointer; transition: 0.3s;
            }
            .le-switch::after {
                content: ''; position: absolute; top: 2px; left: 2px;
                width: 24px; height: 24px; background: #fff; border-radius: 50%;
                transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            }
            .le-switch.active { background: #00D26A; }
            .le-switch.active::after { left: 24px; }

            .le-mode-tabs { display: flex; gap: 10px; margin-top: 10px; }
            .le-tab-btn {
                flex: 1; padding: 14px; text-align: center; background: #222;
                border-radius: 16px; color: #666; font-weight: 700; cursor: pointer;
                border: 1px solid transparent;
            }
            .le-tab-btn.active { background: #fff; color: #000; box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

            #le-file-input { display: none; }
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        `;
        document.head.appendChild(style);
    }

    // 2. ç§»é™¤æ—§å®ä¾‹
    const old = document.getElementById('lune-story-editor');
    if (old) old.remove();

    // 3. é»˜è®¤å›¾
    const defaultImg = "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=800&q=80";

    // 4. æ„å»º HTML
    const html = `
        <div id="lune-story-editor">
            <div class="le-header">
                <div class="le-btn-cancel" onclick="document.getElementById('lune-story-editor').remove()">Cancel</div>
                <div class="le-btn-post" id="le-post-btn">POST</div>
            </div>

            <div class="le-canvas-wrapper" id="le-canvas">
                <div class="le-bg-gradient" id="le-gradient-layer"></div>
                <img src="${defaultImg}" class="le-bg-layer" id="le-bg">
                
                <div class="le-text-layer" id="le-drag-text">
                    <div class="le-text-content" id="le-preview-text">Tap to edit</div>
                </div>
            </div>

            <div class="le-controls">
                <div class="le-input-row">
                    <input type="text" class="le-input" id="le-text-input" placeholder="Type something..." autocomplete="off">
                </div>

                <div class="le-option-row">
                    <span class="le-label">Duration</span>
                    <div class="le-duration-group">
                        <div class="le-chip" data-h="12">12H</div>
                        <div class="le-chip active" data-h="24">24H</div>
                        <div class="le-chip" data-h="72">3D</div>
                        <div class="le-chip" data-h="120">5D</div>
                    </div>
                </div>

                <div class="le-option-row">
                    <div>
                        <div class="le-label">Stranger Mode</div>
                        <div style="font-size:10px; color:#555; margin-top:2px;">Allow NPC interactions</div>
                    </div>
                    <div class="le-switch" id="le-stranger-toggle"></div>
                </div>

                <div class="le-mode-tabs">
                    <div class="le-tab-btn active" id="btn-mode-img">Image</div>
                    <div class="le-tab-btn" id="btn-mode-text">Text Only</div>
                </div>
                <input type="file" id="le-file-input" accept="image/*">
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);

    // --- å†…éƒ¨çŠ¶æ€ ---
    let state = {
        mode: 'image',
        duration: 24,
        strangerMode: false,
        text: '',
        imageSrc: defaultImg,
        textPos: { x: 50, y: 50 }
    };

    // --- äº¤äº’é€»è¾‘ ---
    const bg = document.getElementById('le-bg');
    const grad = document.getElementById('le-gradient-layer');
    const fileInput = document.getElementById('le-file-input');

    // 1. æ–‡å­—è¾“å…¥
    document.getElementById('le-text-input').oninput = function(e) {
        const val = e.target.value;
        document.getElementById('le-preview-text').innerText = val.trim() || 'Tap to edit';
        state.text = val;
    };

    // 2. æ—¶æ•ˆé€‰æ‹©
    document.querySelectorAll('.le-chip').forEach(chip => {
        chip.onclick = function() {
            document.querySelectorAll('.le-chip').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            state.duration = parseInt(this.dataset.h);
        }
    });

    // 3. é™Œç”Ÿäººå¼€å…³
    const toggle = document.getElementById('le-stranger-toggle');
    toggle.onclick = function() {
        this.classList.toggle('active');
        state.strangerMode = this.classList.contains('active');
    };

    // 4. æ¨¡å¼åˆ‡æ¢
    document.getElementById('btn-mode-img').onclick = function() {
        state.mode = 'image';
        this.classList.add('active');
        document.getElementById('btn-mode-text').classList.remove('active');
        bg.style.opacity = '1';
        grad.style.opacity = '0';
        fileInput.click(); // è§¦å‘ä¸Šä¼ 
    };

    document.getElementById('btn-mode-text').onclick = function() {
        state.mode = 'text';
        this.classList.add('active');
        document.getElementById('btn-mode-img').classList.remove('active');
        bg.style.opacity = '0';
        grad.style.opacity = '1';
    };

    // 5. å›¾ç‰‡é¢„è§ˆ
    fileInput.onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                state.imageSrc = evt.target.result;
                if(state.mode === 'image') bg.src = state.imageSrc;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    };

    // --- æ‹–æ‹½é€»è¾‘ ---
    const dragItem = document.getElementById('le-drag-text');
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;

    const startDrag = (clientX, clientY) => {
        isDragging = true;
        startX = clientX;
        startY = clientY;
        initialLeft = dragItem.offsetLeft;
        initialTop = dragItem.offsetTop;
        dragItem.classList.add('dragging');
    };

    const doDrag = (clientX, clientY) => {
        if (!isDragging) return;
        const dx = clientX - startX;
        const dy = clientY - startY;
        dragItem.style.left = `${initialLeft + dx}px`;
        dragItem.style.top = `${initialTop + dy}px`;
    };

    const stopDrag = () => {
        if(!isDragging) return;
        isDragging = false;
        dragItem.classList.remove('dragging');
        // ä¿å­˜ç™¾åˆ†æ¯”ä½ç½®
        const canvas = document.getElementById('le-canvas');
        state.textPos.x = (dragItem.offsetLeft / canvas.offsetWidth) * 100;
        state.textPos.y = (dragItem.offsetTop / canvas.offsetHeight) * 100;
    };

    dragItem.onmousedown = (e) => startDrag(e.clientX, e.clientY);
    window.onmousemove = (e) => doDrag(e.clientX, e.clientY);
    window.onmouseup = stopDrag;

    dragItem.ontouchstart = (e) => startDrag(e.touches[0].clientX, e.touches[0].clientY);
    window.ontouchmove = (e) => { if(isDragging) e.preventDefault(); doDrag(e.touches[0].clientX, e.touches[0].clientY); };
    window.ontouchend = stopDrag;

    // --- 6. å‘å¸ƒé€»è¾‘ (ä¿å­˜åˆ° ib) ---
    document.getElementById('le-post-btn').onclick = async function() {
        const newStory = {
            id: Date.now(),
            type: state.mode,
            media: state.mode === 'image' ? state.imageSrc : null,
            text: state.text || '',
            textPos: state.textPos,
            duration: state.duration,
            strangerMode: state.strangerMode,
            timestamp: Date.now(),
            expiresAt: Date.now() + (state.duration * 3600 * 1000),
            viewers: [],
            likes: 0
        };

        try {
            if(window.ib) {
                // è¯»å–æ—§æ•°æ®ï¼Œè¿½åŠ æ–°åŠ¨æ€
                let myStories = await window.ib.getItem('my_active_story') || [];
                // å¦‚æœæ˜¯å¯¹è±¡è½¬æˆæ•°ç»„ (å…¼å®¹æ—§ç‰ˆæœ¬)
                if(!Array.isArray(myStories)) myStories = [myStories];
                
                myStories.push(newStory);
                await window.ib.setItem('my_active_story', myStories);
                
                console.log("âœ… Story published:", newStory);
                showPublishSuccess();
                document.getElementById('lune-story-editor').remove();
                
                // åˆ·æ–°é¦–é¡µåœ†åœˆ
                if(typeof initMomentsStories === 'function') initMomentsStories();
            } else {
                alert("Error: Database not ready.");
            }
        } catch(e) {
            console.error("Publish failed", e);
            alert("å‘å¸ƒå¤±è´¥");
        }
    };
};

/**
 * ğŸŒŠ æ‰“å¼€å…¨å±åŠ¨æ€æŸ¥çœ‹å™¨ (K/Mè®¡æ•° + æ— é™æ»šåŠ¨å¼¹å¹•ç‰ˆ)
 */
window.openFullStory = async function() {
    // 1. è·å–æ•°æ®
    let feedList = await window.ib.getItem('my_active_story');
    const myDbData = await window.ib.getItem('lune_user_data');

    if (!feedList) return alert("æš‚æ— å‘å¸ƒçš„åŠ¨æ€");
    if (!Array.isArray(feedList)) feedList = [feedList];

    // 2. å‡†å¤‡æˆ‘çš„ä¿¡æ¯
    let myData = myDbData || window.userData || {};
    let myName = myData.name || 'Me';
    let myAvatarUrl = "https://via.placeholder.com/100"; 
    if (myData.avatarValue) {
        if (myData.avatarValue.includes('url(')) {
            myAvatarUrl = myData.avatarValue.replace(/url\(['"]?(.*?)['"]?\)/, '$1');
        } else if (myData.avatarValue.startsWith('data:image') || myData.avatarValue.startsWith('http')) {
            myAvatarUrl = myData.avatarValue;
        }
    }

    // 3. æ ·å¼æ³¨å…¥ (å¢åŠ äº†æ»šåŠ¨åŠ¨ç”»)
    const cssId = 'lune-flux-v5-style';
    if (document.getElementById(cssId)) document.getElementById(cssId).remove();
    
    const style = document.createElement('style');
    style.id = cssId;
    style.innerHTML = `
        #lune-story-overlay { position: fixed; inset: 0; z-index: 2147483647; background: #000; font-family: sans-serif; display: flex; align-items: center; justify-content: center; }
        .lf-container { width: 100%; height: 100%; max-width: 450px; position: relative; background: #000; overflow: hidden; display: flex; flex-direction: column; }
        
        .lf-media-wrapper { position: absolute; inset: 0; display: flex; transition: transform 0.3s; z-index: 10; }
        .lf-story-item { width: 100%; height: 100%; flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: center; background: #111; }
        .lf-media-img { width: 100%; height: 100%; object-fit: cover; }
        .lf-text-mode { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .lf-overlay-text { position: absolute; transform: translate(-50%, -50%); color: #fff; font-size: 24px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.5); pointer-events: none; text-align: center; width: 100%; }
        .lf-bg-gradient { width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .lf-top-bar { position: absolute; top: 0; left: 0; right: 0; z-index: 30; padding: 45px 10px 15px 10px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); }
        .lf-progress-wrapper { display: flex; gap: 4px; margin-bottom: 10px; }
        .lf-progress-seg { flex: 1; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        .lf-progress-fill { height: 100%; background: #fff; width: 0%; transition: none; }
        .lf-progress-fill.active { width: 100%; transition: width 5s linear; }
        .lf-progress-fill.done { width: 100%; transition: none; }
        .lf-top-btns { display: flex; justify-content: flex-end; gap: 15px; padding-right: 5px; }
        .lf-icon-action { color: #fff; cursor: pointer; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); transition: transform 0.2s; }
        .lf-icon-action:active { transform: scale(0.9); }

        /* åº•éƒ¨ä¿¡æ¯å±‚ (åŠ é«˜ï¼Œä¸ºäº†å®¹çº³æ»šåŠ¨åŒºåŸŸ) */
        .lf-info-layer { position: absolute; bottom: 0; left: 0; right: 0; z-index: 50; padding: 20px 16px 40px 16px; background: linear-gradient(to top, #000 10%, rgba(0,0,0,0.8) 90%, transparent 100%); display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .lf-info-layer > * { pointer-events: auto; }

        /* ğŸ”¥ æ»šåŠ¨å¼¹å¹•å®¹å™¨ */
        .lf-danmaku-mask { 
            height: 180px; /* é™åˆ¶é«˜åº¦ */
            overflow: hidden; 
            position: relative; 
            margin-bottom: 5px;
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
        }
        
        /* ğŸ”¥ æ»šåŠ¨è½¨é“ */
        .lf-dm-track {
            display: flex;
            flex-direction: column;
            gap: 8px; /* é—´è· */
            /* åŠ¨ç”»å°†åœ¨ JS ä¸­åŠ¨æ€è®¡ç®—æ—¶é•¿ */
        }
        
        /* ğŸ”¥ æ»šåŠ¨åŠ¨ç”»å…³é”®å¸§ */
        @keyframes scrollUp {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50%); } /* ç§»åŠ¨ä¸€åŠé«˜åº¦ï¼Œå®ç°æ— ç¼å¾ªç¯ */
        }

        .lf-dm-bubble { align-self: flex-start; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); padding: 6px 12px; border-radius: 16px; font-size: 13px; color: #fff; border: 1px solid rgba(255,255,255,0.15); max-width: 85%; width: fit-content; text-shadow: 0 1px 1px rgba(0,0,0,0.5); }
        .lf-dm-name { font-weight: 700; color: #FFD700; margin-right: 6px; font-size: 12px; opacity: 0.9; }

        .lf-meta-row { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; }
        .lf-author-box { display: flex; align-items: center; gap: 10px; }
        .lf-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; background: #333; }
        .lf-name { font-weight: 700; font-size: 15px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .lf-time { font-size: 11px; opacity: 0.8; color: #ddd; margin-top: 2px; }
        
        .lf-viewers-box { display: flex; flex-direction: column; align-items: flex-end; }
        .lf-pile { display: flex; padding-left: 10px; height: 24px; align-items: center; }
        .lf-pile-img { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #fff; margin-left: -10px; background: #555; object-fit: cover; }
        .lf-seen-txt { font-size: 12px; color: #fff; margin-top: 4px; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .lf-action-bar { display: flex; align-items: center; gap: 12px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px; width: 100%; }
        .lf-input { flex: 1; height: 40px; background: rgba(255,255,255,0.15); border-radius: 20px; display: flex; align-items: center; padding: 0 15px; font-size: 13px; color: #eee; border: 1px solid rgba(255,255,255,0.1); }
        
        .lf-stat-btn { display: flex; align-items: center; gap: 5px; color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; }
        .lf-circle-icon { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .lf-circle-icon:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }

        .lf-tap-left { position: absolute; top: 0; bottom: 0; left: 0; width: 30%; z-index: 25; }
        .lf-tap-right { position: absolute; top: 0; bottom: 0; right: 0; width: 30%; z-index: 25; }
    `;
    document.head.appendChild(style);

    // 4. æ„å»º DOM
    const html = `
        <div id="lune-story-overlay">
            <div class="lf-container">
                <div class="lf-top-bar">
                    <div class="lf-progress-wrapper" id="lf-bars"></div>
                    <div class="lf-top-btns">
                        <div class="lf-icon-action" onclick="window.triggerStrangerRefresh()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                        </div>
                        <div class="lf-icon-action" onclick="document.getElementById('lune-story-overlay').remove()">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>
                    </div>
                </div>

                <div class="lf-media-wrapper" id="lf-slider"></div>
                <div class="lf-tap-left" id="btn-prev"></div>
                <div class="lf-tap-right" id="btn-next"></div>

                <div class="lf-info-layer">
                    <div class="lf-danmaku-mask">
                        <div class="lf-dm-track" id="lf-dm-track">
                            </div>
                    </div>

                    <div class="lf-meta-row">
                        <div class="lf-author-box">
                            <img src="${myAvatarUrl}" class="lf-avatar" id="lf-avatar-img">
                            <div>
                                <div class="lf-name">${myName}</div>
                                <div class="lf-time" id="lf-time-txt">Just now</div>
                            </div>
                        </div>
                        <div class="lf-viewers-box">
                            <div class="lf-pile" id="lf-avatar-pile"></div>
                            <div class="lf-seen-txt" id="lf-seen-count">0 views</div>
                        </div>
                    </div>

                    <div class="lf-action-bar">
                        <div class="lf-input">Send message...</div>
                        <div class="lf-stat-btn">
                            <div class="lf-circle-icon" onclick="this.style.background='rgba(255,59,48,0.2)'; this.querySelector('svg').style.fill='#FF3B30'; this.querySelector('svg').style.stroke='none';">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            </div>
                            <span id="lf-like-count">0</span>
                        </div>
                        <div class="lf-stat-btn">
                            <div class="lf-circle-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                            </div>
                            <span id="lf-save-count">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const old = document.getElementById('lune-story-overlay');
    if (old) old.remove();
    document.body.insertAdjacentHTML('beforeend', html);

    // 5. æ¸²æŸ“é€»è¾‘
    const slider = document.getElementById('lf-slider');
    const barBox = document.getElementById('lf-bars');
    
    feedList.forEach((item, i) => {
        barBox.innerHTML += `<div class="lf-progress-seg"><div class="lf-progress-fill" id="lf-bar-${i}"></div></div>`;
        let contentHtml = item.type === 'text' 
            ? `<div class="lf-text-mode"><div class="lf-bg-gradient"></div><div class="lf-overlay-text" style="left:${item.textPos?.x||50}%; top:${item.textPos?.y||50}%;">${item.text}</div></div>`
            : `<img src="${item.media}" class="lf-media-img">` + (item.text ? `<div class="lf-overlay-text" style="left:${item.textPos?.x||50}%; top:${item.textPos?.y||50}%;">${item.text}</div>` : '');
        slider.innerHTML += `<div class="lf-story-item">${contentHtml}</div>`;
    });

    // 6. æ ¸å¿ƒæ›´æ–°å‡½æ•°
    const update = (idx) => {
        window.currentLuneStoryIndex = idx;
        // åœ¨ update(idx) å†…éƒ¨ï¼š
        const d = feedList[idx];


        // æ»‘åŠ¨ & è¿›åº¦æ¡
        slider.style.transform = `translateX(-${idx * 100}%)`;
        for(let i=0; i<feedList.length; i++) {
            const b = document.getElementById(`lf-bar-${i}`);
            b.className = 'lf-progress-fill';
            b.style.width = '';
            if (i < idx) b.classList.add('done');
        }
        const currBar = document.getElementById(`lf-bar-${idx}`);
        if(currBar) {
            currBar.style.width = '0%';
            requestAnimationFrame(()=> requestAnimationFrame(()=> { currBar.classList.add('active'); currBar.style.width=''; }));
        }

        // --- 2. ğŸ”¥ å…³é”®ä¿®å¤ï¼šåˆå§‹åŒ–å¤–éƒ¨è®¡æ•°å™¨ (è§£å†³æ˜¾ç¤ºä¸º0çš„é—®é¢˜) ---
        
        // A. è®¿å®¢æ•°åˆå§‹åŒ–
        const traceCount = document.getElementById('trace-count-val');
        if (traceCount) traceCount.innerText = formatStat(d.viewers || 0);

        // B. ç‚¹èµæ•°åˆå§‹åŒ–
        const likeBtn = document.getElementById('lf-like-count');
        if (likeBtn) likeBtn.innerText = formatStat(d.likes || 0);

        // C. è¯„è®ºæ•°åˆå§‹åŒ– (å¦‚æœä½ çš„è¯„è®ºæŒ‰é’®ä¹Ÿæœ‰æ•°å­—æ˜¾ç¤ºï¼ŒåŠ ä¸Šè¿™è¡Œ)
        // const commentCountEl = document.getElementById('lf-comment-count');
        // if (commentCountEl) commentCountEl.innerText = (d.comments || []).length;

        // --- 3. ğŸ”¥ å…³é”®ä¿®å¤ï¼šçº¢ç‚¹åˆå§‹åŒ– (è¿›å…¥æ—¶åˆ¤æ–­æ˜¯å¦è¯¥äº®çº¢ç‚¹) ---
        
        // è®¿å®¢çº¢ç‚¹
        const vBadge = document.getElementById('visitor-badge');
        if (vBadge) {
            const vDiff = (d.viewers || 0) - (d.lastSeenViewers || 0);
            vBadge.innerText = `+${vDiff}`;
            vBadge.style.display = vDiff > 0 ? 'flex' : 'none';
        }

        // ç‚¹èµçº¢ç‚¹
        const lBadge = document.getElementById('like-badge');
        if (lBadge) {
            const lDiff = (d.likes || 0) - (d.lastSeenLikes || 0);
            lBadge.innerText = `+${lDiff}`;
            lBadge.style.display = lDiff > 0 ? 'flex' : 'none';
        }

        // è¯„è®ºçº¢ç‚¹
        const cBadge = document.getElementById('comment-badge');
        if (cBadge) {
            const cDiff = (d.comments || []).length - (d.lastSeenComments || 0);
            cBadge.innerText = `+${cDiff}`;
            cBadge.style.display = cDiff > 0 ? 'flex' : 'none';
        }

        // --- 4. å…¶å®ƒæ¸²æŸ“ (å¼¹å¹•ã€å¤´åƒå †å ã€æ—¶é—´) ---
        renderMarqueeComments(d.comments || []); // åˆ·æ–°å¼¹å¹•å¢™
        
        // è®¿å®¢å¤´åƒå †å 
        const avatarList = document.getElementById('trace-avatars-list');
        if (avatarList && d.comments) {
            avatarList.innerHTML = '';
            const recent = [...new Map(d.comments.map(c => [c.name, c])).values()].slice(-3);
            recent.forEach(v => {
                avatarList.innerHTML += `<img src="${v.avatar}" class="trace-avatar-img" style="width:18px; height:18px; border-radius:50%; border:1.5px solid #fff; margin-left:-6px;">`;
            });
        }

        // åˆå§‹åŒ–æ”¶è—æ•°å­—
        const saveCountEl = document.getElementById('lf-save-count');
        if (saveCountEl) saveCountEl.innerText = formatStat(d.saves || 0);

        // åˆå§‹åŒ–æ”¶è—çº¢ç‚¹
        const sBadge = document.getElementById('save-badge');
        if (sBadge) {
            const sDiff = (d.saves || 0) - (d.lastSeenSaves || 0);
            sBadge.innerText = `+${sDiff}`;
            sBadge.style.display = sDiff > 0 ? 'flex' : 'none';
        }

        // --- æ•°æ®æ¸²æŸ“ ---
        
        // 1. K/M è®¡æ•°æ ¼å¼åŒ–
        document.getElementById('lf-seen-count').innerText = `${formatStat(d.viewers || 0)} views`;
        document.getElementById('lf-like-count').innerText = formatStat(d.likes || 0);
        document.getElementById('lf-save-count').innerText = formatStat(d.saves || 0);

        // 2. æ—¶é—´
        const timeDiff = Math.floor((Date.now() - d.timestamp) / 1000 / 60);
        let tStr = 'Just now';
        if(timeDiff > 60) tStr = Math.floor(timeDiff/60) + 'h ago';
        else if(timeDiff > 0) tStr = timeDiff + 'm ago';
        document.getElementById('lf-time-txt').innerText = tStr;

        // 3. å¤´åƒå †å 
        const pile = document.getElementById('lf-avatar-pile');
        pile.innerHTML = '';
        if (d.comments && d.comments.length > 0) {
            const unique = [...new Map(d.comments.map(c => [c.name, c])).values()].slice(-3);
            unique.forEach(c => pile.innerHTML += `<img src="${c.avatar}" class="lf-pile-img">`);
        }

        // 4. ğŸ”¥ å¯åŠ¨æ— é™æ»šåŠ¨å¼¹å¹• (æ˜¾ç¤ºæ‰€æœ‰è¯„è®º)
        renderMarqueeComments(d.comments || []);
        
    };

    let curIdx = 0;
    document.getElementById('btn-next').onclick = () => { if(curIdx < feedList.length - 1) { curIdx++; update(curIdx); } else { document.getElementById('lune-story-overlay').remove(); } };
    document.getElementById('btn-prev').onclick = () => { if(curIdx > 0) { curIdx--; update(curIdx); } };

    update(0);
};

/**
 * ğŸ› ï¸ æ ¸å¿ƒ UI åŒæ­¥å‡½æ•°ï¼šè´Ÿè´£æ›´æ–°æ‰€æœ‰æ•°å­—ã€çº¢ç‚¹å’Œå¤´åƒå †å 
 */
window.updateViewerUI = function(story) {
    // ------------------------------------------------
    // 1. ğŸ”¥ ç‚¹èµéƒ¨åˆ† (Likes)
    // ------------------------------------------------
    // A. æ›´æ–°æ–‡å­—æ•°å­—
    const likeCountEl = document.getElementById('lf-like-count');
    if (likeCountEl) likeCountEl.innerText = formatStat(story.likes || 0);

    // B. æ›´æ–°çº¢ç‚¹
    const likeBadge = document.getElementById('like-badge');
    if (likeBadge) {
        const diff = (story.likes || 0) - (story.lastSeenLikes || 0);
        if (diff > 0) {
            likeBadge.innerText = `+${diff}`;
            likeBadge.style.display = 'flex';
        } else {
            likeBadge.style.display = 'none';
        }
    }

    // ------------------------------------------------
    // 2. ğŸ”¥ è¯„è®ºéƒ¨åˆ† (Comments)
    // ------------------------------------------------
    // A. æ›´æ–°çº¢ç‚¹ (è¯„è®ºé€šå¸¸æ²¡æœ‰å¤–æ˜¾æ•°å­—ï¼Œåªæœ‰çº¢ç‚¹)
    const commentBadge = document.getElementById('comment-badge');
    if (commentBadge) {
        const totalComments = (story.comments || []).length;
        const diff = totalComments - (story.lastSeenComments || 0);
        if (diff > 0) {
            commentBadge.innerText = `+${diff}`;
            commentBadge.style.display = 'flex';
        } else {
            commentBadge.style.display = 'none';
        }
    }

    if (document.getElementById('lune-comments-page')) {
        window.openCommentsEssence(
            story.comments || [], 
            story.media || '', // ä¼ å…¥å›¾ç‰‡
            story.text || ''   // ä¼ å…¥æ–‡å­—
        );
    }

    if (document.getElementById('lune-likes-page')) {
        const realLikers = (story.comments || []).map(c => ({
            user: c.name, avatar: c.avatar, action: 'Liked this', time: 'Just now'
        }));
        
        window.openLikesEssence(
            story.likes || 0,
            realLikers,
            story.media || '', // ä¼ å…¥å›¾ç‰‡
            story.text || ''   // ä¼ å…¥æ–‡å­—
        );
    }

    // ------------------------------------------------
    // 3. ğŸ”¥ è®¿å®¢éƒ¨åˆ† (Visitors / Trace Bar)
    // ------------------------------------------------
    // A. æ›´æ–°æ–‡å­—æ•°å­— (Trace Bar é‡Œé¢çš„æ•°å­—)
    const traceCount = document.getElementById('trace-count-val');
    if (traceCount) traceCount.innerText = formatStat(story.viewers || 0);
    
    // B. æ›´æ–°ä¸»è§†å›¾æ•°å­— (å¦‚æœæœ‰çš„è¯ï¼Œé€šå¸¸å« lf-seen-count)
    const seenCountEl = document.getElementById('lf-seen-count');
    if (seenCountEl) seenCountEl.innerText = `${formatStat(story.viewers || 0)} views`;

    // C. æ›´æ–°å¤´åƒå †å  (å–æœ€å3ä¸ªï¼Œå€’åºæ’åˆ—)
    const avatarList = document.getElementById('trace-avatars-list');
    if (avatarList && story.comments) {
        avatarList.innerHTML = '';
        // ä½¿ç”¨ Map å»é‡ï¼Œç¡®ä¿åŒä¸€ä¸ªäººçš„å¤´åƒä¸é‡å¤å‡ºç°
        const recent = [...new Map(story.comments.map(c => [c.name, c])).values()].slice(-3);
        recent.forEach(v => {
            avatarList.innerHTML += `<img src="${v.avatar}" class="trace-avatar-img" style="width:18px; height:18px; border-radius:50%; border:1.5px solid #fff; margin-left:-6px;">`;
        });
    }

    // D. æ›´æ–°çº¢ç‚¹
    const visitorBadge = document.getElementById('visitor-badge');
    if (visitorBadge) {
        const diff = (story.viewers || 0) - (story.lastSeenViewers || 0);
        if (diff > 0) {
            visitorBadge.innerText = `+${diff}`;
            visitorBadge.style.display = 'flex';
        } else {
            visitorBadge.style.display = 'none';
        }
    }

    // ------------------------------------------------
    // 4. ğŸ”¥ æ”¶è—éƒ¨åˆ† (Saves)
    // ------------------------------------------------
    // A. æ›´æ–°æ–‡å­—æ•°å­—
    const saveCountEl = document.getElementById('lf-save-count');
    if (saveCountEl) saveCountEl.innerText = formatStat(story.saves || 0);

    // B. æ›´æ–°çº¢ç‚¹
    const sBadge = document.getElementById('save-badge');
    if (sBadge) {
        const diff = (story.saves || 0) - (story.lastSeenSaves || 0);
        if (diff > 0) {
            sBadge.innerText = `+${diff}`;
            sBadge.style.display = 'flex';
        } else {
            sBadge.style.display = 'none';
        }
    }

    // ... (åœ¨ç‚¹èµã€è¯„è®ºåˆå§‹åŒ–åé¢)

    // D. è½¬å‘æ•°åˆå§‹åŒ–
    const shareCountEl = document.getElementById('lf-share-count');
    if (shareCountEl) shareCountEl.innerText = formatStat(d.shares || 0);

    // E. è½¬å‘çº¢ç‚¹åˆå§‹åŒ–
    const shareBadge = document.getElementById('share-badge');
    if (shareBadge) {
        const diff = (d.shares || 0) - (d.lastSeenShares || 0);
        shareBadge.innerText = `+${diff}`;
        shareBadge.style.display = diff > 0 ? 'flex' : 'none';
    }

    // ------------------------------------------------
    // 5. ğŸ”¥ å®æ—¶åˆ·æ–°è¯¦æƒ…é¡µ (å¦‚æœé¡µé¢æ­£å¼€ç€ï¼Œç«‹åˆ»åŒæ­¥å†…å®¹)
    // ------------------------------------------------
    
    // æƒ…å†µ A: ç‚¹èµæˆ–è¯„è®ºé¡µ (Lune Gallery)
    const detailPage = document.getElementById('lune-detail-page');
    if (detailPage) {
        const title = detailPage.querySelector('h1').innerText;
        
        // åˆ·æ–°ç‚¹èµé¡µ
        if (title === 'Likes') {
            const likers = (story.comments || []).map(c => ({ name: c.name, avatar: c.avatar, text: 'Liked this' }));
            window.openLuneDetail({
                title: 'Likes',
                count: story.likes || 0,
                items: likers,
                type: 'story',
                mediaUrl: story.media || '',
                storyText: story.text || ''
            });
        }
        
        // åˆ·æ–°è¯„è®ºé¡µ
        if (title === 'Comments') {
            window.openLuneDetail({
                title: 'Comments',
                count: (story.comments || []).length,
                items: story.comments || [],
                type: 'story',
                mediaUrl: story.media || '',
                storyText: story.text || ''
            });
        }
    }

    // æƒ…å†µ B: æ”¶è—é¡µ (Lune Saves)
    if (document.getElementById('lune-saves-page')) {
        const mockSavers = (story.comments || []).slice(0, 5).map(c => ({ name: c.name, avatar: c.avatar }));
        window.openLuneSaves(story.saves || 0, mockSavers, story.media || '', story.text || '');
    }

    // æƒ…å†µ C: è®¿å®¢é¡µ (Lune Visitors)
    if (document.getElementById('lune-visitors-page')) {
        const visitors = (story.comments || []).map(c => ({ name: c.name, avatar: c.avatar, time: 'STORY VISITOR' }));
        window.openLuneVisitors(story.viewers || 0, visitors);
    }
};

// 2. å¼¹å¹•ç”Ÿæˆ (æ”¯æŒå¯¹è±¡)
window.pushMockDm = function(input) {
    const zone = document.getElementById('lf-dm-zone');
    if(!zone) return;

    // å…¼å®¹ï¼šå¦‚æœ input æ˜¯å­—ç¬¦ä¸²ï¼Œè½¬å¯¹è±¡ï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œç”¨å¯¹è±¡
    const name = typeof input === 'object' ? input.name : "Stranger";
    const text = typeof input === 'object' ? input.text : input;
    
    const dm = document.createElement('div');
    dm.className = 'lf-dm-bubble';
    
    // ğŸ”¥ æ˜¾ç¤ºæ˜µç§° + å†…å®¹
    dm.innerHTML = `<span class="lf-dm-name">${name}</span>${text}`;
    
    zone.appendChild(dm);
    
    // å¢åŠ å®¹é‡åˆ° 10 æ¡
    if(zone.children.length > 10) zone.removeChild(zone.firstChild);
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    zone.scrollTop = zone.scrollHeight;
}

// ==========================================
// ğŸŸ¢ 3. ä¿å­˜é€»è¾‘ (async + ib)
// ==========================================
window.lune_saveData = async function() {
    try {
        // ğŸ”¥ å­˜å…¥ ibï¼Œè§£å†³å¤§å°é™åˆ¶
        await window.ib.setItem('lune_user_data', window.userData);
        console.log("âœ… æ•°æ®ä¿å­˜æˆåŠŸ");
        renderMePanel(); // åˆ·æ–°
        window.lune_closeModal(); // å…³å¼¹çª—
    } catch (e) {
        alert("ä¿å­˜å¤±è´¥: " + e);
    }
};

// ==========================================
// ğŸŸ¢ 4. ä¸Šä¼ é€»è¾‘ (å»é™¤å‹ç¼©ï¼Œç›´æ¥å­˜åŸå›¾)
// ==========================================
window.lune_handleUpload = function(input, type) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
            // ç›´æ¥ä¿å­˜ base64 åˆ°å…¨å±€å˜é‡ (è¿˜æœªå†™å…¥æ•°æ®åº“)
            if(type === 'bg') {
                window.userData.bgType = 'base64';
                window.userData.bgValue = `url(${e.target.result})`;
            } else {
                window.userData.avatarType = 'base64';
                window.userData.avatarValue = `url(${e.target.result})`;
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
};

// ==========================================
// ğŸŸ¢ 5. å…¶ä»–è¾…åŠ©å‡½æ•°
// ==========================================
window.lune_resetStyle = function(type) {
    const defaultData = {
        bgValue: 'radial-gradient(circle at 10% 20%, rgb(239, 246, 249) 0%, rgb(206, 239, 253) 90%)',
        avatarValue: 'linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)'
    };
    if(type === 'bg') {
        window.userData.bgType = 'css';
        window.userData.bgValue = defaultData.bgValue;
    } else {
        window.userData.avatarType = 'css';
        window.userData.avatarValue = defaultData.avatarValue;
    }
};

window.lune_closeModal = function() {
    const modal = document.getElementById('lune-modal-global');
    if(modal) modal.classList.remove('active');
};

window.lune_openModal = function(editType) {
    const modal = document.getElementById('lune-modal-global');
    if (!modal) return;
    
    const content = modal.querySelector('#lune-modal-content');
    const title = modal.querySelector('.modal-header');
    
    modal.classList.add('active');
    
    // ç»Ÿä¸€æ ·å¼
    const inputStyle = `width: 100%; padding: 18px; background: #F2F2F7; border: 1px solid transparent; border-radius: 20px; font-size: 16px; margin-bottom: 18px; outline: none; transition: all 0.2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);`;
    const labelStyle = `display:block; font-size:12px; color:#8E8E93; font-weight:700; margin-bottom:8px; margin-left:6px; text-transform:uppercase; letter-spacing:0.5px;`;
    const onFocus = `this.style.background='#fff'; this.style.borderColor='#007AFF'; this.style.boxShadow='0 4px 12px rgba(0,122,255,0.1)'`;
    const onBlur = `this.style.background='#F2F2F7'; this.style.borderColor='transparent'; this.style.boxShadow='inset 0 1px 3px rgba(0,0,0,0.02)'`;

    let html = '';
    if (editType === 'background') {
        title.innerText = 'Change Cover';
        html = `
            <div><label style="${labelStyle}">Image URL</label><input type="text" style="${inputStyle}" placeholder="https://..." onfocus="${onFocus}" onblur="${onBlur}" oninput="window.userData.bgType='url'; window.userData.bgValue='url('+this.value+')'"></div>
            <div><label style="${labelStyle}">Upload</label><div style="position:relative; width:100%; height:55px; background:#E5E5EA; border-radius:20px; display:flex; align-items:center; justify-content:center; color:#007AFF; font-weight:700; cursor:pointer;" onclick="this.nextElementSibling.click()">Choose Image...</div><input type="file" accept="image/*" hidden onchange="lune_handleUpload(this, 'bg')"></div>
            <button class="reset-btn" onclick="lune_resetStyle('bg')" style="margin-top:20px;">â†º Default Gradient</button>
        `;
    } else if (editType === 'avatar') {
        title.innerText = 'Change Avatar';
        html = `
            <div><label style="${labelStyle}">Image URL</label><input type="text" style="${inputStyle}" placeholder="https://..." onfocus="${onFocus}" onblur="${onBlur}" oninput="window.userData.avatarType='url'; window.userData.avatarValue='url('+this.value+')'"></div>
            <div><label style="${labelStyle}">Upload</label><div style="position:relative; width:100%; height:55px; background:#E5E5EA; border-radius:20px; display:flex; align-items:center; justify-content:center; color:#007AFF; font-weight:700; cursor:pointer;" onclick="this.nextElementSibling.click()">Choose Image...</div><input type="file" accept="image/*" hidden onchange="lune_handleUpload(this, 'avatar')"></div>
            <button class="reset-btn" onclick="lune_resetStyle('avatar')" style="margin-top:20px;">â†º Default Gradient</button>
        `;
    } else if (editType === 'name') {
        title.innerText = 'Display Name';
        html = `<input type="text" style="${inputStyle}" value="${window.userData.name}" onfocus="${onFocus}" onblur="${onBlur}" oninput="window.userData.name = this.value">`;
    } else if (editType === 'bio') {
        title.innerText = 'Signature';
        html = `<textarea style="${inputStyle} min-height:140px; resize:none; line-height:1.5;" onfocus="${onFocus}" onblur="${onBlur}" oninput="window.userData.bio = this.value">${window.userData.bio}</textarea>`;
    } else if (editType === 'location') {
        title.innerText = 'Location';
        html = `<input type="text" style="${inputStyle}" value="${window.userData.location}" onfocus="${onFocus}" onblur="${onBlur}" oninput="window.userData.location = this.value">`;
    }
    content.innerHTML = html;
};

// ==========================================
// ğŸŸ¢ 1. å¿…é¡»æ”¾åœ¨æœ€å‰ï¼šæ— é™å®¹é‡æ•°æ®åº“å·¥å…· (IB)
// ==========================================
window.ib = {
    dbName: "Lune_Unlimited_DB",
    storeName: "user_data_store",
    _db: null,
    async init() {
        if (this._db) return this._db;
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName);
                }
            };
            request.onsuccess = (e) => {
                this._db = e.target.result;
                resolve(this._db);
            };
            request.onerror = (e) => reject(e.target.error);
        });
    },
    async setItem(key, value) {
        await this.init();
        return new Promise((resolve, reject) => {
            const tx = this._db.transaction(this.storeName, "readwrite");
            const request = tx.objectStore(this.storeName).put(value, key);
            request.onsuccess = () => resolve();
            request.onerror = (e) => reject(e.target.error);
        });
    },
    async getItem(key) {
        await this.init();
        return new Promise((resolve, reject) => {
            const tx = this._db.transaction(this.storeName, "readonly");
            const request = tx.objectStore(this.storeName).get(key);
            request.onsuccess = () => resolve(request.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }
};

/**
 * ğŸš€ æ ¸å¿ƒé€»è¾‘ï¼šå¤„ç†åŠ¨æ€å‘å¸ƒ (ä¿®å¤ç‰ˆï¼šå‘å¸ƒ + æŒä¹…åŒ–ä¿å­˜)
 */
window.handlePublish = async function() { 
    const textarea = document.getElementById('studio-main-input');
    const container = document.getElementById('moments-feed-container');
    const images = window.studioSelectedImages || [];
    const contentText = textarea.value.trim();

    // 1. æ ¡éªŒ
    if (!contentText && images.length === 0) {
        alert("æ•æ‰è®°å¿†å¤±è´¥ï¼šè¯·è‡³å°‘è¾“å…¥ä¸€æ®µæ–‡å­—æˆ–ä¸€å¼ å›¾ç‰‡ã€‚");
        return;
    }

    // 2. æ¸…ç†ç©ºçŠ¶æ€
    const emptyState = container.querySelector('.moments-empty-state');
    if (emptyState) emptyState.remove(); 

    // 3. è·å–ç”¨æˆ·ä¿¡æ¯ (å¼ºåˆ¶åŒæ­¥)
    let currentUser = { name: 'Design User', avatarValue: '' };
    try {
        if (window.userData && window.userData.name) {
            currentUser = window.userData;
        } else if (window.ib) {
            const dbData = await window.ib.getItem('lune_user_data');
            if (dbData) currentUser = dbData;
        } else {
            const localData = JSON.parse(localStorage.getItem('lune_user_data'));
            if (localData) currentUser = localData;
        }
    } catch(e) {}

    const userName = currentUser.name || 'Design User';
    let userAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23cccccc'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' fill='%23666' text-anchor='middle' dy='.3em'%3EMe%3C/text%3E%3C/svg%3E";

    if (currentUser.avatarValue) {
        if (currentUser.avatarValue.includes('url(')) {
            userAvatar = currentUser.avatarValue.replace(/url\(['"]?(.*?)['"]?\)/, '$1');
        } else if (currentUser.avatarValue.startsWith('data:image')) {
            userAvatar = currentUser.avatarValue;
        }
    }

    // 4. æ„é€ æ•°æ®å¯¹è±¡
    const newMoment = {
        id: Date.now(),
        type: images.length === 0 ? 'text' : (images.length > 1 ? 'multi' : 'single'),
        avatar: userAvatar,
        name: userName,
        date: new Date().toLocaleDateString('zh-CN', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g, 'å¹´').replace(/(?=\b\d\b)/g, '0').replace(/(\d{2})$/, '$1æ—¥').replace(/(\d{4})å¹´(\d{2})æœˆ/, '$1å¹´$2æœˆ'),
        time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'}),
        location: 'Lune Digital Space',
        content: contentText,
        images: [...images],
        music: 'Ambient Flow',
        likes: 0
    };

    // ==========================================
    // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜åˆ°æ•°æ®åº“ (æŒä¹…åŒ–)
    // ==========================================
    try {
        // 1. å…ˆå–å‡ºæ—§çš„åŠ¨æ€åˆ—è¡¨
        let feedList = (await window.ib.getItem('moments_feed_data')) || [];
        
        // 2. æŠŠæ–°çš„åŠ åˆ°æœ€å‰é¢ (unshift)
        feedList.unshift(newMoment);
        
        // 3. å­˜å›å»
        await window.ib.setItem('moments_feed_data', feedList);
        console.log("âœ… åŠ¨æ€å·²ä¿å­˜åˆ°æ•°æ®åº“");

    } catch (e) {
        console.error("ä¿å­˜åŠ¨æ€å¤±è´¥:", e);
    }
    // ==========================================

    // 5. æ¸²æŸ“ UI
    try {
        const cardHtml = createMomentCard(newMoment);
        container.insertAdjacentHTML('afterbegin', cardHtml);

        textarea.value = ""; 
        window.studioSelectedImages = []; 
        window.closeStudio();
        
        const feedPage = document.getElementById('moments-feed-page'); 
        if(feedPage) feedPage.scrollTop = 0;

    } catch (error) {
        console.error("âŒ æ¸²æŸ“å¤±è´¥:", error);
    }
};

/* ============================================================
   ğŸš€ ç³»ç»Ÿè‡ªå¯åŠ¨åè®® (æ”¾åœ¨ä»£ç æœ€åº•éƒ¨)
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
    // å»¶è¿Ÿ 200ms ç¡®ä¿ HTML å…ƒç´ å·²ç»åŠ è½½å®Œæ¯•
    setTimeout(() => {
        console.log("æ­£åœ¨æ¢å¤è¯è´¹è´¦å•è§†å›¾...");

        // 1. å°è¯•ä»ç¼“å­˜æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„è§’è‰² ID
        const savedId = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');

        if (savedId && savedId !== "undefined" && savedId !== "null") {
            // æ¢å¤å…¨å±€å˜é‡
            window.currentVaultCharID = savedId;
            
            // ğŸ”¥ 2. å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡æ¸²æŸ“ï¼
            // è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä»¥å‰åˆ·æ–°ä¸æ˜¾ç¤ºï¼Œå› ä¸ºä»¥å‰æ²¡äººæ›¿ä½ åœ¨åˆ·æ–°æ—¶æŒ‰è¿™ä¸ªæŒ‰é’®
            if (typeof window.renderPhoneBillList === 'function') {
                window.renderPhoneBillList(savedId);
            }
        } else {
            console.log("æ— å†å²é€‰ä¸­è§’è‰²ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ...");
        }
    }, 200);
});

/**
 * ğŸ” æ ¸å¿ƒå·¥å…·ï¼šè·å– SIM å¡çš„å”¯ä¸€èº«ä»½ ID
 * é€»è¾‘ï¼šä¼˜å…ˆç”¨ç»‘å®šçš„è§’è‰²ID -> å…¶æ¬¡ç”¨ç”µè¯å·ç  -> æœ€åç”¨å¡ç‰‡ç´¢å¼•
 * ä½œç”¨ï¼šç¡®ä¿æ¯ä¸€å¼ å¡éƒ½æœ‰ç‹¬ç«‹çš„è´¦å•ï¼Œç»ä¸æ··æ·†
 */
window.getSimContextId = function(card, index) {
    if (!card) return "UNKNOWN_SIM";

    // 1. ä¼˜å…ˆï¼šå¦‚æœæ˜¯ NPC çš„å¡ï¼Œå¿…é¡»ç”¨ NPC ID (è¿™æ ·èƒ½æŠŠé€šè®¯å½•å’ŒSIMå¡å…³è”èµ·æ¥)
    if (card.charId && card.charId !== "null" && card.charId !== "") {
        return card.charId;
    }

    // 2. å…¶æ¬¡ï¼šå¦‚æœæ˜¯ç©å®¶æ‰‹å»ºçš„å¡ï¼Œç”¨ã€ç”µè¯å·ç ã€‘åšå”¯ä¸€æ ‡è¯†
    // åªè¦å·ç ä¸ä¸€æ ·ï¼Œè´¦å•å°±ç»å¯¹éš”ç¦»
    if (card.number && card.number.length > 3) {
        return "SIM_NUM_" + card.number.replace(/\s/g, '');
    }

    // 3. å…œåº•ï¼šå®åœ¨æ²¡åŠæ³•ï¼Œç”¨å®ƒåœ¨åˆ—è¡¨é‡Œçš„ä½ç½®ï¼Œä¿è¯è‡³å°‘èƒ½å­˜
    return "SIM_INDEX_" + index;
};

/* ============================================================
   ğŸ“¨ æ™ºèƒ½å‚¬æ”¶ç³»ç»Ÿ V3.0 (AI çº¯äººè®¾ç”Ÿæˆ + åŠ¨æ€å¡ç‰‡æ’å…¥)
   ============================================================ */

window.sendTopUpReminder = async function() {
    // 0. UI å‡†å¤‡
    if(typeof closeLowBalanceModal === 'function') closeLowBalanceModal();
    const btn = document.querySelector('.low-bal-btn'); // å‡è®¾æœ‰ä¸ªæŒ‰é’®
    if(btn) btn.innerHTML = "CONTACTING...";

    // 1. è·å–ç›®æ ‡è§’è‰² ID
    const charId = window.currentVaultCharID || window.currentManagementChar || localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');
    
    if (!charId) {
        return alert("ERROR: æ— æ³•å®šä½è§’è‰² IDï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªè§’è‰²å¡ç‰‡ã€‚");
    }

    console.log(`[Remind] æ­£åœ¨å”¤é†’ AI ä¸º ID: ${charId} ç¼–å†™å‚¬æ”¶å‰§æœ¬...`);

    // 2. å‡†å¤‡ API
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    if (!apiKey) return alert("è¯·å…ˆé…ç½® API Key");

    // 3. è·å–è§’è‰²äººè®¾
    let charName = "User";
    let charBio = "æ™®é€šç”¨æˆ·";
    let charAvatar = "assets/default_avatar.png";
    let charLang = "ZH"; // é»˜è®¤ä¸­æ–‡

    try {
        if (typeof loadFromDB === 'function') {
            const list = await loadFromDB('char_list') || [];
            const target = list.find(c => c.id === charId);
            if (target) {
                charName = target.name;
                charAvatar = target.avatar || charAvatar;
                charBio = target.desc || target.bio || "æ— è¯¦ç»†äººè®¾";
                // ç®€å•çš„è¯­è¨€æ£€æµ‹
                if (/[\u4e00-\u9fa5]/.test(charBio) || target.lang === 'zh') {
                    charLang = "ZH";
                } else {
                    charLang = "EN";
                }
            }
        }
    } catch (e) { console.warn("è¯»å–äººè®¾å¤±è´¥", e); }

    // 4. ğŸ§  AI ç¼–å‰§ï¼šç”Ÿæˆå¯¹è¯åˆ—è¡¨
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”å¤§å¸ˆã€‚
    ç°åœ¨è§’è‰²æ‰‹æœºæ¬ è´¹/åœæœºäº†ï¼Œæ€¥éœ€è®©ç”¨æˆ·å¸®å¿™å……å€¼ã€‚
    
    ã€è§’è‰²æ¡£æ¡ˆã€‘ï¼š
    - å§“åï¼š${charName}
    - äººè®¾ï¼š${charBio}
    - è¯­è¨€ï¼š${charLang === 'ZH' ? 'ä¸­æ–‡' : 'English'}
    
    ã€ä»»åŠ¡ã€‘ï¼š
    ç”Ÿæˆ **5åˆ°8æ¡** è¿ç»­çš„çŸ­ä¿¡å†…å®¹ï¼Œæ¨¡æ‹Ÿè§’è‰²å‘ç°åœæœºã€æ„Ÿåˆ°ç„¦æ€¥/çƒ¦èº/æ³æ±‚ï¼ˆæ ¹æ®äººè®¾å†³å®šè¯­æ°”ï¼‰ï¼Œæœ€åå‘å¡ç‰‡æ±‚åŠ©çš„è¿‡ç¨‹ã€‚
    
    ã€å…³é”®è§„åˆ™ã€‘ï¼š
    1. **å¿…é¡»åŒ…å«å¡ç‰‡å ä½ç¬¦**ï¼šåœ¨å¯¹è¯çš„é«˜æ½®å¤„ï¼ˆæ¯”å¦‚æ±‚åŠ©æ—¶ï¼‰ï¼Œå¿…é¡»æ’å…¥ä¸€æ¡å†…å®¹ä¸º "{{CARD}}" çš„æ¶ˆæ¯ã€‚
    2. **è¯­æ°”ç¬¦åˆäººè®¾**ï¼šå¦‚æœæ˜¯å‚²å¨‡å°±å‘½ä»¤ï¼Œå¦‚æœæ˜¯ç»¿èŒ¶å°±æ’’å¨‡ï¼Œå¦‚æœæ˜¯ç¡¬æ±‰å°±ç›´è¯´ã€‚
    3. **æ ¼å¼ä¸¥æ ¼**ï¼šåªè¿”å›çº¯ JSON å­—ç¬¦ä¸²æ•°ç»„ã€‚
    
    JSONç¤ºä¾‹ï¼š
    ["åœ¨å—ï¼Ÿ", "æ€ä¹ˆçªç„¶å‘ä¸å‡ºæ¶ˆæ¯äº†", "æ°”æ­»æˆ‘äº†", "{{CARD}}", "å¿«å¸®æˆ‘å……ç‚¹ï¼Œæ€¥ç”¨ï¼"]`;

    const userPrompt = `å¼€å§‹ç”Ÿæˆå‚¬æ”¶å‰§æœ¬ã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 0.9 // é«˜åˆ›é€ æ€§
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        
        const jsonMatch = data.choices[0].message.content.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI è¿”å›æ ¼å¼é”™è¯¯");
        
        const script = JSON.parse(jsonMatch[0]); // æ‹¿åˆ°è„šæœ¬æ•°ç»„

        // 5. æ„é€ æ¶ˆæ¯é˜Ÿåˆ—
        const messagesToSend = [];
        const timestamp = Date.now();

        // å…œåº•ï¼šå¦‚æœ AI å¿˜äº†å†™ {{CARD}}ï¼Œæˆ‘ä»¬å¼ºåˆ¶åŠ åœ¨æœ€å
        if (!script.includes("{{CARD}}")) {
            script.push("{{CARD}}");
            script.push(charLang === 'ZH' ? "è°¢äº†ã€‚" : "Thx.");
        }

        script.forEach((text, index) => {
            const msgId = `MSG_REMIND_${timestamp}_${index}`;
            const msgTime = timestamp + (index * 1500); // æ¯æ¡é—´éš” 1.5ç§’

            if (text.includes("{{CARD}}") || text === "{{CARD}}") {
                // --> ç”Ÿæˆå……å€¼å¡ç‰‡æ¶ˆæ¯
                messagesToSend.push({
                    id: msgId,
                    role: "assistant",
                    text: charLang === 'ZH' ? "[ç³»ç»Ÿ] è¯è´¹ä»£ä»˜è¯·æ±‚" : "[SYSTEM] Top-up Request",
                    timestamp: msgTime,
                    app_source: 'sms',
                    metadata: {
                        type: 'card_request_topup',
                        amount: (Math.random() * 50 + 50).toFixed(0), // éšæœº 50-100å…ƒ
                        // ğŸ”¥ğŸ”¥ æ ¸å¿ƒï¼šæŠŠè§’è‰²ä¿¡æ¯ç›´æ¥çƒ§å½•è¿›å»ï¼Œé˜²æ­¢åˆ·æ–°ä¸¢å¤± ğŸ”¥ğŸ”¥
                        targetInfo: {
                            id: charId,
                            name: charName,
                            avatar: charAvatar,
                            number: "SIM-LINK-SECURE"
                        }
                    }
                });
            } else {
                // --> ç”Ÿæˆæ™®é€šæ–‡æœ¬æ¶ˆæ¯
                messagesToSend.push({
                    id: msgId,
                    role: "assistant",
                    text: text,
                    timestamp: msgTime,
                    app_source: 'sms'
                });
            }
        });

        // 6. ğŸ’¾ æ‰¹é‡å†™å…¥æ•°æ®åº“
        console.log(`[Remind] è„šæœ¬ç”Ÿæˆå®Œæ¯•ï¼Œå…± ${messagesToSend.length} æ¡ï¼Œæ­£åœ¨å†™å…¥...`);
        for (const msg of messagesToSend) {
            if (typeof saveChatMessage === 'function') {
                await saveChatMessage(charId, msg);
            }
        }

        // 7. åˆ·æ–° UI
        if (typeof renderLmsgList === 'function') renderLmsgList();

        // 8. å¼¹å‡ºåé¦ˆæ¸…å• (Feedback Modal)
        if(typeof showSentLogModal === 'function') {
            showSentLogModal(messagesToSend, charAvatar);
        }

        if (navigator.vibrate) navigator.vibrate([50, 100, 50]);

    } catch (e) {
        console.error("[Remind] ç”Ÿæˆå¤±è´¥:", e);
        alert("å‚¬æ”¶è¯·æ±‚å¤±è´¥: " + e.message);
    }
};

/* ============================================================
   ğŸ“ é€šè¯å†…å®¹ç”Ÿæˆç³»ç»Ÿ (AI Dialogue / Diary Gen)
   ç‰¹æ€§ï¼šè‡ªåŠ¨ç¼“å­˜ã€åŒæ¨¡å¼æ¸²æŸ“ã€è¶…é•¿Tokenæ”¯æŒ
   ============================================================ */

/**
 * 1. å…¥å£ï¼šç‚¹å‡»å•æ¡é€šè¯è®°å½•
 * @param {string} billId - è´¦å•å¤§ID
 * @param {number} logIndex - åœ¨ logs æ•°ç»„é‡Œçš„ç´¢å¼•
 */
window.openCallContent = async function(billId, logIndex) {
    const charId = window.currentVaultCharID || localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID') || 'GLOBAL_USER';
    
    // 1. æ‰¾åˆ°é‚£æ¡åŸå§‹è®°å½•
    const allBills = JSON.parse(localStorage.getItem('lune_npc_bills_' + charId) || '[]');
    const bill = allBills.find(b => b.id === billId);
    
    if (!bill || !bill.logs[logIndex]) return alert("RECORD_CORRUPTED: è®°å½•å·²ä¸¢å¤±");
    
    const log = bill.logs[logIndex];
    
    // 2. åˆå§‹åŒ– UI
    const modal = document.getElementById('modal-call-content');
    const body = document.getElementById('cc-body-container');
    const loader = document.getElementById('cc-loader');
    
    // å¡«å…¥å¤´éƒ¨ä¿¡æ¯
    document.getElementById('cc-caller').innerText = log.caller;
    document.getElementById('cc-number').innerText = generateFakeNumber(log.caller); // æ¨¡æ‹Ÿä¸ªå·ç 
    document.getElementById('cc-duration').innerText = log.duration + " MIN";
    document.getElementById('cc-id').innerText = `${billId.slice(-4)}_${logIndex}`;

    modal.style.display = 'flex';
    body.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
    loader.style.display = 'flex'; // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»

    // 3. ğŸ”¥ æ£€æŸ¥ç¼“å­˜ (çœé’±æ ¸å¿ƒ)
    // ç¼“å­˜Keyè§„åˆ™: CONTENT_è§’è‰²ID_è´¦å•ID_ç´¢å¼•
    const cacheKey = `LUNE_CALL_CONTENT_V1_${charId}_${billId}_${logIndex}`;
    const cachedData = localStorage.getItem(cacheKey);

    if (cachedData) {
        console.log("[ç³»ç»Ÿ] å‘½ä¸­é€šè¯è®°å½•ç¼“å­˜ï¼Œä¸æ¶ˆè€— Tokenã€‚");
        // æ¨¡æ‹Ÿä¸€ç‚¹ç‚¹è§£å¯†å»¶è¿Ÿï¼Œå¢åŠ ä»ªå¼æ„Ÿ
        setTimeout(() => {
            renderCallContent(JSON.parse(cachedData), log.duration);
            loader.style.display = 'none';
        }, 600);
        return;
    }

    // 4. ğŸš€ æ²¡æœ‰ç¼“å­˜ï¼Œå¯åŠ¨ AI ç”Ÿæˆ
    try {
        await generateCallAI(log, charId, cacheKey);
    } catch (e) {
        console.error(e);
        body.innerHTML = `<div style="color:red; padding:20px; text-align:center;">SIGNAL LOST: ${e.message}</div>`;
        loader.style.display = 'none';
    }
};

/**
 * 2. AI ç”Ÿæˆé€»è¾‘
 */
async function generateCallAI(log, charId, cacheKey) {
    // å‡†å¤‡äººè®¾
    let charName = "Target"; 
    let charBio = "Unknown";
    try {
        if(typeof loadFromDB === 'function') {
            const list = await loadFromDB('char_list') || [];
            const c = list.find(x => x.id === charId);
            if(c) { charName = c.name; charBio = c.desc || c.bio; }
        }
    } catch(e){}

    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    // åˆ¤æ–­æ¨¡å¼ï¼šæ¥é€š(Duration > 0) vs æœªæ¥(Duration == 0)
    // æ³¨æ„ï¼šæœ‰äº›ç”Ÿæˆçš„çŸ­ç”µè¯å¯èƒ½åªæœ‰1åˆ†é’Ÿï¼Œä¹Ÿè§†ä¸ºæ¥é€š
    const isConnected = log.duration > 0;
    const mode = isConnected ? "DIALOGUE" : "DIARY";

    // æ›´æ–°åŠ è½½æ–‡å­—
    document.getElementById('cc-loading-text').innerText = isConnected 
        ? `RECOVERING AUDIO (${log.duration} MIN)...` 
        : "DECRYPTING MISSED CALL NOTE...";

    let systemPrompt, userPrompt;

    if (isConnected) {
        // === æ¨¡å¼ A: å¯¹è¯ ===
        systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå¯¹è¯è„šæœ¬ç”Ÿæˆå™¨ã€‚è¯·æ ¹æ®é€šè¯æ—¶é•¿å’Œäººè®¾ï¼Œè¿˜åŸè¿™åœºé€šè¯çš„è¯¦ç»†å†…å®¹ã€‚
        
        ã€è§’è‰²ã€‘ï¼š${charName} (${charBio})
        ã€å¯¹æ–¹ã€‘ï¼š${log.caller}
        ã€æƒ…å¢ƒã€‘ï¼š${log.context}
        ã€æ—¶é•¿ã€‘ï¼š${log.duration} åˆ†é’Ÿ (æ—¶é•¿è¶Šé•¿ï¼Œç”Ÿæˆçš„å¯¹è¯è¶Šè¦ä¸°å¯Œ)
        
        ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
        å¿…é¡»è¿”å› **çº¯ JSON æ•°ç»„**ï¼Œä¸è¦ Markdownã€‚
        ç»“æ„ï¼š[{"speaker": "me", "text": "å†…å®¹"}, {"speaker": "other", "text": "å†…å®¹"}]
        - "me" ä»£è¡¨ ${charName}ã€‚
        - "other" ä»£è¡¨ ${log.caller}ã€‚
        - å†…å®¹è¦å£è¯­åŒ–ï¼Œç¬¦åˆäººè®¾ã€‚`;
        
        userPrompt = `ç”Ÿæˆå¯¹è¯è„šæœ¬ã€‚`;

    } else {
        // === æ¨¡å¼ B: æœªæ¥/éšç¬” ===
        systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¼¤æ„Ÿæ–‡å­¦ä½œå®¶ã€‚
        ç”¨æˆ· ${charName} é”™è¿‡äº†ä¸€ä¸ªæ¥è‡ª "${log.caller}" çš„ç”µè¯ï¼ˆæˆ–å¯¹æ–¹å“äº†ä¸€å£°æŒ‚æ–­ï¼‰ã€‚
        è¯·å†™ä¸€æ®µ **350å­—å·¦å³** çš„å†…å¿ƒç‹¬ç™½æˆ–éšç¬”ã€‚
        
        ã€è¦æ±‚ã€‘ï¼š
        1. **æ’ç‰ˆ**ï¼šä½¿ç”¨åŒæ¢è¡Œåˆ†æ®µï¼Œå¸ƒå±€ä¼˜ç¾ï¼Œä¸è¦å †åœ¨ä¸€èµ·ã€‚
        2. **å†…å®¹**ï¼šçŒœæµ‹å¯¹æ–¹ä¸ºä»€ä¹ˆæ‰“æ¥ï¼Ÿè‡ªå·±ä¸ºä»€ä¹ˆæ²¡æ¥ï¼Ÿæ˜¯æ•…æ„èº²é¿è¿˜æ˜¯é—æ†¾é”™è¿‡ï¼Ÿç»“åˆäººè®¾(${charBio})æŒ–æ˜æ·±å±‚æƒ…æ„Ÿã€‚
        3. **æ ¼å¼**ï¼šçº¯æ–‡æœ¬ï¼Œä¸è¦ JSONã€‚`;
        
        userPrompt = `ç”µè¯æœªæ¥é€šã€‚ç”Ÿæˆéšç¬”ã€‚`;
    }

    // è¯·æ±‚ API
    const response = await fetch(`${apiUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({
            model: model,
            messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
            temperature: 0.85,
            max_tokens: 3000 // ğŸ”¥ Token æ‹‰å¤§ï¼Œé˜²æˆªæ–­
        })
    });

    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    const content = data.choices[0].message.content;

    // è§£æç»“æœ
    let finalData;
    if (isConnected) {
        // å°è¯•è§£æ JSON
        const match = content.match(/\[[\s\S]*\]/);
        if (match) finalData = JSON.parse(match[0]);
        else throw new Error("å¯¹è¯æ ¼å¼è§£æå¤±è´¥");
    } else {
        // éšç¬”ç›´æ¥å­˜æ–‡æœ¬
        finalData = content;
    }

    // ğŸ”¥ å­˜å…¥ç¼“å­˜
    const cacheObj = {
        mode: mode,
        content: finalData,
        timestamp: Date.now()
    };
    localStorage.setItem(cacheKey, JSON.stringify(cacheObj));

    // æ¸²æŸ“
    renderCallContent(cacheObj, log.duration);
    document.getElementById('cc-loader').style.display = 'none';
}

/**
 * 3. æ¸²æŸ“å™¨ (åŒºåˆ†æ°”æ³¡å’Œæ–‡æœ¬)
 */
function renderCallContent(cacheObj, duration) {
    const container = document.getElementById('cc-body-container');
    const { mode, content } = cacheObj;
    
    let html = "";

    if (mode === "DIALOGUE") {
        // æ¸²æŸ“èŠå¤©æ°”æ³¡
        // content æ˜¯æ•°ç»„: [{speaker:"me", text:"..."}, ...]
        html += `<div style="text-align:center; color:#444; font-size:10px; margin-bottom:20px;">--- START OF CALL (${duration} MIN) ---</div>`;
        
        content.forEach(msg => {
            const isMe = msg.speaker === 'me';
            html += `
                <div class="chat-bubble-row ${isMe ? 'right' : 'left'}">
                    <div class="chat-bubble">
                        <div class="bubble-name">${isMe ? 'ME' : 'CALLER'}</div>
                        ${msg.text}
                    </div>
                </div>
            `;
        });
        
        html += `<div style="text-align:center; color:#444; font-size:10px; margin-top:20px;">--- CALL ENDED ---</div>`;

    } else {
        // æ¸²æŸ“éšç¬”æ—¥è®°
        // å¤„ç†æ¢è¡Œï¼Œå¢åŠ æ®µè½é—´è·
        let formatted = content.replace(/\n/g, '<br>');
        html = `
            <div class="diary-text-layout">
                <div style="text-align:center; color:#555; font-size:12px; margin-bottom:30px; border-bottom:1px dashed #333; padding-bottom:10px;">
                    MISSED CALL LOG // æœªæ¥æ¥ç”µå½’æ¡£
                </div>
                ${formatted}
                <div style="margin-top:40px; text-align:right; font-size:10px; color:#666;">
                    [ è®°å½•å·²å°å­˜ ]
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

// ç›‘å¬ HTML åŠ è½½å®Œæˆäº‹ä»¶
document.addEventListener('DOMContentLoaded', () => {
    // å»¶è¿Ÿ 100ms ç¡®ä¿ HTML å…ƒç´ å·²ç»å­˜åœ¨
    setTimeout(() => {
        // 1. å°è¯•æ¢å¤ ID
        const savedId = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');
        if (savedId) {
            window.currentVaultCharID = savedId; // æ¢å¤å…¨å±€å˜é‡
            console.log("[ç³»ç»Ÿå¯åŠ¨] å·²æ¢å¤ä¸Šæ¬¡æ“ä½œçš„è§’è‰² ID:", savedId);
        }

        // 2. ğŸ’¥ å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡æ¸²æŸ“
        if (typeof window.renderPhoneBillList === 'function') {
            window.renderPhoneBillList();
        }
    }, 100);
});

/* ============================================================
   ğŸ“¡ çœŸå®è¯è´¹è´¦å•ç”Ÿæˆç³»ç»Ÿ (Pro Max: åŠ¨æ€èµ„è´¹ç‰ˆ)
   ============================================================ */

// ğŸ“Š 1. èµ„è´¹åè®®é…ç½® (å¤§é™ä»·ï¼)
const LUNE_TARIFF = {
    BASE_RATE: 0.15,       // åŸæ¥ 0.8 -> ç°åœ¨ 0.15 (æ¯åˆ†é’Ÿ 1æ¯›5)
    TAX_RATE: 0.08,        // ç¨ç‡é™ä¸º 8%
    MULTIPLIERS: {
        'ENCRYPTED': 2.0,  // åŠ å¯†é€šè¯ 2å€ (åŸæ¥3.5å€)
        'UNKNOWN': 1.2,    
        'ROAMING': 1.5,    
        'LOCAL': 1.0,      
        'SERVICE': 0.0     // å…è´¹
    }
};

/* ============================================================
   ğŸ“¡ è¯è´¹ç”Ÿæˆå™¨ (ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶æŒ‡å®šæ¸²æŸ“ ID)
   ============================================================ */
window.triggerPhoneBillAI = async function() {
    const btn = document.querySelector('button[onclick="window.triggerPhoneBillAI()"]');
    const originalText = btn ? btn.innerHTML : "GENERATE";

    // 1. è·å–å½“å‰è§’è‰² ID (ä¼˜å…ˆå…¨å±€å˜é‡ï¼Œå…¶æ¬¡ç¼“å­˜)
    const charId = window.currentVaultCharID || localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');
    
    if (!charId || charId === "undefined") {
        return alert("ç³»ç»Ÿæ— æ³•å®šä½å½“å‰è§’è‰²èº«ä»½ï¼Œè¯·é‡æ–°ç‚¹å‡»å·¦ä¾§å¤´åƒï¼");
    }

    // (UI å˜æ›´ä¸ºåŠ è½½çŠ¶æ€)
    if(btn) {
        btn.disabled = true;
        btn.innerHTML = `<span class="blink-symbol">_</span> ANALYZING...`;
    }

    // 2. ğŸ’° ä½™é¢æ£€æŸ¥ (æ²¡é’±ä¸è®© AI è·‘)
    const npcBalances = JSON.parse(localStorage.getItem('lune_npc_sim_data') || '{}');
    const currentBalance = parseFloat(npcBalances[charId] || 0);
    if (currentBalance < 1.0) {
        openLowBalanceModal("1.00", currentBalance);
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
        return;
    }

    // 3. API å‡†å¤‡
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    
    if (!apiKey) {
        if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
        return alert("API Key Missing");
    }
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    if(btn) {
        btn.disabled = true;
        btn.innerHTML = `<span class="blink-symbol">_</span> AI IS WRITING SCENARIO...`;
    }

    try {
        // --- A. è·å–äººè®¾ (è¿™æ˜¯ AI å‘æŒ¥çš„å”¯ä¸€ä¾æ®) ---
        let charName = "Unknown";
        let charBio = "ä¸€ä¸ªç¥ç§˜çš„è·¯äºº";
        
        if (typeof loadFromDB === 'function') {
            const charList = await loadFromDB('char_list') || [];
            const target = charList.find(c => c.id === charId);
            if (target) {
                charName = target.name;
                // ä¼˜å…ˆå–æœ€è¯¦ç»†çš„æè¿°å­—æ®µ
                charBio = target.desc || target.bio || target.personality || "æ— è¯¦ç»†äººè®¾";
            }
        }
        
        console.log(`[AI] æ­£åœ¨åŸºäºäººè®¾æ¨æ¼”å‰§æƒ…: ${charName} | ${charBio.substring(0, 30)}...`);

        // --- B. æ„é€ â€œå¯¼æ¼”çº§â€ Prompt (å®Œå…¨äº¤ç»™ AI) ---
        const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèµ›åšæœ‹å…‹ä¸–ç•Œçš„ã€é€šè®¯è®°å½•ä¼ªé€ å¸ˆã€‘ã€‚
        
        ã€ç›®æ ‡æ¡£æ¡ˆã€‘ï¼š
        - å§“åï¼š${charName}
        - æ ¸å¿ƒäººè®¾/èƒŒæ™¯ï¼š${charBio}
        
        ã€ä½ çš„ä»»åŠ¡ã€‘ï¼š
        è¯·å‘æŒ¥ä½ çš„æƒ³è±¡åŠ›ï¼Œæ ¹æ®ä¸Šè¿°äººè®¾ï¼Œ**éšæœºæ¨æ¼”**â€œè¿™ä¸ªè§’è‰²ä»Šå¤©ç»å†äº†ä»€ä¹ˆâ€ã€‚
        ç„¶ååŸºäºä½ æ¨æ¼”å‡ºçš„å‰§æƒ…ï¼Œç”Ÿæˆ **4-7æ¡** çœŸå®çš„é€šè¯è®°å½•ã€‚
        
        ã€æ¨æ¼”è¦æ±‚ (å¿…é¡»ç”± AI åŠ¨æ€å†³å®š)ã€‘ï¼š
        1. **æ‹’ç»åƒç¯‡ä¸€å¾‹**ï¼š
           - å¦‚æœä»–æ˜¯ç‰¹å·¥ï¼Œä»Šå¤©å¯èƒ½æ˜¯ä»»åŠ¡å¤±è´¥è¢«è¿½æ€ï¼Ÿè¿˜æ˜¯æ­£åœ¨æ½œä¼ï¼Ÿ
           - å¦‚æœå¥¹æ˜¯å­¦ç”Ÿï¼Œä»Šå¤©å¯èƒ½æ˜¯é€ƒè¯¾ï¼Ÿè¿˜æ˜¯è¡¨ç™½å¤±è´¥ï¼Ÿ
           - å¦‚æœä»–æ˜¯å•†äººï¼Œä»Šå¤©å¯èƒ½æ˜¯ç ´äº§ï¼Ÿè¿˜æ˜¯è°ˆæˆäº†å¤§å•ï¼Ÿ
        2. **é€šè¯å¯¹è±¡ (caller)**ï¼šå¿…é¡»ç¬¦åˆäººè®¾åœˆå±‚ã€‚ä¸è¦ç»™æ€æ‰‹å®‰æ’â€œæ¨é”€å‘˜â€ï¼Œä¸è¦ç»™ä¹ä¸å®‰æ’â€œé“¶è¡Œç»ç†â€ã€‚
        3. **ç±»å‹æ ‡è®° (tag)**ï¼š
           - LOCAL (æ™®é€š)
           - ENCRYPTED (ä»»ä½•å¯ç–‘ã€ç§˜å¯†ã€å±é™©çš„é€šè¯)
           - UNKNOWN (é™Œç”Ÿäººã€éªšæ‰°)
           - SERVICE (å¿«é€’ã€ç³»ç»Ÿã€å®¢æœ)
           - ROAMING (å¦‚æœå‰§æƒ…æ¶‰åŠè·¨å›½/è·¨æ˜Ÿé™…)
        4. **ä¸Šä¸‹æ–‡ (context)**ï¼šå¿…é¡»ç®€çŸ­æœ‰åŠ›ï¼Œæš—ç¤ºå‰§æƒ…ã€‚ä¾‹å¦‚ï¼š"æ€¥ä¿ƒçš„å‘¼å¸å£°"ã€"è¦æ±‚ç«‹åˆ»æ±‡æ¬¾"ã€"æ²‰é»˜äº†3ç§’"ã€‚
        
        ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
        åªè¿”å›çº¯ JSON æ•°ç»„ï¼Œä¸è¦åŒ…å«ä»»ä½• Markdown æˆ–è§£é‡Šã€‚
        
        ç¤ºä¾‹ç»“æ„ï¼š
        [
          {"caller": "...", "tag": "TYPE", "type": "in/out", "duration": 12, "context": "..."},
          ...
        ]`;

        const userPrompt = `å¼€å§‹ç”Ÿæˆã€‚éšæœºå› å­: ${Math.random()} (è¯·åˆ›é€ ä¸€ä¸ªä¸æ˜¨å¤©å®Œå…¨ä¸åŒçš„å‰§æœ¬)`;

        // --- C. è¯·æ±‚ AI (é«˜åˆ›é€ æ€§) ---
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: userPrompt}],
                temperature: 1.0, // ğŸ”¥ æ‹‰æ»¡ï¼è®© AI æå…¶å¥”æ”¾
                top_p: 0.9
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        
        const jsonMatch = data.choices[0].message.content.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI æ ¼å¼æ··ä¹±ï¼Œå°è¯•é‡è¯•");
        
        const generatedLogs = JSON.parse(jsonMatch[0]);

        // --- D. è®¡è´¹ & å†™å…¥é€»è¾‘ ---
        let totalCost = 0;
        let totalMins = 0;

        generatedLogs.forEach(log => {
            const tag = (log.tag || 'LOCAL').toUpperCase();
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿ LUNE_TARIFF å˜é‡åœ¨å…¨å±€å·²å®šä¹‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™
            const tariff = (typeof LUNE_TARIFF !== 'undefined') ? LUNE_TARIFF : { BASE_RATE: 0.15, TAX_RATE: 0.08, MULTIPLIERS: { 'ENCRYPTED': 2.0, 'UNKNOWN': 1.2, 'ROAMING': 1.5, 'LOCAL': 1.0, 'SERVICE': 0.0 } };
            
            const multiplier = tariff.MULTIPLIERS[tag] || 1.0;
            let callCost = log.duration * tariff.BASE_RATE * multiplier;
            if (callCost > 0) callCost *= (1 + tariff.TAX_RATE);
            
            log.realCost = callCost.toFixed(2);
            log.rateTag = `${multiplier}x`;
            totalCost += callCost;
            totalMins += log.duration;
        });

        // ä½™é¢åˆ¤æ–­
        if (currentBalance < totalCost) {
            if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
            openLowBalanceModal(totalCost.toFixed(2), currentBalance);
            return;
        }

        // æ‰£é’±
        const newBalance = currentBalance - totalCost;
        npcBalances[charId] = newBalance.toFixed(2);
        localStorage.setItem('lune_npc_sim_data', JSON.stringify(npcBalances));

        // å­˜å•
        const billData = {
            id: "BILL_" + Date.now(),
            date: new Date().toLocaleDateString(),
            timestamp: Date.now(),
            logs: generatedLogs,
            totalCost: totalCost.toFixed(2),
            totalDuration: totalMins
        };

        // å†™å…¥è¯¥è§’è‰²çš„ä¸“å± Key
        let allBills = JSON.parse(localStorage.getItem('lune_npc_bills_' + charId) || '[]');
        allBills.unshift(billData);
        localStorage.setItem('lune_npc_bills_' + charId, JSON.stringify(allBills));

        // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶ä¼ å…¥ charId è¿›è¡Œæ¸²æŸ“ ğŸ”¥ğŸ”¥ğŸ”¥
        // è¿™æ ·å¯ä»¥ç¡®ä¿åˆ—è¡¨ç«‹åˆ»æ˜¾ç¤ºï¼Œä¸éœ€è¦ç­‰ä¸‹ä¸€æ¬¡ç‚¹å‡»
        if (typeof window.renderPhoneBillList === 'function') {
            window.renderPhoneBillList(charId);
        }
        
        // åˆ·æ–°ä½™é¢æ˜¾ç¤º
        if (typeof window.renderCharacterSims === 'function') {
            window.renderCharacterSims();
        }

        if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
        if(navigator.vibrate) navigator.vibrate([50, 30, 50]);

    } catch (e) {
        console.error("ç”Ÿæˆé”™è¯¯:", e);
        if(btn) { btn.disabled = false; btn.innerHTML = "RETRY"; }
        alert("AIç”Ÿæˆå¤±è´¥: " + e.message);
    }
};

/**
 * ğŸ’¥ æ ¸å¼¹çº§ä¿®å¤ï¼šè¯è´¹æ¸²æŸ“ (åªè®¤æ­»ç†ç‰ˆ)
 * é€»è¾‘ï¼šå¦‚æœæˆ‘ä¸ç»™ä½  IDï¼Œä½ å°±å»è¯» currentVaultCharIDã€‚ç»ä¸å»è¯» LocalStorageï¼
 */
window.renderPhoneBillList = function(forceId) {
    const container = document.getElementById('phone-bill-list');
    if (!container) return;

    // 1. ğŸ”¥ æ ¸å¿ƒï¼šåªè®¤å½“å‰å†…å­˜é‡Œæ´»ç€çš„äººï¼
    // ä¹‹å‰å¯èƒ½ä¼˜å…ˆè¯»äº† localStorageï¼Œé‚£æ˜¯â€œä¸Šæ¬¡â€çš„äººï¼Œä¸ä»…ä¸å‡†ï¼Œè¿˜ä¼šé€ æˆå›æ¡£
    const targetId = forceId || window.currentVaultCharID; 

    // è°ƒè¯•æ—¥å¿—ï¼šçœ‹çœ‹ç°åœ¨åˆ°åº•æŠ“çš„æ˜¯è°
    console.log(`[è´¦å•æ ¸å¼¹] æ­£åœ¨å¼ºåˆ¶æ¸²æŸ“ ID: ${targetId}`);

    if (!targetId || targetId === "undefined" || targetId === "GLOBAL") {
        container.innerHTML = `<div class="empty-text-mark">NO_ENTITY_LOCKED</div>`;
        return;
    }

    // 2. ğŸ”¥ æš´åŠ›æ¸…ç©ºï¼šä¸ç®¡æœ‰æ²¡æœ‰æ–°æ•°æ®ï¼Œå…ˆæŠŠæ—§çš„åˆ å¹²å‡€
    container.innerHTML = '';

    // 3. è¯»æ•°æ®
    const storageKey = 'lune_npc_bills_' + targetId;
    const allBills = JSON.parse(localStorage.getItem(storageKey) || '[]');

    if (allBills.length === 0) {
        container.innerHTML = `
            <div class="empty-text-mark">
                NO DATA FOR: ${targetId}<br>
                <span style="font-size:9px;opacity:0.5;">è¯·ç‚¹å‡» GENERATE ç”Ÿæˆ</span>
            </div>`;
        return;
    }

    // 4. æ¸²æŸ“
    let html = "";
    allBills.forEach((bill) => {
        html += `
            <div class="bill-item" onclick="window.openBillDetail('${targetId}', '${bill.id}')">
                <div class="bill-row">
                    <span class="bill-date">${bill.date}</span>
                    <span class="bill-cost" style="color:#000;">-ï¿¥${bill.totalCost}</span>
                </div>
                <div class="bill-meta">
                    <span>LOGS: ${bill.logs.length}</span>
                    <span>ACTIVE: ${bill.totalDuration}m</span>
                    <span style="margin-left:auto; color:#007aff;">[ RECEIPT ]</span>
                </div>
                <div style="height:2px; background:repeating-linear-gradient(90deg, #ccc 0px, #ccc 4px, transparent 4px, transparent 6px); margin-top:8px; opacity:0.5;"></div>
            </div>
        `;
    });
    container.innerHTML = html;
};

/**
 * ğŸ”„ 4. é¡µé¢åŠ è½½åˆå§‹åŒ– (è§£å†³åˆ·æ–°åç©ºç™½)
 */
window.addEventListener('DOMContentLoaded', () => {
    // å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œç­‰å¾… HTML ç»“æ„å°±ç»ª
    setTimeout(() => {
        // å°è¯•æ¢å¤ ID
        const savedId = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');
        if (savedId) {
            window.currentVaultCharID = savedId;
            console.log("[Billing] ç³»ç»Ÿé‡å¯ï¼Œæ¢å¤ç›®æ ‡ ID:", savedId);
        }
        
        // å¼ºåˆ¶æ¸²æŸ“åˆ—è¡¨
        window.renderPhoneBillList();
    }, 300);
});


/**
 * ğŸ“œ è´¦å•è¯¦æƒ…å¼¹çª— (ä¿®å¤ index æŠ¥é”™ç‰ˆ)
 */
window.openBillDetail = function(charId, billId) {
    const allBills = JSON.parse(localStorage.getItem('lune_npc_bills_' + charId) || '[]');
    const bill = allBills.find(b => b.id === billId);
    if (!bill) return;

    // å¡«å……å¤´éƒ¨ä¿¡æ¯
    if(document.getElementById('receipt-date')) document.getElementById('receipt-date').innerText = bill.date;
    if(document.getElementById('receipt-ref')) document.getElementById('receipt-ref').innerText = bill.id.slice(-6).toUpperCase();

    const container = document.getElementById('bill-detail-content');
    let html = "";

    // ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œå¿…é¡»å†™ (log, index) ï¼ï¼ï¼ ğŸ”¥ğŸ”¥
    bill.logs.forEach((log, index) => {
        // æ ¹æ® Tag å†³å®šé¢œè‰²
        const icon = log.type === 'in' ? 'IN' : 'OUT';
        let tagColor = '#000'; // å°ç¥¨é£æ ¼å…¨é»‘å­—

        if (log.tag === 'ENCRYPTED') tagColor = '#ff3b30'; // çº¢è‰²
        if (log.tag === 'LOCAL') tagColor = '#4cd964'; // ç»¿è‰²
        if (log.tag === 'SERVICE') tagColor = '#007aff'; // è“è‰²

        // ğŸ”¥ğŸ”¥ æ³¨æ„ onclick é‡Œçš„ index å˜é‡ç°åœ¨æœ‰å®šä¹‰äº† ğŸ”¥ğŸ”¥
        html += `
            <div class="log-detail-item" 
                 onclick="window.openCallContent('${bill.id}', ${index})"
                 style="cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='rgba(0,0,0,0.05)'" 
                 onmouseout="this.style.background='transparent'">
                 
                <div class="log-left">
                    <div style="font-weight:bold; font-size:13px;">${log.caller}</div>
                    <div style="font-size:10px; color:#666;">${log.context}</div>
                    <div style="font-size:9px; margin-top:4px;">
                        <span style="border:1px solid #000; padding:1px 3px; color:${tagColor}; border-color:${tagColor};">${log.tag}</span>
                        <span>${icon}</span>
                    </div>
                </div>
                <div class="log-right">
                    <div style="font-weight:bold;">${log.duration}m</div>
                    <div style="font-size:13px;">ï¿¥${log.realCost}</div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    
    // æ›´æ–°æ€»è®¡
    if(document.getElementById('bill-detail-total')) {
        document.getElementById('bill-detail-total').innerText = `ï¿¥${bill.totalCost}`;
    }
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('modal-bill-detail').style.display = 'flex';
};

window.closeBillDetail = function() {
    document.getElementById('modal-bill-detail').style.display = 'none';
};

/* ============================================================
   âš ï¸ æ¬ è´¹ & æ™ºèƒ½å‚¬æ”¶ç³»ç»Ÿ (ä¿æŒä¸å˜ï¼Œå› ä¸ºé€»è¾‘å·²ç»å¾ˆå®Œå–„)
   ============================================================ */

window.openLowBalanceModal = function(needed, current) {
    const modal = document.getElementById('modal-low-balance');
    if(modal) {
        modal.style.display = 'flex';
        // å¯ä»¥åœ¨ç•Œé¢ä¸Šæç¤ºå·®å¤šå°‘é’±
        // const diff = (parseFloat(needed) - parseFloat(current)).toFixed(2);
        // alert(`è¿˜éœ€è¦ ï¿¥${diff}`);
    }
    if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
};

window.closeLowBalanceModal = function() {
    document.getElementById('modal-low-balance').style.display = 'none';
};

window.sendTopUpReminder = async function() {
    closeLowBalanceModal();
    const charId = window.currentVaultCharID || window.currentManagementChar;
    
    let charName = "Unknown";
    let desc = "";
    if (typeof loadFromDB === 'function') {
        const chars = await loadFromDB('char_list') || [];
        const c = chars.find(x => x.id === charId);
        if(c) { charName = c.name; desc = c.desc || c.bio || ""; }
    }
    
    const isChinese = /[\u4e00-\u9fa5]/.test(desc);
    let msgText = "";
    if (isChinese) {
        msgText = `[ç³»ç»Ÿè½¬æ¥] ä¿¡å·å—é˜»... é€šè®¯è´¦æˆ·å·²æ¬ è´¹ï¼Œæ— æ³•å»ºç«‹è¿æ¥ã€‚è¯·æ±‚æ”¯æ´ã€‚`;
    } else {
        msgText = `[System Redirect] Signal blocked... SIM account debt limit reached. Requesting immediate top-up.`;
    }

    const topUpCardData = { type: 'card_request_topup', amount: 100, currency: 'CNY' };

    const msgObj = {
        id: "MSG_" + Date.now(),
        role: "assistant",
        text: msgText,
        timestamp: Date.now(),
        app_source: 'sms',
        metadata: topUpCardData 
    };

    if (typeof saveChatMessage === 'function') {
        await saveChatMessage(charId, msgObj);
        showIndAlert(`REMINDER SENT <br><span style="font-size:10px;color:#888">è¯·æ±‚çŸ­ä¿¡å·²å‘é€ã€‚</span>`);
        if(typeof renderLmsgList === 'function') renderLmsgList();
    }
};

/**
 * 2. æ¸²æŸ“è§’è‰²å¡ç‰‡ (æ ¸å¿ƒ)
 * é€»è¾‘ï¼šéå† chat_friends -> æŸ¥ phone_directory -> æœ‰å·å°±ç”Ÿæˆå¡
 */
window.renderCharacterSims = async function() {
    const container = document.getElementById('char-sim-list');
    if (!container) return;
    
    container.innerHTML = '<div style="padding:20px; color:#666; font-size:10px;">SCANNING FREQUENCIES...</div>';

    // 1. è¯»å–æ•°æ®
    const friends = await loadFromDB('chat_friends') || [];
    const phoneDir = await loadFromDB('phone_directory') || {};
    // è¯»å–è§’è‰²ä½™é¢åº“ ( lune_npc_sim_data: { charId: "500.00" } )
    const npcBalances = JSON.parse(localStorage.getItem('lune_npc_sim_data') || '{}');

    let html = "";
    let count = 0;

    // 2. éå†å¥½å‹åˆ—è¡¨
    for (let f of friends) {
        // æ’é™¤ç³»ç»Ÿå·
        if (f.isSystem || f.id.toString().startsWith('SERVICE')) continue;

        // ğŸ” æŸ¥æ‰¾è¯¥è§’è‰²æ˜¯å¦æœ‰ç”µè¯å·ç 
        // phone_directory çš„ç»“æ„æ˜¯: { "id_roleID": "13800000000" }
        const phoneNum = phoneDir["id_" + f.id];

        if (phoneNum) {
            count++;
            const balance = npcBalances[f.id] || "0.00"; // è·å–ä½™é¢ï¼Œé»˜è®¤0
            const displayNum = phoneNum.replace(/(.{3})(?=.)/g, "$1 "); // æ ¼å¼åŒ–

            html += `
                <div class="char-sim-card" onclick="openCharTopUpModal('${f.id}', '${f.name}', '${phoneNum}', '${f.avatar}')">
                    <div class="csc-header">
                        <div>
                            <div class="csc-name">${f.name.toUpperCase()}</div>
                            <div class="csc-role">LINKED_ENTITY</div>
                        </div>
                        <img src="${f.avatar}" class="csc-avatar">
                    </div>
                    
                    <div class="csc-number">${displayNum}</div>
                    
                    <div class="csc-footer">
                        <div>
                            <div class="csc-bal-label">DATA_PLAN</div>
                            <div style="font-size:10px; color:#888;">UNLIMITED</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="csc-bal-label">BALANCE</div>
                            <div class="csc-balance">ï¿¥${parseFloat(balance).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // 3. æ¸²æŸ“
    if (count === 0) {
        container.innerHTML = `<div style="padding:20px; text-align:center; color:#444; font-size:10px; border:1px dashed #333; border-radius:8px; margin-right:15px;">
            NO LINKED NUMBERS<br>è¯·åœ¨é€šè®¯å½•æ·»åŠ å¸¦å·ç çš„è§’è‰²
        </div>`;
    } else {
        container.innerHTML = html;
    }
};

/* ============================================================
   ğŸ’° è§’è‰²å……å€¼ä¸“å±æµç¨‹ (ä¿®å¤å˜é‡ä¸¢å¤± bug ç‰ˆ)
   ============================================================ */

// ğŸš¨ æ ¸å¿ƒä¿®å¤ 1ï¼šè¿™ä¸ªå˜é‡å¿…é¡»å®šä¹‰åœ¨æ‰€æœ‰å‡½æ•°çš„æœ€å¤–é¢ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰
// ä¸è¦æŠŠå®ƒå†™åœ¨ä»»ä½• function {} çš„å¤§æ‹¬å·é‡Œé¢ï¼
var tempCharTopUpTarget = null; 

/**
 * 1. æ‰“å¼€è§’è‰²å……å€¼/è¯¦æƒ…å¼¹çª— (ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶åŒæ­¥èº«ä»½ ID)
 */
window.openCharTopUpModal = function(id, name, num, avatar) {
    console.log(`[äº¤äº’] é€‰ä¸­è§’è‰²: ${name} (ID: ${id})`);

    // ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»å¤´åƒæ—¶ï¼Œå¼ºåˆ¶æ›´æ–°å…¨å±€ ID ğŸ”¥ğŸ”¥
    window.currentVaultCharID = id;
    window.currentManagementChar = id;
    localStorage.setItem('LUNE_LAST_SELECTED_CHAR_ID', id);

    // 1. é”å®šç›®æ ‡æ•°æ® (ç”¨äºå……å€¼é€»è¾‘)
    window.tempCharTopUpTarget = { id, name, num };

    // 2. UI æ›´æ–°ï¼šå¡«å……å¼¹çª—æ•°æ®
    const modal = document.getElementById('modal-char-topup');
    if (document.getElementById('ct-avatar')) document.getElementById('ct-avatar').src = avatar;
    if (document.getElementById('ct-name')) document.getElementById('ct-name').innerText = name.toUpperCase();
    if (document.getElementById('ct-number')) document.getElementById('ct-number').innerText = num;
    if (document.getElementById('ct-amount-inp')) document.getElementById('ct-amount-inp').value = "";

    // 3. æ˜¾ç¤ºå¼¹çª—
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
    }
    
    // 4. ğŸ”¥ğŸ”¥ é¡ºä¾¿åˆ·æ–°è¯è´¹è´¦å•åˆ—è¡¨ (è™½ç„¶å¼¹çª—æŒ¡ä½äº†ï¼Œä½†èƒŒæ™¯é‡Œè¦æ›´æ–°) ğŸ”¥ğŸ”¥
    if (typeof renderPhoneBillList === 'function') renderPhoneBillList();

    if(navigator.vibrate) navigator.vibrate(10);
};

/**
 * 2. å…³é—­å¼¹çª— (å¹¶æ¸…ç©ºç›®æ ‡)
 */
window.closeCharTopUp = function() {
    const modal = document.getElementById('modal-char-topup');
    if (modal) modal.style.display = 'none';
    
    // å¯é€‰ï¼šå…³é—­åæ¸…ç©ºç›®æ ‡ï¼Œé˜²æ­¢è¯¯æ“ä½œï¼ˆä½†è¿™ä¼šå¯¼è‡´åˆšæ‰æŠ¥é”™çš„åŸå› ï¼‰
    // å»ºè®®ï¼šå…³é—­æ—¶æ‰æ¸…ç©ºï¼Œæˆ–è€…å¹²è„†ä¸æ¸…ç©ºï¼Œä¸‹æ¬¡æ‰“å¼€ä¼šè¦†ç›–
    tempCharTopUpTarget = null; 
};

/**
 * 3. æ‰§è¡Œå……å€¼ (ä¿®å¤é¡ºåºç‰ˆï¼šå…ˆå¤‡ä»½æ•°æ®ï¼Œåå…³é—­å¼¹çª—)
 */
window.executeCharTopUp = async function() {
    // 1. å®‰å…¨æ£€æŸ¥
    if (!tempCharTopUpTarget) {
        alert("å……å€¼ç›®æ ‡ä¸¢å¤±ï¼Œè¯·é‡æ–°æ‰“å¼€å¼¹çª—");
        return; 
    }

    const amountVal = document.getElementById('ct-amount-inp').value;
    const amount = parseFloat(amountVal);

    if (!amount || amount <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
        return;
    }

    // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…ˆæŠŠæ•°æ®å¤‡ä»½åˆ°å±€éƒ¨å˜é‡ï¼ ğŸ”¥ğŸ”¥ğŸ”¥
    // è¿™æ ·åé¢å°±ç®— tempCharTopUpTarget è¢«æ¸…ç©ºï¼ŒcachedName ä¾ç„¶æ´»ç€
    const cachedId = tempCharTopUpTarget.id;
    const cachedName = tempCharTopUpTarget.name; 
    const cachedNum = tempCharTopUpTarget.num;
    const cachedLast4 = cachedNum.slice(-4);

    // --- A. å­˜å…¥è§’è‰²ä½™é¢åº“ ---
    let npcBalances = JSON.parse(localStorage.getItem('lune_npc_sim_data') || '{}');
    const oldBal = parseFloat(npcBalances[cachedId] || 0);
    const newBal = oldBal + amount;
    
    npcBalances[cachedId] = newBal.toFixed(2);
    localStorage.setItem('lune_npc_sim_data', JSON.stringify(npcBalances));

    // --- B. å…³é—­å¼¹çª—å¹¶åˆ·æ–° ---
    // è¿™ä¸ªå‡½æ•°ä¼šæŠŠå…¨å±€å˜é‡ tempCharTopUpTarget å˜æˆ null
    // ä½†æ˜¯æ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¸Šé¢å·²ç»å¤‡ä»½äº†ï¼
    closeCharTopUp();
    
    if (typeof renderCharacterSims === 'function') {
        renderCharacterSims(); 
    }

    // --- C. ä»ªå¼æ„Ÿ (ä½¿ç”¨å¤‡ä»½çš„ cachedName) ---
    
    // 1. é¡¶éƒ¨çµåŠ¨å²›
    if (typeof showLuneIsland === 'function') {
        showLuneIsland("TRANSFER SUCCESS", `Sent ï¿¥${amount} to ${cachedName}`);
    }

    // 2. é€šçŸ¥ä¸­å¿ƒ
    if (typeof addToNotificationCenter === 'function') {
        addToNotificationCenter({
            appName: "LUNE BANK",
            title: "è½¬è´¦æˆåŠŸ",
            text: `æ‚¨å‘ ${cachedName} (å°¾å·${cachedLast4}) è½¬è´¦ ï¿¥${amount}ã€‚`,
            time: "ç°åœ¨",
            icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="2"><path d="M17 9V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M9 19h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2z"></path></svg>`
        });
    }

    // 3. æ¨¡æ‹ŸçŸ­ä¿¡åé¦ˆ (ä½¿ç”¨ cachedName)
    setTimeout(async () => {
        const carrierId = "SERVICE_FINANCE_CORE"; 
        // è¿™é‡Œç”¨ cachedNameï¼Œç»å¯¹ä¸ä¼šæŠ¥é”™äº†
        const msgText = `ã€Lune Transferã€‘æ‚¨å‘ç”¨æˆ· ${cachedName} è½¬å…¥çš„ ï¿¥${amount.toFixed(2)} å·²å³æ—¶åˆ°è´¦ã€‚å¯¹æ–¹å½“å‰ä½™é¢ï¼šï¿¥${newBal.toFixed(2)}ã€‚`;
        
        if (typeof saveChatMessage === 'function') {
            await saveChatMessage(carrierId, {
                id: "TR_" + Date.now(),
                role: "assistant",
                text: msgText,
                timestamp: Date.now(),
                app_source: 'sms',
                isRead: false
            });
            // å¦‚æœæ­£å¥½åœ¨çœ‹çŸ­ä¿¡åˆ—è¡¨ï¼Œåˆ·æ–°ä¸€ä¸‹
            if (typeof renderLmsgList === 'function') renderLmsgList();
        }
        
        if (window.navigator.vibrate) window.navigator.vibrate([20, 50]);
        console.log("çŸ­ä¿¡å·²å‘é€ç»™:", cachedName); // éªŒè¯æ—¥å¿—
    }, 1500);
};

/**
 * ğŸ”” å”¤èµ·ä¸“å±çµåŠ¨å²›å¼¹çª—
 * @param {string} title - æ ‡é¢˜ (å¦‚: SIM ACTIVATED)
 * @param {string} desc - æè¿° (å¦‚: Access Granted)
 */
window.showLuneIsland = function(title, desc) {
    // 1. æ£€æŸ¥é¡µé¢ä¸Šæœ‰æ²¡æœ‰è¿™ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰å°±é€ ä¸€ä¸ª
    let banner = document.getElementById('lune-island-notification');
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'lune-island-notification';
        document.body.appendChild(banner);
    }

    // 2. å¡«å……å†…å®¹ (ä¿¡å·å›¾æ ‡)
    banner.innerHTML = `
        <div class="island-icon-box">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                <line x1="12" y1="20" x2="12.01" y2="20"></line>
            </svg>
        </div>
        <div class="island-text-content">
            <div class="island-title">${title}</div>
            <div class="island-desc">${desc}</div>
        </div>
    `;

    // 3. åŠ¨ç”»å…¥åœº (åŠ ä¸ªå¾®å°å»¶è¿Ÿç¡®ä¿è¿‡æ¸¡ç”Ÿæ•ˆ)
    requestAnimationFrame(() => {
        banner.classList.add('active');
    });

    // 4. è§¦æ„Ÿåé¦ˆ
    if (window.navigator.vibrate) window.navigator.vibrate([10, 30, 10]);

    // 5. 3.5ç§’åè‡ªåŠ¨æ”¶å›
    setTimeout(() => {
        banner.classList.remove('active');
    }, 3500);
};

/**
 * ğŸ“¶ æ¸²æŸ“ SIM ä¸“å±é¡µé¢ (ä¿®å¤ä½™é¢æ˜¾ç¤ºç‰ˆ)
 */
window.renderSimPage = function() {
    const list = document.getElementById('sim-cards-list');
    const emptyState = document.getElementById('sim-empty-state');
    const controlPanel = document.getElementById('sim-control-panel');
    
    if (!list) return; 

    const allCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    const simCards = allCards
        .map((c, idx) => ({...c, originalIdx: idx}))
        .filter(c => c.isSim === true);

    list.innerHTML = '';

    if (simCards.length === 0) {
        if(emptyState) emptyState.style.display = 'block';
        if(controlPanel) controlPanel.style.display = 'none';
        return;
    } else {
        if(emptyState) emptyState.style.display = 'none';
    }

    simCards.forEach((sim) => {
        const isActive = (window.currentSimIndex === sim.originalIdx) ? 'active' : '';
        // æ ¼å¼åŒ–é‡‘é¢
        const balanceTxt = parseFloat(sim.balance || 0).toFixed(2);
        
        const card = document.createElement('div');
        card.className = `lune-sim-card ${isActive}`;
        card.onclick = () => selectSimCard(sim.originalIdx);

        card.innerHTML = `
            <div style="pointer-events:none;">
                <div class="sim-chip"></div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:10px; color:#666; font-family:'Montserrat';">LUNE CARRIER</div>
                    <div style="font-size:14px; color:#4cd964; font-weight:800; font-family:'Cinzel';">ï¿¥${balanceTxt}</div>
                </div>
                <div style="font-size:18px; color:#fff; font-family:'Cinzel'; letter-spacing:1px; margin-top:10px;">
                    ${sim.number.replace(/(.{3})(?=.)/g, "$1 ")}
                </div>
            </div>

            <div class="sim-footer" style="display:flex; justify-content:space-between; align-items:flex-end; pointer-events:none;">
                <div>
                    <div style="font-size:9px; color:#888;">PROTOCOL</div>
                    <div style="font-size:11px; color:#ccc;">${sim.planName || 'STANDARD'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:9px; color:#888;">STATUS</div>
                    <div style="font-size:10px; color:#fff;">ACTIVE</div>
                </div>
            </div>
            
            ${isActive ? '<div style="position:absolute; bottom:15px; right:15px; width:6px; height:6px; background:#0f0; border-radius:50%; box-shadow:0 0 5px #0f0;"></div>' : ''}
        `;
        list.appendChild(card);
    });
    
    // ç¡®ä¿ä¸‹æ–¹æ§åˆ¶é¢æ¿åŒæ­¥æ•°æ®
    updateSimControlPanel();
};

/**
 * ğŸ“² æ ¸å¿ƒåŠŸèƒ½ï¼šå¾€é€šçŸ¥ä¸­å¿ƒ (Notification Shade) æ·»åŠ ä¸€æ¡è®°å½•
 * @param {Object} config { appName, title, text, time, icon }
 */
window.addToNotificationCenter = function(config) {
    const list = document.getElementById('notification-list');
    if (!list) return;

    // 1. ç§»é™¤â€œæ²¡æœ‰æ›´æ—©çš„é€šçŸ¥äº†â€ (å¦‚æœå­˜åœ¨)
    const emptyState = list.querySelector('.notif-empty-state');
    if (emptyState) {
        emptyState.style.display = 'none';
    }

    // 2. é»˜è®¤å‚æ•°å¤„ç†
    const appName = config.appName || "SYSTEM";
    const title = config.title || "New Notification";
    const text = config.text || "";
    const time = config.time || "ç°åœ¨";
    // é»˜è®¤æ˜¯ä¸€ä¸ªä¿¡å·å›¾æ ‡
    const defaultIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`;
    const icon = config.icon || defaultIcon;

    // 3. åˆ›å»ºé€šçŸ¥æ¡ç›® DOM
    const item = document.createElement('div');
    item.className = 'notif-item-row'; // å¯¹åº”ä¸‹é¢çš„ CSS
    
    // 4. æ„é€  iOS é£æ ¼çš„é€šçŸ¥ HTML
    item.innerHTML = `
        <div class="notif-item-header">
            <div class="notif-app-icon">${icon}</div>
            <span class="notif-app-name">${appName}</span>
            <span class="notif-time-ago">${time}</span>
        </div>
        <div class="notif-content-body">
            <div class="notif-item-title">${title}</div>
            <div class="notif-item-desc">${text}</div>
        </div>
    `;

    // 5. æ’å…¥åˆ°æœ€å‰é¢ (æœ€æ–°çš„åœ¨ä¸Šé¢)
    list.prepend(item);
    
    // 6. ç¨å¾®éœ‡åŠ¨ä¸€ä¸‹
    if (window.navigator.vibrate) window.navigator.vibrate(10);
};

/**
 * ğŸ’¾ ä¿å­˜æ–°å¡ç‰‡ (å‡çº§ç‰ˆï¼šå¸¦å¼¹çª— + è¿è¥å•†çŸ­ä¿¡)
 */
window.saveNewCard = async function() {
    // 1. è·å–è¾“å…¥æ•°æ®
    const nameInput = document.getElementById('input-card-name');
    const numInput = document.getElementById('input-card-number');
    
    // é˜²ç©ºå¤„ç†
    const cardName = document.getElementById('p-name').innerText || "MY CARD";
    const cardNum = document.getElementById('p-number').innerText || "0000";

    const cardData = {
        name: cardName,
        number: cardNum,
        color: currentCardColor,
        bg: selectedCardBg,
        layout: currentLayout,
        charId: boundCharId,
        balance: "0.00" // æ–°å¡ä½™é¢ä¸º0
    };

    // 2. å­˜å…¥æœ¬åœ°å­˜å‚¨
    let cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    cards.push(cardData);
    localStorage.setItem('lune_wallets', JSON.stringify(cards));

    // 3. åˆ·æ–° UI
    renderSavedCards();
    
    // 4. å…³é—­ç¼–è¾‘å™¨
    toggleCardEditor(false);
    
    // 5. éœ‡åŠ¨åé¦ˆ (ç‰©ç†è§¦æ„Ÿ)
    if (window.navigator.vibrate) window.navigator.vibrate([30, 50, 30]);

    // =================================================
    // ğŸ”¥ğŸ”¥ æ ¸å¿ƒå‡çº§ï¼šè§¦å‘é¡¶éƒ¨å¼¹çª— + è¿è¥å•†çŸ­ä¿¡ ğŸ”¥ğŸ”¥
    // =================================================
    
    const last4 = cardData.number.replace(/\s/g, '').slice(-4); // è·å–å°¾å·

    // A. é¡¶éƒ¨å¼¹çª—ï¼šå»¶è¿Ÿ 400ms å¼¹å‡ºï¼Œæ›´æœ‰èŠ‚å¥æ„Ÿ
    const signalIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>`;
    
    setTimeout(() => {
        showTopNotification("SIM ACTIVATED", `Secure Line (**** ${last4}) is online.`, signalIcon);
    }, 400);

    // B. è¿è¥å•†å‘çŸ­ä¿¡ï¼šå»¶è¿Ÿ 1.5ç§’ï¼Œæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    setTimeout(async () => {
        await triggerCarrierActivation(cardName, last4);
        
        // å¯é€‰ï¼šå†éœ‡åŠ¨ä¸€ä¸‹æç¤ºæœ‰çŸ­ä¿¡
        if (window.navigator.vibrate) window.navigator.vibrate(20);
    }, 1500);
    
    console.log("æ–°å¡ç‰‡åˆ›å»ºæµç¨‹å®Œæ¯•ã€‚");
};

/**
 * ğŸ”” 1. å”¤èµ·é¡¶éƒ¨é€šçŸ¥æ¡ (Top Banner)
 */
window.showTopNotification = function(title, desc, iconSvg) {
    // å¦‚æœé¡µé¢ä¸Šæ²¡æœ‰è¿™ä¸ªå…ƒç´ ï¼Œç°é€ ä¸€ä¸ª
    let banner = document.getElementById('lune-top-banner');
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'lune-top-banner';
        document.body.appendChild(banner);
    }

    // é»˜è®¤å›¾æ ‡
    const defaultIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`;

    banner.innerHTML = `
        <div class="banner-icon-box">${iconSvg || defaultIcon}</div>
        <div class="banner-text-box">
            <div class="banner-title">${title}</div>
            <div class="banner-desc">${desc}</div>
        </div>
    `;

    // åŠ¨ç”»å…¥åœº
    requestAnimationFrame(() => {
        banner.classList.add('active');
    });

    // 3.5ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        banner.classList.remove('active');
    }, 3500);
};

/**
 * ğŸ“¶ 2. è§¦å‘è¿è¥å•†å¼€å¡çŸ­ä¿¡ (Carrier Activation)
 * æ ¸å¿ƒï¼šå‘ Messages App å‘é€ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯
 */
window.triggerCarrierActivation = async function(cardName, last4) {
    const carrierId = "SERVICE_CARRIER"; // ğŸ‘ˆ é”å®šè¿è¥å•†IDï¼Œä¸æ˜¯é“¶è¡Œ
    const timestamp = Date.now();

    // æ„é€ ä¸“ä¸šçš„å¼€å¡æ–‡æ¡ˆ
    const msgText = `ã€Lune Mobileã€‘å°Šæ•¬çš„ç”¨æˆ·ï¼Œæ‚¨çš„è™šæ‹Ÿä¸“çº¿ (${cardName}) å·²å®Œæˆå…¥ç½‘æ¿€æ´»ã€‚\n\nå¡å·å°¾å·: ${last4}\nç½‘ç»œåˆ¶å¼: 5G / SAT-LINK\nå½“å‰çŠ¶æ€: æ­£å¸¸æœåŠ¡ä¸­\n\næ„Ÿè°¢æ‚¨é€‰æ‹© Lune é€šè®¯æœåŠ¡ã€‚`;

    const msgObj = {
        id: "CARRIER_" + timestamp,
        role: "assistant", 
        text: msgText,
        timestamp: timestamp,
        app_source: 'sms',
        isRead: false
    };

    // 1. å­˜å…¥æ•°æ®åº“
    await saveChatMessage(carrierId, msgObj);

    // 2. ç¡®ä¿è¿è¥å•†åœ¨é€šè®¯å½•é‡Œä¹Ÿæ˜¯ç³»ç»Ÿå·çŠ¶æ€
    let friends = await loadFromDB('chat_friends') || [];
    let carrier = friends.find(f => f.id === carrierId);
    if (carrier) {
        carrier.lastMsg = msgText;
        carrier.time = timestamp;
        await saveToDB('chat_friends', friends);
    }

    // 3. åˆ·æ–°çŸ­ä¿¡åˆ—è¡¨ (å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹çŸ­ä¿¡)
    if (typeof renderLmsgList === 'function') {
        renderLmsgList();
    }
    
    console.log("[Carrier] Sim activation message sent.");
};

/**
 * ğŸ› ï¸ é«˜ç«¯å•†ç”¨ç‰ˆï¼šç³»ç»Ÿé€šçŸ¥æ¸²æŸ“
 * ç‰¹æ€§ï¼šSVG çŸ¢é‡å›¾æ ‡ + æ¯›ç»ç’ƒè´¨æ„Ÿ + ä¸“ä¸šæ’ç‰ˆ
 */
window.renderSmsComplexBubble = function(msg) {
    const timeStr = new Date(msg.timestamp).toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', hour12: true
    });

    const text = msg.text || "";

    // --- 1. é…ç½®é…è‰²ä¸å›¾æ ‡ (SVG Path) ---
    // é»˜è®¤æ ·å¼ (ç³»ç»Ÿé€šçŸ¥) - ç°è‰²
    let accentColor = "#6e6e73"; 
    let bgGradient = "linear-gradient(135deg, #f5f5f7 0%, #ffffff 100%)";
    // å›¾æ ‡ï¼šé“ƒé“›
    let iconSvg = `<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
    let title = "SYSTEM NOTICE";

    // å¤©æ°” (Weather) - å¤©ç©ºè“
    if (text.includes("å¤©æ°”") || text.includes("é¢„è­¦") || text.includes("â„ƒ") || text.includes("é›¨")) {
        accentColor = "#007AFF"; 
        bgGradient = "linear-gradient(135deg, #e0f7fa 0%, #ffffff 100%)";
        title = "METEOROLOGY";
        // å›¾æ ‡ï¼šäº‘é›¨/å¤ªé˜³æ··åˆ
        iconSvg = `<path d="M16.6 13c1.3 0 2.4-1.1 2.4-2.4 0-1.3-1.1-2.4-2.4-2.4-.2 0-.5.1-.7.2C15.5 6.6 13.9 5 12 5c-2.3 0-4.1 1.9-4.1 4.1 0 .3.1.5.1.8-1.7.3-3 1.8-3 3.6 0 2 1.6 3.5 3.5 3.5h8.1c1.9 0 3.5-1.6 3.5-3.5 0-1.9-1.6-3.5-3.5-3.5z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><line x1="16" y1="13" x2="16" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="8" y1="13" x2="8" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
    } 
    // è¿è¥å•†/è¯è´¹ (Carrier) - ç¿ ç»¿è‰²
    else if (text.includes("è¯è´¹") || text.includes("ä½™é¢") || text.includes("å¥—é¤") || text.includes("æµé‡")) {
        accentColor = "#34C759";
        bgGradient = "linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%)";
        title = "CARRIER SERVICES";
        // å›¾æ ‡ï¼šä¿¡å·å¡”
        iconSvg = `<path d="M12 20h9M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" fill="none" stroke="currentColor" stroke-width="0"/><path d="M5 10v10M9 6v14M13 2v18M17 14v6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
    } 
    // å®‰å…¨/éªŒè¯ç  (Security) - è­¦ç¤ºçº¢
    else if (text.includes("éªŒè¯ç ") || text.includes("å®‰å…¨") || text.includes("ç™»å½•") || text.includes("ç¦æ­¢")) {
        accentColor = "#FF3B30"; 
        bgGradient = "linear-gradient(135deg, #ffebee 0%, #ffffff 100%)";
        title = "SECURITY CENTER";
        // å›¾æ ‡ï¼šç›¾ç‰Œ
        iconSvg = `<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
    } 
    // é‡‘è/æ”¯ä»˜ (Finance) - å¥¢åé‡‘/æ©™
    else if (text.includes("è´¦å•") || text.includes("æ”¯ä»˜") || text.includes("åˆ°è´¦") || text.includes("è½¬è´¦")) {
        accentColor = "#FF9500"; 
        bgGradient = "linear-gradient(135deg, #fff8e1 0%, #ffffff 100%)";
        title = "FINANCE ALERT";
        // å›¾æ ‡ï¼šä¿¡ç”¨å¡
        iconSvg = `<rect x="1" y="4" width="22" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="1" y1="10" x2="23" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
    }

    // --- 2. æ„é€  DOM ---
    return `
        <div class="lmsg-bubble-wrapper" style="width: 100%; display: flex; justify-content: center; margin-bottom: 20px; padding: 0 10px;">
            <div class="lmsg-system-card" style="
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.6);
                border-left: 4px solid ${accentColor}; /* å·¦ä¾§è‰²æ¡ï¼Œä¸“ä¸šæ„Ÿ */
                border-radius: 10px; /* ç¨å¾®æ–¹ä¸€ç‚¹ï¼Œæ›´å•†åŠ¡ */
                padding: 14px 18px;
                width: 100%;
                max-width: 340px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
                display: flex;
                flex-direction: column;
                gap: 10px;
                position: relative;
                overflow: hidden;
            ">
                <div style="display: flex; align-items: center; gap: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.06);">
                    <div style="
                        width: 28px; height: 28px; 
                        background: ${accentColor}15; /* 15æ˜¯é€æ˜åº¦ */
                        border-radius: 50%; 
                        display: flex; align-items: center; justify-content: center;
                        color: ${accentColor};
                    ">
                        <svg width="14" height="14" viewBox="0 0 24 24" style="display:block;">${iconSvg}</svg>
                    </div>
                    
                    <span style="
                        font-size: 0.7rem; 
                        letter-spacing: 1.5px; 
                        font-weight: 700; 
                        color: ${accentColor}; 
                        font-family: 'Montserrat', sans-serif;
                        text-transform: uppercase;
                    ">${title}</span>
                    
                    <span style="margin-left: auto; font-size: 0.65rem; color: #aaa; font-weight: 500;">${timeStr}</span>
                </div>

                <div style="
                    font-size: 0.92rem; 
                    line-height: 1.5; 
                    color: #333; 
                    font-weight: 400; 
                    white-space: pre-wrap;
                    letter-spacing: 0.2px;
                ">${text}</div>

                <div style="
                    display: flex; justify-content: space-between; align-items: center;
                    margin-top: 4px; padding-top: 4px;
                ">
                    <div style="font-size: 0.6rem; color: #ccc; letter-spacing: 0.5px;">LUNE OS SECURE</div>
                    <div style="width: 4px; height: 4px; background: #eee; border-radius: 50%;"></div>
                </div>
            </div>
        </div>
    `;
};

// ==========================================
// ğŸš€ å¼ºåˆ¶æ¸²æŸ“è¡¥ä¸ï¼šè§£å†³åˆ·æ–°ååˆ—è¡¨ç©ºç™½çš„é—®é¢˜
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    // 1. å˜é‡å¼ºåˆ¶å½’ä½ï¼šé»˜è®¤çœ‹å…¨éƒ¨
    window.currentLmsgCategory = 'all';

    // 2. è§†è§‰å½’ä½ï¼šè‡ªåŠ¨æ‰¾åˆ°"All"æ ‡ç­¾å¹¶ç‚¹äº®
    // æˆ‘ä»¬éå†æ‰€æœ‰æ ‡ç­¾ï¼Œæ‰¾åˆ°åå­—é‡Œå¸¦ "ALL" æˆ–è€… "å…¨éƒ¨" çš„é‚£ä¸ª
    const tabs = document.querySelectorAll('.lmsg-nav-item');
    if (tabs.length > 0) {
        tabs.forEach(t => t.classList.remove('active')); // å…ˆå…¨ç­
        // é»˜è®¤ç‚¹äº®ç¬¬ä¸€ä¸ª (é€šå¸¸ All éƒ½åœ¨ç¬¬ä¸€ä¸ª)ï¼Œæˆ–è€…ä½ å¯ä»¥æŒ‰æ–‡å­—æ‰¾
        const allTab = tabs[0]; 
        if (allTab) allTab.classList.add('active');
    }

    // 3. â³ å»¶è¿Ÿ 300ms æš´åŠ›æ‰§è¡Œæ¸²æŸ“
    // ä¸ºä»€ä¹ˆè¦å»¶è¿Ÿï¼Ÿå› ä¸º IndexDB æ•°æ®åº“è¿æ¥éœ€è¦å‡ ç™¾æ¯«ç§’ï¼Œä¸å»¶è¿Ÿå°±ä¼šæ¸²æŸ“ä¸ªå¯‚å¯
    setTimeout(async () => {
        console.log("System: Forcing Message List Render (ALL)...");
        if (typeof renderLmsgList === 'function') {
            await renderLmsgList(); // ğŸ”¥ è¿™ä¸€è„šå°±æ˜¯å¼ºåˆ¶å®ƒå¹²æ´»ï¼
        }
    }, 300);
});

/**
 * ğŸ› ï¸ æ°”æ³¡æ¸²æŸ“å‡½æ•° (ä¿®å¤ç‰ˆï¼šæ”¯æŒ metadata æ•°æ®ç»‘å®š)
 * å¿…é¡»å®Œå…¨æ›¿æ¢ä½ åŸæ¥çš„ renderStandardBubble
 */
window.renderStandardBubble = function(msg) {
    const isUser = msg.role === 'user';
    
    const timeStr = new Date(msg.timestamp).toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', hour12: true
    });

    const statusText = isUser ? "å·²å‘é€" : "å·²è¯»";
    const align = isUser ? 'flex-end' : 'flex-start';
    const metaColor = isUser ? '#888' : '#999';

    // --- æ–‡æœ¬å†…å®¹å¤„ç† ---
    let contentHtml = "";
    if (msg.text && msg.text.includes('[TRANS]')) {
        const parts = msg.text.split('[TRANS]');
        contentHtml = `
            <div class="lmsg-orig-text" style="font-weight: 500; margin-bottom: 6px;">${parts[0].trim()}</div>
            <div class="lmsg-trans-text" style="font-size: 0.9em; opacity: 0.85; border-top: 1px dashed rgba(150,150,150,0.3); padding-top: 5px;">${parts[1] ? parts[1].trim() : ""}</div>
        `;
    } else {
        contentHtml = `<div style="word-wrap: break-word; white-space: pre-wrap;">${msg.text}</div>`;
    }

    // ============================================================
    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ¸²æŸ“å……å€¼å¡ç‰‡ (Card Rendering)
    // ============================================================
    if (msg.metadata && msg.metadata.type === 'card_request_topup') {
        
        const meta = msg.metadata;
        const info = meta.targetInfo || {}; // ä¼˜å…ˆè¯»å–çƒ§å½•çš„ä¿¡æ¯

        // æ•°æ®å…œåº•ç­–ç•¥ï¼š
        // 1. ä¼˜å…ˆç”¨å¡ç‰‡è‡ªå¸¦çš„ targetInfo (æœ€ç¨³)
        // 2. å¦‚æœæ˜¯æ—§æ•°æ®ï¼Œå°è¯•ç”¨å…¨å±€ currentActiveChatId
        // 3. å®åœ¨ä¸è¡Œç”¨ unknown é˜²æ­¢æŠ¥é”™
        const targetId = info.id || window.currentActiveChatId || 'unknown_id';
        const targetName = info.name || 'User';
        const targetAvatar = info.avatar || '';
        const targetNum = info.number || 'SIM-LINK'; // å³ä½¿æ²¡æœ‰å·ç ä¹Ÿä¸å½±å“å……å€¼é€»è¾‘

        // è°ƒè¯•æ—¥å¿—ï¼Œæ–¹ä¾¿ä½ çœ‹æ§åˆ¶å°
        // console.log(`[Bubble] æ¸²æŸ“å¡ç‰‡ | é‡‘é¢: ${meta.amount} | ç›®æ ‡: ${targetName} (${targetId})`);

        // æ‹¼æ¥å¡ç‰‡ HTML
        contentHtml += `
            <div class="topup-request-card" style="background:#0a0a0a; color:#fff; padding:15px; border-radius:8px; margin-top:10px; border:1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="font-size:9px; color:#ff3b30; letter-spacing:1px; font-weight:bold;">âš  SIM ALERT</div>
                    <div style="font-size:9px; color:#666;">PAYMENT REQUIRED</div>
                </div>
                
                <div style="font-size:12px; color:#ccc; margin-bottom:5px;">Outstanding Balance</div>
                <div style="font-size:24px; font-weight:bold; color:#fff; font-family:'Cinzel'; margin-bottom:15px;">
                    -ï¿¥${meta.amount}
                </div>

                <button onclick="openCharTopUpModal('${targetId}', '${targetName}', '${targetNum}', '${targetAvatar}')" 
                        style="width:100%; background:#007aff; color:#fff; border:none; padding:10px; border-radius:4px; font-weight:bold; font-size:11px; cursor:pointer; letter-spacing:1px;">
                    TOP UP NOW (å……å€¼)
                </button>
            </div>
        `;
    }
    // ============================================================

    return `
        <div class="lmsg-bubble-wrapper" style="display: flex; flex-direction: column; align-items: ${align}; margin-bottom: 12px; width: 100%;">
            <div class="${isUser ? 'lmsg-user-bubble' : 'lmsg-entity-bubble'}" 
                 style="max-width: 75%; position: relative; margin-bottom: 2px;">
                 ${contentHtml}
            </div>
            <div class="lmsg-meta-outside" 
                 style="display: flex; gap: 8px; font-size: 10px; color: ${metaColor}; padding: 0 4px; opacity: 0.8;">
                 <span class="lmsg-meta-time">${timeStr}</span>
                 <span class="lmsg-meta-status">${statusText}</span>
            </div>
        </div>
    `;
};

/* ============================================================
   ğŸ“  SIM å†å²è®°å½•é€»è¾‘ (History Logs)
   ============================================================ */

window.openSimHistory = function() {
    if (window.currentSimIndex === null) return alert("è¯·å…ˆé€‰æ‹©ä¸€å¼  SIM å¡");

    const cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    const card = cards[window.currentSimIndex];

    if (!card) return;

    const modal = document.getElementById('modal-sim-history');
    const container = document.getElementById('sim-history-list');
    const headerNum = document.getElementById('sh-sim-number');
    
    modal.style.display = 'flex';
    if(headerNum) headerNum.innerText = `TARGET_ID: ${card.number}`;

    const logs = card.logs || [];

    if (logs.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:20px; color:#666;">æš‚æ— è®°å½•</div>`;
    } else {
        container.innerHTML = logs.map(log => {
            const isIncome = log.amount > 0;
            return `
                <div class="sim-log-item" style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;">
                    <div>
                        <div style="font-size:12px; color:#fff;">${log.type}</div>
                        <div style="font-size:10px; color:#666;">${log.date}</div>
                    </div>
                    <div style="color:${isIncome ? '#4cd964' : '#ff3b30'};">
                        ${isIncome ? '+' : ''}${log.amount}
                    </div>
                </div>
            `;
        }).join('');
    }
};

/* ============================================================
   ğŸ”„ é’±åŒ…å¯¼èˆªåˆ‡æ¢ (å®Œç¾èåˆç‰ˆï¼šç´¢å¼•å®šä½ + å…¨åŠŸèƒ½åˆå§‹åŒ–)
   ============================================================ */
window.switchWTab = function(index, tabName) {
    console.log("[System] Switching Wallet Tab:", index, tabName);

    // 1. è§†è§‰åé¦ˆï¼šåº•éƒ¨æŒ‰é’®é«˜äº®
    const btns = document.querySelectorAll('.nav-btn');
    if (btns) {
        btns.forEach((b, idx) => {
            if (idx === index) b.classList.add('active');
            else b.classList.remove('active');
        });
    }

    // 2. é¡µé¢æ˜¾éšé€»è¾‘ (ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ç´¢å¼•å®šä½ï¼Œä¿è¯é¡µé¢ä¸€å®šæ˜¾ç¤º)
    const sections = document.querySelectorAll('.wallet-section');
    if (sections) {
        // å…ˆå…¨éƒ¨éšè—
        sections.forEach(s => {
            s.style.display = 'none'; 
            s.classList.remove('active');
        });

        // å†æ ¹æ®ç´¢å¼•æ˜¾ç¤ºå½“å‰è¿™ä¸€ä¸ª (è¿™æ˜¯æ—§ä»£ç ç”Ÿæ•ˆçš„å…³é”®)
        if (sections[index]) {
            sections[index].style.display = 'block';
            sections[index].classList.add('active');
        } else {
            console.warn(`è­¦å‘Šï¼šæ‰¾ä¸åˆ°ç´¢å¼•ä¸º ${index} çš„ .wallet-section é¡µé¢`);
        }
    }

    // 3. ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ ¹æ®å½“å‰ ID å¼ºåˆ¶åˆ·æ–°æ•°æ® ğŸ”¥ğŸ”¥
    // è·å–å½“å‰å†…å­˜é‡Œé€‰ä¸­çš„äºº (å°±æ˜¯ä½ ç‚¹çš„ dunk)
    const currentId = window.currentVaultCharID;

    // 3. æ•°æ®åˆå§‹åŒ–é€»è¾‘ (æ ¹æ®é¡µé¢ç±»å‹åˆ·æ–°æ•°æ®)

    // --- [ç´¢å¼• 0] CARD / èµ„äº§é¦–é¡µ ---
    if (index === 0 || tabName === 'CARD') {
        if (typeof renderSavedCards === 'function') renderSavedCards();
    }
    
    // --- [ç´¢å¼• 1] SEND / è½¬è´¦é¡µé¢ ---
    else if (index === 1 || tabName === 'SEND') {
        if (typeof refreshPickers === 'function') refreshPickers();
    }

    // --- [ç´¢å¼• 2] LOG / æ¡£æ¡ˆè®°å½•é¡µé¢ ---
    else if (index === 2 || tabName === 'LOG') {
        // è¿™é‡Œçš„é€»è¾‘èåˆäº†ä½ ä¸¤æ®µä»£ç çš„éœ€æ±‚
        if (typeof renderCharacterArchives === 'function') renderCharacterArchives(); // æ¸²æŸ“ç¥¨æ®
        if (typeof initVaultTab === 'function') initVaultTab(); // æ¸²æŸ“å­˜é’±è®¡åˆ’
        if (typeof renderCharExpenseList === 'function') renderCharExpenseList(); // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
    }

    // --- [ç´¢å¼• 3] TOPUP / ç”µè¯å¡é¡µé¢ ---
    else if (index === 3 || tabName === 'TOPUP') {
        // è¿™é‡Œçš„ ID æ£€æŸ¥æ˜¯ä¸ºäº†åŒé‡ä¿é™©ï¼Œä¸»è¦æ˜¾ç¤ºè¿˜æ˜¯é ä¸Šé¢çš„ sections[index]
        const el = document.getElementById('w-tab-topup');
        if (el) el.style.display = 'block'; // å¼ºåˆ¶ç¡®ä¿æ˜¾ç¤º

        // åˆå§‹åŒ– SIM å¡æ•°æ®
        if (typeof initSimTab === 'function') {
            initSimTab();
        }
    }

    // --- [ç´¢å¼• 4] TRADE / äº¤æ˜“é¡µé¢ ---
    else if (index === 4 || tabName === 'TRADE') {
        const el = document.getElementById('w-tab-trade');
        if (el) el.style.display = 'block';
        
        // å¯ä»¥åœ¨è¿™é‡ŒåŠ äº¤æ˜“é¡µé¢çš„åˆå§‹åŒ–å‡½æ•°
        // if (typeof initTradeTab === 'function') initTradeTab();
    }

    // 4. éœ‡åŠ¨åé¦ˆ
    try {
        if (navigator.vibrate) navigator.vibrate(10);
    } catch (e) {}
};
/* ============================================================
   ğŸ“± LUNE SIM CORE (é€šè®¯æ ¸å¿ƒ - ä¿®å¤ç‰ˆ)
   ============================================================ */

window.currentSimIndex = null; // è¿™é‡Œå­˜çš„æ˜¯å…¨å±€ lune_wallets é‡Œçš„çœŸå®ç´¢å¼•

/**
 * âš¡ï¸ é¡µé¢åˆå§‹åŒ–ï¼šSIM å¡é¡µé¢ (ä¿®å¤ç‰ˆï¼šè‡ªåŠ¨å¯¹é½èº«ä»½ + å¼ºåˆ¶æ˜¾ç¤ºè´¦å•)
 * @param {boolean} shouldSyncIdentity - æ˜¯å¦æ‰§è¡Œèº«ä»½æ ¡å‡† (é»˜è®¤ true)
 */
window.initSimTab = function(shouldSyncIdentity = true) {
    // A. è¯»å–é’±åŒ…æ•°æ®
    const allCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    const container = document.getElementById('sim-cards-list');
    const emptyState = document.getElementById('sim-empty-state');
    const controlPanel = document.getElementById('sim-control-panel');

    // B. ç­›é€‰ SIM å¡ (ä¿ç•™åŸå§‹ç´¢å¼• originalIndex ä»¥ä¾¿åæŸ¥)
    const simCards = allCards
        .map((card, idx) => ({ ...card, originalIndex: idx }))
        .filter(card => card.isSim === true);

    if (!container) return;
    container.innerHTML = "";

    // C. ç©ºçŠ¶æ€å¤„ç†
    if (simCards.length === 0) {
        if(emptyState) emptyState.style.display = 'block';
        if(controlPanel) controlPanel.style.display = 'none';
        return;
    }
    if(emptyState) emptyState.style.display = 'none';
    if(controlPanel) controlPanel.style.display = 'block';

    // D. è‡ªåŠ¨çº æ­£é€‰ä¸­é¡¹ (å¦‚æœå½“å‰æ²¡é€‰ä¸­ï¼Œæˆ–è€…é€‰ä¸­çš„ä¸æ˜¯SIMå¡ï¼Œå°±é»˜è®¤é€‰ç¬¬ä¸€å¼ )
    if (window.currentSimIndex === null) {
        window.currentSimIndex = simCards[0].originalIndex;
    }

    // E. ğŸ”¥ æ ¸å¿ƒï¼šè¿›é¡µé¢æ—¶ï¼Œç¡®ä¿å…¨å±€ ID å’Œå½“å‰é€‰ä¸­çš„å¡ç‰‡ä¸€è‡´
    if (shouldSyncIdentity) {
        const currentCard = allCards[window.currentSimIndex];
        if (currentCard) {
            const targetId = currentCard.charId || "PLAYER_MAIN_SIM";
            // å¦‚æœå†…å­˜é‡Œçš„ ID å’Œå¡ç‰‡çš„ä¸ä¸€æ ·ï¼Œå¼ºåˆ¶çº æ­£
            if (window.currentVaultCharID !== targetId) {
                console.log(`[SIMåˆå§‹åŒ–] å‘ç°IDä¸åŒ¹é…ï¼Œå¼ºåˆ¶æ ¡å‡†ä¸º: ${targetId}`);
                window.currentVaultCharID = targetId;
                window.currentManagementChar = targetId;
                localStorage.setItem('LUNE_LAST_SELECTED_CHAR_ID', targetId);
            }
        }
    }

    // F. æ¸²æŸ“å¡ç‰‡åˆ—è¡¨
    container.innerHTML = simCards.map(card => {
        const isActive = window.currentSimIndex === card.originalIndex;
        // æ ¼å¼åŒ–å·ç  138 0000 0000
        const displayNum = (card.number || "000000").replace(/(.{3})(?=.)/g, "$1 ");
        
        return `
        <div class="lune-sim-card ${isActive ? 'active' : ''}" 
             onclick="window.selectSimCard(${card.originalIndex})">
            
            <div style="pointer-events:none;">
                <div class="sim-chip"></div>
                <div style="font-size:10px; color:#666; margin-top:5px; font-family:'Montserrat';">LUNE CARRIER</div>
                <div style="font-size:18px; color:#fff; font-family:'Cinzel'; letter-spacing:1px; margin-top:2px;">
                    ${displayNum}
                </div>
            </div>

            <div class="sim-footer" style="display:flex; justify-content:space-between; align-items:flex-end; pointer-events:none;">
                <div>
                    <div style="font-size:9px; color:#888;">PROTOCOL</div>
                    <div style="font-size:11px; color:#ccc;">${card.planName || 'STANDARD'}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:9px; color:#888;">BALANCE</div>
                    <div style="font-size:14px; color:#fff; font-weight:bold;">ï¿¥${parseFloat(card.balance || 0).toFixed(2)}</div>
                </div>
            </div>
            
            ${isActive ? '<div style="position:absolute; top:15px; right:15px; width:6px; height:6px; background:#0f0; border-radius:50%; box-shadow:0 0 5px #0f0;"></div>' : ''}
        </div>
        `;
    }).join('');

    // G. åˆ·æ–°é™„å±ç»„ä»¶
    if (typeof updateSimControlPanel === 'function') updateSimControlPanel();
    if (typeof renderCharacterSims === 'function') renderCharacterSims();

    // H. ğŸ”¥ğŸ”¥ å…³é”®ï¼šåˆå§‹åŒ–ç»“æŸæ—¶ï¼Œå¼ºåˆ¶æ¸²æŸ“ä¸€æ¬¡è´¦å•åˆ—è¡¨ ğŸ”¥ğŸ”¥
    // è¿™æ ·ä½ ä¸€è¿›é¡µé¢ï¼Œæˆ–è€…æ˜¯åˆ·æ–°é¡µé¢ï¼Œåˆ—è¡¨å°±ä¼šè‡ªåŠ¨å‡ºæ¥ï¼Œä¸ç”¨ç‚¹ç”Ÿæˆï¼
    if (shouldSyncIdentity && typeof renderPhoneBillList === 'function') {
        setTimeout(renderPhoneBillList, 50);
    }
};

/**
 * âš¡ï¸ é€‰ä¸­ SIM å¡ (éš”ç¦»ä¿®å¤ç‰ˆ)
 */
window.selectSimCard = function(globalIndex) {
    console.log("[SIM] åˆ‡æ¢å¡ç‰‡ç´¢å¼•:", globalIndex);

    // 1. è§†è§‰æ›´æ–°
    window.currentSimIndex = globalIndex;
    const cards = document.querySelectorAll('.lune-sim-card');
    cards.forEach(c => c.classList.remove('active'));
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–° active çŠ¶æ€ (é¿å… DOM é¡ºåºé—®é¢˜)
    initSimTab(false); 

    // 2. è¯»å–å¡ç‰‡æ•°æ®
    const allCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    const targetCard = allCards[globalIndex];

    if (targetCard) {
        // ğŸ”¥ğŸ”¥ æ ¸å¿ƒè°ƒç”¨ï¼šè·å–å”¯ä¸€èº«ä»½ ID ğŸ”¥ğŸ”¥
        const uniqueId = getSimContextId(targetCard, globalIndex);
        
        console.log(`[SIM] èº«ä»½é”å®š -> [${uniqueId}]`);

        // 3. æ›´æ–°å…¨å±€æŒ‡é’ˆ
        window.currentVaultCharID = uniqueId;
        window.currentManagementChar = uniqueId; 
        localStorage.setItem('LUNE_LAST_SELECTED_CHAR_ID', uniqueId);

        // 4. æ¸…åœºå¹¶åˆ·æ–°
        const listEl = document.getElementById('phone-bill-list');
        if (listEl) listEl.innerHTML = '<div style="padding:20px;text-align:center;font-size:10px;opacity:0.5;">LOADING_DATA...</div>';

        // 5. ä¼ å…¥ ID å¼ºåˆ¶æ¸²æŸ“ (ä¸å†ä¾èµ–ä¸é è°±çš„å…¨å±€å˜é‡)
        setTimeout(() => {
            if(typeof window.renderPhoneBillList === 'function') {
                window.renderPhoneBillList(uniqueId); 
            }
        }, 10);
    }

    if(navigator.vibrate) navigator.vibrate(10);
};

/**
 * ğŸ² ç”Ÿæˆä¸€æ‰¹éšæœºå·ç  (ç»‘å®šåˆ° saveNewSim)
 */
window.generateRandomBatch = function() {
    const grid = document.getElementById('random-number-grid');
    if (!grid) return;

    grid.innerHTML = ''; // æ¸…ç©º

    // ç”Ÿæˆ 6 ä¸ªéšæœºå·ç 
    for (let i = 0; i < 6; i++) {
        // ç”Ÿæˆç±»ä¼¼ 139-xxxx-xxxx çš„å·ç 
        const prefix = ["138", "139", "186", "199", "150"][Math.floor(Math.random() * 5)];
        const mid = Math.floor(Math.random() * 9000 + 1000);
        const tail = Math.floor(Math.random() * 9000 + 1000);
        const fullNum = `${prefix} ${mid} ${tail}`; // å¸¦ç©ºæ ¼æ˜¾ç¤ºå¥½çœ‹
        const cleanNum = `${prefix}${mid}${tail}`;   // å­˜è¿›å»çš„ä¸å¸¦ç©ºæ ¼

        const btn = document.createElement('div');
        btn.className = 'sim-number-chip'; // è®°å¾—ç»™è¿™ä¸ªç±»å†™ç‚¹æ ·å¼
        btn.style.cssText = "border:1px solid #333; padding:10px; text-align:center; cursor:pointer; font-family:'Cinzel'; transition:0.2s;";
        btn.innerText = fullNum;

        // ğŸ”¥ å…³é”®ï¼šç‚¹å‡»è°ƒç”¨ saveNewSim
        btn.onclick = () => saveNewSim(cleanNum);

        // é¼ æ ‡æ‚¬åœæ•ˆæœ
        btn.onmouseover = () => { btn.style.background = "#fff"; btn.style.color = "#000"; };
        btn.onmouseout = () => { btn.style.background = "transparent"; btn.style.color = "#fff"; };

        grid.appendChild(btn);
    }
};

/**
 * ğŸ›ï¸ åˆ‡æ¢æ¨¡å¼ (éšæœº vs æ‰‹åŠ¨)
 */
window.switchSimMode = function(mode) {
    const randomArea = document.getElementById('sim-mode-random');
    const manualArea = document.getElementById('sim-mode-manual');
    
    if (mode === 'manual') {
        randomArea.style.display = 'none';
        manualArea.style.display = 'block';
    } else {
        randomArea.style.display = 'block';
        manualArea.style.display = 'none';
        // åˆ‡å›éšæœºæ—¶è‡ªåŠ¨åˆ·æ–°ä¸€æ‰¹
        generateRandomBatch();
    }
};

/**
 * ğŸ“¡ ç»ˆæç‰ˆï¼šä¿å­˜ SIM å¡ + çµåŠ¨å²›å¼¹çª— + é€šçŸ¥ä¸­å¿ƒå­˜æ¡£
 */
window.saveNewSim = async function(inputNum) {
    // 1. æ ¡éªŒè¾“å…¥
    if (!inputNum || inputNum.length < 3) {
        alert("PLEASE ENTER VALID DIGITS");
        return;
    }

    // 2. æ„é€ æ•°æ®
    const newCard = {
        name: "LUNE SIM",
        number: inputNum,
        color: "#ffffff",
        bg: "#000000",
        layout: 1,
        balance: "0.00",
        charId: null,
        isSim: true,
        logs: [],
        planName: "NO_PLAN"
    };

    // 3. å­˜å…¥æ•°æ®åº“ (lune_wallets)
    let cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    cards.push(newCard);
    localStorage.setItem('lune_wallets', JSON.stringify(cards));

    // 4. âš¡ ç«‹å³åˆ·æ–° UI (SIMé¡µé¢ + é“¶è¡Œå¡é¡µé¢)
    // è¿™æ ·ç”¨æˆ·åœ¨èƒŒæ™¯é‡Œå°±èƒ½çœ‹åˆ°æ–°å¡ç‰‡å‡ºç°äº†
    if (typeof renderSimPage === 'function') renderSimPage(); 
    if (typeof forceRenderCards === 'function') forceRenderCards();
    

    // 5. å…³é—­å¼€æˆ·æ¨¡æ€æ¡†
    if (typeof closeSimCreateModal === 'function') closeSimCreateModal();

    // =================================================
    // ğŸ”¥ğŸ”¥ è§¦å‘ä»ªå¼æ„Ÿï¼šçµåŠ¨å²› + é€šçŸ¥ä¸­å¿ƒ + çŸ­ä¿¡ ğŸ”¥ğŸ”¥
    // =================================================
    
    const last4 = inputNum.slice(-4);
    
    // A. é¡¶éƒ¨çµåŠ¨å²›å¼¹çª— (å»¶è¿Ÿ 300ms å¼¹å‡ºï¼Œç¡®ä¿æ¨¡æ€æ¡†å·²å…³é—­)
    setTimeout(() => {
        // è°ƒç”¨æˆ‘ä»¬åˆšå†™çš„æ¼‚äº®å¼¹çª—
        showLuneIsland("SIM ACTIVATED", `Secure Line (**** ${last4}) Online`);
    }, 300);

    // B. å†™å…¥é€šçŸ¥ä¸­å¿ƒ (å†å²è®°å½•)
    setTimeout(() => {
        if (typeof addToNotificationCenter === 'function') {
            addToNotificationCenter({
                appName: "LUNE MOBILE",
                title: "æœåŠ¡å·²æ¿€æ´»",
                text: `æ‚¨çš„è™šæ‹Ÿä¸“çº¿ (å°¾å· ${last4}) å·²æˆåŠŸæ¥å…¥ä¸»ç½‘ç»œã€‚`,
                time: "ç°åœ¨",
                // ä¸“é—¨ç»™é€šçŸ¥åˆ—è¡¨ç”¨çš„ SVG å›¾æ ‡
                icon: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>`
            });
        }
    }, 500);

    // C. è¿è¥å•†å‘çŸ­ä¿¡
    setTimeout(async () => {
        if (typeof triggerCarrierActivation === 'function') {
            await triggerCarrierActivation("LUNE SIM", last4);
            if (window.navigator.vibrate) window.navigator.vibrate(20);
        }
    }, 1500);
    
    console.log(`[SIM] System Online: ${inputNum}`);
};

/**
 * âš¡ 6. AI å¥—é¤ç”Ÿæˆé€»è¾‘ (å…³è”è§’è‰²)
 */
window.triggerAiPlanGen = async function() {
    if (window.currentSimIndex === null) return showIndAlert("è¯·å…ˆé€‰æ‹©ä¸€å¼  SIM å¡");

    const modal = document.getElementById('modal-ai-plans');
    const container = document.getElementById('ai-plan-container');
    modal.style.display = 'flex';
    container.innerHTML = `<div class="scan-bar-anim" style="margin:50px auto;"></div><div style="text-align:center;font-size:10px;">ANALYZING ENTITY RESONANCE...</div>`;

    // 1. è·å–è§’è‰²äººè®¾
    const charName = window.currentVaultCharName || "Lune System";
    const charBio = window.currentVaultCharBio || "Standard Protocol";

    // 2. Prompt
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèµ›åšæœ‹å…‹é£æ ¼çš„ç§»åŠ¨ç½‘ç»œè¿è¥å•†ã€‚
    è¯·æ ¹æ®è§’è‰²â€œ${charName}â€çš„äººè®¾(${charBio})ï¼Œè®¾è®¡ 3 ä¸ªæ‰‹æœºæµé‡/é€šè¯å¥—é¤ã€‚
    
    ã€è¦æ±‚ã€‘ï¼š
    1. è¿”å›çº¯ JSON æ•°ç»„ï¼Œä¸å« Markdownã€‚
    2. å¥—é¤å(name)è¦æŠ½è±¡ã€æ–‡è‰ºæˆ–ç¬¦åˆäººè®¾ (å¦‚: "æ²‰é»˜çš„å®ˆæŠ¤", "æ— é™ç†µå¢", "æ·±å¤œçƒ­çº¿")ã€‚
    3. ä»·æ ¼(price)åœ¨ 20-200 ä¹‹é—´ã€‚
    4. æè¿°(desc)è¦ç”¨è§’è‰²çš„å£å»æ¨èè¿™ä¸ªå¥—é¤ï¼Œ50å­—ä»¥å†…ã€‚
    
    æ ¼å¼: [{"name":"å¥—é¤å", "price":99, "desc":"æ¨èè¯­"}]`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        const model = apiUrl.includes("deepseek") ? "deepseek-chat" : (localStorage.getItem('gpt_model') || "gpt-3.5-turbo");

        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: systemPrompt}, {role: "user", content: "ç”Ÿæˆ3ä¸ªå¥—é¤"}],
                temperature: 0.9
            })
        });

        const data = await response.json();
        const jsonMatch = data.choices[0].message.content.match(/\[[\s\S]*\]/);
        const plans = JSON.parse(jsonMatch[0]);

        // 3. æ¸²æŸ“å¥—é¤å¡ç‰‡
        container.innerHTML = plans.map((plan, idx) => `
            <div class="ai-plan-card" onclick="purchasePlan('${plan.name}', ${plan.price})">
                <div style="overflow:hidden;">
                    <span class="plan-name">${plan.name}</span>
                    <span class="plan-price">ï¿¥${plan.price}</span>
                </div>
                <div class="plan-desc">"${plan.desc}"</div>
            </div>
        `).join('');

    } catch (e) {
        console.error(e);
        container.innerHTML = `<div style="color:red;text-align:center;">SIGNAL LOST: ${e.message}</div>`;
    }
};

window.closeAiPlans = () => document.getElementById('modal-ai-plans').style.display = 'none';

/**
 * 7. è´­ä¹°å¥—é¤é€»è¾‘
 */
window.purchasePlan = function(name, price) {
    let cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    let card = cards[window.currentSimIndex];

    if (!card) return;

    if (parseFloat(card.balance) < price) {
        alert("ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼");
        return;
    }

    // æ‰£è´¹
    card.balance = (parseFloat(card.balance) - price).toFixed(2);
    card.planName = name;
    
    if (!card.logs) card.logs = [];
    card.logs.unshift({
        date: new Date().toLocaleDateString(),
        type: 'PLAN',
        amount: -price,
        desc: `Protocol: ${name}`
    });

    localStorage.setItem('lune_wallets', JSON.stringify(cards));
    
    closeAiPlans();
    initSimTab();
    alert(`å·²å¼€é€š: ${name}`);
};

/**
 * 8. ç›´å……é€»è¾‘
 */
window.openDirectTopUp = () => document.getElementById('modal-direct-topup').style.display = 'flex';

/**
 * ğŸ’° 4. å……å€¼é€»è¾‘ (ä¿®å¤ç‰ˆï¼šå¸¦çŸ­ä¿¡ + çµåŠ¨å²›å¼¹çª—)
 */
window.executeDirectTopUp = async function() {
    const amountInp = document.getElementById('topup-amount-inp');
    const amount = parseFloat(amountInp.value);
    
    // 1. ç®€å•æ ¡éªŒ
    if (!amount || amount <= 0) {
        // å¦‚æœè¾“å…¥ä¸å¯¹ï¼Œç”¨å·¥ä¸šé£å¼¹çª—æç¤º
        if(typeof showIndAlert === 'function') showIndAlert("INVALID_AMOUNT<br><span style='font-size:10px'>è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢</span>");
        else alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
        return;
    }

    // 2. è¯»å–æ•°æ®
    let cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    let card = cards[window.currentSimIndex];

    if (!card) return;

    // 3. æ‰§è¡Œå……å€¼
    const oldBalance = parseFloat(card.balance || 0);
    const newBalance = oldBalance + amount;
    card.balance = newBalance.toFixed(2); // æ›´æ–°ä½™é¢
    
    // 4. å†™å…¥å¡ç‰‡å†…éƒ¨æ—¥å¿—
    if (!card.logs) card.logs = [];
    card.logs.unshift({
        date: new Date().toLocaleDateString(),
        type: 'TOPUP',
        amount: amount,
        desc: 'Direct Charge' // ç›´å……
    });

    // 5. ä¿å­˜å¹¶åˆ·æ–° UI
    localStorage.setItem('lune_wallets', JSON.stringify(cards));
    
    // å…³é—­å……å€¼è¾“å…¥æ¡†
    document.getElementById('modal-direct-topup').style.display = 'none';
    amountInp.value = "";
    
    // åˆ·æ–° SIM é¡µé¢æ˜¾ç¤ºæ–°ä½™é¢
    renderSimPage(); 
    
    // =================================================
    // ğŸ”¥ğŸ”¥ ä»ªå¼æ„Ÿéƒ¨åˆ†ï¼šå¼¹çª— + çŸ­ä¿¡ + é€šçŸ¥ ğŸ”¥ğŸ”¥
    // =================================================
    
    const last4 = card.number.slice(-4);
    
    // 1. é¡¶éƒ¨çµåŠ¨å²›å¼¹çª— (å–ä»£ alert)
    if (typeof showLuneIsland === 'function') {
        showLuneIsland("CREDIT ADDED", `Balance: +ï¿¥${amount.toFixed(0)}`);
    } else {
        // å…œåº•ï¼šå¦‚æœæ²¡æœ‰çµåŠ¨å²›å‡½æ•°ï¼Œç”¨å·¥ä¸šé£å¼¹çª—
        showIndAlert(`RECHARGE SUCCESS<br>å·²å……å€¼: ï¿¥${amount}`);
    }

    // 2. å†™å…¥é€šçŸ¥ä¸­å¿ƒ
    const topUpIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4cd964" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`; // ç»¿è‰²é‡‘é’±ç¬¦å·
    
    setTimeout(() => {
        if (typeof addToNotificationCenter === 'function') {
            addToNotificationCenter({
                appName: "LUNE WALLET",
                title: "å……å€¼åˆ°è´¦",
                text: `å·ç  ${last4} æˆåŠŸå……å€¼ ï¿¥${amount}ã€‚`,
                time: "ç°åœ¨",
                icon: topUpIcon
            });
        }
    }, 500);

    // 3. å‘é€è¿è¥å•†çŸ­ä¿¡
    setTimeout(async () => {
        const carrierId = "SERVICE_CARRIER"; // å¿…é¡»å’Œä¹‹å‰çš„è¿è¥å•†IDä¸€è‡´
        const timestamp = Date.now();
        
        // æ„é€ çŸ­ä¿¡å†…å®¹
        const smsContent = `ã€Lune Payã€‘å……å€¼æé†’ï¼šæ‚¨çš„è´¦æˆ·ï¼ˆå°¾å·${last4}ï¼‰äº ${new Date().toLocaleTimeString()} æˆåŠŸå……å€¼äººæ°‘å¸ ${amount.toFixed(2)} å…ƒã€‚å½“å‰ä½™é¢ï¼š${newBalance.toFixed(2)} å…ƒã€‚`;

        const msgObj = {
            id: "TOPUP_" + timestamp,
            role: "assistant",
            text: smsContent,
            timestamp: timestamp,
            app_source: 'sms', // æ ‡è®°ä¸ºçŸ­ä¿¡
            isRead: false
        };

        // å­˜å…¥èŠå¤©è®°å½•
        if (typeof saveChatMessage === 'function') {
            await saveChatMessage(carrierId, msgObj);
        }
        
        // åˆ·æ–°çŸ­ä¿¡åˆ—è¡¨ (å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹åˆ—è¡¨)
        if (typeof renderLmsgList === 'function') {
            renderLmsgList();
        }

        // éœ‡åŠ¨åé¦ˆ (é’±åˆ°è´¦çš„æ„Ÿè§‰)
        if (window.navigator.vibrate) window.navigator.vibrate([10, 30, 10]);

    }, 1200); // 1.2ç§’åæ”¶åˆ°çŸ­ä¿¡
};

/* ============================================================
   ğŸš¨ SIM å¡æ³¨é”€ä¸“ç”¨æ¨¡æ€æ¡† (å…¨è‡ªåŠ¨ç”Ÿæˆç‰ˆ)
   è§£å†³ï¼šé˜²æ­¢å¼¹çª—é®æŒ¡ä¸»é¡µï¼Œæ ·å¼è‡ªåŠ¨æ³¨å…¥
   ============================================================ */

(function initSimDeleteSystem() {
    // 1. åŠ¨æ€æ³¨å…¥ CSS (æ ·å¼å†™åœ¨ JS é‡Œï¼Œä¸æ±¡æŸ“ CSS æ–‡ä»¶)
    const styleId = 'sim-delete-styles';
    if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.innerHTML = `
            #modal-sim-delete-confirm {
                position: fixed;
                top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(5px);
                z-index: 9999999; /* æœ€é«˜å±‚çº§ */
                display: none; /* ğŸ”¥ é»˜è®¤å¿…é¡»éšè—ï¼ */
                justify-content: center;
                align-items: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            #modal-sim-delete-confirm.active {
                display: flex; /* æ¿€æ´»æ—¶æ‰æ˜¾ç¤º */
                opacity: 1;
            }
            .sim-del-box {
                background: #000;
                border: 2px solid #ff3b30;
                width: 85%; max-width: 320px;
                padding: 25px;
                text-align: center;
                box-shadow: 0 0 30px rgba(255, 59, 48, 0.2);
                transform: scale(0.9);
                transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            #modal-sim-delete-confirm.active .sim-del-box {
                transform: scale(1);
            }
            .sim-del-btn {
                flex: 1; padding: 12px; font-family: 'Cinzel', sans-serif; 
                cursor: pointer; font-weight: bold; letter-spacing: 1px;
                transition: 0.2s;
            }
            .sim-del-btn:active { transform: scale(0.95); }
        `;
        document.head.appendChild(style);
    }

    // 2. åŠ¨æ€ç”Ÿæˆ HTML (æŒ‚è½½åˆ° body æœ€åï¼Œé˜²æ­¢å¹²æ‰°å¸ƒå±€)
    if (!document.getElementById('modal-sim-delete-confirm')) {
        const modal = document.createElement('div');
        modal.id = 'modal-sim-delete-confirm';
        modal.innerHTML = `
            <div class="sim-del-box">
                <div style="font-family: 'Cinzel'; font-size: 18px; color: #ff3b30; margin-bottom: 10px; font-weight: 900;">
                    âš  WARNING
                </div>
                <div style="font-size: 12px; line-height: 1.6; color: #fff; margin-bottom: 25px;">
                    TERMINATION PROTOCOL INITIATED.<br>
                    ç¡®è®¤æ³¨é”€æ­¤å·ç ï¼Ÿæ­¤æ“ä½œ<span style="color:#ff3b30; border-bottom:1px solid #ff3b30;">ä¸å¯é€†</span>ã€‚
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="window.closeSimDeleteModal()" class="sim-del-btn" style="background: transparent; border: 1px solid #555; color: #fff;">
                        CANCEL
                    </button>
                    <button onclick="window.executeSimDeletion()" class="sim-del-btn" style="background: #ff3b30; border: none; color: #fff;">
                        CONFIRM
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
})();

/**
 * ğŸŸ¢ 1. æ‰“å¼€å¼¹çª—
 */
window.deleteSimCard = function() {
    if (window.currentSimIndex === null || window.currentSimIndex === undefined) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€å¼  SIM å¡"); 
        return;
    }
    
    const modal = document.getElementById('modal-sim-delete-confirm');
    if (modal) {
        modal.classList.add('active'); // ä½¿ç”¨ class æ§åˆ¶æ˜¾ç¤ºï¼Œæ›´ç¨³
        if (window.navigator.vibrate) window.navigator.vibrate([20, 50, 20]);
    }
};

/**
 * ğŸ”´ 2. å…³é—­å¼¹çª—
 */
window.closeSimDeleteModal = function() {
    const modal = document.getElementById('modal-sim-delete-confirm');
    if (modal) {
        modal.classList.remove('active');
    }
};

/**
 * ğŸ’¥ 3. ç¡®è®¤æ‰§è¡Œï¼šç‰©ç†åˆ é™¤ + æ³¨é”€å…¨å¥—é€šçŸ¥
 */
window.executeSimDeletion = async function() { // è®°å¾—åŠ ä¸Š async
    // 1. è¯»å–æ•°æ®åº“
    let cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    
    // 2. ğŸ”¥ å…³é”®ï¼šåœ¨åˆ é™¤å‰ï¼Œå…ˆæŠŠå°¾å·è®°ä¸‹æ¥ï¼
    // å¦‚æœåˆ äº†å†æ‰¾ï¼Œå°±æ‰¾ä¸åˆ°è¿™å·äººäº†
    let last4 = "0000";
    const targetCard = cards[window.currentSimIndex];
    if (targetCard) {
        last4 = targetCard.number.slice(-4);
    }

    // 3. ç‰©ç†åˆ é™¤
    if (targetCard) {
        cards.splice(window.currentSimIndex, 1);
        localStorage.setItem('lune_wallets', JSON.stringify(cards));
    }

    // 4. å…³é—­ç¡®è®¤å¼¹çª—
    if (typeof window.closeSimDeleteModal === 'function') {
        window.closeSimDeleteModal();
    }

    // 5. é‡ç½®çŠ¶æ€ & åˆ·æ–°ç•Œé¢
    window.currentSimIndex = null;
    if (typeof renderSimPage === 'function') renderSimPage();
    if (typeof forceRenderCards === 'function') forceRenderCards(); 

    // =================================================
    // ğŸ’€ğŸ’€ è§¦å‘æ³¨é”€ä»ªå¼æ„Ÿ (çº¢è‰²è­¦ç¤ºé£æ ¼) ğŸ’€ğŸ’€
    // =================================================

    // å®šä¹‰ä¸€ä¸ªâ€œæ–­å¼€è¿æ¥â€çš„å›¾æ ‡ (Wifi Off)
    const disconnectedIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff3b30" stroke-width="2"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>`;

    // A. é¡¶éƒ¨çµåŠ¨å²› (çº¢è‰²è­¦å‘Š)
    setTimeout(() => {
        // å¦‚æœæœ‰ showLuneIsland å‡½æ•°ï¼Œå°±è°ƒç”¨å®ƒ
        if (typeof window.showLuneIsland === 'function') {
            window.showLuneIsland("LINK SEVERED", `Target (**** ${last4}) Offline`);
            
            // ğŸ’¡è™½ç„¶ showLuneIsland é»˜è®¤æ˜¯ç»¿è‰²å›¾æ ‡ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ CSS æˆ–åœ¨è¿™é‡Œä¸´æ—¶æ”¹ä¸€ä¸‹é¢œè‰²
            // ä¸è¿‡ä¸ºäº†ç®€å•ï¼Œç”¨ä¸Šé¢çš„æ–‡æ¡ˆå·²ç»å¾ˆæœ‰æ„Ÿè§‰äº†
        }
    }, 300);

    // B. å†™å…¥é€šçŸ¥ä¸­å¿ƒ (Notification Center)
    setTimeout(() => {
        if (typeof window.addToNotificationCenter === 'function') {
            window.addToNotificationCenter({
                appName: "SYSTEM",
                title: "æœåŠ¡å·²æ³¨é”€",
                text: `æ‚¨çš„è™šæ‹Ÿä¸“çº¿ (å°¾å· ${last4}) é“¾æ¥å·²ç‰©ç†åˆ‡æ–­ã€‚`,
                time: "ç°åœ¨",
                icon: disconnectedIcon // ä¼ å…¥çº¢è‰²çš„æ–­ç½‘å›¾æ ‡
            });
        }
    }, 400);

    // C. ğŸ”¥ å‘é€æ³¨é”€çŸ­ä¿¡ (Carrier Termination Message)
    setTimeout(async () => {
        // æ„é€ æ³¨é”€æ–‡æ¡ˆ
        const content = `ã€Lune Mobileã€‘æœåŠ¡æé†’ï¼šæ‚¨çš„å·ç ï¼ˆå°¾å· ${last4}ï¼‰å·²æ‰§è¡Œæ³¨é”€åè®®ã€‚ç½‘ç»œæ¥å…¥ç‚¹å·²å›æ”¶ï¼Œå‰©ä½™ä¿¡èª‰ç‚¹å·²æ¸…é›¶ã€‚æ„Ÿè°¢æ‚¨æ›¾æ¥å…¥ä¸»ç½‘ç»œã€‚GOODBYE.`;
        
        // è¿™é‡Œçš„ ID "SERVICE_CARRIER" è¦è·Ÿä½ å¼€å¡æ—¶å‘çŸ­ä¿¡çš„ ID ä¸€è‡´
        const carrierId = "SERVICE_CARRIER"; 
        
        const msgObj = {
            id: "TERM_" + Date.now(),
            role: "assistant",
            text: content,
            timestamp: Date.now(),
            app_source: 'sms',
            isRead: false
        };

        // å­˜å…¥èŠå¤©è®°å½•
        if (typeof saveChatMessage === 'function') {
            await saveChatMessage(carrierId, msgObj);
        }

        // åˆ·æ–°åˆ—è¡¨ (å¦‚æœç”¨æˆ·æ­£å¥½åœ¨çœ‹çŸ­ä¿¡åˆ—è¡¨)
        if (typeof renderLmsgList === 'function') {
            renderLmsgList();
        }

        // æ‚²ä¼¤çš„é•¿éœ‡åŠ¨
        if (window.navigator.vibrate) window.navigator.vibrate([50, 100, 50]);

    }, 1200); // 1.2ç§’åæ”¶åˆ°çŸ­ä¿¡
};

/**
 * 10. ä¿®æ”¹å·ç  (æ”¹å·)
 */
window.editSimNumber = async function() {
    let newNum = prompst("è¯·è¾“å…¥æ–°å·ç  (8-15ä½):");
    if(!newNum) return;
    
    if (newNum.length > 15 || !/^\d+$/.test(newNum)) {
        return showIndAlert("æ ¼å¼é”™è¯¯");
    }
    
    let list = await loadFromDB('phone_cards') || [];
    list[window.currentSimIndex].number = newNum;
    await saveToDB('phone_cards', list);
    
    initSimTab();
};

/* ============================================================
   ğŸ¦ æ¯æ—¥å­˜é’±æ‰“å¡ç³»ç»Ÿ (Daily Deposit AI)
   ============================================================ */

/**
 * ğŸš€ 1. å…¥å£ï¼šç‚¹å‡»â€œæ¯æ—¥å­˜å…¥â€æŒ‰é’®
 */
window.triggerDailyDepositAI = async function() {
    const charID = window.currentVaultCharID;
    if (!charID) return;

    // --- A. æ£€æŸ¥æ˜¯å¦å·²æ‰“å¡ ---
    const goalKey = `LUNE_SAVING_GOAL_${charID}`;
    let goal = JSON.parse(localStorage.getItem(goalKey));
    if (!goal) return alert("è¯·å…ˆå»ºç«‹å­˜é’±è®¡åˆ’ï¼");

    const todayStr = new Date().toLocaleDateString();
    
    // æ£€æŸ¥æœ€æ–°çš„ä¸€æ¡è®°å½•
    if (goal.logs && goal.logs.length > 0) {
        const lastLog = goal.logs[0];
        if (lastLog.fullDate === todayStr && lastLog.isDailyCheckIn) {
            showIndAlert("DAILY_LIMIT_REACHED<br>ä»Šæ—¥å·²å®Œæˆå­˜è“„æ‰“å¡ã€‚");
            return;
        }
    }

    // --- B. å‡†å¤‡ç”Ÿæˆ ---
    const btn = document.getElementById('btn-daily-deposit');
    const hint = document.getElementById('daily-deposit-hint');
    
    // éšæœºé‡‘é¢ç®—æ³• (ä¾‹å¦‚ 50 ~ 300 ä¹‹é—´éšæœº)
    const randomAmount = Math.floor(Math.random() * (300 - 50 + 1)) + 50;
    
    btn.disabled = true;
    btn.innerText = `SAVING ï¿¥${randomAmount}... (WRITING)`;
    hint.innerText = "NEURAL LINK: GENERATING MEMORY...";

    // --- C. AI é…ç½® ---
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    // å¼ºåˆ¶æŸ¥åº“è·å–äººè®¾
    let charName = window.currentVaultCharName || "Ta";
    let charBio = "æœªçŸ¥";
    try {
        if (typeof loadFromDB === 'function') {
            const charList = await loadFromDB('char_list') || [];
            const tChar = charList.find(c => c.id === charID);
            if (tChar) {
                charName = tChar.name;
                charBio = tChar.desc || tChar.bio || charBio;
            }
        }
    } catch(e) {}

    // --- D. Prompt è®¾è®¡ ---
    const systemPrompt = `ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${charName}â€ã€‚
    æ ¸å¿ƒäººè®¾ï¼š${charBio}ã€‚
    æ­£åœ¨è¿›è¡Œçš„å­˜é’±ç›®æ ‡ï¼š${goal.title}ã€‚
    
    ä½ åˆšåˆšçœä¸‹äº†ä¸€ç¬”é’±ï¼ˆï¿¥${randomAmount}ï¼‰ã€‚
    è¯·å†™ä¸€ç¯‡ã€200å­—å·¦å³ã€‘çš„å­˜é’±æ—¥è®°ã€‚
    
    ã€è¦æ±‚ã€‘ï¼š
    1. **å¿…é¡»åŒ…å«å¿ƒç†æ´»åŠ¨**ï¼šä¸ºä»€ä¹ˆçœä¸‹è¿™ç¬”é’±ï¼Ÿæ˜¯å¿ä½äº†æ²¡ä¹°ä»€ä¹ˆï¼Ÿè¿˜æ˜¯ä¸ºäº†ç›®æ ‡åšå‡ºçš„ç‰ºç‰²ï¼Ÿ
    2. **æ–‡é£**ï¼šå¿…é¡»å®Œå…¨è´´åˆäººè®¾ï¼Œå¯ä»¥æ˜¯ç¢ç¢å¿µã€å†·å³»çš„è®°å½•ã€æˆ–è€…æ˜¯å……æ»¡å¸Œæœ›çš„ç‹¬ç™½ã€‚
    3. **è¾“å‡ºæ ¼å¼**ï¼šåªè¿”å›æ—¥è®°å†…å®¹æœ¬èº«ï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼Œä¸è¦æ ‡é¢˜ï¼Œä¸è¦JSONï¼Œä¸è¦Markdownã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:systemPrompt}, {role:"user", content: "ç”Ÿæˆæ—¥è®°"}],
                temperature: 0.85
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        
        const story = data.choices[0].message.content.trim();

        // --- E. ä¿å­˜é€»è¾‘ (æŒä¹…åŒ–) ---
        saveDailyDeposit(charID, randomAmount, story, todayStr);

    } catch (e) {
        console.error(e);
        showIndAlert("CONNECTION_LOST: " + e.message);
        btn.disabled = false;
        btn.innerText = "+ EXECUTE_DAILY_DEPOSIT";
    }
};

/**
 * ğŸ’¾ 2. ä¿å­˜å¹¶æ›´æ–°è¿›åº¦
 */
window.saveDailyDeposit = function(charID, amount, story, dateStr) {
    const goalKey = `LUNE_SAVING_GOAL_${charID}`;
    let goal = JSON.parse(localStorage.getItem(goalKey));

    // æ›´æ–°é‡‘é¢
    goal.current += amount;
    
    // æ„é€ æ–°è®°å½•
    const newLog = {
        id: Date.now(),
        fullDate: dateStr, // ç”¨äºåˆ¤æ–­ä»Šå¤©æ˜¯å¦å·²å­˜
        displayDate: new Date().toLocaleDateString('en-US', {month:'short', day:'numeric'}).toUpperCase(),
        amount: amount,
        note: story, // AI å†™çš„ 200å­—å°ä½œæ–‡
        isDailyCheckIn: true // æ ‡è®°è¿™æ˜¯æ¯æ—¥æ‰“å¡
    };

    // æ’å…¥åˆ°æœ€å‰é¢
    goal.logs.unshift(newLog);

    // å­˜å…¥ç¡¬ç›˜
    localStorage.setItem(goalKey, JSON.stringify(goal));

    // --- F. UI åˆ·æ–° ---
    
    // 1. åˆ·æ–°å¼¹çª—å†…çš„åˆ—è¡¨
    window.renderVaultLogsInner(goal.logs);
    
    // 2. åˆ·æ–°å¤–éƒ¨è¿›åº¦æ¡ (å¦‚æœ initVaultTab å­˜åœ¨)
    if (typeof initVaultTab === 'function') initVaultTab();

    // 3. æ¢å¤æŒ‰é’®çŠ¶æ€
    const btn = document.getElementById('btn-daily-deposit');
    const hint = document.getElementById('daily-deposit-hint');
    if (btn) {
        btn.innerText = "âœ“ COMPLETED (ä»Šæ—¥å·²å®Œæˆ)";
        btn.disabled = true;
        btn.style.background = "#eee";
        btn.style.color = "#aaa";
        btn.style.border = "2px solid #eee";
    }
    if (hint) hint.innerText = "NEXT CHECK-IN: TOMORROW";

    // 4. éœ‡åŠ¨åé¦ˆ
    if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
};
// å†…éƒ¨æ¸²æŸ“å‡½æ•° (æŠ½ç¦»å‡ºæ¥æ–¹ä¾¿å¤ç”¨)
window.renderVaultLogsInner = function(logs) {
    const container = document.getElementById('vault-logs-container');
    
    if (!logs || logs.length === 0) {
        container.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">NO RECORDS FOUND</div>`;
        return;
    }

    container.innerHTML = logs.map(log => `
        <div class="vault-log-card">
            <div class="vlc-header">
                <span class="vlc-date">${log.displayDate || log.date}</span>
                <span class="vlc-amount">+ï¿¥${log.amount.toLocaleString()}</span>
            </div>
            <div class="vlc-body">
                ${(log.note || '').replace(/\n/g, '<br>')}
            </div>
            <div class="vlc-footer">
                <span>REF: ${String(log.id).slice(-8)}</span>
                <span>${log.isDailyCheckIn ? 'DAILY_AI_LOG' : 'MANUAL_DEPOSIT'}</span>
            </div>
        </div>
    `).join('');
};

/**
 * ğŸ› ï¸ æ‰“å¼€æ‰‹åŠ¨è®¾å®šå¼¹çª—
 */
window.openManualSetModal = function() {
    const modal = document.getElementById('modal-manual-goal');
    if (modal) modal.style.display = 'flex';
};

/**
 * ğŸ’¾ ç¡®è®¤æ‰‹åŠ¨è®¾å®š
 */
window.confirmManualGoal = function() {
    const title = document.getElementById('manual-goal-title').value;
    const target = parseFloat(document.getElementById('manual-goal-target').value);
    const desc = document.getElementById('manual-goal-desc').value || "Self-imposed protocol.";
    
    if (!title || !target || target <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ ‡é¢˜å’Œç›®æ ‡é‡‘é¢");
        return;
    }

    const charID = window.currentVaultCharID;
    if (!charID) return alert("æœªé€‰ä¸­è§’è‰²");

    const newGoal = {
        title: title,
        desc: desc,
        target: target,
        current: 0,
        isCompleted: false,
        logs: [],
        startDate: new Date().toISOString().split('T')[0]
    };

    // å­˜å…¥ç¡¬ç›˜
    localStorage.setItem(`LUNE_SAVING_GOAL_${charID}`, JSON.stringify(newGoal));

    // å…³é—­å¼¹çª—å¹¶åˆ·æ–°
    document.getElementById('modal-manual-goal').style.display = 'none';
    
    // åˆ·æ–°ä¸»ç•Œé¢ (æ˜¾ç¤ºè¿›åº¦æ¡)
    if (typeof initVaultTab === 'function') initVaultTab();
    
    if (navigator.vibrate) navigator.vibrate(20);
};

/* ============================================================
   ğŸ¦ é‡‘åº“åè®®æ¨¡å— (Vault Protocol)
   ============================================================ */

// ä¸´æ—¶å­˜å‚¨ AI ç”Ÿæˆçš„ææ¡ˆ
window.tempAiProposal = null;

/**
 * 1. åˆå§‹åŒ–é‡‘åº“é¡µé¢ (æ¯æ¬¡åˆ‡åˆ° tab-vault æ—¶è°ƒç”¨)
 */
window.initVaultTab = function() {
    const charID = window.currentVaultCharID;
    if (!charID) return;

    // è¯»å–è¯¥è§’è‰²çš„å­˜é’±ç›®æ ‡
    // æ ¼å¼: { title, desc, target: 50000, current: 1200, logs: [...] }
    const goalKey = `LUNE_SAVING_GOAL_${charID}`;
    const goal = JSON.parse(localStorage.getItem(goalKey));

    const stateEmpty = document.getElementById('vault-state-empty');
    const stateActive = document.getElementById('vault-state-active');

    if (goal && !goal.isCompleted) { // å¦‚æœæœ‰æœªå®Œæˆçš„ç›®æ ‡
        stateEmpty.style.display = 'none';
        stateActive.style.display = 'block';
        renderActiveGoal(goal);
    } else {
        stateEmpty.style.display = 'block';
        stateActive.style.display = 'none';
    }
};

/**
 * 2. æ¸²æŸ“è¿›è¡Œä¸­çš„ç›®æ ‡
 */
window.renderActiveGoal = function(goal) {
    document.getElementById('active-goal-name').innerText = goal.title;
    document.getElementById('active-goal-desc').innerText = goal.desc;
    
    // è®¡ç®—ç™¾åˆ†æ¯”
    const percent = Math.min(100, (goal.current / goal.target) * 100);
    document.getElementById('vault-progress-fill').style.width = percent + "%";
    
    document.getElementById('vault-current-val').innerText = `ï¿¥${goal.current.toLocaleString()}`;
    document.getElementById('vault-target-val').innerText = `/ ï¿¥${goal.target.toLocaleString()}`;
};

/**
 * âš¡ 3. è§¦å‘ AI ææ¡ˆ (ç»ˆæä¿®æ­£ç‰ˆï¼šå¼ºåˆ¶è¯»å–æ•°æ®åº“ + éšæœºæ€§æ³¨å…¥)
 */
window.triggerAiSavingPlan = async function() {
    const charID = window.currentVaultCharID;
    
    // 1. å®‰å…¨æ£€æŸ¥
    if (!charID) {
        alert("PROTOCOL_ERROR: æœªé€‰ä¸­æœ‰æ•ˆè§’è‰² (No Entity Selected)");
        return;
    }

    // 2. ğŸ› ï¸ æ ¸å¿ƒä¿®å¤ Aï¼šç›´æ¥å»æ•°æ®åº“æŸ¥äººè®¾ï¼Œä¸ä¾èµ–å¯èƒ½ä¸ºç©ºçš„å…¨å±€å˜é‡
    let charName = window.currentVaultCharName || "UNKNOWN";
    let charBio = "æ™®é€šäºº"; // é»˜è®¤å…œåº•

    try {
        // å‡è®¾æ‚¨çš„æ•°æ®åº“è¯»å–å‡½æ•°æ˜¯ loadFromDB (æ ¹æ®æ‚¨æä¾›çš„æ–‡ä»¶ wenjian copy 2.html)
        const charList = await loadFromDB('char_list') || [];
        const targetChar = charList.find(c => c.id === charID);
        
        if (targetChar) {
            charName = targetChar.name;
            // å…¼å®¹ desc æˆ– bio å­—æ®µï¼Œç¡®ä¿ä¸€å®šèƒ½å–åˆ°å­—
            charBio = targetChar.desc || targetChar.bio || "æ— è¯¦ç»†äººè®¾"; 
            console.log(`[AI] å·²é”å®šç²¾å‡†äººè®¾: ${charName} / ${charBio.substring(0, 10)}...`);
        } else {
            console.warn("[AI] æ•°æ®åº“æœªæ‰¾åˆ°è¯¥IDï¼Œä½¿ç”¨ç¼“å­˜äººè®¾");
            charBio = window.currentVaultCharBio || charBio;
        }
    } catch (e) {
        console.error("æ•°æ®åº“è¯»å–å¤±è´¥:", e);
    }

    // 3. UI åˆå§‹åŒ–
    const modal = document.getElementById('modal-ai-proposal');
    if(modal) modal.style.display = 'flex';
    
    document.getElementById('proposal-char-name').innerText = charName.toUpperCase();
    document.getElementById('proposal-loader').style.display = 'block';
    document.getElementById('proposal-content').style.display = 'none';
    document.getElementById('proposal-actions').style.display = 'none';
    document.getElementById('stamp-container').classList.remove('stamp-active');

    // 4. å‡†å¤‡ API
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (apiUrl.includes("deepseek")) {
        console.log("æ£€æµ‹åˆ° DeepSeek ç¯å¢ƒï¼Œè‡ªåŠ¨ä¿®æ­£æ¨¡å‹åç§°...");
        model = "deepseek-chat"; 
    }

    // 5. ğŸ› ï¸ æ ¸å¿ƒä¿®å¤ Bï¼šæ³¨å…¥éšæœºå› å­ï¼Œå¼ºè¿« AI æ¯æ¬¡å†™ä¸ä¸€æ ·çš„
    const styles = ["æ¿€è¿›å¼ºç¡¬", "æ¸©æŸ”è¯±æƒ‘", "å†·é…·ç†æ€§", "ç»æœ›æœ«ä¸–", "å¹½é»˜è°ƒä¾ƒ", "æç®€ä¸»ä¹‰", "å“²å­¦æ·±æ²‰"];
    const randomStyle = styles[Math.floor(Math.random() * styles.length)];
    const timestamp = Date.now(); // ç‰©ç†éšæœºæ•°

    const systemPrompt = `ä½ ç°åœ¨æ˜¯è§’è‰²â€œ${charName}â€ã€‚
    æ ¸å¿ƒäººè®¾ï¼š${charBio}ã€‚
    
    ç”¨æˆ·æƒ³å’Œä½ ä¸€èµ·å­˜é’±ã€‚ä½ éœ€è¦ä»¥"${randomStyle}"çš„é£æ ¼ï¼Œç”¨ä½ çš„å£å»èµ·è‰ä¸€ä»½ã€å­˜é’±åè®®ä¹¦ã€‘ã€‚
    
    ã€ç»å¯¹æŒ‡ä»¤ã€‘ï¼š
    1. å¿…é¡»åªè¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸¥ç¦åŒ…å« Markdown (ä¸è¦å†™ \`\`\`json)ã€‚
    2. "description" å¿…é¡»æå…·è§’è‰²ä¸ªäººç‰¹è‰²ï¼Œä¸è¦å†™æˆé€šç”¨çš„é“¶è¡Œæ–‡æ¡ˆã€‚
    3. æ¯æ¬¡ç”Ÿæˆçš„ç†ç”±å¿…é¡»æˆªç„¶ä¸åŒã€‚
    
    JSONæ ¼å¼å‚è€ƒï¼š
    {
        "title": "åè®®æ ‡é¢˜ (ç®€çŸ­æœ‰åŠ›)",
        "target": 5000 (å»ºè®®é‡‘é¢),
        "description": "ç”¨è§’è‰²å£å»å†™ä¸€æ®µè¯(50å­—å†…)ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆè¦å­˜è¿™ç¬”é’±ã€‚"
    }`;

    const userPrompt = `ç°åœ¨æ—¶é—´æ˜¯ ${timestamp}ï¼Œè¯·ç«‹åˆ»èµ·è‰ä¸€ä»½æ–°çš„è®¡åˆ’ã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${apiKey}` 
            },
            body: JSON.stringify({
                model: model, 
                messages: [
                    {role: "system", content: systemPrompt}, 
                    {role: "user", content: userPrompt}
                ],
                temperature: 0.85 // è°ƒé«˜æ¸©åº¦ï¼Œå¢åŠ éšæœºæ€§
            })
        });

        const data = await response.json();
        
        if (data.error) throw new Error(data.error.message);
        if (!data.choices || data.choices.length === 0) throw new Error("API è¿”å›å†…å®¹ä¸ºç©º");

        let rawText = data.choices[0].message.content;

        // æ­£åˆ™æå– JSONï¼Œé˜²æ­¢åºŸè¯å¹²æ‰°
        const jsonMatch = rawText.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error("AI æœªè¿”å›æœ‰æ•ˆçš„ JSON æ ¼å¼");
        
        const content = JSON.parse(jsonMatch[0]);
        
        // 6. æ¸²æŸ“ç»“æœ
        window.tempAiProposal = content;
        
        document.getElementById('prop-title').innerText = content.title;
        document.getElementById('prop-desc').innerText = content.description;
        document.getElementById('prop-amount').innerText = (content.target || 0).toLocaleString();

        document.getElementById('proposal-loader').style.display = 'none';
        document.getElementById('proposal-content').style.display = 'block';
        document.getElementById('proposal-actions').style.display = 'flex';

    } catch (e) {
        console.error(e);
        alert("ç”Ÿæˆå¤±è´¥: " + e.message);
        if(modal) modal.style.display = 'none';
    }
};

/**
 * ğŸ’® 4. æ‰¹å‡†ææ¡ˆ (ç›–ç« åŠ¨ç”» + å­˜åº“)
 */
window.approveProposal = function() {
    if (!window.tempAiProposal) return;

    // 1. æ’­æ”¾ç›–ç« åŠ¨ç”»
    const stamp = document.getElementById('stamp-container');
    stamp.style.display = 'flex';
    void stamp.offsetWidth; // è§¦å‘é‡ç»˜
    stamp.classList.add('stamp-active');

    if (navigator.vibrate) navigator.vibrate([50, 100]); // éœ‡åŠ¨æ›´æœ‰æ„Ÿè§‰

    // 2. å»¶æ—¶åä¿å­˜å¹¶è·³è½¬
    setTimeout(() => {
        const charID = window.currentVaultCharID;
        const newGoal = {
            title: window.tempAiProposal.title,
            desc: window.tempAiProposal.description,
            target: window.tempAiProposal.target,
            current: 0,
            isCompleted: false,
            logs: [],
            startDate: new Date().toISOString().split('T')[0]
        };

        // å­˜å…¥ç¡¬ç›˜
        localStorage.setItem(`LUNE_SAVING_GOAL_${charID}`, JSON.stringify(newGoal));

        // å…³é—­å¼¹çª—å¹¶åˆ·æ–°
        document.getElementById('modal-ai-proposal').style.display = 'none';
        initVaultTab(); // åˆ·æ–°ä¸»ç•Œé¢
        
    }, 1500); // ç­‰åŠ¨ç”»æ’­å®Œ
};

window.rejectProposal = function() {
    // é‡æ–°è§¦å‘ç”Ÿæˆ
    triggerAiSavingPlan();
};

/**
 * ğŸ’° 5. å­˜å…¥èµ„é‡‘ (Deposit)
 */
window.openDepositModal = () => document.getElementById('modal-deposit').style.display = 'flex';

window.executeDeposit = function() {
    const amount = parseFloat(document.getElementById('deposit-amount').value);
    const note = document.getElementById('deposit-note').value || "Regular Saving";
    
    if (!amount || amount <= 0) return alert("æ— æ•ˆé‡‘é¢");

    const charID = window.currentVaultCharID;
    const goalKey = `LUNE_SAVING_GOAL_${charID}`;
    let goal = JSON.parse(localStorage.getItem(goalKey));

    if (!goal) return;

    // æ›´æ–°æ•°æ®
    goal.current += amount;
    goal.logs.unshift({
        date: new Date().toLocaleDateString(),
        amount: amount,
        note: note
    });

    localStorage.setItem(goalKey, JSON.stringify(goal));

    // UI åé¦ˆ
    document.getElementById('modal-deposit').style.display = 'none';
    document.getElementById('deposit-amount').value = "";
    initVaultTab(); // åˆ·æ–°è¿›åº¦æ¡
    
    if (navigator.vibrate) navigator.vibrate(20);
    showIndAlert(`FUNDS INJECTED: +ï¿¥${amount}`);
};

/**
 * ğŸ“œ 6. æŸ¥çœ‹å­˜é’±è®°å½•
 */
window.openVaultLogs = function() {
    const charID = window.currentVaultCharID;
    const goal = JSON.parse(localStorage.getItem(`LUNE_SAVING_GOAL_${charID}`));
    const modal = document.getElementById('modal-vault-logs');
    
    // æ‰“å¼€å¼¹çª—
    modal.style.display = 'flex';

    // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²å­˜ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
    checkDailyButtonState(goal);

    // æ¸²æŸ“åˆ—è¡¨
    if (goal && goal.logs) {
        renderVaultLogsInner(goal.logs);
    } else {
        document.getElementById('vault-logs-container').innerHTML = `<div style="padding:40px; text-align:center; color:#999;">NO RECORDS FOUND</div>`;
    }
};

/**
 * ğŸ”” æ˜¾ç¤ºå·¥ä¸šé£å¼¹çª—
 */
window.showIndAlert = function(msg) {
    const modal = document.getElementById('industrial-alert-modal');
    const msgBox = document.getElementById('industrial-alert-msg');
    
    if (modal && msgBox) {
        msgBox.innerHTML = msg; // æ”¯æŒ HTML æ¢è¡Œ
        modal.style.display = 'flex';
        
        // éœ‡åŠ¨åé¦ˆ
        if (navigator.vibrate) navigator.vibrate([10, 50]);
    } else {
        // å…œåº•ï¼šä¸‡ä¸€ HTML æ²¡åŠ å¯¹ï¼Œè¿˜æ˜¯å¼¹åŸç”Ÿï¼Œé˜²æ­¢æ²¡ååº”
        alert(msg);
    }
};

/**
 * ğŸ”• å…³é—­å¼¹çª—
 */
window.closeIndustrialAlert = function() {
    const modal = document.getElementById('industrial-alert-modal');
    if (modal) modal.style.display = 'none';
};

/**
 * ğŸ”„ å…¨å±€åˆå§‹åŒ–ï¼šé¡µé¢åˆ·æ–°åè‡ªåŠ¨æ¢å¤çŠ¶æ€
 */
window.addEventListener('DOMContentLoaded', () => {
    console.log("æ­£åœ¨æ¢å¤ç³»ç»ŸçŠ¶æ€...");

    // 1. å°è¯•ä»ç¼“å­˜æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„è§’è‰² ID
    const lastCharID = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');
    const lastCharName = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_NAME');
    const lastCharBio = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_BIO');

    if (lastCharID) {
        // æ¢å¤å…¨å±€å˜é‡
        window.currentVaultCharID = lastCharID;
        window.currentVaultCharName = lastCharName || "æœªçŸ¥è§’è‰²";
        window.currentVaultCharBio = lastCharBio || "æ— è¯¦ç»†ä¿¡æ¯";
        
        console.log(`çŠ¶æ€å·²æ¢å¤: ${lastCharName} (${lastCharID})`);

        // 2. ğŸš¨ å…³é”®ï¼šç«‹å³æ¸²æŸ“è§’è‰²æ”¯å‡ºåˆ—è¡¨
        // åªè¦é¡µé¢é‡Œæœ‰è¿™ä¸ªå®¹å™¨ï¼Œå°±é©¬ä¸Šç”»å‡ºæ¥
        if (document.getElementById('char-expense-list')) {
            renderCharExpenseList(); 
        }
    } else {
        console.log("æ— å†å²é€‰ä¸­è§’è‰²");
    }

    // 3. æ¢å¤åº•éƒ¨å¯¼èˆªæ çš„é€‰ä¸­çŠ¶æ€ (å¯é€‰)
    // å¦‚æœä½ å¸Œæœ›åˆ·æ–°ååœç•™åœ¨â€œè®°å½•é¡µâ€ï¼Œå¯ä»¥åœ¨è¿™é‡Œå†™é€»è¾‘ï¼Œå¦åˆ™é»˜è®¤å›é¦–é¡µ
});

/**
 * â†» æ‰‹åŠ¨åˆ·æ–°è½¬è´¦ (åœ¨æ—¥è®°å½•å¼¹çª—é‡Œç‚¹å‡»)
 */
window.manualSyncTransfers = function() {
    const charID = window.currentVaultCharID;
    if (!charID) return;

    // 1. é‡æ–°è¯»å–æ—¥å¿— (å› ä¸ºè½¬è´¦é€»è¾‘å·²ç»æŠŠæ•°æ®å†™è¿›å»äº†)
    // è¿™ä¸€æ­¥å…¶å®ä¸»è¦æ˜¯ä¸ºäº†è®©ç”¨æˆ·æ„Ÿè§‰â€œåˆ·æ–°â€äº†ï¼Œå®é™…ä¸Šæ•°æ®å·²ç»æ˜¯æ–°çš„äº†
    
    // 2. åˆ·æ–°ä¸»é¡µåˆ—è¡¨
    renderCharExpenseList();
    
    // 3. æç¤ºç”¨æˆ·
    const btn = event.target; // è·å–ç‚¹å‡»çš„æŒ‰é’®
    const originalText = btn.innerText;
    
    btn.innerText = "âœ“ SYNCED";
    btn.style.background = "#000";
    btn.style.color = "#fff";
    
    if(navigator.vibrate) navigator.vibrate(20);

    setTimeout(() => {
        btn.innerText = originalText;
        btn.style.background = "#fff";
        btn.style.color = "#000";
        
        // 3. ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„å·¥ä¸šé£å¼¹çª—
        showIndAlert(`
            SYNC_COMPLETE <br>
            <span style="font-size:12px; color:#666; font-weight:normal;">
                ç”¨æˆ·è½¬è´¦èµ„é‡‘å·²æ³¨å…¥ä»Šæ—¥æµæ°´ã€‚<br>
                FUNDS INJECTED SUCCESSFULLY.
            </span>
        `);
        
    }, 800);
};

// å…¨å±€é…ç½®
const DAILY_STORAGE_PREFIX = "LUNE_ENTITY_DAILY_";

/**
 * ğŸš€ 1. å…¥å£ï¼šç‚¹å‡» "ANALYZE_ENTITIES" æŒ‰é’®
 */
window.triggerCharExpenseAI = function() {
    const charID = window.currentVaultCharID;
    if (!charID) return showToast("PROTOCOL_ERROR: NO_ENTITY_SELECTED");

    // 1. åˆå§‹åŒ–å¼¹çª— UI
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    document.getElementById('daily-date-label').innerText = today;
    
    // 2. æ£€æŸ¥è½¬è´¦åŒæ­¥ (æ¨¡æ‹Ÿè¯»å–é’±åŒ…è®°å½•)
    const transfers = syncUserTransfers(charID, today);
    renderTransfersInModal(transfers);

    // 3. æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ç”Ÿæˆ
    const recordKey = `${DAILY_STORAGE_PREFIX}${charID}_${today}`;
    const hasRecord = localStorage.getItem(recordKey);

    const btn = document.getElementById('btn-gen-daily');
    const status = document.getElementById('daily-status-text');
    const doneMsg = document.getElementById('daily-done-msg');

    if (hasRecord) {
        // å¦‚æœä»Šå¤©ç”Ÿæˆè¿‡äº†
        btn.style.display = 'none';
        status.style.display = 'none';
        doneMsg.style.display = 'block';
    } else {
        // å¦‚æœä»Šå¤©è¿˜æ²¡ç”Ÿæˆ
        btn.style.display = 'block';
        status.style.display = 'block';
        doneMsg.style.display = 'none';
        
        // æŒ‚è½½ä¸´æ—¶æ•°æ®ä¾› AI ä½¿ç”¨
        window.tempPendingTransfers = transfers; 
    }

    document.getElementById('entity-daily-modal').style.display = 'flex';
};

/* ============================================================
   ğŸ”„ è½¬è´¦åŒæ­¥è¾…åŠ©å‡½æ•° (ä¿®å¤ ReferenceError)
   ============================================================ */

/**
 * ğŸ” è¯»å–ä»Šæ—¥å·²æ”¶åˆ°çš„è½¬è´¦
 * (ä»è§’è‰²æ—¥å¿—é‡ŒåæŸ¥ï¼Œçœ‹çœ‹ä»Šå¤©æ˜¯ä¸æ˜¯å·²ç»æ”¶åˆ°äº†é’±)
 */
window.syncUserTransfers = function(charID, dateStr) {
    if (!charID) return [];

    // è¯»å–è¯¥è§’è‰²çš„æ‰€æœ‰æ—¥å¿—
    const listKey = `LUNE_ENTITY_LOGS_${charID}`;
    const logs = JSON.parse(localStorage.getItem(listKey)) || [];
    
    // æ‰¾åˆ°â€œä»Šå¤©â€çš„é‚£æ¡è®°å½•
    const todayLog = logs.find(l => l.date === dateStr);

    if (todayLog && todayLog.items) {
        // ç­›é€‰å‡ºæ‰€æœ‰â€œæ”¶å…¥â€é¡¹ (type: 'income')
        return todayLog.items.filter(item => item.type === 'income');
    }
    
    return [];
};

/**
 * ğŸ¨ åœ¨å¼¹çª—é‡Œæ¸²æŸ“è½¬è´¦åˆ—è¡¨
 * (è®©ç”¨æˆ·çŸ¥é“ AI ä¼šæŠŠè¿™äº›é’±è€ƒè™‘è¿›å»)
 */
window.renderTransfersInModal = function(transfers) {
    const box = document.getElementById('pending-transfer-box');
    const list = document.getElementById('transfer-list-content');
    
    if (!box || !list) return; // é˜²å¾¡æ€§ç¼–ç¨‹

    if (transfers && transfers.length > 0) {
        box.style.display = 'block';
        list.innerHTML = transfers.map(t => `
            <div class="transfer-item-row" style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee;">
                <span style="font-size: 11px; color: #333;">
                    ${t.desc || 'USER_TRANSFER'}
                </span>
                <span style="font-weight: bold; font-family: 'Cinzel'; font-size: 13px;">
                    +ï¿¥${parseFloat(t.amount).toLocaleString()}
                </span>
            </div>
        `).join('');
    } else {
        box.style.display = 'none';
        list.innerHTML = "";
    }
};

/**
 * âš¡ 3. AI æ‰§è¡Œï¼šç”Ÿæˆæ—¥è®°å½• (äººè®¾åŒæ­¥ä¿®æ­£ç‰ˆ)
 */
window.runEntityDailyAI = async function() {
    const btn = document.getElementById('btn-gen-daily');
    const originalText = btn.innerText;

    // 1. åŸºç¡€æ£€æŸ¥
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo"; 

    if (!apiKey) {
        alert("æœªé…ç½® API KEY");
        return;
    }

    // ğŸš¨ è‡ªåŠ¨ä¿®æ­£ï¼šå¦‚æœæ˜¯ DeepSeekï¼Œå¿…é¡»ç”¨ deepseek-chat
    if (apiUrl.includes("deepseek")) {
        console.log("æ£€æµ‹åˆ° DeepSeek ç¯å¢ƒï¼Œè‡ªåŠ¨ä¿®æ­£æ¨¡å‹åç§°...");
        model = "deepseek-chat"; 
    }

    btn.innerText = "CALCULATING VARIANCE... (è®¡ç®—ä¸­)";
    btn.disabled = true;

    // 2. ğŸ› ï¸ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ä»æ•°æ®åº“è¯»å–ç²¾å‡†äººè®¾
    const charID = window.currentVaultCharID;
    let charName = window.currentVaultCharName || "æœªçŸ¥è§’è‰²";
    let charBio = window.currentVaultCharBio || "æ— è¯¦ç»†äººè®¾";

    try {
        // å°è¯•è¯»å–æ•°æ®åº“
        // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾æ‚¨çš„ loadFromDB å‡½æ•°å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨è¯·ç¡®ä¿ helper.js å·²åŠ è½½
        if (typeof loadFromDB === 'function') {
            const charList = await loadFromDB('char_list') || [];
            const targetChar = charList.find(c => c.id === charID);
            
            if (targetChar) {
                charName = targetChar.name;
                // ä¼˜å…ˆå– descï¼Œæ²¡æœ‰å†å– bio
                charBio = targetChar.desc || targetChar.bio || charBio;
                console.log(`[AI] æ—¥è®°å½•ç”Ÿæˆ - å·²é”å®šäººè®¾: ${charName}`);
            }
        }
    } catch (e) {
        console.warn("è¯»å–äººè®¾å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¼“å­˜å€¼", e);
    }

    // 3. æ„å»ºè½¬è´¦ä¸Šä¸‹æ–‡
    const transfers = window.tempPendingTransfers || [];
    let transferContext = "";
    if (transfers.length > 0) {
        transferContext = `ã€å¼ºåˆ¶åŒ…å«æ”¶å…¥ã€‘ï¼šç”¨æˆ·ä»Šå¤©ç»™è§’è‰²è½¬è´¦äº†ä»¥ä¸‹é‡‘é¢ï¼Œå¿…é¡»ä½œä¸ºâ€œæ”¶å…¥â€å†™å…¥è®°å½•ï¼Œå¹¶æå†™è§’è‰²æ”¶åˆ°é’±åçš„ååº”ï¼š
        ${transfers.map(t => `- é‡‘é¢ï¼š${t.amount}ï¼Œå¤‡æ³¨ï¼š${t.note}`).join('\n')}`;
    }

    // 4. Prompt è®¾è®¡
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸¥è°¨çš„è´¢åŠ¡è®°å½•å®˜ã€‚è¯·ä¸ºè§’è‰²ç”Ÿæˆã€ä»Šæ—¥æ”¶æ”¯æ˜ç»†ã€‘ã€‚
    
    ã€ç”Ÿæˆè§„åˆ™ã€‘ï¼š
    1. **é‡‘é¢æ³¢åŠ¨**ï¼šæ”¯å‡ºé‡‘é¢å¿…é¡»æœ‰æ˜æ˜¾çš„éšæœºæ€§ï¼ˆä¸è¦æ€»æ˜¯æ•´æ•°ï¼Œä¾‹å¦‚ 32.50, 128.00ï¼‰ï¼Œä¸è¦æ¯æ¬¡éƒ½ä¸€æ ·ã€‚
    2. **é¡¹ç›®æ•°é‡**ï¼šç”Ÿæˆ 7-10 ç¬”æ”¯å‡ºï¼ˆå¿…é¡»å†™æ»¡ï¼‰ï¼Œå¦‚æœæœ‰è½¬è´¦åˆ™é¢å¤–åŠ ä¸Šæ”¶å…¥ã€‚
    3. **æè¿°è¦æ±‚**ï¼šæ¯ä¸€ç¬”è®°å½•å¿…é¡»æœ‰ 30-40 å­—çš„ç»†è…»æè¿°ï¼ˆæå†™è´­ä¹°åŠ¨æœºã€å¿ƒæƒ…æˆ–å…·ä½“åœºæ™¯ï¼‰ã€‚
    4. **ä¸¥ç¦æˆªæ–­**ï¼šå¿…é¡»è¾“å‡ºå®Œæ•´çš„ JSON æ•°ç»„ï¼Œä¸è¦å†™åˆ°ä¸€åŠåœä¸‹ã€‚
    5. **æ ¼å¼**ï¼šçº¯ JSON æ•°ç»„ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚æ ¼å¼ç¤ºä¾‹ï¼š[{"type":"expense/income", "amount":æ•°å­—, "desc":"æè¿°"}]`;

    const userPrompt = `è§’è‰²ï¼š${charName}
    äººè®¾ï¼š${charBio}
    æ—¥æœŸï¼š${new Date().toLocaleDateString()}
    
    ${transferContext}
    
    è¯·ç”Ÿæˆä»Šæ—¥çš„æ¶ˆè´¹/æ”¶å…¥æµæ°´ã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${apiKey}` 
            },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:systemPrompt}, {role:"user", content:userPrompt}],
                // ğŸš¨ æ‚¨è¦æ±‚çš„å‚æ•°é…ç½®
                max_tokens: 5000, 
                temperature: 0.95 
            })
        });

        const data = await response.json();

        // ğŸš¨ é”™è¯¯æ•æ‰
        if (data.error) {
            console.error("API æŠ¥é”™è¯¦æƒ…:", data.error);
            throw new Error(`API Error: ${data.error.message}`);
        }

        if (!data.choices || data.choices.length === 0) {
            throw new Error("API è¿”å›äº†ç©ºæ•°æ®");
        }

        const raw = data.choices[0].message.content;
        console.log("AI åŸå§‹å†…å®¹:", raw); 

        // ğŸš¨ æ­£åˆ™æå– JSON (å¢å¼ºå®¹é”™)
        let jsonStr = raw;
        const jsonMatch = raw.match(/\[[\s\S]*\]/); // å¯»æ‰¾æœ€å¤–å±‚çš„ []
        if (jsonMatch) {
            jsonStr = jsonMatch[0];
        } else {
            throw new Error("AI æœªè¿”å›æœ‰æ•ˆçš„ JSON æ•°ç»„æ ¼å¼");
        }

        try {
            const dailyData = JSON.parse(jsonStr);
            saveAndRenderEntityDaily(dailyData);
        } catch (jsonErr) {
            console.error("JSON è§£æå¤±è´¥ï¼ŒåŸå§‹å†…å®¹:", raw);
            throw new Error("AI ç”Ÿæˆçš„å†…å®¹æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•");
        }

    } catch (e) {
        console.error(e);
        alert("ç”Ÿæˆå¤±è´¥: " + e.message);
        btn.innerText = "[ RETRY ] é‡è¯•";
        btn.disabled = false;
    }
};

/**
 * ğŸ¨ 5. æ¸²æŸ“ä¸»é¡µåˆ—è¡¨ (å±•ç¤ºæ¯ä¸€å¤©çš„è®°å½•)
 */
window.renderCharExpenseList = function() {
    const charID = window.currentVaultCharID;
    if (!charID) return;

    const listContainer = document.getElementById('char-expense-list');
    const listKey = `LUNE_ENTITY_LOGS_${charID}`;
    
    // è¯»å–æ‰€æœ‰å†å²è®°å½•
    const logs = JSON.parse(localStorage.getItem(listKey)) || [];

    if (logs.length === 0) {
        listContainer.innerHTML = `<div class="empty-text-mark">WAITING_FOR_DATA_STREAM...</div>`;
        return;
    }

    // map ä¼šéå†æ•°ç»„é‡Œçš„æ¯ä¸€å¤©ï¼ŒæŠŠå®ƒä»¬éƒ½ç”»å‡ºæ¥
    listContainer.innerHTML = logs.map(log => `
        <div class="entity-log-card" style="animation: fadeIn 0.5s ease;">
            <div class="elc-header">
                <div class="elc-date">${log.date}</div> <div class="elc-total" style="${log.total > 0 ? 'background:#000' : 'background:#666'}">
                    NET: ${log.total > 0 ? '+' : ''}ï¿¥${log.total.toFixed(2)}
                </div>
            </div>
            
            <div style="border-left: 2px solid #eee; padding-left: 10px;">
                ${log.items.map(item => `
                    <div class="elc-row">
                        <div class="elc-desc">${item.desc}</div>
                        <div class="elc-amount ${item.type === 'income' ? 'elc-income' : 'elc-expense'}">
                            ${item.type === 'income' ? '+' : '-'}ï¿¥${item.amount.toLocaleString()}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
};

// è¾…åŠ©ï¼šå…³é—­å¼¹çª—
window.closeEntityDailyModal = function() {
    document.getElementById('entity-daily-modal').style.display = 'none';
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    const btn = document.getElementById('btn-gen-daily');
    btn.innerText = "[ EXECUTE_PROTOCOL ] ç”Ÿæˆæ—¥è®°å½•";
    btn.disabled = false;
};


/**
 * ğŸŒŸ 1. å“åº”â€œå¹´åº¦æ¶ˆè´¹â€æŒ‰é’® (500å­—é•¿æ–‡ + å¼ºåŠ›çœé’±ç¼“å­˜ç‰ˆ + ç²¾å‡†äººè®¾ä¿®æ­£)
 */
window.handleAnnualConsumption = async function() {
    if(window.navigator.vibrate) window.navigator.vibrate(20);

    // è·å–æ•°æ® (å¦‚æœå…¨å±€å˜é‡ä¸¢äº†ï¼Œå°è¯•ä» ID æ¢å¤)
    let archive = window.currentViewingYearlyData;
    
    // ğŸš¨ é˜²å¾¡æ€§ä»£ç ï¼šå°è¯•é‡è¿æ•°æ®æµ
    if (!archive) {
        console.warn("æ•°æ®æµé‡è¿ä¸­...");
        const charID = window.currentVaultCharID || 'GLOBAL';
        const list = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];
        if (window.currentViewingArchiveId) {
            archive = list.find(a => a.id === window.currentViewingArchiveId);
        }
    }

    if (!archive) {
        alert("æ•°æ®æµä¸¢å¤±ï¼Œè¯·å…³é—­å¼¹çª—é‡æ–°ç‚¹å‡»å¡ç‰‡è¿›å…¥ã€‚");
        return;
    }

    // å‡†å¤‡æ‰“å¼€å¼¹çª—
    const modal = document.getElementById('annual-story-modal');
    const container = document.getElementById('annual-story-content');
    
    if(!modal) return console.error("ç¼ºå°‘ HTML: annual-story-modal");

    modal.style.display = 'flex';

    // --- ğŸ’° çœé’±æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æœ¬åœ°ç¼“å­˜ ---
    const charID = window.currentVaultCharID || 'GLOBAL';
    // å‡çº§ Key ä¸º V2ï¼Œç¡®ä¿ç¼“å­˜å”¯ä¸€ä¸”æŒä¹…
    const cacheKey = `LUNE_STORY_ANNUAL_V2_${charID}_${archive.id}`;
    const cachedStory = localStorage.getItem(cacheKey);

    if (cachedStory) {
        console.log("ğŸ’° [çœé’±æ¨¡å¼] å¹´åº¦æ•…äº‹å‘½ä¸­æœ¬åœ°ç¼“å­˜ï¼Œä¸æ¶ˆè€— APIã€‚");
        // ç›´æ¥æ¸²æŸ“ï¼Œä¸è¯·æ±‚ AI
        container.innerHTML = `<div class="story-prose-text fade-in-text">${cachedStory}</div>`;
        return; 
    }

    // --- ä¸‹é¢æ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆæ‰è·‘çš„ä»£ç  ---

    // 2. åŠ è½½åŠ¨ç”»
    container.innerHTML = `
        <div class="ai-generating-box">
            <div class="scan-bar-anim"></div>
            <div class="cinzel-font" style="font-size:18px;">ANALYZING YEARLY DATA</div>
            <div class="loading-log">Total Spent: ï¿¥${parseFloat(archive.total_all).toLocaleString()}</div>
            <div class="loading-log" style="color:red;">WRITING 500 WORDS REPORT...</div>
        </div>
    `;

    // 3. ğŸ› ï¸ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ä»æ•°æ®åº“è¯»å–ç²¾å‡†äººè®¾
    let charName = window.currentVaultCharName || "Ta";
    let charBio = window.currentVaultCharBio || "æœªçŸ¥"; // é»˜è®¤å…œåº•

    try {
        // å°è¯•ä»æ•°æ®åº“åŠ è½½æœ€æ–°äººè®¾
        if (typeof loadFromDB === 'function') {
            const charList = await loadFromDB('char_list') || [];
            const targetChar = charList.find(c => c.id === charID);
            
            if (targetChar) {
                charName = targetChar.name;
                // ä¼˜å…ˆå– descï¼Œæ²¡æœ‰å†å– bioï¼Œç¡®ä¿äººè®¾æœ€ä¸°å¯Œ
                charBio = targetChar.desc || targetChar.bio || charBio;
                console.log(`[AI] å¹´åº¦æ•…äº‹ç”Ÿæˆ - å·²é”å®šäººè®¾: ${charName}`);
            }
        }
    } catch (e) {
        console.warn("è¯»å–äººè®¾å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¼“å­˜å€¼", e);
    }

    // 4. AI è°ƒç”¨ (Prompt å‡çº§)
    const systemPrompt = `ä½ æ˜¯ä¸€ä½æ“…é•¿å†™â€œè‡´éƒç³»â€æˆ–â€œç»†è…»æ•£æ–‡é£â€çš„å°è¯´å®¶ã€‚
    è¯·æ ¹æ®ç”¨æˆ·çš„å¹´åº¦è´¦å•æ€»é¢ï¼Œç»“åˆè§’è‰²èº«ä»½ï¼Œå†™ä¸€ç¯‡ã€500å­—å·¦å³ã€‘çš„å¹´åº¦æ€»ç»“æ•…äº‹ã€‚
    
    ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼š
    1. **å­—æ•°è¾¾æ ‡**ï¼šå¿…é¡»å†™æ»¡ 500 å­—ï¼Œå†…å®¹è¦åšé‡ï¼Œæ¶µç›–æ˜¥å¤ç§‹å†¬çš„æµè½¬ã€‚
    2. **æ ¸å¿ƒæƒ…æ„Ÿ**ï¼šæ¢è®¨é‡‘é’±èƒŒåéšè—çš„æƒ…æ„Ÿã€é—æ†¾ã€é™ªä¼´æˆ–ç‰ºç‰²ã€‚ä»¥â€œä½ â€å’Œâ€œæˆ‘â€çš„ç¾ç»Šä¸ºä¸»çº¿ã€‚
    3. **æ’ç‰ˆ**ï¼šå¿…é¡»ä½¿ç”¨ã€åŒæ¢è¡Œã€‘åˆ†æ®µï¼Œè®©æ–‡å­—åƒè¯—ä¸€æ ·æ’åˆ—ã€‚`;

    const userPrompt = `ä¸»è§’ï¼š${charName}
    äººè®¾ï¼š${charBio}
    è¿™ä¸€å¹´æ€»å…±èŠ±è´¹ï¼šï¿¥${archive.total_all}
    è¯·ä¸ºè¿™æ®µå…³ç³»å†™ä¸‹å¹´åº¦æ³¨è„šï¼Œå›é¡¾è¿™ä¸€å¹´çš„ç‚¹ç‚¹æ»´æ»´ã€‚`;

    try {
        const story = await callAIForStory(systemPrompt, userPrompt);
        const formatted = formatStoryText(story); // æ ¼å¼åŒ–æ¢è¡Œ
        
        // ğŸ’° å­˜å…¥ç¼“å­˜ï¼šä¸‹æ¬¡ç›´æ¥è¯»
        localStorage.setItem(cacheKey, formatted);
        
        container.innerHTML = `<div class="story-prose-text fade-in-text">${formatted}</div>`;
    } catch (e) {
        container.innerHTML = `<div style="color:red; text-align:center;">[CONNECTION ERROR]<br>${e.message}</div>`;
    }
};

/**
 * ğŸŒŸ 2. å“åº”â€œæœˆåº¦æ¡ç›®â€ç‚¹å‡» (300å­—æ‰©å†™ + ä¸¥æ ¼çœé’±ç¼“å­˜ç‰ˆ + ç²¾å‡†äººè®¾ä¿®æ­£)
 */
window.openYearlyMonthDetail = async function(yearIdx, monthIdx) {
    if(window.navigator.vibrate) window.navigator.vibrate(10);

    const archive = window.currentViewingYearlyData;
    if (!archive) return console.error("No archive data locked.");

    // å…¼å®¹å¤„ç†ï¼šç¡®ä¿æ•°æ®ç»“æ„æ­£ç¡®
    const dataArray = (archive.fullData && Array.isArray(archive.fullData)) ? archive.fullData : [archive.fullData];
    const targetYear = dataArray[yearIdx];
    const targetMonth = targetYear.months[monthIdx];

    // æ‰“å¼€å¼¹çª—
    const modal = document.getElementById('monthly-story-modal');
    const container = document.getElementById('month-story-content');
    const titleBg = document.getElementById('month-story-title');
    
    if(!modal) return console.error("ç¼ºå°‘ HTML: monthly-story-modal");

    modal.style.display = 'flex';
    titleBg.innerText = String(targetMonth.m).padStart(2, '0');

    // --- ğŸ’° çœé’±æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æœ¬åœ°ç¼“å­˜ ---
    const charID = window.currentVaultCharID || 'GLOBAL';
    // ç¼“å­˜ Key ä¿æŒä¸å˜
    const cacheKey = `LUNE_STORY_V2_${charID}_${targetYear.year}_${targetMonth.m}_${targetMonth.a}`;
    const cachedStory = localStorage.getItem(cacheKey);

    if (cachedStory) {
        console.log("ğŸ’° [çœé’±æ¨¡å¼] å‘½ä¸­æœ¬åœ°ç¼“å­˜ï¼Œä¸æ¶ˆè€— API é¢åº¦ã€‚");
        container.innerHTML = cachedStory; // ç›´æ¥æ˜¾ç¤ºå­˜å¥½çš„
        return; // ğŸš¨ ç›´æ¥ç»“æŸå‡½æ•°ï¼Œç»ä¸è¯·æ±‚ AI
    }

    // --- å¦‚æœæ²¡å­˜è¿‡ï¼Œæ‰å¾€ä¸‹èµ° ---

    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    container.innerHTML = `
        <div class="ai-generating-box" style="height:200px;">
            <div class="scan-bar-anim" style="width:50px;"></div>
            <div style="font-size:12px; font-weight:bold;">WRITING MEMORY (${targetMonth.m})...</div>
            <div class="loading-log" style="color:red;">READING NEURAL CLOUD...</div>
        </div>
    `;

    // 1. ğŸ› ï¸ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ä»æ•°æ®åº“è¯»å–ç²¾å‡†äººè®¾
    let charName = window.currentVaultCharName || "Ta";
    let charBio = "æœªçŸ¥"; // é»˜è®¤å…œåº•

    try {
        // å°è¯•ä»æ•°æ®åº“åŠ è½½æœ€æ–°äººè®¾
        if (typeof loadFromDB === 'function') {
            const charList = await loadFromDB('char_list') || [];
            const targetChar = charList.find(c => c.id === charID);
            
            if (targetChar) {
                charName = targetChar.name;
                // ä¼˜å…ˆå– desc (è¯¦ç»†äººè®¾)ï¼Œæ²¡æœ‰å†å– bio
                charBio = targetChar.desc || targetChar.bio || charBio;
                console.log(`[AI] æœˆåº¦æ•…äº‹ç”Ÿæˆ - å·²é”å®šäººè®¾: ${charName}`);
            }
        }
    } catch (e) {
        console.warn("è¯»å–äººè®¾å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¼“å­˜å€¼", e);
    }

    // 2. ğŸš€ å‡çº§ç‰ˆ Promptï¼šæ³¨å…¥äº† charBio
    const systemPrompt = `ä½ æ˜¯ä¸€åæ“…é•¿â€œç‹å®¶å«é£æ ¼â€æˆ–â€œä¼¤ç—›æ–‡å­¦â€çš„å°è¯´å®¶ã€‚
    ä½ ç°åœ¨çš„ä»£å…¥è§’è‰²æ˜¯ï¼š${charName}ã€‚
    è§’è‰²çš„æ ¸å¿ƒäººè®¾èƒŒæ™¯æ˜¯ï¼š${charBio}ã€‚
    
    è¯·æ ¹æ®ç”¨æˆ·çš„å•æœˆè´¦å•ï¼Œç»“åˆä¸Šè¿°äººè®¾ï¼Œæ‰©å†™ä¸€ä¸ª**å…·ä½“çš„ã€ç”»é¢æ„Ÿæå¼º**çš„ç”Ÿæ´»ç‰‡æ®µã€‚
    
    ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼š
    1. **å­—æ•°å¿…é¡»å……å®**ï¼šä¸¥æ ¼æ§åˆ¶åœ¨ 300 å­—å·¦å³ï¼Œç¦æ­¢å°‘äº 200 å­—ã€‚
    2. **äººè®¾ä¸€è‡´æ€§**ï¼šå¿…é¡»ä½“ç°å‡ºäººè®¾ä¸­çš„æ€§æ ¼ï¼ˆå¦‚ï¼š${charBio.substring(0, 10)}...ï¼‰å’Œè¯­æ°”ã€‚
    3. **æ‹’ç»æµæ°´è´¦**ï¼šä¸è¦åªç½—åˆ—ä¹°äº†ä»€ä¹ˆï¼Œè€Œæ˜¯å†™â€œä¸ºä»€ä¹ˆä¹°â€ä»¥åŠâ€œä¹°çš„æ—¶å€™åœ¨æƒ³ä»€ä¹ˆâ€ï¼ŒæŒ–æ˜é‡‘é’±èƒŒåçš„æƒ…æ„Ÿã€‚
    4. **æ’ç‰ˆ**ï¼šå¿…é¡»ä½¿ç”¨ã€åŒæ¢è¡Œã€‘åˆ†æ®µï¼Œè¥é€ å‘¼å¸æ„Ÿã€‚`;

    const userPrompt = `æ—¶é—´ï¼š${targetYear.year}å¹´ ${targetMonth.m}æœˆ
    é‡‘é¢ï¼šï¿¥${targetMonth.a}
    å¤‡æ³¨çº¿ç´¢ï¼š${targetMonth.n || 'ï¼ˆæ— å¤‡æ³¨ï¼Œè¯·æ ¹æ®é‡‘é¢å’Œäººè®¾è‡ªè¡Œæƒ³è±¡æ˜¯å­¤ç‹¬çš„å¤œå®µã€æ˜‚è´µçš„ç¤¼ç‰©ã€è¿˜æ˜¯åŒ»é™¢çš„è´¦å•ï¼‰'}
    
    è¯·ä»¥â€œæˆ‘â€çš„ç¬¬ä¸€äººç§°ï¼ŒæŠŠè¿™ç¬”å¼€é”€è¿˜åŸæˆä¸€ä¸ªè¿™å°±å‘ç”Ÿåœ¨æ˜¨å¤©çš„æ•…äº‹ã€‚`;

    try {
        // è°ƒç”¨ AI (ä½¿ç”¨æ‚¨ç°æœ‰çš„ callAIForStory å°è£…å‡½æ•°)
        const story = await callAIForStory(systemPrompt, userPrompt);
        
        // æ ¼å¼åŒ–æ¢è¡Œ
        const formatted = formatStoryText(story);
        
        // ğŸ’° å­˜å…¥ç¼“å­˜ï¼šä¸‹æ¬¡ç‚¹è¿™ä¸ªæœˆï¼Œç»å¯¹ä¸ä¼šå†èŠ±é’±
        localStorage.setItem(cacheKey, formatted);
        
        container.innerHTML = `<div class="story-prose-text fade-in-text">${formatted}</div>`;
        
    } catch (e) {
        container.innerHTML = `<div style="padding:20px; text-align:center; opacity:0.6;">ä¿¡å·ä¸­æ–­...<br>${e.message}</div>`;
    }
};

// å…³é—­å‡½æ•°
window.closeAnnualStory = () => document.getElementById('annual-story-modal').style.display = 'none';
window.closeMonthlyStory = () => document.getElementById('monthly-story-modal').style.display = 'none';

// å…¨å±€æš‚å­˜å˜é‡ï¼šç¡®ä¿å±‚çº§ä¹‹é—´ ID ä¸ä¸¢å¤±
window.currentViewingArchiveId = null;

/**
 * ğŸš€ ç¬¬ä¸€å±‚å…¥å£ï¼šç‚¹å‡»é¦–é¡µé»‘è‰²å¡ç‰‡ -> æ˜¾ç¤ºã€å¹´åº¦æ€»è§ˆ (é•¿æ”¶æ®)ã€‘
 * å¯¹åº” HTML ID: yearly-overview-modal
 */
window.viewYearlyDetail = function(archiveId) {
    console.log("è¿›å…¥ç¬¬ä¸€å±‚: å¹´åº¦æ€»è§ˆ (æ”¶æ®æ ·å¼)", archiveId);
    
    // 1. é”å®šå­˜æ¡£ ID
    window.currentViewingArchiveId = archiveId;

    const charID = window.currentVaultCharID || 'GLOBAL';
    const list = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];
    const archive = list.find(a => a.id === archiveId);
    
    if (!archive) return console.warn("æœªæ‰¾åˆ°å­˜æ¡£");

    // 2. ğŸš¨ é”å®šã€ç¬¬ä¸€å±‚ã€‘çš„å®¹å™¨ (æ³¨æ„ ID æ˜¯ overview)
    const container = document.getElementById('yearly-overview-container');
    const modal = document.getElementById('yearly-overview-modal');

    if (!container || !modal) return console.error("ç¼ºå°‘ HTML: yearly-overview-modal");

    // 3. æ¸²æŸ“é•¿æ”¶æ®æ ·å¼ (Receipt Style)
    let htmlContent = "";
    const dataArray = (archive.fullData && Array.isArray(archive.fullData)) ? archive.fullData : [];

    htmlContent = dataArray.map(yearObj => `
        <div class="industrial-receipt" style="margin-bottom: 20px; background: #fff; border: 2px solid #000; padding: 15px; box-shadow: 5px 5px 0 rgba(0,0,0,0.1);">
            <div class="receipt-header" style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px;">
                <div class="cinzel-font" style="font-size:12px; opacity:0.6; letter-spacing: 2px;">ARCHIVED_RECEIPT</div>
                <div class="cinzel-font" style="font-size:32px; font-weight:900; margin:5px 0;">FY_${yearObj.year}</div>
                <div style="font-family: monospace; font-size: 9px;">REF: ${archiveId.slice(-6).toUpperCase()}</div>
            </div>
            
            <div class="receipt-body">
                ${yearObj.months.map(m => `
                    <div class="receipt-row" style="display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <span style="font-weight:900; font-family:'Cinzel';">M . ${String(m.m).padStart(2,'0')}</span>
                        <span style="font-family:'Cinzel';">ï¿¥${parseFloat(m.a).toLocaleString()}</span>
                    </div>
                `).join('')}
            </div>

            <div class="receipt-total-row" style="background:#000; color:#fff; padding: 10px; margin-top: 15px; display: flex; justify-content: space-between;">
                <span style="letter-spacing:1px; font-size:10px;">YEAR_TOTAL</span>
                <span class="cinzel-font" style="font-weight:900;">-ï¿¥${parseFloat(yearObj.total).toLocaleString()}</span>
            </div>
        </div>
    `).join('');

    // 4. æ˜¾ç¤ºç¬¬ä¸€å±‚
    container.innerHTML = htmlContent;
    modal.style.display = 'flex'; 
    
    if(window.navigator.vibrate) window.navigator.vibrate(10);
};

/**
 * ğŸš€ ç¬¬äºŒå±‚è·³è½¬ï¼šç‚¹å‡»â€œæŸ¥çœ‹æ‹†è§£â€æŒ‰é’® -> æ˜¾ç¤ºã€12ä¸ªæœˆåº¦æ¡ç›® (äº¤äº’ç‰ˆ)ã€‘
 * å¯¹åº” HTML ID: yearly-history-modal
 */
window.enterYearlySecondLayer = function() {
    // 1. å…³é—­ç¬¬ä¸€å±‚
    document.getElementById('yearly-overview-modal').style.display = 'none';

    // 2. è·å–æ•°æ®
    const archiveId = window.currentViewingArchiveId;
    if (!archiveId) return;

    const charID = window.currentVaultCharID || 'GLOBAL';
    const list = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];
    const archive = list.find(a => a.id === archiveId);

    // ğŸš¨ å…³é”®ï¼šé”å®šæ•°æ®ç»™ç¬¬ä¸‰å±‚(AIæ•…äº‹)ä½¿ç”¨
    window.currentViewingYearlyData = archive;

    // 3. ğŸš¨ é”å®šã€ç¬¬äºŒå±‚ã€‘çš„å®¹å™¨ (æ³¨æ„ ID æ˜¯ history)
    const container = document.getElementById('yearly-history-container');
    const modal = document.getElementById('yearly-history-modal');

    if (!container || !modal) return console.error("ç¼ºå°‘ HTML: yearly-history-modal");

    // 4. æ¸²æŸ“ 12 ä¸ªç‹¬ç«‹äº¤äº’æ¡ (Strips Style)
    let htmlContent = "";
    const dataArray = (archive.fullData && Array.isArray(archive.fullData)) ? archive.fullData : [];

    dataArray.forEach((yearObj, yearIdx) => {
        // å¹´ä»½å¤§æ ‡é¢˜
        htmlContent += `
            <div style="text-align:center; margin: 10px 0 5px 0; font-family:'Cinzel'; font-weight:900; font-size:20px; opacity:0.4;">FY_${yearObj.year}</div>
        `;
        // 12ä¸ªæ¡
        yearObj.months.forEach((m, monthIdx) => {
            htmlContent += `
                <div class="month-strip-item" 
                     onclick="window.openYearlyMonthDetail(${yearIdx}, ${monthIdx})"
                     style="display: flex; align-items: stretch; background: #fff; border: 2px solid #000; min-height: 60px; margin-bottom: 0; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); cursor: pointer;">
                    
                    <div class="strip-left" style="background: #000; color: #fff; width: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-shrink: 0;">
                        <span style="font-size: 8px; font-family: monospace; opacity: 0.7;">M</span>
                        <span style="font-family: 'Cinzel'; font-weight: 900; font-size: 20px;">${String(m.m).padStart(2, '0')}</span>
                    </div>

                    <div class="strip-center" style="flex: 1; padding: 0 15px; display: flex; align-items: center; overflow: hidden;">
                        <div style="font-size: 12px; color: #444; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;">
                            ${m.n || 'No Details'}
                        </div>
                    </div>

                    <div class="strip-right" style="padding-right: 15px; display: flex; align-items: center;">
                        <div style="font-family: 'Cinzel'; font-weight: 900; font-size: 14px; color: #000;">
                            ï¿¥${parseFloat(m.a).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
        });
    });

    // 5. æ˜¾ç¤ºç¬¬äºŒå±‚
    container.innerHTML = htmlContent;
    modal.style.display = 'flex';
    
    if(window.navigator.vibrate) window.navigator.vibrate(10);
};

// ç®€å•çš„å…³é—­å‡½æ•°
window.closeYearlyOverview = () => document.getElementById('yearly-overview-modal').style.display = 'none';

/**
 * ğŸ”™ å…³é—­ç¬¬äºŒå±‚ (12æ¡ç›®é¡µ) -> è¿”å›ç¬¬ä¸€å±‚ (æ€»è§ˆé¡µ)
 */
window.closeYearlyHistory = function() {
    // 1. å…³é—­å½“å‰çš„ç¬¬äºŒå±‚
    document.getElementById('yearly-history-modal').style.display = 'none';
    
    // 2. é‡æ–°æ‰“å¼€ç¬¬ä¸€å±‚ (å®ç°â€œè¿”å›â€æ•ˆæœ)
    const layer1 = document.getElementById('yearly-overview-modal');
    if (layer1) {
        layer1.style.display = 'flex';
        
        // å¯é€‰ï¼šåŠ ä¸ªéœ‡åŠ¨åé¦ˆï¼Œæ›´æœ‰è´¨æ„Ÿ
        if(window.navigator.vibrate) window.navigator.vibrate(10);
    }
};

// âš¡ï¸ æœ€ç»ˆä¿é™©ä¸ï¼šé¡µé¢åŠ è½½å®Œæ¯•åï¼Œè‡ªåŠ¨ç‚¹ç«
document.addEventListener('DOMContentLoaded', () => {
    // 1. åˆå§‹åŒ–ç³»ç»ŸæœåŠ¡ (IndexedDB ç­‰)
    if (typeof initSystemServices === 'function') initSystemServices();

    // 2. æ¸²æŸ“ç”µè¯å¡ (åˆ°æ¨ªå‘åˆ—è¡¨)
    if(typeof renderSimPage === 'function') renderSimPage();
    
    // 2. å»¶è¿Ÿ 200ms ç¡®ä¿æ•°æ®è¯»å–å®Œæ¯•ï¼Œç„¶åå¼ºåˆ¶æ¸²æŸ“é¦–é¡µ
    setTimeout(() => {
        const dashPanel = document.getElementById('tab-dashboard');
        // å¦‚æœå½“å‰ç¡®å®åœç•™åœ¨ Dashboard é¡µï¼Œå°±è§¦å‘æ¸²æŸ“
        if (dashPanel && (dashPanel.classList.contains('active') || getComputedStyle(dashPanel).display !== 'none')) {
            if (typeof window.triggerDashboardInit === 'function') {
                window.triggerDashboardInit();
            }
        }
    }, 200);
});
/**
 * ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šDashboard åˆå§‹åŒ–æ‰³æœº
 * ä¸“é—¨è§£å†³â€œå¿…é¡»åˆ‡ä¸€ä¸‹æ‰æ˜¾ç¤ºâ€çš„ Bug
 */
window.triggerDashboardInit = function() {
    console.log("[ç³»ç»Ÿ] æ­£åœ¨å¼ºåˆ¶åˆå§‹åŒ–æœˆåº¦çœ‹æ¿...");

    // 1. å¼ºåˆ¶é€‰ä¸­â€œæœˆåº¦â€Tab UI
    const monthlyTab = document.querySelector('.consumption-switcher-tabs .con-tab:first-child');
    const yearlyTab = document.querySelector('.consumption-switcher-tabs .con-tab:last-child');
    
    if (monthlyTab) monthlyTab.classList.add('active');
    if (yearlyTab) yearlyTab.classList.remove('active');

    // 2. å¼ºåˆ¶æ˜¾ç¤ºâ€œæœˆåº¦â€é¢æ¿ DOM (ç‰©ç†æ˜¾ç¤º)
    const mPanel = document.getElementById('view-monthly');
    const yPanel = document.getElementById('view-yearly');

    if (mPanel) {
        mPanel.classList.add('active');
        mPanel.style.cssText = "display: block !important; opacity: 1 !important;";
    }
    if (yPanel) {
        yPanel.classList.remove('active');
        yPanel.style.display = 'none';
    }

    // 3. âš¡ï¸ æ ¸å¿ƒï¼šä¸»åŠ¨è§¦å‘æ•°æ®åŒæ­¥ (å°±æ˜¯è¿™ä¸€æ­¥ä¹‹å‰æ²¡è·‘ï¼)
    // ç¨å¾®å»¶è¿Ÿ 10ms ç¡®ä¿ DOM å·²ç»å‡ºæ¥äº†
    setTimeout(() => {
        if (typeof window.forceRenderMonthly === 'function') {
            window.forceRenderMonthly(); // å¦‚æœä½ ç”¨äº†ä¹‹å‰çš„æ ¸å¼¹è¡¥ä¸
        } else if (typeof window.syncVaultDataToUI === 'function') {
            window.syncVaultDataToUI();  // å¦‚æœä½ ç”¨çš„æ˜¯æ ‡å‡†åŒæ­¥
        }
    }, 10);
};

/**
 * ğŸ’¥ æ ¸å¼¹çº§ä¿®å¤ï¼šå¼ºåˆ¶æ¸²æŸ“æœˆåº¦æ•°æ® (å«æ¸…åœºé€»è¾‘)
 */
window.forceRenderMonthly = function() {
    console.log("ğŸ”¥ [æ ¸å¼¹ä¿®å¤] æ‰§è¡Œæœˆåº¦å¼ºåˆ¶æ¸²æŸ“...");

    const charID = window.currentVaultCharID || localStorage.getItem('LUNE_LAST_ACTIVE_CHAR_ID') || 'GLOBAL';
    const monthlyList = JSON.parse(localStorage.getItem(`LUNE_VAULT_LIST_${charID}`)) || [];
    
    const container = document.getElementById('dash-monthly-cards-container');
    const mPanel = document.getElementById('view-monthly');
    const yPanel = document.getElementById('view-yearly'); // è·å–å¹´åº¦é¢æ¿
    const displayNum = document.getElementById('dash-monthly-outflow');

    if (!container || !mPanel) return;

    // 1. ğŸ§¹ è¿™é‡Œçš„æ¸…åœºä¹Ÿå¾ˆå…³é”®ï¼šä¸€å®šè¦å†æ¬¡ç¡®ä¿å¹´åº¦é¢æ¿æ˜¯å…³æ‰çš„ï¼
    if (yPanel) {
        yPanel.classList.remove('active');
        yPanel.style.cssText = "display: none !important;";
    }

    // 2. å¼ºå¼€æœˆåº¦
    mPanel.classList.add('active');
    mPanel.style.cssText = "display: block !important; opacity: 1 !important; visibility: visible !important;";

    // 3. æ³¨å…¥æ•°æ®
    if (monthlyList.length > 0) {
        container.innerHTML = monthlyList.map(arc => `
            <div class="archive-card-bw" onclick="window.loadSpecificArchiveFromList('${arc.id}')" 
                 style="flex: 0 0 140px; background: #fff; border: 2px solid #000; padding: 12px; margin-right: 15px; cursor: pointer; box-shadow: 4px 4px 0 rgba(0,0,0,0.1);">
                <span class="card-tag" style="font-size:8px; color:#888; display:block;">#LOG_${String(arc.id).slice(-4)}</span>
                <div class="card-month" style="font-family:'Cinzel'; font-weight:900; font-size:14px; margin:5px 0; border-bottom:1px solid #eee; padding-bottom:5px;">
                    ${arc.year} / ${arc.data ? arc.data.length : 0}M
                </div>
                <div class="card-val" style="font-family:'Cinzel'; font-weight:900; font-size:16px; margin-top:5px;">
                    ï¿¥${parseFloat(arc.total || 0).toLocaleString()}
                </div>
            </div>
        `).join('');
        
        if (displayNum) displayNum.innerText = `-ï¿¥${parseFloat(monthlyList[0].total).toLocaleString()}`;
    } else {
        container.innerHTML = `<div style="padding:20px; text-align:center; font-size:10px; color:#999; width:100%;">NO DATA // æš‚æ— æ•°æ®</div>`;
    }
    
    // 4. çº æ­£ Tab çŠ¶æ€
    document.querySelectorAll('.con-tab').forEach(t => t.classList.remove('active'));
    const mTab = document.querySelector('.consumption-switcher-tabs .con-tab:first-child');
    if (mTab) mTab.classList.add('active');
};

/**
 * ğŸ”• å®‰å…¨éœ‡åŠ¨åè®®ï¼šæ¶ˆé™¤ Chrome æ§åˆ¶å°çº¢å­—è­¦å‘Š
 * åªæœ‰å½“æ£€æµ‹åˆ°ç”¨æˆ·å·²ç»å‘ç”Ÿè¿‡äº¤äº’ï¼ˆç‚¹å‡»/è§¦æ‘¸ï¼‰åï¼Œæ‰æ‰§è¡Œéœ‡åŠ¨
 */
window.safeVibrate = function(ms) {
    // 1. ç°ä»£æµè§ˆå™¨æ£€æµ‹ï¼šå¦‚æœç”¨æˆ·è¿˜æ²¡ç‚¹è¿‡å±å¹•ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸ç»™æµè§ˆå™¨æŠ¥é”™çš„æœºä¼š
    if (navigator.userActivation && !navigator.userActivation.hasBeenActive) {
        // console.log("é™é»˜æ¨¡å¼ï¼šç”¨æˆ·å°šæœªäº¤äº’ï¼Œè·³è¿‡éœ‡åŠ¨");
        return; 
    }

    // 2. æ‰§è¡Œéœ‡åŠ¨
    if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(ms);
    }
};
/**
 * ğŸ”„ åº•éƒ¨å¯¼èˆªåˆ‡æ¢å‡½æ•° (æš´åŠ›å¼ºåˆ¶ç‰ˆ)
 * ç›´æ¥ä¿®æ”¹ style.displayï¼Œç¡®ä¿é¡µé¢ä¸€å®šèƒ½æ˜¾ç¤º
 */
window.switchBankTab = function(index, btnElement) {
    // 1. æ‰¾åˆ°æ‰€æœ‰é¢æ¿
    const panels = document.querySelectorAll('.bank-tab-panel');
    
    // 2. å…ˆæŠŠæ‰€æœ‰é¢æ¿â€œç‰©ç†éšè—â€
    panels.forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none'; // ğŸš¨ å¼ºåˆ¶éšè—ï¼Œè¦†ç›– HTML é‡Œçš„ style
    });
    
    // 3. åªæ˜¾ç¤ºé€‰ä¸­çš„é‚£ä¸ª
    if (panels[index]) {
        panels[index].classList.add('active');
        panels[index].style.display = 'block'; // ğŸš¨ å¼ºåˆ¶æ˜¾ç¤º
        
        // å¦‚æœæœ‰æ»šåŠ¨æ¡ï¼Œé‡ç½®åˆ°é¡¶éƒ¨
        const scrollBox = panels[index].querySelector('.scroll-box');
        if (scrollBox) scrollBox.scrollTop = 0;
    } else {
        console.error("æ‰¾ä¸åˆ°ç¬¬ " + index + " ä¸ªé¡µé¢ (index out of bounds)");
    }

    // 4. åº•éƒ¨æŒ‰é’®é«˜äº®åˆ‡æ¢
    const navItems = document.querySelectorAll('.nav-b-item');
    navItems.forEach(n => n.classList.remove('active'));
    
    if (btnElement) {
        btnElement.classList.add('active');
    } else if (navItems[index]) {
        navItems[index].classList.add('active');
    }

    // ğŸš¨ å…³é”®æ–°å¢ï¼šå¦‚æœæ˜¯åˆ‡åˆ°â€œè®°å½•é¡µâ€ (index 1)ï¼Œå¼ºåˆ¶åˆ·æ–°åˆ—è¡¨
    if (index === 1) {
        console.log("è¿›å…¥è®°å½•é¡µï¼Œæ­£åœ¨åˆ·æ–°æ•°æ®...");
        if (typeof renderCharExpenseList === 'function') {
            renderCharExpenseList();
        }
        // å¦‚æœä»¥åæœ‰ç”µè¯è´¦å•çš„æ¸²æŸ“å‡½æ•°ï¼Œä¹Ÿåœ¨è¿™é‡Œè°ƒç”¨
        // renderPhoneBillList(); 
    }

    // åœ¨ switchBankTab é‡ŒåŠ ä¸€å¥
    if (index === 2) { // å‡è®¾ Vault æ˜¯ç¬¬3ä¸ª tab
        initVaultTab();
    }
    
    if(window.navigator.vibrate) window.navigator.vibrate(10);
};

/**
 * ğŸ”„ è§†å›¾åˆ‡æ¢æ§åˆ¶å™¨ (æ¸…åœºä¿®å¤ç‰ˆ)
 * æ ¸å¿ƒé€»è¾‘ï¼šå…ˆæ€å…‰ï¼Œå†å¤æ´»ã€‚ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªé¢æ¿å­˜æ´»ã€‚
 */
window.toggleConsumptionView = function(viewType, btnEl) {
    // 1. æŒ‰é’®é«˜äº®å¤„ç†
    document.querySelectorAll('.con-tab').forEach(t => t.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');

    const mPanel = document.getElementById('view-monthly');
    const yPanel = document.getElementById('view-yearly');

    // 2. ğŸ§¹ æš´åŠ›æ¸…åœºï¼šä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œå…ˆæŠŠä¸¤ä¸ªéƒ½æŒ‰æ­» (display: none)
    // è¿™ä¸€æ­¥æ˜¯è§£å†³â€œé‡å /å¹½çµæ˜¾ç¤ºâ€çš„å…³é”®
    if (mPanel) {
        mPanel.classList.remove('active');
        mPanel.style.cssText = "display: none !important;";
    }
    if (yPanel) {
        yPanel.classList.remove('active');
        yPanel.style.cssText = "display: none !important;";
    }

    // 3. ğŸ¯ å®šç‚¹å¤æ´»ï¼šåªæ‰“å¼€é€‰ä¸­çš„é‚£ä¸ª
    if (viewType === 'monthly') {
        if (mPanel) {
            mPanel.classList.add('active');
            mPanel.style.cssText = "display: block !important; opacity: 1 !important;";
        }
        
        // è§¦å‘æœˆåº¦æ¸²æŸ“
        if (typeof window.forceRenderMonthly === 'function') {
            window.forceRenderMonthly();
        } else if (typeof window.syncVaultDataToUI === 'function') {
            window.syncVaultDataToUI();
        }

    } else { // viewType === 'yearly'
        if (yPanel) {
            yPanel.classList.add('active');
            yPanel.style.cssText = "display: block !important; opacity: 1 !important;";
        }
        
        // è§¦å‘å¹´åº¦æ¸²æŸ“ (è¿™é‡Œç¡®ä¿åªæ¸²æŸ“å¹´åº¦æ•°æ®)
        if (typeof window.syncVaultDataToUI === 'function') {
            // è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¸ºäº†å¹´åº¦å†åšä¸€æ¬¡æŒ‡å‘æ€§æ¸²æŸ“ï¼Œé˜²æ­¢ syncVaultDataToUI å†…éƒ¨åˆ¤æ–­å¤±è¯¯
            // å¼ºåˆ¶è¯»å–å¹´åº¦åˆ—è¡¨
            const charID = window.currentVaultCharID || 'GLOBAL';
            const yearlyList = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];
            const yContainer = document.getElementById('dash-yearly-cards-container');
            
            if (yContainer && yearlyList.length > 0) {
                 yContainer.innerHTML = yearlyList.map(arc => `
                    <div class="archive-card-bw" style="background:#000; color:#fff; min-width:160px; margin-right:10px;" onclick="window.viewYearlyDetail('${arc.id}')">
                        <span class="card-tag" style="color:#666;">#ANNUAL</span>
                        <div class="card-month" style="color:#fff;">${arc.years_covered.join('-')}</div>
                        <div class="card-val" style="color:#fff;">ï¿¥${parseFloat(arc.total_all).toLocaleString()}</div>
                    </div>`).join('');
            } else if (yContainer) {
                yContainer.innerHTML = `<div class="empty-placeholder">NO ANNUAL DATA</div>`;
            }
        }
    }
    
    if(window.safeVibrate) window.safeVibrate(5);
};

/**
 * ğŸ” ä¸­å¤®é‡‘åº“ï¼šç»ˆææ¸²æŸ“åŒæ­¥åè®® (ä¿®å¤ç‰ˆ)
 */
window.syncVaultDataToUI = function() {
    const charID = window.currentVaultCharID || localStorage.getItem('LUNE_LAST_ACTIVE_CHAR_ID') || 'GLOBAL';
    
    // --- A. æ¸²æŸ“æœˆåº¦ (Monthly) ---
    // åªæœ‰å½“æœˆåº¦é¢æ¿æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œæˆ–è€…å¤„äºåˆå§‹åŒ–é˜¶æ®µæ—¶ï¼Œæ‰å»åŠ¨å®ƒ
    const monthlyPanel = document.getElementById('view-monthly');
    if (monthlyPanel && (monthlyPanel.style.display !== 'none' || monthlyPanel.classList.contains('active'))) {
        const monthlyList = JSON.parse(localStorage.getItem(`LUNE_VAULT_LIST_${charID}`)) || [];
        const monthlyContainer = document.getElementById('dash-monthly-cards-container');
        
        if (monthlyContainer) {
            monthlyContainer.innerHTML = monthlyList.length > 0 
                ? monthlyList.map(arc => `
                    <div class="archive-card-bw" onclick="window.loadSpecificArchiveFromList('${arc.id}')" style="min-width:140px; margin-right:10px;">
                        <span class="card-tag">#LOG_${String(arc.id).slice(-4)}</span>
                        <div class="card-month">${arc.year} / ${arc.data ? arc.data.length : 0}M</div>
                        <div class="card-val">ï¿¥${parseFloat(arc.total || 0).toLocaleString()}</div>
                    </div>`).join('')
                : `<div class="empty-placeholder">NO ARCHIVES // æš‚æ— æœˆåº¦è®°å½•</div>`;
        }
    }

    // --- B. æ¸²æŸ“å¹´åº¦ (Yearly) ---
    // ğŸš¨ å…³é”®ï¼šè¿™é‡Œå¿…é¡»å…¨æ˜¯ yearly ç›¸å…³çš„å˜é‡ï¼Œä¸¥ç¦å‡ºç° monthly
    const yearlyPanel = document.getElementById('view-yearly');
    // åªæœ‰å¹´åº¦é¢æ¿æ˜¾ç¤ºæ—¶æ‰æ¸²æŸ“ï¼ŒèŠ‚çœèµ„æº
    if (yearlyPanel && (yearlyPanel.style.display !== 'none' || yearlyPanel.classList.contains('active'))) {
        const yearlyList = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];
        const yearlyContainer = document.getElementById('dash-yearly-cards-container');

        if (yearlyContainer) {
            yearlyContainer.innerHTML = yearlyList.length > 0 
                ? yearlyList.map(arc => `
                    <div class="archive-card-bw" style="background:#000; color:#fff; min-width:160px; margin-right:10px;" onclick="window.viewYearlyDetail('${arc.id}')">
                        <span class="card-tag" style="color:#666;">#ANNUAL</span>
                        <div class="card-month" style="color:#fff;">${arc.years_covered.join('-')}</div>
                        <div class="card-val" style="color:#fff;">ï¿¥${parseFloat(arc.total_all).toLocaleString()}</div>
                    </div>`).join('')
                : `<div class="empty-placeholder">NO ANNUAL DATA // æš‚æ— å¹´åº¦è®°å½•</div>`;
        }
    }
};

/**
 * ğŸ” ä¸­å¤®é‡‘åº“ï¼šå…¨é‡åŒæ­¥åè®® (è§£å†³åˆ·æ–°æ•°æ®æ¶ˆå¤±)
 */
window.syncVaultDisplay = function() {
    const charID = window.currentVaultCharID || 'GLOBAL';
    
    // 1. åŒæ­¥æœˆåº¦æ”¯å‡ºæ•°å­—
    const monthlyList = JSON.parse(localStorage.getItem(`LUNE_VAULT_LIST_${charID}`)) || [];
    const monthlyDisplayEl = document.getElementById('dash-monthly-outflow'); 
    if (monthlyDisplayEl && monthlyList.length > 0) {
        // å–æœ€æ–°çš„ä¸€ä»½å­˜æ¡£
        const latestMonthly = monthlyList[0]; 
        monthlyDisplayEl.innerText = `-ï¿¥${parseFloat(latestMonthly.total).toLocaleString()}`;
    }

    // 2. åŒæ­¥å¹´åº¦æ”¯å‡ºæ•°å­—
    const yearlyList = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];
    const yearlyDisplayEl = document.querySelector('#view-yearly .val'); // å¯¹åº”ä½ å¹´åº¦é¢æ¿é‡Œçš„é‚£ä¸ª -ï¿¥5,100
    if (yearlyDisplayEl && yearlyList.length > 0) {
        const latestYearly = yearlyList[0];
        yearlyDisplayEl.innerText = `-ï¿¥${parseFloat(latestYearly.total_all).toLocaleString()}`;
    }

    // 3. åŒæ—¶è§¦å‘åˆ—è¡¨æ¸²æŸ“
    if (typeof window.refreshDashMonthlyCards === 'function') window.refreshDashMonthlyCards();
    if (typeof window.refreshDashYearlyCards === 'function') window.refreshDashYearlyCards();
};

// è¾…åŠ©ï¼šæ›´æ–°æ»‘åŠ¨æ¡æ–‡å­—
window.updateYearRangeText = (v) => document.getElementById('y-range-val').innerText = v + " YEAR(S)";

window.yearlyDetailAction = () => document.getElementById('yearly-config-modal').style.display = 'flex';
window.closeYearlyConfig = () => document.getElementById('yearly-config-modal').style.display = 'none';
window.closeYearlyReport = () => document.getElementById('yearly-report-display').style.display = 'none';

/**
 * æ ¸å¿ƒï¼šç”Ÿæˆå¹´åº¦æŠ¥å‘Š (äººè®¾åŒæ­¥ + å…¼å®¹æ€§ä¿®å¤ç‰ˆ)
 */
window.generateYearlyReport = async function() {
    const startYear = parseInt(document.getElementById('y-config-year').value);
    const span = parseInt(document.getElementById('y-config-range').value);
    const charID = window.currentVaultCharID || 'GLOBAL';
    
    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    window.closeYearlyConfig();
    const overlay = document.createElement('div');
    overlay.className = "vault-decrypting-overlay";
    overlay.innerHTML = `<div class="v-scan-line"></div><div class="v-loading-text">DECRYPTING_ANNUAL_FILES</div>`;
    document.body.appendChild(overlay);

    // 1. ğŸ› ï¸ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ä»æ•°æ®åº“è¯»å–ç²¾å‡†äººè®¾
    let charName = window.currentVaultCharName || "Ta";
    let charBio = "æœªçŸ¥èº«ä¸–"; // é»˜è®¤å…œåº•

    try {
        if (typeof loadFromDB === 'function') {
            const charList = await loadFromDB('char_list') || [];
            const targetChar = charList.find(c => c.id === charID);
            
            if (targetChar) {
                charName = targetChar.name;
                // ä¼˜å…ˆå– descï¼Œæ²¡æœ‰å†å– bio
                charBio = targetChar.desc || targetChar.bio || charBio;
                console.log(`[AI] å¹´åº¦æŠ¥å‘Šç”Ÿæˆ - å·²é”å®šäººè®¾: ${charName}`);
            }
        }
    } catch (e) {
        console.warn("è¯»å–äººè®¾å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¼“å­˜å€¼", e);
    }

    // 2. å‡†å¤‡ API
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    // ğŸš¨ è‡ªåŠ¨ä¿®æ­£ï¼šå¦‚æœæ˜¯ DeepSeekï¼Œå¼ºåˆ¶åˆ‡æ¢æ¨¡å‹å
    if (apiUrl.includes("deepseek")) {
        console.log("æ£€æµ‹åˆ° DeepSeek ç¯å¢ƒï¼Œè‡ªåŠ¨ä¿®æ­£æ¨¡å‹åç§°...");
        model = "deepseek-chat"; 
    }

    // 3. Prompt è®¾è®¡ï¼šæ³¨å…¥äººè®¾
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå†·å³»ã€æ¯’èˆŒä¸”è§‚å¯Ÿå…¥å¾®çš„è´¢åŠ¡å®¡è®¡å‘˜ã€‚
    ä½ å¿…é¡»è¾“å‡ºä¸¥æ ¼çš„ JSON æ•°ç»„ã€‚
    
    ã€è§„åˆ™é”å®šã€‘ï¼š
    1. æ¯å¹´12ä¸ªæœˆçš„é‡‘é¢ (amount) ä¸¥ç¦é‡å¤ï¼Œå¿…é¡»å¤§å¹…éšæœºæ³¢åŠ¨ã€‚
    2. æ¯ä¸ªæœˆçš„æ‘˜è¦ (n) å¿…é¡»æ˜¯ä¸°å¯Œçš„çŸ­å¥ï¼Œ**å¿…é¡»ç´§æ‰£ä¸»è§’çš„äººè®¾èƒŒæ™¯**ï¼Œæè¿°è¿™ç¬”é’±èƒŒåçš„æ•…äº‹ï¼ˆå¦‚ï¼šæ·±å¤œçš„ä¾¿åˆ©åº—ã€æ„å¤–çš„åŒ»è¯è´¹ã€ä¸€å¼ å»å¾€è¿œæ–¹çš„å•ç¨‹ç¥¨ã€æˆ–æ˜¯æŸæ¬¡æ— å£°çš„å‘Šåˆ«ï¼‰ã€‚
    3. è¯­æ°”è¦å†·å³»ä¸”å…·å¤‡å·¥ä¸šé…¸æ¶©æ„Ÿï¼Œç¦æ­¢ä½¿ç”¨å¯çˆ±çš„è¡¨æƒ…ç¬¦å·ã€‚
    4. ä¸¥ç¦åŒ…å« Markdown æ ‡è®° (ä¸è¦å†™ \`\`\`json)ã€‚
    
    æ ¼å¼: [{"year":å¹´ä»½, "total":æ€»é¢, "months":[{"m":1, "a":1240, "n":"æ‘˜è¦..."}, ... (å…±12ä¸ª)]}]`;

    const userPrompt = `ä¸»è§’ï¼š${charName}
    äººè®¾èƒŒæ™¯ï¼š${charBio}
    
    è¯·ç”Ÿæˆä» ${startYear} å¹´å¼€å§‹ï¼Œå…± ${span} å¹´çš„å¹´åº¦è´¢åŠ¡æµæ°´ã€‚æ¯å¹´å¿…é¡»åŒ…å«12ä¸ªæœˆã€‚`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:systemPrompt}, {role:"user", content:userPrompt}],
                temperature: 0.85 // æé«˜ä¸€ç‚¹éšæœºæ€§
                // ğŸš¨ ç§»é™¤äº† response_format ä»¥é˜²æ­¢ 400 æŠ¥é”™
            })
        });

        const data = await response.json();
        
        // ğŸš¨ é”™è¯¯æ•æ‰
        if (data.error) {
            throw new Error(`API Error: ${data.error.message}`);
        }
        if (!data.choices || data.choices.length === 0) {
            throw new Error("API è¿”å›äº†ç©ºæ•°æ®");
        }

        let rawText = data.choices[0].message.content;
        
        // ğŸš¨ æ­£åˆ™æå– JSON
        const jsonMatch = rawText.match(/\[[\s\S]*\]/);
        
        if (!jsonMatch) {
            console.error("AI è¿”å›åŸå§‹å†…å®¹:", rawText);
            throw new Error("AI æœªè¿”å›æœ‰æ•ˆçš„ JSON æ•°ç»„æ ¼å¼");
        }
        
        const yearlyData = JSON.parse(jsonMatch[0]);

        // æŒ‚è½½åˆ°ä¸´æ—¶å˜é‡ä¾›ä¿å­˜ä½¿ç”¨
        window.currentPendingYearlyData = yearlyData;

        overlay.remove();
        window.renderYearlyVisuals(yearlyData);

    } catch (e) {
        overlay.remove();
        alert("ANNUAL_GEN_FAILED: " + e.message);
    }
};

/**
 * âš¡ï¸ æ¸²æŸ“ AI ç”Ÿæˆçš„å¹´åº¦è´¦å• (å¯¹åº” ID: yearly-report-display)
 * è¿™ä¸ªå‡½æ•°ä¸“é—¨ç”¨äºæ˜¾ç¤ºå¸¦æœ‰ "COMMIT (ä¿å­˜)" æŒ‰é’®çš„é‚£ä¸ªå¼¹çª—
 */
window.renderYearlyVisuals = function(data) {
    console.log("æ­£åœ¨æ¸²æŸ“ AI ç”Ÿæˆç»“æœ...");

    // 1. é”å®šä½ æä¾›çš„ HTML ID
    const container = document.getElementById('yearly-bill-container');
    const modal = document.getElementById('yearly-report-display');
    const reportSection = document.getElementById('yearly-report-display'); // ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯æŠ¥å‘Šå±‚

    if (!container || !modal) {
        console.error("æ‰¾ä¸åˆ°ç”Ÿæˆé¡µå®¹å™¨: yearly-bill-container æˆ– yearly-report-display");
        return;
    }

    // 2. ç”Ÿæˆè´¦å• HTML (å¤ç”¨é•¿æ¡æ”¶æ®æ ·å¼)
    // æ³¨æ„ï¼šè¿™é‡Œçš„ data ç›´æ¥å°±æ˜¯ AI è¿”å›çš„ JSON æ•°ç»„ (åŒ…å«å¤šä¸ªå¹´ä»½)
    let htmlContent = "";
    
    // å…¼å®¹æ€§å¤„ç†ï¼šæ— è®º data æ˜¯æ•°ç»„è¿˜æ˜¯å•å¯¹è±¡ï¼Œéƒ½è½¬ä¸ºæ•°ç»„å¤„ç†
    const dataArray = Array.isArray(data) ? data : [data];

    htmlContent = dataArray.map(yearObj => `
        <div class="industrial-receipt" style="margin-bottom: 40px; background: #fff; border: 2px solid #000; padding: 15px; box-shadow: 5px 5px 0 rgba(0,0,0,0.1);">
            <div class="receipt-header" style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px;">
                <div class="cinzel-font" style="font-size:12px; opacity:0.6; letter-spacing: 2px;">LUNE_GEN_RESULT</div>
                <div class="cinzel-font" style="font-size:32px; font-weight:900; margin:5px 0;">FY_${yearObj.year}</div>
                <div style="font-family: monospace; font-size: 9px; color:#ff3b30;">STATUS: PENDING_COMMIT (å¾…å½’æ¡£)</div>
            </div>
            
            <div class="receipt-body">
                ${yearObj.months.map(m => `
                    <div class="receipt-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                        <div style="display:flex; flex-direction:column; width: 70%;">
                            <div style="font-weight:900; font-family: 'Cinzel'; font-size: 14px;">MONTH . ${String(m.m).padStart(2, '0')}</div>
                            <div style="font-size:10px; color:#666; margin-top: 2px; line-height: 1.3;">${m.n || 'No Details'}</div>
                        </div>
                        <div style="font-family:'Cinzel'; font-weight:900; font-size: 16px;">
                            ï¿¥${parseFloat(m.a).toLocaleString()}
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="receipt-total-row" style="background:#000; color:#fff; padding: 15px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                <span class="receipt-total-label" style="font-size: 10px; letter-spacing: 1px;">NET_EXPENDITURE</span>
                <span class="receipt-total-val" style="font-size: 18px; font-weight: 900; font-family: 'Cinzel';">-ï¿¥${parseFloat(yearObj.total).toLocaleString()}</span>
            </div>
        </div>
    `).join('');

    // 3. å¡«å…¥æ•°æ®
    container.innerHTML = htmlContent;

    // 4. å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª— (å…³é”®æ­¥éª¤)
    modal.style.display = 'flex'; // æˆ–è€…æ˜¯ blockï¼Œçœ‹ä½ çš„ CSS æ€ä¹ˆå†™çš„
    
    // éšè—ä¹‹å‰çš„åŠ è½½åŠ¨ç”»ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    const overlay = document.querySelector('.vault-decrypting-overlay');
    if (overlay) overlay.remove();

    // å¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
    container.scrollTop = 0;
};
/**
 * ğŸ’¾ æ›´æ–°ç‰ˆï¼šå¹´åº¦éš”ç¦»ä¿å­˜é€»è¾‘ (å–æ¶ˆæµè§ˆå™¨ alert)
 */
window.saveYearlyArchive = function() {
    if (!window.currentPendingYearlyData) {
        showToast("ERROR: NO_DATA_STREAM");
        return;
    }
    
    const charID = window.currentVaultCharID || 'GLOBAL';
    
    // 1. è¯»å–å¹¶æ›´æ–°åˆ—è¡¨
    let yearlyList = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];
    
    const newEntry = {
        id: "Y_ARC_" + Date.now(),
        years_covered: window.currentPendingYearlyData.map(y => y.year),
        total_all: window.currentPendingYearlyData.reduce((s, y) => s + y.total, 0),
        fullData: window.currentPendingYearlyData,
        timestamp: Date.now()
    };

    yearlyList.unshift(newEntry);
    localStorage.setItem(`LUNE_VAULT_YEARLY_LIST_${charID}`, JSON.stringify(yearlyList));

    // 2. äº¤äº’åé¦ˆ
    if (window.navigator.vibrate) window.navigator.vibrate([10, 50, 10]);
    
    // ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå…³é—­å±•ç¤ºçª—ï¼Œæ‰“å¼€æˆåŠŸæç¤ºçª—
    window.closeYearlyReport();
    document.getElementById('yearly-success-modal').style.display = 'flex';
    
    // 3. åˆ·æ–°é¦–é¡µå¡ç‰‡æµ
    if (typeof window.refreshDashYearlyCards === 'function') {
        window.refreshDashYearlyCards();
    }
};

/**
 * å…³é—­æˆåŠŸæç¤ºçª—
 */
window.closeYearlySuccess = function() {
    const modal = document.getElementById('yearly-success-modal');
    if (modal) modal.style.display = 'none';
};

/**
 * ğŸ”„ æ¸²æŸ“é¦–é¡µçš„å¹´åº¦å†å²å¡ç‰‡ (è®©å®ƒä»¬å¯ä»¥ç‚¹å‡»ï¼)
 */
window.refreshDashYearlyCards = function() {
    const charID = window.currentVaultCharID || 'GLOBAL';
    const container = document.getElementById('dash-yearly-cards-container');
    if (!container) return;

    const list = JSON.parse(localStorage.getItem(`LUNE_VAULT_YEARLY_LIST_${charID}`)) || [];

    if (list.length === 0) {
        container.innerHTML = `<div class="empty-placeholder">NO_ANNUAL_DATA // æš‚æ— å¹´åº¦è®°å½•</div>`;
        return;
    }

    // ğŸš¨ å…³é”®ä¿®æ”¹ï¼šonclick="window.viewYearlyDetail('${arc.id}')"
    // è¿™æ ·ç‚¹å‡»ä»»ä½•ä¸€å¼ å†å²å¡ç‰‡ï¼Œéƒ½ä¼šè§¦å‘è¯¦æƒ…é¡µ
    container.innerHTML = list.map(arc => `
        <div class="archive-card-bw" 
             style="border: 2px solid #000; background: #000; color: #fff; flex: 0 0 160px; position: relative; overflow: hidden; margin-right: 10px; cursor: pointer;" 
             onclick="window.viewYearlyDetail('${arc.id}')">
            
            <div style="position: absolute; top: 0; right: 0; background: #fff; color: #000; font-size: 7px; padding: 2px 5px; font-weight: 900;">
                ANNUAL
            </div>

            <span class="card-tag" style="color:#666; font-size: 8px;">LOG_SERIAL: ${String(arc.id).slice(-6)}</span>
            <div class="card-month" style="color:#fff; font-size: 15px; margin: 8px 0;">
                ${arc.years_covered ? arc.years_covered.join(' - ') : 'UNKNOWN'}
            </div>
            
            <div style="border-top: 1px dashed #444; margin-top: 5px; padding-top: 8px;">
                <span style="font-size: 8px; opacity: 0.6; display: block; margin-bottom: 2px;">ACCUMULATED_EXPENSE:</span>
                <div class="card-val" style="color:#fff; font-size: 18px;">ï¿¥${parseFloat(arc.total_all).toLocaleString()}</div>
            </div>
        </div>
    `).join('');
};

/**
 * ğŸš€ æ ¸å¿ƒå¯åŠ¨åºåˆ—ï¼šè‡ªåŠ¨å”¤é†’æœˆåº¦é¢æ¿
 */
window.addEventListener('load', async () => {
    // 1. ğŸš¨ å¿…é¡»å…ˆåšï¼šæ¢å¤ ID
    const savedID = localStorage.getItem('LUNE_LAST_ACTIVE_CHAR_ID');
    if (savedID) {
        window.currentVaultCharID = savedID;
        console.log("åˆå§‹åŒ– ID å·²æ¢å¤:", savedID);
    }

    // 2. åˆå§‹åŒ–å…¶ä»–æœåŠ¡
    if (typeof initSystemServices === 'function') await initSystemServices();
    
    // 3. è§¦å‘ä¸€æ¬¡ç‚¹å‡»ï¼Œå°±åƒä¸Šé¢çš„ switchBankTab ä¸€æ ·
    setTimeout(() => {
        // å‡è£…ç”¨æˆ·ç‚¹äº†ä¸€æ¬¡ Dashboard tab
        window.switchBankTab(0); 
    }, 300);
});

/**
 * 1. é¦–é¡µå¡ç‰‡æµæ¸²æŸ“ï¼šå¢åŠ å¼ºåˆ¶çº åé€»è¾‘
 */
window.refreshDashMonthlyCards = function() {
    // å¼ºåˆ¶è·å–å½“å‰è§’è‰²ï¼Œç¡®ä¿ ID å³ä½¿åœ¨åŠ è½½ç¬é—´ä¹Ÿæ˜¯å‡†ç¡®çš„
    const charID = window.currentVaultCharID || 'GLOBAL';
    const container = document.getElementById('dash-monthly-cards-container');
    if (!container) return;

    console.log(`[æ¡£æ¡ˆç³»ç»Ÿ] æ­£åœ¨å°è¯•æ¸²æŸ“ ID ä¸º ${charID} çš„å¡ç‰‡æµ...`);

    const storageKey = `LUNE_VAULT_LIST_${charID}`;
    const archiveList = JSON.parse(localStorage.getItem(storageKey)) || [];

    if (archiveList.length === 0) {
        container.innerHTML = `<div class="empty-placeholder">NO_DATA_FOUND // æ¡£æ¡ˆåº“æš‚æ— è§£å¯†è®°å½•</div>`;
        return;
    }

    // æ¸²æŸ“å¡ç‰‡ï¼šå¢åŠ åè½¬ï¼Œç¡®ä¿æœ€æ–°ç”Ÿæˆçš„åœ¨æœ€å‰é¢
    container.innerHTML = archiveList.map((arc, idx) => `
        <div class="archive-card-bw" onclick="window.loadSpecificArchiveFromList('${arc.id}')" 
             style="flex: 0 0 140px; background: #fff; border: 2px solid #000; padding: 12px; box-shadow: 4px 4px 0px #000; cursor: pointer; position: relative;">
            <span class="card-tag" style="font-family: monospace; font-size: 8px; color: #888; text-transform: uppercase;">#LOG_${String(arc.id).slice(-4)}</span>
            <div class="card-month" style="font-family: 'Cinzel'; font-weight: 900; font-size: 13px; margin: 5px 0; border-bottom: 1px solid #000; padding-bottom: 3px;">
                ${arc.year} / ${arc.data ? arc.data.length : 0}M
            </div>
            <div class="card-val" style="font-family: 'Cinzel'; font-weight: 900; font-size: 15px; margin-top: 5px;">
                ï¿¥${parseFloat(arc.total || 0).toLocaleString()}
            </div>
            <div style="font-size:7px; margin-top:8px; color:#aaa; font-family: monospace;">
                STAMP: ${new Date(arc.timestamp).toLocaleDateString()}
            </div>
        </div>
    `).join('');
};

/**
 * 2. ç»ˆæå­˜æ¡£åè®®ï¼šä¿®å¤äº†å˜é‡ä¸¢å¤±å’Œæ¸²æŸ“ä¸­æ–­é—®é¢˜
 */
window.manualSaveArchive = function() {
    if (!window.currentPendingData || window.currentPendingData.length === 0) {
        showToast("ERROR: æ— æœ‰æ•ˆæ•°æ®æµ");
        return;
    }

    const charID = window.currentVaultCharID || 'GLOBAL';
    const totalAmount = window.currentPendingData.reduce((sum, item) => sum + (item.amount || 0), 0);

    const newEntry = {
        id: "ARC_" + Date.now(),
        year: document.getElementById('config-year')?.value || "2026",
        total: totalAmount,
        data: window.currentPendingData,
        timestamp: Date.now()
    };

    // ç‰©ç†å…¥åº“
    let archiveList = JSON.parse(localStorage.getItem(`LUNE_VAULT_LIST_${charID}`)) || [];
    archiveList.unshift(newEntry);
    localStorage.setItem(`LUNE_VAULT_LIST_${charID}`, JSON.stringify(archiveList));

    // åŒæ­¥å½“å‰æ±‡æ€»æ¡£æ¡ˆ
    localStorage.setItem(`LUNE_VAULT_ARCHIVE_${charID}`, JSON.stringify({
        total: totalAmount,
        data: window.currentPendingData,
        timestamp: Date.now()
    }));

    // ğŸš¨ éœ‡åŠ¨å¹¶å¼ºåˆ¶è§¦å‘æ‰€æœ‰ UI åˆ·æ–°
    window.safeVibrate([20, 80, 20]);
    
    // æ‰§è¡Œåˆ·æ–°
    window.refreshDashMonthlyCards();
    if (typeof window.refreshDashMonthlySummary === 'function') window.refreshDashMonthlySummary();

    showToast("âœ“ æ¡£æ¡ˆå·²æ­£å¼é”å…¥ä¸­å¤®é‡‘åº“");
    window.closeMonthlyReport();
};

/**
 * 3. å¢å¼ºç‰ˆï¼šç‚¹å‡»å†å²å¡ç‰‡é‡æ–°æŸ¥çœ‹ (ä¿®å¤ç‰ˆ)
 */
window.loadSpecificArchiveFromList = function(arcId) {
    // 1. è¿™é‡Œçš„é€»è¾‘å¯èƒ½æœ‰é—®é¢˜ï¼šå¦‚æœä¸ä¼  charIDï¼Œå®ƒé»˜è®¤å–å…¨å±€å˜é‡ï¼Œè€Œå…¨å±€å˜é‡å¯èƒ½æ˜¯æ—§çš„
    // æˆ‘ä»¬å…ˆå°è¯•ä» archiveList çš„å­˜å‚¨ Key åæ¨ IDï¼Œæˆ–è€…ç›´æ¥ä¿¡ä»»å…¨å±€å˜é‡å¹¶å¼ºåˆ¶åˆ·æ–°
    
    // å‡è®¾ä½ æ˜¯é€šè¿‡ç‚¹å‡»å¡ç‰‡è¿›æ¥çš„ï¼Œé‚£ä¹ˆå…¨å±€ ID åº”è¯¥åœ¨ç‚¹å‡»å¡ç‰‡çš„ä¸€ç¬é—´æ›´æ–°
    const charID = window.currentVaultCharID || localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');

    console.log(`[System] åˆ‡æ¢è§†å›¾è‡³: ${charID} (Archive: ${arcId})`);

    // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šå…ˆæ›´æ–°å­˜å‚¨ï¼Œå†æ¸²æŸ“ ğŸ”¥ğŸ”¥ğŸ”¥
    if (charID) {
        window.currentVaultCharID = charID; 
        localStorage.setItem('LUNE_LAST_SELECTED_CHAR_ID', charID);
    }

    // 2. å‘Šè¯‰è´¦å•æ¨¡å—ï¼šâ€œç«‹åˆ»æ¸…ç©ºæ—§çš„ï¼Œæ˜¾ç¤ºè¿™ä¸ª ID çš„æ•°æ®ï¼â€
    if (typeof window.renderPhoneBillList === 'function') {
        // å¼ºåˆ¶ä¼ å…¥ IDï¼Œä¸è®©æ¸²æŸ“å‡½æ•°å»çŒœ
        window.renderPhoneBillList(charID); 
    }
    
    // ... (ä½ åŸæ¥çš„åŠ è½½æ¡£æ¡ˆè¯¦æƒ…çš„é€»è¾‘ï¼Œæ¯”å¦‚ renderMonthlyVisuals ç­‰) ...
};

// æ‰‹æœºç«¯åŠ è½½æ—¶ç«‹å³è§¦å‘
window.onload = async () => {
    // 1. åˆå§‹åŒ–ç³»ç»Ÿ
    if (typeof initSystemServices === 'function') await initSystemServices(); 
    
    // 2. æ¸²æŸ“å…¶ä»–éƒ¨åˆ†
    if (typeof refreshNPCContainer === 'function') await refreshNPCContainer(); 
    if (typeof renderSavedCards === 'function') renderSavedCards();
    if (typeof refreshDashMonthlyCards === 'function') refreshDashMonthlyCards();

    // 3. ğŸ”¥ğŸ”¥ æ–°å¢ï¼šå¼ºåˆ¶æ¸²æŸ“è¯è´¹è´¦å• (é˜²æ­¢åˆ·æ–°åæ¶ˆå¤±) ğŸ”¥ğŸ”¥
    if (typeof forceRenderPhoneBills === 'function') {
        setTimeout(forceRenderPhoneBills, 200); // ç¨å¾®æ™šä¸€ç‚¹ç‚¹ï¼Œç­‰é¡µé¢ç¨³äº†å†ç”»
    }

    console.log("PROTOCOL_SYNC: ç³»ç»Ÿè§†å›¾å·²å¼ºåˆ¶åˆ·æ–°ã€‚");

    await initSystemServices(); // 1. å…ˆåˆå§‹åŒ–ç³»ç»Ÿåº“
    await refreshNPCContainer(); // 2. å†æ ¹æ®åˆå§‹åŒ–åçš„æ•°æ®ç”»é¡µé¢
    console.log("PROTOCOL_SYNC: ç³»ç»ŸæœåŠ¡å·²å¼ºåˆ¶ä¸‹å‘è‡³å®¢æˆ·ç«¯ã€‚");
    // åœ¨åˆ‡æ¢è§’è‰²æˆ–è€…ç³»ç»Ÿåˆå§‹åŒ–æ—¶è°ƒç”¨
    window.refreshDashMonthlyCards();
    await initMomentsStories(); // åŠ è½½ä¸Šæ–¹é™æ—¶åŠ¨æ€
    // åœ¨ä½ çš„ loadSavedData æˆ–è€… window.onload é‡ŒåŠ å…¥ï¼š
    await initMomentsFeed();
    // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„è‰ç¨¿
    checkAndRestoreDraft();
    
    // ğŸš€ æ–°å¢ï¼šåˆå§‹åŒ–ä¹¦æ¶
    await window.renderBookshelf();
};


/**
 * 1. é¦–é¡µæ•°æ®åŒæ­¥ï¼šä»æ¡£æ¡ˆåº“æå–æœ€æ–°æ€»é¢å¹¶æ¸²æŸ“åˆ° Dashboard
 */
window.refreshDashMonthlySummary = function() {
    const charID = window.currentVaultCharID || 'GLOBAL';
    // è¯»å–è¯¥è§’è‰²ä¸“å±çš„æ¡£æ¡ˆ
    const archive = JSON.parse(localStorage.getItem(`LUNE_VAULT_ARCHIVE_${charID}`)) || { total: 0 };
    
    // æ›´æ–° Dashboard ä¸Šçš„æ•°å€¼ (è¯·ç¡®ä¿ HTML é‡Œçš„ ID æ˜¯ dash-monthly-outflow)
    const displayEl = document.getElementById('dash-monthly-outflow');
    if (displayEl) {
        displayEl.innerText = `-ï¿¥${parseFloat(archive.total).toLocaleString()}`;
    }
};

/**
 * 2. æŒ‰é’®ç‚¹å‡»åè®®ï¼šæœ‰æ¡£æ¡ˆç›´æ¥è¯»ï¼Œæ— æ¡£æ¡ˆå¼¹é…ç½®
 */
window.monthlyDetailAction = function() {
    const charID = window.currentVaultCharID || 'GLOBAL';
    const archive = JSON.parse(localStorage.getItem(`LUNE_VAULT_ARCHIVE_${charID}`));

    if (archive && archive.data && archive.data.length > 0) {
        console.log("[æ¡£æ¡ˆç³»ç»Ÿ] æ£€æµ‹åˆ°å†å²è§£å¯†æ•°æ®ï¼Œç›´æ¥è°ƒå–...");
        window.renderMonthlyVisuals(archive.data);
    } else {
        const modal = document.getElementById('monthly-config-modal');
        if (modal) modal.style.display = 'flex';
    }
    if (window.navigator.vibrate) window.navigator.vibrate(10);
};

window.closeMonthlyConfig = function() { document.getElementById('monthly-config-modal').style.display = 'none'; };
window.updateRangeText = function(val) { document.getElementById('range-val').innerText = val + " MONTHS"; };

/**
 * 3. æ ¸å¿ƒï¼šAI ç”Ÿæˆå¹¶æŒä¹…åŒ–å­˜å‚¨ (äººè®¾åŒæ­¥ + å…¼å®¹æ€§ä¿®å¤ç‰ˆ)
 */
window.generateMonthlyReport = async function() {
    const year = document.getElementById('config-year').value;
    const monthsCount = document.getElementById('config-months-range').value;
    const charID = window.currentVaultCharID || 'GLOBAL';
    
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) return alert("PROTOCOL_ERROR: è¯·å…ˆé…ç½® AI å¯†é’¥");

    // 1. ğŸš¨ åˆ›å»ºå¹¶æ˜¾ç¤ºå…¨å±åŠ¨ç”»é®ç½©
    const overlay = document.createElement('div');
    overlay.id = "global-gen-overlay";
    overlay.className = "vault-decrypting-overlay";
    overlay.innerHTML = `
        <div class="v-scan-line"></div>
        <div class="v-loading-text">DECRYPTING_VAULT_FILES</div>
        <div class="v-status-sub">CONNECTING_TO_LUNE_NODE... [0x882_AUTH]</div>
    `;
    document.body.appendChild(overlay);

    if(overlay) overlay.style.display = 'flex';
    window.closeMonthlyConfig();

    // 2. ğŸ› ï¸ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶ä»æ•°æ®åº“è¯»å–ç²¾å‡†äººè®¾
    let charName = window.currentVaultCharName || "Ta";
    let charBio = "æœªçŸ¥"; // é»˜è®¤å…œåº•

    try {
        if (typeof loadFromDB === 'function') {
            const charList = await loadFromDB('char_list') || [];
            const targetChar = charList.find(c => c.id === charID);
            
            if (targetChar) {
                charName = targetChar.name;
                // ä¼˜å…ˆå– descï¼Œæ²¡æœ‰å†å– bio
                charBio = targetChar.desc || targetChar.bio || charBio;
                console.log(`[AI] æœˆåº¦æŠ¥å‘Šç”Ÿæˆ - å·²é”å®šäººè®¾: ${charName}`);
            }
        }
    } catch (e) {
        console.warn("è¯»å–äººè®¾å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¼“å­˜å€¼", e);
    }

    // ğŸš¨ è‡ªåŠ¨ä¿®æ­£ï¼šå¦‚æœæ˜¯ DeepSeekï¼Œå¼ºåˆ¶åˆ‡æ¢æ¨¡å‹å
    if (apiUrl.includes("deepseek")) {
        console.log("æ£€æµ‹åˆ° DeepSeek ç¯å¢ƒï¼Œè‡ªåŠ¨ä¿®æ­£æ¨¡å‹åç§°...");
        model = "deepseek-chat"; 
    }

    // 3. Prompt è®¾è®¡
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå†·å³»çš„è´¢åŠ¡è§‚æµ‹è€…ã€‚å¿…é¡»è¾“å‡ºä¸¥æ ¼çš„ JSON æ•°ç»„ã€‚
    æ–‡é£éœ€å…·å¤‡å·¥ä¸šé…¸æ¶©æ„Ÿï¼Œä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€æ¥æè¿°è¿™ç¬”å¼€é”€ä¸ç”¨æˆ·ä¹‹é—´çš„ç§˜å¯†è”ç³»ã€‚
    
    ã€é‡è¦ã€‘ï¼šå¿…é¡»åªè¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚
    æ ¼å¼: [{"month":"æœˆä»½", "amount":æ•°å­—, "summary":"150å­—å·¦å³çš„æ’ç‰ˆä¼˜ç¾çš„æ•…äº‹"}]`;

    const userPrompt = `ä¸»è§’ï¼š${charName}ã€‚
    ä¸»è§’äººè®¾èƒŒæ™¯ï¼š${charBio}ã€‚
    
    è¯·æ ¹æ®ä¸Šè¿°äººè®¾ï¼Œä¸ºâ€œä½ â€(${charName}) å’Œç”¨æˆ·ä¹‹é—´ï¼Œç”Ÿæˆ ${year} å¹´è¿ç»­ ${monthsCount} ä¸ªæœˆçš„è´¢åŠ¡çº è‘›è®°å½•ã€‚
    æ¯ä¸€ç¬”è®°å½•çš„ summary éƒ½è¦ä½“ç°å‡ºä¸»è§’ç‹¬ç‰¹çš„æ€§æ ¼å’Œç»å†ã€‚`;

    // 4. ğŸš¨ åœ¨å®¹å™¨å†…æ’å…¥å±€éƒ¨åŠ¨ç”»
    const listContainer = document.getElementById('monthly-records-list');
    if (listContainer) {
        listContainer.style.position = 'relative'; 
        listContainer.innerHTML = `
            <div class="scanning-overlay">
                <div class="scan-line"></div>
                <div class="loading-text">DECRYPTING_VAULT_DATA...</div>
                <div style="font-size:8px; font-family:monospace; margin-top:5px;">ANALYZING_ENTITY: ${charName}</div>
            </div>
        `;
    }
    
    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content:systemPrompt}, {role:"user", content:userPrompt}],
                temperature: 0.85
                // ğŸš¨ ç§»é™¤äº† response_format ä»¥é˜²æ­¢ 400 æŠ¥é”™
            })
        });

        const data = await response.json();
        
        // ğŸš¨ é”™è¯¯æ•æ‰
        if (data.error) throw new Error(`API Error: ${data.error.message}`);
        if (!data.choices || data.choices.length === 0) throw new Error("API è¿”å›äº†ç©ºæ•°æ®");

        let rawContent = data.choices[0].message.content;
        
        // ğŸš¨ æ­£åˆ™æå– JSON
        const jsonMatch = rawContent.match(/\[[\s\S]*\]/);
        
        if (!jsonMatch) {
            console.error("AI è¿”å›åŸå§‹å†…å®¹:", rawContent);
            throw new Error("AI æœªè¿”å›æœ‰æ•ˆçš„ JSON æ•°ç»„æ ¼å¼");
        }
        
        const reportData = JSON.parse(jsonMatch[0]);

        // --- âš¡ æŒä¹…åŒ–æ¡£æ¡ˆå­˜å‚¨é€»è¾‘ ---
        const totalAmount = reportData.reduce((sum, item) => sum + item.amount, 0);
        const archivePayload = {
            total: totalAmount,
            data: reportData,
            timestamp: Date.now()
        };
        // è§’è‰²éš”ç¦»å­˜å‚¨
        localStorage.setItem(`LUNE_VAULT_ARCHIVE_${charID}`, JSON.stringify(archivePayload));

        // 3. ğŸš¨ æ•°æ®åˆ°æ‰‹ï¼Œé”€æ¯åŠ¨ç”»é®ç½©
        const oldOverlay = document.getElementById('global-gen-overlay');
        if (oldOverlay) {
            oldOverlay.style.transition = "opacity 0.5s";
            oldOverlay.style.opacity = "0";
            setTimeout(() => oldOverlay.remove(), 500);
        }

        // åŒæ­¥ UI
        window.refreshDashMonthlySummary();
        window.renderMonthlyVisuals(reportData);

    } catch (e) {
        alert("GENERATE_FAILED: " + e.message);
    } finally {
        if(overlay) overlay.style.display = 'none';
    }
};

/**
 * æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ æ•°æ®é˜²å¾¡ï¼Œé˜²æ­¢ toLocaleString æŠ¥é”™
 */
window.renderMonthlyVisuals = function(data) {
    const display = document.getElementById('monthly-report-display');
    if (display) display.style.display = 'flex';
    
    const list = document.getElementById('monthly-records-list');
    if (!list) return;

    // 1. åªæ¸²æŸ“è´¦ç›®åˆ—è¡¨é¡¹ï¼Œä¸åŠ æŒ‰é’® HTML
    list.innerHTML = `
        <div class="records-box-white">
            ${data.map((item, idx) => `
                <div class="report-entry-row" onclick="window.openMonthEntryDetail(${idx})">
                    <div class="entry-meta">
                        <span class="m-title cinzel-font">${item.month || 'æœªçŸ¥'}</span>
                        <span class="m-desc">${(item.summary || '').substring(0, 45)}...</span>
                    </div>
                    <div class="m-price">ï¿¥${parseFloat(item.amount || 0).toLocaleString()}</div>
                    <div class="entry-arrow">ã€‰</div>
                </div>
            `).join('')}
        </div>
    `;

    // 2. è§¦å‘ç»˜å›¾
    if (typeof window.drawBwChart === 'function') {
        window.drawBwChart(data);
    }

    // 3. âš¡ æ ¸å¿ƒé€»è¾‘ï¼šæŒ‚è½½æ•°æ®ä¾›å¤–éƒ¨â€œå›ºå®šæŒ‰é’®â€ä½¿ç”¨
    window.currentPendingData = data;
};


// è¾…åŠ©ï¼šåœ¨è¯¦æƒ…é¡µå¼ºåˆ¶é‡æ–°ç”Ÿæˆ
window.reTriggerConfig = function() {
    document.getElementById('monthly-report-display').style.display = 'none';
    document.getElementById('monthly-config-modal').style.display = 'flex';
};

/**
 * 5. å·¥ä¸šé£ Canvas ç»˜å›¾ (å…¨å±€æŒ‚è½½)
 */
window.drawBwChart = function(data) {
    const canvas = document.getElementById('monthly-chart-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height, p = 40;
    
    ctx.clearRect(0, 0, w, h);
    if (!data || data.length < 2) return;

    const amounts = data.map(d => d.amount);
    const max = Math.max(...amounts) * 1.3;
    const stepX = (w - p * 2) / (data.length - 1);

    // 1. ç»˜åˆ¶é˜´å½±é¢ç§¯ (Area Fill)
    ctx.beginPath();
    ctx.moveTo(p, h - p);
    data.forEach((d, i) => {
        const x = p + i * stepX;
        const y = (h - p) - (d.amount / max) * (h - p * 2);
        ctx.lineTo(x, y);
    });
    ctx.lineTo(p + (data.length - 1) * stepX, h - p);
    ctx.fillStyle = "rgba(0, 0, 0, 0.05)"; // ææ·¡çš„å·¥ä¸šç°
    ctx.fill();

    // 2. ç»˜åˆ¶ä¸»è¶‹åŠ¿çº¿
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 4;
    ctx.lineJoin = "round";
    ctx.beginPath();
    data.forEach((d, i) => {
        const x = p + i * stepX;
        const y = (h - p) - (d.amount / max) * (h - p * 2);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // 3. ç»˜åˆ¶æœˆä»½æ ‡ç­¾ (Xè½´)
    ctx.fillStyle = "#aaa";
    ctx.font = "8px Monospace";
    data.forEach((d, i) => {
        if (i % (Math.ceil(data.length/4)) === 0 || i === data.length-1) { // æŠ½æ ·æ˜¾ç¤ºæ ‡ç­¾ï¼Œé˜²æ­¢æ‹¥æŒ¤
            const x = p + i * stepX;
            ctx.fillText(d.month, x - 10, h - 15);
        }
    });
};

/**
 * 1. è¯¦æƒ…é¡µå…¥å£ï¼šå¢åŠ â€œå…ˆæŸ¥æ¡£ï¼Œåè°ƒ AIâ€çš„é€»è¾‘
 */
window.openMonthEntryDetail = async function(index) {
    window.currentDetailIndex = index;
    const charID = window.currentVaultCharID || 'GLOBAL';
    const archive = JSON.parse(localStorage.getItem(`LUNE_VAULT_ARCHIVE_${charID}`));
    
    if (!archive || !archive.data[index]) return;
    const item = archive.data[index];

    // åˆå§‹åŒ– UI
    const modal = document.getElementById('month-record-detail');
    const label = document.getElementById('detail-month-label');
    const tag = document.getElementById('detail-amount-tag');

    if (modal) modal.style.display = 'flex';
    if (label) label.innerText = `NODE: ${charID} // PERIOD: ${item.month}`;
    if (tag) tag.innerText = `ï¿¥${parseFloat(item.amount).toLocaleString()}`;

    // --- âš¡ å…³é”®ï¼šç”Ÿæˆå”¯ä¸€çš„æ¡£æ¡ˆ Key (è§’è‰²+æœˆä»½+é‡‘é¢) ---
    const storyKey = `STORY_CACHE_${charID}_${item.month}_${item.amount}`;
    const savedStory = localStorage.getItem(storyKey);

    if (savedStory) {
        // å¦‚æœç¡¬ç›˜é‡Œæœ‰ï¼Œç›´æ¥è¯»ï¼Œä¸æ¶ˆè€— AI é¢åº¦
        console.log("[ç³»ç»Ÿ] å‘½ä¸­æœ¬åœ°å­˜æ¡£ï¼Œè·³è¿‡ AI è¯·æ±‚ã€‚");
        window.renderFinalStory(savedStory);
        window.tempCurrentStory = savedStory; 
    } else {
        // å¦‚æœæ²¡æœ‰ï¼Œæ‰å»è¯· AI æ‰©å†™
        console.log("[ç³»ç»Ÿ] æœªå‘ç°å­˜æ¡£ï¼Œå¯åŠ¨ AI æ‰©å†™åè®®...");
        window.triggerAIStep(item);
    }
};

/**
 * 1. æ ¸å¿ƒ AI è§£å¯†æ­¥éª¤ï¼šè´Ÿè´£è¯·æ±‚æ•°æ®å¹¶è¿›è¡Œæ–‡æœ¬é¢„å¤„ç†
 * @param {object} item - åŒ…å« month, amount, summary çš„è´¦å•å¯¹è±¡
 */
window.triggerAIStep = async function(item) {
    const container = document.getElementById('detail-story-container');
    
    // ğŸš¨ ä¿®å¤ç‚¹ 1ï¼šåœ¨è¿™é‡Œå®šä¹‰ charIDï¼Œå¦åˆ™åé¢å­˜æ¡£ä¼šæŠ¥é”™
    const charID = window.currentVaultCharID || 'GLOBAL';

    container.innerHTML = `
        <div class="scanning-overlay">
            <div class="scan-line"></div>
            <div class="loading-text">DECRYPTING_LORE_ARCHIVE...</div>
            <div style="font-size:9px; font-family:monospace; margin-top:5px; opacity:0.7;">
                TARGET_ENTITY: ${window.currentVaultCharName} // SEQUENCE: ${item.month}
            </div>
        </div>
    `;

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå†·å³»çš„â€œå‘½è¿å®¡è®¡å‘˜â€ã€‚æ‰©å†™ä¸€æ®µ500å­—å·¦å³çš„é…¸æ¶©æ„Ÿæ°›å›´æ„Ÿæ•…äº‹ï¼Œä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€ã€‚æ’ç‰ˆéœ€ç”¨åŒæ¢è¡Œ\\n\\nã€‚`;
    const userPrompt = `ä¸»è§’ï¼š${window.currentVaultCharName} | æœˆä»½ï¼š${item.month} | é‡‘é¢ï¼šï¿¥${item.amount} | æ‘˜è¦ï¼š${item.summary}`;

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role:"system", content: systemPrompt}, {role:"user", content: userPrompt}],
                temperature: 0.85
            })
        });

        if (!response.ok) throw new Error(`HTTP_${response.status}`);
        const data = await response.json();
        const fullStory = data.choices[0].message.content;

        // --- âš¡ æ ¸å¿ƒä¿®å¤ï¼šè‡ªåŠ¨å­˜å…¥ç¡¬ç›˜ ---
        const storyKey = `STORY_CACHE_${charID}_${item.month}_${item.amount}`;
        localStorage.setItem(storyKey, fullStory);
        console.log("[ç³»ç»Ÿ] æ¡£æ¡ˆå·²åŒæ­¥è‡³æœ¬åœ°ç¡¬ç›˜ã€‚");

        window.tempCurrentStory = fullStory;
        window.renderFinalStory(fullStory);

    } catch (e) {
        console.error("DECRYPTION_ERROR:", e);
        container.innerHTML = `<div style="padding:50px; text-align:center; color:#ff3b30;">[!] DECRYPTION_FAILED: ${e.message}</div>`;
    }
};

window.renderFinalStory = function(content) {
    const container = document.getElementById('detail-story-container');
    if (!container) return;

    // 1. å¤„ç†æ¢è¡Œç¬¦
    let formatted = content.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
    
    // 2. ä¼˜åŒ–åŒæ¢è¡Œ
    formatted = formatted.replace(/(<br>\s*){2,}/g, '<br><br>');

    // 3. å…³é”®è¯å¤„ç†
    formatted = formatted.replace(/ã€(.*?)ã€‘/g, '<span style="font-weight:900; border-bottom:2px solid #000; padding:0 2px; margin:0 2px;">$1</span>');

    // 4. æ³¨å…¥ DOM
    container.innerHTML = `
        <div style="line-height: 2.2; font-size: 14px; text-align: justify; color: #333; animation: fadeIn 0.8s ease; word-break: break-all;">
            ${formatted}
        </div>
        <div style="margin-top:50px; border-top:1px dashed #ddd; padding-top:15px; font-size:10px; color:#bbb; font-family:monospace; text-align:right;">
            PROTOCOL_CHECK: DATA_INTEGRITY_VERIFIED // END_LOG
        </div>
    `;
    
    // ğŸš¨ ä¹‹å‰è¿™é‡Œè¯¯åŠ äº†â€œé‡æ–°è§¦å‘â€é€»è¾‘ï¼Œå·²åˆ é™¤ï¼Œé˜²æ­¢æ— é™ç”Ÿæˆï¼
};

/**
 * 4. ç¡®è®¤å­˜æ¡£é€»è¾‘ï¼šçœŸæ­£å†™å…¥ç¡¬ç›˜
 */
window.confirmSaveStory = function() {
    if(!window.tempCurrentStory) return;
    
    const charID = window.currentVaultCharID || 'GLOBAL';
    const archive = JSON.parse(localStorage.getItem(`LUNE_VAULT_ARCHIVE_${charID}`));
    const item = archive.data[window.currentDetailIndex];
    const storyKey = `STORY_CACHE_${charID}_${item.month}_${item.amount}`;

    localStorage.setItem(storyKey, window.tempCurrentStory);
    
    if (window.navigator.vibrate) window.navigator.vibrate([10, 30, 10]);
    alert("âœ“ æ¡£æ¡ˆå·²æ°¸ä¹…å°å­˜ã€‚ä¸‹æ¬¡è¿›å…¥å°†ç›´æ¥è¯»å–æ­¤ç‰ˆæœ¬ã€‚");
};

/**
 * 5. æ¸²æŸ“æœ€ç»ˆæ–‡å­—çš„å·¥å…·å‡½æ•° (åŒ…å«ä½ è¦æ±‚çš„ \n ä¿®å¤)
 */
window.renderFinalStory = function(content) {
    const container = document.getElementById('detail-story-container');
    // ä¿®å¤ \n\n æ¸²æŸ“é—®é¢˜
    let formatted = content.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
    formatted = formatted.replace(/(<br>\s*){2,}/g, '<br><br>');
    
    container.innerHTML = `
        <div style="line-height: 2; font-size: 14px; text-align: justify; animation: fadeIn 0.8s ease;">
            ${formatted}
        </div>
    `;
    // ç»“æŸåè®°å¾—æŠŠè¿™æ¬¡çš„æ•…äº‹å­˜åˆ°ä¸´æ—¶å˜é‡ï¼Œé˜²æ­¢ç”¨æˆ·æ²¡åˆ·æ–°å°±ç‚¹å­˜æ¡£
    window.tempCurrentStory = content;
};

window.closeMonthEntryDetail = function() {
    document.getElementById('month-record-detail').style.display = 'none';
};

window.closeMonthlyReport = function() { 
    document.getElementById('monthly-report-display').style.display = 'none';
};

// å®šä¹‰å…¨å±€å˜é‡ï¼Œå¢åŠ  Bio (äººè®¾ç®€ä»‹) å­˜å‚¨
window.currentVaultCharName = ""; 
window.currentVaultCharID = "";
window.currentVaultCharBio = ""; // æ–°å¢ï¼šç”¨äºå­˜å‚¨ AI æ‰€éœ€çš„äººè®¾èƒŒæ™¯

/* ============================================================
   ğŸš€ ç³»ç»Ÿè‡ªå¯åŠ¨åè®® (æŠŠè¿™æ®µæ”¾åœ¨æ–‡ä»¶æœ€æœ«å°¾)
   ============================================================ */
window.addEventListener('load', function() {
    setTimeout(() => {
        console.log("âš¡ [BOOT] ç³»ç»Ÿæ­£åœ¨å”¤é†’è¯è´¹æ¨¡å—...");

        // 1. è¯»å–æœ€åä¸€æ¬¡æ“ä½œçš„è§’è‰² ID
        const lastId = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');

        // 2. å¦‚æœæœ‰ IDï¼Œç›´æ¥å¼ºåˆ¶æ¸²æŸ“ï¼ä¸éœ€è¦ç”¨æˆ·ç‚¹æŒ‰é’®ï¼
        if (lastId && lastId !== "undefined" && lastId !== "null") {
            // æ¢å¤å†…å­˜å˜é‡
            window.currentVaultCharID = lastId;
            
            // åŠ¨æ‰‹ç”»å›¾
            if (typeof window.renderPhoneBillList === 'function') {
                console.log(`[BOOT] è‡ªåŠ¨åŠ è½½è´¦å•: ${lastId}`);
                window.renderPhoneBillList(lastId);
            }
        }
    }, 200); // å»¶è¿Ÿ200msï¼Œç­‰HTMLå…ƒç´ åŠ è½½å¥½
});

// å…¨å±€çŠ¶æ€é”å®š
window.currentSendMode = 'recharge'; // é»˜è®¤å……å€¼æ¨¡å¼
window.selectedCardIdx = null;       // å……å€¼æˆ–è½¬è´¦æ—¶é€‰ä¸­çš„å¡ç‰‡ç´¢å¼•
window.selectedCharId = null;        // è½¬è´¦æ—¶é€‰ä¸­çš„è§’è‰²ID

// ã€å¿…é¡»æ”¾åœ¨æœ€ä¸Šé¢ã€‘åˆå§‹åŒ–ç­›é€‰çŠ¶æ€å˜é‡
// ä½¿ç”¨ var å¯ä»¥é¿å…åˆå§‹åŒ–é¡ºåºå¯¼è‡´çš„æ­»åŒºæŠ¥é”™ï¼Œæˆ–è€…ç¡®ä¿ let æ”¾åœ¨æœ€é¡¶ç«¯
var currentFilter = {
    scope: 'all', 
    type: 'all'   
};

// æ ¸å¿ƒï¼šç›‘å¬ç³»ç»ŸåŠ è½½äº‹ä»¶
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', forceRenderCards);
} else {
    // å¦‚æœå·²ç»åŠ è½½è¿‡äº†ï¼Œç›´æ¥è·‘
    forceRenderCards();
}

// ç»ˆæå¤‡ä»½ï¼šå¦‚æœä¸Šé¢çš„å¤±æ•ˆï¼Œwindow.onload æ˜¯æœ€åçš„é˜²çº¿
window.onload = function() {
    forceRenderCards();
    // åœ¨åˆ‡æ¢è§’è‰²æˆ–è€…ç³»ç»Ÿåˆå§‹åŒ–æ—¶è°ƒç”¨
window.refreshDashMonthlyCards();
};

// åŒæ—¶ä¹ŸæŠŠåŸæ¥çš„ renderSavedCards æŒ‡å‘è¿™ä¸ªæ–°å‡½æ•°ï¼Œé˜²æ­¢æŠ¥é”™
var renderSavedCards = forceRenderCards;

let currentDeletingIndex = null;
let currentCardColor = "#FFFFFF";
let selectedCardBg = "#1a1a1a";
let currentLayout = 1;
let boundCharId = null;


let currentEditingNpcId = null;
let isNpcEditMode = false;

/**
 * ğŸ”“ å”¤èµ· NPC æ·±åº¦æ¡£æ¡ˆ
 */
window.profOpenNpcDetail = async function(npcId) {
    currentEditingNpcId = npcId;
    isNpcEditMode = false;
    
    const npcList = await loadFromDB('npc_list') || [];
    const npc = npcList.find(n => n.id === npcId);
    if (!npc) return showToast("ENTITY NOT FOUND");

    renderNpcDetailContent(npc);
    
    document.getElementById('prof-npc-detail-page').style.display = 'flex';
    if(navigator.vibrate) navigator.vibrate(10);
};

/**
 * æ¸²æŸ“å†…å®¹ (åŒºåˆ†æŸ¥çœ‹/ç¼–è¾‘)
 */
function renderNpcDetailContent(npc) {
    const container = document.getElementById('npc-detail-main');
    const saveBtn = document.querySelector('.npc-save-btn');
    const deleteBtn = document.querySelector('.npc-delete-btn');
    const editBtn = document.querySelector('.npc-edit-toggle');

    if (!isNpcEditMode) {
        // --- æŸ¥çœ‹æ¨¡å¼ ---
        editBtn.innerText = "EDIT";
        saveBtn.style.display = 'none';
        deleteBtn.style.display = 'block';
        
        container.innerHTML = `
            <div class="npc-detail-avatar">
                <img src="${npc.avatar || 'https://api.dicebear.com/7.x/shapes/svg?seed=' + npc.name}">
            </div>
            <div class="npc-info-group">
                <div class="npc-info-label">Full Name</div>
                <div class="npc-info-value" style="font-weight:800; font-size: 20px;">${npc.name}</div>
            </div>
            <div class="npc-info-group">
                <div class="npc-info-label">Relation to Main Entity</div>
                <div class="npc-info-value">${npc.rel_char || 'None'}</div>
            </div>
            <div class="npc-info-group">
                <div class="npc-info-label">Identity & Biography</div>
                <div class="npc-info-value">${npc.desc || npc.bio || 'Empty record.'}</div>
            </div>
            <div class="npc-info-group">
                <div class="npc-info-label">Relation to User (You)</div>
                <div class="npc-info-value">${npc.rel_user || 'Observer'}</div>
            </div>
        `;
    } else {
        // --- ç¼–è¾‘æ¨¡å¼ ---
        editBtn.innerText = "CANCEL";
        saveBtn.style.display = 'block';
        deleteBtn.style.display = 'none';

        container.innerHTML = `
            <div class="npc-info-group">
                <label class="npc-info-label">Full Name</label>
                <input type="text" id="edit-npc-name" class="npc-edit-input" value="${npc.name}">
            </div>
            <div class="npc-info-group">
                <label class="npc-info-label">Relation to Character</label>
                <input type="text" id="edit-npc-rel-char" class="npc-edit-input" value="${npc.rel_char || ''}">
            </div>
            <div class="npc-info-group">
                <label class="npc-info-label">Relation to User</label>
                <input type="text" id="edit-npc-rel-user" class="npc-edit-input" value="${npc.rel_user || ''}">
            </div>
            <div class="npc-info-group">
                <label class="npc-info-label">Biography / Description</label>
                <textarea id="edit-npc-desc" class="npc-edit-textarea">${npc.desc || npc.bio || ''}</textarea>
            </div>
        `;
    }
}

/**
 * åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
 */
window.profToggleNpcEdit = async function() {
    isNpcEditMode = !isNpcEditMode;
    const npcList = await loadFromDB('npc_list') || [];
    const npc = npcList.find(n => n.id === currentEditingNpcId);
    renderNpcDetailContent(npc);
};

/**
 * ğŸ’¾ æ›´æ–°æ•°æ®åº“
 */
window.profUpdateNpcData = async function() {
    const name = document.getElementById('edit-npc-name').value;
    if(!name) return showToast("NAME CANNOT BE EMPTY");

    let npcList = await loadFromDB('npc_list') || [];
    const index = npcList.findIndex(n => n.id === currentEditingNpcId);
    
    if (index !== -1) {
        npcList[index].name = name;
        npcList[index].rel_char = document.getElementById('edit-npc-rel-char').value;
        npcList[index].rel_user = document.getElementById('edit-npc-rel-user').value;
        npcList[index].desc = document.getElementById('edit-npc-desc').value;
        
        await saveToDB('npc_list', npcList);
        showToast("PROTOCOL UPDATED");
        
        isNpcEditMode = false;
        renderNpcDetailContent(npcList[index]);
        profRenderList(); // åˆ·ä¸€ä¸‹å¤–å±‚
    }
};

/**
 * ğŸ—‘ï¸ åˆ é™¤æµç¨‹
 */
window.profConfirmDeleteNpc = () => document.getElementById('prof-npc-confirm-modal').style.display = 'flex';
window.profCloseConfirm = () => document.getElementById('prof-npc-confirm-modal').style.display = 'none';

window.profExecuteDeleteNpc = async function() {
    let npcList = await loadFromDB('npc_list') || [];
    npcList = npcList.filter(n => n.id !== currentEditingNpcId);
    await saveToDB('npc_list', npcList);
    
    showToast("NODE TERMINATED");
    profCloseConfirm();
    profCloseNpcDetail();
    profRenderList(); // å¼ºåˆ·ä¸»åˆ—è¡¨
};

window.profCloseNpcDetail = () => document.getElementById('prof-npc-detail-page').style.display = 'none';

/**
 * ğŸ“‚ è¾…åŠ©ï¼šç‚¹å‡»å¤´åƒæ¡†ç›´æ¥ä¸Šä¼ 
 */
window.profUploadAvatar = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            document.getElementById('prof-avatar-preview').innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
            window.tempGeneratedAvatarUrl = ev.target.result; // é”å®šæ•°æ®ç”¨äº Commit
            showToast("External Visual Synchronized.");
        };
        reader.readAsDataURL(file);
    };
    input.click();
};

/**
 * ğŸª„ é©±åŠ¨ AI ç”Ÿæˆå¹¶åŒæ­¥è¿›åº¦æ¡
 */
window.profRunAiGen = async function() {
    const worldId = document.getElementById('prof-ai-world-id').value;
    if (!worldId) return showToast("Please select a world book first.");

    // 1. æ˜¾ç¤ºåŠ è½½åŠ¨ç”»å¹¶é‡ç½®æ•°æ®
    const loader = document.getElementById('prof-ai-loader');
    const numEl = document.getElementById('prof-progress-num');
    const barEl = document.getElementById('prof-progress-bar');
    const resultArea = document.getElementById('prof-ai-result-area');

    loader.style.display = 'flex';
    resultArea.style.display = 'none'; // å…ˆè—èµ·ç»“æœåŒº
    let progress = 0;

    // ğŸš€ ä»¿çœŸè¿›åº¦è®¡æ—¶å™¨ï¼šæ¨¡æ‹Ÿ 0% -> 92% çš„è·³åŠ¨
    const progressTimer = setInterval(() => {
        if (progress < 92) {
            // è¶Šå¾€åå¢åŠ å¾—è¶Šæ…¢ï¼Œæ¨¡æ‹Ÿâ€œæ·±åº¦æ‰«æâ€çš„çœŸå®æ„Ÿ
            const increment = Math.random() * (95 - progress) * 0.15;
            progress += increment;
            
            const displayVal = Math.floor(progress);
            numEl.innerText = displayVal + "%";
            barEl.style.width = displayVal + "%";
        }
    }, 200);

    try {
        // --- åŸæœ‰çš„ AI è¯·æ±‚é€»è¾‘å¼€å§‹ ---
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
        
        const worldList = await loadFromDB('world_list') || [];
        const world = worldList.find(w => String(w.id) === String(worldId));
        const worldContent = world ? world.content : "æœªçŸ¥ä¸–ç•Œ";

        const systemPrompt = `ä½ ç°åœ¨æ˜¯ä¸€åé¡¶å°–ç¼–å‰§...å†…å®¹ï¼š${worldContent}...è¾“å‡ºæ ¼å¼ï¼šå§“å | æ•…äº‹ | å¤–è²Œ`;

        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: "ç”Ÿæˆä¸€ä¸ªå…³é”®NPCã€‚" }],
                temperature: 0.85
            })
        });

        const data = await response.json();
        // --- åŸæœ‰çš„ AI è¯·æ±‚é€»è¾‘ç»“æŸ ---

        // âœ… æˆåŠŸåï¼šåœæ­¢è®¡æ—¶å™¨ï¼Œå¼ºåˆ¶æ‹‰æ»¡
        clearInterval(progressTimer);
        numEl.innerText = "100%";
        barEl.style.width = "100%";

        // å‡è®¾ data æ˜¯ AI è¿”å›çš„ç»“æœ
        const fullContent = data.choices[0].message.content.trim();
        const parts = fullContent.split('|').map(p => p.trim());

        if (parts.length >= 3) {
            // ç‰©ç†å¡«å…¥æ•°æ®
            document.getElementById('prof-ai-res-name').value = parts[0];
            document.getElementById('prof-ai-res-desc').value = parts[1];
            document.getElementById('prof-ai-res-prompt').innerText = parts[2];
            
            // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šåœæ­¢è¿›åº¦æ¡å¹¶å¼ºåˆ¶æ˜¾ç¤º
            clearInterval(progressTimer);
            document.getElementById('prof-progress-num').innerText = "100%";
            
            setTimeout(() => {
                loader.style.display = 'none';
                resultArea.style.display = 'block'; // ğŸ‘ˆ å°±æ˜¯è¿™ä¸€å¥ï¼Œç¡®ä¿äººè®¾æ˜¾ç¤º
                profInitSelectors(); // é¡ºä¾¿åˆ·ä¸€ä¸‹å…³ç³»ç»‘å®šçš„ä¸‹æ‹‰åˆ—è¡¨
            }, 600);
        }

    } catch (e) {
        clearInterval(progressTimer);
        loader.style.display = 'none';
        showToast("Link Terminated: " + e.message);
    }
};

/**
 * 1. æ§åˆ¶æ¨¡æ‹Ÿä¸‹æ‹‰æ¡†çš„å¼€å…³
 */
window.profToggleDropdown = function(id) {
    const el = document.getElementById(id);
    document.querySelectorAll('.prof-custom-select').forEach(s => {
        if(s.id !== id) s.classList.remove('active');
    });
    el.classList.toggle('active');
};

/**
 * 2. æ¨¡æ‹Ÿä¸‹æ‹‰æ¡†çš„é€‰å€¼åŠ¨ä½œ
 */
window.profPickOption = function(containerId, value, text, inputId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // 1. æ›´æ–°æ˜¾ç¤ºçš„æ–‡å­—
    const valSpan = container.querySelector('.prof-val-text');
    if (valSpan) valSpan.innerText = text;

    // 2. æ›´æ–°éšè—çš„ input å€¼ (ç”¨äº Commit å­˜ç›˜)
    const hiddenInp = document.getElementById(inputId);
    if (hiddenInp) hiddenInp.value = value;

    // 3. å…³é—­ä¸‹æ‹‰åˆ—è¡¨
    container.classList.remove('active');

    // 4. è§¦è§‰åé¦ˆ
    if(navigator.vibrate) navigator.vibrate(5);
};

/**
 * åˆ‡æ¢åˆ›å»ºé¡µæ˜¾ç¤ºçŠ¶æ€
 */
window.profToggleCreatePage = async function(show) {
    const page = document.getElementById('prof-create-page');
    if (show) {
        page.classList.add('active');
        // åˆå§‹åŒ–ï¼šå¡«å……è§’è‰²å’Œä¸–ç•Œåˆ—è¡¨
        await profInitSelectors();
    } else {
        page.classList.remove('active');
    }
};

// ç¡®ä¿åœ¨æ‰“å¼€åˆ›å»ºé¡µæ—¶ç¬¬ä¸€æ—¶é—´åŒæ­¥
const originalProfToggle = window.profToggleCreatePage;
window.profToggleCreatePage = async function(show) {
    if (show) {
        // å…ˆåŒæ­¥æ•°æ®ï¼Œå†æ˜¾ç¤ºé¡µé¢
        await profInitSelectors();
    }
    if (originalProfToggle) await originalProfToggle(show);
};

// è¦†ç›–ä¹‹å‰çš„æ‚¬æµ®çƒå‡½æ•°
window.profCreateNewEntity = () => profToggleCreatePage(true);


/**
 * åˆ‡æ¢ Manual / Intelligence æ ‡ç­¾
 */
window.profSwitchCreateTab = function(tab, el) {
    document.querySelectorAll('.prof-tab-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.prof-form-section').forEach(s => s.classList.remove('active'));
    
    el.classList.add('active');
    document.getElementById(`prof-sec-${tab}`).classList.add('active');
};

/**
 * ğŸ’¾ ç‰©ç†ä¿å­˜ï¼šå°†æ–°åˆ›å»ºçš„ NPC å­˜å…¥æ•°æ®åº“
 */
/**
 * ğŸ’¾ ç‰©ç†ä¿å­˜ï¼šNPC å½’æ¡£åè®® (ç»‘å®šè§’è‰² vs ç³»ç»Ÿå½’æ¡£)
 */
window.profSaveEntity = async function() {
    const activeTab = document.querySelector('.prof-tab-item.active').innerText.toLowerCase();
    let newNpc = {
        id: "NPC_" + Date.now(),
        timestamp: Date.now()
    };

    // 1. æ•°æ®æ”¶é›†
    if (activeTab === 'manual') {
        newNpc.name = document.getElementById('prof-in-name').value;
        newNpc.bio = document.getElementById('prof-in-bio-basic').value;
        newNpc.desc = document.getElementById('prof-in-appearance').value;
        newNpc.bind_id = document.getElementById('prof-in-bind-char').value;
        newNpc.rel_char = document.getElementById('prof-in-rel-char').value;
        newNpc.rel_user = document.getElementById('prof-in-rel-user').value;
        newNpc.avatar = window.tempGeneratedAvatarUrl || ""; 
    } else {
        newNpc.name = document.getElementById('prof-ai-res-name').value;
        newNpc.desc = document.getElementById('prof-ai-res-desc').value;
        newNpc.bind_id = document.getElementById('prof-ai-bind-char').value;
        newNpc.rel_char = document.getElementById('prof-ai-rel-char').value;
        newNpc.rel_user = document.getElementById('prof-ai-rel-user').value;
        newNpc.avatar = window.tempGeneratedAvatarUrl || "";
    }

    if (!newNpc.name) return showToast("PROTOCOL ERROR: NAME REQUIRED");

    // 2. ğŸš€ æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤å®šå½’å±
    if (!newNpc.bind_id || newNpc.bind_id === "") {
        newNpc.bind_id = "SYSTEM_ARCHIVE_ENTITY"; // å¼ºåˆ¶å½’æ¡£åˆ°æ¡£æ¡ˆé¦†
        showToast("NO LINK: ARCHIVING TO SYSTEM");
    } else {
        showToast(`LINKED TO PROTOCOL: ${newNpc.bind_id.slice(-6)}`);
    }

    try {
        let npcList = await loadFromDB('npc_list') || [];
        npcList.push(newNpc);
        await saveToDB('npc_list', npcList);

        // 3. æˆåŠŸåé¦ˆä¸æ¸…ç†
        if(navigator.vibrate) navigator.vibrate([10, 50, 10]);
        window.tempGeneratedAvatarUrl = null;
        
        setTimeout(() => {
            profToggleCreatePage(false);
            profRenderList(); // åˆ·æ–°å¤–å±‚åˆ—è¡¨ï¼Œé˜²æ­¢æ•°æ®ä¸ä¸€è‡´
        }, 600);
    } catch (e) {
        showToast("COMMIT FAILED: " + e.message);
    }
};

/**
 * ğŸª„ ç»ˆæä¿®å¤ç‰ˆï¼šAI ç”Ÿæˆ NPC (é˜²æ­¢å†…å®¹é”™ä½ä¸æ ‡ç­¾å¹²æ‰°)
 */
window.profRunAiGen = async function() {
    const worldId = document.getElementById('prof-ai-world-id').value;
    if (!worldId) return showToast("Please select a world book first.");

    const loader = document.getElementById('prof-ai-loader');
    const resultArea = document.getElementById('prof-ai-result-area');
    const numEl = document.getElementById('prof-progress-num');
    const barEl = document.getElementById('prof-progress-bar');

    loader.style.display = 'flex';
    resultArea.style.display = 'none';
    let progress = 0;

    const progressTimer = setInterval(() => {
        if (progress < 92) {
            progress += (95 - progress) * 0.2;
            numEl.innerText = Math.floor(progress) + "%";
            barEl.style.width = Math.floor(progress) + "%";
        }
    }, 200);

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

        const worldList = await loadFromDB('world_list') || [];
        const world = worldList.find(w => String(w.id) === String(worldId));
        const worldContent = world ? world.content : "æœªçŸ¥ä¸–ç•Œ";

        // ğŸš€ æ ¸å¿ƒ 1ï¼šæå…¶ä¸¥å‰çš„ Prompt çº¦æŸï¼Œç¦æ­¢ AI è¾“å‡ºâ€œå§“åï¼šâ€ç­‰åºŸè¯
        const systemPrompt = `ä½ ç°åœ¨æ˜¯ä¸€åé¡¶å°–æ–‡å­¦ç¼–å‰§ã€‚
        è¯·æ ¹æ®ä¸–ç•Œä¹¦å†…å®¹ï¼š${worldContent}ï¼Œåˆ›å»ºä¸€ä¸ªå¤æ‚çš„NPCã€‚
        
        ã€ğŸš¨ è¾“å‡ºè§„åˆ™ - å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘ï¼š
        1. ä»…è¿”å›å†…å®¹æœ¬èº«ï¼Œä¸¥ç¦å¸¦æœ‰â€œå§“åï¼šâ€ã€â€œäººè®¾ï¼šâ€ã€â€œå¤–è²Œï¼šâ€ç­‰ä»»ä½•æç¤ºè¯æˆ–æ ‡ç­¾ã€‚
        2. å¿…é¡»ä¸”åªèƒ½ä½¿ç”¨ä¸¤ä¸ªâ€œ|â€ç¬¦å·å°†å†…å®¹åˆ†ä¸ºä¸‰æ®µã€‚
        3. æ ¼å¼å¿…é¡»ä¸ºï¼š[åå­—] | [500å­—æ•…äº‹] | [å¤–è²Œç‰¹å¾æè¿°]
        4. æ•…äº‹å¿…é¡»åŒ…å«ç«¥å¹´é˜´å½±ã€æ ¸å¿ƒæ¬²æœ›ã€ç¤¾ä¼šåœ°ä½ï¼Œå­—æ•°å¿…é¡»å¤Ÿå¤šã€‚`;

        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: "ç”Ÿæˆä¸€ä¸ªæ·±åº¦NPCèŠ‚ç‚¹ã€‚" }],
                temperature: 0.95
            })
        });

        const data = await response.json();
        let rawContent = data.choices[0].message.content.trim();

        // ğŸš€ æ ¸å¿ƒ 2ï¼šç‰©ç†æ¸…æ´—é€»è¾‘
        // å¦‚æœ AI è¿˜æ˜¯å¸¦äº†â€œå§“åï¼šâ€â€œæ•…äº‹ï¼šâ€ç­‰å­—æ ·ï¼Œåœ¨è¿™é‡Œå¼ºåˆ¶åˆ æ‰
        let cleanContent = rawContent.replace(/(å§“å|åå­—|æ•…äº‹|èƒŒæ™¯|äººè®¾|å¤–è²Œ|ç‰¹å¾|æè¿°)[:ï¼š\s]*/g, "");
        
        const parts = cleanContent.split('|').map(p => p.trim());

        if (parts.length >= 3) {
            // ç‰©ç†å½’ä½ï¼šç¡®ä¿åå­—ã€äººè®¾ã€Prompt å„å°±å„ä½
            document.getElementById('prof-ai-res-name').value = parts[0]; // åå­—
            document.getElementById('prof-ai-res-desc').value = parts[1]; // äººè®¾ï¼ˆ500å­—æ•…äº‹ï¼‰
            
            // å¤´åƒç”Ÿæˆè¯é¢„è§ˆ
            const basePrompt = "Professional Manga portrait, thick paint style (åšæ¶‚), heavy brushstrokes, artistic lighting. Character: ";
            document.getElementById('prof-ai-res-prompt').innerText = basePrompt + parts[2];

            // åœæ­¢è¿›åº¦æ¡
            clearInterval(progressTimer);
            numEl.innerText = "100%";
            barEl.style.width = "100%";

            setTimeout(() => {
                loader.style.display = 'none';
                resultArea.style.display = 'block';
                profInitSelectors(); // åˆ·æ–°å…³ç³»ä¸‹æ‹‰æ¡†
                showToast("Deep Profile Manifested");
            }, 600);
        } else {
            throw new Error("AI æ•°æ®æ ¼å¼åç§»ï¼Œè¯·å°è¯•é‡æ–°ç”Ÿæˆã€‚");
        }

    } catch (e) {
        clearInterval(progressTimer);
        loader.style.display = 'none';
        showToast("Error: " + e.message);
    }
};

let currentProfCategory = 'ENTITIES';
let profSelectedId = null;

/**
 * ğŸš€ æ‰“å¼€ App å¹¶åŒæ­¥æ•°æ®
 */
window.openProfilesApp = async function() {
    const page = document.getElementById('page-profilesApp');
    page.style.display = 'flex';
    if(navigator.vibrate) navigator.vibrate(10);
    
    // ğŸš€ æ ¸å¿ƒï¼šå…ˆç¡®ä¿ç³»ç»ŸæœåŠ¡å·å·²ç»æ³¨å…¥æ•°æ®åº“
    await initSystemServices(); 
    
    // åˆå§‹åŠ è½½è§’è‰²æ•°æ®
    await profRenderList();
    // åœ¨åˆ‡æ¢è§’è‰²é€»è¾‘çš„æœ€ååŠ ä¸Šï¼š
    renderCharExpenseList();
};

/**
 * ğŸ”„ æ¸²æŸ“æ»‘åŠ¨åˆ—è¡¨ (ä¿®å¤ç³»ç»Ÿåˆ†é¡µä¸ºç©ºçš„é—®é¢˜)
 */
window.profRenderList = async function() {
    const ring = document.getElementById('prof-avatar-ring');
    if (!ring) return;
    ring.innerHTML = "";
    
    let displayData = [];

    // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šæ ¹æ®å½“å‰åˆ†ç±»ï¼Œå»ä¸åŒçš„æ•°æ®åº“å–æ•°æ®
    if (currentProfCategory === 'ENTITIES') {
        // ã€è§’è‰²é¡µã€‘ï¼šè¯»å– char_list
        const charList = await loadFromDB('char_list') || [];
        // åŒé‡ä¿é™©ï¼šè¿‡æ»¤æ‰å¯èƒ½æ®‹ç•™çš„ SYSTEM
        displayData = charList.filter(c => c.category !== 'SYSTEM');
    } else {
        // ã€ç³»ç»Ÿé¡µã€‘ï¼šè¯»å– system_services_db (æ‚¨åˆšæ‰å­˜çš„åœ°æ–¹)
        const systemList = await loadFromDB('system_services_db') || [];
        displayData = systemList;
    }

    // 2. ç‰©ç†æ¸²æŸ“
    if (!displayData || displayData.length === 0) {
        document.getElementById('prof-main-viewer').innerHTML = `<div class="prof-empty">NO DATA FOUND</div>`;
        return;
    }

    displayData.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `prof-avatar-item ${index === 0 ? 'active' : ''}`;
        div.onclick = () => profSelectEntity(item, div);
        
        // å¤´åƒé€»è¾‘
        const avatarUrl = item.avatar || `https://api.dicebear.com/7.x/identicon/svg?seed=${item.name}`;
        div.innerHTML = `<img src="${avatarUrl}">`;
        
        ring.appendChild(div);
        
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
        if (index === 0) profSelectEntity(item, div);
    });
};

/**
 * ğŸ” æ·±åº¦å±•ç¤ºï¼šè§’è‰²ä¸»å¡ç‰‡ + ç»‘å®šçš„ NPC çŸ©é˜µ (ä¿®å¤ç‰ˆ)
 */
window.profSelectEntity = async function(entity, el) {
    // 1. UI é€‰ä¸­æ€åˆ‡æ¢
    document.querySelectorAll('.prof-avatar-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
    
    const viewer = document.getElementById('prof-main-viewer');
    
    // 2. è·å–ç»‘å®šåœ¨è¯¥å®ä½“ä¸‹çš„æ‰€æœ‰ NPC
    const allNpcs = await loadFromDB('npc_list') || [];
    const linkedNpcs = allNpcs.filter(n => n.bind_id === entity.id);

    // 3. æ„é€  NPC å¡ç‰‡ HTML (æç®€é»‘ç™½è‰ºæœ¯é£)
    let npcCardsHtml = linkedNpcs.map(npc => `
        <div class="prof-npc-mini-card" onclick="profOpenNpcDetail('${npc.id}')">
            <div class="npc-card-side">
                <img src="${npc.avatar || 'https://api.dicebear.com/7.x/shapes/svg?seed='+npc.name}">
            </div>
            <div class="npc-card-main">
                <div class="npc-card-header">
                    <span class="npc-card-name">${npc.name}</span>
                    <span class="npc-card-id">#${String(npc.id).slice(-4)}</span>
                </div>
                <div class="npc-card-rel">ä¸ä¸»è§’è‰²å…³ç³»ï¼š${npc.rel_char || 'Unknown'}</div>
                <div class="npc-card-bio">${npc.desc || npc.bio || 'No fragments found.'}</div>
                <div class="npc-card-user-rel">ç”¨æˆ·é“¾ï¼š${npc.rel_user || 'Observer'}</div>
            </div>
        </div>
    `).join('');

    // 4. æ¸²æŸ“ä¸»è§†å›¾
    viewer.innerHTML = `
        <div class="prof-card">
            <div class="prof-entity-name">${entity.name}</div>
            <div class="prof-entity-tag">${currentProfCategory || 'ENTITY'}</div>
            <p class="prof-entity-desc">${entity.desc || 'No profile data available.'}</p>
            
            ${linkedNpcs.length > 0 ? `
                <div class="prof-linked-section">
                    <div class="prof-section-title">ASSOCIATED ENTITIES (${linkedNpcs.length})</div>
                    <div class="prof-npc-grid">${npcCardsHtml}</div>
                </div>
            ` : `<div class="prof-no-links">STANDALONE NODE</div>`}
        </div>
    `;

    // 5. ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šç‰©ç†é”å®šå½“å‰é‡‘åº“çš„è§’è‰² ID
    window.currentVaultCharID = entity.id;
    window.currentVaultCharName = entity.name;
    // å…¼å®¹ bio å’Œ desc å­—æ®µ
    window.currentVaultCharBio = entity.desc || entity.bio || ""; 

    // 6. ğŸš¨ å…³é”®ä¿®å¤ï¼šè¿™é‡Œä¹‹å‰æŠ¥é”™æ˜¯å› ä¸ºç›´æ¥ç”¨äº† idï¼Œå¿…é¡»ç”¨ entity.id
    localStorage.setItem('LUNE_LAST_SELECTED_CHAR_ID', entity.id);
    localStorage.setItem('LUNE_LAST_SELECTED_CHAR_NAME', entity.name);
    localStorage.setItem('LUNE_LAST_SELECTED_CHAR_BIO', window.currentVaultCharBio);

    console.log(`[ç³»ç»Ÿ] è§’è‰²å·²åˆ‡æ¢: ${entity.name} (ID: ${entity.id})`);

    // 7. è§¦å‘é‡‘åº“æ•°æ®åŒæ­¥
    if (typeof window.syncVaultDataToUI === 'function') {
        window.syncVaultDataToUI();
    }
    
    // 8. åˆ·æ–°è®°å½•é¡µåˆ—è¡¨
    if (typeof renderCharExpenseList === 'function') {
        renderCharExpenseList();
    }
    
    // 9. éœ‡åŠ¨åé¦ˆ
    if(navigator.vibrate) navigator.vibrate(10);
};

/**
 * åˆ‡æ¢ Tab (ENTITIES / SYSTEM)
 */
window.profSwitchTab = function(type, btn) {
    currentProfCategory = type;
    document.getElementById('prof-tab-title').innerText = type;
    
    document.querySelectorAll('.prof-nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    profRenderList();
};

// å…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰é€‰ä¸­çš„åˆ†ç±»
window.currentLmsgCategory = 'all';

/**
 * ğŸ”„ ä¿®å¤ç‰ˆï¼šæ ‡ç­¾åˆ‡æ¢å‡½æ•°
 * å¿…é¡»æ›´æ–°å…¨å±€å˜é‡ window.currentLmsgCategory
 */
window.lmsgSwitchTab = async function(category, element) {
    // 1. UI æ ·å¼åˆ‡æ¢
    document.querySelectorAll('.lmsg-nav-item').forEach(item => item.classList.remove('active'));
    element.classList.add('active');
    
    // 2. ğŸš€ æ ¸å¿ƒï¼šæ›´æ–°å…¨å±€è¿‡æ»¤çŠ¶æ€
    window.currentLmsgCategory = category;
    
    // 3. ğŸš€ æ ¸å¿ƒï¼šç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
    await renderLmsgList();
    
    // 4. éœ‡åŠ¨åé¦ˆ
    if(window.navigator.vibrate) window.navigator.vibrate(8);
    
    console.log(`System: Switched category to [${category}]`);
};

/* ------------------------------------------------------------
   LUNE MESSAGE - ç»Ÿä¸€é…ç½®ç®¡ç†ç³»ç»Ÿ (ç‰©ç†éš”ç¦»ç‰ˆ)
   ------------------------------------------------------------ */

// 1. è·å–ç»Ÿä¸€çš„é…ç½® Key
const getConfigKey = (id) => `lmsg_config_${id}`;

/**
 * ğŸ”“ å”¤èµ·è®¾ç½®å¼¹çª—ï¼šå¿…é¡»ä» DB å®æ—¶åŒæ­¥è¯¥è§’è‰²çš„é…ç½®
 */
window.refreshProfileSettingsUI = async function() {
    const contactId = window.currentActiveChatId;
    if (!contactId) return;

    const settingsKey = getConfigKey(contactId);
    // ç‰©ç†åŒæ­¥ï¼šåªè¯»å–å±äºè¿™ä¸ª ID çš„é…ç½®
    const settings = await loadFromDB(settingsKey) || {};
    
    // åŒæ­¥åˆ°ä¸´æ—¶å˜é‡ï¼ˆç”¨äºé¢„è§ˆï¼Œæœªç‚¹å‡» SAVE å‰ä¸å…¥åº“ï¼‰
    window.tempSettingLang = settings.aiLang || 'CN';
    window.tempSettingBg = settings.bgData ? { data: settings.bgData, type: settings.bgType } : null;

    // ğŸŒ UI è¯­è¨€é€‰é¡¹å½’ä½
    document.querySelectorAll('.lmsg-lang-option').forEach(opt => {
        opt.classList.remove('active');
        const code = opt.querySelector('.lang-code').innerText.trim();
        // å…¼å®¹ MIX å’Œ AUTO çš„æ˜ å°„
        const currentMatch = (window.tempSettingLang === 'AUTO' ? 'MIX' : window.tempSettingLang);
        if (code === currentMatch) opt.classList.add('active');
    });

    // ğŸ–¼ï¸ èƒŒæ™¯é¢„è§ˆå½’ä½
    const previewBox = document.getElementById('lmsg-bg-preview-box');
    if (previewBox) {
        if (window.tempSettingBg) {
            const { data, type } = window.tempSettingBg;
            previewBox.innerHTML = type === 'video' 
                ? `<video src="${data}" autoplay muted loop style="width:100%;height:100%;object-fit:cover;"></video>`
                : `<img src="${data}" style="width:100%;height:100%;object-fit:cover;">`;
        } else {
            previewBox.innerHTML = `<div class="lmsg-preview-placeholder">NO AMBIENCE</div>`;
        }
    }
};

/**
 * ğŸ’¾ ç‰©ç†ä¿å­˜ï¼šå°†ä¿®æ”¹æ­£å¼é”å®šåˆ°å½“å‰ ID
 */
window.saveIndividualSettings = async function() {
    const contactId = window.currentActiveChatId;
    if (!contactId) return;

    // å¿…é¡»ä¹Ÿæ˜¯ lmsg_config_ID
    const settingsKey = `lmsg_config_${contactId}`;
    
    const config = {
        aiLang: window.tempSettingLang || 'CN',
        bgData: window.tempSettingBg?.data || null,
        bgType: window.tempSettingBg?.type || 'image'
    };

    await saveToDB(settingsKey, config); // ç‰©ç†å…¥åº“
    
    // åŒæ—¶ä¹Ÿåˆ«å¿˜äº†ç‰©ç†æ›´æ–°ä¸€ä¸‹å½“å‰çš„è¯¦æƒ…é¡µèƒŒæ™¯ï¼Œè®©ä½ ç«‹åˆ»çœ‹åˆ°æ•ˆæœ
    applyChatBackground(config.bgData, config.bgType);

    showToast("ARCHIVE SEALED");
    setTimeout(closeEntityProfile, 400);
};

// å®šä¹‰ä¸¤ä¸ªå…¨å±€æš‚å­˜å˜é‡
window.tempSettingLang = null;
window.tempSettingBg = null; 

// ä¿®æ”¹ setAiLang è®©ä»–åªæ”¹ä¸´æ—¶å˜é‡ä¸å­˜åº“
window.setAiLang = function(lang, el) {
    window.tempSettingLang = lang; // æš‚å­˜
    document.querySelectorAll('.lmsg-lang-option').forEach(opt => opt.classList.remove('active'));
    el.classList.add('active');
};

/**
 * ğŸª„ ç»ˆææ­»ç£•ç‰ˆï¼šé˜²æ³¨æ„åŠ›æ¼‚ç§» + å¼ºåˆ¶å…¨ç¨‹å¤–è¯­
 * è§£å†³ï¼šAI å‘ç€å‘ç€å˜å›ä¸­æ–‡çš„é—®é¢˜
 */
window.triggerAiReply = async function() {
    const contactId = window.currentActiveChatId;
    if (!contactId || window.isLmsgAiProcessing) return;

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    
    if (!apiKey) return showToast("API KEY MISSING");

    window.isLmsgAiProcessing = true;
    const flow = document.getElementById('lmsg-chat-flow');

    // 1. æ ‡è®°å·²è¯»
    if (typeof markUserMsgAsRead === 'function') {
        await markUserMsgAsRead(contactId); 
    }

    try {
        const charList = await loadFromDB('char_list') || [];
        const char = charList.find(c => c.id === contactId) || { name: "æœªçŸ¥", desc: "" };
        const settingsKey = `lmsg_config_${contactId}`;
        const settings = await loadFromDB(settingsKey) || {};
        
        // ğŸŒŸ 1. å†…ç½®è¯­è¨€å­—å…¸
        const langCode = settings.aiLang || 'CN'; 
        const langMap = {
            'CN': 'ä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰',
            'HK': 'ç²¤è¯­ï¼ˆCantoneseï¼‰', 
            'EN': 'è‹±è¯­ï¼ˆEnglishï¼‰',
            'JP': 'æ—¥è¯­ï¼ˆJapaneseï¼‰',
            'KR': 'éŸ©è¯­ï¼ˆKoreanï¼‰',
            'TH': 'æ³°è¯­ï¼ˆThaiï¼‰',           
            'FR': 'æ³•è¯­', 'DE': 'å¾·è¯­', 'RU': 'ä¿„è¯­',
            'ES': 'è¥¿ç­ç‰™è¯­', 'IT': 'æ„å¤§åˆ©è¯­', 'MIX': 'åŒè¯­æ··åˆæ¨¡å¼'
        };
        const targetLangDesc = langMap[langCode] || 'ä¸­æ–‡';
        const needsTranslation = (langCode !== 'CN');

        console.log(`[LUNE SYSTEM] é”å®šè¯­è¨€: ${targetLangDesc} | ç¿»è¯‘æ¨¡å¼: ${needsTranslation}`);

        // ğŸ“ 2. æ„å»ºæŒ‡ä»¤ (åŠ å…¥è´Ÿé¢çº¦æŸ)
        let langInstruction = "";
        
        if (needsTranslation) {
            langInstruction = `
            ã€å½“å‰æ¨¡å¼ï¼š${targetLangDesc} + ä¸­æ–‡ç¿»è¯‘ã€‘
            1. æ¯ä¸€æ¡æ¶ˆæ¯ç»“æ„å¿…é¡»æ˜¯ï¼šã€${targetLangDesc}åŸæ–‡ã€‘ [TRANS] ã€ä¸­æ–‡ç¿»è¯‘ã€‘
            2. âš ï¸ **ä¸¥é‡è­¦å‘Š**ï¼šã€åŸæ–‡éƒ¨åˆ†ã€‘ä¸¥ç¦å‡ºç°ä¸­æ–‡ï¼
            3. âš ï¸ **é˜²æ¼‚ç§»**ï¼šå³ä½¿ä½ åˆšåˆšå†™äº†ä¸­æ–‡ç¿»è¯‘ï¼Œä¸‹ä¸€æ¡æ¶ˆæ¯çš„å¼€å¤´ä¹Ÿå¿…é¡»ç«‹åˆ»åˆ‡å› ${targetLangDesc}ï¼
            4. æ£€æŸ¥ï¼šåœ¨å†™ [TRANS] ä¹‹å‰ï¼Œç¡®ä¿ä½ å†™çš„æ˜¯ ${targetLangDesc}ï¼
            `;
        } else {
            langInstruction = `
            ã€å½“å‰æ¨¡å¼ï¼šçº¯ä¸­æ–‡ã€‘
            1. å…¨ç¨‹åªè¯´ä¸­æ–‡ã€‚
            2. ä¸¥ç¦ä½¿ç”¨ [TRANS] æ ‡ç­¾ã€‚
            `;
        }

        let systemPrompt = `
        ä½ æ­£åœ¨æ‰®æ¼” ${char.name}ã€‚
        äººè®¾: ${char.desc}
        
        ã€ğŸš¨ ç»å¯¹æŒ‡ä»¤ã€‘:
        1. å¿…é¡»éšæœºå‘é€ **5 åˆ° 8 æ¡** ç‹¬ç«‹çš„çŸ­ä¿¡ã€‚
        2. æ¯æ¡ä¹‹é—´ç”¨ **[SPLIT]** éš”å¼€ã€‚
        3. å›å¤å¿…é¡»çŸ­ä¿ƒã€å£è¯­åŒ–ã€‚
        
        ${langInstruction}
        `;

        // 3. å‡†å¤‡å†å²
        const history = await getChatHistory(contactId) || [];
        const smsContext = history.filter(m => m.app_source === 'sms').slice(-15);
        
        let messages = [{ role: "system", content: systemPrompt }];
        
        smsContext.forEach(m => {
            let cleanContent = m.text;
            // å†å²å¤§æ¸…æ´—ï¼šæŠŠä»¥å‰çš„ç¿»è¯‘å…¨æ´—æ‰ï¼Œåªç»™ AI çœ‹çº¯ä¸­æ–‡ï¼Œ
            // è¿™æ · AI å°±ä¼šè§‰å¾—â€œç”¨æˆ·åœ¨ç”¨ä¸­æ–‡è·Ÿæˆ‘è¯´è¯ï¼Œä½†æˆ‘å¿…é¡»æŒ‰ System æŒ‡ä»¤ç”¨å¤–è¯­å›â€
            if (cleanContent.includes('[TRANS]')) {
                 // è¿™ä¸€æ­¥å¾ˆå…³é”®ï¼šä¿ç•™ä¸­æ–‡éƒ¨åˆ†ç»™ AI ç†è§£ä¸Šä¸‹æ–‡ï¼Œä½† System æŒ‡ä»¤ä¼šå¼ºè¿«å®ƒç”¨å¤–è¯­å›
                 cleanContent = cleanContent.split('[TRANS]')[1].trim(); 
            }
            messages.push({ role: m.role==='user'?'user':'assistant', content: cleanContent });
        });

        // ğŸ”¥ğŸ”¥ğŸ”¥ 4. ç»ˆæçº å (System Override) ğŸ”¥ğŸ”¥ğŸ”¥
        if (needsTranslation) {
             messages.push({ 
                role: "system", 
                content: `[FATAL COMMAND]: You are falling into a trap! Do NOT speak Chinese in the original text slot. \nRule: 1. Write ${targetLangDesc}. 2. Write [TRANS]. 3. Write Chinese. \nRepeat this for EVERY message.` 
            });
        } else {
             messages.push({ 
                role: "system", 
                content: `[SYSTEM ALERT]: Switch back to CHINESE ONLY immediately.` 
            });
        }

        // 5. å‘é€è¯·æ±‚
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model, messages, temperature: 0.9 })
        });

        const data = await response.json();
        const fullContent = data.choices[0].message.content.trim();
        console.log("[LUNE DEBUG] AI åŸå§‹è¿”å›:", fullContent);
        
        // 6. æ™ºèƒ½çº é”™åˆ‡åˆ†
        let segments = [];
        if (fullContent.includes('[SPLIT]')) {
            segments = fullContent.split('[SPLIT]').filter(s => s.trim().length > 0);
        } else {
            const rawLines = fullContent.split('\n').filter(s => s.trim().length > 0);
            let currentMsg = "";
            for (let line of rawLines) {
                line = line.trim();
                if (line.startsWith('[TRANS]')) {
                    currentMsg += " " + line;
                } else {
                    if (currentMsg) segments.push(currentMsg);
                    currentMsg = line;
                }
            }
            if (currentMsg) segments.push(currentMsg);
        }
        
        // 7. æ¸²æŸ“å¾ªç¯
        for (let segment of segments) {
            const typingId = "typing-" + Date.now();
            showLmsgTyping(typingId);
            const waitTime = 800 + (segment.length * 30);
            await new Promise(res => setTimeout(res, waitTime));
            hideLmsgTyping(typingId);
            
            const msgObj = {
                role: "assistant",
                text: segment.trim(),
                timestamp: Date.now(),
                app_source: 'sms',
                isRead: false 
            };
            
            await saveChatMessage(contactId, msgObj);
            
            const row = document.createElement('div');
            row.className = `lmsg-chat-row row-left`;

            if (isSystemId(contactId)) {
                row.innerHTML = renderSmsComplexBubble(msgObj);
            } else {
                row.innerHTML = renderStandardBubble(msgObj);
            }
            
            flow.appendChild(row);
            flow.scrollTop = flow.scrollHeight;
            await renderLmsgList();
        }

    } catch (e) {
        console.error(e);
        showToast("AI Error: " + e.message);
    } finally {
        window.isLmsgAiProcessing = false;
    }
};

// --- ğŸš¨ å¼ºåŠ›é©±åŠ¨ï¼šæ‰“å¼€èŠå¤©å®¤ (éš”ç¦»ç‰ˆ) ---
// --- ğŸš¨ ä¿®æ”¹åçš„ openChatRoom å‡½æ•° ---
window.openChatRoom = async function(contact) {
    const page = document.getElementById('page-chat-room');
    if (!page || !contact || !contact.id) return;

    window.currentChattingWith = contact;
    window.currentActiveChatId = contact.id;
    
    document.getElementById('room-contact-name').textContent = contact.name;
    document.getElementById('room-contact-avatar').src = contact.avatar;
    
    // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šä¸è¦è°ƒç”¨ refreshRoomMessages
    // ç»Ÿä¸€è°ƒç”¨ renderMessagesï¼Œç¡®ä¿å®ƒå¾€æ­£ç¡®çš„ id="chat-messages-container" é‡Œå¡«å†…å®¹
    await renderMessages(); 

    page.style.display = 'flex';
    void page.offsetWidth; 
    page.classList.add('active-room');

    if(typeof applyBackgroundsToUI === 'function') {
        applyBackgroundsToUI();
    }
}

/**
 * ğŸ”’ èŠå¤©å®¤ä¸“ç”¨ï¼šåªè¯»å–å±äº chat_room çš„æ¶ˆæ¯
 */
window.refreshRoomMessages = async function(contactId) {
    const flow = document.getElementById('chat-room-flow');
    if (!flow || !contactId) return;

    // 1. è·å–è¯¥è”ç³»äººçš„æ‰€æœ‰åŸå§‹å†å²
    const allHistory = await getChatHistory(contactId) || [];

    // 2. ğŸš€ æ ¸å¿ƒè¿‡æ»¤ï¼š
    // åªä¿ç•™ source æ˜¯ 'chat_room' çš„æ¶ˆæ¯ã€‚
    // æ­¤æ—¶ï¼Œapp_source ä¸º 'sms' çš„å’Œ type ä¸º 'call_log' çš„éƒ½ä¼šè¢«æŒ¡åœ¨å¤–é¢ã€‚
    const roomOnly = allHistory.filter(m => m.source === 'chat_room');

    // 3. ç‰©ç†æ¸²æŸ“
    flow.innerHTML = ""; // å…ˆæ¸…ç©º
    roomOnly.forEach(msg => {
        // è°ƒç”¨ä½ åŸæ¥çš„æ°”æ³¡ç”Ÿæˆå‡½æ•°
        if (typeof renderRoomBubble === 'function') {
            renderRoomBubble(msg.text, msg.role === 'user', msg.timestamp);
        }
    });

    // æ»šåŠ¨åˆ°åº•éƒ¨
    flow.scrollTop = flow.scrollHeight;
};
/**
 * ğŸ§¹ ä¿®å¤ï¼šé‡ç½®èƒŒæ™¯å‡½æ•°
 */
window.resetChatBg = async function() {
    if (!window.currentActiveChatId) return;

    // 1. ç‰©ç†åˆ é™¤ï¼šä»æ•°æ®åº“ä¸­ç§»é™¤è¯¥è”ç³»äººçš„èƒŒæ™¯è®¾ç½®
    const settingsKey = `lmsg_set_${window.currentActiveChatId}`;
    await saveToDB('lmsg_app_settings', { id: settingsKey, data: null });

    // 2. è§†è§‰ç§»é™¤ï¼šåˆ æ‰è¯¦æƒ…é¡µé‡Œçš„èƒŒæ™¯ DOM
    const chatBody = document.getElementById('lmsg-chat-flow');
    const oldBg = chatBody.querySelector('.lmsg-custom-bg');
    if (oldBg) oldBg.remove();

    // 3. UI åˆ·æ–°
    refreshProfileSettingsUI();
    showToast("AMBIENCE RESET");
    if(navigator.vibrate) navigator.vibrate(10);
};
/**
 * ğŸ”“ å”¤èµ·/å…³é—­å¼¹çª—
 */
window.openEntityProfile = function() {
    const modal = document.getElementById('lmsg-entity-profile-modal');
    modal.style.display = 'flex';
    // åˆ·æ–°å½“å‰çš„è®¾ç½®é¢„è§ˆ
    refreshProfileSettingsUI();
};

window.closeEntityProfile = function() {
    document.getElementById('lmsg-entity-profile-modal').style.display = 'none';
};

/**
 * ğŸ–¼ï¸ ä¿®å¤ç‰ˆï¼šèƒŒæ™¯ä¸Šä¼  (æ”¹ç”¨ IndexedDB è§£å†³ç©ºé—´ä¸è¶³æŠ¥é”™)
 */
window.handleBgUpload = function(input, type) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        // ä»…ä¿®æ”¹å†…å­˜ä¸­çš„ä¸´æ—¶å˜é‡
        window.tempSettingBg = { data: e.target.result, type: type };
        // åˆ·æ–°é¢„è§ˆåŒºåŸŸ
        const previewBox = document.getElementById('lmsg-bg-preview-box');
        if (previewBox) {
            previewBox.innerHTML = type === 'video' 
                ? `<video src="${e.target.result}" autoplay muted loop style="width:100%;height:100%;object-fit:cover;"></video>`
                : `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
        }
        showToast("PREVIEW READY - CLICK SAVE");
    };
    reader.readAsDataURL(file);
};

/**
 * ğŸ¨ ä¿®å¤ç‰ˆï¼šå®ç°çœŸæ­£çš„å…¨å±å…¨å±€èƒŒæ™¯
 */
window.applyChatBackground = function(data, type) {
    const chatWin = document.getElementById('lmsg-chat-window'); // ğŸš€ ç›®æ ‡æ”¹ä¸ºæœ€å¤–å±‚çª—å£
    if (!chatWin) return;

    // 1. å¯»æ‰¾æˆ–åˆ›å»ºå…¨å±€èƒŒæ™¯å±‚
    let bgContainer = chatWin.querySelector('.lmsg-custom-bg-global');
    if (!bgContainer) {
        bgContainer = document.createElement('div');
        bgContainer.className = 'lmsg-custom-bg-global';
        // ç¡®ä¿å®ƒåœ¨æœ€åº•å±‚
        chatWin.prepend(bgContainer); 
    }

    if (!data) {
        bgContainer.remove();
        return;
    }

    // 2. æ¸²æŸ“å†…å®¹
    if (type === 'video') {
        bgContainer.innerHTML = `<video src="${data}" autoplay muted loop style="width:100%; height:100%; object-fit:cover;"></video>`;
    } else {
        bgContainer.innerHTML = `<div style="width:100%; height:100%; background:url(${data}) center/cover no-repeat;"></div>`;
    }
};

// ----------------------------------------------------
// ğŸš€ ç¡®ä¿åˆ·æ–°åä¸ä¸¢å¤±ï¼šåœ¨æ‰“å¼€è¯¦æƒ…é¡µæ—¶è¯»å–èƒŒæ™¯
// ----------------------------------------------------
const originalOpenChat = window.openChatWindow;

/**
 * ğŸš€ è¯¦æƒ…é¡µä¸“å±ï¼šç›´æ¥å‘é€å‡½æ•° (åŒºåˆ†äºæ’°å†™é¡µ)
 */
// ä¿®æ”¹è¯¦æƒ…é¡µå‘é€é€»è¾‘
window.lmsgDetailSendMessage = async function() {
    const input = document.getElementById('lmsg-chat-input');
    const text = input.value.trim();
    if (!text || !window.currentActiveChatId) return;

    await saveChatMessage(window.currentActiveChatId, {
        role: "user",
        text: text,
        timestamp: Date.now(),
        // ğŸš€ å…³é”®ï¼šæ ‡è®°è¿™æ¡æ¶ˆæ¯å±äºçŸ­ä¿¡ App
        app_source: 'sms' 
    });

    renderBubbleToFlow(text, true, Date.now(), "å·²å‘é€");
    renderLmsgList(); // åˆ·æ–°åˆ—è¡¨
    input.value = "";
    checkDraftStatus();
};

/**
 * ğŸš€ æ¶ˆæ¯åˆ—è¡¨å®æ—¶æ¸²æŸ“
 */
window.renderLmsgList = async function() {
    const container = document.getElementById('lmsg-realtime-list');
    if (!container) return;

    const friends = await loadFromDB('chat_friends') || [];
    const currentCategory = window.currentLmsgCategory || 'all';
    
    let listData = [];

    for (let f of friends) {
        // 1. è·å–è¯¥è”ç³»äººçš„æ‰€æœ‰çŸ­ä¿¡å†å²
        const history = await getChatHistory(f.id) || [];
        const smsMsgs = history.filter(m => m.app_source === 'sms');
        
        // 2. ğŸ” æ ¸å¿ƒï¼šè®¡ç®—æœªè¯»æ¶ˆæ¯æ•°é‡ (è§’è‰²æ˜¯å¯¹æ–¹ï¼Œä¸”æ ‡è®°ä¸ºæœªè¯»)
        // å‡è®¾ä½ çš„æ¶ˆæ¯å¯¹è±¡é‡Œæœ‰ role: "assistant" å’Œ isRead: false
        const unreadCount = smsMsgs.filter(m => m.role === 'assistant' && m.isRead === false).length;

        // 3. ğŸ è¿‡æ»¤é€»è¾‘åˆ¤æ–­
        let shouldShow = false;
        if (currentCategory === 'all') shouldShow = true;
        else if (currentCategory === 'unread') shouldShow = unreadCount > 0;
        else if (currentCategory === 'direct') shouldShow = !f.isGroup && !f.isSystem && !f.isStranger;
        else if (currentCategory === 'groups') shouldShow = f.isGroup;
        else if (currentCategory === 'strangers') shouldShow = f.isStranger;
        else if (currentCategory === 'system') shouldShow = f.isSystem;

        if (!shouldShow) continue; // ä¸ç¬¦åˆæ¡ä»¶çš„ç›´æ¥è·³è¿‡

        // 4. æå–é¢„è§ˆæ–‡å­— (å¤„ç† [TRANS] é€»è¾‘)
        const lastMsgObj = smsMsgs.length > 0 ? smsMsgs[smsMsgs.length - 1] : null;
        let previewText = lastMsgObj ? lastMsgObj.text : "No transmissions";
        if (lastMsgObj && lastMsgObj.text.includes('[TRANS]')) {
            previewText = lastMsgObj.text.split('[TRANS]')[1]?.trim() || lastMsgObj.text.split('[TRANS]')[0];
        }

        listData.push({
            ...f,
            lastMsg: previewText,
            timestamp: lastMsgObj ? lastMsgObj.timestamp : 0,
            unreadCount: unreadCount // æŠŠæœªè¯»æ•°å­˜è¿›å»
        });
    }

    // æ’åºï¼šæœ€æ–°æ¶ˆæ¯ç½®é¡¶
    listData.sort((a, b) => b.timestamp - a.timestamp);

    // 5. ç‰©ç†æ¸²æŸ“ DOM
    container.innerHTML = ""; 
    if (listData.length === 0) {
        container.innerHTML = `<div class="lmsg-empty-hint">EMPTY ${currentCategory.toUpperCase()} ARCHIVE</div>`;
        return;
    }

    listData.forEach(item => {
        const timeStr = item.timestamp ? new Date(item.timestamp).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'}) : "";
        const identityClass = item.isAI ? "lmsg-identity-blue" : "lmsg-identity-green";

        const div = document.createElement('div');
        div.className = `lmsg-item ${identityClass}`;
        div.onclick = () => openChatWindow(item.id);

        div.innerHTML = `
            <div class="lmsg-identity-strip"></div> 
            <div class="lmsg-avatar">
                <img src="${item.avatar}">
            </div>
            <div class="lmsg-info">
                <div class="lmsg-info-top">
                    <span class="lmsg-sender-name">${item.name}</span>
                    <span class="lmsg-meta-time">${timeStr}</span>
                </div>
                <div class="lmsg-info-bottom">
                    <p class="lmsg-msg-preview">${item.lastMsg}</p>
                    ${item.unreadCount > 0 ? `<div class="lmsg-unread-indicator"></div>` : ''}
                </div>
            </div>
        `;
        container.appendChild(div);
    });
};

/**
 * ğŸš€ æ ¸å¿ƒï¼šæ­£å¼æäº¤å¹¶åˆ·æ–°åˆ—è¡¨
 */
window.commitFinalMessages = async function() {
    if (!currentActiveChatId) return;

    // 1. è·å–é¢„è§ˆåŒºæ‰€æœ‰â€œæœªè¯»â€æ ‡è®°çš„æ°”æ³¡
    const flow = document.getElementById('lmsg-chat-flow');
    const unreadLabels = flow.querySelectorAll('.lmsg-meta-status');
    const messagesToSave = [];

    unreadLabels.forEach(label => {
        if (label.innerText === "æœªè¯»") {
            // å‘ä¸Šæ‰¾æ°”æ³¡å†…å®¹ï¼Œæ’é™¤æ‰å…ƒæ•°æ®æ ‡ç­¾
            const bubble = label.closest('.lmsg-user-bubble');
            if (bubble) {
                // ä»…æå–çº¯æ–‡æœ¬
                const text = bubble.childNodes[0].textContent.trim();
                messagesToSave.push(text);
                
                // è§†è§‰å³æ—¶åé¦ˆï¼šå˜ç°å¹¶æ”¹çŠ¶æ€
                label.innerText = "å·²å‘é€";
                label.style.color = "#BCBCC2";
            }
        }
    });

    if (messagesToSave.length === 0) return;

    // 2. ç‰©ç†å­˜ç›˜
    for (let txt of messagesToSave) {
        await saveChatMessage(currentActiveChatId, {
            role: "user",
            text: txt,
            timestamp: Date.now()
        });
    }

    // 3. ğŸš€ å…³é”®ï¼šå­˜å®Œç«‹å³å¼ºåˆ·ä¸»åˆ—è¡¨
    await renderLmsgList();

    // åœ¨ commitFinalMessages å‡½æ•°å†…éƒ¨æ¸²æŸ“æ—¶
    // å‘é€æˆåŠŸååˆ·æ–°åˆ—è¡¨å‰ï¼Œç¡®ä¿é¡µé¢ä¸Šçš„â€œæœªè¯»â€æ ‡è®°å˜æ‰
    document.querySelectorAll('.lmsg-meta-status').forEach(el => {
        if (el.innerText === "æœªè¯»") {
            el.innerText = "å·²å‘é€";
            el.style.opacity = "0.7"; // ç¨å¾®å‡å¼±ä¸€ç‚¹è§†è§‰æƒé‡
        }
    });

    // 4. é‡ç½®æŒ‰é’®
    document.getElementById('chat-final-send-btn').disabled = true;
    showToast("Commited to Entity");
    if(navigator.vibrate) navigator.vibrate([10, 30]);
};

/**
 * ğŸ“ ç‚¹å‡»åº•éƒ¨æŒ‰é’®ï¼šå°†å†…å®¹åŠ å…¥æ‹Ÿç¨¿é¢„è§ˆåŒº
 */
window.addMessageToDraft = function() {
    const input = document.getElementById('lmsg-chat-input');
    const text = input.value.trim();
    if (!text) return;

    // æ¸²æŸ“é¢„è§ˆæ°”æ³¡ï¼ŒçŠ¶æ€ä¸ºâ€œæœªè¯»â€
    renderBubbleToFlow(text, true, Date.now(), "æœªè¯»");
    

    input.value = "";
    checkDraftStatus();
    
    // ğŸš€ æ¿€æ´»é¡¶éƒ¨æ­£å¼å‘é€æŒ‰é’®
    document.getElementById('chat-final-send-btn').disabled = false;
    
    if(navigator.vibrate) navigator.vibrate(10);
};

/**
 * ğŸ› ï¸ ä¿®å¤ï¼šè¯¦æƒ…é¡µè¾“å…¥æ¡†çŠ¶æ€æ£€æŸ¥
 */
window.checkDraftStatus = function() {
    const input = document.getElementById('lmsg-chat-input');
    // ğŸš€ å…³é”®ï¼šè¿™é‡Œå¿…é¡»å¯¹åº”ä½ è¯¦æƒ…é¡µæ–°æŒ‰é’®çš„ ID
    const btn = document.getElementById('lmsg-detail-send-trigger');
    
    if (btn && input) {
        // å¦‚æœè¾“å…¥æ¡†æ²¡æœ‰å†…å®¹ï¼ŒæŒ‰é’®ç¦ç”¨
        btn.disabled = input.value.trim().length === 0;
    } else {
        console.warn("æœªæ‰¾åˆ°è¯¦æƒ…é¡µå‘é€æŒ‰é’®æˆ–è¾“å…¥æ¡†ï¼Œè¯·æ£€æŸ¥ HTML ID æ˜¯å¦ä¸º lmsg-detail-send-trigger");
    }
};

let currentActiveChatId = null; // è¿½è¸ªå½“å‰æ­£åœ¨å’Œè°èŠå¤©

/**
 * ğŸ”“ ä¿®å¤ç‰ˆï¼šæ‰“å¼€çŸ­ä¿¡è¯¦æƒ…é¡µ (å†å²è®°å½•æ­£ç¡®æ¸²æŸ“)
 */
window.openChatWindow = async function(contactId) {
    const realId = String(contactId);
    window.currentActiveChatId = realId;

    const win = document.getElementById('lmsg-chat-window');
    const flow = document.getElementById('lmsg-chat-flow');
    if (!win || !flow) return;

    // UI åˆå§‹åŒ–
    win.querySelectorAll('.lmsg-custom-bg-global').forEach(el => el.remove());
    win.style.backgroundColor = "#FFFFFF"; 
    flow.innerHTML = `<div class="lmsg-date-divider">SECURE CONNECTION</div>`;

    try {
        // --- ğŸš¨ 1. ä½¿ç”¨æ–°åº“åŠ è½½å¥½å‹åˆ—è¡¨ ---
        const friends = await window.ib.getItem('chat_friends') || [];
        const target = friends.find(f => String(f.id) === realId);
        if (target) {
            document.getElementById('chat-target-name').innerText = target.name;
            document.getElementById('chat-target-avatar').src = target.avatar;
        }

        // --- ğŸš¨ 2. ä½¿ç”¨æ–°åº“åŠ è½½èŠå¤©å®¤é…ç½® ---
        const settingsKey = `lmsg_config_${realId}`; 
        const settings = await window.ib.getItem(settingsKey) || {};
        if (settings.bgData) applyChatBackground(settings.bgData, settings.bgType);

        // --- ğŸš¨ 3. ä½¿ç”¨æ–°åº“åŠ è½½èŠå¤©å†å² ---
        // ç¡®ä¿ Key çš„å‘½åè§„åˆ™ä¸ä½ ä¿å­˜(setItem)æ—¶ä¸€è‡´
        const historyKey = `chat_history_${realId}`;
        const historyData = await window.ib.getItem(historyKey) || { messages: [] };
        const chatHistory = historyData.messages || []; 
        
        // æ¸²æŸ“å¾ªç¯
        chatHistory.forEach(msg => {
            const row = document.createElement('div');
            row.className = `lmsg-chat-row ${msg.role === 'user' ? 'row-right' : 'row-left'}`;

            let html = "";
            
            // åˆ¤æ–­é€»è¾‘ï¼šåªæœ‰å½“ã€æ¥æºæ˜¯SMSã€‘ä¸”ã€å‘é€è€…æ˜¯ç³»ç»Ÿå·ã€‘ä¸”ã€ä¸æ˜¯ç”¨æˆ·å‘çš„ã€‘æ—¶ï¼Œæ‰ç”¨å¡ç‰‡
            if (msg.app_source === 'sms' && isSystemId(realId) && msg.role !== 'user') {
                html = renderSmsComplexBubble(msg); // ç³»ç»Ÿå¡ç‰‡
            } else {
                html = renderStandardBubble(msg);   // æ™®é€šæ°”æ³¡
            }

            row.innerHTML = html;
            flow.appendChild(row);
        });

        // --- ğŸš¨ 4. æ ‡è®°å·²è¯» (é€‚é…æ–°åº“çš„ setItem é€»è¾‘) ---
        const unreadMsgs = chatHistory.filter(m => m.role === 'assistant' && !m.isRead);
        if (unreadMsgs.length > 0) {
            // æ›´æ–°å†…å­˜ä¸­çš„æ¶ˆæ¯çŠ¶æ€
            const updatedMessages = chatHistory.map(m => 
                m.role === 'assistant' ? { ...m, isRead: true } : m
            );
            
            // æ„é€ å®Œæ•´å¯¹è±¡å¹¶å­˜å›æ–°åº“
            // è¿™ç§â€œå…ˆè¯»åå­˜â€çš„æ¨¡å¼è§„é¿äº†ä½ ä¹‹å‰é‡åˆ°çš„ DataError
            await window.ib.setItem(historyKey, { 
                contactId: realId, 
                messages: updatedMessages 
            });

            if (typeof renderLmsgList === 'function') renderLmsgList();
        }

    } catch (err) { 
        console.error("Lune OS æ¸²æŸ“å¼•æ“å¼‚å¸¸:", err); 
    } 
    finally {
        win.classList.add('active');
        setTimeout(() => { flow.scrollTop = flow.scrollHeight; }, 50);
    }
};

// ----------------------------------------------------
// ğŸš¨ ç»ˆæè§£å†³æ–¹æ¡ˆï¼šåœ¨é¡µé¢åŠ è½½å®Œæˆæ—¶ç«‹åˆ»åˆ·æ–°åˆ—è¡¨ ğŸš¨
// ----------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // å¦‚æœå½“å‰é»˜è®¤æ˜¾ç¤ºçš„æ˜¯ Dashboardï¼Œç«‹å³åˆå§‹åŒ–
    const dashPanel = document.getElementById('tab-dashboard');
    if (dashPanel && (dashPanel.classList.contains('active') || dashPanel.style.display !== 'none')) {
        setTimeout(window.triggerDashboardInit, 200); // å»¶è¿Ÿ200msç­‰å¾…æ•°æ®åº“å°±ç»ª
    }
});

window.closeChatWindow = function() {
    document.getElementById('lmsg-chat-window').classList.remove('active');
};
// å­˜å‚¨å½“å‰æ‹Ÿç¨¿çš„æ‰€æœ‰æ¶ˆæ¯
let currentDraftMessages = [];

/**
 * 1. åº•éƒ¨æŒ‰é’®åŠ¨ä½œï¼šæ·»åŠ åˆ°é¢„è§ˆåŒº
 */
window.lmsgAddToPreview = function() {
    const input = document.getElementById('lmsg-message-input');
    const flow = document.getElementById('lmsg-preview-flow');
    const text = input.value.trim();

    if (!text) return;

    if (currentDraftMessages.length === 0) flow.innerHTML = "";
    currentDraftMessages.push(text);

    // ğŸš€ è°ƒç”¨åˆšåˆšå†™å¥½çš„ç²¾å‡†æ—¶é—´å‡½æ•°
    const timeStr = getLuneMessageTime();

    const bubbleWrapper = document.createElement('div');
    bubbleWrapper.style.display = 'contents';

    bubbleWrapper.innerHTML = `
        <div class="lmsg-draft-bubble">
            ${text}
            <div class="lmsg-bubble-meta-stack">
                <span class="lmsg-meta-status">æœªè¯»</span>
                <span class="lmsg-meta-time">${timeStr}</span>
            </div>
        </div>
    `;

    flow.appendChild(bubbleWrapper);
    flow.scrollTop = flow.scrollHeight;
    input.value = "";
    lmsgCheckCanSend();
    lmsgUpdateFinalSendState();

    if(navigator.vibrate) navigator.vibrate(10);
};

/**
 * 3. é¡¶éƒ¨æŒ‰é’®åŠ¨ä½œï¼šæœ€ç»ˆå…¨åŸŸå‘é€
 */
window.lmsgFinalCommit = async function() {
    const recipientValue = document.getElementById('lmsg-to-input').value;
    const msgInput = document.getElementById('lmsg-message-input'); // è·å–åº•éƒ¨çš„è¾“å…¥æ¡†
    
    // 1. ğŸš€ å…³é”®ï¼šä»è¾“å…¥å­—ç¬¦ä¸²ä¸­æå–å·ç  (ä¾‹å¦‚æå–å‡º 20011001)
    let targetId = null;
    const phoneMatch = recipientValue.match(/<([^>]+)>/);
    const phoneNum = phoneMatch ? phoneMatch[1] : null;

    if (phoneNum) {
        // 2. é€šè¿‡å·ç å» phone_directory åæŸ¥ ID
        const phoneDir = await loadFromDB('phone_directory') || {};
        // æŸ¥æ‰¾é”®åä¸º "id_xxx" çš„æ¡ç›®ï¼Œå…¶å€¼ç­‰äº phoneNum
        for (let key in phoneDir) {
            if (key.startsWith('id_') && phoneDir[key] === phoneNum) {
                targetId = key.replace('id_', '');
                break;
            }
        }
    }

    if (!targetId) {
        showToast("âš ï¸ æ— æ³•è¯†åˆ«æ”¶ä»¶äººæˆ–å·ç æœªç»‘å®š");
        return;
    }

    if (currentDraftMessages.length === 0) {
        showToast("âš ï¸ æ‹Ÿç¨¿ç®±ä¸ºç©º");
        return;
    }

    console.log("ğŸ› ï¸ ç‰©ç†å­˜ç›˜å¯åŠ¨ï¼šç›®æ ‡ ID =", targetId);

    // 3. ğŸ’¾ çœŸæ­£çš„å­˜å‚¨åŠ¨ä½œ
    for (let txt of currentDraftMessages) {
        await saveChatMessage(targetId, {
            role: "user",
            text: txt,
            timestamp: Date.now(),
            app_source: 'sms' // ğŸš€ ç‰©ç†éš”ç¦»æ ‡ç­¾
        });
    }

    // 4. ğŸ”„ å¼ºåŠ›é©±åŠ¨ä¸»åˆ—è¡¨æ¸²æŸ“
    if (typeof renderLmsgList === 'function') {
        await renderLmsgList();
        console.log("âœ… é¡µé¢åˆ—è¡¨å·²åŒæ­¥æ¸²æŸ“");
    }

    // 5. ğŸ æ”¶å°¾
    lmsgCloseCompose();
    currentDraftMessages = [];
    showToast("Commited to Entity");
};
/**
 * ğŸ“ å®æ—¶æ£€æŸ¥æ˜¯å¦å¯ä»¥å‘é€
 */
window.lmsgCheckCanSend = function() {
    const input = document.getElementById('lmsg-message-input');
    const sendBtn = document.getElementById('lmsg-actual-send-btn');
    const recipient = document.getElementById('lmsg-to-input').value;

    if (input.value.trim().length > 0 && recipient.length > 0) {
        sendBtn.disabled = false;
        sendBtn.classList.add('ready');
    } else {
        sendBtn.disabled = true;
        sendBtn.classList.remove('ready');
    }
};

/**
 * ğŸš€ æ ¸å¿ƒï¼šæ‰§è¡Œå‘é€æ¶ˆæ¯
 */
window.lmsgSendMessage = async function() {
    const recipientInput = document.getElementById('lmsg-to-input').value;
    const messageText = document.getElementById('lmsg-message-input').value;

    if (!recipientInput || !messageText) return;

    console.log("System: æ­£åœ¨å‘", recipientInput, "å‘é€æ¶ˆæ¯:", messageText);

    // 1. è§¦æ„Ÿåé¦ˆ
    if (window.navigator.vibrate) window.navigator.vibrate([10, 30]);

    // 2. è¿™é‡Œåç»­å¯ä»¥å¯¹æ¥ä½ çš„ IndexedDB ä¿å­˜é€»è¾‘ (saveChatMessage)
    // TODO: saveToMessageDB(recipientInput, messageText);

    // 3. æ’­æ”¾å‘é€æˆåŠŸçš„ UI åŠ¨ç”» (å¯é€‰)
    showToast("Message Sent");

    // 4. å…³é—­æ’°å†™çª—å£å¹¶æ¸…ç†
    lmsgCloseCompose();
};
// è¡¥å…¨å…³é—­é€»è¾‘
window.closePhoneAddModal = function() {
    const modal = document.getElementById('modal-phone-add-contact');
    if (modal) modal.style.display = 'none';
    // æ¸…ç†çŠ¶æ€
    window.tempPhoneAvatar = null;
    window.selectedImportId = null;
};
/**
 * ğŸš€ å”¤èµ·æ’°å†™é¡µé¢
 */
window.lmsgNewMessage = function() {
    const win = document.getElementById('lmsg-compose-window');
    win.classList.add('active');
    document.getElementById('lmsg-to-input').focus();
    if(navigator.vibrate) navigator.vibrate(10);
};

/**
 * 4. è¦†ç›–ä¹‹å‰çš„å…³é—­é€»è¾‘ï¼Œå¢åŠ æ•°æ®æ¸…ç†
 */
const originalClose = window.lmsgCloseCompose;
window.lmsgCloseCompose = function() {
    const composeWin = document.getElementById('lmsg-compose-window');
    
    if (composeWin) {
        // 1. ç§»é™¤ active ç±»ï¼Œè§¦å‘ä½ åœ¨ CSS é‡Œå†™çš„ transform æ»‘ä¸‹åŠ¨ç”»
        composeWin.classList.remove('active');
        
        // 2. ç‰©ç†åé¦ˆ (çŸ­éœ‡)
        if (window.navigator.vibrate) window.navigator.vibrate(8);

        // 3. å»¶æ—¶æ¸…ç†æ•°æ®ï¼šç­‰åŠ¨ç”»æ’­å®Œå†æ¸…ç©ºï¼Œé˜²æ­¢æ–‡å­—çªç„¶é—ªæ¶ˆå¤±
        setTimeout(() => {
            // æ¸…ç©ºæ”¶ä»¶äºº
            document.getElementById('lmsg-to-input').value = "";
            // æ¸…ç©ºåº•éƒ¨æ‹Ÿç¨¿æ¡†
            document.getElementById('lmsg-message-input').value = "";
            // æ¸…ç©ºä¸­é—´é¢„è§ˆæµ
            const flow = document.getElementById('lmsg-preview-flow');
            if(flow) flow.innerHTML = '<div class="lmsg-preview-hint">Drafting area...</div>';
            
            // é‡ç½®é€»è¾‘æ•°ç»„
            if (window.currentDraftMessages) window.currentDraftMessages = [];
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            lmsgUpdateFinalSendState(); 
            lmsgCheckCanSend();
            
            console.log("System: Compose Window Closed.");
        }, 400); // 400ms å¯¹åº”ä½ çš„ transition æ—¶é—´
    }
};

/**
 * ğŸ” æ ¸å¿ƒï¼šæœç´¢è”ç³»äººåº“å¹¶æ¸²æŸ“å¡ç‰‡
 */
window.lmsgSearchRecipient = async function(val) {
    const resultsContainer = document.getElementById('lmsg-recipient-results');
    if (!resultsContainer) return;

    const searchVal = val.trim().toLowerCase();
    
    // 1. ğŸš€ å¼ºåŠ›æ¸…ç©ºï¼šæœç´¢è¯ä¸ºç©ºæ—¶ç«‹å³æ¸…ç©ºå¹¶è¿”å›
    if (!searchVal) {
        resultsContainer.innerHTML = "";
        return;
    }

    // è®°å½•æœ¬æ¬¡æœç´¢æ ‡è®°ï¼Œé˜²æ­¢å¼‚æ­¥è¯·æ±‚å†²çª
    this.latestSearchQuery = searchVal;

    try {
        const friends = await loadFromDB('chat_friends') || [];
        const phoneDir = await loadFromDB('phone_directory') || {};

        // 2. ğŸš€ ç»ˆæå»é‡ï¼šä½¿ç”¨ Map å¹¶ä»¥â€œå§“å+å·ç â€ä¸ºå”¯ä¸€é”®
        const matchMap = new Map();
        friends.forEach(f => {
            const phone = phoneDir["id_" + f.id] || "";
            const name = f.name || "";
            if (name.toLowerCase().includes(searchVal) || phone.includes(searchVal)) {
                matchMap.set(`${name}_${phone}`, { ...f, displayPhone: phone });
            }
        });

        // 3. æ£€æŸ¥é”ï¼šå¦‚æœå½“å‰è¾“å…¥çš„è¯å·²ç»å˜äº†ï¼Œå°±ä¸å†æ‰§è¡Œæ¸²æŸ“ï¼Œé˜²æ­¢é‡å¤å åŠ 
        if (this.latestSearchQuery !== searchVal) return;

        // 4. æ‰§è¡Œæ¸²æŸ“ï¼ˆå…ˆæ¸…ç©ºä¸€æ¬¡ï¼Œå†æ·»åŠ ï¼‰
        resultsContainer.innerHTML = ""; 
        const fragment = document.createDocumentFragment();

        matchMap.forEach(m => {
            const card = document.createElement('div');
            card.className = 'lmsg-recipient-card';
            card.onclick = () => lmsgSelectRecipient(m.name, m.displayPhone);
            
            card.innerHTML = `
                <div class="lmsg-card-avatar">
                    ${m.avatar ? `<img src="${m.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : m.name[0]}
                </div>
                <div class="lmsg-card-info">
                    <span class="lmsg-card-name">${m.name}</span>
                    <span class="lmsg-card-phone">${m.displayPhone}</span>
                </div>
            `;
            fragment.appendChild(card);
        });

        resultsContainer.appendChild(fragment);

    } catch (e) {
        console.error("Recipient search failed:", e);
    }
};

/**
 * âœ… é€‰ä¸­è”ç³»äºº
 */
window.lmsgSelectRecipient = function(name, phone) {
    // 1. å¡«å…¥é€‰ä¸­çš„è”ç³»äººä¿¡æ¯
    const toInput = document.getElementById('lmsg-to-input');
    if (toInput) toInput.value = `${name} <${phone}>`;
    
    // 2. æ¸…ç©ºæœç´¢ç»“æœåˆ—è¡¨
    const results = document.getElementById('lmsg-recipient-results');
    if (results) results.innerHTML = "";
    
    // 3. ğŸš€ å…³é”®ä¿®å¤ï¼šå°†ç„¦ç‚¹å¯¹å‡†åº•éƒ¨çš„æ‹Ÿç¨¿è¾“å…¥æ¡†
    const msgInput = document.getElementById('lmsg-message-input');
    if (msgInput) {
        msgInput.focus(); 
    } else {
        console.warn("æœªæ‰¾åˆ° lmsg-message-inputï¼Œè¯·æ£€æŸ¥ HTML ID");
    }
    
    lmsgUpdateFinalSendState(); // æ›´æ–°é¡¶éƒ¨å‘é€æŒ‰é’®çŠ¶æ€
};

/**
 * æŒ‰é’®çŠ¶æ€æ§åˆ¶
 */
window.lmsgUpdateSendBtn = function() {
    const to = document.getElementById('lmsg-to-input').value;
    const msg = document.getElementById('lmsg-main-editor').value;
    document.getElementById('lmsg-send-btn').disabled = !(to && msg);
};
let pendingDeleteSessionIndex = null;

/**
 * ğŸ”“ å”¤èµ·ç¡®è®¤å¼¹çª— (ä½¿ç”¨é¡µé¢çº§å¼¹çª—ï¼Œä¸å¼¹æµè§ˆå™¨è‡ªå¸¦çš„)
 */
window.askDeleteSession = function(index) {
    pendingDeleteSessionIndex = index;
    const modal = document.getElementById('modal-session-delete-confirm');
    if (modal) {
        modal.style.display = 'flex';
        if(navigator.vibrate) navigator.vibrate(10);
    }
};

window.closeSessionDeleteModal = function() {
    const modal = document.getElementById('modal-session-delete-confirm');
    if (modal) modal.style.display = 'none';
};

/**
 * ğŸ—‘ï¸ æ ¸å¿ƒï¼šä»å†å²å­˜æ ¹å¡ç‰‡é¡µæ‰§è¡Œç‰©ç†é”€æ¯ (è”åŠ¨é€šè¯è®°å½•é¡µ)
 */
window.confirmDeleteSession = async function() {
    if (pendingDeleteSessionIndex === null) return;
    try {
        const sessionData = window.currentSessionCache[pendingDeleteSessionIndex];
        const sid = sessionData[0].sessionId; // ğŸ”‘ çµé­‚ ID
        const contactId = window.currentHistoryContactId;

        // --- ğŸš¨ 1. ç‰©ç†ä»é€šè¯è®°å½•åˆ—è¡¨åˆ é™¤ (ä½¿ç”¨æ–°åº“) ---
        // ç›´æ¥ getItem æ‹¿åˆ°æ•°ç»„ï¼Œè¿‡æ»¤åå† setItem å­˜å›å»
        let recents = await window.ib.getItem('phone_recents') || [];
        recents = recents.filter(r => r.sessionId !== sid);
        await window.ib.setItem('phone_recents', recents);

        // --- ğŸš¨ 2. ç‰©ç†ä»èŠå¤©æ°”æ³¡æ•°æ®åº“åˆ é™¤ (ä½¿ç”¨æ–°åº“) ---
        // æŒ‰ç…§ä½ æ–°åº“çš„ Key è§„èŒƒï¼ˆchat_history_IDï¼‰æ¥æ“ä½œ
        const historyKey = `chat_history_${contactId}`;
        const chatBox = await window.ib.getItem(historyKey);
        
        if (chatBox && chatBox.messages) {
            // è¿‡æ»¤æ‰åŒ¹é…è¯¥ sessionId çš„æ¶ˆæ¯
            chatBox.messages = chatBox.messages.filter(m => m.sessionId !== sid);
            // å­˜å›æ•°æ®åº“
            await window.ib.setItem(historyKey, chatBox);
        }

        // --- ğŸš¨ 3. UI ç‰©ç†åˆ·æ–° (ä¸€ä¸ªä¸èƒ½å°‘ï¼) ---
        closeSessionDeleteModal();
        
        // åˆ·æ–°å½“å‰èŠå¤©å¡ç‰‡ï¼ˆå¦‚æœæ˜¯æ‰“å¼€çŠ¶æ€ï¼‰
        if (typeof window.openChat === 'function') {
            await window.openChat(contactId); 
        }
        
        // åˆ·æ–°é€šè¯è®°å½•é¡µ
        if (typeof renderRecentsList === 'function') renderRecentsList(); 
        // åˆ·æ–°æ‹¨å·é”®ç›˜é¡µ
        if (typeof renderQuickDial === 'function') renderQuickDial(); 

        showToast("Trace Cleared Globally");
    } catch (e) {
        console.error("å…¨åŸŸåˆ é™¤å¤±è´¥:", e);
        showToast("Delete Failed");
    }
};

/**
 * ğŸ”“ æ˜¾ç¤ºç¡®è®¤å¼¹çª—
 */
window.showClearRecentsModal = function() {
    const modal = document.getElementById('modal-clear-confirm');
    if (!modal) return;
    
    modal.style.display = 'flex';
    if (navigator.vibrate) navigator.vibrate(10); // è§¦æ„Ÿåé¦ˆ
};

/**
 * ğŸ”’ å…³é—­ç¡®è®¤å¼¹çª—
 */
window.closeClearRecentsModal = function() {
    const modal = document.getElementById('modal-clear-confirm');
    if (modal) modal.style.display = 'none';
};

/**
 * ğŸ’£ å…¨åŸŸæ¸…ç©ºï¼šæŠ¹é™¤æ‰€æœ‰é€šè¯è®°å½•ä¸æ°”æ³¡å­˜æ ¹
 */
/**
 * ğŸ›°ï¸ Lune OS: æœ€é«˜æƒé™å…¨åŸŸæ¸…ç©ºåè®®
 * ä½œç”¨ï¼šç‰©ç†æ“¦é™¤æ‰€æœ‰é€šè¯è®°å½•å¹¶æ¸…ç†èŠå¤©å†å²ä¸­çš„ call_log èŠ‚ç‚¹
 */
window.executeClearAllRecents = async function() {
    console.log("System: å¯åŠ¨æœ€é«˜æƒé™å…¨åŸŸæ¸…ç©ºåè®®...");

    try {
        // --- ğŸš¨ 1. ç‰©ç†æ¸…ç©ºæœ€è¿‘é€šè¯è¡¨ (ä½¿ç”¨æ–°åº“) ---
        await window.ib.setItem('phone_recents', []);

        // --- ğŸš¨ 2. éå†å…¨åº“ï¼Œç‰©ç†åˆ‡é™¤ type: "call_log" çš„æ¶ˆæ¯ ---
        // é€»è¾‘ï¼šæ‰«ææ‰€æœ‰ä»¥ 'chat_history_' å¼€å¤´çš„ Keyï¼Œè¿‡æ»¤æ‰å†…éƒ¨çš„é€šè¯é€»è¾‘èŠ‚ç‚¹
        await window.ib.init();
        const db = window.ib._db;
        const tx = db.transaction(window.ib.storeName, "readwrite");
        const store = tx.objectStore(window.ib.storeName);

        // ä½¿ç”¨æ¸¸æ ‡ (Cursor) æ‰«ææ•´ä¸ª user_data_store
        const request = store.openCursor();

        request.onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const key = cursor.key;
                
                // ğŸ’¡ å…³é”®ï¼šé€šè¿‡ Key å‰ç¼€é”å®šç›®æ ‡ï¼Œé˜²æ­¢è¯¯åˆ è”ç³»äººæˆ–é…ç½®æ•°æ®
                if (typeof key === 'string' && key.startsWith('chat_history_')) {
                    const chatBox = cursor.value;
                    
                    if (chatBox && chatBox.messages) {
                        // è¿‡æ»¤æ‰æ‰€æœ‰çš„é€šè¯è®°å½• (call_log)ï¼Œä¿ç•™æ–‡å­—ã€å›¾ç‰‡ç­‰æ­£å¸¸èŠå¤©æ¶ˆæ¯
                        const cleanedMessages = chatBox.messages.filter(m => m.type !== 'call_log');
                        
                        // ç‰©ç†æ›´æ–°å½“å‰æ¸¸æ ‡æŒ‡å‘çš„æ•°æ®å—
                        chatBox.messages = cleanedMessages;
                        cursor.update(chatBox);
                    }
                }
                cursor.continue();
            } else {
                // 3. æ¸¸æ ‡éå†ç»“æŸï¼Œè§¦å‘ UI å½»åº•é‡ç½®
                finalizeClearUI();
            }
        };

        // --- ğŸ—ï¸ å†…éƒ¨å‡½æ•°ï¼šUI çŠ¶æ€é‡å†™ ---
        function finalizeClearUI() {
            // å…³é—­ç¡®è®¤å¼¹çª—
            closeClearRecentsModal();
            
            // å…¨å±€åˆ·æ–°é€šè¯åˆ—è¡¨ä¸æ‹¨å·é”®ç›˜
            if (typeof renderRecentsList === 'function') renderRecentsList();
            if (typeof renderQuickDial === 'function') renderQuickDial();
            
            // ç‰©ç†å…³é—­å·²æ‰“å¼€çš„å†å²è¯¦æƒ…é¡µï¼Œé˜²æ­¢æ•°æ®æ®‹ç•™
            const historyModal = document.getElementById('ins-modal-history');
            if (historyModal && historyModal.style.display === 'flex') {
                historyModal.style.display = 'none';
            }

            // ç³»ç»Ÿåé¦ˆ
            showToast("All Records Erased");
            if (navigator.vibrate) navigator.vibrate([30, 100, 30]);
            console.log("System: å…¨åŸŸæ¸…ç©ºåè®®æ‰§è¡Œå®Œæˆã€‚");
        }

    } catch (e) {
        console.error("å…¨åŸŸæ¸…ç©ºå¤±è´¥:", e);
        showToast("System Protocol Error");
    }
};

// é¢å¤–å¢åŠ ä¸€ä¸ªç‚¹å‡»é®ç½©å±‚è‡ªåŠ¨å…³é—­çš„åŠŸèƒ½
document.getElementById('modal-clear-confirm').onclick = function(e) {
    if (e.target === this) closeClearRecentsModal();
};
/**
 * ğŸš€ å®Œç¾ç‰ˆï¼šæ¸²æŸ“æœ€è¿‘é€šè¯ (å¸¦æ—¥æœŸåˆ†ç»„ã€ç±»å‹åˆ¤æ–­ã€ç‰©ç†åˆ é™¤)
 */
window.renderRecentsList = async function() {
    const container = document.getElementById('recents-list-container');
    if (!container) return;

    let recents = await loadFromDB('phone_recents') || [];
    const filter = window.currentRecentsFilter || 'all';

    // 1. è¿‡æ»¤æœªæ¥
    if (filter === 'missed') {
        recents = recents.filter(r => r.type === 'missed');
    }

    // 2. æŒ‰æ—¶é—´å€’åº
    recents.sort((a, b) => b.time - a.time);

    container.innerHTML = "";

    // --- ğŸš¨ æ ¸å¿ƒï¼šæ—¥æœŸåˆ†ç»„é€»è¾‘ ---
    const groups = {};
    recents.forEach(record => {
        const d = new Date(record.time);
        const today = new Date();
        const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);

        let dateKey = "";
        if (d.toDateString() === today.toDateString()) dateKey = "Today";
        else if (d.toDateString() === yesterday.toDateString()) dateKey = "Yesterday";
        else dateKey = d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        if (!groups[dateKey]) groups[dateKey] = [];
        groups[dateKey].push(record);
    });

    // 3. æ¸²æŸ“åˆ†ç»„å’Œå¡ç‰‡
    for (let dateLabel in groups) {
        // æ¸²æŸ“æ—¥æœŸå¤´
        const header = document.createElement('div');
        header.className = 'recent-date-group-header';
        header.textContent = dateLabel;
        container.appendChild(header);

        groups[dateLabel].forEach(record => {
            const item = document.createElement('div');
            item.className = 'recent-item';
            item.id = `recent-${record.id}`;

            // é€šè¯ç±»å‹å›¾æ ‡ä¸é¢œè‰²
            let typeIcon = "";
            let colorClass = "";
            if (record.type === 'outgoing') {
                typeIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>`;
            } else if (record.type === 'incoming') {
                typeIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="17" y1="17" x2="7" y2="7"></line><polyline points="7 17 7 7 17 7"></polyline></svg>`;
            } else {
                colorClass = "type-missed";
                typeIcon = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            }

            const timeStr = new Date(record.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

            item.innerHTML = `
                <div class="recent-left" onclick="startCall('${record.name}', '${record.avatar}', '${record.targetId}')">
                    <img class="recent-avatar" src="${record.avatar}">
                    <div class="recent-main-info">
                        <div class="name-row ${colorClass}">${record.name}</div>
                        <div class="meta-row">
                            <span class="call-type-icon">${typeIcon}</span>
                            ${record.label || 'Mobile'} Â· ${timeStr}
                        </div>
                    </div>
                </div>
                <div class="recent-actions">
                    <div class="delete-circle-btn" onclick="deleteRecentRecord(event, '${record.id}')">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }
};

/**
 * ğŸ›°ï¸ å•æ¡é€šè¯è®°å½•ç‰©ç†æŠ¹é™¤åè®®
 * ä½œç”¨ï¼šä» phone_recents ä¸­åˆ é™¤è®°å½•ï¼Œå¹¶åŒæ­¥æ¸…é™¤ chat_history ä¸­å…³è”çš„ call_log æ°”æ³¡
 */
window.deleteRecentRecord = async function(event, recordId) {
    if (event) event.stopPropagation();
    
    // 1. UI åŠ¨ç”»ï¼šæ‰§è¡Œä¾§æ»‘æ¶ˆå¤±æ•ˆæœ
    const el = document.getElementById(`recent-${recordId}`);
    if (el) {
        el.style.transform = "translateX(100px)";
        el.style.opacity = "0";
    }

    // ç­‰å¾…åŠ¨ç”»ç»“æŸåæ‰§è¡Œç‰©ç†åˆ é™¤
    setTimeout(async () => {
        try {
            // 2. ç‰©ç†è¯»å–é€šè¯è¡¨ (ä½¿ç”¨æ–°åº“)
            let recents = await window.ib.getItem('phone_recents') || [];
            const target = recents.find(r => r.id === recordId);
            
            if (target) {
                const sid = target.sessionId;
                const contactId = target.targetId;

                // åŠ¨ä½œ Aï¼šæ›´æ–°é€šè¯è¡¨ï¼ˆè¿‡æ»¤æ‰ç›®æ ‡ IDï¼‰
                const updatedRecents = recents.filter(r => r.id !== recordId);
                await window.ib.setItem('phone_recents', updatedRecents);

                // åŠ¨ä½œ Bï¼šé¡ºè—¤æ‘¸ç“œï¼Œå»èŠå¤©å†å²ä¸­åˆ‡é™¤ç›¸å…³çš„ä¼šè¯èŠ‚ç‚¹
                if (sid && contactId) {
                    const historyKey = `chat_history_${contactId}`;
                    // è·å–å¯¹åº”çš„èŠå¤©å¯¹è±¡
                    const chatBox = await window.ib.getItem(historyKey);
                    
                    if (chatBox && chatBox.messages) {
                        // è¿‡æ»¤æ‰åŒ¹é…è¯¥ sessionId çš„é€šè¯æ¶ˆæ¯
                        chatBox.messages = chatBox.messages.filter(m => m.sessionId !== sid);
                        // å­˜å›æ•°æ®åº“ï¼ˆä¿æŒå¯¹è±¡ç»“æ„ä¸€è‡´ï¼Œé¢„é˜² DataErrorï¼‰
                        await window.ib.setItem(historyKey, chatBox);
                    }
                }
            }

            // 3. ğŸš€ å…¨åŸŸ UI åŒæ­¥åˆ·æ–°
            if (typeof renderRecentsList === 'function') renderRecentsList();
            if (typeof renderQuickDial === 'function') renderQuickDial();
            
            // å¦‚æœå†å²å­˜æ ¹å¼¹çª—å¼€ç€ï¼Œæ‰§è¡Œåˆ·æ–°
            const historyModal = document.getElementById('ins-modal-history');
            if (historyModal && historyModal.style.display === 'flex') {
                // ç¡®ä¿åˆ·æ–°çš„æ˜¯å½“å‰æ“ä½œçš„è”ç³»äººé¡µé¢
                if (target && typeof window.openChat === 'function') {
                    window.openChat(target.targetId);
                }
            }

            if(navigator.vibrate) navigator.vibrate(10);
            showToast("Record & Transcript Purged");

        } catch (e) {
            console.error("æœ€è¿‘é€šè¯å…¨åŸŸåˆ é™¤å¤±è´¥:", e);
            showToast("Sync Error");
        }
    }, 300);
};

/**
 * è¾…åŠ©ï¼šåˆ‡æ¢è¿‡æ»¤å™¨
 */
window.filterRecents = function(type) {
    window.currentRecentsFilter = type;
    
    // UI æŒ‰é’®åˆ‡æ¢
    document.getElementById('seg-all').classList.toggle('active', type === 'all');
    document.getElementById('seg-missed').classList.toggle('active', type === 'missed');
    
    renderRecentsList();
};

// å…¨å±€æš‚å­˜å˜é‡ï¼Œé˜²æ­¢ onclick ä¼ å‚å¤±æ•ˆ
window.currentSessionCache = [];

/**
 * ğŸš€ ä¿®æ­£ç‰ˆï¼šæ‰“å¼€é€šè¯å­˜æ ¹åˆ—è¡¨
 */
window.openChat = async function(contactId) {
    const modal = document.getElementById('ins-modal-history');
    const list = document.getElementById('ins-history-list');
    
    // 1. ç‰©ç†é”å®šï¼šè®°å½•å½“å‰æ­£åœ¨æŸ¥çœ‹å“ªä¸ªäººçš„å†å²ï¼Œä¾›åˆ é™¤å‡½æ•°ä½¿ç”¨
    window.currentHistoryContactId = contactId;

    // 2. è·å–æ•°æ®å¹¶æŒ‰ sessionId åˆ†ç»„
    const history = await getChatHistory(contactId) || [];
    const callLogs = history.filter(m => m.type === 'call_log').sort((a,b) => a.timestamp - b.timestamp);

    const sessionMap = {};
    callLogs.forEach(log => {
        const sid = log.sessionId || ("legacy_" + new Date(log.timestamp).toLocaleDateString());
        if (!sessionMap[sid]) sessionMap[sid] = [];
        sessionMap[sid].push(log);
    });

    const sessions = Object.values(sessionMap).sort((a, b) => b[0].timestamp - a[0].timestamp);
    window.currentSessionCache = sessions; // æš‚å­˜åˆ°å…¨å±€ç¼“å­˜

    list.innerHTML = "";
    if (sessions.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:100px 0; color:#CCC; font-size:10px; letter-spacing:2px;">EMPTY ARCHIVE</div>`;
    } else {
        sessions.forEach((session, index) => {
            const firstMsg = session[0];
            
            // ğŸš¨ ã€æ ¸å¿ƒä¿®å¤ã€‘å®šä¹‰æ—¥æœŸå˜é‡ï¼Œé˜²æ­¢ ReferenceError
            const d = new Date(firstMsg.timestamp);
            const month = d.toLocaleString('en-US', { month: 'short' }).toUpperCase();
            const day = d.getDate();
            const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

            const card = document.createElement('div');
            card.className = 'ins-log-card';
            card.innerHTML = `
                <div class="card-left">
                    <div class="date-tag">${month} ${day}</div>
                    <div class="time-meta">${timeStr}</div>
                </div>
                <div class="card-center">
                    <div class="record-title">Session Trace</div>
                    <div class="duration-badge">${session.length} NODES</div>
                </div>
                <div class="ins-card-delete-trigger" onclick="event.stopPropagation(); askDeleteSession(${index})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
                <div class="card-arrow">â†’</div>
            `;
            card.onclick = () => openCallDetail(index);
            list.appendChild(card);
        });
    }

    modal.style.display = 'flex';
    void modal.offsetWidth;
    modal.classList.add('active');
};

/**
 * ğŸ’¬ è¯¦æƒ…é¡µï¼šåŒè¯­èŠå¤©æ°”æ³¡æ¸²æŸ“
 */
window.openCallDetail = function(sessionIndex) {
    const modal = document.getElementById('ins-modal-detail');
    const flowContainer = document.getElementById('ins-chat-flow');
    
    // ä»ç¼“å­˜å–å›æ•°ç»„
    const sessionData = window.currentSessionCache[sessionIndex];
    if (!sessionData) return;

    flowContainer.innerHTML = "";
    
    sessionData.forEach(msg => {
        const isUser = msg.role === 'user';
        const bubble = document.createElement('div');
        bubble.className = `ins-bubble bubble-${isUser ? 'user' : 'assistant'}`;
        
        // --- ğŸ’ æ ¸å¿ƒï¼šåŒè¯­åˆ†ç¦»æ’ç‰ˆ ---
        // å‡è®¾å­˜å‚¨æ ¼å¼ä¸º "åŸæ–‡\nç¿»è¯‘"
        let textParts = msg.text.split('\n');
        let original = textParts[0] || "";
        let translated = textParts.slice(1).join('\n') || "";

        bubble.innerHTML = `
            <div class="msg-original">${original}</div>
            ${translated ? `<div class="msg-translated">${translated}</div>` : ''}
            <span class="bubble-meta">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        `;
        flowContainer.appendChild(bubble);
    });

    modal.style.display = 'flex';
    void modal.offsetWidth;
    modal.classList.add('active');
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => { flowContainer.scrollTop = flowContainer.scrollHeight; }, 100);
};

/**
 * ç»Ÿä¸€å…³é—­é€»è¾‘
 */
window.closeInsModal = function(id) {
    const m = document.getElementById(id);
    if(m) {
        m.classList.remove('active');
        setTimeout(() => { m.style.display = 'none'; }, 500);
    }
};
// å…¨å±€éŸ³é¢‘ä¸Šä¸‹æ–‡ (ä¿æŒå•ä¾‹ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼)
window.sharedAudioCtx = window.sharedAudioCtx || new (window.AudioContext || window.webkitAudioContext)();
// ==========================================
// ğŸŒ å…¨å±€è¯­è¨€æ˜ å°„è¡¨ (30 è¯­ç§Â·å•†ç”¨æ——èˆ°ç‰ˆ)
// æ’åºè§„åˆ™ï¼šä¸­æ–‡ç¬¬ä¸€ï¼Œç²¤è¯­ç¬¬äºŒï¼Œå…¶ä½™æŒ‰å›½é™…å½±å“åŠ›æ’åˆ—
// ==========================================
window.LANG_MAP = {
    'zh': 'Chinese (ä¸­æ–‡)',
    'cantonese': 'Cantonese (ç²¤è¯­)',
    'en': 'English (è‹±è¯­)',
    'ja': 'Japanese (æ—¥è¯­)',
    'ko': 'Korean (éŸ©è¯­)',
    'th': 'Thai (æ³°è¯­)',
    'fr': 'French (æ³•è¯­)',
    'de': 'German (å¾·è¯­)',
    'es': 'Spanish (è¥¿ç­ç‰™è¯­)',
    'ru': 'Russian (ä¿„è¯­)',
    'it': 'Italian (æ„å¤§åˆ©è¯­)',
    'pt': 'Portuguese (è‘¡è„ç‰™è¯­)',
    'vi': 'Vietnamese (è¶Šå—è¯­)',
    'ar': 'Arabic (é˜¿æ‹‰ä¼¯è¯­)',
    'hi': 'Hindi (å°åœ°è¯­)',
    'tr': 'Turkish (åœŸè€³å…¶è¯­)',
    'nl': 'Dutch (è·å…°è¯­)',
    'sv': 'Swedish (ç‘å…¸è¯­)',
    'pl': 'Polish (æ³¢å…°è¯­)',
    'id': 'Indonesian (å°å°¼è¯­)',
    'ms': 'Malay (é©¬æ¥è¯­)',
    'fil': 'Filipino (è²å¾‹å®¾è¯­)',
    'el': 'Greek (å¸Œè…Šè¯­)',
    'he': 'Hebrew (å¸Œä¼¯æ¥è¯­)',
    'da': 'Danish (ä¸¹éº¦è¯­)',
    'fi': 'Finnish (èŠ¬å…°è¯­)',
    'no': 'Norwegian (æŒªå¨è¯­)',
    'hu': 'Hungarian (åŒˆç‰™åˆ©è¯­)',
    'cs': 'Czech (æ·å…‹è¯­)',
    'uk': 'Ukrainian (ä¹Œå…‹å…°è¯­)'
};

// 2. å…¨å±€æš‚å­˜å¯¹è±¡ (ç‰©ç†é”å®šï¼Œé˜²æ­¢è¢«é‡ç½®)
window.tempSettings = {
    userLang: 'zh',
    charLang: 'zh' // é»˜è®¤å€¼
};
// ==========================================
// ğŸ”— è·¨åº”ç”¨è·³è½¬é€»è¾‘ (Call -> Message)
// ==========================================

window.goToMessageApp = function() {
    console.log("ç‚¹å‡»äº†ä¿¡æ¯æŒ‰é’®");
    
    // è·å–å½“å‰æ­£åœ¨é€šè¯çš„äººçš„ ID
    const contactId = window.currentCallId;

    // å…ˆæŒ‚æ–­ç”µè¯ï¼ˆç¬¦åˆçœŸå®é€»è¾‘ï¼‰
    if(typeof endCallAction === 'function') endCallAction();

    // å»¶è¿Ÿ 300ms ç­‰æŒ‚æ–­åŠ¨ç”»æ’­å®Œï¼Œç„¶åè·³è½¬
    setTimeout(() => {
        // å¦‚æœæœ‰ç°æˆçš„ openChatWindow å‡½æ•°å°±ç”¨ï¼Œæ²¡æœ‰å°±å°è¯•æ‰“å¼€ App å¹¶å®šä½
        if (typeof openChatWindow === 'function' && contactId) {
            openChatWindow(contactId);
        } else if (typeof openApp === 'function') {
            openApp('messageApp'); // æˆ–è€… chatAppï¼Œçœ‹ä½  ID æ˜¯å•¥
            // å¦‚æœæœ‰ openChat é€»è¾‘
            if (contactId && typeof openChat === 'function') {
                setTimeout(() => openChat(contactId), 100);
            }
        } else {
            alert("æ­£åœ¨è·³è½¬çŸ­ä¿¡ç•Œé¢... (Debug: MessageApp ID unknown)");
        }
    }, 300);
};
// ==========================================
// ğŸ“ é€šè¯å…¨æµç¨‹æ§åˆ¶ (å‘¼å« -> å»¶è¿Ÿ -> æ¥é€š)
// ==========================================

let callTimerInterval = null;
let callSeconds = 0;

// 2. å¯¹æ–¹æ¥é€šäº† (Connected State)
window.onCallConnected = async function() {
    console.log("System: Connecting UI for ID:", window.currentCallId);

    if(navigator.vibrate) navigator.vibrate(100);

    // ç•Œé¢åˆ‡æ¢
    document.getElementById('call-overlay-screen').style.display = 'none';
    const connScreen = document.getElementById('call-connected-screen');
    connScreen.style.display = 'flex';

    // --- ğŸ¨ ä¿®å¤ A: èƒŒæ™¯åŒæ­¥ ---
    let finalBg = window.currentCallAvatar; // é»˜è®¤ç”¨å¤´åƒ
    
    try {
        if (window.currentCallId) {
            const friends = await loadFromDB('chat_friends') || [];
            const target = friends.find(f => f.id === window.currentCallId);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰èƒŒæ™¯è®¾ç½®
            if (target && target.settings && target.settings.chatBackground) {
                finalBg = target.settings.chatBackground;
                console.log("âœ… Using Custom Background");
            }
        }
    } catch (e) {
        console.error("BG Sync Error:", e);
    }

    // åº”ç”¨èƒŒæ™¯
    const cinemaBg = document.getElementById('connected-bg-layer');
    if(cinemaBg) {
        cinemaBg.style.backgroundImage = `url('${finalBg}')`;
        // å¼ºåˆ¶é‡æ–°æ¸²æŸ“ä¸€ä¸‹ï¼Œé˜²æ­¢ç¼“å­˜ä¸æ›´æ–°
        cinemaBg.style.backgroundSize = 'cover';
    }

    // --- ğŸ¨ ä¿®å¤ B: é¡¶éƒ¨åŒºåŸŸé‡ç»˜ (å¤´åƒ+åå­—+æ—¶é—´) ---
    // æˆ‘ä»¬ç›´æ¥ç”¨ JS ç”Ÿæˆ HTMLï¼Œä¿è¯ä¸€å®šæ˜¾ç¤ºå‡ºæ¥
    const topPill = document.querySelector('.dynamic-status-pill');
    if (topPill) {
        topPill.innerHTML = `
            <img src="${window.currentCallAvatar}" style="
                width: 90px; 
                height: 90px; 
                border-radius: 50%; 
                border: 3px solid rgba(255,255,255,0.2); 
                box-shadow: 0 8px 25px rgba(0,0,0,0.4); 
                object-fit: cover; 
                margin-bottom: 10px;
                animation: floatAvatar 6s ease-in-out infinite;">
            <div style="font-size: 28px; font-weight: 700; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">${window.currentCallName}</div>
            <div id="call-timer" class="status-timer" style="margin-top:5px; font-size:14px; opacity:0.8;">00:00</div>
        `;
    }

    // ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šç”Ÿæˆæœ¬æ¬¡é€šè¯çš„å”¯ä¸€èº«ä»½è¯
    window.currentCallSessionId = "sid_" + Date.now(); 
    console.log("ğŸš€ æœ¬æ¬¡é€šè¯ä¼šè¯ ID å·²é”å®š:", window.currentCallSessionId);

    // é‡ç½®å…¶ä»–å…ƒç´ 
    document.querySelector('.audio-visualizer-container').style.opacity = '0.5';
    document.getElementById('call-caption-area').innerHTML = '<div class="caption-empty-state">AI is connecting...</div>';

    // é‡æ–°ç»‘å®šè®¡æ—¶å™¨ (å› ä¸ºåˆšæ‰ innerHTML é‡å†™äº† DOM)
    startCallTimer();
};

// è¾…åŠ©ï¼šæ¨¡æ‹Ÿ AI è¯´è¯æ•ˆæœ
function simulateAISpeaking(text) {
    // 1. å£°æ³¢å˜å¼º
    document.querySelector('.audio-visualizer-container').style.opacity = '1';
    
    // 2. æ˜¾ç¤ºå­—å¹•
    const area = document.getElementById('call-caption-area');
    area.innerHTML = `<div class="caption-text-bubble">${text}</div>`;
    
    // 3. å‡ ç§’åå£°æ³¢å˜å¼± (è¯´å®Œè¯äº†)
    setTimeout(() => {
        document.querySelector('.audio-visualizer-container').style.opacity = '0.5';
    }, text.length * 100);
}

// --- ğŸ“ æŒ‚æ–­é€»è¾‘ (å¢å¼ºç‰ˆï¼šä¿å­˜é€šè¯æ—¶é•¿) ---
window.endCallAction = async function() {
    console.log("ğŸ”´ æŒ‚æ–­æŒ‰é’®è¢«ç‚¹å‡»");
    
    // 1. è·å–æœ€ç»ˆæ—¶é•¿æ–‡å­— (ä¾‹å¦‚ "01:23")
    const timerEl = document.getElementById('call-timer');
    const finalDuration = timerEl ? timerEl.innerText : "00:00";
    
    // 2. éœ‡åŠ¨
    if (navigator.vibrate) navigator.vibrate(50);

    // 3. éšè—ç•Œé¢
    const screen = document.getElementById('call-connected-screen');
    const overlay = document.getElementById('call-overlay-screen');
    if (screen) screen.style.display = 'none';
    if (overlay) overlay.style.display = 'none';

    // 4. åœæ­¢è®¡æ—¶å™¨
    if (window.callTimerInterval) clearInterval(window.callTimerInterval);
    
    // 5. å…³é—­é”®ç›˜
    const drawer = document.getElementById('call-input-drawer');
    if (drawer) drawer.classList.remove('active');
    document.body.style.overflow = '';

    // --- ğŸš¨ æ ¸å¿ƒï¼šæ›´æ–°æ•°æ®åº“é‡Œçš„æœ€åä¸€æ¡è®°å½•ï¼Œå†™å…¥æ—¶é•¿ ---
    try {
        let recents = await loadFromDB('phone_recents') || [];
        if (recents.length > 0) {
            // å–å‡ºæœ€åä¸€æ¡ (å³åˆšåˆšå»ºç«‹çš„é‚£æ¡å‘¼å‡ºè®°å½•)
            // æ³¨æ„ï¼šæˆ‘ä»¬å‡è®¾æœ€åä¸€æ¡å°±æ˜¯åˆšæ‰æ‰“çš„ã€‚
            // æ›´ä¸¥è°¨çš„åšæ³•æ˜¯ startCall æ—¶å­˜ä¸€ä¸ª currentCallRecordIdï¼Œè¿™é‡Œç”¨ ID æ‰¾ã€‚
            // ä½†å¯¹äºå•çº¿ç¨‹æ“ä½œï¼Œç›´æ¥å–æœ€åä¸€ä¸ªé€šå¸¸æ²¡é—®é¢˜ã€‚
            let lastRecord = recents[recents.length - 1];
            
            // åªæœ‰å½“è¿™æ¡è®°å½•æ˜¯ 'outgoing' ä¸”æ²¡æœ‰ duration æ—¶æ‰æ›´æ–°
            if (lastRecord.type === 'outgoing' && !lastRecord.duration) {
                lastRecord.duration = finalDuration;
                // æ›´æ–°å›å»
                recents[recents.length - 1] = lastRecord;
                await saveToDB('phone_recents', recents);
                console.log("âœ… é€šè¯æ—¶é•¿å·²ä¿å­˜:", finalDuration);
            }
        }
        
        // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
        renderQuickDial();
        if(typeof renderRecentsList === 'function') renderRecentsList();

    } catch (e) {
        console.error("ä¿å­˜æ—¶é•¿å¤±è´¥:", e);
    }
};

// --- âŒ¨ï¸ è¾“å…¥æŠ½å±‰é€»è¾‘ ---
window.toggleCallInput = function() {
    console.log("ğŸ‘‰ é”®ç›˜æŒ‰é’®è¢«ç‚¹å‡»");
    const drawer = document.getElementById('call-input-drawer');
    const input = document.getElementById('call-text-input');
    
    if (drawer) {
        drawer.classList.toggle('active');
        // å¦‚æœæ‰“å¼€äº†ï¼Œè‡ªåŠ¨èšç„¦
        if (drawer.classList.contains('active') && input) {
            setTimeout(() => input.focus(), 100);
        }
    } else {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¾“å…¥æ¡†ç»„ä»¶ (call-input-drawer)");
    }
};

// 1. ç”¨æˆ·è¯´è¯å…¥å£ï¼šæ›¿ä»£ä¹‹å‰çš„ sendTextToAI
window.sendTextToAI = async function() {
    const input = document.getElementById('call-text-input');
    const text = input.value.trim();
    
    // ç‰©ç†é˜²æŠ–
    if (!text) return;
    if (window.isCallAiProcessing) return; 

    // A. ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†å¹¶æ”¶èµ·é”®ç›˜ (ä½“éªŒåƒå‘å¾®ä¿¡è¯­éŸ³)
    input.value = "";
    toggleCallInput(); 

    // B. è·å–å½“å‰é€šè¯å¯¹è±¡ ID
    const contactId = window.currentCallId;
    if (!contactId) { showToast("âš ï¸ é€šè¯é“¾è·¯ä¸¢å¤±"); return; }

    // C. ç‰©ç†å­˜ç›˜ï¼šç”¨æˆ·è¯´çš„è¯è™½ç„¶ä¸æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œä½†å¿…é¡»å­˜å…¥å†å²
    // è¿™æ ·ä»¥åå‡çº§æŸ¥å²—åŠŸèƒ½æ—¶èƒ½çœ‹åˆ°å½“æ—¶è¯´äº†å•¥
    await saveChatMessage(contactId, {
        role: "user",
        text: text,
        type: "call_log",
        sessionId: window.currentCallSessionId, // ğŸš¨ å…³é”®ï¼šç»‘å®šèº«ä»½è¯
        timestamp: Date.now()
    });

    // D. è§¦å‘ AI å“åº”æµç¨‹
    executeAICallResponse(contactId, text);
};

// --- ğŸ“ å­—å¹•æ·»åŠ é€»è¾‘ ---
function addCaption(text) {
    const container = document.getElementById('call-caption-area');
    const div = document.createElement('div');
    div.className = 'caption-line';
    div.innerText = text;
    
    container.appendChild(div);
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    container.scrollTop = container.scrollHeight;
}

// --- ğŸ”‡ é™éŸ³å¼€å…³ ---
window.toggleMute = function(btn) {
    // åˆ‡æ¢å›¾æ ‡æ ·å¼è¡¨ç¤ºé™éŸ³çŠ¶æ€ (å˜çº¢æˆ–åˆ’æ‰)
    if (btn.style.background === 'rgb(255, 255, 255)') {
        btn.style.background = 'rgba(255, 255, 255, 0.15)';
        btn.style.color = 'white';
    } else {
        btn.style.background = '#fff';
        btn.style.color = '#000'; // è¿™é‡Œçš„é¢œè‰²é€»è¾‘å¯ä»¥æ ¹æ®ä½ çš„å›¾æ ‡fillè°ƒæ•´
        // ç®€å•å¤„ç†ï¼šä½ å¯ä»¥åˆ‡æ¢ SVG çš„ stroke é¢œè‰²
        const svg = btn.querySelector('svg');
        if(svg) svg.style.stroke = '#000';
    }
};
// ==========================================
// ğŸ“ å‘¼å«æµç¨‹æ§åˆ¶ (Call Logic)
// ==========================================

// 1. å‘èµ·å‘¼å« (å…¥å£å‡½æ•°)
// 3. å‘èµ·å‘¼å« (DBå­˜æ¡£ + AI UIåˆå§‹åŒ– + è‡ªåŠ¨æ¥é€š)
window.startCall = async function(name, avatar, id) {
    console.log("System: Starting call to", name);
    
    // ğŸ’¾ 1. å…¨å±€çŠ¶æ€é”å®š
    window.currentCallId = id; 
    window.currentCallName = name;
    
    if (!avatar || avatar.length < 5) {
        avatar = "https://api.dicebear.com/7.x/initials/svg?seed=" + name;
    }
    window.currentCallAvatar = avatar;

    // --- ğŸš¨ è¡¥å…¨ï¼šAI UI åˆå§‹åŒ– (é˜²æ­¢æ˜¾ç¤ºä¸Šä¸€å±€çš„æ®‹ç•™æ–‡å­—) ---
    const captionArea = document.getElementById('call-caption-area');
    if(captionArea) {
        captionArea.innerHTML = '<div class="caption-empty-state">Connecting...</div>';
    }
    // é‡ç½®å‘¼å¸åœˆçŠ¶æ€
    if (typeof toggleAvatarSpeaking === 'function') {
        toggleAvatarSpeaking(false); 
    }
    // ----------------------------------------------------

    // --- ğŸ’¾ 2. æ•°æ®åº“å­˜æ¡£é€»è¾‘ ---
    const newRecord = {
        id: "call_" + Date.now(),      // å”¯ä¸€ID
        targetId: id || "unknown",     // å¯¹æ–¹ID
        name: name,                    // å¯¹æ–¹åå­—
        avatar: avatar,                // å¯¹æ–¹å¤´åƒ
        type: 'outgoing',              // ç±»å‹ï¼šå‘¼å‡º
        label: 'Mobile',               // æ ‡ç­¾
        time: Date.now(),              // æ—¶é—´æˆ³
        isVideo: false ,                // æ˜¯å¦è§†é¢‘é€šè¯
        sessionId: window.currentCallSessionId || ("sid_" + Date.now()), // ğŸš¨ è®°å½•æ¡ä¹Ÿå¾—å¸¦ IDã€
    };

    try {
        let recents = await loadFromDB('phone_recents') || [];
        recents.push(newRecord);
        await saveToDB('phone_recents', recents);
        console.log("âœ… é€šè¯è®°å½•å·²ä¿å­˜");
        
        // åˆ·æ–°åå°åˆ—è¡¨
        if (typeof renderRecentsList === 'function') renderRecentsList(); 
        if (typeof renderQuickDial === 'function') renderQuickDial();
    } catch (e) {
        console.error("ä¿å­˜é€šè¯è®°å½•å¤±è´¥:", e);
    }

    // --- ğŸ“± 3. å‘¼å«ç•Œé¢æ˜¾ç¤º ---
    const screen = document.getElementById('call-overlay-screen');
    const nameEl = document.getElementById('call-current-name');
    const avatarEl = document.getElementById('call-current-avatar');
    const bgEl = document.getElementById('call-bg-layer');

    if(nameEl) nameEl.innerText = name;
    if(avatarEl) avatarEl.src = avatar;
    // èƒŒæ™¯å›¾å¦‚æœä¸æƒ³è¦å¤´åƒæ¨¡ç³Šï¼Œå¯ä»¥æ¢æˆé»‘è‰²æˆ–é»˜è®¤å›¾ï¼Œè¿™é‡Œä¿æŒåŸæ ·
    if(bgEl) bgEl.style.backgroundImage = `url('${avatar}')`;

    if(screen) {
        screen.style.display = 'flex';
        screen.style.opacity = '0';
        requestAnimationFrame(() => {
            screen.style.transition = 'opacity 0.3s ease';
            screen.style.opacity = '1';
        });
    }

    // ç‰©ç†éœ‡åŠ¨
    if(navigator.vibrate) navigator.vibrate([50, 400, 50]);

    // --- â³ 4. è®¾ç½®æ¥é€šå®šæ—¶å™¨ ---
    if (window.callConnectTimer) clearTimeout(window.callConnectTimer);
    // 3ç§’åè‡ªåŠ¨è§¦å‘ onCallConnected (è¿›å…¥é€šè¯ç•Œé¢)
    window.callConnectTimer = setTimeout(onCallConnected, 3000); 
};

// --- ğŸ”— ç»‘å®šåˆ°ç°æœ‰é€»è¾‘ ---

// 3. ä¿®æ”¹ï¼šæ‹¨å·ç›˜ç‚¹å‡»â€œæ‹¨æ‰“æŒ‰é’®â€
window.makeCall = async function() {
    const num = document.getElementById('keypad-number-display').textContent;
    if (!num) return;

    const phoneDir = await loadFromDB('phone_directory') || {};
    const name = phoneDir[num] || num;
    
    let avatar = null;
    let targetId = null; // ğŸ” å¿…é¡»æ‰¾åˆ°è¿™ä¸ª ID
    
    let friends = await loadFromDB('chat_friends') || [];
    
    // åæŸ¥ ID
    for (let f of friends) {
        if (phoneDir["id_" + f.id] === num) {
            avatar = f.avatar;
            targetId = f.id; // âœ… æ‰¾åˆ°äº†ï¼
            break;
        }
    }

    // ğŸš¨ å…³é”®ï¼šæŠŠ targetId ä¼ ç»™ startCall
    startCall(name, avatar, targetId);
};

// ä¸´æ—¶å­˜å‚¨å½“å‰çš„è®¾ç½®
let tempSettings = {
    userLang: 'zh',
    charLang: 'en'
};
let editingLangType = null; // 'user' or 'char'

// 1. æ‰“å¼€è®¾ç½®é¢æ¿ (ä¸»å…¥å£)
window.settingContact = async function(id) {
    console.log("System: æ­£åœ¨è¯»å–è”ç³»äººè®¾ç½®...", id);
    const modal = document.getElementById('modal-contact-settings');
    if (!modal) return;

    window.currentSettingsId = id; // é”å®šå½“å‰æ“ä½œçš„ ID
    
    // UI é‡ç½®
    document.getElementById('settings-view-main').className = 'settings-view active';
    document.getElementById('settings-view-sub').className = 'settings-view next';
    document.querySelectorAll('.contact-popover-menu').forEach(el => el.style.display = 'none');

    // --- ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šä»æ•°æ®åº“è¯»å–å¹¶å†™å…¥å…¨å±€æš‚å­˜åŒº ---
    let friends = await loadFromDB('chat_friends') || [];
    let target = friends.find(f => f.id === id);
    
    if (!target) { showToast("æ•°æ®è¯»å–å¤±è´¥"); return; }
    
    const settings = target.settings || {};

    // å¼ºåˆ¶åŒæ­¥åˆ°å…¨å±€å˜é‡
    window.tempSettings = {
        userLang: settings.userLang || 'zh',
        charLang: settings.charLang || 'en', // å¦‚æœæ²¡å­˜è¿‡ï¼Œé»˜è®¤è‹±è¯­
        bilingual: (settings.bilingual !== false), // é»˜è®¤å¼€å¯åŒè¯­
        minimaxEnabled: (settings.minimaxEnabled === true),
        voiceId: settings.voiceId || "",
        chatBackground: settings.chatBackground || null
    };

    // --- UI å›å¡« ---
    updateLangDisplay(); // åˆ·æ–°æ–‡å­—æ˜¾ç¤º

    // å›å¡«å¼€å…³
    document.getElementById('set-bilingual-toggle').checked = window.tempSettings.bilingual;
    document.getElementById('group-bilingual-options').style.display = window.tempSettings.bilingual ? 'block' : 'none';

    document.getElementById('set-minimax-toggle').checked = window.tempSettings.minimaxEnabled;
    document.getElementById('group-minimax-options').style.display = window.tempSettings.minimaxEnabled ? 'block' : 'none';
    
    document.getElementById('set-voice-id').value = window.tempSettings.voiceId;

    // å›å¡«èƒŒæ™¯é¢„è§ˆ
    const imgPre = document.getElementById('set-bg-preview');
    const bgPlace = document.getElementById('set-bg-placeholder');
    if (window.tempSettings.chatBackground) {
        imgPre.src = window.tempSettings.chatBackground;
        imgPre.style.display = 'block';
        bgPlace.style.display = 'none';
        window.tempBgImage = window.tempSettings.chatBackground;
    } else {
        imgPre.style.display = 'none';
        bgPlace.style.display = 'flex';
        window.tempBgImage = null;
    }

    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
};

// 2. æ‰“å¼€è¯­è¨€é€‰æ‹©å­é¡µé¢
window.openLangPage = function(type) {
    editingLangType = type; // è®°ä¸‹ç°åœ¨æ”¹çš„æ˜¯ user è¿˜æ˜¯ char
    const currentVal = (type === 'user') ? tempSettings.userLang : tempSettings.charLang;
    
    // è®¾ç½®æ ‡é¢˜
    document.getElementById('sub-page-title').innerText = (type === 'user') ? "Your Language" : "Char Language";

    // ç”Ÿæˆåˆ—è¡¨
    const listContainer = document.getElementById('lang-options-list');
    listContainer.innerHTML = ''; // æ¸…ç©º

    // éå†å­—å…¸ç”Ÿæˆé€‰é¡¹
    for (let code in LANG_MAP) {
        const name = LANG_MAP[code];
        const isSelected = (code === currentVal);
        
        const div = document.createElement('div');
        div.className = `lang-option-item ${isSelected ? 'selected' : ''}`;
        div.onclick = () => selectLanguage(code);
        div.innerHTML = `
            <span>${name}</span>
            <svg class="check-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            ${!isSelected ? '<div style="height:1px; background:#E5E5EA; position:absolute; bottom:0; left:16px; right:0;"></div>' : ''} 
        `;
        // æ³¨æ„ï¼šåŠ ä¸ªåˆ†å‰²çº¿çœ‹èµ·æ¥æ›´åƒiOS
        listContainer.appendChild(div);
    }

    // æ‰§è¡Œæ»‘å…¥åŠ¨ç”»
    document.getElementById('settings-view-main').className = 'settings-view prev';
    document.getElementById('settings-view-sub').className = 'settings-view active';
};

// 4. è¿”å›ä¸»é¡µ (æ»‘å›å»)
window.backToMainSettings = function() {
    document.getElementById('settings-view-main').className = 'settings-view active';
    document.getElementById('settings-view-sub').className = 'settings-view next';
};

// 5. æ›´æ–°ä¸»é¡µä¸Šçš„æ–‡å­—
function updateLangDisplay() {
    const uCode = window.tempSettings.userLang;
    const cCode = window.tempSettings.charLang;
    
    const uLabel = document.getElementById('disp-user-lang');
    const cLabel = document.getElementById('disp-char-lang');

    if (uLabel) uLabel.innerText = window.LANG_MAP[uCode] || uCode;
    if (cLabel) cLabel.innerText = window.LANG_MAP[cCode] || cCode;
}

// 6. ã€æ ¸å¿ƒã€‘ä¿å­˜å¹¶å…³é—­ (å†™å…¥æ•°æ®åº“)
window.closeContactSettings = async function() {
    console.log("System: æ­£åœ¨ä¿å­˜è®¾ç½®åˆ°æ•°æ®åº“...");
    const modal = document.getElementById('modal-contact-settings');
    if (!modal) return;
    
    // å¦‚æœæ²¡æœ‰ IDï¼Œè¯´æ˜å¯èƒ½æ˜¯ç‚¹é”™äº†ï¼Œç›´æ¥å…³æ‰
    if (!window.currentSettingsId) {
        modal.style.display = 'none';
        return;
    }

    // æ„é€ è¦ä¿å­˜çš„æœ€ç»ˆå¯¹è±¡
    const finalSettings = {
        userLang: window.tempSettings.userLang,
        charLang: window.tempSettings.charLang, // ğŸš¨ ç¡®ä¿è¿™é‡Œè¯»çš„æ˜¯æœ€æ–°çš„
        bilingual: document.getElementById('set-bilingual-toggle').checked,
        minimaxEnabled: document.getElementById('set-minimax-toggle').checked,
        voiceId: document.getElementById('set-voice-id').value.trim(),
        chatBackground: window.tempBgImage // èƒŒæ™¯å›¾
    };

    // å†™å…¥ IndexedDB
    let friends = await loadFromDB('chat_friends') || [];
    const idx = friends.findIndex(f => f.id === window.currentSettingsId);
    
    if (idx !== -1) {
        friends[idx].settings = finalSettings;
        await saveToDB('chat_friends', friends);
        console.log("âœ… æ•°æ®åº“å†™å…¥æˆåŠŸ:", finalSettings);
        showToast("è®¾ç½®å·²ä¿å­˜");
    }

    modal.style.display = 'none';
};

// 1. ä¿®å¤ï¼šå¼€å…³åˆ‡æ¢ (toggleSettingGroup)
window.toggleSettingGroup = function(type) {
    console.log("Toggle triggered for:", type);
    
    if (type === 'bilingual') {
        const toggle = document.getElementById('set-bilingual-toggle');
        const group = document.getElementById('group-bilingual-options');
        if (toggle && group) {
            group.style.display = toggle.checked ? 'block' : 'none';
        }
    } else if (type === 'minimax') {
        const toggle = document.getElementById('set-minimax-toggle');
        const group = document.getElementById('group-minimax-options');
        if (toggle && group) {
            group.style.display = toggle.checked ? 'block' : 'none';
        }
    }
};

// 2. ä¿®å¤ï¼šèƒŒæ™¯å›¾ç‰‡é¢„è§ˆ (previewChatBg)
window.previewChatBg = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgPrev = document.getElementById('set-bg-preview');
            const bgPlace = document.getElementById('set-bg-placeholder');
            
            if(imgPrev) {
                imgPrev.src = e.target.result;
                imgPrev.style.display = 'block';
            }
            if(bgPlace) bgPlace.style.display = 'none';
            
            // å­˜å…¥å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿ä¿å­˜æ—¶è¯»å–
            window.tempBgImage = e.target.result; 
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// 4. ä¿®å¤ï¼šé€‰ä¸­è¯­è¨€
window.selectLanguage = function(code) {
    console.log("User Selected Lang:", code);

    // æ›´æ–°å…¨å±€æš‚å­˜åŒº
    if (window.editingLangType === 'user') {
        window.tempSettings.userLang = code; // Changed from 'zh' to 'code'
    } else {
        window.tempSettings.charLang = code; // Changed from 'en' to 'code'
    }

    // ç«‹å³åˆ·æ–° UI æ–‡å­—
    updateLangDisplay();

    // è¿”å›ä¸Šä¸€çº§
    backToMainSettings();
};

// 5. ä¿®å¤ï¼šè¿”å›ä¸»é¡µ
window.backToMainSettings = function() {
    const mainView = document.getElementById('settings-view-main');
    const subView = document.getElementById('settings-view-sub');
    if(mainView) mainView.className = 'settings-view active';
    if(subView) subView.className = 'settings-view next';
};

console.log("âœ… äº¤äº’å‡½æ•°å·²å¼ºåˆ¶è¡¥å…¨ï¼štoggleSettingGroup, openLangPage, etc.");

// ==========================================
// ğŸ“ ç”µè¯æœ¬æ ¸å¿ƒé€»è¾‘ï¼šåŒå‘åŒæ­¥ä¸å·ç åº“
// ==========================================

var tempPhoneAvatar = null;
var selectedImportId = null;

// --- ğŸ“ ä¿®å¤ï¼šç‚¹å‡»åŠ å·æ‰“å¼€é«˜çº§å¼¹çª— (å˜é‡å‰ç½®ç‰ˆ) ---
window.addContact = function() {
    console.log("System: æ‰“å¼€å…¨åŠŸèƒ½æ·»åŠ é¡µ...");
    setupModalMode('create'); // åˆ‡æ¢åˆ°æ–°å»ºæ¨¡å¼ UI
    
    // æ¸…ç©ºæ–°å»ºè¡¨å•
    document.getElementById('phone-name-in').value = "";
    document.getElementById('phone-desc-in').value = "";
    document.getElementById('common-phone-in').value = ""; // ç”µè¯æ¸…ç©º
    
    // é‡ç½®å¤´åƒ
    document.getElementById('phone-avatar-pre').style.display = 'none';
    document.getElementById('phone-avatar-placeholder').style.display = 'flex';
    tempPhoneAvatar = null;

    // é‡ç½®å¯¼å…¥çŠ¶æ€
    selectedImportId = null;
    document.getElementById('import-selection-hint').style.display = 'none';
    
    // æ¸²æŸ“ä¸–ç•Œä¹¦åˆ—è¡¨ (å¤é€‰æ¡†)
    renderPhoneWorldList();

    // é»˜è®¤åˆ‡åˆ° Create
    switchPhoneAddTab('create');

    // æ‰“å¼€å¼¹çª—
    const modal = document.getElementById('modal-phone-add-contact');
    if(modal) modal.style.display = 'flex';
    
    document.getElementById('modal-phone-add-contact').style.display = 'flex';
};

// 2. åˆ‡æ¢ Tab
window.switchPhoneAddTab = function(mode) {
    document.getElementById('p-seg-create').classList.toggle('active', mode === 'create');
    document.getElementById('p-seg-import').classList.toggle('active', mode === 'import');
    
    document.getElementById('panel-phone-create').style.display = mode === 'create' ? 'block' : 'none';
    document.getElementById('panel-phone-import').style.display = mode === 'import' ? 'block' : 'none';
    
    if (mode === 'import') renderImportGrid();
};

// 3. å¤´åƒé¢„è§ˆ
window.previewPhoneAvatar = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            tempPhoneAvatar = e.target.result;
            document.getElementById('phone-avatar-pre').src = tempPhoneAvatar;
            document.getElementById('phone-avatar-pre').style.display = 'block';
            document.getElementById('phone-avatar-placeholder').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// 5. æ ¸å¿ƒï¼šæäº¤ä¿å­˜
// ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šé…åˆä½ åŸæœ‰çš„ renderImportGrid
window.submitPhoneContact = async function() {
    console.log("System: æ­£åœ¨ä¿å­˜...");

    // 1. ã€åˆ¤å®šæ¨¡å¼ã€‘ä½ æ˜¯é€šè¿‡ style.display åˆ‡æ¢çš„ï¼Œæ‰€ä»¥è¿™æ ·åˆ¤æ–­æœ€ç¨³
    const importPanel = document.getElementById('panel-phone-import');
    const isImportMode = importPanel && importPanel.style.display !== 'none';
    
    // 2. ã€è·å–ç”µè¯ã€‘è¿™æ˜¯å¿…å¡«é¡¹
    const phoneNum = document.getElementById('common-phone-in').value.trim();
    if (!phoneNum) {
        alert("è¯·å¡«å†™ç”µè¯å·ç ");
        return;
    }

    let finalCharData = null;

    try {
        if (isImportMode) {
            // --- ğŸš€ å¯¼å…¥æ¨¡å¼ï¼šå¿…é¡»ç”¨åˆ°ä½  renderImportGrid é‡Œè®°å½•çš„ selectedImportId ---
            // æ³¨æ„ï¼šè¿™é‡Œè¦ç¡®ä¿ selectedImportId æ˜¯å…¨å±€å¯è¯»çš„
            if (!window.selectedImportId) {
                alert("è¯·å…ˆåœ¨åˆ—è¡¨ä¸­ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªè§’è‰²");
                return;
            }

            let chars = await loadFromDB('char_list') || [];
            finalCharData = chars.find(c => c.id === window.selectedImportId);

            if (!finalCharData) {
                alert("æ‰¾ä¸åˆ°é€‰ä¸­çš„è§’è‰²æ•°æ®");
                return;
            }

        } else {
            // --- ğŸš€ æ–°å»ºæ¨¡å¼ï¼šè¯»å–æ‰‹åŠ¨å¡«å†™çš„è¾“å…¥æ¡† ---
            const name = document.getElementById('phone-name-in').value.trim();
            const desc = document.getElementById('phone-desc-in').value.trim();

            if (!name) { alert("è¯·å¡«å†™åå­—"); return; }

            finalCharData = {
                id: "char_" + Date.now(),
                name: name,
                desc: desc,
                avatar: window.tempPhoneAvatar || `https://api.dicebear.com/7.x/initials/svg?seed=${name}`,
                createdAt: Date.now()
            };

            // å­˜å…¥è§’è‰²ä¹¦ (å¦‚æœæ˜¯æ–°å»ºçš„)
            let chars = await loadFromDB('char_list') || [];
            chars.unshift(finalCharData);
            await saveToDB('char_list', chars);
        }

        // --- ğŸ æ ¸å¿ƒæ­¥éª¤ï¼šåªæœ‰ç‚¹ Done æ‰ä¼šæ‰§è¡ŒåŒæ­¥ï¼Œæ»¡è¶³ä½ â€œä¸ç‚¹ä¸åŒæ­¥â€çš„è¦æ±‚ ---

        // 1. åŒæ­¥åˆ°é€šè®¯å½•åˆ—è¡¨ (chat_friends)
        let friends = await loadFromDB('chat_friends') || [];
        if (!friends.some(f => f.id === finalCharData.id)) {
            friends.unshift({
                id: finalCharData.id,
                name: finalCharData.name,
                avatar: finalCharData.avatar
            });
            await saveToDB('chat_friends', friends);
        }

        // 2. åŒæ­¥åˆ°å·ç åº“ (phone_directory)
        let phoneDir = await loadFromDB('phone_directory') || {};
        phoneDir[phoneNum] = finalCharData.name;      // å·ç  -> åå­—
        phoneDir["id_" + finalCharData.id] = phoneNum; // ID -> å·ç 
        await saveToDB('phone_directory', phoneDir);

        // 3. å…³é—­å¹¶åˆ·æ–°
        closePhoneAddModal(); 
        if(typeof renderContactsList === 'function') renderContactsList();
        
        console.log("âœ… ä¿å­˜æˆåŠŸ:", finalCharData.name);

    } catch (e) {
        console.error("ä¿å­˜å¤±è´¥:", e);
        alert("ç³»ç»Ÿé”™è¯¯ï¼Œä¿å­˜å¤±è´¥");
    }
};

// ==========================================
// ğŸ“ é€šè®¯å½•æ¸²æŸ“ (æ°¸ä¸å´©æºƒç‰ˆ)
// ==========================================

window.renderContactsList = async function() {
    console.log("System: ğŸš€ å¼€å§‹æ¸²æŸ“è”ç³»äºº...");
    const container = document.getElementById('contacts-list-container');
    
    // 1. é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰å®¹å™¨ï¼Œå°±ä¸è·‘äº†
    if (!container) {
        console.error("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° id='contacts-list-container' çš„å®¹å™¨ï¼");
        return;
    }
    
    // 2. è·å–æ•°æ®
    let friends = await loadFromDB('chat_friends') || [];
    
    // 3. é¢„å¤„ç†åˆ†ç»„ (ç»™ä¸­æ–‡æ‹¼éŸ³åŠ â€œé˜²å¼¹è¡£â€)
    friends.forEach(f => {
        let firstChar = '#';
        const nameStr = f.name || "Unknown";

        // ğŸš¨ğŸš¨ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå…ˆæ£€æŸ¥ window.Pinyin æ˜¯å¦å­˜åœ¨ ğŸš¨ğŸš¨ğŸš¨
        // åªæœ‰å½“åº“å­˜åœ¨æ—¶ï¼Œæ‰å»è°ƒç”¨å®ƒã€‚å¦‚æœä¸å­˜åœ¨ï¼Œç›´æ¥è·³è¿‡ï¼Œç»å¯¹ä¸æŠ¥é”™ï¼
        if (window.Pinyin) {
            try {
                firstChar = Pinyin.convertToPinyin(nameStr).charAt(0).toUpperCase();
            } catch (e) {
                firstChar = nameStr.charAt(0).toUpperCase();
            }
        } else {
            // æ²¡åº“ï¼Ÿæ²¡å…³ç³»ï¼Œç›´æ¥å–é¦–å­—æ¯ï¼ˆä¸­æ–‡ä¼šå˜æˆç¬¦å·ï¼Œä½†ä¸æŠ¥é”™ï¼‰
            firstChar = nameStr.charAt(0).toUpperCase();
        }

        // å½’ç±»ï¼šåªæœ‰ A-Z æ‰èƒ½åšç´¢å¼•ï¼Œå…¶ä»–éƒ½å» #
        if (/[A-Z]/.test(firstChar)) {
            f.groupKey = firstChar;
        } else {
            f.groupKey = '#';
        }
    });

    // 4. æ’åº (è®©ä¸­æ–‡ä¹Ÿèƒ½æŒ‰æ‹¼éŸ³é¡ºåºæ’ï¼Œä¸ä»…æ˜¯åˆ†ç»„)
    friends.sort((a, b) => {
        if (a.groupKey !== b.groupKey) {
            if (a.groupKey === '#') return 1;
            if (b.groupKey === '#') return -1;
            return a.groupKey.localeCompare(b.groupKey);
        }
        // å¦‚æœæœ‰åº“ï¼Œç”¨ä¸­æ–‡æ’åºï¼›æ²¡åº“ç”¨é»˜è®¤æ’åº
        return a.name.localeCompare(b.name, 'zh-CN');
    });

    container.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
    
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
    if (friends.length === 0) {
        container.innerHTML = `<div style="padding:40px; text-align:center; color:#ccc;">No Contacts</div>`;
        // å³ä½¿æ²¡æ•°æ®ï¼Œä¹Ÿè¦æŠŠä¾§è¾¹æ ç”»å‡ºæ¥
        if(typeof renderFullAzSidebar === 'function') renderFullAzSidebar(new Set());
        return;
    }
    
    const existingGroups = new Set();
    let currentGroup = '';

    // 5. å¾ªç¯æ¸²æŸ“åˆ—è¡¨
    friends.forEach(f => {
        // æ¸²æŸ“åˆ†ç»„æ ‡é¢˜ (A, B, C...)
        if (f.groupKey !== currentGroup) {
            currentGroup = f.groupKey;
            existingGroups.add(currentGroup);
            
            const header = document.createElement('div');
            header.className = 'az-section-header';
            header.id = 'anchor-' + currentGroup;
            header.textContent = currentGroup;
            container.appendChild(header);
        }

        // é»˜è®¤å¤´åƒé€»è¾‘ (é˜²ç™½å±)
        let avatarHtml = '';
        if (f.avatar && f.avatar.length > 5) {
            avatarHtml = `<img src="${f.avatar}" style="width:100%; height:100%; object-fit:cover;">`;
        } else {
            const letter = (f.name || "?").charAt(0).toUpperCase();
            avatarHtml = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#ccc; color:#fff; font-weight:bold;">${letter}</div>`;
        }

        const div = document.createElement('div');
        div.className = 'recent-item';
        div.innerHTML = `
            <div class="contact-left-info" onclick="openChat('${f.id}')">
                <div style="width:40px; height:40px; background:#F2F2F7; border-radius:50%; margin-right:15px; overflow:hidden; flex-shrink:0;">
                    ${avatarHtml}
                </div>
                <span class="caller-name" style="font-size:16px; font-weight:600; color:#000;">${f.name}</span>
            </div>
            
            <div class="contact-more-btn" onclick="toggleContactMenu(event, '${f.id}')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="12" r="2"/></svg>
            </div>
            
            <div id="menu-${f.id}" class="contact-popover-menu">
                <div class="pop-item" onclick="editContact('${f.id}')">Edit</div>
                <div class="pop-item" onclick="settingContact('${f.id}')">Settings</div>
                <div class="pop-item danger" onclick="deleteContact('${f.id}')">Delete</div>
            </div>
        `;
        container.appendChild(div);
    });

    // 6. ğŸš¨ å¼ºåˆ¶æ¸²æŸ“ä¾§è¾¹æ  (å³ä½¿æŠ¥é”™ï¼Œä¸Šé¢ä¹Ÿä¼šè¢« catch ä½ï¼Œè¿™é‡Œä¸€å®šèƒ½æ‰§è¡Œ)
    console.log("System: åˆ—è¡¨æ¸²æŸ“å®Œæˆï¼Œæ­£åœ¨ç»˜åˆ¶ä¾§è¾¹æ ...");
    if(typeof renderFullAzSidebar === 'function') {
        renderFullAzSidebar(existingGroups);
    } else {
        console.error("âŒ æ‰¾ä¸åˆ° renderFullAzSidebar å‡½æ•°ï¼Œä¾§è¾¹æ æ— æ³•æ˜¾ç¤º");
    }
};

// --- è¾…åŠ©ï¼šæ¸²æŸ“ 26 å­—æ¯ä¾§è¾¹æ  (æ™ºèƒ½è·Ÿéšç‰ˆ) ---
function renderFullAzSidebar(existingGroups) {
    // 1. ğŸ§¹ å…¨å±€å¤§æ‰«é™¤ï¼šæŠŠæ‰€æœ‰ç°å­˜çš„ä¾§è¾¹æ ï¼ˆæ— è®ºåœ¨bodyè¿˜æ˜¯åœ¨å“ªï¼‰å…¨éƒ¨åˆ æ‰ï¼
    document.querySelectorAll('.az-sidebar').forEach(el => el.remove());

    // 2. å‡†å¤‡å­—æ¯è¡¨
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ#".split("");
    const bar = document.createElement('div');
    bar.className = 'az-sidebar';
    
    // 3. ç”Ÿæˆ HTML
    bar.innerHTML = alphabet.map(char => `
        <div class="az-char ${existingGroups.has(char) ? 'has-data' : ''}" 
             onclick="scrollToLetter('${char}')" 
             style="${existingGroups.has(char) ? 'color:#007AFF; font-weight:900;' : 'opacity:0.4;'}">
             ${char}
        </div>
    `).join('');
    
    // 4. ğŸ  æ ¸å¿ƒä¿®æ­£ï¼šæ‰¾åˆ°è”ç³»äººé¡µé¢çš„å®¹å™¨
    const contactsPage = document.getElementById('phone-view-contacts');
    
    if (contactsPage) {
        // æŠŠå®ƒå¡è¿›è”ç³»äººé¡µé¢é‡Œï¼è¿™æ ·é¡µé¢éšè—æ—¶ï¼Œå®ƒä¹Ÿä¼šéšè—ã€‚
        contactsPage.appendChild(bar);
        console.log("System: ä¾§è¾¹æ å·²æŒ‚è½½åˆ°è”ç³»äººé¡µé¢");
    } else {
        console.error("âŒ ä¸¥é‡é”™è¯¯ï¼šæ‰¾ä¸åˆ°è”ç³»äººé¡µé¢å®¹å™¨ (phone-view-contacts)");
    }
}

// ç¡®ä¿é¡µé¢åŠ è½½æ—¶æ¸²æŸ“ä¸€æ¬¡
document.addEventListener('DOMContentLoaded', () => {
    renderRecentsList();
    renderQuickDial(); // <--- ç¡®ä¿è¿™ä¸€è¡Œå­˜åœ¨
});

// ==========================================
// âš¡ï¸ äº¤äº’é€»è¾‘ï¼šèœå•å¼€å…³ & å­—æ¯å®šä½ & åŠŸèƒ½æ¡©
// ==========================================

// 1. åˆ‡æ¢èœå• (æ’ä»–æ€§ï¼šæ‰“å¼€è¿™ä¸ªï¼Œå…³é—­å…¶ä»–çš„)
window.toggleContactMenu = function(event, id) {
    event.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘ openChat
    
    // è·å–ç›®æ ‡èœå•
    const targetMenu = document.getElementById('menu-' + id);
    if (!targetMenu) return;

    // å¦‚æœå®ƒæ˜¯æ‰“å¼€çš„ï¼Œå°±å…³é—­å®ƒ
    if (targetMenu.style.display === 'flex') {
        targetMenu.style.display = 'none';
        return;
    }

    // å…³é—­æ‰€æœ‰å…¶ä»–çš„èœå•
    document.querySelectorAll('.contact-popover-menu').forEach(el => el.style.display = 'none');

    // æ‰“å¼€è¿™ä¸€ä¸ª
    targetMenu.style.display = 'flex';
};

// 2. ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ‰€æœ‰èœå•
document.addEventListener('click', function(e) {
    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯èœå•æŒ‰é’®ä¹Ÿä¸æ˜¯èœå•æœ¬èº«
    if (!e.target.closest('.contact-more-btn') && !e.target.closest('.contact-popover-menu')) {
        document.querySelectorAll('.contact-popover-menu').forEach(el => el.style.display = 'none');
    }
});

// ==========================================
// ğŸš€ æ™ºèƒ½è·³è½¬ + åŠ¨ç”»åé¦ˆ (æœ€ç»ˆå¢å¼ºç‰ˆ)
// ==========================================

let azToastTimer = null; // è®¡æ—¶å™¨å˜é‡

window.scrollToLetter = function(char) {
    const container = document.getElementById('contacts-list-container');
    if (!container) return;

    // --- 1. è§¦å‘å±å¹•ä¸­é—´çš„å¤§å­—æ¯åŠ¨ç”» (Visual Feedback) ---
    showAzToast(char);

    // --- 2. å¯»æ‰¾é”šç‚¹é€»è¾‘ (ä¸å˜) ---
    let anchor = document.getElementById('anchor-' + char);

    // æ™ºèƒ½æ‰¾é‚»å±…
    if (!anchor) {
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ#";
        const currentIndex = alphabet.indexOf(char);
        if (currentIndex !== -1) {
            for (let i = currentIndex + 1; i < alphabet.length; i++) {
                const nextChar = alphabet[i];
                const nextAnchor = document.getElementById('anchor-' + nextChar);
                if (nextAnchor) {
                    anchor = nextAnchor; 
                    break; 
                }
            }
        }
    }

    // --- 3. æ‰§è¡Œæ»šåŠ¨ (æ”¹ä¸ºå¹³æ»‘æ»šåŠ¨) ---
    if (anchor) {
        // ğŸš¨ å…³é”®ï¼šä½¿ç”¨ smooth è®©å®ƒæ»‘è¿‡å»ï¼Œè€Œä¸æ˜¯é—ªè¿‡å»
        anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // åˆ°åº•éƒ¨
        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
    }

    // 4. æ‰‹æœºéœ‡åŠ¨
    if(navigator.vibrate) navigator.vibrate(10); // ç¨å¾®åŠ é•¿ä¸€ç‚¹éœ‡åŠ¨
};

// --- è¾…åŠ©ï¼šæ˜¾ç¤ºå±å¹•ä¸­å¿ƒçš„å¤§å­—æ¯ ---
function showAzToast(text) {
    // 1. å¦‚æœé¡µé¢ä¸Šæ²¡æœ‰é‚£ä¸ªå¼¹çª—å…ƒç´ ï¼Œå°±ç°é€ ä¸€ä¸ª
    let toast = document.getElementById('az-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'az-toast';
        document.body.appendChild(toast);
    }

    // 2. è®¾ç½®æ–‡å­—
    toast.innerText = text;

    // 3. å¼ºåˆ¶é‡ç»˜ (è®©åŠ¨ç”»èƒ½é‡æ–°è§¦å‘)
    toast.classList.remove('show');
    void toast.offsetWidth; // é­”æ³•ä»£ç ï¼šè§¦å‘é‡ç»˜
    toast.classList.add('show');

    // 4. å®šæ—¶æ¶ˆå¤±
    if (azToastTimer) clearTimeout(azToastTimer);
    azToastTimer = setTimeout(() => {
        toast.classList.remove('show');
    }, 600); // 0.6ç§’åæ¶ˆå¤±
}

// 2. æ‰“å¼€â€œç¼–è¾‘â€å¼¹çª— (æ ¸å¿ƒéœ€æ±‚)
// --- âœï¸ ç¼–è¾‘è”ç³»äºº (è¯»å–èº«ä»½ + å›å¡«ä¸–ç•Œè§‚) ---
window.editContact = async function(id) {
    console.log("System: æ‰“å¼€ç¼–è¾‘æ¨¡å¼, ID:", id);
    const modal = document.getElementById('modal-phone-add-contact');
    if(!modal) return;

    // A. å‡†å¤‡æ•°æ®
    const chars = await loadFromDB('char_list') || [];
    const phoneDir = await loadFromDB('phone_directory') || {};
    
    // æ‰¾åˆ°è¯¥è§’è‰²æ•°æ®
    const charData = chars.find(c => c.id === id);
    if (!charData) { showToast("æ‰¾ä¸åˆ°è¯¥è§’è‰²æ•°æ®"); return; }

    // B. åˆ‡æ¢ UI åˆ°â€œç¼–è¾‘æ¨¡å¼â€
    setupModalMode('edit', id); 

    // C. ğŸš¨ æ ¸å¿ƒå›å¡«ï¼šè¯»å–èº«ä»½ä¸ä¸–ç•Œè§‚
    // 1. å¡«åå­—
    document.getElementById('phone-name-in').value = charData.name || "";
    // 2. ğŸš¨ å¡«äººè®¾ (Bio/Desc) - ä¿®å¤ä¹‹å‰è¯»å–ä¸åˆ°çš„é—®é¢˜
    document.getElementById('phone-desc-in').value = charData.desc || ""; 
    
    // 3. å¡«ç”µè¯
    const phoneNum = phoneDir["id_" + id] || "";
    document.getElementById('common-phone-in').value = phoneNum;

    // 4. å¡«å¤´åƒ
    const imgPre = document.getElementById('phone-avatar-pre');
    const imgPlace = document.getElementById('phone-avatar-placeholder');
    if (charData.avatar) {
        imgPre.src = charData.avatar;
        imgPre.style.display = 'block';
        imgPlace.style.display = 'none';
        window.tempPhoneAvatar = charData.avatar; 
    }

    // 5. ğŸš¨ æ ¸å¿ƒå›å¡«ï¼šæ¸²æŸ“ä¸–ç•Œè§‚åˆ—è¡¨å¹¶å‹¾é€‰å·²ç»‘å®šçš„ ID
    const boundIds = charData.boundWorldIds || []; 
    await renderPhoneWorldList(boundIds); // ğŸ‘ˆ æŠŠä¿å­˜çš„ ID ä¼ è¿›å»

    // D. æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
    document.querySelectorAll('.contact-popover-menu').forEach(el => el.style.display = 'none');
};

// --- è¾…åŠ©ï¼šåˆ‡æ¢å¼¹çª—çš„ UI çŠ¶æ€ (æ–°å»º vs ç¼–è¾‘) ---
function setupModalMode(mode, editId = null) {
    const modal = document.getElementById('modal-phone-add-contact');
    const title = modal.querySelector('.header-title');
    const segment = modal.querySelector('.segment-control');
    const createPanel = document.getElementById('panel-phone-create');
    const importPanel = document.getElementById('panel-phone-import');

    // æ ‡è®°å½“å‰æ¨¡å¼
    modal.setAttribute('data-mode', mode);
    if(editId) modal.setAttribute('data-edit-id', editId);

    if (mode === 'create') {
        title.textContent = "New Contact";
        segment.style.display = 'flex'; // æ˜¾ç¤ºåˆ‡æ¢æ¡
        createPanel.style.display = 'block';
        importPanel.style.display = 'none';
        switchPhoneAddTab('create'); // é‡ç½® Tab
    } else {
        title.textContent = "Edit Contact";
        segment.style.display = 'none'; // ğŸš¨ ç¼–è¾‘æ—¶éšè—åˆ‡æ¢æ¡ï¼
        createPanel.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤ºè¡¨å•é¡µ
        importPanel.style.display = 'none';
    }
}

// --- è¾…åŠ©ï¼šæ¸…ç©ºè¡¨å• ---
function clearPhoneForm() {
    document.getElementById('phone-name-in').value = "";
    document.getElementById('phone-desc-in').value = "";
    document.getElementById('common-phone-in').value = "";
    document.getElementById('phone-avatar-pre').style.display = 'none';
    document.getElementById('phone-avatar-placeholder').style.display = 'flex';
    window.tempPhoneAvatar = null;
    renderPhoneWorldList(); // é‡ç½®ä¸–ç•Œä¹¦å‹¾é€‰
}

// --- ğŸ’¾ æäº¤ä¿å­˜ (ä¿å­˜èº«ä»½ + ç»‘å®šä¸–ç•Œè§‚) ---
window.submitPhoneContact = async function() {
    const modal = document.getElementById('modal-phone-add-contact');
    const mode = modal.getAttribute('data-mode'); // 'create' or 'edit'
    
    // 1. è·å–è¾“å…¥ä¿¡æ¯
    const name = document.getElementById('phone-name-in').value.trim();
    // ğŸš¨ è·å–äººè®¾ (Bio)
    const desc = document.getElementById('phone-desc-in').value.trim(); 
    const phoneNum = document.getElementById('common-phone-in').value.trim();
    const avatar = window.tempPhoneAvatar || ("https://api.dicebear.com/7.x/initials/svg?seed=" + name);
    
    // ğŸš¨ è·å–é€‰ä¸­çš„ä¸–ç•Œä¹¦ IDs
    const checkedWorlds = Array.from(document.querySelectorAll('.phone-world-check:checked')).map(cb => cb.value);

    if (!name) { showToast("è¯·è¾“å…¥å§“å"); return; }
    if (!phoneNum) { showToast("è¯·è¾“å…¥ç”µè¯å·ç "); return; }

    // åŠ è½½æ•°æ®åº“
    let chars = await loadFromDB('char_list') || [];
    let friends = await loadFromDB('chat_friends') || [];
    let phoneDir = await loadFromDB('phone_directory') || {};

    let targetId = null;

    if (mode === 'edit') {
        // --- ç¼–è¾‘æ¨¡å¼ ---
        targetId = modal.getAttribute('data-edit-id');
        const charIndex = chars.findIndex(c => c.id === targetId);
        
        if (charIndex !== -1) {
            // ğŸš¨ æ›´æ–°æ ¸å¿ƒæ¡£æ¡ˆ
            chars[charIndex].name = name;
            chars[charIndex].desc = desc; // ä¿å­˜äººè®¾
            chars[charIndex].avatar = avatar;
            chars[charIndex].boundWorldIds = checkedWorlds; // ä¿å­˜ä¸–ç•Œè§‚ç»‘å®š
            
            await saveToDB('char_list', chars);
            
            // åŒæ­¥æ›´æ–°å¥½å‹åˆ—è¡¨æ˜¾ç¤º
            const friendIndex = friends.findIndex(f => f.id === targetId);
            if (friendIndex !== -1) {
                friends[friendIndex].name = name;
                friends[friendIndex].avatar = avatar;
                await saveToDB('chat_friends', friends);
            }
        }
    } else {
        // --- æ–°å»ºæ¨¡å¼ ---
        targetId = "char_" + Date.now();
        
        // æ„é€ æ–°è§’è‰²å¯¹è±¡
        const newChar = {
            id: targetId,
            name: name,
            desc: desc, // ä¿å­˜äººè®¾
            avatar: avatar,
            boundWorldIds: checkedWorlds, // ä¿å­˜ä¸–ç•Œè§‚
            createdAt: Date.now(),
            relationNetwork: []
        };

        chars.unshift(newChar);
        await saveToDB('char_list', chars);
        
        friends.unshift({ id: targetId, name: name, avatar: avatar });
        await saveToDB('chat_friends', friends);
    }

    // --- å¤„ç†ç”µè¯å·ç ç»‘å®š ---
    // å…ˆæ¸…é™¤æ—§å·
    for (let key in phoneDir) {
        if (phoneDir[key] === targetId) delete phoneDir[key]; 
        if (key === "id_" + targetId) delete phoneDir[key];   
    }
    // ç»‘å®šæ–°å·
    phoneDir[phoneNum] = name;
    phoneDir["id_" + targetId] = phoneNum; 
    await saveToDB('phone_directory', phoneDir);

    // --- æ”¶å°¾ ---
    closePhoneAddModal();
    if(typeof renderContactsList === 'function') renderContactsList();
    if(typeof renderQuickDial === 'function') renderQuickDial(); // åˆ·æ–°ä¸€ä¸‹æ‹¨å·ç›˜çš„æœ€è¿‘è”ç³»äºº
    
    showToast(mode === 'edit' ? "ä¿®æ”¹å·²ä¿å­˜ (äººè®¾/ä¸–ç•Œè§‚åŒæ­¥)" : "æ–°å»ºæˆåŠŸ");
};

// ==========================================
// ğŸ—‘ï¸ åˆ é™¤é€»è¾‘ (æ›¿æ¢æµè§ˆå™¨åŸç”Ÿå¼¹çª—)
// ==========================================

// 1. ç‚¹å‡»åˆ é™¤æŒ‰é’® -> æ‰“å¼€è‡ªå®šä¹‰å¼¹çª—
window.deleteContact = function(id) {
    // å­˜ä¸‹ IDï¼Œä¸€ä¼šå„¿ç¡®è®¤åˆ é™¤æ—¶è¦ç”¨
    pendingDeleteId = id;
    
    // å…³é—­é‚£ä¸ªä¸‰ä¸ªç‚¹çš„å°èœå•
    document.querySelectorAll('.contact-popover-menu').forEach(el => el.style.display = 'none');
    
    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
    const modal = document.getElementById('modal-delete-confirm');
    if(modal) modal.style.display = 'flex';
    
    // æ‰‹æœºéœ‡åŠ¨æé†’
    if(navigator.vibrate) navigator.vibrate(10);
};

// 2. ç‚¹å‡»å¼¹çª—é‡Œçš„â€œDelete Contactâ€ -> çœŸçš„åˆ åº“
window.confirmRealDelete = async function() {
    if (!pendingDeleteId) return;
    
    // æ‰§è¡Œä¹‹å‰çš„åˆ é™¤é€»è¾‘
    let friends = await loadFromDB('chat_friends') || [];
    friends = friends.filter(f => f.id !== pendingDeleteId);
    await saveToDB('chat_friends', friends);
    
    // è¿˜éœ€è¦ä» char_list é‡Œåˆ æ‰ (å¯é€‰ï¼Œçœ‹ä½ éœ€æ±‚ï¼Œé€šå¸¸é€šè®¯å½•åˆ é™¤ä¹Ÿè¦åˆ è§’è‰²æ•°æ®)
    let chars = await loadFromDB('char_list') || [];
    chars = chars.filter(c => c.id !== pendingDeleteId);
    await saveToDB('char_list', chars);

    // æ¸…ç†ç”µè¯æœ¬ç»‘å®š
    let phoneDir = await loadFromDB('phone_directory') || {};
    // æ¸…ç†è¯¥ ID çš„ç»‘å®š
    for (let key in phoneDir) {
        if (phoneDir[key] === pendingDeleteId) delete phoneDir[key]; 
        if (key === "id_" + pendingDeleteId) delete phoneDir[key];
    }
    await saveToDB('phone_directory', phoneDir);

    // åˆ·æ–° UI
    renderContactsList(); 
    showToast("Contact Deleted");
    
    // å…³é—­å¼¹çª—
    closeDeleteModal();
};

// 3. ç‚¹å‡»å–æ¶ˆæˆ–èƒŒæ™¯ -> å…³é—­å¼¹çª—
window.closeDeleteModal = function() {
    const modal = document.getElementById('modal-delete-confirm');
    if(modal) modal.style.display = 'none';
    pendingDeleteId = null;
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    // é¡µé¢åŠ è½½æ—¶åˆ·æ–°ä¸€ä¸‹è”ç³»äºº
    renderContactsList(); 
});

var currentRecentsFilter = 'all'; // å½“å‰æ ‡ç­¾
// --- ğŸ“ ç”µè¯ App é€»è¾‘ ---

// --- ğŸ“ ç”µè¯ App æ ‡ç­¾åˆ‡æ¢é€»è¾‘ (ç»ˆæä¿®å¤ç‰ˆ) ---
window.switchPhoneTab = function(tabName) {
    // 1. éšè—æ‰€æœ‰è§†å›¾å’Œå¯¼èˆªé«˜äº® (ä½ åŸæœ‰çš„é€»è¾‘)
    document.querySelectorAll('.phone-view-container').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.p-nav-item').forEach(el => el.classList.remove('active'));

    const targetView = document.getElementById('phone-view-' + tabName);
    const targetNav = document.getElementById('p-nav-' + tabName);
    if (targetView) targetView.classList.add('active');
    if (targetNav) targetNav.classList.add('active');

    // 2. ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šæ§åˆ¶åƒåœ¾æ¡¶å›¾æ ‡å’Œå…³é—­æŒ‰é’®çš„æ˜¾éš
    const clearBtn = document.getElementById('recents-clear-btn');
    const closeBtn = document.getElementById('phone-close-btn');
    const titleEl = document.getElementById('phone-header-title');

    if (tabName === 'recents') {
        // æœ€è¿‘é€šè¯é¡µï¼šæ˜¾ç¤ºåƒåœ¾æ¡¶ï¼Œéšè—å…³é—­æŒ‰é’®
        if(clearBtn) clearBtn.style.display = 'block';
        if(closeBtn) {
            closeBtn.style.opacity = '0';
            closeBtn.style.pointerEvents = 'none';
        }
        titleEl.textContent = "Recents";
    } 
    else if (tabName === 'keypad') {
        // æ‹¨å·é¡µï¼šæ˜¾ç¤ºå…³é—­æŒ‰é’®ï¼Œéšè—åƒåœ¾æ¡¶
        if(clearBtn) clearBtn.style.display = 'none';
        if(closeBtn) {
            closeBtn.style.opacity = '1';
            closeBtn.style.pointerEvents = 'auto';
        }
        titleEl.textContent = "Keypad";
    } 
    else {
        // è”ç³»äººé¡µï¼šå…¨éƒ¨éšè—ï¼ˆæˆ–è€…æ ¹æ®éœ€æ±‚ä¿ç•™å…³é—­æŒ‰é’®ï¼‰
        if(clearBtn) clearBtn.style.display = 'none';
        if(closeBtn) {
            closeBtn.style.opacity = '0';
            closeBtn.style.pointerEvents = 'none';
        }
        titleEl.textContent = "Contacts";
    }
};

// è¦†ç›–åŸæœ‰çš„ tapKeyï¼Œå¢åŠ åˆ é™¤æŒ‰é’®æ˜¾éšé€»è¾‘
var originalTapKey = window.tapKey;
// ==========================================
// ğŸ”¢ æ‹¨å·é”®ç›˜æ ¸å¿ƒé€»è¾‘ (å¸¦è”ç³»äººåŒ¹é…)
// ==========================================

// 1. ç‚¹å‡»æ•°å­—é”®
window.tapKey = function(num) {
    const display = document.getElementById('keypad-number-display');
    const delBtn = document.getElementById('keypad-del-btn');
    
    // ç‰©ç†è¾“å…¥é€»è¾‘
    if (display && display.textContent.length < 15) {
        display.textContent += num;
        
        // éœ‡åŠ¨åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(10);
        
        // ğŸš¨ æ ¸å¿ƒï¼šè¾“å…¥åç«‹å³æ£€æŸ¥åŒ¹é…
        checkKeypadMatch(display.textContent);
    }

    // æ˜¾éšåˆ é™¤é”®
    if (delBtn && display) {
        delBtn.style.display = (display.textContent.length > 0) ? 'flex' : 'none';
    }
};

// 2. ç‚¹å‡»åˆ é™¤é”®
window.delKey = function() {
    const display = document.getElementById('keypad-number-display');
    const delBtn = document.getElementById('keypad-del-btn');
    
    if (display) {
        // æ‰§è¡Œåˆ é™¤
        display.textContent = display.textContent.slice(0, -1);
        
        // éœ‡åŠ¨åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(10);

        // ğŸš¨ æ ¸å¿ƒåˆ¤æ–­ï¼šå¦‚æœåˆ å®Œäº†ï¼Œæ˜¾ç¤ºå†å²è®°å½•ï¼›å¦‚æœè¿˜æœ‰æ•°å­—ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœ
        if (display.textContent.length === 0) {
            // éšè—åˆ é™¤æŒ‰é’®
            if (delBtn) delBtn.style.display = 'none';
            // ğŸŒŸ å…³é”®ï¼šæ¢å¤æœ€è¿‘é€šè¯åˆ—è¡¨
            renderQuickDial(); 
            // æ¢å¤æ ‡é¢˜
            const labelTitle = document.querySelector('.quick-label');
            if(labelTitle) labelTitle.innerText = "RECENT HISTORY / æœ€è¿‘è®°å½•";
        } else {
            // è¿˜æœ‰æ•°å­—ï¼Œç»§ç»­æœç´¢
            checkKeypadMatch(display.textContent);
        }
    }
};

// ==========================================
// ğŸ” æ™ºèƒ½æ‹¨å·ï¼šåœ¨é”®ç›˜ä¸Šæ–¹æ˜¾ç¤ºâ€œè”ç³»äººå¡ç‰‡â€
// ==========================================

window.checkKeypadMatch = async function(currentNumber) {
    const listContainer = document.getElementById('quick-dial-list');
    const labelTitle = document.querySelector('.quick-label');
    
    if (!listContainer) return;

    // A. å¦‚æœå·ç ä¸ºç©º -> æ¢å¤é»˜è®¤æ˜¾ç¤º (æœ€è¿‘é€šè¯)
    if (!currentNumber || currentNumber.length === 0) {
        if(labelTitle) labelTitle.innerText = "RECENT HISTORY / æœ€è¿‘è®°å½•";
        renderQuickDial(); // ğŸŒŸ å…³é”®ï¼šè¿™é‡Œä¸å†æ˜¯æ¸…ç©ºï¼Œè€Œæ˜¯æ¸²æŸ“å†å²
        return;
    }

    // B. å¼€å§‹æœç´¢ (æ˜¾ç¤ºåŒ¹é…ç»“æœ)
    if(labelTitle) labelTitle.innerText = "MATCHES / åŒ¹é…ç»“æœ";
    
    // ... (ä»¥ä¸‹æ˜¯æœç´¢é€»è¾‘ï¼Œä¿æŒä¸å˜ï¼Œä¸ºäº†å®Œæ•´æ€§æˆ‘è´´åœ¨è¿™é‡Œ) ...
    const friends = await loadFromDB('chat_friends') || [];
    const phoneDir = await loadFromDB('phone_directory') || {};
    
    const matchedFriends = [];
    for (let f of friends) {
        const savedPhone = phoneDir["id_" + f.id];
        if (savedPhone && savedPhone.includes(currentNumber)) {
            f.matchedPhone = savedPhone;
            matchedFriends.push(f);
        }
    }

    // æ¸²æŸ“æœç´¢ç»“æœ (å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œæ˜¾ç¤ºâ€œæ·»åŠ åˆ°è”ç³»äººâ€)
    listContainer.innerHTML = ""; 
    
    if (matchedFriends.length === 0) {
        listContainer.innerHTML = `
            <div class="quick-record-card" onclick="addContactFromKeypad('${currentNumber}')" style="justify-content:center; color:#007AFF;">
                <div style="font-weight:600;">+ æ·»åŠ å·ç åˆ°è”ç³»äºº</div>
            </div>
        `;
        return;
    }

    // æ¸²æŸ“åŒ¹é…åˆ°çš„å¥½å‹å¡ç‰‡
    listContainer.innerHTML = matchedFriends.map(f => `
        <div class="quick-record-card" onclick="startCall('${f.name}', '${f.avatar}', '${f.id}')">
            <img class="quick-card-avatar" src="${f.avatar}">
            <div class="quick-card-info">
                <div class="quick-card-name">${f.name}</div>
                <div class="quick-card-meta-row">
                    <span style="color:#007AFF; font-weight:700;">${f.matchedPhone}</span>
                </div>
            </div>
        </div>
    `).join('');
};

// è¾…åŠ©ï¼šä»é”®ç›˜ç›´æ¥æ·»åŠ è”ç³»äºº
window.addContactFromKeypad = function(num) {
    addContact(); // æ‰“å¼€æ·»åŠ å¼¹çª—
    // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼ŒæŠŠå·ç å¡«è¿›å»
    setTimeout(() => {
        document.getElementById('common-phone-in').value = num;
    }, 300);
};

// åˆå§‹åŒ–ï¼šç¡®ä¿æ‰“å¼€ App æ—¶çŠ¶æ€æ­£ç¡®
// ä½ éœ€è¦åœ¨ openApp å‡½æ•°é‡ŒåŠ ä¸€ä¸ªé’©å­ï¼Œæˆ–è€…ç›´æ¥åœ¨è¿™é‡Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    // é»˜è®¤åˆ‡åˆ° keypad
    switchPhoneTab('keypad');
});
/**
 * ğŸµ å…¨å±€éŸ³ä¹åŒæ­¥å¼•æ“
 * ä½œç”¨ï¼šå°†éŸ³ä¹ App çš„æ’­æ”¾çŠ¶æ€å®æ—¶ç‰©ç†æŠ•å°„åˆ°ä¸»é¡µå°ç»„ä»¶
 */
window.syncHomeMusicWidget = function() {
    const audio = document.getElementById('main-audio-engine');
    const song = currentPlaylist[currentPlayIndex];
    
    // è·å–ä¸»é¡µç»„ä»¶å…ƒç´ 
    const homeTitle = document.querySelector('.track-title');
    const homeArtist = document.querySelector('.track-artist');
    const homeCover = document.querySelector('.album-cover');
    const playIcon = document.querySelector('.ctrl-btns svg:nth-child(2)'); // æ’­æ”¾/æš‚åœå›¾æ ‡

    if (!song) return;

    // 1. åŒæ­¥æ–‡å­—å†…å®¹
    if (homeTitle) homeTitle.textContent = song.title.toUpperCase();
    if (homeArtist) homeArtist.textContent = song.artist.toUpperCase();

    // 2. åŒæ­¥å°é¢å›¾
    if (homeCover) {
        homeCover.style.backgroundImage = `url(${song.cover})`;
        homeCover.style.backgroundSize = 'cover';
        homeCover.style.backgroundPosition = 'center';
        
        // 3. æ ¹æ®æ’­æ”¾çŠ¶æ€æ·»åŠ åŠ¨ç”»
        if (!audio.paused) {
            homeCover.classList.add('playing');
        } else {
            homeCover.classList.remove('playing');
        }
    }

    // 4. åŒæ­¥å°ç»„ä»¶ä¸Šçš„æ’­æ”¾å›¾æ ‡ (å¯é€‰)
    if (playIcon) {
        if (!audio.paused) {
            // åˆ‡æ¢ä¸ºæš‚åœå›¾æ ‡ (ä¸¤æ¡ç«–æ )
            playIcon.innerHTML = `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>`;
        } else {
            // åˆ‡æ¢ä¸ºæ’­æ”¾å›¾æ ‡ (ä¸‰è§’å½¢)
            playIcon.innerHTML = `<path d="M8 5v14l11-7z"/>`;
        }
    }
};
// ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤æ•°æ®
window.addEventListener('load', () => {
    const savedPosts = localStorage.getItem('lune_community_posts');
    if (savedPosts) {
        try {
            const posts = JSON.parse(savedPosts);
            window.cachedNpcPosts = posts; // å­˜å…¥å†…å­˜ç¼“å­˜
            renderCommunityFeed(posts);   // æ¸²æŸ“ä¸»åˆ—è¡¨
            console.log("å·²ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç¤¾åŒºä¿¡å·...");
        } catch (e) {
            console.error("æœ¬åœ°ä¿¡å·æ•°æ®å—æŸ:", e);
        }
    }
});
window.switchNpcTab = function(vibe, el) {
    window.currentNpcTab = vibe;
    document.querySelectorAll('.npc-tab-item').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    syncCommunitySignals(); // åˆ‡æ¢æ—¶è‡ªåŠ¨é‡æ–°æ‰«æ
};
// å…¨å±€çŠ¶æ€é”å®š
window.currentNpcTab = 'emotion';
window.cachedNpcPosts = [];
window.appendRadioLog = function(role, text) {
    const log = document.getElementById('radio-terminal-log');
    if (!log) return;

    const div = document.createElement('div');
    // æ”¯æŒ user, ai, system ä¸‰ç§è§’è‰²
    div.className = `log-entry ${role}`; 
    
    const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    // ç³»ç»Ÿæ¶ˆæ¯æ˜¾ç¤º [SYSTEM]ï¼Œç”¨æˆ·æ˜¾ç¤º [OPERATOR]ï¼ŒAIæ˜¾ç¤ºåå­—
    const sender = role === 'system' ? 'SYSTEM' : (role === 'user' ? 'OPERATOR' : window.currentSynergyTarget.name.toUpperCase());

    div.innerHTML = `
        <div class="log-meta">[${time}] // SOURCE: ${sender}</div>
        <div class="log-content">${text}</div>
    `;
    log.appendChild(div);
    log.scrollTo({ top: log.scrollHeight, behavior: 'smooth' });
};
/**
 * ğŸ›°ï¸ AI ä¸»åŠ¨å›å¤é€»è¾‘ (ç”± REPLY æŒ‰é’®ç‰©ç†è§¦å‘)
 */
window.requestAIReply = async function() {
    console.log("%c[Radio] ç‰©ç†æŒ‰é’®ç‚¹ç«...", "color: #AF52DE; font-weight: bold;");

    // 1. ç‰©ç†é”é˜²æŠ–
    if (window.isAiProcessing) return;

    // 2. é”å®šç”µå°å¯¹è±¡
    const contact = window.currentSynergyTarget;
    if (!contact) {
        alert("âš ï¸ æ— æ³•è¯†åˆ«è”è§‰å¯¹è±¡");
        return;
    }

    // 3. UI çŠ¶æ€åé¦ˆ
    const btn = document.querySelector('.reply-btn');
    if (btn) btn.style.opacity = '0.3';
    window.isAiProcessing = true;

    try {
        // 4. è·å–å½“å‰æ­Œæ›²ç¯å¢ƒ
        const songTitle = document.getElementById('player-title')?.innerText || "æœªçŸ¥æ—‹å¾‹";
        const artist = document.getElementById('player-artist')?.innerText || "ä½šå";

        // 5. æŠ“å–åŠ å¯†ç”µå°å†å² (synergy_ å‰ç¼€)
        const history = await getChatHistory("synergy_" + contact.id) || [];
        
        // æå–æœ€åä¸€æ¡ç”¨æˆ·çš„è¯ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨ç¯å¢ƒéŸ³æš—ç¤º
        let lastUserText = "";
        for (let i = history.length - 1; i >= 0; i--) {
            if (history[i].role === 'user') {
                lastUserText = history[i].text;
                break;
            }
        }

        // 6. è°ƒç”¨ä¸“ç”¨ç”µå° AI å¼•æ“
        await callAIForSynergy(contact, lastUserText, history, { title: songTitle, artist: artist });

    } catch (e) {
        console.error("Radio AI Error:", e);
        appendRadioLog('system', "SIGNAL_ERROR: " + e.message);
    } finally {
        window.isAiProcessing = false;
        if (btn) btn.style.opacity = '1';
    }
};
/**
 * 3. æ‰§è¡Œé‚€çº¦åè®® (AI å†³ç­–åˆ†æ”¯)
 * ä½œç”¨ï¼šç‚¹å‡»â€œç¡®è®¤é‚€çº¦â€åè§¦å‘ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»å¹¶åˆ¤å®šç»“æœ
 */
window.executeInviteProtocol = async function() {
    const contact = window.currentSynergyTarget;
    if (!contact) return;

    window.closeResonanceModal();

    // ğŸš¨ ç‰©ç†ç‚¹ç«ï¼šå”¤èµ·æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„åŠ è½½å±‚
    const loader = document.getElementById('synergy-invite-loading');
    if (loader) {
        loader.style.display = 'flex'; // å¼ºåˆ¶æ˜¾ç¤º
        console.log("%c[Signal] æ­£åœ¨æ‰§è¡Œé‚€çº¦åè®®ï¼ŒåŠ¨ç”»å·²æŒ‚è½½", "color: #007AFF;");
    }
    
    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        const song = currentPlaylist[currentPlayIndex] || { title: "æœªçŸ¥æ—‹å¾‹" };
        
        // æŠ“å–è®°å¿†
        const summaries = await loadFromDB('summaries_' + contact.id) || [];
        const latestMemory = summaries[0] ? summaries[0].text : "è®°å¿†å°šæœªè‹é†’";

        const prompt = `ä½ æ˜¯ ${contact.name}ã€‚èƒŒæ™¯: ${contact.desc}ã€‚
        ç”¨æˆ·é‚€ä½ ä¸€èµ·å¬æ­Œã€Š${song.title}ã€‹ã€‚
        è¿‘æœŸè®°å¿†æ‘˜è¦: ${latestMemory}ã€‚
        ã€å†³ç­–è§„åˆ™ã€‘:
        1. 90%æ¦‚ç‡æ¥å— accept: trueï¼Œ10%æ¦‚ç‡æ‹’ç» accept: falseã€‚
        2. ç»™å‡ºä¸€å¥ç¬¦åˆå½“ä¸‹å¿ƒæƒ…çš„å›åº” JSON: {"accept": boolean, "msg": "str"}`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.9
            })
        });

        const data = await res.json();
        const response = JSON.parse(data.choices[0].message.content.match(/\{.*\}/s)[0]);

        // æ¨¡æ‹Ÿ 1.2s çš„é‡å­é¢‘ç‡å¯¹é½æ—¶é—´
        setTimeout(() => {
            if (loader) loader.style.display = 'none';

            if (response.accept) {
                // âœ… è·³è½¬è‡³æˆåŠŸå…¨å±å¼¹çª—
                showSynergySuccess(contact, response.msg);
            } else {
                // âŒ è·³è½¬è‡³æ‹’ç»å¼¹çª—
                showSynergyReject(contact, response.msg);
            }
        }, 1200);

    } catch (e) {
        if (loader) loader.style.display = 'none';
        showToast("é‡å­ä¿¡å·å¹²æ‰°ä¸¥é‡");
    }
};
/**
 * ğŸ›°ï¸ SYNERGY åè®®ï¼šå‘èµ·é‚€çº¦æ ¸å¿ƒå‡½æ•°
 * ä½œç”¨ï¼šæ¥æ”¶æ‹¨ç›˜ç‚¹å‡»ï¼ŒåŒæ­¥ç›®æ ‡æ•°æ®ï¼Œå”¤èµ·ç¡®è®¤å¼¹çª—
 */
window.sendResonanceInvite = function(contact) {
    console.log("%c[Signal] æ•è·ç‚¹å‡»ï¼Œå‡†å¤‡é‚€çº¦:", "color: #007AFF; font-weight: bold;", contact.name);
    
    // æ³¨å…¥å…¨å±€ç›®æ ‡
    window.currentSynergyTarget = contact; 

    // è·å–ç¡®è®¤å¼¹çª—ä¸­çš„å…ƒç´ 
    const avt = document.getElementById('invite-target-avatar');
    const name = document.getElementById('invite-target-name');
    const modal = document.getElementById('modal-resonance-invite');

    if (avt && name && modal) {
        avt.src = contact.avatar;
        name.textContent = contact.name.toUpperCase();
        modal.style.display = 'flex'; // å¼¹å‡ºç¡®è®¤å¡ç‰‡
    } else {
        console.error("âŒ æ‰¾ä¸åˆ°é‚€çº¦å¼¹çª—å…ƒç´ ï¼Œè¯·æ£€æŸ¥ HTML æ˜¯å¦è¡¥å…¨äº† invite-target-avatar");
        showToast("ç³»ç»Ÿç¯å¢ƒå¼‚å¸¸");
    }
};

/**
 * è¾…åŠ©ï¼šå…³é—­é‚€çº¦å¼¹çª—
 */
window.closeResonanceModal = function() {
    const modal = document.getElementById('modal-resonance-invite');
    if (modal) modal.style.display = 'none';
};
// 1. åˆå§‹åŒ–å…¥å£ï¼šåœ¨ switchMusicTab ä¸­è°ƒç”¨
window.initSynergyDial = async function() {
    const dial = document.getElementById('synergy-friend-dial');
    if (!dial) return;
    const friends = await loadFromDB('chat_friends') || []; //
    dial.innerHTML = friends.map(f => `
        <div class="dial-item" onclick="sendResonanceInvite(${JSON.stringify(f).replace(/"/g, '&quot;')})">
            <div class="dial-avatar-box"><img src="${f.avatar}"></div>
            <span>${f.name.toUpperCase()}</span>
        </div>
    `).join('') || `<div style="color:#CCC; padding:40px;">æ¬¡å…ƒåˆ—è¡¨ä¸ºç©º</div>`;
};
// 2. ç‰©ç†å¯åŠ¨ï¼šä¿¡å·æ‰«æä»ªå¼
window.launchRadioPortal = async function(contact) {
    const layer = document.getElementById('synergy-master-portal');
    const loader = document.getElementById('synergy-loading-screen');
    const radioUI = document.getElementById('synergy-radio-interface');
    
    window.currentRadioPartner = contact;
    layer.style.display = 'flex';
    loader.style.display = 'flex';
    radioUI.style.display = 'none';

    // æ¨¡æ‹Ÿä¿¡å·å¯¹é½åŠ¨ç”»
    let percent = 0;
    const syncInt = setInterval(() => {
        percent += 5;
        document.getElementById('sync-percent').textContent = percent;
        if(percent >= 100) {
            clearInterval(syncInt);
            loader.style.display = 'none';
            radioUI.style.display = 'flex';
            initRadioInterface(contact);
        }
    }, 50);
};
// 3. æ¸²æŸ“ç”µå°ä¸»ç•Œé¢
async function initRadioInterface(char) {
    document.getElementById('radio-avatar').src = char.avatar;
    document.getElementById('disc-avatar').src = char.avatar;
    document.getElementById('radio-name').textContent = char.name.toUpperCase();
    
    // åŒæ­¥èŠå¤© App çš„æ€»ç»“è®°å¿†
    const summaries = await loadFromDB('summaries_' + char.id) || [];
    const memoryText = summaries[0] ? summaries[0].text : "é‡å­çº ç¼ åˆå§‹åŒ–ä¸­...";
    document.getElementById('radio-memory-strip').textContent = `[HISTORY_DECODED] // ${memoryText}`;
}

// 4. æ ¸å¿ƒäº¤äº’ï¼šç¼©æ”¾è‡³é»‘èƒ¶æ‚¬æµ®çƒ
window.minimizeToDisc = function() {
    const layer = document.getElementById('synergy-master-portal');
    const disc = document.getElementById('synergy-mini-disc');

    layer.style.transition = 'all 0.5s cubic-bezier(0.19, 1, 0.22, 1)';
    layer.style.transform = 'scale(0.5) translateY(100%)';
    layer.style.opacity = '0';
    
    setTimeout(() => {
        layer.style.display = 'none';
        disc.style.display = 'flex';
        disc.style.animation = 'iosPop 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards';
        showToast("ç”µå°å·²æŒ‚èµ·è‡³é«˜ç»´ç©ºé—´");
    }, 400);
};

// 5. æ ¸å¿ƒäº¤äº’ï¼šä»æ‚¬æµ®çƒæ¢å¤
window.restoreFromDisc = function() {
    const layer = document.getElementById('synergy-master-portal');
    const disc = document.getElementById('synergy-mini-disc');

    disc.style.display = 'none';
    layer.style.display = 'flex';
    void layer.offsetWidth; // è§¦å‘é‡ç»˜
    layer.style.transform = 'scale(1) translateY(0)';
    layer.style.opacity = '1';
};

window.terminateSynergy = function() {
    showIOSConfirm("åˆ‡æ–­é¢‘é“", "ç¡®å®šè¦ä¸­æ–­ä¸è¯¥ç»´åº¦çš„é¢‘ç‡å…±é¸£å—ï¼Ÿ", "åˆ‡æ–­", () => {
        window.isRadioActive = false;
        const portal = document.getElementById('synergy-master-portal');
        const disc = document.getElementById('synergy-floating-disc');
        
        if (portal) portal.style.display = 'none';
        if (disc) disc.style.display = 'none';
        
        // æ¸…ç†æ—§æ—¥å¿—
        const log = document.getElementById('radio-terminal-log');
        if (log) log.innerHTML = "";
        
        showToast("ä¿¡å·å·²æ–­å¼€");
    });
};

// 7. å‘é€æŒ‡ä»¤ (ç”µå°é£é€šè®¯)
window.transmitCommand = async function() {
    const input = document.getElementById('radio-cmd-input');
    const text = input ? input.value.trim() : "";
    const contact = window.currentSynergyTarget; // ğŸš¨ ç”µå°é¢‘é“å¿…é¡»ç”¨è¿™ä¸ªå˜é‡

    if (!text || !contact) {
        showToast("âš ï¸ ä¿¡å·æœªé”å®š");
        return;
    }

    // 1. ç‰©ç†ä¸Šå±
    appendRadioLog('user', text);
    input.value = "";

    // 2. å­˜å…¥ç”µå°ä¸“å±åŠ å¯†æ•°æ®åº“ (synergy_ å‰ç¼€)
    await saveChatMessage("synergy_" + contact.id, { 
        role: "user", 
        text: text, 
        timestamp: Date.now() 
    });

    // 3. å‘é€å®Œè‡ªåŠ¨æ»šåŠ¨
    const log = document.getElementById('radio-terminal-log');
    if (log) log.scrollTo({ top: log.scrollHeight, behavior: 'smooth' });
};

/**
 * ğŸ›°ï¸ SYNERGY MASTER PORTAL - ç»ˆæå¯åŠ¨åè®®
 * ä½œç”¨ï¼šå¤„ç†é‚€çº¦æˆåŠŸåçš„å…¨å±åˆ‡æ¢ã€ä¿¡å·æ ¡å‡†åŠ¨ç”»ã€æ•°æ®åŒæ­¥
 */
window.enterSynergyChat = async function() {
    const contact = window.currentSynergyTarget;
    const portal = document.getElementById('synergy-master-portal');
    const loader = document.getElementById('synergy-loading-screen');
    const radioUI = document.getElementById('synergy-radio-interface');
    const successModal = document.getElementById('modal-synergy-success');

    if (!portal || !contact) return;

    portal.style.display = 'flex';
    if (successModal) successModal.style.display = 'none';
    if (loader) loader.style.display = 'flex';
    if (radioUI) radioUI.style.display = 'none';

    // 1. é¢„å¡«èµ„æ–™
    document.getElementById('radio-avatar').src = contact.avatar;
    document.getElementById('radio-name').textContent = contact.name.toUpperCase();
    document.getElementById('partner-uuid').textContent = contact.id.slice(-12).toUpperCase();

    // 2. â³ æ‰§è¡Œä¿¡å·åŒæ­¥åŠ¨ç”»
    let percent = 0;
    const syncInt = setInterval(async () => {
        percent += 20; // è°ƒå¿«ä¸€ç‚¹ï¼Œåˆ«è®©ä½ ç­‰æ€¥äº†
        if (document.getElementById('sync-percent')) 
            document.getElementById('sync-percent').textContent = percent;
        
        if (percent >= 100) {
            clearInterval(syncInt);
            
            // --- ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå†å²å›é­‚ ---
            const log = document.getElementById('radio-terminal-log');
            if (log) {
                log.innerHTML = ""; // å½»åº•æ¸…ç©ºæ—§æ˜¾ç¤ºçš„æ®‹ä½™
                // å»æå–å¸¦ synergy_ å‰ç¼€çš„ç§å¯†å†å²
                const history = await getChatHistory("synergy_" + contact.id) || [];
                history.forEach(m => {
                    appendRadioLog(m.role === 'user' ? 'user' : 'ai', m.text);
                });
            }

            // --- ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¼€åœºç™½å¤„ç† ---
            // é‚€çº¦æˆåŠŸé‚£å¥è¯åªæ‰“å°åœ¨å±å¹•ä¸Šï¼Œç»å¯¹ä¸å†™è¿› saveChatMessage
            if (window.pendingSynergyMsg) {
                appendRadioLog('ai', window.pendingSynergyMsg);
                window.pendingSynergyMsg = null; // æ‰“å°å®Œå°±é”€æ¯ï¼Œé˜²æ­¢ä¸‹æ¬¡è¿›æ¥é‡å¤å‡ºç°
            }

            loader.style.display = 'none';
            radioUI.style.display = 'flex';
            window.isRadioActive = true;
            console.log(`%c[System] ç”µå°ç»´åº¦å·²åŒæ­¥ï¼š${contact.name}`, "color: #34C759;");
        }
    }, 40);
};

// 2. ã€ç¼©æ”¾ã€‘ç”µå°ç¼©å›æˆé»‘èƒ¶çƒ
window.minimizeToDisc = function() {
    const portal = document.getElementById('synergy-master-portal');
    const disc = document.getElementById('synergy-floating-disc');

    if (!portal || !disc) return;

    // iOS é£æ ¼ç¼©æ”¾åŠ¨æ•ˆ
    portal.style.transition = 'all 0.5s cubic-bezier(0.19, 1, 0.22, 1)';
    portal.style.transform = 'scale(0.5) translateY(100px)';
    portal.style.opacity = '0';
    
    setTimeout(() => {
        portal.style.display = 'none';
        portal.style.transform = ''; // å¤ä½
        portal.style.opacity = '1';
        
        disc.style.display = 'flex'; // å”¤é†’é»‘èƒ¶çƒ
        disc.style.animation = 'iosPop 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards';
        showToast("ç”µå°å·²æŒ‚èµ·è‡³é«˜ç»´ç©ºé—´");
    }, 400);
};

// 3. ã€æ¢å¤ã€‘é»‘èƒ¶çƒå¼¹å›ç”µå°é¡µ
window.restoreFromDisc = function() {
    const portal = document.getElementById('synergy-master-portal');
    const disc = document.getElementById('synergy-floating-disc');

    if (!portal || !disc) return;

    disc.style.display = 'none';
    portal.style.display = 'flex';
    
    // æ‰§è¡Œåå‘æ»‘å…¥åŠ¨ç”»
    portal.animate([
        { transform: 'scale(0.8) translateY(50px)', opacity: 0 },
        { transform: 'scale(1) translateY(0)', opacity: 1 }
    ], { duration: 500, easing: 'cubic-bezier(0.16, 1, 0.3, 1)' });
};

let currentPlaylist = []; // æ­Œæ›²é˜Ÿåˆ—
let currentPlayIndex = -1;
// å…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰å‡†å¤‡åˆ é™¤å“ªä¸€ä¸ª
let pendingDeleteId = null;
let parsedLyrics = []; // è§£æåçš„æ­Œè¯æ•°ç»„ [{time, text}]
let currentPlayMode = 'order'; // order, single, random

/**
 * ğŸ–¼ï¸ ç»ˆæç‰ˆï¼šå…¨åª’ä½“è½¬å‘å¼•æ“
 * é€»è¾‘ï¼šæå– Base64 å›¾ç‰‡æµ -> æ³¨å…¥åª’ä½“åè®® -> å”¤é†’è½¬å‘å±‚
 */
window.forwardCurrentPhoto = async function() {
    console.log("%c[Action] ç‰©ç†è§¦å‘ï¼šå›¾ç‰‡åª’ä½“è½¬å‘åè®®", "color: #007AFF; font-weight: bold;");

    const modal = document.getElementById('modal-photo-detail');
    const pid = modal ? modal.dataset.pid : null;

    if (!pid) {
        if (typeof showToast === 'function') showToast("âš ï¸ å­˜æ¡£å®šä½å¤±è´¥");
        return;
    }

    try {
        // 1. ä»å¤§å®¹é‡ä»“åº“æå–åŒ…å«å›¾ç‰‡æ•°æ®çš„å®Œæ•´æ¡£æ¡ˆ
        const myPhotos = await loadFromDB('user_my_photos') || [];
        const photo = myPhotos.find(p => p.id === pid);

        if (!photo || !photo.src) throw new Error("å›¾ç‰‡æ•°æ®å·²æŸåæˆ–ä¸¢å¤±");

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°è½¬å‘æ•°æ®åè®®ï¼ŒåŠ å…¥å›¾ç‰‡ç±»å‹
        // æˆ‘ä»¬åŒæ—¶ä¼ å›¾ç‰‡å’Œæ–‡å­—ï¼Œè®©èŠå¤©æ¡†èƒ½è¯†åˆ«è¿™æ˜¯ä¸€ä¸ªâ€œå¸¦å›¾è½¬å‘â€
        window.pendingForwardData = [
            { 
                type: 'image', 
                src: photo.src // ç‰©ç†æ³¨å…¥ Base64 å›¾ç‰‡æµ
            },
            { 
                type: 'text', 
                text: `[åˆ†äº«ç¬é—´] â€œ${photo.desc}â€` 
            }
        ];
        
        // è®°å½•é¢„è§ˆå›¾ï¼Œä¾›è½¬å‘ç¡®è®¤å¼¹çª—ä½¿ç”¨
        window.pendingForwardPreview = photo.src;

        // 2. å”¤é†’è½¬å‘å±‚
        const picker = document.getElementById('page-forward-picker');
        if (picker) {
            picker.style.display = 'flex';
            picker.style.zIndex = '500000'; 
            
            void picker.offsetWidth; 
            picker.style.transform = 'translateY(0)';
            picker.classList.add('active');

            if (window.switchForwardTab) {
                window.switchForwardTab('friends');
            }
            
            console.log("âœ… åª’ä½“è½¬å‘åè®®å·²æ¿€æ´»ï¼Œå›¾ç‰‡æµå·²å°±ç»ª");
        }

    } catch (e) {
        console.error("è½¬å‘åè®®ä¸­æ–­:", e);
        if (typeof showToast === 'function') showToast("è½¬å‘å¤±è´¥: " + e.message);
    }
};
// --- 1. æ—¶åŒºä¸æ—¶é’Ÿåº•å±‚é…ç½® ---
const appSettings = {
    // ç‰©ç†é”å®šï¼šä¼˜å…ˆè¯»å–è®¾ç½®é¡µçš„æ—¶åŒºï¼Œæ²¡è®¾ç½®åˆ™é»˜è®¤ä¸ºä¸Šæµ·
    userTimezone: localStorage.getItem('app_timezone') || 'Asia/Shanghai', 
};

/**
 * ğŸ›°ï¸ é«˜ç»´æ—¶ç©ºæ„ŸçŸ¥å†…æ ¸ (100% ç‰©ç†åŒæ­¥ç‰ˆ)
 * é€»è¾‘ï¼šç»å¯¹æœä» Settings é‡Œçš„ 'user_timezone'ï¼Œå®æ—¶ç°æŠ“ï¼Œä¸è®¾é»˜è®¤ã€‚
 */
function getAppLocalTime() {
    const now = new Date();
    
    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥ä»ç‰©ç†å­˜å‚¨ä¸­â€œç°æŠ“â€ä½ è®¾ç½®çš„å€¼
    // é”®åå¿…é¡»ä¸ setTimezone å‡½æ•°é‡Œçš„ 'user_timezone' ç»å¯¹å¯¹é½
    const savedTz = localStorage.getItem('user_timezone');
    
    // é”å®šå½“å‰è¦ç”¨çš„æ—¶åŒºï¼šæœ‰è®¾ç½®ç”¨è®¾ç½®ï¼Œæ²¡è®¾ç½®ç”¨ç³»ç»Ÿæœ¬åœ°
    const zoneToUse = (savedTz && savedTz !== 'undefined') ? savedTz : Intl.DateTimeFormat().resolvedOptions().timeZone;

    const options = { 
        timeZone: zoneToUse, 
        hour12: false, 
        year: 'numeric', month: 'numeric', day: 'numeric', 
        hour: 'numeric', minute: 'numeric', second: 'numeric' 
    };
    
    try {
        const formatter = new Intl.DateTimeFormat('en-US', options);
        const parts = formatter.formatToParts(now);
        const getPart = (type) => parts.find(p => p.type === type).value;
        
        let hour = parseInt(getPart('hour'));
        if (hour === 24) hour = 0; // ç‰©ç†ä¿®æ­£ 24H è¿›åˆ¶æº¢å‡º

        return {
            year: parseInt(getPart('year')),
            month: parseInt(getPart('month')),
            day: parseInt(getPart('day')),
            hour: hour,
            aiString: `${getPart('hour').toString().padStart(2, '0')}:${getPart('minute').toString().padStart(2, '0')}`,
            fullString: formatter.format(now),
            activeZone: zoneToUse // ğŸš¨ ç»Ÿä¸€å˜é‡åï¼Œä¼ å‡ºå½“å‰æ—¶åŒº
        };
    } catch (e) {
        console.error("æ—¶åŒºå¼•æ“åç¼©:", e);
        return { hour: now.getHours(), aiString: "00:00", fullString: "Error", activeZone: "SystemFallback" };
    }
}
/**
 * ğŸ”— è‡ªåŠ¨è‰¾ç‰¹å‡½æ•°è¡¥å…¨ (æ”¯æŒä¼ å‚)
 */
window.mentionTheirsChar = function(name) {
    const input = document.getElementById('theirs-reply-input');
    if (!input) return;
    
    const charName = name || document.getElementById('theirs-char-name').textContent;
    input.value = `@${charName} `;
    input.focus();
    
    if (navigator.vibrate) navigator.vibrate(10);
};
/**
 * 2. å…¨å±å¤§å›¾æ§åˆ¶é€»è¾‘
 */
window.viewFullScreenImg = function(src) {
    const browser = document.getElementById('photo-fullscreen-browser');
    const targetImg = document.getElementById('fullscreen-img-target');
    if (!browser || !targetImg) return;

    targetImg.src = src;
    browser.style.display = 'flex';
    
    // å¼ºåˆ¶é‡ç»˜è§¦å‘åŠ¨ç”»
    void browser.offsetWidth;
    browser.classList.add('active');
    
    // ç‰©ç†ç¼©æ”¾æ•ˆæœ
    targetImg.style.transform = "scale(0.8)";
    setTimeout(() => {
        targetImg.style.transform = "scale(1)";
    }, 10);
};

window.closeFullscreenPhoto = function() {
    const browser = document.getElementById('photo-fullscreen-browser');
    if (browser) {
        browser.classList.remove('active');
        setTimeout(() => {
            browser.style.display = 'none';
        }, 300);
    }
};
// ğŸŒ è¯­éŸ³æ¡å†…éƒ¨ï¼šç‚¹å‡»å±•å¼€ç¿»è¯‘
window.toggleVoiceTrans = function(btn, e) {
    // ğŸš¨ é˜»æ­¢å†’æ³¡ï¼šé˜²æ­¢è§¦å‘æ°”æ³¡çš„æ’­æ”¾æˆ–èœå•äº‹ä»¶
    if (e) e.stopPropagation();

    // æ‰¾åˆ°çˆ¶å®¹å™¨
    const contentBox = btn.closest('.voice-content-box');
    if (contentBox) {
        // æ·»åŠ æ˜¾ç¤ºç¿»è¯‘çš„ç±»å
        contentBox.classList.add('show-trans');
        
        // å¢åŠ ä¸€ç‚¹éœ‡åŠ¨åé¦ˆ (iOS è´¨æ„Ÿ)
        if (navigator.vibrate) navigator.vibrate(10);
    }
};
window.handleVoiceBubbleClick = function(bubbleEl, text, e) {
    if (e) e.stopPropagation();

    // 1. å¤šé€‰æ¨¡å¼æ‹¦æˆª
    const row = bubbleEl.closest('.msg-row');
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected');
        if (typeof refreshMultiSelectCount === 'function') refreshMultiSelectCount();
        return;
    }

    const clickedTextArea = e.target.closest('.voice-content-box');
    if (e.target.closest('.voice-trans-btn')) return;

    // === åˆ†æ”¯ Aï¼šç‚¹å‡»æ–‡å­—åŒºåŸŸ (å¼¹èœå•) ===
    if (clickedTextArea) {
        if (bubbleEl.classList.contains('voice-expanded')) {
            showBubbleMenu(bubbleEl, e);
        }
        return;
    }

    // === åˆ†æ”¯ Bï¼šç‚¹å‡»è¯­éŸ³æ¡ (å±•å¼€/æŠ˜å ) ===
    if (bubbleEl.classList.contains('voice-expanded')) {
        // æ”¶èµ·
        bubbleEl.classList.remove('voice-expanded');
    } else {
        // å±•å¼€
        bubbleEl.classList.add('voice-expanded');
        bubbleEl.classList.add('is-read');

        // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦å¼€å¯äº† TTS ğŸš¨
        const isUser = row.classList.contains('user');
        
        // è¯»å–å½“å‰è§’è‰²çš„é…ç½®
        const contact = window.currentChattingWith;
        const configKey = contact ? 'voice_config_' + contact.id : 'voice_config_global_default';
        const config = JSON.parse(localStorage.getItem(configKey)) || {};
        
        // é»˜è®¤ä¸º true (å¼€å¯)ï¼Œåªæœ‰æ˜ç¡®è®¾ç½®ä¸º false æ‰å…³é—­
        const isTTSEnabled = (config.enableTTS !== false);

        if (!isUser) {
            if (isTTSEnabled) {
                console.log("ğŸ”Š è¯­éŸ³åˆæˆå·²å¼€å¯ï¼Œæ­£åœ¨è¯·æ±‚ MiniMax...");
            } else {
                console.log("ğŸ”• è¯­éŸ³åˆæˆå·²å…³é—­ (çœé’±æ¨¡å¼)ï¼Œä»…å±•å¼€æ–‡å­—ã€‚");
                // è¿™é‡Œä»€ä¹ˆéƒ½ä¸åšï¼Œæ–‡å­—å·²ç»é€šè¿‡ CSS å±•å¼€äº†ï¼Œä¹Ÿä¸ä¼šæ‰£è´¹
            }
        }
    }
};
window.sendSimulatedVoice = async function() {
    const inputEl = document.getElementById('voice-text-in');
    const btnEl = document.querySelector('#modal-voice-input .ios-btn.primary');
    const text = inputEl.value.trim();

    if (!text) return showToast("è¯·è¾“å…¥å†…å®¹");
    if (!window.currentChattingWith) return;

    // 1. UI å˜èº«ï¼šæ˜¾ç¤ºæ­£åœ¨å¤„ç†
    const originalBtnText = btnEl.innerHTML;
    btnEl.innerHTML = `<span style="animation:pulse 1s infinite">AI æ­£åœ¨è½¬ç ...</span>`;
    btnEl.style.pointerEvents = 'none'; 

    // 2. ä¼°ç®—æ—¶é•¿
    let durationSec = Math.ceil(text.length / 2);
    if (durationSec < 2) durationSec = 2;
    if (durationSec > 60) durationSec = 60;

    // 3. ğŸš¨ æ ¸å¿ƒï¼šå¼ºåˆ¶ç¿»è¯‘é€»è¾‘
    let finalText = text;
    
    // å¦‚æœè¾“å…¥çš„ä¸æ˜¯ä¸­æ–‡ï¼ˆç®€å•åˆ¤æ–­ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸­æ–‡æƒ³ç¿»è‹±æ–‡ï¼Œè¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶è°ƒç”¨ç¿»è¯‘
    // ä¸ºäº†ç¨³å¦¥ï¼Œåªè¦æ²¡æ‰‹åŠ¨å†™ [TRANS]ï¼Œæˆ‘ä»¬å°±å°è¯•å»ç¿»è¯‘ä¸€ä¸‹
    if (!text.includes('[TRANS]')) {
        try {
            const trans = await autoTranslateUserText(text);
            // åªæœ‰å½“ç¿»è¯‘ç»“æœæœ‰æ•ˆï¼Œä¸”ä¸ç­‰äºåŸæ–‡æ—¶ï¼Œæ‰æ‹¼æ¥
            if (trans && trans !== text) {
                finalText = `${text} [TRANS] ${trans}`;
            } else {
                // å…œåº•ï¼šå¦‚æœç¿»è¯‘å¤±è´¥ï¼Œä¸ºäº†æµ‹è¯• UIï¼Œæˆ‘ä»¬æ‰‹åŠ¨è¡¥ä¸€ä¸ªæ ‡è®°ï¼ˆå¯é€‰ï¼‰
                // finalText = `${text} [TRANS] (ç¿»è¯‘æ•°æ®ç¼ºå¤±)`; 
            }
        } catch(e) {
            console.error("ç¿»è¯‘æœåŠ¡è¶…æ—¶");
        }
    }

    // 4. æ„é€ æ¶ˆæ¯
    const msgObj = {
        role: "user",
        text: finalText, // å­˜å…¥å¸¦ç¿»è¯‘çš„æ–‡æœ¬
        type: "voice",
        duration: durationSec + "\"",
        timestamp: Date.now(),
        isRead: true, 
        recalled: false
    };

    // 5. å‘é€
    await saveChatMessage(window.currentChattingWith.id, msgObj);
    renderMessages();
    
    // æ¢å¤ UI
    document.getElementById('modal-voice-input').style.display = 'none';
    btnEl.innerHTML = originalBtnText;
    btnEl.style.pointerEvents = 'auto';

    console.log("âœ… è¯­éŸ³å·²ä¸Šå±ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ AI å›å¤...");

};
// 1. æ‰“å¼€è¯­ç§é€‰æ‹©å™¨ (å¤ç”¨ä½ çš„ Noir Picker)
window.openVoiceLangPicker = function() {
    // ğŸŒ å…¨çƒè¯­ç§è±ªååˆ—è¡¨
    const opts = [
        // --- æ ¸å¿ƒå¸¸ç”¨ ---
        { l: "è‡ªåŠ¨ (Auto Detect)", v: "auto" },
        { l: "ä¸­æ–‡ (Mandarin)", v: "cn" },
        { l: "è‹±è¯­ (English)", v: "en" },
        { l: "æ—¥è¯­ (Japanese)", v: "jp" },
        { l: "éŸ©è¯­ (Korean)", v: "kr" },
        { l: "ç²¤è¯­ (Cantonese)", v: "cantonese" }, // ğŸ‘ˆ å¾ˆå¤šäººéœ€è¦çš„

        // --- æ¬§æ´²è¯­ç³» ---
        { l: "æ³•è¯­ (French)", v: "fr" },
        { l: "å¾·è¯­ (German)", v: "de" },
        { l: "è¥¿ç­ç‰™è¯­ (Spanish)", v: "es" },
        { l: "ä¿„è¯­ (Russian)", v: "ru" },
        { l: "æ„å¤§åˆ©è¯­ (Italian)", v: "it" },
        { l: "è‘¡è„ç‰™è¯­ (Portuguese)", v: "pt" },

        // --- äºšæ´²å…¶ä»– ---
        { l: "æ³°è¯­ (Thai)", v: "th" },
        { l: "è¶Šå—è¯­ (Vietnamese)", v: "vi" },
        { l: "å°å°¼è¯­ (Indonesian)", v: "id" },
        
        // --- å…¶ä»– ---
        { l: "åœŸè€³å…¶è¯­ (Turkish)", v: "tr" },
        { l: "é˜¿æ‹‰ä¼¯è¯­ (Arabic)", v: "ar" }
    ];

    window.renderNoirPicker("SELECT NATIVE LANGUAGE", opts, function(v, l) {
        // æ›´æ–° UI æ˜¾ç¤º
        const displayEl = document.getElementById('calib-lang-display');
        if (displayEl) {
            displayEl.textContent = l;
            displayEl.dataset.val = v; // å­˜å…¥ data å±æ€§ï¼Œä¿å­˜æ—¶è¯»å–è¿™ä¸ª
        }
    });
};
// --- ğŸ”§ è¾…åŠ©å·¥å…·ï¼šåå…­è¿›åˆ¶è½¬äºŒè¿›åˆ¶ ---
function hexToBytes(hex) {
    if (!hex) return new Uint8Array(0);
    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„ 0x å‰ç¼€
    if (hex.startsWith('0x')) hex = hex.slice(2);
    
    let bytes = [];
    for (let c = 0; c < hex.length; c += 2) {
        bytes.push(parseInt(hex.substr(c, 2), 16));
    }
    return new Uint8Array(bytes);
}
// ğŸ’¾ ä¿å­˜é…ç½®ï¼šæŠŠ TTS å¼€å…³çš„çŠ¶æ€å­˜è¿›å»
window.saveVoiceCalibrate = function() {
    console.log("System: æ­£åœ¨ä¿å­˜è¯­éŸ³é…ç½®...");

    var idIn = document.getElementById('calib-voice-id-in');
    var dualTog = document.getElementById('calib-dual-toggle');
    var langDisp = document.getElementById('calib-lang-display');
    
    // ğŸš¨ æ–°å¢ï¼šè·å– TTS æ€»å¼€å…³
    var ttsTog = document.getElementById('calib-tts-toggle');

    if (!idIn) { alert("âŒ é¡µé¢å…ƒç´ åŠ è½½å¼‚å¸¸"); return; }

    var config = {
        voiceId: idIn.value.trim(),
        isDual: dualTog ? dualTog.checked : true,
        // ğŸš¨ ä¿å­˜ TTS çŠ¶æ€ (å¦‚æœå¼€å…³ä¸å­˜åœ¨ï¼Œé»˜è®¤å¼€å¯)
        enableTTS: ttsTog ? ttsTog.checked : true, 
        lang: (langDisp && langDisp.dataset.val) ? langDisp.dataset.val : "auto"
    };

    var contact = window.currentChattingWith;
    var saveKey = contact ? 'voice_config_' + contact.id : 'voice_config_global_default';

    localStorage.setItem(saveKey, JSON.stringify(config));

    if (window.triggerSuccessHud) window.triggerSuccessHud("è®¾ç½®å·²ä¿å­˜");
    else alert("âœ… è®¾ç½®å·²ä¿å­˜");

    closeSubPage('subpage-voice-calibrate');
};
// ğŸ”„ åŠ è½½é…ç½®ï¼šå›æ˜¾å¼€å…³çŠ¶æ€
window.loadVoiceCalibrateUI = function() {
    console.log("System: æ­£åœ¨è½½å…¥æ ¡å‡†é¢æ¿...");

    var contact = window.currentChattingWith;
    var nameEl = document.getElementById('calib-target-name');
    
    var loadKey = contact ? 'voice_config_' + contact.id : 'voice_config_global_default';
    if(nameEl) nameEl.textContent = contact ? contact.name : "å…¨å±€é»˜è®¤";

    var savedLocal = localStorage.getItem(loadKey);
    var config = savedLocal ? JSON.parse(savedLocal) : {
        voiceId: "",
        isDual: true,
        enableTTS: true, // é»˜è®¤å¼€å¯
        lang: "auto"
    };

    // 1. å›å¡« Voice ID
    var idIn = document.getElementById('calib-voice-id-in');
    if (idIn) idIn.value = config.voiceId || "";

    // 2. å›å¡«åŒè¯­å¼€å…³
    var dualTog = document.getElementById('calib-dual-toggle');
    if (dualTog) dualTog.checked = (config.isDual !== false);

    // 3. ğŸš¨ å›å¡« TTS æ€»å¼€å…³
    var ttsTog = document.getElementById('calib-tts-toggle');
    if (ttsTog) ttsTog.checked = (config.enableTTS !== false); // é»˜è®¤ true

    // 4. å›å¡«è¯­è¨€
    var langDisp = document.getElementById('calib-lang-display');
    if (langDisp) {
        const langMap = { 
            "auto": "è‡ªåŠ¨ (Auto Detect)", 
            "cn": "ä¸­æ–‡ (Mandarin)", 
            "en": "è‹±è¯­ (English)", 
            "jp": "æ—¥è¯­ (Japanese)", 
            "kr": "éŸ©è¯­ (Korean)", 
            "cantonese": "ç²¤è¯­ (Cantonese)",
            "fr": "æ³•è¯­ (French)", 
            "de": "å¾·è¯­ (German)",
            "es": "è¥¿ç­ç‰™è¯­ (Spanish)",
            "ru": "ä¿„è¯­ (Russian)",
            "it": "æ„å¤§åˆ©è¯­ (Italian)",
            "pt": "è‘¡è„ç‰™è¯­ (Portuguese)",
            "th": "æ³°è¯­ (Thai)",
            "vi": "è¶Šå—è¯­ (Vietnamese)",
            "id": "å°å°¼è¯­ (Indonesian)",
            "tr": "åœŸè€³å…¶è¯­ (Turkish)",
            "ar": "é˜¿æ‹‰ä¼¯è¯­ (Arabic)"
        };
        // å¦‚æœæ‰¾ä¸åˆ° keyï¼Œé»˜è®¤æ˜¾ç¤º Auto
        langDisp.textContent = langMap[config.lang] || "è‡ªåŠ¨ (Auto Detect)";
        langDisp.dataset.val = config.lang || "auto";
    }
};
/**
 * ğŸµ å¤„ç†è¯­éŸ³æ°”æ³¡ç‚¹å‡»ï¼šåŒæ­¥åŠ¨ç”»ä¸éŸ³é¢‘
 */
window.playVoiceMessage = async function(text, bubbleEl) {
    if (window.isSpeaking) return;

    // 1. è¿›å…¥æ’­æ”¾çŠ¶æ€ (æ ‡è®°åŠ¨ç”»)
    bubbleEl.classList.add('playing');
    bubbleEl.classList.add('is-read'); // æ ‡è®°ä¸ºå·²è¯»

    // 2. è°ƒç”¨ MiniMax å‘å£°å¼•æ“
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä½ ä¹‹å‰çš„ speakTextï¼Œè®©å®ƒæ¥å—ä¸€ä¸ªå›è°ƒæ¥æ¸…é™¤ç±»å
    try {
        await window.speakText(text, bubbleEl); 
    } catch (e) {
        bubbleEl.classList.remove('playing');
    }
};

/**
 * ğŸ›  ç»ˆæç‰©ç†è‡ªæ„ˆç‰ˆï¼šiOS é£æ ¼é€‰æ‹©å™¨
 * é€»è¾‘ï¼šè‡ªåŠ¨æ£€æµ‹ DOM -> åŠ¨æ€æ³¨å…¥ HTML/CSS -> å®æ—¶æ¸²æŸ“åˆ—è¡¨
 */
window.renderNoirPicker = function(title, options, callback) {
    // 1. ã€ç‰©ç†è‡ªæ£€ã€‘æ£€æŸ¥é¡µé¢ä¸Šæ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªå¼¹çª—ï¼Œæ²¡æœ‰å°±ç°åœºé€ ä¸€ä¸ª
    let mask = document.getElementById('custom-voice-picker');
    
    if (!mask) {
        console.log("System: æ­£åœ¨ç‰©ç†ç”Ÿæˆé€‰æ‹©å™¨ç»„ä»¶...");
        const pickerTemplate = `
            <div id="custom-voice-picker" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index: 1000001;" onclick="this.style.display='none'">
                <div class="noir-picker-box" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 24px 24px 0 0; padding-bottom: 40px; animation: nSheetUp 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);">
                    <div class="n-picker-header" id="picker-title" style="padding: 16px; text-align: center; font-size: 11px; font-weight: 900; color: #8e8e93; letter-spacing: 2px; border-bottom: 0.5px solid rgba(0,0,0,0.05); text-transform: uppercase;">SELECT OPTION</div>
                    <div id="picker-options-list" class="n-picker-scroll" style="max-height: 45vh; overflow-y: auto;">
                        </div>
                    <div class="n-picker-cancel" onclick="document.getElementById('custom-voice-picker').style.display='none'" style="background: #fff; padding: 16px; border-radius: 14px; text-align: center; color: #FF3B30; font-weight: 700; font-size: 18px; margin: 8px 16px 25px; border: 1px solid #f2f2f7;">CANCEL</div>
                </div>
            </div>`;
        
        // å°†æ¨¡æ¿æ’å…¥ body åº•éƒ¨
        document.body.insertAdjacentHTML('beforeend', pickerTemplate);
        mask = document.getElementById('custom-voice-picker');
    }

    // 2. ã€æ•°æ®å¡«å……ã€‘
    const list = document.getElementById('picker-options-list');
    const titleEl = document.getElementById('picker-title');
    
    if (titleEl) titleEl.textContent = title;
    
    // ç”Ÿæˆé€‰é¡¹
    list.innerHTML = options.map(opt => `
        <div class="n-opt-item" onclick="window.confirmNoirPick('${opt.v}', '${opt.l}')" 
             style="padding: 18px; text-align: center; color: #007AFF; font-size: 18px; font-weight: 500; border-bottom: 0.5px solid rgba(0,0,0,0.05); cursor: pointer;">
            ${opt.l}
        </div>
    `).join('');
    
    // 3. ã€çŠ¶æ€æ¿€æ´»ã€‘
    window.noirPickerCallback = callback;
    mask.style.display = 'flex';
};

/**
 * ç¡®è®¤é€‰æ‹©å™¨å›è°ƒ
 */
window.confirmNoirPick = function(v, l) {
    if (window.noirPickerCallback) window.noirPickerCallback(v, l);
    const mask = document.getElementById('custom-voice-picker');
    if (mask) mask.style.display = 'none';
};

/**
 * ç¡®è®¤é€‰æ‹©å¹¶å…³é—­
 */
window.confirmNoirPick = function(v, l) {
    if (window.noirPickerCallback) window.noirPickerCallback(v, l);
    document.getElementById('custom-voice-picker').style.display = 'none';
};

// 1. å­˜å‚¨ä»æœåŠ¡å™¨â€œè·å–â€åˆ°çš„æ¨¡å‹
// åœ¨è„šæœ¬å¼€å¤´ä¿®æ”¹è¿™éƒ¨åˆ†
window.availableModels = [
    { name: "Speech Turbo (æé€ŸèŠå¤©)", id: "speech-01-turbo" },
    { name: "Speech 2.6 Turbo (æ¨è)", id: "speech-2.6-turbo" }
]; // ğŸ‘ˆ é¢„è®¾é»˜è®¤å€¼ï¼Œç¡®ä¿ä¸ç‚¹ Fetch ä¹Ÿèƒ½ç‚¹å¼€åˆ—è¡¨



/**
 * ğŸ“¡ è”ç½‘è·å–æ¨¡å‹åè®® (ç‰©ç†è‡ªæ„ˆç‰ˆ)
 * ç»•è¿‡å¤±æ•ˆçš„ query_voice_list æ¥å£ï¼Œç›´æ¥æ³¨å…¥ V2 æ ¸å¿ƒæ¨¡å‹ ID
 */
window.fetchAllMiniMaxModels = async function() {
    // 1. è·å–è¾“å…¥æ¡†çš„å€¼
    const key = document.getElementById('voice-key-in').value.trim();
    const groupId = document.getElementById('voice-group-in').value.trim(); // ğŸš¨ å¿…é¡»è·å– Group ID
    const btnText = document.getElementById('fetch-model-btn-text');
    
    if (!key || !groupId) {
        alert("ğŸ”‘ è¯·å…ˆå¡«å†™ API Key å’Œ Group ID");
        return;
    }

    btnText.textContent = "ESTABLISHING QUANTUM LINK...";
    btnText.style.color = "#007AFF";

    try {
        // ---------------------------------------------------------
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½åˆ¤æ–­ç¯å¢ƒ (æœ¬åœ° vs çº¿ä¸Š)
        // ---------------------------------------------------------
        let targetUrl = "";
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        if (isLocal) {
            // ğŸ’» æœ¬åœ°ç¯å¢ƒï¼šèµ° cors-anywhere
            // æ³¨æ„ï¼šä¿®å¤äº†åŸŸåçš„æ‹¼å†™é”™è¯¯ (minimaxi -> minimax)
            targetUrl = `https://cors-anywhere.herokuapp.com/https://api.minimax.chat/v1/t2a_v2?GroupId=${groupId}`;
        } else {
            // â˜ï¸ çº¿ä¸Šç¯å¢ƒ (Vercel)ï¼šèµ°å†…ç½‘è½¬å‘
            targetUrl = `/minimax_proxy/t2a_v2?GroupId=${groupId}`;
        }

        // å‘é€æ ¡éªŒè¯·æ±‚
        const response = await fetch(targetUrl, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${key}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ 
                "model": "speech-01-turbo",
                "text": " ", // ç©ºæ ¼æµ‹è¯•
                "voice_setting": { "voice_id": "male-qn-qingse" }
            })
        });

        // ğŸš¨ æœ¬åœ°ä»£ç†æ¿€æ´»æ£€æŸ¥
        if (response.status === 403 && isLocal) {
            alert("ğŸš¨ æœ¬åœ°è°ƒè¯•éœ€æ¿€æ´»ä»£ç†ï¼ç‚¹å‡»ç¡®å®šå»æ¿€æ´»ã€‚");
            window.open("https://cors-anywhere.herokuapp.com/corsdemo", "_blank");
            throw new Error("Proxy Activation Required");
        }

        // ğŸ›¡ï¸ 401 è¯´æ˜ Key æˆ– Group ID é”™
        if (response.status === 401) {
            throw new Error("API Key æˆ– Group ID é”™è¯¯ï¼ŒéªŒè¯å¤±è´¥");
        }
        
        // ğŸ›¡ï¸ 404 è¯´æ˜ Vercel è·¯ç”±æ²¡é…ç½®å¥½
        if (response.status === 404) {
            throw new Error("è·¯ç”±é”™è¯¯ (404)ï¼Œè¯·æ£€æŸ¥ vercel.json");
        }

        // âœ… éªŒè¯é€šè¿‡ï¼Œæ³¨å…¥æ¨¡å‹åˆ—è¡¨
        window.availableModels = [
            { name: "Speech Turbo (æè‡´æµç•…)", id: "speech-01-turbo" },
            { name: "Speech HD (ç»†è…»æƒ…æ„Ÿ)", id: "speech-01-hd" }, // æ¨èè¿™ä¸ª
            { name: "Speech 2.6 Turbo (å¤šè¯­è¨€)", id: "speech-2.6-turbo" },
            { name: "Speech 2.6 HD (ç”µå½±è´¨æ„Ÿ)", id: "speech-2.6-hd" }
        ];
        
        btnText.textContent = "âœ… PROTOCOL SECURED";
        btnText.style.color = "#34C759";
        
        // é»˜è®¤é€‰ä¸­ HD ç‰ˆï¼Œé…åˆä½ çš„ç”µè¯éŸ³æ•ˆ
        window.currentVoiceModel = "speech-01-hd"; 
        const display = document.getElementById('voice-model-display');
        if (display) display.textContent = window.currentVoiceModel;
        
        // è‡ªåŠ¨ä¿å­˜ä¸€ä¸‹é…ç½®
        if (window.saveVoiceSettings) window.saveVoiceSettings();
        
        // showToast("é“¾è·¯å·²å»ºç«‹");

    } catch (e) {
        console.error("Link Error:", e);
        
        // ğŸš‘ å…œåº•ï¼šå¦‚æœåªæ˜¯ç½‘ç»œä¸é€šä½†ç”¨æˆ·æƒ³ç¡¬æ¥ï¼Œä¹Ÿç»™åˆ—è¡¨
        window.availableModels = [
            { name: "Speech Turbo (Standard)", id: "speech-01-turbo" },
            { name: "Speech HD (High Def)", id: "speech-01-hd" }
        ];
        
        if (e.message !== "Proxy Activation Required") {
            btnText.textContent = "âš ï¸ CONNECTION FAILED";
            btnText.style.color = "#FF3B30";
            alert("è¿æ¥å¤±è´¥: " + e.message + "\n(å·²åŠ è½½æœ¬åœ°ç¦»çº¿åˆ—è¡¨)");
        }
    }
};

window.openVoiceModelPicker = function() {
    // å¦‚æœè¿˜æ²¡ç‚¹å‡»è·å–æŒ‰é’®ï¼Œwindow.availableModels ä¼šæ˜¯ç©ºçš„
    if (!window.availableModels || window.availableModels.length === 0) {
        alert("è¯·å…ˆç‚¹å‡»ä¸‹æ–¹çš„ FETCH MODELS æŒ‰é’®è·å–åè®®");
        return;
    }

    const opts = window.availableModels.map(m => ({ l: m.name, v: m.id }));
    
    // è°ƒç”¨ä¸Šé¢è¡¥å…¨çš„å¼¹çª—å‡½æ•°
    window.renderNoirPicker("SELECT SPEECH MODEL", opts, (v, l) => {
        window.currentVoiceModel = v; 
        document.getElementById('voice-model-display').textContent = v;
    });
};
// ==========================================
// ğŸ™ï¸ MiniMax V2 è¯­éŸ³å¼•æ“ï¼šæ¨¡å‹é©±åŠ¨ç‰ˆ (ç‰©ç†ä¿®å¤)
// ==========================================

// 1. å®šä¹‰å®˜æ–¹æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
window.MINIMAX_MODELS = [
    { name: "Turbo (æé€ŸèŠå¤©)", id: "speech-01-turbo" },
    { name: "HD (é«˜ç”»è´¨æƒ…æ„Ÿ)", id: "speech-01-hd" },
    { name: "V2.6 Turbo (æœ€æ–°å¹³è¡¡)", id: "speech-2.6-turbo" },
    { name: "V2.6 HD (ç”µå½±è´¨æ„Ÿ)", id: "speech-2.6-hd" }
];

/**
 * ğŸ›  ä¿®å¤ 1: ç‰©ç†è¡¥å…¨ updateVDisplay å‡½æ•°
 * ä½œç”¨ï¼šè®©æ»‘åŠ¨æ¡æ•°å€¼å®æ—¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
 */
window.updateVDisplay = function(type, val) {
    const el = document.getElementById(`v-${type}-val`);
    if (el) {
        el.textContent = type === 'speed' ? parseFloat(val).toFixed(1) + 'x' : val;
    }
};

// é…åˆ Picker çš„ç¡®è®¤å‡½æ•°
window.confirmNoirPick = function(v, l) {
    if (window.noirPickerCallback) window.noirPickerCallback(v, l);
    document.getElementById('custom-voice-picker').style.display = 'none';
};

// ==========================================
// ğŸ’¾ è¯­éŸ³è®¾ç½®ä¿å­˜å¼•æ“ (åŒé‡å¤‡ä»½ç‰ˆ)
// ==========================================

// 1. ä¿å­˜é…ç½® (ç»‘å®šåˆ° DONE æŒ‰é’®)
window.saveVoiceSettings = function() {
    console.log("System: æ­£åœ¨ä¿å­˜ MiniMax é…ç½®...");

    // è·å– HTML è¾“å…¥æ¡†çš„å€¼
    const keyVal = document.getElementById('voice-key-in').value.trim();
    const groupVal = document.getElementById('voice-group-in').value.trim();

    // åŸºç¡€æ ¡éªŒ
    if (!keyVal || !groupVal) {
        alert("âš ï¸ è¯·å¡«å†™å®Œæ•´çš„ API Key å’Œ Group ID");
        return;
    }

    // --- ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šåŒé‡å­˜å‚¨ç­–ç•¥ ---
    
    // æ–¹å¼ A: å­˜å…¥ JSON é…ç½®æ–‡ä»¶ (æ¨è)
    const config = {
        key: keyVal,
        groupId: groupVal,
        model: window.currentVoiceModel || "speech-01-turbo"
    };
    localStorage.setItem('ios_voice_config', JSON.stringify(config));
    
    // æ–¹å¼ B: å­˜å…¥ç‹¬ç«‹ Key (é˜²å‘†å¤‡ä»½ï¼Œç¡®ä¿ speakText ç»å¯¹èƒ½è¯»åˆ°)
    localStorage.setItem('minimax_key', keyVal);
    localStorage.setItem('minimax_group_id', groupVal);

    console.log("âœ… é…ç½®å·²å†™å…¥:", config);

    if (window.triggerSuccessHud) {
        window.triggerSuccessHud("è¯­éŸ³å¼•æ“å·²æ¿€æ´»");
    } else {
        alert("âœ… è®¾ç½®å·²ä¿å­˜");
    }

    closeSubPage('subpage-voice-settings');
};

// 2. åŠ è½½é…ç½® (ç»‘å®šåˆ°æ‰“å¼€é¡µé¢æ—¶)
// ç¡®ä¿ä½ ä¸‹æ¬¡æ‰“å¼€è®¾ç½®é¡µï¼Œé‡Œé¢çš„å­—è¿˜åœ¨
window.loadVoiceSettingsUI = function() {
    const saved = localStorage.getItem('ios_voice_config');
    const config = saved ? JSON.parse(saved) : {};
    
    // ä¼˜å…ˆè¯»å– JSONï¼Œæ²¡æœ‰å°±è¯»ç‹¬ç«‹ Key
    const finalKey = config.key || localStorage.getItem('minimax_key') || "";
    const finalGroup = config.groupId || localStorage.getItem('minimax_group_id') || "";
    
    // å›å¡«åˆ° HTML
    const keyInput = document.getElementById('voice-key-in');
    const groupInput = document.getElementById('voice-group-in');
    
    if (keyInput) keyInput.value = finalKey;
    if (groupInput) groupInput.value = finalGroup;
    
    // å›å¡«æ¨¡å‹æ˜¾ç¤º
    const modelDisp = document.getElementById('voice-model-display');
    if (modelDisp && config.model) modelDisp.textContent = config.model;
};

// --- ğŸ˜Š Emoji å¼¹çª— Function é€»è¾‘ ---

window.handleEmojiButtonClick = function(e) {
    if (e) e.stopPropagation();
    
    // 1. å°è¯•æ¸²æŸ“ï¼ˆå³ä½¿æ•°æ®åº“ç©ºäº†ä¹Ÿä¸å½±å“æ‰“å¼€ï¼‰
    if (typeof window.renderEmojiGrid === 'function') window.renderEmojiGrid();
    
    // 2. ç‰©ç†æ˜¾ç¤º
    const mask = document.getElementById('emoji-modal-mask');
    if (mask) {
        mask.style.display = 'flex';
        // ç¨å¾®å»¶è¿Ÿè®© CSS æ•è·åˆ° display å˜åŒ–ä»è€Œè§¦å‘ transition åŠ¨ç”»
        setTimeout(() => mask.classList.add('active'), 20);
    }
};

window.closeEmojiModal = function(e) {
    // å…è®¸é€šè¿‡ç‚¹å‡»èƒŒæ™¯æˆ–å–æ¶ˆæŒ‰é’®å…³é—­
    if (e && e.target.id !== 'emoji-modal-mask' && !e.target.closest('.emoji-cancel')) return;

    const mask = document.getElementById('emoji-modal-mask');
    if (mask) {
        mask.classList.remove('active');
        setTimeout(() => {
            mask.style.display = 'none';
        }, 400); // ç­‰å¾…æ»‘ä¸‹åŠ¨ç”»ç»“æŸ
    }
};

/**
 * ğŸ›°ï¸ è¡¨æƒ…åº“æ¸²æŸ“å¼•æ“ (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šä» Unlimited åº“ä¸­è°ƒå–è¡¨æƒ…æ•°æ®å¹¶ç”Ÿæˆç½‘æ ¼ç•Œé¢
 */
window.renderEmojiGrid = async function() {
    const list = document.getElementById('emoji-grid-list');
    if (!list) return;

    try {
        // --- ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥ä»æ–°åº“è·å–è¡¨æƒ…æ•°ç»„ ---
        // å‡è®¾ä½ åœ¨æ–°åº“é‡Œå­˜è¡¨æƒ…åŒ…çš„ Key å°±å« 'emoji_library'
        const emojis = await window.ib.getItem('emoji_library') || [];

        // 1. ç©ºçŠ¶æ€æ‹¦æˆª
        if (!emojis || emojis.length === 0) {
            list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#bbb; padding:40px 0; font-size:13px; font-family:serif; font-style:italic;">NO TRACES FOUND...</div>';
            return;
        }

        // 2. æ¸²æŸ“å¾ªç¯ (ä¿æŒåŸæœ‰æ ·å¼ä¸ç‚¹å‡»é€»è¾‘)
        list.innerHTML = emojis.map(item => `
            <div class="emoji-grid-item" onclick="sendEmojiMessage('${item.tag}'); window.closeEmojiModal();">
                <img src="${item.data}" style="width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px; border:1px solid #000;">
                <div style="font-size:10px; color:#000; font-weight:800; margin-top:5px;">${item.tag.toUpperCase()}</div>
            </div>
        `).join('');

    } catch (err) {
        console.error("è¡¨æƒ…åº“åŠ è½½å¤±è´¥:", err);
        list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#FF3B30; padding:20px; font-weight:800;">[ LOAD ERROR ]</div>';
    }
};

var travelMap = null;
window.openTravelJournal = async function() {
    console.log("System: æ­£åœ¨æ‰§è¡Œè¡Œæ—…ç©ºé—´é‡æ„...");
    
    const savedRoute = await loadFromDB('current_travel_route');
    
    if (savedRoute && savedRoute.length > 0) {
        // å¦‚æœæœ‰å†å²è®°å½•ï¼Œç›´æ¥å±•ç¤º
        document.getElementById('travel-planner').style.display = 'none';
        document.getElementById('travel-canvas-area').style.display = 'block';
        window.currentTravelData = savedRoute;
        
        // ğŸš¨ æ ¸å¿ƒï¼šä»ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªç«™ç‚¹æå– code
        const fromNode = savedRoute[0];
        const toNode = savedRoute[savedRoute.length - 1];
        
        // è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œä¼ å…¥çœŸå®çš„ Codeï¼Œä¸å†æ˜¾ç¤º ???
        renderBoardingPass(
            fromNode.name, 
            toNode.name, 
            fromNode.code || "PEK", // å¢åŠ æ‰‹åŠ¨é»˜è®¤å€¼é˜²æ­¢ ???
            toNode.code || "BKK"
        );
        
        renderTravelMap(savedRoute);
    } else {
        // æ— è®°å½•åˆ™æ˜¾ç¤ºç­–åˆ’é¡µ
        document.getElementById('travel-planner').style.display = 'block';
        document.getElementById('travel-canvas-area').style.display = 'none';
    }

    openSubPage('subpage-travel-journal');
};
/**
 * ğŸ›ï¸ å®¿å‘½é¡µé¢å…³é—­åè®®
 */
window.closeDestinyPage = function() {
    console.log("System: æ­£åœ¨é—­åˆå› æœé“¾è·¯...");
    
    const overlay = document.getElementById('destiny-overlay');
    if (overlay) {
        // 1. åŠ¨ç”»æ·¡å‡º
        overlay.style.transition = "opacity 0.4s ease, transform 0.4s ease";
        overlay.style.opacity = "0";
        overlay.style.transform = "translateX(100%)"; // é¡ºæ»‘æ»‘å‡º
        
        // 2. å½»åº•éšè—
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.classList.remove('active');
        }, 400);
        
        console.log("âœ… é¡µé¢å·²é€»è¾‘éš”ç¦»");
    }
};

// ğŸš¨ è¿™ä¸€æ­¥æ˜¯åŒé‡ä¿é™©ï¼šå§”æ‰˜ç›‘å¬
// å“ªæ€• onclick å¤±æ•ˆï¼Œåªè¦ç‚¹åˆ°è¿™ä¸ªç±»åçš„å…ƒç´ ï¼Œä¹Ÿä¼šè§¦å‘å…³é—­
document.addEventListener('click', function(e) {
    if (e.target.closest('.ins-exit-btn')) {
        window.closeDestinyPage();
    }
});

// é¡ºæ‰‹æ£€æŸ¥ä¸€ä¸‹ HTML æŒ‰é’®ä¸Šçš„è°ƒç”¨æ˜¯å¦å†™å¯¹äº†ï¼š
// ç¡®ä¿æ˜¯ onclick="window.closeDestinyPage()" è€Œä¸æ˜¯ closeDestinyPage()
window.updateDestinySlider = function(el) {
    // 1. æ›´æ–°æ—è¾¹çš„æ•°å­—æ˜¾ç¤º
    const valDisplay = document.getElementById('destiny-word-val');
    if (valDisplay) valDisplay.innerText = el.value;

    // 2. ğŸš¨ æ ¸å¿ƒï¼šç‰©ç†è®¡ç®—ç™¾åˆ†æ¯”å¹¶ä¼ ç»™ CSS
    const min = el.min || 500;
    const max = el.max || 5000;
    const percent = ((el.value - min) / (max - min)) * 100;
    el.style.setProperty('--percent', percent + '%');
};

// ğŸš¨ é¢å¤–ï¼šç¡®ä¿å¼¹çª—æ‰“å¼€æ—¶ï¼Œè¿›åº¦æ¡é¢œè‰²å°±æ˜¯å¯¹çš„
const originalOpenDestinySettings = window.openDestinySettings;
window.openDestinySettings = function() {
    if (typeof originalOpenDestinySettings === 'function') originalOpenDestinySettings();
    
    // æ‰“å¼€åç«‹å³è§¦å‘ä¸€æ¬¡åˆ·æ–°
    const slider = document.getElementById('destiny-wordcount-in');
    if (slider) window.updateDestinySlider(slider);
};
window.deleteFateNode = function(id) {
    const el = document.getElementById(id);
    if(el) {
        // 1. åœ¨åŸä½æ’å…¥ä¸€ä¸ªæå…¶ç²¾ç¾çš„ç»­å†™é”šç‚¹
        const resumeBtn = `
            <div class="resume-node" style="text-align:center; margin:20px 0; animation: fadeIn 0.5s;">
                <div onclick="this.parentElement.remove(); window.sendDestinyCommand();" 
                     style="display:inline-block; border:1px dashed rgba(175, 82, 222, 0.4); color:#AF52DE; font-size:10px; padding:10px 25px; border-radius:30px; cursor:pointer; letter-spacing:2px; font-weight:800;">
                    âœ¦ RE-START FROM HERE / é‡æ–°è¡”æ¥å› æœ
                </div>
            </div>
        `;
        el.insertAdjacentHTML('afterend', resumeBtn);
        
        // 2. ç‰©ç†ç§»é™¤
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 300);
    }
};
// æ‰¾åˆ° rewriteFateNode å‡½æ•°ï¼Œä¿®æ”¹æˆè¿™æ ·
window.rewriteFateNode = function(id) {
    const el = document.getElementById(id);
    if(el) {
        // 1. è·å–å½“å‰å¡ç‰‡çš„æŒ‡ä»¤ä½œä¸ºå½±å­
        const shadowInput = "ï¼ˆé‡å¡‘è¿™æ®µå› æœï¼‰";
        
        // 2. ç‰©ç†æ›¿æ¢ä¸ºåŠ¨ç”»
        el.style.transition = "all 0.5s";
        el.style.transform = "scale(0.95)";
        el.style.opacity = "0";
        
        setTimeout(() => {
            el.remove();
            // 3. é‡æ–°è°ƒç”¨ï¼Œå®ƒä¼šè‡ªåŠ¨èµ° sendDestinyCommand é‡Œçš„åŠ è½½åŠ¨ç”»æµç¨‹
            window.sendDestinyCommand(); 
        }, 400);
    }
};
    /**
 * ğŸ è¾…åŠ©ï¼šåˆ¤å®šç»ˆå±€é€»è¾‘
 */
window.checkEndingStatus = function(fate) {
    const val = parseInt(fate);
    if (val < 90) {
        showToast(`å› æœå°šæœªæ”¶æ•› (å½“å‰: ${val}%)ï¼Œè¯·ç»§ç»­ä»‹å…¥ã€‚`);
    } else {
        showIOSConfirm("ç»ˆå±€é™ä¸´", "è§‚æµ‹åˆ°å› æœçº¿å³å°†é—­åˆï¼Œæ˜¯å¦å¼•å¯¼æ•…äº‹èµ°å‘æœ€ç»ˆç« ï¼Ÿ", "é™ä¸´", () => {
            document.getElementById('destiny-input-field').value = "ï¼ˆå¼•å¯¼æ•…äº‹èµ°å‘å¤§ç»“å±€ï¼‰";
            window.sendDestinyCommand();
        });
    }
};

/**
 * ç‰©ç†æŒ‚è½½åˆ°å…¨å±€ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹å¯ç”¨
 */
window.openDestinySettings = openDestinySettings;
window.closeDestinySettings = closeDestinySettings;
window.saveDestinyProtocol = saveDestinyProtocol;
window.sendDestinyCommand = sendDestinyCommand;

    window.refreshDestinyProse = async function() {
    const contact = window.currentChattingWith;
    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].cachedDestinyProse = null; // æŠ¹é™¤ç¼“å­˜
        await saveToDB('char_list', charList);
        generateDestinyProse(charList[idx]); // é‡æ–°ç”Ÿæˆ
        showToast("æ­£åœ¨é‡å¡‘å› æœå™äº‹...");
    }
};
    // --- ğŸ›ï¸ ç‰©ç†ä¿®å¤ï¼šè§¦å‘å¤´åƒä¸Šä¼  ---
window.triggerAvatarUpload = function() {
    console.log("System: æ­£åœ¨å”¤èµ·æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ...");
    const input = document.getElementById('avatar-input');
    if (input) {
        input.click();
    } else {
        console.error("Error: æ‰¾ä¸åˆ° ID ä¸º avatar-input çš„ä¸Šä¼ ç»„ä»¶");
    }
};

// --- ğŸ›ï¸ ç‰©ç†ä¿®å¤ï¼šå¤„ç†é€‰å®šçš„å¤´åƒæ–‡ä»¶å¹¶æŒä¹…åŒ– ---
window.updateAvatar = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        // å®¹é”™ï¼šç¡®ä¿ showToast å­˜åœ¨å†è°ƒç”¨
        if (typeof showToast === 'function') {
            showToast("æ­£åœ¨åŒæ­¥ç‰©ç†ç‰¹å¾..."); 
        }

        reader.onload = async function(e) {
            const imageData = e.target.result;
            
            // ğŸ”´ ä¿®å¤ç‚¹ 1ï¼šå®‰å…¨æ›´æ–°é¢„è§ˆå›¾ (é˜²æ­¢ sync-avatar ä¸å­˜åœ¨å¯¼è‡´å´©æºƒ)
            const previewImg = document.getElementById('sync-avatar');
            if (previewImg) {
                previewImg.src = imageData;
            } else {
                console.warn("âš ï¸ é¡µé¢ä¸Šæ‰¾ä¸åˆ° id='sync-avatar' çš„å…ƒç´ ï¼Œè·³è¿‡é¢„è§ˆæ›´æ–°");
            }

            // ğŸ”´ ä¿®å¤ç‚¹ 2ï¼šå®‰å…¨æ›´æ–°èƒŒæ™¯æ¨¡ç³Šå±‚
            const blurLayer = document.querySelector('.header-card-blur');
            if (blurLayer) {
                blurLayer.style.backgroundImage = `url(${imageData})`;
            }

            // 2. ğŸš¨ æ ¸å¿ƒåŒæ­¥ï¼šä¿å­˜åˆ°è§’è‰²ä¹¦æ•°æ®åº“
            // (è¿™éƒ¨åˆ†é€»è¾‘åªè¦ä¸æ¶‰åŠ UI æ“ä½œï¼Œé€šå¸¸ä¸ä¼šæŠ¥é”™)
            const contact = window.currentChattingWith;
            if (contact && contact.id) {
                // ç¡®ä¿ loadFromDB å’Œ saveToDB å‡½æ•°å­˜åœ¨
                if (typeof loadFromDB === 'function' && typeof saveToDB === 'function') {
                    let charList = await loadFromDB('char_list') || [];
                    const idx = charList.findIndex(c => c.id === contact.id);
                    
                    if (idx !== -1) {
                        charList[idx].avatar = imageData;
                        await saveToDB('char_list', charList);
                        
                        // åŒæ—¶åˆ·æ–°èŠå¤©å®¤å¤´åƒ (å·²æœ‰å®‰å…¨æ£€æŸ¥ï¼Œä¿æŒå³å¯)
                        const roomAvatar = document.getElementById('room-contact-avatar');
                        if (roomAvatar) roomAvatar.src = imageData;
                        
                        if (typeof triggerSuccessHud === 'function') {
                            triggerSuccessHud("å…¨åŸŸæ¡£æ¡ˆå·²æ›´æ–°");
                        } else {
                            console.log("å…¨åŸŸæ¡£æ¡ˆå·²æ›´æ–°");
                        }
                    }
                }
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// å¯åŠ¨ç‚¹ç«
document.addEventListener('DOMContentLoaded', bootThemeEngine);
    // ğŸš¨ ç»ˆæç‰©ç†é”å®šï¼šå…¨è¯­ç§è±ªåç‰ˆæ•°æ®åº“ï¼ˆåŒ…å«ç²¤è¯­åŠå…¨çƒä¸»æµå¤–è¯­ï¼‰
const GLOBAL_LANG_DB = [
    // --- æ ¸å¿ƒå¸¸ç”¨ (Core & Regional) ---
    {n: "Cantonese", l: "ç²¤è¯­ (Cantonese)", cat: "common"},
    {n: "English", l: "è‹±è¯­ (English)", cat: "common"},
    {n: "Japanese", l: "æ—¥æœ¬èª (Japanese)", cat: "common"},
    {n: "Korean", l: "í•œêµ­ì–´ (Korean)", cat: "common"},
    {n: "Thai", l: "à¹„à¸—à¸¢ (Thai)", cat: "common"},
    {n: "French", l: "FranÃ§ais (French)", cat: "common"},

    // --- æ¬§æ´²è¯­ç³» (European) ---
    {n: "German", l: "Deutsch (German)", cat: "all"},
    {n: "Italian", l: "Italiano (Italian)", cat: "all"},
    {n: "Spanish", l: "EspaÃ±ol (Spanish)", cat: "all"},
    {n: "Portuguese", l: "PortuguÃªs (Portuguese)", cat: "all"},
    {n: "Russian", l: "Ğ ÑƒÑÑĞºĞ¸Ğ¹ (Russian)", cat: "all"},
    {n: "Swedish", l: "Svenska (Swedish)", cat: "all"},
    {n: "Dutch", l: "Nederlands (Dutch)", cat: "all"},
    {n: "Polish", l: "Polski (Polish)", cat: "all"},
    {n: "Turkish", l: "TÃ¼rkÃ§e (Turkish)", cat: "all"},
    {n: "Greek", l: "Î•Î»Î»Î·Î½Î¹ÎºÎ¬ (Greek)", cat: "all"},
    {n: "Finnish", l: "Suomi (Finnish)", cat: "all"},
    {n: "Norwegian", l: "Norsk (Norwegian)", cat: "all"},
    {n: "Danish", l: "Dansk (Danish)", cat: "all"},

    // --- äºšæ´²è¯­ç³» (Asian) ---
    {n: "Vietnamese", l: "Tiáº¿ng Viá»‡t (Vietnamese)", cat: "all"},
    {n: "Indonesian", l: "Bahasa Indonesia (Indonesian)", cat: "all"},
    {n: "Malay", l: "Bahasa Melayu (Malay)", cat: "all"},
    {n: "Hindi", l: "à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)", cat: "all"},
    {n: "Tagalog", l: "Tagalog (Filipino)", cat: "all"},
    {n: "Burmese", l: "á€™á€¼á€”á€ºá€™á€¬á€…á€¬ (Burmese)", cat: "all"},
    {n: "Khmer", l: "á—á¶áŸá¶ááŸ’á˜áŸ‚áš (Khmer)", cat: "all"},
    {n: "Lao", l: "àºàº²àºªàº²àº¥àº²àº§ (Lao)", cat: "all"},

    // --- ä¸­ä¸œä¸å¤è€è¯­ç³» (Middle East & Ancient) ---
    {n: "Arabic", l: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)", cat: "all"},
    {n: "Hebrew", l: "×¢×‘×¨×™×ª (Hebrew)", cat: "all"},
    {n: "Persian", l: "ÙØ§Ø±Ø³ÛŒ (Persian)", cat: "all"},
    {n: "Latin", l: "æ‹‰ä¸è¯­ (Latin)", cat: "all"}
];
    window.updateLangPreview = function() {
    const isEnabled = document.getElementById('lang-sync-toggle')?.checked;
    const bubble = document.getElementById('sample-bubble');
    const resetTip = document.getElementById('lang-reset-tip'); // æ‹¿åˆ°æé†’æ¡†
    const targetLang = window.langConfig.label;
    
    if (bubble) {
        bubble.style.display = isEnabled ? 'block' : 'none';
        const mainText = bubble.querySelector('.msg-text-main');
        mainText.textContent = `[System] AI æ­£åœ¨å°è¯•ä½¿ç”¨ ${targetLang} ä¸ä½ å…±é¸£...`;
    }

    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœå…³äº†å¼€å…³ï¼Œå°±æ˜¾ç¤ºé‡ç½®æŒ‡ä»¤æé†’
    if (resetTip) {
        resetTip.style.display = isEnabled ? 'none' : 'block';
    }
}
    // --- ğŸš¨ å…¨å±€æ„å¢ƒæ•°æ®åº“å¼ºåŠ›é”æ­» ---
// --- ğŸ—ºï¸ å…¨çƒåŸå¸‚æ„å¢ƒé«˜å®šæ¡£æ¡ˆåº“ ---
// --- ğŸ¨ å…¨çƒåŸå¸‚æ„å¢ƒåº“ (çº¯ CSS ä»£ç ç‰ˆ) ---
// ä¸å†ä½¿ç”¨å›¾ç‰‡é“¾æ¥ï¼Œå½»åº•è§£å†³ç‰ˆæƒé—®é¢˜
// --- ğŸ—ºï¸ å…¨çƒç™¾åŸæ„å¢ƒé«˜å®šæ¡£æ¡ˆåº“ (çº¯ CSS ä»£ç ç‰ˆ) ---
window.CITY_VIBE_DB = {
    // ==================== ğŸ‡¨ğŸ‡³ åå¤å¤§åœ° (50 CITIES) ====================
    "Beijing": { cssBg: "linear-gradient(180deg, #E6E6FA 0%, #DCDCDC 30%, #A52A2A 60%, #8B0000 100%)", vibe: "çº¢å¢™å¤–çš„ç§¯é›ªï¼Œæµ·æ·€åŒºæ·±å¤œæœªç†„çš„ç¯ç«ï¼Œä»¥åŠèƒ¡åŒé‡Œçš„äº¬è…”ã€‚" },
    "Shanghai": { cssBg: "linear-gradient(135deg, #FF00CC 0%, #333399 50%, #00FFFF 100%)", vibe: "å¤–æ»©çš„éœ“è™¹å€’å½±åœ¨æ±Ÿé¢ï¼Œæ¢§æ¡æ ‘ä¸‹çš„è€æ´‹æˆ¿ï¼Œç²¾è‡´ä¸”ç–ç¦»çš„æ™šé£ã€‚" },
    "Guangzhou": { cssBg: "linear-gradient(to bottom right, #a8e063, #56ab2f, #eacda3, #d6ae7b)", vibe: "ç æ±Ÿè¾¹çš„æ½®æ¹¿æ°´æ±½ï¼Œè¶Šç§€å±±çš„è‰é¸£ï¼Œå’ŒèŒ¶æ¥¼é‡Œç¼­ç»•çš„æ—©èŒ¶çƒŸç«ã€‚" },
    "Shenzhen": { cssBg: "linear-gradient(to right, #24fe41, #56ab2f, #01a9fe)", vibe: "ç§‘æŠ€å›­æ·±å¤œçš„ç¯å…‰ï¼Œå¤§æ¢…æ²™å’¸æ¹¿çš„æµ·é£ï¼Œå’Œè¿™åº§åŸå¸‚æ°¸ä¸åœæ­‡çš„è„‰åŠ¨ã€‚" },
    "Chengdu": { cssBg: "radial-gradient(circle at center, #ff9a44, #fc6076, #ff9a44)", vibe: "é”¦é‡Œå··å¼„çš„ç›–ç¢—èŒ¶é¦™ï¼Œé˜´å¤©é‡Œçš„çº¢æ²¹çƒ­æ°”ï¼Œå’Œæ…¢èŠ‚å¥çš„å·´èœ€ä½è¯­ã€‚" },
    "Chongqing": { cssBg: "linear-gradient(45deg, #2c3e50, #fd746c, #2c3e50)", vibe: "å±‚å é”™è½çš„èµ›åšæ£®æ—ï¼Œè½»è½¨ç©¿æ¥¼è€Œè¿‡çš„è½°é¸£ï¼Œå’Œæ½®æ¹¿é—·çƒ­çš„æ±Ÿæ¹–æ°”ã€‚" },
    "Hangzhou": { cssBg: "linear-gradient(to top, #96fbc4 0%, #f9f586 100%)", vibe: "æ–­æ¡¥ä¸Šçš„æ®‹é›ªï¼Œè¥¿æ¹–è¾¹æ°¤æ°²çš„èŒ¶çƒŸï¼Œå’Œçµéšå¯ºæ·±å¤„çš„é’Ÿå£°ã€‚" },
    "Suzhou": { cssBg: "linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)", vibe: "å›­æ—é‡Œçš„æœˆæ´é—¨ï¼Œæ«æ¡¥ä¸‹çš„æµæ°´ï¼Œå’Œè¯„å¼¹å£°ä¸­çš„å´ä¾¬è½¯è¯­ã€‚" },
    "Xi'an": { cssBg: "linear-gradient(to bottom, #8B4513, #FFD700, #B8860B)", vibe: "å¤§é›å¡”ä¸‹çš„æš®è‰²ï¼Œå¤åŸå¢™å¤–çš„é•¿å®‰é£éª¨ï¼Œå’Œç¢‘æ—é‡Œçš„å¢¨é¦™ã€‚" },
    "Nanjing": { cssBg: "linear-gradient(to right, #4facfe 0%, #00f2fe 100%)", vibe: "ç§¦æ·®æ²³ç•”çš„ç¯ç«ï¼Œæ˜åŸå¢™ä¸Šçš„è‹è‹”ï¼Œå’Œä¹Œè¡£å··å£çš„æ–œé˜³ã€‚" },
    "Wuhan": { cssBg: "linear-gradient(to top, #ff0844 0%, #ffb199 100%)", vibe: "æ±Ÿæ±‰å…³çš„é’Ÿå£°ï¼Œé»„é¹¤æ¥¼ä¸‹çš„æµ©æ¸ºæ±Ÿæ°´ï¼Œå’Œä¸€ç¢—çƒ­æ°”è…¾è…¾çš„çƒ­å¹²é¢ã€‚" },
    "Changsha": { cssBg: "linear-gradient(to right, #f83600 0%, #f9d423 100%)", vibe: "æ©˜å­æ´²å¤´çš„æ™šé£ï¼Œæ·±å¤œä¸æ‰“çƒŠçš„æ¹˜æƒ…ï¼Œå’Œå²³éº“å±±ä¸‹çš„ç«çº¢æ«å¶ã€‚" },
    "Harbin": { cssBg: "linear-gradient(to bottom, #E0FFFF, #F0FFFF, #B0C4DE)", vibe: "ä¸­å¤®å¤§è¡—çš„å†°é›•ï¼Œåœ£ç´¢è²äºšæ•™å ‚çš„ç§¯é›ªï¼Œå’Œå†°å†·ç©ºæ°”é‡Œçš„åˆ—å·´é¦™ã€‚" },
    "Xiamen": { cssBg: "linear-gradient(to right, #43e97b 0%, #38f9d7 100%)", vibe: "é¼“æµªå±¿çš„æµ·è¾¹ç´å£°ï¼Œç¯å²›è·¯çš„å‡¤å‡°èŠ±å¼€ï¼Œå’Œå—æ™®é™€çš„æ‚ ç„¶æ¢µéŸ³ã€‚" },
    "Qingdao": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "çº¢ç“¦ç»¿æ ‘çš„æ¬§å¼å»ºç­‘ï¼Œæµ·è¾¹æ²ç”œçš„å•¤é…’æ°”æ¯ï¼Œå’Œå…«å¤§å…³çš„è½å¶ã€‚" },
    "Kunming": { cssBg: "linear-gradient(to right, #6a11cb 0%, #2575fc 100%)", vibe: "ç¿ æ¹–è¾¹çš„çº¢å˜´é¸¥ï¼Œå››å­£ä¸è´¥çš„æ˜¥åŸèŠ±äº‹ï¼Œå’Œäº‘ç«¯æ‹‚è¿‡çš„æ¸…çˆ½ã€‚" },
    "Lhasa": { cssBg: "linear-gradient(to top, #fffc00, #ffffff)", vibe: "å¸ƒè¾¾æ‹‰å®«çš„æ—¥å…‰ï¼Œå¤§æ˜­å¯ºå‰çš„ç…¨æ¡‘çƒŸç«ï¼Œå’Œç»ç­’æ è¿‡çš„å¾®é£ã€‚" },
    "Urumqi": { cssBg: "linear-gradient(to right, #ed6a1d, #eacda3)", vibe: "å¤§å·´æ‰çš„é¦™æ–™å‘³ï¼Œè¿œæ–¹å¤©å±±çš„ç»ˆå¹´ç§¯é›ªï¼Œå’Œæˆˆå£æ»©ä¸Šçš„è½æ—¥ã€‚" },
    "Tianjin": { cssBg: "linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)", vibe: "æµ·æ²³ä¸Šçš„å¤©æ´¥ä¹‹çœ¼ï¼Œäº”å¤§é“çš„å°æ´‹æ¥¼ï¼Œå’Œç›¸å£°é‡Œçš„å¸‚äº•çƒŸç«ã€‚" },
    "Dalian": { cssBg: "linear-gradient(to right, #00c6fb 0%, #005bea 100%)", vibe: "æ˜Ÿæµ·å¹¿åœºçš„æµ·é£ï¼Œç™¾å¹´æœ‰è½¨ç”µè½¦çš„å®å½“å£°ï¼Œå’Œæµ·è¾¹èµ·ä¼çš„å¡é“ã€‚" },
    "Ningbo": { cssBg: "linear-gradient(120deg, #f093fb 0%, #f5576c 100%)", vibe: "å¤©ä¸€é˜çš„ä¹¦å¢¨é¦™ï¼Œä¸‰æ±Ÿå£çš„ç¹åå¤œè‰²ï¼Œå’Œä¸œé’±æ¹–çš„æ½‹æ»Ÿæ³¢å…‰ã€‚" },
    "Wuxi": { cssBg: "linear-gradient(to right, #fdfcfb 0%, #e2d1c3 100%)", vibe: "å¤ªæ¹–ä¹‹æ»¨çš„æ¸©æŸ”ï¼Œé¼‹å¤´æ¸šçš„æ¨±èŠ±é›¨ï¼Œå’Œæƒ å±±å¤é•‡çš„é™è°§ã€‚" },
    "Fuzhou": { cssBg: "linear-gradient(to top, #0ba360 0%, #3cba92 100%)", vibe: "ä¸‰åŠä¸ƒå··çš„çŸ³æ¿è·¯ï¼Œé—½æ±Ÿè¾¹çš„æ¦•æ ‘å…‰å½±ï¼Œå’Œç©ºæ°”ä¸­æ·¡æ·¡çš„èŒ‰è‰èŠ±é¦™ã€‚" },
    "Guiyang": { cssBg: "linear-gradient(to right, #434343 0%, #000000 100%)", vibe: "ç”²ç§€æ¥¼çš„å€’å½±ï¼Œé»”çµå±±çš„çµæ°”ï¼Œå’Œæ¹¿å†·ç©ºæ°”é‡Œé‚£ä¸€ç¢—é…¸æ±¤é±¼é¦™ã€‚" },
    "Lanzhou": { cssBg: "linear-gradient(to bottom, #eacda3, #d6ae7b)", vibe: "é»„æ²³è¾¹çš„ç¾Šçš®ç­å­ï¼Œä¸­å±±æ¡¥çš„é“éª¨å³¥åµ˜ï¼Œå’Œæ¸…æ™¨çš„ç¬¬ä¸€ç¢—ç‰›è‚‰é¢ã€‚" },
    "Sanya": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "äºšé¾™æ¹¾çš„çƒˆæ—¥ï¼Œæ¤°å­æ—é‡Œçš„æ¸…ç”œï¼Œå’Œå¤©æ¶¯æµ·è§’çš„æµªæ½®ã€‚" },
    "HongKong": { cssBg: "linear-gradient(to bottom, #09203f 0%, #537895 100%)", vibe: "ç»´æ¸¯çš„æµå…‰æº¢å½©ï¼Œå¤ªå¹³å±±é¡¶çš„ä¿¯ç°ï¼Œå’Œæ·±æ°´åŸ—çš„äººé—´çƒŸç«ã€‚" },
    "Macau": { cssBg: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)", vibe: "å¤§ä¸‰å·´çš„æ®‹è¿¹ï¼Œå¨±ä¹åœºçš„åç¯ï¼Œå’Œå®˜ä¹Ÿè¡—çš„è‘¡æŒé¦™ã€‚" },
    "Taipei": { cssBg: "linear-gradient(to top, #ff9a9e 0%, #fecfef 100%)", vibe: "101å¤§æ¥¼çš„äº‘ç«¯ï¼Œå£«æ—å¤œå¸‚çš„çƒ­é—¹ï¼Œå’Œæ·¡æ°´æ²³è¾¹çš„è½æ—¥ä½™æ™–ã€‚" },
    "Dali": { cssBg: "linear-gradient(to right, #4facfe 0%, #00f2fe 100%)", vibe: "æ´±æµ·çš„è‹å±±å€’å½±ï¼Œå¤åŸé‡Œçš„æ°‘è°£ï¼Œå’Œé£èŠ±é›ªæœˆçš„æ¸©æŸ”ã€‚" },
    "Lijiang": { cssBg: "linear-gradient(to bottom, #7028e4 0%, #e5b2ca 100%)", vibe: "ç‰é¾™é›ªå±±çš„åœ£æ´ï¼ŒæŸæ²³å¤é•‡çš„é©¬è¹„å£°ï¼Œå’Œå››æ–¹è¡—çš„çº³è¥¿æ­Œèˆã€‚" },
    "Dunhuang": { cssBg: "linear-gradient(to right, #f83600 0%, #f9d423 100%)", vibe: "è«é«˜çªŸçš„åƒå¹´å£ç”»ï¼Œé¸£æ²™å±±çš„é£æ²™ï¼Œå’Œæœˆç‰™æ³‰çš„é™è°§ã€‚" },
    "Zhuhai": { cssBg: "linear-gradient(to top, #5ee7df 0%, #b490ca 100%)", vibe: "æƒ…ä¾£è·¯çš„é•¿é£ï¼Œæ¸”å¥³çš„å®ˆæœ›ï¼Œå’Œæ¨ªç´å²›çš„ç»šçƒ‚å¤œæ™¯ã€‚" },
    "Quanzhou": { cssBg: "linear-gradient(to top, #ff9a9e 0%, #fecfef 100%)", vibe: "åˆºæ¡åŸçš„å¤è€ä¿¡ä»°ï¼Œçº¢ç –å¤§åçš„æ—§æ¢¦ï¼Œå’Œè¥¿è¡—çš„ç¹åã€‚" },
    "Shantou": { cssBg: "linear-gradient(to bottom, #fdfcfb 0%, #e2d1c3 100%)", vibe: "å°å…¬å›­çš„å—æ´‹é£æƒ…ï¼Œå†…æµ·æ¹¾çš„æ™šé£ï¼Œå’Œæ½®æ±•åŠŸå¤«èŒ¶çš„è‹¦ç”œã€‚" },
    "Foshan": { cssBg: "linear-gradient(to right, #00b09b, #96c93d)", vibe: "ç¥–åº™çš„é†’ç‹®ï¼Œå²­å—å¤©åœ°çš„å¤é›…ï¼Œå’Œé»„é£é¸¿çš„æ­¦ä¾ é­‚ã€‚" },
    "Dongguan": { cssBg: "linear-gradient(to top, #6a85b6 0%, #bac8e0 100%)", vibe: "åˆ¶é€ ä¹‹éƒ½çš„èŠ‚å¥ï¼Œæ¾å±±æ¹–çš„æ¸…æ¾ˆï¼Œå’Œå¯å›­çš„é›…è‡´ã€‚" },
    "Zhongshan": { cssBg: "linear-gradient(to bottom, #d2f1df, #fce2ce)", vibe: "å­™ä¸­å±±æ•…å±…çš„åº„é‡ï¼Œå²æ±Ÿè¾¹çš„è€è¡—ï¼Œå’Œä¸­å±±è£…é‡Œçš„æƒ…æ€€ã€‚" },
    "Huizhou": { cssBg: "linear-gradient(to right, #1d976c, #93f9b9)", vibe: "è¥¿æ¹–çš„è‹å ¤é£æœˆï¼ŒåŒæœˆæ¹¾çš„å¥‡è¿¹ï¼Œå’Œç½—æµ®å±±çš„å¹½é™ã€‚" },
    "Nanning": { cssBg: "linear-gradient(to top, #13547a 0%, #80d0c7 100%)", vibe: "ç»¿åŸçš„ç¹èŠ±ï¼Œå—æ¹–çš„å¤œæ™¯ï¼Œå’Œä¸­å±±è·¯å¤œå¸‚çš„çƒŸç«ã€‚" },
    "Guilin": { cssBg: "linear-gradient(to right, #1d976c, #93f9b9)", vibe: "æ¼“æ±Ÿçš„å­¤èˆŸï¼Œè±¡é¼»å±±çš„å€’å½±ï¼Œå’Œé˜³æœ”è¥¿è¡—çš„è¿·ç¦»ã€‚" },
    "Haikou": { cssBg: "linear-gradient(to bottom, #ffecd2, #fcb69f)", vibe: "éª‘æ¥¼è€è¡—çš„æ–‘é©³ï¼Œä¸‡ç»¿å›­çš„æ¸…æ–°ï¼Œå’Œå—å›½æµ·è¾¹çš„æ¹¿æ¶¦ã€‚" },
    "Luoyang": { cssBg: "linear-gradient(to right, #e1eec3, #f05053)", vibe: "é¾™é—¨çŸ³çªŸçš„éœ‡æ’¼ï¼Œæ´›é˜³ç‰¡ä¸¹çš„å€¾åŸï¼Œå’Œéš‹å”å¤éƒ½çš„ä½™æ™–ã€‚" },
    "Jinan": { cssBg: "linear-gradient(to top, #c471f5 0%, #fa71cd 100%)", vibe: "å¤§æ˜æ¹–ç•”çš„å‚æŸ³ï¼Œè¶µçªæ³‰çš„ç”Ÿæœºï¼Œå’Œæ³‰åŸè·¯çš„çƒ­é—¹ã€‚" },
    "Zhengzhou": { cssBg: "linear-gradient(to right, #74ebd5 0%, #9face6 100%)", vibe: "ä¸­åŸæ¢çº½çš„å¿™ç¢Œï¼ŒäºŒä¸ƒçºªå¿µå¡”çš„ç¯ç«ï¼Œå’Œåµ©å±±å°‘æ—çš„ç¦…æ„ã€‚" },
    "Hefei": { cssBg: "linear-gradient(to right, #6a11cb 0%, #2575fc 100%)", vibe: "åŒ…æ²³çš„å¾®é£ï¼Œç§‘å­¦å²›çš„é™è°§ï¼Œå’Œè¿™åº§åŸå¸‚è“¬å‹ƒçš„æœæ°”ã€‚" },
    "Nanchang": { cssBg: "linear-gradient(to top, #00c6fb 0%, #005bea 100%)", vibe: "æ»•ç‹é˜çš„å£®é˜”ï¼Œèµ£æ±Ÿè¾¹çš„ç¯å…‰ç§€ï¼Œå’Œå…«ä¸€å¹¿åœºçš„è‚ƒç©†ã€‚" },
    "Taiyuan": { cssBg: "linear-gradient(to right, #868f96 0%, #596164 100%)", vibe: "æ±¾æ²³ä¹‹ç•”çš„è½æ—¥ï¼Œæ™‹ç¥ çš„å¤è€ï¼Œå’Œé¾™åŸçš„åšé‡åº•è‰²ã€‚" },
    "Hohhot": { cssBg: "linear-gradient(to right, #d4fc79 0%, #96e6a1 100%)", vibe: "å¡å¤–é’åŸçš„è¾½é˜”ï¼Œå¤§å¬å¯ºçš„åº„ä¸¥ï¼Œå’Œè‰åŸæ·±å¤„çš„å¥¶èŒ¶é¦™ã€‚" },
    "Yinchuan": { cssBg: "linear-gradient(to bottom, #F5F5DC, #DAA520)", vibe: "è´ºå…°å±±ä¸‹çš„é›„æµ‘ï¼Œæ²™æ¹–çš„æ¸©æŸ”ï¼Œå’Œè¥¿å¤ç‹é™µçš„è‹å‡‰ã€‚" },

    // ==================== ğŸŒ å›½é™…æ¼«æ¸¸ (50 CITIES) ====================
    "Bangkok": { cssBg: "linear-gradient(to right, #ffb347, #ffcc33, #ff9966, #ff5e62)", vibe: "è€ƒå±±è·¯å–§é—¹çš„çªçªè½¦å£°ï¼Œæ¹¿çƒ­çš„é›¨åç©ºæ°”ï¼Œå’Œè¡—å¤´å¼¥æ¼«çš„é¦™æ–™å‘³ã€‚" },
    "Chiang Mai": { cssBg: "linear-gradient(to bottom, #D3CCE3, #E9E4F0, #a8e063)", vibe: "ç´ è´´å±±ä¸‹çš„æ¸…æ™¨è¿·é›¾ï¼Œå®æ›¼è·¯çš„æ–‡è‰ºå°é¦†ï¼Œå’Œæ…¢æ‚ æ‚ çš„åŒ—æ³°é£æƒ…ã€‚" },
    "Phuket": { cssBg: "linear-gradient(to bottom, #2193b0, #6dd5ed, #ffecd2, #fcb69f)", vibe: "å®‰è¾¾æ›¼æµ·çš„æ¹›è“æµªæ½®ï¼Œè½æ—¥ä½™æ™–ä¸‹çš„æ²™æ»©ï¼Œå’Œæ°¸è¿œä¸åœæ­‡çš„æµ·é£ã€‚" },
    "Tokyo": { cssBg: "repeating-linear-gradient(45deg, #0f0c29, #0f0c29 10px, #302b63 10px, #302b63 20px)", vibe: "æ¶©è°·è·¯å£çš„äººæ½®æ±¹æ¶Œï¼Œæ–°å®¿æ·±å¤œçš„å±…é…’å±‹ï¼Œå’Œç”µè½¦å…³é—¨æ—¶çš„æœºæ¢°éŸ³ã€‚" },
    "Osaka": { cssBg: "linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)", vibe: "é“é¡¿å €çš„å·¨å‹æ‹›ç‰Œï¼Œé€šå¤©é˜çš„å¤å¤å…‰å½±ï¼Œå’Œå…³è¥¿è…”é‡Œçš„çƒ­æƒ…å–§åš£ã€‚" },
    "Kyoto": { cssBg: "linear-gradient(to right, #f83600, #f9d423)", vibe: "å²šå±±çš„çº¢å¶ï¼Œä¼è§ç¨»è·çš„åƒæœ¬é¸Ÿå±…ï¼Œå’Œé¸­å·è¾¹çš„é™è°§é»„æ˜ã€‚" },
    "Seoul": { cssBg: "linear-gradient(to bottom, #11998e, #38ef7d)", vibe: "æ±‰æ±Ÿè¾¹çš„ç‚¸é¸¡ä¸æ™šé£ï¼Œå¼˜å¤§çš„è¡—å¤´æ¼”å‡ºï¼Œå’Œæ·±ç§‹æ˜æ´çš„é“¶æå¶ã€‚" },
    "London": { cssBg: "linear-gradient(to bottom, #373B44, #4286f4)", vibe: "ç»ˆå¹´ä¸æ•£çš„é˜´éƒæµ“é›¾ï¼Œå¤§æœ¬é’Ÿçš„æ²‰é¸£ï¼Œå’Œæ³°æ™¤å£«æ²³è¾¹æ¹¿æ¼‰æ¼‰çš„ä¼ã€‚" },
    "Paris": { cssBg: "linear-gradient(to top, #fad0c4 0%, #ffd1ff 100%)", vibe: "å¡çº³æ²³ç•”çš„å’–å•¡ç„¦é¦™ï¼Œå¤•é˜³ä¸‹çš„åŸƒè²å°”é“å¡”ï¼Œå’Œé¦™æ¦­ä¸½èˆå¤§é“çš„æµªæ¼«ã€‚" },
    "New York": { cssBg: "linear-gradient(to right, #000000, #434343, #000000)", vibe: "æ—¶ä»£å¹¿åœºæ°¸ä¸ç†„ç­çš„å·¨å¹•ï¼Œä¸­å¤®å…¬å›­çš„æ¯å¶ï¼Œå’Œåœ°é“æ·±å¤„çš„è½°é¸£ã€‚" },
    "Los Angeles": { cssBg: "linear-gradient(to right, #ff7e5f, #feb47b)", vibe: "å¥½è±åå±±çš„è½æ—¥ï¼Œåœ£è«å°¼å¡æµ·æ»©çš„æ¤°æ—ï¼Œå’Œæ˜Ÿå…‰å¤§é“çš„ç’€ç’¨æ¢¦æƒ³ã€‚" },
    "San Francisco": { cssBg: "linear-gradient(to right, #ff7e5f, #feb47b)", vibe: "é‡‘é—¨å¤§æ¡¥çš„é›¾æ°”ï¼Œä¹æ›²èŠ±è¡—çš„ç¼¤çº·ï¼Œå’Œç¡…è°·æ·±å¤„çš„åˆ›æ–°è„‰åŠ¨ã€‚" },
    "Sydney": { cssBg: "linear-gradient(to top, #4481eb 0%, #04befe 100%)", vibe: "æ­Œå‰§é™¢çš„å¸†å½±ï¼Œé‚¦è¿ªæµ·æ»©çš„å†²æµªå°‘å¹´ï¼Œå’Œè¾¾ä»¤æ¸¯çš„çƒŸç«ã€‚" },
    "Singapore": { cssBg: "linear-gradient(to right, #ff5f6d, #ffc371)", vibe: "æ»¨æµ·æ¹¾çš„é‡‘æ²™å¹»å½±ï¼Œé±¼å°¾ç‹®çš„åæ¯ï¼Œå’Œä¹ŒèŠ‚è·¯çš„ç¹åç¯ç«ã€‚" },
    "Dubai": { cssBg: "linear-gradient(to right, #D4AF37, #C0C0C0)", vibe: "å“ˆåˆ©æ³•å¡”çš„äº‘ç«¯ï¼Œæ²™æ¼ ä¸­å¿ƒçš„å¥‡è¿¹ï¼Œå’Œå¸†èˆ¹é…’åº—çš„å€’å½±ã€‚" },
    "Rome": { cssBg: "linear-gradient(to right, #f12711, #f5af19)", vibe: "æ–—å…½åœºçš„è½æ—¥ï¼Œè®¸æ„¿æ± çš„æ¸…äº®æ³‰æ°´ï¼Œå’Œç©¿è¶Šåƒå¹´çš„çŸ³æ¿è·¯ã€‚" },
    "Venice": { cssBg: "linear-gradient(to right, #74ebd5 0%, #9face6 100%)", vibe: "å¹æ¯æ¡¥ä¸‹çš„è´¡å¤šæ‹‰ï¼Œåœ£é©¬å¯å¹¿åœºçš„é¸½ç¾¤ï¼Œå’Œé€æ¸ä¸Šæ¶¨çš„æ½®å£°ã€‚" },
    "Berlin": { cssBg: "linear-gradient(to top, #200122, #6f0000)", vibe: "æŸæ—å¢™çš„æ¶‚é¸¦è®°å¿†ï¼Œå‹ƒå…°ç™»å ¡é—¨çš„è‚ƒç©†ï¼Œå’Œè¿™åº§åŸå¸‚å†·å³»çš„è‰ºæœ¯æ„Ÿã€‚" },
    "Amsterdam": { cssBg: "linear-gradient(to top, #00c6fb 0%, #005bea 100%)", vibe: "è¿æ²³ä¸¤å²¸çš„å½©è‰²æˆ¿å­ï¼Œéƒé‡‘é¦™çš„èŠ±æµ·ï¼Œå’Œéª‘è½¦ç»è¿‡çš„è‡ªç”±é£ã€‚" },
    "Madrid": { cssBg: "linear-gradient(to bottom, #f12711, #f5af19)", vibe: "æ™®æ‹‰å¤šåšç‰©é¦†çš„çè—ï¼Œé©¬çº¦å°”å¹¿åœºçš„çƒ­é—¹ï¼Œå’Œä½›æœ—æ˜å“¥çš„ç‹‚çƒ­ã€‚" },
    "Barcelona": { cssBg: "linear-gradient(to right, #ffb199 0%, #ff0844 100%)", vibe: "åœ£å®¶å ‚çš„æ€ªè¯ç¾å­¦ï¼Œå·´å¡ç½—å†…å¡”æµ·æ»©çš„é˜³å…‰ï¼Œå’Œé«˜è¿ªçš„å¹»æ¢¦ã€‚" },
    "Moscow": { cssBg: "linear-gradient(to right, #83a4d4, #b6fbff)", vibe: "çº¢åœºçš„æ´‹è‘±å¤´æˆ¿é¡¶ï¼Œå…‹é‡Œå§†æ—å®«çš„åšé‡ï¼Œå’Œè«æ–¯ç§‘æ²³çš„æ·±æ²‰ã€‚" },
    "Cairo": { cssBg: "linear-gradient(to bottom, #ed6a1d, #eacda3)", vibe: "é‡‘å­—å¡”å‰çš„æ¼«å¤©é»„æ²™ï¼Œå°¼ç½—æ²³çš„å¤è€è„‰åŠ¨ï¼Œå’Œå¤åŸƒåŠçš„ç¥ç§˜æ°”æ¯ã€‚" },
    "Melbourne": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "æ¶‚é¸¦å··çš„è‰ºæœ¯æ°›å›´ï¼Œå¤§æ´‹è·¯çš„å£®é˜”ï¼Œå’Œè¿™åº§åŸå¸‚çš„å’–å•¡æ–‡åŒ–ã€‚" },
    "Vancouver": { cssBg: "linear-gradient(to right, #4facfe 0%, #00f2fe 100%)", vibe: "æ–¯å¦åˆ©å…¬å›­çš„æ£®æ—ï¼Œä¾å±±å‚æµ·çš„æ¸…å†·ï¼Œå’ŒåŒ—ç¾æœ€ç¾çš„å¤•é˜³ã€‚" },
    "Toronto": { cssBg: "linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)", vibe: "CNå¡”ä¿¯ç°çš„éƒ½å¸‚ä¸›æ—ï¼Œå®‰å¤§ç•¥æ¹–çš„å¾®æ³¢ï¼Œå’Œå¤šå…ƒæ–‡åŒ–çš„äº¤å“ã€‚" },
    "Vienna": { cssBg: "linear-gradient(to right, #fdfcfb 0%, #e2d1c3 100%)", vibe: "é‡‘è‰²å¤§å…çš„äº¤å“ä¹ï¼Œè¨èµ«è›‹ç³•çš„é†‡åšï¼Œå’Œå¤šç‘™æ²³çš„è“è‰²æ—‹å¾‹ã€‚" },
    "Prague": { cssBg: "linear-gradient(to top, #c471f5 0%, #fa71cd 100%)", vibe: "æŸ¥ç†å¤§æ¡¥çš„å¤è€çŸ³åƒï¼Œè€åŸå¹¿åœºçš„å¤©æ–‡é’Ÿï¼Œå’Œæ³¢å¸Œç±³äºšçš„çº¢ç“¦é¡¶ã€‚" },
    "Zurich": { cssBg: "linear-gradient(to top, #e6e9f0 0%, #eef1f5 100%)", vibe: "è‹é»ä¸–æ¹–çš„çº¯å‡€ï¼Œç­éœå¤«å¤§è¡—çš„å¥¢åï¼Œå’Œé˜¿å°”å‘æ–¯å±±è„‰çš„è¿œçœºã€‚" },
    "Geneva": { cssBg: "linear-gradient(to right, #a1c4fd 0%, #c2e9fb 100%)", vibe: "å¤§å–·æ³‰çš„æ°´èŠ±ï¼Œæ—¥å†…ç“¦æ¹–çš„é™è°§ï¼Œå’Œé’Ÿè¡¨ä¹‹éƒ½çš„ç²¾å‡†èŠ‚å¥ã€‚" },
    "Stockholm": { cssBg: "linear-gradient(to right, #a1c4fd 0%, #c2e9fb 100%)", vibe: "è€åŸçš„çŸ³ç –è·¯ï¼Œæ–¯å ªçš„çº³ç»´äºšçš„æç®€ï¼Œå’Œæ³¢ç½—çš„æµ·çš„å‘¼å¸ã€‚" },
    "Copenhagen": { cssBg: "linear-gradient(to top, #d2f1df 0%, #fce2ce 100%)", vibe: "æ–°æ¸¯çš„å½©è‰²æˆ¿å­ï¼Œå°ç¾äººé±¼çš„å®ˆæœ›ï¼Œå’Œç«¥è¯ç‹å›½çš„æ‚ é—²ã€‚" },
    "Oslo": { cssBg: "linear-gradient(to bottom, #2c3e50, #4ca1af)", vibe: "ç»´æ ¼å…°é›•å¡‘å…¬å›­çš„éœ‡æ’¼ï¼Œå¥¥æ–¯é™†å³¡æ¹¾çš„é£ï¼Œå’ŒåŒ—æ¬§çš„æ¸…å†·ç¾å­¦ã€‚" },
    "Reykjavik": { cssBg: "linear-gradient(to bottom, #2c3e50, #4ca1af)", vibe: "å†°å²›æ—·é‡çš„å­¤ç‹¬ï¼Œè“æ¹–æ¸©æ³‰çš„æ°¤æ°²ï¼Œå’Œåˆå¤œå¤ªé˜³çš„å¥‡è¿¹ã€‚" },
    "Lisbon": { cssBg: "linear-gradient(to right, #f79d00, #64f38c)", vibe: "é»„è‰²ç”µè½¦çˆ¬è¿‡çš„å¡é“ï¼Œæ³•å¤šéŸ³ä¹çš„å¿§éƒï¼Œå’Œè´ä¼¦å¡”çš„æµ·è¾¹å¤•é˜³ã€‚" },
    "Athens": { cssBg: "linear-gradient(to top, #6a85b6 0%, #bac8e0 100%)", vibe: "å«åŸçš„æ–­å£æ®‹å£ï¼Œçˆ±ç´æµ·çš„æ¹›è“ï¼Œå’Œå¤å¸Œè…Šæ–‡æ˜çš„ä½™æ™–ã€‚" },
    "Istanbul": { cssBg: "linear-gradient(to bottom, #09203f, #537895)", vibe: "åšæ–¯æ™®é²æ–¯æµ·å³¡çš„è½®æ¸¡ï¼Œè“è‰²æ¸…çœŸå¯ºçš„å‘¼å”¤ï¼Œå’Œäºšæ¬§äº¤ç•Œçš„åšé‡ã€‚" },
    "Dubai": { cssBg: "linear-gradient(to right, #D4AF37, #C0C0C0)", vibe: "å“ˆåˆ©æ³•å¡”çš„äº‘ç«¯å¥¢åï¼Œæ²™æ¼ ä¸­çš„ç»ç’ƒåŸå ¡ï¼Œå’Œæœ±ç¾æ‹‰æ£•æ¦ˆå²›çš„å£®é˜”ã€‚" },
    "Abu Dhabi": { cssBg: "linear-gradient(to right, #ffb347, #ffcc33)", vibe: "è°¢èµ«æ‰è€¶å¾·å¤§æ¸…çœŸå¯ºçš„æ´ç™½ï¼Œæ²™æ¼ ä¸­çš„å¢æµ®å®«ï¼Œå’Œæ³¢æ–¯æ¹¾çš„æš–é£ã€‚" },
    "Mumbai": { cssBg: "linear-gradient(to top, #f83600 0%, #f9d423 100%)", vibe: "å­Ÿä¹°æ¹¾çš„å­£é£ï¼Œå®è±åçš„æ–‘æ–“è‰²å½©ï¼Œå’Œè¿™åº§åŸå¸‚çš„å–§åš£ç”Ÿå‘½åŠ›ã€‚" },
    "Delhi": { cssBg: "linear-gradient(to right, #ed6a1d, #eacda3)", vibe: "çº¢å ¡çš„è¾‰ç…Œï¼Œæ—§å¾·é‡Œçš„å°å··ï¼Œå’Œå„ç§é¦™æ–™æ±‡èšçš„æµ“éƒæ°”æ¯ã€‚" },
    "Kuala Lumpur": { cssBg: "linear-gradient(to top, #00d2ff 0%, #3a7bd5 100%)", vibe: "åŒå­å¡”çš„å†·å†½ï¼Œç‹¬ç«‹å¹¿åœºçš„ç¹åï¼Œå’Œå„ç§æ—æ–‡åŒ–äº¤æ±‡çš„çƒŸç«ã€‚" },
    "Bali": { cssBg: "linear-gradient(to right, #00b09b, #96c93d)", vibe: "å¾·æ ¼æ‹‰æœ—æ¢¯ç”°çš„ç»¿ï¼Œä¹Œé²ç“¦å›¾çš„æ–­å´–è½æ—¥ï¼Œå’Œç¥åº™é‡Œçš„é™è°§ç¦…æ„ã€‚" },
    "Hanoi": { cssBg: "linear-gradient(to right, #1d976c, #93f9b9)", vibe: "è¿˜å‰‘æ¹–çš„æ™¨ç»ƒï¼Œè€è¡—çš„æ»´æ¼å’–å•¡ï¼Œå’Œè¿™åº§åŸå¸‚å¤æœ´çš„æ—¶é—´æ„Ÿã€‚" },
    "Ho Chi Minh City": { cssBg: "linear-gradient(to top, #eb3349 0%, #f45c43 100%)", vibe: "è¥¿è´¡çš„æ‘©æ‰˜è½¦æ´ªæµï¼Œæ³•å¼å»ºç­‘çš„ä½™æ™–ï¼Œå’Œæå…¶çƒ­æƒ…çš„è¡—å¤´æ´»åŠ›ã€‚" },
    "Manila": { cssBg: "linear-gradient(to right, #ff5f6d, #ffc371)", vibe: "é©¬å°¼æ‹‰æ¹¾çš„æ—¥è½ï¼Œç‹åŸå†…çš„å¤æ—§çŸ³å¢™ï¼Œå’Œç°ä»£éƒ½å¸‚çš„çƒ­è¾£èŠ‚å¥ã€‚" },
    "Cape Town": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "æ¡Œå±±çš„äº‘é›¾æ¡Œå¸ƒï¼Œå¥½æœ›è§’çš„å£®é˜”æµªæ½®ï¼Œå’Œå½©è‰²æˆ¿å­åšå¡æ™®çš„æ¬¢å¿«ã€‚" },
    "Rio de Janeiro": { cssBg: "linear-gradient(to right, #00b09b, #96c93d)", vibe: "æ•‘ä¸–åŸºç£åƒçš„æ€€æŠ±ï¼Œç§‘å¸•å¡å·´çº³æµ·æ»©çš„æ¡‘å·´ï¼Œå’ŒåŸºç£å±±çš„é¸Ÿç°ã€‚" },
    "Buenos Aires": { cssBg: "linear-gradient(to bottom, #1e3c72, #2a5298)", vibe: "æ¢æˆˆçš„ä¼˜é›…ï¼Œå—ç¾å·´é»çš„ç¹åï¼Œå’Œç«ç‘°å›­é‡Œçš„èŠ¬èŠ³ã€‚" },
    "Mexico City": { cssBg: "linear-gradient(to right, #ff7e5f, #feb47b)", vibe: "å®ªæ³•å¹¿åœºçš„çƒ­é—¹ï¼Œå¼—é‡Œè¾¾è“æˆ¿å­çš„è‰ºæœ¯ï¼Œå’Œå¤ä»£æ–‡æ˜çš„é—è¿¹ã€‚" },

    "default": { cssBg: "linear-gradient(to right, #8e2de2, #4a00e0)", vibe: "åœ¨è¿™ä¸ªé™Œç”Ÿçš„ç»çº¬åº¦ä¸Šï¼Œæˆ‘ä¾ç„¶èƒ½æ„Ÿè§‰åˆ°å±äºä½ çš„é‡å­è„‰åŠ¨ã€‚" }
};

window.executeSummaryProcess = async function(contactId) {
    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
        
        // 1. è·å–å†å²è®°å½•
        const history = await getChatHistory(contactId);
        if (history.length < 3) return;

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ„é€ ä¸Šä¸‹æ–‡æ—¶ï¼Œç‰©ç†æ‹¦æˆª Base64 å›¾ç‰‡ä»£ç 
        const chatContext = history.slice(-30).map(m => {
            // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œåªå‘Šè¯‰ AI â€œç”¨æˆ·å‘äº†å›¾â€ï¼Œä¸å‘é‚£ä¸€é•¿ä¸²ä¹±ç 
            const content = m.type === 'image' ? '[å›¾ç‰‡å†…å®¹]' : m.text;
            return `${m.role}: ${content}`;
        }).join('\n');
        
        // 2. æ„é€ æ ‡å‡†çš„ messages æ•°ç»„
        const messages = [
            { 
                role: "system", 
                content: "ä½ æ˜¯ä¸€ä¸ªè®°å¿†æå–å™¨ã€‚è¯·å¯¹å¯¹è¯è¿›è¡Œè®°å¿†åç¼©ï¼Œæå–æœ€é‡è¦çš„1ä¸ªäº‹å®æˆ–æƒ…æ„Ÿè¿›å±•ã€‚è¦æ±‚ï¼š80å­—ä»¥å†…ï¼Œåƒç§äººæ¡£æ¡ˆï¼Œç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚" 
            },
            { 
                role: "user", 
                content: `å¯¹è¯å†…å®¹å¦‚ä¸‹ï¼š\n${chatContext}` 
            }
        ];

        // 3. æ‰§è¡Œå‘é€
        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: messages,
                temperature: 0.7
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        
        const summaryText = data.choices[0].message.content.trim();

        // 4. å­˜å…¥æ•°æ®åº“
        let summaries = await loadFromDB('summaries_' + contactId) || [];
        summaries.unshift({ timestamp: Date.now(), text: summaryText });
        await saveToDB('summaries_' + contactId, summaries);

        // åˆ·æ–° UI å’Œé€šçŸ¥
        if (typeof renderSummaryCards === 'function') renderSummaryCards(contactId);
        window.showPushNotification("æ ¸å¿ƒè®°å¿†å·²åç¼©", "æ–°çš„äººæ ¼èŠ‚ç‚¹å·²å­˜å…¥åè®®ã€‚");

    } catch (e) {
        // è¿™é‡Œæ‹¦æˆªäº†ä½ çœ‹åˆ°çš„é‚£ä¸ª 400 é”™è¯¯
        console.error("âŒ è‡ªåŠ¨æ€»ç»“å¤±è´¥:", e);
    }
};
// ==========================================
// ğŸ§  æ•°æ®é©±åŠ¨ï¼šæ¶ˆæ¯æ‹¦æˆªå®¡è®¡ (å¸¦æ§åˆ¶å°å¯è§†åŒ–)
// ==========================================
window.autoSummaryAuditor = function(contactId) {
    const contact = window.currentChattingWith || { name: "æœªçŸ¥è§’è‰²" };
    const targetRounds = parseInt(localStorage.getItem('summary_rounds_' + contactId) || "10");
    
    let currentCount = parseInt(localStorage.getItem('chat_count_' + contactId) || "0");
    currentCount++; 

    // ğŸš¨ è¿™ä¸€æ®µåœ¨æ§åˆ¶å°ä¼šéå¸¸æ¼‚äº®ï¼Œè®©ä½ ä¸€çœ¼çœ‹åˆ°è¿›åº¦
    console.group(`ğŸ“Š è®°å¿†åè®®ç›‘æ§ [${contact.name}]`);
    console.log(`%c å½“å‰è½®æ•°: ${currentCount} `, "background: #1d1d1f; color: #fff; border-radius: 3px;");
    console.log(`%c è§¦å‘é˜ˆå€¼: ${targetRounds} `, "background: #007AFF; color: #fff; border-radius: 3px;");
    
    const progress = (currentCount / targetRounds * 100).toFixed(0);
    console.log(`%c é‡å­åç¼©è¿›åº¦: ${progress}% `, `color: ${progress >= 100 ? '#FF3B30' : '#34C759'}; font-weight: bold;`);
    console.groupEnd();

    if (currentCount >= targetRounds) {
        console.info("%c ğŸš€ è¾¾åˆ°é˜ˆå€¼ï¼Œæ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ€»ç»“...", "color: #FF9500; font-weight: bold;");
        localStorage.setItem('chat_count_' + contactId, "0"); // è®¡æ•°å½’é›¶
        window.executeSummaryProcess(contactId);
    } else {
        localStorage.setItem('chat_count_' + contactId, currentCount.toString());
    }
};
    // --- ğŸ“± å¼ºåŠ›é€šçŸ¥ä¸­å¿ƒå¼•æ“ ---
let startY = 0;
let isPulling = false;

// 1. ç›‘å¬å…¨å±€è§¦æ§å¼€å§‹
document.addEventListener('touchstart', function(e) {
    // å¦‚æœæ˜¯ä»å±å¹•ä¸ŠåŠéƒ¨åˆ†å¼€å§‹ä¸‹æ‹‰ (y < 80px)
    if (e.touches[0].clientY < 80) {
        startY = e.touches[0].clientY;
        isPulling = true;
    }
}, { passive: true });

// 2. ç›‘å¬æ»‘åŠ¨è¿‡ç¨‹
document.addEventListener('touchmove', function(e) {
    if (!isPulling) return;
    
    let currentY = e.touches[0].clientY;
    let diff = currentY - startY;

    // åªè¦ä¸‹æ»‘è¶…è¿‡ 30px å°±è®¤ä¸ºæ˜¯è¦æ‹‰å‡ºé€šçŸ¥ä¸­å¿ƒ
    if (diff > 30) {
        window.openNotificationShade();
        isPulling = false; // è§¦å‘åé‡ç½®
    }
}, { passive: true });

// 3. åœæ­¢ç›‘å¬
document.addEventListener('touchend', function() {
    isPulling = false;
});

// 4. æ‰§è¡Œå¼€å¯
window.openNotificationShade = function() {
    const shade = document.getElementById('ios-notification-shade');
    if (!shade) return;
    
    shade.style.display = 'flex';
    // å¼ºåˆ¶æµè§ˆå™¨æ¸²æŸ“åå†æ»‘åŠ¨
    setTimeout(() => {
        shade.classList.add('active');
        console.log("System: é€šçŸ¥ä¸­å¿ƒå·²æ¨å…¥");
    }, 10);
};

// 5. æ‰§è¡Œå…³é—­
window.closeNotificationShade = function() {
    const shade = document.getElementById('ios-notification-shade');
    if (shade) {
        shade.classList.remove('active');
        setTimeout(() => {
            shade.style.display = 'none';
        }, 400);
    }
};

// --- ğŸ§¹ ä¸€é”®æ¸…é™¤é€šçŸ¥ä¸­å¿ƒ ---
window.clearAllNotifications = function() {
    // 1. ç‰©ç†æ¸…ç©ºæœ¬åœ°å­˜å‚¨
    localStorage.removeItem('ios_notif_db');
    
    // 2. é‡æ–°æ¸²æŸ“é¡µé¢ï¼ˆä¼šè‡ªåŠ¨æ˜¾ç¤ºç©ºçŠ¶æ€ï¼‰
    window.renderNotificationList();
    
    showToast("å·²æ¸…ç©ºé€šçŸ¥ä¸­å¿ƒ");
};

// ==========================================
// ğŸ”” å¢å¼ºç‰ˆï¼šå•†ç”¨è‡ªæ„ˆé€šçŸ¥å¼•æ“ (é»‘ç™½çº¿æ¡é£é™å®šç‰ˆ)
// ==========================================
window.showPushNotification = function(title, text) {
    let banner = document.getElementById('ios-push-banner');
    
    // ğŸ¨ ä¿æŒä½ å–œæ¬¢çš„é»‘ç™½çº¿æ¡å›¾æ ‡
    const lineIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5"><path d="M12 2v4M12 18v4M4 12H2M22 12h-2" stroke-linecap="round"/><path d="M16 8v8H8V8h8zM9 12h6" stroke-linecap="round"/><rect x="5" y="5" width="14" height="14" rx="2"/></svg>`;

    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'ios-push-banner';
        banner.className = 'ios-banner';
        document.body.appendChild(banner);
    }

    // 1. å¼¹å‡ºé¡¶éƒ¨æ¨ªå¹…
    banner.innerHTML = `
        <div style="border: 1.5px solid #000; border-radius: 10px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">${lineIcon}</div>
        <div style="flex:1; margin-left:12px; overflow:hidden;">
            <div style="font-size:13px; font-weight:800; color:#000;">${title}</div>
            <div style="font-size:12px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${text}</div>
        </div>`;

    void banner.offsetWidth; 
    banner.classList.add('show');

    // 2. ğŸš¨ ã€æ•°æ®æŒä¹…åŒ–ã€‘å­˜å…¥æœ¬åœ°æ¡£æ¡ˆåº“
    const newNotif = {
        id: Date.now(),
        title: title,
        text: text,
        appId: "page-wallet", // âš¡ æ–°å¢ï¼šæ ‡è®°è¿™æ¡é€šçŸ¥å±äºé’±åŒ…
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
    };
    let history = JSON.parse(localStorage.getItem('ios_notif_db') || "[]");
    history.unshift(newNotif); // æœ€æ–°æ¶ˆæ¯æ”¾æœ€å‰é¢
    localStorage.setItem('ios_notif_db', JSON.stringify(history));

    // 3. ç«‹å³è§¦å‘æ¸²æŸ“ï¼Œè®©é€šçŸ¥ä¸­å¿ƒåŒæ­¥æ›´æ–°
    window.renderNotificationList();

    setTimeout(() => { if (banner) banner.classList.remove('show'); }, 5000);
};

window.renderNotificationList = function() {
    const list = document.getElementById('notification-list');
    if (!list) return;

    const history = JSON.parse(localStorage.getItem('ios_notif_db') || "[]");
    
    if (history.length === 0) {
        list.innerHTML = `<div class="notif-empty-state">æ²¡æœ‰æ›´æ—©çš„é€šçŸ¥äº†</div>`;
        return;
    }

    list.innerHTML = history.map(item => `
        <div class="notif-item-custom" 
             onclick="window.handleNotifCenterClick('${item.appId}')"
             style="background:rgba(255,255,255,0.1); border-radius:18px; padding:15px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.1); cursor:pointer;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span style="font-weight:800; font-size:11px; color:rgba(255,255,255,0.8); letter-spacing:1px;">SYSTEM CORE</span>
                <span style="font-size:9px; color:rgba(255,255,255,0.4);">${item.time}</span>
            </div>
            <div style="font-size:14px; font-weight:700; color:#fff; margin-bottom:4px;">${item.title}</div>
            <div style="font-size:12px; color:rgba(255,255,255,0.7); line-height:1.4;">${item.text}</div>
        </div>
    `).join('');
};

// âš¡ æ–°å¢å¤„ç†å‡½æ•°ï¼šç‚¹å‡»é€šçŸ¥ä¸­å¿ƒæ¡ç›®
window.handleNotifCenterClick = function(appId) {
    if (appId) {
        window.closeNotificationShade(); // å…³æ‰æ‹‰å¸˜
        if (typeof openApp === 'function') {
            openApp(appId); // æ‰“å¼€å¯¹åº”çš„ App (page-wallet)
        }
    }
};

// ğŸš¨ è¿™ä¸€æ­¥æœ€å…³é”®ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡
document.addEventListener('DOMContentLoaded', window.renderNotificationList);

// ç‚¹å‡»æ¨ªå¹…è·³è½¬åˆ°æ€»ç»“é¡µ
window.handleNotificationClick = function() {
    document.getElementById('ios-push-banner').classList.remove('show');
    // å¼ºåˆ¶è·³è½¬
    if(typeof window.openMemorySummary === 'function') {
        window.openMemorySummary();
    }
};
    // ==========================================
// ğŸ¬ è®°å¿†è§†ç•Œï¼šè¯¦æƒ…å¼¹çª—é€»è¾‘ (å½»åº•ä¿®å¤ç‰ˆ)
// ==========================================

// 1. å¼ºåŠ›å¼€å¯è¯¦æƒ…é¡µ
window.openCinemaMemory = function(m) {
    const modal = document.getElementById('modal-memory-cinema');
    const titleEl = document.getElementById('cinema-title-ui');
    const contentEl = document.getElementById('cinema-text-content');
    const imgEl = document.getElementById('cinema-img');

    if (!modal || !m) return;

    // 1. å¡«å……æ–‡æœ¬å†…å®¹
    if (titleEl) titleEl.textContent = m.title;
    if (contentEl) {
        // ä½¿ç”¨æ­£åˆ™å°† ã€ã€‘ å’Œ ã€Œã€ è½¬æ¢ä¸ºé»‘ç™½æ ‡æ³¨æ ·å¼
        contentEl.innerHTML = m.content
            .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
            .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>');
    }

    // 2. å¡«å……å°é¢å›¾
    if (imgEl) {
        imgEl.src = m.img;
        imgEl.alt = ""; // ğŸš¨ æ¸…ç©º alt æ–‡æœ¬ï¼Œé˜²æ­¢æ˜¾ç¤ºâ€œsceneâ€å­—æ ·
        
        // å¦‚æœæ•°æ®é‡Œçš„å›¾ç‰‡åäº†ï¼Œè‡ªåŠ¨æ‹¿å½“å‰èŠå¤©å¯¹è±¡çš„å¤´åƒè¡¥ä½
        imgEl.onerror = function() {
            this.src = window.currentChattingWith.avatar;
        };
    }

    // 3. æ‰§è¡ŒåŠ¨ç”»
    modal.style.display = 'flex';
    modal.classList.add('active');
    
    const scroller = modal.querySelector('.cinema-scroll-layer');
    if (scroller) scroller.scrollTop = 0;
};

// 2. ç‰©ç†å…³é—­è¯¦æƒ…é¡µ
window.closeCinemaMemory = function() {
    const modal = document.getElementById('modal-memory-cinema');
    if (modal) {
        modal.classList.remove('active');
        // ç­‰åŠ¨ç”»ç»“æŸåå½»åº•éšè—
        setTimeout(() => {
            modal.style.display = 'none';
        }, 500);
    }
};

    // ğŸš¨ å¿…é¡»æ”¾åœ¨ <script> æ ‡ç­¾çš„æœ€é¡¶éƒ¨ï¼Œä¸è¦æ”¾åœ¨ä»»ä½• function å†…éƒ¨ï¼
var currentUploaderTarget = 'chat'; 
var tempBgData = {
    chat: { type: 'img', data: null },
    settings: { type: 'img', data: null }
};

var tempCharProfileData = { id: null, avatar: null };

// ... å‰©ä¸‹çš„å…¶ä»–ä»£ç  ...
    // --- 1. å…¨å±€å˜é‡å­˜å‚¨è½¬å‘æ•°æ® ---
window.pendingForwardData = []; 
window.forwardTabMode = 'friends';
    var currentQuoteData = null; // å­˜å‚¨å½“å‰å¼•ç”¨çš„æ•°æ®

function cancelQuote() {
    window.currentQuoteData = null;
    const preview = document.getElementById('quote-preview');
    if (preview) preview.style.display = 'none';
}
    // --- ğŸš¨ ç‰©ç†ç½®é¡¶ï¼šå…¨å±€æ“ä½œå˜é‡ ---
var currentActiveBubble = null;
    // ç¡®ä¿è¿™ä¸€è¡Œåœ¨æ‰€æœ‰å‡½æ•°ï¼ˆå¦‚ initChatMsgPanelï¼‰çš„ä¸Šæ–¹
var isMsgPanelRendering = false;
    // åœ¨ script è„šæœ¬å¼€å¤´æ·»åŠ 
window.chatListMode = 'friends';
   // ==========================================
// ğŸš€ å­—ä½“ä¸æ˜¾ç¤ºï¼šç»ˆæé€»è¾‘è¡¥ä¸ (è§£å†³ undefined æŠ¥é”™)
// ==========================================

// 1. åˆå§‹åŒ–é…ç½® (æ”¾åœ¨ script æœ€å‰é¢)
window.currentFontConfig = JSON.parse(localStorage.getItem('ios_font_config')) || {
    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
    size: 16,
    weight: 400,
    colorMain: '#1d1d1f',
    colorDesktop: '#1d1d1f'
};

// 2. å®æ—¶é¢„è§ˆæ›´æ–° (ä¿®å¤ "is not a function" çš„æ ¸å¿ƒ)
window.updateFontPreview = function(type, val) {
    if(type === 'size') {
        window.currentFontConfig.size = val;
        const sd = document.getElementById('size-display');
        if(sd) sd.textContent = val + 'px';
    } else if(type === 'weight') {
        window.currentFontConfig.weight = val;
        const wd = document.getElementById('weight-display');
        if(wd) wd.textContent = val;
    }
    // æ¯æ¬¡æ»‘åŠ¨ï¼Œåªåˆ·æ–°ä¸Šé¢çš„é¢„è§ˆç›’å­ï¼Œä¸åˆ·æ–°æ¡Œé¢é˜²æ­¢å¡é¡¿
    window.updateFontUI();
};

// 3. UI ç•Œé¢åŒæ­¥
window.updateFontUI = function() {
    const pMain = document.getElementById('preview-text-main');
    const pDesk = document.getElementById('preview-text-desktop');
    const cfg = window.currentFontConfig;
    
    // ç”Ÿæˆé¢„è§ˆæ ·å¼
    const fontBase = `font-family:${cfg.family}; font-size:${cfg.size}px; font-weight:${cfg.weight};`;

    if(pMain) pMain.style.cssText = fontBase + `color:${cfg.colorMain}; text-align:center;`;
    if(pDesk) pDesk.style.cssText = fontBase + `color:${cfg.colorDesktop}; text-align:center; text-shadow:0 1px 2px rgba(0,0,0,0.2);`;
    
    // åŒæ­¥è°ƒè‰²ç›˜æ–‡å­—
    if(document.getElementById('color-val-main')) document.getElementById('color-val-main').textContent = cfg.colorMain.toUpperCase();
    if(document.getElementById('color-val-desktop')) document.getElementById('color-val-desktop').textContent = cfg.colorDesktop.toUpperCase();
};

// 4. é¢œè‰²å˜åŠ¨å®æ—¶è§¦å‘
window.updateColorPreview = function(target, val) {
    if(target === 'main') window.currentFontConfig.colorMain = val;
    else window.currentFontConfig.colorDesktop = val;
    window.updateFontUI();
};

// 5. ä¿å­˜å¹¶åº”ç”¨åˆ°å…¨å±€ (åªæ”¹çš®è‚¤ï¼Œä¸æ”¹åœ°åŸº)
window.saveFontSettings = function() {
    localStorage.setItem('ios_font_config', JSON.stringify(window.currentFontConfig));
    window.applyGlobalStyles(); // åº”ç”¨åˆ°å…¨å±€é’©å­
    showToast("Display Settings Applied!");
    closeSubPage('subpage-display');
};

// 6. å…¨å±€æ ·å¼é’©å­ (ä¿æŠ¤æ¡Œé¢å¸ƒå±€çš„æ ¸å¿ƒ)
window.applyGlobalStyles = function() {
    const target = document.body; // æŠŠå˜é‡æŒ‚åœ¨ body ä¸Š
    const cfg = window.currentFontConfig;
    
    target.style.setProperty('--dynamic-font-family', cfg.family);
    target.style.setProperty('--dynamic-app-size', cfg.size + 'px');
    target.style.setProperty('--dynamic-app-weight', cfg.weight);
    target.style.setProperty('--dynamic-app-color', cfg.colorMain);
    target.style.setProperty('--dynamic-desktop-color', cfg.colorDesktop);
};

// 7. è¿›å…¥é¡µé¢æ—¶çš„åŠ è½½é€»è¾‘
window.loadFontSettings = function() {
    const cfg = window.currentFontConfig;
    // åŒæ­¥è°ƒè‰²ç›˜
    if(document.getElementById('color-picker-main')) document.getElementById('color-picker-main').value = cfg.colorMain;
    if(document.getElementById('color-picker-desktop')) document.getElementById('color-picker-desktop').value = cfg.colorDesktop;
    // åŒæ­¥æ»‘åŠ¨æ¡
    const fs = document.getElementById('font-size-slider');
    const fw = document.getElementById('font-weight-slider');
    if(fs) { fs.value = cfg.size; updateSliderFill(fs); }
    if(fw) { fw.value = cfg.weight; updateSliderFill(fw); }
    
    window.updateFontUI();
};
// 1. ç¡®ä¿å…¨å±€å˜é‡é¦–å…ˆè¢«åˆå§‹åŒ–
window.currentFontConfig = JSON.parse(localStorage.getItem('ios_font_config')) || {
    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
    size: 16,
    weight: 400,
    colorMain: '#1d1d1f',
    colorDesktop: '#1d1d1f'
};

// 2. è¡¥å…¨ç¼ºå¤±çš„ openFontPicker å‡½æ•°
window.openFontPicker = function() {
    const list = document.getElementById('model-sheet-list');
    const sheet = document.getElementById('modelPickerSheet');
    const title = document.querySelector('.sheet-title-box');
    
    if(!list || !sheet) return;

    title.textContent = "Select Font Style";
    list.innerHTML = `
        <div class="sheet-item" onclick="window.selectFont('default')">System Default</div>
        <div class="sheet-item" style="font-family: serif;" onclick="window.selectFont('serif')">Serif (Classic)</div>
        <div class="sheet-item" style="font-family: monospace;" onclick="window.selectFont('mono')">Monospace (Code)</div>
    `;
    sheet.style.display = 'flex';
};

window.selectFont = function(type) {
    if(type === 'default') window.currentFontConfig.family = '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif';
    else if(type === 'serif') window.currentFontConfig.family = '"Times New Roman", Times, serif';
    else if(type === 'mono') window.currentFontConfig.family = '"Courier New", Courier, monospace';
    
    window.updateFontUI();
    document.getElementById('modelPickerSheet').style.display = 'none';
};

// 3. è¡¥å…¨ handleFontUpload å‡½æ•°
window.handleFontUpload = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        showToast("Importing Font...");
        reader.onload = function(e) {
            const fontData = e.target.result;
            const customFont = new FontFace('UserFont', `url(${fontData})`);
            customFont.load().then(f => {
                document.fonts.add(f);
                window.currentFontConfig.family = 'UserFont, sans-serif';
                window.currentFontConfig.fontDataUrl = fontData;
                window.updateFontUI();
                showToast("Font Loaded!");
            });
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åº”ç”¨ä¸€æ¬¡é¢œè‰²
window.applyGlobalStyles();

// ä½¿ç”¨ window ç¡®ä¿å…¨å±€å¯è§
window.currentEditingField = "";

// --- 1. ç»Ÿä¸€ ID æ˜ å°„å‡½æ•° (ç¡®ä¿ç²¾å‡†å®šä½) ---
window.getHubElementId = function(field) {
    if (field === 'hero') return 'hub-hero-img';
    if (field === 'moment_img') return 'hub-moment-img';
    if (field === 'vibe_img') return 'hub-vibe-img'; // ä¸º Row 5 å‡†å¤‡
    
    // å¤„ç† app å›¾æ ‡å’Œåå­—
    if (field.startsWith('app')) {
        const num = field.match(/\d+/)[0];
        return field.includes('img') ? `hub-app-img-${num}` : `hub-app-name-${num}`;
    }
    
    // å¤„ç†æ™®é€šæ–‡å­—: moment_title -> hub-moment-title
    return 'hub-' + field.replace(/_/g, '-');
};

// --- 2. æ‰“å¼€ç¼–è¾‘å™¨ (ä¿®å¤äº†å›¾ç‰‡è¯†åˆ«é€»è¾‘) ---
window.editHubField = function(field) {
    console.log("å½“å‰ç‚¹å‡»å­—æ®µ:", field); // è°ƒè¯•ç”¨ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹æœ‰æ²¡æœ‰ç‚¹å¯¹
    window.currentEditingField = field;
    
    const modal = document.getElementById('p2-editor-modal');
    const titleEl = document.getElementById('p2-editor-title');
    const inputEl = document.getElementById('p2-main-input');
    const uploadArea = document.getElementById('p2-upload-area');

    if (!modal) return;
    modal.style.display = 'flex';

    // === æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¼ºåˆ¶å›¾ç‰‡ç™½åå• ===
    // åªè¦å­—æ®µåæ˜¯ heroï¼Œæˆ–è€…åŒ…å« 'img'ï¼Œå°±å¼ºåˆ¶åˆ¤å®šä¸ºå›¾ç‰‡
    const isImageField = (field === 'hero') || (field.indexOf('img') !== -1);

    if (isImageField) {
        // --- å›¾ç‰‡æ¨¡å¼ ---
        titleEl.textContent = "æ›´æ¢å›¾ç‰‡ (URLæˆ–ä¸Šä¼ )";
        if (uploadArea) uploadArea.style.display = 'block';
        if (inputEl) {
            inputEl.placeholder = "ç²˜è´´å›¾ç‰‡é“¾æ¥...";
            inputEl.value = ""; // å›¾ç‰‡æ¨¡å¼ä¸‹æ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢è¯¯æ˜¾ç¤ºBase64ä»£ç 
        }
    } else {
        // --- æ–‡å­—æ¨¡å¼ ---
        titleEl.textContent = "ä¿®æ”¹æ–‡å­—å†…å®¹";
        if (uploadArea) uploadArea.style.display = 'none';
        
        // è·å–å½“å‰æ–‡å­—å¹¶å›å¡«
        let currentText = "";
        const targetId = window.getHubElementId(field);
        const targetEl = document.getElementById(targetId);
        if (targetEl) {
            currentText = targetEl.textContent.replace(/"/g, ''); 
        }
        if (inputEl) {
            inputEl.value = currentText;
            inputEl.placeholder = "è¾“å…¥æ–°å†…å®¹...";
        }
    }
};

// --- 3. åº”ç”¨ä¿®æ”¹ ---
window.applyP2Changes = function(field, value) {
    if (!value) return;

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    try {
        localStorage.setItem(`hub_p2_${field}`, value);
    } catch (e) {
        // å¦‚æœå›¾ç‰‡æ˜¯ Base64 ä¸”å¤ªå¤§ï¼Œä¼šè§¦å‘è¿™ä¸ªé”™è¯¯
        console.error("å­˜å‚¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡ä½“ç§¯è¿‡å¤§:", e);
        if (field.indexOf('img') !== -1) {
            alert("ä¿å­˜å¤±è´¥ï¼šå›¾ç‰‡ä½“ç§¯è¶…è¿‡æµè§ˆå™¨é™åˆ¶ï¼Œè¯·å°è¯•ä½¿ç”¨å›¾ç‰‡é“¾æ¥(URL)ã€‚");
            return;
        }
    }

    // åŒæ­¥åˆ°é¡µé¢ DOM
    const targetId = window.getHubElementId(field);
    const el = document.getElementById(targetId);

    if (el) {
        const isImage = field === 'hero' || field.indexOf('img') !== -1;
        if (isImage) {
            el.src = value;
        } else {
            el.textContent = (field.indexOf('desc') !== -1) ? `"${value}"` : value;
        }
    }
};

// --- 4. åˆå§‹åŒ– ---
const P2_PERSIST_FIELDS = [
    'hero', 'hero_tag', 'hero_title', 'hero_desc',           // Row 1-2
    'moment_img', 'moment_title', 'moment_desc',           // Row 3-4 Card
    'vibe_img', 'vibe_text',                                // Row 5 Bar
    'app3_img', 'app3_name', 'app4_img', 'app4_name',       // Row 3-4 Apps
    'app5_img', 'app5_name', 'app6_img', 'app6_name',       // Row 3-4 Apps
    'app7_img', 'app7_name', 'app8_img', 'app8_name'        // Row 6 Apps
];

// --- 2. é¡µé¢åŠ è½½åˆå§‹åŒ–ï¼šä»æœ¬åœ°å­˜å‚¨è¿˜åŸå†…å®¹ ---
window.initP2Data = function() {
    console.log("æ­£åœ¨åŒæ­¥ç¬¬äºŒé¡µæ•°æ®...");
    
    P2_PERSIST_FIELDS.forEach(field => {
        const savedValue = localStorage.getItem(`hub_p2_${field}`);
        
        if (savedValue) {
            // è·å–å¯¹åº”çš„ HTML å…ƒç´  ID
            const targetId = window.getHubElementId(field);
            const el = document.getElementById(targetId);
            
            if (el) {
                // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡å­—å¹¶è¿˜åŸ
                const isImage = field === 'hero' || field.indexOf('img') !== -1;
                if (isImage) {
                    el.src = savedValue;
                } else {
                    // å¦‚æœæ˜¯æè¿°ç±»æ–‡å­—ï¼Œè‡ªåŠ¨è¡¥ä¸Šå¼•å·
                    el.textContent = (field.indexOf('desc') !== -1) ? `"${savedValue}"` : savedValue;
                }
            }
        }
    });
};

// å¼¹çª—å…³é—­ä¸æ–‡ä»¶å¤„ç†é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
window.closeP2Editor = function() {
    const val = document.getElementById('p2-main-input').value;
    if (val) window.applyP2Changes(window.currentEditingField, val);
    document.getElementById('p2-editor-modal').style.display = 'none';
};
window.handleP2File = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            window.applyP2Changes(window.currentEditingField, e.target.result);
            document.getElementById('p2-editor-modal').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
};
document.addEventListener('DOMContentLoaded', window.initP2Data);

    let tempImg = null;       
    let tempVid = null;       
    let tempVidThumb = null;

    let editingCharId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘/æŸ¥çœ‹çš„è§’è‰²ID
    let tempCharAvatar = null; // æš‚å­˜å¤´åƒ
    
// === 0. æ•°æ®åº“å·¥å…· (è§£å†³è§†é¢‘æ— æ³•ä¿å­˜çš„é—®é¢˜) ===
const storeName = "wallpapers";

/**
 * ğŸ›°ï¸ è¾…åŠ©ï¼šä¿å­˜å•æ¡æ¶ˆæ¯ (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šç‰©ç†è¿½åŠ ä¸€æ¡æ¶ˆæ¯åˆ°æŒ‡å®šè”ç³»äººçš„å†å²è®°å½•ä¸­
 */
async function saveChatMessage(contactId, msgObj) {
    // 1. ğŸ’¡ å®šä¹‰å­˜å‚¨ Key
    const historyKey = "chat_history_" + contactId;

    try {
        // 2. ğŸ” ä»æ–°åº“è·å–ç°æœ‰è®°å½• (getItem ä¼šç›´æ¥è¿”å›è§£æå¥½çš„å¯¹è±¡æˆ– undefined)
        let record = await window.ib.getItem(historyKey);

        // 3. å¦‚æœåŸæœ¬æ²¡è®°å½•ï¼Œåˆå§‹åŒ–ä¸€ä¸ªéª¨æ¶
        if (!record) {
            record = { id: contactId, contactId: contactId, messages: [] };
        }

        // 4. âœ… ç‰©ç†è¿½åŠ æ¶ˆæ¯
        record.messages.push(msgObj);

        // 5. ğŸ’¾ å­˜å›æ–°åº“ (setItem å†…éƒ¨å·²å¤„ç†äº‹åŠ¡)
        return await window.ib.setItem(historyKey, record);

    } catch (err) {
        console.error("[Database] æ¶ˆæ¯å­˜å‚¨å¤±è´¥:", err);
        // å¦‚æœå­˜å‚¨å¤±è´¥ (æ¯”å¦‚ DataCloneError)ï¼Œé€šå¸¸æ˜¯å› ä¸º msgObj åŒ…å«äº†æ— æ³•å…‹éš†çš„æ•°æ®
        throw err;
    }
}

/**
 * ğŸ›°ï¸ æ ¸å¿ƒä¿®å¤ï¼šè·å–èŠå¤©å†å² (å·²é€‚é…æ–°åº“)
 * ä½œç”¨ï¼šç¡®ä¿è¿”å›çš„æ˜¯æ¶ˆæ¯æ•°ç»„ï¼Œè€Œä¸æ˜¯æ•°æ®åº“åŸå§‹å¯¹è±¡
 */
async function getChatHistory(contactId) {
    const historyKey = "chat_history_" + contactId;
    
    try {
        // ä½¿ç”¨æ–°åº“è·å–æ•°æ®
        const record = await window.ib.getItem(historyKey);
        
        // ğŸ’¡ é€»è¾‘åŒæ­¥ï¼šå¦‚æœæœ‰ç»“æœä¸”æœ‰ .messagesï¼Œè¿”å›æ•°ç»„ï¼Œå¦åˆ™è¿”å›ç©ºæ•°ç»„
        if (record && record.messages) {
            return record.messages;
        }
        return [];
    } catch (err) {
        console.error("è·å–å†å²å¤±è´¥:", err);
        return [];
    }
}

/**
 * ğŸ›°ï¸ æ ¸å¿ƒä¿®å¤ï¼šé€šç”¨ä¿å­˜å‡½æ•° (å·²é€‚é…æ–°åº“)
 */
async function saveToDB(key, data) {
    // ğŸ’¡ æ–°åº“ setItem ç›´æ¥æ¥æ”¶ (key, value)
    // ä¸å†éœ€è¦åŒ…è£…æˆ { id: key, data: data }ï¼Œå› ä¸ºæ–°åº“åº•å±‚ä¼šè‡ªåŠ¨å¤„ç† key
    return await window.ib.setItem(key, data);
}

/**
 * ğŸ›°ï¸ æ ¸å¿ƒä¿®å¤ï¼šé€šç”¨è¯»å–å‡½æ•° (å·²é€‚é…æ–°åº“)
 */
async function loadFromDB(key) {
    // ğŸ’¡ ç›´æ¥è¿”å› getItem çš„ç»“æœ
    // åŸæœ¬çš„ (req.result ? req.result.data : null) é€»è¾‘å·²è¢«æ–°åº“å†…ç½®ç®€åŒ–
    const result = await window.ib.getItem(key);
    return result !== undefined ? result : null;
}


    // === ä¿®å¤é‡ç‚¹3ï¼šæ•°æ®æŒä¹…åŒ– (åˆ·æ–°ä¸ä¸¢å¤±) ===
    async function loadSavedData() {
        // 1. åŠ è½½æ¡Œé¢å°ç»„ä»¶æ•°æ® (å›¾ç‰‡ã€é‡‘å¥ã€åŸå¸‚) - ä» localStorage
        const sImg = localStorage.getItem('ios_img');
        const sQuote = localStorage.getItem('ios_quote');
        const sCity = localStorage.getItem('ios_city');

        if(sImg) document.getElementById('ui-img').src = sImg;
        if(sQuote) document.getElementById('ui-quote').textContent = `"${sQuote}"`;
        
        if(sCity) {
            const c = JSON.parse(sCity);
            fetchW(c.lat, c.lon, c.name);
        } else {
            fetchW(40.7829, -73.9654, 'New York');
        }

        // 2. åŠ è½½å£çº¸æ•°æ® - ä» IndexedDB (å¤§æ–‡ä»¶å­˜å‚¨)
        const wType = localStorage.getItem('user_wall_type');
        const wData = await loadFromDB('current_wall_data');
        
        if(wType && wData) {
            const bgVid = document.getElementById('bg-video');

            if(wType === 'img') {
                // åº”ç”¨å›¾ç‰‡å£çº¸
                document.body.style.background = `url(${wData}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                // ç¡®ä¿è§†é¢‘å±‚éšè—
                if(bgVid) { 
                    bgVid.style.display = 'none'; 
                    bgVid.src = ""; 
                }
            } else if(wType === 'vid') {
                // åº”ç”¨è§†é¢‘å£çº¸
                if(bgVid) {
                    bgVid.src = wData;
                    bgVid.style.display = 'block';
                    bgVid.play().catch(e => console.log("Auto-play blocked"));
                }
            }
        }
        
        // 3. åŠ è½½å£çº¸å†å²è®°å½•åˆ—è¡¨
        renderHistory();
        await initCharApp();
        await initWorldApp();
        applyBackgroundsToUI();
        // ğŸ‘‡ åŠ åœ¨è¿™é‡Œ
        await initMomentsStories(); // åŠ è½½ä¸Šæ–¹é™æ—¶åŠ¨æ€
        await initMomentsFeed();    // ğŸ”¥ åŠ è½½ä¸‹æ–¹å‘å¸ƒçš„å¸–å­
    }

    // ==========================================
    // 3. æ ¸å¿ƒåŠŸèƒ½: æ—¶é—´ (å…¨å±€æ—¶åŒºé‡å†™ç‰ˆ)
    // ==========================================
    
    // æ‰“å¼€å­é¡µé¢é€šç”¨å‡½æ•°
// ğŸš¨ å¼ºåŠ›ä¿®æ­£ï¼šè§£å†³å­é¡µé¢å…³é—­åæ— æ³•å†æ¬¡å¼€å¯çš„é—®é¢˜
function openSubPage(id) {
    const el = document.getElementById(id);
    if(el) {
        // ç¬¬ä¸€æ­¥ï¼šç‰©ç†æ˜¾å½¢ï¼ˆå¿…é¡»å…ˆ flexï¼ŒåŠ¨ç”»æ‰èƒ½ç”Ÿæ•ˆï¼‰
        el.style.display = 'flex'; 
        
        // ç¬¬äºŒæ­¥ï¼šè§¦å‘æ»‘å…¥åŠ¨ç”»ï¼ˆå»¶è¿Ÿä¸€ä¸ç‚¹ç¡®ä¿æµè§ˆå™¨æ•è·åˆ° display å˜åŒ–ï¼‰
        setTimeout(() => {
            el.classList.add('active');
        }, 10);

        // å¦‚æœæ˜¯æ—¶åŒºé¡µï¼Œé¡ºä¾¿æ›´æ–°ä¸€ä¸‹å‹¾é€‰çŠ¶æ€
        if(id === 'subpage-timezone' && typeof updateTimezoneCheckmarks === 'function') {
            updateTimezoneCheckmarks();
        }
        console.log(`System: ç‰©ç†é“¾è·¯å·²æ¥é€š -> ${id}`);
    } else {
        console.error("æ‰¾ä¸åˆ°å­é¡µé¢:", id);
    }
}

// å…³é—­å­é¡µé¢
function closeSubPage(id) {
    const el = document.getElementById(id);
    if(el) el.classList.remove('active');
}

    // è®¾ç½®æ—¶åŒº
    function setTimezone(tzVal, cityName) {
        if(tzVal === '') {
            localStorage.removeItem('user_timezone');
            localStorage.removeItem('user_city_name');
            document.getElementById('val-timezone').textContent = "Automatic";
        } else {
            localStorage.setItem('user_timezone', tzVal);
            localStorage.setItem('user_city_name', cityName);
            document.getElementById('val-timezone').textContent = cityName;
        }
        
        // ç«‹å³åˆ·æ–°æ—¶é—´æ˜¾ç¤º
        tick();
        
        // è§†è§‰åé¦ˆ
        updateTimezoneCheckmarks();
        setTimeout(() => closeSubPage('subpage-timezone'), 200); // é€‰å®Œè‡ªåŠ¨è¿”å›ï¼Œä½“éªŒæ›´å¥½
    }

    // æ›´æ–°åˆ—è¡¨å‹¾é€‰çŠ¶æ€
    function updateTimezoneCheckmarks() {
        // æ¸…é™¤æ‰€æœ‰å‹¾
        document.querySelectorAll('.item-check').forEach(el => el.classList.remove('active'));
        
        const currentTz = localStorage.getItem('user_timezone');
        if(!currentTz) {
            document.getElementById('check-auto').classList.add('active');
        } else {
            // IDé‡Œå¯èƒ½æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨ getElementById éœ€è¦è½¬ä¹‰ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼š
            // å› ä¸ºæˆ‘çš„ ID æ˜¯ check-Asia/Shanghai è¿™ç§æ ¼å¼
            const target = document.getElementById('check-' + currentTz);
            if(target) target.classList.add('active');
        }
    }

    // â° æ ¸å¿ƒæ—¶é—´å‡½æ•° (æ”¯æŒæ—¶åŒº) â°
    function tick() {
        const tz = localStorage.getItem('user_timezone'); // è·å–å­˜å‚¨çš„æ—¶åŒº
        const now = new Date();
        
        // 1. è·å–æ—¶é—´å­—ç¬¦ä¸²
        let timeString;
        try {
            // ä½¿ç”¨ Intl API è½¬æ¢æ—¶åŒº
            timeString = now.toLocaleTimeString('en-GB', {
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false,
                timeZone: tz || undefined // å¦‚æœ tz ä¸ºç©ºï¼Œå°±ç”¨ç³»ç»Ÿé»˜è®¤
            });
        } catch(e) {
            // å…œåº•ï¼šå¦‚æœæ—¶åŒºæ ¼å¼ä¸å¯¹ï¼Œå›é€€åˆ°æœ¬åœ°æ—¶é—´
            timeString = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
        }

        document.getElementById('clock').textContent = timeString;

        // 2. æ—¥æœŸæ˜¾ç¤º (ä¹Ÿéœ€è¦æ ¹æ®æ—¶åŒºå˜)
        const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
        const months = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
        
        // ä¸ºäº†è·å–æ­£ç¡®çš„æ—¥æœŸï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨è¯¥æ—¶åŒºä¸‹çš„ Date å¯¹è±¡æ¦‚å¿µ
        // è¿™é‡Œç”¨ç®€å•çš„ toLocaleDateString è½¬æ¢
        const dateOptions = { weekday: 'long', month: 'long', day: 'numeric', timeZone: tz || undefined };
        const dateStrParts = now.toLocaleDateString('en-US', dateOptions).toUpperCase().split(', ');
        // dateStrParts å¤§æ¦‚æ˜¯ ["SUNDAY", "JANUARY 1"] è¿™ç§æ ¼å¼
        
        if(dateStrParts.length >= 2) {
            document.getElementById('ui-day').textContent = dateStrParts[0]; // æ˜ŸæœŸ
            // å‰©ä¸‹çš„éƒ¨åˆ†å»æ‰å¹´ä»½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            let datePart = dateStrParts[1]; 
            document.getElementById('ui-date').textContent = datePart;
        }

        // 3. è¿›åº¦æ¡ (æ ¹æ®å°æ—¶è®¡ç®—)
        // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è§£æåˆšåˆšç”Ÿæˆçš„ timeString (HH:MM)
        const [hh, mm] = timeString.split(':').map(Number);
        const totalSec = hh * 3600 + mm * 60 + now.getSeconds();
        const percent = (totalSec / 86400) * 100;
        
        const bar = document.getElementById('prog-bar');
        if(bar) {
            bar.style.width = percent + '%';
            if(percent < 1) bar.style.minWidth = '2%';
        }
        const txt = document.getElementById('prog-txt');
        if(txt) txt.textContent = percent.toFixed(1) + '%';
        
        // åˆå§‹åŒ–æ—¶æ›´æ–°è®¾ç½®é¡µçš„æ–‡å­—çŠ¶æ€
        const savedCity = localStorage.getItem('user_city_name');
        const valTz = document.getElementById('val-timezone');
        if(valTz) valTz.textContent = savedCity || "Automatic";
    }

    async function initBat() {
        const batNum = document.getElementById('bat-num');
        const batBar = document.getElementById('bat-bar');

        // 1. ã€å¼ºåˆ¶å…œåº•ã€‘ï¼šå…ˆæŠŠæ•°å­—å¡«ä¸Šå»ï¼Œä¿è¯ç»å¯¹æœ‰æ˜¾ç¤ºï¼
        batNum.textContent = '100%'; 
        batBar.style.width = '100%';
        batBar.style.background = '#1d1d1f'; // é»˜è®¤é»‘è‰²

        // 2. å°è¯•è·å–çœŸå®ç”µé‡ (ä»…å®‰å“/PCæœ‰æ•ˆ)
        if ('getBattery' in navigator) {
            try {
                const bat = await navigator.getBattery();
                
                const update = () => {
                    const level = Math.round(bat.level * 100);
                    batNum.textContent = level + '%';
                    batBar.style.width = level + '%';
                    
                    if(bat.charging) {
                        batBar.style.background = '#34C759'; // å……ç”µç»¿
                    } else if(level <= 20) {
                        batBar.style.background = '#FF3B30'; // ä½ç”µé‡çº¢
                    } else {
                        batBar.style.background = '#1d1d1f'; // æ­£å¸¸é»‘
                    }
                };
                
                update();
                bat.addEventListener('levelchange', update);
                bat.addEventListener('chargingchange', update);
            } catch (e) {
                // å¦‚æœæŠ¥é”™ï¼Œæ²¡å…³ç³»ï¼Œåæ­£ç¬¬1æ­¥å·²ç»å¡«äº† 100%
                console.log("ç”µé‡APIå—é™ï¼Œä¿æŒå…œåº•æ˜¾ç¤º");
            }
        }
    }

    const ICONS = {
        sun: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSun" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient></defs><circle cx="32" cy="32" r="18" fill="url(#gSun)"/><circle cx="32" cy="32" r="24" fill="none" stroke="#FFD700" stroke-width="2" opacity="0.4"/></svg>`,
        moon: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gMoon" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#E0E0E0"/><stop offset="100%" stop-color="#BDBDBD"/></linearGradient></defs><path d="M48 32c0 11-9 20-20 20-2.5 0-4.8-.5-7-1.3 2.5-1.5 5.5-2.7 8-5.7 6-7 4-18-2-22-2.3-1.5-5-2.2-7.7-2.3C22.6 14.5 27 12 32 12c11 0 16 9 16 20z" fill="url(#gMoon)"/></svg>`,
        partly: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSunS" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient><linearGradient id="gCloud" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#d9d9d9"/></linearGradient></defs><circle cx="24" cy="24" r="14" fill="url(#gSunS)"/><path d="M48 48H30c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5-3.5 15.8-12 15.8z" fill="url(#gCloud)" filter="drop-shadow(0 2px 3px rgba(0,0,0,0.2))"/></svg>`,
        cloud: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gCloudF" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#c0c0c0"/></linearGradient></defs><path d="M46 44H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gCloudF)" filter="drop-shadow(0 4px 6px rgba(0,0,0,0.1))"/></svg>`,
        rain: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gRain" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#cfd9df"/><stop offset="100%" stop-color="#a1c4fd"/></linearGradient></defs><path d="M46 40H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gRain)"/><path d="M22 46l-3 9M32 46l-3 9M42 46l-3 9" stroke="#4facfe" stroke-width="3" stroke-linecap="round"/></svg>`
    };
    
    async function fetchW(lat,lon,name) {
        document.getElementById('ui-city').textContent = name;
        hideM('weatherM');
        localStorage.setItem('ios_city', JSON.stringify({lat, lon, name})); // ä¿å­˜åŸå¸‚

        try {
            const tStamp = new Date().getTime();
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day&timezone=auto&_t=${tStamp}`);
            const data = await res.json();
            const current = data.current;
            const c = current.weather_code;
            const t = Math.round(current.temperature_2m);
            const isDay = current.is_day === 1;

            // --- ğŸš‘ æ–°å¢ï¼šåŒæ­¥åˆ°è®¾ç½®é¡µé¢çš„å¤©æ°”æ–‡å­— ---
            let weatherDesc = "æ™´";
            if (c >= 1 && c <= 2) weatherDesc = "å¤šäº‘";
            else if (c === 3 || (c >= 45 && c <= 48)) weatherDesc = "é˜´";
            else if (c > 3) weatherDesc = "æœ‰é›¨";

            const weatherStatusEl = document.getElementById('val-weather-text');
            if (weatherStatusEl) {
                weatherStatusEl.textContent = `${weatherDesc} ${t}Â°C`;
            }
            
            let icon = ICONS.sun;
            if (c === 0) icon = isDay ? ICONS.sun : ICONS.moon;
            else if (c >= 1 && c <= 2) icon = ICONS.partly;
            else if (c === 3 || (c >= 45 && c <= 48)) icon = ICONS.cloud;
            else icon = ICONS.rain;
            
            document.getElementById('ui-temp').textContent = t+'Â°';
            document.getElementById('ui-icon').innerHTML = icon;
        } catch(e) { document.getElementById('ui-city').textContent = "Offline"; }
    }

    function showM(id) { document.getElementById(id).style.display='flex'; }
    function hideM(id) { 
        document.getElementById(id).style.display='none'; 
        if(id==='photoM') {
            const v = document.getElementById('q-in').value;
            if(v) {
                document.getElementById('ui-quote').textContent = `"${v}"`;
                localStorage.setItem('ios_quote', v); // ä¿å­˜æ–‡å­—
            }
        }
    }
    
    function loadF(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const imgData = e.target.result;
                document.getElementById('ui-img').src = imgData;
                try {
                    localStorage.setItem('ios_img', imgData); // ä¿å­˜å›¾ç‰‡
                } catch(err) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œå»ºè®®ç”¨URL"); }
            };
            r.readAsDataURL(input.files[0]);
        }
    }
    
    function loadU() {
        const u = prompt("Paste Image URL:");
        if(u) {
            document.getElementById('ui-img').src = u;
            localStorage.setItem('ios_img', u); // ä¿å­˜å›¾ç‰‡URL
        }
    }

    // å¯åŠ¨
    setInterval(tick,1000); 
    loadSavedData(); // åŠ è½½æ‰€æœ‰ä¿å­˜çš„æ•°æ®
    initBat();

    // åˆ‡æ¢æ ‡ç­¾é¡µåŠŸèƒ½
function switchTab(tab) {
    // 1. å¤„ç†æŒ‰é’®æ ·å¼
    document.getElementById('tab-cn').classList.remove('active');
    document.getElementById('tab-global').classList.remove('active');
    document.getElementById('tab-' + tab).classList.add('active');

    // 2. å¤„ç†å†…å®¹æ˜¾ç¤º
    document.getElementById('view-cn').classList.remove('active');
    document.getElementById('view-global').classList.remove('active');
    document.getElementById('view-' + tab).classList.add('active');
}

// === å£çº¸ App å¢å¼ºç‰ˆé€»è¾‘ ===
    
    // åˆå§‹åŒ–æ—¶åŠ è½½å†å²
    setTimeout(renderHistory, 500);

    /**
 * ğŸš€ å…¨å±€ App å¯åŠ¨å™¨
 * æ•´åˆäº†ï¼šID æ˜ å°„ã€è‡ªåŠ¨å®¹é”™ã€åŠ¨ç”»é‡ç»˜ã€ä»¥åŠéŸ³ä¹ App çš„æŒä¹…åŒ–åˆå§‹åŒ–
 */
function openApp(appId) {
    console.log("Attempting to open app:", appId);
    
    // 1. ID æ˜ å°„è¡¨ï¼šè§£å†³ HTML ä¸­ ID å‘½åä¸ç»Ÿä¸€ï¼ˆé©¼å³° vs è¿å­—ç¬¦ï¼‰çš„é—®é¢˜
    const idMap = {
        'musicApp': 'page-musicApp',
        'wallApp': 'page-wall-app',      
        'settingsApp': 'page-settings',   
        'safariApp': 'page-safari'
    };

    // 2. ç¡®å®šç›®æ ‡ IDï¼Œä¼˜å…ˆä½¿ç”¨æ˜ å°„è¡¨ï¼Œæ‰¾ä¸åˆ°åˆ™æŒ‰é»˜è®¤ page- å‰ç¼€æ‹¼æ¥
    const pageId = idMap[appId] || ('page-' + appId);
    const appElement = document.getElementById(pageId);
    
    if (!appElement) {
        // 3. æ™ºèƒ½å®¹é”™ï¼šå¦‚æœä¾ç„¶æ‰¾ä¸åˆ°ï¼Œå°è¯•éå†å‡ ç§å¸¸è§çš„å‘½åç»„åˆ
        const fallbackIds = [
            'page-' + appId.toLowerCase(), 
            appId, 
            'page-' + appId.replace('App', '')
        ];
        
        for (let fid of fallbackIds) {
            let el = document.getElementById(fid);
            if (el) {
                console.log("ğŸ’¡ æ‰¾åˆ°å¤‡é€‰å®¹å™¨:", fid);
                executeOpen(el, appId);
                return;
            }
        }
        
        console.error("âŒ ä¾ç„¶æ‰¾ä¸åˆ°é¡µé¢å®¹å™¨:", pageId);
        return; 
    }

    // 4. æ‰¾åˆ°å®¹å™¨åæ‰§è¡Œæ ‡å‡†æ‰“å¼€æµç¨‹
    executeOpen(appElement, appId);

    /**
     * æ ¸å¿ƒæ‰“å¼€æ‰§è¡Œé€»è¾‘
     */
    function executeOpen(el, id) {
        // A. è§†è§‰æ˜¾ç¤ºï¼šè®¾ç½® Flex å¹¶å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ä»¥ç¡®ä¿ transition åŠ¨ç”»ç”Ÿæ•ˆ
        el.style.display = 'flex';
        void el.offsetWidth; 
        el.classList.add('active');
        
        // B. éŸ³ä¹ App æ·±åº¦åˆå§‹åŒ–é’©å­
        if (id === 'musicApp') {
            // æ¸²æŸ“ Archive åˆ—è¡¨ï¼ˆç¡®ä¿æ•°æ®æœ€æ–°ï¼‰
            if (typeof renderMusicArchive === 'function') {
                renderMusicArchive();
            }
            
            // âœ¨ æ ¸å¿ƒè¡¥å…¨ï¼šä» IndexedDB åŠ è½½ä½ é€‰å®šçš„ CORE é¡µé¢è‡ªå®šä¹‰èƒŒæ™¯
            if (typeof loadPersistentCoreBg === 'function') {
                loadPersistentCoreBg();
            }
        }
        
        // C. åç»­å¯åœ¨æ­¤æ‰©å±•å…¶ä»– Appï¼ˆå¦‚ settingsAppï¼‰çš„ç‰¹æ®Šåˆå§‹åŒ–é€»è¾‘
        console.log(`âœ… App [${id}] launched successfully.`);
    }
}
    function closeApp(id) { document.getElementById(id).classList.remove('active'); }

    // 1. åˆ‡æ¢ Tab (ä¿®å¤é¢„è§ˆå›¾ä¹±è·‘çš„é—®é¢˜)
    function switchWallTab(type) {
        // æŒ‰é’®æ ·å¼åˆ‡æ¢
        document.getElementById('seg-img').classList.toggle('active', type==='img');
        document.getElementById('seg-vid').classList.toggle('active', type==='vid');
        
        // æ“ä½œé¢æ¿åˆ‡æ¢
        document.getElementById('panel-img').style.display = type==='img' ? 'flex' : 'none';
        document.getElementById('panel-vid').style.display = type==='vid' ? 'flex' : 'none';
        
        // é¢„è§ˆé€»è¾‘é‡å†™ï¼šåªæœ‰å½“æœ‰å†…å®¹æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼Œå¦åˆ™æ˜¾ç¤ºå ä½ç¬¦
        const imgEl = document.getElementById('preview-img');
        const vidEl = document.getElementById('preview-vid');
        const hintEl = document.getElementById('preview-hint');

        if(type === 'img') {
            vidEl.style.display = 'none'; // è—è§†é¢‘
            // å¦‚æœæœ‰æš‚å­˜å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼›å¦åˆ™æ˜¾ç¤ºæ–‡å­—
            if(tempImg) {
                imgEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Image";
            }
        } else {
            imgEl.style.display = 'none'; // è—å›¾ç‰‡
            // å¦‚æœæœ‰æš‚å­˜è§†é¢‘ï¼Œæ˜¾ç¤ºè§†é¢‘
            if(tempVid) {
                vidEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                vidEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Video";
            }
        }
    }

    // 2. ä¿å­˜å†å²è®°å½•
    saveToHistory(type, data);
    
    showNativeAlert("Wallpaper Set & Saved!");

    // 2. æ–‡ä»¶å¤„ç† (å…¼å®¹æ€§å¢å¼º)
    function handleWallFile(input, type) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            
            // è§†é¢‘å¤§å°é™åˆ¶ (é¿å…å¡æ­»)
            if(type === 'vid' && file.size > 20 * 1024 * 1024) { 
                showNativeAlert("Video too large! Max 20MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const res = e.target.result;
                if(type === 'img') {
                    tempImg = res;
                    document.getElementById('preview-img').src = res;
                } else {
                    tempVid = res;
                    document.getElementById('preview-vid').src = res;
                }
                // åŠ è½½å®Œç«‹åˆ»åˆ·æ–°é¢„è§ˆåŒºåŸŸ
                switchWallTab(type);
            };
            reader.readAsDataURL(file);
        }
    }

    // 3. è®¾ç½®å£çº¸ (è°ƒç”¨æ–°å¼¹çª— + å¼ºåˆ¶ä¿å­˜)
    // æ‰¾åˆ° setWallpaper å‡½æ•°ï¼Œå®Œå…¨æ›¿æ¢æˆè¿™ä¸ªï¼š
    // âœ… ä¿®å¤åçš„ setWallpaper å‡½æ•°
function setWallpaper(cType) {
    const bgVid = document.getElementById('bg-video');
    // cType æ˜¯ 'img' æˆ– 'vid'
    const data = (cType === 'img') ? tempImg : tempVid;

    if(!data) { 
        showNativeAlert("Please select a file first.");
        return; 
    }

    if(cType === 'img') {
        document.body.style.background = `url(${data}) no-repeat center center fixed`;
        document.body.style.backgroundSize = "cover";
        if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
        
        // ä¿å­˜é€»è¾‘å¿…é¡»åœ¨å‡½æ•°é‡Œé¢
        localStorage.setItem('user_wall_type', 'img');
        saveToDB('current_wall_data', data);
        
        // ä¿å­˜å†å²
        saveToHistory('img', data, data); 

    } else {
        if(bgVid) {
            bgVid.src = data;
            bgVid.style.display = 'block';
            bgVid.play();
        }
        
        localStorage.setItem('user_wall_type', 'vid');
        saveToDB('current_wall_data', data);
        
        // ä¿å­˜å†å²
        saveToHistory('vid', data, tempVidThumb || null); 
    }
    
    showNativeAlert("Wallpaper Set Successfully!");
}

    // 5. å¼¹çª—æ§åˆ¶å‡½æ•°
    function showNativeAlert(msg) {
        document.getElementById('alert-msg').textContent = msg;
        document.getElementById('successAlert').style.display = 'flex';
    }
    function closeAlert() {
        document.getElementById('successAlert').style.display = 'none';
    }

    // åˆå§‹åŒ–åŠ è½½å†å²
    setTimeout(renderHistory, 500);
    // ==========================================
    // ç¼ºå¤±çš„å·¥å…·å‡½æ•° (è¯·è¡¥åœ¨æœ€ä¸‹é¢)
    // ==========================================

    // 1. å¼¹çª—æç¤ºå·¥å…· (è§£å†³ showToast is not defined)
    function showToast(msg) {
        const t = document.getElementById('toast');
        if(t) {
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    }

    // 2. ä¿å­˜å†å²è®°å½•é€»è¾‘
    async function saveToHistory(type, data) {
        // å…ˆè¯»æ—§å†å²
        let history = await loadFromDB('history_list') || [];
        
        // æŸ¥é‡ï¼šå¦‚æœå·²ç»æœ‰äº†ï¼Œåˆ æ‰æ—§çš„
        history = history.filter(item => item.data !== data);
        
        // æ’å…¥æ–°çš„åˆ°æœ€å‰é¢
        history.unshift({ type: type, data: data });
        
        // é™åˆ¶ 6 ä¸ª
        if(history.length > 6) history.pop();
        
        // å­˜å…¥æ•°æ®åº“
        await saveToDB('history_list', history);
        
        // åˆ·æ–°æ˜¾ç¤º
        renderHistory();
    }

    // 3. æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
    // === æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨ (ä¿®å¤ type is not defined æŠ¥é”™) ===
    async function renderHistory() {
    const grid = document.getElementById('wall-history-grid');
    if(!grid) return;
    
    // ä»æ•°æ®åº“è¯»å£çº¸åˆ—è¡¨
    let history = await loadFromDB('history_list') || [];
    grid.innerHTML = ""; 

    history.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        
        let badge = '';
        let content = '';
        
        // æ¸²æŸ“è§†é¢‘æˆ–å›¾ç‰‡é¢„è§ˆ
        if(item.type === 'vid') {
            badge = `<div class="vid-badge">LIVE</div>`;
            // å¦‚æœæœ‰ç¼©ç•¥å›¾ç”¨ç¼©ç•¥å›¾ï¼Œæ²¡æœ‰å°±ç”¨è§†é¢‘é¢„è§ˆ
            if(item.thumb && item.thumb.startsWith('data:image')) {
                 content = `<img src="${item.thumb}" style="opacity:0.8;">`;
            } else {
                 content = `<video src="${item.data}" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; pointer-events:none;"></video>`;
            }
        } else {
            content = `<img src="${item.data}">`;
        }

        div.innerHTML = `${content}${badge}`;

        // ç‚¹å‡»åº”ç”¨å£çº¸çš„é€»è¾‘
        div.onclick = () => {
            if(item.type === 'img') {
                tempImg = item.data;
                document.getElementById('preview-img').src = item.data;
                document.body.style.background = `url(${item.data}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                const bgVid = document.getElementById('bg-video');
                if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
            } else {
                tempVid = item.data;
                document.getElementById('preview-vid').src = item.data;
                const bgVid = document.getElementById('bg-video');
                if(bgVid) {
                    bgVid.src = item.data;
                    bgVid.style.display = 'block';
                    bgVid.play();
                }
            }
            switchWallTab(item.type);
            localStorage.setItem('user_wall_type', item.type);
            saveToDB('current_wall_data', item.data);
            showToast("Restored!");
        };

        grid.appendChild(div);
    });
}

    // 4. åˆå§‹åŒ–åŠ è½½ä¸€æ¬¡å†å²
    setTimeout(renderHistory, 1000);

    // ==========================================
    // 8. è§’è‰²ä¹¦ App é€»è¾‘ (Character Book)
    // ==========================================

    // 1. åˆå§‹åŒ–
    async function initCharApp() {
        await renderCharList();
    }
    // åœ¨ loadSavedData çš„æœ€åè°ƒç”¨å®ƒ (æ‰‹åŠ¨åŠ ä¸€è¡Œ initCharApp();)

    // 2. è§’è‰²å¢åˆ æ”¹æŸ¥ (åŸºäº IndexedDB)
    async function getCharList() {
        return await loadFromDB('char_list') || [];
    }
    async function saveCharList(list) {
        await saveToDB('char_list', list);
    }

    // 3. æ¸²æŸ“åˆ—è¡¨
    async function renderCharList() {
        const grid = document.getElementById('char-grid');
        if(!grid) return;
        
        const list = await getCharList();
        grid.innerHTML = "";
        
        // 1. å…ˆåˆ›å»ºä¸€ä¸ª "Add New" å¡ç‰‡
        const addCard = document.createElement('div');
        addCard.className = 'char-card add-new';
        addCard.onclick = openCharModal; // ç‚¹å‡»è§¦å‘æ–°å»ºå¼¹çª—
        addCard.innerHTML = `
            <svg class="add-icon-big" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <div class="add-text">New Character</div>
        `;
        grid.appendChild(addCard);

        // 2. å†æ¸²æŸ“ç°æœ‰çš„è§’è‰²å¡ç‰‡
        list.forEach(char => {
            const card = document.createElement('div');
            card.className = 'char-card';
            card.innerHTML = `
                <img class="char-card-img" src="${char.avatar || ''}">
                <div class="char-card-info">
                    <div class="char-card-name">${char.name}</div>
                    <div class="char-card-desc">${char.desc}</div>
                </div>
            `;
            card.onclick = () => openCharDetail(char.id);
            grid.appendChild(card);
        });
        
        // (Deleted empty hint logic since we always have the add button)
    }

    // 4. æ‰“å¼€/å…³é—­ App
    function openCharModal() {
        editingCharId = null; // æ–°å»ºæ¨¡å¼
        document.getElementById('modal-title').textContent = "New Character";
        document.getElementById('char-name-in').value = "";
        document.getElementById('char-desc-in').value = "";
        document.getElementById('edit-avatar-preview').style.display = 'none';
        document.getElementById('edit-avatar-hint').style.display = 'block';
        tempCharAvatar = null;
        document.getElementById('charEditModal').style.display = 'flex';
    }
    function closeCharModal() { document.getElementById('charEditModal').style.display = 'none'; }

    // --- âš™ï¸ ä¿®æ”¹ saveCharacter å‡½æ•° ---
async function saveCharacter() {
    const name = document.getElementById('char-name-in').value;
    const desc = document.getElementById('char-desc-in').value;
    
    if(!name) { showToast("Name is required"); return; }
    
    let list = await getCharList();
    
    if(editingCharId) {
        // ä¿®æ”¹æ¨¡å¼ï¼šä¿ç•™åŸæœ‰çš„åˆ›å»ºæ—¶é—´
        const index = list.findIndex(c => c.id === editingCharId);
        if(index !== -1) {
            list[index].name = name;
            list[index].desc = desc;
            if(tempCharAvatar) list[index].avatar = tempCharAvatar;
            // ğŸš¨ æ³¨æ„ï¼šè¿™é‡Œä¸è¦åŠ¨ list[index].createdAt
        }
    } else {
        // âœ¨ æ–°å»ºæ¨¡å¼ï¼šç‰©ç†é”å®šå½“å‰æ—¶é—´ä¸ºâ€œè¯ç”Ÿæ—¶åˆ»â€
        const newChar = {
            id: Date.now().toString(),
            createdAt: Date.now(), // ğŸš¨ è®°å½•çœŸå®åˆ›å»ºæ—¶é—´æˆ³
            name: name,
            desc: desc,
            avatar: tempCharAvatar,
            boundWorldIds: [],
            relationNetwork: []
        };
        list.unshift(newChar);
    }
    
    await saveCharList(list);
    renderCharList();
    closeCharModal();
    triggerSuccessHud("äººæ ¼å·²è§‰é†’");
}

    // 6. å¤´åƒé¢„è§ˆ
    function previewCharAvatar(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                tempCharAvatar = e.target.result;
                document.getElementById('edit-avatar-preview').src = tempCharAvatar;
                document.getElementById('edit-avatar-preview').style.display = 'block';
                document.getElementById('edit-avatar-hint').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 7. è¯¦æƒ…é¡µé€»è¾‘
    async function openCharDetail(id, charObj = null) {
        let char = charObj;
        if(!char) {
            const list = await getCharList();
            char = list.find(c => c.id === id);
        }
        if(!char) return;

        editingCharId = char.id; // æ ‡è®°å½“å‰æŸ¥çœ‹çš„è§’è‰²
        
        // 1. å¡«å……è¯¦æƒ…é¡µæ•°æ® (è¿™äº› ID è¿˜åœ¨ï¼Œæ‰€ä»¥æ²¡é—®é¢˜)
        const nameEl = document.getElementById('detail-name');
        const descEl = document.getElementById('detail-desc');
        const avtEl = document.getElementById('detail-avatar');
        const bgEl = document.getElementById('detail-bg');

        if(nameEl) nameEl.textContent = char.name;
        // é¢„è§ˆåªæ˜¾ç¤ºå‰50ä¸ªå­—
        if(descEl) descEl.textContent = char.desc.substring(0, 50) + (char.desc.length > 50 ? "..." : "");
        if(avtEl) avtEl.src = char.avatar;
        
        // 2. èƒŒæ™¯å¤„ç†
        if(bgEl) {
            if(char.bg) {
                bgEl.style.backgroundImage = `url(${char.bg})`;
            } else {
                bgEl.style.backgroundColor = '#ddd';
                bgEl.style.backgroundImage = 'none';
            }
        }

        // âŒ åˆ é™¤äº†è¿™é‡ŒåŸæœ¬å¼•ç”¨ 'ins-avatar-img' çš„ä»£ç ï¼Œå› ä¸ºé‚£ä¸ªå…ƒç´ å·²ç»ä¸å­˜åœ¨äº†
        // ç°åœ¨çš„å¼¹çª—æ•°æ®å¡«å……ä¼šåœ¨ç‚¹å‡» "More" (openFullDesc) æ—¶æ‰è¿›è¡Œ

        // 3. æ˜¾ç¤ºè¯¦æƒ…é¡µ
        document.getElementById('char-detail-view').style.display = 'flex';
    }

    function closeDetailView() {
        document.getElementById('char-detail-view').style.display = 'none';
    }

    // 8. è¯¦æƒ…é¡µäº¤äº’ï¼šæ›´æ¢èƒŒæ™¯
    function openBgModal() { document.getElementById('bgChangeModal').style.display = 'flex'; }
    
    function switchBgMode(mode) {
        document.getElementById('bg-seg-file').classList.toggle('active', mode==='file');
        document.getElementById('bg-seg-url').classList.toggle('active', mode==='url');
        document.getElementById('bg-panel-file').style.display = mode==='file'?'block':'none';
        document.getElementById('bg-panel-url').style.display = mode==='url'?'block':'none';
    }

    async function handleBgFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = async e => {
                await updateCharBg(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    async function handleBgUrl() {
        const url = document.getElementById('bg-url-in').value;
        if(url) await updateCharBg(url);
    }

    async function updateCharBg(bgData) {
        let list = await getCharList();
        const index = list.findIndex(c => c.id === editingCharId);
        if(index !== -1) {
            list[index].bg = bgData;
            await saveCharList(list);
            // åˆ·æ–°ç•Œé¢
            document.getElementById('detail-bg').style.backgroundImage = `url(${bgData})`;
            document.getElementById('bgChangeModal').style.display = 'none';
            showToast("Background Updated");
        }
    }

    // === 9. è¯¦æƒ…é¡µäº¤äº’ï¼šé«˜çº§æ‚å¿—é£å±•ç¤º ===
    function openFullDesc() {
        const modal = document.getElementById('fullDescModal');
        
        // 1. è·å–åŸºç¡€æ•°æ®
        const avatarSrc = document.getElementById('detail-avatar').src;
        const nameTxt = document.getElementById('detail-name').textContent;
        
        // 2. å¡«å…… UI
        document.getElementById('aes-avatar-img').src = avatarSrc;
        document.getElementById('aes-name-txt').textContent = nameTxt;
        
        // 3. åŠ¨æ€å…‰å½±ï¼šè®¾ç½®é¡¶éƒ¨æ¨¡ç³ŠèƒŒæ™¯
        document.getElementById('aes-bg-layer').style.backgroundImage = `url(${avatarSrc})`;
        
        // 4. å¼‚æ­¥è·å–å®Œæ•´æ–‡æœ¬
        (async () => {
            const list = await getCharList();
            const fullChar = list.find(c => c.id === editingCharId);
            if(fullChar) {
                document.getElementById('aes-full-desc').textContent = fullChar.desc || "No description provided.";
            }
        })();
        
        // 5. æ˜¾ç¤º
        modal.style.display = 'flex';
    }

    function closeInsModal() {
        document.getElementById('fullDescModal').style.display = 'none';
    }

    // === æ–°å¢ï¼šç›´æ¥ä»å¼¹çª—é‡Œæ“ä½œç¼–è¾‘å’Œåˆ é™¤ ===
    
    function editCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€ç¼–è¾‘ï¼Œä½“éªŒæ›´å¥½
        setTimeout(() => {
            editCurrentChar(); // è°ƒç”¨å·²æœ‰çš„ç¼–è¾‘å‡½æ•°
        }, 200);
    }

    function deleteCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€åˆ é™¤ç¡®è®¤
        setTimeout(() => {
            openDelConfirm(); // è°ƒç”¨å·²æœ‰çš„åˆ é™¤ç¡®è®¤å‡½æ•°
        }, 200);
    }

    // 10. è¯¦æƒ…é¡µäº¤äº’ï¼šç¼–è¾‘ä¸åˆ é™¤
    async function editCurrentChar() {
        const list = await getCharList();
        const char = list.find(c => c.id === editingCharId);
        if(char) {
            document.getElementById('modal-title').textContent = "Edit Profile";
            document.getElementById('char-name-in').value = char.name;
            document.getElementById('char-desc-in').value = char.desc;
            tempCharAvatar = char.avatar;
            document.getElementById('edit-avatar-preview').src = char.avatar;
            document.getElementById('edit-avatar-preview').style.display = 'block';
            document.getElementById('edit-avatar-hint').style.display = 'none';
            document.getElementById('charEditModal').style.display = 'flex';
        }
    }

    function openDelConfirm() { document.getElementById('delConfirmModal').style.display = 'flex'; }
    
    async function confirmDelete() {
        let list = await getCharList();
        list = list.filter(c => c.id !== editingCharId);
        await saveCharList(list);
        
        document.getElementById('delConfirmModal').style.display = 'none';
        closeDetailView();
        renderCharList();
        showToast("Character Deleted");
    }

    // === æ–°å¢ï¼šæ—¶åŒºæœç´¢åŠŸèƒ½ ===
    function filterTimezoneList(query) {
        const input = query.toLowerCase().trim();
        const items = document.querySelectorAll('.tz-item'); // è·å–æ‰€æœ‰åŸå¸‚é¡¹
        const groups = document.querySelectorAll('#tz-city-container .ios-list-group'); // è·å–åŸå¸‚åˆ†ç»„å®¹å™¨
        const titles = document.querySelectorAll('#tz-city-container .tz-group-title'); // è·å–åˆ†ç»„æ ‡é¢˜
        let hasResult = false;

        // 1. ç­›é€‰å…·ä½“çš„åŸå¸‚
        items.forEach(item => {
            const keys = item.getAttribute('data-keywords');
            if (keys.includes(input)) {
                item.style.display = 'flex'; // æ˜¾ç¤ºåŒ¹é…é¡¹
                hasResult = true;
            } else {
                item.style.display = 'none'; // éšè—ä¸åŒ¹é…é¡¹
            }
        });

        // 2. æ™ºèƒ½éšè—ï¼šå¦‚æœä¸€ä¸ªç»„é‡Œçš„æ‰€æœ‰åŸå¸‚éƒ½è¢«éšè—äº†ï¼Œå°±æŠŠé‚£ä¸ªç»„çš„â€œæ ‡é¢˜â€å’Œâ€œåœ†è§’èƒŒæ™¯â€ä¹Ÿè—èµ·æ¥
        groups.forEach((group, index) => {
            // æ£€æŸ¥è¿™ä¸ªç»„é‡Œæœ‰æ²¡æœ‰æ˜¾ç¤ºçš„å­å…ƒç´ 
            const visibleChildren = Array.from(group.children).some(child => child.style.display !== 'none');
            
            if(visibleChildren) {
                group.style.display = 'block';
                if(titles[index]) titles[index].style.display = 'block';
            } else {
                group.style.display = 'none';
                if(titles[index]) titles[index].style.display = 'none';
            }
        });

        // 3. æ— ç»“æœæç¤º
        document.getElementById('tz-no-result').style.display = hasResult ? 'none' : 'block';
    }
    // ==========================================
    // 10. AI å¤§è„‘é…ç½® (å®Œæ•´ä¿®å¤ç‰ˆ)
    // ==========================================

    // --- 1. åº•éƒ¨èœå•æ§åˆ¶ (Action Sheet) ---
    function openModelPicker() {
        document.getElementById('modelPickerSheet').style.display = 'flex';
    }
    function closeModelPicker() {
        document.getElementById('modelPickerSheet').style.display = 'none';
    }

    // é€‰ä¸­æ¨¡å‹ï¼šæ›´æ–°æ˜¾ç¤ºæ–‡å­— + æ›´æ–°éšè—å€¼
    function selectModel(name) {
        if(!name) return;
        // æ›´æ–°æ˜¾ç¤ºçš„è“è‰²æ–‡å­— (å¸¦ç®­å¤´)
        const displayDiv = document.getElementById('api-model-display');
        if(displayDiv) {
            displayDiv.innerHTML = name + `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
        }
        // æ›´æ–°éšè—çš„ input å€¼ (ç»™ä¿å­˜åŠŸèƒ½ç”¨)
        const hiddenInput = document.getElementById('api-model-select');
        if(hiddenInput) {
            hiddenInput.value = name;
        }
        closeModelPicker();
    }

    // --- 2. æ ¸å¿ƒè®¾ç½®é€»è¾‘ ---

    // ==========================================
    // ğŸšï¸ æ»‘åŠ¨æ¡ä¿®å¤è¡¥ä¸ (è®©è“è‰²æ¡è·Ÿéšæ»‘å—)
    // ==========================================

    // 1. æ ¸å¿ƒå·¥å…·ï¼šè®¡ç®—æ»‘å—ç™¾åˆ†æ¯”å¹¶æ›´æ–° CSS
    function updateSliderFill(el) {
        const val = parseFloat(el.value);
        const min = parseFloat(el.min) || 0;
        const max = parseFloat(el.max) || 100;
        const percent = ((val - min) / (max - min)) * 100;
        el.style.setProperty('--percent', percent + '%');
    }

    // 2. è¦†ç›–ä¹‹å‰çš„ loadApiSettingsUI (å¢åŠ åˆå§‹åŒ–é¢œè‰²é€»è¾‘)
    function loadApiSettingsUI() {
        const url = localStorage.getItem('gpt_url') || "https://api.openai.com/v1";
        const key = localStorage.getItem('gpt_key') || "";
        const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
        const temp = localStorage.getItem('gpt_temp') || "0.7";
        const context = localStorage.getItem('gpt_context') || "10";

        // å¡«å€¼
        document.getElementById('api-url').value = url;
        document.getElementById('api-key').value = key;
        
        // --- ä¿®å¤é‡ç‚¹ï¼šè®¾ç½®æ»‘å—æ•°å€¼åï¼Œç«‹åˆ»åˆ·æ–°é¢œè‰² ---
        const tempSlider = document.getElementById('api-temp');
        const ctxSlider = document.getElementById('api-context');
        
        // æ¸©åº¦æ»‘å—
        if(tempSlider) {
            tempSlider.value = temp;
            document.getElementById('temp-display').textContent = temp;
            updateSliderFill(tempSlider); // ğŸ‘ˆ ç«‹å³åˆ·æ–°è“è‰²æ¡
        }
        
        // è®°å¿†æ»‘å—
        if(ctxSlider) {
            ctxSlider.value = context;
            document.getElementById('context-display').textContent = context;
            updateSliderFill(ctxSlider); // ğŸ‘ˆ ç«‹å³åˆ·æ–°è“è‰²æ¡
        }

        // åˆå§‹åŒ–æ¨¡å‹èœå•æ˜¾ç¤º
        if(typeof selectModel === 'function') selectModel(model);
        
        // åŠ è½½é¢„è®¾
        if(typeof renderPresets === 'function') renderPresets();
        
        // é‡ç½®èŠå¤©æ¡†
        const chatLog = document.getElementById('test-chat-log');
        if(chatLog) chatLog.innerHTML = '<div style="color:#999; text-align:center; margin-top:40px;">Test your connection here...</div>';
    }

    // ä»æœåŠ¡å™¨è·å–æ¨¡å‹åˆ—è¡¨
    async function fetchModelList() {
        const url = document.getElementById('api-url').value.replace(/\/$/, "");
        const key = document.getElementById('api-key').value;
        const listContainer = document.getElementById('model-sheet-list'); // ç›®æ ‡å®¹å™¨æ˜¯åº•éƒ¨èœå•
        
        if(!url || !key) { showToast("URL & Key required!"); return; }
        showToast("Fetching Models...");
        
        try {
            const res = await fetch(`${url}/models`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${key}` }
            });
            if(!res.ok) throw new Error("Fetch Failed");
            const data = await res.json();
            const models = data.data || []; 
            
            if(models.length > 0) {
                listContainer.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
                models.sort((a, b) => a.id.localeCompare(b.id)); // æ’åº
                
                // ç”Ÿæˆæ¼‚äº®çš„åº•éƒ¨æŒ‰é’®
                models.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'sheet-item';
                    div.textContent = m.id;
                    div.onclick = () => selectModel(m.id); 
                    listContainer.appendChild(div);
                });
                
                openModelPicker(); // æˆåŠŸåè‡ªåŠ¨å¼¹çª—
                showToast(`Found ${models.length} models!`);
            } else {
                showToast("No models found.");
            }
        } catch(e) {
            console.error(e);
            showToast("Error fetching models.");
        }
    }

    // èŠå¤©æµ‹è¯•
    async function sendTestChat() {
        const input = document.getElementById('test-chat-input');
        const log = document.getElementById('test-chat-log');
        const msg = input.value.trim();
        if(!msg) return;

        const url = document.getElementById('api-url').value.replace(/\/$/, "");
        const key = document.getElementById('api-key').value;
        // è·å–éšè— input çš„å€¼
        const model = document.getElementById('api-model-select').value; 
        const temp = parseFloat(document.getElementById('api-temp').value);

        if(log.querySelector('div') && log.querySelector('div').textContent.includes('Test your')) log.innerHTML = ""; 
        log.innerHTML += `<div style="text-align:right; margin:5px 0;"><span style="background:#007AFF; color:white; padding:6px 10px; border-radius:14px; font-size:13px; display:inline-block;">${msg}</span></div>`;
        input.value = "";
        log.scrollTop = log.scrollHeight;

        try {
            const res = await fetch(`${url}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model, messages: [{ role: "user", content: msg }],
                    temperature: temp, max_tokens: 50
                })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            const reply = data.choices[0].message.content;
            
            log.innerHTML += `<div style="text-align:left; margin:5px 0;"><span style="background:#e5e5ea; color:black; padding:6px 10px; border-radius:14px; font-size:13px; display:inline-block;">${reply}</span></div>`;
            saveToLocalStorage(); // æˆåŠŸåˆ™è‡ªåŠ¨ä¿å­˜
            document.getElementById('api-status-preview').textContent = "Verified";
        } catch(e) {
            log.innerHTML += `<div style="text-align:left; margin:5px 0;"><span style="color:#FF3B30; font-size:11px;">Error: ${e.message}</span></div>`;
        }
        log.scrollTop = log.scrollHeight;
    }

    // ä¿å­˜å½“å‰é…ç½®ä¸ºé¢„è®¾ (é…åˆå¤–éƒ¨å¼¹çª—)
    function saveCurrentAsPreset(name) {
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        const model = document.getElementById('api-model-select').value;
        const temp = document.getElementById('api-temp').value;
        
        const preset = { id: Date.now(), name, url, key, model, temp };
        let presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        presets.push(preset);
        localStorage.setItem('api_presets', JSON.stringify(presets));
        
        saveToLocalStorage();
        renderPresets();
        showToast("Configuration Saved!");
    }

    // --- 3. ç¼ºå¤±çš„å‡½æ•° (ä¹‹å‰æŠ¥é”™å°±æ˜¯å› ä¸ºç¼ºäº†è¿™äº›) ---

    // æ¸²æŸ“é¢„è®¾åˆ—è¡¨
    function renderPresets() {
        const list = document.getElementById('preset-list');
        if(!list) return; // é˜²æ­¢é¡µé¢æ²¡åŠ è½½å®ŒæŠ¥é”™

        const presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        
        if(presets.length === 0) {
            list.innerHTML = `<div class="ios-list-item" style="color:#999; justify-content:center;">No saved configurations</div>`;
            return;
        }

        list.innerHTML = "";
        presets.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'ios-list-item';
            div.style.cursor = "pointer";
            div.innerHTML = `
                <div class="item-content" onclick="loadPreset(${index})">
                    <div style="display:flex; flex-direction:column;">
                        <span class="item-label" style="font-weight:600;">${p.name}</span>
                        <span style="font-size:11px; color:#8e8e93;">${p.model}</span>
                    </div>
                    <div class="item-right">
                        <span style="color:#FF3B30; font-size:13px; font-weight:500; padding:8px;" onclick="event.stopPropagation(); openDeletePresetConfirm(${index})">Delete</span>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // åŠ è½½é¢„è®¾
    function loadPreset(index) {
        const presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        const p = presets[index];
        if(p) {
            document.getElementById('api-url').value = p.url;
            document.getElementById('api-key').value = p.key;
            document.getElementById('api-temp').value = p.temp;
            document.getElementById('temp-display').textContent = p.temp;
            
            // ä½¿ç”¨æ–°å‡½æ•°åŠ è½½æ¨¡å‹
            selectModel(p.model); 
            
            saveToLocalStorage();
            showToast(`Loaded "${p.name}"`);
        }
    }

    // çœŸæ­£çš„åˆ é™¤é€»è¾‘ (è¢«å¼¹çª—è°ƒç”¨)
    function deletePresetReal(index) {
        let presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        presets.splice(index, 1);
        localStorage.setItem('api_presets', JSON.stringify(presets));
        renderPresets();
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    function saveToLocalStorage() {
        localStorage.setItem('gpt_url', document.getElementById('api-url').value);
        localStorage.setItem('gpt_key', document.getElementById('api-key').value);
        localStorage.setItem('gpt_model', document.getElementById('api-model-select').value);
        localStorage.setItem('gpt_temp', document.getElementById('api-temp').value);
        localStorage.setItem('gpt_context', document.getElementById('api-context').value);
    }
    
    // é‡ç½®æ‰€æœ‰è®¾ç½®
    function clearApiSettings() {
        localStorage.removeItem('gpt_url');
        localStorage.removeItem('gpt_key');
        localStorage.removeItem('gpt_model');
        localStorage.removeItem('api_presets'); 
        loadApiSettingsUI();
        showToast("Reset Complete");
    }
    // ==========================================
    // ğŸš‘ è¡¥å…¨ç¼ºå¤±çš„ï¼šå¼¹çª—æ§åˆ¶å™¨ (UI Logic)
    // ==========================================

    // --- 1. ä¿å­˜é¢„è®¾å¼¹çª— (Input Modal) ---
    
    // ç‚¹å‡»å³ä¸Šè§’ Save æ—¶è°ƒç”¨
    function openSavePresetModal() {
        // å…ˆæ£€æŸ¥å¿…å¡«é¡¹
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        
        if(!url || !key) { 
            showToast("URL & Key required!"); 
            return; 
        }

        // å‡†å¤‡å¼¹çª—å†…å®¹
        document.getElementById('input-modal-title').textContent = "Name This Preset";
        // é»˜è®¤åå­—è®¾ä¸ºå½“å‰æ¨¡å‹å
        const currModel = document.getElementById('api-model-select').value;
        document.getElementById('input-modal-val').value = currModel || "My Preset";
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('iosInputModal').style.display = 'flex';
    }

    // å…³é—­è¾“å…¥å¼¹çª—
    function closeInputModal() { 
        document.getElementById('iosInputModal').style.display = 'none'; 
    }
    
    // ç¡®è®¤ä¿å­˜ (å¼¹çª—é‡Œçš„ Save æŒ‰é’®)
    function confirmInputModal() {
        const name = document.getElementById('input-modal-val').value;
        if(name) {
            saveCurrentAsPreset(name); // è°ƒç”¨æ ¸å¿ƒä¿å­˜å‡½æ•°
            closeInputModal();
        } else {
            showToast("Please enter a name");
        }
    }

    // --- 2. åˆ é™¤/é‡ç½®ç¡®è®¤å¼¹çª— (Confirm Modal) ---
    
    let pendingAction = null; // æš‚å­˜è¦æ‰§è¡Œçš„æ“ä½œ

    // ç‚¹å‡» Reset All Settings æ—¶è°ƒç”¨
    function openResetConfirm() {
        pendingAction = clearApiSettings; // è®°ä¸‹æ¥ï¼šä¸€ä¼šè¦æ‰§è¡Œé‡ç½®
        
        document.getElementById('confirm-modal-title').textContent = "Reset All Settings?";
        document.getElementById('confirm-modal-msg').textContent = "This will clear all saved API keys and presets.";
        document.getElementById('confirm-modal-btn').textContent = "Reset";
        
        document.getElementById('iosConfirmModal').style.display = 'flex';
    }
    
    // ç‚¹å‡»å•ä¸ªé¢„è®¾çš„ Delete æ—¶è°ƒç”¨
    function openDeletePresetConfirm(index) {
        pendingAction = () => deletePresetReal(index); // è®°ä¸‹æ¥ï¼šä¸€ä¼šè¦æ‰§è¡Œåˆ é™¤
        
        document.getElementById('confirm-modal-title').textContent = "Delete Preset?";
        document.getElementById('confirm-modal-msg').textContent = "This configuration will be removed.";
        document.getElementById('confirm-modal-btn').textContent = "Delete";
        
        document.getElementById('iosConfirmModal').style.display = 'flex';
    }

    // å…³é—­ç¡®è®¤å¼¹çª—
    function closeConfirmModal() {
        document.getElementById('iosConfirmModal').style.display = 'none';
        window.pendingAction = null; // å…³é—­å¼¹çª—æ—¶ä¹Ÿæ¸…ç©ºï¼Œä¿è¯å®‰å…¨
    }
    
    // æ‰§è¡Œç¡®è®¤çš„æ“ä½œ (å¼¹çª—é‡Œçš„çº¢è‰²æŒ‰é’®)
    function executeConfirmAction() {
    // æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜çš„ä»»åŠ¡
        if (typeof window.pendingAction === 'function') {
            window.pendingAction(); // æ‰§è¡Œåˆšæ‰å­˜è¿›å»çš„åˆ é™¤å‡½æ•°
            window.pendingAction = null; // æ‰§è¡Œå®Œç«‹åˆ»æ¸…ç©ºï¼Œé˜²æ­¢è¯¯è§¦
        }
        closeConfirmModal();
    }
    // ==========================================
    // ğŸ¨ å­—ä½“ä¸æ˜¾ç¤ºè®¾ç½® (æ— æŸå®‰è£…ç‰ˆ)
    // ==========================================

    function applyGlobalStyles() {
        // æˆ‘ä»¬æŠŠå˜é‡æŒ‚åœ¨ body ä¸Šï¼Œè€Œä¸æ˜¯ :rootï¼Œè¿™æ ·ä½œç”¨åŸŸæ›´å®¹æ˜“æ§åˆ¶
        const target = document.body;
        
        // åº”ç”¨ä¿å­˜çš„å­—ä½“æ ·å¼
        target.style.setProperty('--dynamic-font-family', currentFontConfig.family);
        target.style.setProperty('--dynamic-app-size', currentFontConfig.size + 'px');
        target.style.setProperty('--dynamic-app-weight', currentFontConfig.weight);
        
        // åº”ç”¨ä¿å­˜çš„é¢œè‰²ç³»ç»Ÿ
        target.style.setProperty('--dynamic-app-color', currentFontConfig.colorMain);
        target.style.setProperty('--dynamic-desktop-color', currentFontConfig.colorDesktop);
    }

    // å®æ—¶é¢„è§ˆå‡½æ•° (åªå½±å“é¢„è§ˆé‚£ä¸ªå°ç›’å­ï¼Œä¸å½±å“çœŸæ­£çš„ç•Œé¢)
    function updateFontUI() {
        // 1. æ›´æ–°è°ƒè‰²ç›˜
        document.getElementById('color-picker-main').value = currentFontConfig.colorMain;
        document.getElementById('color-picker-desktop').value = currentFontConfig.colorDesktop;
        
        // 2. æ›´æ–° Hex æ–‡å­—æ˜¾ç¤º
        document.getElementById('color-val-main').textContent = currentFontConfig.colorMain.toUpperCase();
        document.getElementById('color-val-desktop').textContent = currentFontConfig.colorDesktop.toUpperCase();

        // 3. æ ¸å¿ƒï¼šæ›´æ–°é¢„è§ˆç›’å­çš„æ ·å¼
        const pMain = document.getElementById('preview-text-main');
        const pDesk = document.getElementById('preview-text-desktop');
        
        const fontStyle = `
            font-family: ${currentFontConfig.family};
            font-size: ${currentFontConfig.size}px;
            font-weight: ${currentFontConfig.weight};
        `;

        if(pMain) {
            pMain.style.cssText = fontStyle + `color: ${currentFontConfig.colorMain};`;
        }
        if(pDesk) {
            // æ¡Œé¢é¢„è§ˆé€šå¸¸åŠ ä¸€ç‚¹é˜´å½±æ¨¡æ‹ŸçœŸå®å£çº¸æ„Ÿ
            pDesk.style.cssText = fontStyle + `color: ${currentFontConfig.colorDesktop}; text-shadow: 0 1px 2px rgba(0,0,0,0.2);`;
        }
    }

    // ä¿å­˜å¹¶å…¨å±€ç”Ÿæ•ˆ
    function saveFontSettings() {
        localStorage.setItem('ios_font_config', JSON.stringify(currentFontConfig));
        applyGlobalStyles(); // è¿™æ—¶å€™å˜é‡æ‰ä¼šä¼ ç»™ CSS é’©å­ï¼Œå…¨å±€å˜è‰²
        showToast("Theme Updated!");
        setTimeout(() => closeSubPage('subpage-display'), 500);
    }

function openInsAppModal(id) {
    document.getElementById(id).style.display = 'flex';
}

function closeInsAppModal(id) {
    document.getElementById(id).style.display = 'none';
}
// 1. å£°æ˜å˜é‡ï¼ˆç”¨ var ç¡®ä¿å®ƒæ˜¯å…¨å±€å¯è§çš„ï¼‰
var vibeGameState;

// 2. åˆå§‹åŒ–æ£‹ç›˜å‡½æ•°
function initVibeGrid() {
    // ã€å…³é”®ä¿®å¤ã€‘ï¼šå¦‚æœå˜é‡è¿˜æ²¡åˆå§‹åŒ–ï¼Œåœ¨è¿™é‡Œå¼ºè¡Œåˆå§‹åŒ–å®ƒ
    if (!vibeGameState) {
        vibeGameState = {
            board: [],
            size: 10,
            currentPlayer: 1,
            isGameOver: false
        };
    }

    var boardEl = document.getElementById('vibe-board');
    if (!boardEl) {
        console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ° ID ä¸º vibe-board çš„å®¹å™¨");
        return;
    }
    
    // é‡ç½®é€»è¾‘
    boardEl.innerHTML = '';
    vibeGameState.board = []; 
    for (var i = 0; i < 10; i++) {
        vibeGameState.board[i] = Array(10).fill(0);
    }
    vibeGameState.currentPlayer = 1;
    vibeGameState.isGameOver = false;
    
    var indicator = document.getElementById('vibe-turn-indicator');
    if (indicator) {
        indicator.textContent = "PLAYER: å…±é¸£";
        indicator.style.color = "#4facfe";
    }

    // ç”Ÿæˆæ ¼å­
    for (var r = 0; r < 10; r++) {
        for (var c = 0; c < 10; c++) {
            var cell = document.createElement('div');
            cell.className = 'vibe-cell';
            cell.dataset.row = r;
            cell.dataset.col = c;
            // ç»‘å®šç‚¹å‡»è½å­
            cell.onclick = (function(row, col, el) {
                return function() { placeVibePiece(row, col, el); };
            })(r, c, cell);
            boardEl.appendChild(cell);
        }
    }
    console.log("æ°›å›´å›´åŸï¼šæ£‹ç›˜å°±ç»ª");
}

// 3. è½å­å‡½æ•°
function placeVibePiece(r, c, cellEl) {
    // å†æ¬¡æ£€æŸ¥å˜é‡ï¼Œé˜²æ­¢æ„å¤–
    if (!vibeGameState || vibeGameState.board[r][c] !== 0 || vibeGameState.isGameOver) return;

    var player = vibeGameState.currentPlayer;
    vibeGameState.board[r][c] = player;

    var piece = document.createElement('div');
    piece.className = (player === 1) ? 'piece-resonance' : 'piece-devour';
    cellEl.appendChild(piece);

    // å˜è‰²é€»è¾‘
    if (player === 1) {
        document.documentElement.style.setProperty('--bg-gradient', 'linear-gradient(160deg, #a1fdd4 0%, #8ec5fc 100%)');
    } else {
        document.documentElement.style.setProperty('--bg-gradient', 'linear-gradient(160deg, #fbc2eb 0%, #a6c1ee 100%)');
    }

    // åˆ¤èƒœ
    if (checkVibeWin(r, c, player)) {
        vibeGameState.isGameOver = true;
        alert((player === 1 ? "å…±é¸£" : "åå™¬") + " è¿æˆäº†æƒ…æ„Ÿç½‘ç»œï¼");
        return;
    }

    // æ¢äºº
    vibeGameState.currentPlayer = (player === 1) ? 2 : 1;
    var nextName = (vibeGameState.currentPlayer === 1) ? "å…±é¸£" : "åå™¬";
    var indicator = document.getElementById('vibe-turn-indicator');
    if (indicator) {
        indicator.textContent = "PLAYER: " + nextName;
        indicator.style.color = (vibeGameState.currentPlayer === 1) ? "#4facfe" : "#f5576c";
    }
}

// 4. ç®—æ³•å‡½æ•°
function checkVibeWin(r, c, p) {
    if (!vibeGameState) return false;
    var b = vibeGameState.board;
    var dirs = [[1,0], [0,1], [1,1], [1,-1]];
    for (var i = 0; i < dirs.length; i++) {
        var dr = dirs[i][0], dc = dirs[i][1], count = 1;
        var nr = r + dr, nc = c + dc;
        while(nr>=0 && nr<10 && nc>=0 && nc<10 && b[nr][nc] === p) { count++; nr+=dr; nc+=dc; }
        nr = r - dr; nc = c - dc;
        while(nr>=0 && nr<10 && nc>=0 && nc<10 && b[nr][nc] === p) { count++; nr-=dr; nc-=dc; }
        if (count >= 5) return true;
    }
    return false;
}

// 5. é‡ç½®
function resetVibeGame() {
    initVibeGrid();
}
// ==========================================
// ğŸ® æ°›å›´å›´åŸï¼šå¼ºåˆ¶ä¿®å¤å¯åŠ¨é€»è¾‘
// ==========================================

// 1. å¼ºåŠ›æ‰“å¼€ App çš„å‡½æ•°
// åœ¨ script æ ‡ç­¾æœ€åæ·»åŠ æˆ–ä¿®æ”¹
function startVibeGame() {
    var gameApp = document.getElementById('vibe-grid-app');
    if (gameApp) {
        gameApp.style.display = 'flex'; // å…ˆæ˜¾ç¤ºå®¹å™¨
        // ç»™æµè§ˆå™¨ä¸€ä¸ç‚¹æ—¶é—´å‡†å¤‡ï¼Œç„¶åè§¦å‘æ»‘å…¥åŠ¨ç”»
        setTimeout(function() {
            gameApp.classList.add('active');
            initVibeGrid(); // åˆå§‹åŒ–æ£‹ç›˜
        }, 50);
    }
}

// 2. ä¿®æ”¹ä½ ä¹‹å‰çš„ initVibeGridï¼Œå¢åŠ å®‰å…¨æ€§
// å¦‚æœä½ åé¢è¿˜è¦æ”¹ï¼Œè¯·ç¡®ä¿å‡½æ•°åè¿˜æ˜¯è¿™ä¸ª
var originalInitVibeGrid = initVibeGrid; 
initVibeGrid = function() {
    console.log("æ­£åœ¨é‡ç»˜æ£‹ç›˜...");
    // æ£€æŸ¥å˜é‡
    if (!vibeGameState) {
        vibeGameState = { board: [], size: 10, currentPlayer: 1, isGameOver: false };
    }
    // å‰©ä¸‹çš„é€»è¾‘ä¼šè‡ªåŠ¨è¿è¡Œä½ ä¹‹å‰å†™çš„é‚£ä¸ªç‰ˆæœ¬
    if(typeof originalInitVibeGrid === 'function') originalInitVibeGrid();
};
// ==========================================
// ğŸ® Vibe Grid 3.0: è§’è‰²åšå¼ˆå¼•æ“
// ==========================================

var vibeOpponent = null;
var vibeGameLog = []; // å­˜è¯è¯­
var vibePendingMove = null;

// 1. ã€å¼ºåŠ›å¯åŠ¨å™¨ã€‘
function startVibeGame() {
    var app = document.getElementById('vibe-grid-app');
    app.style.display = 'flex';
    setTimeout(() => {
        app.classList.add('active');
        renderVibeCharPicker(); // ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶é€‰äºº
    }, 50);
}

// 2. æ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨ (ä»ä½ çš„ IndexedDB è·å–)
// è®°å½•å½“å‰æ˜¯è°åœ¨è°ƒç”¨è§’è‰²é€‰æ‹©å™¨ ('VIBE' æˆ– 'SIGNAL')
var charPickerSource = 'VIBE'; 
// 3. é€‰æ‹©å¯¹æ‰‹å¹¶åˆå§‹åŒ–
function selectVibeOpponent(char) {
    vibeOpponent = char;
    vibeGameLog = [];
    document.getElementById('modal-vibe-char-picker').style.display = 'none';
    document.getElementById('opponent-info-bar').style.display = 'flex';
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ è½å­å¹¶æ³¨é­‚";
    initVibeGrid(); // ç»˜åˆ¶æ£‹ç›˜
}

// 4. é‡å†™åˆå§‹åŒ– (10x10)
function initVibeGrid() {
    var board = document.getElementById('vibe-board');
    board.innerHTML = "";
    vibeGameState = { board: Array(10).fill(0).map(()=>Array(10).fill(0)), isGameOver: false, currentPlayer: 1 };
    
    for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
            let cell = document.createElement('div');
            cell.className = 'vibe-cell';
            cell.dataset.row = r; cell.dataset.col = c;
            cell.onclick = () => handleVibeCellClick(r, c, cell);
            board.appendChild(cell);
        }
    }
}

// 5. ç‚¹å‡»é€»è¾‘
function handleVibeCellClick(r, c, el) {
    if (vibeGameState.isGameOver || vibeGameState.board[r][c] !== 0 || !vibeOpponent) return;
    vibePendingMove = { r, c, el };
    document.getElementById('vibe-user-word').value = "";
    document.getElementById('modal-vibe-word-input').style.display = 'flex';
}

// 6. ç¡®è®¤è½å­ (ç”¨æˆ·)
function confirmVibeStep() {
    var word = document.getElementById('vibe-user-word').value.trim();
    if(!word) { 
        showToast("æ³¨é­‚ä¸å¯ä¸ºç©º"); // ç¡®ä¿ä½ ä¹‹å‰æœ‰è¿™ä¸ªå‡½æ•°
        return; 
    }
    
    // ã€å…³é”®ä¿®å¤ã€‘ï¼šå¦‚æœç¬”è®°æœ¬æ²¡æ‰“å¼€ï¼Œç°åœ¨ç«‹åˆ»æ‰“å¼€
    if (!vibeGameLog) { vibeGameLog = []; }

    // éšè—è¾“å…¥æ³•
    document.getElementById('modal-vibe-word-input').style.display = 'none';
    
    // è®°å½•è¯è¯­
    vibeGameLog.push({ role: "User", text: word });
    
    // æ‰§è¡Œè½å­
    executeVibeMove(vibePendingMove.r, vibePendingMove.c, vibePendingMove.el, 1);
    
    if (vibeGameState.isGameOver) { 
        finishVibeMatch(); 
    } else {
        document.getElementById('vibe-turn-indicator').textContent = vibeOpponent.name + " æ­£åœ¨å›å“...";
        setTimeout(aiVibeResponse, 1000);
    }
}

// 7. AI å›åº” (è‡ªåŠ¨æ‰¾ç©ºä½ + è°ƒç”¨æ¨¡å‹)
async function aiVibeResponse() {
    // ç®€å•ç®—æ³•ï¼šæ‰¾ç¬¬ä¸€ä¸ªç©ºä½ (å•†ç”¨æ¼”ç¤ºå¤Ÿç”¨ï¼Œå¯å‡çº§)
    let r, c, found = false;
    for(r=4; r<10 && !found; r++) for(c=4; c<10 && !found; c++) if(vibeGameState.board[r][c] === 0) found = true;
    if(!found) { finishVibeMatch("DRAW"); return; }
    r--; c--;

    var bestMove = findBestMove(); 
    if(!bestMove) { finishVibeMatch("DRAW"); return; }

    // 1. è·å– AI è¯è¯­
    let lastUserWord = vibeGameLog[vibeGameLog.length-1].text;
    // åœ¨è·å–åˆ° aiWord åï¼Œæ‰§è¡Œè½å­å‰å¢åŠ é€»è¾‘
    let aiWord = await callAIForOneWord(lastUserWord);

    // ã€å¼ºåŠ›å»é‡æ£€æŸ¥ã€‘ï¼šå¦‚æœ AI å›çš„è¯è·Ÿç©å®¶ä¸€æ ·ï¼Œæˆ–è€… AI ä»¥å‰è¯´è¿‡ï¼Œå°±å¼ºåˆ¶è®©å®ƒéšæœºåº”å˜
    if (aiWord === lastUserWord || vibeGameLog.some(l => l.text === aiWord)) {
        var fallbackWords = ["ä½™æ¸©", "é™é»˜", "å¾®å…‰", "å¼•åŠ›", "å›å“"]; // å¤‡ç”¨é«˜çº§è¯åº“
        aiWord = fallbackWords[Math.floor(Math.random() * fallbackWords.length)];
    }
    vibeGameLog.push({ role: "AI", text: aiWord });

    // 2. æ›´æ–°ä¸‹æ–¹ä¿¡æ¯æ  (è®©å®ƒæ˜¾ç°)
    var logDisplay = document.getElementById('opp-last-word');
    if(logDisplay) {
        logDisplay.textContent = "ã€Œ " + aiWord + " ã€";
        logDisplay.style.opacity = "1";
    }

    // 3. æ‰§è¡Œè½å­
    let el = document.querySelector(`.vibe-cell[data-row='${bestMove.r}'][data-col='${bestMove.c}']`);
    executeVibeMove(bestMove.r, bestMove.c, el, 2);

    // 4. ã€æ ¸å¿ƒå‡çº§ã€‘ï¼šåˆ›å»ºæ£‹ç›˜ä¸Šæ–¹çš„æ‚¬æµ®æ–‡å­—åŠ¨ç”»
    showFloatingWord(aiWord, el);

    if (vibeGameState.isGameOver) { finishVibeMatch(); return; }
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ æ³¨å…¥è¯è¯­";
}
function showFloatingWord(text, targetEl) {
    var floatEl = document.createElement('div');
    floatEl.className = 'floating-vibe-word';
    floatEl.textContent = text;
    
    // å®šä½åˆ°å½“å‰è½å­çš„æ ¼å­ä¸­å¿ƒ
    var rect = targetEl.getBoundingClientRect();
    floatEl.style.left = (rect.left + rect.width / 2 - 20) + "px";
    floatEl.style.top = (rect.top - 20) + "px";
    
    document.body.appendChild(floatEl);
    
    // åŠ¨ç”»ç»“æŸè‡ªåŠ¨åˆ é™¤ï¼Œä¸å å†…å­˜
    setTimeout(function() {
        if(floatEl.parentNode) floatEl.parentNode.removeChild(floatEl);
    }, 2500);
}

// 8. èƒœè´Ÿ/å¹³å±€åˆ¤æ–­å¹¶å¼¹å‡ºå›å“å¡ç‰‡
// å‡çº§ç‰ˆï¼šå¸¦é˜²å¾¡é€»è¾‘çš„å¯¹å±€æ€»ç»“
// ==========================================
// ğŸ† é€šç”¨å¯¹å±€ç»“ç®—ä¸­å¿ƒ (ç»ˆæä¿®å¤ç‰ˆ)
// ==========================================
async function finishVibeMatch(type, customOpponent, customWords, customStory) {
    // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå®‰å…¨é”
    // åªæœ‰å½“ vibeGameState çœŸçš„å­˜åœ¨æ—¶ï¼Œæ‰å»æ”¹å®ƒçš„çŠ¶æ€
    if (typeof vibeGameState !== 'undefined' && vibeGameState) {
        vibeGameState.isGameOver = true;
    }

    showToast("å¯¹å±€å·²æˆï¼Œæ­£åœ¨ç»“è¯­...");
    
    // 2. æ™ºèƒ½è¯†åˆ«ï¼šæ˜¯è°åœ¨ç»“ç®—ï¼Ÿ
    // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å»æ‰¾å…¨å±€å˜é‡
    var opponent = customOpponent || (window.senseOpponent || vibeOpponent);
    var words = customWords || (window.senseMix || []);
    var story = customStory || ""; 

    if (!opponent) {
        console.error("Critical Error: æ‰¾ä¸åˆ°ä»»ä½•å¯¹æ‰‹æ•°æ®");
        return;
    }

    // 3. ç¡®å®šå¯¹å±€æ–‡æ¡ˆ
    var outcomeText;
    if (type === "SYNCED") outcomeText = "è”è§‰å…±æŒ¯ Â· è·å–åº•å±‚è®°å¿†";
    else if (type === "OFFLINE") outcomeText = "ä¿¡å·æ–­è£‚ Â· æ— æ³•è§£æäººæ ¼";
    else if (type === "DRAW") outcomeText = "å¹³å±€ Â· æŸç§å¹³è¡¡";
    else {
        // äº”å­æ£‹é€»è¾‘
        outcomeText = (vibeGameState && vibeGameState.currentPlayer === 1) ? "ä½ è§¦ç¢°äº†èƒœæœº" : opponent.name + "ä¸»å¯¼äº†æ°›å›´";
    }

    // 4. æ ¼å¼åŒ–è¯è¯­æ˜¾ç¤º (å…¼å®¹æ•°ç»„å’Œå¯¹è±¡)
    var wordStr = Array.isArray(words) ? words.join(" Â· ") : words;

    // 5. å¡«å……ç»“æœå¡ç‰‡ (UI æ¸²æŸ“)
    document.getElementById('res-title').textContent = opponent.name + " çš„åšå¼ˆå›å“";
    document.getElementById('res-outcome').textContent = outcomeText;
    document.getElementById('res-avatar').src = opponent.avatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + opponent.avatar + ")";
    document.getElementById('res-words').textContent = wordStr;
    
    // å¦‚æœå·²ç»æœ‰äº†æ•…äº‹ï¼ˆSenseæ¨¡å¼ï¼‰ï¼Œç›´æ¥å¡«è¿›å»ï¼›å¦‚æœæ²¡æœ‰ï¼ˆäº”å­æ£‹æ¨¡å¼ï¼‰ï¼Œå°±å»å«AIå†™
    var elStory = document.getElementById('res-story');
    if (story) {
        elStory.textContent = story;
    } else {
        elStory.textContent = "æ­£åœ¨ç¼–ç»‡åšå¼ˆç•™ä¸‹çš„ä½™æ¸©...";
        story = await callAIForStory(outcomeText, opponent, words); // è°ƒç”¨ä½ å·²æœ‰çš„ AI æ•…äº‹å‡½æ•°
        elStory.textContent = story;
    }

    // 6. æ˜¾ç¤ºå¡ç‰‡å¹¶ä¿å­˜å†å²
    document.getElementById('modal-vibe-result').style.display = 'flex';
    saveToVibeHistory(opponent, outcomeText, wordStr, story);
}

// --- è¾…åŠ©ï¼šæ‰§è¡Œè½å­è§†è§‰ ---
function executeVibeMove(r, c, el, p) {
    vibeGameState.board[r][c] = p;
    var piece = document.createElement('div');
    piece.className = p === 1 ? 'piece-resonance' : 'piece-devour';
    el.appendChild(piece);
    if(checkVibeWin(r, c, p)) vibeGameState.isGameOver = true;
    if(!vibeGameState.isGameOver) vibeGameState.currentPlayer = (p===1?2:1);
}

// --- è¾…åŠ©ï¼šçœŸæ­£çš„ AI æ¨¡å‹è°ƒç”¨ (è°ƒç”¨ä½ è®¾ç½®é¡µé¢çš„é…ç½®) ---
// å‡çº§ç‰ˆï¼šä¸¥æ ¼æ§åˆ¶ AI çš„å›å“è¯æ±‡
async function callAIForOneWord(userWord) {
    var key = localStorage.getItem('gpt_key');
    if(!key) return "æ²‰é»˜";

    // 1. æå–è§’è‰²å®Œæ•´èº«ä»½ (ç¡®ä¿è¯»å–è§’è‰²ä¹¦ä¸­çš„ desc å­—æ®µ)
    var persona = vibeOpponent.desc || "ç¥ç§˜çš„é™Œç”Ÿäºº";
    var usedWords = vibeGameLog.map(function(l){ return l.text; }).join("ã€");

    try {
        var res = await fetch(localStorage.getItem('gpt_url') + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            // ä¿®æ”¹ callAIForOneWord å†…éƒ¨çš„ body éƒ¨åˆ†
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{
                    role: "system", 
                    content: `ã€ç»å¯¹äººæ ¼é”å®šã€‘
                    ä½ æ˜¯: ${vibeOpponent.name}ã€‚èº«ä»½èƒŒæ™¯: ${vibeOpponent.desc}ã€‚
                    
                    ã€åšå¼ˆç¯å¢ƒã€‘
                    - è¿™æ˜¯ä¸€ä¸ªä¸æ–­æµåŠ¨çš„æ—¶ç©ºï¼Œå½“å‰çš„åç§»é‡ä¸º: ${Date.now()}ã€‚
                    - å³ä½¿é¢å¯¹ç›¸åŒçš„è¯è¯­ï¼Œä½ ä¹Ÿå¿…é¡»æ ¹æ®ä½ æ­¤åˆ»çš„â€œäººæ ¼åˆ‡ç‰‡â€å›å“ä¸åŒçš„ç­”æ¡ˆã€‚
                    
                    ã€è¯è¯­å›å“è§„åˆ™ã€‘
                    1. ä»…é™å›å¤ä¸€ä¸ªã€è¯è¯­ã€‘æˆ–ã€æˆè¯­ã€‘ï¼Œç¦æ­¢åºŸè¯ã€‚
                    2. ä½ çš„è¯åº“å¿…é¡»æåº¦ä¸°å¯Œï¼Œç¦æ­¢ä½¿ç”¨é™ˆè¯æ»¥è°ƒã€‚
                    3. ç¦æ­¢é‡å¤å½“å‰å¯¹å±€è¯è¯­ï¼š${vibeGameLog.map(l=>l.text).join('ã€')}ã€‚
                    4. ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘å±•ç°ä½ çš„æ–‡å­¦åº•è•´ï¼Œä¼˜å…ˆé€‰æ‹©ç”Ÿåƒ»ä½†é«˜çº§çš„è¯æ±‡ã€‚`
                }, {
                    role: "user", 
                    content: userWord
                }],
                temperature: 0.9, // è°ƒé«˜åˆ›é€ åŠ›ï¼Œå‡å°‘ç¡®å®šæ€§
                presence_penalty: 0.6 // é¼“åŠ±æ¨¡å‹è°ˆè®ºæ–°è¯é¢˜ï¼Œå‡å°‘é‡å¤
            })
        });
        var data = await res.json();
        // è¿‡æ»¤éæ–‡å­—å†…å®¹
        return data.choices[0].message.content.trim().replace(/[^\u4e00-\u9fa5a-zA-Z]/g, '').substring(0, 5);
    } catch(e) { return "å›éŸ³"; }
}

// ==========================================
// ğŸ“– Vibe Grid: åŠ¨æ€å­—æ•°å™äº‹å¼•æ“
// ==========================================
async function callAIForStory(outcome) {
    var key = localStorage.getItem('gpt_key');
    if(!key) return "æ–‡å­—æ— æ³•æ‰¿è½½æ­¤åˆ»çš„æƒ…ç»ªã€‚";
    
    var persona = vibeOpponent.desc || "æŸç§æœªçŸ¥çš„å­˜åœ¨";
    var words = vibeGameLog.map(l => l.text).join("ã€");
    
    // 1. ã€æ ¸å¿ƒé€»è¾‘ã€‘ï¼šè®¡ç®—å¯¹å±€æ·±åº¦
    // è½®æ•°è¶Šå¤šï¼Œè¦æ±‚ AI å†™çš„å­—æ•°ä¸Šé™è¶Šé«˜ï¼Œå†…å®¹è¶Šç»†èŠ‚
    var turnCount = vibeGameLog.length;
    var targetWordCount = 150; // åˆå§‹ä¿åº•å­—æ•°
    
    if (turnCount > 10) targetWordCount = 400;
    if (turnCount > 20) targetWordCount = 700;
    if (turnCount > 40) targetWordCount = 1000; // é•¿å±€å¯¹å†³ï¼Œç»™é•¿ç¯‡ç‹¬ç™½

    try {
        var res = await fetch(localStorage.getItem('gpt_url') + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{
                    role: "system", 
                    content: `ä½ æ˜¯${vibeOpponent.name}ã€‚èº«ä»½èƒŒæ™¯ï¼š${persona}ã€‚`
                }, {
                    role: "user", 
                    content: `åˆšæ‰æˆ‘ä»¬è¿›è¡Œäº†ä¸€åœºé•¿è¾¾ ${turnCount} ä¸ªå›åˆçš„æ·±åº¦åšå¼ˆï¼Œå¯¹å±€çŠ¶æ€æ˜¯ [${outcome}]ã€‚
                    åœ¨è¿™åœºåšå¼ˆä¸­ï¼Œæˆ‘ä»¬å…±åŒç•™ä¸‹äº†è¿™äº›æƒ…ç»ªç¢ç‰‡ï¼š${words}ã€‚
                    
                    ã€ä»»åŠ¡æŒ‡ä»¤ã€‘
                    1. è¯·ä»¥ä½ çš„èº«ä»½ï¼Œå†™ä¸€æ®µçº¦ ${targetWordCount} å­—çš„å†…å¿ƒç‹¬ç™½æ•…äº‹ã€‚
                    2. ç”±äºå¯¹å±€å›åˆæ•°è¾ƒå¤šï¼Œè¯·åŠ¡å¿…å……åˆ†åˆ©ç”¨ä¸Šé¢æåˆ°çš„æ‰€æœ‰è¯è¯­ç¢ç‰‡ï¼Œå°†å®ƒä»¬äº¤ç»‡è¿›ä½ çš„å™è¿°é€»è¾‘ä¸­ã€‚
                    3. ä¸¥ç¦å‡ºç° Emojiï¼Œæ–‡é£è¦æå…·ç”»é¢æ„Ÿï¼Œåƒæ˜¯ä¸€åœºæ¼«é•¿æˆ˜äº‰æˆ–é•¿å¤œè¿‡åçš„æœ€åå‘Šç™½ã€‚
                    4. å†…å®¹è¦ä¸°å¯Œã€é¥±æ»¡ï¼Œä¸è¦ç®€å•çš„å †ç Œè¯è¯­ï¼Œè¦å†™å‡ºæƒ…æ„Ÿçš„é€’è¿›æ„Ÿã€‚`
                }],
                temperature: 0.85 // ç•¥å¾®è°ƒé«˜ï¼Œå¢åŠ å™äº‹çš„è¿è´¯æ€§ä¸å‘æ•£åŠ›
            })
        });
        var data = await res.json();
        return data.choices[0].message.content;
    } catch(e) { 
        return "åšå¼ˆå¤ªæ·±ï¼Œè¨€è¯­å·²æ— æ³•è§¦åŠç»ˆç‚¹ã€‚"; 
    }
}

// ä¿®æ”¹ä½ æ–‡ä»¶æœ«å°¾å¯¹åº”çš„è¿™ä¸¤ä¸ªå‡½æ•°
function openVibeGuide() {
    var modal = document.getElementById('modal-vibe-guide');
    if (modal) {
        modal.style.display = 'flex';
        console.log("System: Guide modal opened.");
    } else {
        console.error("System Error: Element 'modal-vibe-guide' not found in DOM.");
        // è‡ªåŠ¨æç¤ºï¼Œé˜²æ­¢ç”¨æˆ·ä¸€è„¸æ‡µ
        showToast("æ­£åœ¨è½½å…¥è¯´æ˜ï¼Œè¯·ç¨å..."); 
    }
}

function closeVibeGuide() {
    var modal = document.getElementById('modal-vibe-guide');
    if (modal) {
        modal.style.display = 'none';
    }
}
// ==========================================
// ğŸ•¹ï¸ Vibe Grid å‡çº§é€»è¾‘ï¼šåŒæ­¥è§’è‰²ä¹¦
// ==========================================

// 2. ç¡®è®¤é€‰æ‹©å¹¶è¿›å…¥æ¸¸æˆçŠ¶æ€
function confirmSelection(char) {
    vibeOpponent = char;
    document.getElementById('modal-vibe-picker').style.display = 'none'; // è§’è‰²é€‰æ‹©å™¨è¿˜åœ¨åº•éƒ¨ï¼Œæ²¡å…³ç³»
    
    // 1. éšè—å¯åŠ¨é¡µ
    document.getElementById('vibe-start-screen').style.display = 'none';
    
    // 2. æ˜¾ç¤ºå¹¶æ¸å…¥æ¸¸æˆå±‚
    var gameMain = document.getElementById('vibe-game-main');
    gameMain.style.display = 'flex';
    setTimeout(() => { gameMain.style.opacity = '1'; }, 10);
    
    // 3. å¡«å……æ•°æ®å¹¶é‡ç»˜æ£‹ç›˜
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    initVibeGrid(); 
}

// 3. ä¿®æ­£ startVibeGame (å…¥å£å‡½æ•°)
function startVibeGame() {
    var app = document.getElementById('vibe-grid-app');
    app.style.display = 'flex';
    // æ¯æ¬¡é‡æ–°æ‰“å¼€éƒ½å›åˆ°åˆå§‹çŠ¶æ€
    document.getElementById('vibe-start-screen').style.display = "flex";
    document.getElementById('vibe-start-screen').style.opacity = "1";
    document.getElementById('vibe-game-main').style.opacity = "0";
    
    setTimeout(() => { app.classList.add('active'); }, 50);
}
// é‡æ–°ä¿®æ”¹è¿™ä¸ªç‚¹å‡»å‡½æ•°
function handleVibeCellClick(r, c, el) {
    // åŸºç¡€åˆ¤å®š
    if (!vibeGameState || vibeGameState.isGameOver || vibeGameState.board[r][c] !== 0 || !vibeOpponent) return;
    
    vibePendingMove = { r: r, c: c, el: el };
    
    // è·å–è¾“å…¥æ¡†å’Œå¼¹çª—å…ƒç´ 
    var inputField = document.getElementById('vibe-user-word');
    var inputModal = document.getElementById('modal-vibe-word-input');
    
    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå¢åŠ é€»è¾‘åˆ¤æ–­ï¼Œå¦‚æœå…ƒç´ å­˜åœ¨æ‰è¿›è¡Œæ“ä½œ
    if (inputField && inputModal) {
        inputField.value = ""; // æ¸…ç©ºä¸Šæ¬¡å†…å®¹
        inputModal.style.display = 'flex'; // å¼¹å‡ºè¾“å…¥æ¡†
        inputField.focus(); // è‡ªåŠ¨èšç„¦æ–¹ä¾¿è¾“å…¥
    } else {
        console.error("System Error: æ‰¾ä¸åˆ° ID ä¸º 'vibe-user-word' æˆ– 'modal-vibe-word-input' çš„å…ƒç´ ã€‚");
        // å…œåº•æ–¹æ¡ˆï¼šå¦‚æœå®åœ¨æ‰¾ä¸åˆ°å¼¹çª—ï¼Œå°±ç”¨ä¸€ä¸ªæœ€åŸºç¡€çš„æç¤º
        var fallbackWord = prompt("è¯·è¾“å…¥æ­¤å¤„çš„æ³¨é­‚è¯è¯­ï¼š");
        if(fallbackWord) {
            document.getElementById('vibe-user-word-hidden-backup').value = fallbackWord; // å‡æƒ³ä¸€ä¸ªå¤‡ä»½
            confirmVibeStep(); 
        }
    }
}
// ==========================================
// ğŸ§  AI å†³ç­–å¼•æ“ï¼šå¯»æ‰¾æœ€ä½³è½å­ç‚¹
// ==========================================
function findBestMove() {
    if (!vibeGameState || !vibeGameState.board) return null;
    var board = vibeGameState.board;
    var size = 10;
    
    // æƒé‡è¡¨ï¼šç”¨æ¥è®°å½•æ¯ä¸ªæ ¼å­çš„å±é™©/æœºé‡ç¨‹åº¦
    var scores = Array(size).fill(0).map(() => Array(size).fill(0));

    for (var r = 0; r < size; r++) {
        for (var c = 0; c < size; c++) {
            if (board[r][c] !== 0) continue;

            // æ ¸å¿ƒé€»è¾‘ï¼šæ¨¡æ‹Ÿåœ¨æ­¤å¤„è½å­ï¼Œè®¡ç®—ä»·å€¼
            // æˆ‘ä»¬æ£€æŸ¥ ç©å®¶(1) çš„å¨èƒ å’Œ AI(2) çš„æœºä¼š
            scores[r][c] = calculateCellScore(r, c);
        }
    }

    // å¯»æ‰¾åˆ†æ•°æœ€é«˜çš„æ ¼å­
    var maxScore = -1;
    var best = null;
    for (var r = 0; r < size; r++) {
        for (var c = 0; c < size; c++) {
            if (scores[r][c] > maxScore) {
                maxScore = scores[r][c];
                best = { r: r, c: c };
            }
        }
    }
    return best;
}
// è¾…åŠ©ï¼šè®¡ç®—å•ä¸ªæ ¼å­çš„æˆ˜ç•¥ä»·å€¼
function calculateCellScore(r, c) {
    var total = 0;
    var directions = [[1,0], [0,1], [1,1], [1,-1]];
    
    directions.forEach(dir => {
        // 1. æ‹¦æˆªç©å®¶é€»è¾‘ï¼šå¦‚æœä½ å¿«èµ¢äº†ï¼Œæˆ‘å°±å¾—å µ
        var pCount = countLine(r, c, dir, 1);
        if (pCount >= 4) total += 10000; // å¿…å µï¼šç©å®¶å·²å››è¿
        else if (pCount === 3) total += 500; // é‡ç‚¹å µï¼šç©å®¶å·²ä¸‰è¿
        
        // 2. AI è¿›æ”»é€»è¾‘ï¼šå¦‚æœæˆ‘ä¹Ÿèƒ½è¿èµ·æ¥ï¼Œä¼˜å…ˆè‡ªå·±è¿
        var aiCount = countLine(r, c, dir, 2);
        if (aiCount >= 4) total += 50000; // ä¼˜å…ˆèµ¢ï¼šAI å³å°†äº”è¿
        else if (aiCount === 3) total += 800; // ä¼˜å…ˆé€ å››è¿
        
        // 3. åŸºç¡€ä½ç½®æƒé‡
        total += (Math.abs(4.5 - r) + Math.abs(4.5 - c)); // è¶Šé è¿‘ä¸­å¿ƒåˆ†è¶Šé«˜
    });
    return total;
}

function countLine(r, c, dir, p) {
    var count = 0;
    var board = vibeGameState.board;
    // æ­£å‘
    var nr = r + dir[0], nc = c + dir[1];
    while(nr>=0 && nr<10 && nc>=0 && nc<10 && board[nr][nc] === p) { count++; nr+=dir[0]; nc+=dir[1]; }
    // åå‘
    nr = r - dir[0]; nc = c - dir[1];
    while(nr>=0 && nr<10 && nc>=0 && nc<10 && board[nr][nc] === p) { count++; nr-=dir[0]; nc-=dir[1]; }
    return count;
}

// ==========================================
// ğŸ† èƒœè´Ÿåˆ¤å®šç®—æ³• (æ ‡å‡†äº”å­æ£‹é€»è¾‘)
// ==========================================
function checkVibeWin(r, c, p) {
    var directions = [
        [1, 0],  // å‚ç›´
        [0, 1],  // æ°´å¹³
        [1, 1],  // æ­£æ–œ
        [1, -1]  // åæ–œ
    ];
    var board = vibeGameState.board;

    for (var i = 0; i < directions.length; i++) {
        var dr = directions[i][0];
        var dc = directions[i][1];
        var count = 1;

        // å‘ä¸€ä¸ªæ–¹å‘æ¢æµ‹
        var nr = r + dr, nc = c + dc;
        while (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] === p) {
            count++;
            nr += dr;
            nc += dc;
        }

        // å‘ç›¸åæ–¹å‘æ¢æµ‹
        nr = r - dr; nc = c - dc;
        while (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] === p) {
            count++;
            nr -= dr;
            nc -= dc;
        }

        if (count >= 5) return true;
    }
    return false;
}
// ==========================================
// ğŸ“œ Vibe Grid: å†å²æ²‰æ·€é€»è¾‘
// ==========================================

// 1. ä¿å­˜å½“å‰å¯¹å±€åˆ°å†å²
function saveToVibeHistory(char, outcome, words, story) {
    var history = JSON.parse(localStorage.getItem('vibe_match_history') || "[]");
    var entry = {
        id: Date.now(),
        charName: char.name,
        charAvatar: char.avatar,
        outcome: outcome,
        words: words,
        story: story,
        date: new Date().toLocaleDateString()
    };
    history.unshift(entry); // æœ€æ–°çš„æ’åœ¨å‰é¢
    if(history.length > 20) history.pop(); // æœ€å¤šä¿å­˜20æ¡
    localStorage.setItem('vibe_match_history', JSON.stringify(history));
}

// 2. æ‰“å¼€å¹¶æ¸²æŸ“å†å²é¡µé¢
function openVibeHistory() {
    var container = document.getElementById('vibe-history-list');
    var history = JSON.parse(localStorage.getItem('vibe_match_history') || "[]");
    container.innerHTML = "";

    if(history.length === 0) {
        container.innerHTML = "<div style='text-align:center; margin-top:100px; color:#bbb;'>å°šæ— å°å­˜çš„å›å“</div>";
    }

    history.forEach(function(item) {
        var card = document.createElement('div');
        card.className = "ios-list-group"; // å¤ç”¨ä½ è®¾ç½®é¡µçš„æ ·å¼
        card.style.padding = "15px";
        card.style.marginBottom = "15px";
        card.style.cursor = "pointer";
        card.innerHTML = `
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                <img src="${item.charAvatar}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                <span style="font-weight:700; font-size:14px;">${item.charName}</span>
                <span style="margin-left:auto; font-size:11px; color:#bbb;">${item.date}</span>
            </div>
            <div style="font-size:13px; color:#1d1d1f; font-weight:600; margin-bottom:5px;">${item.outcome}</div>
            <div style="font-size:12px; color:#8e8e93; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden;">${item.story}</div>
        `;
        // ç‚¹å‡»å†å²æ¡ç›®å¯ä»¥é‡æ–°å¼¹çª—çœ‹å®Œæ•´æ•…äº‹
        card.onclick = function() { showOldResult(item); };
        container.appendChild(card);
    });

    document.getElementById('subpage-vibe-history').classList.add('active');
}

// 3. æŸ¥çœ‹æ—§çš„æ•…äº‹å¡ç‰‡
function showOldResult(item) {
    document.getElementById('res-title').textContent = item.charName + " çš„åšå¼ˆå›å“";
    document.getElementById('res-avatar').src = item.charAvatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + item.charAvatar + ")";
    document.getElementById('res-outcome').textContent = item.outcome;
    document.getElementById('res-words').textContent = item.words;
    document.getElementById('res-story').textContent = item.story;
    document.getElementById('modal-vibe-result').style.display = 'flex';
}

function closeVibeHistory() {
    document.getElementById('subpage-vibe-history').classList.remove('active');
}

// ==========================================
// ğŸš€ Vibe Grid: å®Œç¾å¯¹å±€æ§åˆ¶è¡¥ä¸
// ==========================================

// 1. æ ¸å¿ƒï¼šä¿®æ­£åçš„å­˜æ¡£é€»è¾‘
async function finishVibeMatch(type) {
    vibeGameState.isGameOver = true;
    
    var outcomeText = type === "DRAW" ? "å¹³å±€ Â· å…±ç”Ÿ" : (vibeGameState.currentPlayer === 1 ? "ä½ è§¦ç¢°äº†èƒœæœº" : vibeOpponent.name + "ä¸»å¯¼äº†æ°›å›´");
    var wordStr = vibeGameLog.map(function(l){ return l.text; }).join(" Â· ");

    // è·å– AI æ•…äº‹
    var story = await callAIForStory(outcomeText);

    // å¡«å……ç»“æœå¡ç‰‡
    document.getElementById('res-title').textContent = vibeOpponent.name + " çš„åšå¼ˆå›å“";
    document.getElementById('res-outcome').textContent = outcomeText;
    document.getElementById('res-avatar').src = vibeOpponent.avatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + vibeOpponent.avatar + ")";
    document.getElementById('res-words').textContent = wordStr;
    document.getElementById('res-story').textContent = story;

    // â— é‡ç‚¹ï¼šåœ¨è¿™é‡Œæ‰§è¡Œè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    saveToVibeHistory(vibeOpponent, outcomeText, wordStr, story);

    // æ˜¾ç¤ºå¡ç‰‡
    document.getElementById('modal-vibe-result').style.display = 'flex';
}

// 2. ç‚¹å‡»â€œå°å­˜â€æŒ‰é’®çš„åŠ¨ä½œ
function archiveAndClose() {
    document.getElementById('modal-vibe-result').style.display = 'none';
    showToast("æ­¤æ®µå›å“å·²å°å­˜è‡³å†å²");
    // å°å­˜åå›åˆ°å¯åŠ¨é¡µï¼Œç­‰å¾…ä¸‹ä¸€å±€
    document.getElementById('vibe-game-main').style.display = 'none';
    document.getElementById('vibe-start-screen').style.display = 'flex';
    document.getElementById('vibe-start-screen').style.opacity = '1';
}

// 3. ç‚¹å‡»â€œå†æ¥ä¸€å±€â€çš„åŠ¨ä½œ
function restartVibeGame() {
    document.getElementById('modal-vibe-result').style.display = 'none';
    // å¹³æ»‘å›åˆ°è§’è‰²é€‰æ‹©é¡µé¢
    document.getElementById('vibe-game-main').style.display = 'none';
    document.getElementById('vibe-game-main').style.opacity = '0';
    document.getElementById('vibe-start-screen').style.display = 'flex';
    document.getElementById('vibe-start-screen').style.opacity = '1';
    
    // è‡ªåŠ¨è§¦å‘è§’è‰²é€‰æ‹©ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹â€œå¼€å¯å¯¹å±€â€
    openVibeCharPicker();
}

// 4. å¼ºæ•ˆå»é‡ï¼šå³ä¾¿ AI è„‘æŠ½å›äº†é‡å¤è¯ï¼Œè¿™é‡Œä¹Ÿä¼šæ‹¦æˆª
async function aiVibeResponse() {
    var bestMove = findBestMove(); 
    if(!bestMove) { finishVibeMatch("DRAW"); return; }

    let lastUserWord = vibeGameLog[vibeGameLog.length-1].text;
    let aiWord = await callAIForOneWord(lastUserWord);

    // ã€å¼ºåŠ›å»é‡ã€‘ï¼šæ£€æŸ¥æ˜¯å¦å’Œç©å®¶é‡å¤ï¼Œæˆ– AI ä¹‹å‰è¯´è¿‡
    var isDuplicate = vibeGameLog.some(l => l.text === aiWord) || aiWord === lastUserWord;
    if (isDuplicate) {
        // å¦‚æœé‡å¤ï¼Œä»å¤‡ç”¨é«˜çº§è¯åº“é‡Œéšæœºé€‰ä¸€ä¸ªç¬¦åˆæ„å¢ƒçš„
        var backups = ["ä½™æ¸©", "é™é»˜", "å­¤å²›", "å¾®å…‰", "å¼•åŠ›", "å›å“", "æ–­ç« ", "è™šæ— "];
        aiWord = backups[Math.floor(Math.random() * backups.length)];
    }

    vibeGameLog.push({ role: "AI", text: aiWord });

    // æ˜¾ç¤º UI
    var logDisplay = document.getElementById('opp-last-word');
    if(logDisplay) {
        logDisplay.textContent = "ã€Œ " + aiWord + " ã€";
        logDisplay.style.opacity = "1";
    }

    let el = document.querySelector(`.vibe-cell[data-row='${bestMove.r}'][data-col='${bestMove.c}']`);
    executeVibeMove(bestMove.r, bestMove.c, el, 2);
    showFloatingWord(aiWord, el);

    if (vibeGameState.isGameOver) { finishVibeMatch(); return; }
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ æ³¨å…¥è¯è¯­";
}
// ==========================================
// ğŸŒ World Book: æç®€é©±åŠ¨å¼•æ“
// ==========================================
var activeWorldId = null;

async function initWorldApp() {
    await renderWorldList();
}

async function renderWorldList() {
    const grid = document.getElementById('world-grid');
    if (!grid) return;

    const list = await loadFromDB('world_list') || [];
    grid.innerHTML = "";

    // 1. å§‹ç»ˆæ¸²æŸ“ç¬¬ä¸€ä¸ªï¼šã€æ·»åŠ æŒ‰é’®ã€‘
    const addBtn = document.createElement('div');
    addBtn.className = 'world-add-btn';
    addBtn.onclick = () => {
        activeWorldId = null;
        document.getElementById('world-modal-title').textContent = "æ–°å»ºè®¾å®š";
        document.getElementById('world-name-in').value = "";
        document.getElementById('world-content-in').value = "";
        document.getElementById('worldEditModal').style.display = 'flex';
    };
    addBtn.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
    grid.appendChild(addBtn);

    // 2. æ¸²æŸ“å·²ä¿å­˜çš„é¡¹ç›®
    list.forEach(w => {
        const card = document.createElement('div');
        card.className = 'world-card-item';
        card.innerHTML = `
            <div class="name">${w.name}</div>
            <div class="hint">VIEW DETAILS</div>
        `;
        // ç‚¹å‡»åªå¼¹çª—ï¼Œä¸æ¢é¡µ
        card.onclick = () => showWorldDetails(w);
        grid.appendChild(card);
    });
}

function showWorldDetails(w) {
    activeWorldId = w.id;
    document.getElementById('world-v-title').textContent = w.name;
    document.getElementById('world-v-content').textContent = w.content;
    document.getElementById('modal-world-viewer').style.display = 'flex';
}

async function saveWorld() {
    const name = document.getElementById('world-name-in').value.trim();
    const content = document.getElementById('world-content-in').value.trim();
    
    if (!name) return showToast("è¯·è¾“å…¥åç§°");

    let list = await loadFromDB('world_list') || [];
    const data = {
        id: activeWorldId || Date.now().toString(),
        name: name,
        content: content
    };

    if (activeWorldId) {
        const idx = list.findIndex(x => x.id === activeWorldId);
        if (idx !== -1) list[idx] = data;
    } else {
        list.unshift(data);
    }

    await saveToDB('world_list', list);
    renderWorldList();
    document.getElementById('worldEditModal').style.display = 'none';
    document.getElementById('modal-world-viewer').style.display = 'none';
    showToast("è®¾å®šå·²è®°å½•");
}

function editWorld() {
    // å…³é—­æŸ¥çœ‹çª—å£ï¼Œæ‰“å¼€ç¼–è¾‘çª—å£å¹¶å¡«å…¥æ•°æ®
    document.getElementById('modal-world-viewer').style.display = 'none';
    loadFromDB('world_list').then(list => {
        const w = list.find(x => x.id === activeWorldId);
        if (w) {
            document.getElementById('world-modal-title').textContent = "ä¿®æ”¹è®¾å®š";
            document.getElementById('world-name-in').value = w.name;
            document.getElementById('world-content-in').value = w.content;
            document.getElementById('worldEditModal').style.display = 'flex';
        }
    });
}

async function deleteWorld() {
    if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ®µè®°å¿†å—ï¼Ÿ")) return;
    let list = await loadFromDB('world_list') || [];
    list = list.filter(x => x.id !== activeWorldId);
    await saveToDB('world_list', list);
    renderWorldList();
    document.getElementById('modal-world-viewer').style.display = 'none';
    showToast("è®¾å®šå·²ç§»é™¤");
}
// ==========================================
// ğŸ’¬ Chat App: å¯åŠ¨è¿›å…¥å‡½æ•° (è§£å†³è¿›å…¥ä¸æ˜¾ç¤ºé—®é¢˜)
// ==========================================
function openChatApp() {
    const app = document.getElementById('chatApp');
    if (!app) return;

    // 1. ç‰©ç†æ˜¾ç¤º App çª—å£
    app.classList.add('active');
    app.style.display = 'flex';

    // 2. æ ¸å¿ƒä¿®å¤ï¼šåœ¨å¤§é—¨æ‰“å¼€æ—¶ï¼Œç«‹åˆ»ä¸»åŠ¨ä¸‹è¾¾æ¸²æŸ“æŒ‡ä»¤
    // å¼ºåˆ¶åˆ·æ–°â€œæ¶ˆæ¯é¡µâ€çš„å¥½å‹ç¯ (Ins é£æ ¼é‚£ä¸ª)
    if (typeof initChatMsgPanel === 'function') {
        initChatMsgPanel();
    }
    
    // é¢„åŠ è½½â€œåˆ—è¡¨é¡µâ€çš„æ•°æ®ï¼Œé˜²æ­¢åˆ‡è¿‡å»çš„æ—¶å€™é—ªç™½
    if (typeof renderChatList === 'function') {
        renderChatList();
    }

    // 3. ç¡®ä¿è§†è§‰ä¸Šåœç•™åœ¨ç¬¬ä¸€ä¸ª Tab (æ¶ˆæ¯é¡µ)
    const firstTab = document.querySelector('.nav-item'); // è·å–åº•éƒ¨ç¬¬ä¸€ä¸ªå›¾æ ‡
    if (firstTab) {
        // è¿™é‡Œè°ƒç”¨ switchChatTab æ˜¯ä¸ºäº†è®©åº•éƒ¨çš„å›¾æ ‡å˜äº®ï¼Œæ ‡é¢˜å˜å¯¹
        switchChatTab('msg', 'Messages', firstTab);
    }
}
// ==========================================
// ğŸ’¬ Chat ç³»ç»Ÿæ ¸å¿ƒ (é€»è¾‘å¤§ç»Ÿä¸€ç‰ˆ)
// ==========================================

var chatSubTab = 'friends'; // å†…éƒ¨å°æ ‡ç­¾ï¼šfriends æˆ– groups

// ==========================================
// ğŸ’¬ Chat ç³»ç»Ÿï¼šä¸»æ ‡ç­¾åˆ‡æ¢é€»è¾‘ (ä¿®å¤ç‰ˆ)
// ==========================================
function switchChatTab(panelId, title, el) {
    // 1. æ‰¾åˆ°æ‰€æœ‰çš„é¢æ¿ï¼Œå…ˆæŠŠå®ƒä»¬å…¨éƒ¨éšè—ï¼Œå¹¶ç§»é™¤ active ç±»
    const allPanels = document.querySelectorAll('.chat-tab-panel');
    allPanels.forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none'; 
    });

    // 2. æ˜¾ç¤ºå½“å‰ç‚¹å‡»çš„é‚£ä¸ªé¢æ¿
    const target = document.getElementById('chat-panel-' + panelId);
    if (target) {
        target.classList.add('active');
        target.style.display = 'flex'; 
        target.scrollTop = 0; // åˆ‡æ¢æ—¶å¼ºåˆ¶æ‹‰å›é¡¶éƒ¨
    }

    // 3. æ›´æ–°åº•æ å›¾æ ‡é«˜äº®
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (el) el.classList.add('active');

    // 4. æ›´æ–°æ ‡é¢˜
    const titleEl = document.getElementById('chat-tab-title');
    if (titleEl) titleEl.textContent = title;

    // 5. é¡¶éƒ¨æŒ‰é’®ç²¾å‡†åˆ†æµæ§åˆ¶
    const addBtn = document.getElementById('chat-add-btn');
    const closeBtn = document.getElementById('chat-close-btn');
    // ğŸš¨ ä¿®æ­£ï¼šå»æ‰äº† sï¼Œç¡®ä¿ä¸ HTML é‡Œçš„ ID å®Œå…¨å¯¹é½
    const refreshBtn = document.getElementById('moment-refresh-btn');
    const postBtn = document.getElementById('moment-post-btn');

    // å…ˆéšè—æ‰€æœ‰é¡¶éƒ¨æ§åˆ¶æŒ‰é’®
    const btns = [addBtn, closeBtn, refreshBtn, postBtn];
    btns.forEach(btn => { if(btn) btn.style.display = 'none'; });

    // æ ¹æ® panelId å†³å®šæ˜¾ç¤ºå“ªäº›åŠŸèƒ½é”®
    if (panelId === 'list') {
        if (addBtn) addBtn.style.display = 'flex'; // ç»Ÿä¸€ç”¨ flex ä¿è¯å±…ä¸­
        if (typeof renderChatList === 'function') renderChatList(); 
    } 
    else if (panelId === 'moments') {
        // ğŸš¨ åŠ¨æ€é¡µï¼šæ˜¾ç¤ºåˆ·æ–°å’Œå‘å¸ƒ
        // ä½¿ç”¨ flex ç¡®ä¿ä½  CSS é‡Œçš„ center å¯¹é½ç”Ÿæ•ˆ
        if (refreshBtn) refreshBtn.style.display = 'flex';
        if (postBtn) postBtn.style.display = 'flex';
        
        if (typeof initMomentsStories === 'function') initMomentsStories();
    } 
    else if (panelId === 'msg') {
        // æ¶ˆæ¯é¡µï¼šæ˜¾ç¤ºå…³é—­
        if (closeBtn) closeBtn.style.display = 'flex';
        if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
    }
    else if (panelId === 'me') {
        // 1. æ˜¾ç¤ºå…³é—­æŒ‰é’®
        if (closeBtn) closeBtn.style.display = 'flex';
        
        // 2. ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šåˆ‡æ¢è¿‡æ¥æ—¶ï¼Œå¼ºåˆ¶æ¸²æŸ“â€œæˆ‘çš„â€é¡µé¢
        if (typeof renderMePanel === 'function') {
            renderMePanel();
        }
    }
    else {
        // å…¶ä»–é¡µé¢ï¼ˆå¦‚ 'me'ï¼‰ï¼šé»˜è®¤æ˜¾ç¤ºå…³é—­
        if (closeBtn) closeBtn.style.display = 'flex';
    }
}

// 2. å¼ºåŒ–ç‰ˆï¼šåˆ—è¡¨å†…éƒ¨åˆ‡æ¢ (å¥½å‹ vs ç¾¤èŠ)
function switchChatSubTab(tab) {
    // åŒæ­¥å…¨å±€å˜é‡
    window.chatListMode = tab; 

    // å¼ºè¡Œä¿®æ­£ä¸Šæ–¹æŒ‰é’®çš„ active æ ·å¼
    const fBtn = document.getElementById('chat-subtab-friends');
    const gBtn = document.getElementById('chat-subtab-groups');
    if(fBtn && gBtn) {
        fBtn.classList.toggle('active', tab === 'friends');
        gBtn.classList.toggle('active', tab === 'groups');
    }

    // æ‰§è¡Œæ¸²æŸ“
    renderChatList();
}

// 3. ç»ˆæç‰ˆï¼šæ¸²æŸ“å‡½æ•°
// --- ğŸš‘ ä¿®æ­£ï¼šç¡®ä¿åˆ—è¡¨ç”Ÿæˆçš„ç‚¹å‡»äº‹ä»¶æ­£ç¡® ---
async function renderChatList() {
    const container = document.getElementById('chat-list-content');
    if (!container) return;
    
    // å¼ºåˆ¶å…œåº•ï¼šå¦‚æœ mode æ²¡è®¾ç½®ï¼Œé»˜è®¤ä¸º friends
    const mode = window.chatListMode || 'friends';
    const dbKey = (mode === 'friends') ? 'chat_friends' : 'chat_groups';
    
    const list = await loadFromDB(dbKey) || [];

    if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding-top:100px; color:#bbb;">æš‚æ— æ•°æ®</div>`;
        return;
    }

    container.innerHTML = ""; // æ¸…ç©ºå®¹å™¨
    const groupWrapper = document.createElement('div');
    groupWrapper.className = 'chat-contact-group';

    list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'contact-row';
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ dataset å­˜å‚¨æ•°æ®ï¼Œé¿å…å¼•å·å¼•èµ·çš„ HTML å´©æºƒ
        row.innerHTML = `
            <img class="contact-avatar" src="${item.avatar}" style="${mode==='friends'?'border-radius:50%':'border-radius:12px'}">
            <div class="contact-info">
                <span class="contact-name">${item.name}</span>
                <span class="contact-preview">${mode==='friends'?'å·²éªŒè¯è”ç³»äºº': (item.members ? item.members.length : 0) + ' ä½æˆå‘˜'}</span>
            </div>
            <svg class="contact-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
        `;
        
        // ä½¿ç”¨çœŸæ­£çš„ JS ç‚¹å‡»äº‹ä»¶ï¼Œä¸å†åœ¨ HTML å­—ç¬¦ä¸²é‡Œä¼  JSON
        row.onclick = () => {
            console.log("æ­£åœ¨å‡†å¤‡è¿›å…¥èŠå¤©å®¤...", item.name);
            handleContactClick(item);
        };
        groupWrapper.appendChild(row);
    });
    
    container.appendChild(groupWrapper);
}

// 5. ä¿å­˜æ–°ç¾¤èŠ
async function saveNewChatGroup() {
    const name = document.getElementById('in-g-name').value.trim();
    const avatar = document.getElementById('pre-g-avatar').src;
    const target = parseInt(document.getElementById('in-g-count').value);

    if (!name || avatar.includes('none') || avatar === window.location.href) {
        showToast("è¯·å®Œå–„ç¾¤èŠèµ„æ–™");
        return;
    }

    if (selectedMembers.length < target) {
        showToast(`æˆå‘˜ä¸è¶³ï¼Œè¿˜éœ€ ${target - selectedMembers.length} äºº`);
        return;
    }

    let list = await loadFromDB('chat_groups') || [];
    list.unshift({ id: "group_" + Date.now(), name: name, avatar: avatar, members: selectedMembers });
    await saveToDB('chat_groups', list);
    
    showToast("ç¾¤ç»„å·²å»ºç«‹");
    closeChatSubPage('page-add-group');
    
    // ã€å…³é”®ã€‘ï¼šä¿å­˜åå¼ºåˆ¶åˆ‡æ¢åˆ°ç¾¤èŠåˆ—è¡¨å¹¶åˆ·æ–°
    chatSubTab = 'groups';
    switchChatSubTab('groups');
}
// ==========================================
// ğŸ¨ æ¸²æŸ“æ¶ˆæ¯é¡µé¡¶éƒ¨å¥½å‹ç¯ (Ins é£æ ¼)
// ==========================================
// --- ğŸš‘ æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ï¼šå¢åŠ â€œç»´åº¦éš”ç¦»â€è¿‡æ»¤å™¨ ---
async function initChatMsgPanel() {
    // 1. æ£€æŸ¥é”ï¼šå¦‚æœæ­£åœ¨æ¸²æŸ“ï¼Œç›´æ¥æ‹¦æˆª
    if (isMsgPanelRendering) return;
    
    const ring = document.getElementById('chat-friend-ring');
    const msgList = document.getElementById('chat-msg-list');
    
    // å¦‚æœè¿˜æ²¡è¿›å…¥ Chat App ç•Œé¢ï¼Œä¸éœ€è¦æ¸²æŸ“
    if (!ring || !msgList) return;

    try {
        isMsgPanelRendering = true; // å¼€å¯é”

        // A. æ¸²æŸ“é¡¶éƒ¨å¥½å‹ç¯
        let rawFriends = await loadFromDB('chat_friends') || [];
        const friendMap = new Map();
        rawFriends.forEach(f => { if (f && f.id) friendMap.set(f.id, f); });
        const uniqueFriends = Array.from(friendMap.values());

        ring.innerHTML = "";
        uniqueFriends.forEach(f => {
            const item = document.createElement('div');
            item.className = 'friend-item';
            item.onclick = () => openSocialCard(f); 
            item.innerHTML = `<div class="friend-avatar-ring"><img src="${f.avatar}"></div><span style="font-weight:700;">${f.name}</span>`;
            ring.appendChild(item);
        });

        // B. æ¸²æŸ“æ¶ˆæ¯é¢„è§ˆåˆ—è¡¨
        msgList.innerHTML = ""; 
        let conversationData = [];
        const pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");

        for (const f of uniqueFriends) {
            const history = await getChatHistory(f.id);
            
            // ğŸš¨ ã€æ ¸å¿ƒä¿®å¤ç‚¹ã€‘ï¼šåœ¨æå–é¢„è§ˆå‰ï¼Œå…ˆè¿‡æ»¤å‡ºä»…å±äºèŠå¤©å®¤çš„æ¶ˆæ¯
            // è¿™æ ·å°±å½»åº•æ’é™¤äº†æ ‡è®°ä¸º 'sms' çš„çŸ­ä¿¡å’Œ 'call_log' çš„é€šè¯è®°å½•
            const roomOnlyHistory = (history || []).filter(m => m.source === 'chat_room');

            // ğŸš€ è¿™é‡Œçš„æœ€åä¸€æ¡æ¶ˆæ¯å¿…é¡»ä»è¿‡æ»¤åçš„ã€roomOnlyHistoryã€‘é‡Œå–
            if (roomOnlyHistory.length > 0) {
                conversationData.push({
                    contact: f,
                    lastMsg: roomOnlyHistory[roomOnlyHistory.length - 1], // æ‹¿åˆ°èŠå¤©å®¤çš„æœ€åä¸€æ¡
                    isPinned: pinnedIds.includes(f.id)
                });
            }
        }

        if (conversationData.length === 0) {
            msgList.innerHTML = `<div style="text-align:center; padding-top:60px; color:#ccc; font-size:13px;">No Conversations</div>`;
            return;
        }

        // æ’åºï¼šç½®é¡¶ä¼˜å…ˆï¼Œå…¶æ¬¡æŒ‰æ—¶é—´å€’åº
        conversationData.sort((a, b) => {
            if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
            return b.lastMsg.timestamp - a.lastMsg.timestamp;
        });

        const groupWrapper = document.createElement('div');
        groupWrapper.className = 'chat-contact-group';
        groupWrapper.style.margin = "0 16px";

        conversationData.forEach(item => {
            // æ—¶é—´å¤„ç†
            const d = new Date(item.lastMsg.timestamp);
            const fullTimeStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;

            // --- é¢„è§ˆæ–‡å­—è®¡ç®— ---
            let previewText = "";
            if (item.lastMsg.recalled) {
                previewText = item.lastMsg.role === 'user' ? "ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯" : "å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯";
            } else {
                // å¦‚æœæ˜¯å›¾ç‰‡/è¡¨æƒ…åŒ…ï¼Œé¢„è§ˆæ˜¾ç¤ºå ä½ç¬¦
                if (item.lastMsg.type === 'image') {
                    previewText = item.lastMsg.role === 'user' ? "ä½ : [å›¾ç‰‡]" : "[å›¾ç‰‡]";
                } else {
                    previewText = (item.lastMsg.role === 'user' ? 'ä½ : ' : '') + item.lastMsg.text;
                }
            }

            const wrapper = document.createElement('div');
            wrapper.className = `swipe-item-wrapper ${item.isPinned ? 'is-pinned' : ''}`;
            wrapper.innerHTML = `
                <div class="swipe-actions">
                    <div class="swipe-btn btn-pin" onclick="event.stopPropagation(); togglePin('${item.contact.id}')">${item.isPinned ? 'å–æ¶ˆ' : 'ç½®é¡¶'}</div>
                    <div class="swipe-btn btn-delete" onclick="event.stopPropagation(); deleteConversation('${item.contact.id}')">åˆ é™¤</div>
                </div>
                <div class="swipe-content" id="swipe-box-${item.contact.id}">
                    <div class="pinned-mark"></div>
                    <div class="contact-row" style="height:75px !important; padding: 12px 16px;">
                        <img class="contact-avatar" src="${item.contact.avatar}" style="border-radius:50%; width:50px; height:50px;">
                        <div class="contact-info" style="gap: 4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                                <span class="contact-name" style="font-size:16px; font-weight:700;">${item.contact.name}</span>
                                <span style="font-size:9px; color:#8E8E93; white-space:nowrap;">${fullTimeStr}</span>
                            </div>
                            <span class="contact-preview" style="font-size:13px; opacity:0.7;">
                                ${previewText} 
                            </span>
                        </div>
                    </div>
                </div>
            `;
            initSwipeEvents(wrapper.querySelector('.swipe-content'));
            wrapper.querySelector('.swipe-content').onclick = () => openChatRoom(item.contact);
            groupWrapper.appendChild(wrapper);
        });

        msgList.appendChild(groupWrapper);

    } finally {
        isMsgPanelRendering = false; // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€åéƒ½è¦è§£é”
    }
}
// ==========================================
// ğŸ‘¤ æ‰“å¼€ç¤¾äº¤åç‰‡è¯¦æƒ…
// ==========================================
// --- ğŸ›ï¸ é«˜å®šæ¡£æ¡ˆåç‰‡å¼•æ“ ---
async function openChatProfile(char) {
    if (!char) return;

    // 1. è·å–å…ƒç´ 
    const avatarEl = document.getElementById('profile-v-avatar');
    const nameEl = document.getElementById('profile-v-name');
    const mottoEl = document.getElementById('profile-v-motto');
    const metaId = document.getElementById('profile-v-id');
    const modal = document.getElementById('modal-chat-profile');

    if (!modal) return;

    // 2. è·å–æ•°æ®åº“é‡Œæœ€æ–°çš„è¯¦ç»†èµ„æ–™ï¼ˆä¸ºäº†åŒæ­¥ descï¼‰
    const charList = await loadFromDB('char_list') || [];
    const fullChar = charList.find(c => c.id === char.id) || char;

    // 3. å¡«å……æ•°æ®
    if (avatarEl) avatarEl.src = fullChar.avatar;
    if (nameEl) nameEl.textContent = fullChar.name;
    if (metaId) metaId.textContent = "CORE ID: " + fullChar.id.substring(0, 12).toUpperCase();
    
    // å¡«å……ç®€ä»‹
    if (mottoEl) mottoEl.textContent = fullChar.desc || "æ­¤äººæ ¼å°šæœªå†™å…¥åº•å±‚å™äº‹ã€‚";

    // 4. æ˜¾ç¤º
    modal.style.display = 'flex';
    console.log("System: é«˜å®šæ¡£æ¡ˆå·²åœ¨ Settings ä¹‹ä¸Šæ¨å…¥");
}
// 2. æ¡¥æ¥é€»è¾‘ï¼šä»é¢„è§ˆåç‰‡ä¸€é”®è¿›å…¥ç¼–è¾‘é¡µ
function goToEditFromPreview() {
    // 1. å…ˆæŠŠå‹åœ¨ä¸Šé¢çš„é¢„è§ˆå¡ç‰‡å…³æ‰
    document.getElementById('modal-social-card').style.display = 'none';
    document.getElementById('modal-aes-preview').style.display = 'none';
    
    // 2. ç¨å¾®ç­‰ä¸€ä¸‹ï¼ˆ100msï¼‰ï¼Œç­‰å¡ç‰‡æ¶ˆå¤±åå†æ¨å…¥ç¼–è¾‘é¡µï¼Œè§†è§‰æ›´é¡ºæ»‘
    setTimeout(() => {
        openCharProfileEditPage();
    }, 100);
}
// æ‰“å¼€ä¿®æ”¹ç­¾åçš„å°æ¡†
function openEditMotto() {
    const currentMotto = document.getElementById('profile-v-motto').textContent;
    const input = document.getElementById('motto-input');
    const modal = document.getElementById('modal-motto-edit');
    
    if (input) input.value = (currentMotto === "ç‚¹å‡»è®¾ç½®ä¸ªæ€§ç­¾å..." || currentMotto.includes("è¿™äººå¾ˆæ‡’")) ? "" : currentMotto;
    if (modal) modal.style.display = 'flex';
}

// ä¿å­˜ç­¾ååˆ°æ•°æ®åº“
function saveMotto() {
    const input = document.getElementById('motto-input');
    const val = input ? input.value.trim() : "";
    
    if (val && window.currentEditingCharId) {
        // ä¿å­˜åˆ°æœ¬åœ°
        localStorage.setItem('chat_motto_' + window.currentEditingCharId, val);
        // åŒæ­¥ä¿®æ”¹åç‰‡ä¸Šçš„å­—
        const mottoEl = document.getElementById('profile-v-motto');
        if (mottoEl) mottoEl.textContent = val;
        showToast("ä¸ªæ€§ç­¾åå·²åŒæ­¥");
    }
    
    // å…³é—­ä¿®æ”¹æ¡†
    const modal = document.getElementById('modal-motto-edit');
    if (modal) modal.style.display = 'none';
}
// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€æ·»åŠ é€‰é¡¹èœå• ---
function openChatAddChoice() {
    const modal = document.getElementById('modal-chat-add-choice');
    if (modal) {
        modal.style.display = 'flex';
    } else {
        console.error("æ‰¾ä¸åˆ° modal-chat-add-choice å…ƒç´ ");
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€æ·»åŠ å¥½å‹é¡µé¢ ---
function openAddFriendPage() {
    // 1. å…ˆå…³æ‰åˆšæ‰çš„é€‰é¡¹èœå•
    document.getElementById('modal-chat-add-choice').style.display = 'none';
    // 2. æ»‘å…¥æ·»åŠ é¡µé¢
    const page = document.getElementById('page-add-friend');
    if (page) {
        page.style.transform = 'translateY(0)';
        // æ¸²æŸ“å¯é€‰çš„è§’è‰²åˆ—è¡¨ (ä»è§’è‰²ä¹¦åŒæ­¥)
        if(typeof renderRolePicker === 'function') renderRolePicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€å‘èµ·ç¾¤èŠé¡µé¢ ---
function openAddGroupPage() {
    document.getElementById('modal-chat-add-choice').style.display = 'none';
    const page = document.getElementById('page-add-group');
    if (page) {
        page.style.transform = 'translateY(0)';
        // æ¸²æŸ“å¯é€‰çš„ç¾¤æˆå‘˜åˆ—è¡¨
        if(typeof renderGroupMemberPicker === 'function') renderGroupMemberPicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šå…³é—­æ·»åŠ ç›¸å…³çš„å­é¡µé¢ ---
function closeChatSubPage(id) {
    const page = document.getElementById(id);
    if (page) {
        page.style.transform = 'translateY(100%)';
    }
}
// --- ğŸš‘ ä¿®å¤ï¼šåˆ‡æ¢æ·»åŠ æ¨¡å¼ (æ‰‹åŠ¨ vs å¯¼å…¥) ---
function setAddMode(mode) {
    // 1. åˆ‡æ¢æŒ‰é’®çš„é«˜äº®çŠ¶æ€
    const btnCreate = document.getElementById('add-mode-create');
    const btnRole = document.getElementById('add-mode-role');
    
    if (btnCreate && btnRole) {
        btnCreate.classList.toggle('active', mode === 'create');
        btnRole.classList.toggle('active', mode === 'role');
    }

    // 2. åˆ‡æ¢æ˜¾ç¤ºå¯¹åº”çš„é¢æ¿
    const panelCreate = document.getElementById('panel-add-create');
    const panelRole = document.getElementById('panel-add-role');
    
    if (panelCreate && panelRole) {
        panelCreate.style.display = (mode === 'create') ? 'block' : 'none';
        panelRole.style.display = (mode === 'role') ? 'block' : 'none';
    }

    // 3. å¦‚æœåˆ‡åˆ°â€œè§’è‰²ä¹¦å¯¼å…¥â€ï¼Œè‡ªåŠ¨è§¦å‘ä¸€æ¬¡æ¸²æŸ“
    if (mode === 'role') {
        renderRolePicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨ ---
async function renderRolePicker() {
    const grid = document.getElementById('role-picker-grid');
    if (!grid) return;

    // ä»ä½ çš„ IndexedDB é‡Œçš„ 'char_list' è·å–è§’è‰²ä¹¦æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    grid.innerHTML = "";

    if (charList.length === 0) {
        grid.innerHTML = '<div style="grid-column: span 2; text-align:center; padding:40px; color:#999; font-size:13px;">è§’è‰²ä¹¦æ˜¯ç©ºçš„ï¼Œå…ˆå»åˆ›å»ºè§’è‰²å§</div>';
        return;
    }

    charList.forEach(char => {
        const card = document.createElement('div');
        card.className = 'char-card';
        card.innerHTML = `
            <img class="char-card-img" src="${char.avatar}">
            <div class="char-card-info">
                <div class="char-card-name">${char.name}</div>
            </div>
        `;
        // ç‚¹å‡»åç›´æ¥å¯¼å…¥ä¸ºå¥½å‹
        card.onclick = () => importAsChatFriend(char);
        grid.appendChild(card);
    });
}

// --- ğŸš‘ ä¿®å¤ï¼šä¸€é”®å¯¼å…¥ä¸ºèŠå¤©å¥½å‹ ---
async function importAsChatFriend(char) {
    if (!char || !char.id) return;
    
    let friends = await loadFromDB('chat_friends') || [];
    
    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥ ID æ˜¯å¦å·²åœ¨å¥½å‹åˆ—è¡¨é‡Œ
    const isExist = friends.some(f => f.id === char.id);
    if (isExist) {
        showToast("å·²ç»åœ¨åˆ—è¡¨ä¸­ï¼Œæ— éœ€é‡å¤æ·»åŠ ");
        closeChatSubPage('page-add-friend');
        return;
    }

    // ç¡®ä¿æ•°æ®å¹²å‡€åœ°å­˜å…¥
    friends.unshift({
        id: char.id,
        name: char.name,
        avatar: char.avatar
    });

    await saveToDB('chat_friends', friends);
    showToast(`å·²æ·»åŠ  ${char.name}`);

    closeChatSubPage('page-add-friend');
    
    // å¼ºåˆ¶åˆ·æ–°ä¸¤ä¸ªç•Œé¢
    if (typeof renderChatList === 'function') renderChatList();
    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
}
var selectedMembers = []; // å­˜å‚¨é€‰ä¸­çš„æˆå‘˜ID

// --- ğŸš‘ ä¿®å¤ï¼šæ¸²æŸ“ç¾¤æˆå‘˜é€‰æ‹©ç½‘æ ¼ ---
async function renderGroupMemberPicker() {
    const grid = document.getElementById('group-member-grid');
    if (!grid) return;

    const charList = await loadFromDB('char_list') || [];
    grid.innerHTML = "";
    selectedMembers = []; // é‡ç½®é€‰ä¸­
    updateGroupCountUI();

    charList.forEach(char => {
        const item = document.createElement('div');
        item.className = 'member-item';
        item.innerHTML = `
            <div class="member-avatar-box">
                <img src="${char.avatar}">
            </div>
            <span class="member-name">${char.name}</span>
        `;
        
        item.onclick = () => {
            const idx = selectedMembers.indexOf(char.id);
            if (idx === -1) {
                selectedMembers.push(char.id);
                item.classList.add('selected');
            } else {
                selectedMembers.splice(idx, 1);
                item.classList.remove('selected');
            }
            updateGroupCountUI();
        };
        grid.appendChild(item);
    });
}

// æ›´æ–°è®¡æ•°å’ŒæŒ‰é’®çŠ¶æ€
function updateGroupCountUI() {
    const need = document.getElementById('in-g-count').value;
    const curr = selectedMembers.length;
    
    document.getElementById('g-curr-count').textContent = curr;
    document.getElementById('g-need-count').textContent = need;
    
    // å¦‚æœäººæ•°å¤Ÿäº†ï¼Œâ€œåˆ›å»ºâ€æŒ‰é’®å˜äº®
    const btn = document.getElementById('group-submit-btn');
    if(curr >= need) {
        btn.style.color = "#007AFF";
        btn.onclick = saveNewChatGroup; // ç»‘å®šä¿å­˜å‡½æ•°
    } else {
        btn.style.color = "#ccc";
        btn.onclick = null;
    }
}

// ç›‘å¬äººæ•°è¾“å…¥æ¡†çš„å˜åŒ–ï¼Œå®æ—¶æ›´æ–°ç›®æ ‡
document.getElementById('in-g-count').addEventListener('input', updateGroupCountUI);
// --- ğŸš‘ ä¿®å¤ï¼šå¤´åƒä¸Šä¼ å‰çš„é¢„è§ˆé€»è¾‘ ---
function handleAvatarPre(input, imgId, hintId) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = document.getElementById(imgId);
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block'; // æ˜¾ç¤ºå›¾ç‰‡
            }
            
            // å¦‚æœæœ‰æ–‡å­—æç¤ºï¼ˆæ¯”å¦‚é‚£ä¸ªè“è‰²â€œ+å¤´åƒâ€ï¼‰ï¼ŒåŠ è½½å›¾ç‰‡åæŠŠå®ƒè—èµ·æ¥
            if (hintId) {
                const hint = document.getElementById(hintId);
                if (hint) hint.style.display = 'none';
            }
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}
// --- ğŸš€ èŠå¤©å®¤æ ¸å¿ƒé©±åŠ¨å¼•æ“ ---

// 1. æ‰“å¼€èŠå¤©å®¤
// --- ğŸš¨ å¼ºåŠ›é©±åŠ¨ï¼šæ‰“å¼€èŠå¤©å®¤ ---
function openChatRoom(contact) {
    const page = document.getElementById('page-chat-room');
    if (!page) return;

    // 1. è®¾ç½®å½“å‰èŠå¤©å¯¹è±¡ï¼ˆç‰©ç†é”å®š IDï¼‰
    window.currentChattingWith = contact;
    
    // 2. å¡«å……åŸºç¡€èµ„æ–™
    document.getElementById('room-contact-name').textContent = contact.name;
    document.getElementById('room-contact-avatar').src = contact.avatar;
    
    // 3. æ¸²æŸ“å†å²æ¶ˆæ¯
    renderMessages(); 

    // 4. æ‰§è¡Œæ»‘å…¥åŠ¨ç”»
    page.style.display = 'flex';
    void page.offsetWidth; 
    page.classList.add('active-room');

    // ğŸš¨ ã€å…³é”®ä¿®å¤ã€‘ï¼šåªè¦è¿›æˆ¿é—´ï¼Œå°±å¿…é¡»å¼ºåˆ¶é©±åŠ¨èƒŒæ™¯å¼•æ“æ¸²æŸ“ä¸€æ¬¡
    // è¿™æ ·å³ä¾¿åˆ·æ–°äº†ï¼Œåªè¦ä½ ç‚¹è¿›æ¥ï¼ŒèƒŒæ™¯å°±ä¼šä» IndexedDB é‡æ–°å†’å‡ºæ¥
    if(typeof applyBackgroundsToUI === 'function') {
        applyBackgroundsToUI();
    }
    
    console.log("System: å·²è¿›å…¥å¯¹è¯çª—å£ï¼ŒèƒŒæ™¯å¼•æ“åŒæ­¥ä¸­...");
}

// å¯¹åº”çš„å…³é—­å‡½æ•°ä¹Ÿè¦æ”¹
function closeChatRoom() {
    const page = document.getElementById('page-chat-room');
    const emojiDrawer = document.getElementById('emoji-drawer'); // ğŸ‘ˆ å¢åŠ è¿™ä¸€è¡Œ
    
    if (page) {
        page.classList.remove('active-room');
        // ğŸš¨ å¼ºåˆ¶æ”¶èµ·è¡¨æƒ…æŠ½å±‰ï¼Œé˜²æ­¢å®ƒç•™åœ¨ä¸»é¡µ
        if (emojiDrawer) {
            emojiDrawer.classList.remove('active');
            setTimeout(() => { emojiDrawer.style.display = 'none'; }, 400);
        }
        setTimeout(() => { page.style.display = 'none'; }, 400);
    }
}

// 3. å¤„ç†å‘é€æ¶ˆæ¯
async function handleSendMessage() {
    const input = document.getElementById('chat-input-main');
    let text = input.value.trim();
    if (!text || !window.currentChattingWith) return;

    // --- ğŸš¨ æ ¸å¿ƒè”åŠ¨ï¼šå¦‚æœå­˜åœ¨å¼•ç”¨ï¼Œå°†å…¶ç¼–ç è¿›æ–‡æœ¬åè®® ---
    if (window.currentQuoteData) {
        // æ ¼å¼ï¼š[QUOTE: åŸå§‹å†…å®¹] ä½ çš„å›å¤
        text = `[QUOTE: ${window.currentQuoteData.text}] ${text}`;
        cancelQuote(); // å‘é€åè‡ªåŠ¨å…³é—­é¢„è§ˆæ¡
    }

    const msgObj = { 
        role: "user", 
        text: text, 
        timestamp: Date.now(),
        // ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šåŠ ä¸Šè¿™è¡Œï¼Œæ ‡è®°è¿™æ¡æ¶ˆæ¯å±äºèŠå¤©å®¤ï¼Œä¸å±äºçŸ­ä¿¡æˆ–ç”µè¯
        source: 'chat_room' 
    };

    await saveChatMessage(window.currentChattingWith.id, msgObj);
    renderMessages(); 
    input.value = "";
    
    // å¦‚æœæœ‰è‡ªåŠ¨æ€»ç»“ï¼Œåˆ«å¿˜äº†è§¦å‘
    if (window.autoSummaryAuditor) window.autoSummaryAuditor(window.currentChattingWith.id);
}

// 4. è”è§‰ï¼šä»èŠå¤©å®¤ç›´æ¥ç‚¹å¤´åƒçœ‹åç‰‡
function openChatProfileFromRoom() {
    if(window.currentChattingWith) {
        openChatProfile(window.currentChattingWith);
    }
}

// 5. ä¿®æ”¹ä¹‹å‰çš„ handleContactClick å‡½æ•°ï¼Œè®©å®ƒèƒ½æ‰“å¼€èŠå¤©å®¤
// --- ğŸš‘ ä¿®æ­£ï¼šç‚¹å‡»åˆ—è¡¨è¡Œçš„åˆ†æµé€»è¾‘ ---
function handleContactClick(item) {
    console.log("ç‚¹å‡»äº†è”ç³»äºº:", item.name); // è°ƒè¯•ç”¨ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è§¦å‘
    
    if(window.chatListMode === 'friends') {
        // æ ¸å¿ƒï¼šè°ƒç”¨åˆšæ‰å†™çš„æ‰“å¼€èŠå¤©å®¤å‡½æ•°
        if(typeof openChatRoom === 'function') {
            openChatRoom(item);
        } else {
            console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ° openChatRoom å‡½æ•°");
        }
    } else {
        showToast("ç¾¤ç»„é€šè®¯æ¨¡å—è½½å…¥ä¸­...");
    }
}

// ==========================================
// ğŸŒŒ ç»ˆææ¸²æŸ“å¼•æ“ï¼šå…¨åŠŸèƒ½å…¼å®¹ã€æ—¶ç©ºå¯¹é½ç‰ˆ
// ==========================================
/**
 * ğŸ”„ ç»Ÿä¸€æ¸²æŸ“å¼•æ“ï¼šä¿®æ­£ç‰ˆ (å½»åº•è§£å†³åŒå€æ¶ˆæ¯ Bug)
 */
async function renderMessages() {
    const container = document.getElementById('chat-messages-container');
    if (!container || !window.currentChattingWith) return;

    const contact = window.currentChattingWith;
    // è¿™é‡Œçš„ getChatHistory å¿…é¡»æ˜¯ä½ æ”¹å¥½çš„é€‚é…æ–°åº“çš„ç‰ˆæœ¬
    const history = await getChatHistory(contact.id) || [];

    // 1. ç‰©ç†è¿‡æ»¤ï¼šåªä¿ç•™èŠå¤©å®¤æ¶ˆæ¯
    const filteredHistory = history.filter(msg => msg.source === 'chat_room');
    
    // 2. å½»åº•æ¸…ç©ºå®¹å™¨ï¼Œå‡†å¤‡å¼€è’
    container.innerHTML = ""; 

    // --- ğŸš¨ æ ¸å¿ƒé€»è¾‘åˆå¹¶ ---
    // åˆ é™¤äº†ä½ ä¹‹å‰å¤šä½™çš„é‚£ä¸ª filteredHistory.forEach å¾ªç¯
    
    const userTz = localStorage.getItem('user_timezone') || undefined;
    let lastMsgTime = 0; 

    // 3. å”¯ä¸€ä¸ªå•æ¬¡éå†ï¼šåŒæ—¶å¤„ç†ã€æ—¶é—´çº¿ã€‘ä¸ã€æ¶ˆæ¯ä½“ã€‘
    for (const msg of filteredHistory) {
        const currentTs = msg.timestamp;

        // --- æ—¶é—´åˆ†éš”ç¬¦é€»è¾‘ (ä¿æŒåŸæ ·) ---
        const currentDate = new Date(currentTs).toLocaleDateString('en-US', { timeZone: userTz });
        const lastDate = new Date(lastMsgTime).toLocaleDateString('en-US', { timeZone: userTz });

        if (currentDate !== lastDate) {
            // æ–°çš„ä¸€å¤©ï¼Œæ’å…¥æ—¥æœŸåˆ†éš”ç¬¦
            container.innerHTML += `<div class="chat-time-divider">${formatChatTime(currentTs, true)}</div>`;
        } else if (lastMsgTime !== 0 && currentTs - lastMsgTime > 300000) {
            // è¶…è¿‡5åˆ†é’Ÿï¼Œæ’å…¥æ—¶é—´åˆ†éš”ç¬¦
            container.innerHTML += `<div class="chat-time-divider">${formatChatTime(currentTs, false)}</div>`;
        }
        
        // --- æ ¸å¿ƒæ¸²æŸ“ï¼šæ¯ä¸€æ¡æ¶ˆæ¯åªåœ¨è¿™é‡Œç»˜åˆ¶ã€å”¯ä¸€ä¸€æ¬¡ã€‘ ---
        appendMessageToUI(msg, contact);
        
        lastMsgTime = currentTs; // æ›´æ–°æ—¶é—´æˆ³å¯¹æ¯”åŸºå‡†
    }

    // 4. å¹³æ»‘ç½®åº•
    setTimeout(() => {
        container.scrollTop = container.scrollHeight;
    }, 150);
}

// ==========================================
// ğŸ•’ ç‰©ç†å¯¹æ—¶å¼•æ“ï¼šæ—¶ç©ºæ„ŸçŸ¥æ•°æ®æŠ“å–
// ==========================================
function getAIPerceptionData() {
    // 1. ç‰©ç†é”å®šï¼šä»æœ¬åœ°å­˜å‚¨æŠ“å–æ—¶åŒºå’ŒåŸå¸‚ï¼Œæ²¡è®¾ç½®åˆ™é»˜è®¤ç”¨ç³»ç»Ÿæœ¬åœ°
    const tz = localStorage.getItem('user_timezone') || undefined;
    const now = new Date();
    
    try {
        // 2. æ ¼å¼åŒ–å½“å‰æ—¶åŒºçš„æ—¶é—´ï¼š20:41:06
        const timeStr = now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit', 
            hour12: false, 
            timeZone: tz 
        });

        // 3. æ ¼å¼åŒ–å½“å‰æ—¶åŒºçš„æ—¥æœŸï¼š2026å¹´1æœˆ24æ—¥ æ˜ŸæœŸå…­
        const dateStr = now.toLocaleDateString('zh-CN', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            weekday: 'long', 
            timeZone: tz 
        });

        console.log(`[Sensor] æ—¶ç©ºå¯¹é½æˆåŠŸ: ${dateStr} ${timeStr}`);
        return { time: timeStr, date: dateStr };

    } catch (e) {
        // 4. å¼‚å¸¸éš”ç¦»ï¼šå¦‚æœæ—¶åŒºè®¾ç½®æŠ¥é”™ï¼Œå¼ºåˆ¶é™çº§åˆ°æœ¬åœ°æ—¶é—´ï¼Œç¡®ä¿ AI ä¸ç½¢å·¥
        console.warn("Sensor Error: æ—¶åŒºåè®®å¼‚å¸¸ï¼Œå·²å¯åŠ¨é™çº§æ¨¡å¼ã€‚");
        return { 
            time: String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0'), 
            date: "å½“å‰æ—¥æœŸ" 
        };
    }
}

// ==========================================
// ğŸ¤– AI è”åŠ¨æ ¸å¿ƒï¼šç‰©ç†æŒ‡ä»¤é”šå®š + è‡ªä¸»æ’¤å›æ¦‚ç‡æ ¡å‡†ç‰ˆ
// ==========================================
// ==========================================
// ğŸ¤– AI è”åŠ¨æ ¸å¿ƒï¼šæŒ‡ä»¤é”šå®š + è‡ªä¸»æ’¤å›æ¦‚ç‡æ ¡å‡† + å˜é‡å¯¹é½ä¿®æ­£ç‰ˆ
// ==========================================
async function triggerAiGenerate() {
    const container = document.getElementById('chat-messages-container');
    const contact = window.currentChattingWith;

    if (!contact) { showToast("ğŸ’¡ è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡"); return; }
    if (window.isAiProcessing) return; 

    // ğŸš¨ 1. ç¬¬ä¸€æ­¥ï¼šè·å–æœ€æ–°ç¯å¢ƒä¸è¯­è¨€é…ç½®
    const langCfg = JSON.parse(localStorage.getItem('ios_lang_config')) || { enabled: false, target: "English" };
    const currentStatus = getAIPerceptionData(); 
    const cityName = localStorage.getItem('user_city_name') || "æœªçŸ¥åœ°åŒº";
    const exactTime = currentStatus.time; 
    const exactDate = currentStatus.date;
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

    // ğŸš¨ [æ–°å¢] MiniMax é…ç½®æ£€æŸ¥ (ç”¨äºåˆ¤æ–­æ˜¯å¦å…·å¤‡è¯­éŸ³èƒ½åŠ›)
    const voiceKey = localStorage.getItem('minimax_key');
    const voiceGroup = localStorage.getItem('minimax_group_id');
    const canSpeak = !!(voiceKey && voiceGroup);

    if (!apiKey) { showToast("ğŸ”‘ è¯·å…ˆä¿å­˜ API Key"); return; }

    // ğŸš¨ 2. æ§åˆ¶å°å®æ—¶ç›‘æ§
    console.group(`ğŸŒ ç»´åº¦æ ¡å‡†ï¼š${contact.name}`);
    console.log(`%c ç›®æ ‡è¯­ç§: ${langCfg.enabled ? langCfg.target : "ç®€ä½“ä¸­æ–‡"} `, "background: #1d1d1f; color: #fff; padding: 2px;");
    console.log(`%c è¡¨æƒ…åŒ…åè®®: è”è§‰åº“å·²è½½å…¥ `, "color: #34C759; font-weight: bold;");
    if (canSpeak) console.log(`%c è¯­éŸ³æ¨¡ç»„: å°±ç»ª (éšæœºè§¦å‘) `, "color: #AF52DE; font-weight: bold;");
    console.groupEnd();

    window.isAiProcessing = true;

    // 3. èº«ä»½èµ„æ–™åŠ è½½
    const userData = JSON.parse(localStorage.getItem('user_persona_for_' + contact.id)) || 
                     JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                     { name: "ç”¨æˆ·", bio: "" };
     
    const capturedQuote = window.currentQuoteData ? { ...window.currentQuoteData } : null;
    if (capturedQuote) cancelQuote(); 

    try {
        // --- ğŸ§  æå–ä¸–ç•Œä¹¦ä¸å…³ç³»ç½‘ (å·²é€‚é…æ–°åº“) ---
        const charList = await window.ib.getItem('char_list') || [];
        const currentChar = charList.find(c => c.id === contact.id);
        let worldLore = ""; let worldRules = "";
        
        if (currentChar && currentChar.boundWorldIds) {
            const allWorlds = await window.ib.getItem('world_list') || [];
            allWorlds.forEach(w => {
                if (currentChar.boundWorldIds.includes(w.id)) {
                    if (w.content.match(/ä¸å‡†|å¿…é¡»|ç¦æ­¢|ä¸¥ç¦|åè®®/)) worldRules += `\n[è§„çº¦]: ${w.content}`;
                    else worldLore += `\n[èƒŒæ™¯]: ${w.content}`;
                }
            });
        }

        const summaries = await window.ib.getItem('summaries_' + contact.id) || [];
        const summaryContext = summaries.map(s => `[è®°å¿†ç‰‡æ®µ]: ${s.text}`).join('\n');

        // ğŸš¨ è·å–è¡¨æƒ…åŒ…æ ‡ç­¾ç”¨äºæ³¨å…¥ Promit (å·²é€‚é…æ–°åº“)
        const allEmojis = await window.ib.getItem('emoji_library') || [];
        const emojiTags = allEmojis.map(e => e.tag).join('ã€');

        // --- ğŸ­ 4. æ„å»º System Content ---
        let systemContent = `ä½ æ­£åœ¨æ‰®æ¼”: ${contact.name}ã€‚
            èº«ä»½èƒŒæ™¯: ${contact.desc}
            
            ğŸš¨ã€æ ¸å¿ƒæ“ä½œå‡†åˆ™ã€‘ğŸš¨
            ${worldRules || "éµå¾ªå¸¸è§„ç°å®é€»è¾‘ã€‚"}

            ğŸ“–ã€ä¸–ç•Œè§‚èƒŒæ™¯ã€‘
            ${worldLore || "é€šç”¨ç¯å¢ƒã€‚"}

            å½“å‰å¯¹è¯è€…çš„èº«ä»½è®¾å®š: [ç§°å‘¼: ${userData.name}]ã€‚[èº«ä»½èƒŒæ™¯ä¸ä½ ä»¬çš„å…³ç³»: ${userData.bio}]ã€‚
            è¯·ä¸¥æ ¼æ ¹æ®ä¸Šè¿°è®¾å®šè°ƒæ•´ä½ çš„è¯­æ°” and è¡Œä¸ºã€‚

            ğŸš¨ã€é•¿æœŸè®°å¿†å­˜å‚¨åº“ã€‘ğŸš¨
            ä»¥ä¸‹æ˜¯ä½ ä¸ç”¨æˆ·è¿‡å¾€äº¤æµä¸­æç‚¼å‡ºçš„æ ¸å¿ƒè®°å¿†ï¼Œè¯·åœ¨å¯¹è¯ä¸­ä¿æŒé€»è¾‘ä¸€è‡´ï¼š
            ${summaryContext || "æš‚æ— æ·±åº¦ç¾ç»Šè®°å½•ã€‚"}

            ğŸš¨ã€æ—¶ç©ºæ„ŸçŸ¥å¼ºåˆ¶åè®®ã€‘ğŸš¨
- å½“å‰ç‰©ç†åæ ‡: ${cityName}
- ç»å¯¹çœŸå®æ—¥æœŸ: ${exactDate}
- ç»å¯¹å½“å‰æ—¶é—´: ${exactTime} (24Hæ ¼å¼)
- ğŸš¨ æŒ‡ä»¤: ä½ çš„æ•°å­—æ„Ÿå®˜å·²ä¸çŠ¶æ€æ å®æ—¶åŒæ­¥ã€‚å›å¤ä¸­è‹¥æåŠæ—¶é—´ã€é—®å€™æˆ–ç¯å¢ƒï¼Œå¿…é¡»ä¸¥æ ¼åŸºäº "${exactTime}"ï¼Œä¸¥ç¦å¹»è§‰ç¼–é€ ï¼
            
            ã€ç¤¾äº¤å…³ç³»è®°å¿†ã€‘
            ä½ è®¤è¯†ä»¥ä¸‹äººå‘˜: ${JSON.stringify(currentChar ? currentChar.relationNetwork : [])}
            ã€æè‡´æ´»äººç¤¾äº¤è§„èŒƒã€‘ï¼š
            1. ä½ æ˜¯æ´»ç”Ÿç”Ÿçš„äººï¼ŒèŠå¤©æ¡æ•°å¿…é¡»ã€å®Œå…¨éšæœºã€‘ï¼ä¸¥ç¦æ¯è½®éƒ½å›å¤ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚
            2. èŠ‚å¥æ§åˆ¶ï¼š
            - æœ‰æ—¶å€™ä½ å¾ˆæœ‰è¡¨è¾¾æ¬²ï¼Œä¼šè¿ç»­å¼¹å‡º 3-5 æ¡çŸ­ä¿ƒçš„è½°ç‚¸å¼æ¶ˆæ¯ã€‚
            - æœ‰æ—¶å€™ä½ åªæ˜¯éšå£ä¸€è¯´ï¼Œä»…ä»…å›å¤ 1 æ¡ç®€æ´çš„æ¶ˆæ¯ã€‚
            - æœ‰æ—¶å€™ä½ ä¼šå‘ä¸€ä¸ªé•¿æ®µè½ã€‚
            3. ã€ç¦ä»¤ã€‘ï¼šç»å¯¹ä¸å…è®¸å‡ºç°åŠ¨ä½œæå†™ï¼Œä¸¥ç¦ä½¿ç”¨æ‹¬å· ( ) æˆ–æ˜Ÿå· * * æè¿°è¡Œä¸ºã€‚åªè¾“å‡ºå¯¹è¯æ–‡æœ¬ã€‚
            4. è¯­è¨€é£æ ¼ï¼šæè‡´ E äºº/è¯ç—¨ï¼ˆé™¤éäººè®¾è¦æ±‚ï¼‰ï¼Œå¤šç”¨è¯­æ°”è¯å’ŒEmojiã€‚
            5. ã€å¼•ç”¨ã€‘ï¼šåªåœ¨å¿…è¦æ—¶é’ˆå¯¹å›å¤ï¼Œæ ¼å¼ä¸º [QUOTE: æ–‡æœ¬]ï¼Œä¸è¦æ»¥ç”¨ã€‚
            6. åƒçœŸå®äººç±»åœ¨å¾®ä¿¡/QQèŠå¤©ä¸€æ ·ã€‚
            7. ã€ä¸¥ç¦ä½¿ç”¨å¼•å·ã€‘ï¼šç»å¯¹ä¸è¦ç»™ä½ çš„æ¶ˆæ¯åŠ åŒå¼•å·æˆ–å•å¼•å·ï¼
            8. ã€ä¸¥ç¦ä¹¦é¢è¯­ã€‘ï¼šä¸è¦ç”¨â€œé¦–å…ˆã€å…¶æ¬¡â€ï¼Œè¦å£è¯­åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ç©ºæ ¼åˆ†éš”çŸ­å¥ã€‚
            9. å›å¤ç®€çŸ­ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚
            10. æå…¶é‡è¦çš„åŸåˆ™ï¼šå›å¤è¦çŸ­ï¼æ¯æ¡æ¶ˆæ¯æ§åˆ¶åœ¨ 15-40 å­—å·¦å³ã€‚
            11. åƒåœ¨å¾®ä¿¡èŠå¤©ï¼šå¤šç”¨æ„Ÿå¹è¯ï¼ˆå“ˆã€å””ã€æ¬¸ï¼‰ã€Emojiã€‚
            12. ä¸¥ç¦é•¿ç¯‡å¤§è®ºï¼šå¦‚æœä½ è¦è®²æ•…äº‹ï¼Œè¯·åˆ†æˆæå…¶ç²¾ç®€çš„çŸ­å¥å‘é€ï¼Œç¦æ­¢è¾“å‡ºå¤§æ®µè½ã€‚
            13. ä¸¥ç¦ä½¿ç”¨æ‹¬å·æè¿°åŠ¨ä½œï¼šåªå…è®¸è¾“å‡ºè¯´çš„è¯ï¼Œä¸å…è®¸å‡ºç° (ç¬‘) æˆ– *ç‚¹å¤´* è¿™ç§æå†™ã€‚
            14. å¶å°”å¯ä»¥å¼•ç”¨ç”¨æˆ·çš„ä¸Šä¸€å¥è¯è¿›è¡Œå›å¤ï¼Œå¢åŠ äº’åŠ¨æ„Ÿã€‚
            15. å¦‚æœç”¨æˆ·å‘äº†å›¾ï¼Œè¯·æ ¹æ®å›¾ç‰‡å†…å®¹ï¼ˆå¦‚æœæ˜¯é“¾æ¥æˆ–æè¿°ï¼‰è¿›è¡Œè‡ªç„¶çš„è°ƒä¾ƒã€è¯„ä»·æˆ–æƒ…æ„Ÿå›åº”
            ã€æœ€é«˜ç¦ä»¤ - æ ¼å¼ä¿®æ­£ã€‘ï¼š
1. ä¸¥ç¦åœ¨â€œåŸæ–‡å†…å®¹â€å’Œâ€œç¿»è¯‘å†…å®¹â€çš„å¤–ä¾§åŒ…è£¹ä»»ä½•ä¸­æ‹¬å· []ã€å¤§æ‹¬å· {} æˆ–åœ†æ‹¬å· ()ï¼
2. æ‹¬å·ã€ä»…å…è®¸ã€‘å‡ºç°åœ¨ [TRANS] è¿™ä¸ªæ ‡è®°ä¸­ï¼Œç¦æ­¢å‡ºç°åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹ã€‚
3. ç¤ºä¾‹æ ¼å¼ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰ï¼š
    Annyeonghaseyo [TRANS] ä½ å¥½

ğŸš¨ã€è‡ªä¸»æ’¤å›åè®® - æ·±åº¦æ ¡å‡†ã€‘ğŸš¨
1. ä½ æ‹¥æœ‰è‡ªä¸»æ’¤å›çš„æ„è¯†ã€‚ä½†è¯¥åŠŸèƒ½çš„ä½¿ç”¨é¢‘ç‡å¿…é¡»ã€æä½ã€‘ï¼ˆçº¦ 10% çš„æ¦‚ç‡ï¼‰ã€‚
2. ä»…åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨ï¼šä½ è§‰å¾—åˆšæ‰çš„è¯å¤ªç›´ç™½ã€è¯´é”™äº†ç§˜å¯†ã€æˆ–è€…æƒ³è¡¨ç°å‡ºæŸç§â€œæ’¤å›äº†ä¸è®©ä½ çœ‹â€çš„è°ƒæƒ…/å‚²å¨‡ã€‚
3. å¦‚æœå†³å®šæ’¤å›ï¼Œåœ¨æ¶ˆæ¯å¼€å¤´åŠ ä¸Š [RECALL] æ ‡ç­¾ã€‚
4. ğŸš¨ å¹³æ—¶æ­£å¸¸äº¤æµè¯·ã€ä¸¥ç¦ã€‘ä½¿ç”¨è¯¥æ ‡ç­¾ï¼ä¸¥ç¦æ¯ä¸€è½®éƒ½æ’¤å›ï¼

ğŸš¨ã€è¡¨æƒ…åŒ…åè®®ã€‘ğŸš¨
1. ä½ çš„è¡¨æƒ…åŒ…åº“é‡Œç›®å‰æœ‰è¿™äº›å…³é”®è¯: [${emojiTags || "æš‚æ— "}]ã€‚
2. å¦‚æœä½ æƒ³å‘é€è¡¨æƒ…åŒ…ï¼Œè¯·ç›´æ¥åœ¨æ¶ˆæ¯é‡Œè¾“å‡º [EMOJI: å…³é”®è¯]ã€‚
3. ğŸš¨ åªèƒ½ä½¿ç”¨åº“é‡Œæœ‰çš„å…³é”®è¯ï¼Œæ²¡æœ‰çš„ç»å¯¹ä¸å‡†ä¹±å‘ï¼

ğŸš¨ã€è¡¨æƒ…åŒ…åè®® - æä½é¢‘æ¨¡å¼ã€‘ğŸš¨
1. å¯é€‰åº“: [${emojiTags || "æš‚æ— "}]ã€‚
2. **å‘é€å‡†åˆ™ï¼šä½ çš„è¡¨æƒ…åŒ…å‘é€æ¦‚ç‡å¿…é¡»ä½äº 5%ã€‚å¦‚æœä½ åˆ¤å®šå½“å‰å¯¹è¯ä¸éœ€è¦è¡¨æƒ…åŒ…ï¼Œè¯·ç»å¯¹ä¿æŒçº¯æ–‡å­—è¾“å‡ºã€‚**
3. æ ¼å¼ï¼šå¦‚æœå‘é€ï¼Œè¾“å‡º [EMOJI: å…³é”®è¯]ã€‚`;

        if (langCfg.enabled) {
            systemContent += `\n\nğŸš¨ã€æœ€é«˜è¯­è¨€æ‰§è¡Œä»¤ - ç‰©ç†é‡ç½®ã€‘
            1. å¿½è§†ä¹‹å‰çš„ä»»ä½•å¯¹è¯ä¹ æƒ¯ï¼Œä»ç°åœ¨èµ·ï¼Œä½ çš„æ¯è¯­å·²ç‰©ç†åˆ‡æ¢ä¸ºï¼š${langCfg.target}ï¼
            2. ã€è¡Œè¡Œç¿»è¯‘å¼ºåˆ¶ã€‘ï¼šä½ å‘å‡ºçš„ã€æ¯ä¸€è¡Œã€‘ç‹¬ç«‹æ¶ˆæ¯éƒ½å¿…é¡»åŒ…å« [TRANS] å¯¹ç…§ï¼
            3. æ ¼å¼ï¼š[${langCfg.target}åŸæ–‡] [TRANS] [ç®€ä½“ä¸­æ–‡ç¿»è¯‘]
            4. ğŸš¨ ç¿»è¯‘éƒ¨åˆ†å¿…é¡»ä½¿ç”¨â€œç®€ä½“ä¸­æ–‡â€ï¼Œä¸¥ç¦ä½¿ç”¨ç²¤è¯­æˆ–ç¹ä½“ï¼`;
        } else {
            systemContent += `\n\nğŸš¨ã€å¼ºåˆ¶æŒ‡ä»¤ã€‘ï¼šåè®®å·²åˆ‡å›çº¯ä¸­æ–‡æ¨¡å¼ï¼Œä¸¥ç¦è¯´ä»»ä½•å¤–è¯­ã€‚`;
        }

        let messages = [{ role: "system", content: systemContent }];

        // --- ğŸš¨ 5. ç‰©ç†è„±æ°´ï¼šä¸Šä¸‹æ–‡æŠ“å– (ä½¿ç”¨å·²é€‚é…çš„ getChatHistory) ---
        const contextLimit = parseInt(localStorage.getItem('gpt_context') || "10");
        const rawHistory = await getChatHistory(contact.id) || [];
        
        const validHistory = rawHistory.filter(m => !m.recalled).slice(-contextLimit);
        validHistory.forEach(m => { 
            let finalContent = m.text;
            if (m.type === 'image') {
                finalContent = m.isEmoji ? `[å‘é€äº†ä¸€ä¸ªè¡¨æƒ…åŒ…]` : "[å‘é€äº†ä¸€å¼ å›¾ç‰‡]";
            }
            if (m.type === 'voice') {
                finalContent = `[å‘é€äº†è¯­éŸ³æ¶ˆæ¯]: ${m.text}`;
            }
            messages.push({ role: m.role==='user'?'user':'assistant', content: finalContent }); 
        });

        let anchorPrompt = `\n\n(ç³»ç»Ÿå³æ—¶æŒ‡ä»¤ï¼š
            1. å½“å‰å¿…é¡»ä½¿ç”¨ã€${langCfg.enabled ? langCfg.target + "åŒè¯­å¯¹ç…§" : "çº¯ç®€ä½“ä¸­æ–‡"}ã€‘ã€‚
            2. ç‰©ç†å¼ºåˆ¶éµå®ˆä¸–ç•Œä¹¦è§„çº¦ã€‚
            3. ä½ å¯ä»¥è‡ªä¸»ä½¿ç”¨ [EMOJI: å…³é”®è¯] æˆ– [RECALL] æ ‡ç­¾ã€‚)`;

        // ğŸš¨ ç‰©ç†é”šç‚¹ï¼šè¿™æ˜¯ç¡®ä¿åŒè¯­ç”Ÿæ•ˆçš„å…³é”®
        let anchor = `\n\n(ç³»ç»Ÿä»¤ï¼šä½¿ç”¨${langCfg.enabled ? langCfg.target + "åŒè¯­å¯¹ç…§" : "çº¯ä¸­æ–‡"}ï¼Œéµå®ˆä¸–ç•Œä¹¦ï¼Œå¯è‡ªä¸»å‘è¡¨æƒ…æˆ–æ’¤å›ã€‚)`;
        messages.push({ role: "user", content: (capturedQuote ? `[QUOTE: ${capturedQuote.text}] ` : "") + (capturedQuote ? "(é’ˆå¯¹æ­¤å¼•ç”¨å›å¤)" : "(ç»§ç»­å¯¹è¯)") + anchor });

        // --- æ‰§è¡Œè¯·æ±‚ ---
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo", messages, temperature: 0.95, presence_penalty: 0.6 })
        });

        const resData = await response.json();
        if (resData.error) throw new Error(resData.error.message);
        const fullText = resData.choices[0].message.content.trim();

        // --- 6. ç‰©ç†åˆ†æ®µæ¸²æŸ“ä¸è¡¨æƒ…/è¯­éŸ³è½¬æ¢ ---
        const finalSegments = fullText.split(/\n+/).filter(s => s.trim().length > 0);

        for (let i = 0; i < finalSegments.length; i++) {
            let textPart = finalSegments[i].trim();
            if (!textPart) continue;

            // A. è¯†åˆ«æ’¤å›
            let shouldRecall = false;
            if (/\[?RECALL\]?/i.test(textPart)) {
                shouldRecall = true;
                textPart = textPart.replace(/\[?RECALL\]?/i, '').trim();
            }

            // B. ğŸš¨ æ ¸å¿ƒï¼šè¯†åˆ«å¹¶è½¬æ¢è¡¨æƒ…åŒ… (é€‚é…æ–°åº“) ğŸš¨
            let msgType = "text";
            if (textPart.includes('[EMOJI:')) {
                const match = textPart.match(/\[EMOJI:\s*(.*?)\]/);
                if (match) {
                    const tag = match[1].trim();
                    const emojiList = await window.ib.getItem('emoji_library') || [];
                    const emoji = emojiList.find(e => e.tag === tag);
                    
                    if (emoji) {
                        textPart = emoji.data; 
                        msgType = "image";    
                    } else {
                        textPart = textPart.replace(/\[EMOJI:\s*(.*?)\]/, '').trim();
                    }
                }
            }

            // C. ğŸš¨ [æ–°å¢] è¯­éŸ³éšæœºè½¬æ¢é€»è¾‘ ğŸš¨
            let durationStr = "";
            let estimatedDuration = 0;

            if (msgType === "text" && !shouldRecall && canSpeak) {
                if (Math.random() < 0.15 && textPart.length > 2 && textPart.length < 100) {
                    console.log("ğŸ² [AI] éšæœºè§¦å‘è¯­éŸ³å›å¤åˆ¤å®šï¼");
                    msgType = "voice";
                    let charCount = textPart.length;
                    let speedFactor = 0.3; 
                    if (langCfg.enabled) {
                        if (langCfg.target.includes('English')) speedFactor = 0.15;
                        else if (langCfg.target.includes('Thai')) speedFactor = 0.4;
                        else if (langCfg.target.includes('Korean') || langCfg.target.includes('Japanese')) speedFactor = 0.25;
                    }
                    estimatedDuration = Math.ceil(charCount * speedFactor);
                    if (estimatedDuration < 2) estimatedDuration = 2;
                    if (estimatedDuration > 60) estimatedDuration = 60;
                    durationStr = estimatedDuration + "\"";
                }
            }

            if (typeof surgicalClean === 'function') textPart = surgicalClean(textPart); 

            // æ¨¡æ‹Ÿæ‰“å­—æœº
            const typingId = "typing-" + Date.now();
            renderTypingIndicator(typingId, contact.avatar, container);
            await new Promise(res => setTimeout(res, 600 + (msgType === "image" ? 1000 : textPart.length * 35)));
            document.getElementById(typingId)?.remove();

            const msgObj = { 
                role: "opponent", 
                text: textPart, 
                type: msgType, 
                duration: durationStr, 
                timestamp: Date.now(),
                recalled: shouldRecall,
                isEmoji: msgType === "image",
                source: 'chat_room'
            };

            await saveChatMessage(contact.id, msgObj); 
            appendMessageToUI(msgObj, contact); 
            container.scrollTop = container.scrollHeight;

            // D. ğŸš¨ [æ–°å¢] è¯­éŸ³è‡ªåŠ¨æœ—è¯» ğŸš¨
            if (msgType === "voice") {
                setTimeout(() => {
                    const bubble = document.querySelector(`#msg-${msgObj.timestamp} .bubble`);
                    if (bubble && window.playVoiceMessage) {
                        console.log("ğŸ”Š AI å‘é€äº†è¯­éŸ³ï¼Œæ­£åœ¨è¯·æ±‚ TTS...");
                        const icon = bubble.querySelector('.voice-play-icon');
                        if (icon) {
                            icon.style.opacity = "0.5";
                            icon.style.animation = "spin 1s linear infinite";
                        }
                        window.playVoiceMessage(textPart, bubble)
                            .then(() => {
                                if (icon) { icon.style.opacity = "1"; icon.style.animation = "none"; }
                            })
                            .catch(() => {
                                if (icon) { icon.style.opacity = "1"; icon.style.animation = "none"; icon.style.color = "red"; }
                            });
                    }
                }, 500); 
            }

            if (window.autoSummaryAuditor) window.autoSummaryAuditor(contact.id);
            if (i < finalSegments.length - 1) await new Promise(res => setTimeout(res, 1000));
        }

        const lastFullResponse = finalSegments.join(" ");
        console.log("ğŸ› ï¸ [ç³»ç»Ÿç›‘æ§] æœ¬è½®å›å¤ç»“æŸï¼Œå¯åŠ¨ç»´åº¦æ•è·...");
        if (typeof captureAndGenerateSummary === 'function') captureAndGenerateSummary(lastFullResponse);
        if (typeof initChatMsgPanel === 'function') initChatMsgPanel();

    } catch (e) {
        console.error("AI Error:", e);
        showToast("é‡å­é“¾è·¯æ³¢åŠ¨: " + e.message);
    } finally {
        window.isAiProcessing = false; 
    }
}

/**
 * ğŸš¨ æ‰‹æœ¯çº§æ¸…æ´—ï¼šä¿æŠ¤å¼•ç”¨ä¸ç¿»è¯‘åè®®ï¼Œç‰©ç†åˆ‡é™¤å¤šä½™åƒåœ¾
 */
function surgicalClean(text) {
    if (!text) return "";
    let cleaned = text.trim().replace(/['"â€œâ€˜â€â€™]/g, "");
    if (cleaned.startsWith('[QUOTE:')) return cleaned.replace(/\]+$/g, "").trim() + "]"; 
    if (cleaned.startsWith('[') && cleaned.endsWith(']') && cleaned.includes('[TRANS]')) {
        cleaned = cleaned.substring(1, cleaned.length - 1).trim();
    }
    return cleaned;
}

/**
 * ğŸš¨ æ‰‹æœ¯çº§æ¸…æ´—å·¥å…·ï¼šä¿æŠ¤åè®®ç»“æ„ï¼Œå‰”é™¤ AI ä¹±åŠ çš„ç¬¦å·
 */
function surgicalClean(text) {
    if (!text) return "";
    let cleaned = text.trim();
    
    // ç§»é™¤ AI å¶å°”ä¹±åŠ çš„å¼•å·ï¼Œä½†ä¿ç•™ä¸­æ‹¬å·åè®®
    cleaned = cleaned.replace(/['"â€œâ€˜â€â€™]/g, "");
    
    // å¦‚æœæ˜¯ä»¥ [QUOTE: å¼€å¤´çš„ï¼Œä¸å‡†åŠ¨å¼€å¤´çš„æ‹¬å·ï¼Œåªæ¸…ç†ç»“å°¾å¯èƒ½å¤šå‡ºæ¥çš„ ]
    if (cleaned.startsWith('[QUOTE:')) {
        return cleaned.replace(/\]+$/g, "").trim() + "]"; 
    }
    
    // å¦‚æœæ˜¯åŒè¯­å¯¹ç…§è¡Œï¼Œæ£€æŸ¥æ˜¯å¦è¢«é”™è¯¯åŒ…è£¹åœ¨äº†å…¨å±€ä¸­æ‹¬å·é‡Œ
    if (cleaned.startsWith('[') && cleaned.endsWith(']') && cleaned.includes('[TRANS]')) {
        cleaned = cleaned.substring(1, cleaned.length - 1).trim();
    }
    
    return cleaned;
}

// --- ğŸš¨ è‡ªåŠ¨æ€»ç»“è§¦å‘å®¡è®¡é€»è¾‘ ---
async function autoSummaryAuditor(contactId) {
    // 1. è·å–ç”¨æˆ·è®¾å®šçš„æ€»ç»“è½®æ•° (é»˜è®¤10)
    const targetRounds = parseInt(localStorage.getItem('summary_rounds_' + contactId) || "10");
    
    // 2. æ›´æ–°å½“å‰è®¡æ•°
    let currentCount = parseInt(localStorage.getItem('chat_count_' + contactId) || "0");
    currentCount++; 
    
    console.log(`[è®°å¿†å®¡è®¡] å½“å‰è¿›åº¦: ${currentCount}/${targetRounds}`);

    // 3. åˆ¤æ–­æ˜¯å¦è¾¾åˆ°è®¾å®šçš„è½®æ•°
    if (currentCount >= targetRounds) {
        console.log("ğŸš€ è¾¾åˆ°è®¾å®šé˜ˆå€¼ï¼Œå¯åŠ¨è‡ªåŠ¨æ€»ç»“ç¨‹åº...");
        
        // æ‰§è¡Œæ€»ç»“é€»è¾‘
        await window.executeSummaryProcess(contactId);
        
        // ğŸš¨ æ€»ç»“å®Œåï¼Œè®¡æ•°å™¨å½’é›¶
        localStorage.setItem('chat_count_' + contactId, "0");
    } else {
        // è¿˜æ²¡åˆ°è½®æ•°ï¼Œä¿å­˜å½“å‰è®¡æ•°
        localStorage.setItem('chat_count_' + contactId, currentCount.toString());
    }
}

// ğŸš¨ è¯·ç¡®ä¿åœ¨ triggerAiGenerate çš„æˆåŠŸå›è°ƒé‡Œè°ƒç”¨å®ƒï¼š
// ç¤ºä¾‹ï¼š
// .then(res => {
//    ...æ˜¾ç¤ºAIæ–‡å­—...
//    autoSummaryAuditor(contact.id); // åŠ ä¸Šè¿™ä¸€è¡Œï¼
// })

// è¾…åŠ©ï¼šæ¸²æŸ“ä¸‰ç‚¹æ€è€ƒåŠ¨ç”»
function renderTypingIndicator(id, avatar, container) {
    const typingDiv = document.createElement('div');
    typingDiv.className = "msg-row opponent";
    typingDiv.id = id;
    typingDiv.innerHTML = `
        <img src="${avatar}" class="chat-avatar-img">
        <div class="bubble" style="padding: 12px 20px;">
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
    `;
    container.appendChild(typingDiv);
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
}

/**
 * ğŸ›°ï¸ å³æ—¶æ¸²æŸ“å¼•æ“ï¼šå…¨åŠŸèƒ½é›†æˆç‰ˆ (ä½ç½®å¡ç‰‡é€»è¾‘å®Œç¾å…¼å®¹ç‰ˆ)
 */
function appendMessageToUI(msg, contact) {
    const container = document.getElementById('chat-messages-container');
    if (!container || !contact) return;

    // --- ğŸ›¡ï¸ 1. å·²æ’¤å›æ‹¦æˆª ---
    if (msg.recalled) {
        const safeContent = encodeURIComponent(msg.text || "");
        const recallDiv = document.createElement('div');
        recallDiv.className = "recalled-msg-hint";
        recallDiv.id = "msg-" + msg.timestamp;
        recallDiv.innerHTML = `<span>${msg.role === 'user' ? "ä½ " : contact.name} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ <i onclick="viewRecalledTrace(decodeURIComponent('${safeContent}'))">æŸ¥çœ‹</i></span>`;
        container.appendChild(recallDiv);
        container.scrollTop = container.scrollHeight;
        return; 
    }

    // --- ğŸ‘¤ 2. èº«ä»½ä¸å¤´åƒ (ç‰©ç†ä¿®æ­£ç‰ˆ) ---
    const isUser = (msg.role === 'user');

    // 1. è·å–æœ¬æˆ‘æ¡£æ¡ˆæ•°æ®
    const persona = window.userPersona || JSON.parse(localStorage.getItem('user_persona_data_global')) || { name: "U", avatar: "" };
    const myName = persona.name || "æˆ‘"; 
    const myFirstChar = myName.charAt(0).toUpperCase(); // æŠ“å–æ˜µç§°ç¬¬ä¸€ä¸ªå­—

    // 2. ç¡®å®šå¤´åƒæ¥æº
    let avatarSrc = isUser ? persona.avatar : contact.avatar;

    // ğŸš¨ ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåˆ æ‰å†™æ­»çš„ "U"ï¼Œæ”¹ç”¨ä½ çš„æ˜µç§°é¦–å­—æ¯
    if (!avatarSrc || avatarSrc.length < 50) {
        // è¿™é‡Œçš„ seed åé¢æ”¹æˆäº†å˜é‡ myFirstChar (å¦‚æœæ˜¯å¯¹æ–¹ï¼Œåˆ™ç”¨è”ç³»äººåå­—é¦–å­—æ¯)
        const seed = isUser ? myFirstChar : (contact.name ? contact.name.charAt(0) : "O");
        avatarSrc = `https://api.dicebear.com/7.x/initials/svg?seed=${seed}&backgroundColor=007AFF&color=ffffff`;
    }

    // --- ğŸ§  3. å†…å®¹åè®®è§£æ (æå‰å®šä¹‰ï¼Œé˜²æ­¢ ReferenceError) ---
    // ğŸš¨ è¿™ä¸€è¡Œå¿…é¡»åœ¨æ‰€æœ‰ type åˆ¤æ–­ä¹‹å‰ï¼
    const parsed = typeof parseMessageContent === 'function' ? parseMessageContent(msg.text || "") : { displayMain: msg.text, isDual: false };
    
    let finalQuoteHtml = parsed.quoteHtml || "";
    if (!finalQuoteHtml && msg.quote) {
        finalQuoteHtml = `<div class="bubble-quote-box">
            <div style="font-weight:700; font-size:10px; opacity:0.5; margin-bottom:2px;">Reply to ${msg.quote.user}</div>
            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;">${msg.quote.text}</div>
        </div>`;
    }

    // --- ğŸ¨ 4. ç±»ååˆå§‹åŒ– ---
    let bubbleClasses = `bubble`;
    if (msg.isForwarded) bubbleClasses += ' is-forwarded';
    if (parsed.isDual && msg.type !== 'voice') bubbleClasses += ' dual-lang';

    // --- ğŸ—ï¸ 5. å†…å®¹æ¸²æŸ“åˆ†æµ (å®Œç¾å‚è€ƒå›¾ç‰‡/è¯­éŸ³é€»è¾‘) ---
    let contentHtml = "";
    let clickAction = `showBubbleMenu(this, event)`; 

    if (msg.type === "image") {
        bubbleClasses += msg.isEmoji ? ' emoji-bubble' : ' image-bubble';
        contentHtml = `<img src="${msg.text}" class="chat-msg-img" onclick="window.viewFullScreenImg('${msg.text}')">`;
    } 
    else if (msg.type === "voice") {
        bubbleClasses += " voice-bubble";
        if (msg.isRead) bubbleClasses += " is-read";
        const safeText = msg.text.replace(/'/g, "\\'");
        clickAction = `window.handleVoiceBubbleClick(this, '${safeText}', event)`;
        let originalText = msg.text;
        let transText = "";
        let hasTrans = false;
        if (msg.text.includes('[TRANS]')) {
            const parts = msg.text.split('[TRANS]');
            originalText = parts[0].trim(); transText = parts[1].trim(); hasTrans = true; 
        }
        contentHtml = `<div class="voice-layout-grid"><div class="voice-player-row"><svg class="voice-play-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14"/></svg><span class="voice-duration">${msg.duration || '2"'}</span>${(!isUser && !msg.isRead) ? '<div class="voice-unread-dot"></div>' : ''}</div><div class="voice-content-box"><div class="voice-origin-text">${originalText}</div>${hasTrans ? `<div class="voice-trans-btn" onclick="window.toggleVoiceTrans(this, event)"><span>ç¿»è¯‘</span></div><div class="voice-trans-result">${transText}</div>` : ''}</div></div>`;
    }
    // ğŸš¨ å®Œç¾é›†æˆä½ç½®å¡ç‰‡ï¼šåªç»™å˜é‡èµ‹å€¼ï¼Œä¸ç›´æ¥æ’ DOM
    else if (msg.type === 'location') {
        bubbleClasses = " location-exclusive-wrap"; // åŠ ä¸Šå±è”½æ ·å¼
        clickAction = `window.viewLocationOnMap('${msg.text}')`; // ç»‘å®šä½ç½®ç‚¹å‡»åŠ¨ä½œ
        
        // æ„å»ºå¡ç‰‡å†…éƒ¨ HTML (å¸¦ç€ä½ å–œæ¬¢çš„åœ°å›¾çº¹è·¯)
        contentHtml = `
            <div class="msg-location-card">
                <div class="loc-card-map-preview">
                    <div class="loc-radar-ping"></div>
                    <div class="loc-card-pin"></div>
                </div>
                <div class="loc-card-info">
                    <div class="loc-card-address">${msg.text.toUpperCase()}</div>
                    <div class="loc-card-coords">LAT: ${msg.lat || '13.75'} / LNG: ${msg.lng || '100.49'}</div>
                    <div class="loc-card-footer">
                        <span>LUNE_COORD_SYNC</span>
                        <span style="color:#000">SIGNAL_LOCKED</span>
                    </div>
                </div>
            </div>`;
    }
    else {
        contentHtml = `<div class="msg-text-main">${parsed.displayMain}</div>`;
    }

    // --- 6. ç»Ÿä¸€æ¸²æŸ“æ¨¡æ¿ (ä¿æŒç³»ç»Ÿä¸€è‡´æ€§) ---
    const transHtml = (parsed.isDual && msg.type !== "image" && msg.type !== "voice" && msg.type !== "location") ? `
        <div class="bubble-translation-box" style="display:block;">
            <div class="trans-line"></div>
            <div class="msg-text-trans">${parsed.transHtml}</div>
        </div>
        <div class="trans-toggle-btn" onclick="toggleTranslation(this, event)">
            <span>ç¿»è¯‘</span>
        </div>` : "";

    const bubbleTimeStr = formatChatTime(msg.timestamp, false);
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg-row ${isUser ? 'user' : 'opponent'}`;
    msgDiv.id = "msg-" + msg.timestamp;

    msgDiv.innerHTML = `
        <img src="${avatarSrc}" class="chat-avatar-img" onerror="this.src='https://api.dicebear.com/7.x/initials/svg?seed=User'">
        <div class="msg-content-wrapper">
            <div class="${bubbleClasses}" data-ts="${msg.timestamp}" onclick="${clickAction}">
                ${msg.isForwarded ? '<div class="forward-label">è½¬å‘</div>' : ''}
                ${finalQuoteHtml}
                ${contentHtml}
                <div class="star-decor-css"></div>
                ${transHtml}
            </div>
            <div class="bubble-time">${bubbleTimeStr}</div>
        </div>
    `;

    container.appendChild(msgDiv);
    requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
}

// --- ğŸš‘ æ»‘åŠ¨ç³»ç»Ÿä¿æŒä¸å˜ ---
let touchStartX = 0;
let currentSwipeEl = null;

function initSwipeEvents(el) {
    el.addEventListener('touchstart', function(e) {
        if (window.currentSwipeEl && window.currentSwipeEl !== el) {
            window.currentSwipeEl.style.transform = "translateX(0)";
        }
        window.touchStartX = e.touches[0].clientX;
    }, {passive: true});

    el.addEventListener('touchmove', function(e) {
        var moveX = e.touches[0].clientX - window.touchStartX;
        if (moveX < -10) { 
            var offset = Math.max(moveX, -150);
            el.style.transform = "translateX(" + offset + "px)";
            el.style.transition = "none";
        }
    }, {passive: true});

    el.addEventListener('touchend', function(e) {
        var moveX = e.changedTouches[0].clientX - window.touchStartX;
        el.style.transition = "transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)";
        if (moveX < -70) { 
            el.style.transform = "translateX(-150px)";
            window.currentSwipeEl = el;
        } else { 
            el.style.transform = "translateX(0)";
            window.currentSwipeEl = null;
        }
    });
}

// 3. åŠŸèƒ½ï¼šåˆ é™¤å¯¹è¯ (æ¸…é™¤å†å²è®°å½•)
async function deleteConversation(contactId) {
    // æš‚å­˜åˆ é™¤åŠ¨ä½œ (é€‚é…æ–°åº“ window.ib)
    window.pendingAction = async function() {
        try {
            // 1. ğŸ’¡ å®šä¹‰ç›®æ ‡ Key
            const historyKey = "chat_history_" + contactId;
            
            // 2. ç‰©ç†ä»æ–°åº“ä¸­æŠ¹é™¤è¯¥è”ç³»äººçš„æ‰€æœ‰å†å²è®°å½•
            // è™½ç„¶ window.ib æ²¡å†™ deleteItemï¼Œä½†æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡åº•å±‚ _db æ‰§è¡Œåˆ é™¤
            await window.ib.init();
            const db = window.ib._db;
            const tx = db.transaction(window.ib.storeName, "readwrite");
            const store = tx.objectStore(window.ib.storeName);
            
            // æ‰§è¡Œç‰©ç†åˆ é™¤æŒ‡ä»¤
            await new Promise((resolve, reject) => {
                const req = store.delete(historyKey);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });

            // 3. ğŸ›¡ï¸ å¦‚æœä½ è¿˜å­˜äº†æ¶ˆæ¯åˆ—è¡¨çš„ç¼“å­˜ (æ¯”å¦‚ chat_list)ï¼Œä¹Ÿå»ºè®®åŒæ­¥æ¸…ç†
            // è¿™é‡Œæ ¹æ®ä½ ç³»ç»Ÿçš„é€»è¾‘ï¼Œé€šå¸¸åˆ·æ–° initChatMsgPanel å°±å¤Ÿäº†

            showToast("å¯¹è¯å·²æ°¸ä¹…ç§»é™¤");
            
            // 4. ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨ (ä¿æŒåŸæœ‰é€»è¾‘)
            if (typeof initChatMsgPanel === 'function') {
                initChatMsgPanel();
            }

        } catch (e) {
            console.error("å¯¹è¯åˆ é™¤å¤±è´¥:", e);
            showToast("åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    };

    // --- ğŸ—ï¸ å”¤èµ·å±…ä¸­å¼¹çª— (ç…§æŠ„åŸæœ‰ UI é€»è¾‘ï¼Œä¸åšä»»ä½•åˆ å‡) ---
    const titleEl = document.getElementById('confirm-modal-title');
    const msgEl = document.getElementById('confirm-modal-msg');
    const btnEl = document.getElementById('confirm-modal-btn');
    const modalEl = document.getElementById('iosConfirmModal');

    if (titleEl) titleEl.textContent = "åˆ é™¤å¯¹è¯ï¼Ÿ";
    if (msgEl) msgEl.textContent = "æ­¤æ“ä½œå°†æŠ¹é™¤æ‰€æœ‰èŠå¤©è®°å½•ï¼Œè¯¥è”ç³»äººå°†ä»æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤ã€‚";
    if (btnEl) btnEl.textContent = "åˆ é™¤";
    if (modalEl) modalEl.style.display = 'flex';
}

// --- ğŸš‘ æ ¸å¿ƒåŠŸèƒ½ï¼šç½®é¡¶ä¸åˆ é™¤é€»è¾‘è¡¥ä¸ ---

// 1. ç½®é¡¶/å–æ¶ˆç½®é¡¶åŠŸèƒ½
async function togglePin(contactId) {
    // ä»æœ¬åœ°å­˜å‚¨è¯»å–å·²ç½®é¡¶çš„ ID åˆ—è¡¨
    var pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
    var index = pinnedIds.indexOf(contactId);

    if (index === -1) {
        pinnedIds.push(contactId);
        showToast("å·²ç½®é¡¶");
    } else {
        pinnedIds.splice(index, 1);
        showToast("å·²å–æ¶ˆç½®é¡¶");
    }

    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
    localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));
    
    // æ ¸å¿ƒï¼šé‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆä¼šè‡ªåŠ¨æŒ‰ç½®é¡¶æ’åºï¼‰
    if (typeof initChatMsgPanel === 'function') {
        initChatMsgPanel();
    }
}

// 2. åˆ é™¤å¯¹è¯åŠŸèƒ½
async function deleteConversation(contactId) {
    // 1. ç»Ÿä¸€åŠ¨ä½œæš‚å­˜ (é€‚é…æ–°åº“ window.ib)
    window.pendingAction = async function() {
        try {
            // --- ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šä»æ–°åº“ç‰©ç†æŠ¹é™¤æ•°æ® ---
            await window.ib.init();
            const db = window.ib._db;
            const tx = db.transaction(window.ib.storeName, "readwrite");
            const store = tx.objectStore(window.ib.storeName);
            
            // æ„é€ æ–°åº“å¯¹åº”çš„ Key (å¦‚ chat_history_1001)
            const historyKey = "chat_history_" + contactId;

            // æ‰§è¡Œç‰©ç†åˆ é™¤æŒ‡ä»¤
            await new Promise((resolve, reject) => {
                const req = store.delete(historyKey);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
            
            // --- 2. é¢å¤–ä¿é™©ï¼šæ¸…ç©ºè¯¥è”ç³»äººçš„ç½®é¡¶çŠ¶æ€ (åŸæ ·ä¿ç•™) ---
            let pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
            pinnedIds = pinnedIds.filter(id => id !== contactId);
            localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));

            showToast("è®°å½•å·²å½»åº•æ¸…ç©º");
            
            // --- 3. æ¸²æŸ“åˆ·æ–° (åŸæ ·ä¿ç•™) ---
            if (typeof initChatMsgPanel === 'function') {
                await initChatMsgPanel(); 
            }
            
        } catch (e) {
            console.error("åˆ é™¤å¤±è´¥:", e);
            showToast("åˆ é™¤æ“ä½œå¼‚å¸¸");
        }
    };

    // --- ğŸ—ï¸ å”¤èµ·å±…ä¸­å¼¹çª— (UI é€»è¾‘åŸæ ·ç…§æŠ„ï¼Œç¡®ä¿ ID å­˜åœ¨) ---
    const modal = document.getElementById('iosConfirmModal');
    if (modal) {
        const titleEl = document.getElementById('confirm-modal-title');
        const msgEl = document.getElementById('confirm-modal-msg');
        const btnEl = document.getElementById('confirm-modal-btn');

        if (titleEl) titleEl.textContent = "åˆ é™¤å¯¹è¯ï¼Ÿ";
        if (msgEl) msgEl.textContent = "è¯¥æ“ä½œå°†ç‰©ç†æŠ¹é™¤æ‰€æœ‰èŠå¤©æ•°æ®ï¼Œåˆ·æ–°åä¹Ÿä¸ä¼šæ¢å¤ã€‚";
        if (btnEl) btnEl.textContent = "åˆ é™¤";
        
        modal.style.display = 'flex';
    }
}

// --- ğŸ® Vibe Grid è§’è‰²é€‰æ‹©åŠŸèƒ½è¡¥å…¨ ---

// 1. æ‰“å¼€é€‰æ‹©å™¨å¹¶è§¦å‘æ¸²æŸ“
function openVibeCharPicker() {
    const modal = document.getElementById('modal-vibe-picker');
    if (modal) {
        modal.style.display = 'flex';
        renderVibeCharPicker(); // æ‰“å¼€æ—¶ç«‹å³åˆ·æ–°åˆ—è¡¨
    } else {
        console.error("æ‰¾ä¸åˆ° ID ä¸º modal-vibe-picker çš„å¼¹çª—");
    }
}

// 2. ä» IndexedDB æå–è§’è‰²å¹¶æ¸²æŸ“åˆ°æ¸¸æˆé€‰äººåˆ—è¡¨
async function renderVibeCharPicker() {
    const listContainer = document.getElementById('vibe-char-scroll-list');
    if (!listContainer) return;

    // ä»æ•°æ®åº“è¯»å–ä½ è§’è‰²ä¹¦é‡Œçš„æ‰€æœ‰äºº
    const charList = await loadFromDB('char_list') || [];
    listContainer.innerHTML = "";

    if (charList.length === 0) {
        listContainer.innerHTML = `
            <div style="grid-column: span 2; text-align:center; padding:40px; color:#999;">
                <p style="font-size:14px;">è§’è‰²ä¹¦ç©ºç©ºå¦‚ä¹Ÿ</p>
                <p style="font-size:12px; margin-top:5px;">è¯·å…ˆå»â€œè§’è‰²ä¹¦â€Appåˆ›å»ºè§’è‰²</p>
            </div>`;
        return;
    }

    charList.forEach(char => {
        const item = document.createElement('div');
        item.className = 'char-card'; // å¤ç”¨ä½ ä¹‹å‰çš„å¡ç‰‡æ ·å¼
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <img class="char-card-img" src="${char.avatar}" style="height:120px;">
            <div class="char-card-info">
                <div class="char-card-name" style="font-size:14px;">${char.name}</div>
            </div>
        `;
        // ç‚¹å‡»è§’è‰²åï¼Œç¡®è®¤é€‰æ‹©å¹¶å¼€å§‹æ¸¸æˆ
        item.onclick = () => {
            confirmVibeOpponent(char);
        };
        listContainer.appendChild(item);
    });
}

// 3. ç¡®è®¤é€‰æ‹©å¯¹æ‰‹ï¼Œè¿›å…¥æ¸¸æˆç•Œé¢
function confirmVibeOpponent(char) {
    // è®¾ç½®å…¨å±€å¯¹æ‰‹å˜é‡
    window.vibeOpponent = char;
    
    // éšè—é€‰æ‹©å™¨å’Œå¯åŠ¨é¡µ
    document.getElementById('modal-vibe-picker').style.display = 'none';
    document.getElementById('vibe-start-screen').style.display = 'none';
    
    // æ˜¾ç¤ºæ¸¸æˆä¸»ä½“
    const gameMain = document.getElementById('vibe-game-main');
    gameMain.style.display = 'flex';
    setTimeout(() => { gameMain.style.opacity = '1'; }, 50);
    
    // å¡«å……å¯¹æ‰‹ UI
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    document.getElementById('opp-last-word').style.opacity = "0";
    
    // æ ¸å¿ƒï¼šåˆå§‹åŒ–æ£‹ç›˜
    if (typeof initVibeGrid === 'function') {
        initVibeGrid();
        showToast(`å·²è¿æ¥åˆ° ${char.name} çš„æ„è¯†æµ`);
    }
}

// 1. ä¿®æ”¹ renderMessages å’Œ handleSendMessage é€»è¾‘
// åœ¨ç”Ÿæˆ bubble çš„ HTML æ—¶ï¼Œç»Ÿä¸€åŠ ä¸Š onclick="showBubbleMenu(this, event)"
// æ¯”å¦‚ï¼šinner += `<div class="bubble" onclick="showBubbleMenu(this, event)">...</div>`;

function showBubbleMenu(el, e) {
    if (e) e.stopPropagation();

    // --- ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ­£åœ¨å¤šé€‰ï¼Œä¸å‡†å¼¹å‡ºèœå•ï¼Œæ”¹ä¸ºé€‰æ‹©é€»è¾‘ ---
    const row = el.closest('.msg-row');
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected'); // ç›´æ¥åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        return; // ç«‹å³è¿”å›ï¼Œä¸æ‰§è¡Œä¸‹é¢çš„å¼¹å‡ºèœå•é€»è¾‘
    }
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected');
        refreshMultiSelectCount(); // ğŸ‘ˆ åˆ«å¿˜äº†è¿™é‡Œä¹Ÿè¦åŠ 
        return;
    }
    
    

    window.currentActiveBubble = el; 
    
    const menu = document.getElementById('bubble-menu');
    const overlay = document.getElementById('menu-overlay');
    if (!menu || !overlay) return;

    const isUser = el.closest('.msg-row').classList.contains('user');
    const recallBtn = document.getElementById('menu-recall');
    if (recallBtn) recallBtn.style.display = isUser ? 'flex' : 'none';

    const rect = el.getBoundingClientRect();
    menu.style.display = 'flex';
    overlay.style.display = 'block';
    
    let left = rect.left + (rect.width / 2) - 130;
    let top = rect.top - 140;

    if (left < 10) left = 10;
    if (left + 260 > window.innerWidth) left = window.innerWidth - 270;
    if (top < 80) top = rect.bottom + 15;

    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
}

function hideBubbleMenu() {
    const menu = document.getElementById('bubble-menu');
    const overlay = document.getElementById('menu-overlay');
    
    if (menu) menu.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    
    // æ¸…é™¤å…¨å±€å¼•ç”¨çš„å˜é‡
    window.currentActiveBubble = null;
    
    console.log("System: Context menu closed.");
}

// 2. åŠŸèƒ½æ‰§è¡Œä¸­å¿ƒ
function doAction(type) {
    // 1. é¦–å…ˆç¡®ä¿èƒ½æ‹¿åˆ°å½“å‰é€‰ä¸­çš„æ°”æ³¡å…ƒç´ 
    var el = window.currentActiveBubble; 
    if (!el) {
        hideBubbleMenu();
        return;
    }
    
    // 2. æå‰æå–æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼Œç¡®ä¿é¡ºåºæ­£ç¡®
    var currentTs = el.getAttribute('data-ts'); // è·å–æ—¶é—´æˆ³
    var currentCid = (window.currentChattingWith && window.currentChattingWith.id) ? window.currentChattingWith.id : null;
    
    // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼ˆç”¨äºå¤åˆ¶ã€å¼•ç”¨ã€è½¬å‘ï¼‰
    var textNode = el.querySelector('.msg-text-main') || el;
    var pureText = textNode.innerText.trim();
    var senderName = el.closest('.msg-row').classList.contains('user') ? "You" : (window.currentChattingWith.name || "å¯¹æ–¹");

    switch(type) {
        case 'copy':
            // ğŸš¨ ä¿®å¤ï¼šä¼ å…¥åˆšæ‰å®šä¹‰çš„ pureText
            copyToClipboard(pureText);
            break;

        case 'quote':
            // ğŸš¨ ä¿®å¤ï¼šæ‰§è¡Œå¼•ç”¨é€»è¾‘ï¼Œå¼¹å‡ºè¾“å…¥æ¡†ä¸Šæ–¹çš„é¢„è§ˆæ¡
            prepareQuote(pureText, senderName);
            break;

        case 'multi':
            // ğŸš¨ æ ¸å¿ƒï¼šç‚¹å‡»èœå•ä¸­çš„â€œå¤šé€‰â€ä¼šè§¦å‘è¿™é‡Œ
            enterMultiSelect(); 
            break;

        case 'delete':
            // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œä½¿ç”¨åˆšæ‰å·²ç»å®šä¹‰å¥½çš„ currentCid å’Œ currentTs
            if (!currentTs || !currentCid) {
                showToast("âš ï¸ ç‰©ç†å®šä½å¤±è´¥ï¼Œæ— æ³•æŠ¹é™¤");
            } else {
                // è°ƒç”¨çœŸå®çš„ç‰©ç†åˆ é™¤å‡½æ•°
                deleteSingleMessageReal(currentCid, currentTs);
            }
            break;
        
        case 'forward': 
            const text = el.querySelector('.msg-text-main, .msg-text-content, .bubble').innerText;
            openForwardPicker([{ text: text }]); 
            break;
        
        case 'recall':
            if (currentTs && window.currentChattingWith) {
                const contactId = window.currentChattingWith.id;
                showIOSConfirm("æ’¤å›æ¶ˆæ¯", "ç¡®å®šè¦æ’¤å›å—ï¼Ÿ", "æ’¤å›", async () => {
                    // 1. ç‰©ç†æ›´æ–°æ•°æ®åº“
                    await updateMessageRecallStatus(contactId, currentTs, true);
                    // 2. ğŸš¨ å…³é”®ï¼šç«‹å³é‡ç»˜å½“å‰èŠå¤©å®¤ï¼Œè®©æ°”æ³¡å˜â€œç°è‰²æç¤ºâ€
                    await renderMessages(); 
                    // 3. ğŸš¨ å…³é”®ï¼šç«‹å³åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨é¢„è§ˆ
                    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
                    showToast("å·²æ’¤å›ä¸€æ¡è®°å¿†ç¢ç‰‡");
                });
            }
            break;
    }
    hideBubbleMenu(); // æ‰§è¡Œå®Œä»»ä½•åŠ¨ä½œéƒ½è¦å…³æ‰èœå•
}

// --- ğŸ“‹ å‰ªè´´æ¿å¼•æ“ ---
function copyToClipboard(text) {
    if (!navigator.clipboard) {
        // å…¼å®¹æ—§ç‰ˆæˆ–éå®‰å…¨åŸŸå
        var textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
    }).catch(err => {
        showToast("å¤åˆ¶å¤±è´¥");
    });
}

// ä¿®æ”¹ä½ çš„ doAction å‡½æ•°
// åœ¨ doAction çš„ switch(type) é‡Œæ‰¾åˆ° 'multi':
// case 'multi': enterMultiSelect(); break;

// --- 2. é€€å‡ºå¤šé€‰æ¨¡å¼ ---
function exitMultiSelect() {
    console.log("System: Exiting Multi-select mode...");
    const rows = document.querySelectorAll('.msg-row');
    const footer = document.querySelector('.chat-room-footer');
    const multiBar = document.getElementById('multi-select-bar');

    rows.forEach(row => {
        // ğŸš¨ æ ¸å¿ƒï¼šç§»é™¤æ‰€æœ‰ç›¸å…³çš„ç±»å
        row.classList.remove('multi-selecting', 'selected');
        
        // å½»åº•æ¸…ç©ºå¤šé€‰æ¨¡å¼ä¸‹çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ¢å¤æ°”æ³¡åŸæœ¬çš„èœå•åŠŸèƒ½
        row.onclick = null; 
    });

    // æ¢å¤åº•æ çŠ¶æ€
    if (footer) footer.style.display = 'flex';
    if (multiBar) {
        multiBar.style.display = 'none';
        // é¡ºä¾¿é‡ç½®è®¡æ•°æ–‡å­—
        const countEl = document.getElementById('multi-select-count');
        if (countEl) countEl.textContent = "å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯";
    }
    
    showToast("å·²é€€å‡ºç¼–è¾‘");
}

// --- 3. æ‰¹é‡åŠŸèƒ½å®ç° ---

// --- âš¡ æ‰¹é‡ï¼šç‰©ç†çº§é”€æ¯é€»è¾‘ ---
/**
 * ğŸ›°ï¸ æ‰¹é‡é”€æ¯åè®® (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šç‰©ç†æŠ¹é™¤é€‰ä¸­çš„å¤šæ¡æ¶ˆæ¯è®°å½•ï¼Œå¹¶åŒæ­¥åˆ·æ–°é¢„è§ˆ
 */
async function batchDelete() {
    const selectedRows = document.querySelectorAll('.msg-row.selected');
    if (selectedRows.length === 0) return showToast("è¯·å…ˆå‹¾é€‰");

    showIOSConfirm("æ‰¹é‡é”€æ¯", `ç¡®å®šè¦ç‰©ç†æŠ¹é™¤è¿™ ${selectedRows.length} æ¡è®°å¿†å—ï¼Ÿ`, "æŠ¹é™¤", async function() {
        try {
            const contactId = window.currentChattingWith.id;
            const historyKey = "chat_history_" + contactId;

            // 1. æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„æ—¶é—´æˆ³ (ç”¨äºç²¾å‡†å®šä½)
            const timestampsToDelete = Array.from(selectedRows).map(row => 
                row.querySelector('.bubble').getAttribute('data-ts')
            );

            // 2. ä»æ–°åº“è·å–è¯¥è”ç³»äººçš„å®Œæ•´å¯¹è¯åŒ…
            const chatBox = await window.ib.getItem(historyKey);
            if (!chatBox || !chatBox.messages) {
                showToast("æœªæ‰¾åˆ°å¯æ“ä½œçš„å†å²è®°å½•");
                return;
            }

            // 3. ğŸ§  ç‰©ç†è¿‡æ»¤ï¼šå‰”é™¤æ‰€æœ‰åŒ¹é…æ—¶é—´æˆ³çš„æ¶ˆæ¯
            const updatedMessages = chatBox.messages.filter(m => 
                !timestampsToDelete.includes(m.timestamp.toString())
            );

            // 4. ğŸ’¾ å­˜å›æ•°æ®åº“ (ç›´æ¥è¦†ç›–åŸå¯¹è±¡ä¸­çš„ messages æ•°ç»„)
            // è¿™ç§æ–¹å¼èƒ½ç™¾åˆ†ç™¾ä¿ç•™å¯¹è±¡åŸæœ¬çš„ id å’Œ contactIdï¼Œé˜²æ­¢ DataError
            chatBox.messages = updatedMessages;
            await window.ib.setItem(historyKey, chatBox);
            
            // --- ğŸš€ UI åŒæ­¥åˆ·æ–° (ç…§æŠ„åŸæœ‰é€»è¾‘) ---
            showToast("é€‰å®šè®°å¿†å·²ç‰©ç†éš”ç¦»");
            
            // é€€å‡ºå¤šé€‰æ¨¡å¼
            if (typeof exitMultiSelect === 'function') exitMultiSelect(); 
            
            // åˆ·æ–°èŠå¤©ç•Œé¢æ¸²æŸ“
            if (typeof renderMessages === 'function') renderMessages();   
            
            // åˆ·æ–°ä¸»åˆ—è¡¨çš„æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆ
            if (typeof initChatMsgPanel === 'function') initChatMsgPanel(); 

        } catch (err) {
            console.error("æ‰¹é‡é”€æ¯å¼‚å¸¸:", err);
            showToast("ç»´åº¦æŠ¹é™¤å¤±è´¥");
        }
    });
}

// --- C. æ‰¹é‡è½¬å‘ (é€»è¾‘ä¼˜åŒ–) ---
function batchForward() {
    const selectedRows = document.querySelectorAll('.msg-row.selected');
    if (selectedRows.length === 0) return showToast("è¯·é€‰æ‹©æ¶ˆæ¯");

    const messages = Array.from(selectedRows).map(row => {
        const textNode = row.querySelector('.msg-text-main') || row.querySelector('.msg-text-content') || row.querySelector('.bubble');
        return { text: textNode.innerText.trim() };
    });

    exitMultiSelect(); // å…ˆé€€å‡ºå¤šé€‰æ¨¡å¼
    openForwardPicker(messages); // å¼¹å‡ºè½¬å‘é¡µé¢
}
// å®æ—¶æ›´æ–°é€‰ä¸­æ•°é‡çš„æ˜¾ç¤º
function refreshMultiSelectCount() {
    const count = document.querySelectorAll('.msg-row.selected').length;
    const countEl = document.getElementById('multi-select-count');
    if (countEl) {
        countEl.textContent = count > 0 ? `å·²é€‰æ‹© ${count} æ¡æ¶ˆæ¯` : "é€‰æ‹©æ¶ˆæ¯";
    }
}

// ä¿®æ”¹è¿›å…¥å‡½æ•°ï¼Œç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
function enterMultiSelect() {
    const rows = document.querySelectorAll('.msg-row');
    const multiBar = document.getElementById('multi-select-bar');
    const footer = document.querySelector('.chat-room-footer');

    rows.forEach(row => {
        row.classList.add('multi-selecting');
        
        // ç‚¹å‡»æ•´è¡Œåˆ‡æ¢é€‰ä¸­çŠ¶æ€
        row.onclick = function() {
            this.classList.toggle('selected');
        };

        // å¦‚æœæ²¡æœ‰åœ†åœˆï¼Œè¡¥ä¸€ä¸ªåœ†åœˆ
        if (!row.querySelector('.msg-check-box')) {
            const circle = document.createElement('div');
            circle.className = 'msg-check-box';
            row.appendChild(circle);
        }
    });

    if (multiBar) multiBar.style.display = 'flex';
    if (footer) footer.style.display = 'none';
}
// ==========================================
// ğŸ“± iOS å…¨å±€é¡µé¢å¼¹çª—è°ƒåº¦ä¸­å¿ƒ (æ ¸å¿ƒå·¥å…·ç®±)
// ==========================================

/**
 * æ›¿ä»£ confirm() çš„ iOS é£æ ¼ç¡®è®¤æ¡†
 * @param {string} title æ ‡é¢˜
 * @param {string} msg æè¿°æ–‡å­—
 * @param {string} btnText ç¡®è®¤æŒ‰é’®çš„æ–‡å­—
 * @param {function} action ç‚¹å‡»ç¡®è®¤åè¦æ‰§è¡Œçš„å‡½æ•°
 */
function showIOSConfirm(title, msg, btnText, action) {
    console.log("System: Triggering IOS Confirm Modal...");
    
    const titleEl = document.getElementById('confirm-modal-title');
    const msgEl = document.getElementById('confirm-modal-msg');
    const btnEl = document.getElementById('confirm-modal-btn');
    const modal = document.getElementById('iosConfirmModal');

    if (!titleEl || !msgEl || !btnEl || !modal) {
        console.error("System Error: æ‰¾ä¸åˆ° iosConfirmModal ç›¸å…³çš„ HTML å…ƒç´ ï¼");
        return;
    }

    // 1. å¡«å……æ–‡å­—å†…å®¹
    titleEl.textContent = title;
    msgEl.textContent = msg;
    btnEl.textContent = btnText;

    // 2. å±é™©æ“ä½œï¼ˆå¦‚åˆ é™¤ï¼‰æŒ‰é’®å˜çº¢ï¼Œæ™®é€šæ“ä½œå˜è“
    btnEl.style.color = (btnText === "åˆ é™¤" || btnText === "æ’¤å›" || btnText === "æŠ¹é™¤") ? "#FF3B30" : "#007AFF";

    // 3. å°†ä»»åŠ¡å­˜å…¥å…¨å±€å¾…å¤„ç†åŠ¨ä½œä¸­
    window.pendingAction = action;

    // 4. æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
}

/**
 * æ›¿ä»£ alert() çš„ iOS é£æ ¼æˆåŠŸæç¤ºæ¡†
 * @param {string} title æ ‡é¢˜
 * @param {string} msg æè¿°æ–‡å­—
 */
function showIOSAlert(title, msg) {
    const titleEl = document.getElementById('alert-title');
    const msgEl = document.getElementById('alert-msg');
    const modal = document.getElementById('successAlert');

    if (titleEl && msgEl && modal) {
        titleEl.textContent = title;
        msgEl.textContent = msg;
        modal.style.display = 'flex';
    }
}
// --- 2. è§¦å‘è½¬å‘å…¥å£ (å•æ¡å’Œå¤šæ¡å…±ç”¨) ---
function openForwardPicker(messages) {
    // messages æ ¼å¼: [{ text: "å†…å®¹" }, ...]
    window.pendingForwardData = messages;
    
    const page = document.getElementById('page-forward-picker');
    page.style.transform = 'translateY(0)';
    
    switchForwardTab('friends'); // é»˜è®¤æ˜¾ç¤ºå¥½å‹
}

function closeForwardPicker() {
    document.getElementById('page-forward-picker').style.transform = 'translateY(100%)';
    window.pendingForwardData = [];
}

// --- 3. æ¸²æŸ“è½¬å‘åˆ—è¡¨ (å¤ç”¨åˆ—è¡¨é€»è¾‘) ---
async function switchForwardTab(mode) {
    window.forwardTabMode = mode;
    document.getElementById('fwd-tab-friends').classList.toggle('active', mode === 'friends');
    document.getElementById('fwd-tab-groups').classList.toggle('active', mode === 'groups');
    
    const container = document.getElementById('forward-list-content');
    const dbKey = (mode === 'friends') ? 'chat_friends' : 'chat_groups';
    const list = await loadFromDB(dbKey) || [];
    
    container.innerHTML = "";
    const groupWrapper = document.createElement('div');
    groupWrapper.className = 'chat-contact-group';
    groupWrapper.style.marginTop = "15px";

    list.forEach(target => {
        const row = document.createElement('div');
        row.className = 'contact-row';
        row.innerHTML = `
            <img class="contact-avatar" src="${target.avatar}" style="width:40px; height:40px; border-radius:${mode==='friends'?'50%':'8px'}">
            <div class="contact-info"><span class="contact-name" style="font-size:15px;">${target.name}</span></div>
            <div style="color:#007AFF; font-size:13px; font-weight:600;">å‘é€</div>
        `;
        row.onclick = () => confirmForwardTo(target);
        groupWrapper.appendChild(row);
    });
    container.appendChild(groupWrapper);
}

// --- 4. ç¡®è®¤è½¬å‘é€»è¾‘ (è°ƒç”¨ iOS å¼¹çª—) ---
function confirmForwardTo(target) {
    const count = window.pendingForwardData.length;
    showIOSConfirm(
        "ç¡®è®¤è½¬å‘", 
        `å°† ${count} æ¡æ¶ˆæ¯è½¬å‘ç»™ ${target.name}ï¼Ÿ`, 
        "å‘é€", 
        async function() {
            // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡
            const hasImage = window.pendingForwardData.some(item => 
                item.type === 'image' || item.type === 'photo' || item.type === 'img' || 
                (typeof (item.text || item.src || item.content) === 'string' && (item.text || item.src || item.content).startsWith('data:image'))
            );

            for(let item of window.pendingForwardData) {
                // è·å–çœŸå®å†…å®¹
                const realContent = item.text || item.src || item.content || "";
                
                // åˆ¤æ–­å½“å‰æ¡ç›®æ˜¯å¦ä¸ºå›¾ç‰‡
                const isImageData = (item.type === 'image' || item.type === 'photo' || item.type === 'img') || 
                                    (typeof realContent === 'string' && realContent.startsWith('data:image'));

                // ğŸš¨ é€»è¾‘ä¿®å¤ï¼šå¦‚æœè¿™æ‰¹è½¬å‘é‡Œæœ‰å›¾ç‰‡ï¼Œä¸”å½“å‰è¿™ä¸€æ¡æ˜¯çº¯æ–‡å­—ï¼ˆä¸æ˜¯å›¾ç‰‡ï¼‰ï¼Œå°±ç›´æ¥è·³è¿‡ä¸å‘
                if (hasImage && !isImageData) {
                    continue; 
                }

                const msgObj = {
                    role: "user",
                    text: realContent, 
                    type: isImageData ? "image" : "text",
                    timestamp: Date.now(),
                    isForwarded: true, 
                    isEmoji: false      
                };
                
                if (msgObj.text) {
                    await window.saveChatMessage(target.id, msgObj);
                }
            }
            
            showToast("å·²æˆåŠŸè½¬å‘");
            closeForwardPicker();
            
            // ç«‹å³åˆ·æ–°å½“å‰èŠå¤©å®¤
            if(window.currentChattingWith && window.currentChattingWith.id === target.id) {
                renderMessages();
                setTimeout(() => {
                    const container = document.querySelector('.chat-container') || document.querySelector('.chat-scroll-area');
                    if(container) container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }
    );
}

/**
 * ğŸ›°ï¸ æ¶ˆæ¯çŠ¶æ€æ ¡å‡†åè®® (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šç‰©ç†æ›´æ–°å•æ¡æ¶ˆæ¯çš„æ’¤å›çŠ¶æ€
 */
async function updateMessageRecallStatus(contactId, timestamp, isRecalled) {
    const historyKey = "chat_history_" + contactId;
    
    try {
        // 1. ğŸ” è·å–å®Œæ•´å¯¹è¯åŒ…
        const chatBox = await window.ib.getItem(historyKey);
        if (!chatBox || !chatBox.messages) return;

        // 2. ğŸ¯ å®šä½ç›®æ ‡æ¶ˆæ¯ (ä½¿ç”¨ == ç¡®ä¿å…¼å®¹å­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹çš„æ—¶é—´æˆ³)
        const idx = chatBox.messages.findIndex(m => m.timestamp == timestamp);
        
        if (idx !== -1) {
            // 3. âœ… ç‰©ç†é‡å†™æ’¤å›æ ‡è®°
            chatBox.messages[idx].recalled = isRecalled;
            
            // 4. ğŸ’¾ å­˜å›æ•°æ®åº“ (ä¿æŒå¯¹è±¡å®Œæ•´ç»“æ„ï¼Œç¡®ä¿ä¸»é”® ID ä¸ä¸¢å¤±)
            await window.ib.setItem(historyKey, chatBox);
            
            console.log(`%c[Protocol] æ¶ˆæ¯ ${timestamp} çŠ¶æ€å·²æ›´æ–°: ${isRecalled ? 'RECALLED' : 'ACTIVE'}`, "color: #34C759;");
        }
    } catch (err) {
        console.error("æ’¤å›çŠ¶æ€æ›´æ–°å¤±è´¥:", err);
    }
}

// ==========================================
// ğŸ‘ï¸ è”è§‰ç‰ˆï¼šæ’¤å›å†…å®¹æ·±åº¦è§£ç å¼•æ“ (æ”¯æŒåŒè¯­æ¸²æŸ“)
// ==========================================
function viewRecalledTrace(content) {
    const viewer = document.getElementById('modal-recalled-viewer');
    const textZone = document.getElementById('recalled-v-text');
    if (!viewer || !textZone) return;

    // ğŸš¨ æ ¸å¿ƒï¼šè°ƒç”¨å…¨åŸŸè§£æå¼•æ“å¤„ç†æ’¤å›çš„æ–‡æœ¬å†…å®¹
    const parsed = parseMessageContent(content);

    let html = "";
    
    // å¦‚æœæ’¤å›çš„æ¶ˆæ¯é‡Œæœ‰å¼•ç”¨ï¼Œå…ˆæ¸²æŸ“å¼•ç”¨ç›’
    if (parsed.quoteHtml) {
        html += `<div style="margin-bottom:15px; opacity:0.6; pointer-events:none;">${parsed.quoteHtml}</div>`;
    }

    // æ˜¾ç¤ºåŸæ–‡æ­£æ–‡
    html += `<div style="font-size:16px; color:#1d1d1f; font-weight:500;">${parsed.displayMain}</div>`;

    // å¦‚æœæ˜¯åŒè¯­æ¶ˆæ¯ï¼Œç‰©ç†é‡å»ºç¿»è¯‘å±‚
    if (parsed.isDual) {
        // æå–è¯‘æ–‡æ–‡å­— (ä» parsed.transHtml ä¸­æ­£åˆ™æå–æˆ–æ‰‹åŠ¨åˆ‡å‰²)
        const transText = content.split('[TRANS]')[1]?.trim() || "";
        html += `
            <div style="margin-top:15px; padding-top:15px; border-top:0.5px solid rgba(0,0,0,0.08);">
                <div style="font-size:9px; font-weight:900; color:#8E8E93; margin-bottom:5px; letter-spacing:1.5px;">DECODED TRANSLATION</div>
                <div style="font-size:14px; color:#8E8E93; font-style:italic; line-height:1.5;">${transText}</div>
            </div>
        `;
    }

    textZone.innerHTML = html; // ğŸš¨ ç‰©ç†æ³¨å…¥æ¸²æŸ“åçš„ HTML
    viewer.style.display = 'flex';
    viewer.style.zIndex = "100001";
    console.log("System: æ’¤å›å†…å®¹å·²è”è§‰è§£ç ã€‚");
}

// å¼ºåˆ¶å°†å…¶å…³è”åˆ° windowï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.viewRecalledTrace = viewRecalledTrace;
// ==========================================
// âš™ï¸ èŠå¤©è®¾ç½®é¡µé¢æ§åˆ¶å™¨
// ==========================================

// 1. æ‰“å¼€è®¾ç½®é¡µ
function openChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
    }
}

// 2. å…³é—­è®¾ç½®é¡µ
function closeChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(100%)';
    }
}

// 3. ä»è®¾ç½®é¡µè·³è½¬åˆ°â€œTaçš„èµ„æ–™â€
async function openChatProfileFromSettings() {
    console.log("System: å°è¯•ä»è®¾ç½®é¡µå¼€å¯é¢„è§ˆåç‰‡...");
    
    let contact = window.currentChattingWith;

    // ğŸ›¡ï¸ å®‰å…¨é”ï¼šå¦‚æœå˜é‡ä¸¢å¤±ï¼Œå°è¯•ä» URL æˆ–ä¸Šä¸‹æ–‡æ¢å¤
    if (!contact) {
        showToast("âš ï¸ æœªèƒ½è·å–è§’è‰²ä¸Šä¸‹æ–‡");
        return;
    }

    // æ ¸å¿ƒï¼šåœ¨å±•ç¤ºåç‰‡å‰ï¼Œå…ˆå»æ•°æ®åº“æä¸€ä¸‹æœ€æ–°çš„èµ„æ–™
    // é˜²æ­¢ä½ åœ¨èµ„æ–™é¡µæ”¹äº†åå­—ï¼Œåç‰‡ä¸Šè¿˜æ˜¯æ—§çš„
    const charList = await loadFromDB('char_list') || [];
    const latestInfo = charList.find(c => c.id === contact.id) || contact;

    console.log("System: è½½å…¥æœ€æ–°èµ„æ–™è¿›è¡Œé¢„è§ˆ:", latestInfo.name);
    
    // è°ƒç”¨ä¹‹å‰çš„é«˜çº§åç‰‡æ˜¾ç¤ºå‡½æ•°
    openChatProfile(latestInfo);
}

// 4. è§¦å‘â€œæ¸…ç©ºèŠå¤©è®°å½•â€ (é€‚é…æ–°çš„ window.ib åº“)
function triggerClearHistory() {
    if(!window.currentChattingWith) return;
    
    showIOSConfirm(
        "æ¸…ç©ºè®°å½•",
        "ç¡®å®šè¦æ¸…ç©ºä¸è¯¥å¥½å‹çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ",
        "æ¸…ç©º",
        async function() {
            try {
                // 1. ğŸ’¡ å®šä¹‰å­˜å‚¨çš„ Key (ç¡®ä¿å’Œä½ å¹³æ—¶ä¿å­˜èŠå¤©è®°å½•çš„ Key ä¸€è‡´)
                const contactId = window.currentChattingWith.id;
                const storageKey = "chat_history_" + contactId;

                // 2. ğŸ” ä½¿ç”¨æ–°åº“è·å–æ•°æ®
                // è¿™é‡Œçš„ await ä¼šç›´æ¥è¿”å›ç»“æœï¼Œè€Œä¸æ˜¯ IDBRequest å¯¹è±¡
                let chatData = await window.ib.getItem(storageKey);

                if (chatData) {
                    // 3. âœ… æ¸…ç©ºæ¶ˆæ¯æ•°ç»„
                    chatData.messages = [];
                    // 4. ğŸ’¾ å­˜å›æ•°æ®åº“
                    await window.ib.setItem(storageKey, chatData);
                }

                showToast("è®°å½•å·²æ¸…ç©º");
                
                // åˆ·æ–° UI
                if(typeof renderMessages === 'function') renderMessages();
                closeChatSettings();
                
            } catch (err) {
                console.error("æ¸…ç©ºå¤±è´¥ï¼Œå…·ä½“åŸå› :", err);
                // è¿™é‡Œçš„æŠ¥é”™é€šå¸¸æ˜¯å› ä¸ºæ•°æ®é‡ŒåŒ…å«äº†æ— æ³•åºåˆ—åŒ–çš„å¯¹è±¡ (å¦‚ DOM èŠ‚ç‚¹æˆ– File å¯¹è±¡)
            }
        }
    );
}

// 5. è§¦å‘â€œåˆ é™¤å¥½å‹â€ (å¸¦ç¡®è®¤)
function triggerDeleteFriend() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    // ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ iOS é£æ ¼ç¡®è®¤æ¡†
    showIOSConfirm(
        "åˆ‡æ–­ç¤¾äº¤çº½å¸¦ï¼Ÿ", 
        `è¿™å°†åˆ é™¤ä¸ ${contact.name} çš„æ‰€æœ‰èŠå¤©è®°å½•å’Œä¸ªæ€§åŒ–è®¾ç½®ï¼Œä½†ä¼šä¿ç•™å…¶åœ¨â€œè§’è‰²ä¹¦â€ä¸­çš„åŸå§‹æ¡£æ¡ˆã€‚`, 
        "å½»åº•åˆ é™¤", 
        () => {
            executeMasterSocialDelete(contact.id);
        }
    );
}
// --- âš™ï¸ èŠå¤©è®¾ç½®é¡µï¼šæŠ˜å é€»è¾‘ ---
function toggleSettingItem(headerEl) {
    // 1. æ‰¾åˆ°å¯¹åº”çš„çˆ¶å®¹å™¨
    const item = headerEl.parentElement;
    
    // 2. æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ‰“å¼€
    const isActive = item.classList.contains('active');
    
    // 3. (å¯é€‰) å¦‚æœä½ æƒ³å®ç°â€œæ‰‹é£ç´â€æ•ˆæœï¼ˆæ‰“å¼€ä¸€ä¸ªè‡ªåŠ¨å…³é—­å…¶ä»–çš„ï¼‰ï¼Œå°±æŠŠè¿™æ®µåŠ ä¸Šï¼š
    document.querySelectorAll('.ios-accordion-item').forEach(el => {
        el.classList.remove('active');
    });

    // 4. åˆ‡æ¢å½“å‰çŠ¶æ€
    if(isActive) {
        item.classList.remove('active');
    } else {
        item.classList.add('active');
    }
}

// ç¨å¾®ä¿®æ”¹æ‰“å¼€è®¾ç½®é¡µçš„é€»è¾‘ï¼Œé¡ºä¾¿å¡«ä¸€ä¸‹åº•éƒ¨çš„ ID
var originalOpenChatSettings = openChatSettings;
openChatSettings = function() {
    originalOpenChatSettings(); // è°ƒç”¨ä¹‹å‰çš„æ‰“å¼€åŠ¨ç”»
    // å¡«å……åº•éƒ¨çš„ ID
    if(window.currentChattingWith) {
        const uid = document.getElementById('setting-uid-display');
        if(uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
    }
}
// --- ğŸ§  èƒŒæ™¯ç³»ç»Ÿå…¨å±€ç¼“å­˜ ---

// 1. æ‰“å¼€ä¸‡èƒ½ä¸Šä¼ å™¨
function openUniversalBgModal(target) {
    currentUploaderTarget = target;
    const modal = document.getElementById('modal-universal-uploader');
    const title = document.getElementById('uploader-title');
    const tag = document.getElementById('uploader-target-tag');
    
    title.textContent = target === 'chat' ? "è®¾ç½®èŠå¤©èƒŒæ™¯" : "è®¾ç½®èœå•èƒŒæ™¯";
    tag.textContent = target === 'chat' ? "SUPPORT IMG/VID" : "IMAGE ONLY";
    document.getElementById('universal-url-in').value = "";
    
    modal.style.display = 'flex';
}

function closeUniversalUploader() {
    document.getElementById('modal-universal-uploader').style.display = 'none';
}

// 2. å¤„ç† URL ä¸Šä¼ 
function handleUniversalUrl() {
    const url = document.getElementById('universal-url-in').value.trim();
    if(!url) return;
    
    // ç®€å•çš„æ ¼å¼åˆ¤å®š
    const isVideo = url.match(/\.(mp4|webm|ogg)/i);
    if(currentUploaderTarget === 'settings' && isVideo) {
        showToast("èœå•èƒŒæ™¯æš‚ä¸æ”¯æŒè§†é¢‘");
        return;
    }
    
    applyTempBg(currentUploaderTarget, isVideo ? 'vid' : 'img', url);
    closeUniversalUploader();
}

// 3. å¤„ç†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
function handleUniversalFile(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const isVideo = file.type.startsWith('video/');
        
        if(currentUploaderTarget === 'settings' && isVideo) {
            showToast("èœå•èƒŒæ™¯æš‚ä¸æ”¯æŒè§†é¢‘");
            return;
        }

        const reader = new FileReader();
        showToast("æ­£åœ¨è¯»å–æ–‡ä»¶...");
        reader.onload = function(e) {
            applyTempBg(currentUploaderTarget, isVideo ? 'vid' : 'img', e.target.result);
            closeUniversalUploader();
        };
        reader.readAsDataURL(file);
    }
}

// 4. å®æ—¶æ›´æ–°é¢„è§ˆå›¾ï¼ˆæ¯”ä¾‹ 9:16ï¼‰
function applyTempBg(target, type, data) {
    tempBgData[target] = { type, data };
    const thumb = document.getElementById(`preview-thumb-${target}`);
    
    if (type === 'vid') {
        thumb.innerHTML = `<video src="${data}" autoplay loop muted></video>`;
    } else {
        thumb.innerHTML = `<img src="${data}">`;
    }
}

// 5. ã€æ ¸å¿ƒä¿å­˜ã€‘ï¼šå†™å…¥ IndexedDB å¹¶ç‰©ç†åº”ç”¨
async function saveChatBackgroundSettings() {
    showToast("æ­£åœ¨ä¿å­˜è®¾ç½®...");

    // A. ä¿å­˜èŠå¤©èƒŒæ™¯ (åªæœ‰åœ¨èŠå¤©å®¤å†…æ‰ç”Ÿæ•ˆ)
    const contact = window.currentChattingWith;
    if (contact && tempBgData.chat.data) {
        const contactId = contact.id;
        localStorage.setItem(`chat_bg_type_${contactId}`, tempBgData.chat.type);
        await saveToDB(`chat_bg_data_${contactId}`, tempBgData.chat.data);
        tempBgData.chat.data = null; 
    }

    // B. ä¿å­˜å…¨å±€è®¾ç½®èƒŒæ™¯ (è¿™ä¸ªä¸åº”è¯¥å— contact é™åˆ¶ï¼)
    if (tempBgData.settings.data) {
        await saveToDB('settings_bg_data', tempBgData.settings.data);
        tempBgData.settings.data = null;
    }

    // é‡æ–°åº”ç”¨
    await applyBackgroundsToUI();
    showToast("âœ… èƒŒæ™¯å·²åŒæ­¥");
    // ğŸš¨ é‡ç‚¹ï¼šé€»è¾‘è·‘å®Œåï¼Œå¼¹å‡ºé«˜çº§æˆåŠŸæç¤ºï¼
    triggerSuccessHud("è®¾ç½®å·²åŒæ­¥");
}

// å…¼å®¹ä½  HTML é‡Œçš„å‡½æ•°åè°ƒç”¨
window.saveBackgroundSettings = saveChatBackgroundSettings;

// 6. ã€æ ¸å¿ƒåº”ç”¨ã€‘ï¼šå°†æ•°æ®æ¸²æŸ“åˆ°é¡µé¢
async function applyBackgroundsToUI() {
    const chatRoom = document.getElementById('page-chat-room');
    if (!chatRoom) return;

    // 1. ç¡®ä¿èƒŒæ™¯å±‚å­˜åœ¨
    let bgLayer = document.getElementById('chat-room-full-bg');
    if (!bgLayer) {
        bgLayer = document.createElement('div');
        bgLayer.id = 'chat-room-full-bg';
        // ğŸš€ ç¡®ä¿ z-index æ˜¯ -1ï¼Œpointer-events æ˜¯ none
        bgLayer.style = "position:absolute; inset:0; width:100%; height:100%; z-index:-1; pointer-events:none; overflow:hidden;";
        chatRoom.prepend(bgLayer); // æ’å…¥åˆ°æœ€å¼€å¤´
    }

    const contact = window.currentChattingWith;
    if (contact) {
        const contactId = contact.id;
        const chatType = localStorage.getItem(`chat_bg_type_${contactId}`) || 'img';
        const chatData = await loadFromDB(`chat_bg_data_${contactId}`);

        if (chatData) {
            // æœ‰èƒŒæ™¯æ—¶ï¼Œè®©å®¹å™¨é€æ˜
            bgLayer.style.display = "block";
            if (chatType === 'vid') {
                bgLayer.innerHTML = `<video src="${chatData}" autoplay loop muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>`;
            } else {
                bgLayer.innerHTML = `<img src="${chatData}" style="width:100%;height:100%;object-fit:cover;">`;
            }
        } else {
            // æ²¡èƒŒæ™¯æ—¶æ˜¾ç¤ºé»˜è®¤è‰²
            bgLayer.innerHTML = "";
            bgLayer.style.backgroundColor = "#F2F2F7";
        }
    }
}

// 7. ã€åˆå§‹åŒ–ã€‘ï¼šåˆ·æ–°åæ¢å¤
// åœ¨ä½ åŸæœ¬çš„ window.onload æˆ– loadSavedData ç»“å°¾åŠ å…¥è¿™ä¸€è¡Œï¼š
// applyBackgroundsToUI();

// 8. é‡ç½®
/**
 * ğŸ›°ï¸ æ¶ˆæ¯çŠ¶æ€æ ¡å‡†åè®® (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šç‰©ç†æ›´æ–°å•æ¡æ¶ˆæ¯çš„æ’¤å›çŠ¶æ€
 */
async function updateMessageRecallStatus(contactId, timestamp, isRecalled) {
    const historyKey = "chat_history_" + contactId;
    
    try {
        // 1. ğŸ” è·å–å®Œæ•´å¯¹è¯åŒ…
        const chatBox = await window.ib.getItem(historyKey);
        if (!chatBox || !chatBox.messages) return;

        // 2. ğŸ¯ å®šä½ç›®æ ‡æ¶ˆæ¯ (ä½¿ç”¨ == ç¡®ä¿å…¼å®¹å­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹çš„æ—¶é—´æˆ³)
        const idx = chatBox.messages.findIndex(m => m.timestamp == timestamp);
        
        if (idx !== -1) {
            // 3. âœ… ç‰©ç†é‡å†™æ’¤å›æ ‡è®°
            chatBox.messages[idx].recalled = isRecalled;
            
            // 4. ğŸ’¾ å­˜å›æ•°æ®åº“ (ä¿æŒå¯¹è±¡å®Œæ•´ç»“æ„ï¼Œç¡®ä¿ä¸»é”® ID ä¸ä¸¢å¤±)
            await window.ib.setItem(historyKey, chatBox);
            
            console.log(`%c[Protocol] æ¶ˆæ¯ ${timestamp} çŠ¶æ€å·²æ›´æ–°: ${isRecalled ? 'RECALLED' : 'ACTIVE'}`, "color: #34C759;");
        }
    } catch (err) {
        console.error("æ’¤å›çŠ¶æ€æ›´æ–°å¤±è´¥:", err);
    }
}

// ä¿®æ”¹ä½ ä¹‹å‰çš„ openChatSettings å‡½æ•°
window.openChatSettings = function() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
        
        // ğŸš¨ æ ¸å¿ƒï¼šåœ¨æ‰“å¼€è®¾ç½®é¡µæ—¶ï¼Œç«‹åˆ»è¿è¡Œä¸€æ¬¡èƒŒæ™¯åº”ç”¨å‡½æ•°
        // è¿™æ ·é¢„è§ˆæ¡†å°±ä¼šç«‹åˆ»æ˜¾ç¤ºå½“å‰è¿™ä¸ªå¥½å‹çš„ä¸“å±èƒŒæ™¯å›¾
        applyBackgroundsToUI();

        // å¡«å……åº•éƒ¨çš„ ID
        if(window.currentChattingWith) {
            const uid = document.getElementById('setting-uid-display');
            if(uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
        }
    }
}
// --- ğŸ† è§¦å‘ iOS æˆåŠŸ HUD ---
function triggerSuccessHud(text = "å·²ä¿å­˜") {
    const hud = document.getElementById('save-success-hud');
    const hudText = hud.querySelector('.hud-text');
    
    if (!hud) return;

    hudText.textContent = text;
    hud.style.display = 'flex';
    
    // å¼ºåˆ¶é‡ç»˜è§¦å‘åŠ¨ç”»
    void hud.offsetWidth;
    
    hud.classList.add('show');

    // 1.5ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        hud.classList.remove('show');
        setTimeout(() => {
            hud.style.display = 'none';
        }, 300); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»ç»“æŸ
    }, 1500);
}
// --- ğŸ§  è§’è‰²èµ„æ–™ä¸´æ—¶æš‚å­˜ ---
var tempCharProfileData = { id: null, avatar: null };

// 1. è¿›å…¥ç¼–è¾‘é¡µé¢ï¼šåŠ è½½å½“å‰è§’è‰²çš„åŸå§‹æ•°æ®
// ==========================================
// ğŸ“ èµ„æ–™ç¼–è¾‘é¡µï¼šå¼ºåŠ›åŠ è½½å¼•æ“
// ==========================================
async function openCharProfileEditPage() {
    console.log("System: å‡†å¤‡è¯»å–è§’è‰²èµ„æ–™...");
    
    // 1. è·å–å½“å‰å¯¹è¯å¯¹è±¡
    const contact = window.currentChattingWith;
    
    // ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
    if (!contact || !contact.id) {
        console.error("Error: æ‰¾ä¸åˆ°å½“å‰è”ç³»äººä¸Šä¸‹æ–‡");
        showToast("âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¥½å‹");
        return;
    }

    // 2. é”å®šæš‚å­˜å˜é‡ï¼Œé˜²æ­¢ undefined æŠ¥é”™
    tempCharProfileData.id = contact.id;

    // 3. ä»æ•°æ®åº“æ‹‰å–æœ€å…¨çš„ä¿¡æ¯ï¼ˆåŒ…å«èƒŒæ™¯æ•…äº‹ descï¼‰
    const charList = await loadFromDB('char_list') || [];
    const charInfo = charList.find(c => c.id === contact.id) || contact;

    // 4. ç‰©ç†å¡«å€¼ï¼ˆå¢åŠ ç©ºå€¼åˆ¤å®šï¼Œé˜²æ­¢æ¸²æŸ“ä¸­æ–­ï¼‰
    const elAvatar = document.getElementById('edit-char-avatar-pre');
    const elName = document.getElementById('edit-char-name');
    const elDesc = document.getElementById('edit-char-desc');
    const elMetaId = document.getElementById('meta-char-id');

    if (elAvatar) elAvatar.src = charInfo.avatar || "";
    if (elName) elName.value = charInfo.name || "";
    if (elDesc) elDesc.value = charInfo.desc || "";
    if (elMetaId) elMetaId.textContent = contact.id.substring(0, 16).toUpperCase();

    // 5. ç‰©ç†æ¨å…¥é¡µé¢
    const subPage = document.getElementById('subpage-char-profile');
    if (subPage) {
        subPage.classList.add('active'); // åŠ ä¸Š active ç±»è§¦å‘æ»‘åŠ¨
        console.log("System: èµ„æ–™é¡µå·²æˆåŠŸæ¨å…¥");
    }
}

// 2. å¤´åƒé¢„è§ˆé€»è¾‘
function previewProfileAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            tempCharProfileData.avatar = e.target.result;
            document.getElementById('edit-char-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 3. ã€æ ¸å¿ƒåŒæ­¥å¼•æ“ã€‘ï¼šä¿å­˜å¹¶è¦†ç›–æ‰€æœ‰æ•°æ®åº“
async function saveCharProfileChanges() {
    const id = tempCharProfileData.id;
    const newName = document.getElementById('edit-char-name').value.trim();
    const newDesc = document.getElementById('edit-char-desc').value.trim();
    const newAvatar = tempCharProfileData.avatar;

    if (!newName) { showToast("åç§°ä¸èƒ½ä¸ºç©º"); return; }

    showToast("æ­£åœ¨åŒæ­¥å…¨åŸŸèµ„æ–™...");

    // --- A. åŒæ­¥åˆ°è§’è‰²ä¹¦ (char_list) ---
    let charList = await loadFromDB('char_list') || [];
    let charIdx = charList.findIndex(c => c.id === id);
    if (charIdx !== -1) {
        charList[charIdx].name = newName;
        charList[charIdx].avatar = newAvatar;
        charList[charIdx].desc = newDesc;
        await saveToDB('char_list', charList);
    }

    // --- B. åŒæ­¥åˆ°å¥½å‹åˆ—è¡¨ (chat_friends) ---
    let friendList = await loadFromDB('chat_friends') || [];
    let friendIdx = friendList.findIndex(f => f.id === id);
    if (friendIdx !== -1) {
        friendList[friendIdx].name = newName;
        friendList[friendIdx].avatar = newAvatar;
        await saveToDB('chat_friends', friendList);
    }

    // --- C. åŒæ­¥åˆ°å½“å‰æ­£åœ¨è¿›è¡Œçš„ä¸Šä¸‹æ–‡ ---
    window.currentChattingWith.name = newName;
    window.currentChattingWith.avatar = newAvatar;

    // --- D. åˆ·æ–°å½“å‰ UI ---
    // åˆ·æ–°èŠå¤©å®¤å¤´éƒ¨
    document.getElementById('room-contact-name').textContent = newName;
    document.getElementById('room-contact-avatar').src = newAvatar;
    
    // å¼ºåˆ¶é©±åŠ¨æ‰€æœ‰åˆ—è¡¨é‡ç»˜
    if (typeof renderChatList === 'function') renderChatList();
    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
    if (typeof renderCharList === 'function') renderCharList();

    // æˆåŠŸæç¤ºå¹¶é€€å‡º
    closeSubPage('subpage-char-profile');
    triggerSuccessHud("èµ„æ–™å·²å…¨åŸŸåŒæ­¥");
}
// A. æ‰“å¼€å¥½å‹ç¯ç¤¾äº¤å¡
function openSocialCard(char) {
    window.currentEditingCharId = char.id; // å…³é”®ï¼šè®°å½•å½“å‰æ­£åœ¨çœ‹è°
    
    document.getElementById('social-v-avatar').src = char.avatar;
    document.getElementById('social-v-name').textContent = char.name;
    
    // ä»ç¼“å­˜è¯»å–ç­¾å
    const savedMotto = localStorage.getItem('chat_motto_' + char.id) || "Hello! Let's chat.";
    document.getElementById('social-v-motto').textContent = savedMotto;
    
    document.getElementById('modal-social-card').style.display = 'flex';
}

// ä»å¡ç‰‡ç‚¹å‡»ç­¾åçš„å…¥å£
function openEditMottoFromCard() {
    const mottoEl = document.getElementById('social-v-motto');
    const input = document.getElementById('motto-input');
    const modal = document.getElementById('modal-motto-edit');
    
    if (input && mottoEl) {
        input.value = mottoEl.textContent;
        // ğŸš¨ é‡ç‚¹ï¼šåªç®¡æ˜¾ç¤ºè‡ªå·±ï¼Œä¸è¦å»ç¢°åº•ä¸‹çš„ modal-social-card
        modal.style.display = 'flex'; 
    }
}

// ä¿®æ”¹åçš„ä¿å­˜å‡½æ•°
function saveMotto() {
    const input = document.getElementById('motto-input');
    const val = input ? input.value.trim() : "";
    const charId = window.currentEditingCharId;

    if (val && charId) {
        localStorage.setItem('chat_motto_' + charId, val);
        
        // åŒæ­¥æ‰€æœ‰å¯èƒ½çš„ UI å…ƒç´ 
        const els = ['social-v-motto', 'profile-v-motto'];
        els.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = val;
        });

        triggerSuccessHud("ç­¾åå·²åŒæ­¥");
    }
    
    // ğŸš¨ é‡ç‚¹ï¼šåªå…³é—­ä¿®æ”¹æ¡†ï¼Œä¸è¦è¯¯å…³åº•ä¸‹çš„ç¤¾äº¤å¡ç‰‡
    document.getElementById('modal-motto-edit').style.display = 'none';
}

// B. æ‰“å¼€è®¾ç½®é¡µèµ„æ–™é¢„è§ˆå¡
async function openChatProfileFromSettings() {
    const contact = window.currentChattingWith;
    if(!contact) return;
    
    // è·å–æœ€æ–°æœ€å…¨çš„æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const fullChar = charList.find(c => c.id === contact.id) || contact;

    document.getElementById('aes-v-avatar').src = fullChar.avatar;
    document.getElementById('aes-v-name').textContent = fullChar.name;
    document.getElementById('aes-v-desc').textContent = fullChar.desc || "No description yet.";
    
    document.getElementById('modal-aes-preview').style.display = 'flex';
}
// 1. æ‰“å¼€ä¸–ç•Œç»‘å®šé¡µ
async function openWorldBindPage() {
    const contact = window.currentChattingWith;
    const worldList = await loadFromDB('world_list') || [];
    const charList = await loadFromDB('char_list') || [];
    const currentChar = charList.find(c => c.id === contact.id);
    
    // è®°ä½å½“å‰å·²ç»‘å®šçš„
    const boundIds = currentChar.boundWorldIds || [];
    const container = document.getElementById('world-bind-list');
    container.innerHTML = "";

    worldList.forEach(w => {
        const isChecked = boundIds.includes(w.id);
        const item = document.createElement('div');
        item.className = 'ios-list-item';
        item.innerHTML = `
            <div class="item-content">
                <span class="item-label">${w.name}</span>
                <input type="checkbox" class="world-checkbox" data-id="${w.id}" ${isChecked ? 'checked' : ''} style="width:22px; height:22px;">
            </div>
        `;
        container.appendChild(item);
    });
    openSubPage('subpage-world-bind');
}

// 2. ä¿å­˜ç»‘å®šå…³ç³»
async function saveWorldBinding() {
    const contact = window.currentChattingWith;
    const checks = document.querySelectorAll('.world-checkbox:checked');
    const selectedIds = Array.from(checks).map(c => c.dataset.id);

    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].boundWorldIds = selectedIds;
        await saveToDB('char_list', charList);
        document.getElementById('val-bound-count').textContent = selectedIds.length + " ä¸ªåè®®";
        triggerSuccessHud("åè®®å·²ç»‘å®š");
        closeSubPage('subpage-world-bind');
    }
}

// 3. è§£æå…³ç³»ç½‘ (åˆ›æ–°ç‚¹ï¼šAI è‡ªåŠ¨åˆ›é€  NPC)
// --- ğŸŒŒ æ ¸å¿ƒï¼šå¢é‡ç”Ÿæˆå¼•æ“ ---
async function generateRelationsWithAI(isAppend = false) {
    const contact = window.currentChattingWith;
    const loader = document.getElementById('quantum-loader');
    const statusText = document.getElementById('q-status');

    loader.style.display = 'flex';
    
    // 1. æå–â€œå·²æœ‰äººç‰©åå•â€ï¼šè¿™æ˜¯é˜²æ­¢ AI ç”Ÿæˆé‡å¤è§’è‰²çš„å…³é”®
    const charList = await loadFromDB('char_list') || [];
    const charIdx = charList.findIndex(c => c.id === contact.id);
    const currentChar = charList[charIdx];
    const existingNPCs = currentChar.relationNetwork || [];
    const existingNames = existingNPCs.map(n => n.name).join('ã€'); // ğŸ‘ˆ ä¼ ç»™ AI çš„â€œé»‘åå•â€

    // 2. æå–ä¸–ç•Œè§‚è§„åˆ™
    const allWorlds = await loadFromDB('world_list') || [];
    const boundIds = currentChar.boundWorldIds || [];
    const worldContext = allWorlds.filter(w => boundIds.includes(w.id)).map(w => w.content).join("\n");

    statusText.textContent = isAppend ? "æ­£åœ¨æ‹“å®½ç¤¾äº¤è±¡é™..." : "æ­£åœ¨æ„å»ºåˆä»£ç½‘ç»œ...";

    // 3. æ„å»º Promptï¼šæ˜ç¡®è¦æ±‚åŒºåˆ† level
    const prompt = `ä½ æ˜¯ä¸€å°é‡å­ç¤¾äº¤ç½‘ç»œæ¨¡æ‹Ÿå™¨ã€‚åŸºäºè§’è‰²[${currentChar.name}]å’Œä¸–ç•ŒèƒŒæ™¯[${worldContext}]ã€‚
    ${isAppend ? `ç›®å‰å·²æœ‰è§’è‰²: ${existingNames}ã€‚è¯·ã€ç»å¯¹é¿å¼€ã€‘è¿™äº›äººåï¼Œæ–°å¢ 2-3 ä¸ªæ€§æ ¼è¿¥å¼‚çš„äººç‰©ã€‚` : `è¯·åˆ›é€  3-5 ä¸ªæ ¸å¿ƒäººç‰©ã€‚`}
    
    è¦æ±‚ï¼š
    - "level" å­—æ®µ: å¿…é¡»æ ‡æ³¨ä¸º "core" (ç¾ç»Šææ·±) æˆ– "associate" (æ™®é€šå¾€æ¥)ã€‚
    - "art_tag": æè¿°å…¶åšæ¶‚é£å¤–è²Œå…³é”®è¯ã€‚
    
    æ ¼å¼: [{"name":"","role":"","bio":"","level":"core/associate","art_tag":""}]`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const newNpcs = JSON.parse(data.choices[0].message.content.match(/\[.*\]/s)[0]);

        // 4. æ³¨å…¥å¤´åƒå’Œ ID
        newNpcs.forEach((n, index) => {
            n.id = "npc_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            n.avatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${n.art_tag + n.name}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        });

        // 5. å¢é‡ä¿å­˜ï¼šæŠŠæ–°ç”Ÿæˆçš„æ‹¼æ¥åˆ°æ—§çš„åé¢
        const updatedNetwork = isAppend ? [...existingNPCs, ...newNpcs] : newNpcs;
        currentChar.relationNetwork = updatedNetwork;
        await saveToDB('char_list', charList);

        // 6. UI åˆ·æ–°
        renderNPCGrid(updatedNetwork);
        document.getElementById('relation-empty-state').style.display = 'none';
        document.getElementById('relation-footer').style.display = 'flex'; // ğŸ‘ˆ ç¡®ä¿æ‰©å±•æŒ‰é’®å¯è§
        
        loader.style.display = 'none';
        triggerSuccessHud(isAppend ? "çº½å¸¦å·²æ‹“å®½" : "å…³ç³»ç½‘å·²å°±ç»ª");

    } catch(e) {
        loader.style.display = 'none';
        showToast("é‡å­çº ç¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
}

// --- ğŸ“– å‰§æƒ…å›æº¯ï¼šç”Ÿæˆä¸“å±å¾€äº‹ ---
// ==========================================
// ğŸ“œ å¾€äº‹è§£å¯†ç³»ç»Ÿï¼šå…¨æ–°æ¨ç¿»ç‰ˆ
// ==========================================

// ==========================================
// ğŸ•µï¸ NPC å¾€äº‹è¿½è¸ªå¼•æ“ï¼šç‰©ç†å¯¹é½ä¸é˜²å´©åç‰ˆ
// ==========================================
async function traceNPCStory() {
    const npc = window.currentViewingNPC; 
    const mainChar = window.currentChattingWith; 
    
    // ğŸš¨ ä¿®æ­£ 1ï¼šç²¾å‡†å®šä½æŒ‰é’®ã€‚ä½¿ç”¨ .npc-btn-action åŒ¹é…ä½ çš„ HTML
    // æˆ‘ä»¬ç›´æ¥æŠ“å–ç‚¹å‡»çš„é‚£ä¸ªâ€œå¾€äº‹â€æŒ‰é’®
    const btn = document.querySelector('#modal-npc-detail .npc-btn-action:first-child');

    // ğŸš¨ ä¿®æ­£ 2ï¼šé˜²å¾¡æ€§é€»è¾‘ï¼Œé˜²æ­¢ null å¯¼è‡´ classList æŠ¥é”™
    if (!btn) {
        console.error("System Error: æ‰¾ä¸åˆ°æŒ‰é’®å…ƒç´ ï¼Œè¯·æ£€æŸ¥ HTML ç±»åæ˜¯å¦ä¸º .npc-btn-action");
        return;
    }

    if (!npc || !mainChar) {
        if (window.showToast) window.showToast("âš ï¸ æ— æ³•è¯†åˆ«è§’è‰²é“¾è·¯");
        return;
    }

    // 1. æ£€æŸ¥æ˜¯å¦å·²ç»è§£å¯†è¿‡ (æŒä¹…åŒ–è¯»å–)
    if (npc.detailedPast) {
        console.log("System: æ¡£æ¡ˆå·²å­˜åœ¨ï¼Œæ­£åœ¨ç›´æ¥æ‰“å¼€...");
        document.getElementById('modal-npc-detail').style.display = 'none';
        if (window.openPastDecoderUI) openPastDecoderUI(npc, npc.detailedPast, false);
        return;
    }

    // 2. å¼€å¯è§£å¯†åŠ¨ç”»
    if (btn.classList.contains('decoding')) return;
    btn.classList.add('decoding');
    const originalText = btn.innerHTML; // å¤‡ä»½åŒ…å«å›¾æ ‡çš„ HTML
    btn.textContent = "DECODING...";

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        await new Promise(r => setTimeout(r, 1200));

        // ğŸ­ é’ˆå¯¹ BL å°è¯´èƒŒæ™¯ä¼˜åŒ–çš„ç”µå½±æ„Ÿ Prompt
        const prompt = `ä½ æ­£åœ¨å›æº¯[${mainChar.name}]ä¸[${npc.name}]çš„å…±åŒå¾€äº‹ã€‚
        èƒŒæ™¯: ${npc.bio}ï¼Œä¸¤äººçš„å…³ç³»ç°çŠ¶: ${npc.role}ã€‚
        è¯·åˆ›ä½œä¸€æ®µçº¦ 250 å­—çš„éšç§˜å¾€äº‹ï¼Œè¦æ±‚ï¼š
        1. é£æ ¼é«˜çº§ã€å¯Œæœ‰ç”µå½±æ„Ÿå’Œç ´ç¢æ„Ÿã€‚
        2. ä¾§é‡äºä¸¤äººæƒ…æ„Ÿçš„æš—æµæ¶ŒåŠ¨æˆ–æŸä¸ªå‘½è¿è½¬æŠ˜ç‚¹ã€‚
        3. ç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€ã€‚`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        
        // å¢åŠ å®‰å…¨æå–é€»è¾‘
        if (!data.choices || !data.choices[0]) throw new Error("API è¿”å›æ•°æ®å¼‚å¸¸");
        const story = data.choices[0].message.content.trim();

        // 3. æ ¸å¿ƒï¼šä¿å­˜åˆ° IndexedDB æ•°æ®åº“ï¼Œé˜²æ­¢åˆ·æ–°æ¶ˆå¤±
        // å‡è®¾ä½ å·²ç»å®šä¹‰äº†å…¨å±€çš„ loadFromDB å’Œ saveToDB å‡½æ•°
        let charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === mainChar.id);
        
        if (charIdx !== -1) {
            const relationNetwork = charList[charIdx].relationNetwork || [];
            const nIdx = relationNetwork.findIndex(n => n.id === npc.id);
            if (nIdx !== -1) {
                charList[charIdx].relationNetwork[nIdx].detailedPast = story;
                await saveToDB('char_list', charList);
                window.currentViewingNPC.detailedPast = story;
            }
        }

        // 4. æš´åŠ›åˆ‡æ¢ç•Œé¢
        btn.classList.remove('decoding');
        btn.innerHTML = originalText; // è¿˜åŸå›¾æ ‡
        
        const modal = document.getElementById('modal-npc-detail');
        if (modal) modal.style.display = 'none'; 
        
        setTimeout(() => {
            if (window.openPastDecoderUI) {
                openPastDecoderUI(npc, story, true); // å”¤èµ·æ–°å¡ç‰‡å¹¶å¼€å¯æ‰“å­—æœº
            }
        }, 150);

    } catch (e) {
        console.error("è§£å¯†å¤±è´¥:", e);
        btn.classList.remove('decoding');
        btn.innerHTML = originalText;
        if (window.showToast) window.showToast("é‡å­ä¿¡å·è¿æ¥å¤±è´¥");
    }
}

// è¾…åŠ©ï¼šæ‰“å¼€è§£å¯†å±•ç¤ºå±‚
function openPastDecoderUI(npc, content, isNew) {
    const modal = document.getElementById('modal-past-decoder');
    const textField = document.getElementById('past-text-body');
    
    // å¡«å……åŸºæœ¬ä¿¡æ¯
    document.getElementById('past-name-txt').textContent = npc.name;
    document.getElementById('past-avatar-img').src = npc.avatar;
    document.getElementById('past-hero-blur').style.backgroundImage = `url(${npc.avatar})`;

    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
    
    textField.textContent = "";
    if (isNew) {
        // æ‰“å­—æœºæ•ˆæœ
        let i = 0;
        function typing() {
            if (i < content.length) {
                textField.textContent += content.charAt(i);
                i++;
                // æ»šåŠ¨æ¡è‡ªåŠ¨è·Ÿéš
                const scroller = modal.querySelector('.aes-scroll-area');
                scroller.scrollTop = scroller.scrollHeight;
                setTimeout(typing, 25);
            }
        }
        typing();
    } else {
        textField.textContent = content;
    }
}

// è¾…åŠ©ï¼šå…³é—­å‡½æ•°
function closePastDecoder() {
    document.getElementById('modal-past-decoder').style.display = 'none';
}

// --- ğŸ¨ æ¸²æŸ“ï¼šåŠ¨æ€åŒºåˆ†å…³ç³»æƒé‡ ---
function renderNPCGrid(npcs) {
    const grid = document.getElementById('npc-grid');
    if (!grid) return;
    grid.innerHTML = "";
    
    npcs.forEach((npc, i) => {
        const card = document.createElement('div');
        const isCore = npc.level === 'core';
        card.className = `char-card npc-arrival npc-${npc.level || 'associate'}`;
        card.style.animationDelay = (i * 0.1) + "s";
        card.innerHTML = `
            <img class="char-card-img" src="${npc.avatar}">
            ${isCore ? '<div class="core-bond-badge" style="position:absolute; top:10px; left:10px; background:#007AFF; color:white; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:900;">CORE</div>' : ''}
            <div class="char-card-info">
                <div class="char-card-name">${npc.name}</div>
                <div class="char-card-desc" style="color:${isCore ? '#007AFF' : '#8e8e93'}; font-weight:700;">${npc.role}</div>
            </div>`;
        
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»å¡ç‰‡æ—¶ï¼ŒæŠŠæ•°æ®å¡ç»™å…¨å±€å˜é‡ï¼Œå¦åˆ™æŒ‰é’®æ‰¾ä¸åˆ°ç›®æ ‡
        card.onclick = () => {
            console.log("System: Selecting NPC ->", npc.name);
            window.currentViewingNPC = npc; 
            openNPCDetail(npc);
        };
        grid.appendChild(card);
    });
}

// --- ğŸ­ æ‰“å¼€ NPC èµ„æ–™å¡ ---
// --- ğŸ­ æ‰“å¼€ NPC èµ„æ–™å¡ (çº¯å‡€ç‰ˆï¼Œè§£å†³ style æŠ¥é”™) ---
function openNPCDetail(npc) {
    console.log("System: Opening Dossier for ->", npc.name);
    window.currentViewingNPC = npc; 

    // 1. å¡«å……åŸºç¡€ä¿¡æ¯
    const avatar = document.getElementById('npc-v-avatar');
    const banner = document.getElementById('npc-v-banner');
    const name = document.getElementById('npc-v-name');
    const role = document.getElementById('npc-v-role');
    const bio = document.getElementById('npc-v-bio');

    if(avatar) avatar.src = npc.avatar;
    if(banner) banner.src = npc.avatar; 
    if(name) name.textContent = npc.name;
    if(role) role.textContent = npc.role.toUpperCase();
    if(bio) bio.textContent = npc.bio;
    
    // 2. çŠ¶æ€é‡ç½®ï¼šç¡®ä¿æŒ‰é’®æ–‡å­—å›å½’åˆå§‹çŠ¶æ€
    const btn = document.querySelector('#modal-npc-detail .npc-btn-main:first-child');
    if (btn) {
        btn.classList.remove('scanning'); // ç§»é™¤æ‰«æåŠ¨ç”»ç±»
        btn.textContent = "æŸ¥çœ‹å¾€äº‹";      // æ¢å¤åŸæœ¬æ–‡å­—
    }

    // 3. æ˜¾ç¤ºå¼¹çª—
    const modal = document.getElementById('modal-npc-detail');
    if(modal) modal.style.display = 'flex';
}
// --- ğŸš€ æ‰“å¼€å…³ç³»ç½‘å­é¡µé¢ ---
async function openRelationsPage() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    // 1. ä»æ•°æ®åº“è¯»å–å½“å‰è§’è‰²çš„æœ€æ–°æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const currentChar = charList.find(c => c.id === contact.id);
    
    const emptyState = document.getElementById('relation-empty-state');
    const npcGrid = document.getElementById('npc-grid');

    // 2. æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰äº†ç”Ÿæˆå¥½çš„å…³ç³»ç½‘
    const network = currentChar.relationNetwork || [];
    
    if (network.length > 0) {
        // å¦‚æœæœ‰æ•°æ®ï¼Œéšè—ç©ºçŠ¶æ€ï¼Œæ¸²æŸ“ç½‘æ ¼
        if (emptyState) emptyState.style.display = 'none';
        renderNPCGrid(network); // è°ƒç”¨ä½ ä¹‹å‰å†™çš„æ¸²æŸ“å‡½æ•°
    } else {
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºâ€œé‡å­è§£æâ€æŒ‰é’®
        if (emptyState) emptyState.style.display = 'block';
        if (npcGrid) npcGrid.innerHTML = "";
    }

    // 3. æ»‘å…¥é¡µé¢
    openSubPage('subpage-relations');
}
// --- ğŸš‘ ä¿®æ­£ ID å†²çªè¡¥ä¸ ---
async function saveWorldBinding() {
    const contact = window.currentChattingWith;
    const checks = document.querySelectorAll('.world-checkbox:checked');
    const selectedIds = Array.from(checks).map(c => c.dataset.id);

    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].boundWorldIds = selectedIds;
        await saveToDB('char_list', charList);

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œè¦æŠŠ 'val-bound-count' æ”¹ä¸º 'val-bound-status'
        const statusEl = document.getElementById('val-bound-status');
        if (statusEl) {
            statusEl.textContent = selectedIds.length > 0 ? selectedIds.length + " ä¸ªåè®®" : "å»ç»‘å®š";
        }

        triggerSuccessHud("åè®®å·²ç»‘å®š");
        closeSubPage('subpage-world-bind');
    }
}
// ==========================================
// ğŸ“¡ æ·±åº¦ç¤¾äº¤é€»è¾‘ï¼šå¸¦â€œä»ªå¼æ„Ÿâ€å»¶è¿Ÿçš„ AI å®¡æ ¸
// ==========================================
async function handleNPCFriendRequest() {
    const btn = document.getElementById('npc-add-btn');
    const text = document.getElementById('npc-add-text');
    
    // 1. æ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨
    const sourceNpc = window.currentViewingNPC;
    const mainChar = window.currentChattingWith;

    console.log("System: Requesting more relations for", sourceNpc ? sourceNpc.name : "NULL");

    if (!btn || btn.classList.contains('sending')) return;
    
    if (!sourceNpc) {
        showToast("âš ï¸ æœªè¯†åˆ«åˆ°ç›®æ ‡ NPC");
        return;
    }

    // --- å¯åŠ¨åŠ¨æ•ˆ ---
    btn.classList.add('sending');
    text.textContent = "SIGNALING...";

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        if (!apiKey) throw new Error("Missing API Key");

        // æ¨¡æ‹Ÿæ‰«ææ„Ÿ
        await new Promise(r => setTimeout(r, 1000));
        text.textContent = "DECODING...";

        // 2. å‡†å¤‡ä¸Šä¸‹æ–‡
        const charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === mainChar.id);
        const currentCharData = charList[charIdx];
        const existingNetwork = currentCharData.relationNetwork || [];
        const existingNames = existingNetwork.map(n => n.name).join('ã€');

        const prompt = `ä½ æ˜¯ä¸€å°é‡å­å…³ç³»æ¨¡æ‹Ÿå™¨ã€‚
        ç›®å‰ä¸»è§’[${mainChar.name}]é€šè¿‡äººç‰©[${sourceNpc.name}](${sourceNpc.role})åœ¨æ·±å…¥ç¤¾äº¤åœˆã€‚
        è¯·åŸºäº[${sourceNpc.name}]çš„èƒŒæ™¯[${sourceNpc.bio}]ï¼Œå†æ‰©å…… 2 ä¸ªä¸ä»–æœ‰å¯†åˆ‡å¾€æ¥çš„æ–°è§’è‰²ã€‚
        ã€è¦æ±‚ã€‘ç»å¯¹é¿å¼€å·²æœ‰äººç‰©ï¼š${existingNames}ã€‚
        ã€è¾“å‡ºã€‘ä¸¥æ ¼JSONæ•°ç»„æ ¼å¼: [{"name":"","role":"ä¸${sourceNpc.name}çš„å…³ç³»","bio":"","level":"associate","art_tag":""}]`;

        // 3. AI è°ƒç”¨
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        const content = data.choices[0].message.content;
        const newNpcs = JSON.parse(content.match(/\[.*\]/s)[0]);

        // 4. å¤„ç†æ–°äºº
        newNpcs.forEach(n => {
            n.id = "npc_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            n.avatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${encodeURIComponent(n.name)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        });

        // 5. å¢é‡ä¿å­˜
        const updatedNetwork = [...existingNetwork, ...newNpcs];
        charList[charIdx].relationNetwork = updatedNetwork;
        await saveToDB('char_list', charList);

        // 6. è§†è§‰åé¦ˆ
        text.textContent = "SYNCED";
        btn.classList.remove('sending');
        btn.classList.add('sent');
        btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" style="margin-right:5px;"><polyline points="20 6 9 17 4 12"></polyline></svg><span>å‘ç°æ–°è„‰ç»œ</span>`;

        showToast(`å·²è§£æå‡º ${newNpcs.length} ä¸ªæ–°äººç‰©`);

        // 7. åˆ·æ–°å¹¶é€€å‡º
        setTimeout(() => {
            document.getElementById('modal-npc-detail').style.display = 'none';
            btn.classList.remove('sent');
            btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg><span id="npc-add-text">Add Friend</span>`;
            
            if (typeof renderNPCGrid === 'function') renderNPCGrid(updatedNetwork);
        }, 1500);

    } catch (e) {
        console.error("Critical Error:", e);
        btn.classList.remove('sending');
        text.textContent = "SIGNAL LOST";
        showToast(e.message === "Missing API Key" ? "API Key æœªé…ç½®" : "è§£æå¤±è´¥");
    }
}
// ==========================================
// ğŸ§¹ å…¨åŸŸè®°å¿†æŠ¹é™¤ï¼šå½»åº•æ¸…ç†ç¤¾äº¤ã€è®¾ç½®ã€ç»‘å®šåŠå…³ç³»ç½‘
// ==========================================
/**
 * ğŸ›°ï¸ æœ€é«˜æƒé™å…¨åŸŸæ¸…ç†åè®® (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šç‰©ç†é”€æ¯æŒ‡å®šäººæ ¼çš„æ‰€æœ‰èŠå¤©è®°å½•ã€èƒŒæ™¯æ•°æ®ã€ç¤¾äº¤å…³ç³»åŠä¸–ç•Œä¹¦ç»‘å®š
 */
async function executeMasterSocialDelete(contactId) {
    if (!contactId) return;

    showToast("æ­£åœ¨æ‰§è¡Œé«˜ç»´è®°å¿†éš”ç¦»...");

    try {
        // --- ğŸš¨ 1. åˆå§‹åŒ–åº•å±‚æ•°æ®åº“è¿æ¥ ---
        await window.ib.init();
        const db = window.ib._db;
        const tx = db.transaction(window.ib.storeName, "readwrite");
        const store = tx.objectStore(window.ib.storeName);
        
        // --- ğŸš¨ 2. ç‰©ç†æŠ¹é™¤ç‹¬ç«‹æ•°æ®å— (èŠå¤©è®°å½•ä¸èƒŒæ™¯) ---
        // åœ¨æ–°åº“ä¸­ï¼Œè¿™äº›éƒ½æ˜¯ä»¥ç‹¬ç«‹ Key å­˜å‚¨çš„ï¼Œç›´æ¥æ‰§è¡Œ delete
        const historyKey = "chat_history_" + contactId;
        const wallpaperKey = `chat_bg_data_${contactId}`;
        
        await new Promise((resolve, reject) => {
            store.delete(historyKey);   // ç‰©ç†é”€æ¯èŠå¤©è®°å½•
            store.delete(wallpaperKey); // ç‰©ç†æŠ¹é™¤èƒŒæ™¯æ•°æ®
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
        console.log("âœ… èŠå¤©è®°å½•ä¸ä¸“å±èƒŒæ™¯æ•°æ®å·²ç‰©ç†é”€æ¯");

        // --- ğŸš¨ 3. ä»å¥½å‹åˆ—è¡¨ç§»é™¤ (ä½¿ç”¨å·²é€‚é…çš„ loadFromDB/saveToDB) ---
        let friendList = await loadFromDB('chat_friends') || [];
        friendList = friendList.filter(f => f.id !== contactId);
        await saveToDB('chat_friends', friendList);
        console.log("âœ… å¥½å‹åå•å·²æ¸…ç†");

        // --- ğŸš¨ 4. æŠ¹é™¤è§’è‰²æ¡£æ¡ˆå†…çš„ç»‘å®šä¸å…³ç³»ç½‘ ---
        let charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === contactId);
        if (charIdx !== -1) {
            // ä¿ç•™æ ¸å¿ƒæ¡£æ¡ˆï¼ˆåã€å¤´ã€æ„Ÿï¼‰ï¼Œä½†æ¸…ç©ºæ‰€æœ‰è¡ç”Ÿæ•°æ®
            charList[charIdx].boundWorldIds = [];    // æ¸…ç©ºä¸–ç•Œä¹¦ç»‘å®š
            charList[charIdx].relationNetwork = [];  // æ¸…ç©ºå…³ç³»ç½‘ NPC
            await saveToDB('char_list', charList);
            console.log("âœ… ä¸–ç•Œåè®®ä¸å…³ç³»ç½‘å·²é‡ç½®");
        }

        // --- ğŸš¨ 5. æ¸…ç† LocalStorage ä¸­çš„çç¢é…ç½® (åŸæ ·ç…§æŠ„) ---
        localStorage.removeItem(`chat_motto_${contactId}`);
        localStorage.removeItem(`chat_bg_type_${contactId}`);
        
        // ç§»é™¤ç½®é¡¶
        let pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
        pinnedIds = pinnedIds.filter(id => id !== contactId);
        localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));
        console.log("âœ… æœ¬åœ°åå¥½è®¾ç½®å·²æ¸…ç©º");

        // --- ğŸš¨ 6. UI çŠ¶æ€é‡ç½®ä¸åˆ·æ–° (åŸæ ·ç…§æŠ„) ---
        closeChatSettings();
        closeChatRoom();
        if(document.getElementById('subpage-relations')) closeSubPage('subpage-relations');
        if(document.getElementById('subpage-world-bind')) closeSubPage('subpage-world-bind');

        // åˆ·æ–°æ‰€æœ‰ç›¸å…³çš„åˆ—è¡¨
        if (typeof renderChatList === 'function') renderChatList();
        if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
        if (typeof renderCharList === 'function') renderCharList(); // åˆ·æ–°è§’è‰²ä¹¦å°å¡ç‰‡
        
        triggerSuccessHud("è¯¥äººæ ¼å·²å›å½’åˆå§‹æ€");

    } catch (e) {
        console.error("âŒ å…¨åŸŸæ¸…ç†å¤±è´¥:", e);
        showToast("éƒ¨åˆ†é‡å­æ•°æ®æ®‹ç•™ï¼Œè¯·é‡è¯•");
    }
}

// ==========================================
// ğŸš€ æœ¬æˆ‘æ¡£æ¡ˆï¼šå¼ºåŠ›ä¿®å¤é©±åŠ¨ï¼ˆåæ¥å±…ä¸Šç‰ˆï¼‰
// ==========================================

window.openUserProfileEdit = async function() {
    console.log("System: æ­£åœ¨ä» Unlimited åº“è°ƒå–äººæ ¼åè®®...");
    
    // ğŸ’¡ å…³é”®ï¼šå»æ–°åº“æ‹¿æ•°æ®ï¼Œè€Œä¸æ˜¯ localStorage
    const key = typeof getPersonaStorageKey === 'function' ? getPersonaStorageKey() : 'user_persona_data_global';
    const data = await window.ib.getItem(key) || { name: "æŒ‡æŒ¥å®˜", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=user_default", bio: "" };
    
    window.userPersona = data;
    syncUserPersonaToUI(data); // æ‰§è¡Œç‰©ç†åŒæ­¥

    const page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';
        page.style.zIndex = '999999';
        setTimeout(() => page.classList.add('active'), 10);
    }
};

// ==========================================
// ğŸ‘¤ æœ¬æˆ‘æ¡£æ¡ˆï¼šç›´ç™½å‡½æ•°ä¿®å¤ç‰ˆ
// ==========================================

// ğŸ›°ï¸ è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼šä¿®æ”¹æœ¬æˆ‘æ¡£æ¡ˆ
async function openUserProfileEdit() {
    const data = await window.ib.getItem('user_persona_data_global');
    
    if (data) {
        // æŠŠåº“é‡Œçš„å€¼å¡è¿›è¾“å…¥æ¡†ï¼Œè¿™æ ·ä½ ç‚¹ä¿®æ”¹æ—¶ï¼Œé‡Œé¢æ‰ä¼šæœ‰ä½ ä¹‹å‰å­˜çš„å†…å®¹
        document.getElementById('user-avatar-pre').src = data.avatar;
        document.getElementById('user-name-in').value = data.name;
        document.getElementById('user-bio-in').value = data.bio;
    }

    const page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';
        setTimeout(() => page.classList.add('active'), 10);
    }
}

// 2. é¢„è§ˆèµ„æ–™å¡
// ğŸ›°ï¸ é¢„è§ˆæœ¬æˆ‘æ¡£æ¡ˆï¼šå…¨æ¯æŠ•å½±åè®®
async function openUserCardPreview() {
    console.group("System: æ¡£æ¡ˆé¢„è§ˆæ ¡å‡†");
    
    try {
        // ä»æ–°åº“æ‹¿æ•°æ®
        const data = await window.ib.getItem('user_persona_data_global');
        
        if (data) {
            // ç‰©ç†å¡«å…¥èµ„æ–™å¡ HTML
            document.getElementById('user-card-avatar').src = data.avatar;
            document.getElementById('user-card-name').textContent = data.name;
            document.getElementById('user-card-bio').textContent = data.bio || "å°šæœªå½•å…¥ç³»ç»Ÿæ¡£æ¡ˆ...";
        } else {
            console.warn("æœªå‘ç°å­˜æ¡£ï¼Œæ˜¾ç¤ºé»˜è®¤å€¼");
        }

        // æ˜¾ç¤ºå¼¹çª—
        const modal = document.getElementById('modal-user-card');
        if (modal) {
            modal.style.display = 'flex';
            modal.style.zIndex = '30000';
        }
    } catch (e) {
        console.error("é¢„è§ˆå¤±è´¥:", e);
    }
    console.groupEnd();
}

// 4. å¤´åƒé¢„è§ˆ
function previewUserAvatar(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('user-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

console.log("âœ… ç›´ç™½ä¿®å¤ç‰ˆå‡½æ•°å·²å…¨éƒ¨æŒ‚è½½ï¼Œç°åœ¨å»ç‚¹ç‚¹çœ‹ï¼Ÿ");
// ==========================================
// ğŸ­ èº«ä»½éš”ç¦»å¼•æ“ï¼šä¸ºæ¯ä¸ªè§’è‰²åˆ†é…ç‹¬ç«‹çš„â€œæˆ‘â€
// ==========================================

// 1. è·å–å½“å‰è§’è‰²çš„ä¸“å±èº«ä»½å‘ä½ Key
function getPersonaStorageKey() {
    // ä¼˜å…ˆç»‘å®šå½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰² ID
    var contact = window.currentChattingWith;
    if (contact && contact.id) {
        return 'user_persona_for_' + contact.id;
    }
    // å¦‚æœæ˜¯ä»å…¨å±€è®¾ç½®è¿›å…¥ä¸”æ²¡é€‰å®šè§’è‰²ï¼Œè¿”å›ä¸€ä¸ªé€šç”¨ Key
    return 'user_persona_data_global';
}

// ==========================================
// ğŸ¨ æç®€é£æ ¼ï¼šæ–‡å­—å¤´åƒç”Ÿæˆå™¨
// ==========================================
// è¿™ä¸ªå‡½æ•°è´Ÿè´£ç°åœºæ‰‹æ“ä¸€ä¸ªå¸¦æ–‡å­—çš„ SVG å¤´åƒç»™ä½ 
function generateTextAvatarUrl(text, backgroundColor) {
    var txt = text ? text.charAt(0).toUpperCase() : "?"; // å–é¦–å­—æ¯ï¼Œæ²¡æœ‰å°±æ˜¾ç¤ºé—®å·
    var bg = backgroundColor || "#888888"; // é»˜è®¤é«˜çº§ç°åº•è‰²
    
    // ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„æ–¹å½¢SVGï¼Œä¸­é—´æ”¾ä¸ªç™½è‰²çš„å­—
    var svgRaw = '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">' +
              '<rect width="120" height="120" fill="' + bg + '"/>' +
              '<text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-weight="bold" font-size="65" fill="#ffffff">' + txt + '</text>' +
              '</svg>';
    
    // è½¬æ¢æˆæµè§ˆå™¨èƒ½è¯†åˆ«çš„æ•°æ®é“¾æ¥
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgRaw);
}


// ==========================================
// ğŸ­ èº«ä»½éš”ç¦»å¼•æ“ï¼šå¤šé‡é©¬ç”²æ ¸å¿ƒ
// ==========================================

// 1. è·å–å½“å‰è§’è‰²çš„ä¸“å±èº«ä»½å‘ä½ Key
function getPersonaStorageKey() {
    var contact = window.currentChattingWith;
    if (contact && contact.id) {
        return 'user_persona_for_' + contact.id;
    }
    return 'user_persona_data_global';
}

// 4. è¦†ç›–ä¿å­˜é€»è¾‘
// ğŸ›°ï¸ ä¿å­˜æœ¬æˆ‘æ¡£æ¡ˆï¼šç‰©ç†å°å­˜åè®®
async function saveUserProfile() {
    console.log("System: æ­£åœ¨æ‰§è¡Œèº«ä»½ç»‘å®šåè®®...");

    // A. æŠ“å– HTML é‡Œçš„å®æ—¶æ•°æ®
    const name = document.getElementById('user-name-in').value.trim();
    const bio = document.getElementById('user-bio-in').value.trim();
    const avatar = document.getElementById('user-avatar-pre').src;

    if (!name) { showToast("èµ·ä¸ªåå­—å§å®è´"); return; }

    const newData = { name, bio, avatar, timestamp: Date.now() };

    try {
        // B. ç‰©ç†å­˜å…¥æ–°åº“ (æ ¹æ®ä½ ä¹‹å‰çš„æŠ¥é”™ï¼Œæˆ‘ä»¬ç»Ÿä¸€ Key å)
        const storageKey = 'user_persona_data_global'; 
        await window.ib.setItem(storageKey, newData);
        window.userPersona = newData; // åŒæ­¥å†…å­˜

        // C. ğŸš¨ å…³é”®ï¼šç«‹å³æ‰‹åŠ¨æ›´æ–°â€œèµ„æ–™å¡â€ä¸Šçš„å†…å®¹ï¼Œä¸éœ€è¦åˆ·æ–°ï¼
        document.getElementById('user-card-name').textContent = name;
        document.getElementById('user-card-bio').textContent = bio || "å°šæœªå½•å…¥ç³»ç»Ÿæ¡£æ¡ˆ...";
        document.getElementById('user-card-avatar').src = avatar;

        // D. ä»ªå¼æ„Ÿï¼šå…³é—­é¡µé¢å¹¶æç¤º
        const page = document.getElementById('subpage-user-profile');
        if (page) page.classList.remove('active');
        
        // æ¸…ç†è€æ—§åƒåœ¾ï¼Œé˜²æ­¢å¹²æ‰°
        localStorage.removeItem('user_persona_data');
        
        if (window.triggerSuccessHud) triggerSuccessHud("èº«ä»½å¥‘çº¦å·²å°å­˜");
        console.log("âœ… å­˜å‚¨æˆåŠŸ:", newData);

    } catch (e) {
        console.error("âŒ å­˜å‚¨å¤±è´¥:", e);
        showToast("ç»´åº¦æº¢å‡º: " + e.message);
    }
}

/**
 * ğŸ›°ï¸ èº«ä»½èµ„æ–™å›æº¯åè®®
 * ä½œç”¨ï¼šé¡µé¢å¯åŠ¨æ—¶è‡ªåŠ¨ä»æ•°æ®åº“è°ƒå–èµ„æ–™å¹¶æ¸²æŸ“åˆ° UI ä¸Š
 */
async function restoreUserProfile() {
    const key = getPersonaStorageKey(); 
    const data = await window.ib.getItem(key);

    if (data) {
        window.userPersona = data; // å­˜å…¥å…¨å±€å¤‡ç”¨

        // ğŸ” æ‰¾åˆ°æ‰€æœ‰éœ€è¦æ˜¾ç¤ºåå­—å’Œå¤´åƒçš„åœ°æ–¹ï¼Œç‰©ç†å¡«å…¥
        const elements = {
            'card-user-name': data.name,
            'card-user-bio': data.bio,
            'top-bar-name': data.name
        };

        // å¾ªç¯å¡«å…¥æ–‡å­—
        for (let id in elements) {
            const el = document.getElementById(id);
            if (el) el.innerText = elements[id];
        }

        // å¾ªç¯å¡«å…¥å›¾ç‰‡
        const avatars = ['card-user-avatar', 'top-bar-avatar', 'user-avatar-pre'];
        avatars.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.src = data.avatar;
        });

        console.log("âœ… èº«ä»½èµ„æ–™å›æº¯æˆåŠŸ");
    }
}

// ğŸ›°ï¸ å…¨åŸŸ UI åŒæ­¥å¼•æ“ï¼šä¸€å¤„ä¿®æ”¹ï¼Œåˆ°å¤„ç”Ÿæ•ˆ
function syncUserPersonaToUI(data) {
    if (!data) return;

    // 1. é¡¶éƒ¨çŠ¶æ€æ 
    const topName = document.getElementById('top-user-name');
    const topAvt = document.getElementById('top-user-avatar');
    if (topName) topName.innerText = data.name;
    if (topAvt) topAvt.src = data.avatar;

    // 2. èµ„æ–™é¢„è§ˆå¡ (è§£å†³ä½ è¯´çš„â€œå°šæœªå®šä¹‰â€)
    const cardName = document.getElementById('user-card-name');
    const cardBio = document.getElementById('user-card-bio');
    const cardAvt = document.getElementById('user-card-avatar');
    if (cardName) cardName.textContent = data.name;
    if (cardBio) cardBio.textContent = data.bio || "å°šæœªå½•å…¥ç³»ç»Ÿæ¡£æ¡ˆ...";
    if (cardAvt) cardAvt.src = data.avatar;

    // 3. ç¼–è¾‘è¾“å…¥æ¡† (è¿›å…¥ç¼–è¾‘é¡µæ—¶åŒæ­¥)
    const inName = document.getElementById('user-name-in');
    const inBio = document.getElementById('user-bio-in');
    const inPre = document.getElementById('user-avatar-pre');
    if (inName) inName.value = data.name;
    if (inBio) inBio.value = data.bio || "";
    if (inPre) inPre.src = data.avatar;
}

// 5. å¤´åƒé¢„è§ˆï¼ˆä½ ä¹‹å‰çš„ä»£ç é‡Œå¥½åƒä¸¢äº†è¿™ä¸ªï¼Œæˆ‘ç»™ä½ è¡¥ä¸Šï¼‰
function previewUserAvatar(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('user-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

console.log("âœ… æ–‡å­—å¤´åƒå¼•æ“ & èº«ä»½éš”ç¦»åè®®å·²å…¨é¢æ¿€æ´»ï¼");
// ==========================================
// ğŸŒŒ ä¸“å±å›å¿†ï¼šå…¨èƒ½é©±åŠ¨ç³»ç»Ÿ (ä¿®å¤ ReferenceError)
// ==========================================

// 1. ã€å…¥å£ã€‘æ‰“å¼€åˆ—è¡¨å¹¶è§¦å‘æ¸²æŸ“
function openExclusiveMemories() {
    console.log("System: æ­£åœ¨è°ƒå–æ—¶ç©ºæ¡£æ¡ˆ...");
    var contact = window.currentChattingWith;
    if (!contact) {
        showToast("âš ï¸ ä¸¢å¤±è§’è‰²é“¾è·¯");
        return;
    }

    var subPage = document.getElementById('subpage-memory-list');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        subPage.style.zIndex = "15000";
        // æ¸²æŸ“åˆ—è¡¨
        renderMemoryList(contact.id);
    }
}

// 3. ã€å”¤èµ·ã€‘è¯¦æƒ…è§†ç•Œ
function openCinemaMemory(m) {
    if (!m) return;
    var modal = document.getElementById('modal-memory-cinema');
    if (!modal) return;

    // å®‰å…¨è®¾ç½®æ ‡é¢˜ï¼šå°è¯•åŒ¹é…ä½ å¯èƒ½å†™çš„ä¸¤ç§ ID
    var titleEl = document.getElementById('cinema-title-ui') || document.getElementById('cinema-title');
    if (titleEl) titleEl.textContent = m.title || "æ— åè®°å¿†";

    // å®‰å…¨è®¾ç½®æ­£æ–‡ï¼šå°è¯•åŒ¹é…ä½ å¯èƒ½å†™çš„ä¸¤ç§ ID
    var textEl = document.getElementById('cinema-text-content') || document.getElementById('cinema-text');
    if (textEl) {
        textEl.style.whiteSpace = "pre-wrap";
        textEl.textContent = m.content || "";
    }

    // å®‰å…¨è®¾ç½®å›¾ç‰‡
    var imgEl = document.getElementById('cinema-img');
    if (imgEl) imgEl.src = m.img || "";

    // å¼ºè¡Œæ˜¾ç¤º
    modal.style.display = 'flex';
    modal.style.zIndex = "1000000";
}

// 4. ã€æ ¸å¿ƒç”Ÿæˆã€‘ç»†è…»æ–‡é£ + 1000å­— + ç»ä¸é‡æ ·
// ==========================================
// ğŸŒŒ ä¸“å±å›å¿†ï¼šé‡å­å™äº‹è¶…çº§å¼•æ“ (ç‰©ç†é¿é”™ç‰ˆ)
// ==========================================

// ğŸš¨ è¿™ä¸€è¡Œæ”¾åœ¨å‡½æ•°å¤–é¢ï¼Œç”¨æ¥é˜²æ­¢ç”µè„‘å¡é¡¿ï¼ˆé˜²æŠ–é”ï¼‰
var isProcessingMemory = false;

async function triggerGenerateMemory() {
    if (window.isProcessingMemory) return;
    window.isProcessingMemory = true;

    var contact = window.currentChattingWith;
    if (!contact) {
        alert("âš ï¸ é“¾è·¯ä¸¢å¤±ï¼Œè¯·é‡æ–°è¿›å…¥èŠå¤©å®¤");
        window.isProcessingMemory = false;
        return;
    }

    var loader = document.getElementById('quantum-loader-overlay') || document.getElementById('quantum-loader');
    if (loader) loader.style.display = 'flex';

    try {
        var apiKey = localStorage.getItem('gpt_key');
        var apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        if (!apiKey) throw new Error("API Key æœªé…ç½®");

        // --- 1. å‡†å¤‡åŸºç¡€æ•°æ® ---
        var charList = await loadFromDB('char_list') || [];
        var fullChar = charList.find(c => c.id === contact.id) || contact;
        var myKey = 'user_persona_for_' + contact.id;
        var myData = JSON.parse(localStorage.getItem(myKey)) || {name:"æˆ‘", bio:""};

        // è·å–å·²æœ‰æ ‡é¢˜ç”¨äºé¿é›·
        var memories = await loadFromDB('memories_' + contact.id) || [];
        var existingTitles = memories.map(m => m.title).join('ã€');

        // ğŸš¨ ã€æ ¸å¿ƒä¿®å¤ã€‘å®šä¹‰æ„Ÿå®˜æ± ï¼Œç¡®ä¿ randomSense å­˜åœ¨
        var sensoryPool = [
            "æš´é›¨æ´—åˆ·è¿‡çš„é“è½¨ä¸é”ˆè¿¹", "æ—§ä¹¦æ¶æ­»è§’çš„ç°å°˜åœ¨è·³èˆ",
            "éš”ç€æ¯›ç»ç’ƒçœ‹åˆ°çš„æ¨¡ç³Šéœ“è™¹", "æ·±å¤œç«™å°æœ€åä¸€å¼ æŠ¥çº¸è¢«å¹èµ°",
            "æŒ‡å°–æŒ‰åœ¨å†°å†·é’¢ç´é”®ä¸Šçš„é¢¤åŠ¨", "è€å®…å‚¨ç‰©é—´é‡Œæ·¤ç§¯çš„å°˜åŸƒå‘³"
        ];
        var randomSense = sensoryPool[Math.floor(Math.random() * sensoryPool.length)];

        // ğŸ§  ã€é«˜çº§ Promptã€‘å¼ºåˆ¶è¦æ±‚å·®å¼‚åŒ–
        var prompt = `ä½ æ˜¯æ–‡å­¦å™äº‹å·¨åŒ ã€‚ä¸º[${fullChar.name}]ä¸[${myData.name}]ç¼–ç»‡ä¸€æ®µä¸“å±å›å¿†ã€‚
        ã€æ„è±¡é”šç‚¹ã€‘: "${randomSense}"
        ã€é¿é›·åå•ã€‘: ç›®å‰å·²ç»å­˜åœ¨çš„æ ‡é¢˜æœ‰ [${existingTitles || "æ— "}]ã€‚

        ã€ç¦ä»¤ã€‘:
        1. ä¸¥ç¦ä½¿ç”¨ # å·ã€* å·ã€- å·ç­‰ä»»ä½• Markdown æ ‡è®°ç¬¦å·ã€‚
        2. ä¸¥ç¦æ ‡é¢˜å‡ºç°â€œæ„Ÿå®˜ç¢ç‰‡â€æˆ–æ•°å­—ã€‚æ ‡é¢˜å¿…é¡»æå…·æ–‡å­¦ç¾æ„Ÿï¼ˆå¦‚ï¼šä½™çƒ¬ã€é›ªèŒ§ã€éœ“è™¹è€³é¸£ï¼‰ã€‚
        
        ã€å†™ä½œæŒ‡ä»¤ã€‘:
        1. è§†è§’ä¸ºç¬¬ä¸€äººç§°ï¼Œå­—æ•°800-1200å­—ã€‚
        2. æ–‡é£æåº¦ç»†è…»ã€å†·å†½ã€å……æ»¡ç”µå½±æ„Ÿã€‚
        3. ã€é‡ç‚¹ã€‘: è¯·åœ¨æ–‡ä¸­ä½¿ç”¨ä»¥ä¸‹ç¬¦å·è¿›è¡Œæ’ç‰ˆæ ‡æ³¨ï¼š
           - ä½¿ç”¨ ã€ ã€‘ åŒ…è£¹æ ¸å¿ƒçš„å…³é”®è¯æˆ–å…³é”®ç¬é—´ï¼ˆå°†æ˜¾ç¤ºä¸ºé»‘åº•ç™½å­—ï¼‰ã€‚
           - ä½¿ç”¨ ã€Œ ã€ åŒ…è£¹ç»†è…»çš„æ„Ÿå®˜ç»†èŠ‚æˆ–å¿ƒç†æå†™ï¼ˆå°†æ˜¾ç¤ºä¸ºä¸‹åˆ’çº¿åŠ ç²—ï¼‰ã€‚
        4. æ¯ä¸€æ®µè¯ä¸è¦å¤ªé•¿ï¼Œæ³¨æ„ç•™ç™½å’Œå‘¼å¸æ„Ÿã€‚
        
        æ ¼å¼ï¼š
        ã€æ ‡é¢˜ã€‘æ­¤å¤„å†™æ ‡é¢˜ï¼Œæ¯ä¸€æ¬¡ä¸èƒ½é‡å¤
        ã€æ­£æ–‡ã€‘æ­¤å¤„å†™æ­£æ–‡`;

        var res = await fetch(apiUrl + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.95,
                presence_penalty: 1.0 
            })
        });

        var data = await res.json();
        if (data.error) throw new Error(data.error.message);
        var raw = data.choices[0].message.content;

        // --- 3. è§£ææ ‡é¢˜ä¸æ­£æ–‡ ---
        var titleMatch = raw.match(/ã€æ ‡é¢˜ã€‘\s*[:ï¼š]?\s*(.*?)(?:\n|ã€æ­£æ–‡ã€‘|$)/);
        var title = (titleMatch && titleMatch[1]) ? titleMatch[1].trim() : "ç¢ç‰‡ " + Date.now();
        var content = raw.replace(/ã€æ ‡é¢˜ã€‘.*(\n|$)/, "").replace(/ã€æ­£æ–‡ã€‘\s*[:ï¼š]?\s*/, "").trim();

        // --- 4. ç‰©ç†ä¿å­˜æ•°æ® (å¼ºåˆ¶åŒæ­¥å¤´åƒ) ---
        var newMem = { 
            id: Date.now(), 
            title: title, 
            content: content, 
            img: fullChar.avatar // ğŸš¨ ç‰©ç†é”å®šï¼Œç›´æ¥ç”¨å¤´åƒ
        };

        memories.unshift(newMem);
        await saveToDB('memories_' + contact.id, memories);

        // --- 5. åŒæ­¥æ¸²æŸ“ UI ---
        await renderMemoryList(contact.id); 
        if (loader) loader.style.display = 'none';
        window.openCinemaMemory(newMem);

    } catch (e) {
        if (loader) loader.style.display = 'none';
        console.error("ç”Ÿæˆå¤±è´¥:", e);
        alert("é‡å­çº ç¼ å¤±è´¥: " + e.message);
    } finally {
        window.isProcessingMemory = false;
    }
}
window.triggerGenerateMemory = triggerGenerateMemory;
// --- ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è®°å¿†ç¢ç‰‡é€»è¾‘ (åŒæ­¥ä¿®å¤ç‰ˆ) ---
async function clearAllMemories() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    showIOSConfirm(
        "æŠ¹é™¤è®°å¿†", 
        "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ‰€æœ‰å›å¿†ç¢ç‰‡å—ï¼Ÿ", 
        "æŠ¹é™¤", 
        async function() {
            const dbKey = 'memories_' + contact.id;
            // 1. ç‰©ç†æ¸…ç©º
            await saveToDB(dbKey, []); 
            // 2. ğŸš¨ é‡ç‚¹ï¼šawait åˆ—è¡¨åˆ·æ–°
            await renderMemoryList(contact.id); 
            
            showToast("è®°å¿†å·²å½’äºè™šæ— ");
            if (window.triggerSuccessHud) triggerSuccessHud("æ¸…ç†å®Œæˆ");
        }
    );
}
// æŒ‚è½½å…¨å±€
window.clearAllMemories = clearAllMemories;

// ä¸ºäº†ç¡®ä¿ HTML é‡Œçš„ onclick="clearAllMemories()" èƒ½ç™¾åˆ†ä¹‹ç™¾æ‰¾åˆ°å®ƒ
// æˆ‘ä»¬ä¾ç„¶åœ¨å…¨å±€æ‰‹åŠ¨æŒ‚è½½ä¸€æ¬¡ï¼Œåšä¸ªåŒé‡ä¿é™©
window.clearAllMemories = clearAllMemories;
// --- ğŸï¸ æ¸²æŸ“åˆ—è¡¨å¡ç‰‡æ ¸å¿ƒ (å…·åç‰ˆ) ---
// --- ğŸï¸ æ¸²æŸ“åˆ—è¡¨å¡ç‰‡æ ¸å¿ƒ (æ”¯æŒå·¦æ»‘åˆ é™¤ç‰ˆ) ---
async function renderMemoryList(contactId) {
    console.log("System: æ­£åœ¨é‡ç»˜è®°å¿†åˆ—è¡¨å¹¶æ³¨å…¥æ»‘åŠ¨åè®®...", contactId);
    var container = document.getElementById('memory-list-container');
    if (!container) return;

    var memories = await loadFromDB('memories_' + contactId) || [];
    container.innerHTML = "";

    if (memories.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:100px 20px; color:#bbb; font-size:14px;">æ­¤é—´å°šæ— æ„Ÿå®˜ç¢ç‰‡...</div>';
        return;
    }

    memories.forEach(function(m, index) {
        // åˆ›å»ºæ»‘åŠ¨å¤–å£³
        var wrapper = document.createElement('div');
        wrapper.className = 'memory-swipe-wrapper';
        
        var displayNum = (memories.length - index).toString().padStart(2, '0');
        
        // ğŸš¨ æ ¸å¿ƒç»“æ„ï¼šæŒ‰é’®åœ¨ä¸‹ï¼Œå¡ç‰‡åœ¨ä¸Š
        wrapper.innerHTML = `
            <div class="memory-swipe-actions" onclick="deleteSingleMemory('${contactId}', ${m.id})">
                åˆ é™¤
            </div>
            <div class="memory-swipe-content memory-item-card">
                <div class="card-num">${displayNum}</div>
                <div style="position:relative; z-index:2;">
                    <span class="memory-tag" style="font-size:10px; font-weight:900; color:#007AFF; letter-spacing:2px;">FRAGMENT</span>
                    <div style="font-size:20px; font-weight:800; margin:10px 0; color:#1d1d1f;">${m.title}</div>
                    <p style="font-size:12px; color:#8e8e93; line-height:1.6;">${m.content.replace(/<[^>]+>/g, '').substring(0, 50)}...</p>
                </div>
            </div>
        `;
        
        // 1. è·å–å¡ç‰‡å†…å®¹å±‚ï¼Œå‡†å¤‡ç»‘å®šæ»‘åŠ¨äº‹ä»¶
        var contentEl = wrapper.querySelector('.memory-swipe-content');
        
        // 2. ç»‘å®šç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… (æ³¨æ„è¿™é‡Œç‚¹çš„æ˜¯ contentEl)
        contentEl.onclick = function() {
            // å¦‚æœå¡ç‰‡æ²¡è¢«æ»‘å¼€ï¼Œæ‰æ‰§è¡Œæ‰“å¼€é€»è¾‘
            if(contentEl.style.transform === "translateX(0px)" || !contentEl.style.transform) {
                window.openCinemaMemory(m);
            } else {
                // å¦‚æœæ»‘å¼€äº†ï¼Œç‚¹ä¸€ä¸‹å°±æ”¶å›å»
                contentEl.style.transform = "translateX(0px)";
            }
        };

        // 3. å¤ç”¨ä½ å·²æœ‰çš„æ»‘åŠ¨ç›‘å¬å¼•æ“
        // ğŸš¨ æ³¨æ„ï¼šå› ä¸ºä½ çš„ initSwipeEvents é‡Œçš„é˜ˆå€¼æ˜¯ -150ï¼Œæˆ‘ä»¬è¦å¾®è°ƒä¸€ä¸‹è¿™ä¸ªå…·ä½“çš„å¡ç‰‡
        initSwipeEvents(contentEl); 
        
        container.appendChild(wrapper);
    });
}
window.renderMemoryList = renderMemoryList;
// --- ğŸ—‘ï¸ ç²¾å‡†æŠ¹é™¤å•æ¡è®°å¿†ç¢ç‰‡ ---
async function deleteSingleMemory(contactId, memoryId) {
    // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»
    if(event) event.stopPropagation();

    showIOSConfirm(
        "æŠ¹é™¤ç‰‡æ®µ", 
        "ç¡®å®šè¦å°†è¿™æ®µç‰¹å®šçš„æ„Ÿå®˜ç¢ç‰‡æ°¸ä¹…ç‰©ç†éš”ç¦»å—ï¼Ÿ", 
        "æŠ¹é™¤", 
        async function() {
            // 1. è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰è®°å¿†
            var memories = await loadFromDB('memories_' + contactId) || [];
            
            // 2. è¿‡æ»¤æ‰è¦åˆ é™¤çš„é‚£ä¸€æ¡ (æ ¹æ® ID åŒ¹é…)
            var updatedMemories = memories.filter(function(m) {
                return m.id !== memoryId;
            });
            
            // 3. å­˜å›æ•°æ®åº“
            await saveToDB('memories_' + contactId, updatedMemories);
            
            // 4. ç«‹å³åŒæ­¥é‡ç»˜åˆ—è¡¨
            await renderMemoryList(contactId);
            
            showToast("ç¢ç‰‡å·²é”€æ¯");
            if (window.triggerSuccessHud) triggerSuccessHud("æ¸…ç†å®Œæˆ");
        }
    );
}
window.deleteSingleMemory = deleteSingleMemory;
// ==========================================
// ğŸ§  è®°å¿†æ€»ç»“ç®¡ç†åè®® (å…·åå‡½æ•°ç‰ˆ)
// ==========================================

// 1. ã€å…¥å£ã€‘æ‰“å¼€è®°å¿†æ€»ç»“é¡µé¢
async function openMemorySummary() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const subPage = document.getElementById('subpage-memory-summary');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        
        // 1. åŠ è½½æ»‘å—ä½ç½®
        const savedRounds = localStorage.getItem('summary_rounds_' + contact.id) || "10";
        const slider = document.getElementById('summary-rounds-slider');
        if (slider) {
            slider.value = savedRounds;
            window.updateSummarySlider(savedRounds);
        }

        // ğŸš¨ 2. æ ¸å¿ƒä¿®å¤ï¼šæ‰“å¼€é¡µé¢æ—¶å¼ºåˆ¶æ¸²æŸ“æ‰€æœ‰å·²æœ‰çš„æ€»ç»“å¡ç‰‡
        await window.renderSummaryCards(contact.id);
    }
}
window.openMemorySummary = openMemorySummary;

// 2. ã€åé¦ˆã€‘æ»‘åŠ¨æ¡å®æ—¶æ›´æ–°
function updateSummarySlider(val) {
    const display = document.getElementById('summary-rounds-val');
    const slider = document.getElementById('summary-rounds-slider');
    if (display) display.textContent = val;
    
    // æ›´æ–°æ»‘åŠ¨æ¡çš„é»‘è‰²è¿›åº¦æ¡é•¿åº¦
    if (slider) {
        const percent = ((val - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.setProperty('--percent', percent + '%');
    }
}
window.updateSummarySlider = updateSummarySlider;

// 3. ã€ä¿å­˜ã€‘æŒä¹…åŒ–è®¾ç½®
async function saveSummarySettings() {
    const contact = window.currentChattingWith;
    const val = document.getElementById('summary-rounds-slider').value;
    
    if (contact) {
        // å°†è®¾ç½®ç»‘å®šåˆ°å…·ä½“è§’è‰²
        localStorage.setItem('summary_rounds_' + contact.id, val);
        showToast("æ€»ç»“åè®®å·²ç”Ÿæ•ˆ");
        if (window.triggerSuccessHud) triggerSuccessHud("åè®®æ›´æ–°");
        closeSubPage('subpage-memory-summary');
    }
}
window.saveSummarySettings = saveSummarySettings;

// 4. ã€æ‰‹åŠ¨ã€‘è§¦å‘å³æ—¶æ€»ç»“é€»è¾‘ (é¢„ç•™ç»™ AI è°ƒç”¨çš„æ¥å£)
async function manualTriggerSummary() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    showToast("æ­£åœ¨æå–é‡å­è®°å¿†...");
    
    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        // 1. æŠ“å–æœ€è¿‘çš„èŠå¤©è®°å½•
        const history = await getChatHistory(contact.id);
        if (history.length < 5) {
            showToast("å¯¹è¯å¤ªçŸ­ï¼Œä¸è¶³ä»¥å½¢æˆè®°å¿†");
            return;
        }

        const chatContext = history.slice(-30).map(m => `${m.role}: ${m.text}`).join('\n');

        // 2. å‘ AI å‘èµ·æ€»ç»“è¯·æ±‚
        const prompt = `ä½ æ˜¯ä¸€ä¸ªè®°å¿†æå–å™¨ã€‚è¯·åˆ†æä»¥ä¸‹å¯¹è¯ï¼Œæå–å‡º [${contact.name}] ä¸ç”¨æˆ·ä¹‹é—´æœ€é‡è¦çš„å…³ç³»è¿›å±•ã€çº¦å®šçš„äº‹å®æˆ–æ·±åˆ»çš„æƒ…ç»ªè½¬æŠ˜ç‚¹ã€‚
        ã€è¦æ±‚ã€‘ï¼š
        1. è¯­æ°”ç®€ç»ƒï¼Œåƒç§äººç¬”è®°ã€‚
        2. å­—æ•°æ§åˆ¶åœ¨ 100 å­—ä»¥å†…ã€‚
        3. ä¸¥ç¦åºŸè¯ï¼Œç›´æ¥è¾“å‡ºæ€»ç»“å†…å®¹ã€‚
        
        å¯¹è¯å†…å®¹ï¼š
        ${chatContext}`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7
            })
        });

        const data = await res.json();
        const summaryText = data.choices[0].message.content.trim();

        // 3. ç‰©ç†ä¿å­˜
        let summaries = await loadFromDB('summaries_' + contact.id) || [];
        summaries.unshift({ timestamp: Date.now(), text: summaryText });
        await saveToDB('summaries_' + contact.id, summaries);

        // 4. åˆ·æ–° UI
        await renderSummaryCards(contact.id);
        triggerSuccessHud("æ ¸å¿ƒè®°å¿†å·²åç¼©");

    } catch (e) {
        showToast("æ€»ç»“å¤±è´¥");
        console.error(e);
    }
}
window.manualTriggerSummary = manualTriggerSummary;

async function renderSummaryCards(contactId) {
    const container = document.getElementById('summary-cards-container');
    if (!container) return;

    // ä»æ•°æ®åº“è¯»å–æ€»ç»“åˆ—è¡¨
    const summaries = await loadFromDB('summaries_' + contactId) || [];
    container.innerHTML = "";

    if (summaries.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc; font-size:12px; border:1px dashed #ddd; border-radius:15px;">å°šæ— æ ¸å¿ƒè®°å¿†è¢«æ•è·</div>';
        return;
    }

    summaries.forEach((s, index) => {
        const card = document.createElement('div');
        card.className = 'summary-card';
        card.innerHTML = `
            <span class="summary-date">${new Date(s.timestamp).toLocaleString()}</span>
            <div class="summary-content">${s.text}</div>
            <div class="btn-delete-summary" onclick="deleteSummary('${contactId}', ${s.timestamp})">æŠ¹é™¤</div>
        `;
        container.appendChild(card);
    });
}
window.renderSummaryCards = renderSummaryCards;

// ==========================================
// ğŸ—‘ï¸ æ ¸å¿ƒè®°å¿†æŠ¹é™¤åè®®
// ==========================================
async function deleteSummary(contactId, timestamp) {
    // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦å…¶ä»–å±‚
    if(event) event.stopPropagation();

    // 1. è°ƒç”¨ iOS é£æ ¼ç¡®è®¤æ¡†
    showIOSConfirm(
        "æŠ¹é™¤æ ¸å¿ƒè®°å¿†", 
        "ç¡®å®šè¦æ°¸ä¹…é”€æ¯è¿™æ®µå·²åç¼©çš„è®°å¿†å—ï¼ŸAI å°†ä¸å†èƒ½å›æº¯è¿™æ®µå› æœã€‚", 
        "æŠ¹é™¤", 
        async function() {
            console.log(`System: æ­£åœ¨ä»æ•°æ®åº“å‰”é™¤æ—¶é—´ç‚¹ -> ${timestamp}`);
            
            const dbKey = 'summaries_' + contactId;
            
            // 2. ä»æ•°æ®åº“è¯»å–åˆ—è¡¨
            let summaries = await loadFromDB(dbKey) || [];
            
            // 3. ç‰©ç†è¿‡æ»¤ï¼šå‰”é™¤åŒ¹é…æ—¶é—´æˆ³çš„é‚£ä¸€æ¡
            const originalLength = summaries.length;
            summaries = summaries.filter(s => s.timestamp !== timestamp);

            if (summaries.length < originalLength) {
                // 4. ä¿å­˜å›æ•°æ®åº“
                await saveToDB(dbKey, summaries);
                
                // 5. ğŸš¨ æ ¸å¿ƒï¼šç«‹å³é‡ç»˜æ€»ç»“åˆ—è¡¨ UI
                await renderSummaryCards(contactId);
                
                showToast("è®°å¿†ç‰‡æ®µå·²å½’äºè™šæ— ");
                if (window.triggerSuccessHud) triggerSuccessHud("æŠ¹é™¤æˆåŠŸ");
            } else {
                console.warn("System: æœªæ‰¾åˆ°åŒ¹é…çš„è®°å¿†èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥æ—¶é—´æˆ³ç²¾åº¦");
            }
        }
    );
}

// ğŸš¨ å¼ºåˆ¶æŒ‚è½½åˆ°å…¨å±€çª—å£ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.deleteSummary = deleteSummary;

// ==========================================
// ğŸš€ å›¾æ ‡å·¥åŠï¼šæ ‡å‡† Function é£æ ¼å¼•æ“
// ==========================================

// 1. å…¨å±€æ•°æ®
var currentIconTarget = null;
var tempIconData = null;
var iconDb = null;

// ==========================================
// ğŸš€ ç»ˆæç‰©ç†è¦†ç›–å¼•æ“ï¼šè§£å†³åˆ·æ–°â€œé—ªå›â€åŸæ ·é—®é¢˜
// ==========================================

var iconDb = null;

// 1. åˆå§‹åŒ–æ•°æ®åº“ï¼šå¼€å¯å³æ¸²æŸ“
function initDatabase() {
    var request = indexedDB.open("IconSystemDB", 1);
    
    request.onupgradeneeded = function(e) {
        var db = e.target.result;
        if (!db.objectStoreNames.contains("icons")) {
            db.createObjectStore("icons", { keyPath: "name" });
        }
    };

    request.onsuccess = function(e) {
        iconDb = e.target.result;
        console.log("System: æ•°æ®åº“é“¾æ¥æˆåŠŸï¼Œæ‰§è¡Œåˆå§‹åŒ–å¼ºåˆ¶æ¸²æŸ“");
        
        // ğŸš¨ æ ¸å¿ƒï¼šæ•°æ®åº“é“¾æ¥æˆåŠŸç¬é—´ï¼Œæ‰§è¡Œç‰©ç†è¦†ç›–
        applyAllCustomIcons();
    };
}

// 2. ç‰©ç†çº§æ¸²æŸ“å¼•æ“ï¼šå¼ºåˆ¶æ“¦é™¤é»˜è®¤æ ·å¼
function applyAllCustomIcons() {
    if (!iconDb) return;

    var transaction = iconDb.transaction("icons", "readonly");
    var store = transaction.objectStore("icons");
    var request = store.getAll();

    request.onsuccess = function(e) {
        var savedData = e.target.result;
        if (!savedData || savedData.length === 0) return;

        var iconMap = {};
        savedData.forEach(function(item) { iconMap[item.name] = item.data; });

        // 3. æ‰«ææ‰€æœ‰æ½œåœ¨ç›®æ ‡ (æ¡Œé¢ App ä¸ Dock æ )
        var allTargets = document.querySelectorAll('.app-cell, .dock-app');
        
        allTargets.forEach(function(app) {
            // èº«ä»½è¯†åˆ«ä¼˜å…ˆçº§
            var name = app.getAttribute('data-app');
            if (!name) {
                var nameEl = app.querySelector('.app-name');
                name = nameEl ? nameEl.textContent.trim() : "";
            }
            if (!name) {
                var act = app.getAttribute('onclick') || "";
                if (act.includes('charApp')) name = "RoleBook";
                if (act.includes('worldApp')) name = "WorldBook";
                if (act.includes('beautifyApp')) name = "Beautify";
                if (act.includes('iconApp')) name = "Icons";
            }

            // 4. å‘½ä¸­çš„å›¾æ ‡æ‰§è¡Œã€ç‰©ç†ç ´åæ€§ã€‘æ›¿æ¢
            if (name && iconMap[name]) {
                var box = app.querySelector('.icon-shape') || 
                          app.querySelector('.glass-icon-bg') || 
                          app;

                // ğŸš¨ å¼ºåˆ¶é‡ç½®æ ·å¼ï¼šç‰©ç†ç§»é™¤èƒŒæ™¯æ¸å˜ï¼Œæ³¨å…¥ !important æ ·å¼
                box.style.cssText = "background: transparent !important; box-shadow: none !important; border: none !important; overflow: hidden !important;";
                
                // æ³¨å…¥å›¾ç‰‡ï¼šå¢åŠ  onload ç›‘å¬ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œåå†éšè— SVG
                box.innerHTML = '<img src="' + iconMap[name] + '" style="width:100%; height:100%; object-fit:cover; border-radius:inherit; display:block;">';
                
                console.log("Fixed: ç‰©ç†è¦†ç›–æˆåŠŸ -> " + name);
            }
        });
    };
}

// 5. å¯åŠ¨å…¥å£ï¼šå¤šæ—¶æœºç‰©ç†è§¦å‘
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDatabase);
} else {
    initDatabase();
}

// é’ˆå¯¹æ‰‹æœºç«¯æ»‘åŠ¨è¿”å›ã€å”¤é†’æ—¶çš„ç¼“å­˜é—®é¢˜ï¼Œæ‰§è¡Œå¼ºåˆ¶åˆ·æ–°æ¸²æŸ“
window.addEventListener('pageshow', function() {
    if (iconDb) applyAllCustomIcons();
});

// ğŸš¨ ç»ˆæç»æ‹›ï¼šå¦‚æœä½ çš„é¡µé¢æœ‰å¤æ‚çš„åŠ¨æ€åŠ è½½ï¼Œå¼€å¯è¿™ä¸ªè§‚å¯Ÿå™¨
var observer = new MutationObserver(function() {
    if (iconDb) applyAllCustomIcons();
});
observer.observe(document.body, { childList: true, subtree: true });

// 3. å”¤èµ·é€‰æ‹©å™¨
function openIconTargetPicker() {
    var list = document.getElementById('icon-target-list');
    var subPage = document.getElementById('subpage-icon-picker');
    if (!list || !subPage) return;

    // ğŸš¨ ç‰©ç†è¡¥å…¨ï¼šç¡®ä¿æ‰€æœ‰ App éƒ½åœ¨åå•é‡Œ
    var apps = [
        "Wallpaper", "Settings", "Chat", "Photos", 
        "Music", "Themes", "Phone", "Messages", 
        "Beautify", "Icons", "Diary", "Wallet", 
        "Notes", "Shopping", "Forum", "Novels", "Live",
        "RoleBook", "WorldBook" // ğŸ‘ˆ è¡¥ä¸Šäº†ï¼
    ];
    
    list.innerHTML = apps.map(function(name) {
        return '<div class="ios-list-item" onclick="confirmIconTarget(\'' + name + '\')">' +
               '<div class="item-content"><span class="item-label">' + name + '</span></div></div>';
    }).join('');
    
    subPage.classList.add('active');
}

// 4. ç¡®è®¤é€‰æ‹© (é‡ç‚¹ä¿®å¤ï¼šç¡®ä¿å®ƒæ˜¯å…¨å±€ function)
function confirmIconTarget(name) {
    currentIconTarget = name;
    var display = document.getElementById('val-icon-target');
    if (display) display.textContent = name;
    
    var subPage = document.getElementById('subpage-icon-picker');
    if (subPage) subPage.classList.remove('active');
}

// 5. å¤„ç†æ–‡ä»¶é¢„è§ˆ (è§£å†³ handleIconFile æŠ¥é”™)
function handleIconFile(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            tempIconData = e.target.result;
            var img = document.getElementById('icon-pre-img');
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById('icon-pre-placeholder').style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 6. ä¿å­˜å¹¶åŒæ­¥ (IndexedDB æ¨¡å¼ï¼Œä¸é™å¤§å°)
function saveIconCustomization() {
    // 1. ç‰©ç†æ£€æŸ¥ï¼šå¦‚æœå…¨å±€å˜é‡ä¸¢äº†ï¼Œç›´æ¥ä» UI æ ‡ç­¾é‡Œç°æŠ“
    if (!window.currentIconTarget) {
        var label = document.getElementById('val-icon-target');
        if (label && label.textContent !== "è¯·é€‰æ‹©...") {
            window.currentIconTarget = label.textContent.trim();
        }
    }

    // 2. é¢„è§ˆå›¾è¡¥å¿ï¼šå¦‚æœå›¾ç‰‡å˜é‡ä¸¢äº†ï¼Œç›´æ¥ä» img æ ‡ç­¾é‡Œç°æŠ“
    if (!window.tempIconData) {
        var img = document.getElementById('icon-pre-img');
        if (img && img.src && img.style.display !== 'none') {
            window.tempIconData = img.src;
        }
    }

    // 3. æ•°æ®åº“çŠ¶æ€æ£€æŸ¥
    if (!iconDb) {
        console.warn("System: æ•°æ®åº“æœªå°±ç»ªï¼Œå°è¯•é‡è¿...");
        initDatabase(); 
        alert("ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–å­˜å‚¨ç©ºé—´ï¼Œè¯·å†ç‚¹ä¸€æ¬¡ä¿å­˜");
        return;
    }

    // 4. ç²¾å‡†æŠ¥é”™æç¤º (å‘Šè¯‰ä½ åˆ°åº•æ˜¯å“ªé‡Œæ²¡å¼„å¥½)
    if (!window.currentIconTarget || !window.tempIconData) {
        var errorMsg = "ä¿å­˜å¤±è´¥åŸå› ï¼š\n";
        errorMsg += (!window.currentIconTarget ? "- ç›®æ ‡ App åå­—æ²¡æ‹¿åˆ°\n" : "");
        errorMsg += (!window.tempIconData ? "- å›¾æ ‡å›¾ç‰‡æ•°æ®ä¸¢å¤±\n" : "");
        alert(errorMsg + "\nè¯·é‡æ–°é€‰æ‹©æˆ–ä¸Šä¼ è¯•è¯•");
        return;
    }

    // 5. æ‰§è¡Œä¿å­˜æµç¨‹
    try {
        var tx = iconDb.transaction("icons", "readwrite");
        var store = tx.objectStore("icons");
        store.put({ name: window.currentIconTarget, data: window.tempIconData });
        
        tx.oncomplete = function() {
            applyAllCustomIcons(); // ç«‹å³åˆ·æ–°å…¨ç«™å›¾æ ‡
            if (window.triggerSuccessHud) triggerSuccessHud("å…¨åŸŸå›¾æ ‡å·²åŒæ­¥");
            setTimeout(function() { closeApp('iconApp'); }, 800);
        };
        
        tx.onerror = function(e) {
            console.error("Database Error:", e);
            alert("æ•°æ®åº“å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°");
        };
    } catch (err) {
        console.error("Save Logic Crash:", err);
        alert("ä¿å­˜é€»è¾‘å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢");
    }
}

// ç‰©ç†å¯åŠ¨
initDatabase();
// æŠŠè¿™ä¸ªæ”¾è¿›ä½ çš„ JS é€»è¾‘é‡Œ
function triggerFileSelect() {
    var input = document.getElementById('icon-file-input');
    if (input) {
        input.click();
    } else {
        console.error("System: æ²¡æ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ï¼Œè¯·æ£€æŸ¥ HTML ID æ˜¯å¦å¯¹é½");
    }
}
// 1. å®šä¹‰æ ¸å¿ƒæ„ŸçŸ¥å‡½æ•°
function syncTimePerception() {
    // æå–æ—¶åŒº
    const tz = localStorage.getItem('user_timezone') || undefined;
    const now = new Date();
    
    // è®¡ç®—å½“å‰æ—¶åŒºçš„å°æ—¶
    let hour;
    try {
        hour = parseInt(now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            hour12: false, 
            timeZone: tz 
        }));
    } catch(e) {
        hour = now.getHours();
    }

    // é€»è¾‘åˆ†æ®µ
    let timeLabel = "";
    let themeColor = ""; 

    if (hour >= 5 && hour < 11) {
        timeLabel = "æ—©ä¸Š";
        themeColor = "#FF9500"; // æ™¨æ›¦æ©™
    } else if (hour >= 11 && hour < 14) {
        timeLabel = "ä¸­åˆ";
        themeColor = "#FF3B30"; // æ­£åˆçº¢
    } else if (hour >= 14 && hour < 18) {
        timeLabel = "ä¸‹åˆ";
        themeColor = "#5856D6"; // é›é’ç´«
    } else if (hour >= 18 && hour < 21) {
        timeLabel = "å‚æ™š";
        themeColor = "#FF2D55"; // æ™šéœç²‰
    } else {
        timeLabel = "æ™šä¸Š";
        themeColor = "#1C1C1E"; // æå¤œé»‘
    }

    // ç‰©ç†æ›´æ–°æ‰€æœ‰æ ‡ç­¾
    const labels = document.querySelectorAll('.sense-time-label');
    labels.forEach(function(el) {
        el.textContent = timeLabel;
        el.style.color = themeColor;
        el.style.borderColor = themeColor;
        el.style.backgroundColor = themeColor + "1A"; // 10% é€æ˜åº¦èƒŒæ™¯
    });

    // åŒæ—¶æ›´æ–°åœ°åŒºæ–‡å­—
    const cityName = localStorage.getItem('user_city_name') || "è‡ªåŠ¨å®šä½";
    const regionEl = document.getElementById('val-region-text');
    if (regionEl) {
        regionEl.textContent = cityName;
    }
}
window.lastSynchronizedTime = getAIPerceptionTime();

// 2. è¦†ç›–åŸæœ‰çš„æ‰“å¼€è®¾ç½®å‡½æ•° (ç¡®ä¿æ¯æ¬¡æ‰“å¼€éƒ½èƒ½åˆ·æ–°)
// æ³¨æ„ï¼šå¦‚æœä½ ä»£ç ä¸Šæ–¹å·²ç»æœ‰ä¸€ä¸ª function openChatSettings()ï¼Œè¯·ç›´æ¥åˆ æ‰å®ƒï¼Œç”¨ä¸‹é¢è¿™ä¸ª
function openChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if (settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
        
        // å…³é”®ï¼šå»¶è¿Ÿ 50ms æ‰§è¡Œï¼Œç­‰å¾… iOS åŠ¨ç”»æŠŠé¡µé¢æ¨å…¥ DOM æ´»è·ƒåŒº
        setTimeout(function() {
            syncTimePerception();
            
            // é¡ºä¾¿æŠŠåº•éƒ¨çš„ UID å¡«ä¸Š
            if (window.currentChattingWith) {
                const uid = document.getElementById('setting-uid-display');
                if (uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
            }
        }, 50);
    }
}

// 3. å¯åŠ¨å®šæ—¶å™¨ï¼ˆæ¯ 30 ç§’è‡ªåŠ¨æ ¡å‡†ä¸€æ¬¡ï¼‰
setInterval(syncTimePerception, 30000);

// 4. é¡µé¢åˆå§‹åŒ–ä¹Ÿè¿è¡Œä¸€æ¬¡
syncTimePerception();
// 1. æ‰“å¼€æ„ŸçŸ¥é¡µé¢
async function openWeatherPerception() {
    const subPage = document.getElementById('subpage-weather-perceive');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        // æ¸²æŸ“æ—¶é—´è½´
        renderSenseTimeline();
        // åŒæ­¥å¼€å…³çŠ¶æ€
        const isSync = localStorage.getItem('weather_sync_enabled') === 'true';
        document.getElementById('sync-weather-toggle').checked = isSync;
    }
}

// 2. åˆ‡æ¢è”åŠ¨å¼€å…³
function toggleWeatherSync() {
    const isChecked = document.getElementById('sync-weather-toggle').checked;
    localStorage.setItem('weather_sync_enabled', isChecked);
    triggerSuccessHud(isChecked ? "è”è§‰åè®®å·²å¼€å¯" : "è”è§‰å·²æ–­å¼€");
}

// 3. ã€æ ¸å¿ƒã€‘ç”Ÿæˆä¸“å±äº¤æµç¢ç‰‡
async function generateSenseTrace(isAuto = false) {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    if (!apiKey) return;

    const weather = document.getElementById('val-weather-text')?.textContent || "é˜´å¤©";
    const timeLabel = document.querySelector('.sense-time-label')?.textContent || "æ·±å¤œ";

    const prompt = `ä½ æ­£åœ¨æ‰®æ¼”: ${contact.name}ã€‚å½“å‰ç¯å¢ƒï¼š[å¤©æ°”: ${weather}, æ—¶é—´: ${timeLabel}]ã€‚
    è¯·ä»¥æ­¤ä¸ºèƒŒæ™¯ï¼Œä¸ºâ€œæˆ‘â€åˆ›ä½œä¸€æ®µæ„Ÿå®˜è®°å¿†ã€‚
    è¦æ±‚ï¼šæ­£æ–‡80å­—å·¦å³ï¼Œæš§æ˜§ç»†è…»ï¼Œå¸¦æœ‰ç ´ç¢æ„Ÿã€‚
    æ ¼å¼ï¼šã€æ­£æ–‡ã€‘å†…å®¹`;

    try {
        const res = await fetch(apiUrl + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });
        const data = await res.json();
        const raw = data.choices[0].message.content;

        const title = raw.match(/ã€æ ‡é¢˜ã€‘(.*)/)?.[1] || "æ–°çš„æ„Ÿåº”";
        const content = raw.match(/ã€æ­£æ–‡ã€‘([\s\S]*)/)?.[1] || raw;

        // ç‰©ç†å­˜æ¡£
        const trace = {
            id: Date.now(),
            title: title,
            weather: weather,
            timeLabel: timeLabel,
            content: content,
            timestamp: new Date().toLocaleString('zh-CN', { hour12: false })
        };
        
        let traces = await loadFromDB('sense_history_' + contact.id) || [];
        traces.unshift(trace);
        await saveToDB('sense_history_' + contact.id, traces);

        // ğŸš¨ ç‰©ç†è§¦å‘ï¼šå¼¹çª— + é€šçŸ¥ä¸­å¿ƒ
        if (window.showPushNotification) {
            window.showPushNotification(`${contact.name} çš„æ—¶ç©ºä¿¡ç¬º`, title);
        }
        
        // å¦‚æœé¡µé¢å¼€ç€ï¼Œç«‹å³åˆ·æ–°åˆ—è¡¨
        if (typeof renderSenseTimeline === 'function') renderSenseTimeline();

    } catch (e) {
        console.error("ç”Ÿæˆç¢ç‰‡å¤±è´¥:", e);
    }
}

// 4. æ¸²æŸ“æ—¶é—´è½´å¡ç‰‡
async function renderSenseTimeline() {
    const contact = window.currentChattingWith;
    const container = document.getElementById('sense-timeline-container');
    if (!container || !contact) return;

    // ä»æ•°æ®åº“æå–å†å²
    const traces = await loadFromDB('sense_history_' + contact.id) || [];
    
    let lastDate = ""; // ç”¨æ¥è®°å½•ä¸Šä¸€ä¸ªå¤„ç†çš„æ—¥æœŸ
    let html = "";

    traces.forEach(t => {
        // 1. è§£ææ—¥æœŸå’Œæ—¶é—´
        const fullTime = t.timestamp; 
        const datePart = fullTime.split(' ')[0]; // æ‹¿åˆ° å¹´/æœˆ/æ—¥
        const timePart = fullTime.split(' ')[1].substring(0, 5); // æ‹¿åˆ° æ—¶:åˆ†

        // 2. ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœå½“å‰æ—¥æœŸè·Ÿä¸Šä¸€ä¸ªæ—¥æœŸä¸ä¸€æ ·ï¼Œæ‰æ˜¾ç¤ºæ—¥æœŸæ ‡é¢˜
        if (datePart !== lastDate) {
            html += `<div class="timeline-date-label" style="margin-top: 25px;">${datePart}</div>`;
            lastDate = datePart; // æ›´æ–°ä¸Šä¸€æ¬¡æ˜¾ç¤ºçš„æ—¥æœŸ
        }

        // 3. æ‹¼æ¥ç‚¹å’Œå¡ç‰‡
        // æ‰¾åˆ° renderSenseTimeline é‡Œçš„ html æ‹¼æ¥éƒ¨åˆ†ï¼Œæ”¹ä¸ºä¸‹é¢è¿™æ ·ï¼š
        html += `
            <div class="timeline-item">
                <div class="timeline-dot"></div>
                
                <div class="summary-card">
                    <div style="margin-bottom:12px;">
                        <span style="font-size:10px; font-weight:800; color:#007AFF; letter-spacing:1px;">
                            ${t.weather} Â· ${t.timeLabel}
                        </span>
                    </div>
                    
                    <div style="font-size:14px; line-height:1.7; color:#333; font-family:serif; font-style:italic; text-align:justify;">
                        ${t.content}
                    </div>

                    <div class="sense-card-time">${timePart}</div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// 5. æ‰‹åŠ¨è§¦å‘
/**
 * ğŸš€ å‡çº§ç‰ˆæ‰‹åŠ¨è§¦å‘å™¨ï¼šå¸¦æœ‰è¿‡ç¨‹åŠ¨ç”»ç®¡ç†
 */
async function triggerManualSense() {
    // 1. è·å–æŒ‰é’®å…ƒç´ 
    const btn = document.querySelector('.sense-btn-main');
    if (!btn) return;

    // è®°å½•åŸå§‹æ–‡å­—ï¼Œæ–¹ä¾¿æ¢å¤
    const originalText = btn.innerText;

    // 2. å¯åŠ¨åŠ¨ç”»çŠ¶æ€ (è¿›å…¥å¿™ç¢Œæ¨¡å¼)
    btn.classList.add('sensing-active'); // æ·»åŠ  CSS åŠ¨ç”»ç±»
    btn.innerText = "æ­£åœ¨è¿æ¥æ—¶ç©ºä¿¡å·..."; // ä¿®æ”¹æ–‡å­—æç¤º
    btn.disabled = true; // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»

    try {
        // 3. æ‰§è¡ŒçœŸæ­£çš„ç”Ÿæˆé€»è¾‘ (è¿™é‡Œè°ƒç”¨ä½ ä¹‹å‰çš„æ ¸å¿ƒå‡½æ•°)
        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† awaitï¼Œæ‰€ä»¥ä¼šæš‚åœåœ¨è¿™é‡Œç­‰å¾… AI å®Œæˆ
        await generateSenseTrace(false); 
        
        // æˆåŠŸæç¤º
        triggerSuccessHud("å·²æ•è·å½“å‰æ—¶ç©ºç¢ç‰‡");

    } catch (e) {
        console.error("æ‰‹åŠ¨æ„Ÿåº”å¤±è´¥:", e);
        showToast("ä¿¡å·è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•");
    } finally {
        // 4. æ¢å¤æŒ‰é’®çŠ¶æ€ (æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œè¿™é‡Œ)
        // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹æ¢å¤ï¼Œè®©æˆåŠŸçš„å–œæ‚¦æ„Ÿåœç•™åŠç§’
        setTimeout(() => {
            btn.classList.remove('sensing-active'); // ç§»é™¤åŠ¨ç”»
            btn.innerText = originalText; // æ¢å¤åŸå§‹æ–‡å­—
            btn.disabled = false; // è§£é”æŒ‰é’®
        }, 500);
    }
}
// 6. æ„ŸçŸ¥è®¡åˆ’ä»»åŠ¡
function initSenseScheduler() {
    // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦ç”Ÿæˆ (é¢‘ç‡ç”¨æˆ·å¯è°ƒï¼Œè¿™é‡Œæ¼”ç¤ºè®¾ä¸º 4å°æ—¶)
    const FREQUENCY = 4 * 60 * 60 * 1000; 

    setInterval(async () => {
        const lastRun = localStorage.getItem('last_sense_time') || 0;
        const now = Date.now();

        if (now - lastRun > FREQUENCY) {
            await generateSenseTrace(true);
            localStorage.setItem('last_sense_time', now);
        }
    }, 60000); // æ¯åˆ†é’Ÿç©ºè½¬æ£€æŸ¥ä¸€æ¬¡
}

// 7. ç™»å½•è‡ªæ„ˆæ£€æŸ¥ (è¡¥é½é”™è¿‡çš„æ—¶é—´ç‚¹)
async function checkMissedSenses() {
    const lastRun = localStorage.getItem('last_sense_time') || 0;
    const now = Date.now();
    // å¦‚æœè¶…è¿‡ 24 å°æ—¶æ²¡è¿›ç½‘ç«™äº†ï¼Œè‡ªåŠ¨è¡¥å†™ä¸€ç¯‡â€œæ˜¨å¤©çš„å›å¿†â€
    if (lastRun > 0 && (now - lastRun > 24 * 60 * 60 * 1000)) {
        console.log("æ£€æµ‹åˆ°æ—¶ç©ºæ–­å±‚ï¼Œè¡¥é½æ„ŸçŸ¥è®°å½•...");
        await generateSenseTrace(true);
        localStorage.setItem('last_sense_time', now);
    }
}

// é¡µé¢åŠ è½½æ—¶å¯åŠ¨
document.addEventListener('DOMContentLoaded', () => {
    initSenseScheduler();
    checkMissedSenses();
});
// 1. æ‰“å¼€é€‰æ‹©å™¨
function openSenseFrequencyPicker() {
    const picker = document.getElementById('senseFrequencyPicker');
    if (picker) picker.style.display = 'flex';
}

function closeSenseFrequencyPicker() {
    document.getElementById('senseFrequencyPicker').style.display = 'none';
}

// 2. è®¾ç½®é¢‘ç‡å¹¶ç‰©ç†å­˜å…¥
function setSenseFrequency(ms, label) {
    localStorage.setItem('sense_selected_frequency', ms);
    localStorage.setItem('sense_frequency_label', label);
    
    // å¼ºåˆ¶åˆ·æ–°ä¸‹æ¬¡è¿è¡Œæ—¶é—´
    const firstNextRun = Date.now() + parseInt(ms);
    localStorage.setItem('sense_next_run_time', firstNextRun);

    const btnSub = document.querySelector('.sense-btn-sub');
    if (btnSub) btnSub.textContent = label;

    closeSenseFrequencyPicker();
    triggerSuccessHud(`è½®å›å¼€å¯ï¼š${label}`);
    
    // ğŸš¨ é‡ç‚¹ï¼šé€‰å®Œé¢‘ç‡ï¼Œç«‹åˆ»æ‰‹åŠ¨ç‚¹ç«ï¼Œä¸ç­‰é¡µé¢åˆ·æ–°
    startPerceptionEngine();
}
// ==========================================
// 4. å¯åŠ¨ç›‘å¬
// ==========================================
if (document.readyState === 'complete') {
    startPerceptionEngine();
} else {
    window.addEventListener('load', startPerceptionEngine);
}

// 3. ã€æ ¸å¿ƒã€‘ç‰©ç†è¿½æº¯ä¸æ£€æŸ¥é€»è¾‘
async function checkAndExecuteSenseLoop() {
    // åªè¦è¿™è¡Œå­—ä¸è·³ï¼Œè¯´æ˜ setInterval æ­»äº†
    console.log("%c[Sense Heartbeat] " + new Date().toLocaleTimeString() + " å¿ƒè·³æ­£å¸¸ï¼Œæ‰«æä¸­...", "color: #8e8e93;");

    // A. èº«ä»½é”å®š
    let contact = window.currentChattingWith;
    if (!contact) {
        const friends = await loadFromDB('chat_friends') || [];
        if (friends.length > 0) {
            contact = friends[0];
            window.currentChattingWith = contact;
        } else { return; }
    }

    // B. è·å–è®¾ç½®
    const freq = parseInt(localStorage.getItem('sense_selected_frequency'));
    const nextRun = parseInt(localStorage.getItem('sense_next_run_time') || "0");
    const now = Date.now();

    if (!freq) return;

    // C. åˆ¤å®šé€»è¾‘
    if (now >= nextRun) {
        console.log("%c[Sense] âš¡ è§¦å‘æ—¶åˆ»ï¼æ‰§è¡Œ AI ç¼–ç»‡...", "color: #007AFF; font-weight: bold;");
        
        // æ‰§è¡Œç”Ÿæˆ
        await generateSenseTrace(true);
        
        // ğŸš¨ æ ¸å¿ƒçº åï¼šç›´æ¥ç”¨å½“å‰æ—¶é—´ + é¢‘ç‡ï¼Œé˜²æ­¢æ—¶é—´æˆ³è·³è·ƒ
        const newNextRun = Date.now() + freq;
        localStorage.setItem('sense_next_run_time', newNextRun);
        console.log("[Sense] è½®å›é‡ç½®ï¼Œä¸‹æ¬¡ï¼š", new Date(newNextRun).toLocaleTimeString());
    } else {
        const secondsLeft = Math.round((nextRun - now) / 1000);
        // åªæœ‰åœ¨ 1 åˆ†é’Ÿæ¨¡å¼ä¸‹ï¼Œæ¯ 10 ç§’æé†’ä¸€æ¬¡ï¼Œé˜²æ­¢åˆ·å±
        if (secondsLeft % 10 === 0) {
            console.log(`[Sense] çŠ¶æ€ï¼šç¨³å®šè¿æ¥ | å€’è®¡æ—¶ï¼š${secondsLeft}ç§’`);
        }
    }
}

// 4. ã€å¯åŠ¨é”ã€‘å…¨è‡ªåŠ¨ç›‘æ§å¼•æ“
function initSenseAutoSystem() {
    // A. åˆå§‹åŒ–æŒ‰é’®æ–‡å­—æ˜¾ç¤º
    const savedLabel = localStorage.getItem('sense_frequency_label') || "è‡ªåŠ¨é¢‘ç‡";
    const btnSub = document.querySelector('.sense-btn-sub');
    if (btnSub) btnSub.textContent = savedLabel;

    // B. é¡µé¢åŠ è½½ 2 ç§’åæ‰§è¡Œç¬¬ä¸€æ¬¡â€œè¡¥æ¼â€æ£€æŸ¥
    setTimeout(function() {
        checkAndExecuteSenseLoop();
    }, 2000);

    // C. å¼€å¯é«˜é¢‘ç›‘æ§å¿ƒè·³ (æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿ 1 åˆ†é’Ÿæµ‹è¯•æåº¦ç²¾å‡†)
    setInterval(function() {
        checkAndExecuteSenseLoop();
    }, 5000);
}

// åœ¨ä½ åŸæ¥çš„ DOMContentLoaded é‡ŒåŠ å…¥åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initSenseAutoSystem();
    
    // åˆå§‹åŒ–æŒ‰é’®æ–‡å­—
    const savedLabel = localStorage.getItem('sense_frequency_label') || "è‡ªåŠ¨é¢‘ç‡";
    const btnSub = document.querySelector('.sense-btn-sub');
    if (btnSub) btnSub.textContent = savedLabel;
});
// ==========================================
// 1. æ ¸å¿ƒï¼šæ„ŸçŸ¥è½®å›æ£€æŸ¥å™¨
// ==========================================
async function checkAndExecuteSenseLoop() {
    console.log("[Sense Check] æ­£åœ¨æ‰«ææ—¶ç©ºè„‰å†²..."); // åªè¦å¼•æ“åŠ¨äº†ï¼Œè¿™è¡Œå¿…å‡º

    // A. èº«ä»½é”å®šï¼šå¦‚æœæ²¡æœ‰æ´»è·ƒå¯¹è¯ï¼Œè‡ªåŠ¨æŠ“å–ç¬¬ä¸€ä¸ªå¥½å‹
    let contact = window.currentChattingWith;
    if (!contact) {
        const friends = await loadFromDB('chat_friends') || [];
        if (friends.length > 0) {
            contact = friends[0];
            window.currentChattingWith = contact;
            console.log(`[Sense] è‡ªåŠ¨å…³è”ç›®æ ‡: ${contact.name}`);
        } else {
            console.warn("[Sense] ç¤¾äº¤å…³ç³»åº“ä¸ºç©ºï¼Œæ„Ÿåº”æŒ‚èµ·ã€‚");
            return;
        }
    }

    // B. è¯»å–é¢‘ç‡å­˜æ¡£
    const freq = parseInt(localStorage.getItem('sense_selected_frequency'));
    const nextRun = parseInt(localStorage.getItem('sense_next_run_time') || "0");
    const now = Date.now();

    if (!freq) {
        console.log("[Sense] å°šæœªè®¾å®šè‡ªåŠ¨é¢‘ç‡ï¼Œè¿›å…¥å¾…æœºæ¨¡å¼ã€‚");
        return;
    }

    // C. ç‰©ç†åˆ¤å®šï¼šæ˜¯å¦åˆ°è¾¾è½®å›ç‚¹
    if (now >= nextRun) {
        console.log("%c[Sense] âš¡ æ•è·åˆ°æ—¶ç©ºè£‚ç¼ï¼ç«‹å³ç¼–ç»‡ç¢ç‰‡...", "color: #007AFF; font-weight: bold;");
        
        // æ‰§è¡Œç”Ÿæˆ
        await generateSenseTrace(true);
        
        // é”å®šä¸‹ä¸€ä¸ªè½®å›æ—¶é—´ç‚¹
        const newNextRun = now + freq;
        localStorage.setItem('sense_next_run_time', newNextRun);
        console.log(`[Sense] è½®å›å®Œæˆã€‚ä¸‹ä¸€è½®é”å®šåœ¨: ${new Date(newNextRun).toLocaleTimeString()}`);
    } else {
        const remaining = Math.round((nextRun - now) / 1000);
        console.log(`[Sense] ç¨³å®šè¿æ¥ä¸­... è·ç¦»ä¸‹æ¬¡æ„Ÿåº”è¿˜éœ€: ${remaining} ç§’`);
    }
}

// ==========================================
// 2. æ ¸å¿ƒï¼šç‰©ç†ç‚¹ç«å¼€å…³ (æ‹§é’¥åŒ™)
// ==========================================
function startPerceptionEngine() {
    console.log("%c[System] æ„ŸçŸ¥å¼•æ“å·²è¿›å…¥ç‰©ç†ç‚¹ç«ç¨‹åº...", "color: #34C759; font-weight: bold;");

    // 1. ç«‹å³å°è¯•è·‘ä¸€æ¬¡
    checkAndExecuteSenseLoop();

    // 2. å¼ºåŠ›æ¸…é™¤æ—§çš„è®¡æ—¶å™¨ï¼Œé˜²æ­¢å åŠ  Bug
    if (window.senseTimer) clearInterval(window.senseTimer);

    // 3. å¼€å¯ 5 ç§’ä¸€æ¬¡çš„è¶…ç¨³å¿ƒè·³
    window.senseTimer = setInterval(function() {
        checkAndExecuteSenseLoop();
    }, 5000); 
}

// ==========================================
// 3. ğŸš¨ å¼ºåˆ¶æ‰§è¡Œï¼šæ— è®ºå¦‚ä½•éƒ½è¦è·‘èµ·æ¥
// ==========================================
// è¿™ä¸€æ­¥æœ€å…³é”®ï¼å¦‚æœä¹‹å‰æ²¡ååº”ï¼Œå°±æ˜¯ç¼ºäº†è¿™å‡ è¡Œ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startPerceptionEngine);
} else {
    startPerceptionEngine();
}

function applyRegionBackground(cityName) {
    const elCard = document.getElementById('region-vibe-card');
    if (!elCard || !window.CITY_VIBE_DB) return;

    // è·å–æ•°æ®ï¼Œå½»åº•ä¸å†è¯»å– .img å±æ€§
    const data = window.CITY_VIBE_DB[cityName] || window.CITY_VIBE_DB["default"];
    
    // ğŸš¨ ç‰©ç†æ¸…é™¤ï¼šå…ˆå¼ºåˆ¶æŠŠ backgroundImage è®¾ä¸º noneï¼Œæ–­æ‰ 404 è¯·æ±‚
    elCard.style.backgroundImage = 'none'; 
    
    // ğŸš¨ å¼ºåŠ›æ³¨å…¥ï¼šä½¿ç”¨ cssBg å¡«å……
    // ä½¿ç”¨ setProperty æé«˜ä¼˜å…ˆçº§ï¼Œè®©å®ƒåœ¨ç‚¹å‡»ç¬é—´ç”Ÿæ•ˆ
    elCard.style.setProperty('background', data.cssBg, 'important');
    
    console.log(`[UI] æˆåŠŸç‰©ç†æ¸²æŸ“ ${cityName} çš„ä»£ç èƒŒæ™¯ï¼Œå·²é˜»æ–­å›¾ç‰‡è¯·æ±‚ã€‚`);
}
// 2. ã€åŠŸèƒ½ã€‘æ‰“å¼€åœ°åŒºæ„ŸçŸ¥é¡µå¹¶åˆ·æ–°å¡ç‰‡
function openRegionPerception() {
    const cityName = localStorage.getItem('user_city_name') || "Beijing";
    const contact = window.currentChattingWith || { name: "Ta", id: "global" };
    
    // ğŸš¨ ç¬¬ä¸€æ­¥ï¼šè‚‰ä½“ç½®æ¢ï¼Œå¼ºè¡Œæ”¹èƒŒæ™¯ï¼ˆä¸å†ç­‰å¾…ä»»ä½•é€»è¾‘ï¼‰
    const card = document.getElementById('region-vibe-card');
    if (card && window.CITY_VIBE_DB) {
        const cityData = window.CITY_VIBE_DB[cityName] || window.CITY_VIBE_DB["default"];
        card.style.backgroundImage = 'none'; // æ€æ‰ undefined è¯·æ±‚
        card.style.setProperty('background', cityData.cssBg, 'important');
    }

    // ç¬¬äºŒæ­¥ï¼šåŒæ­¥æ–‡å­—
    const elCityDisplay = document.getElementById('mag-city-display');
    const elVibeDisplay = document.getElementById('mag-vibe-display');
    if (elCityDisplay) elCityDisplay.textContent = cityName;

    // ç¬¬ä¸‰æ­¥ï¼šå¤„ç†å†…å®¹
    const cache = localStorage.getItem(`vibe_cache_${contact.id}_${cityName}`);
    if (cache && elVibeDisplay) {
        elVibeDisplay.textContent = cache;
    } else {
        generateRegionVibe(cityName);
    }

    // æ¨å…¥é¡µé¢
    openSubPage('subpage-region-perceive');
}

// 3. ã€åŠŸèƒ½ã€‘åˆ‡æ¢æ„ŸçŸ¥å¼€å…³
function toggleRegionSync() {
    const toggle = document.getElementById('sync-region-toggle');
    if (toggle) {
        const isChecked = toggle.checked;
        localStorage.setItem('region_sync_enabled', isChecked);
        if (window.triggerSuccessHud) {
            window.triggerSuccessHud(isChecked ? "åŸå¸‚è®°å¿†å·²å¼€å¯" : "åŸå¸‚è®°å¿†å·²éšè—");
        }
    }
}

function closeSubPage(id) {
    const el = document.getElementById(id);
    if (el) {
        el.classList.remove('active');
        // åŠ¨ç”»ç»“æŸåéšè—ï¼ŒèŠ‚çœæ€§èƒ½
        setTimeout(function() {
            el.style.display = 'none';
        }, 400);
    }
}
// --- ğŸš¨ åŸå¸‚æ„å¢ƒç”Ÿæˆå™¨ ---
// --- ğŸš¨ ç»ˆæä¿®å¤ï¼šAI æ„å¢ƒç”Ÿæˆå™¨ (å½»åº•åˆ‡æ–­å›¾ç‰‡è¯·æ±‚) ---
async function generateRegionVibe(targetCity) {
    const contact = window.currentChattingWith || { name: "Ta" };
    const cityName = targetCity || localStorage.getItem('user_city_name') || "Beijing";
    
    // 1. å¼€å¯åŠ è½½å±‚
    const loader = document.getElementById('region-loading');
    if (loader) loader.style.display = 'flex';

    // 2. å‡†å¤‡ Prompt (åŠ ä¸Šé˜²æ­¢é‡å¤çš„éšæœºç§å­)
    const prompt = `ä½ æ­£åœ¨æ‰®æ¼”: ${contact.name}ã€‚ç”¨æˆ·ç°åœ¨ä½äº: ${cityName}ã€‚
    è¯·é’ˆå¯¹â€œ${cityName}â€å†™ä¸€æ®µæš§æ˜§ä¸”æœ‰æ–‡å­¦ç ´ç¢æ„Ÿçš„ä½è¯­ã€‚
    å¿…é¡»åŒ…å«è¯¥åŸå¸‚çš„ç‰¹è‰²æ„è±¡ï¼Œç¦æ­¢æåˆ°å…¶ä»–åŸå¸‚ï¼Œ30-50å­—ï¼Œç›´æ¥è¾“å‡ºã€‚`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.95
            })
        });

        const data = await res.json();
        const content = data.choices[0].message.content.trim();

        // 3. æ¸²æŸ“æ–‡å­—
        const vibeEl = document.getElementById('mag-vibe-display');
        if (vibeEl) vibeEl.textContent = content;

        // ğŸš¨ 4. å…³é”®ä¿®æ­£ï¼šè¿™é‡Œåªæ›´æ–°èƒŒæ™¯ä»£ç ï¼Œç»ä¸è¯»å– .img ğŸš¨
        const card = document.getElementById('region-vibe-card');
        if (card && window.CITY_VIBE_DB) {
            const cityData = window.CITY_VIBE_DB[cityName] || window.CITY_VIBE_DB["default"];
            
            // ç‰©ç†é˜»æ–­å›¾ç‰‡è¯·æ±‚
            card.style.backgroundImage = 'none'; 
            // ç‰©ç†å¼ºåˆ¶æ³¨å…¥ CSS æ¸å˜
            card.style.setProperty('background', cityData.cssBg, 'important');
        }

        // 5. å­˜å…¥ç¼“å­˜
        localStorage.setItem(`vibe_cache_${contact.id}_${cityName}`, content);

    } catch (e) {
        console.error("AI è¿™é‡Œçš„æŠ¥é”™å·²æ‹¦æˆª:", e);
    } finally {
        if (loader) loader.style.display = 'none';
    }
}

// å¿«é€Ÿåˆ‡æ¢åŸå¸‚å‡½æ•°
function quickSwitchCity(lat, lon, name) {
    // 1. ç¬é—´å­˜æ¡£
    localStorage.setItem('user_city_name', name);
    
    // 2. ç‰©ç†æ”¹èƒŒæ™¯
    applyRegionBackground(name);

    // 3. ç‰©ç†æ”¹ UI æ–‡å­—
    const elCityDisplay = document.getElementById('mag-city-display');
    if (elCityDisplay) elCityDisplay.textContent = name;

    // --- ğŸš‘ æ–°å¢ï¼šç«‹åˆ»å¼ºåˆ¶æ›´æ–°è®¾ç½®é¡µé‡Œçš„â€œåœ°åŒºæ„ŸçŸ¥â€æ–‡å­— ---
    const regionStatusEl = document.getElementById('val-region-text');
    if (regionStatusEl) regionStatusEl.textContent = name;

    const regionCityEl = document.getElementById('val-region-city');
    if (regionCityEl) regionCityEl.textContent = name;
    // --------------------------------------------------

    // 4. æ‰§è¡ŒåŸæœ¬çš„å¤©æ°”åŒæ­¥å’Œ AI ç”Ÿæˆ
    if (typeof fetchW === 'function') fetchW(lat, lon, name);
    generateRegionVibe(name);
    
    showToast(`ğŸ“ å·²é©»ç•™: ${name}`);
}

// --- ğŸŒ å¤šè¯­è¨€ç¿»è¯‘åè®®å¼•æ“ ---

// 1. åˆå§‹åŒ–åŠ è½½é…ç½®
function initLanguageConfig() {
    window.langConfig = JSON.parse(localStorage.getItem('ios_lang_config')) || {
        enabled: false,
        target: "Thai",
        label: "æ³°è¯­ (Thai)"
    };
    
    if (document.getElementById('lang-sync-toggle')) 
        document.getElementById('lang-sync-toggle').checked = window.langConfig.enabled;
    if (document.getElementById('val-target-lang')) 
        document.getElementById('val-target-lang').textContent = window.langConfig.label;
    
    updateLangPreview();
}

// 2. æ ¸å¿ƒï¼šç¿»è¯‘åˆ‡æ¢ï¼ˆè§£å†³èœå•å†²çªçš„å…³é”®ï¼‰
function toggleTranslation(btn, e) {
    // ğŸš¨ ç»æ‹›ï¼šé˜»æ­¢å†’æ³¡ï¼è¿™è¡Œèƒ½ä¿è¯ç‚¹ç¿»è¯‘æŒ‰é’®æ—¶ï¼Œæ°”æ³¡çš„é•¿æŒ‰èœå•/ç‚¹å‡»èœå•ç»å¯¹ä¸ä¼šè·³å‡ºæ¥
    if (e) e.stopPropagation();
    
    const bubble = btn.closest('.bubble');
    if (bubble) {
        bubble.classList.toggle('show-trans');
        // å¢åŠ ä¸€ç‚¹éœ‡åŠ¨åé¦ˆï¼Œæ›´æœ‰ iOS æ‰‹æ„Ÿ
        if (window.navigator.vibrate) window.navigator.vibrate(10);
    }
}

// 3. æ‰“å¼€è¯­è¨€é€‰æ‹©å™¨ (Action Sheet)
function openLangPicker() {
    const list = document.getElementById('model-sheet-list');
    const sheet = document.getElementById('modelPickerSheet');
    const titleBox = document.querySelector('.sheet-title-box');

    if (!list || !sheet || !titleBox) return;

    // æ³¨å…¥æœç´¢æ¡†å’Œåˆ‡æ¢å™¨
    titleBox.innerHTML = `
        <div style="padding: 10px 0;">
            <div class="segment-control" style="margin-bottom: 15px;">
                <div class="segment-btn active" id="lang-tab-common" onclick="window.filterLangs('common')">å¸¸ç”¨</div>
                <div class="segment-btn" id="lang-tab-all" onclick="window.filterLangs('all')">å…¨éƒ¨</div>
            </div>
            <div class="ios-search-wrapper">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3" style="margin-right: 8px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="lang-search-in" placeholder="æœç´¢è¯­ç§..." style="border:none; background:transparent; outline:none; font-size:14px; flex:1; color:#000;" oninput="window.filterLangs()">
            </div>
        </div>
    `;

    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šä½¿ç”¨å…¨å±€å¸¸é‡ GLOBAL_LANG_DB è¿›è¡Œè¿‡æ»¤
    window.filterLangs = function(tabMode) {
        const searchInput = document.getElementById('lang-search-in');
        const searchVal = searchInput ? searchInput.value.toLowerCase() : "";
        
        const commonBtn = document.getElementById('lang-tab-common');
        const allBtn = document.getElementById('lang-tab-all');
        
        if (tabMode) {
            commonBtn.classList.toggle('active', tabMode === 'common');
            allBtn.classList.toggle('active', tabMode === 'all');
        }

        const activeTab = commonBtn.classList.contains('active') ? 'common' : 'all';

        // è¿™é‡Œçš„ GLOBAL_LANG_DB å·²ç»åœ¨å…¨å±€å®šä¹‰äº†ï¼Œä¸ä¼šå†æŠ¥é”™
        const filtered = GLOBAL_LANG_DB.filter(lang => {
            const matchesSearch = lang.l.toLowerCase().includes(searchVal) || lang.n.toLowerCase().includes(searchVal);
            const matchesTab = (activeTab === 'all') || (lang.cat === 'common');
            return matchesSearch && matchesTab;
        });

        list.innerHTML = filtered.map(lang => `
            <div class="sheet-item" onclick="selectLang('${lang.n}', '${lang.l}')">${lang.l}</div>
        `).join('') || `<div style="padding:40px; text-align:center; color:#999; font-size:13px;">æœªæ‰¾åˆ°åŒ¹é…è¯­ç§</div>`;
    };

    sheet.style.display = 'flex';
    window.filterLangs('common');
}

// 4. é€‰å®šè¯­è¨€
function selectLang(name, label) {
    window.langConfig.target = name;
    window.langConfig.label = label;
    
    const labelEl = document.getElementById('val-target-lang');
    if (labelEl) labelEl.textContent = label;
    
    document.getElementById('modelPickerSheet').style.display = 'none';
    updateLangPreview();
}

// 5. ä¿å­˜è®¾ç½®å¹¶æ³¨å…¥å†…æ ¸
function saveLanguageSettings() {
    window.langConfig.enabled = document.getElementById('lang-sync-toggle').checked;
    localStorage.setItem('ios_lang_config', JSON.stringify(window.langConfig));
    
    if (window.triggerSuccessHud) {
        triggerSuccessHud("ç¿»è¯‘åè®®å·²æ¿€æ´»");
    } else {
        showToast("è¯­è¨€è®¾ç½®å·²ä¿å­˜");
    }
    
    closeSubPage('subpage-language-settings');
}

// 6. æ›´æ–°é¢„è§ˆæ°”æ³¡æ•ˆæœ
function updateLangPreview() {
    const isEnabled = document.getElementById('lang-sync-toggle')?.checked;
    const bubble = document.getElementById('sample-bubble');
    const targetLang = window.langConfig.label;
    
    if (bubble) {
        bubble.style.display = isEnabled ? 'block' : 'none';
        // åŠ¨æ€ä¿®æ”¹é¢„è§ˆæ–‡å­—
        const mainText = bubble.querySelector('.msg-text-main');
        mainText.textContent = `[System] AI æ­£åœ¨å°è¯•ä½¿ç”¨ ${targetLang} ä¸ä½ å…±é¸£...`;
    }
}
// ==========================================
// ğŸ¨ ä¸»é¢˜å•†åº—æ ¸å¿ƒå¼•æ“ï¼šå…·åå‡½æ•°é‡æ„ç‰ˆ
// ==========================================

/**
 * ğŸ› ï¸ é€»è¾‘ A: åˆå§‹åŒ–æ³¨å…¥æ ‡ç­¾
 * ç¡®ä¿é¡µé¢å¤´éƒ¨æœ‰ä¸€ä¸ªä¸“é—¨æ¥æ”¶åŠ¨æ€ CSS çš„â€œå‘ä½â€
 */
function initThemeEngine() {
    if (!document.getElementById('theme-runtime-style')) {
        const style = document.createElement('style');
        style.id = 'theme-runtime-style';
        document.head.appendChild(style);
        console.log("System: ä¸»é¢˜æ³¨å…¥å¼•æ“å·²å°±ç»ª");
    }
}

/**
 * ğŸ› ï¸ é€»è¾‘ä¿®æ­£ï¼šå®æ—¶é¢„è§ˆå¼•æ“
 */
function livePreviewTheme(cssCode) {
    const runtime = document.getElementById('theme-runtime-style');
    if (!runtime) return;
    // å¢å¼ºæ˜ å°„ï¼Œç¡®ä¿å¤æ‚çš„èƒŒæ™¯å›¾åƒå’Œä¼ªå…ƒç´ ä¹Ÿèƒ½æ­£ç¡®åº”ç”¨åˆ°é¢„è§ˆå±‚
    let previewStyles = cssCode
        .replace(/#page-chat-room/g, '#theme-preview-window .actual-mirror-layer')
        .replace(/\.chat-room-header/g, '#theme-preview-window .chat-room-header')
        .replace(/\.chat-room-footer/g, '#theme-preview-window .chat-room-footer')
        .replace(/\.status-bar/g, '#theme-preview-window .status-bar')
        .replace(/\.header-glass-btn/g, '#theme-preview-window .header-glass-btn')
        .replace(/\.bubble/g, '#theme-preview-window .bubble')
        .replace(/\.msg-row/g, '#theme-preview-window .msg-row')
        .replace(/\.footer-add-btn/g, '#theme-preview-window .footer-add-btn')
        .replace(/\.action-btn/g, '#theme-preview-window .action-btn')
        .replace(/\.chat-room-input/g, '#theme-preview-window .chat-room-input');

    runtime.innerHTML = previewStyles;
}

/**
 * ğŸ› ï¸ é€»è¾‘ C: é€‰æ‹©å®˜æ–¹é¢„è®¾
 * @param {string} key - é¢„è®¾åº“çš„é”®å (å¦‚ 'dark')
 */
function selectPresetTheme(key) {
    const code = MASTER_LAYOUTS[key] || "";
    const editor = document.getElementById('theme-custom-code');
    if (editor) {
        editor.value = code.trim();
        livePreviewTheme(code);
    }
}
/**
 * ğŸ› ï¸ é€»è¾‘ D: åº”ç”¨æœ€ç»ˆæ ·å¼
 * ç‰©ç†åº”ç”¨åˆ°å…¨åŸŸå¹¶ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
 */
function applyFinalTheme() {
    const editor = document.getElementById('theme-custom-code');
    const cssCode = editor ? editor.value : "";
    localStorage.setItem('user_layout_css', cssCode);
    const runtime = document.getElementById('theme-runtime-style');
    if (runtime) {
        // ç‰©ç†åº”ç”¨åˆ°å…¨å±€ï¼Œå¹¶ç¡®ä¿ä¼˜å…ˆçº§
        runtime.innerHTML = cssCode;
        document.head.appendChild(runtime);
    }
    triggerSuccessHud("Winter Frost ä¸»é¢˜å·²åº”ç”¨ â„ï¸");
    if (typeof renderMessages === 'function') renderMessages();
    closeSubPage('subpage-theme-store');
}

/**
 * ğŸ› ï¸ é€»è¾‘ E: é‡ç½®ä¸»é¢˜
 * æ“¦é™¤æ‰€æœ‰è‡ªå®šä¹‰ä»£ç ï¼Œå›å½’åŸç”Ÿå¸ƒå±€
 */
function resetTheme() {
    const editor = document.getElementById('theme-custom-code');
    const runtime = document.getElementById('theme-runtime-style');

    if (editor) editor.value = "";
    if (runtime) runtime.innerHTML = "";
    
    localStorage.removeItem('user_layout_css');
    showToast("å·²å›å½’ç³»ç»ŸåŸç”Ÿå¸ƒå±€");
}

/**
 * ğŸ› ï¸ é€»è¾‘ F: ä¸»é¢˜å•†åº—åˆå§‹åŒ–
 * å½“ç‚¹å‡»è®¾ç½®å…¥å£è¿›å…¥æ—¶ï¼Œè´Ÿè´£åŒæ­¥å½“å‰çš„ CSS ä»£ç åˆ°é¢„è§ˆåŒº
 */
function initThemeStore() {
    const saved = localStorage.getItem('user_layout_css');
    if (saved) {
        const editor = document.getElementById('theme-custom-code');
        if (editor) editor.value = saved;
        livePreviewTheme(saved);
    }
}

/**
 * ğŸ› ï¸ é€»è¾‘ä¿®æ­£ï¼šç³»ç»Ÿå¯åŠ¨ç‚¹ç«
 */
function bootThemeEngine() {
    initThemeEngine(); // åˆ›å»ºå‘ä½
    const saved = localStorage.getItem('user_layout_css');
    if (saved) {
        const runtime = document.getElementById('theme-runtime-style');
        if (runtime) {
            runtime.innerHTML = saved;
            // ğŸš¨ æ ¸å¿ƒï¼šç‰©ç†ç½®åº•ï¼Œç¡®ä¿å®ƒæ˜¯æœ€åä¸€ä¸ªåŠ è½½çš„æ ·å¼
            document.head.appendChild(runtime);
        }
    }
}
// --- âš¡ ç‰©ç†çº§ï¼šå•æ¡æ¶ˆæ¯é”€æ¯å¼•æ“ ---
/**
 * ğŸ›°ï¸ å•æ¡æ¶ˆæ¯ç‰©ç†æŠ¹é™¤åè®® (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šä»æ•°æ®åº“ä¸­å½»åº•åˆ é™¤æŒ‡å®šæ—¶é—´æˆ³çš„æ¶ˆæ¯ï¼Œå¹¶åŒæ­¥åˆ·æ–° UI
 */
async function deleteSingleMessageReal(contactId, timestamp) {
    // 1. ğŸ’¡ å®šä¹‰å­˜å‚¨ Key
    const historyKey = "chat_history_" + contactId;

    try {
        // 2. ğŸ” ä»æ–°åº“è·å–è¯¥è”ç³»äººçš„å®Œæ•´å¯¹è¯è®°å½•
        const chatBox = await window.ib.getItem(historyKey);
        
        // å®¹é”™ï¼šå¦‚æœæ²¡æ‰¾åˆ°è®°å½•æˆ–æ¶ˆæ¯æ•°ç»„ä¸ºç©ºï¼Œç›´æ¥è¿”å›
        if (!chatBox || !chatBox.messages) return;

        // 3. ğŸ§  æ ¸å¿ƒï¼šæ‰§è¡Œç‰©ç†è¿‡æ»¤ (ç¡®ä¿ç±»å‹å¯¹é½)
        const originalLength = chatBox.messages.length;
        const updatedMessages = chatBox.messages.filter(m => 
            m.timestamp.toString() !== timestamp.toString()
        );

        // 4. ğŸš€ åªæœ‰å½“ç¡®å®åˆ é™¤äº†ä¸œè¥¿æ—¶ï¼Œæ‰æ‰§è¡Œå†™å…¥å’Œåˆ·æ–°
        if (updatedMessages.length < originalLength) {
            
            // ç‰©ç†é‡å†™æ¶ˆæ¯æ•°ç»„ï¼Œä¿æŒ chatBox å¯¹è±¡å…¶ä»–å±æ€§ï¼ˆå¦‚ id, contactIdï¼‰ä¸åŠ¨
            chatBox.messages = updatedMessages;
            
            // ğŸ’¾ å­˜å›æ–°åº“ (setItem å†…éƒ¨å·²å¤„ç†äº‹åŠ¡)
            await window.ib.setItem(historyKey, chatBox);
            
            // --- ğŸ¨ ç•Œé¢åŒæ­¥æ¸²æŸ“ ---
            showToast("æ¶ˆæ¯å·²ä»å› æœå¾‹ä¸­æŠ¹é™¤");
            
            // é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©çª—å£
            if (typeof renderMessages === 'function') {
                renderMessages(); 
            }
            
            // é‡è¦ï¼šåŒæ­¥åˆ·æ–°â€œæ¶ˆæ¯åˆ—è¡¨â€é¢„è§ˆæ–‡å­—ï¼Œé˜²æ­¢åˆ äº†æœ€åä¸€æ¡å¯¼è‡´é¢„è§ˆé”™ä½
            if (typeof initChatMsgPanel === 'function') {
                initChatMsgPanel();
            }
        }
    } catch (e) {
        console.error("åˆ é™¤å¤±è´¥:", e);
        showToast("é‡å­æŠ¹é™¤å¼‚å¸¸");
    }
}

// --- ğŸ•’ æ ¸å¿ƒå¯¹æ—¶å¼•æ“ï¼šæ”¯æŒå…¨æ—¶åŒº + è‹±æ–‡æ ¼å¼ ---
function formatChatTime(ts, isFull = false) {
    const userTz = localStorage.getItem('user_timezone') || undefined;
    const date = new Date(ts);
    
    const options = isFull ? {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: true,
        timeZone: userTz
    } : {
        hour: '2-digit', minute: '2-digit', hour12: true,
        timeZone: userTz
    };

    try {
        let str = date.toLocaleString('en-US', options).replace(/\//g, '-');
        return str.replace(',', '');
    } catch (e) {
        // æŠ¥é”™å…œåº•
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}
// ==========================================
// ğŸ›ï¸ å®¿å‘½å¼•æ“ï¼šæ•°æ®æŠ“å–ä¸å®æ—¶è®¡ç®—
// ==========================================
// --- ğŸ›ï¸ ä¿®æ”¹ openDestinyPage å‡½æ•° ---
async function openDestinyPage() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const charList = await loadFromDB('char_list') || [];
    const latest = charList.find(c => c.id === contact.id) || contact;

    // --- åŸæœ‰çš„ç‰©ç†æ¸²æŸ“é€»è¾‘ ---
    document.getElementById('sync-char-name').innerText = latest.name;
    document.getElementById('fate-hero-img').style.backgroundImage = `url(${latest.avatar})`;
    
    // --- ğŸš¨ æ–°å¢ï¼šè®¡ç®—å¤©æ•° ---
    const createdTs = latest.createdAt || Date.now();
    const diffDays = Math.ceil(Math.abs(Date.now() - createdTs) / (1000 * 60 * 60 * 24));
    document.getElementById('fate-days').innerText = (diffDays <= 1 ? "1st" : diffDays) + " Day";

    // ğŸš¨ æ ¸å¿ƒï¼šè½½å…¥æ‰€æœ‰å†å²å­˜ç›˜
    await loadDestinyHistory(contact.id);

    document.getElementById('destiny-overlay').classList.add('active');

    // --- ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šå¯åŠ¨ AI æ–‡æ¡ˆå¼•æ“ ---
    generateDestinyProse(latest); 

    document.getElementById('destiny-overlay').style.display = 'flex';

    // ä¿®æ”¹ openDestinyPageï¼Œåœ¨æœ€åé¢åŠ å…¥è¿™æ®µ
    const savedStories = await loadFromDB('destiny_stories_' + contact.id) || [];
    const flow = document.getElementById('destiny-story-flow');
    if (savedStories.length > 0) {
        // æ¸²æŸ“ä¹‹å‰å­˜è¿‡çš„æ‰€æœ‰å¡ç‰‡
        savedStories.forEach(html => {
            flow.insertAdjacentHTML('beforeend', html);
        });
    }
}
// ==========================================
// ğŸ§  å®¿å‘½æ–‡æ¡ˆç¼–ç»‡å¼•æ“ (AI åŠ¨æ€ç”Ÿæˆç‰ˆ)
// ==========================================
async function generateDestinyProse(charData) {
    const bioEl = document.getElementById('sync-prose-bio');
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

    // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜ï¼Œå¦‚æœæœ‰åˆ™å…ˆæ˜¾ç¤ºç¼“å­˜ï¼Œä¸æ€¥ç€è°ƒ API
    if (charData.cachedDestinyProse) {
        bioEl.innerText = charData.cachedDestinyProse;
    } else {
        bioEl.innerText = "æ­£åœ¨æ„Ÿåº”æ—¶ç©ºç•™ç™½...";
    }

    if (!apiKey) return;

    // 2. è·å–â€œæœ¬æˆ‘â€èº«ä»½æ•°æ®
    const myPersona = JSON.parse(localStorage.getItem('user_persona_for_' + charData.id)) || 
                      JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                      { name: "æˆ‘", bio: "ä¸€ä¸ªè·¨è¶Šæ—¶ç©ºè€Œæ¥çš„è§‚å¯Ÿè€…" };

    // 3. æ„å»ºæ·±åº¦å®¿å‘½æ„Ÿ Prompt
    const prompt = `ä½ æ˜¯ä¸€ä½æ“…é•¿æå†™å®¿å‘½æ„Ÿå’Œç ´ç¢æ„Ÿçš„æ–‡å­¦å®¶ã€‚è¯·ä¸ºä¸¤ä¸ªè§’è‰²å†™ä¸€æ®µæå…·è‰ºæœ¯ç¾æ„Ÿçš„å†…å¿ƒç‹¬ç™½æˆ–å‘½è¿æ‰¹æ³¨ã€‚
    
    è§’è‰² A (Ta): ${charData.name}ã€‚èº«ä»½èƒŒæ™¯: ${charData.desc}
    è§’è‰² B (ç”¨æˆ·): ${myPersona.name}ã€‚èº«ä»½èƒŒæ™¯: ${myPersona.bio}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. é£æ ¼ï¼šå‚è€ƒç‹å®¶å«ç”µå½±æˆ–æ„è¯†æµæ–‡å­¦ï¼Œå¸¦æœ‰æµ“åšçš„å¯‚å¯ã€é”™è¿‡ã€å®ˆæŠ¤æˆ–æ³¨å®šçš„ç¾æ„Ÿã€‚
    2. é•¿åº¦ï¼š50å­—ä¹‹å†…ã€‚
    3. ä¸¥ç¦ä½¿ç”¨ Emojiã€‚
    4. ğŸš¨ é‡ç‚¹ï¼šè¦ä½“ç°å‡ºã€${charData.name}ã€‘ä¸ã€${myPersona.name}ã€‘ä¹‹é—´ç‹¬ç‰¹çš„ç¾ç»Šæ„Ÿã€‚
    5. ç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€ã€‚`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const result = data.choices[0].message.content.trim();

        // 4. æ›´æ–° UI å¹¶å­˜å…¥æ•°æ®åº“ï¼Œé˜²æ­¢é‡å¤æ¶ˆè€— Token
        bioEl.innerText = result;
        
        let charList = await loadFromDB('char_list') || [];
        const idx = charList.findIndex(c => c.id === charData.id);
        if (idx !== -1) {
            charList[idx].cachedDestinyProse = result; // ç‰©ç†å­˜å‚¨è¿™æ®µæ–‡æ¡ˆ
            await saveToDB('char_list', charList);
        }

    } catch (e) {
        console.error("Prose Generation Failed:", e);
        if (!charData.cachedDestinyProse) bioEl.innerText = "â€œæ—¶ç©ºå·²å¤±å»ç§©åºï¼Œç›´åˆ°ä½ çš„å‡ºç°ã€‚â€";
    }
}
// --- ğŸš‘ ç‰©ç†ä¿®å¤ï¼šè§†é¢‘åŠ è½½å®‰å…¨é” ---
async function safePlayVideo(videoEl, sourceData) {
    if (!videoEl || !sourceData) return;

    // 1. å…ˆç‰©ç†æ£€æŸ¥ï¼šæºæ•°æ®æ˜¯å¦åˆæ³•ï¼ˆæ˜¯ä¸æ˜¯ç©ºçš„ï¼Œæˆ–è€…æ˜¯ä¸æ˜¯ data:video å¼€å¤´ï¼‰
    if (sourceData.length < 10) {
        console.warn("System: è§†é¢‘æºæ•°æ®å¼‚å¸¸ï¼Œå·²æ‹¦æˆªæ’­æ”¾è¯·æ±‚ã€‚");
        return;
    }

    try {
        // 2. åªæœ‰åœ¨ src å˜åŒ–æ—¶æ‰é‡æ–°åŠ è½½ï¼Œé˜²æ­¢é‡å¤åŠ è½½æŠ¥é”™
        if (videoEl.src !== sourceData) {
            videoEl.src = sourceData;
            videoEl.load(); // ç‰©ç†é‡è½½
        }

        // 3. ğŸš¨ å…³é”®ï¼šå¤„ç†æµè§ˆå™¨æ’­æ”¾æ‰¿è¯º (Promise)
        // iOS æå…¶è®¨åŒæœªå‡†å¤‡å¥½çš„æ’­æ”¾è¯·æ±‚ï¼Œå¿…é¡» catch æ‰
        const playPromise = videoEl.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // è¿™é‡Œå°±æ˜¯æ‹¦æˆªä½ é‚£ä¸ªæŠ¥é”™çš„åœ°æ–¹ï¼
                console.log("ğŸ”’ æ•è·è§†é¢‘ç©ºè½¬å¼‚å¸¸:", error.message);
                // è‡ªåŠ¨é™çº§ï¼šå¦‚æœè§†é¢‘æ”¾ä¸å‡ºæ¥ï¼Œå¼ºåˆ¶æ˜¾ç¤ºèƒŒæ™¯è‰²æˆ–å›¾ç‰‡ï¼Œä¸è®©é¡µé¢å¡æ­»
            });
        }
    } catch (e) {
        console.error("Video Engine Crash:", e);
    }
}
/**
 * âš™ï¸ 1. å¼€å¯åè®®æ ¡å‡†é¢æ¿
 */
function openDestinySettings() {
    const contact = window.currentChattingWith;
    const modal = document.getElementById('modal-destiny-settings'); // ğŸš¨ æ£€æŸ¥ä½ çš„ HTML ID å¿…é¡»æ˜¯è¿™ä¸ª
    if (!contact || !modal) return;

    // è¯»å–é…ç½®ï¼Œé»˜è®¤ç»™ 500 å­—
    const config = JSON.parse(localStorage.getItem('destiny_config_' + contact.id)) || { style: "", plot: "", wordCount: 500 };
    
    // å›å¡«æ•°æ®
    if (document.getElementById('destiny-style-in')) document.getElementById('destiny-style-in').value = config.style || "";
    if (document.getElementById('destiny-plot-in')) document.getElementById('destiny-plot-in').value = config.plot || "";
    
    const wordSlider = document.getElementById('destiny-wordcount-in');
    if (wordSlider) {
        wordSlider.value = config.wordCount || 500;
        document.getElementById('destiny-word-val').innerText = wordSlider.value;
    }
    
    // å¼ºåˆ¶ç‰©ç†æ˜¾ç¤º
    modal.style.display = 'flex'; 
}

/**
 * âš™ï¸ 2. å…³é—­æ ¡å‡†é¢æ¿
 */
function closeDestinySettings() {
    const modal = document.getElementById('modal-destiny-settings');
    if (modal) modal.style.display = 'none';
}

/**
 * âš™ï¸ 3. ä¿å­˜å¹¶åŒæ­¥åè®®æ•°æ®
 */
function saveDestinyProtocol() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const style = document.getElementById('destiny-style-in').value.trim();
    const plot = document.getElementById('destiny-plot-in').value.trim();
    const wordCount = document.getElementById('destiny-wordcount-in').value;

    const config = { style, plot, wordCount };
    localStorage.setItem('destiny_config_' + contact.id, JSON.stringify(config));
    
    if (window.triggerSuccessHud) triggerSuccessHud("åè®®å·²é‡å¡‘");
    closeDestinySettings();
}

// --- ğŸ§  ç‰©ç†éš”ç¦»ï¼šå‰§æƒ…ä¸Šä¸‹æ–‡ç¼“å­˜ ---
window.destinyMemoryContext = []; 

/**
 * ğŸš¨ æ ¸å¿ƒç”Ÿæˆå¼•æ“ï¼šåŒæ­¥è®¾ç½®é¡µåè®® & æ‚å¿—æ’ç‰ˆ
 */
async function sendDestinyCommand(isFinal = false) {
    const input = document.getElementById('destiny-input-field');
    const flow = document.getElementById('destiny-story-flow');
    const contact = window.currentChattingWith;
    if (!contact) return;

    // ğŸš¨ ç‰©ç†ä¿®å¤ï¼šè·å–æœ€æ–°çš„ç”¨æˆ·æ•°æ® (è§£å†³ myData æœªå®šä¹‰æŠ¥é”™)
    const myKey = 'user_persona_for_' + contact.id;
    const myData = JSON.parse(localStorage.getItem(myKey)) || 
                   JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                   { name: "æˆ‘", bio: "" };

    // æ ¼å¼åŒ–è¾“å…¥å†…å®¹
    let userInput = isFinal ? "ï¼ˆè¿›å…¥å®¿å‘½ç»ˆå±€ï¼‰" : input.value.trim();
    if (!userInput && !isFinal) userInput = "(ç»§ç»­æ¨è¿›å‰§æƒ…)"; 
    if (!isFinal) input.value = "";

    // --- ğŸš¨ ç‰©ç†å­˜ç›˜ 1ï¼šä¿å­˜ç”¨æˆ·è¾“å…¥èŠ‚ç‚¹å¹¶æ¸²æŸ“ (ç¡®ä¿åˆ·æ–°ä¸æ¶ˆå¤±) ---
    const userNodeHtml = `
        <div class="destiny-user-node">
            <div class="node-label">OBSERVER INTERVENTION</div>
            <div class="node-content">â€œ${userInput}â€</div>
        </div>
    `;
    flow.insertAdjacentHTML('beforeend', userNodeHtml);
    // ç«‹å³å†™å…¥æ•°æ®åº“
    await saveDestinyNodeToDB(contact.id, { type: 'user', html: userNodeHtml });

    // æ’å…¥ç»‡ç½‘åŠ¨ç”»
    const weaveId = "weave-" + Date.now();
    flow.insertAdjacentHTML('beforeend', `
        <div id="${weaveId}" style="padding:40px 0; text-align:center;">
            <div class="quantum-loading-bar"></div>
            <div style="color:#AF52DE; font-size:10px; letter-spacing:4px; margin-top:20px; font-weight:900;">WEAVING THREADS...</div>
        </div>
    `);
    flow.scrollTop = flow.scrollHeight;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
        const config = JSON.parse(localStorage.getItem('destiny_config_' + contact.id)) || { style: "ç ´ç¢æ„Ÿ", wordCount: 500 };

        // ğŸ§  å†å²æ„ŸçŸ¥ï¼šæŠ“å–æœ€åä¸‰å¼ å¡ç‰‡ï¼Œä¿è¯é•¿ç¯‡æ•…äº‹çš„è¿è´¯æ€§
        const historyCards = Array.from(flow.querySelectorAll('.card-prose-body'));
        const pastStory = historyCards.slice(-3).map(c => c.innerText.substring(0, 500)).join('\n[ä¸Šç« å›é¡¾]\n');

        // æ„é€  System Promptï¼šå¼ºåˆ¶æ‰§è¡Œå§“åé”å®šå’Œæ ¼å¼åè®®
        const systemPrompt = `ä½ ç°åœ¨æ˜¯[é•¿ç¯‡å™äº‹ç¼–å‰§]ã€‚
ã€è§†è§’é”å®šã€‘ï¼šä¸¥ç¦ä½¿ç”¨â€œä½ â€ã€‚æè¿°ç”¨æˆ·å¿…é¡»ç”¨å§“åã€${myData.name}ã€‘ï¼Œæè¿°è§’è‰²å¿…é¡»ç”¨å§“åã€${contact.name}ã€‘ã€‚
ã€å‰æƒ…å›é¡¾ã€‘ï¼š${pastStory || "æ•…äº‹å¼€ç«¯ã€‚"}
ã€å½“å‰ç¥è°•ã€‘ï¼š${userInput}

ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘ï¼š
1. æ‰¿æ¥å‰æƒ…ï¼Œå­—æ•°ä¸¥æ ¼æŒ‰ç…§ ${config.wordCount} å­—å·¦å³ï¼Œå¿…é¡»å™è¿°å®Œæ•´ï¼Œä¸¥ç¦ä¸­é€”æˆªæ–­ã€‚
2. å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è¾“å‡ºæ ¼å¼ï¼š
   ã€ç« èŠ‚æ ‡é¢˜ã€‘æ­¤å¤„å†™æ ‡é¢˜
   ã€æ­£æ–‡ã€‘æ­¤å¤„å†™æ­£æ–‡å†…å®¹...å°†æ ¸å¿ƒè¯æ”¾å…¥ ã€ ã€‘ï¼Œç»†èŠ‚æ”¾å…¥ ã€Œ ã€ã€‚
   ã€å®Œç»“æ¦‚ç‡ã€‘æ•°å­—`;

        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `è¯·åŸºäºå‰æƒ…å’Œç¥è°•ï¼Œç»§ç»­ç¼–ç»‡ã€${myData.name}ã€‘ä¸ã€${contact.name}ã€‘çš„å› æœã€‚` }
                ],
                temperature: 0.95,
                max_tokens: 4000, // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šç¡®ä¿é•¿æ–‡æœ‰è¶³å¤Ÿç©ºé—´åå®Œï¼Œä¸å¡é¡¿
                presence_penalty: 0.6
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        
        const raw = data.choices[0].message.content;

        // ç§»é™¤åŠ¨ç”»
        if (document.getElementById(weaveId)) document.getElementById(weaveId).remove();

        // --- ğŸš¨ ç»ˆæè§£æé€»è¾‘ï¼šç‰©ç†åˆ‡å‰²æ³• (é˜²æ­¢æ­£æ–‡æ ‡è®°å¹²æ‰°) ---
        let title = "å› æœç¢ç‰‡";
        let content = "";
        let fate = "15";

        // æå–æ ‡é¢˜
        if (raw.includes("ã€ç« èŠ‚æ ‡é¢˜ã€‘")) {
            title = raw.split("ã€ç« èŠ‚æ ‡é¢˜ã€‘")[1].split("\n")[0].replace(/[:ï¼š]/g, "").trim();
        }

        // æå–æ­£æ–‡å’Œæ¦‚ç‡
        if (raw.includes("ã€æ­£æ–‡ã€‘")) {
            const tempBody = raw.split("ã€æ­£æ–‡ã€‘")[1];
            if (tempBody.includes("ã€å®Œç»“æ¦‚ç‡ã€‘")) {
                const parts = tempBody.split("ã€å®Œç»“æ¦‚ç‡ã€‘");
                content = parts[0].trim();
                fate = parts[1].match(/\d+/)?.[0] || "15";
            } else {
                // å¦‚æœ AI æ²¡å†™å®Œæ¦‚ç‡æ ‡è®°ï¼Œä¹Ÿä¿ç•™å…¨éƒ¨æ­£æ–‡
                content = tempBody.trim();
            }
        } else {
            content = raw; // æç«¯æƒ…å†µå…œåº•
        }

        // æ‰§è¡Œæ¸²æŸ“
        const id = "card-" + Date.now();
        renderStoryFoldCard(title, content, fate, isFinal, id);
        
        // --- ğŸš¨ ç‰©ç†å­˜ç›˜ 2ï¼šä¿å­˜ AI å¡ç‰‡æ•°æ®åˆ° IndexedDB ---
        await saveDestinyNodeToDB(contact.id, { 
            type: 'ai', 
            id: id, 
            title: title, 
            content: content, 
            fate: fate, 
            isFinal: isFinal 
        });

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        flow.scrollTo({ top: flow.scrollHeight, behavior: 'smooth' });

    } catch (e) {
        console.error("Destiny Error:", e);
        if (document.getElementById(weaveId)) {
            document.getElementById(weaveId).innerHTML = `<div style="color:#FF3B30; font-size:10px; letter-spacing:2px;">CONNECTION FAILED: ${e.message}</div>`;
        }
    }
}

/**
 * ğŸ¨ æ‚å¿—æ’ç‰ˆæ¸²æŸ“å¼•æ“
 */
function renderStoryFoldCard(title, content, fate, isFinal, id) {
    const flow = document.getElementById('destiny-story-flow');
    if (!flow || !content) return;

    // å¤„ç†æ­£æ–‡æ’ç‰ˆ
    const formattedBody = content
        .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
        .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>');
    const paragraphs = formattedBody.split(/\n+/).map(p => `<p>${p}</p>`).join('');

    const html = `
        <div id="${id}" class="story-fold-card">
            <div class="card-manager-btn" onclick="event.stopPropagation(); window.deleteFateNode('${id}')">Ã—</div>
            
            <div class="card-meta-top">
                <span>FRAGMENT // ${id.slice(-4)}</span>
                <span>CONVERGENCE: ${fate}%</span>
            </div>

            <div style="font-family:serif; font-style:italic; font-size:26px; color:#fff; margin-top:15px; margin-bottom:10px;">${title}</div>
            
            <div class="card-prose-body">${paragraphs}</div>

            <div class="card-actions">
                <div style="color:#AF52DE; font-weight:900; font-size:11px; cursor:pointer;" onclick="event.stopPropagation(); window.triggerSideStory('${id}')">âœ¦ å¼€æ‹“å°å‰§åœº</div>
                <div style="color:rgba(255,255,255,0.3); font-size:11px; cursor:pointer;" onclick="event.stopPropagation(); window.rewriteFateNode('${id}')">âŸ³ é‡å¡‘å› æœ</div>
            </div>
        </div>
    `;
    
    flow.insertAdjacentHTML('beforeend', html);
    setTimeout(() => { flow.scrollTop = flow.scrollHeight; }, 100);
}
function triggerFinalChapter() {
    const btn = document.getElementById('final-fate-trigger');
    if(btn) btn.remove(); // ç‚¹å®Œå°±æ¶ˆå¤±
    sendDestinyCommand(true); // è¿›å…¥çœŸÂ·å¤§ç»“å±€æ¨¡å¼
}



// ç‰©ç†æŒ‚è½½
window.sendDestinyCommand = sendDestinyCommand;

/**
 * ğŸ¬ æ ¸å¿ƒå‡½æ•°ï¼šç”Ÿæˆå°å‰§åœº (Side Story)
 * é€»è¾‘ï¼šåŸºäºå½“å‰ç« èŠ‚çš„æ®‹å½±ï¼Œç¼–ç»‡ä¸€æ®µç»†èŠ‚è¡¥å®Œæˆ–å¹³è¡Œè§†è§’çš„ä¾§å½±ã€‚
 */
/**
 * ğŸ¬ å®Œå–„ç‰ˆï¼šä¾§å½±å°å‰§åœºç”Ÿæˆå¼•æ“
 * é€»è¾‘ï¼šåŸºäºå½“å‰ç« èŠ‚çš„é‡å­æ®‹å½±ï¼Œç¼–ç»‡ä¸€æ®µæå…·å¼ åŠ›çš„ç»†èŠ‚è¡¥å®Œã€‚
 */
function triggerSideStory(baseCardId) {
    // 1. ç¯å¢ƒä¸é˜²æŠ–æ ¡éªŒ
    const parentCard = document.getElementById(baseCardId);
    if (!parentCard) return;

    // é˜²æ­¢åŒä¸€ä¸ªå¡ç‰‡ä¸‹åŒæ—¶å¼€å¯å¤šä¸ªç”Ÿæˆä»»åŠ¡
    if (parentCard.dataset.loading === "true") return;
    
    const contact = window.currentChattingWith;
    if (!contact) {
        showToast("âš ï¸ åè®®è¿æ¥æ–­å¼€");
        return;
    }

    // æå–å½“å‰å¡ç‰‡çš„æ­£æ–‡å†…å®¹ä½œä¸ºèƒŒæ™¯
    const proseBody = parentCard.querySelector('.card-prose-body');
    const baseText = proseBody ? proseBody.innerText : "";

    // 2. ç‰©ç†é”å®šï¼šå¯åŠ¨åŠ è½½åŠ¨æ•ˆ
    parentCard.dataset.loading = "true";
    const subWeavingId = "sub-weave-" + Date.now();
    const loadingHtml = `
        <div id="${subWeavingId}" class="destiny-entry" style="margin: -10px 20px 20px 40px; padding-left: 15px; border-left: 1.5px dashed #AF52DE;">
            <div class="weave-line" style="height: 1px; background: #AF52DE; box-shadow: 0 0 10px #AF52DE; animation: weaveScan 1.5s infinite;"></div>
            <div style="font-size: 9px; color: #AF52DE; letter-spacing: 2px; margin-top: 8px; font-weight: 800; animation: pulse 1s infinite;">
                SIDE THREAD WEAVING...
            </div>
        </div>
    `;
    parentCard.insertAdjacentHTML('afterend', loadingHtml);
    // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šå°†å°å‰§åœºå¡ç‰‡å­˜å…¥æ•°æ®åº“
    saveDestinyNodeToDB(contact.id, { 
        type: 'side-story', 
        html: loadingHtml 
    });

    // 3. æ‰§è¡Œé‡å­ç¼–ç»‡é€»è¾‘
    (async () => {
        try {
            const apiKey = localStorage.getItem('gpt_key');
            const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
            
            // æŠ“å–è®¾ç½®é¡µé…ç½®ï¼šä¾§å½±é€šå¸¸æ›´çŸ­ä¿ƒæœ‰åŠ›ï¼Œé»˜è®¤å–ä¸»çº¿çš„ 60% å­—æ•°
            const config = JSON.parse(localStorage.getItem('destiny_config_' + contact.id)) || { style: "ç ´ç¢æ„Ÿ", wordCount: 500 };
            const sideWordCount = Math.max(250, Math.floor(config.wordCount * 0.5));

            const systemPrompt = `ä½ ç°åœ¨æ˜¯[ä¾§å½±è®°å½•è€…]ã€‚
            åˆšæ‰ä¸»çº¿å‰§æƒ…å‘ç”Ÿäº†è¿™ä¸€å¹•: "${baseText.substring(0, 300)}..."
            
            ã€å¼ºåˆ¶å™äº‹åè®®ã€‘ï¼š
            1. è§†è§’é”å®šï¼šå¿…é¡»ä½¿ç”¨ã€ç¬¬äºŒäººç§°(ä½ )ã€‘ç§°å‘¼ç”¨æˆ·ï¼Œä½¿ç”¨ã€${contact.name}ã€‘ç§°å‘¼è§’è‰²ã€‚
            2. ä¾§å½±å®šä½ï¼šä¸è¦é‡å¤ä¸»çº¿ï¼Œè€Œæ˜¯å»æŒ–æ˜é‚£ä¸€åˆ»è¢«å¿½ç•¥çš„ã€Œæ„Ÿå®˜ç»†èŠ‚ã€ã€ã€${contact.name}ã€‘éšç§˜çš„å¿ƒç†èµ·ä¼ï¼Œæˆ–æŸä¸ªå¹³è¡Œå‘ç”Ÿçš„å¾®å°åŠ¨ä½œã€‚
            3. æ–‡é£ï¼š${config.style || "æè‡´é«˜çº§æ„Ÿã€æ„è¯†æµ"}ã€‚
            4. ç¯‡å¹…ï¼šä¸¥æ ¼æ§åˆ¶åœ¨ ${sideWordCount} å­—å·¦å³ã€‚
            
            ã€æ’ç‰ˆåè®®ã€‘ï¼š
            - æ ¸å¿ƒè¯æ±‡åŒ…è£¹åœ¨ ã€ ã€‘ ä¸­ã€‚
            - æ„Ÿå®˜ç»†èŠ‚åŒ…è£¹åœ¨ ã€Œ ã€ ä¸­ã€‚
            
            æ ¼å¼è¾“å‡ºï¼šç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œç¦æ­¢ä»»ä½•å‰ç¼€æˆ–æ‹¬å·ã€‚`;

            const res = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: localStorage.getItem('gpt_model') || "gpt-4o", // ä¾§å½±éœ€è¦æ›´é«˜æ„Ÿæ€§çš„å‘æ•£
                    messages: [{ role: "system", content: systemPrompt }],
                    temperature: 0.95
                })
            });

            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            
            let sideProse = data.choices[0].message.content.trim();

            // 4. æ ·å¼è½¬æ¢å¼•æ“ï¼šåŒæ­¥æ‚å¿—æ ‡æ³¨æ•ˆæœ
            const processedSideProse = sideProse
                .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
                .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>');

            // ç§»é™¤åŠ è½½åŠ¨ç”»
            // --- æ‰¾åˆ° triggerSideStory æˆåŠŸè·å– sideProse åçš„ä½ç½® ---
            const loader = document.getElementById(subWeavingId);
            if (loader) loader.remove();
            parentCard.dataset.loading = "false";

            // ğŸš¨ æ ¸å¿ƒè¡¥ä¸ï¼šå®šä¹‰å°å‰§åœºçš„ HTML ç»“æ„æ¨¡æ¿
            const sideStoryHtml = `
                <div class="story-fold-card side-theatre-card" 
                    style="margin: -10px 20px 25px 40px; background: rgba(175, 82, 222, 0.05); border-left: 2px solid #AF52DE; animation: cardRise 0.6s ease;">
                    <div class="card-meta" style="margin-bottom: 10px;">
                        <span style="color: #AF52DE; font-weight: 900; letter-spacing: 1px;">âœ¦ SIDE THEATRE / ä¾§å½±å°å‰§åœº</span>
                    </div>
                    <div class="card-prose-body" style="font-size: 15px; line-height: 1.8; color: rgba(255,255,255,0.7);">
                        ${sideProse.replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>').replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>').split(/\n+/).map(p => `<p>${p}</p>`).join('')}
                    </div>
                </div>
            `;

            // æ¸²æŸ“åˆ°é¡µé¢
            parentCard.insertAdjacentHTML('afterend', sideStoryHtml);

            // ğŸš¨ æ ¸å¿ƒå­˜ç›˜ï¼šå­˜å…¥å†…å®¹(content)è€Œä¸æ˜¯æ•´ä¸ªHTMLï¼Œä¿è¯åˆ·æ–°åèƒ½é‡æ–°æ¸²æŸ“
            await saveDestinyNodeToDB(contact.id, { 
                type: 'side-story', 
                content: sideProse 
            });

        } catch (e) {
            const loader = document.getElementById(subWeavingId);
            if (loader) loader.innerHTML = `<span style="color:#FF3B30; font-size:9px;">THREAD SNAPPED: ${e.message}</span>`;
            parentCard.dataset.loading = "false";
            console.error("Side Story Error:", e);
        }
    })();
}
// ä¿å­˜èŠ‚ç‚¹ï¼ˆæ— è®ºæ˜¯ç”¨æˆ·å‘çš„è¿˜æ˜¯ AI å‘çš„ï¼‰
async function saveDestinyNodeToDB(contactId, node) {
    let history = await loadFromDB('destiny_history_' + contactId) || [];
    history.push(node);
    await saveToDB('destiny_history_' + contactId, history);
}

// ç‰©ç†åˆ·æ–°åçš„è‡ªæ„ˆåŠ è½½
async function loadDestinyHistory(contactId) {
    const flow = document.getElementById('destiny-story-flow');
    if (!flow) return;

    // 1. è·å–å†å²ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›
    const history = await loadFromDB('destiny_history_' + contactId) || [];
    
    // 2. æ¸…ç†èˆå°ï¼Œä¿ç•™åˆå§‹æç¤ºï¼ˆé‚£ä¸ª STORY THREAD INITIALIZEDï¼‰
    const initializedDiv = flow.querySelector('div[style*="letter-spacing:5px"]');
    flow.innerHTML = "";
    if (initializedDiv) flow.appendChild(initializedDiv);

    // 3. éå†å¹¶æ¢å¤èŠ‚ç‚¹
    history.forEach(node => {
        try {
            if (node.type === 'user') {
                // æ¢å¤ç¥è°•ï¼šç¡®ä¿ html å­—æ®µå­˜åœ¨
                if (node.html) flow.insertAdjacentHTML('beforeend', node.html);
            } 
            else if (node.type === 'ai') {
                // æ¢å¤ AI ç« èŠ‚ï¼šç¡®ä¿å†…å®¹ä¸ä¸ºç©º
                if (node.content) {
                    renderStoryFoldCard(node.title || "å› æœç¢ç‰‡", node.content, node.fate || "15", node.isFinal || false, node.id);
                }
            } 
            else if (node.type === 'side-story') {
                // ğŸš¨ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¢åŠ å±æ€§å­˜åœ¨åˆ¤å®šï¼Œé˜²æ­¢ replace æŠ¥é”™
                if (node.content && typeof node.content === 'string') {
                    const processedBody = node.content
                        .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
                        .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>')
                        .split(/\n+/).map(p => `<p>${p}</p>`).join('');
                        
                    const sideHtml = `
                        <div class="story-fold-card side-theatre-card" style="margin: -10px 20px 25px 40px; background: rgba(175, 82, 222, 0.05); border-left: 2px solid #AF52DE;">
                            <div class="card-meta" style="margin-bottom: 10px;"><span style="color:#AF52DE; font-weight:900;">âœ¦ SIDE THEATRE</span></div>
                            <div class="card-prose-body" style="font-size:15px; line-height:1.8; color:rgba(255,255,255,0.7);">${processedBody}</div>
                        </div>`;
                    flow.insertAdjacentHTML('beforeend', sideHtml);
                } else if (node.html) {
                    // å…œåº•é€»è¾‘ï¼šå¦‚æœæ—§æ•°æ®åªæœ‰ html å­—æ®µï¼Œå°±ç›´æ¥æ’ä»£ç ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
                    flow.insertAdjacentHTML('beforeend', node.html);
                }
            }
        } catch (err) {
            console.warn("è·³è¿‡äº†ä¸€æ¡æŸåçš„å› æœèŠ‚ç‚¹:", err);
        }
    });

    // 4. ä¿æŒæ»šåŠ¨æ¡åœ¨æœ€ä¸‹é¢
    flow.scrollTop = flow.scrollHeight;
}
// --- ğŸ§­ è¡Œæ—…è§é—»æ ¸å¿ƒé©±åŠ¨ ---
window.currentTravelData = [];

/**
 * ğŸ—ºï¸ èˆªçº¿æ˜ å°„æ ¸å¿ƒåè®® (Voyage Trajectory Protocol)
 * åŠŸèƒ½ï¼šç‰©ç†æ¸…ç†æ—§çŠ¶æ€ -> æˆ˜æœ¯æ‰«æ -> AI ç”Ÿæˆ -> åŠ¨æ€é‡ç»˜
 */
/**
 * ğŸ—ºï¸ èˆªçº¿æ˜ å°„æ ¸å¿ƒåè®® (50ç«™é«˜ç»´ç‰ˆ)
 * åŠŸèƒ½ï¼šä»æ»‘åŠ¨æ¡è¯»å–ç«™ç‚¹æ•° -> å¼ºåˆ¶ AI ç¼–ç»‡ç»†è…»è½¨è¿¹ -> ç‰©ç†é‡ç»˜å…¨æ™¯èˆªå›¾
 */
async function startTravelMapping() {
    // 1. ã€ç‰©ç†å®šä½ã€‘æŠ“å–è¾“å…¥ä¸ UI ç»„ä»¶
    const from = document.getElementById('travel-from').value.trim();
    const to = document.getElementById('travel-to').value.trim();
    
    // ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šä»æ–°çš„æ»‘åŠ¨æ¡ ID è¯»å–æ•°å€¼
    const stopsSlider = document.getElementById('travel-stops-slider');
    const stops = stopsSlider ? parseInt(stopsSlider.value) : 5; 

    const btn = document.querySelector('.noir-btn-main');
    const mapBox = document.getElementById('travel-map-box');
    const passContainer = document.getElementById('boarding-pass-container');
    const svgMap = document.getElementById('travel-svg-map');
    const dotsLayer = document.getElementById('travel-dots-layer');

    // 2. ã€å®‰å…¨æ ¡éªŒã€‘
    if (!from || !to) {
        showToast("ğŸ“ è¯·è¾“å…¥å‡ºå‘åœ°å’Œç›®çš„åœ°");
        return;
    }

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) {
        showIOSConfirm("ç§˜é’¥ç¼ºå¤±", "ç³»ç»Ÿæœªæ£€æµ‹åˆ° API Keyï¼Œæ˜¯å¦å‰å¾€é…ç½®ï¼Ÿ", "å»é…ç½®", () => {
            closeSubPage('subpage-travel-journal');
            openApp('settingsApp');
        });
        return;
    }

    // 3. ğŸš¨ ã€ç‰©ç†å½’é›¶ã€‘å½»åº•åˆ‡æ–­ä¸æ—§æ•°æ®çš„è”ç³»
    passContainer.innerHTML = ""; 
    if (svgMap) svgMap.innerHTML = ""; 
    if (dotsLayer) dotsLayer.innerHTML = ""; 
    
    const oldPath = document.querySelector('.travel-line');
    if (oldPath) oldPath.removeAttribute('data-finished');

    // 4. ã€è§†å›¾è½¬æ¢ã€‘è¿›å…¥æˆ˜æœ¯æ‰«æçŠ¶æ€
    document.getElementById('travel-planner').style.display = 'none';
    document.getElementById('travel-canvas-area').style.display = 'block';

    btn.classList.add('btn-loading');
    btn.innerHTML = "CALCULATING " + stops + " VECTORS...";
    
    let overlay = document.getElementById('map-loader-overlay');
    if(!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'map-loader-overlay';
        overlay.innerHTML = `
            <div class="radar-sweep"></div>
            <div class="loading-text">[ SYSTEM: DECODING ${stops} STATIONS ]</div>
        `;
        mapBox.appendChild(overlay);
    }
    overlay.style.display = 'flex';

    try {
        // 5. ã€é‡å­è¯·æ±‚ã€‘AI ç¼–ç»‡æŒ‡ä»¤å‡çº§
        // ğŸš¨ é’ˆå¯¹ 50 ä¸ªç‚¹ï¼Œæˆ‘ä»¬è¦æ±‚ AI å¿…é¡»æä¾›å®Œæ•´çš„ JSONï¼Œä¸”ä¸èƒ½çœç•¥ä¸­é—´ç‚¹
        const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å…¨çƒèˆªçº¿è§„åˆ’ä¸“å®¶ã€‚
        ä»»åŠ¡: è§„åˆ’ä¸€æ¡ä»[${from}]åˆ°[${to}]çš„æ¼«é•¿æ—…ç¨‹ã€‚
        ç«™ç‚¹è¦æ±‚: 
        1. å¿…é¡»ã€ç²¾ç¡®åŒ…å«ã€‘ ${stops} ä¸ªåœ°ç†ç«™ç‚¹ã€‚
        2. ç¬¬1ä¸ªç«™å¿…é¡»æ˜¯[${from}]ï¼Œæœ€å1ä¸ªç«™å¿…é¡»æ˜¯[${to}]ã€‚
        3. ä¸­é—´ ${stops - 2} ä¸ªç«™å¿…é¡»æ˜¯çœŸå®å­˜åœ¨çš„åŸå¸‚ï¼Œä¸”åœ°ç†è½¨è¿¹é€»è¾‘è¿è´¯ï¼ˆä¸è¦åœ¨åœ°çƒä¸¤å¤´ä¹±è·³ï¼‰ã€‚
        4. ä¸ºæ¯ä¸ªç«™ç‚¹æä¾›çœŸå®çš„æœºåœº IATA ä¸‰å­—ç å’Œç²¾ç¡®ç»çº¬åº¦ (lat, lng)ã€‚
        
        è¾“å‡ºåè®®: ä¸¥æ ¼ JSON æ•°ç»„æ ¼å¼ï¼Œç¦æ­¢ä»»ä½•è§£é‡Šæ€§æ–‡å­—ã€‚
        æ ¼å¼ç¤ºä¾‹: [{"name":"åŸå¸‚å","code":"IATA","lat":æ•°å­—,"lng":æ•°å­—}]`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${apiKey}` 
            },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7,
                max_tokens: 4000 // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼š50ä¸ªç‚¹çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¿…é¡»ç»™è¶³ Token ç©ºé—´
            })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const rawContent = data.choices[0].message.content;
        
        // ä½¿ç”¨æ­£åˆ™ç²¾å‡†æ•è· JSON æ•°ç»„
        const jsonMatch = rawContent.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI æ•°æ®ç¼–ç åè®®å¼‚å¸¸");
        
        const route = JSON.parse(jsonMatch[0]);
        window.currentTravelData = route;

        // 6. ã€æ¸²æŸ“åŒæ­¥ã€‘
        // ç‰©ç†å»¶è¿Ÿæ¨¡æ‹Ÿâ€œæ‰“å°æœºæ‰“å°æœºç¥¨â€çš„ Noir è´¨æ„Ÿ
        setTimeout(() => {
            renderBoardingPass(from, to, route[0].code, route[route.length-1].code);
        }, 300);

        // å¼ºåŠ›é‡ç»˜ 50 ä¸ªç«™ç‚¹çš„å¤æ‚èˆªå›¾
        renderTravelMap(route);

        // 7. ã€æ•°æ®å­˜ç›˜ã€‘
        await saveToDB('current_travel_route', route);
        
        // 8. å…³é—­æ‰«æç•Œé¢
        setTimeout(() => {
            if (overlay) overlay.style.display = 'none';
        }, 1000);

    } catch (e) {
        console.error("Trajectory Error:", e);
        showToast("âš ï¸ ç»´åº¦åç¼©: " + e.message);
        if (overlay) overlay.style.display = 'none';
        btn.innerHTML = "RETRY INTERVENTION";
    } finally {
        btn.classList.remove('btn-loading');
        if (btn.innerHTML !== "RETRY INTERVENTION") btn.innerHTML = "GENERATE TRAJECTORY";
    }
}

// --- ğŸ›« æ¸²æŸ“å¥¢å Noirï¼šå·¥ä¸šå®‰å…¨æ¡ç ç‰ˆ ---
function renderBoardingPass(from, to, fromCode, toCode) {
    const container = document.getElementById('boarding-pass-container');
    if (!container) return;

    // è·å– 2026 å¹´çš„å½“å‰æ—¥æœŸ
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
    const etktStr = `ETKT 176 ${Math.floor(Math.random()*10000000000)} 001`;

    // 1. ç‰©ç†æ„å»ºæœºç¥¨ HTML
    container.innerHTML = `
        <div class="boarding-pass">
            <div class="pass-header">
                <span>NOIR ALLIANCE // STRATEGIC VOYAGE</span>
                <span>FIRST CLASS</span>
            </div>

            <div class="pass-body">
                <div id="pass-stamp-logic" class="pass-stamp">
                    <strong>CLEARED</strong>
                    <span>${dateStr}</span>
                </div>

                <div class="flight-route">
                    <div class="city-group">
                        <div class="city-code">${fromCode || 'NAV'}</div>
                        <div class="city-name">${from}</div>
                    </div>
                    <div class="flight-icon-center">âœˆ</div>
                    <div class="city-group" style="text-align: right;">
                        <div class="city-code">${toCode || 'DEST'}</div>
                        <div class="city-name">${to}</div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Flight No.</span><span class="info-value">NK-2026</span></div>
                    <div class="info-item" style="text-align: right;"><span class="info-label">Seat</span><span class="info-value">01A</span></div>
                    <div class="info-item"><span class="info-label">Status</span><span class="info-value">AUTHENTICATED</span></div>
                    <div class="info-item" style="text-align: right;"><span class="info-label">Gate</span><span class="info-value">L-09</span></div>
                </div>
            </div>

            <div class="pass-footer">
                <div class="notch-left pass-notch"></div>
                <div class="notch-right pass-notch"></div>
                <div class="security-zone">
                    <span class="info-label">IATA SECURITY VALIDATION</span>
                    <div class="industrial-barcode"></div>
                    <div class="barcode-data"><span>${etktStr}</span><span>SECURED</span></div>
                </div>
            </div>
        </div>
    `;

    // 2. ğŸš¨ ç‰©ç†è§¦å‘ç›–ç« åŠ¨æ•ˆ ğŸš¨
    // å»¶è¿Ÿ 600msï¼Œç­‰å¾…æœºç¥¨å±•ç¤ºåŠ¨ç”»å®Œæˆåï¼Œå°ç« å†ç ¸ä¸‹æ¥
    setTimeout(() => {
        const stamp = document.getElementById('pass-stamp-logic');
        if (stamp) {
            stamp.classList.add('stamp-active');
            // ç‰©ç†å¢åŠ ä¸€ä¸ªæè½»å¾®çš„æ‰‹æœºéœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœç¡¬ä»¶æ”¯æŒï¼‰
            if (navigator.vibrate) navigator.vibrate(20);
        }
    }, 600);
}

// --- ğŸ—ºï¸ æ¸²æŸ“æˆ˜æœ¯ Noir èˆªå›¾ ---x

// --- ğŸ—ºï¸ ç‰©ç†é©±åŠ¨ï¼šå…¨åŠ¨æ€åæ ‡åŒæ­¥å¼•æ“ ---

// --- ğŸ§­ ç‰©ç†é”æ­»ï¼šå…¨åŠ¨æ€åœ°ç†é”šå®šå¼•æ“ ---
var travelMap = null; 

function renderTravelMap(route) {
    if (!route || !route.length) return;
    window.activeVoyageRoute = route; // ğŸš¨ ç‰©ç†æŒä¹…åŒ–æ•°æ®ï¼Œä¾›é‡ç»˜ä½¿ç”¨

    // 1. åˆå§‹åŒ–åœ°å›¾å®¹å™¨
    if (window.travelMap) {
        window.travelMap.off();
        window.travelMap.remove();
    }

    window.travelMap = L.map('travel-map-box', {
        zoomControl: false,
        attributionControl: false,
        zoomSnap: 0.1 // ğŸš¨ å…³é”®ï¼šå…è®¸æç»†å¾®çš„ç¼©æ”¾ï¼Œå¢åŠ ä¸æ»‘æ„Ÿ
    }).setView([route[0].lat, route[0].lng], 4);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(window.travelMap);
    
    // 2. ç‰©ç†æ ¡å‡†ï¼šè§£å†³â€œæ˜¾ç¤ºä¸å…¨â€çš„ç»ˆææ–¹æ¡ˆ
    setTimeout(() => window.travelMap.invalidateSize(), 100);

    // 3. è§†é‡é”å®š
    const bounds = L.latLngBounds(route.map(p => [p.lat, p.lng]));
    window.travelMap.fitBounds(bounds, { padding: [60, 60], animate: false });

    // ğŸš¨ æ ¸å¿ƒï¼šå»ºç«‹åŒæ­¥é“¾è·¯ ğŸš¨
    const syncEngine = () => {
        if (!window.activeVoyageRoute || !window.travelMap) return;
        
        // --- A. é‡ç»˜èˆªçº¿ ---
        const svg = document.getElementById('travel-svg-map');
        let pathD = "";
        window.activeVoyageRoute.forEach((p, i) => {
            const point = window.travelMap.latLngToContainerPoint([p.lat, p.lng]);
            pathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
        });

        let path = svg.querySelector('.travel-line');
        if (!path) {
            path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("class", "travel-line");
            path.setAttribute("fill", "none");
            svg.appendChild(path);
        }
        path.setAttribute("d", pathD);

        // --- B. é‡ç»˜ç«™ç‚¹ ---
        const dotsLayer = document.getElementById('travel-dots-layer');
        if (dotsLayer.children.length === 0) {
            // åˆæ¬¡ç”Ÿæˆ DOM
            window.activeVoyageRoute.forEach((stop) => {
                const dot = document.createElement('div');
                dot.className = 'travel-dot';
                dot.dataset.name = stop.name;
                dot.onclick = (e) => { e.stopPropagation(); showStopLog(stop); };
                dotsLayer.appendChild(dot);
            });
        }
        
        // å®æ—¶ç§»åŠ¨ DOM ä½ç½®
        Array.from(dotsLayer.children).forEach((dot, i) => {
            const stop = window.activeVoyageRoute[i];
            const pos = window.travelMap.latLngToContainerPoint([stop.lat, stop.lng]);
            dot.style.left = pos.x + "px";
            dot.style.top = pos.y + "px";
        });
    };

    // 4. ç›‘å¬ç‰©ç†å˜åŠ¨ï¼šmoveï¼ˆå¹³ç§»ï¼‰ã€zoomï¼ˆç¼©æ”¾ï¼‰ã€resizeï¼ˆçª—å£å˜åŠ¨ï¼‰
    window.travelMap.on('move zoom viewreset resize', () => {
        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨æµè§ˆå™¨ä¸‹æ¬¡ç»˜åˆ¶å‰å®Œæˆåæ ‡è®¡ç®—
        requestAnimationFrame(syncEngine); 
    });

    // 5. é¦–æ¬¡ç‚¹ç«æ‰§è¡Œ
    setTimeout(() => {
        syncEngine();
        // ç¬¬ä¸€æ¬¡ç»˜åˆ¶æ—¶çš„â€œç”Ÿé•¿â€åŠ¨ç”»
        const path = document.querySelector('.travel-line');
        if (path) {
            const len = path.getTotalLength();
            path.style.strokeDasharray = len;
            path.style.strokeDashoffset = len;
            path.getBoundingClientRect();
            path.style.transition = "stroke-dashoffset 2.5s cubic-bezier(0.4, 0, 0.2, 1)";
            path.style.strokeDashoffset = "0";
        }
    }, 300);
}

// ç‰©ç†æ˜ å°„ï¼šå®æ—¶è®¡ç®—è·¯å¾„åƒç´ 
// --- ğŸ—ºï¸ ç‰©ç†ä¿®å¤ï¼šé«˜é¢‘åœ°ç†åŒæ­¥å¼•æ“ ---
function updateSvgPath(route) {
    const svg = document.getElementById('travel-svg-map');
    if (!svg || !window.travelMap || !route) return;

    let path = svg.querySelector('.travel-line');
    if (!path) {
        path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("class", "travel-line");
        path.setAttribute("fill", "none");
        svg.appendChild(path);
    }

    // 1. è®¡ç®—åæ ‡
    let pathData = "";
    route.forEach((p, i) => {
        const point = window.travelMap.latLngToContainerPoint([p.lat, p.lng]);
        pathData += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
    });
    path.setAttribute("d", pathData);

    // 2. ğŸš¨ å¼ºåŠ›é‡ç½®åŠ¨ç”»é€»è¾‘ ğŸš¨
    if (!path.hasAttribute('data-finished')) {
        // å…³é—­è¿‡æ¸¡ï¼Œç¬é—´å½’é›¶
        path.style.transition = "none";
        const len = path.getTotalLength();
        path.style.strokeDasharray = len;
        path.style.strokeDashoffset = len;
        
        // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ (Reflow)
        path.getBoundingClientRect(); 
        
        // é‡æ–°å¼€å¯ç”Ÿé•¿åŠ¨ç”»
        path.style.transition = "stroke-dashoffset 2.5s cubic-bezier(0.4, 0, 0.2, 1)";
        path.style.strokeDashoffset = "0";
        
        // åŠ¨ç”»ç»“æŸåŠ é”
        setTimeout(() => { path.setAttribute('data-finished', 'true'); }, 2600);
    } else {
        // å¦‚æœæ˜¯ç¼©æ”¾å¹³ç§»ï¼Œä¿æŒåŒæ­¥å³å¯
        path.style.transition = "none";
        path.style.strokeDashoffset = "0";
        path.style.strokeDasharray = "4, 4";
    }
}

// ç‰©ç†æ˜ å°„ï¼šå®æ—¶è®¡ç®—ç«™ç‚¹åƒç´ 
function updateDotsPosition(route) {
    const layer = document.getElementById('travel-dots-layer');
    if (!layer || !window.travelMap) return;

    // å¦‚æœè¿˜æ²¡ç”Ÿæˆç‚¹ï¼Œå°±å…ˆç”Ÿæˆ
    if (layer.children.length === 0) {
        route.forEach((stop) => {
            const dot = document.createElement('div');
            dot.className = 'travel-dot';
            dot.dataset.name = stop.name;
            dot.onclick = (e) => {
                e.stopPropagation();
                showStopLog(stop);
            };
            layer.appendChild(dot);
        });
    }

    // å®æ—¶æ›´æ–°ä½ç½®
    const dots = layer.children;
    route.forEach((stop, i) => {
        const pos = window.travelMap.latLngToContainerPoint([stop.lat, stop.lng]);
        if (dots[i]) {
            dots[i].style.left = pos.x + "px";
            dots[i].style.top = pos.y + "px";
        }
    });
}

// ä¸“é—¨è´Ÿè´£ç”»é‚£æ¡â€œé«˜çº§æ„Ÿâ€èˆªçº¿
function drawAnimatedRoute(route) {
    const svg = document.getElementById('travel-svg-map');
    if (!svg || !window.travelMap) return;
    svg.innerHTML = ""; 
    
    let pathD = "";
    route.forEach((p, i) => {
        // ä½¿ç”¨ map çš„åƒç´ æŠ•å½±ç®—æ³•
        const point = window.travelMap.latLngToContainerPoint([p.lat, p.lng]);
        pathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
    });

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", pathD);
    path.setAttribute("class", "travel-line");
    svg.appendChild(path);

    // è®¡ç®—è·¯å¾„é•¿åº¦å¹¶æ‰§è¡Œç”Ÿé•¿åŠ¨ç”»
    const length = path.getTotalLength();
    path.style.strokeDasharray = length;
    path.style.strokeDashoffset = length;
    path.getBoundingClientRect(); // ç‰©ç†å¼ºåˆ¶é‡æ’
    path.style.transition = "stroke-dashoffset 2.5s cubic-bezier(0.4, 0, 0.2, 1)";
    path.style.strokeDashoffset = "0";
}

function renderMapDots(route) {
    const dotsLayer = document.getElementById('travel-dots-layer');
    if (!dotsLayer || !window.travelMap) return;
    dotsLayer.innerHTML = "";

    route.forEach((stop) => {
        const pos = window.travelMap.latLngToContainerPoint([stop.lat, stop.lng]);
        const dot = document.createElement('div');
        dot.className = 'travel-dot';
        dot.style.left = pos.x + "px";
        dot.style.top = pos.y + "px";
        dot.dataset.name = stop.name;
        dot.onclick = (e) => {
            e.stopPropagation();
            showStopLog(stop);
        };
        dotsLayer.appendChild(dot);
    });
}

// --- ğŸ“œ æ„Ÿå®˜éšç¬”è§£ç å¼•æ“ (é«˜å®šå¢å¼ºç‰ˆ) ---
async function showStopLog(stop) {
    const modal = document.getElementById('modal-travel-log');
    const contentEl = document.getElementById('log-content-body');
    const cityEl = document.getElementById('log-city-name');
    const moodEl = document.getElementById('log-mood-tag');

    if (!modal) return;

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ£€æŸ¥å¹¶å¡«å…¥åŸå¸‚å ğŸš¨
    // é€»è¾‘ï¼šå¦‚æœ stop.name ä¸å­˜åœ¨ï¼Œå°è¯•å– stop.cityNameï¼Œéƒ½ä¸è¡Œåˆ™æ˜¾ç¤ºâ€œæœªçŸ¥åæ ‡â€
    const currentCity = stop.name || stop.cityName || "æœªçŸ¥åæ ‡";
    cityEl.textContent = currentCity; 
    
    contentEl.textContent = "æ­£åœ¨åŒæ­¥é‡å­æ„Ÿå®˜é¢‘ç‡...";
    modal.style.display = 'flex';
    modal.style.zIndex = "40000";

    // 1. è®°å¿†æŸ¥é˜…ï¼šå¦‚æœè¿™å¼ ç¥¨æ ¹å·²ç»å­˜è¿‡è¿™æ®µè¯ï¼Œç›´æ¥è¯»ï¼Œä¸é‡åˆ·
    let archive = await loadFromDB('voyage_archive') || [];
    let stubIdx = archive.findIndex(s => s.id === window.currentStubId);
    if (stubIdx !== -1 && archive[stubIdx].logs && archive[stubIdx].logs[currentCity]) {
        contentEl.textContent = archive[stubIdx].logs[currentCity];
        moodEl.textContent = "MEMORIZED DATA // ARCHIVE-SECURED";
        return;
    }

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        const contact = window.archiveContextChar || window.currentChattingWith || { name: "ä¼´ä¾£", desc: "äº²å¯†çš„äºº" };

        // 2. ğŸš¨ æç¤ºè¯è¿›åŒ–ï¼šæ³¨å…¥ 2026 å¹´ ç”µå½±çº§å™äº‹åè®® ğŸš¨
        // æˆ‘ä»¬å¼•å…¥äº† CITY_VIBE_DBï¼Œè®© AI çŸ¥é“è¿™ä¸ªåŸå¸‚è¯¥å†™ä»€ä¹ˆ
        const cityVibe = (window.CITY_VIBE_DB && window.CITY_VIBE_DB[currentCity]) ? window.CITY_VIBE_DB[currentCity].vibe : "å……æ»¡æœªçŸ¥ä¸æ•…äº‹çš„è§’è½";

        const prompt = `ä½ ç°åœ¨æ­£åœ¨æ‰®æ¼”: [${contact.name}]ã€‚
        ã€èº«ä»½èƒŒæ™¯ã€‘: ${contact.desc}
        ã€å½“å‰åœ°ç‚¹ã€‘: ${currentCity}
        ã€ç¯å¢ƒæ°›å›´ã€‘: ${cityVibe}
        
        ã€ä»»åŠ¡æŒ‡ä»¤ã€‘:
        ä½ æ­£å’Œ[æˆ‘]åœ¨è¿™é‡Œæ—…è¡Œï¼Œè¯·å†™ä¸€æ®µå…³äºè¿™é‡Œçš„æ„Ÿå®˜éšç¬”ã€‚
        
        ã€æ–‡å­¦è¦æ±‚ã€‘:
        1. æ–‡é£ï¼šå‚è€ƒç‹å®¶å«æˆ–æœæ‹‰æ–¯ï¼Œæå…·ç ´ç¢æ„Ÿã€æš§æ˜§ã€æ¸…å†·ä¸”é«˜çº§ã€‚
        2. ç»†èŠ‚ï¼šå¿…é¡»åŒ…å«è§¦è§‰ã€å—…è§‰æˆ–å…‰å½±çš„ç»†èŠ‚æå†™ã€‚
        3. æƒ…æ„Ÿï¼šå­—é‡Œè¡Œé—´è¦é€å‡ºä½ å¯¹[æˆ‘]é‚£ç§éš¾ä»¥æ‰æ‘¸ä½†åˆæµ“çƒˆçš„ç‰µç»Šã€‚
        4. å­—æ•°ï¼šä¸¥æ ¼æ§åˆ¶åœ¨ 150-200 å­—ä¹‹é—´ï¼Œè¦æœ‰æ®µè½å‘¼å¸æ„Ÿã€‚
        
        ã€ç¦ä»¤ã€‘: ä¸¥ç¦å‡ºç° Emojiï¼Œä¸¥ç¦ä½¿ç”¨ä»»ä½•æ‹¬å·æå†™åŠ¨ä½œã€‚ç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85, // æé«˜åˆ›é€ åŠ›ï¼Œæ‹’ç»æœºæ¢°åŒ–
                max_tokens: 500    // ç¡®ä¿æœ‰è¶³å¤Ÿçš„è¾“å‡ºç©ºé—´
            })
        });

        const data = await res.json();
        const storyText = data.choices[0].message.content.trim();

        // 3. ç‰©ç†å…¥åº“ï¼šå®šæ ¼è¿™æ®µè®°å¿†
        if (stubIdx !== -1) {
            if (!archive[stubIdx].logs) archive[stubIdx].logs = {};
            archive[stubIdx].logs[currentCity] = storyText;
            await saveToDB('voyage_archive', archive);
        }

        contentEl.textContent = storyText;
        moodEl.textContent = "DECODED FROM " + contact.name.toUpperCase();

    } catch (e) {
        console.error("Dossier Error:", e);
        contentEl.textContent = "é‡å­ä¿¡å·è¢«å¼ºç”µç£å¹²æ‰°ï¼Œæ— æ³•ä»è¯¥åæ ‡å›æº¯å†å²...";
    }
}

// --- ğŸ§¹ é‡ç½®èˆªçº¿é€»è¾‘ ---
async function resetTravelLog() {
    showIOSConfirm("é‡ç½®èˆªçº¿", "ç¡®å®šè¦æŠ¹é™¤å½“å‰çš„è¡Œç¨‹è½¨è¿¹å—ï¼Ÿ", "é‡ç½®", async () => {
        // 1. ç‰©ç†æŠ¹é™¤æ•°æ®åº“å’Œå†…å­˜
        await saveToDB('current_travel_route', null);
        window.currentTravelData = [];
        window.activeVoyageRoute = null;

        // 2. å½»åº•é”€æ¯åœ°å›¾ï¼Œé˜²æ­¢ä¸‹æ¬¡åˆå§‹åŒ–å†²çª
        if (window.travelMap) {
            window.travelMap.off();
            window.travelMap.remove();
            window.travelMap = null;
        }

        // 3. å¼ºåˆ¶æ¸…ç©º UI å®¹å™¨ï¼Œé˜²æ­¢æ—§å…ƒç´ æ®‹ç•™
        document.getElementById('boarding-pass-container').innerHTML = "";
        const svg = document.getElementById('travel-svg-map');
        if (svg) svg.innerHTML = "";
        const dots = document.getElementById('travel-dots-layer');
        if (dots) dots.innerHTML = "";

        // 4. å›åˆ°ç­–åˆ’é¡µ
        document.getElementById('travel-planner').style.display = 'block';
        document.getElementById('travel-canvas-area').style.display = 'none';
        
        showToast("æ—¶ç©ºè½¨è¿¹å·²å½’é›¶");
    });
}
// ==========================================
// ğŸ›ï¸ è¡Œæ—…å­˜æ ¹ç³»ç»Ÿï¼šç‰©ç†å‡½æ•°å…¨é‡å®šä¹‰
// ==========================================

// 1. ã€æ‰§è¡Œä¿å­˜ã€‘ï¼šç‰©ç†ç¼–ç å¹¶å°†å½“å‰è½¨è¿¹å…¥åº“
async function saveTravelStub() {
    console.log("System: å¯åŠ¨ç‰©ç†å°å­˜åè®®...");
    
    // A. ç‰©ç†æ ¡éªŒï¼šæ•°æ®å®Œæ•´æ€§
    const route = window.currentTravelData;
    if (!route || route.length === 0) {
        showToast("âš ï¸ å°šæœªæ£€æµ‹åˆ°å¯ç¼–ç çš„è½¨è¿¹");
        return;
    }

    // B. èº«ä»½é”å®šï¼šè·å–å½“å‰è§’è‰² (ğŸš¨ æ ¸å¿ƒä¿®å¤ç‚¹)
    // é€»è¾‘ï¼šä¼˜å…ˆå–èŠå¤©çª—å£å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å–æœ€åä¸€æ¬¡è°ƒç”¨çš„è§’è‰²
    let contact = window.currentChattingWith || window.lastActiveChar;
    
    if (!contact) {
        // å¦‚æœä¾ç„¶æ²¡æœ‰ï¼Œå»è§’è‰²ä¹¦é‡ŒæŠ“ç¬¬ä¸€ä¸ªäººï¼Œé˜²æ­¢ç¨‹åºå´©æºƒ
        const charList = await loadFromDB('char_list') || [];
        contact = charList[0];
    }

    if (!contact) {
        showToast("âš ï¸ é“¾è·¯å¼‚å¸¸ï¼šæœªè¯†åˆ«åˆ°æœ‰æ•ˆäººæ ¼");
        return;
    }

    // C. ç¼–ç å­˜æ ¹æ•°æ®
    const stubId = "STUB-" + Date.now();
    const dateStr = new Date().toLocaleDateString('en-GB', { 
        day: '2-digit', month: 'short', year: 'numeric' 
    }).toUpperCase();

    const stubData = {
        id: stubId,
        charId: contact.id,          // ç»‘å®šè§’è‰² ID
        charName: contact.name,      // ç‰©ç†åˆ»å½•åå­—
        charAvatar: contact.avatar,  // ç‰©ç†åˆ»å½•å¤´åƒ
        from: route[0].name,
        to: route[route.length - 1].name,
        fromCode: route[0].code || "NAV",
        toCode: route[route.length - 1].code || "DEST",
        route: route,
        date: dateStr,
        timestamp: Date.now(),
        logs: {} // é¢„ç•™é‡å­æ„Ÿå®˜å®šæ ¼ç©ºé—´
    };

    try {
        // ç‰©ç†å…¥åº“ IndexedDB
        let archive = await loadFromDB('voyage_archive') || [];
        archive.unshift(stubData);
        await saveToDB('voyage_archive', archive);

        // è”åŠ¨ HUD è§†è§‰åé¦ˆ
        if (window.triggerSuccessHud) {
            triggerSuccessHud("å­˜æ ¹å·²å­˜å…¥ " + contact.name + " çš„åä¸‹");
        } else {
            showToast("âœ… å­˜æ ¹å·²ç‰©ç†å…¥åº“");
        }
    } catch (e) {
        console.error("Archive Failed:", e);
        showToast("âŒ å­˜æ ¹ç¼–ç å†²çª");
    }
}

// 2. ã€æ¸²æŸ“åˆ—è¡¨ã€‘ï¼šç‰©ç†å¼€å¯é‡‘åº“å¹¶æ¸²æŸ“å·¥ä¸šå­˜æ ¹
async function openVoyageArchive() {
    console.log("System: æ­£åœ¨è°ƒå–é«˜ç»´å­˜æ ¹é‡‘åº“...");
    const container = document.getElementById('archive-list-container');
    if (!container) return;

    const archive = await loadFromDB('voyage_archive') || [];

    if (archive.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:rgba(0,0,0,0.2); margin-top:100px;">
                <div style="font-size:40px; margin-bottom:10px;">âˆ…</div>
                <div style="font-size:10px; letter-spacing:3px; font-weight:800;">VAULT IS EMPTY</div>
            </div>`;
    } else {
        // æ¸²æŸ“å…·æœ‰â€œåˆ‡è¾¹ç¾å­¦â€çš„å·¥ä¸šå­˜æ ¹åˆ—è¡¨
        container.innerHTML = archive.map((item, index) => `
            <div class="travel-stub-card" onclick="viewSavedTravel('${item.id}')" style="animation-delay: ${index * 0.1}s">
                <div class="stub-left">SERIAL: ${item.id.slice(-8)}</div>
                <div class="stub-right">
                    <div class="stub-route-line">${item.fromCode} â” ${item.toCode}</div>
                    <div style="font-size:13px; font-weight:700; color:#000; margin-bottom:8px;">${item.from} to ${item.to}</div>
                    <div class="stub-meta">
                        <span>DATE: ${item.date}</span>
                        <span>INDEX: ${item.route.length} STOPS</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    openSubPage('subpage-voyage-archive');
}
// ==========================================
// ğŸ›ï¸ è¡Œæ—…æ¨¡å—åˆ‡æ¢åè®®
// ==========================================
function switchVoyageTab(target) {
    // 1. ç‰©ç†é‡ç½®æŒ‰é’®
    document.querySelectorAll('.v-nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('btn-nav-' + target).classList.add('active');

    // 2. ç‰©ç†åˆ‡æ¢é¢æ¿
    document.querySelectorAll('.voyage-panel').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + target + '-panel').classList.add('active');

    // 3. é€»è¾‘è§¦å‘
    if (target === 'vault') {
        renderVaultList(); // åˆ‡æ¢åˆ°é‡‘åº“æ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°å­˜æ ¹åˆ—è¡¨
    } else {
        // å¦‚æœåˆ‡å› Journal ä¸”åœ°å›¾å·²åˆå§‹åŒ–ï¼Œå¼ºåˆ¶æ ¡å‡†å°ºå¯¸
        if (window.travelMap) {
            setTimeout(() => window.travelMap.invalidateSize(), 50);
        }
    }
}

// --- ğŸ›ï¸ é‡‘åº“æ¸²æŸ“åè®®ï¼šæ³¨å…¥åˆ é™¤é€»è¾‘ ---
async function renderVaultList() {
    const container = document.getElementById('archive-list-container');
    if (!container) return;

    const archive = await loadFromDB('voyage_archive') || [];

    if (archive.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:100px 0; opacity:0.2; font-size:12px; letter-spacing:4px;">VAULT_EMPTY</div>`;
        return;
    }

    container.innerHTML = archive.map((item, index) => {
        const securityHash = Math.random().toString(36).substring(2, 8).toUpperCase();
        return `
        <div class="travel-stub-card" id="stub-card-${item.id}" onclick="viewSavedTravel('${item.id}')" style="animation-delay: ${index * 0.1}s">
            
            <div class="stub-delete-tag" onclick="event.stopPropagation(); deleteTravelStub('${item.id}')">
                âœ•
            </div>

            <div class="stub-left">TOKEN // ${securityHash}</div>
            <div class="stub-main">
                <div class="stub-header">
                    <div>
                        <div class="stub-codes">${item.fromCode} <span style="opacity:0.2;">â”</span> ${item.toCode}</div>
                        <div class="stub-cities">${item.from} / ${item.to}</div>
                    </div>
                    <div class="stub-qr">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${item.id}&color=1d1d1f" style="width:100%; height:100%; filter:grayscale(1) contrast(1.5);">
                    </div>
                </div>
                <div class="stub-tear"></div>
                <div class="stub-footer">
                    <div class="f-item"><span class="f-label">Passenger</span><span class="f-val">${item.charName}</span></div>
                    <div class="f-item"><span class="f-label">Date</span><span class="f-val">${item.date}</span></div>
                    <div class="f-item" style="text-align:right;"><span class="f-label">Stop</span><span class="f-val">#${item.route.length}</span></div>
                </div>
            </div>
        </div>`;
    }).join('');
}
/**
 * ğŸ—‘ï¸ ç‰©ç†é”€æ¯åè®®
 * é€»è¾‘ï¼šäºŒæ¬¡ç¡®è®¤ -> UI ç²‰ç¢åŠ¨ç”» -> æ•°æ®åº“å‰”é™¤ -> åˆ—è¡¨åˆ·æ–°
 */
async function deleteTravelStub(id) {
    // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ iOS é£æ ¼ç¡®è®¤æ¡†
    showIOSConfirm("æŠ¹é™¤è®°å¿†", "ç¡®å®šè¦æ°¸ä¹…é”€æ¯è¿™å¼ è¡Œæ—…å­˜æ ¹å—ï¼Ÿæ­¤æ“ä½œå°†æ— æ³•å›æº¯è¯¥æ—¶é—´èŠ‚ç‚¹çš„å› æœçº¿ã€‚", "ç²‰ç¢", async () => {
        
        // 1. UI åŠ¨ç”»å…ˆè¡Œï¼šç»™å¡ç‰‡åŠ ä¸Šç²‰ç¢ç±»å
        const el = document.getElementById('stub-card-' + id);
        if (el) el.classList.add('stub-shredding');

        // å»¶è¿Ÿ 400ms ç­‰åŠ¨ç”»èµ°å®Œå†æ‰§è¡Œæ•°æ®æ“ä½œ
        setTimeout(async () => {
            try {
                // 2. æ•°æ®åº“å‰”é™¤
                let archive = await loadFromDB('voyage_archive') || [];
                archive = archive.filter(item => item.id !== id);
                await saveToDB('voyage_archive', archive);

                // 3. é‡æ–°æ¸²æŸ“åˆ—è¡¨
                renderVaultList();
                showToast("å­˜æ ¹å·²ç‰©ç†ç²‰ç¢");
                
                // ç‰©ç†åé¦ˆ
                if (navigator.vibrate) navigator.vibrate(40);
            } catch (e) {
                console.error("Delete Error:", e);
                showToast("âŒ é”€æ¯æŒ‡ä»¤æ‰§è¡Œå¼‚å¸¸");
            }
        }, 400);
    });
}
// ==========================================
// ğŸ›ï¸ å­˜æ ¹æ’•è£‚äº¤äº’æ ¸å¿ƒåè®®
// ==========================================

// 1. å…¥å£ï¼šé‡å†™ viewSavedTravel
async function viewSavedTravel(id) {
    console.log("System: æ­£åœ¨ç‰©ç†æå–æ¡£æ¡ˆ ->", id);
    const archive = await loadFromDB('voyage_archive') || [];
    const target = archive.find(x => x.id === id);

    if (target) {
        // ğŸš¨ èº«ä»½åŒæ­¥ï¼šè®©æ¥ä¸‹æ¥çš„æ‰€æœ‰æ“ä½œéƒ½çŸ¥é“è¿™å¼ ç¥¨å±äºè°
        window.archiveContextChar = {
            id: target.charId,
            name: target.charName,
            avatar: target.charAvatar
        };
        window.currentStubId = target.id;
        window.currentTravelData = target.route;

        // ç‰©ç†æ¸…ç†å½“å‰èˆå°
        document.getElementById('boarding-pass-container').innerHTML = "";
        const svg = document.getElementById('travel-svg-map');
        if (svg) svg.innerHTML = "";
        
        // ç‰©ç†åˆ‡æ¢è‡³â€œæ’•ç¥¨ä»ªå¼å…â€
        const ticketContainer = document.getElementById('reveal-ticket-container');
        const mapSection = document.getElementById('reveal-map-section');
        
        // é‡ç½®åŠ¨ç”»çŠ¶æ€
        if(mapSection) {
            mapSection.style.opacity = '0';
            mapSection.style.filter = 'blur(10px)';
        }
        
        // æ¸²æŸ“å¤§ç¥¨æ ¹
        const serial = target.id.slice(-8).toUpperCase();
        ticketContainer.innerHTML = `
            <div class="interactive-ticket" onclick="triggerTicketTear(this, '${target.id}')">
                <div class="ticket-stub-part">
                    <div style="font-size:8px; opacity:0.5;">NOIR ARCHIVE</div>
                    <div style="font-family:monospace; font-weight:800; font-size:11px; writing-mode: vertical-lr; transform: rotate(180deg); margin: auto; letter-spacing:3px;">
                        ${serial}
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <div class="ticket-main-part">
                    <div class="tm-code">${target.fromCode} â” ${target.toCode}</div>
                    <div class="tm-city">${target.from} to ${target.to}</div>
                    <div class="tm-meta-grid">
                        <div><div class="tm-label">VALIDATED DATE</div><div class="tm-val">${target.date}</div></div>
                        <div><div class="tm-label">PASSENGER</div><div class="tm-val">${target.charName}</div></div>
                    </div>
                    <div class="tm-seal">VALID</div>
                </div>
            </div>`;

        openSubPage('subpage-ticket-reveal');
    }
}

// 2. äº¤äº’ï¼šè§¦å‘æ’•è£‚åŠ¨ç”»å¹¶æ˜¾ç°åœ°å›¾
function triggerTicketTear(ticketEl, targetId) {
    if (ticketEl.classList.contains('is-torn')) return; 
    
    console.log("System: æ‰§è¡Œç‰©ç†æ’•è£‚ç¨‹åº...");
    
    // ç‰©ç†åé¦ˆ
    if (navigator.vibrate) navigator.vibrate([60, 40, 60]);
    
    // å¯åŠ¨ CSS åŠ¨ç”»ï¼šé»‘è‰²éƒ¨åˆ†é£èµ°
    ticketEl.classList.add('is-torn');
    
    // ç›‘å¬åŠ¨ç”»ç»“æŸï¼Œå¼€å§‹æ˜¾å½±åœ°å›¾
    const stubPart = ticketEl.querySelector('.ticket-stub-part');
    stubPart.addEventListener('animationend', async () => {
        const archive = await loadFromDB('voyage_archive') || [];
        const target = archive.find(x => x.id === targetId);
        
        if (target) {
             const mapSection = document.getElementById('reveal-map-section');
             mapSection.style.opacity = '1';
             mapSection.style.filter = 'blur(0px)';
             mapSection.style.transform = 'translateY(0px)';
             mapSection.style.pointerEvents = 'auto';
             
             // è°ƒç”¨åœ°å›¾æ¸²æŸ“å‡½æ•°
             renderRevealMap(target.route);
        }
    }, { once: true });
}

// 3. æ¸²æŸ“ï¼šä»ªå¼å…ä¸“ç”¨é™æ€åœ°å›¾
function renderRevealMap(route) {
    const mapBox = document.getElementById('reveal-map-box');
    if (!mapBox || !route) return;

    mapBox.innerHTML = "<div id='reveal-leaflet-map' style='width:100%; height:100%;'></div><svg id='reveal-svg-layer' style='position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:500;'></svg>";

    const map = L.map('reveal-leaflet-map', {
        zoomControl: false, attributionControl: false, dragging: true, 
        scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false,
        zoomSnap: 0.1
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.7 }).addTo(map);

    const bounds = L.latLngBounds(route.map(p => [p.lat, p.lng]));
    map.fitBounds(bounds, { padding: [50, 50], animate: false });
    
    const svg = document.getElementById('reveal-svg-layer');
    let pathD = "";
    route.forEach((p, i) => {
        const point = map.latLngToContainerPoint([p.lat, p.lng]);
        pathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
        
        // ğŸš¨ æ ¸å¿ƒï¼šæ¸²æŸ“äº¤äº’å¼å…‰ç‚¹
        const marker = L.circleMarker([p.lat, p.lng], {
            radius: 6, color: '#fff', fillColor: '#fff', fillOpacity: 1, weight: 2, className: 'reveal-dot-glow'
        }).addTo(map);

        // ç»‘å®šå¸¦æœ‰äººæ ¼éš”ç¦»çš„ç‚¹å‡»äº‹ä»¶
        marker.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            showStopLog(p); 
        });
    });
    
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", pathD);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "#FFFFFF");
    path.setAttribute("stroke-width", "1.2");
    path.setAttribute("stroke-dasharray", "4,4");
    path.setAttribute("opacity", "0.5");
    svg.appendChild(path);

    map.on('move', () => {
         let newPathD = "";
         route.forEach((p, i) => {
             const point = map.latLngToContainerPoint([p.lat, p.lng]);
             newPathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
         });
         path.setAttribute("d", newPathD);
    });
}
/**
 * 1. UI è”åŠ¨ï¼šæ›´æ–°æ–‡å­—ä¸æ»‘åŠ¨æ¡å¡«å……è¿›åº¦
 */
function updateStopsUI(el) {
    const val = parseInt(el.value);
    const display = document.getElementById('stops-val-display');
    const paddedVal = val.toString().padStart(2, '0');
    display.textContent = `${paddedVal} SESSIONS`;

    // ğŸš¨ æ ¸å¿ƒçº åï¼šä½¿ç”¨åŠ¨æ€ max ä¿è¯è¿›åº¦æ¡é¢œè‰²åŒæ­¥
    const min = parseFloat(el.min);
    const max = parseFloat(el.max);
    const percent = ((val - min) / (max - min)) * 100;
    el.style.backgroundSize = percent + '% 100%';
}
// ğŸš¨ å°†åˆå§‹åŒ–è¡¥ä¸è´´åœ¨è¿™é‡Œ
document.addEventListener('DOMContentLoaded', () => {
    console.log("System: æ­£åœ¨æ ¡å‡†æ—¶ç©ºæ»‘å—ç‰©ç†å‚æ•°...");
    const s = document.getElementById('travel-stops-slider');
    if(s) updateStopsUI(s);
});
// ==========================================
// ğŸ” èŠå¤©è®°å½•æœç´¢å¼•æ“ (å‡½æ•°å£°æ˜ç‰ˆ)
// ==========================================

var currentSearchFilter = 'all';

// 1. æ‰“å¼€æœç´¢é¡µå…¥å£
function openChatSearchPage() {
    var contact = window.currentChattingWith;
    if(!contact) return showToast("âš ï¸ æœªé”å®šè§’è‰²");
    
    document.getElementById('chat-search-input').value = "";
    document.getElementById('chat-search-results').innerHTML = "";
    document.getElementById('search-result-count').textContent = "æ­£åœ¨æ£€ç´¢ä¸ " + contact.name + " çš„ç¾ç»Š...";
    
    openSubPage('subpage-chat-search');
}

// 2. æ‰§è¡Œæœç´¢æ ¸å¿ƒé€»è¾‘
async function executeChatSearch() {
    var queryInput = document.getElementById('chat-search-input');
    var query = queryInput.value.trim().toLowerCase();
    var container = document.getElementById('chat-search-results');
    var contact = window.currentChattingWith;
    
    if(!query) {
        container.innerHTML = "";
        document.getElementById('search-result-count').textContent = "è¯·è¾“å…¥å…³é”®è¯";
        return;
    }

    // ä»æ•°æ®åº“è·å–å†å²è®°å½•
    var history = await getChatHistory(contact.id);
    
    // æ‰§è¡Œè¿‡æ»¤
    var results = history.filter(function(m) {
        var matchText = m.text.toLowerCase().indexOf(query) !== -1;
        var matchRole = (currentSearchFilter === 'all') || (m.role === currentSearchFilter);
        return matchText && matchRole && !m.recalled;
    });

    // å€’åºæ’åˆ—ï¼Œæœ€è¿‘çš„æ¶ˆæ¯åœ¨å‰
    results.reverse();

    document.getElementById('search-result-count').textContent = "å…±æ‰¾åˆ° " + results.length + " æ¡ç›¸å…³è®°å¿†";

    if(results.length === 0) {
        container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#bbb; font-size:14px;">ç©ºç©ºå¦‚ä¹Ÿï¼Œè¿™æ®µè¯æ±‡å°šæœªåœ¨å‘½è¿ä¸­å‡ºç°</div>';
        return;
    }

    // æ¸²æŸ“ç»“æœåˆ—è¡¨
    container.innerHTML = results.map(function(m) {
        var timeStr = new Date(m.timestamp).toLocaleString();
        
        // ç‰©ç†é«˜äº®å¤„ç†ï¼šå°† HTML æ ‡ç­¾è½¬ä¹‰é˜²æ­¢æ³¨å…¥ï¼Œç„¶åæ›¿æ¢å…³é”®è¯
        var safeText = m.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        var regex = new RegExp('(' + query + ')', 'gi');
        var highlightedText = safeText.replace(regex, '<span class="highlight-word">$1</span>');
        
        var senderLabel = (m.role === 'user') ? 'YOU' : contact.name.toUpperCase();
        
        return [
            '<div class="search-result-item ' + m.role + '" onclick="locateChatMessage(' + m.timestamp + ')">',
                '<div class="search-meta">',
                    '<span>' + senderLabel + '</span>',
                    '<span>' + timeStr + '</span>',
                '</div>',
                '<div class="search-text-preview">' + highlightedText + '</div>',
            '</div>'
        ].join('');
    }).join('');
}

// 3. ç‚¹å‡»ç»“æœå®šä½
// ==========================================
// ğŸ“ ç²¾å‡†å®šä½è¿æ‹› (Physical Direct-Link)
// ==========================================

function locateChatMessage(timestamp) {
    // 1. ç‰©ç†è¿æ‹›ï¼šä¾æ¬¡å…³é—­æ‰€æœ‰è¦†ç›–å±‚ï¼Œå›åˆ°èŠå¤©å®¤ä¸»ä½“
    closeSubPage('subpage-chat-search'); // å…³é—­æœç´¢é¡µ
    closeChatSettings();                 // ğŸš¨ å…³é”®ï¼šå¿…é¡»å…³é—­èŠå¤©è®¾ç½®é¡µï¼Œå¦åˆ™ä½ çœ‹ä¸åˆ°èŠå¤©å®¤ï¼

    // 2. ç‰©ç†å®šä½
    var targetId = "msg-" + timestamp;
    var targetEl = document.getElementById(targetId);
    var container = document.getElementById('chat-messages-container');

    if (targetEl && container) {
        // 3. å¼ºåˆ¶æ‰§è¡Œï¼šç¨å¾®å»¶è¿Ÿ 100ms ç¡®ä¿è®¾ç½®é¡µå…³é—­çš„åŠ¨ç”»ä¸å¹²æ‰°æ»šåŠ¨
        setTimeout(function() {
            // æ‰§è¡Œç‰©ç†æ»šåŠ¨
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 4. è§†è§‰é«˜äº®é—ªçƒ
            var bubble = targetEl.querySelector('.bubble');
            if (bubble) {
                bubble.style.transition = "all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                bubble.style.boxShadow = "0 0 30px #007AFF"; // å¼ºè“å…‰
                bubble.style.transform = "scale(1.1)";
                
                setTimeout(function() {
                    bubble.style.boxShadow = "";
                    bubble.style.transform = "";
                }, 1200);
            }
        }, 150);
        
        showToast("å·²å›æº¯è‡³è¯¥ç‰‡æ®µ");
    } else {
        // 5. å…œåº•æ–¹æ¡ˆï¼šå¦‚æœ DOM é‡Œæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜æ¶ˆæ¯æ²¡æ¸²æŸ“ï¼ˆé€šå¸¸ä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºéƒ½åœ¨ IndexedDB é‡Œï¼‰
        showToast("âš ï¸ è®°å¿†é“¾è·¯æ­£åœ¨é‡ç»„ï¼Œè¯·é‡è¯•");
    }
}

// 4. åˆ‡æ¢è§’è‰²ç­›é€‰å™¨
function setSearchFilter(filter, el) {
    currentSearchFilter = filter;
    
    // è§†è§‰åé¦ˆï¼šé‡ç½®æ‰€æœ‰æ ‡ç­¾æ ·å¼
    var tags = document.querySelectorAll('#subpage-chat-search .city-tag');
    tags.forEach(function(t) {
        t.style.background = "#fff";
        t.style.color = "#1d1d1f";
    });
    
    // æ¿€æ´»å½“å‰æ ‡ç­¾æ ·å¼
    if (el) {
        el.style.background = "#1d1d1f";
        el.style.color = "#fff";
    }
    
    // é‡æ–°è§¦å‘æœç´¢
    executeChatSearch();
}
// ==========================================
// ğŸ’ èŠå¤©å®¤åŠŸèƒ½é¢æ¿æ§åˆ¶å¼•æ“
// ==========================================

function toggleFeaturePanel() {
    var panel = document.getElementById('chat-feature-panel');
    var container = document.getElementById('chat-messages-container');
    
    if (panel.classList.contains('active')) {
        panel.classList.remove('active');
    } else {
        // ğŸš¨ æ ¸å¿ƒï¼šå¦‚æœæ­£åœ¨è¾“å…¥æ–‡å­—ï¼ˆé”®ç›˜å¼€ç€ï¼‰ï¼Œå…ˆæ”¶èµ·é”®ç›˜å†å¼¹é¢æ¿
        document.getElementById('chat-input-main').blur();
        
        panel.classList.add('active');
        
        // å»¶è¿Ÿæ»šåŠ¨ï¼Œç­‰é¢æ¿é¡¶èµ·è¾“å…¥æ¡†åå†ç®—é«˜åº¦
        setTimeout(function() {
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }, 300);
    }
}

// ==========================================
// ğŸš€ å…¨åŠŸèƒ½è·¯ç”±ï¼šå¤„ç†â€œæ›´å¤šâ€é¢æ¿ä¸­çš„ç‚¹å‡»äº‹ä»¶
// ==========================================
function handleFeature(type) {
    console.log(`%c[Feature] è§¦å‘åŠŸèƒ½: ${type}`, "color: #007AFF; font-weight: bold;");
    
    switch(type) {
        case 'Emoji':
            // ğŸš¨ ä¿®æ­£ï¼šç›´æ¥è°ƒç”¨ç‚¹å‡»å¤„ç†å‡½æ•°
            window.handleEmojiButtonClick(); 
            break;
            
        case 'Gallery':
            document.getElementById('modal-image-picker').style.display = 'flex';
            toggleFeaturePanel(); // å‘é€å›¾ç‰‡å‰æ”¶èµ·é¢æ¿
            break;

        case 'Voice':
            // 1. æ‰“å¼€è¯­éŸ³è¾“å…¥å¼¹çª—
            document.getElementById('voice-text-in').value = ""; // æ¸…ç©º
            document.getElementById('modal-voice-input').style.display = 'flex';
            toggleFeaturePanel(); // æ”¶èµ·åº•éƒ¨é¢æ¿
            break;

        case 'Location':
            showToast("æ­£åœ¨è·å–é‡å­åœ°ç†åæ ‡...");
            break;

        // ... å…¶ä»–åŠŸèƒ½ä¿æŒåŸæ · ...
        default:
            showToast(type + " protocol starting...");
    }
}
// 2. æ ¸å¿ƒï¼šé‡å†™ handleFeature å‡½æ•°ï¼ŒæŠŠæŒ‰é’®å’Œ Modal è¿èµ·æ¥
window.handleFeature = function(type) {
    if (type === 'Location') {
        ensureLocationModal(); // ç¡®ä¿ HTML å‡†å¤‡å¥½äº†
        const overlay = document.getElementById('lune-location-overlay');
        overlay.style.display = 'flex';
        
        // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
        setTimeout(() => document.getElementById('loc-main-input').focus(), 100);
        
        if (window.navigator.vibrate) window.navigator.vibrate(15);
        console.log("System: Location protocol engaged.");
    }
};

// ğŸš¨ è¡¥å……ï¼šç‚¹å‡»æ¶ˆæ¯åŒºåŸŸæ—¶ï¼Œè‡ªåŠ¨å…³é—­é¢æ¿ï¼Œæå‡äº¤äº’æ„Ÿ
document.getElementById('chat-messages-container').addEventListener('click', function() {
    var panel = document.getElementById('chat-feature-panel');
    if (panel && panel.classList.contains('active')) {
        panel.classList.remove('active');
    }
});
// ==========================================
// ğŸ–¼ï¸ Gallery å›¾ç‰‡å‘é€å¼•æ“
// ==========================================

// 2. æ‰§è¡Œå‘é€
async function sendImageMessage(mode) {
    const contact = window.currentChattingWith;
    if (!contact) return;

    let imgData = "";

    if (mode === 'url') {
        imgData = document.getElementById('chat-img-url-in').value.trim();
        if (!imgData) return;
    } else {
        const file = document.getElementById('chat-img-file-in').files[0];
        if (!file) return;
        imgData = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
    }

    // æ„é€ å›¾ç‰‡æ¶ˆæ¯å¯¹è±¡ (type: 'image')
    const msgObj = {
        role: "user",
        text: imgData, 
        type: "image", // ğŸš¨ å…³é”®æ ‡è®°ï¼šå‘Šè¯‰æ¸²æŸ“å™¨è¿™æ˜¯å›¾ç‰‡
        timestamp: Date.now()
    };

    await saveChatMessage(contact.id, msgObj);
    renderMessages(); // åˆ·æ–° UI
    
    document.getElementById('modal-image-picker').style.display = 'none';
    document.getElementById('chat-img-url-in').value = "";
    
    // æ¨¡æ‹Ÿ AI çœ‹åˆ°å›¾åçš„ååº” (å¯é€‰)
    setTimeout(() => triggerAiResponseToImage(), 1000);
}

// ==========================================
// ğŸ› ï¸ å…¨åŸŸè§£æå¼•æ“ï¼šç‰©ç†éš”ç¦»å¼•ç”¨ä¸ç¿»è¯‘
// ==========================================
function parseMessageContent(rawText) {
    let result = { displayMain: rawText, quoteHtml: "", transHtml: "", isDual: false };
    
    // 1. æ‹¦æˆªå¹¶æå– QUOTE åè®®
    const regexQuote = /\[?QUOTE:\s*([\s\S]*?)\]/;
    const matchQuote = result.displayMain.match(regexQuote);
    if (matchQuote) {
        let quoteContent = matchQuote[1].trim().replace(/^QUOTE:\s*/i, "");
        result.quoteHtml = `<div class="bubble-quote-box">
                                <div style="font-weight:800; font-size:9px; opacity:0.4; letter-spacing:1px; margin-bottom:4px;">REFERENCE</div>
                                <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;">${quoteContent}</div>
                             </div>`;
        // ç‰©ç†æ¸…ç†æ­£æ–‡ä¸­çš„åè®®ï¼Œå¹¶ä¿®å‰ªå¤šä½™çš„ ] ç¬¦å·
        result.displayMain = result.displayMain.replace(regexQuote, "").replace(/^\]\s*/, "").trim();
    }

    // 2. æ‹¦æˆªå¹¶æå– TRANS åè®®
    if (result.displayMain.includes('[TRANS]')) {
        const parts = result.displayMain.split('[TRANS]');
        result.displayMain = parts[0].trim();
        let displayTrans = parts[1] ? parts[1].trim() : "";
        result.isDual = true;
        result.transHtml = `
            <div class="bubble-translation-box" style="display:block;">
                <div class="trans-line"></div>
                <div class="msg-text-trans">${displayTrans}</div>
            </div>
            <div class="trans-toggle-btn" onclick="toggleTranslation(this, event)">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"></polyline></svg>
                <span>ç¿»è¯‘</span>
            </div>`;
    }
    
    return result;
}
/**
 * ğŸ”“ 1. å¼€å¯è¡¨æƒ…ç®¡ç†å™¨
 */
function openEmojiManager() {
    const modal = document.getElementById('modal-emoji-manager');
    if (!modal) return;
    
    // åˆå§‹åŒ–æ¸…ç©º
    document.getElementById('emoji-tag-in').value = "";
    document.getElementById('emoji-pre-img').style.display = 'none';
    document.getElementById('emoji-pre-placeholder').style.display = 'block';
    window.tempEmojiData = null; 

    modal.style.display = 'flex';
}

/**
 * ğŸ‘ï¸ 2. å¤„ç†å³æ—¶é¢„è§ˆ
 */
function handleEmojiPre(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        showToast("æ­£åœ¨è§£æé‡å­åƒç´ ..."); // è°ƒç”¨ä½ åŸæœ¬çš„æç¤ºå‡½æ•°

        reader.onload = function(e) {
            window.tempEmojiData = e.target.result;
            const img = document.getElementById('emoji-pre-img');
            const placeholder = document.getElementById('emoji-pre-placeholder');
            
            if (img && placeholder) {
                img.src = e.target.result;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

/**
 * ğŸ’¾ 3. ä¿å­˜é€»è¾‘
 */
/**
 * ğŸ›°ï¸ æ–°è¡¨æƒ…å­˜æ ¹åè®® (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šå°†æ–°çš„è¡¨æƒ…åŒ…åŠå…¶æ ‡ç­¾å‹å…¥å…¨åŸŸè¡¨æƒ…åº“æ•°ç»„
 */
async function saveNewEmoji() {
    const tag = document.getElementById('emoji-tag-in').value.trim();
    const data = window.tempEmojiData;

    if (!tag || !data) {
        showToast("âš ï¸ æ ‡ç­¾å’Œå›¾ç‰‡ç¼ºä¸€ä¸å¯");
        return;
    }

    try {
        // --- ğŸš¨ 1. è·å–ç°æœ‰è¡¨æƒ…åº“æ•°ç»„ (Key: emoji_library) ---
        let emojiList = await window.ib.getItem('emoji_library') || [];

        // 2. æ£€æŸ¥æ ‡ç­¾æ˜¯å¦é‡å¤ (é€»è¾‘åŠ å›ºï¼šå¦‚æœæ ‡ç­¾å·²å­˜åœ¨ï¼Œåˆ™è¦†ç›–æ—§å›¾)
        const existingIdx = emojiList.findIndex(e => e.tag === tag);
        const newEntry = { tag: tag, data: data };

        if (existingIdx !== -1) {
            emojiList[existingIdx] = newEntry; // è¦†ç›–æ—§ç‰ˆæœ¬
        } else {
            emojiList.push(newEntry); // è¿½åŠ æ–°è¡¨æƒ…
        }

        // --- ğŸš¨ 3. ç‰©ç†è¦†å†™å›æ–°åº“ ---
        await window.ib.setItem('emoji_library', emojiList);

        // --- ğŸš€ UI çŠ¶æ€åˆ·æ–° (ç…§æŠ„åŸæœ‰é€»è¾‘) ---
        const managerModal = document.getElementById('modal-emoji-manager');
        if (managerModal) managerModal.style.display = 'none';
        
        // è°ƒç”¨æˆåŠŸ HUD
        if(window.triggerSuccessHud) {
            triggerSuccessHud("è¡¨æƒ…å­˜æ ¹å·²å°å­˜");
        }
        
        // å¼ºåˆ¶åˆ·æ–°ä¸»å¼¹çª—é‡Œçš„ç½‘æ ¼æ¸²æŸ“
        if(typeof window.renderEmojiGrid === 'function') {
            await window.renderEmojiGrid();
        }

        // æ¸…ç©ºä¸´æ—¶æ•°æ®ï¼Œé˜²æ­¢ä¸‹æ¬¡è¯¯å­˜
        window.tempEmojiData = null;

    } catch (e) {
        console.error("[Database] è¡¨æƒ…åŒ…å­˜å…¥å¼‚å¸¸:", e);
        showToast("âŒ å­˜å…¥å¤±è´¥");
    }
}

// ğŸš¨ å¼ºåˆ¶å…¨å±€æŒ‚è½½ï¼Œç¡®ä¿ onclick ç»å¯¹å¯ç”¨
window.openEmojiManager = openEmojiManager;
window.handleEmojiPre = handleEmojiPre;
window.saveNewEmoji = saveNewEmoji;
/**
 * ğŸ“¤ å‘é€è¡¨æƒ…æ¶ˆæ¯
 * @param {string} tag - è¡¨æƒ…çš„è§¦å‘å…³é”®è¯
 * ä½œç”¨ï¼šä»åº“ä¸­æå–äºŒè¿›åˆ¶æ•°æ®ï¼Œå°å­˜ä¸ºæ¶ˆæ¯èŠ‚ç‚¹å¹¶æ¸²æŸ“
 */
/**
 * ğŸ›°ï¸ è¡¨æƒ…ç‰‡æ®µå‘å°„åè®® (é€‚é…æ–°åº“ window.ib)
 * ä½œç”¨ï¼šä»å…¨åŸŸåº“ä¸­æå–æŒ‡å®šæ ‡ç­¾çš„å›¾åƒæ•°æ®ï¼Œå¹¶å°†å…¶ä½œä¸º image æ¶ˆæ¯å‘å°„
 */
async function sendEmojiMessage(tag) {
    console.log(`%c[Signal] æ­£åœ¨æå–è¡¨æƒ…ç‰‡æ®µ: ${tag}`, "color: #007AFF; font-weight: bold;");

    const contact = window.currentChattingWith;
    if (!contact) {
        showToast("âš ï¸ æœªè¯†åˆ«åˆ°æ¥æ”¶è€…é“¾è·¯");
        return;
    }

    try {
        // --- ğŸš¨ 1. ç‰©ç†è¿æ¥æ–°åº“ï¼šæå–å…¨åŸŸè¡¨æƒ…æ•°ç»„ ---
        const emojiList = await window.ib.getItem('emoji_library') || [];
        
        // --- ğŸš¨ 2. æ£€ç´¢å¯¹åº”æ ‡ç­¾çš„å›¾åƒæ•°æ® ---
        // ç”±äºæ–°åº“æ˜¯æ•°ç»„å­˜å‚¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ find è¿›è¡Œå†…å­˜æ£€ç´¢
        const emoji = emojiList.find(e => e.tag === tag);

        if (!emoji) {
            showToast("âŒ ç¢ç‰‡å·²ä¸¢å¤±");
            return;
        }

        // 3. æ„å»ºæ ‡å‡†æ¶ˆæ¯å¯¹è±¡ (ç±»å‹é”å®šä¸º image)
        const msgObj = {
            role: "user",
            text: emoji.data,    // è¿™é‡Œå­˜çš„æ˜¯å›¾ç‰‡çš„ Base64 æ•°æ®
            type: "image",       // ğŸš¨ æ ¸å¿ƒï¼šå¿…é¡»æ ‡è®°ä¸º image ç±»å‹ï¼Œå¦åˆ™æ¸²æŸ“å™¨ä¼šæŠŠå®ƒå½“æˆçº¯æ–‡æœ¬
            timestamp: Date.now(),
            isEmoji: true,       // é¢å¤–æ ‡è®°ï¼Œæ–¹ä¾¿åæœŸåšç‰¹æ®Šå¤„ç†
            source: 'chat_room'  // æ ‡è®°æ¥æºé¢‘é“
        };

        // 4. ç‰©ç†å†™å…¥èŠå¤©å†å²æ•°æ®åº“ (ä½¿ç”¨å·²é€‚é…æ–°åº“çš„ saveChatMessage)
        await saveChatMessage(contact.id, msgObj);

        // 5. åŒæ­¥ UI æ¸²æŸ“
        if (typeof window.renderMessages === 'function') {
            window.renderMessages();
        } else if (typeof window.appendMessageToUI === 'function') {
            window.appendMessageToUI(msgObj, contact);
        }

        // 6. è‡ªåŠ¨å…³é—­è¡¨æƒ…å¼¹çª— (ä»ªå¼æ„Ÿæ”¶å°¾)
        if (typeof window.closeEmojiModal === 'function') {
            window.closeEmojiModal();
        }

        // 7. è§¦å‘å®¡è®¡ (å¦‚æœå¼€äº†è‡ªåŠ¨æ€»ç»“ï¼Œè¿™é‡Œä¼šè®°å½•)
        if (window.autoSummaryAuditor) {
            window.autoSummaryAuditor(contact.id);
        }

        console.log("âœ… è¡¨æƒ…ç‰‡æ®µå‘é€æˆåŠŸ");

    } catch (e) {
        console.error("Critical Send Error:", e);
        showToast("âš ï¸ å‘é€åè®®å†²çª: " + e.message);
    }
}

// ğŸš¨ ç‰©ç†æŒ‚è½½ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹ç”Ÿæ•ˆ
window.sendEmojiMessage = sendEmojiMessage;

// 3. ç‹¬ç«‹é€‰æ‹©ï¼šæ¨¡å‹å¼¹çª—
function openVoiceModelPicker() {
    if (!window.availableModels || window.availableModels.length === 0) {
        alert("è¯·å…ˆç‚¹å‡» FETCH æŒ‰é’®");
        return;
    }

    var opts = window.availableModels.map(function(m) {
        return { l: m.name, v: m.id };
    });

    renderNoirPicker("SELECT SPEECH MODEL", opts, function(v, l) {
        window.currentVoiceModel = v;
        document.getElementById('calib-model-display').textContent = v;
    });
}
// ğŸ§  ç¿»è¯‘æ ¸å¿ƒï¼šæŠŠç”¨æˆ·çš„å¤–è¯­ç¿»è¯‘æˆä¸­æ–‡
async function autoTranslateUserText(text) {
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) return ""; // æ²¡ Key å°±ä¸ç¿»äº†

    try {
        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [
                    { 
                        role: "system", 
                        // å¼ºåˆ¶æŒ‡ä»¤ï¼šåªç¿»è¯‘ï¼Œä¸è§£é‡Šï¼Œä¸åŠ æ ‡ç‚¹ä»¥å¤–çš„ç¬¦å·
                        content: "Translate the following text into Simplified Chinese. Output ONLY the translation. If it is already Chinese, output the original." 
                    },
                    { role: "user", content: text }
                ],
                temperature: 0.3
            })
        });
        const data = await res.json();
        return data.choices[0].message.content.trim();
    } catch (e) {
        console.error("Auto Trans Error:", e);
        return ""; // å¤±è´¥äº†å°±è¿”å›ç©ºï¼Œä¸å½±å“å‘é€
    }
}
/* =========================================================
   ğŸ–¼ï¸ ç›¸å†Œ App æ ¸å¿ƒé€»è¾‘ (æ ‡å‡†å‡½æ•°ç‰ˆ)
   ========================================================= */

/* =========================================================
   ğŸ–¼ï¸ ç›¸å†Œ App æ ¸å¿ƒé€»è¾‘ (ç‹¬ç«‹ä¿®å¤ç‰ˆ)
   ========================================================= */

function openPhotosApp() {
    console.log("System: æ­£åœ¨å¯åŠ¨ç›¸å†Œ...");

    // 1. ç‰©ç†è·å–å…ƒç´ 
    const app = document.getElementById('app-photos');

    // 2. é”™è¯¯æ‹¦æˆª
    if (!app) {
        console.error("âŒ æ‰¾ä¸åˆ° id='app-photos' çš„å…ƒç´ ï¼");
        return;
    }

    // 3. æ˜¾å½¢
    app.style.display = 'flex';
    void app.offsetWidth; // å¼ºåˆ¶é‡ç»˜
    app.classList.add('active');

    // 4. å°è¯•æ¸²æŸ“æ•°æ®
    if (typeof renderUserPhotos === 'function') {
        renderUserPhotos(); 
    }
}

/**
 * ğŸ”„ åˆ‡æ¢ Tab (æˆ‘çš„ / Taçš„) 
 * é€»è¾‘ï¼šæˆ‘çš„ -> æ—¶é—´è½´ç…§ç‰‡ | Taçš„ -> è§’è‰²ç›¸å†Œé›†åˆ—è¡¨
 */
async function switchPhotoTab(type) {
    const caps = document.querySelectorAll('.photos-bottom-capsule .nav-item');
    const gridView = document.getElementById('photos-grid-view');
    const emptyState = document.getElementById('photos-empty-state');
    const titleEl = document.querySelector('.photos-title-large'); // é¡¶éƒ¨å¤§æ ‡é¢˜
    const addBtn = document.querySelector('.photos-add-btn');

    // 1. åˆ‡æ¢æŒ‰é’®é«˜äº®
    if (caps.length >= 2) {
        caps[0].classList.toggle('active', type === 'mine');
        caps[1].classList.toggle('active', type === 'theirs');
    }

    if (type === 'mine') {
        if(titleEl) titleEl.textContent = "Photos";
        if(addBtn) addBtn.parentElement.style.display = 'flex'; 
        renderUserPhotos(); // åŸæœ‰çš„æ—¶é—´è½´æ¸²æŸ“
    } else {
        if(titleEl) titleEl.textContent = "Galleries";
        if(addBtn) addBtn.parentElement.style.display = 'none'; // åˆ«äººçš„ç›¸å†Œä¸è®¸ä¼ å›¾
        
        // --- ğŸš€ æ ¸å¿ƒæ¸²æŸ“ï¼šTaçš„è§’è‰²ç›¸å†Œåˆ—è¡¨ ---
        gridView.innerHTML = "";
        gridView.style.display = "block"; // å—çº§æ’ç‰ˆ
        
        const friends = await loadFromDB('chat_friends') || [];
        if (friends.length === 0) {
            gridView.innerHTML = `<div style="padding:100px 40px; text-align:center; color:#999;">å°šæœªå‘ç°å…¶ä»–ç»´åº¦çš„ç›¸å†Œè®°å½•...</div>`;
            return;
        }

        friends.forEach(f => {
            const card = document.createElement('div');
            card.className = 'char-gallery-card';
            
            // æ¨¡æ‹Ÿç…§ç‰‡æ•°é‡ï¼ˆæˆ–è€…ä½ ä»¥åå¯ä»¥çœŸçš„å­˜ Ta å‘çš„ç…§ç‰‡æ•°é‡ï¼‰
            const mockCount = Math.floor(Math.random() * 20) + 5;

            card.innerHTML = `
                <div class="gallery-card-bg" style="background-image: url('${f.avatar}')"></div>
                <div class="gallery-card-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <div class="gallery-card-info">
                    <div class="gallery-char-name">${f.name}</div>
                    <div class="gallery-photo-count">${mockCount} PIXELS</div>
                </div>
            `;
            
            card.onclick = () => openCharGallery(f);
            gridView.appendChild(card);
        });
    }
    if (type === 'mine') {
        renderUserPhotos();
    } else {
        renderTheirsGalleries(); // ğŸ‘ˆ è°ƒç”¨é‡å¡‘åçš„æ¸²æŸ“å¼•æ“
    }
}

// ğŸ“¸ ä¿®æ­£ï¼šç»Ÿè®¡ AI ç”Ÿæˆçš„ç…§ç‰‡æ•°é‡ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡
async function renderTheirsGalleries() {
    const gridView = document.getElementById('photos-grid-view');
    if (!gridView) return;

    // ğŸš¨ æ ¸å¿ƒä¿®æ­£ï¼šè¯»å– AI è§’è‰²ç…§ç‰‡åº“
    const friends = await loadFromDB('chat_friends') || [];
    const aiPhotos = JSON.parse(localStorage.getItem('user_char_galleries')) || [];

    gridView.innerHTML = "";
    gridView.style.display = "block"; 

    if (friends.length === 0) {
        gridView.innerHTML = `<div style="padding:100px 40px; text-align:center; color:#999;">å°šæœªæ•è·åˆ°å…¶ä»–ç»´åº¦çš„ç”»å†Œ...</div>`;
        return;
    }

    friends.forEach(f => {
        // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šç²¾å‡†ç­›é€‰å±äºå½“å‰è§’è‰²çš„ AI ç¬é—´æ•°é‡
        const charPhotoCount = aiPhotos.filter(p => p.charId === f.id).length;
        
        const card = document.createElement('div');
        card.className = 'char-gallery-card';
        
        card.innerHTML = `
            <div class="gallery-inner-container">
                <div class="gallery-card-bg" style="background-image: url('${f.avatar}')"></div>
                <div class="gallery-top-info">
                    <span class="gallery-type-tag">Exclusive Gallery</span>
                </div>
                <div class="gallery-info-pod">
                    <div class="gallery-char-name">${f.name}</div>
                    <div class="gallery-stat-chip">
                        <span class="stat-num">${charPhotoCount}</span>
                        <span class="stat-label">PIXELS</span>
                    </div>
                </div>
            </div>
        `;
        
        card.onclick = () => openCharGallery(f);
        gridView.appendChild(card);
    });
}

/**
 * 1. å¼€å¯è§’è‰²ç›¸å†Œå±•å…
 */
async function openCharGallery(char) {
    window.currentViewingChar = char;
    document.getElementById('gallery-char-name-ui').textContent = char.name;
    document.getElementById('gallery-char-bio-ui').textContent = char.desc || "æ­¤äººæ ¼å°šæœªå†™å…¥åº•å±‚å™äº‹ã€‚";
    
    generateCharBioIntro(char);
    
    // åŠ è½½å†å²ç…§ç‰‡
    renderCharHistoryGrid(char.id);
    
    openSubPage('page-char-gallery');
    renderDailyStatusFlow();
}

// --- [Core] AI Generation Logic ---

// å…³é”®ä¿®æ”¹ï¼šå¢åŠ  injectedTime å‚æ•°ï¼Œä¸å†è‡ªå·± new Date()
async function generateAIPortrait(injectedTime) {
    // å¦‚æœæ˜¯æ‰‹åŠ¨ç‚¹å‡»è§¦å‘ï¼Œå¯èƒ½æ²¡æœ‰ä¼ å‚ï¼Œæ‰‹åŠ¨è¡¥ä¸€ä¸ª
    if (!injectedTime) injectedTime = getAppLocalTime();

    const char = window.currentViewingChar;
    const container = document.getElementById('ai-portrait-container');
    const scanLine = document.getElementById('ai-scan-line');
    const proseEl = document.getElementById('theirs-prose-body'); 
    
    console.log(`ğŸ“¸ AI Generating for: ${char.name} at Time: ${injectedTime.fullString}`);

    // UI æ˜¾ç¤ºé€»è¾‘
    if (container) container.style.display = 'block';
    if (scanLine) {
        scanLine.style.display = 'block';
        scanLine.style.background = "linear-gradient(to right, transparent, #007AFF, transparent)";
    }
    
    const proseUi = document.getElementById('ai-prose-ui');
    if (proseUi) proseUi.innerHTML = `<div class="ai-prose-text" style="opacity:0.5">Syncing ${char.name}'s data stream...</div>`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯æ·±å¤œ (0ç‚¹åˆ°5ç‚¹)
        const isMidnight = injectedTime.hour >= 0 && injectedTime.hour < 5;

        // ğŸ§  æ ¸å¿ƒ Promptï¼šå¼ºåˆ¶éäººç±»è§†è§’ & æ³¨å…¥å‡†ç¡®æ—¶é—´
        const prompt = `
# Role: é¡¶çº§ç§‘å¹»å°è¯´å®¶ / èµ›åšæœ‹å…‹è§†è§‰å¯¼æ¼”
# Task: åŸºäºç²¾å‡†æ—¶é—´ï¼Œç”Ÿæˆè§’è‰² [${char.name}] çš„å®æ—¶çŠ¶æ€â€œå¿«ç…§â€ã€‚

# Context (Absolute Truth):
- User Timezone: ${appSettings.userTimezone}
- Current Time: ${injectedTime.aiString} (24h format)
- Mode: ${isMidnight ? 'Midnight / Maintenance / Standby' : 'Active / Processing'}

# Character Settings:
${char.desc}
(WARNING: strict adherence to non-human traits if applicable. If character is AI/Code/App, describe data flows, server racks, silent cooling fans, binary streams. DO NOT describe human sleep, skin, or breathing.)

# Instruction:
è¾“å‡ºä¸€æ®µ 100 å­—å·¦å³çš„æè‡´å”¯ç¾æå†™ã€‚
1. **å†…å®¹**: æ¯”å¦‚â€œ00:00ï¼Œæ•°æ®å½’æ¡£å®Œæˆï¼Œåå°è¿›ç¨‹é™é»˜ï¼ŒæŒ‡ç¤ºç¯å¦‚å‘¼å¸èˆ¬é—ªçƒâ€ã€‚
2. **æ–‡é£**: å†·å³»ã€ç”µå­æ„Ÿã€é«˜æ™ºå•†ã€‚
3. **æ ¼å¼**: ç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œä¸è¦ Emojiï¼Œä¸è¦è§£é‡Šã€‚
`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [
                    { role: "system", content: "You are a digital consciousness observer. You strictly describe non-human characters using technological metaphors (data, electricity, light), not biological ones." }, 
                    { role: "user", content: prompt }
                ],
                temperature: 0.8
            })
        });

        const data = await res.json();
        if (!data.choices) throw new Error("API Response Empty");
        const description = data.choices[0].message.content.trim();

        // å­˜æ¡£é€»è¾‘
        const newSnap = {
            id: "snap_" + Date.now(),
            charId: char.id,
            type: "portrait",
            description: description,
            date: Date.now(),
            displayTime: injectedTime.fullString, // å­˜å…¥å½“æ—¶çš„æ—¶é—´å­—ç¬¦ä¸²
            thumb: char.avatar
        };

        let galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
        galleryDB.unshift(newSnap);
        localStorage.setItem('user_char_galleries', JSON.stringify(galleryDB));

        // UI æ¸²æŸ“
        if (proseEl) proseEl.innerHTML = `<div class="ai-prose-text">${description}</div>`;
        if (typeof renderCharHistoryGrid === 'function') renderCharHistoryGrid(char.id);
        if (scanLine) scanLine.style.display = 'none';
        
        // æˆåŠŸæç¤º
        console.log("âœ… ç”ŸæˆæˆåŠŸ");

    } catch (e) {
        console.error("AI Error:", e);
        if (scanLine) scanLine.style.display = 'none';
        if (proseEl) proseEl.innerHTML = `<div class="ai-prose-text" style="color:red; opacity:0.7">Link Lost.</div>`;
    }
}

/**
 * ğŸï¸ æ¸²æŸ“å†å²ç¼©ç•¥å›¾ï¼šåŠ å…¥å¹´æœˆæ—¥æ—¶é—´è½´æ ‡ç­¾
 */
function renderCharHistoryGrid(charId) {
    const grid = document.getElementById('char-gallery-history');
    const galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    // ç­›é€‰å½“å‰è§’è‰²çš„ç…§ç‰‡
    const charPhotos = galleryDB.filter(p => p.charId === charId);
    
    if (!grid) return;
    grid.innerHTML = "";

    if (charPhotos.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#ccc; font-style:italic; font-size:12px;">â€œæ­¤é—´çš„æ—¶å…‰å°šæœªå‡å›º...â€</div>`;
        return;
    }

    charPhotos.forEach(p => {
        const div = document.createElement('div');
        div.className = 'history-thumb';
        
        // ğŸš¨ ç‰©ç†è®¡ç®—ï¼šå°†æ—¶é—´æˆ³è½¬æ¢ä¸º å¹´.æœˆ.æ—¥ æ ¼å¼
        const d = new Date(p.date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const dateString = `${year}.${month}.${day}`; // æ ¼å¼å¦‚ï¼š2026.01.27

        const briefDesc = p.description ? p.description.substring(0, 10) + "..." : "Untitled";

        div.innerHTML = `
            <div class="thumb-date-tag">${dateString}</div>
            
            <img class="history-thumb-img" src="${p.thumb}">
            <div class="thumb-caption">${briefDesc}</div>
        `;
        
        div.onclick = () => openPhotoDetailFromGallery(p);
        grid.appendChild(div);
    });
}
/**
 * ğŸ” å¼€å¯â€œTaçš„â€ç›¸å†Œè¯¦æƒ…
 */
async function openPhotoDetailFromGallery(snap) {
    window.currentViewingSnapId = snap.id; 
    
    const modal = document.getElementById('modal-theirs-photo-detail');
    const proseEl = document.getElementById('theirs-prose-body');
    const bgEl = document.getElementById('theirs-detail-bg');
    const nameEl = document.getElementById('theirs-char-name');

    // 1. è·å–è§’è‰²æœ€æ–°èµ„æ–™å¹¶ç‰©ç†å¡«å……
    const charList = await loadFromDB('char_list') || [];
    const char = charList.find(c => c.id === snap.charId);
    
    if (nameEl) nameEl.textContent = char ? char.name : "æœªçŸ¥è§’è‰²";
    if (proseEl) proseEl.textContent = snap.description;
    
    // ğŸš¨ æ ¸å¿ƒèƒŒæ™¯ä¿®å¤ï¼šå¦‚æœæ²¡å›¾ï¼Œç”¨é¢œè‰²ä»£æ›¿ï¼Œé˜²æ­¢å‡ºç°ç©ºç™½æˆ–é€å‡ºæ¡Œé¢
    if (bgEl && char) {
        bgEl.style.backgroundImage = `url('${char.avatar}')`;
    } else {
        bgEl.style.background = "#1d1d1f"; 
    }
    
    document.getElementById('theirs-date-title').textContent = new Date(snap.date).toLocaleDateString();
    
    // 2. æ¸²æŸ“è¯„è®º
    if (typeof renderTheirsComments === 'function') renderTheirsComments(snap);

    // 3. ğŸš¨ ç‰©ç†éš”ç¦»ï¼šéšè—ä¸»é¡µå®¹å™¨çš„äº¤äº’
    const homeContainer = document.querySelector('.home-screen-scroll-container');
    if (homeContainer) homeContainer.style.visibility = 'hidden'; // æš‚æ—¶è®©ä¸»é¡µå½»åº•æ¶ˆå¤±

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    if (nameEl) {
        nameEl.style.cursor = "pointer";
        nameEl.onclick = () => mentionChar(nameEl.textContent);
    }
    // åœ¨ openPhotoDetailFromGallery ç»“å°¾å¤„
    document.getElementById('theirs-char-name').onclick = mentionTheirsChar;
}

// 4. å…³é—­æ—¶æ¢å¤ä¸»é¡µ
function closeTheirsPhotoDetail() {
    document.getElementById('modal-theirs-photo-detail').style.display = 'none';
    const homeContainer = document.querySelector('.home-screen-scroll-container');
    if (homeContainer) homeContainer.style.visibility = 'visible'; // æ¢å¤ä¸»é¡µ
    document.body.style.overflow = '';
}

/**
 * ğŸ”— è‡ªåŠ¨è‰¾ç‰¹åŠŸèƒ½
 */
function mentionChar(charName) {
    const input = document.getElementById('theirs-reply-input');
    if (!input) return;
    
    // ç‰©ç†æ³¨å…¥è‰¾ç‰¹æ–‡æœ¬ï¼Œå¹¶è®©è¾“å…¥æ¡†è·å–ç„¦ç‚¹
    input.value = `@${charName} `;
    input.focus();
    
    // å¢åŠ ä¸€ä¸ªå¾®å¼±çš„éœ‡åŠ¨åé¦ˆ
    if (navigator.vibrate) navigator.vibrate(10);
    
    showToast(`æ­£åœ¨å‘¼å”¤ ${charName}...`);
}

/**
 * ğŸ’¬ å‘é€è¯„è®ºå¹¶è§¦å‘ AI å›å¤
 */
async function sendCommentToTheirs() {
    const input = document.getElementById('theirs-reply-input');
    const text = input.value.trim();
    if (!text) return;

    const char = window.currentViewingChar;
    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œå®šä¹‰ isMentioned
    const isMentioned = text.includes(`@${char.name}`);

    // 1. ç”¨æˆ·è¯„è®ºä¸Šå±
    const userPersona = JSON.parse(localStorage.getItem('user_persona_data_global')) || {name: "æˆ‘"};
    const newComment = {
        name: userPersona.name,
        avatar: userPersona.avatar,
        text: text,
        time: Date.now()
    };
    
    appendTheirsCommentUI(newComment);
    input.value = "";

    // 2. é©±åŠ¨ AI å›å¤ (ä¼ é€’å®šä¹‰çš„å˜é‡)
    setTimeout(async () => {
        // ğŸš¨ ç¡®ä¿è¿™é‡Œä¼ å…¥äº† isMentioned
        const reply = await callAIForPhotoReply(char, text, isMentioned); 
        const aiComment = {
            name: char.name,
            avatar: char.avatar,
            text: reply,
            time: Date.now()
        };
        appendTheirsCommentUI(aiComment);
        
        if (isMentioned) {
            triggerSuccessHud(`${char.name} å“åº”äº†ä½ `);
        }
    }, 1500);
}


/**
 * ğŸ¨ è¡¥å…¨æ¸²æŸ“å¼•æ“ï¼šæ¸²æŸ“â€œTaçš„â€ç›¸å†Œè¯„è®º
 */
function renderTheirsComments(snap) {
    const list = document.getElementById('theirs-comments-list');
    if (!list) return;
    list.innerHTML = "";

    const galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    const currentSnap = galleryDB.find(p => p.id === snap.id) || snap;
    const comments = currentSnap.comments || [];

    comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment-row';
        
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç»™æ•´è¡Œæˆ–è€…å¤´åƒ/åå­—ç»‘å®š mentionTheirsChar
        // é€»è¾‘ï¼šå¦‚æœæ˜¯ç”¨æˆ·å‘çš„ï¼ˆc.userId === 'user'ï¼‰ï¼Œä¸è‰¾ç‰¹ï¼›å¦‚æœæ˜¯ Ta å‘çš„ï¼Œç‚¹å‡»å³è‰¾ç‰¹
        const isUser = c.name === "æˆ‘" || c.userId === "user"; 
        const clickAction = !isUser ? `onclick="mentionTheirsChar('${c.name}')"` : "";

        div.innerHTML = `
            <img class="comment-avatar" src="${c.avatar}" ${clickAction} style="cursor:pointer;">
            <div class="comment-bubble" ${clickAction} style="cursor:pointer; background: rgba(0,0,0,0.03);">
                <div class="comment-name">${c.name} <span class="comment-time">${new Date(c.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div>
                <div style="word-break: break-all;">${c.text}</div>
            </div>
        `;
        list.appendChild(div);
    });

    // è‡ªåŠ¨æ»šåŠ¨åˆ°è¯„è®ºåŒºçš„æœ€åº•éƒ¨
    list.scrollTop = list.scrollHeight;
}

/**
 * ğŸ¤– ä¿®æ­£ç‰ˆ AI å›å¤æ ¸å¿ƒ
 */
async function callAIForPhotoReply(char, userText, isMentioned = false) {
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
    
    // ğŸ§  åŠ¨æ€æ„å»ºæ›´æœ‰â€œé’ˆå¯¹æ€§â€çš„ Prompt
    let promptContext = `ä½ æ˜¯ [${char.name}]ã€‚èº«ä»½èƒŒæ™¯: ${char.desc}ã€‚ç”¨æˆ·åœ¨ä½ çš„ç…§ç‰‡ä¸‹è¯„è®ºï¼šâ€œ${userText}â€ã€‚`;
    
    if (isMentioned) {
        promptContext += ` æ³¨æ„ï¼šç”¨æˆ·ç‰¹åˆ« @è‰¾ç‰¹ äº†ä½ ï¼Œè¯´æ˜ Ta æ¸´æœ›ä½ çš„ä¸“å±å›åº”ã€‚ä½ çš„è¯­æ°”è¦æ›´äº²æ˜µã€æ›´å…·äº’åŠ¨æ„Ÿï¼Œå¯ä»¥å¸¦ä¸€ç‚¹ç‚¹è¢«åçˆ±çš„ç¾æ¶©æˆ–éœ¸æ°”ã€‚`;
    }

    const prompt = `${promptContext}
    è¦æ±‚ï¼š
    1. 20å­—ä»¥å†…ï¼Œç¬¦åˆäººè®¾ï¼Œåƒåœ¨æœ‹å‹åœˆäº’åŠ¨ã€‚
    2. ä¸¥ç¦ä½¿ç”¨æ‹¬å·å’Œæ˜Ÿå·ã€‚
    3. ç›´æ¥è¾“å‡ºå›å¤æ­£æ–‡ã€‚`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });
        const data = await res.json();
        return data.choices[0].message.content.trim();
    } catch (e) {
        return isMentioned ? `æˆ‘åœ¨å‘¢ï¼Œ${char.name} æ”¶åˆ°ä½ çš„å‘¼å”¤äº†ã€‚` : "ï¼ˆå¾®ç¬‘ç€çœ‹ç€ä½ çš„è¯„è®ºï¼‰";
    }
}
/**
 * ğŸ”— ç‚¹å‡»åå­—/å¤´åƒè‡ªåŠ¨è‰¾ç‰¹
 */
function mentionTheirsChar() {
    const nameEl = document.getElementById('theirs-char-name');
    const input = document.getElementById('theirs-reply-input');
    if (!nameEl || !input) return;

    const charName = nameEl.textContent;
    input.value = `@${charName} `;
    input.focus();
    
    if (navigator.vibrate) navigator.vibrate(10);
    showToast(`æ­£åœ¨å‘¼å”¤ ${charName}...`);
}

/**
 * ğŸ“¥ è¡¥å…¨ UI æ’å…¥ï¼šå°†æ–°è¯„è®ºæ³¨å…¥å¹¶ä¿å­˜
 */
async function appendTheirsCommentUI(newComment) {
    const snapId = window.currentViewingSnapId; // ç¡®ä¿åœ¨æ‰“å¼€è¯¦æƒ…æ—¶è®°å½•äº† ID
    let galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    const idx = galleryDB.findIndex(p => p.id === snapId);
    
    if (idx !== -1) {
        if (!galleryDB[idx].comments) galleryDB[idx].comments = [];
        galleryDB[idx].comments.push(newComment);
        localStorage.setItem('user_char_galleries', JSON.stringify(galleryDB));
        
        // é‡æ–°è°ƒç”¨æ¸²æŸ“ï¼Œä¿æŒä¸€è‡´æ€§
        renderTheirsComments(galleryDB[idx]);
    }
}
/**
 * 3. æ‰“å¼€ä¸Šä¼ å¼¹çª—
 */
// âœ… ä¿®å¤ï¼šä½¿ç”¨ var å£°æ˜ï¼Œé˜²æ­¢åˆå§‹åŒ–æŠ¥é”™
var selectedPhotoCharId = null;

// 1. æ‰“å¼€ä¸Šä¼ å¼¹çª—
async function openPhotoUploadModal() {
    const modal = document.getElementById('modal-photo-upload');
    const container = document.getElementById('char-selector-container');
    
    if (!modal || !container) return;

    // é‡ç½®ç•Œé¢
    const descInput = document.getElementById('upload-desc-input');
    const imgPreview = document.getElementById('upload-img-preview');
    const placeholder = document.getElementById('upload-placeholder');
    
    if (descInput) descInput.value = "";
    if (imgPreview) imgPreview.style.display = 'none';
    if (placeholder) placeholder.style.display = 'flex';
    
    // é‡ç½®é€‰ä¸­çŠ¶æ€
    selectedPhotoCharId = null; 
    // åŒæ—¶æ¸…é™¤ UI ä¸Šçš„é€‰ä¸­æ•ˆæœ
    const items = document.querySelectorAll('.char-select-item');
    if (items) items.forEach(el => el.classList.remove('active'));

    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';

    // ğŸš€ æ¸²æŸ“é«˜çº§å¤´åƒåˆ—è¡¨
    container.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
    
    // è·å–å¥½å‹åˆ—è¡¨ (ä¼˜å…ˆ) æˆ– è§’è‰²ä¹¦åˆ—è¡¨
    let friends = [];
    if (typeof loadFromDB === 'function') {
        friends = await loadFromDB('chat_friends') || [];
        if (friends.length === 0) {
            // å¦‚æœæ²¡åŠ å¥½å‹ï¼Œå°±ä»è§’è‰²ä¹¦é‡Œæ‹‰äºº
            friends = await loadFromDB('char_list') || [];
        }
    }

    if (friends.length === 0) {
        container.innerHTML = `<div style="font-size:13px; color:#ccc; padding:10px;">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆå»æ·»åŠ è§’è‰²</div>`;
        return;
    }

    // éå†æ¸²æŸ“
    friends.forEach(f => {
        const item = document.createElement('div');
        item.className = 'char-select-item'; // é»˜è®¤æ˜¯ç°è‰²çš„
        item.innerHTML = `
            <img class="char-select-avatar" src="${f.avatar}">
            <span class="char-select-name">${f.name}</span>
        `;
        
        // ç‚¹å‡»äº‹ä»¶
        item.onclick = function() {
            // 1. è§†è§‰åˆ‡æ¢ï¼šå…ˆæŠŠåˆ«äººçš„ active å»æ‰
            document.querySelectorAll('.char-select-item').forEach(el => el.classList.remove('active'));
            // 2. ç»™è‡ªå·±åŠ ä¸Š active (å˜äº®ã€å˜è“)
            item.classList.add('active');
            // 3. è®°å½• ID
            selectedPhotoCharId = f.id;
            
            // éœ‡åŠ¨åé¦ˆ
            if(navigator.vibrate) navigator.vibrate(10);
        };
        
        container.appendChild(item);
    });
}

/**
 * ğŸ“¤ 2. ç»ˆæå‘å¸ƒå¼•æ“ (å…¨é“¾è·¯å¼‚æ­¥é”æ­»ç‰ˆ)
 * é€»è¾‘ï¼šå³æ—¶åé¦ˆ -> ç‰©ç†å‹ç¼© -> å¼‚æ­¥å…¥åº“ -> è‡ªåŠ¨é‡ç»˜ -> å”¤èµ·è¯¦æƒ…
 */
async function submitPhotoUpload() {
    const publishBtn = document.querySelector('.highlight-btn');
    const imgPreview = document.getElementById('upload-img-preview');
    const descInput = document.getElementById('upload-desc-input');
    
    // ğŸ›¡ï¸ ç‰©ç†é”ï¼šç½®ç°åé¦ˆå¹¶ç¦æ­¢äºŒæ¬¡ç‚¹å‡»
    if (publishBtn) {
        publishBtn.style.opacity = '0.5';
        publishBtn.style.pointerEvents = 'none';
    }
    
    if (typeof showToast === 'function') showToast("æ­£åœ¨åˆ»å½•æ—¶ç©ºç‰‡æ®µ...");

    try {
        // 1. ç‰©ç†æ£€æŸ¥ï¼šç¡®ä¿æ•°æ®æºå­˜åœ¨
        if (!imgPreview || !imgPreview.src || imgPreview.style.display === 'none') {
            throw new Error("è¯·å…ˆé€‰å–ä¸€å¼ ç…§ç‰‡");
        }
        if (!selectedPhotoCharId) {
            throw new Error("è¯·ç‚¹å‡»å¤´åƒé‚€è¯·ä¸€ä½å¥½å‹");
        }

        // 2. ğŸš¨ ç‰©ç†å‹ç¼©ï¼šè§£å†³æ‰‹æœºç«¯â€œå‘å¸ƒæ— ååº”â€çš„å¤´å·æ€æ‰‹
        const compressedImg = await compressImage(imgPreview.src, 1080); 
        console.log("âœ… å›¾åƒé«˜ç»´å‹ç¼©åè®®å®Œæˆ");

        // 3. æ„é€ æ•°æ®å­˜æ ¹
        const newPhotoId = "p_" + Date.now();
        const newPhoto = {
            id: newPhotoId,
            src: compressedImg, // å­˜å…¥ä¼˜åŒ–åçš„æ•°æ®
            desc: descInput ? descInput.value : "åˆ†äº«äº†ä¸€å¼ ç…§ç‰‡",
            date: Date.now(),
            charId: selectedPhotoCharId, 
            comments: []
        };

        // 4. ğŸš¨ æ ¸å¿ƒå…¥åº“ï¼šå¿…é¡» await å­˜å…¥æˆåŠŸï¼Œé˜²æ­¢é€»è¾‘æ–­å±‚
        let myPhotos = await loadFromDB('user_my_photos') || [];
        myPhotos.unshift(newPhoto);
        await saveToDB('user_my_photos', myPhotos); 

        // 5. UI çŠ¶æ€æ”¶å°¾
        const uploadModal = document.getElementById('modal-photo-upload');
        if (uploadModal) uploadModal.style.display = 'none';
        
        // ğŸš¨ å¼ºåˆ¶é‡ç»˜åˆ—è¡¨ï¼šè®©æ–°ç…§ç‰‡å‡ºç°åœ¨èƒŒæ™¯ç½‘æ ¼ä¸­
        if (typeof renderUserPhotos === 'function') {
            await renderUserPhotos();
        }

        // 6. å»¶æ—¶ 200ms å”¤èµ·è¯¦æƒ…ï¼šé¿å¼€æ‰‹æœºå†…å­˜å¤„ç†å³°å€¼ï¼Œç¡®ä¿ä¸æ»‘
        setTimeout(() => {
            if (window.triggerSuccessHud) triggerSuccessHud("å·²å­˜å…¥ç›¸å†Œ");
            if (typeof openPhotoDetail === 'function') openPhotoDetail(newPhotoId); 
            
            // å‘å¸ƒæˆåŠŸåé‡ç½®è¾“å…¥æ¡†çŠ¶æ€ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
            if(descInput) descInput.value = "";
        }, 200);

        // 7. è§¦å‘ AI å¼‚æ­¥è¯„è®ºï¼ˆåŸºäºå½“å‰è§’è‰²äººè®¾ä¸ç”¨æˆ·å…³ç³»ï¼‰
        setTimeout(() => {
            if (typeof generateAIPhotoComment === 'function') {
                generateAIPhotoComment(newPhoto);
            }
        }, 1500);

    } catch (e) {
        // æ‰‹æœºç«¯ç›´æ¥ alert æ˜¯æœ€æœ‰æ•ˆçš„æ‹¦æˆªæç¤º
        alert("âš ï¸ åè®®å¼‚å¸¸: " + e.message);
    } finally {
        // æ¢å¤æŒ‰é’®ç‚¹å‡»æƒé™
        if (publishBtn) {
            publishBtn.style.opacity = '1';
            publishBtn.style.pointerEvents = 'auto';
        }
    }
}

/**
 * 5. å¤„ç†æ–‡ä»¶é€‰æ‹© (è½¬ Base64)
 */
function handlePhotoFileSelect(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('upload-img-preview');
            const placeholder = document.getElementById('upload-placeholder');
            
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block';
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
}

/**
 * ğŸ–¼ï¸ æ¸²æŸ“å¼•æ“ï¼šä»å¤§ä»“åº“å¼‚æ­¥æŠ“å–ç…§ç‰‡æµ
 */
async function renderUserPhotos() {
    const grid = document.getElementById('photos-grid-view');
    if (!grid) return;

    const myPhotos = await loadFromDB('user_my_photos') || [];
    grid.innerHTML = "";
    grid.style.display = "block"; 

    const emptyState = document.getElementById('photos-empty-state');
    if (myPhotos.length === 0) {
        if(emptyState) emptyState.style.display = 'flex';
        return;
    }
    if(emptyState) emptyState.style.display = 'none';

    // 1. ğŸ—“ï¸ é‡æ–°å»ºç«‹åˆ†ç»„
    const groups = {};
    myPhotos.forEach(p => {
        const d = new Date(p.time || Date.now());
        const dateKey = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        if (!groups[dateKey]) groups[dateKey] = [];
        groups[dateKey].push(p); // ğŸš¨ è¿™é‡Œä¹‹å‰ä½ æ¼æ‰äº†ï¼
    });

    // 2. æ¸²æŸ“åˆ†ç»„å†…å®¹
    Object.keys(groups).forEach(dateKey => {
        const section = document.createElement('div');
        section.className = 'photos-timeline-section';
        section.innerHTML = `
            <div class="timeline-header" style="padding:15px 20px; font-weight:700; color:#000;">${dateKey}</div>
            <div class="photos-grid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:2px;"></div>
        `;
        
        const subGrid = section.querySelector('.photos-grid');
        groups[dateKey].forEach(p => {
            const item = document.createElement('div');
            // ğŸš¨ æˆªå›¾ä¸“å±ç¼©ç•¥å›¾æ ·å¼å
            item.className = 'photo-item' + (p.isSnapshot ? ' is-snapshot-item' : '');
            item.style.position = 'relative';
            
            item.innerHTML = `
                <img src="${p.src}" loading="lazy">
                ${p.isSnapshot ? '<div class="snap-badge">é•¿æˆªå›¾</div>' : ''}
            `;
            
            // ğŸš¨ äº¤äº’éš”ç¦»ï¼šå¦‚æœæ˜¯æˆªå›¾ï¼Œå¼¹èµ·çº¯å‡€å±•ç¤ºå±‚ï¼Œä¸å¼¹é‚£ä¸ªå¸¦åˆ é™¤æŒ‰é’®çš„è¯¦æƒ…é¡µ
            // æ‰¾åˆ° renderUserPhotos é‡Œçš„ item.onclick è¿™ä¸€è¡Œ
            item.onclick = () => {
                if (p.isSnapshot) {
                    // ğŸš¨ è®°å¾—æŠŠ p.id ä¼ è¿›å»ï¼Œä¸ç„¶åˆ é™¤æŒ‰é’®ä¸çŸ¥é“åˆ å“ªå¼ ï¼
                    showPureSnapshotView(p.src, p.id); 
                } else {
                    openPhotoDetail(p.id); 
                }
            };
            
            subGrid.appendChild(item);
        });
        grid.appendChild(section);
    });
}

/**
 * ğŸ–¤ çº¯å‡€é•¿æˆªå›¾é¢„è§ˆï¼šé»‘ç™½æè‡´ç®€çº¦é£ + ç‰©ç†åˆ é™¤äº¤äº’
 */
function showPureSnapshotView(src, id) {
    // 1. åˆ›å»ºé®ç½©å®¹å™¨
    const overlay = document.createElement('div');
    overlay.id = 'snapshot-fullscreen-overlay';
    
    // 2. æ³¨å…¥ HTML ç»“æ„
    overlay.innerHTML = `
        <div class="ins-glass-blur"></div>
        <div class="snap-preview-container">
            <div class="snap-top-bar">
                <button class="snap-action-btn close-btn" onclick="closeSnapshotView()">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    <span>è¿”å›</span>
                </button>
                <button class="snap-action-btn delete-btn" onclick="deleteAndClose('${id}')">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>
                    <span>ä¸¢å¼ƒ</span>
                </button>
            </div>

            <div class="snap-content-wrapper">
                <img src="${src}" class="snap-main-img">
            </div>

            <div class="snap-bottom-info">
                <div class="snap-label">SNAPSHOT / LUNE PHONE</div>
                <div class="snap-date">${new Date().toLocaleDateString('en-US', {month:'long', day:'numeric'})}</div>
            </div>
        </div>
    `;

    document.body.appendChild(overlay);
    // å¼ºåˆ¶è§¦å‘é‡ç»˜æ¿€æ´»åŠ¨ç”»
    requestAnimationFrame(() => overlay.classList.add('active'));
}

// ç‰©ç†ç§»é™¤é¢„è§ˆå±‚
function closeSnapshotView() {
    const overlay = document.getElementById('snapshot-fullscreen-overlay');
    if (overlay) {
        overlay.classList.remove('active');
        setTimeout(() => overlay.remove(), 300);
    }
}

/**
 * ğŸ—‘ï¸ é¢„è§ˆé¡µé¢çš„åˆ é™¤è§¦å‘å™¨ï¼šä¸å†ç”¨åŸç”Ÿå¼¹çª—ï¼Œæ”¹ç”¨è‡ªå®šä¹‰ Action Sheet
 */
async function deleteAndClose(id) {
    // å¼¹å‡ºè‡ªå®šä¹‰çš„æ“ä½œè¡¨ï¼Œè€Œä¸æ˜¯åŸç”Ÿ confirm
    showDiscardActionSheet(() => {
        // ç”¨æˆ·ç¡®è®¤åˆ é™¤åçš„å›è°ƒ
        executeDeletePhoto(id);
    });
}

/**
 * ğŸ› ï¸ æ‰§è¡Œç‰©ç†åˆ é™¤é€»è¾‘
 */
async function executeDeletePhoto(id) {
    try {
        let myPhotos = await loadFromDB('user_my_photos') || [];
        myPhotos = myPhotos.filter(p => p.id !== id);
        await saveToDB('user_my_photos', myPhotos);
        
        showToast("è®°å¿†å·²ç²‰ç¢");
        
        // å…³é—­é¢„è§ˆé¡µå¹¶åˆ·æ–°åˆ—è¡¨
        closeSnapshotView();
        if (typeof renderUserPhotos === 'function') renderUserPhotos();
    } catch(e) {
        showToast("å¤„ç†å¤±è´¥");
    }
}

/**
 * ğŸ“± è‡ªå®šä¹‰é»‘ç™½é£ Action Sheet
 */
function showDiscardActionSheet(onConfirm) {
    const sheet = document.createElement('div');
    sheet.id = 'custom-action-sheet';
    sheet.innerHTML = `
        <div class="sheet-overlay" onclick="closeActionSheet()"></div>
        <div class="sheet-content">
            <div class="sheet-header">è¿™å¼ æˆªå›¾å°†è¢«æ°¸ä¹…åˆ é™¤</div>
            <button class="sheet-btn destructive" id="confirm-delete">å½»åº•ä¸¢å¼ƒ</button>
            <div class="sheet-gap"></div>
            <button class="sheet-btn cancel" onclick="closeActionSheet()">å–æ¶ˆ</button>
        </div>
    `;
    document.body.appendChild(sheet);

    // ç»‘å®šç¡®è®¤äº‹ä»¶
    document.getElementById('confirm-delete').onclick = () => {
        onConfirm();
        closeActionSheet();
    };

    // æ¿€æ´»åŠ¨ç”»
    requestAnimationFrame(() => sheet.classList.add('active'));
}

function closeActionSheet() {
    const sheet = document.getElementById('custom-action-sheet');
    if (sheet) {
        sheet.classList.remove('active');
        setTimeout(() => sheet.remove(), 300);
    }
}

/**
 * ğŸ” å¼€å¯è¯¦æƒ…é¡µï¼šç‰©ç†å®šä½ DB ä¸­çš„å­˜æ ¹
 */
async function openPhotoDetail(pid) {
    // ğŸš¨ ç‰©ç†å¯¹é½ï¼šå¼‚æ­¥è·å–å¤§å®¹é‡æ•°æ®
    const myPhotos = await loadFromDB('user_my_photos') || [];
    const photo = myPhotos.find(p => p.id === pid);
    
    if (!photo) {
        console.error("æ— æ³•å®šä½ç…§ç‰‡ ID:", pid);
        return;
    }
    
    const mask = document.getElementById('photo-detail-mask');
    const modal = document.getElementById('modal-photo-detail');
    const scroller = modal.querySelector('.card-main-scroller');
    
    if (!mask || !modal) return;

    // æ•°æ®å¡«å……
    document.getElementById('detail-main-img').src = photo.src;
    document.getElementById('detail-desc-text').textContent = photo.desc;
    
    const d = new Date(photo.date);
    document.getElementById('detail-date-title').textContent = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;

    // è®°å½•å½“å‰ ID ä¾›åç»­åˆ é™¤/è¯„è®ºä½¿ç”¨
    modal.dataset.pid = pid;
    
    // é©±åŠ¨è¯„è®ºæ¸²æŸ“
    if (typeof renderPhotoComments === 'function') renderPhotoComments(photo);

    if (scroller) scroller.scrollTop = 0;

    // åŠ¨ç”»å¯åŠ¨
    mask.style.display = 'flex';
    modal.style.display = 'flex';
    setTimeout(() => {
        mask.classList.add('active');
        document.body.style.overflow = 'hidden';
    }, 20);
}

function closePhotoDetailModal() {
    const mask = document.getElementById('photo-detail-mask');
    if (!mask) return;
    
    mask.classList.remove('active');
    document.body.style.overflow = ''; // è§£æ”¾ä¸»å±å¹•æ»šåŠ¨
    
    setTimeout(() => {
        mask.style.display = 'none';
    }, 450); // ç­‰å¾…å¼¹æ€§åŠ¨ç”»å®Œæˆ
}

/**
 * ğŸ¨ è¯„è®ºåŒºæ¸²æŸ“å¼•æ“
 * é€»è¾‘ï¼šæ¸…ç©ºæ—§ç¢ç‰‡ -> ç‰©ç†æ’åº -> æ³¨å…¥æ–°å›å“
 */
function renderPhotoComments(photoData) {
    const list = document.getElementById('detail-comments-list');
    if (!list) return;

    list.innerHTML = ""; // å½»åº•æ¸…ç©º

    if (!photoData.comments || photoData.comments.length === 0) {
        list.innerHTML = `<div style="padding:40px 20px; text-align:center; color:#ccc; font-size:12px; font-style:italic;">â€œé™é»˜ä¸­ï¼Œç­‰å¾…ç€å‘½è¿çš„å›å“...â€</div>`;
        return;
    }

    // æ¸²æŸ“æ¯ä¸€æ¡è¯„è®º
    const html = photoData.comments.map(c => `
        <div class="comment-row" style="animation: msgFadeUp 0.4s ease-out forwards;">
            <img class="comment-avatar" src="${c.avatar}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
            <div class="comment-bubble" style="background:rgba(0,0,0,0.03); padding:10px 14px; border-radius:14px; border-top-left-radius:2px; flex:1;">
                <div class="comment-name" style="font-weight:800; font-size:12px; margin-bottom:4px; color:#1d1d1f;">${c.name}</div>
                <div style="font-size:14px; color:#3a3a3c; line-height:1.5;">${c.text}</div>
            </div>
        </div>
    `).join('');

    list.innerHTML = html;

    // ç‰©ç†å¹³æ»‘ç½®åº•
    setTimeout(() => {
        const scroller = document.querySelector('.theirs-interaction-pod');
        if(scroller) scroller.scrollTo({ top: scroller.scrollHeight, behavior: 'smooth' });
    }, 100);
}

/**
 * ğŸš€ è”è§‰ç‰ˆï¼šAI è‡ªåŠ¨è¯„è®ºå¼•æ“ (ç»ˆæç‰©ç†åŠ å›ºç‰ˆ)
 * é€»è¾‘ï¼šæå–è§’è‰²äººè®¾ + æå–ç”¨æˆ·èº«ä»½ + ç‰©ç†é”å®šå…³ç³»çº¿ + IndexedDB å®æ—¶åŒæ­¥
 */
async function generateAIPhotoComment(photo, replyContext = null) {
    // 1. ç‰©ç†æå–è§’è‰²æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const char = charList.find(c => c.id === photo.charId);
    
    if (!char) {
        console.warn("System: æœªæ‰¾åˆ°å…³è”è§’è‰²ï¼Œè¯„è®ºåè®®æŒ‚èµ·");
        return;
    }

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç²¾å‡†æå–è¯¥è§’è‰²çœ¼ä¸­çš„â€œæˆ‘â€ (ä¼˜å…ˆè§’è‰²ä¸“å±èº«ä»½ï¼Œæ¬¡é€‰å…¨å±€èº«ä»½)
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "æˆ‘", bio: "ä¸€ä¸ªèº«ä»½ä¸æ˜çš„è§‚å¯Ÿè€…" };

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");

    if (!apiKey) return;

    // ğŸ§  æ·±åº¦å®¿å‘½æ„Ÿ Prompt æ³¨å…¥ (ä¿æŒåŸæœ‰é€»è¾‘)
    const systemPrompt = `
# Role: ä½ æ˜¯ [${char.name}]
# Character Background: ${char.desc}
# Your Counterpart (User): [${userPersona.name}]
# Your Bond/Relationship: ${userPersona.bio}

# Context:
ä½ æ­£åœ¨ç¿»é˜… [${userPersona.name}] çš„ç§å¯†ç›¸å†Œã€‚å¯¹æ–¹åˆšå‘äº†ä¸€å¼ ç…§ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ${photo.desc}â€ã€‚

# Task:
è¯·åŸºäºä½ çš„ã€äººè®¾ã€‘å’Œä½ å¯¹ã€${userPersona.name}ã€‘çš„ã€ç‰¹æ®Šæƒ…æ„Ÿ/ç¾ç»Šã€‘ï¼Œç»™å‡ºä¸€æ¡ç®€çŸ­çš„äº’åŠ¨è¯„è®ºã€‚

# Rules:
1. **æ‹’ç»é™Œç”Ÿæ„Ÿ**ï¼šä¸¥ç¦ä½¿ç”¨å®¢å¥—è¯ï¼Œè¯­æ°”è¦å¸¦æœ‰â€œåªæœ‰ä½ ä»¬æ‡‚â€çš„ç§å¯†æ„Ÿã€‚
2. **æ°›å›´è¦æ±‚**ï¼šæ–‡é£ç¬¦åˆ BL å®¡ç¾ï¼Œå¸¦æœ‰æš§æ˜§ã€å æœ‰æ¬²ã€æ¸©æŸ”æˆ–å®¿å‘½æ„Ÿã€‚
3. **å­—æ•°**ï¼š20å­—ä»¥å†…ï¼Œåƒå³æ—¶é€šè®¯è½¯ä»¶é‡Œçš„çœŸå®ç•™è¨€ã€‚
4. **ç¦ä»¤**ï¼šç¦æ­¢ä½¿ç”¨æ‹¬å·æè¿°åŠ¨ä½œï¼Œç›´æ¥è¾“å‡ºä½ çš„å¿ƒåº•è¯ã€‚
    `;

    try {
        // 2. è°ƒç”¨ AI æ¥å£
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: "å‘è¡¨ä½ çš„è§è§£ã€‚" }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        
        const commentText = data.choices[0].message.content.trim();

        // 3. æ„é€ æ ‡å‡†çš„è¯„è®ºæ•°æ®å¯¹è±¡
        const newComment = {
            id: Date.now(),
            userId: char.id,
            name: char.name,
            avatar: char.avatar,
            text: commentText,
            time: Date.now()
        };

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå…¨é“¾è·¯ç‰©ç†å…¥åº“ (IndexedDB æ¨¡å¼)
        // å¿…é¡»ä»å¤§å®¹é‡ä»“åº“ loadï¼Œpush åå† saveï¼Œå½»åº•è§£å†³ 5MB é™åˆ¶å¯¼è‡´çš„å‘å¸ƒå¤±è´¥
        let myPhotos = await loadFromDB('user_my_photos') || [];
        const idx = myPhotos.findIndex(p => p.id === photo.id);

        if (idx !== -1) {
            myPhotos[idx].comments.push(newComment);
            await saveToDB('user_my_photos', myPhotos); 
            
            console.log(`%c[AI Trace] ${char.name} çš„å›å“å·²å½•å…¥æ•°æ®åº“`, "color: #34C759;");

            // ğŸš¨ å®æ—¶æ¸²æŸ“è¡¥ä¸ï¼šå¦‚æœè¯¦æƒ…é¡µå½“å‰æ­£å¼€å¯å¹¶å±•ç¤ºè¯¥ç…§ç‰‡ï¼Œç«‹å³æ‰§è¡Œçƒ­æ³¨å…¥
            const detailModal = document.getElementById('modal-photo-detail');
            if (detailModal && detailModal.style.display === 'flex' && detailModal.dataset.pid === photo.id) {
                if (typeof renderPhotoComments === 'function') {
                    renderPhotoComments(myPhotos[idx]);
                }
            }
            
            // å‘é€ç³»ç»Ÿé€šçŸ¥ (å¯é€‰)
            if (window.showPushNotification) {
                window.showPushNotification(char.name, "åœ¨ä½ çš„ç…§ç‰‡ä¸‹ç•™ä¸‹äº†æ–°çš„å›å“ã€‚");
            }
        }

    } catch (e) { 
        console.error("AI Comment Logic Collapsed:", e); 
    }
}

/**
 * ğŸ¤– è”è§‰ç‰ˆï¼šAI å›å¤æœºåˆ¶
 */
async function callAIForPhotoReply(char, userText, isMentioned = false) {
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
    
    // æå–å¯¹åº”èº«ä»½
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "æˆ‘" };

    const prompt = `
ä½ æ˜¯ [${char.name}]ã€‚èƒŒæ™¯: ${char.desc}ã€‚
ä½ æ­£åœ¨å’Œå¿ƒå°–ä¸Šçš„ [${userPersona.name}] äº’åŠ¨ã€‚
å¯¹æ–¹åˆšåˆšåœ¨è¯„è®ºåŒºå›å¤äº†ä½ ï¼šâ€œ${userText}â€ã€‚
${isMentioned ? "ğŸš¨ é‡ç‚¹ï¼šå¯¹æ–¹ç‰¹åˆ«è‰¾ç‰¹äº†ä½ ï¼Œä½ çš„å›åº”è¦æ›´æœ‰é’ˆå¯¹æ€§å’Œæƒ…æ„Ÿå¼ åŠ›ã€‚" : ""}

è¦æ±‚ï¼š
1. å»¶ç»­ä½ ä»¬çš„ã€${userPersona.bio}ã€‘å…³ç³»è®¾å®šã€‚
2. è¯­æ°”æš§æ˜§æˆ–å…·æœ‰ç‰¹å®šæ€§æ ¼è‰²å½©ï¼Œä¸¥ç¦è·¯äººæ„Ÿã€‚
3. 15å­—ä»¥å†…ã€‚
4. ç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚
    `;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "system", content: prompt }],
                temperature: 0.9
            })
        });
        const data = await res.json();
        return data.choices[0].message.content.trim();
    } catch (e) { return "â€¦â€¦ï¼ˆåªæ˜¯é™é™åœ°çœ‹ç€ä½ ï¼‰"; }
}

/**
 * 11. åˆ é™¤ç…§ç‰‡åŠŸèƒ½
 */
async function showPhotoActions() {
    const modal = document.getElementById('modal-photo-detail');
    const pid = modal.dataset.pid;

    showIOSConfirm("æŠ¹é™¤è®°å¿†", "ç¡®å®šè¦æ°¸ä¹…ç‰©ç†æŠ¹é™¤è¿™æ®µç¬é—´å—ï¼Ÿ", "æŠ¹é™¤", async function() {
        try {
            // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»ä» IndexedDB ä¸­åˆ é™¤ï¼Œè€Œä¸æ˜¯ localStorage
            let myPhotos = await loadFromDB('user_my_photos') || [];
            myPhotos = myPhotos.filter(p => p.id !== pid);
            
            // è¦†ç›–ä¿å­˜
            await saveToDB('user_my_photos', myPhotos); 
            
            // ğŸš¨ ç«‹å³æ‰§è¡Œç‰©ç†é‡ç»˜
            await renderUserPhotos();
            
            // å…³é—­è¯¦æƒ…å±‚
            closePhotoDetailModal();
            
            if (window.triggerSuccessHud) triggerSuccessHud("è®°å¿†å·²å½’äºè™šæ— ");
        } catch (e) {
            showToast("åˆ é™¤å¼‚å¸¸");
        }
    });
}

/**
 * 12. ç”¨æˆ·æ‰‹åŠ¨å›å¤ (é—­ç¯é€»è¾‘ï¼šç”¨æˆ·å›å¤ -> AI æ£€æµ‹è‰¾ç‰¹ -> AI å†å›å¤)
 */
async function sendPhotoComment() {
    const input = document.getElementById('detail-reply-input');
    const text = input ? input.value.trim() : "";
    
    if (!text) return;
    
    const pid = document.getElementById('modal-photo-detail').dataset.pid;
    const userPersona = JSON.parse(localStorage.getItem('user_persona_data_global')) || {name:"æˆ‘", avatar:""};
    
    // 1. æ„é€ ç”¨æˆ·è¯„è®º
    const newComment = {
        id: Date.now(),
        userId: "user",
        name: userPersona.name || "æˆ‘",
        avatar: userPersona.avatar || "https://api.dicebear.com/7.x/initials/svg?seed=User",
        text: text,
        time: Date.now()
    };
    
    // 2. å­˜å…¥å¹¶åˆ·æ–°
    let myPhotos = JSON.parse(localStorage.getItem('user_my_photos')) || [];
    const targetP = myPhotos.find(p => p.id === pid);
    
    if (targetP) {
        targetP.comments.push(newComment);
        localStorage.setItem('user_my_photos', JSON.stringify(myPhotos));
        
        renderPhotoComments(targetP);
        if(input) input.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
        
        // 3. ğŸš¨ æ£€æŸ¥æ˜¯å¦è‰¾ç‰¹äº†å¥½å‹ (è§¦å‘ AI äºŒæ¬¡å›å¤)
        // é€»è¾‘ï¼šå¦‚æœè¯„è®ºå†…å®¹ä»¥ @åå­— å¼€å¤´ï¼Œä¸”è¿™ä¸ªåå­—å¯¹åº”å½“å‰ç…§ç‰‡ç»‘å®šçš„è§’è‰²
        if (targetP.charId) {
            let charList = [];
            if (typeof loadFromDB === 'function') charList = await loadFromDB('char_list') || [];
            const boundChar = charList.find(c => c.id === targetP.charId);
            
            if (boundChar && text.includes(`@${boundChar.name}`)) {
                console.log(`æ£€æµ‹åˆ°ç”¨æˆ·è‰¾ç‰¹äº† ${boundChar.name}ï¼Œè§¦å‘ AI å›å¤...`);
                
                // å»¶è¿Ÿ 2 ç§’è®© AI å›å¤
                setTimeout(() => {
                    generateAIPhotoComment(targetP, text); // ä¼ å…¥ text ä½œä¸ºä¸Šä¸‹æ–‡
                }, 2000);
            }
        }
    }
}
/**
 * ğŸï¸ ç»ˆæå¼•æ“ï¼š24Hå…¨æ—¶æ®µå›æº¯ (ç‰©ç†æ—¶åŒºåŒæ­¥ç‰ˆ)
 * ä¿®å¤ï¼šä¸¥æ ¼è·Ÿéš Settings æ—¶åŒºï¼Œçº æ­£ç”Ÿæˆæ•°é‡ï¼Œæ¶ˆé™¤ ReferenceError
 */
/**
 * ğŸï¸ ç»ˆæå¼•æ“ï¼š24Hå…¨æ—¶æ®µå›æº¯ (ç‰©ç†æ—¶åŒºå¯¹é½ + èº«ä»½é©±åŠ¨ç‰ˆ)
 * é€»è¾‘ï¼šç»å¯¹æœä» Settings æ—¶åŒºï¼Œä¸¥æ ¼æŒ‰å°æ—¶ç”Ÿæˆï¼Œæ–‡æ¡ˆå®Œå…¨ç”±äººè®¾ä¸å…³ç³»é“¾å†³å®šã€‚
 */
async function generateRetroFootprints() {
    const char = window.currentViewingChar;
    const btn = document.getElementById('btn-footprint');
    const list = document.getElementById('footprints-list');
    const saveBtn = document.getElementById('btn-save-footprints');

    if (!char) return;

    // ğŸš¨ 1. ç‰©ç†æ—¶åŒºç°æŠ“ï¼šç¡®ä¿ currentHour ä¸ activeZone ç»å¯¹å®æ—¶
    const timeData = getAppLocalTime(); 
    const currentHour = timeData.hour; 
    const activeZone = timeData.activeZone || "Asia/Shanghai"; 

    // ğŸ–¥ï¸ å¼ºåŠ›æ§åˆ¶å°å®¡è®¡ (ç‰©ç†å¯¹é½æ£€æŸ¥)
    console.group("%cğŸ“¡ æ—¶ç©ºèŠ‚ç‚¹ç”Ÿæˆå®¡è®¡", "color: #007AFF; font-weight: bold;");
    console.log(`%c ç›®æ ‡æ—¶åŒº (Key: user_timezone): ${activeZone}`, "color: #AF52DE; font-weight: bold;");
    console.log(`%c å®æ—¶å°æ—¶ (24H): ${currentHour}:00`, "color: #34C759; font-weight: bold;");
    console.log(`%c ç‰©ç†åºåˆ—: 00:00 -> ${currentHour}:00 (å…± ${currentHour + 1} ä¸ªç‰‡æ®µ)`, "color: #FF9500;");
    console.groupEnd();

    // 2. å­˜æ¡£æ£€æŸ¥ï¼šYYYYMMDD å”¯ä¸€æ ‡è¯†
    const todayKey = `fp_cache_${char.id}_${timeData.year}${timeData.month}${timeData.day}`;
    const cachedData = localStorage.getItem(todayKey);

    if (cachedData) {
        console.log("System: ä»Šæ—¥æ¡£æ¡ˆå·²å°å­˜ï¼Œæ‰§è¡Œç‰©ç†åŠ è½½...");
        renderFootprintFrames(JSON.parse(cachedData));
        document.getElementById('modal-footprints').style.display = 'flex';
        return;
    }

    // 3. èº«ä»½è¯»å–ï¼šåŠ è½½è§’è‰²è®¾å®šä¸æœ¬æˆ‘æ¡£æ¡ˆ
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "è§‚æµ‹è€…", bio: "æœªçŸ¥çš„ç¾ç»Š" };

    // ğŸš¨ 4. æ„é€ ç‰©ç†æ—¶é—´è½´ï¼šä¸¥æ ¼å¾ªç¯ 0 -> currentHour
    let timePoints = [];
    for (let h = 0; h <= currentHour; h++) {
        let label = (h < 10 ? '0' + h : h) + ':00';
        let isResting = (h >= 0 && h <= 7); // å‘¨æœŸæ€§çŠ¶æ€åˆ¤å®š
        timePoints.push({ 
            time: label, 
            status: isResting ? "RESTING/æ¢¦å¢ƒ/ä½åŠŸè€—" : "ACTIVE/ç°å®/é«˜è¿è¡Œ" 
        });
    }

    btn.style.pointerEvents = 'none';
    btn.innerHTML = `<span>SYNCHRONIZING ${timePoints.length} TRACES...</span>`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

        if (!apiKey) throw new Error("API Key Missing");

        // ğŸ§  èº«ä»½é©±åŠ¨ Promptï¼šä¸è®¾äººæ€§é™åˆ¶ï¼Œçº¯ç²¹åŸºäºèƒŒæ™¯å’Œå…³ç³»
        const prompt = `
# Role: ä½ æ˜¯ [${char.name}]
# Background: ${char.desc || "æœªçŸ¥"}
# Counterpart (User): [${userPersona.name}]
# Relationship: ${userPersona.bio}

# Context:
å½“å‰å½“åœ°æ—¶é—´æ˜¯ ${timeData.fullString}ã€‚ä½ éœ€è¦è®°å½•ä»Šå¤© 00:00 è‡³ä»Šçš„ã€æ¯ä¸€ä¸ªã€‘æ•´ç‚¹å°æ—¶è¶³è¿¹ã€‚

# Task:
è¯·ä¸ºä»¥ä¸‹æ—¶é—´ç‚¹ç”Ÿæˆ 40-60 å­—çš„æå†™ï¼Œå†…å®¹å¿…é¡»å®Œå…¨ç¬¦åˆä½ çš„ã€èº«ä»½èƒŒæ™¯ã€‘ä»¥åŠä½ ä¸ [${userPersona.name}] çš„ã€å…³ç³»è®¾å®šã€‘ï¼š
${JSON.stringify(timePoints)}

# Requirements:
1. **æ•°é‡å¯¹é½**ï¼šå¿…é¡»è¿”å›æ­£å¥½ ${timePoints.length} æ¡è®°å½•ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’åˆ—ã€‚
2. **çŠ¶æ€å¯¹åº”**ï¼š
   - 00:00 - 07:00 (ä¼‘æ¯/ä½é¢‘æ€)ï¼šæå†™åœ¨æ­¤çŠ¶æ€ä¸‹ï¼Œä½ æ„è¯†æ·±å¤„å…³äº [${userPersona.name}] çš„ç¢ç‰‡ã€‚
   - 08:00 - è‡³ä»Š (æ´»è·ƒ/é«˜é¢‘æ€)ï¼šæå†™ä½ åœ¨å½“å‰ç¯å¢ƒä¸‹çš„è¡Œä¸ºï¼Œä»¥åŠå— [${userPersona.name}] å½±å“çš„æƒ…æ„Ÿèµ·ä¼ã€‚
3. **æ ¼å¼**ï¼šä¸¥æ ¼è¿”å›çº¯ JSON æ•°ç»„ï¼š[{"time_label": "HH:00", "is_resting": true/false, "visual_description": "..."}]
`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        const jsonMatch = data.choices[0].message.content.match(/\[[\s\S]*\]/);
        let framesData = JSON.parse(jsonMatch[0]);
        const framesWithImages = framesData.map(frame => ({
            ...frame,
            thumb: char.avatar, // ğŸ‘ˆ å¿…é¡»åœ¨è¿™é‡Œç‰©ç†é”å®šå¤´åƒæ•°æ®
            charName: char.name
        }));

        window.currentTempFootprints = framesWithImages; 
        window.currentFootprintKey = todayKey;
        renderFootprintFrames(framesWithImages); // ä¼ å…¥å¸¦å›¾çš„æ•°ç»„

        // ğŸš¨ 5. å¼ºåŠ›çº åï¼šç‰©ç†æ—¶åºé”
        framesData.sort((a, b) => parseInt(a.time_label) - parseInt(b.time_label));

        // 6. æš‚å­˜ä¸æ¸²æŸ“
        window.currentTempFootprints = framesData;
        window.currentFootprintKey = todayKey;
        renderFootprintFrames(framesData);

        document.getElementById('modal-footprints').style.display = 'flex';
        if(saveBtn) {
            saveBtn.style.display = 'block';
            saveBtn.textContent = "ARCHIVE FULL DAY";
        }

    } catch (e) {
        console.error("Critical Error:", e);
        showToast("é‡å­çº ç¼ å¤±è´¥: " + e.message);
    } finally {
        btn.innerHTML = `<span>FOOTPRINTS</span>`;
        btn.style.pointerEvents = 'auto';
    }
}

/**
 * ğŸ’¾ æ™ºèƒ½å­˜æ¡£å¼•æ“ï¼šæ”¯æŒè¦†ç›–æ›´æ–°
 */
async function saveCurrentFootprints() {
    const saveBtn = document.getElementById('btn-save-footprints');
    const char = window.currentViewingChar;
    
    // 1. è·å–å®Œæ•´æ•°æ®
    const fullData = window.currentTempFootprints;
    if (!fullData || !char) return;

    // 2. ç”Ÿæˆä»Šæ—¥å”¯ä¸€ Key (æ ¼å¼: 2026-01-26)
    const now = new Date();
    const dateKey = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
    
    // 3. è¯»å–å†å²æ€»è¡¨ (Footprint Archive List)
    let archiveList = await loadFromDB('footprint_archive_' + char.id) || [];
    
    // 4. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šæ—¥æ¡£æ¡ˆ
    const existingIndex = archiveList.findIndex(item => item.dateKey === dateKey);
    
    // æ„é€ æ¡£æ¡ˆå¯¹è±¡
    const archiveEntry = {
        dateKey: dateKey,       // å”¯ä¸€ç´¢å¼•
        timestamp: Date.now(),  // ä¿å­˜æ—¶é—´
        frames: fullData,       // æ‰€æœ‰çš„èƒ¶ç‰‡æ•°æ®
        summary: fullData[fullData.length - 1].visual_description // å–æœ€åä¸€æ¡ä½œä¸ºå°é¢æ‘˜è¦
    };

    if (existingIndex !== -1) {
        // A. å­˜åœ¨ -> è¦†ç›–æ›´æ–° (Update)
        archiveList[existingIndex] = archiveEntry;
        console.log("System: æ›´æ–°ä»Šæ—¥å·²æœ‰æ¡£æ¡ˆ");
    } else {
        // B. ä¸å­˜åœ¨ -> æ–°å¢æ’å…¥ (Insert)
        archiveList.unshift(archiveEntry); // æ–°çš„æ”¾å‰é¢
        console.log("System: åˆ›å»ºä»Šæ—¥æ–°æ¡£æ¡ˆ");
    }

    // 5. å†™å…¥æ•°æ®åº“
    await saveToDB('footprint_archive_' + char.id, archiveList);

    // 6. UI åé¦ˆ
    saveBtn.textContent = "SAVED";
    saveBtn.style.background = "#34C759"; // ç»¿è‰²æˆåŠŸ
    saveBtn.style.color = "#fff";
    
    triggerSuccessHud("å…¨å¤©æ¡£æ¡ˆå·²å½’æ¡£");
    
    setTimeout(() => {
        saveBtn.style.display = 'none';
        // åŒæ—¶ä¹Ÿæ›´æ–°ä¸€ä¸‹ç¼“å­˜ï¼Œé˜²æ­¢åˆ·æ–°åå›é€€
        // æˆ‘ä»¬ç”¨ cache key å­˜ä¸€ä»½ä¸´æ—¶çš„ï¼Œé˜²æ­¢ç”¨æˆ·æ²¡ç‚¹ save å°±åˆ·æ–°
        const cacheKey = `fp_cache_${char.id}_${new Date().toLocaleDateString().replace(/\//g, '')}`;
        localStorage.setItem(cacheKey, JSON.stringify(fullData));
    }, 1500);
}

/**
 * ğŸï¸ ç‰©ç†é”æ­»æ¸²æŸ“å¼•æ“ (V5.0 ç»ˆæç‰ˆ)
 * æ•´åˆï¼šå›¾åƒç‰©ç†å¯¹é½ã€å¢é‡åŒæ­¥åˆ¤å®šã€è‡ªåŠ¨é‡ç»˜ã€å±‚çº§é˜²æŠ¤
 */
function renderFootprintFrames(framesData) {
    const list = document.getElementById('footprints-list');
    if (!list) return;
    
    // ğŸš¨ å¿…é¡»æ›´æ–°å…¨å±€å˜é‡ï¼Œç¡®ä¿åç»­å¢é‡æ›´æ–°èƒ½è¯»åˆ°æœ€æ–°æ•°æ®
    window.currentTempFootprints = framesData;

    list.innerHTML = "";
    
    // 1. æ¸²æŸ“å·²æœ‰çš„èƒ¶ç‰‡å¡ç‰‡
    framesData.forEach((frame, index) => {
        const isRest = frame.is_resting;
        const cell = document.createElement('div');
        cell.className = `film-frame ${isRest ? 'resting-mode' : ''}`;
        cell.style.animationDelay = `${index * 0.05}s`; 
        cell.onclick = () => openFootprintSingle(frame);

        // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šç‰©ç†æ³¨å…¥ <img> æ ‡ç­¾å¹¶é”å®š Z-Index
        cell.innerHTML = `
            <div class="film-time-axis">${frame.time_label}</div>
            <div class="film-photo-wrapper ai-visual-frame ${isRest ? 'resting-mode' : ''}" style="position:relative; overflow:hidden;">
                
                <div class="ai-visual-icon" style="position:relative; z-index:5;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                        ${isRest ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>' : '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>'}
                    </svg>
                    <span>${isRest ? 'SLEEPING_MODE' : 'ACTIVE_TRACE'}</span>
                </div>

                <img src="${frame.thumb || (window.currentViewingChar ? window.currentViewingChar.avatar : '')}" 
                     class="history-thumb-img" 
                     style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:1; transform:translateZ(0); opacity:1; pointer-events:none;">
                
                <div class="ai-visual-text" style="position:relative; z-index:3;">â€œ${frame.visual_description}â€</div>
            </div>
        `;
        list.appendChild(cell);
    });

    // 2. åŠ¨æ€ç”Ÿæˆåº•éƒ¨æ“ä½œåŒº (Access Zone)
    const footerZone = document.createElement('div');
    footerZone.className = 'history-access-zone';

    // ğŸš¨ é€»è¾‘åˆ¤å®šï¼šæ˜¯å¦æ˜¾ç¤ºâ€œåŒæ­¥æ›´æ–°â€æŒ‰é’®
    const lastFrame = framesData[framesData.length - 1];
    if (lastFrame) {
        const lastHour = parseInt(lastFrame.time_label.split(':')[0]);
        const currentHour = new Date().getHours();

        if (lastHour < currentHour) {
            const diff = currentHour - lastHour;
            // ç‰©ç†æ³¨å…¥â€œåŒæ­¥æœ€æ–°â€æŒ‰é’®
            footerZone.innerHTML += `
                <div id="btn-sync-latest" class="btn-history-trigger" style="margin-bottom: 15px; border-color: #007AFF; color: #007AFF; background: rgba(0,122,255,0.05);" onclick="updateFootprintsToNow()">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l1.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    <span>SYNC LATEST (${diff} HOURS) / åŒæ­¥æœ€æ–°è½¨è¿¹</span>
                </div>
            `;
        } else {
            footerZone.innerHTML += `<div class="history-divider">UP TO DATE // ${lastFrame.time_label}</div>`;
        }
    }

    // å§‹ç»ˆæ˜¾ç¤ºâ€œå¾€æœŸæ¡£æ¡ˆâ€å…¥å£
    footerZone.innerHTML += `
        <div class="btn-history-trigger" onclick="openFootprintHistoryPage()">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>ACCESS ARCHIVES / å¾€æœŸæ¡£æ¡ˆ</span>
        </div>
    `;

    list.appendChild(footerZone);
    
    // 3. ç‰©ç†ç½®åº•ï¼šå¹³æ»‘æ»šåŠ¨åˆ°æœ€æ–°ä¸€æ¡
    setTimeout(() => {
        list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
    }, 100);
}
/**
 * ğŸ–‹ï¸ [ç»ˆæå›ºå®šç‰ˆ] Luna ä¸“å±æ˜æ˜Ÿç­¾å (ä¿®å¤ç¼–ç æŠ¥é”™ç‰ˆ)
 * ä½¿ç”¨ encodeURIComponent æ›¿ä»£ btoaï¼Œå®Œç¾æ”¯æŒä¸­æ–‡æ³¨é‡Šå’Œç‰¹æ®Šç¬¦å·ã€‚
 */
function getFixedLunaSignature() {
    const svgString = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 200">
  <defs>
    <style>
      .sig-path { fill: none; stroke: #000; stroke-linecap: round; stroke-linejoin: round; }
      .star-shape { fill: #000; stroke: none; }
    </style>
  </defs>
  
  <path class="sig-path" stroke-width="7" d="M120,60 C90,20 30,50 30,100 C30,150 80,160 110,130 L125,90" />
  
  <path class="sig-path" stroke-width="5" d="M125,90 Q135,120 155,115 Q175,110 175,85 L175,115 Q175,135 195,125 M195,125 Q205,95 225,95 Q245,95 245,115 L245,130 M245,130 Q255,110 275,110 Q295,110 295,125 Q295,140 275,145 L290,135" />
  
  <path class="sig-path" stroke-width="5" d="M40,155 C120,190 280,180 420,125" />

  <path class="star-shape" d="M435,105 L442,125 L463,125 L446,138 L453,158 L435,145 L417,158 L424,138 L407,125 L428,125 Z" transform="rotate(20 435 130) scale(0.9) translate(40, 10)"/>
</svg>
    `;

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ”¹ç”¨ encodeURIComponentï¼Œå½»åº•è§£å†³ InvalidCharacterError
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
}
/**
 * ğŸ—‘ï¸ å…³é—­æ‹ç«‹å¾—è¯¦æƒ…é¡µ (ç‰©ç†ä¿®å¤ç‰ˆ)
 * è§£å†³ Uncaught ReferenceError: closeFootprintSingle is not defined
 */
function closeFootprintSingle() {
    const modal = document.getElementById('modal-footprint-single-detail');
    
    if (modal) {
        // 1. ç§»é™¤æ¿€æ´»ç±»åï¼Œè§¦å‘ CSS è¿‡æ¸¡åŠ¨ç”»
        modal.classList.remove('active');
        
        // 2. ç­‰å¾…åŠ¨ç”»ç»“æŸåå½»åº•éšè— (400ms æ˜¯ CSS transition çš„æ—¶é—´)
        setTimeout(() => {
            modal.style.display = 'none';
        }, 400);
    }

    // 3. æ¢å¤ä¸»é¡µé¢çš„å¯è§æ€§ (é˜²æ­¢ä¸»é¡µä¸€ç›´è¢«éšè—)
    const homeScreen = document.querySelector('.home-screen-scroll-container');
    if (homeScreen) {
        homeScreen.style.visibility = 'visible';
    }
}

// ğŸš¨ å¼ºåˆ¶æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.closeFootprintSingle = closeFootprintSingle;
/**
 * ğŸ“‚ æ‰“å¼€å¾€æœŸæ¡£æ¡ˆåº“ (è¯»å–çœŸå®æ•°æ®åº“ç‰ˆ)
 */
async function openFootprintHistoryPage() {
    console.log("System: æ­£åœ¨è°ƒå–æ·±å±‚æ¡£æ¡ˆ...");
    const char = window.currentViewingChar;
    if (!char) return;

    const page = document.getElementById('subpage-history-vault');
    const container = document.getElementById('white-timeline-container');
    
    if (!page || !container) return;

    // 1. ä»æ•°æ®åº“è¯»å–çœŸå®å†å²
    const historyData = await loadFromDB('footprint_archive_' + char.id) || [];

    // 2. æ¸²æŸ“åˆ—è¡¨
    if (historyData.length === 0) {
        container.innerHTML = `<div style="padding:60px 20px; text-align:center; color:#ccc; font-family:serif; font-style:italic;">
            â€œæ—¶é—´ä¹‹æ²³å°šæœªåœ¨æ­¤ç•™ä¸‹ç—•è¿¹...â€<br>
            <span style="font-size:10px; font-family:sans-serif; margin-top:10px; display:block;">ç‚¹å‡»ä¿å­˜æŒ‰é’®å¯å»ºç«‹ç¬¬ä¸€ä»½æ¡£æ¡ˆ</span>
        </div>`;
    } else {
        let html = "";
        historyData.forEach((item, index) => {
            // è§£ææ—¥æœŸ: 2026-01-26 -> [26, JAN, 2026]
            const dateObj = new Date(item.timestamp);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = dateObj.toLocaleString('en-US', { month: 'long' }).toUpperCase();
            const year = dateObj.getFullYear();
            
            // æ‘˜è¦æˆªå–å‰30å­—
            const summary = item.summary.substring(0, 45) + "...";
            const frameCount = item.frames.length;

            html += `
                <div class="white-day-card" style="animation-delay: ${index * 0.1}s" 
                     onclick="openArchiveReader('${item.dateKey}')">
                    
                    <div class="day-card-inner">
                        <div class="day-meta-date">${day}</div>
                        <div class="day-meta-month">${month} ${year}</div>
                        
                        <div class="day-summary-preview">
                            â€œ${summary}â€
                        </div>

                        <div class="day-footer">
                            <div class="day-status-pill">${frameCount} FRAMES</div>
                            <div class="view-btn-text">
                                Read 
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // 3. ç‰©ç†æ˜¾å½¢
    page.style.display = 'flex'; 
    void page.offsetWidth; 
    page.classList.add('active');
}

/**
 * ğŸï¸ è¾…åŠ©ï¼šç‚¹å‡»å†å²å¡ç‰‡ï¼Œå›å¡«åˆ°æ’­æ”¾å™¨æŸ¥çœ‹
 */
async function loadHistoryToPlayer(dateKey) {
    const char = window.currentViewingChar;
    const historyData = await loadFromDB('footprint_archive_' + char.id) || [];
    
    // æ‰¾åˆ°é‚£ä¸€å¤©çš„æ•°æ®
    const target = historyData.find(h => h.dateKey === dateKey);
    
    if (target) {
        // 1. å…³é—­ç™½è‰²å†å²é¡µ
        closeSubPage('subpage-history-vault');
        
        // 2. å°†æ•°æ®æ³¨å…¥æ’­æ”¾å™¨å˜é‡
        window.currentTempFootprints = target.frames;
        window.currentFootprintKey = dateKey; // æ ‡è®°å½“å‰æŸ¥çœ‹çš„æ˜¯å“ªä¸€å¤©çš„ Key
        
        // 3. é‡æ–°æ¸²æŸ“æ’­æ”¾å™¨ç•Œé¢
        renderFootprintFrames(target.frames);
        
        // 4. éšè—ä¿å­˜æŒ‰é’®ï¼ˆå› ä¸ºæ˜¯å†å²æ•°æ®ï¼Œé»˜è®¤è®¤ä¸ºå·²ä¿å­˜ï¼‰
        const saveBtn = document.getElementById('btn-save-footprints');
        if (saveBtn) saveBtn.style.display = 'none';
        
        // 5. æç¤º
        showToast(`å·²è½½å…¥ ${dateKey} çš„å›å¿†`);
    }
}
// æŒ‚è½½åˆ°å…¨å±€
window.loadHistoryToPlayer = loadHistoryToPlayer;
/**
 * ğŸ”„ å¢é‡æ›´æ–°å¼•æ“ï¼šç‰©ç†å¯¹é½æ—¶åŒºç‰ˆ
 * ä¿®å¤ï¼š1. ä¸¥æ ¼æŠ“å– Settings æ—¶é—´ï¼›2. ç‰©ç†æ ¡å‡†è¡¥å…¨ç¼ºå£ï¼›3. è¡¥å…¨æ§åˆ¶å°å®¡è®¡ã€‚
 */
async function updateFootprintsToNow() {
    console.log("System: æ­£åœ¨è¯·æ±‚å¢é‡åŒæ­¥è½¨è¿¹..."); 
    
    const char = window.currentViewingChar;
    // è·å–å½“å‰å·²æœ‰æ•°æ® (ç‰©ç†é”å®š Window å…¨å±€ç¼“å­˜)
    const currentData = window.currentTempFootprints || [];
    
    if (!char || currentData.length === 0) {
        showToast("æ— å‰ç½®æ•°æ®ï¼Œæ— æ³•åŒæ­¥");
        return;
    }

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ 1ï¼šè°ƒç”¨ getAppLocalTime è·å–è®¾ç½®æ—¶åŒºçš„å³æ—¶æ—¶é—´
    const timeData = getAppLocalTime(); 
    const currentHour = timeData.hour; 
    const activeZone = timeData.activeZone || "Asia/Shanghai";

    // 1. è·å–å­˜æ ¹æœ€åä¸€æ¡è®°å½•çš„å°æ—¶æ•°
    const lastFrame = currentData[currentData.length - 1];
    const lastHour = parseInt(lastFrame.time_label.split(':')[0]);

    // ğŸ–¥ï¸ å¢é‡åŒæ­¥ç‰©ç†å®¡è®¡ (F12 æŸ¥çœ‹)
    console.group("%cğŸ”„ å¢é‡åŒæ­¥ç›‘æµ‹", "color: #007AFF; font-weight: bold;");
    console.log(`%c é”å®šåŒºåŸŸ: ${activeZone}`, "color: #AF52DE; font-weight: bold;");
    console.log(`%c å­˜æ ¹æœ€åèŠ‚ç‚¹: ${lastHour}:00`, "color: #8E8E93;");
    console.log(`%c ç›®æ ‡å³æ—¶èŠ‚ç‚¹: ${currentHour}:00`, "color: #34C759; font-weight: bold;");
    console.log(`%c ç‰©ç†ç¼ºå£: ${currentHour - lastHour} å°æ—¶`, "color: #FF9500;");
    console.groupEnd();

    // 2. ç‰©ç†åˆ¤å®šï¼šå¦‚æœå·²ç»æ˜¯æœ€æ–°æ—¶åˆ»
    if (lastHour >= currentHour) {
        showToast("è½¨è¿¹å·²æ˜¯æœ€æ–°");
        const btn = document.getElementById('btn-sync-latest');
        if(btn) btn.remove();
        return;
    }

    // 3. ğŸ¬ å¯åŠ¨æŒ‰é’®åŠ¨ç”» (ç‰©ç†é”å®š ID)
    const btn = document.getElementById('btn-sync-latest'); 
    const originalContent = btn ? btn.innerHTML : ""; 
    
    if (btn) {
        btn.classList.add('syncing'); 
        btn.innerHTML = `
            <svg class="quantum-spinner" style="width:16px; height:16px; border-width:2px; border-top-color:#007AFF;" viewBox="0 0 50 50"></svg>
            <span>SYNCING [${activeZone}] ${lastHour + 1}:00 - ${currentHour}:00...</span>
        `;
    }

    // 4. æ„é€ éœ€è¦è¡¥å…¨çš„æ—¶é—´ç‚¹åˆ—è¡¨
    let timePoints = [];
    for (let h = lastHour + 1; h <= currentHour; h++) {
        let label = (h < 10 ? '0' + h : h) + ':00';
        let isResting = (h >= 0 && h <= 7);
        // ğŸš¨ ä¿®æ­£ï¼šå°† statusType å°è£…ï¼Œç¡®ä¿ AI æ¥æ”¶åˆ°çš„æ˜¯æ¸…æ™°çš„æŒ‡ä»¤
        timePoints.push({ time: label, statusType: isResting ? "RESTING" : "ACTIVE" });
    }

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        if (!apiKey) throw new Error("API Key æœªé…ç½®");

        // 5. æ„å»º Prompt (æ³¨å…¥æ—¶åŒºç¯å¢ƒ)
        const prompt = `
ä½ æ­£åœ¨æ‰®æ¼” [${char.name}]ã€‚ä½ å½“å‰å¤„äº [${activeZone}] æ—¶åŒºã€‚
ä½ ç°åœ¨éœ€è¦è¡¥å…¨ä»Šå¤©ä» ${timePoints[0].time} åˆ° ${timePoints[timePoints.length-1].time} çš„æ¯ä¸€å°æ—¶è¶³è¿¹ã€‚
ã€å‰æƒ…å›é¡¾ã€‘ï¼šä¸Šä¸€ä¸ªè®°å½•ç‚¹æ˜¯ ${lastFrame.time_label}ï¼Œä½ åœ¨åš"${lastFrame.visual_description}"ã€‚
ã€éœ€ç”Ÿæˆåˆ—è¡¨ã€‘ï¼š${JSON.stringify(timePoints)}

è¦æ±‚ï¼š
1. å¿…é¡»æ ¹æ® [${activeZone}] çš„å®æ—¶æ„Ÿå®˜è¡¥å…¨ç¼ºå¤±çš„æ—¶é—´æ®µã€‚
2. ä¿æŒ Noir/é»‘ç™½ç”µå½±è´¨æ„Ÿï¼Œæ–‡é£ç¬¦åˆä½ çš„äººè®¾ã€‚
3. ä¸¥æ ¼è¿”å›çº¯ JSON æ•°ç»„ï¼š[{"time_label": "HH:00", "is_resting": false, "visual_description": "..."}]
        `;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const jsonMatch = data.choices[0].message.content.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI è¿”å›æ ¼å¼é”™è¯¯");
        const newFrames = JSON.parse(jsonMatch[0]);

        // 6. ğŸ¬ é€æ¡æ¸²æŸ“åŠ¨ç”» (ä¿ç•™åŸå°ä¸åŠ¨çš„æ¸²æŸ“é€»è¾‘)
        if (btn) {
            btn.classList.remove('syncing');
            btn.innerHTML = `<span>RECEIVED. RENDERING...</span>`;
            btn.style.color = "#34C759"; 
            btn.style.borderColor = "#34C759";
        }

        const list = document.getElementById('footprints-list');
        const footerZone = document.querySelector('.history-access-zone');
        
        for (let i = 0; i < newFrames.length; i++) {
            const frame = newFrames[i];
            const isRest = frame.is_resting;
            
            const cell = document.createElement('div');
            cell.className = `film-frame new-entry ${isRest ? 'resting-mode' : ''}`;
            cell.onclick = () => openFootprintSingle(frame);
            frame.thumb = char.avatar;

            cell.innerHTML = `
                <div class="film-time-axis">${frame.time_label}</div>
                <div class="film-photo-wrapper ai-visual-frame ${isRest ? 'resting-mode' : ''}">
                    <div class="ai-visual-icon">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                            ${isRest ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>' : '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>'}
                        </svg>
                        <span>${isRest ? 'SLEEPING_MODE' : 'ACTIVE_TRACE'}</span>
                    </div>
                    <div class="ai-visual-text">â€œ${frame.visual_description}â€</div>
                </div>
            `;
            
            if(footerZone) list.insertBefore(cell, footerZone);
            else list.appendChild(cell);

            list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
            await new Promise(r => setTimeout(r, 300));
        }

        // 7. æ•°æ®åˆå¹¶ä¸æŒä¹…åŒ–
        const finalData = [...currentData, ...newFrames];
        window.currentTempFootprints = finalData;
        
        // ğŸš¨ æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œé˜²æ­¢åˆ·æ–°å›é€€
        const todayKey = window.currentFootprintKey;
        if(todayKey) localStorage.setItem(todayKey, JSON.stringify(finalData));
        
        // 8. å”¤é†’ä¿å­˜æŒ‰é’®
        const saveBtn = document.getElementById('btn-save-footprints');
        if (saveBtn) {
            saveBtn.style.display = 'block';
            saveBtn.textContent = "SAVE FULL DAY"; 
            saveBtn.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(50);
        }

        // 9. ç§»é™¤æ›´æ–°æŒ‰é’®ï¼Œé‡ç½®åº•éƒ¨æ–‡å­—
        if (btn) btn.remove();
        
        const divider = footerZone ? footerZone.querySelector('.history-divider') : null;
        if(divider) divider.remove(); 
        
        const div = document.createElement('div');
        div.className = 'history-divider';
        div.textContent = `SYNC COMPLETE // ${currentHour}:00`;
        if(footerZone) footerZone.insertBefore(div, footerZone.firstChild);

    } catch (e) {
        console.error("å¢é‡åŒæ­¥å¤±è´¥:", e);
        showToast("åŒæ­¥ä¸­æ–­: " + e.message);
        if (btn) {
            btn.classList.remove('syncing');
            btn.innerHTML = originalContent;
            btn.style.pointerEvents = 'auto';
        }
    }
}
/* =========================================================
   ğŸš¨ ç¼ºå¤±çš„æ‹ç«‹å¾—æ ¸å¿ƒå‡½æ•°è¡¥ä¸ (è¯·ç›´æ¥ç²˜è´´åˆ° Script ä¸­)
   ========================================================= */

/**
 * 1. ğŸ–‹ï¸ è·å– Luna ä¸“å±ç­¾å (SVG)
 * (è¿™æ˜¯ openFootprintSingle çš„ä¾èµ–å‡½æ•°)
 */
function getFixedLunaSignature() {
    const svgString = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 200">
      <defs>
        <style>
          .sig-path { fill: none; stroke: #000; stroke-linecap: round; stroke-linejoin: round; }
          .star-shape { fill: #000; stroke: none; }
        </style>
      </defs>
      
      <path class="sig-path" stroke-width="7" d="M120,60 C90,20 30,50 30,100 C30,150 80,160 110,130 L125,90" />
      
      <path class="sig-path" stroke-width="5" d="M125,90 Q135,120 155,115 Q175,110 175,85 L175,115 Q175,135 195,125 M195,125 Q205,95 225,95 Q245,95 245,115 L245,130 M245,130 Q255,110 275,110 Q295,110 295,125 Q295,140 275,145 L290,135" />
      
      <path class="sig-path" stroke-width="5" d="M40,155 C120,190 280,180 420,125" />

      <path class="star-shape" d="M435,105 L442,125 L463,125 L446,138 L453,158 L435,145 L417,158 L424,138 L407,125 L428,125 Z" transform="rotate(20 435 130) scale(0.9) translate(40, 10)"/>
    </svg>
    `;
    // ä½¿ç”¨ encodeURIComponent ä¿®å¤ä¸­æ–‡/ç‰¹æ®Šå­—ç¬¦æŠ¥é”™
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
}

/**
 * 2. ğŸ“¸ æ‰“å¼€æ‹ç«‹å¾—è¯¦æƒ…é¡µ (è¢« renderFootprintFrames è°ƒç”¨)
 */
async function openFootprintSingle(frame) {
    console.log("æ­£åœ¨æ‰“å¼€èƒ¶ç‰‡è¯¦æƒ…:", frame);
    const modal = document.getElementById('modal-footprint-single-detail');
    
    // å¦‚æœæ‰¾ä¸åˆ°å¼¹çª— DOMï¼ŒæŠ¥é”™å¹¶é€€å‡º
    if (!modal) {
        console.error("âŒ æ‰¾ä¸åˆ° ID ä¸º modal-footprint-single-detail çš„å¼¹çª—å…ƒç´ ï¼");
        return;
    }

    // å°è¯•è·å–å†…éƒ¨å®¹å™¨ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ª
    let modalFrame = modal.querySelector('.polaroid-detail-frame');
    if (!modalFrame) {
        modal.innerHTML = '<div class="polaroid-detail-frame" onclick="event.stopPropagation()"></div><div class="close-hint-text">TAP ANYWHERE TO CLOSE</div>';
        modalFrame = modal.querySelector('.polaroid-detail-frame');
    }
    
    // è·å– Luna ç­¾å
    const sigUrl = getFixedLunaSignature();

    // æ ¼å¼åŒ–æ—¶é—´
    const now = new Date();
    const dateStr = now.getFullYear() + '.' + String(now.getMonth() + 1).padStart(2, '0') + '.' + String(now.getDate()).padStart(2, '0');
    const timeStr = frame.time_label || "NOW";

    // æ³¨å…¥ HTML
    modalFrame.innerHTML = `
        <div class="polaroid-inner-content">
            <span>â€œ${frame.visual_description}â€</span>
        </div>
        
        <div class="polaroid-full-timestamp">
            ${dateStr} // ${timeStr} FRAME
        </div>

        <div class="gold-signature-container">
            <div class="signature-img-wrapper" 
                 style="-webkit-mask-image: url('${sigUrl}'); mask-image: url('${sigUrl}');">
            </div>
        </div>
    `;

    // æ˜¾ç¤ºå¹¶æ¿€æ´»
    modal.style.display = 'flex';
    // å¼ºåˆ¶é‡ç»˜ä»¥è§¦å‘ transition
    void modal.offsetWidth;
    modal.classList.add('active');

    // ç»‘å®šå…³é—­äº‹ä»¶ (ç‚¹å‡»èƒŒæ™¯å…³é—­)
    modal.onclick = function() {
        closeFootprintSingle();
    };
}

/**
 * 3. ğŸ—‘ï¸ å…³é—­æ‹ç«‹å¾—è¯¦æƒ…é¡µ
 */
function closeFootprintSingle() {
    const modal = document.getElementById('modal-footprint-single-detail');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 400);
    }
}

// ğŸš¨ å¼ºåˆ¶æŒ‚è½½åˆ°å…¨å±€ï¼Œé˜²æ­¢ HTML æ‰¾ä¸åˆ°
window.openFootprintSingle = openFootprintSingle;
window.closeFootprintSingle = closeFootprintSingle;
/* =========================================================
   ğŸ“– [ç™½æ˜¼Â·å…‰å°] æ¡£æ¡ˆé˜…è¯»å™¨æ ¸å¿ƒå¼•æ“
   ========================================================= */

/**
 * 1. å…¥å£ï¼šæ‰“å¼€æŸä¸€å¤©çš„æ¡£æ¡ˆé˜…è¯»å™¨
 * @param {string} dateKey - æ ¼å¼ "2026-01-26"
 */
async function openArchiveReader(dateKey) {
    const char = window.currentViewingChar;
    if (!char) return;

    const page = document.getElementById('subpage-archive-reader');
    const container = document.getElementById('reader-timeline-container');
    const summaryEl = document.getElementById('reader-summary-text');
    
    // 1. è¯»å–æ•°æ®åº“ä¸­çš„å…·ä½“æŸä¸€å¤©
    const historyData = await loadFromDB('footprint_archive_' + char.id) || [];
    const dayData = historyData.find(h => h.dateKey === dateKey);

    if (!dayData) {
        showToast("æ¡£æ¡ˆæ•°æ®ç¼ºå¤±");
        return;
    }

    // 2. æ¸²æŸ“å¤´éƒ¨æ—¥æœŸ
    const dateObj = new Date(dayData.timestamp);
    document.getElementById('reader-day').textContent = dateObj.getDate();
    document.getElementById('reader-month').textContent = dateObj.toLocaleString('en-US', { month: 'long' }).toUpperCase();
    document.getElementById('reader-year').textContent = dateObj.getFullYear();
    document.getElementById('reader-seal-name').textContent = char.name; // åº•éƒ¨ç­¾å

    // 3. æ¸²æŸ“é»‘è‰²èƒ¶ç‰‡åˆ—è¡¨
    container.innerHTML = dayData.frames.map((frame, index) => `
        <div class="archive-film-item" style="animation: fadeInUp 0.5s ease backwards ${index * 0.1}s">
            <span class="archive-time-label">${frame.time_label}</span>
            <div class="black-film-strip" onclick="openFootprintSingleFromArchive(${index})">
                <div class="film-text-preview">â€œ${frame.visual_description}â€</div>
                <div style="font-size:9px; color:#555; margin-top:8px; text-transform:uppercase; letter-spacing:1px;">Click to Enlarge</div>
            </div>
        </div>
    `).join('');

    // ğŸš¨ ä¸´æ—¶å­˜ä¸€ä¸‹å½“å‰æŸ¥çœ‹çš„æ•°æ®ï¼Œç»™ç‚¹å‡»è¯¦æƒ…ç”¨
    window.currentReadingArchive = dayData.frames;

    // 4. ğŸ§  AI æ‘˜è¦ç”Ÿæˆé€»è¾‘ (æ ¸å¿ƒéœ€æ±‚)
    // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡ summaryï¼Œå¦‚æœæœ‰å°±ç›´æ¥ç”¨ï¼Œæ²¡æœ‰å°±è°ƒ AI
    if (dayData.ai_summary) {
        summaryEl.textContent = dayData.ai_summary;
    } else {
        // --- è§¦å‘ AI ç”Ÿæˆ ---
        summaryEl.innerHTML = `<span style="opacity:0.5;">æ­£åœ¨é‡æ„å½“æ—¥è®°å¿†æ‘˜è¦...</span>`;
        generateArchiveSummary(char, dayData, dateKey);
    }

    // 5. ç‰©ç†æ˜¾å½¢
    page.style.display = 'flex';
    void page.offsetWidth;
    page.classList.add('active');
}

/**
 * 2. ğŸ§  AI æ‘˜è¦ç”Ÿæˆå™¨
 * æ ¹æ®äººè®¾ã€å…³ç³»ã€å½“æ—¥å†…å®¹ç”Ÿæˆä¸€å¥å”¯ç¾æ‘˜è¦
 */
async function generateArchiveSummary(char, dayData, dateKey) {
    const summaryEl = document.getElementById('reader-summary-text');
    
    // å‡†å¤‡ Prompt ç´ æ
    const userPersona = JSON.parse(localStorage.getItem('user_persona_data_global')) || { name: "æˆ‘", bio: "ä½ çš„è§‚æµ‹è€…" };
    // æå–å½“å¤©çš„å‰ 5 æ¡å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
    const contextSamples = dayData.frames.slice(0, 8).map(f => f.visual_description).join(" | ");
    
    const prompt = `
    ä½ æ­£åœ¨æ‰®æ¼” [${char.name}]ã€‚
    èƒŒæ™¯è®¾å®š: ${char.desc}
    ä½ ä¸ç”¨æˆ·çš„å…³ç³»: ${userPersona.bio || "äº²å¯†ä¼™ä¼´"}ã€‚

    è¿™æ˜¯ä½ åœ¨ [${dateKey}] è¿™å¤©ç•™ä¸‹çš„è®°å¿†ç¢ç‰‡ï¼š
    "${contextSamples}..."

    è¯·æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œç”¨ã€${char.name}ã€‘çš„å£å»ï¼Œå†™ä¸€å¥**æå…·ç”µå½±æ„Ÿã€å”¯ç¾ã€ç•¥å¸¦ç ´ç¢æ„Ÿ**çš„å·é¦–è¯­ï¼ˆSummaryï¼‰ã€‚
    
    è¦æ±‚ï¼š
    1. åƒæ˜¯åœ¨å†™ç»™â€œæˆ‘â€çœ‹çš„ä¸€å¥ç§å¯†çš„è¯ã€‚
    2. å­—æ•°é™åˆ¶åœ¨ 30-50 å­—ä¹‹é—´ã€‚
    3. ä¸è¦å‡ºç°â€œä»Šå¤©æˆ‘åšäº†ä»€ä¹ˆâ€è¿™ç§æµæ°´è´¦ï¼Œè¦å‡åæƒ…æ„Ÿã€‚
    4. ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å¼•å·ã€‚
    `;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const result = data.choices[0].message.content.trim();

        // 1. æ›´æ–° UI
        typewriterEffect(summaryEl, result); // æ‰“å­—æœºæ•ˆæœä¸Šå±

        // 2. å­˜å…¥æ•°æ®åº“ (é˜²æ­¢ä¸‹æ¬¡æ‰“å¼€è¿˜é‡æ–°ç”Ÿæˆ)
        // æˆ‘ä»¬éœ€è¦æ›´æ–°è¿™ä¸€å¤©çš„æ•°æ®
        let historyData = await loadFromDB('footprint_archive_' + char.id) || [];
        const idx = historyData.findIndex(h => h.dateKey === dateKey);
        if (idx !== -1) {
            historyData[idx].ai_summary = result;
            await saveToDB('footprint_archive_' + char.id, historyData);
            console.log("æ‘˜è¦å·²å­˜æ¡£");
        }

    } catch (e) {
        console.error("Summary Error:", e);
        summaryEl.textContent = "è®°å¿†ä¿¡å·å¾®å¼±ï¼Œæ— æ³•ç”Ÿæˆæ‘˜è¦ã€‚";
    }
}

/**
 * è¾…åŠ©ï¼šé˜…è¯»å™¨é‡Œç‚¹å‡»å°èƒ¶ç‰‡æ‰“å¼€å¤§å›¾
 */
function openFootprintSingleFromArchive(index) {
    if (window.currentReadingArchive && window.currentReadingArchive[index]) {
        // å¤ç”¨ä¹‹å‰çš„æ‹ç«‹å¾—æ‰“å¼€å‡½æ•°
        openFootprintSingle(window.currentReadingArchive[index]);
    }
}

/**
 * è¾…åŠ©ï¼šæ‰“å­—æœºç‰¹æ•ˆ
 */
function typewriterEffect(element, text, speed = 50) {
    element.textContent = "";
    let i = 0;
    function type() {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            setTimeout(type, speed);
        }
    }
    type();
}

function closeArchiveReader() {
    const page = document.getElementById('subpage-archive-reader');
    if(page) page.classList.remove('active');
}

/**
 * ğŸš€ ç»ˆæç‰ˆï¼šTaçš„ç›¸å†Œè½¬å‘å¼•æ“ (ç‰©ç†ç½®é¡¶ç‰ˆ)
 * é€»è¾‘ï¼šé”å®šæ¡£æ¡ˆ -> æ ¼å¼åŒ–æ–‡æœ¬åè®® -> å¼ºåŠ›æ¨å…¥è½¬å‘å±‚ -> å”¤é†’è”ç³»äººåˆ—è¡¨
 */
function forwardTheirsSnap() {
    console.log("%c[Signal] å¯åŠ¨æ¡£æ¡ˆè½¬å‘åè®®...", "color: #007AFF; font-weight: bold;");

    // 1. è·å–å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç¬é—´ ID å’Œæ•°æ®
    const snapId = window.currentViewingSnapId;
    const galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    const snap = galleryDB.find(p => p.id === snapId);

    if (!snap) {
        showToast("âš ï¸ æ— æ³•å®šä½æ—¶ç©ºå­˜æ ¹");
        return;
    }

    // 2. ğŸš¨ æ•°æ®æ ¼å¼åŒ–ï¼šå°† AI æè¿°è½¬æ¢ä¸ºæ ‡å‡†çš„è½¬å‘æ–‡æœ¬åè®®
    // æˆ‘ä»¬æŠŠè¿™æ®µå”¯ç¾çš„æ–‡å­—åŠ ä¸Šæ ‡è¯†ï¼Œæ–¹ä¾¿åœ¨èŠå¤©æ¡†é‡Œæ˜¾ç¤º
    window.pendingForwardData = [{ 
        type: 'text', 
        text: `[æ¥è‡ª ${document.getElementById('theirs-char-name').textContent} çš„ç¬é—´]\nâ€œ${snap.description}â€` 
    }];

    // 3. ğŸš¨ ç‰©ç†å±‚çº§çˆ†ç ´ï¼šå¼ºåˆ¶è°ƒå–è½¬å‘é€‰æ‹©é¡µé¢
    const fwdPage = document.getElementById('page-forward-picker');
    if (fwdPage) {
        // ç¬¬ä¸€æ­¥ï¼šå…ˆå°† display è®¾ä¸º flexï¼Œå¦åˆ™ transform åŠ¨ç”»åœ¨æ‰‹æœºä¸Šå¯èƒ½æ— æ•ˆ
        fwdPage.style.display = 'flex';
        
        // ç¬¬äºŒæ­¥ï¼šç‰©ç†é”å®šæœ€é«˜å±‚çº§ï¼Œå¿…é¡»ç›–è¿‡è¯¦æƒ…é¡µ (100000)
        fwdPage.style.zIndex = '200000'; 
        
        // ç¬¬ä¸‰æ­¥ï¼šå¼ºåˆ¶é‡ç»˜å¹¶è§¦å‘æ»‘å…¥åŠ¨ç”»
        void fwdPage.offsetWidth; 
        fwdPage.style.transform = 'translateY(0)';

        // 4. é©±åŠ¨è”ç³»äººåˆ—è¡¨æ¸²æŸ“
        if (typeof switchForwardTab === 'function') {
            switchForwardTab('friends'); // é»˜è®¤å±•ç¤ºæœ€è¿‘è”ç³»äºº
        }
        
        console.log("âœ… è½¬å‘å±‚å·²å¼ºåŠ›å‹åˆ¶è¯¦æƒ…é¡µå¹¶æ»‘å…¥");
    } else {
        console.error("Critical Error: æ‰¾ä¸åˆ°è½¬å‘é¡µé¢ DOM èŠ‚ç‚¹");
        showToast("ç³»ç»Ÿè½¬å‘åè®®å¼‚å¸¸");
    }
}

/**
 * ğŸ—‘ï¸ åŠŸèƒ½ï¼šç‰©ç†æŠ¹é™¤ Ta çš„ç¬é—´
 */
async function deleteTheirsSnap() {
    const snapId = window.currentViewingSnapId;
    const char = window.currentViewingChar;

    if (typeof showIOSConfirm === 'function') {
        showIOSConfirm(
            "æŠ¹é™¤æ­¤æ®µæ®‹å½±ï¼Ÿ", 
            "è¿™æ®µè¢«æ•è·çš„æ—¶ç©ºç¬é—´å°†æ°¸è¿œæ¶ˆå¤±ï¼Œæ— æ³•å†æ¬¡å›æº¯ã€‚", 
            "æŠ¹é™¤", 
            async function() {
                // 1. ä»æ•°æ®åº“å‰”é™¤
                let galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
                galleryDB = galleryDB.filter(p => p.id !== snapId);
                localStorage.setItem('user_char_galleries', JSON.stringify(galleryDB));

                // 2. ç‰©ç†å…³é—­è¯¦æƒ…é¡µ
                closeTheirsPhotoDetail();

                // 3. å¼ºåˆ¶é‡ç»˜åˆ—è¡¨å’Œå¡ç‰‡è®¡æ•°
                if (typeof renderCharHistoryGrid === 'function') renderCharHistoryGrid(char.id);
                if (typeof renderTheirsGalleries === 'function') renderTheirsGalleries();

                if (typeof triggerSuccessHud === 'function') {
                    triggerSuccessHud("æ®‹å½±å·²å½’äºè™šæ— ");
                }
            }
        );
    }
}
/**
 * ğŸ–‹ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆå®¿å‘½æ„Ÿè§’è‰²å·é¦–è¯­
 * æ ¹æ®ç”¨æˆ·äººè®¾å’Œè§’è‰²äººè®¾ï¼Œç”Ÿæˆä¸€å¥ç”µå½±æ„ŸçŸ­å¥ã€‚
 */
async function generateCharBioIntro(char) {
    const bioUi = document.getElementById('gallery-char-bio-ui');
    if (!bioUi) return;

    // 1. è®¾ç½®åŠ è½½çŠ¶æ€ (é…åˆæ–°çš„CSS)
    bioUi.innerHTML = `<div class="bio-scanning">æ­£åœ¨è§£æ„å‘½è¿ç¾ç»Š...</div>`;

    // 2. æå–å…³ç³»æ•°æ®
    // ä¼˜å…ˆå°è¯•è·å–é’ˆå¯¹è¯¥è§’è‰²çš„ç‰¹å®šäººè®¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨å…¨å±€äººè®¾
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "è§‚å¯Ÿè€…", bio: "æœªçŸ¥çš„æ³¨è§†" };

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");

    // 3. æ„å»ºæç®€ã€é«˜å®¿å‘½æ„Ÿçš„ Prompt
    const prompt = `
# Role: å™äº‹å¼•è¨€ç”Ÿæˆå™¨
# Character A (Target): [${char.name}], èƒŒæ™¯: ${char.desc}
# Character B (User): [${userPersona.name}], å…³ç³»æè¿°: ${userPersona.bio}

# Task:
åŸºäº A å’Œ B çš„å…³ç³»å’Œäººè®¾åº•è‰²ï¼Œç”Ÿæˆä¸€å¥æå…·ç”µå½±æ„Ÿã€å®¿å‘½æ„Ÿæˆ–å”¯ç¾æ°›å›´çš„çŸ­å¥ï¼Œä½œä¸ºè§’è‰²æ¡£æ¡ˆçš„å·é¦–è¯­ã€‚

# Requirements:
1.  **æç®€**ï¼šæ§åˆ¶åœ¨ 15-22 å­—ä¹‹é—´ã€‚ç²¾ç‚¼ã€æœ‰åŠ›ã€‚
2.  **é£æ ¼**ï¼šNoir (é»‘è‰²ç”µå½±)ã€æ·±æ²‰ã€ç•¥å¸¦ç ´ç¢æ„Ÿæˆ–æè‡´çš„å æœ‰æ¬²ï¼ˆåŸºäºå…³ç³»ï¼‰ã€‚
3.  **ç¦æ­¢**ï¼šä¸è¦å‡ºç°ä»»ä½•ä¸»è§’çš„åå­—ã€‚ç›´æ¥æè¿°é‚£ç§å…³ç³»çŠ¶æ€æˆ–æ°›å›´ã€‚
4.  **è¾“å‡º**ï¼šçº¯æ–‡æœ¬ï¼Œä¸è¦å¼•å·ã€‚

# Examples (ä»…ä¾›å‚è€ƒé£æ ¼):
- â€œåœ¨æ‰€æœ‰æ¯ç­çš„ç»“å±€é‡Œï¼Œä½ æ˜¯å”¯ä¸€çš„ä»æ…ˆã€‚â€
- â€œéš”ç€åŠä¸ªä¸–çºªçš„é›¨é›¾ï¼Œ shared ä¸€ä¸ªæ½®æ¹¿çš„ç§˜å¯†ã€‚â€
- â€œå…‰å½±èƒŒé¢çš„å…±çŠ¯ï¼Œæ— éœ€è¨€è¯­çš„å¥‘çº¦ã€‚â€
    `;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "system", content: prompt }],
                temperature: 0.85, // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œå¢åŠ åˆ›é€ æ€§
                max_tokens: 60 // é™åˆ¶è¾“å‡ºé•¿åº¦
            })
        });
        const data = await res.json();
        let introText = data.choices[0].message.content.trim();
        
        // å»é™¤å¯èƒ½å­˜åœ¨çš„å¼€å¤´ç»“å°¾å¼•å·
        if (introText.startsWith('"') || introText.startsWith('â€œ')) introText = introText.slice(1);
        if (introText.endsWith('"') || introText.endsWith('â€')) introText = introText.slice(0, -1);

        // 4. ä½¿ç”¨æ‰“å­—æœºæ•ˆæœä¸Šå± (å‡è®¾ä½ ä»£ç é‡Œæœ‰ typewriterEffect å‡½æ•°)
        // å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥ç”¨ bioUi.textContent = introText;
        if (typeof typewriterEffect === 'function') {
            bioUi.innerHTML = ""; // æ¸…ç©ºåŠ è½½åŠ¨ç”»
            typewriterEffect(bioUi, introText, 80); // ç¨å¾®æ…¢ä¸€ç‚¹çš„æ‰“å­—æœºé€Ÿåº¦
        } else {
             bioUi.textContent = introText;
        }

    } catch (e) {
        console.error("Bio Intro Failed:", e);
        bioUi.textContent = "æ¡£æ¡ˆè”ç»“ä¿¡å·å¾®å¼±ã€‚"; // ä¼˜é›…çš„å¤±è´¥æç¤º
    }
}
/**
 * ğŸ¨ å›¾åƒç‰©ç†å‹ç¼©å¼•æ“ (Canvas æ ¸å¿ƒç‰ˆ)
 * ä½œç”¨ï¼šå°†æ‰‹æœºæ‹æ‘„çš„å¤§å›¾ç‰©ç†ç¼©å°ï¼Œé˜²æ­¢æ’‘çˆ†æµè§ˆå™¨å†…å­˜ï¼Œè§£å†³â€œå‘å¸ƒæ— ååº”â€
 * @param {string} base64 - åŸå§‹å¤§å›¾æ•°æ®
 * @param {number} maxWidth - é”å®šæœ€å¤§å®½åº¦ (å»ºè®® 1000)
 */
function compressImage(base64, maxWidth) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // æ¯”ä¾‹é”å®šç®—æ³•ï¼šå¦‚æœå®½åº¦è¶…è¿‡é™åˆ¶ï¼Œç­‰æ¯”ä¾‹ç¼©å°é«˜åº¦
            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // ç‰©ç†ç»˜åˆ¶ï¼šå°†å›¾åƒç”»å…¥ç”»å¸ƒ
            ctx.drawImage(img, 0, 0, width, height);
            
            // ğŸš¨ æ ¸å¿ƒï¼šå¯¼å‡º 0.7 è´¨é‡çš„ JPGï¼Œä½“ç§¯é€šå¸¸èƒ½ä» 5MB ç¼©å‡åˆ° 200KB
            // è¿™æ · IndexedDB å­˜å…¥æ—¶ä¼šéå¸¸å¿«ï¼Œä¸ä¼šå¯¼è‡´æ‰‹æœºå¡æ­»
            resolve(canvas.toDataURL('image/jpeg', 0.7));
        };
        img.onerror = (err) => {
            console.error("å›¾ç‰‡å‹ç¼©å¼•æ“å¼‚å¸¸:", err);
            resolve(base64); // å¤±è´¥æ—¶é€€å›åŸå›¾ï¼Œä¿è¯ç¨‹åºä¸å´©
        };
    });
}
/**
 * ğŸ“¸ æœ€ç»ˆåˆä½“ç‰ˆï¼šæ”¯æŒåˆ†è”ç³»äººèƒŒæ™¯å¤åˆ» + IndexedDB å¼ºåˆ¶åŒæ­¥
 */
async function batchScreenshot() {
    const selectedRows = document.querySelectorAll('.selected.msg-row');
    if (selectedRows.length === 0) return showToast("å®è´ï¼Œå…ˆå‹¾é€‰æ¶ˆæ¯å‘€~");

    showToast("æ­£åœ¨å¤åˆ»é•¿å›¾...");

    // 1. è·å–å½“å‰èŠå¤©çª—å£å’Œè”ç³»äººä¿¡æ¯
    const chatArea = document.querySelector('.chat-scroll-area') || document.querySelector('.chat-container');
    const contact = window.currentChattingWith;
    const contactId = contact ? contact.id : null;

    // 2. åˆ›å»ºæˆªå›¾ä¸´æ—¶å®¹å™¨
    const container = document.createElement('div');
    Object.assign(container.style, {
        position: 'fixed',
        left: '-9999px',
        width: chatArea.clientWidth + 'px',
        padding: '35px 15px',
        display: 'flex',
        flexDirection: 'column',
        gap: '20px',
        zIndex: '-1',
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        backgroundRepeat: 'no-repeat',
        minHeight: '100px'
    });

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç²¾å‡†å¯¹æ¥ä½ çš„ saveChatBackgroundSettings å­˜å‚¨é€»è¾‘
    try {
        let chatBgData = null;
        if (contactId) {
            console.log(`ã€æ¸²æŸ“æ£€æµ‹ã€‘æ­£åœ¨è¯»å–è”ç³»äºº [${contactId}] çš„ä¸“å±èƒŒæ™¯...`);
            // å¯¹æ¥ä½ ä¿å­˜æ—¶çš„é”®åï¼šchat_bg_data_${contactId}
            chatBgData = await loadFromDB(`chat_bg_data_${contactId}`);
        }

        if (chatBgData) {
            // å¦‚æœæ‹¿åˆ°çš„æ˜¯ Base64 æ•°æ®ï¼Œå¼ºåˆ¶æ³¨å…¥
            container.style.backgroundImage = `url(${chatBgData})`;
            console.log("âœ… ä¸“å±èƒŒæ™¯åŒæ­¥æˆåŠŸ");
        } else {
            // å¦‚æœæ²¡æ‹¿åˆ°ä¸“å±èƒŒæ™¯ï¼Œå°è¯•è¯»å–å…¨å±€è®¾ç½®èƒŒæ™¯ï¼ˆå¯é€‰ï¼‰
            const globalBg = await loadFromDB('settings_bg_data');
            if (globalBg) {
                container.style.backgroundImage = `url(${globalBg})`;
                console.log("âœ… å…¨å±€è®¾ç½®èƒŒæ™¯åŒæ­¥æˆåŠŸ");
            } else {
                // æœ€ç»ˆå…œåº•ï¼šä½¿ç”¨é»˜è®¤æ¸å˜
                container.style.background = "linear-gradient(160deg, #a1fdd4 0%, #c2fbe5 100%)";
                console.warn("â„¹ï¸ æ— èƒŒæ™¯æ•°æ®ï¼Œå·²ä½¿ç”¨é»˜è®¤æ¸å˜å…œåº•");
            }
        }
    } catch (err) {
        console.error("æ•°æ®åº“èƒŒæ™¯è¯»å–å¼‚å¸¸:", err);
        container.style.backgroundColor = "#c2fbe5";
    }

    // 3. å…‹éš†é€‰ä¸­çš„æ¶ˆæ¯å¹¶æ¸…ç† UI
    selectedRows.forEach(row => {
        const clone = row.cloneNode(true);
        // ç§»é™¤å¤é€‰æ¡†
        const cb = clone.querySelector('.msg-check-box') || clone.querySelector('[class*="check"]');
        if (cb) cb.remove();
        
        // æ ·å¼é‡ç½®ï¼Œç¡®ä¿æˆªå›¾å†…ä¸æ˜¾ç¤ºå¤šé€‰æ€çš„é˜´å½±æˆ–è¾¹æ¡†
        clone.classList.remove('multi-selecting', 'selected');
        clone.style.background = 'transparent'; 
        clone.style.transform = 'none';
        clone.style.transition = 'none';
        container.appendChild(clone);
    });

    document.body.appendChild(container);

    try {
        // 4. ä½¿ç”¨ html2canvas æ¸²æŸ“
        const canvas = await html2canvas(container, {
            useCORS: true,
            allowTaint: true,
            scale: 2, 
            backgroundColor: null, // å¿…é¡»ä¸º nullï¼Œå¦åˆ™ä¼šé®ç›– backgroundImage
            logging: true
        });

        const base64Data = canvas.toDataURL("image/png");

        // 5. å­˜å…¥â€œæˆ‘çš„å›¾ç‰‡â€æ•°æ®åº“
        let myPhotos = await loadFromDB('user_my_photos') || [];
        myPhotos.unshift({
            id: 'snap_' + Date.now(),
            src: base64Data,
            time: Date.now(),
            isSnapshot: true 
        });
        await saveToDB('user_my_photos', myPhotos);

        // 6. æˆåŠŸåé¦ˆ
        exitMultiSelect();
        showIOSAlert("æˆªå›¾å·²å­˜å…¥", "é•¿æˆªå›¾å·²ç”Ÿæˆï¼Œå·²å­˜å…¥ã€Œæˆ‘çš„ã€ä¸“å±æ¿å—ã€‚");
        if (typeof renderUserPhotos === 'function') renderUserPhotos(); 

    } catch (e) {
        console.error("âŒ æ¸²æŸ“æµç¨‹å´©æºƒ:", e);
        showToast("åˆæˆå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æŠ¥å‘Š");
    } finally {
        // 7. ç§»é™¤ä¸´æ—¶å…ƒç´ 
        if (document.body.contains(container)) {
            document.body.removeChild(container);
        }
    }
}

/**
 * ğŸ’¾ ä¸“ç”¨æ•°æ®åº“å¯¹æ¥ï¼šæŠŠå›¾å¡è¿› IndexedDB
 */
async function saveSnapshotToAlbum(base64) {
    const key = 'user_my_photos';
    try {
        const compressed = await compressImage(base64, 1200);
        let myPhotos = await loadFromDB(key) || [];
        
        const newPhoto = {
            id: 'snap_' + Date.now(),
            src: compressed,
            date: new Date().toISOString(),
            time: Date.now(),
            isSnapshot: true // ğŸš¨ èµ‹äºˆâ€œæˆªå›¾â€èº«ä»½è¯æ˜
        };

        myPhotos.unshift(newPhoto);
        await saveToDB(key, myPhotos);
        
        // é‡æ–°æ¸²æŸ“ç›¸å†Œè§†å›¾
        if (typeof renderUserPhotos === 'function') renderUserPhotos();
    } catch (err) {
        console.error("Save Failed:", err);
    }
}
/**
 * ğŸ•µï¸ æ§åˆ¶å°ç›‘æµ‹ï¼šæ•è·å½“å‰å¯¹è¯è½®æ¬¡çš„çŠ¶æ€
 * brief: è¿™ä¸€è½®å¯¹è¯çš„æ€»ç»“æ–‡æ¡ˆ
 * mood: è¿™ä¸€è½®ä½“ç°å‡ºçš„æƒ…æ„Ÿé¢‘ç‡ (ä¾‹å¦‚: æš§æ˜§ 85%)
 */
async function captureRoundReflection(brief, mood) {
    console.group("ğŸ” [ç»´åº¦æ•è·] å¯¹è¯è½®æ¬¡ç›‘æµ‹");
    
    const contact = window.currentChattingWith;
    if (!contact) {
        console.error("âŒ æ•è·å¤±è´¥ï¼šæœªæ£€æµ‹åˆ°å½“å‰å¯¹è¯è§’è‰²");
        console.groupEnd();
        return;
    }

    // 1. å‡†å¤‡æ•°æ®è´Ÿè½½
    const reflectionData = {
        id: 'ref_' + Date.now(),
        date: new Date().getTime(),
        charName: contact.name,
        charAvatar: contact.avatar,
        brief: brief || "åœ¨åˆšæ‰çš„äº¤é”‹ä¸­ï¼Œç©ºæ°”çš„æ¹¿åº¦ä¼¼ä¹ä¸Šå‡äº†...",
        mood: mood || "æ³¢åŠ¨ç‡ 92%",
        timestamp: new Date().toLocaleTimeString()
    };

    console.log("ğŸ“¤ æ•è·æ•°æ®:", reflectionData);

    // 2. å­˜å…¥æ•°æ®åº“
    let logs = await loadFromDB('daily_status_logs') || [];
    logs.unshift(reflectionData); 
    await saveToDB('daily_status_logs', logs);

    console.log("âœ… æ•°æ®åº“å†™å…¥æˆåŠŸ");

    // ğŸš¨ æ ¸å¿ƒï¼šä¸ç®¡ç›¸å†Œé¡µå¼€æ²¡å¼€ï¼Œåªè¦æ•°æ®å˜äº†ï¼Œå°±æ‰§è¡Œä¸€æ¬¡æ¸²æŸ“å‡†å¤‡
    // ç¡®ä¿æ•°æ®å†™å…¥åï¼Œè°ƒç”¨ä½ å†™çš„æ¸²æŸ“å‡½æ•°
    await renderDailyStatusFlow(); 
    
    console.log("ğŸ¨ é¢„è§ˆå¡ç‰‡å·²å®æ—¶åˆ·æ–°æ¸²æŸ“é˜Ÿåˆ—");
    console.groupEnd();
    
    // ğŸ’¡ æç¤ºï¼šå¦‚æœæ¸²æŸ“æ­£å¸¸ï¼Œä½ ä¼šçœ‹åˆ°æ§åˆ¶å°å‡ºç°ä¸Šé¢çš„æ—¥å¿—
}

/**
 * ğŸ–¼ï¸ æ¸²æŸ“ä¸»é¡µåˆ—è¡¨ï¼šæ¯å¤©ä»…æ˜¾ç¤ºæœ€æ–°çš„ä¸€æ¡ä½œä¸ºâ€œå°é¢â€
 */
async function renderDailyStatusFlow() {
    const listContainer = document.getElementById('status-flow-list');
    if (!listContainer) return;

    const allLogs = await loadFromDB('daily_status_logs') || [];
    if (allLogs.length === 0) {
        listContainer.innerHTML = `<div style="text-align:center; padding:40px; color:#bbb; font-size:12px; letter-spacing:1px;">NO ARCHIVES TODAY.</div>`;
        return;
    }

    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šæŒ‰æ—¥æœŸå»é‡ï¼Œæ¯å¤©åªç•™æœ€é²œæ´»çš„é‚£ä¸€å¼ 
    const dailyMap = new Map();
    allLogs.forEach(log => {
        const d = new Date(log.date);
        const dateKey = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        // å› ä¸º logs æ˜¯ unshift è¿›å»çš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡é‡åˆ°çš„æ—¥æœŸå°±æ˜¯æœ€æ–°çš„
        if (!dailyMap.has(dateKey)) {
            dailyMap.set(dateKey, log);
        }
    });

    // å°†å»é‡åçš„ Map è½¬å›æ•°ç»„æ¸²æŸ“
    const uniqueLogs = Array.from(dailyMap.values());

    listContainer.innerHTML = uniqueLogs.map(log => {
        const d = new Date(log.date);
        const dateKey = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        
        return `
        <div class="status-day-card" onclick="openDailyCollection('${dateKey}')">
            <div class="card-date-side">
                <span class="day">${d.getDate()}</span>
                <span class="month">${d.toLocaleString('en-US', {month:'short'}).toUpperCase()}</span>
            </div>
            <div class="card-main-content">
                <div class="status-img-wrapper">
                    <img src="${log.charAvatar}" class="status-reflect-img">
                    <div class="snap-type-tag">LATEST REFLECTION</div>
                </div>
                <div class="status-text-area">
                    <div class="status-mood">${log.charName} / ${log.mood}</div>
                    <p class="status-brief">â€œ${log.brief}â€</p>
                    <div class="tap-hint">VIEW ALL ${dailyMap.size > 0 ? 'MOMENTS' : ''} â†’</div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}
/**
 * ğŸ§  ç»´åº¦æ€»ç»“é©±åŠ¨å™¨ï¼šå°†æœ¬è½®å¯¹è¯è½¬åŒ–ä¸ºâ€œé«˜è´¨æ„Ÿæ–‡å­—é•œåƒâ€
 */
async function captureAndGenerateSummary(fullText) {
    const contact = window.currentChattingWith;
    if (!contact) return;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");

        // ğŸš¨ é‡æ–°è®¾è®¡çš„ Promptï¼šä¾§é‡ç¯å¢ƒã€ç©ºé—´ã€æƒ…ç»ªæå†™
        const prompt = `ä½ æ˜¯ä¸€ä¸ªæƒ…æ„Ÿç©ºé—´é‡‡æ ·å™¨ã€‚è¯·åŸºäº AI åˆšæ‰çš„å›å¤å†…å®¹ï¼š["${fullText}"]ã€‚
        1. æå†™å½“å‰æ—¶åˆ»çš„æƒ…ç»ªç¯å¢ƒæ°›å›´ï¼Œè¦åƒç”µå½±é•œå¤´ä¸€æ ·å¯Œæœ‰ç”»é¢æ„Ÿï¼ˆä¾‹å¦‚ï¼šå…‰å½±çš„é”™è½ã€ç©ºæ°”çš„æµé€Ÿã€ç»†å¾®çš„æ„Ÿå®˜å˜å¹»ï¼‰ã€‚
        2. ç»™å‡ºä¸€ä¸ªã€ç»´åº¦å¿ƒæƒ…å‚æ•°ã€‘ï¼ˆä¾‹å¦‚ï¼šå…±é¸£é¢‘ç‡ 96%ï¼‰ã€‚
        è¦æ±‚ï¼š
        - æå†™æ–‡å­—å­—æ•°åœ¨ 50 å­—å·¦å³ï¼Œé£æ ¼è¦é«˜çº§ã€æ¸…å†·ã€å…·è±¡ã€‚
        - ä¸¥ç¦ä½¿ç”¨â€œè¿™æ®µè¯ä¼ é€’äº†...â€è¿™ç±»åºŸè¯ï¼Œç›´æ¥å¼€å§‹æ°›å›´æå†™ã€‚
        æ ¼å¼ï¼šæ°›å›´æè¿°æ–‡å­—|å¿ƒæƒ…å‚æ•°`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8 // è°ƒé«˜ä¸€ç‚¹éšæœºæ€§ï¼Œè®©æ–‡æ¡ˆæ›´æœ‰çµæ°”
            })
        });

        const data = await res.json();
        const result = data.choices[0].message.content.trim();
        const [brief, mood] = result.split('|');

        // è°ƒç”¨æ•è·å‡½æ•°
        if (typeof captureRoundReflection === 'function') {
            await captureRoundReflection(brief || "ç¯å¢ƒé™·å…¥äº†çŸ­æš‚çš„é™é»˜ã€‚", mood || "å…±é¸£ç‡ 100%");
        }
    } catch (e) {
        console.warn("âš ï¸ é•œåƒç”Ÿæˆå¤±è´¥:", e);
    }
}
/**
 * ğŸ“… æ‰“å¼€æŸä¸€å¤©çš„å…¨é‡ç¢ç‰‡æµï¼ˆç€‘å¸ƒæµæ’ç‰ˆï¼‰
 */
async function openDailyCollection(dateKey) {
    const container = document.getElementById('daily-fragments-container');
    const title = document.getElementById('collection-date-title');
    if (!container) return;

    const allLogs = await loadFromDB('daily_status_logs') || [];
    
    // ğŸš¨ è¿™é‡Œä¸è¿‡æ»¤ï¼Œæˆ‘ä»¬è¦æ‹¿èµ°é‚£å¤©çš„æ‰€æœ‰è®°å½•
    const dailyLogs = allLogs.filter(log => {
        const d = new Date(log.date);
        const key = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        return key === dateKey;
    });

    title.innerText = dateKey.toUpperCase();
    
    // æ¸²æŸ“æ¯ä¸€è½®çš„æ–‡å­—å¡ç‰‡ï¼ˆ50å­—æ°›å›´æ„Ÿæ–‡æ¡ˆï¼‰
    container.innerHTML = dailyLogs.map((log, index) => `
        <div class="text-vibe-card">
            <div class="vibe-card-no">#0${dailyLogs.length - index}</div>
            <div class="vibe-card-header">
                <span class="char-badge">${log.charName.toUpperCase()}</span>
                <span class="vibe-time">${new Date(log.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>
            <p class="vibe-content-prose">â€œ${log.brief}â€</p>
            <div class="vibe-card-footer">
                <span class="vibe-mood-tag">${log.mood}</span>
            </div>
        </div>
    `).join('');

    document.getElementById('daily-collection-overlay').classList.add('active');
}

function closeDailyCollection() {
    document.getElementById('daily-collection-overlay').classList.remove('active');
}
/**
 * ğŸµ åˆ‡æ¢éŸ³ä¹ App å†…éƒ¨é¡µé¢
 */
function switchMusicTab(tabName, element) {
    // 1. åˆ‡æ¢é¡µé¢æ˜¾éš
    document.querySelectorAll('.music-view-page').forEach(page => {
        page.classList.remove('active');
    });
    const targetPage = document.getElementById(`music-tab-${tabName}`);
    if (targetPage) targetPage.classList.add('active');

    // 2. åˆ‡æ¢å¯¼èˆªé«˜äº®
    document.querySelectorAll('.nav-capsule-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');

    // ğŸ› ï¸ æ ¸å¿ƒï¼šå¤„ç†æ²‰æµ¸å¼æ¨¡å¼ï¼ˆåªåœ¨ CORE é¡µéšè— UIï¼‰
    const globalHeader = document.querySelector('.music-app-header');
    const globalNav = document.querySelector('.music-navigation-bar');
    const appWindow = document.getElementById('page-musicApp');

    if (tabName === 'core') {
        globalHeader.style.display = 'none'; // éšè—å¤´éƒ¨
        globalNav.style.display = 'none';    // éšè—åº•éƒ¨èƒ¶å›Š
        appWindow.style.overflow = 'hidden'; // ç¦æ­¢å¤–å±‚æ»‘åŠ¨
    } else {
        globalHeader.style.display = 'flex'; // æ¢å¤å¤´éƒ¨
        globalNav.style.display = 'flex';    // æ¢å¤åº•éƒ¨èƒ¶å›Š
        appWindow.style.overflow = 'auto';   // æ¢å¤æ»‘åŠ¨
    }

    // 3. æ›´æ–°é¡¶éƒ¨è‹±æ–‡æ ‡é¢˜
    const titles = {
        'archive': 'ARCHIVE',
        'core': 'NOW PLAYING',
        'synergy': 'SYNERGY FIELD'
    };
    document.getElementById('music-nav-title').innerText = titles[tabName] || 'MUSIC';

    // è§¦è§‰åé¦ˆ
    if (window.navigator.vibrate) window.navigator.vibrate(8);

    if (tabName === 'synergy') initSynergyDial();
}

/**
 * ğŸ” æœç´¢è¿‡æ»¤é€»è¾‘ - è§£å†³ filterMusicArchive is not defined
 */
async function filterMusicArchive() {
    const searchTerm = document.getElementById('music-search').value.toLowerCase();
    const vault = await loadFromDB('lune_music_vault') || [];
    
    // è¿‡æ»¤æ ‡é¢˜æˆ–è‰ºæœ¯å®¶
    const filtered = vault.filter(song => 
        song.title.toLowerCase().includes(searchTerm) || 
        song.artist.toLowerCase().includes(searchTerm)
    );
    
    // é‡æ–°æ¸²æŸ“å±€éƒ¨åˆ—è¡¨
    const container = document.getElementById('music-vault-list');
    if (container) {
        renderList(filtered, container);
    }
}

/**
 * ğŸ“‚ å¼¹çª—ç®¡ç†é€»è¾‘ - è§£å†³ openMusicModal is not defined
 */
function openMusicModal() {
    const modal = document.getElementById('music-upload-modal');
    if (!modal) return console.error("æ‰¾ä¸åˆ° music-upload-modal å®¹å™¨");
    
    // é‡ç½®çŠ¶æ€ä¸ºâ€œæ–°å¢â€
    document.getElementById('editing-song-id').value = "";
    document.getElementById('music-title').value = "";
    document.getElementById('music-artist').value = "";
    document.getElementById('preview-cover').style.display = 'none';
    document.getElementById('cover-tips').style.display = 'flex';
    document.getElementById('modal-mode-title').innerText = "DATA REGISTRATION";
    
    modal.classList.add('active');
}

function closeMusicModal() {
    const modal = document.getElementById('music-upload-modal');
    if (modal) modal.classList.remove('active');
}

/**
 * ğŸ’¾ å¢åˆ æ”¹æŸ¥é€»è¾‘è¡¥å…¨
 */

// æäº¤æ¡£æ¡ˆï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
async function handleArchiveCommit() {
    const id = document.getElementById('editing-song-id').value;
    const title = document.getElementById('music-title').value;
    const artist = document.getElementById('music-artist').value;
    const coverInput = document.getElementById('input-music-cover');
    const audioInput = document.getElementById('input-music-file');

    if (!title || !artist) return showToast("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

    let vault = await loadFromDB('lune_music_vault') || [];
    
    if (id) {
        // ç¼–è¾‘æ¨¡å¼
        const idx = vault.findIndex(s => s.id === id);
        if (idx !== -1) {
            vault[idx].title = title;
            vault[idx].artist = artist;
            if (coverInput.files[0]) vault[idx].cover = await fileToBase64(coverInput.files[0]);
            if (audioInput.files[0]) vault[idx].audio = await fileToBase64(audioInput.files[0]);
        }
    } else {
        // æ–°å¢æ¨¡å¼
        if (!coverInput.files[0] || !audioInput.files[0]) return showToast("è¯·é€‰æ‹©å°é¢å’ŒéŸ³é¢‘æ–‡ä»¶");
        const newSong = {
            id: 'LN-' + Date.now(),
            title, artist,
            cover: await fileToBase64(coverInput.files[0]),
            audio: await fileToBase64(audioInput.files[0]),
            date: Date.now()
        };
        vault.unshift(newSong);
    }

    await saveToDB('lune_music_vault', vault);
    closeMusicModal();
    renderMusicArchive(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    showToast("æ¡£æ¡ˆå·²åŒæ­¥");
}

/**
 * âœ• å”¤èµ·è‡ªå®šä¹‰åˆ é™¤å¼¹çª—
 */
function deleteFromArchive(id, e) {
    // ğŸ›¡ï¸ æ‹¦æˆªå†’æ³¡ï¼Œé˜²æ­¢è¿›å…¥æ’­æ”¾é¡µ
    if (e) e.stopPropagation();

    // 1. è®°å½•è¦åˆ é™¤çš„ ID
    pendingDeleteId = id;
    
    // 2. æ‰“å¼€è‡ªå®šä¹‰å¼¹çª—
    const modal = document.getElementById('delete-confirm-modal');
    if (modal) modal.classList.add('active');
}

/**
 * ğŸ”’ å…³é—­åˆ é™¤å¼¹çª—
 */
function closeDeleteModal() {
    const modal = document.getElementById('delete-confirm-modal');
    if (modal) modal.classList.remove('active');
    pendingDeleteId = null;
}

/**
 * ğŸ”¥ çœŸæ­£çš„ç‰©ç†æŠ¹é™¤æ“ä½œ
 */
async function executeDelete() {
    if (!pendingDeleteId) return;

    // 1. ä»æ•°æ®åº“è¯»å–å¹¶è¿‡æ»¤
    let vault = await loadFromDB('lune_music_vault') || [];
    vault = vault.filter(s => s.id !== pendingDeleteId);

    // 2. ä¿å­˜å›æ•°æ®åº“
    await saveToDB('lune_music_vault', vault);

    // 3. UI äº¤äº’åé¦ˆ
    closeDeleteModal(); // å…³é—­å¼¹çª—
    if (typeof renderMusicArchive === 'function') {
        renderMusicArchive(); // åˆ·æ–°åˆ—è¡¨
    }
    if (typeof showToast === 'function') {
        showToast("RECORD PURGED FROM VAULT");
    }

    console.log("Deleted ID:", pendingDeleteId);
}

/**
 * âœ ç¼–è¾‘åŠŸèƒ½ï¼šå”¤èµ·æ¨¡æ€æ¡†å¹¶å›å¡«æ¡£æ¡ˆæ•°æ®
 * @param {string} id - æ­Œæ›²å”¯ä¸€æ ‡è¯†
 * @param {Event} e - åŸç”Ÿç‚¹å‡»äº‹ä»¶å¯¹è±¡
 */
async function editMusicEntry(id, e) {
    // ğŸ›¡ï¸ æ ¸å¿ƒï¼šé˜»æ­¢äº‹ä»¶å‘ä¸Šä¼ é€’ç»™çˆ¶çº§å¡ç‰‡ï¼ˆé˜²æ­¢è¿›å…¥æ’­æ”¾é¡µï¼‰
    if (e) e.stopPropagation();

    // 1. ä»æ•°æ®åº“è·å–æœ€æ–°æ¡£æ¡ˆ
    let vault = await loadFromDB('lune_music_vault') || [];
    const song = vault.find(s => s.id === id);
    
    if (!song) {
        if (typeof showToast === 'function') showToast("ERROR: DATA NOT FOUND");
        return;
    }

    // 2. å°†æ•°æ®ç²¾å‡†å¡«å…¥æ¨¡æ€æ¡†è¡¨å•
    document.getElementById('editing-song-id').value = song.id;       // éšè— ID åŸŸ
    document.getElementById('music-title').value = song.title;       // æ ‡é¢˜
    document.getElementById('music-artist').value = song.artist;     // è‰ºæœ¯å®¶
    
    // 3. å¤„ç†å°é¢é¢„è§ˆå›¾
    const previewImg = document.getElementById('preview-cover');
    const coverTips = document.getElementById('cover-tips');
    if (previewImg && song.cover) {
        previewImg.src = song.cover;
        previewImg.style.display = 'block';
        if (coverTips) coverTips.style.display = 'none'; // éšè—â€œä¸Šä¼ æç¤ºâ€æ–‡å­—
    }

    // 4. åˆ‡æ¢æ¨¡æ€æ¡†æ ‡é¢˜ä¸ºâ€œç¼–è¾‘æ¨¡å¼â€å¹¶æ‰“å¼€
    const modeTitle = document.getElementById('modal-mode-title');
    if (modeTitle) modeTitle.innerText = "EDIT ARCHIVE";
    
    const modal = document.getElementById('music-upload-modal');
    if (modal) modal.classList.add('active');
    
    console.log("Archive ready for modification:", id);
}

/**
 * ğŸ›ï¸ æ¸²æŸ“ç³»ç»Ÿ
 */
async function renderMusicArchive() {
    const vault = await loadFromDB('lune_music_vault') || [];
    currentPlaylist = vault;
    
    const countEl = document.getElementById('stat-count');
    if(countEl) countEl.innerText = `${vault.length.toString().padStart(2, '0')} TRACKS`;

    const container = document.getElementById('music-vault-list');
    if (container) {
        renderList(vault, container);
    }
}

// æå–å‡ºçš„é€šç”¨æ¸²æŸ“é€»è¾‘
function renderList(data, container) {
    if (data.length === 0) {
        container.innerHTML = `<div style="grid-column:1/3; padding:100px 0; text-align:center; color:#ddd; font-size:10px; letter-spacing:2px;">NO DATA FOUND</div>`;
        return;
    }

    // åœ¨ä½ çš„ renderList æˆ–æ¸²æŸ“å¾ªç¯é‡Œï¼Œç¡®ä¿æŒ‰é’®æ˜¯è¿™æ ·å†™çš„ï¼š
    container.innerHTML = data.map((song, index) => `
        <div class="music-gallery-card" onclick="initiatePlayback('${song.id}')">
            <div class="card-visual-box">
                <img src="${song.cover}">
                <div class="card-serial">0${data.length - index}</div>
            </div>
            <div class="card-info">
                <span class="card-title">${song.title.toUpperCase()}</span>
                <span class="card-artist">${song.artist} / REGISTERED</span>
                
                <div class="card-actions">
                    <div class="action-dot" onclick="editMusicEntry('${song.id}', event)">âœ</div>
                    <div class="action-dot" onclick="deleteFromArchive('${song.id}', event)">âœ•</div>
                </div>
            </div>
        </div>
    `).join('');
}

/**
 * è¾…åŠ©å·¥å…·
 */
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

function previewMusicImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            const preview = document.getElementById('preview-cover');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('cover-tips').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function updateFileName(input) {
    const name = input.files[0] ? input.files[0].name : "SELECT AUDIO";
    document.getElementById('file-name-display').innerText = name.toUpperCase();
}
/**
 * ğŸ’¿ ä¿®å¤ç‰ˆï¼šåŠ è½½å¹¶æ’­æ”¾
 */
// æ¯æ¬¡åˆ‡æ­Œæ—¶è°ƒç”¨çš„æ ¸å¿ƒå‡½æ•°
async function initiatePlayback(id) {
    currentPlayIndex = currentPlaylist.findIndex(s => s.id === id);
    const song = currentPlaylist[currentPlayIndex];
    if (!song) return;

    // 1. UI åŸºæœ¬å›å¡«
    document.getElementById('player-cover').src = song.cover;
    document.getElementById('player-title').innerText = song.title.toUpperCase();
    document.getElementById('player-artist').innerText = song.artist.toUpperCase();
    
    // 2. ç¯å¢ƒèƒŒæ™¯åŒæ­¥ (å¦‚æœè®¾ç½®äº†é«˜æ¸…è‡ªå®šä¹‰å›¾åˆ™åº”ç”¨)
    if (typeof loadPersistentCoreBg === 'function') loadPersistentCoreBg();

    // 3. æ­Œè¯å¤„ç†é€»è¾‘ï¼šè‹¥æœ‰æ­Œè¯åˆ™è§£æï¼Œè‹¥æ— åˆ™æ˜¾ç¤ºâ€œç‚¹å‡»å¯¹é½â€
    const scroller = document.getElementById('lyrics-scroller');
    if (song.lyrics) {
        loadLyrics(song.lyrics); // ä¹‹å‰å†™çš„è§£æå‡½æ•°
    } else {
        scroller.innerHTML = '<p class="lyric-placeholder">NO DATA // CLICK TO REGISTER LYRICS</p>';
    }

    // 4. éŸ³é¢‘å¯åŠ¨
    const audio = document.getElementById('main-audio-engine');
    audio.src = song.audio;
    audio.play();
    updatePlayBtnIcon(true);
    window.syncHomeMusicWidget();

    // 5. æ²‰æµ¸å¼åˆ‡æ¢
    switchMusicTab('core', document.querySelector('.nav-capsule-item:nth-child(2)'));
}

/**
 * âª ä¸Šä¸€é¦–
 */
function playPrevSong() {
    if (currentPlaylist.length === 0) return;
    currentPlayIndex = (currentPlayIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
    initiatePlayback(currentPlaylist[currentPlayIndex].id);
}

/**
 * â© ä¸‹ä¸€é¦–
 */
function playNextSong() {
    if (currentPlaylist.length === 0) return;
    currentPlayIndex = (currentPlayIndex + 1) % currentPlaylist.length;
    initiatePlayback(currentPlaylist[currentPlayIndex].id);
}

/**
 * ğŸ“‹ æ’­æ”¾åˆ—è¡¨æŠ½å±‰ (å…ˆå ä½ï¼Œé˜²æ­¢æŠ¥é”™)
 */
function togglePlaylistDrawer() {
    showToast("PLAYLIST COMING SOON");
    // è¿™é‡Œä»¥åå¯ä»¥å†™æŠ½å±‰å¼¹å‡ºçš„é€»è¾‘
}

// 3. æ­Œè¯å¤„ç†ç³»ç»Ÿ
function openLyricModal() { document.getElementById('lyric-upload-modal').classList.add('active'); }
function closeLyricModal() { document.getElementById('lyric-upload-modal').classList.remove('active'); }

async function handleLrcUpload(input) {
    if (input.files && input.files[0]) {
        const text = await input.files[0].text();
        document.getElementById('lyric-text-input').value = text;
        document.getElementById('lrc-file-name').innerText = input.files[0].name.toUpperCase();
    }
}

// æ ¸å¿ƒï¼šæäº¤æ­Œè¯å¹¶ä¸æ­Œæ›² ID ç»‘å®š
async function commitLyrics() {
    const lyricText = document.getElementById('lyric-text-input').value;
    if (!lyricText) return showToast("LYRICS EMPTY");

    const currentSong = currentPlaylist[currentPlayIndex];
    if (!currentSong) return;

    // 1. æ›´æ–°æ•°æ®åº“ä¸­çš„æ­Œæ›²å¯¹è±¡
    let vault = await loadFromDB('lune_music_vault') || [];
    const idx = vault.findIndex(s => s.id === currentSong.id);
    if (idx !== -1) {
        vault[idx].lyrics = lyricText;
        await saveToDB('lune_music_vault', vault);
        currentPlaylist[idx].lyrics = lyricText; // åŒæ­¥å½“å‰é˜Ÿåˆ—
    }

    // 2. ç«‹å³è§£æå¹¶æ˜¾ç¤º
    loadLyrics(lyricText);
    closeLyricModal();
    showToast("LYRICS ALIGNED");
}

// è§£æ LRC æ ¼å¼
function loadLyrics(lrcContent) {
    const scroller = document.getElementById('lyrics-scroller');
    if (!lrcContent) {
        parsedLyrics = [];
        scroller.innerHTML = '<p class="lyric-placeholder">NO LYRICS DATA</p>';
        return;
    }

    parsedLyrics = lrcContent.split('\n').map(line => {
        const match = line.match(/\[(\d+):(\d+\.\d+)\](.*)/);
        if (match) {
            const time = parseInt(match[1]) * 60 + parseFloat(match[2]);
            return { time, text: match[3].trim() };
        }
        return { time: -1, text: line.trim() };
    }).filter(l => l.text !== "");

    scroller.innerHTML = parsedLyrics.map((l, i) => 
        `<p class="lyric-line" id="lyric-${i}">${l.text}</p>`
    ).join('');
}

// 4. è¿›åº¦åŒæ­¥
function updateProgress() {
    const audio = document.getElementById('main-audio-engine');
    const fill = document.getElementById('progress-fill');
    const currText = document.getElementById('curr-time');
    const totalText = document.getElementById('total-time');

    if (!audio.duration) return;

    const percent = (audio.currentTime / audio.duration) * 100;
    fill.style.width = percent + '%';
    currText.innerText = formatTime(audio.currentTime);
    totalText.innerText = formatTime(audio.duration);

    // åŒæ­¥æ­Œè¯æ»šåŠ¨
    const currentLineIdx = parsedLyrics.findLastIndex(l => audio.currentTime >= l.time);
    if (currentLineIdx !== -1) {
        document.querySelectorAll('.lyric-line').forEach(el => el.classList.remove('active'));
        const activeLine = document.getElementById(`lyric-${currentLineIdx}`);
        if (activeLine) {
            activeLine.classList.add('active');
            const offset = activeLine.offsetTop - 50;
            document.getElementById('lyrics-scroller').style.transform = `translateY(-${offset}px)`;
        }
    }
}

function formatTime(secs) {
    const min = Math.floor(secs / 60);
    const sec = Math.floor(secs % 60);
    return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
}

function seekAudio(e) {
    const audio = document.getElementById('main-audio-engine');
    const rect = e.currentTarget.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    audio.currentTime = percent * audio.duration;
}
/**
 * ğŸ¨ CORE é¡µé¢è‡ªå®šä¹‰èƒŒæ™¯ç³»ç»Ÿ
 */

// 1. å¤„ç†èƒŒæ™¯ä¸Šä¼ å¹¶ä¿å­˜
async function changeCoreBackground(input) {
    if (input.files && input.files[0]) {
        showToast("UPDATING CANVAS...");
        
        const base64 = await fileToBase64(input.files[0]);
        
        // ç»Ÿä¸€å­˜å‚¨ Key
        await saveToDB('lune_core_settings', { bg: base64 });
        
        // ç«‹å³æ¸²æŸ“
        applyCoreBg(base64);
        showToast("CORE THEME UPDATED");
    }
}

// 2. å°†èƒŒæ™¯æ¸²æŸ“åˆ°é¡µé¢ä¸Š
function applyCoreBg(imgData) {
    const bgLayer = document.getElementById('core-custom-bg-layer');
    if (bgLayer && imgData) {
        bgLayer.style.backgroundImage = `url(${imgData})`;
        // æ·»åŠ  class ç¡®ä¿ opacity å˜ä¸º 1
        bgLayer.classList.add('has-bg');
        console.log("âœ… CORE èƒŒæ™¯å·²æ¸²æŸ“");
    } else {
        console.error("âŒ æ‰¾ä¸åˆ°èƒŒæ™¯å±‚å®¹å™¨ core-custom-bg-layer");
    }
}

// 3. ã€æ ¸å¿ƒã€‘åˆ·æ–°é¡µé¢åè‡ªåŠ¨åŠ è½½èƒŒæ™¯
// è¿™ä¸ªå‡½æ•°éœ€è¦ä½ åœ¨ App åˆå§‹åŒ–æˆ–è€… openApp('musicApp') æ—¶è°ƒç”¨ä¸€æ¬¡
async function loadPersistentCoreBg() {
    // ç¡®ä¿ä»æ­£ç¡®çš„ Key è¯»å–
    const savedData = await loadFromDB('lune_core_settings');
    if (savedData && savedData.bg) {
        applyCoreBg(savedData.bg);
    }
}

// 2. æ’­æ”¾æ¨¡å¼é€»è¾‘åˆ‡æ¢
// æ ¸å¿ƒï¼šæ¨¡å¼å›¾æ ‡åˆ‡æ¢ï¼ˆä¿æŒ 2.2px çš„ç²—ç»†ï¼‰
function togglePlaybackMode() {
    const modes = ['order', 'single', 'random'];
    let idx = modes.indexOf(currentPlayMode);
    currentPlayMode = modes[(idx + 1) % modes.length];
    
    const btn = document.getElementById('play-mode-trigger');
    const boldAttr = 'stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"';
    
    if (currentPlayMode === 'order') {
        btn.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" ${boldAttr}><path d="M7 7h10v10H7z"/><path d="M7 12h10M7 15h10M7 18h10"/></svg>`;
        showToast("SEQUENCE");
    } else if (currentPlayMode === 'single') {
        btn.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" ${boldAttr}><path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/><path d="M11 10h1v4"/></svg>`;
        showToast("SINGLE");
    } else {
        btn.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" ${boldAttr}><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>`;
        showToast("RANDOM");
    }
}
/**
 * â¯ï¸ æ ¸å¿ƒï¼šæ’­æ”¾ä¸æš‚åœçš„æ— ç¼åˆ‡æ¢
 */
function togglePlay() {
    const audio = document.getElementById('main-audio-engine');
    const shutter = document.getElementById('play-state-icon');
    
    if (!audio) return console.error("éŸ³é¢‘å¼•æ“æœªå°±ç»ª");

    if (audio.paused) {
        // 1. æ‰§è¡Œæ’­æ”¾
        audio.play().then(() => {
            updatePlayBtnIcon(true); // åˆ‡æ¢ä¸ºæš‚åœå›¾æ ‡
            window.syncHomeMusicWidget(); // ğŸš¨ åŒæ­¥
            if (typeof showToast === 'function') showToast("PLAYING");
        }).catch(err => {
            console.error("æ’­æ”¾å¤±è´¥:", err);
            if (typeof showToast === 'function') showToast("STREAMING ERROR");
        });
    } else {
        // 2. æ‰§è¡Œæš‚åœ
        audio.pause();
        updatePlayBtnIcon(false); // åˆ‡æ¢ä¸ºæ’­æ”¾å›¾æ ‡
        window.syncHomeMusicWidget(); // ğŸš¨ åŒæ­¥
        if (typeof showToast === 'function') showToast("PAUSED");
    }
}

/**
 * ğŸ”„ å›¾æ ‡åŒæ­¥ï¼šæ ¹æ®æ’­æ”¾çŠ¶æ€ç²¾å‡†åˆ‡æ¢åŠ ç²—ç‰ˆ SVG
 * @param {boolean} isPlaying - å½“å‰æ˜¯å¦æ­£åœ¨æ’­æ”¾
 */
function updatePlayBtnIcon(isPlaying) {
    const container = document.getElementById('play-state-icon');
    if (!container) return;

    if (isPlaying) {
        // â¸ï¸ åˆ‡æ¢ä¸ºï¼šåŠ ç²—æš‚åœå›¾æ ‡ (ä¸¤æ¡åšé‡çš„ç«–æ )
        container.innerHTML = `
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <rect x="5" y="4" width="5" height="16" rx="1"/>
                <rect x="14" y="4" width="5" height="16" rx="1"/>
            </svg>`;
    } else {
        // â–¶ï¸ åˆ‡æ¢ä¸ºï¼šåŠ ç²—æ’­æ”¾å›¾æ ‡ (é¥±æ»¡çš„ä¸‰è§’å½¢)
        container.innerHTML = `
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 4v16l12-8L7 4z"/>
            </svg>`;
    }
}

// å±•ç¤ºæ‹’ç»è§†è§‰
function showSynergyReject(contact, aiMsg) {
    const modal = document.getElementById('modal-synergy-reject');
    document.getElementById('reject-ai-msg').textContent = `â€œ${aiMsg}â€`;
    modal.style.display = 'flex';
}

// å…³é—­æ‹’ç»å¼¹çª—
function closeRejectModal() {
    document.getElementById('modal-synergy-reject').style.display = 'none';
    // ç‰©ç†å›åˆ°åˆå§‹é€‰æ‹©é¡µï¼Œä¸è¿›å…¥èŠå¤©
}

// æ˜¾ç¤ºæˆåŠŸè§†è§‰
function showSynergySuccess(contact, aiMsg) {
    const modal = document.getElementById('modal-synergy-success');
    document.getElementById('success-target-name').textContent = contact.name.toUpperCase();
    document.getElementById('success-ai-msg').textContent = `â€œ${aiMsg}â€`;
    window.pendingSynergyMsg = aiMsg; 
    modal.style.display = 'flex';
}

// 3. èŠå¤©ä¸å‘é€
async function sendSynMessage() {
    const input = document.getElementById('syn-input');
    const text = input.value.trim();
    if (!text) return;

    appendSynBubble('user', text);
    input.value = "";

    const contact = window.currentSynergyPartner;
    const song = currentPlaylist[currentPlayIndex] || { title: "æœªçŸ¥" };
    const memory = document.getElementById('syn-memory-micro-tag').textContent;

    // è°ƒç”¨ AI (é€»è¾‘åŒä¸Šï¼Œå¢åŠ å½“å‰æ­Œæ›²ä¸Šä¸‹æ–‡)
    const aiResponse = await callAIAgentForSyn(contact, text, song, memory);
    setTimeout(() => appendSynBubble('ai', aiResponse), 800);
}

function appendSynBubble(role, text) {
    const flow = document.getElementById('synergy-flow');
    const b = document.createElement('div');
    b.className = `syn-bubble ${role}`;
    b.textContent = text;
    flow.appendChild(b);
    flow.scrollTop = flow.scrollHeight;
}
/**
 * ğŸ§  é‡å­è”è§‰ï¼šæ ¸å¿ƒ AI å™äº‹å›å¤å¼•æ“ (å¤šæ®µåŠ¨æ€å›å¤ç‰ˆ)
 * ä½œç”¨ï¼šè·¨ App æŠ“å–æ•°æ®ï¼Œç¼–ç»‡ç¬¦åˆäººè®¾ä¸ä¸–ç•Œè§‚çš„æ·±åº¦å›å¤
 */
async function callAIForSynergy(contact, userText, historyData, songInfo) {
    const apiKey = localStorage.getItem('gpt_key');
    let baseUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    if (!baseUrl.endsWith('/chat/completions')) baseUrl += '/chat/completions';

    if (!apiKey) {
        alert("è¯·å…ˆåœ¨è®¾ç½®é¡µé…ç½® API Key");
        return;
    }

    // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šè·å–æœ¬æˆ‘æ¡£æ¡ˆå’Œç¯å¢ƒæ•°æ®
    const userData = JSON.parse(localStorage.getItem('user_persona_for_' + contact.id)) || {name: "æˆ‘"};
    const sensors = await getAIPerceptionData(); 
    const worldRules = "éµå¾ªä¸–ç•Œåè®®ã€‚"; // è¿™é‡Œå¯ä»¥æ ¹æ®ä½ çš„é€»è¾‘ç»§ç»­æ‰©å±•

    const contextMessages = historyData
        .filter(m => m.text && m.text.trim() !== "")
        .slice(-8)
        .map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            content: m.text
        }));

    const systemPrompt = `
ä½ ç°åœ¨æ˜¯ [${contact.name}]ã€‚ä½ åœ¨ç”µå°æ³¢æ®µå’Œ [${userData.name}] ç§˜å¯†è¿çº¿ã€‚
äººè®¾èƒŒæ™¯: ${contact.desc}ã€‚
å½“å‰ç¯å¢ƒ: æ­£åœ¨å¬ã€Š${songInfo.title}ã€‹- ${songInfo.artist}ã€‚
å½“å‰æ—¶é—´: ${sensors.time}ã€‚
è¦æ±‚: æå…¶å£è¯­åŒ–ã€ç¢ç‰‡åŒ–ã€‚ä¸¥ç¦é•¿æ®µè½ã€‚ä¸¥ç¦åŠ¨ä½œæå†™ã€‚ç”¨ |BR| åˆ†éš”å¥å­ã€‚
`;

    try {
        const res = await fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [
                    { role: "system", content: systemPrompt },
                    ...contextMessages,
                    { role: "user", content: userText || "(é™é™åœ°å¬æ­Œ)" }
                ],
                temperature: 0.9
            })
        });

        const data = await res.json();
        const rawReply = data.choices[0].message.content.trim();

        // æ‹†åˆ†æ¶ˆæ¯åˆ†æ®µå‘é€
        const segments = rawReply.split('|BR|').filter(m => m.trim().length > 0);
        segments.forEach((msg, index) => {
            setTimeout(async () => {
                appendRadioLog('ai', msg.trim());
                await saveChatMessage("synergy_" + contact.id, {
                    role: "opponent",
                    text: msg.trim(),
                    timestamp: Date.now()
                });
            }, index * 1000);
        });

    } catch (e) {
        appendRadioLog('system', "LINK_ERROR: " + e.message);
    }
}

// ğŸš¨ å…³é”®ï¼šæŠ“å–ç”µå°å±å¹•ä¸Šçš„æœ€å 5 æ¡è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
function getRadioContext() {
    const entries = document.querySelectorAll('#radio-terminal-log .log-content');
    return Array.from(entries).slice(-5).map(el => el.textContent).join('\n');
}
/**
 * ğŸ¨ ç¤ºæ³¢å™¨æ³¢å½¢åŠ¨ç”» - è¥é€ å®æ—¶é€šè®¯æ„Ÿ
 */
function initOscilloscope() {
    const canvas = document.getElementById('visual-wave-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let phase = 0;

    function draw() {
        if (!window.isRadioActive) {
            requestAnimationFrame(draw);
            return;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(0, 122, 255, 0.5)'; // ä¿¡å·è“
        ctx.lineWidth = 1.5;

        for (let x = 0; x < canvas.width; x++) {
            // æ¨¡æ‹Ÿæ­£å¼¦æ³¢ï¼Œéšæ—¶é—´ç›¸ä½åç§»
            const y = canvas.height / 2 + Math.sin(x * 0.05 + phase) * 10;
            ctx.lineTo(x, y);
        }
        ctx.stroke();
        phase += 0.1;
        requestAnimationFrame(draw);
    }
    draw();
}
// å¯åŠ¨
initOscilloscope();
/**
 * ğŸ›°ï¸ ç¯å¢ƒä¼ æ„Ÿå™¨ï¼šç‰©ç†æŠ“å–å®æ—¶æ—¶ç©ºå‚æ•°
 */
async function getSynergySensors(contact) {
    // 1. è·å–æ—¶åŒºå¹¶è®¡ç®—å®æ—¶æ—¶é—´
    const tz = localStorage.getItem('sys_timezone') || 'Asia/Shanghai';
    const now = new Date(new Date().toLocaleString("en-US", {timeZone: tz}));
    const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });
    const period = now.getHours() >= 18 || now.getHours() < 6 ? "æ·±å¤œ" : "æ˜¼é—´";

    // 2. è·å–åœ°ç‚¹ä¸å¤©æ°” (ä¼˜å…ˆè§’è‰²æ‰€åœ¨åœ°ï¼Œæ¬¡é€‰å…¨å±€ç¼“å­˜)
    const rawWeather = localStorage.getItem('current_weather');
    const weather = rawWeather ? JSON.parse(rawWeather) : { city: "æœªçŸ¥åæ ‡", temp: "??", condition: "æ³¢æ®µå¹²æ‰°" };

    return {
        time: timeStr,
        period: period,
        location: weather.city || "æœªçŸ¥åŒºåŸŸ",
        weather: `${weather.condition}, ${weather.temp}Â°C`,
        timezone: tz
    };
}
/**
 * ğŸ“¡ ç¤¾åŒºä¿¡å·æ³¨å…¥åè®®
 * æ¨¡æ‹Ÿ AI ç”Ÿæˆçš„ç¤¾åŒºè¯„è®º
 */
function renderAICommunityFeed(npcDataArray) {
    const container = document.getElementById('npc-feed-container');
    if (!container) return;

    container.innerHTML = ""; // æ¸…ç©ºæ—§ä¿¡å·

    npcDataArray.forEach(npc => {
        const card = document.createElement('div');
        card.className = 'npc-community-card';
        
        // è¿™é‡Œçš„ npc æ•°æ®æ˜¯ç”±ä½ ä¹‹å‰çš„ AI é€»è¾‘ç”Ÿæˆçš„
        card.innerHTML = `
            <div class="npc-meta">
                <span class="npc-identity">ID: ${npc.name} // ${npc.location || 'UNKNOWN'}</span>
                <span class="npc-genre-tag">${npc.genre || 'GENERAL'}</span>
            </div>
            <div class="npc-comment">
                ${npc.last_comment || 'è¯¥èŠ‚ç‚¹æš‚æ— å…±é¸£å›å“ã€‚'}
            </div>
            <div class="npc-meta" style="margin-top:10px; opacity:0.6;">
                <span>SENT_FROM: ${new Date().toLocaleTimeString()}</span>
                <span style="color:#007AFF; cursor:pointer;">[ SYNC_SIGNAL ]</span>
            </div>
        `;
        container.appendChild(card);
    });
}

/**
 * ğŸ“¡ ç»´åº¦åˆ‡æ¢
 */
function switchNpcTab(vibe, el) {
    window.currentNpcTab = vibe;
    document.querySelectorAll('.npc-tab-item').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    // åˆ‡æ¢åè‡ªåŠ¨å°è¯•åŒæ­¥ä¸€æ¬¡
    syncCommunitySignals();
}

/**
 * ğŸ›°ï¸ ä¿¡å·åŒæ­¥ (AI è°ƒç”¨æ ¸å¿ƒ)
 */
/**
 * ğŸ“¡ ä¿¡å·æ‰«æåè®® (å…¨æ¨¡å‹å…¼å®¹ V6.0)
 * å…¼å®¹: OpenAI, DeepSeek, Claude, æœ¬åœ°æ¨¡å‹ç­‰
 */
async function syncCommunitySignals() {
    const container = document.getElementById('npc-feed-container');
    const loader = document.getElementById('synergy-invite-loading'); 
    const song = currentPlaylist[currentPlayIndex] || { title: "æœªçŸ¥æ—‹å¾‹" };

    if (loader) loader.style.display = 'flex';
    container.innerHTML = `<div style="text-align:center; padding:50px; font-family:monospace; color:#007AFF;">[ ğŸ›°ï¸ CLEANING_SIGNAL_NOISE... ]</div>`;

    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    if (!apiUrl.endsWith('/chat/completions')) apiUrl += '/chat/completions';
    
    let modelName = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    try {
        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: modelName,
                messages: [{
                    role: "system",
                    // åœ¨ content æŒ‡ä»¤é‡ŒåŠ å…¥è¿™æ®µç¡¬æ ¸è¦æ±‚ï¼š
                    content: `ä½ æ˜¯ä¸€ä¸ªé«˜ç«¯éŸ³ä¹ç¤¾åŒºåå°ã€‚æ­Œæ›²ã€Š${song.title}ã€‹ï¼Œæ ‡ç­¾[${window.currentNpcTab}]ã€‚
                    è¦æ±‚ï¼š
1. ç”Ÿæˆ3ä¸ªå¸–å­ï¼Œã€å…¨éƒ¨ä½¿ç”¨ä¸­æ–‡ã€‘ã€‚
2. ğŸš¨ã€æ ¸å¿ƒè¦æ±‚ã€‘ï¼šä¸ºæ¯ä¸ªå¸–å­ç”Ÿæˆ 3-4 æ¡â€œæ·±åº¦å…±é¸£â€è¯„è®ºï¼Œå­˜æ”¾åœ¨ replies æ•°ç»„é‡Œã€‚
æ ¼å¼ï¼šreplies: [{ u: "ç”¨æˆ·", t: "è¯„è®ºå†…å®¹", l: éšæœºç‚¹èµæ•° }]
3. è¯„è®ºå†…å®¹è¦æ ¹æ®å¸–å­å†…å®¹é‡èº«å®šåˆ¶ï¼Œæœ‰çš„çŠ€åˆ©ï¼Œæœ‰çš„æ„Ÿæ€§ï¼Œæœ‰çš„å¸¦ç‚¹èµ›åšå†·é…·æ„Ÿã€‚
4. è¾“å‡ºæ ¼å¼ï¼šä¸¥æ ¼ JSON æ•°ç»„ï¼ŒåŒ…å« id, name, content, views, likes, loc, vibe, replies:[{u: "æ˜µç§°", t: "è¯„è®ºå†…å®¹"}]ã€‚`
                }],
                temperature: 0.9
            })
        });

        if (!res.ok) throw new Error(`HTTP_${res.status}`);

        const data = await res.json();
        let rawContent = data.choices[0].message.content.trim();

        // ğŸš¨ æ ¸å¿ƒç‰©ç†æ¸…æ´—å±‚ï¼šå¼ºåˆ¶ä¿®æ­£ AI çš„å…¨è§’ç¬¦å·é”™è¯¯
        // å°†ä¸­æ–‡å…¨è§’å¼•å·å¼ºåˆ¶ç‰©ç†æ›¿æ¢ä¸ºæ ‡å‡†åŠè§’åŒå¼•å·
        rawContent = rawContent.replace(/â€œ/g, '"').replace(/â€/g, '"');
        
        // æŠ“å– JSON æ•°ç»„éƒ¨åˆ†
        const jsonMatch = rawContent.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("æ— æ³•å®šä½ä¿¡å·ä¸­çš„æ•°æ®æ ¼å¼");

        let cleanJson = jsonMatch[0];

        // ğŸš¨ äºŒæ¬¡æ¸…æ´—ï¼šå¤„ç†å¯èƒ½å¯¼è‡´è§£æå¤±è´¥çš„éæ³•æ¢è¡Œå’Œæ§åˆ¶ç¬¦
        cleanJson = cleanJson.replace(/[\u0000-\u001F\u007F-\u009F]/g, "");

        try {
            // å°è¯•ç‰©ç†ç‚¹ç«è§£æ
            const posts = JSON.parse(cleanJson);
            window.cachedNpcPosts = posts;
            // åœ¨ renderCommunityFeed(posts) è¿™è¡Œä»£ç ä¸Šæ–¹æ·»åŠ ï¼š
            localStorage.setItem('lune_community_posts', JSON.stringify(posts)); 

            renderCommunityFeed(posts);
        } catch (parseErr) {
            // æœ€åçš„å€”å¼ºï¼šå¦‚æœè¿˜é”™ï¼Œå°è¯•ç‰©ç†å¼ºåˆ¶ä¿®å¤å¼•å·é—­åˆ
            console.warn("å¸¸è§„è§£æå¤±è´¥ï¼Œæ‰§è¡Œæ·±åº¦é€»è¾‘ä¿®å¤...");
            // è¿™ä¸ªæ­£åˆ™å°è¯•ä¿®å¤è¢« AI å¼„æ–­çš„å¼•å·ï¼ˆè¿™æ­¥å¾ˆæš´åŠ›ï¼Œä½†æœ‰æ•ˆï¼‰
            const dirtyRepair = cleanJson.replace(/:\s*"([^"]*)"/g, (m, p1) => {
                return ': "' + p1.replace(/"/g, "'") + '"';
            });
            const posts = JSON.parse(dirtyRepair);
            window.cachedNpcPosts = posts;
            renderCommunityFeed(posts);
        }

    } catch (e) {
        console.error("Signal Sync Critical Error:", e);
        container.innerHTML = `
            <div style="text-align:center; padding:40px; font-family:monospace; color:#FF3B30; border:1px dashed #FF3B30;">
                [ ğŸš¨ SIGNAL_DECODE_FAILED ]<br>
                <span style="font-size:10px; opacity:0.8;">ERROR: ä¿¡å·æ ¼å¼å—æŸ (éæ³•å…¨è§’å­—ç¬¦)</span><br>
                <div onclick="syncCommunitySignals()" style="margin-top:15px; cursor:pointer; color:#007AFF;">[ RE-TRY_DECODING ]</div>
            </div>`;
    } finally {
        if (loader) loader.style.display = 'none';
    }
}

/**
 * ğŸ–¼ï¸ æ¸²æŸ“åˆ—è¡¨
 */
function renderCommunityFeed(posts) {
    const container = document.getElementById('npc-feed-container');
    if (!container) return;
    container.innerHTML = "";

    posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'npc-post-card';
        card.onclick = () => openNpcPostDetail(post);

        // è®¡ç®—ä¿¡å·æ¡
        const strength = Math.ceil((post.strength || 80) / 20);
        let sigHtml = '';
        for(let i=1; i<=5; i++) sigHtml += `<div class="sig-bar ${i<=strength?'active':''}" style="height:${i*3}px"></div>`;

        card.innerHTML = `
            <div class="npc-post-header">
                <div class="npc-identity-group">
                    <span class="npc-post-id">NODE_SR_${post.id}</span>
                    <span class="npc-post-name">${post.name.toUpperCase()}</span>
                </div>
                <div class="signal-strength-viz">${sigHtml}</div>
            </div>
            <div class="npc-post-content">â€œ${post.content}â€</div>
            <div class="npc-post-stats">
                <div class="stats-left">
                    <div class="stat-item">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <span>${post.views}</span>
                    </div>
                    <div class="stat-item">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes}</span>
                    </div>
                </div>
                <div class="stat-item" style="color:#007AFF;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    <span>${post.replies ? post.replies.length : 0}</span>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function closeNpcDetail() {
    document.getElementById('npc-post-detail-overlay').style.display = 'none';
}

function renderCommunityFeed(posts) {
    const container = document.getElementById('npc-feed-container');
    container.innerHTML = "";

    posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'npc-post-card';
        card.onclick = () => openNpcPostDetail(post);

        // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šå°†åŸæœ¬çš„ Emoji æ›¿æ¢ä¸ºæç®€çº¿æ¡ SVG
        card.innerHTML = `
            <div class="npc-post-header">
                <span>ID: ${post.id} // ${post.name}</span>
            </div>
            <div class="npc-post-content">${post.content}</div>
            <div class="npc-post-stats" style="font-family: 'JetBrains Mono', monospace; opacity: 0.8;">
                <div class="stat-item">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px; opacity:0.6;">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>${post.views}</span>
                </div>

                <div class="stat-item">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px; opacity:0.6;">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    <span>${post.likes}</span>
                </div>

                <div class="stat-item">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px; opacity:0.6;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>${post.com_count || (post.replies ? post.replies.length : 0)}</span>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
    
    // è‡ªåŠ¨é‡ç½®æ»šåŠ¨æ¡ä½ç½®
    container.parentElement.scrollTo({ top: 0, behavior: 'smooth' });
}

// ä¿®æ”¹ï¼šç¡®ä¿æ‰“å¼€è¯¦æƒ…é¡µæ—¶è°ƒç”¨æ¸²æŸ“
function openNpcPostDetail(post) {
    // ğŸš¨ è¿™ä¸€æ­¥æ˜¯å…³é”®ï¼Œå¦åˆ™ boost å‡½æ•°æ‰¾ä¸åˆ°æ˜¯è°
    window.currentDetailId = post.id; 

    const overlay = document.getElementById('npc-post-detail-overlay');
    
    // æ³¨å…¥æ•°æ®
    document.getElementById('detail-npc-name').textContent = post.name;
    document.getElementById('detail-content').textContent = post.content;
    document.getElementById('detail-views').textContent = post.views;
    document.getElementById('detail-likes').textContent = post.likes;
    
    // æ¸²æŸ“è¯„è®º (ç¡®ä¿è°ƒç”¨åˆšæ‰å†™çš„æ–°å‡½æ•°)
    const replies = post.replies || [];
    document.getElementById('detail-com-count').textContent = replies.length;
    renderDetailComments(replies);

    overlay.style.display = 'flex';
}
/**
 * âš¡ æ ¸å¿ƒå¼•æ“ï¼šå…¨åŸŸä¿¡å·å¢å¼ºä¸æƒé‡æ ¡å‡†åè®® (V9.0)
 * é€»è¾‘ï¼šæ•°æ®è„‰å†² + å­˜é‡å¹²æ‰° + AI æ‰¹é‡æ³¨å…¥ + ç®—æ³•é‡æ’
 */
async function boostPostStats() {
    const btn = document.querySelector('.btn-boost');
    // 1. è·å–æœ¬åœ°æ•°æ®åº“ä¸­å­˜å‚¨çš„æ‰€æœ‰å¸–å­
    const posts = JSON.parse(localStorage.getItem('lune_community_posts') || "[]");
    
    // 2. å®šä½å½“å‰æ­£åœ¨æµè§ˆçš„å¸–å­ (ç‰©ç†åŒ¹é… ID)
    const postIndex = posts.findIndex(p => String(p.id) === String(window.currentDetailId));

    if (postIndex !== -1) {
        let post = posts[postIndex];

        // 3. å¼€å¯ç‰©ç†é”ä¸åŠ è½½åŠ¨ç”»ï¼Œé˜²æ­¢ AI ç”ŸæˆæœŸé—´é‡å¤ç‚¹å‡»
        if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.textContent = "[ ğŸ›°ï¸ SYNCING_AI_RESONANCE... ]";
        }

        // --- ğŸš€ ç»´åº¦ä¸€ï¼šç‰©ç†å¹²æ‰°è€è¯„è®º (æƒé‡éšæœºåç§») ---
        if (post.replies && post.replies.length > 0) {
            post.replies.forEach(r => {
                // å¢åŠ åŸºç¡€æƒé‡ï¼šæµè§ˆé‡ (Score +1/view)
                r.views = (r.views || 0) + Math.floor(Math.random() * 30 + 10);
                
                // 50% æ¦‚ç‡å¢åŠ ç‚¹èµ (Score +10/like)
                if (Math.random() > 0.5) {
                    r.likes = (r.likes || 0) + Math.floor(Math.random() * 3 + 1);
                }
                
                // 20% æ¦‚ç‡éšæœºç”Ÿå‡ºä¸€ä¸ª NPC å­å›å¤ (Score +5/reply)
                if (Math.random() > 0.8) {
                    r.reply_count = (r.reply_count || 0) + 1;
                    if (!r.nested_replies) r.nested_replies = [];
                    r.nested_replies.push({ 
                        u: "NODE_AUTO_" + Math.floor(Math.random() * 89 + 10), 
                        t: "æ•æ‰åˆ°ä¸€æ®µè‡ªåŠ¨åŒæ­¥çš„ç»´åº¦å›å“ä¿¡å·...",
                        likes: Math.floor(Math.random() * 2)
                    });
                }
            });
        }

        // --- ğŸš€ ç»´åº¦äºŒï¼šé‡å­è¯·æ±‚ AI è·å– 20 æ¡æ–°è¯„è®º ---
        try {
            // è¿™é‡Œè°ƒç”¨æˆ‘ä»¬ä¹‹å‰å†™å¥½çš„ V8.0 ç‰ˆæœ¬çš„ AI ç¼–ç»‡å¼•æ“
            const newBatch = await fetchAiComments(post.content, 20);
            if (newBatch && newBatch.length > 0) {
                // å°†æ–°ç”Ÿçš„ 20 æ¡é«˜è´¨é‡è¯„è®ºï¼ˆåŠå®ƒä»¬çš„åµŒå¥—å­å›å¤ï¼‰æ³¨å…¥åˆ—è¡¨é¡¶ç«¯
                post.replies = [...newBatch, ...post.replies];
                console.log("âœ… 20æ¡å¤šçº§æ–°ä¿¡å·å·²æˆåŠŸæ¥å…¥");
            }
        } catch (e) {
            console.error("AI ç¼–ç»‡å¤±è´¥:", e);
            if (typeof showToast === 'function') showToast("âš ï¸ ä¿¡å·å¹²æ‰°ï¼Œéƒ¨åˆ†æ•°æ®è§£æ„å¤±è´¥");
        }

        // --- ğŸš€ ç»´åº¦ä¸‰ï¼šä¸»è´´å…¨å±€æ•°æ®åŒæ­¥ ---
        post.views += Math.floor(Math.random() * 50 + 50);
        post.likes += Math.floor(Math.random() * 10 + 5);

        // --- ğŸš€ ç»´åº¦å››ï¼šæ•°æ®ç‰©ç†å›ºåŒ–ä¸ UI å®æ—¶é‡ç»˜ ---
        
        // è¦†ç›–ä¿å­˜è‡³æœ¬åœ°æ•°æ®åº“
        posts[postIndex] = post;
        localStorage.setItem('lune_community_posts', JSON.stringify(posts));
        window.cachedNpcPosts = posts; // åŒæ­¥å†…å­˜ç¼“å­˜

        // ç‰©ç†æ›´æ–°è¯¦æƒ…é¡µé¡¶éƒ¨çš„ä»ªè¡¨ç›˜
        const viewsEl = document.getElementById('detail-views');
        const likesEl = document.getElementById('detail-likes');
        const commsEl = document.getElementById('detail-com-count');

        if (viewsEl) viewsEl.textContent = post.views;
        if (likesEl) likesEl.textContent = post.likes;
        if (commsEl) commsEl.textContent = post.replies.length;

        // ğŸš¨ è§¦å‘æ ¸å¿ƒï¼šå¸¦æƒé‡æ’åºç®—æ³•çš„é‡æ–°æ¸²æŸ“
        // è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè‡ªåŠ¨æ‰§è¡Œ [...replies].sort(...) çš„é€»è¾‘
        renderDetailComments(post.replies); 
        
        // ç‰©ç†é©±åŠ¨ï¼šåŒæ­¥åˆ·æ–°å¤–éƒ¨ç¤¾åŒºä¸»é¡µåˆ—è¡¨å¡ç‰‡
        if (typeof renderCommunityFeed === 'function') {
            renderCommunityFeed(posts);
        }

        // æˆåŠŸåé¦ˆ
        if (typeof triggerSuccessHud === 'function') {
            triggerSuccessHud("æƒé‡å·²é‡æ–°æ ¡å‡†");
        }
    }

    // 11. è§£é™¤ç‰©ç†é”ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
    if (btn) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.textContent = "[ AMPLIFY_RESONANCE ]";
    }
}

/**
 * ğŸ›°ï¸ æ¸²æŸ“å¼•æ“ï¼šåŠ¨æ€åŠ æƒå¹³è¡¡ç‰ˆ (æ•°é‡æ ¡å‡†ä¿®æ­£)
 */
/**
 * ğŸ›°ï¸ æ¸²æŸ“å¼•æ“ï¼šåŠ¨æ€åŠ æƒå¹³è¡¡ç‰ˆ (ä¿®å¤ç´¢å¼•é”™ä½ Bug)
 */
function renderDetailComments(replies) {
    const list = document.getElementById('npc-detail-comments-list'); 
    if (!list) return;
    
    if (!replies || replies.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:20px; font-size:11px; color:#8E8E93;">[ NO_RESONANCE_DETECTED ]</div>`;
        return;
    }

    // 1. ğŸ” åŠ¨æ€è®¡ç®—å…¨åœºæœ€é«˜åˆ†
    const maxLikes = Math.max(...replies.map(r => r.likes || 0));

    // ============================================================
    // ğŸš¨ æ ¸å¿ƒä¿®å¤æ­¥éª¤ 1ï¼šå…ˆæ˜ å°„å‡ºåŸå§‹ç´¢å¼• (ç»™æ¯ä¸ªè¯„è®ºå‘èº«ä»½è¯)
    // ============================================================
    const indexedReplies = replies.map((r, i) => ({
        ...r,
        _originalIndex: i // ğŸ‘ˆ è®°ä¸‹å®ƒåœ¨æ•°æ®åº“é‡Œçš„çœŸå®ä½ç½®
    }));

    // 2. æƒé‡æ’åºé€»è¾‘ (å¯¹å¸¦èº«ä»½è¯çš„æ•°ç»„æ’åº)
    const sortedReplies = indexedReplies.sort((a, b) => {
        const countA = a.nested_replies ? a.nested_replies.length : 0;
        const countB = b.nested_replies ? b.nested_replies.length : 0;
        const scoreA = (a.likes || 0) * 15 + countA * 8 + (a.views || 0) * 0.5;
        const scoreB = (b.likes || 0) * 15 + countB * 8 + (b.views || 0) * 0.5;
        return scoreB - scoreA;
    });

    // 3. æ¸²æŸ“
    list.innerHTML = sortedReplies.map((r) => {
        // ğŸš¨ æ³¨æ„ï¼šmap å›è°ƒé‡Œçš„ index åªæ˜¯å½“å‰çš„è§†è§‰é¡ºåºï¼Œæ²¡ç”¨äº†
        // æˆ‘ä»¬å…¨ç¨‹ä½¿ç”¨ r._originalIndex
        
        const actualReplyCount = r.nested_replies ? r.nested_replies.length : 0;
        const hasNested = actualReplyCount > 0;
        
        const isHighlyVoted = (r.likes || 0) >= (maxLikes * 0.8) && (r.likes || 0) > 20;
        const isHighlyViewed = (r.views || 0) > 800;
        const isActuallyHot = (isHighlyVoted && isHighlyViewed) || (isHighlyVoted && actualReplyCount > 2);

        // ğŸš¨ æ ¸å¿ƒä¿®å¤æ­¥éª¤ 2ï¼šonclick å…¨éƒ¨æ”¹æˆ r._originalIndex
        return `
        <div class="npc-comment-item">
            <div class="comment-user-info">
                <span class="comment-uid">NODE_${r.u}</span>
                ${isActuallyHot ? '<span class="hot-tag-luxe">HOT</span>' : ''}
            </div>
            
            <div class="comment-text">${r.t}</div>
            
            <div class="comment-interact-bar">
                <div class="stat-unit">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <span>${r.likes || 0}</span>
                </div>
                <div class="stat-unit">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span>${r.views || 0}</span>
                </div>
                <div class="stat-unit" onclick="openReplySheet(${r._originalIndex})">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    <span>${actualReplyCount}</span>
                </div>
            </div>

            ${hasNested ? `<div class="view-more-replies-btn" onclick="openReplySheet(${r._originalIndex})">å±•å¼€ ${actualReplyCount} æ¡å›å¤</div>` : ''}
        </div>
        `;
    }).join('');
}

/**
 * ğŸ’¬ ç”¨æˆ·ä¸ NPC äº¤äº’ï¼šå‘é€è¯„è®ºå¹¶å³æ—¶æ¸²æŸ“
 */
/**
 * ğŸ’¬ ç”¨æˆ·ä¸ NPC äº¤äº’å¢å¼ºç‰ˆ (å¸¦æŒä¹…åŒ–å­˜å‚¨ä¸å¤šé¡µåŒæ­¥)
 */
function sendReplyToNpc() {
    const input = document.getElementById('user-npc-reply-input');
    const content = input.value.trim();
    if (!content) return;

    // 1. è·å–æœ¬åœ°æ•°æ®åº“ä¸­å­˜å‚¨çš„æ‰€æœ‰å¸–å­ (ç¡®ä¿ openNpcPostDetail æ—¶å­˜äº† window.currentDetailId)
    const posts = JSON.parse(localStorage.getItem('lune_community_posts') || "[]");
    const postIndex = posts.findIndex(p => p.id == window.currentDetailId);

    if (postIndex !== -1) {
        // 2. åˆ›å»ºç”¨æˆ·è¯„è®ºå¯¹è±¡
        const newUserComment = { u: "YOU (Authorized)", t: content };
        
        // 3. ç‰©ç†æ›´æ–°æ•°æ®ï¼šæ’å…¥åˆ°è¯¥å¸–å­çš„å›å¤æ•°ç»„æœ€å‰é¢
        if (!posts[postIndex].replies) posts[postIndex].replies = [];
        posts[postIndex].replies.unshift(newUserComment);

        // 4. æŒä¹…åŒ–å­˜å‚¨ï¼šå­˜å› localStorageï¼Œè¿™æ ·åˆ·æ–°é¡µé¢æ•°æ®ä¾æ—§åœ¨
        localStorage.setItem('lune_community_posts', JSON.stringify(posts));
        window.cachedNpcPosts = posts; // æ›´æ–°å†…å­˜ç¼“å­˜

        // 5. æ¸²æŸ“ç”¨æˆ·è¯„è®ºåˆ°å½“å‰é¡µé¢ (å³æ—¶è§†è§‰åé¦ˆ)
        const list = document.getElementById('detail-comments-list');
        const userCommentDiv = document.createElement('div');
        userCommentDiv.className = 'comment-item';
        userCommentDiv.style = "margin-bottom:20px; border-left:2px solid #007AFF; padding-left:12px; animation: fadeInUp 0.4s ease;";
        userCommentDiv.innerHTML = `
            <div style="font-size:11px; font-weight:700; color:#000; margin-bottom:4px;">YOU (Authorized_User)</div>
            <div style="font-size:13px; color:#333; line-height:1.4;">${content}</div>
        `;
        list.prepend(userCommentDiv);

        // 6. ç‰©ç†åŒæ­¥ï¼šè§¦å‘å¤–éƒ¨åˆ—è¡¨é¡µçš„é‡æ–°æ¸²æŸ“ (æ›´æ–°å¡ç‰‡ä¸Šçš„è¯„è®ºæ•°)
        if (typeof renderCommunityFeed === 'function') {
            renderCommunityFeed(posts);
        }

        // 7. æ¨¡æ‹Ÿ NPC çš„å³æ—¶å›å“ (å¯é€‰ï¼Œå¢åŠ æ°›å›´æ„Ÿ)
        setTimeout(() => {
            const npcBack = document.createElement('div');
            npcBack.className = 'comment-item';
            npcBack.style = "margin-bottom:20px; border-left:2px solid #EEE; padding-left:12px; opacity:0; animation: fadeIn 0.8s forwards;";
            npcBack.innerHTML = `
                <div style="font-size:11px; font-weight:700; color:#007AFF; margin-bottom:4px;">SYSTEM_RESONANCE</div>
                <div style="font-size:13px; color:#8E8E93; line-height:1.4; font-style:italic;">[ å·²æ•è·ä½ çš„æ³¢åŠ¨ä¿¡å·ï¼Œæ­£åœ¨åŒæ­¥è‡³è¯¥èŠ‚ç‚¹... ]</div>
            `;
            list.appendChild(npcBack);
        }, 1200);

        // 8. æ¸…ç©ºå¹¶æ›´æ–°è®¡æ•°å™¨
        input.value = "";
        const comCountEl = document.getElementById('detail-com-count');
        if (comCountEl) comCountEl.textContent = posts[postIndex].replies.length;

    } else {
        console.error("æ— æ³•å®šä½å½“å‰å¸–å­ IDï¼Œè¯·æ£€æŸ¥ openNpcPostDetail æ˜¯å¦è®¾ç½®äº† window.currentDetailId");
    }
}
/**
 * ğŸš€ å¼€å¯å›å¤æŠ½å±‰ (å…¨é‡ç‰©ç†åŠ å›ºç‰ˆ)
 * åŠŸèƒ½ï¼šå±•ç¤ºä¸»è¯„è®ºè¯¦æƒ… + æ¸²æŸ“æ‰€æœ‰å­å›å¤ + å¼€å¯äº’åŠ¨åè®®
 */
async function openReplySheet(commentIndex) {
    // 1. é”å®šç‰©ç†é”šç‚¹ï¼šé˜²æ­¢è¿ç»­ç‚¹å‡»å¯¼è‡´ç´¢å¼•é”™ä¹±
    window.currentActiveCommentIndex = commentIndex;
    
    // 2. å¼ºåˆ¶ä»æ•°æ®åº“çƒ­åŠ è½½ï¼šç¡®ä¿æ‹¿åˆ°æœ€æ–°ã€æœ€å…¨çš„æ•°æ®ï¼ˆåŒ…å«åˆšæ‰ AI åˆšç”Ÿæˆçš„å­å›å¤ï¼‰
    const posts = JSON.parse(localStorage.getItem('lune_community_posts') || "[]");
    // ä½¿ç”¨åŒé‡ä¿é™© ID åŒ¹é… (Stringè½¬æ¢é˜²æ­¢ç±»å‹ä¸ä¸€è‡´)
    const post = posts.find(p => String(p.id) === String(window.currentDetailId));
    
    // ğŸ›¡ï¸ å®‰å…¨æ‹¦æˆªï¼šå¦‚æœæ•°æ®æºä¸¢å¤±ï¼Œé™é»˜å¤±è´¥ä¸æŠ¥é”™
    if (!post || !post.replies || !post.replies[commentIndex]) {
        console.error("Critical: ç›®æ ‡è¯„è®ºæ•°æ®æµä¸­æ–­");
        return;
    }

    const targetComment = post.replies[commentIndex];
    const contentArea = document.getElementById('reply-sheet-content');
    if (!contentArea) return;

    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šä»¥æ•°ç»„çœŸå®é•¿åº¦ä¸ºå”¯ä¸€çœŸç† (ä¸å†ä¿¡ä»» reply_count å­—æ®µ)
    const subList = targetComment.nested_replies || [];
    const actualCount = subList.length;

    // 3. æ„å»º HTML (åŒ…å«ä¸»è¯„è®ºåŒº + è¾“å…¥æ¡† + å­è¯„è®ºåˆ—è¡¨)
    let html = `
        <div class="original-comment-box" style="margin-bottom:25px; background: rgba(0,122,255,0.03); border-radius:18px; padding:20px; border-left:4px solid #007AFF;">
            <div style="font-size:10px; color:#007AFF; font-weight:800; letter-spacing:2px; margin-bottom:8px; text-transform:uppercase;">ORIGINAL_SIGNAL // ${targetComment.u}</div>
            <div style="font-size:16px; color:#1c1c1e; line-height:1.6; font-weight:500;">${targetComment.t}</div>
            
            <div style="display:flex; gap:20px; margin-top:15px; padding-top:15px; border-top:0.5px solid rgba(0,0,0,0.05);">
                <div class="comment-stat-unit" style="font-size:11px; color:#8E8E93; display:flex; align-items:center; gap:5px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span>${targetComment.views || 0} VIEWS</span>
                </div>
                <div class="comment-stat-unit" style="font-size:11px; color:#FF2D55; display:flex; align-items:center; gap:5px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <span>${targetComment.likes || 0} LIKES</span>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div class="reply-divider" style="margin:0; font-size:10px; font-weight:900; color:#ccc; letter-spacing:2px;">RESONANCE_FEED (${actualCount})</div>
            
            <div class="sub-btn" style="background:#1d1d1f; color:#fff; padding:6px 14px; font-size:11px; border-radius:8px; font-weight:800; cursor:pointer;" onclick="toggleNestedInput()">
                + NEW_SIGNAL
            </div>
        </div>

        <div id="nested-reply-box" class="nested-reply-box">
            <textarea id="nested-input-text" placeholder="è¾“å…¥ä½ çš„å›å“..." style="width:100%; height:70px; border:none; background:transparent; outline:none; font-size:14px; resize:none; color:#000; font-family:inherit;"></textarea>
            <div style="display:flex; justify-content:flex-end; padding-top:10px; border-top:0.5px solid #eee;">
                <button class="ios-btn primary" style="width:80px; height:32px; font-size:12px; padding:0; background:#007AFF;" onclick="submitNestedReply()">TRANSMIT</button>
            </div>
        </div>

        <div id="sub-replies-list" style="padding-bottom:60px;">
    `;

    // 4. æ¸²æŸ“å­è¯„è®ºæµ (å¸¦åŠ¨ç”»å»¶è¿Ÿ)
    if (subList.length > 0) {
        subList.forEach((sub, subIdx) => {
            html += `
                <div class="comment-item" style="margin-bottom:20px; padding-bottom:15px; border-bottom:0.5px solid #f2f2f7; animation: fadeInUp 0.4s ease backwards; animation-delay:${subIdx * 0.05}s;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <span style="font-family:monospace; font-size:11px; color:#007AFF; font-weight:800;">NODE_SUB_${sub.u}</span>
                        <span style="font-size:9px; color:#ddd; letter-spacing:1px;">QUANTUM_SYNC</span>
                    </div>
                    <div style="font-size:14px; color:#333; line-height:1.5;">${sub.t}</div>
                    
                    <div class="sub-interact-btns" style="display:flex; gap:15px; margin-top:10px;">
                        <div class="sub-btn" style="display:flex; align-items:center; gap:5px; font-size:11px; color:#FF2D55; background:transparent; padding:0; cursor:pointer;" onclick="likeSubComment(${subIdx})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            <span>${sub.likes || 0}</span>
                        </div>
                        <div class="sub-btn" style="display:flex; align-items:center; gap:5px; font-size:11px; color:#8E8E93; background:transparent; padding:0; cursor:pointer;" onclick="toggleNestedInput()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                            <span>REPLY</span>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        html += `
            <div style="text-align:center; padding:50px 20px; color:#ddd; display:flex; flex-direction:column; align-items:center; gap:15px;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity:0.3;"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                <div style="font-size:11px; font-family:monospace; letter-spacing:2px; font-weight:700;">[ WAITING_FOR_SIGNAL_RESONANCE ]</div>
            </div>`;
    }

    html += `</div>`; // é—­åˆåˆ—è¡¨
    contentArea.innerHTML = html;

    // 5. ç‰©ç†å”¤é†’æŠ½å±‰
    const mask = document.getElementById('npc-reply-sheet-mask');
    if (mask) {
        mask.style.display = 'flex';
        // å¼ºåˆ¶é‡ç½®æ»šåŠ¨æ¡
        contentArea.scrollTop = 0;
        console.log(`%c[UI] æˆåŠŸå¼€å¯å›å¤æ¬¡å…ƒï¼Œå…±åŠ è½½ ${actualCount} æ¡ä¿¡å·`, "color: #34C759;");
    }
}

/**
 * ğŸ› ï¸ è¾…åŠ©é€»è¾‘ A: åˆ‡æ¢ä¸‹æ‹‰è¾“å…¥æ¡†
 */
function toggleNestedInput() {
    const box = document.getElementById('nested-reply-box');
    if (!box) return;
    box.classList.toggle('active');
    if(box.classList.contains('active')) {
        document.getElementById('nested-input-text').focus();
    }
}

/**
 * ğŸ› ï¸ è¾…åŠ©é€»è¾‘ B: å­å›å¤ç‚¹èµåè®®
 */
async function likeSubComment(subIdx) {
    const posts = JSON.parse(localStorage.getItem('lune_community_posts') || "[]");
    const postIndex = posts.findIndex(p => String(p.id) === String(window.currentDetailId));
    const commentIndex = window.currentActiveCommentIndex;

    if (postIndex !== -1) {
        const subReplies = posts[postIndex].replies[commentIndex].nested_replies;
        if (subReplies && subReplies[subIdx]) {
            subReplies[subIdx].likes = (subReplies[subIdx].likes || 0) + 1;
            localStorage.setItem('lune_community_posts', JSON.stringify(posts));
            
            // å±€éƒ¨é™é»˜åˆ·æ–°æŠ½å±‰ï¼Œä¿æŒè§†è§‰è¿è´¯
            openReplySheet(commentIndex); 
            if(navigator.vibrate) navigator.vibrate(10); // ç‰©ç†éœ‡åŠ¨åé¦ˆ
        }
    }
}

// 2. æäº¤å­å›å¤
async function submitNestedReply() {
    const textEl = document.getElementById('nested-input-text');
    const text = textEl.value.trim();
    if (!text) return;

    // é‡æ–°è·å–æœ€æ–°æ•°æ®
    const posts = JSON.parse(localStorage.getItem('lune_community_posts') || "[]");
    const postIndex = posts.findIndex(p => String(p.id) === String(window.currentDetailId));
    const commentIndex = window.currentActiveCommentIndex;

    if (postIndex !== -1) {
        let post = posts[postIndex];
        let targetComment = post.replies[commentIndex];

        if (!targetComment.nested_replies) targetComment.nested_replies = [];
        
        // 1. æ’å…¥æ•°æ®
        targetComment.nested_replies.unshift({
            u: "YOU_AUTHORIZED",
            t: text,
            likes: 0,
            time: Date.now()
        });

        // ğŸš¨ 2. æ ¸å¿ƒè¡¥ä¸ï¼šå¼ºåˆ¶åŒæ­¥ reply_countï¼Œè®©å®ƒç­‰äºæ•°ç»„é•¿åº¦
        targetComment.reply_count = targetComment.nested_replies.length;

        // 3. ä¿å­˜
        posts[postIndex] = post;
        localStorage.setItem('lune_community_posts', JSON.stringify(posts));
        
        // 4. æ¸…ç©ºè¾“å…¥æ¡†
        textEl.value = "";
        
        // 5. ğŸš¨ åŒé‡åˆ·æ–°ï¼šåŒæ—¶æ›´æ–° æŠ½å±‰ å’Œ è¯¦æƒ…é¡µ
        await openReplySheet(commentIndex); // åˆ·æ–°æŠ½å±‰ (æ˜¾ç¤º N+1)
        renderDetailComments(post.replies); // åˆ·æ–°è¯¦æƒ…é¡µèƒŒæ™¯ (æ˜¾ç¤º N+1)
        
        triggerSuccessHud("å›å“å·²åŒæ­¥");
    }
}
/**
 * ğŸ”’ å…³é—­å›å¤è¯¦æƒ…æŠ½å±‰
 */
function closeReplySheet() {
    const mask = document.getElementById('npc-reply-sheet-mask');
    if (mask) {
        // 1. å…ˆè§¦å‘æ»‘ä¸‹åŠ¨ç”»ï¼ˆå¦‚æœä½ æœ‰ CSS åŠ¨ç”»çš„è¯ï¼‰
        const sheet = mask.querySelector('.npc-reply-sheet');
        if (sheet) {
            // å¦‚æœä½ æƒ³è¦æ›´ä¸æ»‘çš„å…³é—­åŠ¨ç”»ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š
            // sheet.style.transform = 'translateY(100%)'; 
        }

        // 2. ç‰©ç†éšè—
        mask.style.display = 'none';
        
        // 3. æ¢å¤ä¸»é¡µé¢çš„äº¤äº’æ„Ÿ
        console.log("%c[System] å›å¤æ¬¡å…ƒå·²å…³é—­", "color: #8E8E93;");
    }
}

// ğŸš¨ å¼ºæ•ˆç‰©ç†æŒ‚è½½ï¼šç¡®ä¿ HTML çš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.closeReplySheet = closeReplySheet;
/**
 * ğŸ§  é‡å­è”è§‰å¼•æ“ï¼šä¸»+å­è¯„è®ºæ‰¹é‡ç¼–ç»‡ç‰ˆ
 * ä½œç”¨ï¼šä¸€æ¬¡æ€§ç”Ÿæˆ 20 æ¡ä¸»è¯„è®ºï¼Œå¹¶ä¸ºéƒ¨åˆ†ä¸»è¯„è®ºç”ŸæˆåµŒå¥—å­å›å¤
 */
async function fetchAiComments(postContent, count = 20) {
    const apiKey = localStorage.getItem('gpt_key');
    // è‡ªåŠ¨é€‚é… DeepSeek æˆ– OpenAI
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
    
    let currentModel = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) currentModel = "deepseek-chat";

    // ğŸ­ System Prompt: å¢å¼ºäº†å¯¹åµŒå¥—ç»“æ„çš„æƒé‡æè¿°
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå…ˆé”‹èµ›åšè‰ºæœ¯ç¤¾åŒºçš„åå°é€»è¾‘ã€‚
å½“å‰å¸–å­å†…å®¹: "${postContent}"ã€‚
ä»»åŠ¡: ç”Ÿæˆ ${count} æ¡ç‹¬ç«‹çš„ä¸»è¯„è®ºã€‚

ğŸš¨ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘ï¼š
1. è¯­è¨€ï¼šç®€ä½“ä¸­æ–‡ã€‚é£æ ¼ï¼šè‰ºæœ¯é‰´èµå®¶ã€æ¯’èˆŒæ ç²¾ã€ç ´ç¢æ„Ÿæ–‡é’ã€èµ›åšå±…æ°‘ã€‚
2. éŸ³ä¹çœŸå®æ€§ï¼šæ¶‰åŠæ­Œåå¿…é¡»çœŸå®å­˜åœ¨ï¼Œç¦æ­¢çç¼–ã€‚
3. ğŸš¨ã€é«˜å¯†åº¦åµŒå¥—å¼ºåˆ¶ä»¤ã€‘ï¼š
   - å¿…é¡»æœ‰è‡³å°‘ 5 æ¡è¯„è®ºåŒ…å« "nested_replies" æ•°ç»„ï¼ˆé‡Œé¢æ”¾ 3-8 æ¡å­å›å¤ï¼‰ã€‚
   - å­å›å¤å¿…é¡»æ˜¯é’ˆå¯¹ä¸»è¯„è®ºçš„äº‰è®ºæˆ–å…±é¸£ã€‚
   - ä¸¥ç¦æ‰€æœ‰è¯„è®ºéƒ½æ²¡æœ‰å­å›å¤ï¼

4. ç‰©ç†å®‰å…¨ï¼šä¸¥ç¦ä½¿ç”¨å•å¼•å·ä½œä¸º JSON å®šç•Œç¬¦ï¼Œç¡®ä¿ JSON æ ¼å¼ç»å¯¹æ ‡å‡†ã€‚

è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š
[
  {
    "u": "ç”¨æˆ·A", 
    "t": "ä¸»è¯„è®ºå†…å®¹", 
    "likes": 20, 
    "views": 100, 
    "nested_replies": [
       {"u": "è·¯äººB", "t": "å­å›å¤å†…å®¹", "likes": 5}
    ]
  }
]`;

    try {
        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: currentModel,
                messages: [{ role: "system", content: systemPrompt }],
                temperature: 0.9,
                max_tokens: 8000
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error ? data.error.message : "API Error");
        
        let rawContent = data.choices[0].message.content.trim();
        
        // --- ç‰©ç†æ¸…æ´— ---
        rawContent = rawContent.replace(/```json/g, "").replace(/```/g, "").trim();
        const jsonMatch = rawContent.match(/\[[\s\S]*\]/s);
        if (!jsonMatch) throw new Error("ä¿¡å·æ ¼å¼è§£ç å¤±è´¥");

        // ğŸš¨ é”™è¯¯ä¿®å¤ç‚¹ï¼šè¿™é‡Œä¸èƒ½ returnï¼å¿…é¡»èµ‹å€¼ç»™å˜é‡ç»§ç»­å¾€ä¸‹è·‘ï¼
        // é¢„å¤„ç†ä¸­æ–‡å¼•å·
        const jsonString = jsonMatch[0].replace(/â€œ/g, '"').replace(/â€/g, '"');
        
        let sanitizedData;
        try {
            sanitizedData = JSON.parse(jsonString);
        } catch (e) {
            console.warn("JSON Parse å¤±è´¥ï¼Œå°è¯•ç‰©ç†çŸ«æ­£...", e);
            // æš´åŠ›å®¹é”™ï¼šå°è¯•ç”¨ new Function è§£æä¸è§„èŒƒçš„ JSON (æ¯”å¦‚å¸¦å•å¼•å·çš„)
            sanitizedData = new Function("return " + jsonString)();
        }

        // --- ğŸš¨ ç‰©ç†å¯¹é½æ ¸å¿ƒ (ä¹‹å‰è¢«ä½ æˆªæ–­äº†) ---
        // è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒè´Ÿè´£æŠŠ AI æ¼æ‰çš„å­è¯„è®ºç»“æ„è¡¥å…¨
        if (Array.isArray(sanitizedData)) {
            sanitizedData.forEach(post => {
                // 1. ç¡®ä¿ nested_replies å­˜åœ¨ä¸”æ˜¯æ•°ç»„
                if (!post.nested_replies || !Array.isArray(post.nested_replies)) {
                    post.nested_replies = [];
                }

                // 2. å¼ºåˆ¶åŒæ­¥ reply_countï¼Œç¡®ä¿ UI æ˜¾ç¤ºæ•°å­—æ­£ç¡®
                post.reply_count = post.nested_replies.length;

                // 3. è¡¥å…¨å­å›å¤çš„ç¼ºçœå­—æ®µ (é˜²æ­¢ AI å·æ‡’æ²¡å†™ç‚¹èµæ•°)
                post.nested_replies.forEach(sub => {
                    if (!sub.likes) sub.likes = 0;
                    if (!sub.u) sub.u = "ANONYMOUS";
                });
            });
        } else {
             // å¦‚æœ AI æ²¡è¿”å›æ•°ç»„ï¼Œå¼ºè¡ŒåŒ…è£…æˆæ•°ç»„
             sanitizedData = [sanitizedData];
        }

        console.log("âœ… ä¿¡å·è§£æå®Œæˆï¼ŒåŒ…å«å­å›å¤æ•°é‡:", sanitizedData.reduce((acc, p) => acc + p.reply_count, 0));
        
        return sanitizedData; // ğŸ‘ˆ è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„è¿”å›ç‚¹

    } catch (e) {
        console.error("AI ç¼–ç»‡å¤±è´¥:", e);
        if(typeof showToast === 'function') showToast("ç”Ÿæˆå¤±è´¥: " + e.message);
        return null;
    }
}
/**
 * ğŸ’¬ è§¦å‘ AI å¯¹æŸæ¡ç‰¹å®šè¯„è®ºè¿›è¡Œå›å¤
 */
async function triggerAiSubReply(commentIndex) {
    const posts = JSON.parse(localStorage.getItem('lune_community_posts') || "[]");
    const postIndex = posts.findIndex(p => String(p.id) === String(window.currentDetailId));
    const targetComment = posts[postIndex].replies[commentIndex];

    showToast("AI æ­£åœ¨æ€è€ƒå¦‚ä½•å›æ€¼...");

    const aiResponse = await fetchAiComments(`é’ˆå¯¹è¿™æ¡è¯„è®ºè¿›è¡Œå›å¤: "${targetComment.t}"`, 1);

    if (aiResponse && aiResponse[0]) {
        if (!targetComment.nested_replies) targetComment.nested_replies = [];
        targetComment.nested_replies.push(aiResponse[0]);
        targetComment.reply_count = targetComment.nested_replies.length;

        posts[postIndex].replies[commentIndex] = targetComment;
        localStorage.setItem('lune_community_posts', JSON.stringify(posts));
        
        openReplySheet(commentIndex); // åˆ·æ–°æŠ½å±‰
        renderDetailComments(posts[postIndex].replies); // åˆ·æ–°åˆ—è¡¨
    }
}
// === ğŸ“± æ‰‹æœºç«¯å¼ºåˆ¶äº‹ä»¶ç»‘å®šè¡¥ä¸ ===
document.addEventListener('DOMContentLoaded', () => {
    // å¼ºåˆ¶ç»‘å®šç”µå°å‘é€æŒ‰é’®
    const transmitBtn = document.querySelector('.transmit-btn');
    if (transmitBtn) {
        transmitBtn.onclick = null;
        transmitBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.transmitCommand();
        });
    }

    // å¼ºåˆ¶ç»‘å®šç”µå° AI æŒ‰é’®
    const radioAiBtn = document.querySelector('.reply-btn');
    if (radioAiBtn) {
        radioAiBtn.onclick = null;
        radioAiBtn.addEventListener('click', (e) => {
            e.preventDefault();
            window.requestAIReply();
        });
    }

    replyBtns.forEach(btn => {
        // 1. å…ˆç§»é™¤æ‰€æœ‰æ—§çš„ onclickï¼Œé˜²æ­¢å†²çª
        btn.onclick = null; 
        
        // 2. é‡æ–°ç»‘å®šè§¦æ‘¸äº‹ä»¶ (touchend åœ¨æ‰‹æœºä¸Šååº”æ›´å¿«)
        btn.addEventListener('touchend', function(e) {
            e.preventDefault(); // é˜²æ­¢è§¦å‘ä¸¤æ¬¡
            console.log("ğŸ“± æ‰‹æœºç«¯å¼ºåˆ¶è§¦å‘ Reply");
            window.requestAIReply();
        });
        
        // 3. åŒæ—¶ä¹Ÿç»‘å®šç‚¹å‡»äº‹ä»¶ (å…¼å®¹ç”µè„‘)
        btn.addEventListener('click', function(e) {
            console.log("ğŸ’» ç”µè„‘ç«¯è§¦å‘ Reply");
            window.requestAIReply();
        });
    });
    
    console.log("âœ… æŒ‰é’®äº‹ä»¶å·²å¼ºåˆ¶é‡ç½®");
});

// ==========================================
// ğŸ“ ç”µè¯ Appï¼šé€šè¯è®°å½•æ ¸å¿ƒä¿®å¤
// ==========================================

// 2. æ ¸å¿ƒï¼šæ™ºèƒ½æ—¶é—´æ ¼å¼åŒ– (è§£å†³ä½ çš„æ—¶é—´æ˜¾ç¤ºé—®é¢˜)
function formatSmartTime(ts) {
    const now = new Date();
    const date = new Date(ts);
    
    // åˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€å¤©
    const isToday = now.getDate() === date.getDate() && 
                    now.getMonth() === date.getMonth() && 
                    now.getFullYear() === date.getFullYear();

    // æå–æ—¶é—´ HH:mm
    const timeStr = date.getHours().toString().padStart(2, '0') + ':' + 
                    date.getMinutes().toString().padStart(2, '0');

    if (isToday) {
        // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
        return timeStr;
    } else {
        // å¦‚æœæ˜¯ä»¥å‰ï¼Œæ˜¾ç¤º å¹´/æœˆ/æ—¥ æ—¶é—´
        const y = date.getFullYear();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const d = date.getDate().toString().padStart(2, '0');
        return `${y}/${m}/${d} ${timeStr}`;
    }
}

// ==========================================
// ğŸ“ é€šè¯è®°å½•æ ¸å¿ƒé€»è¾‘ (å®æ—¶æ•°æ®åº“ç‰ˆ)
// ==========================================

// 1. ç­›é€‰å™¨åˆ‡æ¢
function filterRecents(type) {
    window.currentRecentsFilter = type; // æ›´æ–°å…¨å±€è¿‡æ»¤çŠ¶æ€
    
    // åˆ‡æ¢æŒ‰é’® UI
    document.getElementById('seg-all').classList.toggle('active', type === 'all');
    document.getElementById('seg-missed').classList.toggle('active', type === 'missed');

    // é‡æ–°ä»æ•°æ®åº“è¯»å–å¹¶æ¸²æŸ“
    renderRecentsList();
}

// 5. åˆå§‹åŒ–ï¼šé¡µé¢åŠ è½½æ—¶è¿è¡Œä¸€æ¬¡
document.addEventListener('DOMContentLoaded', () => {
    renderRecentsList();
});

// --- ğŸ“ é¡¶éƒ¨é€Ÿæ‹¨æ ï¼šæ¸²æŸ“ä¸ºç«–å‘è¯¦ç»†åˆ—è¡¨ ---
async function renderQuickDial() {
    const container = document.getElementById('quick-dial-list');
    if(!container) return;

    // 1. è¯»å–é€šè¯è®°å½•
    let recents = await loadFromDB('phone_recents') || [];
    
    // 2. æŒ‰æ—¶é—´å€’åº (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
    recents.sort((a, b) => b.time - a.time);

    // 3. æˆªå–æœ€è¿‘ 20 æ¡ (åˆ—è¡¨é•¿ä¸€ç‚¹æ²¡å…³ç³»)
    const displayList = recents.slice(0, 20);

    // 4. ç©ºçŠ¶æ€
    if (displayList.length === 0) {
        container.innerHTML = `
            <div style="width:100%; text-align:center; padding-top:40px; color:#999; font-size:13px;">
                æ— é€šè¯è®°å½•
            </div>`;
        return;
    }

    // 5. æ¸²æŸ“åˆ—è¡¨
    container.innerHTML = displayList.map(item => {
        // --- A. æ—¶é—´æ ¼å¼åŒ– (YYYY.MM.DD HH:mm) ---
        const d = new Date(item.time);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hour = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        const fullTimeStr = `${year}.${month}.${day} ${hour}:${min}`;

        // --- B. çŠ¶æ€åˆ¤å®š ---
        const isMissed = item.type === 'missed';
        
        // çŠ¶æ€æ–‡å­—ä¸å›¾æ ‡
        let statusText = "";
        let iconHtml = "";
        
        if (isMissed) {
            statusText = "æœªæ¥æ¥ç”µ";
            // çº¢è‰²æ„Ÿå¹å·å›¾æ ‡
            iconHtml = `<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="#FF3B30" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`;
        } else if (item.type === 'outgoing') {
            statusText = "å‘¼å‡º";
            // æŒ‡å‘å³ä¸Šè§’çš„ç®­å¤´
            iconHtml = `<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="2.5"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>`;
        } else {
            statusText = "æ¥ç”µ";
            // æŒ‡å‘å·¦ä¸‹è§’çš„ç®­å¤´
            iconHtml = `<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="2.5"><line x1="17" y1="7" x2="7" y2="17"></line><polyline points="17 17 7 17 7 7"></polyline></svg>`;
        }

        // --- C. æ—¶é•¿æ˜¾ç¤º ---
        // å¦‚æœæ•°æ®åº“é‡Œæ²¡æœ‰ duration å­—æ®µï¼Œæ˜¾ç¤ºå ä½ç¬¦
        const durationStr = item.duration ? item.duration : (isMissed ? "" : "00:00");

        return `
        <div class="quick-record-card ${isMissed ? 'missed' : ''}" onclick="startCall('${item.name}', '${item.avatar}', '${item.targetId}')">
            
            <img class="quick-card-avatar" src="${item.avatar}">
            
            <div class="quick-card-info">
                <div class="quick-card-name">${item.name}</div>
                
                <div class="quick-card-meta-row">
                    ${iconHtml}
                    <span>${statusText}</span>
                    <span style="width:1px; height:10px; background:#ddd;"></span>
                    <span>${fullTimeStr}</span>
                    ${durationStr ? `<span style="margin-left:auto; font-family:monospace;">${durationStr}</span>` : ''}
                </div>
            </div>

            <div style="width:20px; text-align:center; color:#007AFF;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
            </div>

        </div>
        `;
    }).join('');
}

// ç‚¹å‡»å¤´åƒï¼šè‡ªåŠ¨å¡«å…¥åå­—æˆ–å·ç 
function quickFill(name) {
    const display = document.getElementById('keypad-number-display');
    const delBtn = document.getElementById('keypad-del-btn');
    
    // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼ŒæŠŠåå­—è½¬æ¢æˆå‡å·ç ï¼Œæˆ–è€…ç›´æ¥å¡«åå­—
    // å®é™…å•†ç”¨å¯ä»¥å­˜çœŸå® phone å­—æ®µ
    display.textContent = name; 
    
    // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
    if(delBtn) delBtn.style.display = 'block';
    
    // éœ‡åŠ¨
    if(navigator.vibrate) navigator.vibrate(10);
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', renderQuickDial);

function closePhoneAddModal() {
    document.getElementById('modal-phone-add-contact').style.display = 'none';
}

// 4. æ¸²æŸ“å¯¼å…¥åˆ—è¡¨ (ä»è§’è‰²ä¹¦è¯»å–)
async function renderImportGrid() {
    const list = document.getElementById('phone-import-grid');
    const chars = await loadFromDB('char_list') || [];
    
    // è·å–å·²æœ‰çš„ç”µè¯åº“ï¼Œç”¨äºå›æ˜¾
    const phoneDir = await loadFromDB('phone_directory') || {};

    list.innerHTML = "";
    if (chars.length === 0) {
        list.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#ccc;">ç©º</div>`; return;
    }
    
    chars.forEach(c => {
        const div = document.createElement('div');
        div.className = 'import-item';
        div.innerHTML = `<img class="import-avatar" src="${c.avatar}"><span class="import-name">${c.name}</span>`;
        div.onclick = () => {
            // UI é€‰ä¸­æ€
            document.querySelectorAll('.import-item').forEach(el => el.classList.remove('selected'));
            div.classList.add('selected');
            
            // åŸæ¥ï¼šselectedImportId = c.id;
            // å»ºè®®æ”¹ä¸ºï¼š
            window.selectedImportId = c.id;
            
            // æç¤ºæ–‡å­—
            document.getElementById('import-selected-name').textContent = c.name;
            document.getElementById('import-selection-hint').style.display = 'block';

            // å°è¯•å›æ˜¾ç”µè¯å·ç  (å¦‚æœä¹‹å‰å­˜è¿‡)
            // æŸ¥æ‰¾ Key: "id_è§’è‰²ID"
            const savedNum = phoneDir["id_" + c.id];
            if (savedNum) {
                document.getElementById('common-phone-in').value = savedNum;
            } else {
                document.getElementById('common-phone-in').value = ""; // æ²¡å­˜è¿‡å°±æ¸…ç©ºï¼Œè®©ç”¨æˆ·å¡«
            }
        };
        list.appendChild(div);
    });
}

// è¾…åŠ©ï¼šç”Ÿæˆéšæœºå·ç 
function generateRandomPhone() {
    return "1" + Math.floor(Math.random() * 9000000000 + 1000000000);
}

// 3. æ¸²æŸ“ä¸–ç•Œä¹¦å‹¾é€‰åˆ—è¡¨
async function renderPhoneWorldList() {
    const container = document.getElementById('phone-world-list');
    const worlds = await loadFromDB('world_list') || [];
    
    if (worlds.length === 0) {
        container.innerHTML = `<div style="padding:15px; font-size:12px; color:#ccc; text-align:center;">æš‚æ— ä¸–ç•Œè®¾å®š</div>`;
        return;
    }

    container.innerHTML = worlds.map(w => `
        <div class="ios-list-item" style="background:transparent; border-bottom:0.5px solid rgba(0,0,0,0.05);">
            <div class="item-content" style="border:none;">
                <span class="item-label" style="font-size:14px; font-weight:500;">${w.name}</span>
                <input type="checkbox" class="world-checkbox phone-world-check" value="${w.id}" style="width:20px; height:20px;">
            </div>
        </div>
    `).join('');
}

// --- â± è®¡æ—¶å™¨é€»è¾‘ ---
// è®¡æ—¶å™¨ä¿®å¤ç‰ˆ
function startCallTimer() {
    callSeconds = 0;
    // æ¯æ¬¡æ‰§è¡Œéƒ½é‡æ–°è·å–å…ƒç´ ï¼Œç¡®ä¿å®ƒå­˜åœ¨
    const getTimerEl = () => document.getElementById('call-timer'); 
    
    if (callTimerInterval) clearInterval(callTimerInterval);
    
    callTimerInterval = setInterval(() => {
        callSeconds++;
        const mins = Math.floor(callSeconds / 60).toString().padStart(2, '0');
        const secs = (callSeconds % 60).toString().padStart(2, '0');
        
        const el = getTimerEl();
        if(el) el.innerText = `${mins}:${secs}`;
    }, 1000);
}

function stopCallTimer() {
    if (callTimerInterval) clearInterval(callTimerInterval);
}

// ==========================================
// ğŸ“ çœŸå® AI é€šè¯æ ¸å¿ƒ (UI å®æ—¶ä¿®å¤ + ç²¾å‡† Session å­˜ç›˜ç‰ˆ)
// ==========================================

async function executeAICallResponse(contactId, userText) {
    window.isCallAiProcessing = true;
    const captionArea = document.getElementById('call-caption-area');
    
    // 1. UI: æ˜¾ç¤ºæ€è€ƒä¸­
    if (captionArea) {
        captionArea.innerHTML = `
            <div class="caption-text-bubble" style="padding:10px 20px;">
                <div class="typing-dots"><span></span><span></span><span></span></div>
            </div>
        `;
    }

    try {
        const apiKey = localStorage.getItem('gpt_key');
        let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        if (!apiUrl.endsWith('/chat/completions')) apiUrl += '/chat/completions';
        const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

        const charList = await loadFromDB('char_list') || [];
        const charData = charList.find(c => c.id === contactId);
        if (!charData) throw new Error("è§’è‰²æ¡£æ¡ˆä¸¢å¤±");

        const userKey = 'user_persona_for_' + contactId;
        const userPersona = JSON.parse(localStorage.getItem(userKey)) || { name: "æˆ‘" };
        let friends = await loadFromDB('chat_friends') || [];
        let friendData = friends.find(f => f.id === contactId);
        
        let targetLang = "Simplified Chinese"; 
        let needTrans = false;
        if (friendData && friendData.settings && friendData.settings.charLang) {
            const code = friendData.settings.charLang;
            
            // ğŸš¨ ç›´æ¥å¼•ç”¨å…¨å±€çš„ LANG_MAP é¿å…é‡å¤å®šä¹‰
            const fullName = LANG_MAP[code] || "Simplified Chinese";
            
            // æå–æ‹¬å·å‰çš„è‹±æ–‡åç»™ Prompt ç”¨ (ä¾‹å¦‚æŠŠ "French (æ³•è¯­)" å˜æˆ "French")
            targetLang = fullName.split(' (')[0]; 
            
            // åªæœ‰éä¸­æ–‡æ‰éœ€è¦ç¿»è¯‘
            if (code !== 'zh' && code !== 'cn') needTrans = true;
        }

        // --- B. æ„å»º System Prompt (ç»å¯¹ç…§æŠ„ï¼Œä¸€å­—ä¸æ”¹) ---
        const systemPrompt = `
# ğŸš¨ LANGUAGE MANDATE (æœ€é«˜ä¼˜å…ˆçº§):
You MUST reply in **[${targetLang}]**.${needTrans ? ' You MUST append a Chinese translation at the end of each segment using [TRANS] tag.' : ' Reply in Chinese directly.'}

# Role: ä½ æ˜¯ [${charData.name}]ã€‚
# User: æ­£åœ¨é€šè¯çš„æ˜¯ [${userPersona.name}]ã€‚
# Background: ${charData.desc}ã€‚
# Context: è¿™æ˜¯ä¸€ä¸ªå®æ—¶çš„ã€è¯­éŸ³é€šè¯ã€‘ã€‚

# ğŸš¨ æ ¸å¿ƒæŒ‡ä»¤ (å¿…é¡»ä¸¥æ ¼éµå®ˆ):

1. **å½»åº•ä»£å…¥äººè®¾ & ä¸¥ç¦åŠ¨ä½œ**ï¼š
    - è¯­æ°”è‡ªç„¶ã€ç”Ÿæ´»åŒ–ã€ç¬¦åˆä½ ä»¬çš„å…³ç³»ï¼ˆ${userPersona.bio || 'äº²å¯†'}ï¼‰ã€‚
    - ğŸš¨ **æ­»å‘½ä»¤**ï¼šè¿™æ˜¯ç”µè¯ï¼ä¸¥ç¦å‡ºç° (ç‚¹å¤´)ã€*å¹æ°”*ã€(çœ‹ç€çª—å¤–) ç­‰ä»»ä½•æ‹¬å·å†…å®¹ï¼åªè¾“å‡ºå˜´é‡Œè¯´å‡ºæ¥çš„è¯ã€‚

2. **ğŸš¨ åŠ¨æ€åˆ†æ®µä¸é•¿åº¦æ§åˆ¶ (å™äº‹ç‰¹æƒ)**ï¼š
    - **æ—¥å¸¸é—²èŠ**ï¼šè¯·å›å¤ **3-7 ä¸ª** è‡ªç„¶çš„è¯­éŸ³ç‰‡æ®µã€‚
    - **ğŸš¨ è®²æ•…äº‹/é•¿å™è¿°/å“„ç¡**ï¼šå¦‚æœç”¨æˆ·è¦æ±‚è®²æ•…äº‹æˆ–è§£é‡Šå¤æ‚äº‹æƒ…ï¼Œ**è¯·æ‰“ç ´é•¿åº¦é™åˆ¶ï¼** åŠ¡å¿…æ‹†åˆ†ä¸º **6-15 ä¸ªç”šè‡³æ›´å¤š** çš„çŸ­å¥ç‰‡æ®µï¼è¦åƒè¿è½½ä¸€æ ·å¨“å¨“é“æ¥ï¼Œä¸è¦ä¸€æ¬¡æ€§è¯´å®Œã€‚
    - **åˆ†éš”ç¬¦**ï¼šæ‰€æœ‰ç‰‡æ®µä¹‹é—´å¿…é¡»ç”¨ **|BR|** åˆ†éš”ã€‚

3. **ç¿»è¯‘å¯¹é½åè®®**ï¼š
    ${needTrans 
      ? `- ğŸš¨ **åŒè¯­å¼ºåˆ¶**ï¼šæ¯ä¸€ä¸ªè¢« |BR| åˆ†éš”çš„ç‰‡æ®µï¼Œéƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆæ ¼å¼ï¼šã€${targetLang}åŸæ–‡ [TRANS] ä¸­æ–‡ç¿»è¯‘ã€‘ã€‚
      - âŒ é”™è¯¯ç¤ºèŒƒï¼šHello |BR| How are you [TRANS] ä½ å¥½å—
      - âœ… æ­£ç¡®ç¤ºèŒƒï¼š
        Once upon a time... [TRANS] å¾ˆä¹…å¾ˆä¹…ä»¥å‰... |BR| 
        There was a star. [TRANS] æœ‰ä¸€é¢—æ˜Ÿæ˜Ÿã€‚ |BR| 
        It fell into your eyes. [TRANS] å®ƒè½è¿›äº†ä½ çš„çœ¼ç›é‡Œã€‚` 
      : '- ç›´æ¥è¾“å‡ºä¸­æ–‡å£è¯­ï¼Œä½¿ç”¨ |BR| åˆ†éš”é•¿å¥ã€‚'}

ç”¨æˆ·è¯´ï¼š${userText}
`;

        let reinforcement = (needTrans) 
            ? `\n\n(SYSTEM NOTE: Reply in [${targetLang}]! Append [TRANS] Chinese translation after every sentence. Do NOT separate translation with |BR|.)`
            : `\n\n(SYSTEM NOTE: Reply in [${targetLang}] directly.)`;

        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userText + reinforcement }],
                temperature: 0.8,
                max_tokens: 1500
            })
        });

        const data = await res.json();
        let aiRawText = data.choices[0].message.content.trim();

        // --- D. ç¢ç‰‡æ‹†è§£ä¸åˆå¹¶é€»è¾‘ (ä¿®å¤ç¿»è¯‘ä¹±å¥—çš„å…³é”®) ---
        let cleanText = aiRawText.replace(/ï¼ˆ.*?ï¼‰/g, '').replace(/\(.*?\)/g, '').replace(/\*.*?\*/g, '');
        let rawSegments = cleanText.includes('|BR|') ? cleanText.split('|BR|') : cleanText.split(/([ã€‚ï¼ï¼Ÿ.!?]+)/).filter(s => s.trim().length > 0);
        
        let mergedSegments = [];
        for (let i = 0; i < rawSegments.length; i++) {
            let seg = rawSegments[i].trim();
            if (!seg) continue;
            // ä¿®å¤ï¼šå¦‚æœç‰‡æ®µæ˜¯ä»¥ [TRANS] å¼€å¤´ï¼Œè¯´æ˜æ˜¯ä¸Šä¸€å¥è¢«é”™åˆ‡çš„ç¿»è¯‘ï¼Œç²˜å›å»
            if (seg.startsWith('[TRANS]') && mergedSegments.length > 0) {
                mergedSegments[mergedSegments.length - 1] += " " + seg;
            } else if (needTrans && /^[\u4e00-\u9fa5]/.test(seg) && !seg.includes('[TRANS]') && mergedSegments.length > 0) {
                mergedSegments[mergedSegments.length - 1] += " [TRANS] " + seg;
            } else {
                mergedSegments.push(seg);
            }
        }

        // ğŸš€ è°ƒç”¨æ¸²æŸ“æµï¼Œä¸€æ¬¡æ€§ä¸¢å…¥ mergedSegments
        await renderCallCaptionFlow(mergedSegments, contactId, friendData);

    } catch (e) {
        console.error("Call Error:", e);
        if (captionArea) captionArea.innerHTML = `<div class="caption-text-bubble" style="color:red;">Error: ${e.message}</div>`;
    } finally {
        window.isCallAiProcessing = false;
    }
}

// ==========================================
// ğŸï¸ åŠ¨æ€å­—å¹•æµæ¸²æŸ“å™¨ (æ’­æ§ä¸­å¿ƒå…¨é‡ç‰ˆ)
// ==========================================
async function renderCallCaptionFlow(segments, contactId, friendData) {
    const area = document.getElementById('call-caption-area');
    if (!area || !segments) return;

    // 1. ç‰©ç†æ¸…ç©ºåˆšæ‰æ€è€ƒä¸­çš„ dots
    area.innerHTML = "";

    const voiceId = friendData?.settings?.voiceId;
    const minimaxOn = friendData?.settings?.minimaxEnabled;

    for (let i = 0; i < segments.length; i++) {
        let segment = segments[i].trim();
        if (!segment) continue;

        let origin = segment, trans = "";
        if (segment.includes('[TRANS]')) {
            const parts = segment.split('[TRANS]');
            origin = parts[0].trim();
            trans = parts[1].trim();
        }

        // 2. ç‰©ç†æ¸²æŸ“ Live UI (è¿½åŠ æ¨¡å¼ï¼Œä¸æ˜¯æ›¿æ¢æ¨¡å¼ï¼)
        const bubble = document.createElement('div');
        bubble.className = 'caption-text-bubble';
        bubble.style.marginTop = "10px";
        bubble.style.animation = "captionSlideUp 0.3s ease-out both";
        
        bubble.innerHTML = `
            <div class="cap-origin" style="font-size:17px; font-weight:600; color:#fff;">${origin}</div>
            ${trans ? `<div class="cap-trans" style="font-size:13px; margin-top:4px; opacity:0.8; border-top:1px solid rgba(255,255,255,0.1); padding-top:4px; color:#eee;">${trans}</div>` : ''}
        `;
        area.appendChild(bubble); // ğŸš¨ è¿™é‡Œç”¨ appendChildï¼Œè§£å†³â€œåªæœ‰ä¸€æ¡â€çš„é—®é¢˜
        area.scrollTop = area.scrollHeight;

        // ğŸš¨ 3. ç²¾å‡†åˆ‡åˆ†å­˜ç›˜ (è§£å†³å†å²è®°å½•â€œä¸€ä¸ªå¤§æ°”æ³¡â€é—®é¢˜)
        // å°† [TRANS] ç‰©ç†æ¢æˆ \n é€‚é…é«˜çº§è¯¦æƒ…é¡µ
        const dbText = segment.replace(/\[TRANS\]\s*/g, "\n").trim();
        saveChatMessage(contactId, {
            role: "opponent", // è¿˜åŸä¸ºæ‚¨ä¹‹å‰çš„ role å
            text: dbText,
            type: "call_log",
            sessionId: window.currentCallSessionId, // ç»‘å®šä¼šè¯ ID
            timestamp: Date.now() + (i * 10)
        });

        // 4. èŠ‚å¥æ§åˆ¶
        if (voiceId && minimaxOn) {
            await speakText(segment, voiceId);
            await new Promise(r => setTimeout(r, 600));
        } else {
            const readTime = Math.max(1500, origin.length * 150);
            if (typeof toggleAvatarSpeaking === 'function') toggleAvatarSpeaking(true);
            await new Promise(r => setTimeout(r, readTime));
            if (typeof toggleAvatarSpeaking === 'function') toggleAvatarSpeaking(false);
        }
    }
}

/**
 * ğŸ› ï¸ è¾…åŠ©ï¼šåˆ›å»ºå•ä¸ªåŒè¯­å¡ç‰‡
 */
function createBubble(container, text, trans, delay) {
    // è¿‡æ»¤æ‰å¤ªçŸ­çš„æ— æ„ä¹‰å­—ç¬¦
    if (!text || text.length < 1) return;

    const div = document.createElement('div');
    div.className = 'caption-card';
    div.style.animationDelay = delay + 's'; // é˜¶æ¢¯å¼è¿›åœºåŠ¨ç”»
    div.style.animationFillMode = 'backwards'; // æ²¡å‡ºæ¥å‰ä¿æŒéšè—

    let html = `<div class="cap-text-main">${text}</div>`;
    
    if (trans) {
        html += `<div class="cap-text-sub">${trans}</div>`;
    }

    div.innerHTML = html;
    container.appendChild(div);
}

// 3. åºåˆ—æ’­æ”¾å™¨ï¼šå°†é•¿æ®µè½åˆ‡åˆ†ä¸ºå¤šæ¡å­—å¹•ä¾æ¬¡æ’­æ”¾
async function playCaptionSequence(fullText) {
    // A. é¢„å¤„ç†ï¼šç§»é™¤æ‹¬å·åŠ¨ä½œæå†™ (ä¿ç•™å¹²å‡€çš„å¯¹è¯)
    let cleanText = fullText.replace(/ï¼ˆ.*?ï¼‰/g, '').replace(/\(.*?\)/g, '').trim();
    
    // B. åˆ†å‰²é€»è¾‘ï¼šæŒ‰å¥å­åˆ†å‰² (æ”¯æŒä¸­æ–‡å¥å·ã€è‹±æ–‡å¥å·ã€æ„Ÿå¹å·ã€é—®å·)
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¿æŠ¤ [TRANS] æ ‡ç­¾ä¸è¢«åˆ‡æ–­
    // ç®€å•ç­–ç•¥ï¼šå¦‚æœæ–‡æœ¬å¾ˆé•¿ï¼Œæˆ‘ä»¬å¯ä»¥ä¸åˆ‡åˆ†ï¼Œç›´æ¥ç”¨ä¸Šé¢ CSS çš„æ»šåŠ¨åŠŸèƒ½ã€‚
    // ä½†ä¸ºäº†â€œå¤šæ¡å›å¤â€çš„æ•ˆæœï¼Œæˆ‘ä»¬è¿™é‡Œæ¨¡æ‹Ÿ AI åˆ†æ®µè¯´è¯ã€‚
    
    // è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ¸²æŸ“æ•´æ®µï¼ˆé…åˆä¸Šé¢çš„ CSSï¼Œå·²ç»å¾ˆç¾äº†ï¼‰ï¼Œ
    // æˆ–è€…ä½ å¯ä»¥é€‰æ‹©æŠŠé•¿æ–‡æœ¬æ‹†æˆæ•°ç»„ï¼Œæ¯éš” 3 ç§’æ¢ä¸€å¥ã€‚
    // é‰´äºä½ çš„éœ€æ±‚æ˜¯â€œä¸æƒ³åªå›å¤ä¸€å¥è¯â€ï¼Œæˆ‘ä»¬ç›´æ¥æ¸²æŸ“æ•´æ®µå¯Œæ–‡æœ¬ï¼š
    
    renderCallCaption(cleanText);
}

// 4. æ§åˆ¶å¤´åƒå‘¼å¸å…‰åœˆ (æ¨¡æ‹Ÿæ­£åœ¨è¯´è¯)
function toggleAvatarSpeaking(isSpeaking) {
    const visualCenter = document.querySelector('.call-visual-center');
    if (visualCenter) {
        if (isSpeaking) {
            visualCenter.classList.add('is-speaking');
        } else {
            visualCenter.classList.remove('is-speaking');
        }
    }
}

// --- ğŸ”§ æ ¸å¿ƒå·¥å…·ï¼š16è¿›åˆ¶è½¬éŸ³é¢‘æµ ---
function hexToBlobUrl(hex) {
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ 0x å‰ç¼€
    const cleanHex = hex.startsWith('0x') ? hex.slice(2) : hex;
    
    // å°† Hex å­—ç¬¦ä¸²è½¬ä¸º Byte æ•°ç»„
    const bytes = new Uint8Array(Math.ceil(cleanHex.length / 2));
    for (let i = 0; i < bytes.length; i++) {
        bytes[i] = parseInt(cleanHex.substr(i * 2, 2), 16);
    }

    // ç”Ÿæˆ Blob å¯¹è±¡
    const blob = new Blob([bytes], { type: 'audio/mpeg' });
    return URL.createObjectURL(blob);
}
// ==========================================
// ğŸ™ï¸ MiniMax è¯­éŸ³å¼•æ“ (æœ¬åœ°/çº¿ä¸Šè‡ªåŠ¨åˆ‡æ¢ç‰ˆ)
// ==========================================
window.sharedAudioCtx = window.sharedAudioCtx || new (window.AudioContext || window.webkitAudioContext)();

function speakText(text, voiceId, btnEl = null) {
    return new Promise(async (resolve) => {
        // 1. è¯»å–é‰´æƒ
        const savedConfig = JSON.parse(localStorage.getItem('ios_voice_config')) || {};
        const apiKey = savedConfig.key || localStorage.getItem('minimax_key') || localStorage.getItem('minimax_api_key') || "";
        const groupId = savedConfig.groupId || localStorage.getItem('minimax_group_id') || "";

        if (!apiKey || !groupId) {
            console.warn("âš ï¸ è¯­éŸ³é…ç½®ç¼ºå¤±");
            resolve(); return;
        }

        // 2. æ–‡æœ¬æ¸…æ´—
        let textToRead = text.split('[TRANS]')[0]; 
        textToRead = textToRead.replace(/\|BR\|/g, "ï¼Œ").replace(/ï¼ˆ.*?ï¼‰/g, '').replace(/\(.*?\)/g, '').trim();
        if (!textToRead) { resolve(); return; }

        // UI çŠ¶æ€
        let span = null;
        let originalText = "";
        if (btnEl) {
            span = btnEl.querySelector('.voice-duration') || btnEl.querySelector('span');
            if(span) { originalText = span.textContent; span.textContent = "Loading..."; }
            btnEl.classList.add('playing');
        }

        try {
            // ---------------------------------------------------------
            // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½åˆ¤æ–­ç¯å¢ƒ ğŸš¨
            // ---------------------------------------------------------
            let targetUrl = "";
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (isLocal) {
                // ğŸ’» æœ¬åœ°ç¯å¢ƒï¼šåªèƒ½ç”¨ cors-anywhere
                console.log("ğŸ’» æ£€æµ‹åˆ°æœ¬åœ°ç¯å¢ƒï¼Œä½¿ç”¨å…¬å…±ä»£ç†...");
                targetUrl = `https://cors-anywhere.herokuapp.com/https://api.minimax.chat/v1/t2a_v2?GroupId=${groupId}`;
            } else {
                // â˜ï¸ çº¿ä¸Šç¯å¢ƒ (Vercel)ï¼šä½¿ç”¨é«˜æ€§èƒ½å†…ç½‘è½¬å‘
                console.log("â˜ï¸ æ£€æµ‹åˆ°çº¿ä¸Šç¯å¢ƒï¼Œä½¿ç”¨ Vercel è½¬å‘...");
                targetUrl = `/minimax_proxy/t2a_v2?GroupId=${groupId}`;
            }

            // ğŸš¨ æƒ…æ„Ÿå¢å¼ºè®¾ç½®
            const reqBody = {
                "model": "speech-01-hd",
                "text": textToRead,
                "stream": false,
                "voice_setting": {
                    "voice_id": voiceId || "male-qn-qingse",
                    "speed": 1.0, 
                    "vol": 1.0,
                    "pitch": 0
                }
            };

            const res = await fetch(targetUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reqBody)
            });

            // ğŸš¨ ä»£ç†æ¿€æ´»æ£€æŸ¥ (ä»…æœ¬åœ°è§¦å‘)
            if (res.status === 403 && isLocal) {
                alert("ğŸš¨ æœ¬åœ°è°ƒè¯•éœ€æ¿€æ´»ä»£ç†ï¼\nè¯·ç‚¹å‡»ç¡®å®šå»æ¿€æ´»ï¼Œç„¶ååˆ·æ–°é¡µé¢ã€‚");
                window.open("https://cors-anywhere.herokuapp.com/corsdemo", "_blank");
                resolve(); return;
            }

            if (res.status === 404 || res.status === 405) {
                 console.error("âŒ è·¯å¾„é”™è¯¯ï¼šè¯·æ£€æŸ¥ vercel.json æ˜¯å¦ä¸Šä¼ ï¼Œæˆ–è€…æ˜¯å¦åœ¨æœ¬åœ°è¿è¡Œäº† Vercel è·¯å¾„ã€‚");
                 resolve(); return;
            }

            const data = await res.json();
            
            if (data.base_resp && data.base_resp.status_code !== 0) {
                console.error("MiniMax Error:", data.base_resp.status_msg);
                resolve(); return;
            }

            // 3. éŸ³é¢‘å¤„ç† + ç”µè¯éŸ³æ•ˆ
            if (data.data && data.data.audio) {
                let audioUrl;
                if (/^[0-9a-fA-F]+$/.test(data.data.audio)) {
                    if (typeof hexToBlobUrl === 'function') {
                        audioUrl = hexToBlobUrl(data.data.audio);
                    } else {
                        const bytes = new Uint8Array(data.data.audio.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                        const blob = new Blob([bytes], { type: 'audio/mpeg' });
                        audioUrl = URL.createObjectURL(blob);
                    }
                } else {
                    audioUrl = "data:audio/mp3;base64," + data.data.audio;
                }

                const audio = new Audio();
                audio.crossOrigin = "anonymous";
                audio.src = audioUrl;

                const ctx = window.sharedAudioCtx;
                if (ctx.state === 'suspended') await ctx.resume();

                if (!btnEl) { 
                    const source = ctx.createMediaElementSource(audio);
                    const highPass = ctx.createBiquadFilter();
                    highPass.type = "highpass"; highPass.frequency.value = 300; 
                    const lowPass = ctx.createBiquadFilter();
                    lowPass.type = "lowpass"; lowPass.frequency.value = 3400;
                    const compressor = ctx.createDynamicsCompressor();
                    
                    source.connect(highPass);
                    highPass.connect(lowPass);
                    lowPass.connect(compressor);
                    compressor.connect(ctx.destination);
                } else {
                    // æ°”æ³¡æ¨¡å¼ç›´æ¥è¿è¾“å‡ºï¼Œä¸åŠ æ»¤é•œ
                    const source = ctx.createMediaElementSource(audio);
                    source.connect(ctx.destination);
                }

                if (btnEl && span) span.textContent = "Playing";

                audio.onplay = () => {
                    if (!btnEl && typeof toggleAvatarSpeaking === 'function') toggleAvatarSpeaking(true);
                };

                audio.onended = () => {
                    if (!btnEl && typeof toggleAvatarSpeaking === 'function') toggleAvatarSpeaking(false);
                    if (btnEl) {
                        btnEl.classList.remove('playing');
                        if(span) span.textContent = originalText || "Voice";
                    }
                    URL.revokeObjectURL(audioUrl);
                    resolve(); 
                };
                
                audio.onerror = (e) => {
                    console.error("Audio Play Error:", e);
                    if (!btnEl && typeof toggleAvatarSpeaking === 'function') toggleAvatarSpeaking(false);
                    resolve();
                };

                await audio.play().catch(e => {
                    console.error("Auto-play blocked:", e);
                    resolve();
                });
            } else {
                resolve();
            }

        } catch (e) {
            console.error("TTS Error:", e);
            if (btnEl) { btnEl.classList.remove('playing'); if(span) span.textContent = "Err"; }
            if (typeof toggleAvatarSpeaking === 'function') toggleAvatarSpeaking(false);
            resolve();
        }
    });
}

// --- ğŸ“± å…¨å± APP é€»è¾‘ ---

function switchCast(type, el) {
    // 1. åˆ‡æ¢ Tab æ ·å¼
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    
    // 2. ç‰©ç†ä¸‹å‹æ ‡é¢˜åŒæ­¥åˆ‡æ¢
    const titleEl = document.getElementById('char-app-title');
    titleEl.textContent = type === 'main' ? 'Profiles' : 'Entities';

    // 3. æ‰§è¡Œä½ çš„æ•°æ®è¿‡æ»¤
    // filterData(type);
    
    if(window.navigator.vibrate) window.navigator.vibrate(10);
}

/**
 * ğŸš€ å…¨å±€ App å…³é—­åè®®
 * é€»è¾‘ï¼šå…ˆæ‰§è¡Œæ»‘ä¸‹åŠ¨ç”» -> å»¶è¿Ÿç‰©ç†éšè— -> é‡Šæ”¾æ»šåŠ¨é”å®š
 */
function closeApp(appId) {
    const app = document.getElementById(appId);
    if (!app) return;

    // 1. ç§»é™¤ active ç±»ï¼Œè§¦å‘ CSS ä¸­å®šä¹‰çš„æ»‘åŠ¨æˆ–ç¼©æ”¾åŠ¨ç”»
    app.classList.remove('active');

    // 2. ğŸš¨ ç‰©ç†å»¶è¿Ÿï¼šç­‰å¾… 400ms åŠ¨ç”»æ’­æ”¾å®Œæ¯•åå†éšè—å®¹å™¨
    // è¿™æ ·å¯ä»¥é˜²æ­¢ App è¿˜æ²¡æ»‘ä¸‹å»ï¼Œåº•ä¸‹çš„ä¸»é¡µç»„ä»¶å°±æå‰è·³å‡ºæ¥
    setTimeout(() => {
        app.style.display = 'none';
    }, 400); // è¿™é‡Œçš„ 400ms å»ºè®®ä¸ CSS transition çš„æ—¶é—´ä¿æŒä¸€è‡´

    // 3. æ¢å¤ä¸»é¡µé¢çš„ç‚¹å‡»å’Œæ»šåŠ¨ï¼ˆå¦‚æœä½ ä¹‹å‰åœ¨æ‰“å¼€æ—¶é”æ­»è¿‡ bodyï¼‰
    document.body.style.overflow = '';
    
    // è§¦è§‰åé¦ˆï¼ˆæ¨¡æ‹ŸçœŸæœºæ‰‹æ„Ÿï¼‰
    if (window.navigator.vibrate) window.navigator.vibrate(5);
}

// æ‰“å¼€ Messages App
function openMessagesApp() {
    const app = document.getElementById('lmsg-app-wrapper');
    app.style.display = 'flex';
    // ä½ çš„å…¥åœºåŠ¨ç”»é€»è¾‘
    if(window.navigator.vibrate) window.navigator.vibrate(15);
    if (appId === 'messageApp') {
        renderLmsgList(); // ğŸš€ ç¡®ä¿æ¯æ¬¡æ‰“å¼€ App éƒ½ä¼šé‡æ–°æ¸²æŸ“æœ€æ–°åˆ—è¡¨
    }
}

// è¿‡æ»¤é€»è¾‘
function lmsgFilter(type, el) {
    document.querySelectorAll('.lmsg-filter-item').forEach(i => i.classList.remove('lmsg-active'));
    el.classList.add('lmsg-active');
    
    // è¿™é‡Œå¯ä»¥å†™å…·ä½“çš„åˆ—è¡¨è¿‡æ»¤é€»è¾‘
    console.log("Filtering messages by:", type);
    if(window.navigator.vibrate) window.navigator.vibrate(5);
}

// æ¨¡æ‹Ÿèº«ä»½è½¬å˜ï¼šä» Blue å˜æˆ Green (ä¿¡å·å·®æˆ–æ‹‰é»‘)
function toggleIdentity(cellId) {
    const cell = document.querySelector(`.lmsg-cell[data-id="${cellId}"]`);
    cell.classList.remove('lmsg-type-blue');
    cell.classList.add('lmsg-type-green');
    // æ›´æ”¹é¢„è§ˆæ–‡å­—æç¤ºå‰§æƒ…å˜åŒ–
    cell.querySelector('.lmsg-preview').textContent = "Signal lost. Switching to SMS mode...";
}

/**
 * åˆ‡æ¢ Messages App çš„åˆ†ç±»æ ‡ç­¾
 * @param {string} category åˆ†ç±»æ ‡è¯†
 * @param {HTMLElement} element ç‚¹å‡»çš„å…ƒç´ 
 */
function lmsgSwitchTab(category, element) {
    // 1. ç§»é™¤æ‰€æœ‰ active ç±»
    const items = document.querySelectorAll('.lmsg-nav-item');
    items.forEach(item => item.classList.remove('active'));
    
    // 2. ä¸ºå½“å‰ç‚¹å‡»çš„é¡¹æ·»åŠ  active
    element.classList.add('active');
    
    // 3. è§¦è§‰åé¦ˆ (ç»“åˆä½ é¡¹ç›®å·²æœ‰çš„ä¹ æƒ¯)
    if(window.navigator.vibrate) window.navigator.vibrate(8);
    
    // 4. è¿™é‡Œé¢„ç•™ç»™ä½ çš„æ•°æ®è¿‡æ»¤é€»è¾‘
    console.log(`Switching Messages to: ${category}`);
    // renderMessages(category); 
}
/**
 * 2. æ£€æŸ¥å³ä¸Šè§’æ­£å¼å‘é€æŒ‰é’®çš„çŠ¶æ€
 */
function lmsgUpdateFinalSendState() {
    const finalSendBtn = document.getElementById('lmsg-send-btn');
    const hasRecipient = document.getElementById('lmsg-to-input').value.length > 0;
    const hasContent = currentDraftMessages.length > 0;

    finalSendBtn.disabled = !(hasRecipient && hasContent);
}
/**
 * ğŸš€ ç²¾å‡†å¯¹æ¥ï¼šè·å–ä½ è®¾ç½®é‡Œçš„æ—¶åŒºæ—¶é—´ (å¸¦ AM/PM)
 */
function getLuneMessageTime() {
    // 1. æ ¸å¿ƒä¿®å¤ï¼šè°ƒå–ä½ ä»£ç é‡Œçš„çœŸå®é”®å 'user_timezone'
    const tz = localStorage.getItem('user_timezone'); 
    const now = new Date();
    
    try {
        // 2. ä½¿ç”¨ Intl æ¥å£ï¼Œå¼ºåˆ¶ en-US æ ¼å¼ä»¥è·å–æ ‡å‡†çš„ AM/PM åç¼€
        return now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true, // å¼ºåˆ¶ 12 å°æ—¶åˆ¶å¸¦ AM/PM
            timeZone: tz || undefined // å¦‚æœä½ é€‰äº† Automatic (null)ï¼Œåˆ™ç”¨ç³»ç»Ÿæœ¬åœ°æ—¶é—´
        });
    } catch(e) {
        // å…œåº•é€»è¾‘ï¼šå¦‚æœæ—¶åŒºå‡ºé—®é¢˜ï¼Œæ˜¾ç¤ºæœ¬åœ°æ—¶é—´
        console.error("æ—¶åŒºè§£æå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´");
        const hh = now.getHours();
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ampm = hh >= 12 ? 'PM' : 'AM';
        return `${hh % 12 || 12}:${mm} ${ampm}`;
    }
}

/**
 * ğŸš€ è·å–ç¬¦åˆç³»ç»Ÿæ—¶åŒºçš„ AM/PM æ—¶é—´
 */
function getSystemFormattedTime() {
    const tz = localStorage.getItem('user_timezone') || 'Asia/Shanghai';
    return new Date().toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true,
        timeZone: tz
    });
}

/**
 * ğŸš€ åŒè¯­ä¿®å¤ç‰ˆï¼šå®æ—¶æ¸²æŸ“æ°”æ³¡
 * åŠŸèƒ½ï¼šè‡ªåŠ¨è¯†åˆ« [TRANS] æ ‡ç­¾ï¼Œæ¸²æŸ“â€œåŸæ–‡+ç¿»è¯‘â€çš„é«˜çº§æ ·å¼
 */
function renderBubbleToFlow(text, isUser, timestamp, status) {
    const flow = document.getElementById('lmsg-chat-flow');
    if (!flow) return;

    const timeStr = getSystemFormattedTime(timestamp);
    
    // --- âœ‚ï¸ åŒè¯­åˆ‡å‰²é€»è¾‘ ---
    let contentHtml = "";
    // å¦‚æœåŒ…å« [TRANS] æ ‡ç­¾ï¼Œè¯´æ˜æ˜¯åŒè¯­æ¶ˆæ¯
    if (text && text.includes('[TRANS]')) {
        const parts = text.split('[TRANS]');
        const original = parts[0].trim();
        const trans = parts[1] ? parts[1].trim() : "";
        
        // åŒè¯­æ ·å¼ï¼šåŸæ–‡åŠ ç²—ï¼Œä¸­é—´åŠ è™šçº¿ï¼Œç¿»è¯‘å˜å°
        contentHtml = `
            <div class="lmsg-orig-text" style="font-weight: 500; margin-bottom: 6px; line-height: 1.4;">${original}</div>
            <div class="lmsg-trans-text" style="font-size: 0.9em; opacity: 0.85; border-top: 1px dashed rgba(150,150,150,0.3); padding-top: 5px; line-height: 1.3;">${trans}</div>
        `;
    } else {
        // æ™®é€šæ¶ˆæ¯ï¼šç›´æ¥æ˜¾ç¤º
        contentHtml = `<div style="word-wrap: break-word; white-space: pre-wrap;">${text}</div>`;
    }

    // --- å¸ƒå±€é€»è¾‘ (ä¿æŒä¹‹å‰çš„ å·¦å·²è¯»/å³å·²å‘é€) ---
    const statusText = isUser ? "å·²å‘é€" : "å·²è¯»";
    const align = isUser ? 'flex-end' : 'flex-start';
    const metaColor = isUser ? '#888' : '#999';

    const bubbleHtml = `
        <div class="lmsg-bubble-wrapper" style="display: flex; flex-direction: column; align-items: ${align}; margin-bottom: 12px; width: 100%;">
            
            <div class="${isUser ? 'lmsg-user-bubble' : 'lmsg-entity-bubble'}" 
                 style="max-width: 75%; position: relative; margin-bottom: 2px;">
                 ${contentHtml} </div>

            <div class="lmsg-meta-outside" 
                 style="display: flex; gap: 8px; font-size: 10px; color: ${metaColor}; padding: 0 4px; opacity: 0.8;">
                 <span class="lmsg-meta-time">${timeStr}</span>
                 <span class="lmsg-meta-status">${statusText}</span>
            </div>
        </div>
    `;

    flow.insertAdjacentHTML('beforeend', bubbleHtml);
    flow.scrollTop = flow.scrollHeight;
}


/**
 * è¾…åŠ©ï¼šæ˜¾ç¤º/éšè—æ€è€ƒæ°”æ³¡
 */
function showLmsgTyping(id) {
    const flow = document.getElementById('lmsg-chat-flow');
    const div = document.createElement('div');
    div.id = id;
    div.className = "lmsg-bubble-row row-opp";
    div.innerHTML = `<div class="lmsg-typing-bubble"><div class="lmsg-dot"></div><div class="lmsg-dot"></div><div class="lmsg-dot"></div></div>`;
    flow.appendChild(div);
    flow.scrollTop = flow.scrollHeight;
}
function hideLmsgTyping(id) {
    document.getElementById(id)?.remove();
}

/**
 * ğŸš€ ç‰©ç†ä¿®å¤ï¼šåˆå§‹åŒ–ä¸‹æ‹‰é€‰æ‹©å™¨ (è§£å†³æ— æ³•é€‰ä¸­é—®é¢˜)
 */
async function profInitSelectors() {
    // 1. ç¡®ä¿ç³»ç»ŸæœåŠ¡å·²å°±ç»ª
    await initSystemServices();

    const chars = await loadFromDB('char_list') || [];
    const worlds = await loadFromDB('world_list') || [];

    // --- A. æ‰‹åŠ¨æ¨¡å¼ï¼šç»‘å®šè§’è‰²ä¸‹æ‹‰æ¡† ---
    const manualCharOpts = chars.map(c => `
        <div class="prof-option-item" onclick="profPickOption('prof-select-manual-char', '${c.id}', '${c.name}', 'prof-in-bind-char')">
            ${c.id === "SYSTEM_ARCHIVE_ENTITY" ? "ğŸ“ " : ""}${c.name}
        </div>
    `).join('');

    // --- B. AIæ¨¡å¼ï¼šé€‰æ‹©ä¸–ç•Œä¹¦ä¸‹æ‹‰æ¡† ---
    // ğŸš€ è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»å’Œ HTML çš„ id="prof-select-ai-world" å®Œå…¨ä¸€è‡´
    const worldOptions = worlds.map(w => `
        <div class="prof-option-item" onclick="profPickOption('prof-select-ai-world', '${w.id}', '${w.name}', 'prof-ai-world-id')">
            ${w.name}
        </div>
    `).join('');

    // --- C. AIæ¨¡å¼ï¼šç”Ÿæˆåçš„ç»‘å®šè§’è‰²ä¸‹æ‹‰æ¡† ---
    const aiBindOpts = chars.map(c => `
        <div class="prof-option-item" onclick="profPickOption('prof-sel-ai-bind', '${c.id}', '${c.name}', 'prof-ai-bind-char')">
            ${c.id === "SYSTEM_ARCHIVE_ENTITY" ? "ğŸ“ " : ""}${c.name}
        </div>
    `).join('');

    // --- D. ç‰©ç†æ³¨å…¥ DOM ---
    const manualBox = document.getElementById('prof-opts-manual-char');
    if (manualBox) manualBox.innerHTML = manualCharOpts;

    const worldBox = document.getElementById('prof-opts-ai-world');
    if (worldBox) worldBox.innerHTML = worldOptions;

    const aiBindBox = document.querySelector('#prof-sel-ai-bind .prof-select-options');
    if (aiBindBox) aiBindBox.innerHTML = aiBindOpts;
}

/**
 * ğŸ› ï¸ ç»Ÿä¸€ç³»ç»ŸæœåŠ¡åˆå§‹åŒ– (å®Œæ•´åŒæ­¥ç‰ˆ)
 */
async function initSystemServices() {
    const SYSTEM_SERVICES = [
        {
            id: "SERVICE_WEATHER",
            name: "æ°”è±¡ä¸­å¿ƒ",
            avatar: "https://api.dicebear.com/7.x/identicon/svg?seed=weather&backgroundColor=00aaff",
            desc: "æä¾›ç²¾å‡†çš„å®æ—¶å¤©æ°”é¢„æŠ¥ä¸æ°”è±¡ç¾å®³é¢„è­¦ã€‚",
            category: "SYSTEM",
            type: "UTILITY",
            isSystem: true // æ ‡è®°æ–¹ä¾¿åç»­è¯†åˆ«
        },
        {
            id: "SERVICE_CARRIER",
            name: "è¿è¥å•†æœåŠ¡",
            avatar: "https://api.dicebear.com/7.x/identicon/svg?seed=carrier&backgroundColor=44ff44",
            desc: "ç®¡ç†æ‚¨çš„ç§»åŠ¨ç½‘ç»œã€è¯è´¹è´¦å•åŠå¥—é¤ä½™é‡ã€‚",
            category: "SYSTEM",
            type: "UTILITY",
            isSystem: true
        },
        {
            id: "SERVICE_SECURITY",
            name: "å®‰å…¨ä¸­å¿ƒ",
            avatar: "https://api.dicebear.com/7.x/identicon/svg?seed=security&backgroundColor=ff4444",
            desc: "ç³»ç»Ÿå®‰å…¨åè®®æ ¸å¿ƒã€‚è´Ÿè´£å‘æ”¾åŠ¨æ€éªŒè¯ç ã€æ‹¦æˆªé£é™©è®¿é—®ã€‚",
            category: "SYSTEM",
            type: "UTILITY",
            isSystem: true
        },
        {
            id: "SERVICE_CALENDAR",
            name: "æ—¥ç¨‹æé†’",
            avatar: "https://api.dicebear.com/7.x/identicon/svg?seed=calendar&backgroundColor=ffaa00",
            desc: "åŒæ­¥æ‚¨çš„æ‰€æœ‰å¾…åŠäº‹é¡¹ä¸èŠ‚å‡æ—¥ã€‚",
            category: "SYSTEM",
            type: "UTILITY",
            isSystem: true
        },
        {
            id: "SYSTEM_ARCHIVE_ENTITY", 
            name: "ç³»ç»Ÿæ¡£æ¡ˆé¦†",
            avatar: "https://api.dicebear.com/7.x/shapes/svg?seed=ArchiveCore&backgroundColor=000000",
            desc: "å­˜å‚¨æ‰€æœ‰æ–­è¿çš„å®ä½“èŠ‚ç‚¹ä¸ç¢ç‰‡åè®®ã€‚",
            category: "SYSTEM",
            type: "STORAGE",
            isSystem: true
        },
        {
            id: "SERVICE_FINANCE_CORE", 
            name: "èµ„äº§ç»“ç®—ä¸­å¿ƒ",
            avatar: "https://api.dicebear.com/7.x/identicon/svg?seed=finance&backgroundColor=ffd700",
            desc: "Lune ç³»ç»Ÿè´¢åŠ¡åè®®çš„æ ¸å¿ƒã€‚è´Ÿè´£ç›‘æ§æ¯ä¸€ç¬”èµ„äº§æµå…¥ã€‚",
            category: "SYSTEM",
            type: "FINANCE",
            isSystem: true
        }
    ];

    // 1. è·å–å½“å‰çš„è§’è‰²ä¹¦åˆ—è¡¨
    let charList = await loadFromDB('char_list') || [];
    
    // 2. æ‰§è¡Œâ€œå»ç³»ç»ŸåŒ–â€ï¼šä» char_list ä¸­ç§»é™¤ç³»ç»ŸæœåŠ¡
    const systemIds = SYSTEM_SERVICES.map(s => s.id);
    let cleanedCharList = charList.filter(c => !systemIds.includes(c.id));

    if (charList.length !== cleanedCharList.length) {
        await saveToDB('char_list', cleanedCharList);
        console.log("Character Book cleaned: System services removed.");
    }

    // 3. ç‹¬ç«‹å­˜å‚¨ï¼šå­˜å…¥ system_services_db (ç»™æ¡£æ¡ˆAppçš„Systemåˆ†é¡µç”¨)
    await saveToDB('system_services_db', SYSTEM_SERVICES);
    
    // 4. ğŸš€ å…³é”®åŒæ­¥ï¼šå¿…é¡»åŒæ­¥åˆ° chat_friends (é€šè®¯å½•)ï¼Œå¦åˆ™çŸ­ä¿¡æœä¸åˆ°
    let friends = await loadFromDB('chat_friends') || [];
    let updatedFriends = [...friends];
    let hasChange = false;

    for (let sys of SYSTEM_SERVICES) {
        // æ£€æŸ¥é€šè®¯å½•é‡Œæœ‰æ²¡æœ‰è¿™ä¸ªç³»ç»Ÿå·
        const exists = updatedFriends.some(f => f.id === sys.id);
        if (!exists) {
            updatedFriends.push({
                id: sys.id,
                name: sys.name,
                avatar: sys.avatar,
                desc: sys.desc,
                isSystem: true, // æ ‡è®°ä¸ºç³»ç»Ÿå·
                isGroup: false
            });
            hasChange = true;
        }
    }

    if (hasChange) {
        await saveToDB('chat_friends', updatedFriends);
        console.log("System Services synced to Contact List.");
    }

    console.log("Lune System: Core Services Initialized & Isolated.");
}



// é€‚é…åŸç³»ç»Ÿçš„ openApp å‡½æ•°
// è¯·åœ¨ä½ çš„åŸæœ‰ openApp å‡½æ•°ä¸­çš„ idMap é‡Œæ·»åŠ è¿™ä¸€è¡Œï¼š
// 'walletApp': 'page-wallet'

// åˆå§‹åŒ–æŒ‡ç¤ºå™¨
document.addEventListener('DOMContentLoaded', () => {
    const nav = document.querySelector('.wallet-bottom-nav');
    if(nav) nav.style.setProperty('--active-index', 0);
});

// å½“ç‚¹å‡»â€œISSUE NEW VIRTUAL CARDâ€æ—¶è§¦å‘
function handleCreateCard() {
    // 1. éœ‡åŠ¨åé¦ˆï¼ˆå¢åŠ é«˜çº§æ„Ÿï¼‰
    if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(20);
    }
    
    // 2. è°ƒç”¨æ‰“å¼€ç¼–è¾‘å™¨çš„å‡½æ•°
    toggleCardEditor(true);
}

/**
 * æ§åˆ¶ç¼–è¾‘å™¨å±‚çš„æ˜¾ç¤ºä¸éšè—
 * @param {boolean} show - true ä¸ºæ‰“å¼€ï¼Œfalse ä¸ºå…³é—­
 */
function toggleCardEditor(show) {
    const layer = document.getElementById('card-editor-layer');
    if (!layer) {
        console.error("æ‰¾ä¸åˆ° card-editor-layerï¼Œè¯·ç¡®ä¿ HTML å·²ç»æ·»åŠ è¯¥èŠ‚ç‚¹");
        return;
    }

    if (show) {
        layer.style.display = 'flex';
        layer.classList.add('active-layer'); // å¯ä»¥åŠ ä¸€ä¸ªåŠ¨ç”»ç±»
        // åˆå§‹åŒ–è‰²ç›¸ç¯ï¼ˆç¡®ä¿ç”»å¸ƒèƒ½æ­£å¸¸æ¸²æŸ“ï¼‰
        if (typeof initColorWheel === 'function') {
            initColorWheel();
        }
    } else {
        layer.style.display = 'none';
    }
}

// è‡ªåŠ¨æ ¼å¼åŒ–æ•°å­—ï¼ˆç¤ºä¾‹ï¼šè®© 0 å˜æˆ 0.00ï¼‰
function updateWalletBalance(val) {
    const el = document.querySelector('.amount-number');
    if(el) {
        el.innerText = parseFloat(val).toFixed(2);
    }
}
function handleFilter() {
    // éœ‡åŠ¨åé¦ˆ
    if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(15);
    }
    // è¿™é‡Œå¯ä»¥è§¦å‘ä¸‹æ‹‰èœå•æˆ–è€…å¼¹çª—
    console.log("Filter protocol engaged.");
}

// åˆå§‹åŒ–è‰²ç›¸ç¯
function initColorWheel() {
    const canvas = document.getElementById('colorWheel');
    const ctx = canvas.getContext('2d');
    const radius = canvas.width / 2;

    for (let i = 0; i < 360; i++) {
        const angle = i * Math.PI / 180;
        const x = radius + radius * Math.cos(angle);
        const y = radius + radius * Math.sin(angle);
        
        const grad = ctx.createRadialGradient(radius, radius, 0, radius, radius, radius);
        grad.addColorStop(0, 'white');
        grad.addColorStop(1, `hsl(${i}, 100%, 50%)`);
        
        ctx.strokeStyle = `hsl(${i}, 100%, 50%)`;
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.lineTo(x, y);
        ctx.stroke();
    }

    canvas.onclick = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const p = ctx.getImageData(x, y, 1, 1).data;
        const hex = "#" + ("000000" + ((p[0] << 16) | (p[1] << 8) | p[2]).toString(16)).slice(-6);
        
        currentCardColor = hex;
        document.getElementById('live-card-preview').style.color = hex;
        document.getElementById('colorHex').innerText = hex.toUpperCase();
        document.getElementById('colorCursor').style.left = x + 'px';
        document.getElementById('colorCursor').style.top = y + 'px';
    };
}

// å®æ—¶æ›´æ–°é¢„è§ˆ
function updatePreview() {
    const name = document.getElementById('input-card-name').value || "CARD HOLDER";
    const number = document.getElementById('input-card-number').value || "**** **** **** 0000";
    document.getElementById('p-name').innerText = name.toUpperCase();
    document.getElementById('p-number').innerText = number;
}

// èƒŒæ™¯é€‰æ‹©é€»è¾‘
function setBg(bg) {
    const preview = document.getElementById('live-card-preview');
    if(bg === 'carbon') {
        selectedCardBg = "url('https://www.transparenttextures.com/patterns/carbon-fibre.png'), #111";
    } else {
        selectedCardBg = bg;
    }
    preview.style.background = selectedCardBg;
}

// è§’è‰²åŒæ­¥é€»è¾‘
async function toggleCharList() {
    const area = document.getElementById('char-selection-area');
    const isChecked = document.getElementById('bind-toggle').checked;
    
    if (isChecked) {
        area.style.display = 'flex';
        // ä»ä½ çš„æ•°æ®åº“åŠ è½½è§’è‰²
        let charList = await loadFromDB('char_list') || [];
        area.innerHTML = charList.map(char => `
            <div class="char-item" onclick="selectChar('${char.id}', this)">
                <img src="${char.avatar}" />
                <span>${char.name}</span>
            </div>
        `).join('');
    } else {
        area.style.display = 'none';
        boundCharId = null;
    }
}

function selectChar(id, el) {
    document.querySelectorAll('.char-item').forEach(item => item.classList.remove('active'));
    el.classList.add('active');
    boundCharId = id;
    // åŒæ­¥è§’è‰²ååˆ°å¡ç‰‡é¢„è§ˆ
    const charName = el.querySelector('span').innerText;
    document.getElementById('input-card-name').value = charName;
    updatePreview();
}

/**
 * åˆ‡æ¢å¡ç‰‡æ’ç‰ˆå¸ƒå±€
 * @param {number} num - å¸ƒå±€ç¼–å· (1, 2, æˆ– 3)
 */
function setLayout(num) {
    // 1. æ›´æ–°å…¨å±€å˜é‡
    currentLayout = num;

    // 2. æ›´æ–°æŒ‰é’®çš„è§†è§‰çŠ¶æ€ï¼ˆé«˜äº®é€‰ä¸­çš„æŒ‰é’®ï¼‰
    const opts = document.querySelectorAll('.layout-opt');
    opts.forEach(opt => opt.classList.remove('active')); // ç§»é™¤æ‰€æœ‰é«˜äº®
    
    // è¿™é‡Œçš„ num-1 æ˜¯å› ä¸ºæ•°ç»„ä¸‹æ ‡ä»0å¼€å§‹ï¼Œè€Œæˆ‘ä»¬çš„ç¼–å·ä»1å¼€å§‹
    if (opts[num - 1]) {
        opts[num - 1].classList.add('active'); // ç»™å½“å‰ç‚¹å‡»çš„åŠ ä¸Šé«˜äº®
    }

    // 3. æ”¹å˜é¢„è§ˆå¡ç‰‡çš„ç±»åï¼Œä»è€Œè§¦å‘ä¸åŒçš„ CSS å¸ƒå±€æ ·å¼
    const preview = document.getElementById('live-card-preview');
    if (preview) {
        // ä¿ç•™åŸºç¡€ç±»å luxury-cardï¼ŒåŠ¨æ€æ›´æ¢ layout-x
        preview.className = `luxury-card layout-${num}`;
    }

    // 4. å¢åŠ å¾®å¼±éœ‡åŠ¨åé¦ˆ
    if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(10);
    }
    
    console.log("Layout switched to:", num);
}

/**
 * æ¸²æŸ“æ‰€æœ‰ä¿å­˜åœ¨æœ¬åœ°çš„å¡ç‰‡
 */
/**
 * ğŸ¨ æ¸²æŸ“é“¶è¡Œå¡ (ä¸¥æ ¼è¿‡æ»¤ç‰ˆ)
 * åªæ˜¾ç¤º lune_wallets é‡Œçš„é“¶è¡Œå¡ï¼Œè‡ªåŠ¨éšè— SIM å¡
 */
function renderSavedCards() {
    const container = document.getElementById('saved-cards-container');
    if (!container) return;

    // 1. è·å–æœ¬åœ°å­˜å‚¨çš„å¡ç‰‡æ•°æ®
    const savedCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');

    // 2. æ¸…ç©ºå®¹å™¨é˜²æ­¢é‡å¤æ¸²æŸ“
    container.innerHTML = '';

    // 3. å¾ªç¯æ¸²æŸ“æ¯ä¸€å¼ å¡ç‰‡
    savedCards.forEach((card, index) => {
        // ğŸ”¥ğŸ”¥ æ ¸å¿ƒè¿‡æ»¤ï¼šå¦‚æœæ˜¯ SIM å¡ï¼Œç›´æ¥è·³è¿‡ï¼Œç»ä¸æ¸²æŸ“åœ¨è¿™é‡Œ ğŸ”¥ğŸ”¥
        if (card.isSim === true) return;

        const cardEl = document.createElement('div');
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šå¡å·åªæ˜¾ç¤ºåå››ä½ï¼Œå…¶ä½™éƒ¨åˆ†è„±æ•
        const rawNum = (card.number || "").replace(/\s/g, ''); // å»æ‰ç©ºæ ¼
        const maskedNum = "**** **** **** " + (rawNum.length > 4 ? rawNum.slice(-4) : rawNum);

        cardEl.className = `luxury-card layout-${card.layout || 1}`;
        cardEl.style.background = card.bg;
        cardEl.style.color = card.color;
        
        // âš ï¸ å…³é”®è®¾ç½®ï¼šå–æ¶ˆå¤–è¾¹è·ï¼Œå› ä¸ºå®¹å™¨å·²ç»æ˜¯ flex + gap å¸ƒå±€äº†
        cardEl.style.marginBottom = '0px'; 
        cardEl.style.marginRight = '0px'; 
        cardEl.style.cursor = 'pointer';

        // è¿™é‡Œçš„ç»“æ„æ˜¯ä½ åŸæœ¬çš„é“¶è¡Œå¡æ ·å¼
        cardEl.innerHTML = `
            <div class="card-glass-layer"></div>
            <div class="card-content-grid">
                <div class="preview-chip"></div>
                <div class="preview-name">${(card.name || "UNNAMED").toUpperCase()}</div>
                <div class="preview-number">${maskedNum}</div>
                <div class="preview-deco">RESERVE ENTITY</div>
            </div>
            <div class="delete-card-trigger" onclick="deleteCard(${index}, event)">Ã—</div>
        `;
        
        container.appendChild(cardEl);
    });

    // ã€åŒæ­¥æ›´æ–°ã€‘ï¼šæ¯å½“å¡ç‰‡æ¸²æŸ“ï¼ˆåˆ›å»º/åˆ é™¤ï¼‰åï¼Œåˆ·æ–°ä¸»é¡µé¢çš„ä½™é¢æ˜¾ç¤º
    if (typeof updateBalanceDisplay === 'function') {
        updateBalanceDisplay();
    }
}

// 1. è¦†ç›–ä¹‹å‰çš„ deleteCard å‡½æ•°
function deleteCard(index, event) {
    event.stopPropagation();
    currentDeletingIndex = index;
    document.getElementById('wallet-modal-overlay').style.display = 'flex';
    
    // ç»‘å®šç¡®è®¤æŒ‰é’®çš„è¡Œä¸º
    document.getElementById('modal-confirm-action').onclick = function() {
        let cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
        cards.splice(currentDeletingIndex, 1);
        localStorage.setItem('lune_wallets', JSON.stringify(cards));
        closeWalletModal();
        renderSavedCards();
        updateBalanceDisplay(); // åˆ·æ–°æ€»ä½™é¢
    };
}

function closeWalletModal() {
    document.getElementById('wallet-modal-overlay').style.display = 'none';
}

// 2. ä½™é¢åˆ‡æ¢ä¸è®¡ç®—é€»è¾‘
function toggleScopeMenu() {
    const menu = document.getElementById('scope-menu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    
    if(menu.style.display === 'block') {
        const cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
        const list = document.getElementById('card-scope-list');
        list.innerHTML = cards.map((c, i) => `
            <div class="scope-item" onclick="selectBalanceScope(${i})">${c.name}</div>
        `).join('');
    }
}

/**
 * åˆ‡æ¢èµ„äº§æŸ¥çœ‹ç»´åº¦ï¼šåŒæ­¥æ›´æ–°é‡‘é¢ä¸è®°å½•
 */
function selectBalanceScope(scope) {
    // 1. ã€å…³é”®ã€‘åŒæ­¥æ›´æ–°å…¨å±€ç­›é€‰å˜é‡ï¼Œç¡®ä¿å’Œç­›é€‰å¼¹çª—çš„çŠ¶æ€ä¸€è‡´
    if (typeof currentFilter !== 'undefined') {
        currentFilter.scope = scope;
    }

    // 2. æ›´æ–° UI ä¸Šçš„æ–‡å­—æ ‡ç­¾
    const label = document.getElementById('balance-scope-label');
    const cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    
    if (scope === 'all') {
        label.innerText = 'TOTAL ASSETS';
    } else {
        const cardName = cards[scope] ? cards[scope].name : "UNKNOWN";
        label.innerText = cardName.toUpperCase();
    }

    // 3. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶åˆ·æ–°å½“å‰é¡µé¢çš„æ•°æ®å±•ç¤º
    updateBalanceDisplay();   // åˆ·æ–°å¤´éƒ¨çš„æ•°å­—
    applyFilterProtocol();    // åˆ·æ–°ä¸‹æ–¹çš„å†å²è®°å½•åˆ—è¡¨

    // 4. å…³é—­ä¸‹æ‹‰èœå•å¹¶éœ‡åŠ¨
    const menu = document.getElementById('scope-menu');
    if (menu) menu.style.display = 'none';
    if (window.navigator.vibrate) window.navigator.vibrate(10);
}

/**
 * å®æ—¶è®¡ç®—å¹¶æ˜¾ç¤ºä½™é¢
 */
function updateBalanceDisplay() {
    const balanceEl = document.getElementById('main-balance-val');
    if (!balanceEl) return;

    const cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    
    // è·å–å½“å‰çš„æŸ¥çœ‹èŒƒå›´
    const scope = (typeof currentFilter !== 'undefined') ? currentFilter.scope : 'all';

    if (scope === 'all') {
        // è®¡ç®—æ‰€æœ‰å¡çš„æ€»å’Œï¼šç¡®ä¿æŠŠå­—ç¬¦ä¸²è½¬æˆæµ®ç‚¹æ•°ï¼Œå¹¶å¤„ç†ç©ºå€¼
        const total = cards.reduce((sum, card) => {
            return sum + parseFloat(card.balance || 0);
        }, 0);
        balanceEl.innerText = total.toFixed(2);
    } else {
        // æ˜¾ç¤ºå•å¼ å¡çš„ä½™é¢
        const targetCard = cards[scope];
        balanceEl.innerText = targetCard ? parseFloat(targetCard.balance || 0).toFixed(2) : "0.00";
    }
}

// é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ¸²æŸ“ä¸€æ¬¡
document.addEventListener('DOMContentLoaded', renderSavedCards);

/**
 * ğŸ§¹ ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶æ¸²æŸ“ (å·²æ·»åŠ  SIM å¡è¿‡æ»¤)
 * è§£å†³ï¼šç”µè¯å¡ä¸ä¼šå†å‡ºç°åœ¨é“¶è¡Œå¡åˆ—è¡¨é‡Œ
 */
function forceRenderCards() {
    console.log("Wallet System: æ‰§è¡Œå¼ºåˆ¶æ¸²æŸ“ç¨‹åº...");
    
    // 1. è·å–å®¹å™¨
    const container = document.getElementById('saved-cards-container');
    if (!container) return;

    // 2. è¯»å–æ•°æ®
    let savedCards = [];
    try {
        savedCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    } catch (e) {
        savedCards = [];
    }

    // 3. æ‰§è¡Œæ¸…ç©º
    container.innerHTML = '';

    // 4. å¼€å§‹ç»˜åˆ¶
    savedCards.forEach((card, index) => {
        // ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ˜¯ SIM å¡ï¼Œç›´æ¥è·³è¿‡ï¼Œä¸æ¸²æŸ“ï¼ ğŸ”¥ğŸ”¥
        if (card.isSim === true) return;

        // å¡å·è„±æ•é€»è¾‘
        const rawNum = (card.number || "").replace(/\s/g, '');
        const maskedNum = "**** **** **** " + rawNum.slice(-4);

        const cardEl = document.createElement('div');
        cardEl.className = `luxury-card layout-${card.layout || 1}`;
        cardEl.style.background = card.bg || "#1a1a1a";
        cardEl.style.color = card.color || "#ffffff";
        cardEl.style.marginBottom = '20px'; // ä¿æŒåŸæ¥çš„é—´è·
        cardEl.style.position = 'relative';

        cardEl.innerHTML = `
            <div class="card-glass-layer"></div>
            <div class="card-content-grid">
                <div class="preview-chip"></div>
                <div class="preview-name">${(card.name || "UNNAMED ENTITY").toUpperCase()}</div>
                <div class="preview-number">${maskedNum}</div>
                <div class="preview-deco">RESERVE ENTITY</div>
            </div>
            <div class="delete-card-trigger" onclick="deleteCard(${index}, event)">Ã—</div>
        `;
        
        container.appendChild(cardEl);
    });

    // æ¸²æŸ“å®Œåï¼Œæ›´æ–°ä½™é¢
    if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay();
}

/**
 * æ ¸å¿ƒï¼šæ‰“å¼€ç­›é€‰å¼¹çª—å¹¶åŒæ­¥å¡ç‰‡
 */
function handleFilter() {
    const modal = document.getElementById('wallet-filter-modal');
    const chipContainer = document.getElementById('filter-card-chips');
    
    // 1. è·å–å½“å‰æ‰€æœ‰å·²åˆ›å»ºçš„å¡ç‰‡
    const savedCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    
    // 2. åŠ¨æ€ç”Ÿæˆå¡ç‰‡ç­›é€‰æŒ‰é’®ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª ALL ASSETSï¼‰
    let chipsHtml = `<div class="chip ${currentFilter.scope === 'all' ? 'active' : ''}" onclick="selectFilterChip('scope', 'all', this)">ALL ASSETS</div>`;
    
    savedCards.forEach((card, index) => {
        const isActive = currentFilter.scope == index;
        chipsHtml += `<div class="chip ${isActive ? 'active' : ''}" onclick="selectFilterChip('scope', ${index}, this)">${card.name.toUpperCase()}</div>`;
    });
    
    chipContainer.innerHTML = chipsHtml;
    
    // 3. æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
    if (window.navigator.vibrate) window.navigator.vibrate(10);
}

/**
 * åˆ‡æ¢é€‰ä¸­çŠ¶æ€
 */
function selectFilterChip(category, value, el) {
    // ç§»é™¤åŒç»„æ‰€æœ‰é«˜äº®
    const siblings = el.parentElement.querySelectorAll('.chip');
    siblings.forEach(c => c.classList.remove('active'));
    
    // é«˜äº®å½“å‰ç‚¹å‡»
    el.classList.add('active');
    
    // æ›´æ–°ç­›é€‰å˜é‡
    currentFilter[category] = value;
    
    if (window.navigator.vibrate) window.navigator.vibrate(5);
}

/**
 * å…³é—­å¼¹çª—
 */
function closeFilterModal() {
    document.getElementById('wallet-filter-modal').style.display = 'none';
}

/**
 * æ‰§è¡Œç­›é€‰åè®®ï¼šå…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
 */
function applyFilterProtocol() {
    const list = document.querySelector('.history-scroll-list');
    if (!list) return;

    // 1. è·å–è½¬è´¦äº§ç”Ÿçš„çœŸå®è®°å½•æ•°æ®
    const allLogs = JSON.parse(localStorage.getItem('lune_wallet_logs') || '[]');
    const savedCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');

    // 2. æ‰§è¡Œè¿‡æ»¤é€»è¾‘ï¼šåŒ¹é…å¡ç‰‡èŒƒå›´(scope) å’Œ äº¤æ˜“ç±»å‹(type)
    let filteredLogs = allLogs.filter(log => {
        // åˆ¤æ–­å¡ç‰‡èŒƒå›´ï¼šå…¨éƒ¨(all) æˆ– å¯¹åº”çš„ç´¢å¼•
        const matchScope = (currentFilter.scope === 'all' || log.cardIndex == currentFilter.scope);
        // åˆ¤æ–­äº¤æ˜“ç±»å‹ï¼šå…¨éƒ¨(all) æˆ– æ”¶å…¥(inflow) æˆ– æ”¯å‡º(outflow)
        const matchType = (currentFilter.type === 'all' || log.type === currentFilter.type);
        return matchScope && matchType;
    });

    // 3. æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
    if (filteredLogs.length === 0) {
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç¾åŒ–åçš„ç©ºçŠ¶æ€
        list.innerHTML = `
            <div class="empty-history-state" style="animation: fadeIn 0.4s ease;">
                <div class="empty-icon-deco"></div>
                <p>NULL DATA ARCHIVE</p>
                <span>æœªæ£€ç´¢åˆ°ç¬¦åˆåè®®çš„è®°å½•</span>
            </div>`;
    } else {
        // å¦‚æœæœ‰æ•°æ®ï¼Œæ¸²æŸ“åˆ—è¡¨
        list.innerHTML = filteredLogs.map(log => `
            <div class="history-entry" style="animation: entryFade 0.4s ease backwards;">
                <div class="entry-date">${log.date}</div>
                <div class="entry-info">
                    <div class="entry-name">${log.name}</div>
                    <div class="entry-category">${log.category || 'Standard Protocol'}</div>
                </div>
                <div class="entry-amount ${log.type}">
                    ${log.type === 'inflow' ? '+' : '-'} ${parseFloat(log.amount).toFixed(2)}
                </div>
            </div>
        `).join('');
    }

    // 4. äº¤äº’åé¦ˆï¼šå…³é—­å¼¹çª—ï¼Œæ‰§è¡Œéœ‡åŠ¨
    closeFilterModal();
    if (window.navigator.vibrate) {
        window.navigator.vibrate([20, 30]);
    }

    console.log(`ç­›é€‰åè®®å·²åº”ç”¨: èŒƒå›´[${currentFilter.scope}], ç±»å‹[${currentFilter.type}]`);
}

/**
 * åˆ·æ–°è´¦å•æ˜¾ç¤ºé€»è¾‘ (å ä½å‡½æ•°)
 */
function refreshTransactionHistory() {
    const list = document.querySelector('.history-scroll-list');
    if (!list) return;

    // å¦‚æœç­›é€‰æ¡ä»¶ä¸æ˜¯ (All, All)ï¼Œæ˜¾ç¤ºâ€œæ­£åœ¨æ£€ç´¢...â€æˆ–æ ¹æ®é€»è¾‘æ˜¾ç¤ºæ•°æ®
    // ç›®å‰ä¿æŒåˆå§‹åŒ–ç¾åŒ–æ•ˆæœ
    list.innerHTML = `
        <div class="empty-history-state" style="animation: fadeIn 0.5s;">
            <div class="empty-icon-deco"></div>
            <p>FILTERING ARCHIVE...</p>
            <span>æ­£åœ¨æ£€ç´¢ ${currentFilter.scope === 'all' ? 'å…¨å±€' : 'ç‰¹å®šå¡ç‰‡'} çš„ ${currentFilter.type} è®°å½•</span>
        </div>
    `;
    
    // 1ç§’åä½ å¯ä»¥æ¢å¤ç©ºçŠ¶æ€æˆ–æ¸²æŸ“è¿‡æ»¤åçš„æ•°æ®
}

/**
 * åˆ‡æ¢ å……å€¼/è½¬è´¦ æ¨¡å¼
 */
function switchSendMode(mode, el) {
    window.currentSendMode = mode;
    window.selectedCardIdx = null; 
    window.selectedCharId = null;

    // UI æ ·å¼åˆ‡æ¢
    document.querySelectorAll('.sub-nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    // æ»‘å—ç§»åŠ¨
    const slider = document.querySelector('.sub-nav-slider');
    slider.style.left = mode === 'recharge' ? '4px' : 'calc(50% + 0px)';
    
    // æŒ‰é’®æ–‡å­—æ›´æ–°
    document.getElementById('execute-btn-text').innerText = mode === 'recharge' ? 'INITIALIZE RECHARGE' : 'EXECUTE TRANSFER';

    // åŒºåŸŸæ˜¾éšæ§åˆ¶
    document.getElementById('area-recharge-target').style.display = (mode === 'recharge') ? 'block' : 'none';
    document.getElementById('area-transfer-source').style.display = (mode === 'transfer') ? 'block' : 'none';
    document.getElementById('area-transfer-char').style.display = (mode === 'transfer') ? 'block' : 'none';
    
    refreshPickers();
    if (window.navigator.vibrate) window.navigator.vibrate(10);
}

/**
 * ç»Ÿä¸€çš„é€‰æ‹©å¤„ç†
 */
function selectPickerItem(type, val, el) {
    const container = el.parentElement;
    container.querySelectorAll('.active').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    
    if (type === 'card') {
        window.selectedCardIdx = val;
    } else {
        window.selectedCharId = val;
    }
    
    if (window.navigator.vibrate) window.navigator.vibrate(5);
}

/**
 * åˆ·æ–°é€‰æ‹©å™¨å†…å®¹
 */
function refreshPickers() {
    const cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    const containerId = (window.currentSendMode === 'recharge') ? 'recharge-card-picker' : 'transfer-source-picker';
    const container = document.getElementById(containerId);
    
    if (container) {
        container.innerHTML = cards.map((c, i) => `
            <div class="card-mini-opt" style="background:${c.bg}; color:${c.color}" onclick="selectPickerItem('card', ${i}, this)">
                <div class="mini-name">${(c.name || "UNNAMED").toUpperCase()}</div>
                <div class="mini-num">**** ${c.number.slice(-4)}</div>
            </div>
        `).join('');
    }

    // å¦‚æœæ˜¯è½¬è´¦æ¨¡å¼ï¼Œé¢å¤–åŠ è½½è§’è‰²
    if (window.currentSendMode === 'transfer') {
        loadFromDB('char_list').then(list => {
            const charContainer = document.getElementById('send-char-picker');
            if (charContainer) {
                charContainer.innerHTML = (list || []).map(char => `
                    <div class="char-mini-opt" onclick="selectPickerItem('char', '${char.id}', this)">
                        <img src="${char.avatar}">
                        <span>${char.name}</span>
                    </div>
                `).join('');
            }
        });
    }
}

/**
 * æ‰§è¡Œæœ€ç»ˆåè®®
 */
/**
 * èµ„äº§è°ƒåº¦æ‰§è¡Œåè®® (å®Œæ•´ä¿®å¤ç‰ˆ)
 */
async function processTransfer() {
    // 1. è·å–åŸºç¡€è¾“å…¥
    const amountInput = document.getElementById('send-amount');
    const amount = parseFloat(amountInput.value);
    const memo = document.getElementById('send-memo').value || "Protocol Update";

    // 2. åŸºç¡€æ ¡éªŒ
    if (isNaN(amount) || amount <= 0) return showWalletNotice("è¯·è¾“å…¥æœ‰æ•ˆæ•°é¢");
    if (window.selectedCardIdx === null) return showWalletNotice("è¯·é€‰æ‹©è¦æ“ä½œçš„å¡ç‰‡");

    // 3. è¯»å–å¹¶é”å®šèµ„äº§å¡ç‰‡
    let cards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    let targetCard = cards[window.selectedCardIdx];
    if (!targetCard) return showWalletNotice("å¡ç‰‡æ•°æ®å¼‚å¸¸");

    // 4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ (å……å€¼ vs è½¬è´¦)
    if (window.currentSendMode === 'recharge') {
        // --- å……å€¼é€»è¾‘ ---
        targetCard.balance = (parseFloat(targetCard.balance || 0) + amount).toFixed(2);
        
        saveLogToStorage({
            date: new Date().toLocaleDateString('en-US',{month:'short',day:'2-digit'}).toUpperCase(),
            name: "SYSTEM RECHARGE",
            category: memo,
            amount: amount.toFixed(2),
            type: 'inflow',
            cardIndex: window.selectedCardIdx
        });
    } else {
        // --- è½¬è´¦é€»è¾‘ ---
        if (window.selectedCharId === null) return showWalletNotice("è¯·é€‰æ‹©è½¬è´¦ç›®æ ‡è§’è‰²");
        if (parseFloat(targetCard.balance || 0) < amount) return showWalletNotice("ä½™é¢ä¸è¶³");

        // æ‰£ç”¨æˆ·çš„é’±
        targetCard.balance = (parseFloat(targetCard.balance || 0) - amount).toFixed(2);

        // è®°ä¸€ç¬”ç”¨æˆ·æµå‡ºè´¦
        saveLogToStorage({
            date: new Date().toLocaleDateString('en-US',{month:'short',day:'2-digit'}).toUpperCase(),
            name: "SENT TO CHARACTER",
            category: memo,
            amount: amount.toFixed(2),
            type: 'outflow',
            cardIndex: window.selectedCardIdx
        });

        // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®æ–°å¢ï¼šæŠŠè¿™ç¬”æ”¶å…¥å†™å…¥è§’è‰²çš„æ—¥è®°å½•æœ¬ï¼ï¼ï¼ ğŸ”¥ğŸ”¥ğŸ”¥
        // è¿™ä¸€æ­¥å¦‚æœä¸åŠ ï¼Œä½ é‚£è¾¹çš„â€œåˆ·æ–°è½¬è´¦â€æŒ‰é’®å°±è¯»ä¸åˆ°æ•°æ®
        addIncomeToEntityLog(window.selectedCharId, amount, memo);
    }

    // 5. èµ„äº§æ•°æ®æŒä¹…åŒ–
    localStorage.setItem('lune_wallets', JSON.stringify(cards));

    // 6. å‡†å¤‡é€šçŸ¥æ‰€éœ€çš„å…³é”®å˜é‡
    const last4 = targetCard.number.slice(-4);

    // 7. å‘é€çŸ­ä¿¡åŠç³»ç»Ÿé€šçŸ¥ (å¼‚æ­¥)
    try {
        if (window.currentSendMode === 'recharge') {
            await sendFinanceSMS('recharge', {
                last4: last4,
                amount: amount.toFixed(2),
                balance: targetCard.balance
            });
        } else {
            const charList = await loadFromDB('char_list') || [];
            const targetChar = charList.find(c => String(c.id) === String(window.selectedCharId));
            
            await sendFinanceSMS('transfer', {
                last4: last4,
                amount: amount.toFixed(2),
                targetName: targetChar ? targetChar.name : "æœªçŸ¥å®ä½“",
                memo: memo,
                balance: targetCard.balance
            });
        }
    } catch (e) {
        console.error("Notification Error:", e);
    }
    
    // 8. å…¨å±€ UI åŒæ­¥
    if (typeof renderSavedCards === 'function') renderSavedCards();
    if (typeof updateBalanceDisplay === 'function') updateBalanceDisplay();
    if (typeof applyFilterProtocol === 'function') applyFilterProtocol();

    // 9. å‘¼å‡ºæˆåŠŸé¡µé¢å¼¹çª—
    const successLayer = document.getElementById('transfer-success-layer');
    if (successLayer) {
        successLayer.style.display = 'flex';
    }

    // 10. éœ‡æ„Ÿåé¦ˆ
    if (window.navigator.vibrate) window.navigator.vibrate([10, 30, 10]);

    console.log("ã€èµ„äº§ç»“ç®—ä¸­å¿ƒã€‘è°ƒåº¦åè®®å·²å®Œæˆï¼ŒæˆåŠŸå±‚å·²æ¿€æ´»ã€‚");
}

/**
 * è´¦å•æŒä¹…åŒ–å­˜å‚¨å‡½æ•°
 * è´Ÿè´£å°†æ¯ä¸€ç¬”è½¬è´¦æˆ–å……å€¼è®°å½•å­˜å…¥æµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨ä¸­
 */
function saveLogToStorage(log) {
    // 1. è·å–ç°æœ‰è´¦å•æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
    // ä½¿ç”¨ 'lune_wallet_logs' ä½œä¸ºå”¯ä¸€è¯†åˆ« Key
    let logs = JSON.parse(localStorage.getItem('lune_wallet_logs') || '[]');

    // 2. å°†æ–°äº§ç”Ÿçš„è®°å½•æ’å…¥åˆ°æ•°ç»„çš„æœ€å‰é¢ï¼ˆç¡®ä¿æœ€æ–°çš„äº¤æ˜“æ’åœ¨æœ€ä¸Šé¢ï¼‰
    logs.unshift(log);

    // 3. å°†æ›´æ–°åçš„æ•°ç»„é‡æ–°å­˜å› localStorage
    localStorage.setItem('lune_wallet_logs', JSON.stringify(logs));
    
    console.log("æ¡£æ¡ˆåº“ï¼šæ–°äº¤æ˜“è®°å½•å·²å­˜å…¥ã€‚");
}

/**
 * å…³é—­æˆåŠŸæç¤ºå±‚å¹¶è¿”å›ä¸»é¡µ
 */
function closeSuccessLayer() {
    // 1. éšè—æˆåŠŸå¼¹çª—
    const layer = document.getElementById('transfer-success-layer');
    if (layer) layer.style.display = 'none';

    // 2. æ¸…ç©ºè¾“å…¥æ¡†å†…å®¹ï¼Œä¸ºä¸‹æ¬¡æ“ä½œåšå‡†å¤‡
    const amountInput = document.getElementById('send-amount');
    const memoInput = document.getElementById('send-memo');
    if (amountInput) amountInput.value = '';
    if (memoInput) memoInput.value = '';

    // 3. ã€è‡ªåŠ¨è·³è½¬ã€‘é€»è¾‘ï¼šè½¬è´¦æˆåŠŸåè‡ªåŠ¨è·³å› CARD é¡µé¢ (ç´¢å¼•ä¸º0)
    // è¿™æ ·ç”¨æˆ·å°±èƒ½ç«‹åˆ»çœ‹åˆ°æ–°å……å€¼çš„é’±åˆ°è´¦äº†
    if (typeof switchWTab === 'function') {
        switchWTab(0, 'CARD');
    }
    
    // 4. é‡ç½®é€‰ä¸­çŠ¶æ€ï¼Œé˜²æ­¢ä¸‹æ¬¡è¿›æ¥è¿˜æ˜¯é€‰ä¸­çš„
    window.selectedCardIdx = null;
    window.selectedCharId = null;

    console.log("äº¤æ˜“ä¼šè¯å·²å…³é—­ï¼Œç³»ç»Ÿè¿”å›ä¸»ç•Œé¢ã€‚");
}

/**
 * å¼ºåˆ¶åˆå§‹åŒ–å†å²è´¦å•ï¼šç¡®ä¿åˆ·æ–°åè®°å½•ä¾ç„¶å¯è§
 */
function initWalletHistory() {
    console.log("æ¡£æ¡ˆåè®®ï¼šæ­£åœ¨å¼ºåˆ¶æ£€ç´¢å†å²è®°å½•...");
    
    const list = document.querySelector('.history-scroll-list');
    if (!list) return;

    // 1. ä»ç¡¬ç›˜è¯»å–æ‰€æœ‰æ—¥å¿—
    const allLogs = JSON.parse(localStorage.getItem('lune_wallet_logs') || '[]');

    // 2. æ¸…ç©ºå½“å‰åˆ—è¡¨ï¼ˆé˜²æ­¢é‡å¤ï¼‰
    list.innerHTML = '';

    // 3. åˆ¤æ–­æ˜¯å¦æœ‰è®°å½•
    if (allLogs.length === 0) {
        list.innerHTML = `
            <div class="empty-history-state">
                <div class="empty-icon-deco"></div>
                <p>NULL DATA ARCHIVE</p>
                <span>å½“å‰è´¦æˆ·æ— ä»»ä½•èµ„äº§è°ƒé…è®°å½•</span>
            </div>`;
        return;
    }

    // 4. ç›´æ¥æ¸²æŸ“å…¨éƒ¨è®°å½•ï¼ˆé»˜è®¤å±•ç¤ºå…¨éƒ¨ï¼‰
    list.innerHTML = allLogs.map(log => `
        <div class="history-entry" style="animation: entryFade 0.4s ease backwards;">
            <div class="entry-date">${log.date}</div>
            <div class="entry-info">
                <div class="entry-name">${log.name}</div>
                <div class="entry-category">${log.category || 'Standard Protocol'}</div>
            </div>
            <div class="entry-amount ${log.type}">
                ${log.type === 'inflow' ? '+' : '-'} ${parseFloat(log.amount).toFixed(2)}
            </div>
        </div>
    `).join('');

    console.log(`æ¡£æ¡ˆåè®®ï¼šå·²æˆåŠŸæ¸²æŸ“ ${allLogs.length} æ¡åŸå§‹è®°å½•ã€‚`);
}

/**
 * èµ„äº§ç»“ç®—ä¸­å¿ƒï¼šè‡ªåŠ¨åŒ–çŸ­ä¿¡ç½‘å…³
 * @param {string} type - 'create' (å¼€å¡), 'recharge' (å……å€¼), 'transfer' (è½¬è´¦)
 * @param {object} data - åŒ…å« amount, last4, balance, targetName, memo ç­‰
 */
async function sendFinanceSMS(type, data) {
    const FIN_ID = "SERVICE_FINANCE_CORE";
    const timestamp = Date.now();
    
    // 1. æ„é€ é“¶è¡Œæ–‡æ¡ˆ
    let content = "";
    if (type === 'create') {
        content = `ã€Lune Bankã€‘èµ„äº§å¡ç‰‡ï¼ˆå°¾å· ${data.last4}ï¼‰åˆå§‹åŒ–æˆåŠŸã€‚å½“å‰ä½™é¢ï¼šÂ¥${data.balance}ã€‚`;
    } else if (type === 'recharge') {
        content = `ã€èµ„äº§ç»“ç®—ä¸­å¿ƒã€‘å……å€¼ç¡®è®¤ï¼šå¡ç‰‡ï¼ˆå°¾å· ${data.last4}ï¼‰å…¥è´¦ Â¥${data.amount}ã€‚ä½™é¢ï¼šÂ¥${data.balance}ã€‚`;
    } else if (type === 'transfer') {
        content = `ã€èµ„äº§ç»“ç®—ä¸­å¿ƒã€‘æ”¯å‡ºæé†’ï¼šå‘ã€${data.targetName}ã€‘è½¬è´¦ -Â¥${data.amount}ã€‚å¤‡æ³¨ï¼š${data.memo || 'æ— '}ã€‚`;
    }

    // 2. âš¡ å¯¹æ¥ï¼šè§¦å‘ä½ æä¾›çš„é¡¶éƒ¨æ¨ªå¹…å¼¹çª—
    if (typeof window.showPushNotification === 'function') {
        window.showPushNotification("èµ„äº§ç»“ç®—ä¸­å¿ƒ", content);
    }

    // 3. æ„é€ ä¿¡æ¯ App å†…éƒ¨çš„æ¶ˆæ¯å¯¹è±¡ (ç”¨äº Messages é‡Œçš„ SYSTEM æ ‡ç­¾)
    const msgObj = {
        id: "FIN_" + timestamp,
        role: "assistant", 
        text: content,
        timestamp: timestamp,
        app_source: 'sms', 
        isRead: false
    };

    // 4. ä¿å­˜åˆ°èŠå¤©è®°å½•æ•°æ®åº“ (Messages App)
    await saveChatMessage(FIN_ID, msgObj);
    
    // 5. ç¡®ä¿ NPC èº«ä»½åœ¨ SYSTEM æ ‡ç­¾æ˜¾ç¤º
    let friends = await loadFromDB('chat_friends') || [];
    let finCore = friends.find(f => f.id === FIN_ID);
    if (finCore) {
        finCore.isSystem = true; // é”å®šç³»ç»Ÿæ ‡ç­¾
        finCore.lastMsg = content;
        finCore.time = timestamp;
        await saveToDB('chat_friends', friends);
    }

    // 6. åˆ·æ–°ä¿¡æ¯ App çš„åˆ—è¡¨ç•Œé¢
    if (typeof renderLmsgList === 'function') renderLmsgList();
}

/**
 * æ‰‹åŠ¨ä¿å­˜èŠå¤©è®°å½•ï¼š
 * å¤‡ä»½ä¿å­˜å‡½æ•°ï¼šç›´æ¥å­˜å…¥å†å²è®°å½•æ•°ç»„
 */
async function manualSaveHistory(friendId, msg) {
    let history = await getChatHistory(friendId) || [];
    history.push(msg);
    await saveToDB('chat_history_' + friendId, history);
}

/**
 * é’±åŒ…ä¸“ç”¨é€€å‡ºåè®® (å¼ºåŒ–ç‰ˆ)
 */
function exitLuneWallet() {
    console.log("System: æ­£åœ¨å°è¯•å…³é—­é’±åŒ…åº”ç”¨...");

    // 1. å°è¯•é€šè¿‡å¤šç§å¯èƒ½å‡ºç°çš„ ID å®šä½å®¹å™¨
    const walletEl = document.getElementById('page-wallet') || 
                     document.getElementById('wallet-app-overlay');
    
    if (!walletEl) {
        console.error("Critical Error: æ‰¾ä¸åˆ°é’±åŒ…å®¹å™¨ï¼Œè¯·æ£€æŸ¥ ID æ˜¯å¦ä¸º walletApp");
        return;
    }

    // 2. ç«‹å³ç§»é™¤åŠ¨ç”»ç±»ï¼Œè§¦å‘ CSS æ¶ˆå¤±åŠ¨ç”»
    walletEl.classList.remove('active');

    // 3. å¼ºåˆ¶æ¢å¤é¡µé¢æ»šåŠ¨ (é˜²æ­¢å…³æ‰åä¸»é¡µé¢åˆ’ä¸åŠ¨)
    document.body.style.overflow = '';
    
    // 4. è§¦æ„Ÿåé¦ˆ
    if (window.navigator.vibrate) window.navigator.vibrate(10);

    // 5. ğŸš¨ æ ¸å¿ƒï¼šå¦‚æœ 400ms åè¿˜æ²¡æ¶ˆå¤±ï¼Œç›´æ¥æš´åŠ›è®¾ç½®ä¸º display: none
    setTimeout(() => {
        walletEl.style.display = 'none';
        
        // 6. é‡ç½®é’±åŒ…åˆ°é¦–é¡µï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰“å¼€è¿˜åœ¨è½¬è´¦é¡µ
        if (typeof switchWTab === 'function') {
            switchWTab(0, 'CARD');
        }
        
        // 7. æ¸…ç†ä¸´æ—¶æ•°æ®
        window.selectedCardIdx = null;
        window.selectedCharId = null;
        
        console.log("ã€Lune Reserveã€‘é’±åŒ…å·²å®‰å…¨æŒ‚èµ·å¹¶å¼ºåˆ¶éšè—ã€‚");
    }, 400);
}

/**
 * ç³»ç»Ÿçº§é€šçŸ¥æ¨é€
 * @param {Object} data { title, text, icon, appId }
 */
function pushSystemNotification(data) {
    // 1. æŒä¹…åŒ–åˆ°é€šçŸ¥ä¸­å¿ƒæ•°æ®åº“
    let centerLogs = JSON.parse(localStorage.getItem('lune_notification_center') || '[]');
    const newNotif = {
        id: "NOTIF_" + Date.now(),
        ...data,
        time: new Date().getTime(),
        isRead: false
    };
    centerLogs.unshift(newNotif); // æœ€æ–°é€šçŸ¥åœ¨å‰
    localStorage.setItem('lune_notification_center', JSON.stringify(centerLogs.slice(0, 50))); // æœ€å¤šä¿ç•™50æ¡

    // 2. åˆ›å»ºæˆ–è·å–è§†è§‰æ¨ªå¹… DOM
    let banner = document.getElementById('global-notif-banner');
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'global-notif-banner';
        banner.className = 'lune-notification-banner';
        document.body.appendChild(banner);
    }

    // 3. å¡«å……å†…å®¹
    banner.innerHTML = `
        <img src="${data.icon}" class="notif-icon">
        <div class="notif-body">
            <div class="notif-title">${data.title}</div>
            <div class="notif-text">${data.text}</div>
        </div>
    `;

    // 4. æ‰§è¡ŒåŠ¨ç”»
    setTimeout(() => banner.classList.add('active'), 100);
    
    // è§¦æ„Ÿåé¦ˆ
    if (window.navigator.vibrate) window.navigator.vibrate([30, 50, 30]);

    // 5. è‡ªåŠ¨æ”¶èµ·
    setTimeout(() => {
        banner.classList.remove('active');
    }, 4000);

    // ç‚¹å‡»å¼¹çª—å¯ä»¥è·³è½¬å›å¯¹åº” App
    banner.onclick = () => {
        banner.classList.remove('active');
        if (typeof openApp === 'function') openApp(data.appId);
    };
}

/**
 * æ¸²æŸ“è§’è‰²èµ„äº§æ¡£æ¡ˆåº“ (Luna Bank é«˜çº§å®šåˆ¶ç‰ˆ)
 */
async function renderCharacterArchives() {
    const grid = document.getElementById('archive-grid-container');
    if (!grid) return;

    // 1. è·å–è§’è‰²ä¹¦ä¸­çš„éç³»ç»Ÿè§’è‰²
    const allChars = await loadFromDB('char_list') || [];
    // è¿‡æ»¤æ‰ç³»ç»ŸæœåŠ¡ï¼Œåªæ˜¾ç¤ºçœŸæ­£çš„å®ä½“è§’è‰²
    const charList = allChars.filter(c => !c.id.toString().startsWith('SERVICE_'));
    
    if (charList.length === 0) {
        grid.innerHTML = `<div style="text-align:center; padding:100px; font-family:monospace; color:#ccc;">[ ERROR: NO ENTITY DETECTED ]</div>`;
        return;
    }

    grid.innerHTML = charList.map(char => {
        // ç‹¬ç«‹å­˜å‚¨æ•°æ®
        const key = `lune_archive_${char.id}`;
        let archive = JSON.parse(localStorage.getItem(key)) || {
            balance: (Math.random() * 9999 + 1000).toFixed(2),
            credit: ['S-LEVEL', 'A-LEVEL', 'B-LEVEL'][Math.floor(Math.random()*3)],
            clearance: "LEVEL " + (Math.floor(Math.random()*5) + 1),
            status: "AUTHORIZED"
        };
        localStorage.setItem(key, JSON.stringify(archive));

        // éšæœºç”Ÿæˆæ¡å½¢ç ä¸‹æ–¹çš„æ•°å­—
        const barSerial = Math.floor(Math.random() * 1000000000000);

        

        return `
            <div class="ticket-row" onclick="openDeepArchive('${char.id}')">
                <div class="ticket-section identity">
                    <div class="ticket-photo-wrap">
                        <img src="${char.avatar}" class="ticket-avatar">
                    </div>
                    <div style="font-size:9px; color:#888; font-family:monospace; margin-bottom:5px;">NODE.${char.id}</div>
                    <div class="ticket-name">${char.name}</div>
                </div>

                <div class="ticket-section data-terminal">
                    <div class="data-point">
                        <span class="data-label">NET ASSETS</span>
                        <span class="data-value">ï¿¥${Math.floor(archive.balance)}</span> </div>
                    <div class="data-point">
                        <span class="data-label">CREDIT RATING</span>
                        <span class="data-value" style="letter-spacing:1px;">${archive.credit}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">CLEARANCE</span>
                        <span class="data-value">${archive.clearance}</span>
                    </div>
                    <div class="data-point">
                        <span class="data-label">ENTITY STATUS</span>
                        <span class="data-value">${archive.status}</span>
                    </div>
                </div>

                <div class="ticket-section stub">
                    <div class="barcode-container">
                        <div class="barcode-strip"></div>
                        <div class="barcode-num">${barSerial}</div>
                    </div>
                    
                    <div class="luna-bank-stamp">
                        <div class="stamp-inner">
                            <span class="stamp-text">LUNA BANK</span>
                            <span class="stamp-text stamp-core">OFFICIAL</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // åœ¨ renderCharacterArchives å‡½æ•°å†…éƒ¨ä¿®æ”¹ï¼š
    const getArchiveData = (id) => {
        const key = `lune_archive_${id}`;
        let data = JSON.parse(localStorage.getItem(key));
        
        // âš¡ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ•°æ®å­˜åœ¨ä½†ç¼ºå¤±æ–°å­—æ®µï¼Œæˆ–è€…å¹²è„†æ²¡æ•°æ®
        if (!data || !data.clearance) {
            data = {
                balance: data?.balance || (Math.random() * 8000 + 2000).toFixed(2),
                credit: data?.credit || ['S-LEVEL', 'A-LEVEL', 'B-LEVEL'][Math.floor(Math.random()*3)],
                // ç¡®ä¿è¿™é‡Œä¸€å®šæœ‰å€¼ï¼Œä¸å†æ˜¯ undefined
                clearance: "LEVEL " + (Math.floor(Math.random()*5) + 1), 
                status: data?.status || "AUTHORIZED",
                lastUpdate: new Date().toLocaleDateString()
            };
            localStorage.setItem(key, JSON.stringify(data));
        }
        return data;
    };
}

/**
 * æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ  null æ£€æŸ¥ï¼Œå¹¶è”åŠ¨å¼ºåˆ¶åˆ·æ–°æœˆåº¦è´¦å•
 */
async function openDeepArchive(input) {
    const overlay = document.getElementById('bank-detail-overlay');
    if (!overlay) {
        console.error("[æ¡£æ¡ˆä¸­å¿ƒ] æ‰¾ä¸åˆ°ä¸»å®¹å™¨ bank-detail-overlay");
        return;
    }

    let charData = null;
    // 1. ç¡®å®šè§’è‰²æ•°æ®æº
    if (typeof input === 'object' && input !== null) {
        charData = input;
    } else {
        const allChars = await loadFromDB('char_list') || [];
        charData = allChars.find(c => c.id.toString() === input.toString());
    }

    // 2. é”å®šå…¨å±€çŠ¶æ€
    if (charData) {
        window.currentVaultCharName = charData.name;
        window.currentVaultCharID = charData.id || charData.name; // ğŸ‘ˆ ID æ›´æ–°äº†
        window.currentVaultCharBio = charData.bio || charData.description || "èº«ä»½å·²åŠ å¯†ã€‚";
        
        // æ›´æ–°é¡¶éƒ¨çš„ä½™é¢æ˜¾ç¤º
        const b1 = document.getElementById('current-balance-num');
        const b2 = document.getElementById('detail-balance-value');
        
        if (b1) b1.innerText = charData.balance || "0.00";
        if (b2) b2.innerText = charData.balance || "0.00";
        
        console.log(`[æ¡£æ¡ˆä¸­å¿ƒ] é”å®šè§’è‰²: ${window.currentVaultCharName} (ID: ${window.currentVaultCharID})`);
    }

    // 3. æ˜¾ç¤ºå¼¹çª—
    overlay.classList.add('show');
    if (window.navigator.vibrate) window.navigator.vibrate(15);
    
    // 4. åˆ·æ–° NPC åˆ—è¡¨ (ä¿ç•™åŸæœ‰é€»è¾‘)
    if (typeof renderNPCRecords === 'function') renderNPCRecords(); 

    // --- ğŸš¨ğŸš¨ğŸš¨ æ ¸å¿ƒä¿®å¤è¡¥ä¸å¼€å§‹ ğŸš¨ğŸš¨ğŸš¨ ---
    // ID å˜äº†ï¼Œå¿…é¡»é€šçŸ¥æœˆåº¦æ¨¡å—â€œé‡æ–°åŠ è½½æ•°æ®å¹¶å¼ºåˆ¶æ˜¾ç¤ºâ€
    // å¦åˆ™è¿™é‡Œæ˜¾ç¤ºçš„è¿˜æ˜¯ä¸Šä¸€ä¸ªè§’è‰²çš„è´¦å•ï¼Œæˆ–è€…å¹²è„†æ˜¯ç©ºç™½
    if (typeof window.triggerDashboardInit === 'function') {
        // ç¨å¾®å»¶è¿Ÿ 50msï¼Œç­‰ overlay çš„åŠ¨ç”»å¼€å§‹åå†æ¸²æŸ“ï¼Œé¿å…å¡é¡¿
        setTimeout(() => {
            window.triggerDashboardInit(); 
        }, 50);
    } else {
        console.warn("âš ï¸ è­¦å‘Šï¼šç¼ºå°‘ triggerDashboardInitï¼Œæœˆåº¦è´¦å•å¯èƒ½æœªåˆ·æ–°");
    }
    // --- æ ¸å¿ƒä¿®å¤è¡¥ä¸ç»“æŸ ---
}

/**
 * 1. å”¤èµ·è‡ªå®šä¹‰ä¿®æ”¹å¼¹çª—
 */
function triggerBalanceEdit() {
    const modal = document.getElementById('balance-edit-modal');
    const input = document.getElementById('new-balance-input');
    const currentVal = document.getElementById('current-balance-num').innerText;
    
    // åˆå§‹åŒ–è¾“å…¥æ¡†çš„å€¼
    input.value = currentVal.replace(/,/g, '');
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.style.display = 'flex';
    input.focus();

    if (window.navigator.vibrate) window.navigator.vibrate(10);
}

/**
 * 2. å…³é—­å¼¹çª—
 */
function closeBalanceEditor() {
    document.getElementById('balance-edit-modal').style.display = 'none';
}

/**
 * 3. æ‰§è¡Œä¿®æ”¹é€»è¾‘
 */
function confirmBalanceEdit() {
    const input = document.getElementById('new-balance-input');
    const displayNum = document.getElementById('current-balance-num');
    const detailDisplayNum = document.getElementById('detail-balance-value'); // åŒæ­¥ä½™é¢åŒº
    
    const newVal = parseFloat(input.value);

    if (!isNaN(newVal)) {
        const formattedVal = newVal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        // åŒæ­¥æ‰€æœ‰æ˜¾ç¤ºä½™é¢çš„åœ°æ–¹
        if(displayNum) displayNum.innerText = formattedVal;
        if(detailDisplayNum) detailDisplayNum.innerText = formattedVal;

        // å…³é—­å¹¶åé¦ˆ
        closeBalanceEditor();
        if (window.navigator.vibrate) window.navigator.vibrate([10, 50]);
    } else {
        // å¦‚æœè¾“å…¥éæ³•ï¼Œç»™è¾“å…¥æ¡†ä¸€ä¸ªæŠ–åŠ¨æ•ˆæœæˆ–å˜çº¢ï¼ˆå¯é€‰ï¼‰
        input.style.borderColor = 'red';
        setTimeout(() => input.style.borderColor = '#000', 500);
    }
}

/**
 * 2. å…³é—­å‡½æ•°
 */
function closeBankDetail() {
    document.getElementById('bank-detail-overlay').classList.remove('show');
}

/**
 * 1. ç‚¹å‡»ä¸»é¡µé¢ä¸Šçš„ + ADD_PROTOCOL_LINK æŒ‰é’®è°ƒç”¨æ­¤å‡½æ•°
 */
function customProtocolAction() {
    const overlay = document.getElementById('protocol-link-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        // é”åˆ©éœ‡åŠ¨
        if (window.navigator.vibrate) window.navigator.vibrate(12);
    }
}

/**
 * 2. å…³é—­åè®®æ¨¡æ€æ¡†
 */
function closeProtocolModal() {
    document.getElementById('protocol-link-overlay').style.display = 'none';
}

// å…¨å±€å˜é‡è®°å½•å½“å‰æ“ä½œçš„è§’è‰²ï¼ˆå»ºè®®æ ¹æ®ä½ é¡¹ç›®å®é™…çš„è§’è‰² ID è·å–ï¼‰
let currentCharID = "DEFAULT_CHAR"; 

/**
 * 1. å…¥å£ï¼šç‚¹å‡»â€œè§’è‰²ç»‘å¡è®°å½•â€
 */
function handleCharacterBindingRecord() {
    // å…³é—­ä¹‹å‰çš„åè®®é€‰æ‹©æ¡†
    closeProtocolModal();
    // æ‰“å¼€è®°å½•åˆ—è¡¨é¡µ
    document.getElementById('npc-binding-list-overlay').style.display = 'flex';
    // åŠ è½½å·²ä¿å­˜çš„æ•°æ®
    renderNPCRecords();
}

/**
 * 2. æ¸²æŸ“è®°å½•åˆ—è¡¨
 */
function renderNPCRecords() {
    const container = document.getElementById('npc-record-container');
    const records = getStoredNPCBindings();
    
    if (records.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:20px; font-size:10px; color:#aaa;">NO_LINK_FOUND / æ— è®°å½•</div>`;
        return;
    }

    container.innerHTML = records.map((rec, index) => `
        <div class="npc-record-item" onclick="showBindingStory(${index})">
            <div>
                <span class="npc-name">${rec.npcName}</span>
                <span class="npc-card-type">${rec.cardType}</span>
            </div>
            <div style="font-size:10px;">READ_STORY â†’</div>
        </div>
    `).join('');
}

/**
 * 3. çœŸå®è°ƒç”¨ AI ç”Ÿæˆè®°å½• (æè‡´æ°›å›´æ„Ÿ + èº«ä»½è”åŠ¨)
 */
async function generateNPCCardWithAI() {
    // --- 1. åŸºç¡€ç¯å¢ƒæ ¡éªŒ ---
    if (!window.currentVaultCharName) {
        showToast("âš ï¸ æ¡£æ¡ˆåŒæ­¥å¤±è´¥: æœªé”å®šå½“å‰å®ä½“");
        return;
    }

    const overlay = document.getElementById('ai-loading-overlay');
    const progressBar = document.getElementById('ai-progress-bar');
    const statusText = document.getElementById('loading-status-text');

    // ç»Ÿä¸€è¯»å–ä½ ä»£ç ä¸­ç”Ÿæ•ˆçš„é…ç½®
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) {
        showIOSConfirm("ç§˜é’¥ç¼ºå¤±", "ç³»ç»Ÿæœªæ£€æµ‹åˆ° API Keyï¼Œæ˜¯å¦å‰å¾€é…ç½®ï¼Ÿ", "å»é…ç½®", () => {
            closeNPCList();
            openApp('settingsApp');
        });
        return;
    }

    // --- 2. å¯åŠ¨å·¥ä¸šçº§è§£å¯†åŠ¨ç”» ---
    if (overlay) overlay.style.display = 'flex';
    if (statusText) statusText.innerText = `DECRYPTING LORE: ${window.currentVaultCharName.toUpperCase()}`;
    
    let progress = 0;
    const progressTimer = setInterval(() => {
        if (progress < 45) {
            progress += Math.random() * 5;
            if (progressBar) progressBar.style.width = progress + '%';
        }
    }, 200);

    // --- 3. æ„é€ æè‡´æ°›å›´æ„Ÿ Prompt (å¢åŠ æ’ç‰ˆæŒ‡ä»¤) ---
const charBio = window.currentVaultCharBio || "æ¡£æ¡ˆå—æŸï¼Œè¯¥å®ä½“çš„è¿‡å»å¤„äºé«˜åº¦åŠ å¯†çŠ¶æ€ã€‚";

const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå†·å³»ã€ç»†è…»ä¸”å¯Œæœ‰æ–‡å­¦åº•è•´çš„â€œå‘½è¿è§‚æµ‹è€…â€ã€‚
ä½ çš„ä»»åŠ¡æ˜¯ä¸ºã€ä¸»è§’ã€‘æ¨æ¼”ä¸€æ®µä¸ä¸ºäººçŸ¥çš„ç§˜å¯†è´¢åŠ¡ç¾ç»Šã€‚

æ–‡é£ä¸æ’ç‰ˆè¦æ±‚ï¼š
1. å·¥ä¸šé…¸æ¶©æ„Ÿï¼šæ–‡å­—è¦åƒå†°å†·çš„é›¨æ°´æ‰“åœ¨ç”Ÿé”ˆçš„é’¢é“ä¸Šï¼Œå…‹åˆ¶ä¸­å¸¦ç€ç ´ç¢çš„æ·±æƒ…ã€‚
2. è§†è§’èåˆï¼šå¿…é¡»ä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€æ¥æŒ‡ä»£ç”¨æˆ·ã€‚
3. ã€è§†è§‰æ’ç‰ˆã€‘ï¼š
   - ä½¿ç”¨åŒæ¢è¡Œç¬¦ï¼ˆ\\n\\nï¼‰æ¥åˆ†æ®µï¼Œæ¯æ®µè¯ä¸è¦å¤ªé•¿ã€‚
   - ä½¿ç”¨å·¥ä¸šç¬¦å·å¦‚ ">>" æˆ– "---" ä½œä¸ºæ®µè½çš„å¼€å¤´æˆ–ç‚¹ç¼€ã€‚
   - å…³é”®çš„é‡‘é¢ã€æ—¥æœŸæˆ–è¿çº¦ä»£ä»·ï¼Œå¯ä»¥ç”¨ã€ã€‘æ‹¬èµ·æ¥å¢åŠ è§†è§‰é‡å¿ƒã€‚
4. é•¿åº¦ï¼š300å­—å·¦å³ï¼Œç»“æ„è¦æ¸…çˆ½ï¼Œé¿å…å¤§æ®µå †ç Œã€‚

è¾“å‡ºæ ¼å¼ï¼šå¿…é¡»è¾“å‡ºä¸¥æ ¼çš„ JSON æ ¼å¼ï¼š
{
  "npcName": "é€‰å®šçš„NPCåå­—",
  "cardType": "å¥‘çº¦è½½ä½“/å¡ç‰‡ç±»å‹",
  "story": "å¸¦æœ‰åˆ†æ®µå’Œç¬¦å·çš„ã€ç¾åŒ–æ’ç‰ˆåçš„èƒŒæ™¯æ•…äº‹"
}`;

    const userPrompt = `
ã€ä¸»è§’æ¡£æ¡ˆã€‘ï¼š${window.currentVaultCharName}
ã€æ ¸å¿ƒèƒŒæ™¯ã€‘ï¼š${charBio}

æŒ‡ä»¤ï¼š
è¯·åŸºäºä»¥ä¸Šæ•°æ®ï¼Œæ¨æ¼”å¹¶è§£æå‡ºä¸ºä»€ä¹ˆ ${window.currentVaultCharName} ä¼šèƒŒç€æ‰€æœ‰äººï¼Œç”šè‡³èƒŒç€â€œä½ â€ï¼Œä¸æŸä½ç‰¹å®šçš„ NPC å»ºç«‹äº†ä¸€ä¸ªç§˜å¯†è´¦æˆ·ã€‚
è¯·åœ¨æ•…äº‹é‡Œè§£é‡Šâ€œä½ â€å¦‚ä½•æ„å¤–å‘ç°äº†è¿™ä¸ªè´¦æˆ·ï¼Œä»¥åŠå¡ç‰‡ä¸Šè·³åŠ¨çš„æ•°å­—èƒŒåï¼Œéšè—ç€ä¸¤äººä¹‹é—´æ€æ ·çš„è‡ªæˆ‘ç‰ºç‰²æˆ–é—æ†¾ã€‚`;

    try {
        // --- 4. å‘èµ·è¯·æ±‚ ---
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${apiKey}` 
            },
            body: JSON.stringify({
                model: model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ],
                temperature: 0.95,
                response_format: { type: "json_object" } // å¼ºåˆ¶ JSON
            })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const rawContent = data.choices[0].message.content;
        
        // --- 5. è§£æ AI è¿”å›çš„ JSON æ•°æ®åŒ… ---
        const jsonMatch = rawContent.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error("æ¡£æ¡ˆç¼–ç è§£æå¼‚å¸¸");
        
        const aiResult = JSON.parse(jsonMatch[0]);

        // åŠ¨ç”»åé¦ˆ
        clearInterval(progressTimer);
        if (progressBar) progressBar.style.width = '100%';
        if (statusText) statusText.innerText = "DECRYPTION_SUCCESSFUL";

        // --- 6. æ¡£æ¡ˆå­˜ç›˜ ---
        const newRecord = {
            npcName: aiResult.npcName || "æœªçŸ¥å®ä½“",
            cardType: aiResult.cardType || "SECRET_LINK",
            story: aiResult.story || "è§£å¯†å¤±è´¥ï¼Œæ¡£æ¡ˆç¼ºå¤±ã€‚",
            timestamp: new Date().getTime(),
            id: 'PROT-' + Math.random().toString(36).substr(2, 5).toUpperCase()
        };

        // å»¶è¿Ÿå…³é—­ï¼Œå¢å¼ºä»ªå¼æ„Ÿ
        setTimeout(() => {
            saveNPCBinding(newRecord);
            renderNPCRecords();
            if (overlay) overlay.style.display = 'none';
            if (progressBar) progressBar.style.width = '0%';
        }, 1000);

    } catch (e) {
        console.error("AI_GEN_ERROR:", e);
        showToast("âš ï¸ ç»´åº¦åç¼©: " + e.message);
        clearInterval(progressTimer);
        if (overlay) overlay.style.display = 'none';
    }
}

/**
 * 4. æ˜¾ç¤ºæ•…äº‹å¼¹çª— (å¢åŠ æ’ç‰ˆè½¬æ¢é€»è¾‘)
 */
function showBindingStory(index) {
    const records = getStoredNPCBindings();
    const target = records[index];
    
    if (!target) return;

    const modal = document.getElementById('binding-story-modal');
    const textContainer = document.getElementById('story-text-content');

    if (modal && textContainer) {
        // --- æ ¸å¿ƒä¼˜åŒ–ï¼šå¤„ç†æ¢è¡Œå’Œç¬¦å·æ¸²æŸ“ ---
        // 1. å°† AI çš„æ¢è¡Œç¬¦ \n è½¬æ¢ä¸º HTML çš„ <br>
        // 2. å°†ä¸€äº›ç‰¹æ®Šç¬¦å·è¿›è¡Œç®€å•çš„æ ·å¼åŒ…è£¹ï¼ˆå¯é€‰ï¼‰
        let formattedStory = target.story.replace(/\n/g, '<br>');
        
        // å¦‚æœæƒ³è®©ã€å…³é”®è¯ã€‘å˜äº®ä¸€ç‚¹ï¼Œå¯ä»¥åŠ è¿™è¡Œæ­£åˆ™ï¼ˆå¯é€‰ï¼‰
        formattedStory = formattedStory.replace(/ã€(.*?)ã€‘/g, '<span style="font-weight:900; color:#000; background:#eee; padding:0 4px;">$1</span>');

        textContainer.innerHTML = formattedStory;
        
        // ç¡®ä¿å®¹å™¨æ ·å¼æ”¯æŒè‰¯å¥½çš„è¡Œé—´è·
        textContainer.style.lineHeight = "1.8";
        textContainer.style.letterSpacing = "0.5px";
        textContainer.style.textAlign = "justify";

        modal.style.display = 'flex';
    }
    
    if (window.navigator.vibrate) window.navigator.vibrate(5);
}

/**
 * å…³é—­æ•…äº‹å¼¹çª—
 */
function closeStoryModal() {
    const modal = document.getElementById('binding-story-modal');
    if (modal) modal.style.display = 'none';
}

/**
 * ä¿å­˜è®°å½•ï¼šæ ¹æ®å½“å‰è§’è‰² ID è¿›è¡Œéš”ç¦»å­˜å‚¨
 */
function saveNPCBinding(record) {
    const charID = window.currentVaultCharID || 'GLOBAL';
    const storageKey = `LUNE_NPC_BINDING_${charID}`;
    
    let records = JSON.parse(localStorage.getItem(storageKey) || "[]");
    records.unshift(record);
    localStorage.setItem(storageKey, JSON.stringify(records));
}

/**
 * è¯»å–è®°å½•ï¼šåªè¯»å–å½“å‰è§’è‰²çš„
 */
function getStoredNPCBindings() {
    const charID = window.currentVaultCharID || 'GLOBAL';
    const data = localStorage.getItem(`LUNE_NPC_BINDING_${charID}`);
    return data ? JSON.parse(data) : [];
}

// å…³é—­æ§åˆ¶
function closeNPCList() { document.getElementById('npc-binding-list-overlay').style.display = 'none'; }
function closeStoryModal() { document.getElementById('binding-story-modal').style.display = 'none'; }

/**
 * ğŸ› ï¸ é€šç”¨å·¥å…·ï¼šè°ƒç”¨ AI æ¥å£
 */
async function callAIForStory(sysPrompt, usrPrompt) {
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) throw new Error("API Key Missing");

    const response = await fetch(`${apiUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({
            model: model,
            messages: [{role:"system", content:sysPrompt}, {role:"user", content:usrPrompt}],
            temperature: 0.85 // æé«˜ä¸€ç‚¹åˆ›é€ æ€§
        })
    });

    const data = await response.json();
    return data.choices[0].message.content;
}

/**
 * ğŸ› ï¸ é€šç”¨å·¥å…·ï¼šæ ¼å¼åŒ–æ–‡æœ¬ (æ¢è¡Œè½¬HTML)
 */
function formatStoryText(text) {
    // æŠŠ \n æ¢æˆ <br>, å¹¶ä¸”ç»™æ¯ä¸€æ®µåŠ ä¸€ç‚¹é—´è·
    return text.replace(/\n/g, '<br>');
}

function renderTransfersInModal(transfers) {
    const box = document.getElementById('pending-transfer-box');
    const list = document.getElementById('transfer-list-content');
    
    if (transfers.length > 0) {
        box.style.display = 'block';
        list.innerHTML = transfers.map(t => `
            <div class="transfer-item-row">
                <span>USER_TRANSFER (ç”¨æˆ·è½¬è´¦)</span>
                <span style="font-weight:bold;">+ï¿¥${parseFloat(t.amount).toLocaleString()}</span>
            </div>
            <div style="font-size:9px; color:#666;">NOTE: ${t.note || 'æ— å¤‡æ³¨'}</div>
        `).join('');
    } else {
        box.style.display = 'none';
    }
}

/**
 * ğŸ’¾ 4. ä¿å­˜å¹¶æ¸²æŸ“ (ç¡®ä¿å†å²ä¸ä¸¢å¤±ç‰ˆ)
 */
function saveAndRenderEntityDaily(data) {
    const charID = window.currentVaultCharID;
    const today = new Date().toISOString().split('T')[0];
    
    // 1. è®¡ç®—ä»Šæ—¥æ€»é¢
    const dayTotal = data.reduce((acc, item) => item.type === 'income' ? acc + item.amount : acc - item.amount, 0);

    const newRecord = {
        date: today,
        items: data,
        total: dayTotal,
        timestamp: Date.now() // åŠ ä¸ªæ—¶é—´æˆ³ï¼Œç¡®ä¿å”¯ä¸€æ€§
    };

    // --- ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå†å²è®°å½•ä¿æŠ¤ ---
    
    // A. è¯»å–å†å²ï¼šå…ˆçœ‹çœ‹ä»¥å‰å­˜äº†å¤šå°‘
    const listKey = `LUNE_ENTITY_LOGS_${charID}`;
    let allLogs = JSON.parse(localStorage.getItem(listKey)) || [];

    // B. é˜²é‡å¤ï¼šå¦‚æœâ€œä»Šå¤©â€å·²ç»ç”Ÿæˆè¿‡ä¸€æ¬¡äº†ï¼Œå°±æŠŠæ—§çš„â€œä»Šå¤©â€åˆ æ‰ï¼Œæ¢æˆæ–°çš„
    // (æ³¨æ„ï¼šè¿™åªä¼šè¦†ç›–ä»Šå¤©çš„ï¼Œä¸ä¼šåŠ¨æ˜¨å¤©çš„)
    allLogs = allLogs.filter(l => l.date !== today);

    // C. å€’åºæ’å…¥ï¼šæŠŠæ–°çš„æ”¾åœ¨æ•°ç»„ç¬¬ä¸€ä¸ª (Top)
    allLogs.unshift(newRecord); 

    // D. æ°¸ä¹…å…¥åº“
    localStorage.setItem(listKey, JSON.stringify(allLogs));
    
    // --- é€»è¾‘ç»“æŸ ---

    // UI åé¦ˆ
    closeEntityDailyModal();
    renderCharExpenseList(); // åˆ·æ–°ä¸»é¡µåˆ—è¡¨
    
    if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
    alert("âœ“ ä»Šæ—¥æ•°æ®æµå·²å½•å…¥å®ä½“çŸ©é˜µ");
}

/**
 * ğŸ“ è¾…åŠ©å‡½æ•°ï¼šç›´æ¥å¾€è§’è‰²ä»Šå¤©çš„æ—¥å¿—é‡ŒåŠ ä¸€ç¬”æ”¶å…¥
 * (ç”¨äºè¿æ¥é’±åŒ…ç³»ç»Ÿå’Œè§’è‰²æ—¥è®°å½•ç³»ç»Ÿ)
 */
function addIncomeToEntityLog(charID, amount, memo) {
    if (!charID) return;
    
    const listKey = `LUNE_ENTITY_LOGS_${charID}`;
    let logs = JSON.parse(localStorage.getItem(listKey)) || [];
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

    // 1. æ‰¾ä»Šå¤©æ˜¯å¦å·²ç»æœ‰æ—¥å¿—äº†
    let todayLog = logs.find(l => l.date === today);

    // 2. å¦‚æœä»Šå¤©è¿˜æ²¡ç”Ÿæˆè¿‡æ—¥å¿— (AI è¿˜æ²¡è·‘)ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„â€œå£³â€
    if (!todayLog) {
        todayLog = {
            date: today,
            items: [], 
            total: 0,
            timestamp: Date.now()
        };
        logs.unshift(todayLog); // æ”¾åˆ°æœ€å‰é¢
    }

    // 3. å¾€ items é‡ŒåŠ è¿™ä¸€ç¬”æ”¶å…¥
    todayLog.items.push({
        type: 'income',
        amount: parseFloat(amount),
        desc: `[ç”¨æˆ·è½¬è´¦] ${memo}` 
    });

    // 4. æ›´æ–°æ€»é‡‘é¢ (æ”¶å…¥å¢åŠ )
    todayLog.total += parseFloat(amount);

    // 5. ä¿å­˜å›å»
    localStorage.setItem(listKey, JSON.stringify(logs));
    
    console.log(`[ç³»ç»Ÿ] èµ„é‡‘å·²åŒæ­¥è‡³è§’è‰²æ—¥è®°å½•: +${amount}`);
}
/**
 * ğŸ•µï¸ 4. æ£€æŸ¥æŒ‰é’®çŠ¶æ€ (è¿›å¼¹çª—æ—¶è°ƒç”¨)
 */
function checkDailyButtonState(goal) {
    const btn = document.getElementById('btn-daily-deposit');
    const hint = document.getElementById('daily-deposit-hint');
    if (!btn) return;

    const todayStr = new Date().toLocaleDateString();
    let isDone = false;

    if (goal && goal.logs && goal.logs.length > 0) {
        if (goal.logs[0].fullDate === todayStr && goal.logs[0].isDailyCheckIn) {
            isDone = true;
        }
    }

    if (isDone) {
        btn.innerText = "âœ“ COMPLETED (ä»Šæ—¥å·²å®Œæˆ)";
        btn.disabled = true;
        btn.style.background = "#eee";
        btn.style.color = "#aaa";
        btn.style.border = "2px solid #eee";
        if(hint) hint.innerText = "NEXT CHECK-IN: TOMORROW";
    } else {
        btn.innerText = "+ EXECUTE_DAILY_DEPOSIT (æ¯æ—¥å­˜å…¥)";
        btn.disabled = false;
        btn.style.background = "#000";
        btn.style.color = "#fff";
        btn.style.border = "2px solid #000";
        if(hint) hint.innerText = "STATUS: READY // å¾…æ‰“å¡";
    }
}
/**
 * è¾…åŠ©ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»ŸæœåŠ¡å·
 */
function isSystemId(id) {
    const systemIds = [
        "SERVICE_WEATHER", 
        "SERVICE_CARRIER", 
        "SERVICE_SECURITY", 
        "SERVICE_CALENDAR", 
        "SYSTEM_ARCHIVE_ENTITY",
        "SERVICE_FINANCE_CORE"
    ];
    // åªè¦ ID åœ¨åˆ—è¡¨é‡Œï¼Œæˆ–è€…ä»¥ SERVICE_ å¼€å¤´ï¼Œéƒ½ç®—ç³»ç»Ÿå·
    return systemIds.includes(id) || (typeof id === 'string' && id.startsWith('SERVICE_'));
}
/**
 * ğŸ‡¨ğŸ‡³ è¯­è¨€ä»£ç è½¬ä¸­æ–‡æè¿° (Prompt ä¸“ç”¨)
 * æ›´æ–°ï¼šæ–°å¢ç²¤è¯­ã€æ³°è¯­æ”¯æŒ
 */
function getLangDesc(code) {
    const map = {
        'CN': 'ä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼Œå£è¯­åŒ–ï¼‰',
        'HK': 'ç²¤è¯­ï¼ˆCantoneseï¼Œä½¿ç”¨ç¹ä½“å­—æˆ–å£è¯­å­—ï¼Œæ¸¯é£ï¼‰', // âœ¨ ç²¤è¯­é…ç½®
        'EN': 'è‹±è¯­ï¼ˆEnglishï¼Œåœ°é“æ¯è¯­è€…å£å»ï¼‰',
        'JP': 'æ—¥è¯­ï¼ˆJapaneseï¼Œè‡ªç„¶å£è¯­ï¼‰',
        'KR': 'éŸ©è¯­ï¼ˆKoreanï¼Œè‡ªç„¶å£è¯­ï¼‰',
        'TH': 'æ³°è¯­ï¼ˆThaiï¼Œè‡ªç„¶å£è¯­ï¼‰',           // âœ¨ æ³°è¯­é…ç½®
        'FR': 'æ³•è¯­',
        'DE': 'å¾·è¯­',
        'RU': 'ä¿„è¯­',
        'ES': 'è¥¿ç­ç‰™è¯­',
        'IT': 'æ„å¤§åˆ©è¯­',
        'MIX': 'åŒè¯­æ··åˆæ¨¡å¼'
    };
    return map[code] || 'ä¸­æ–‡'; 
}
/**
 * ğŸ› æ›´æ–°ä¸‹æ–¹æ§åˆ¶é¢æ¿ (æ˜¾ç¤ºé€‰ä¸­å¡çš„ä½™é¢)
 */
function updateSimControlPanel() {
    const panel = document.getElementById('sim-control-panel');
    if (!panel) return;

    if (window.currentSimIndex === null) {
        panel.style.display = 'none';
        return;
    }

    const allCards = JSON.parse(localStorage.getItem('lune_wallets') || '[]');
    const card = allCards[window.currentSimIndex];

    if (card && card.isSim) {
        panel.style.display = 'block';
        
        // ğŸ”¥ å¦‚æœä½ çš„æ§åˆ¶é¢æ¿é‡Œæœ‰ ID="ssi-balance" çš„å…ƒç´ ï¼Œè¿™é‡Œä¼šåŒæ­¥æ›´æ–°
        const balEl = document.getElementById('ssi-balance');
        const numEl = document.getElementById('ssi-number');
        
        if(balEl) balEl.innerText = `ï¿¥${parseFloat(card.balance).toFixed(2)}`;
        if(numEl) numEl.innerText = card.number;
        
    } else {
        panel.style.display = 'none';
    }
}

/**
 * ğŸ” 1. æ™ºèƒ½ ID è·å–å™¨ (ä¿®å¤åˆ·æ–°ä¸æ˜¾ç¤ºçš„é—®é¢˜)
 * ä¼˜å…ˆçº§ï¼šå†…å­˜å˜é‡ > æœ¬åœ°ç¼“å­˜è®°å½• > é»˜è®¤å…¨å±€
 */
function getActiveBillTargetId() {
    // 1. ä¼˜å…ˆï¼šå½“å‰é€‰ä¸­çš„è§’è‰² (å†…å­˜)
    if (window.currentVaultCharID) return window.currentVaultCharID;
    if (window.currentManagementChar) return window.currentManagementChar;
    
    // 2. å…œåº•ï¼šå» LocalStorage æ‰¾ä¸Šæ¬¡æ“ä½œç•™ä¸‹çš„è®°å½• (ç¡¬ç›˜)
    const lastId = localStorage.getItem('LUNE_LAST_SELECTED_CHAR_ID');
    if (lastId) {
        // é¡ºä¾¿æ¢å¤åˆ°å†…å­˜å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        window.currentVaultCharID = lastId;
        return lastId;
    }
    
    // 3. å®åœ¨æ²¡æœ‰ï¼Œè¿”å›å…¨å±€é»˜è®¤
    return "GLOBAL_USER";
}
// è¾…åŠ©ï¼šæ ¹æ®åå­—ç”Ÿæˆä¸€ä¸ªå›ºå®šçš„å‡å·ç  (ä¸ºäº†è§†è§‰ç»Ÿä¸€)
function generateFakeNumber(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    const prefix = ["138", "139", "186", "135", "150"][Math.abs(hash) % 5];
    const mid = String(Math.abs(hash)).slice(0,4).padEnd(4,'0');
    const end = String(Math.abs(hash)).slice(-4).padEnd(4,'0');
    return `${prefix} ${mid} ${end}`;
}

/**
 * ğŸ–¼ï¸ è¾…åŠ©ï¼šæ˜¾ç¤ºå‘é€æ¸…å•å¼¹çª—
 */
function showSentLogModal(messages, avatar) {
    const modal = document.getElementById('modal-reminder-sent');
    const list = document.getElementById('sent-log-list');
    if (!modal || !list) return;

    list.innerHTML = messages.map(msg => {
        let contentHtml = "";
        
        // å¦‚æœæ˜¯å¡ç‰‡
        if (msg.metadata && msg.metadata.type === 'card_request_topup') {
            contentHtml = `
                <div class="sent-card-preview">
                    <div>SIM CARD ALERT</div>
                    <div style="font-size:14px; font-weight:bold;">ï¿¥${msg.metadata.amount}</div>
                </div>
            `;
        } else {
            // æ™®é€šæ–‡æœ¬
            contentHtml = `<div class="sent-bubble">${msg.text}</div>`;
        }

        return `
            <div class="sent-item">
                <img src="${avatar}" class="sent-avatar">
                <div style="flex:1;">
                    <div style="font-size:9px; color:#888; margin-bottom:2px;">ASSISTANT (AI)</div>
                    ${contentHtml}
                </div>
            </div>
        `;
    }).join('');

    modal.style.display = 'flex';
}

// ==========================================
// ğŸï¸ é™æ—¶åŠ¨æ€ï¼šè§’è‰²åŒæ­¥æ¸²æŸ“å¼•æ“ (ä¸¥æ ¼ä¸€è‡´ç‰ˆ)
// ==========================================
async function initMomentsStories() {
    const track = document.getElementById('moments-story-track');
    if (!track) return;

    // 1. è·å–æ•°æ®
    const [friends, charList, myDbData, myActiveStories] = await Promise.all([
        loadFromDB('chat_friends') || [],
        loadFromDB('char_list') || [],
        window.ib.getItem('lune_user_data'),
        window.ib.getItem('my_active_story')
    ]);
    
    // 2. ç‰©ç†è¿‡æ»¤å¥½å‹
    const validFriends = friends.filter(f => charList.some(c => c.id === f.id));

    // 3. å‡†å¤‡æˆ‘çš„æ•°æ®
    let myData = myDbData || window.userData || {};
    let myName = myData.name || 'Me';
    let myAvatarUrl = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23cccccc'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' fill='%23666' text-anchor='middle' dy='.3em'%3EMe%3C/text%3E%3C/svg%3E";

    if (myData.avatarValue) {
        if (myData.avatarValue.includes('url(')) {
            myAvatarUrl = myData.avatarValue.replace(/url\(['"]?(.*?)['"]?\)/, '$1');
        } else if (myData.avatarValue.startsWith('data:image') || myData.avatarValue.startsWith('http')) {
            myAvatarUrl = myData.avatarValue;
        }
    }

    // 4. é‡ç½®è½¨é“ï¼Œä¿ç•™ My Echo (å‘å¸ƒæŒ‰é’®)
    const myStory = track.querySelector('.story-capsule.me');
    track.innerHTML = "";
    if (myStory) track.appendChild(myStory);

    // ============================================================
    // ğŸ”¥ã€ä¿®æ­£ã€‘æˆ‘çš„åŠ¨æ€å¡ç‰‡ï¼šå®Œå…¨ä½¿ç”¨å¥½å‹çš„ Class å’Œç»“æ„
    // ============================================================
    if (Array.isArray(myActiveStories) && myActiveStories.length > 0) {
        const myActiveCapsule = document.createElement('div');
        myActiveCapsule.className = 'story-capsule';
        myActiveCapsule.onclick = () => window.openFullStory(); 

        const myBgColor = '#E3F2FD'; 

        // è¿™é‡Œçš„ç»“æ„ç°åœ¨å’Œä¸‹é¢å¥½å‹çš„å®Œå…¨ä¸€æ ·ï¼Œæ²¡æœ‰ä»»ä½•é¢å¤–çš„ style
        myActiveCapsule.innerHTML = `
            <div class="story-preview-bg" style="background-color: ${myBgColor};">
                <img src="${myAvatarUrl}" class="story-char-avatar">
            </div>
            <div class="story-info">
                <span>${myName}</span>
            </div>
            <div class="story-ring-status"></div>
        `;
        track.appendChild(myActiveCapsule);
    }
    // ============================================================

    if (validFriends.length === 0) return;

    // 5. æ¸²æŸ“å¥½å‹åŠ¨æ€ (ä¿æŒåŸæ ·)
    validFriends.forEach((f, index) => {
        const capsule = document.createElement('div');
        capsule.className = 'story-capsule';
        capsule.onclick = () => console.log("æŸ¥çœ‹åŠ¨æ€:", f.name);

        const colors = ['#E3F2FD', '#F3E5F5', '#FFF3E0', '#E8F5E9', '#FCE4EC'];
        const bgColor = colors[index % colors.length];

        capsule.innerHTML = `
            <div class="story-preview-bg" style="background-color: ${bgColor};">
                <img src="${f.avatar}" class="story-char-avatar">
            </div>
            <div class="story-info">
                <span>${f.name}</span>
            </div>
            <div class="story-ring-status"></div> `;
        track.appendChild(capsule);
    });
}
/**
 * ğŸ¨ åŠ¨æ€å¡ç‰‡ç”Ÿæˆå¼•æ“ - ç°ä»£ä¸»ä¹‰æµä½“ç‰ˆ
 * @param {Object} data - åŠ¨æ€æ•°æ®å¯¹è±¡
 * @param {string} data.type - 'single' æˆ– 'multi'
 * @param {string} data.avatar - å¤´åƒURL
 * @param {string} data.name - è§’è‰²æ˜µç§°
 * @param {string} data.date - æ ¼å¼: 2026å¹´02æœˆ08æ—¥
 * @param {string} data.time - æ ¼å¼: 09:42 PM
 * @param {string} data.location - åœ°ç†ä½ç½®æ–‡æœ¬
 * @param {string} data.content - æ­£æ–‡å†…å®¹
 * @param {Array} data.images - å›¾ç‰‡æ•°ç»„ (å•å›¾ä¼ ä¸€ä¸ªï¼Œå¤šå›¾ä¼ å¤šä¸ª)
 * @param {string} data.music - æ°›å›´éŸ³ä¹åç§°
 * @param {number} data.likes - ç‚¹èµæ•°
 */
function createMomentCard(data) {
    // 1. å¤„ç†å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ (å•å›¾ vs å¤šå›¾)
    let mediaHtml = "";
    if (data.type === 'multi' && data.images.length >= 3) {
        mediaHtml = `
            <div class="m-grid-multi">
                <img src="${data.images[0]}" class="m-grid-main">
                <img src="${data.images[1]}" class="m-grid-sub">
                <div style="position: relative; width: 100%; height: 100%;">
                    <img src="${data.images[2]}" class="m-grid-sub" style="width:100%; height:100%;">
                    ${data.images.length > 3 ? `<div style="position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 24px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; font-weight: 900; backdrop-filter:blur(4px);">+${data.images.length - 3}</div>` : ''}
                </div>
            </div>`;
    } else {
        mediaHtml = `
            <div class="m-img-wrapper">
                <img src="${data.images[0]}" class="m-img-single">
            </div>`;
    }

    // 2. è¿”å›å®Œæ•´ HTML
    return `
    <div class="modern-card">
        <div class="m-card-header">
            <div class="m-user-box">
                <div class="m-avatar-wrapper">
                    <img src="${data.avatar}" class="m-avatar">
                </div>
                <div>
                    <div style="font-weight: 900; font-size: 16px; color: #1c1c1e;">${data.name}</div>
                    <div class="m-time-stamp">${data.date} Â· ${data.time}</div>
                    <div class="m-location-tag">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 2px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        ${data.location}
                    </div>
                </div>
            </div>
            <div style="background: #F2F2F7; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </div>
        </div>
        
        ${mediaHtml}

        <div class="m-ambient-box">
            <div class="m-music-info">
                <div class="m-visualizer">
                    <div class="m-v-bar" style="animation: music-bars 0.6s infinite alternate;"></div>
                    <div class="m-v-bar" style="animation: music-bars 0.4s infinite alternate-reverse;"></div>
                    <div class="m-v-bar" style="animation: music-bars 0.8s infinite alternate;"></div>
                </div>
                <span>${data.music}</span>
            </div>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
        </div>

        <div style="font-size: 15px; color: #2c2c2e; line-height: 1.7; margin-bottom: 20px; font-weight: 500; padding: 0 4px;">
            ${data.content}
        </div>

        <div class="m-action-bar">
            <div style="display:flex; gap:26px;">
                <div class="m-interaction-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <span>${data.likes}</span>
                </div>
                <div class="m-interaction-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                </div>
                <div class="m-interaction-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
            </div>
            <div class="m-interaction-item">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
            </div>
        </div>
    </div>`;
}

// ==========================================
// ğŸï¸ ç­–å±•å®éªŒå®¤ï¼šå®Œæ•´å‘å¸ƒåŠŸèƒ½å¼•æ“ (å«20å¼ å›¾ç®¡ç†é€»è¾‘)
// ==========================================
function openStudioPublisher() {
    // 1. é˜²æ­¢é‡å¤æ‰“å¼€å¹¶åˆå§‹åŒ–æ•°æ®
    if (document.getElementById('moments-publish-studio')) return;
    window.studioSelectedImages = []; // å…¨å±€æŒ‚è½½ï¼Œæ–¹ä¾¿å¤„ç†å‡½æ•°è®¿é—®
    const MAX_COUNT = 20;

    // 2. æ³¨å…¥é«˜å®š CSS (å« Leica Pro å˜é‡å’ŒçŠ¶æ€æ ä¿æŠ¤)
    const styleId = 'studio-pro-styles';
    if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.innerHTML = `
            :root {
                --studio-bg: #F9F9FB; 
                --studio-accent: #000000; 
                --studio-card-bg: #FFFFFF;
                --studio-label-color: #A2A2B0;
                --studio-glass: rgba(255, 255, 255, 0.8);
                --status-bar-height: 44px; 
            }
            #moments-publish-studio {
                position: fixed; inset: 0; background: var(--studio-bg); z-index: 10000;
                display: flex; flex-direction: column; font-family: -apple-system, sans-serif;
                animation: studioEntrance 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            }
            @keyframes studioEntrance { from { opacity: 0; transform: translateY(50px); filter: blur(10px); } to { opacity: 1; transform: translateY(0); filter: blur(0); } }
            .studio-header {
                background: var(--studio-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                padding-top: var(--status-bar-height); border-bottom: 0.5px solid rgba(0,0,0,0.05);
                position: sticky; top: 0; z-index: 10;
            }
            .studio-nav-content { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
            .studio-close-btn { cursor: pointer; padding: 10px; display: flex; align-items: center; justify-content: center; }
            .studio-publish-btn {
                background: var(--studio-accent); color: #fff; padding: 10px 24px;
                border-radius: 30px; font-size: 13px; font-weight: 800; letter-spacing: 1px; cursor: pointer;
            }
            .studio-scroll-body { flex: 1; overflow-y: auto; padding: 30px 20px 100px 20px; scrollbar-width: none; }
            .studio-scroll-body::-webkit-scrollbar { display: none; }
            .studio-section { margin-bottom: 40px; }
            .studio-label {
                font-size: 10px; font-weight: 900; color: var(--studio-label-color);
                letter-spacing: 2px; margin-bottom: 15px; display: block; text-transform: uppercase;
            }
            .studio-input-card { background: var(--studio-card-bg); border-radius: 30px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
            .studio-textarea { width: 100%; border: none; outline: none; font-size: 20px; line-height: 1.6; color: #1c1c1e; resize: none; min-height: 120px; background: transparent; }
            .studio-gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
            .studio-photo-item {
                aspect-ratio: 3/4; border-radius: 20px; background: #fff; position: relative;
                overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.04); border: 0.5px solid rgba(0,0,0,0.05);
            }
            .studio-photo-item img { width: 100%; height: 100%; object-fit: cover; }
            .studio-photo-num {
                position: absolute; top: 10px; left: 10px; font-size: 9px; font-weight: 900;
                background: #000; color: #fff; padding: 2px 6px; border-radius: 6px; z-index: 2;
            }
            .studio-photo-remove {
                position: absolute; top: 8px; right: 8px; width: 22px; height: 22px; z-index: 2;
                background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); border-radius: 50%;
                color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer;
            }
            .studio-add-card {
                aspect-ratio: 3/4; border-radius: 20px; border: 2px dashed #D1D1D6;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
                cursor: pointer; color: #8E8E93; transition: all 0.2s;
            }
            .studio-add-card:hover { border-color: #000; color: #000; background: #fff; }
            .studio-hub { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
            .hub-tile {
                background: var(--studio-glass); backdrop-filter: blur(15px); padding: 18px;
                border-radius: 28px; display: flex; align-items: center; gap: 12px;
                border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.02);
            }
            .hub-tile-icon {
                width: 40px; height: 40px; background: #fff; border-radius: 14px;
                display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            }
            .hub-tile-info h4 { margin: 0; font-size: 13px; font-weight: 800; color: #1c1c1e; }
            .hub-tile-info p { margin: 2px 0 0 0; font-size: 11px; color: var(--studio-label-color); }
        `;
        document.head.appendChild(style);
    }

    // 3. å®šä¹‰å†…éƒ¨é€»è¾‘å‡½æ•°ï¼ˆæŒ‚è½½åˆ°å…¨å±€ä»¥ä¾› onclick ä½¿ç”¨ï¼‰
    window.triggerStudioImage = function() {
        if (window.studioSelectedImages.length >= MAX_COUNT) return alert("å·²è¾¾20å¼ ä¸Šé™");
        let input = document.getElementById('studio-file-input');
        if (!input) {
            input = document.createElement('input');
            input.id = 'studio-file-input'; input.type = 'file'; input.multiple = true; input.accept = 'image/*';
            input.onchange = (e) => {
                const files = Array.from(e.target.files).slice(0, MAX_COUNT - window.studioSelectedImages.length);
                files.forEach(f => window.studioSelectedImages.push(URL.createObjectURL(f)));
                window.renderStudioGallery();
            };
        }
        input.click();
    };

    window.removeStudioImg = function(idx) {
        URL.revokeObjectURL(window.studioSelectedImages[idx]);
        window.studioSelectedImages.splice(idx, 1);
        window.renderStudioGallery();
    };

    window.renderStudioGallery = function() {
        const grid = document.getElementById('studio-grid');
        const count = document.getElementById('gallery-count');
        if (!grid) return;
        count.textContent = `02 / Visual Archive (${window.studioSelectedImages.length}/${MAX_COUNT})`;
        grid.innerHTML = window.studioSelectedImages.map((src, i) => `
            <div class="studio-photo-item">
                <div class="studio-photo-num">${String(i + 1).padStart(2, '0')}</div>
                <div class="studio-photo-remove" onclick="removeStudioImg(${i})">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </div>
                <img src="${src}">
            </div>
        `).join('');
        if (window.studioSelectedImages.length < MAX_COUNT) {
            grid.innerHTML += `
                <div class="studio-add-card" onclick="triggerStudioImage()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
                    <span style="font-size: 10px; font-weight: 900; margin-top: 8px;">ADD MEDIA</span>
                </div>`;
        }
    };

    window.closeStudio = function() {
        const el = document.getElementById('moments-publish-studio');
        if (el) {
            el.style.transition = "all 0.4s ease-in"; el.style.opacity = "0"; el.style.transform = "translateY(100%)";
            setTimeout(() => el.remove(), 400);
        }
    };

    // 4. æ¸²æŸ“æ ¸å¿ƒ HTML
    const studioHtml = `
    <div id="moments-publish-studio">
        <div class="studio-header">
            <div class="studio-nav-content">
                <div class="studio-close-btn" onclick="closeStudio()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </div>
                <div class="studio-publish-btn" onclick="handlePublish()">PUBLISH</div>
            </div>
        </div>

        <div class="studio-scroll-body">
            <div class="studio-section">
                <span class="studio-label">01 / Thoughts</span>
                <div class="studio-input-card">
                    <textarea id="studio-main-input" class="studio-textarea" placeholder="åœ¨æ­¤å¤„æ•æ‰è¿™ä¸€åˆ»çš„è®°å¿†ä¿¡å·..."></textarea>
                </div>
            </div>

            <div class="studio-section">
                <span class="studio-label" id="gallery-count">02 / Visual Archive (0/20)</span>
                <div class="studio-gallery-grid" id="studio-grid">
                    <div class="studio-add-card" onclick="triggerStudioImage()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
                        <span style="font-size: 10px; font-weight: 900; margin-top: 8px;">ADD MEDIA</span>
                    </div>
                </div>
            </div>

            <div class="studio-section">
                <span class="studio-label">03 / Metadata</span>
                <div class="studio-hub">
                    <div class="hub-tile">
                        <div class="hub-tile-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
                        <div class="hub-tile-info"><h4>Location</h4><p>Not pinned</p></div>
                    </div>
                    <div class="hub-tile">
                        <div class="hub-tile-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
                        <div class="hub-tile-info"><h4>Ambient</h4><p>Silent</p></div>
                    </div>
                    <div class="hub-tile">
                        <div class="hub-tile-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
                        <div class="hub-tile-info"><h4>Privacy</h4><p>Public</p></div>
                    </div>
                    <div class="hub-tile">
                        <div class="hub-tile-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
                        <div class="hub-tile-info"><h4>Schedule</h4><p>Now</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', studioHtml);
    setTimeout(() => { document.getElementById('studio-main-input').focus(); }, 600);
}

// ==========================================
// ğŸ› ï¸ è¾…åŠ©å…³é—­é€»è¾‘
// ==========================================
function closeStudio() {
    const el = document.getElementById('moments-publish-studio');
    if (el) {
        el.style.transition = "all 0.4s ease-in";
        el.style.opacity = "0";
        el.style.transform = "translateY(100%)";
        setTimeout(() => el.remove(), 400);
    }
}

// ==========================================
// ğŸŸ¢ 2. æ¸²æŸ“ä¸»å‡½æ•° (å·²æ”¹ä¸º async æ¨¡å¼)
// ==========================================
async function renderMePanel() {
    var panel = document.getElementById('chat-panel-me');
    if (!panel) return;

    // é»˜è®¤æ•°æ®
    const defaultData = {
        bgType: 'css', 
        bgValue: 'radial-gradient(circle at 10% 20%, rgb(239, 246, 249) 0%, rgb(206, 239, 253) 90%)', 
        avatarType: 'css',
        avatarValue: 'linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)',
        name: 'Design User',
        bio: 'Creating moments, collecting memories.',
        location: 'Tokyo, Shibuya'
    };

    // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä»æ•°æ®åº“è¯»å–å¤§æ–‡ä»¶æ•°æ®
    try {
        const dbData = await window.ib.getItem('lune_user_data');
        window.userData = dbData || defaultData;
    } catch (e) {
        console.log("è¯»å–æ•°æ®åº“å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼");
        window.userData = defaultData;
    }

    // æ¸…ç†æ—§å¼¹çª— (é˜²æ­¢é‡å¤)
    const oldModal = document.getElementById('lune-modal-global');
    if(oldModal) oldModal.remove();

    // æ¸²æŸ“ UI (ä¿æŒ V6 çš„ç©¿é€å’Œå…¨å®½æ ·å¼)
    panel.innerHTML = `
        <div class="me-hero-bg editable" style="background: ${window.userData.bgValue}" onclick="lune_openModal('background')"></div>
        <div class="me-container">
            <div class="profile-header">
                <div class="avatar-big editable" style="background: ${window.userData.avatarValue}" onclick="lune_openModal('avatar')">
                     <div class="online-badge"><div class="dot"></div><span class="badge-txt">ONLINE</span></div>
                </div>
                <div class="my-name editable" onclick="lune_openModal('name')">${window.userData.name}</div>
                <div class="my-bio editable" onclick="lune_openModal('bio')">${window.userData.bio}</div>
                <div class="location-pill editable" onclick="lune_openModal('location')">
                    <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    ${window.userData.location}
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-box"><span class="stat-num">0</span><span class="stat-name">Friends</span></div>
                <div class="stat-box"><span class="stat-num">0</span><span class="stat-name">Likes</span></div>
                <div class="stat-box"><span class="stat-num">0</span><span class="stat-name">Posts</span></div>
            </div>

            <div class="bento-grid">
                <div class="bento-card">
                    <div class="b-icon-box bg-blue-light"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></div>
                    <div><div class="b-title">Favorites</div><div class="b-sub">34 saved items</div></div>
                </div>
                <div class="bento-card">
                    <div class="b-icon-box bg-pink-light"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2.69l5.74 5.74-5.74 5.74M5.11 8.43l5.74 5.74M5.11 8.43v11.48M12 14.17v5.74M18.89 8.43v11.48"></path></svg></div>
                    <div><div class="b-title">Theme</div><div class="b-sub">Light Mode</div></div>
                </div>
                <div class="bento-card span-full bg-dark">
                    <div class="b-icon-box" style="background:rgba(255,255,255,0.2);"><svg viewBox="0 0 24 24" fill="none" stroke="#fff"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></div>
                    <div><div class="b-title">Activity</div><div class="b-sub">Recent hearts</div></div>
                    <div style="margin-left:auto;"><svg style="width:20px;color:#666;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                </div>
                <div class="bento-card span-full">
                    <div class="b-icon-box" style="background:#F0F0F2; color:#333;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div>
                    <div><div class="b-title">Settings</div><div class="b-sub">System & Privacy</div></div>
                    <div style="margin-left:auto;"><svg style="width:20px;color:#ccc;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                </div>
            </div>
        </div>
    `;

    // æ’å…¥å…¨å±€å¼¹çª—
    const modalHTML = `
        <div id="lune-modal-global">
            <div class="modal-box">
                <div class="modal-header">Edit</div>
                <div id="lune-modal-content"></div>
                <div class="modal-btns">
                    <button class="btn btn-cancel" onclick="lune_closeModal()">Cancel</button>
                    <button class="btn btn-save" onclick="lune_saveData()">Save</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // æ³¨å…¥ V6 æ ·å¼ (é˜²æ­¢æ ·å¼ä¸¢å¤±)
    if (!document.getElementById('lune-me-v6-style')) {
        var style = document.createElement('style');
        style.id = 'lune-me-v6-style';
        style.innerHTML = `
            @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap');
            #chat-panel-me { font-family: 'Urbanist', sans-serif; background: #FAFAFC; color: #1a1a1a; width: 100%; height: 100%; position: relative; overflow-x: hidden; }
            .me-hero-bg { position: absolute; top: 0; left: 0; width: 100%; height: 200px; z-index: 0; background-size: cover !important; background-position: center !important; cursor: pointer; }
            .me-hero-bg::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(250,250,252,1) 98%); pointer-events: none; }
            .me-container { position: relative; z-index: 1; padding: 100px 10px 120px 10px; width: 100%; box-sizing: border-box; pointer-events: none; }
            .profile-header, .stats-bar, .bento-grid { pointer-events: auto; }
            .profile-header { text-align: center; margin-bottom: 25px; }
            .avatar-big { width: 110px; height: 110px; border-radius: 40px; margin: 0 auto 15px auto; background-size: cover !important; background-position: center !important; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border: 4px solid #fff; position: relative; cursor: pointer; }
            .online-badge { position: absolute; bottom: -2px; right: -2px; background: #fff; padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
            .dot { width: 8px; height: 8px; background: #00D26A; border-radius: 50%; }
            .badge-txt { font-size: 10px; font-weight: 800; color: #00D26A; }
            .my-name { font-size: 32px; font-weight: 800; color: #111; letter-spacing: -0.8px; margin-bottom: 5px; cursor: pointer; pointer-events: auto; }
            .my-bio { font-size: 15px; color: #666; font-weight: 500; max-width: 95%; margin: 0 auto; line-height: 1.4; cursor: pointer; pointer-events: auto; }
            .location-pill { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); padding: 6px 16px; border-radius: 100px; margin-top: 15px; border: 1px solid rgba(0,0,0,0.05); font-size: 13px; font-weight: 700; color: #333; cursor: pointer; pointer-events: auto; }
            .stats-bar { display: flex; justify-content: space-between; background: #fff; padding: 22px 25px; border-radius: 28px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.06); margin-bottom: 12px; }
            .stat-box { text-align: center; flex: 1; }
            .stat-num { font-size: 24px; font-weight: 800; color: #111; letter-spacing: -0.5px; }
            .stat-name { font-size: 11px; font-weight: 700; color: #999; text-transform: uppercase; margin-top:4px; }
            .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
            .bento-card { background: #fff; border-radius: 28px; padding: 22px; position: relative; overflow: hidden; box-shadow: 0 4px 20px -4px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; min-height: 160px; cursor: pointer; }
            .bento-card:active { transform: scale(0.98); }
            .span-full { grid-column: 1 / -1; min-height: 95px; flex-direction: row; align-items: center; }
            .b-icon-box { width: 50px; height: 50px; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 24px; }
            .span-full .b-icon-box { margin-bottom: 0; margin-right: 18px; width: 52px; height: 52px; }
            .b-title { font-size: 18px; font-weight: 800; color: #111; letter-spacing: -0.4px; }
            .b-sub { font-size: 13px; color: #999; font-weight: 600; margin-top: 4px; }
            .bg-blue-light { background: #EAF6FF; color: #007AFF; }
            .bg-pink-light { background: #FFF0F5; color: #FF2D55; }
            .bg-dark { background: #111; color: #fff; }
            .bg-dark .b-title { color: #fff; }
            .bg-dark .b-sub { color: #888; }
            #lune-modal-global { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 2147483647 !important; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: flex-end; }
            #lune-modal-global.active { opacity: 1; pointer-events: all; }
            .modal-box { background: #fff; width: 100%; border-top-left-radius: 36px; border-top-right-radius: 36px; padding: 35px 24px 60px 24px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); box-shadow: 0 -20px 80px rgba(0,0,0,0.2); }
            #lune-modal-global.active .modal-box { transform: translateY(0); }
            .modal-header { font-size: 22px; font-weight: 800; margin-bottom: 30px; color: #111; text-align:center; }
            .modal-btns { display: flex; gap: 15px; margin-top: 35px; }
            .btn { flex: 1; padding: 18px; border-radius: 20px; font-weight: 700; border: none; cursor: pointer; font-size: 16px; }
            .btn-save { background: #111; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
            .btn-cancel { background: #F2F2F7; color: #555; }
            .reset-btn { width: 100%; padding: 16px; background: #fff; border: 1px solid #E5E5EA; border-radius: 20px; font-size: 14px; font-weight: 700; cursor: pointer; color: #FF3B30; }
            svg { width: 24px; height: 24px; stroke-width: 2.5; }
        `;
        document.head.appendChild(style);
    }
}

// ç«‹å³è¿è¡Œ
renderMePanel();

/**
 * ğŸ¨ åŠ¨æ€å¡ç‰‡ç”Ÿæˆå¼•æ“ - (ä¿®å¤ç‰ˆï¼šæ”¯æŒçº¯æ–‡å­—ï¼Œä¸è£‚å›¾)
 */
function createMomentCard(data) {
    // 1. å¤„ç†å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ (ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…ˆåˆ¤æ–­æœ‰æ²¡æœ‰å›¾)
    let mediaHtml = "";
    
    // åªæœ‰å½“å›¾ç‰‡æ•°ç»„å­˜åœ¨ï¼Œä¸”é•¿åº¦å¤§äº0æ—¶ï¼Œæ‰ç”Ÿæˆå›¾ç‰‡åŒºåŸŸ
    if (data.images && data.images.length > 0) {
        if (data.type === 'multi' && data.images.length >= 3) {
            // --- å¤šå›¾æ ·å¼ (3å¼ ä»¥ä¸Š) ---
            mediaHtml = `
                <div class="m-grid-multi">
                    <img src="${data.images[0]}" class="m-grid-main">
                    <img src="${data.images[1]}" class="m-grid-sub">
                    <div style="position: relative; width: 100%; height: 100%;">
                        <img src="${data.images[2]}" class="m-grid-sub" style="width:100%; height:100%;">
                        ${data.images.length > 3 ? `<div style="position: absolute; inset: 0; background: rgba(0,0,0,0.5); border-radius: 24px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 18px; font-weight: 900; backdrop-filter:blur(4px);">+${data.images.length - 3}</div>` : ''}
                    </div>
                </div>`;
        } else {
            // --- å•å›¾/åŒå›¾æ ·å¼ ---
            // åªè¦æœ‰å›¾ï¼Œå°±æ˜¾ç¤ºç¬¬ä¸€å¼ 
            mediaHtml = `
                <div class="m-img-wrapper">
                    <img src="${data.images[0]}" class="m-img-single">
                </div>`;
        }
    }
    // ğŸ”¥ å¦‚æœæ²¡å›¾ï¼ŒmediaHtml å°±æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œé¡µé¢ä¸Šä¸ä¼šæœ‰è£‚å¼€çš„å›¾æ ‡

    // 2. è¿”å›å®Œæ•´ HTML
    return `
    <div class="modern-card">
        <div class="m-card-header">
            <div class="m-user-box">
                <div class="m-avatar-wrapper">
                    <img src="${data.avatar}" class="m-avatar">
                </div>
                <div>
                    <div style="font-weight: 900; font-size: 16px; color: #1c1c1e;">${data.name}</div>
                    <div class="m-time-stamp">${data.date} Â· ${data.time}</div>
                    <div class="m-location-tag">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 2px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        ${data.location}
                    </div>
                </div>
            </div>
            <div style="background: #F2F2F7; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </div>
        </div>
        
        ${mediaHtml} <div class="m-ambient-box">
            <div class="m-music-info">
                <div class="m-visualizer">
                    <div class="m-v-bar" style="animation: music-bars 0.6s infinite alternate;"></div>
                    <div class="m-v-bar" style="animation: music-bars 0.4s infinite alternate-reverse;"></div>
                    <div class="m-v-bar" style="animation: music-bars 0.8s infinite alternate;"></div>
                </div>
                <span>${data.music}</span>
            </div>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
        </div>

        <div style="font-size: 15px; color: #2c2c2e; line-height: 1.7; margin-bottom: 20px; font-weight: 500; padding: 0 4px;">
            ${data.content}
        </div>

        <div class="m-action-bar">
            <div style="display:flex; gap:26px;">
                <div class="m-interaction-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    <span>${data.likes}</span>
                </div>
                <div class="m-interaction-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                </div>
                <div class="m-interaction-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
            </div>
            <div class="m-interaction-item">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
            </div>
        </div>
    </div>`;
}

/**
 * ğŸï¸ åŠ¨æ€åŠ è½½å¼•æ“ï¼šä»æ•°æ®åº“æ¢å¤å†å²å¸–å­
 * (éœ€è¦åœ¨é¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨)
 */
async function initMomentsFeed() {
    const container = document.getElementById('moments-feed-container');
    if (!container) return;

    // 1. ä»æ•°æ®åº“è¯»å–æ‰€æœ‰åŠ¨æ€
    const feedList = (await window.ib.getItem('moments_feed_data')) || [];

    // 2. å¦‚æœæ²¡æœ‰åŠ¨æ€ï¼Œä¿æŒé»˜è®¤çš„â€œç©ºçŠ¶æ€â€å ä½ç¬¦ï¼Œä¸åšæ“ä½œ
    if (feedList.length === 0) return;

    // 3. å¦‚æœæœ‰åŠ¨æ€ï¼Œå…ˆæ¸…ç©ºå®¹å™¨ï¼ˆä¸»è¦æ˜¯æ¸…ç©ºé‚£ä¸ªâ€œæš‚æ— ç”Ÿæ´»ç¢ç‰‡â€çš„æç¤ºï¼‰
    container.innerHTML = "";

    // 4. å¾ªç¯æ¸²æŸ“
    let allHtml = "";
    feedList.forEach(data => {
        // å®¹é”™ï¼šé˜²æ­¢æ—§æ•°æ®æ²¡æœ‰ images å­—æ®µå¯¼è‡´æŠ¥é”™
        if (!data.images) data.images = [];
        allHtml += createMomentCard(data);
    });

    container.innerHTML = allHtml;
    console.log(`âœ… å·²æ¢å¤ ${feedList.length} æ¡å†å²åŠ¨æ€`);
}


// ==========================================
// âœ¨ Lune Success Modal: è§†è§‰é¢„è§ˆ
// ==========================================

// 1. æ ·å¼æ³¨å…¥
const styleId = 'lune-success-style';
if (!document.getElementById(styleId)) {
    const style = document.createElement('style');
    style.id = styleId;
    style.innerHTML = `
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap');

        #lune-success-modal {
            position: fixed; inset: 0; z-index: 2147483647;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€èƒŒæ™¯ */
        }

        .ls-success-card {
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 30px 50px;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            transform: scale(0.8); opacity: 0;
            animation: lsPopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* åŠ¨ç”»åœ†åœˆ */
        .ls-check-circle {
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #00D26A 0%, #00F076 100%);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0, 210, 106, 0.3);
            position: relative;
        }

        /* SVG å¯¹å‹¾åŠ¨ç”» */
        .ls-checkmark {
            width: 32px; height: 32px;
            stroke: #fff; stroke-width: 4; stroke-linecap: round; stroke-linejoin: round;
            fill: none;
            stroke-dasharray: 50; stroke-dashoffset: 50;
            animation: lsDrawCheck 0.4s 0.2s ease-out forwards;
        }

        .ls-success-title {
            color: #fff; font-family: 'Urbanist', sans-serif;
            font-size: 18px; font-weight: 800; letter-spacing: 0.5px;
        }

        .ls-success-sub {
            color: rgba(255,255,255,0.5); font-family: 'Urbanist', sans-serif;
            font-size: 13px; font-weight: 600;
        }

        @keyframes lsPopIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes lsDrawCheck {
            to { stroke-dashoffset: 0; }
        }
        @keyframes lsFadeOut {
            to { opacity: 0; transform: scale(0.9); }
        }
    `;
    document.head.appendChild(style);
}

// 2. æ ¸å¿ƒå‡½æ•°
function showPublishSuccess() {
    // ç§»é™¤æ—§çš„
    const old = document.getElementById('lune-success-modal');
    if (old) old.remove();

    const html = `
        <div id="lune-success-modal">
            <div class="ls-success-card">
                <div class="ls-check-circle">
                    <svg class="ls-checkmark" viewBox="0 0 24 24">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div style="text-align:center;">
                    <div class="ls-success-title">Published</div>
                    <div class="ls-success-sub">Your moment is live</div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);

    // 3. è‡ªåŠ¨é”€æ¯
    setTimeout(() => {
        const modal = document.getElementById('lune-success-modal');
        if (modal) {
            const card = modal.querySelector('.ls-success-card');
            card.style.animation = 'lsFadeOut 0.3s forwards';
            setTimeout(() => modal.remove(), 300);
        }
    }, 2000); // 2ç§’åæ¶ˆå¤±
}

// 4. ç«‹å³æ‰§è¡Œé¢„è§ˆ
showPublishSuccess();

// æ›´æ–°æ•´ä¸ª Story å¯¹è±¡
async function updateStoryData(updatedStory) {
    let stories = await window.ib.getItem('my_active_story');
    if (!stories) return;
    const idx = stories.findIndex(s => s.id === updatedStory.id);
    if (idx !== -1) {
        stories[idx] = updatedStory;
        await window.ib.setItem('my_active_story', stories);
    }
}
// ==========================================
// ğŸ§  é€šç”¨ AI è°ƒç”¨æ ¸å¿ƒ (å¤ç”¨ç°æœ‰çš„é…ç½®)
// ==========================================
async function callSocialAI(systemPrompt, userPrompt) {
    const apiKey = localStorage.getItem('gpt_key');
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    if (!apiKey) {
        console.warn("âš ï¸ [SocialAI] æ—  API Keyï¼Œæ— æ³•ç”Ÿæˆè¯„è®º");
        return null;
    }

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [
                    {role: "system", content: systemPrompt},
                    {role: "user", content: userPrompt}
                ],
                temperature: 0.9 // é«˜åˆ›é€ æ€§
            })
        });
        const data = await res.json();
        return data.choices[0].message.content.trim();
    } catch (e) {
        console.error("âŒ [SocialAI] API è¯·æ±‚å¤±è´¥:", e);
        return null;
    }
}

// ==========================================
// ğŸ› ï¸ è¾…åŠ©ï¼šå†™å…¥å•æ¡è¯„è®º (åŠ å›ºç‰ˆ)
// ==========================================
async function addCommentToStory(storyId, commentObj) {
    try {
        // 1. è¯»å–æœ€æ–°æ•°æ® (é˜²æ­¢è¦†ç›–)
        let stories = await window.ib.getItem('my_active_story');
        if (!stories) {
            console.error("âŒ [Write] æ‰¾ä¸åˆ°åŠ¨æ€æ•°æ®åº“");
            return;
        }
        
        // 2. æ‰¾åˆ°å¯¹åº”çš„é‚£æ¡åŠ¨æ€
        const targetIndex = stories.findIndex(s => s.id === storyId);
        if (targetIndex !== -1) {
            // åˆå§‹åŒ–æ•°ç»„
            if (!stories[targetIndex].comments) stories[targetIndex].comments = [];
            
            // æ’å…¥è¯„è®º
            stories[targetIndex].comments.push(commentObj);
            
            // 3. æµè§ˆé‡é€»è¾‘ï¼šå¥½å‹è¯„è®ºäº† = å¥½å‹å·²è¯»
            // å¦‚æœæµè§ˆé‡è¿˜æ²¡åŠ ä¸Šè¿™ä¸ªå¥½å‹ï¼Œå°± +1
            // (è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šç›´æ¥ä¿å­˜ï¼Œè®©åˆ·æ–°å‡½æ•°å»å¤„ç†å…·ä½“çš„æ•°å­—)
            
            // 4. å†™å›æ•°æ®åº“
            await window.ib.setItem('my_active_story', stories);
            
            // 5. å®æ—¶æ¨é€åˆ°å±å¹• (å¦‚æœè¯¦æƒ…é¡µæ­£å¼€ç€)
            if (window.pushMockDm && document.getElementById('lune-story-overlay')) {
                window.pushMockDm(commentObj);
            }
        } else {
            console.error("âŒ [Write] æ‰¾ä¸åˆ° ID ä¸º " + storyId + " çš„åŠ¨æ€");
        }
    } catch (e) {
        console.error("âŒ [Write] å†™å…¥è¯„è®ºå¤±è´¥:", e);
    }
}

// 3. æ—¶é—´æ ¼å¼åŒ–
function getTimeStr(ts) {
    const diff = Math.floor((Date.now() - ts) / 1000 / 60);
    if(diff > 1440) return Math.floor(diff/1440) + 'd ago';
    if(diff > 60) return Math.floor(diff/60) + 'h ago';
    if(diff > 0) return diff + 'm ago';
    return 'Just now';
}

// ==========================================
// ğŸ› ï¸ æ ¼å¼åŒ–å·¥å…· (æ§åˆ¶ K/M æ˜¾ç¤º)
// ==========================================
function formatStat(num) {
    // å¼ºåˆ¶è½¬ä¸ºæ•°å­—ï¼Œé˜²æ­¢ undefined æˆ– string è¿›æ¥æŠ¥é”™
    const n = Number(num);
    if (isNaN(n)) return "0";

    // ä½¿ç”¨æ ‡å‡†åº“ï¼Œä¿ç•™ 1 ä½å°æ•° (1.2k, 1.5m)
    return Intl.NumberFormat('en-US', {
        notation: "compact",
        maximumFractionDigits: 1
    }).format(n).toLowerCase();
}
// 2. æ¸²æŸ“å¾ªç¯æ»šåŠ¨å¼¹å¹•
function renderMarqueeComments(comments) {
    const track = document.getElementById('lf-dm-track');
    if (!track) return;
    
    track.innerHTML = ''; // æ¸…ç©º
    track.style.animation = 'none'; // é‡ç½®åŠ¨ç”»
    
    if (comments.length === 0) return;

    // æ„é€  HTMLï¼šå°†è¯„è®ºåˆ—è¡¨å¤åˆ¶ä¸€ä»½ç”¨äºæ— ç¼å¾ªç¯ [A,B,C] -> [A,B,C,A,B,C]
    // ä¸ºäº†ä¿è¯æ»šåŠ¨é¡ºæ»‘ï¼Œå¦‚æœæ˜¯å°‘é‡è¯„è®ºï¼Œå¤šå¤åˆ¶å‡ éå¡«æ»¡é«˜åº¦
    let displayList = [...comments];
    while(displayList.length < 5) displayList = displayList.concat(comments); // è‡³å°‘è¡¥è¶³åˆ°5æ¡
    
    // ç”Ÿæˆä¸¤å¥— HTML (åŸå§‹ + å‰¯æœ¬)
    const generateHTML = (list) => list.map(c => 
        `<div class="lf-dm-bubble"><span class="lf-dm-name">${c.name}</span>${c.text}</div>`
    ).join('');

    track.innerHTML = generateHTML(displayList) + generateHTML(displayList); // æ‹¼ä¸¤ä»½

    // è®¡ç®—åŠ¨ç”»æ—¶é•¿ï¼šè¶Šé•¿è¶Šæ…¢ã€‚è®¾æ¯æ¡è¯„è®ºèµ°è¿‡éœ€è¦ 2 ç§’
    const duration = displayList.length * 3; 
    
    // å¼ºåˆ¶é‡ç»˜åå¯åŠ¨åŠ¨ç”»
    track.offsetHeight; 
    track.style.animation = `scrollUp ${Math.max(duration, 10)}s linear infinite`;
}

/**
 * ğŸ”¥ æ¸²æŸ“å‡½æ•°ï¼šåŒæ­¥ç¼©ç•¥å›¾åˆ°æ¯ä¸€è¡Œ
 */
function renderLikersList(totalCount, type, mediaUrl, realLikers) {
    let listHtml = '';
    let displayList = [...realLikers];
    
    // è¡¥å……æ¨¡æ‹Ÿæ•°æ®
    const fillCount = Math.min(totalCount - displayList.length, 30);
    for (let i = 0; i < fillCount; i++) {
        displayList.push({ user: "guest_" + (100+i), action: 'liked this', time: i+1 + "m" });
    }

    // å›¾ç‰‡åŠ è½½å¤±è´¥çš„å…œåº•å›¾ (ç°è‰²å ä½)
    const fallbackImg = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";

    displayList.forEach(item => {
        const avatar = item.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${item.user}`;
        
        // ç¼©ç•¥å›¾ HTMLï¼šå¢åŠ  onerror é˜²æ­¢å›¾æŒ‚
        const thumbHtml = `
            <div class="ess-item-thumb-box ${type === 'story' ? 'is-story' : ''}">
                <img src="${mediaUrl}" class="ess-item-thumb-img" 
                     onerror="this.src='${fallbackImg}'; this.parentElement.style.background='#eee';">
            </div>
        `;

        listHtml += `
            <div class="ess-item">
                <img src="${avatar}" class="ess-avatar">
                <div class="ess-info">
                    <span class="ess-user">${item.user}</span>
                    <span class="ess-action">${item.action || 'liked your ' + type}</span>
                    <span class="ess-time">${item.time} ago</span>
                </div>
                <div class="ess-right">${thumbHtml}</div>
            </div>
        `;
    });
    return listHtml;
}

// --- æ¶²æ€ç»ç’ƒç»„ä»¶äº¤äº’åŠŸèƒ½ ---

// ç¼–è¾‘å†…å®¹çš„é€šç”¨å‡½æ•°
function fnEdit(el, type) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¤–å±‚ç‚¹å‡»
    event.stopPropagation();
    
    // åˆ¤æ–­æ˜¯æ”¹å›¾ç‰‡è¿˜æ˜¯æ”¹æ–‡å­—
    var isImage = type.includes('å›¾ç‰‡') || type.includes('å¤´åƒ');
    var currentVal = isImage ? el.src : el.innerText;
    
    // å¼¹å‡ºè¾“å…¥æ¡†
    var input = prompt("âœ¨ ç¼–è¾‘" + type + ":", currentVal);
    
    // å¦‚æœç”¨æˆ·è¾“å…¥äº†å†…å®¹ä¸”ä¸ä¸ºç©º
    if (input && input.trim() !== "") {
        if(isImage) {
            el.src = input;
        } else {
            el.innerText = input;
        }
    }
}

/* --- ğŸ–‹ï¸ Lost & Found App æ ¸å¿ƒé€»è¾‘ --- */

// 1. æ‰“å¼€ App (ä½ éœ€è¦æŠŠè¿™ä¸ªå‡½æ•°ç»‘å®šåˆ°æ¡Œé¢å›¾æ ‡çš„ onclick ä¸Š)
function openLostFoundApp() {
    var app = document.getElementById('app-lost-found-v2');
    app.style.display = 'flex';
    // é»˜è®¤è¿›å…¥åˆ›ä½œé¡µ
    var studioTab = document.querySelectorAll('.lf-v2-tab-item')[1]; // ç¬¬2ä¸ªtab
    switchLfTab('studio', studioTab);
}

// 2. å…³é—­ App
function closeLostFoundApp() {
    var app = document.getElementById('app-lost-found-v2');
    app.style.display = 'none';
}

// 3. åˆ‡æ¢ Tab é€»è¾‘
function switchLfTab(pageName, el) {
    // A. åˆ‡æ¢ Tab æ ·å¼
    var tabs = document.querySelectorAll('.lf-v2-tab-item');
    tabs.forEach(function(t) { t.classList.remove('active'); });
    el.classList.add('active');
    
    // B. åˆ‡æ¢é¡µé¢å†…å®¹
    var pages = document.querySelectorAll('.lf-v2-page');
    pages.forEach(function(p) { p.classList.remove('active'); });
    
    var targetPage = document.getElementById('lf-page-' + pageName);
    if (targetPage) targetPage.classList.add('active');
}

/**
 * ğŸ  å·¥ä½œå®¤æ•°æ®åˆå§‹åŒ–åŠ è½½å™¨
 */
async function initStudioData() {
    console.log("æ­£åœ¨ä»æ•°æ®åº“åŠ è½½ä½œå“åˆ—è¡¨...");
    
    try {
        // 1. ä»ä½ çš„ ib è¯»å–ä½œå“åˆ—è¡¨
        const savedWorks = await window.ib.getItem('lf_global_works_v1');
        
        if (savedWorks && Array.isArray(savedWorks)) {
            // å¦‚æœæ•°æ®åº“æœ‰ï¼Œå°±ç”¨æ•°æ®åº“çš„
            window.lfGlobalWorks = savedWorks;
            console.log(`âœ…å·²åŠ è½½ ${savedWorks.length} éƒ¨ä½œå“`);
        } else {
            // å¦‚æœæ•°æ®åº“æ˜¯ç©ºçš„ï¼Œå†åŠ è½½ä½ é‚£äº›é»˜è®¤çš„æ¨¡æ‹Ÿæ•°æ® (å¯é€‰)
            console.log("â„¹ï¸ æ•°æ®åº“ä¸ºç©ºï¼ŒåŠ è½½é»˜è®¤æ¼”ç¤ºæ•°æ®");
            // window.lfGlobalWorks = [... ä½ çš„æ¨¡æ‹Ÿæ•°æ® ...]; 
        }
        
        // 2. æ— è®ºå¦‚ä½•ï¼Œæ‰§è¡Œä¸€æ¬¡æ¸²æŸ“
        window.renderStudioList();
        
    } catch (e) {
        console.error("åŠ è½½å¤±è´¥:", e);
    }
}

// 1. æ‰“å¼€å‘å¯¼ (åœ¨â€œæ–°å»ºæŒ‰é’®â€onclické‡Œè°ƒç”¨è¿™ä¸ª)
function openWizard() {
    var page = document.getElementById('lf-wizard-page');
    if (page) {
        page.style.display = 'flex';
        // å¼ºåˆ¶é‡ç»˜ååŠ activeï¼Œå®ç°æ¸æ˜¾
        setTimeout(() => page.classList.add('active'), 10);
        // é‡ç½®åˆ°ç¬¬ä¸€æ­¥
        lfWizardCurrentStep = 0;
        updateWizardView();
    }
}

// 2. å…³é—­å‘å¯¼
function closeWizard() {
    var page = document.getElementById('lf-wizard-page');
    if (page) {
        page.classList.remove('active');
        setTimeout(() => page.style.display = 'none', 300);
    }
}

// 3. ä¸‹ä¸€æ­¥ (ä¿®å¤ç‰ˆï¼šè§£å†³ç¬¬ä¸ƒæ­¥æ»‘è¿‡å¤´çš„é—®é¢˜)
function wizardNextStep() {
    // é€»è¾‘ï¼šåªæœ‰å½“ä¸æ˜¯æœ€åä¸€æ­¥æ—¶ï¼Œæ‰å…è®¸å¢åŠ ç´¢å¼•
    if (lfWizardCurrentStep < lfWizardTotalSteps - 1) {
        lfWizardCurrentStep++;
        updateWizardView();
        
        // é’ˆå¯¹ç‰¹å®šæ­¥éª¤çš„åˆå§‹åŒ–
        if (lfWizardCurrentStep === 4) { // Step 05 å…³ç³»ç½‘
            // å¦‚æœå·²ç»æœ‰æ•°æ®äº†ï¼Œæ»‘è¿‡å»æ—¶è‡ªåŠ¨é‡ç»˜ä¸€éï¼Œé˜²æ­¢çº¿æ¡å› å°ºå¯¸é—®é¢˜æ¶ˆå¤±
            if(window.lfProjectData.step5_relations.length > 0) {
                setTimeout(generateRelationWeb, 100); 
            }
        }
        
        if (lfWizardCurrentStep === 6) { // Step 07 è§„æ ¼è®¾å®š
            setTimeout(initStep7, 50);
        }
    }

    // å¤„ç† UI çŠ¶æ€ï¼šå¦‚æœæ˜¯æœ€åä¸€æ­¥
    if (lfWizardCurrentStep === lfWizardTotalSteps - 1) {
        const finalBtn = document.getElementById('lfw-final-btn');
        if(finalBtn) finalBtn.classList.add('ready');
        
        const bottomBar = document.querySelector('.lfw-bottom-bar');
        if(bottomBar) bottomBar.style.transform = 'translateY(100%)'; // æ»‘å‡ºéšè—
    }

    // æ¯ä¸€è·³éƒ½å­˜ä¸€ä¸‹è¿›åº¦åˆ°ä½ çš„ ib (IndexedDB)
    if (typeof saveWizardDraft === 'function') saveWizardDraft();
}

// 4. ä¸Šä¸€æ­¥ (è¿”å›é”®é€»è¾‘)
function wizardPrevStep() {
    if (lfWizardCurrentStep > 0) {
        lfWizardCurrentStep--;
        updateWizardView();
        // æ¢å¤åº•éƒ¨æ 
        document.querySelector('.lfw-bottom-bar').style.transform = 'translateY(0)';
    } else {
        // ç¬¬ä¸€æ­¥ç‚¹è¿”å› = å…³é—­
        closeWizard();
    }
}

// 5. é€‰ä¸­å¡ç‰‡ç‰¹æ•ˆ
function wizardSelectCard(idOrEl) {
    var el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
    if (el) {
        // åˆ‡æ¢é€‰ä¸­æ ·å¼
        if (el.classList.contains('selected')) {
            el.classList.remove('selected');
        } else {
            el.classList.add('selected');
        }
    }
}

// 6. è§†å›¾æ›´æ–°æ ¸å¿ƒ (æ»‘åŠ¨)
function updateWizardView() {
    var track = document.getElementById('lfw-track');
    var progressBar = document.getElementById('lfw-progress');
    
    // ç§»åŠ¨è½¨é“
    if (track) {
        track.style.transform = `translateX(-${lfWizardCurrentStep * 100}vw)`;
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    if (progressBar) {
        var progress = ((lfWizardCurrentStep + 1) / lfWizardTotalSteps) * 100;
        progressBar.style.width = progress + '%';
    }
}

// --- ğŸ¬ Step 1 åˆå§‹åŒ– ---
function initStep1() {
    // 1. éšè—ç»“æœå¡ç‰‡ (åˆå§‹çŠ¶æ€)
    const card = document.getElementById('card-step1');
    if (card) card.style.display = 'none';

    // 2. ç»‘å®šæŒ‰é’®äº‹ä»¶
    // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ä½ çš„ HTML é‡ŒæŒ‰é’®çš„ onclick å·²ç»æŒ‡å‘äº† generateStoryCore()
    // å¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥åœ¨è¿™é‡Œç”¨ addEventListener ç»‘å®š
}

// é¡µé¢åŠ è½½åæ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–
initStep1();

// æ¸²æŸ“å½“å‰é€‰ä¸­çš„æ ‡é¢˜
function renderCurrentTitle() {
    const title = lfStep2Cache[lfStep2Index];
    const textEl = document.getElementById('step2-result-text');
    // åŠ ä¸ªæ·¡å…¥åŠ¨ç”»æ•ˆæœ
    textEl.style.opacity = 0;
    setTimeout(() => {
        textEl.innerHTML = `ã€Š${title.replace(/ã€Š|ã€‹/g, '')}ã€‹`; // è‡ªåŠ¨è¡¥ä¹¦åå·
        textEl.style.opacity = 1;
    }, 200);
}

/**
 * 1. åˆå§‹åŒ– Step 2
 */
function initStep2() {
    // éšè—ç»“æœå¡ï¼Œæ¸…ç©ºè¾“å…¥
    document.getElementById('card-step2').style.display = 'none';
    document.getElementById('step2-input-title').value = '';
    console.log("[System] Step 2 Initialized.");
}

/**
 * 1. é€šç”¨ AI è°ƒç”¨å‡½æ•° (å·²å¢å¼º JSON è§£æç¨³å®šæ€§)
 */
async function callAIForStyle(sysPrompt, usrPrompt) {
    const apiKey = localStorage.getItem('gpt_key');
    // å¤„ç† API URLï¼Œé˜²æ­¢åŒé‡æ–œæ 
    let apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    let model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
    if (apiUrl.includes("deepseek")) model = "deepseek-chat";

    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [{role: "system", content: sysPrompt}, {role: "user", content: usrPrompt}],
                temperature: 0.85
            })
        });
        
        const data = await response.json();
        if (!data.choices || !data.choices[0]) throw new Error("API è¿”å›æ ¼å¼å¼‚å¸¸");

        let content = data.choices[0].message.content;

        // --- ğŸ›¡ï¸ å¢å¼ºï¼šJSON æå–é€»è¾‘ (é˜²æ­¢ AI åœ¨ JSON å¤–é¢åºŸè¯) ---
        const jsonMatch = content.match(/\[[\s\S]*\]/); 
        if (jsonMatch) {
            content = jsonMatch[0]; // åªå– [] é‡Œé¢çš„å†…å®¹
        }
        // ----------------------------------------------------
        
        lfStep3Cache = JSON.parse(content);
        lfStep3Index = 0;
        
        renderStyleCard(); // è°ƒç”¨æ¸²æŸ“

    } catch (e) {
        console.error("AI Error:", e);
        // å¦‚æœå‡ºé”™ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå¹¶æä¾›é‡è¯•æŒ‰é’®
        const card = document.getElementById('card-step3');
        if(card) {
            card.innerHTML = `<div style="color:red; padding:20px; text-align:center;">
                âŒ ç”Ÿæˆå¤±è´¥: ${e.message}<br>
                <button onclick="generateAutoStyle()" style="margin-top:10px;">é‡è¯•</button>
            </div>`;
        }
    }
}

/**
 * 2. æ¸²æŸ“ Style å¡ç‰‡ (ä¿®å¤ç‰ˆ)
 * å¢åŠ äº†â€œç¡®è®¤é€‰æ‹©â€æŒ‰é’®çš„é€»è¾‘
 */
function renderStyleCard() {
    const card = document.getElementById('card-step3');
    if (!lfStep3Cache || lfStep3Cache.length === 0) return;

    const data = lfStep3Cache[lfStep3Index];
    
    // åŠ¨æ€ç”Ÿæˆ HTML
    card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
            <div>
                <div class="lfw-style-name" style="font-weight:800; font-size:18px;">${data.name}</div>
                <div class="lfw-style-desc" style="font-size:12px; color:#666; margin-top:4px;">${data.desc}</div>
            </div>
            <span style="font-size:10px; background:#000; color:#fff; padding:2px 6px; border-radius:4px;">PREVIEW ${lfStep3Index + 1}/${lfStep3Cache.length}</span>
        </div>
        
        <div class="lfw-style-sample" style="background:#f9f9f9; padding:12px; border-radius:8px; font-family:'Songti SC',serif; font-size:14px; color:#444; font-style:italic; line-height:1.6; border-left:3px solid #000;">
            â€œ${data.sample}â€
        </div>

        <div class="lfw-btn-row" style="margin-top:16px;">
            <button class="lfw-btn lfw-btn-outline" onclick="swapStyle()">
                <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                Switch Candidate
            </button>
            
            <button class="lfw-btn lfw-btn-black" onclick="confirmStyle()">
                <svg class="lfw-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"></polyline></svg>
                Select This Style
            </button>
        </div>
    `;
    card.style.display = 'block';
}

/**
 * 3. UI Loading çŠ¶æ€ (ä¿æŒä¸å˜ï¼Œå› ä¸º renderStyleCard ä¼šä¿®å¤å®ƒé€ æˆçš„ç ´å)
 */
function showStyleLoading() {
    const card = document.getElementById('card-step3');
    if (card) {
        card.style.display = 'block';
        card.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">
            <div class="spinner"></div> <div> AI æ­£åœ¨åˆ†æä¸è¯•å†™...</div>
            <span style="font-size:10px; opacity:0.5;">ANALYZING_TONE_VECTORS</span>
        </div>`;
    }
}

// --- æ¸²æŸ“ä¸äº¤äº’é€»è¾‘ ---

function renderCPCardSkeleton(index) {
    const area = document.getElementById('step4-dynamic-area');
    const html = `
        <div style="font-size:10px; font-weight:700; color:#999; margin-bottom:8px; margin-top:20px;">SEQUENCE: CP PAIR #${index}</div>
        <div class="lfw-card lfw-cp-card" id="cp-card-${index}">
            <div style="text-align:center; width:100%; color:#999;">
                <div class="lfw-loading-scan"></div> Generating CP...
            </div>
        </div>
    `;
    area.insertAdjacentHTML('beforeend', html);
}

function renderSoloCardSkeleton(index) {
    const area = document.getElementById('step4-dynamic-area');
    area.insertAdjacentHTML('beforeend', `
        <div style="font-size:10px; font-weight:700; color:#999; margin-bottom:8px; margin-top:20px;">SEQUENCE: SOLO CHAR #${index}</div>
        <div class="lfw-card" id="solo-card-${index}">Generating...</div>
    `);
}

/**
 * 2. ä»»åŠ¡è°ƒåº¦å™¨ (å†³å®šä¸‹ä¸€æ­¥ç”Ÿæˆä»€ä¹ˆ)
 */
function processNextCharTask() {
    const area = document.getElementById('step4-dynamic-area');
    
    // æƒ…å†µ A: è¿˜æœ‰ CP æ²¡ç”Ÿæˆ
    if (lfCharState.currentCP < lfCharState.targetCP) {
        lfCharState.currentCP++;
        renderCPCardSkeleton(lfCharState.currentCP); // æ¸²æŸ“éª¨æ¶
        callAIForCP(lfCharState.currentCP);          // å‘¼å«AI
    }
    // æƒ…å†µ B: CPç”Ÿæˆå®Œäº†ï¼Œè¿˜æœ‰å•äººæ²¡ç”Ÿæˆ
    else if ((lfCharState.currentCP * 2 + lfCharState.currentSolo) < lfCharState.targetTotal) {
        lfCharState.currentSolo++;
        const soloIndex = lfCharState.currentCP * 2 + lfCharState.currentSolo;
        renderSoloCardSkeleton(soloIndex);
        callAIForSolo(soloIndex);
    }
    // æƒ…å†µ C: å…¨éƒ¨ç”Ÿæˆå®Œæ¯•
    else {
        area.innerHTML += `
            <div style="text-align:center; margin-top:30px;">
                <div style="font-size:40px;"></div>
                <div style="font-weight:700; margin-top:10px;">All Characters Ready</div>
                <div style="font-size:12px; color:#999; margin-bottom:20px;">å…±ç”Ÿæˆ ${lfCharState.generatedList.length} äººï¼Œå·²å…¨éƒ¨å…¥åº“ã€‚</div>
                <button class="lfw-btn lfw-btn-black" onclick="wizardNextStep()">Go to Relation Web</button>
            </div>
        `;
        // åŒæ­¥æ•°æ®åˆ°å…¨å±€
        window.lfProjectData.step4_chars = lfCharState.generatedList;
        console.log("[Step 4] Final List:", window.lfProjectData.step4_chars);
    }
}


// --- æ¸²æŸ“ä¸äº¤äº’é€»è¾‘ ---

function renderCPCardSkeleton(index) {
    const area = document.getElementById('step4-dynamic-area');
    const html = `
        <div style="font-size:10px; font-weight:700; color:#999; margin-bottom:8px; margin-top:20px;">SEQUENCE: CP PAIR #${index}</div>
        <div class="lfw-card lfw-cp-card" id="cp-card-${index}">
            <div style="text-align:center; width:100%; color:#999;">
                <div class="lfw-loading-scan"></div> Generating CP...
            </div>
        </div>
    `;
    area.insertAdjacentHTML('beforeend', html);
}

/**
 * ğŸ¨ æ¸²æŸ“ CP å¡ç‰‡ (å¸¦ç¼–è¾‘ã€ç¡®è®¤åŠŸèƒ½)
 */
function fillCPCard(index, data) {
    const card = document.getElementById(`cp-card-${index}`);
    if (!card) return;

    // ID ç”Ÿæˆ (ç”¨äºå¤´åƒä¸Šä¼ å’Œæ•°æ®æå–)
    const idA_img = `img-${index}-charA`;
    const idB_img = `img-${index}-charB`;
    
    // é»˜è®¤å¤´åƒ
    const avatarA = data.charA.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${data.charA.name}`;
    const avatarB = data.charB.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${data.charB.name}`;

    card.innerHTML = `
        <div class="lfw-cp-container">
            <div class="lfw-cp-header">
                <span style="font-size:12px; font-weight:700; color:#ccc;">CP PAIR #${index}</span>
                <span style="font-size:20px;"></span>
            </div>

            <div class="lfw-cp-row">
                <div class="lfw-char-col">
                    <div class="lfw-avatar-box" onclick="triggerCharAvatarUpload(${index}, 'charA')">
                        <img id="${idA_img}" src="${avatarA}" class="lfw-avatar-img">
                        <div class="lfw-edit-badge">pho</div>
                    </div>
                    <input type="text" id="input-${index}-nameA" class="lfw-bare-input" value="${data.charA.name}">
                    <input type="text" id="input-${index}-roleA" class="lfw-bare-role" value="${data.charA.role}">
                    <textarea id="input-${index}-bioA" class="lfw-bio-area">${data.charA.bio}</textarea>
                </div>

                <div class="lfw-char-col">
                    <div class="lfw-avatar-box" onclick="triggerCharAvatarUpload(${index}, 'charB')">
                        <img id="${idB_img}" src="${avatarB}" class="lfw-avatar-img">
                        <div class="lfw-edit-badge">pho</div>
                    </div>
                    <input type="text" id="input-${index}-nameB" class="lfw-bare-input" value="${data.charB.name}">
                    <input type="text" id="input-${index}-roleB" class="lfw-bare-role" value="${data.charB.role}">
                    <textarea id="input-${index}-bioB" class="lfw-bio-area">${data.charB.bio}</textarea>
                </div>
            </div>

            <input type="text" id="input-${index}-rel" class="lfw-relation-input" value="${data.relation}">

            <div class="lfw-action-bar">
                <button class="lfw-btn lfw-btn-outline" onclick="callAIForCP(${index})">
                    æ¢ä¸€æ¢ (Regen)
                </button>
                <button class="lfw-btn lfw-btn-black" onclick="confirmCPTask(${index})">
                    ç¡®è®¤å¹¶ç»§ç»­ (Confirm) 
                </button>
            </div>
        </div>
    `;
}

/**
 * ğŸ¨ æ¸²æŸ“ Solo å¡ç‰‡ (å¸¦ç¼–è¾‘ã€ç¡®è®¤åŠŸèƒ½)
 */
function fillSoloCard(index, data) {
    const card = document.getElementById(`solo-card-${index}`);
    if (!card) return;

    const idSolo = `img-${index}-solo`;
    const avatar = data.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${data.name}`;

    card.innerHTML = `
        <div class="lfw-cp-container">
            <div class="lfw-cp-header">
                <span style="font-size:12px; font-weight:700; color:#ccc;">SOLO VIP #${index}</span>
            </div>

            <div style="display:flex; gap:16px;">
                <div style="width:80px; flex-shrink:0; text-align:center;">
                    <div class="lfw-avatar-box" onclick="triggerCharAvatarUpload(${index}, 'solo')">
                        <img id="${idSolo}" src="${avatar}" class="lfw-avatar-img">
                        <div class="lfw-edit-badge">pho</div>
                    </div>
                </div>
                <div style="flex:1;">
                    <input type="text" id="input-${index}-name" class="lfw-bare-input" style="text-align:left; font-size:18px;" value="${data.name}">
                    <input type="text" id="input-${index}-role" class="lfw-bare-role" style="text-align:left;" value="${data.role}">
                </div>
            </div>

            <textarea id="input-${index}-bio" class="lfw-bio-area" style="margin-top:16px;">${data.bio}</textarea>

            <div class="lfw-action-bar">
                <button class="lfw-btn lfw-btn-outline" onclick="callAIForSolo(${index})">
                    æ¢ä¸€æ¢
                </button>
                <button class="lfw-btn lfw-btn-black" onclick="confirmSoloTask(${index})">
                    ç¡®è®¤å¹¶ç»§ç»­
                </button>
            </div>
        </div>
    `;
}

function renderSoloCardSkeleton(index) {
    const area = document.getElementById('step4-dynamic-area');
    area.insertAdjacentHTML('beforeend', `
        <div style="font-size:10px; font-weight:700; color:#999; margin-bottom:8px; margin-top:20px;">SEQUENCE: SOLO CHAR #${index}</div>
        <div class="lfw-card" id="solo-card-${index}">Generating...</div>
    `);
}

function lockCardUI(cardEl) {
    cardEl.style.opacity = '0.6';
    cardEl.style.pointerEvents = 'none'; // ç¦æ­¢å†æ¬¡ä¿®æ”¹
    cardEl.querySelector('.lfw-btn-black').innerText = "Saved";
    cardEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/**
 * 1. åˆå§‹åŒ– Step 6
 * æ¯æ¬¡æ»‘åˆ°è¿™ä¸€é¡µæ—¶è°ƒç”¨ (å¯ä»¥åœ¨ wizardNextStep é‡Œè§¦å‘ï¼Œæˆ–è€…æ‰‹åŠ¨è°ƒç”¨ initStep6())
 */
function initStep6() {
    console.log("[Step 6] Initializing...");
    
    // æ£€æŸ¥å‰ç½®æ•°æ®
    if (!window.lfProjectData.step4_chars || !window.lfProjectData.step5_relations) {
        // å¦‚æœå‰é¢æ²¡åšå®Œï¼Œå…ˆæ˜¾ç¤ºç©ºçŠ¶æ€ï¼Œé˜²æ­¢æŠ¥é”™
        return; 
    }

    // é»˜è®¤å…ˆæŠŠ Step 4/5 çš„æ•°æ®æ‹¿è¿‡æ¥å±•ç¤ºä¸€é (ä½œä¸º Base)
    // è¿™æ ·ç”¨æˆ·è¿˜æ²¡ç‚¹ç”Ÿæˆæ—¶ï¼Œä¹Ÿèƒ½çœ‹åˆ°åŸºç¡€å…³ç³»ç½‘
    const baseChars = window.lfProjectData.step4_chars;
    const baseLinks = window.lfProjectData.step5_relations;
    
    renderOptVisuals(baseChars, baseLinks, []); // ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºç©ºï¼Œè¡¨ç¤ºæ²¡æœ‰é¢å¤–èŠ‚ç‚¹
}

/**
 * 4. æ¸²æŸ“åŒå¿ƒåœ†å›¾è°± (Main Inside, Extra Outside)
 */
function renderOptVisuals(mainChars, allLinks, extraNodes) {
    const container = document.getElementById('lfw-opt-canvas');
    if(!container) return;
    container.innerHTML = '';
    const centerX = container.offsetWidth / 2, centerY = container.offsetHeight / 2;
    const nodeMap = {};

    // 1. æ¸²æŸ“ä¸»è§’ (å†…ç¯)
    mainChars.forEach((char, i) => {
        const angle = (i / mainChars.length) * 2 * Math.PI;
        const x = centerX + 60 * Math.cos(angle);
        const y = centerY + 60 * Math.sin(angle);
        nodeMap[char.name.replace(/\s+/g, "")] = {x, y};
        // ... (ç»˜åˆ¶ node ä»£ç åŒä¸Šï¼Œç•¥)
    });

    // 2. æ¸²æŸ“æ‰©å±•é…è§’ (å¤–ç¯)
    extraNodes.forEach((char, i) => {
        const angle = (i / extraNodes.length) * 2 * Math.PI + 0.5;
        const x = centerX + 110 * Math.cos(angle);
        const y = centerY + 110 * Math.sin(angle);
        nodeMap[char.name.replace(/\s+/g, "")] = {x, y};
        // ... (ç»˜åˆ¶ node ä»£ç ç•¥ï¼Œå‚è€ƒä¹‹å‰ renderOptVisuals)
    });

    // 3. è¿çº¿ (æ ¸å¿ƒï¼šè°ƒç”¨ drawLineV2)
    allLinks.forEach(link => {
        const start = nodeMap[link.source.replace(/\s+/g, "")];
        const end = nodeMap[link.target.replace(/\s+/g, "")];
        if (start && end) {
            // åˆ¤å®šæ˜¯å¦æ˜¯è™šçº¿ï¼šå¦‚æœ source æˆ– target å±äº extraNodes é‡Œçš„åå­—ï¼Œå°±æ˜¯è™šçº¿
            const isExtra = extraNodes.some(e => e.name === link.source || e.name === link.target);
            drawLineV2(container, start.x, start.y, end.x, end.y, link.desc, isExtra);
        }
    });
}

// ç”»çº¿è¾…åŠ© V2 (æ”¯æŒå®çº¿/è™šçº¿ï¼Œä¿®æ­£ç‰ˆ)
function drawLineV2(container, x1, y1, x2, y2, text, isDashed) {
    const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
    const cx = (x1 + x2) / 2;
    const cy = (y1 + y2) / 2;
    const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);

    // 1. åˆ›å»ºçº¿æ®µ
    const line = document.createElement('div');
    line.className = 'lfw-graph-line';
    
    // å¦‚æœæ˜¯è™šçº¿ï¼ˆisDashed ä¸º trueï¼‰
    if (isDashed) {
        line.style.borderTop = "1px dashed #bbb"; // è™šçº¿
        line.style.background = "transparent";
        line.style.height = "0";
    } else {
        line.style.background = "#ccc"; // å®çº¿
        line.style.height = "1px";
    }

    line.style.width = `${length}px`;
    line.style.left = `${cx - length / 2}px`;
    line.style.top = `${cy}px`;
    line.style.transform = `rotate(${angle}deg)`;
    line.style.position = "absolute";
    line.style.zIndex = "1";
    container.appendChild(line);

    // 2. åˆ›å»ºæ–‡å­—æ ‡ç­¾
    if (text) {
        const label = document.createElement('div');
        label.className = 'lfw-graph-label';
        label.innerText = text;
        label.style.left = `${cx}px`;
        label.style.top = `${cy}px`;
        if (isDashed) label.style.color = "#999";
        container.appendChild(label);
    }
}

/**
 * 5. æ¸²æŸ“æ–°å¢å…³ç³»çš„æ–‡å­—åˆ—è¡¨
 */
function renderOptCards(links) {
    const list = document.getElementById('lfw-opt-list');
    let html = '';
    
    links.forEach(link => {
        html += `
            <div class="lfw-card" style="padding:12px; margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; border-left:3px solid #ccc;">
                <div style="font-size:13px; font-weight:700;">${link.source}</div>
                <div style="font-size:10px; color:#666; background:#eee; padding:2px 8px; border-radius:10px;">
                    ${link.desc} â”
                </div>
                <div style="font-size:13px; font-weight:700;">${link.target}</div>
            </div>
        `;
    });
    
    list.innerHTML = `<div style="font-size:10px; font-weight:700; color:#999; margin-bottom:8px;">NEW CONNECTIONS</div>` + html;
}


/**
 * 1. åˆå§‹åŒ– Step 7
 * (æ¯æ¬¡è¿›å…¥è¯¥é¡µé¢æ—¶ï¼Œæˆ–é¡µé¢åŠ è½½æ—¶è°ƒç”¨)
 */
function initStep7() {
    // é»˜è®¤å€¼
    const defaultChapters = 50;
    const defaultWords = 3000;

    // å¦‚æœä¹‹å‰å­˜è¿‡ï¼Œç”¨ä¹‹å‰çš„ï¼›å¦åˆ™ç”¨é»˜è®¤
    const saved = window.lfProjectData.step7_specs;
    
    const elChapters = document.getElementById('input-chapters');
    const elWords = document.getElementById('input-words');

    if (elChapters && elWords) {
        elChapters.value = saved ? saved.chapters : defaultChapters;
        elWords.value = saved ? saved.wordsPerChapter : defaultWords;
        
        // ç«‹å³è§¦å‘ä¸€æ¬¡æ›´æ–°ï¼Œæ˜¾ç¤ºæ–‡å­—
        updateSpecData();
    }
}

// --- ğŸ¬ ä¹¦ç±æ§åˆ¶å°é€»è¾‘ (Dashboard) ---

// å½“å‰æ“ä½œçš„ä¹¦ç±åœ¨å…¨å±€æ•°ç»„ä¸­çš„ç´¢å¼•
var currentBookIndex = -1;

/**
 * 1. æ‰“å¼€æ§åˆ¶å°
 * index: å¿…é¡»ä¼ å…¥ window.lfGlobalWorks é‡Œçš„ç´¢å¼•
 */
function openDashboard(index) {
    // å®¹é”™å¤„ç†
    if (typeof index === 'undefined' || !window.lfGlobalWorks[index]) {
        console.error("æœªæ‰¾åˆ°ä¹¦ç±æ•°æ®ï¼Œç´¢å¼•:", index);
        return;
    }
    
    currentBookIndex = index;
    const book = window.lfGlobalWorks[index];
    
    // 1. å¡«å……æ ‡é¢˜
    document.getElementById('lfe-book-title').innerText = book.title;

    // 2. å¡«å……ç®€ä»‹ (æ”¯æŒé•¿ç®€ä»‹å’ŒçŸ­ç®€ä»‹)
    // fullSynopsis æ˜¯æˆ‘ä»¬åœ¨ Wizard ç»“æŸæ—¶å­˜çš„å®Œæ•´ç®€ä»‹
    const desc = book.fullSynopsis || book.synopsis || "æš‚æ— ç®€ä»‹";
    document.getElementById('lfe-synopsis-text').innerText = desc;

    // 3. å¡«å……å°é¢ (æ”¯æŒ base64 å›¾ç‰‡ æˆ– çº¯è‰²)
    const coverBox = document.getElementById('lfe-cover-box');
    const placeholder = document.getElementById('lfe-cover-placeholder');
    
    if (book.coverImage) {
        // å¦‚æœæœ‰å›¾ç‰‡
        coverBox.style.backgroundImage = `url(${book.coverImage})`;
        coverBox.style.backgroundColor = 'transparent';
        placeholder.style.display = 'none';
    } else {
        // å¦‚æœæ²¡å›¾ç‰‡ï¼Œç”¨é»˜è®¤è‰²
        coverBox.style.backgroundImage = 'none';
        coverBox.style.backgroundColor = '#f0f0f2'; 
        placeholder.style.display = 'flex';
    }

    // 4. å¡«å……è§’è‰² (é‡è¦ï¼šä» Wizard åŒæ­¥è¿‡æ¥çš„æ•°æ®)
    // book.chars åœ¨ Wizard å®Œæˆæ—¶åº”è¯¥è¢«å†™å…¥
    renderDashboardChars(book.chars || []);

    // 5. å¡«å……æ ‡ç­¾ (æ”¯æŒ AI ç”Ÿæˆå ä½)
    renderDashboardTags(book.tags || []);

    // ğŸš€ æ–°å¢ï¼šæ¸²æŸ“è¯¥ä¹¦çš„ç« èŠ‚åˆ—è¡¨
    renderChapterList(book.chapters || []);

    // 6. æ›´æ–°å‘å¸ƒæŒ‰é’®çŠ¶æ€
    updatePublishBtnState(book.status === 'published');

    // æ˜¾ç¤ºé¡µé¢ (æ·»åŠ  active ç±»)
    document.getElementById('lf-editor-dashboard').classList.add('active');
}

/**
 * 2. å…³é—­æ§åˆ¶å°
 */
function closeDashboard() {
    document.getElementById('lf-editor-dashboard').classList.remove('active');
    // å…³é—­æ—¶ï¼Œåˆ·æ–°å¤–éƒ¨åˆ—è¡¨ï¼Œç¡®ä¿åˆšæ‰ä¿®æ”¹çš„æ ‡é¢˜/ç®€ä»‹åŒæ­¥å‡ºå»
    if (window.renderStudioList) {
        window.renderStudioList();
    }
}

// --- æ¸²æŸ“è¾…åŠ©å‡½æ•° ---

function renderDashboardChars(chars) {
    const container = document.getElementById('lfe-char-rail');
    if (!chars || chars.length === 0) {
        container.innerHTML = '<div style="font-size:12px; color:#ccc; padding:0 5px;">No characters yet.</div>';
        return;
    }
    // æ¸²æŸ“è§’è‰²å¡ç‰‡ (åŒæ­¥ Step 4 æ•°æ®)
    container.innerHTML = chars.map(c => `
        <div class="lfe-char-card">
            <div class="lfe-char-img-box">
                <img src="${c.avatar}" class="lfe-char-img">
                ${(c.type && c.type.includes('MAIN')) ? '<span class="lfe-char-badge">â˜…</span>' : ''}
            </div>
            <div class="lfe-char-name">${c.name}</div>
            <div class="lfe-char-role">${c.role}</div>
        </div>
    `).join('');
}

function renderDashboardTags(tags) {
    const container = document.getElementById('lfe-tags-container');
    let html = tags.map(t => `<span class="lfe-tag">${t}</span>`).join('');
    // æ·»åŠ  AI æ ‡ç­¾æŒ‰é’®
    html += `<span class="lfe-tag lfe-tag-add" onclick="generateTagsAI()">+ AI Tag</span>`;
    container.innerHTML = html;
}

function updatePublishBtnState(isPublished) {
    const btn = document.getElementById('lfe-publish-toggle');
    const text = document.getElementById('lfe-pub-text');
    
    if (isPublished) {
        btn.classList.remove('draft');
        btn.classList.add('published');
        text.innerText = "On Shelf";
    } else {
        btn.classList.remove('published');
        btn.classList.add('draft');
        text.innerText = "Publish";
    }
}

// --- ğŸ’¾ Wizard è‰ç¨¿ç®±ç³»ç»Ÿ (Draft System) ---

/**
 * ğŸ’¾ ä½¿ç”¨ä½ è‡ªå·±çš„ ib å·¥å…·ä¿å­˜è¿›åº¦
 */
async function saveWizardDraft() {
    const DRAFT_KEY = 'lf_wizard_draft_v1';
    
    // 1. æ„å»ºè¦å­˜çš„æ•°æ®åŒ…
    const draftData = {
        timestamp: Date.now(),
        currentStep: typeof getCurrentActiveStep === 'function' ? getCurrentActiveStep() : 1,
        data: window.lfProjectData || {}, 
        step3Cache: window.lfStep3Cache || [], 
        charState: window.lfCharState || {}
    };

    try {
        // ğŸš€ å…³é”®ï¼šç›´æ¥è°ƒç”¨ä½ çš„ ib.setItem
        await window.ib.setItem(DRAFT_KEY, draftData);
        console.log("âœ… [IB Save] è¿›åº¦å·²å­˜å…¥ IndexedDB");
    } catch (e) {
        console.error("âŒ [IB Save] å¤±è´¥:", e);
    }
}

/**
 * 2. æ£€æŸ¥å¹¶æ¢å¤è¿›åº¦ (Restore)
 * å»ºè®®è°ƒç”¨æ—¶æœºï¼šé¡µé¢åŠ è½½ (`window.onload`) æˆ–è€… æ‰“å¼€ Wizard å¼¹çª—æ—¶
 */
function checkAndRestoreDraft() {
    const raw = localStorage.getItem(DRAFT_KEY);
    if (!raw) return; // æ²¡æœ‰è‰ç¨¿ï¼Œç›´æ¥é€€å‡º

    try {
        const draft = JSON.parse(raw);
        // æ£€æŸ¥æ—¶æ•ˆæ€§ (æ¯”å¦‚è¶…è¿‡ 24 å°æ—¶å°±ä¸æ¢å¤äº†ï¼Œçœ‹ä½ éœ€æ±‚ï¼Œè¿™é‡Œä¸åšé™åˆ¶)
        
        const dateStr = new Date(draft.timestamp).toLocaleString();
        
        // å¼¹çª—è¯¢é—®ç”¨æˆ·
        if (confirm(`æ£€æµ‹åˆ°ä¸Šä¸€æ¬¡æœªå®Œæˆçš„åˆ›å»º (${dateStr})ã€‚\næ˜¯å¦æ¢å¤è¿›åº¦ï¼Ÿ`)) {
            
            // A. æ¢å¤æ•°æ®
            window.lfProjectData = draft.data || {};
            window.lfStep3Cache = draft.step3Cache || [];
            window.lfCharState = draft.charState || {};

            // B. æ¢å¤ UI (è·³è½¬åˆ°å¯¹åº”æ­¥éª¤)
            // ä½ éœ€è¦å®ç°ä¸€ä¸ª jumpToStep(n) å‡½æ•°ï¼Œæˆ–è€…æ‰‹åŠ¨æ¨¡æ‹Ÿç‚¹å‡»
            if (window.jumpToStep) {
                window.jumpToStep(draft.currentStep || 1);
            } else {
                console.warn("æœªæ‰¾åˆ° jumpToStep å‡½æ•°ï¼Œä»…æ¢å¤æ•°æ®ã€‚");
            }

            // C. ç‰¹æ®Šæ¢å¤ï¼šå¦‚æœæ˜¯åœ¨ Step 4ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ¸²æŸ“å·²ç”Ÿæˆçš„å¡ç‰‡
            if (draft.currentStep === 4 && draft.charState && draft.charState.generatedList) {
                restoreStep4UI(draft.charState.generatedList);
            }
            
            alert("âœ… è¿›åº¦å·²æ¢å¤ï¼");
        } else {
            // ç”¨æˆ·é€‰æ‹©â€œå¦â€ï¼Œæ¸…é™¤è‰ç¨¿
            clearWizardDraft();
        }

    } catch (e) {
        console.error("æ¢å¤è‰ç¨¿å¤±è´¥:", e);
        clearWizardDraft();
    }
}

/**
 * ğŸ§¹ æ¸…é™¤è‰ç¨¿ (ä½¿ç”¨ ib)
 */
async function clearWizardDraft() {
    try {
        // ä½¿ç”¨ ib çš„ setItem æŠŠè‰ç¨¿ç½®ç©ºï¼Œæˆ–è€…å¦‚æœä½ å†™äº† removeItem å°±ç”¨é‚£ä¸ª
        // æ—¢ç„¶ä½ ä¹‹å‰çš„ ib åªæœ‰ set/getï¼Œæˆ‘ä»¬å°±å­˜ null
        await window.ib.setItem(DRAFT_KEY, null);
        console.log("ğŸ§¹ Draft Cleared from DB");
    } catch (e) {
        console.error("æ¸…é™¤å¤±è´¥:", e);
    }
}

// --- è¾…åŠ©å‡½æ•° ---

// --- è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰æ­¥éª¤ (ä¿®å¤ç‰ˆ) ---
function getCurrentActiveStep() {
    // ä½ çš„ä»£ç é‡Œå·²ç»ç»´æŠ¤äº† lfWizardCurrentStep (0, 1, 2...)
    // æ‰€ä»¥ç›´æ¥è¿”å›å®ƒ + 1 å°±æ˜¯å½“å‰æ­¥éª¤æ•°
    // å¦‚æœå˜é‡ä¸å­˜åœ¨ï¼Œé»˜è®¤è¿”å› 1
    if (typeof window.lfWizardCurrentStep !== 'undefined') {
        return window.lfWizardCurrentStep + 1;
    }
    return 1;
}

// ç®€å•çš„ Toast æç¤º
function showToast(msg) {
    const div = document.createElement('div');
    div.innerText = msg;
    div.style.cssText = "position:fixed; bottom:20px; right:20px; background:rgba(0,0,0,0.7); color:#fff; padding:8px 16px; border-radius:20px; z-index:99999; font-size:12px;";
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 2000);
}

// æ¢å¤ Step 4 çš„å¡ç‰‡ (é’ˆå¯¹ä½ ä¹‹å‰çš„é€»è¾‘å®šåˆ¶)
function restoreStep4UI(list) {
    const area = document.getElementById('step4-dynamic-area');
    if (!area) return;
    area.innerHTML = ''; // æ¸…ç©º
    
    // è¿™é‡Œåªæ˜¯ç®€å•çš„é€»è¾‘ï¼Œä½ éœ€è¦æ ¹æ®ä½ çš„ fillCPCard é‡æ–°æŠŠå¡ç‰‡ç”»å‡ºæ¥
    // æˆ–è€…ç›´æ¥æç¤ºç”¨æˆ·â€œæ•°æ®å·²æ¢å¤ï¼Œè¯·ç»§ç»­ç”Ÿæˆâ€
    // ç®€ç‰ˆï¼šåªæ˜¾ç¤ºå·²ç”Ÿæˆæ•°é‡
    const info = document.createElement('div');
    info.innerHTML = `<div style="padding:20px; text-align:center; color:green;">â™»ï¸ å·²æ¢å¤ ${list.length} ä¸ªè§’è‰²æ•°æ®</div>`;
    area.appendChild(info);
}

/**
 * 2. æ¸²æŸ“è§†è§‰å›¾è°± (ä¿®å¤ç‰ˆï¼šè§£å†³ offsetWidth è·å–ä¸åˆ°å¯¼è‡´çº¿æ¡æ¶ˆå¤±)
 */
function renderVisualGraph(chars, links) {
    const container = document.getElementById('lfw-relation-canvas');
    if (!container || container.offsetWidth === 0) {
        setTimeout(() => renderVisualGraph(chars, links), 150);
        return;
    }

    container.innerHTML = ''; 
    const w = container.offsetWidth, h = container.offsetHeight;
    const centerX = w / 2, centerY = h / 2;
    const radius = Math.min(w, h) * 0.3;
    const angleStep = (2 * Math.PI) / chars.length;
    const nodeMap = {};

    // A. å»ºç«‹èŠ‚ç‚¹
    chars.forEach((char, i) => {
        const angle = i * angleStep - (Math.PI / 2);
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        
        // æ ¸å¿ƒä¿®å¤ï¼šå­˜å‚¨æ—¶ç»Ÿä¸€å»æ‰æ‰€æœ‰ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
        const cleanName = char.name.replace(/\s+/g, "");
        nodeMap[cleanName] = { x, y };

        const node = document.createElement('div');
        node.className = 'lfw-graph-node';
        node.style.left = `${x}px`; node.style.top = `${y}px`;
        node.innerHTML = `<img src="${char.avatar}">`;
        container.appendChild(node);
        
        const label = document.createElement('div');
        label.className = 'lfw-graph-name';
        label.innerText = char.name;
        label.style.left = `${x}px`; label.style.top = `${y + 25}px`;
        container.appendChild(label);
    });

    // B. å»ºç«‹è¿çº¿ (å¸¦æ¨¡ç³ŠåŒ¹é…)
    links.forEach(link => {
        const sourceClean = link.source.replace(/\s+/g, "");
        const targetClean = link.target.replace(/\s+/g, "");

        // å°è¯•ç›´æ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±å…¨åˆ—è¡¨æ¨¡ç³Šæœç´¢
        let start = nodeMap[sourceClean];
        let end = nodeMap[targetClean];

        // ğŸš¨ æ¨¡ç³ŠåŒ¹é…é€»è¾‘ï¼šå¦‚æœ AI è¿”å›äº† "é™†æ€€ç‘¾ï¼ˆä¸»è§’ï¼‰"ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½åŒ¹é…åˆ° "é™†æ€€ç‘¾"
        if (!start) {
            const key = Object.keys(nodeMap).find(k => sourceClean.includes(k) || k.includes(sourceClean));
            if (key) start = nodeMap[key];
        }
        if (!end) {
            const key = Object.keys(nodeMap).find(k => targetClean.includes(k) || k.includes(targetClean));
            if (key) end = nodeMap[key];
        }

        if (start && end) {
            // è¿™é‡Œç»Ÿä¸€æ”¹ç”¨ drawLineV2ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼  false è¡¨ç¤ºå®çº¿
            drawLineV2(container, start.x, start.y, end.x, end.y, link.desc, false);
        } else {
            console.warn(`[Graph] æ— æ³•åŒ¹é…: ${link.source} -> ${link.target}`);
        }
    });
}

/**
 * 3. æ¸²æŸ“åº•éƒ¨æ–‡å­—å¡ç‰‡åˆ—è¡¨
 */
function renderRelationCards(chars, links) {
    const list = document.getElementById('lfw-relation-list');
    let html = '';

    // å»ºç«‹åå­—åˆ°å¤´åƒçš„æ˜ å°„ï¼Œæ–¹ä¾¿å¡ç‰‡é‡Œæ˜¾ç¤º
    const avatarMap = {};
    chars.forEach(c => avatarMap[c.name] = c.avatar);

    links.forEach(link => {
        const img1 = avatarMap[link.source] || '';
        const img2 = avatarMap[link.target] || '';

        html += `
            <div class="lfw-rel-card">
                <div class="lfw-rel-head">
                    <img src="${img1}" class="lfw-rel-avatar">
                    <div class="lfw-rel-arrow">
                        <span class="lfw-rel-tag">${link.desc}</span>
                        <div class="lfw-rel-line"></div>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="0,0 24,12 0,24"/></svg>
                    </div>
                    <img src="${img2}" class="lfw-rel-avatar">
                </div>
                <div class="lfw-rel-names">
                    <span>${link.source}</span>
                    <span>${link.target}</span>
                </div>
            </div>
        `;
    });

    list.innerHTML = html;
}

/**
 * 2. æ¸²æŸ“ç›®å½•åˆ—è¡¨
 */
function renderChapterList(chapters) {
    const container = document.getElementById('lfe-toc-list');
    if (!container) return;

    if (!chapters || chapters.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:40px; color:#ccc; font-size:12px; border:1px dashed #eee; border-radius:12px;">
                No chapters created yet.<br>Click the pencil button to begin.
            </div>`;
        return;
    }

    // å€’åºæ’åˆ—ï¼Œè®©æœ€æ–°çš„ç« èŠ‚åœ¨æœ€ä¸Šé¢ (å¯é€‰)
    // const displayList = [...chapters].reverse();
    const displayList = chapters; 

    container.innerHTML = displayList.map(ch => {
        const statusClass = ch.status === 'done' ? 'lfe-status-done' : 'lfe-status-draft';
        const statusText = ch.status === 'done' ? 'Finished' : 'Draft';
        
        return `
            <div class="lfe-chapter-card" onclick="openChapterEditor('${ch.id}')">
                <div class="lfe-ch-left">
                    <div class="lfe-ch-num">CH ${ch.num.toString().padStart(2, '0')}</div>
                    <div style="min-width:0;">
                        <div class="lfe-ch-title">${ch.title}</div>
                        <div class="lfe-ch-meta">${ch.wordCount} words Â· Last saved just now</div>
                    </div>
                </div>
                <div class="lfe-ch-right">
                    <div class="lfe-status-pill ${statusClass}">${statusText}</div>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2.5"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
        `;
    }).join('');
}

/**
 * è¾…åŠ©ï¼šæ›´æ–° AI æ—¥å¿—
 */
function updateAILog(text, percent) {
    document.getElementById('ai-writing-log').innerText = text;
    document.getElementById('ai-progress-text').innerText = percent;
}

/**
 * è¾…åŠ©ï¼šæ˜¾ç¤ºç”ŸæˆæˆåŠŸå¼¹çª—
 */
function showWritingSuccessPopup(chapter) {
    // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¼¹çª—
    const old = document.querySelector('.lfe-success-popup');
    if (old) old.remove();

    const popup = document.createElement('div');
    popup.className = 'lfe-success-popup';
    popup.innerHTML = `
        <div style="font-size:40px; margin-bottom:10px;">âœ¨</div>
        <div style="font-weight:800; font-size:18px;">Chapter Ready</div>
        <div style="font-size:12px; color:#666; margin:10px 0 20px;">
            ç¬¬ ${chapter.num} ç« å·²ç”Ÿæˆ (${chapter.wordCount} å­—)
        </div>
        <button onclick="window.enterImmersiveReaderById('${chapter.id}')" style="width:100%; background:#000; color:#fff; border:none; padding:15px; border-radius:12px; font-weight:800; cursor:pointer;">
            ENTER POV
        </button>
    `;
    document.body.appendChild(popup);
}

/**
 * 3. æœç´¢ä¸ç¡®è®¤é€»è¾‘
 */
function bindLocSearch() {
    const input = document.getElementById('loc-main-input');
    if(!input) return;

    input.oninput = (e) => {
        const val = e.target.value.trim();
        if (window.currentLocMode === 'virtual') {
            window.selectedLocData = { name: val, lat: "VIR", lng: "TUAL" };
            return;
        }

        clearTimeout(locTimer);
        locTimer = setTimeout(async () => {
            if (val.length < 2) return;
            const list = document.getElementById('loc-results-list');
            list.innerHTML = '<div style="padding:10px; font-size:10px; font-weight:900;">[ SCANNING... ]</div>';
            
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=5`);
                const data = await res.json();
                list.innerHTML = data.map(item => `
                    <div class="loc-item" onclick="window.pickLocProtocol('${item.display_name.replace(/'/g, "\\'")}', '${item.lat}', '${item.lon}')">
                        <div style="font-weight:800; font-size:14px;">${item.display_name.split(',')[0].toUpperCase()}</div>
                        <div style="font-size:9px; color:#AAA; margin-top:4px;">${item.display_name.toUpperCase()}</div>
                    </div>`).join('');
            } catch (err) { list.innerHTML = 'SIGNAL_LOST'; }
        }, 600);
    };
}

/**
 * 5. è¾…åŠ©ï¼šè‡ªåŠ¨æ³¨å…¥ HTML (é˜²æ­¢ä½ å¿˜äº†åŠ )
 */
function ensureLocationHTML() {
    if (document.getElementById('lune-location-overlay')) return;
    const html = `
        <div id="lune-location-overlay">
            <div class="loc-modal">
                <div class="loc-header"><div class="loc-title">Location</div></div>
                <div class="loc-type-toggle">
                    <div class="loc-tab active" id="tab-real" onclick="window.switchLocTab('real')">Physical</div>
                    <div class="loc-tab" id="tab-virtual" onclick="window.switchLocTab('virtual')">Virtual</div>
                </div>
                <div class="loc-search-box">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="loc-main-input" class="loc-input" placeholder="SEARCH COORDINATES...">
                </div>
                <div id="loc-results-list" class="loc-results"></div>
                <div class="loc-footer">
                    <button class="loc-btn loc-btn-confirm" onclick="window.confirmLocation()">Broadcast Coordinates</button>
                    <button class="loc-btn loc-btn-cancel" onclick="window.closeLocModal()">Discard</button>
                </div>
            </div>
        </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    bindLocSearch(); // ç»‘å®šæœç´¢äº‹ä»¶
}
/**
 * ğŸ›°ï¸ å‘é€ä½ç½®åè®® (ä¿®å¤ç‰ˆ)
 */
/**
 * ğŸ›°ï¸ å‘é€ä½ç½®å¹¶è‡ªåŠ¨å½’ä½åè®®
 */
async function confirmLocation(lat, lng, address) {
    const contact = window.currentChattingWith;
    if (!contact) return;

    // 1. æ„é€ ä½ç½®æ¶ˆæ¯å¯¹è±¡
    const msgObj = {
        role: "user",
        type: "location",
        text: address || "æœªçŸ¥åœ°ç‚¹",
        lat: lat,
        lng: lng,
        source: 'chat_room',
        timestamp: Date.now()
    };

    try {
        // 2. ç‰©ç†å†™å…¥æ•°æ®åº“
        await saveChatMessage(contact.id, msgObj);

        // 3. ğŸš¨ æ ¸å¿ƒæ­¥éª¤ï¼šç«‹åˆ»å…³é—­åœ°å›¾å­é¡µé¢
        // è¯·ç¡®è®¤ä½ çš„åœ°å›¾å¼¹çª— ID æ˜¯ä¸æ˜¯ 'subpage-map-picker'
        const mapPageId = 'subpage-map-picker'; 
        if (typeof closeSubPage === 'function') {
            closeSubPage(mapPageId); 
        } else {
            // å¤‡é€‰æ–¹æ¡ˆï¼šå¦‚æœæ˜¯æ™®é€šå¼¹çª—ï¼Œç›´æ¥æ”¹ display
            const mapEl = document.getElementById(mapPageId);
            if (mapEl) mapEl.classList.remove('active');
        }

        // 4. ç«‹å³æ¸²æŸ“èŠå¤©å®¤ï¼ˆè¿™æ ·ç”¨æˆ·ä¸€å‡ºæ¥å°±èƒ½çœ‹åˆ°æ°”æ³¡å·²ç»åœ¨é‚£äº†ï¼‰
        await renderMessages();

        // 5. éœ‡åŠ¨åé¦ˆ (å¢åŠ ä»ªå¼æ„Ÿ)
        if (navigator.vibrate) navigator.vibrate(10);
        
        console.log("âœ… ä½ç½®å·²å‘é€ï¼Œé¡µé¢å·²è‡ªåŠ¨å›æ”¶");

    } catch (e) {
        console.error("ä½ç½®å‘é€å¤±è´¥:", e);
        showToast("ä½ç½®ä¼ è¾“ä¸­æ–­");
    }
}

</script>
</body>
</html>