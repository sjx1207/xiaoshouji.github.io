<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@100..900&family=Noto+Serif:wght@100..900&family=Roboto+Mono:wght@100..700&display=swap" rel="stylesheet">
    <title>iOS Web OS - Music Edition</title>
    <style>
        :root {
            /* é»˜è®¤å€¼ */
            --global-font-family: 'Inter', sans-serif;
            --global-font-size: 16px;
            --global-font-weight: 400;
            --global-text-color: #000000;
        }

        body {
            /* è®©æ•´ä¸ª Body ä½¿ç”¨è¿™äº›å˜é‡ */
            font-family: var(--global-font-family) !important;
            /* æ³¨æ„ï¼šfont-size å’Œ color æœ€å¥½ä¸è¦å¼ºåˆ¶ç»™ bodyï¼Œ
            è€Œæ˜¯ç»™å…·ä½“çš„ .app-item, .set-text ç­‰å…ƒç´ ï¼Œ
            æˆ–è€…ä½ å¯ä»¥ç›´æ¥è¿™æ ·å†™ï¼Œçœ‹ä½ å–œä¸å–œæ¬¢è¿™ç§å…¨è¦†ç›–çš„æ„Ÿè§‰ */
            color: var(--global-text-color);
        }

        /* å»ºè®®ï¼šä¸“é—¨ç»™éœ€è¦å˜çš„åœ°æ–¹åŠ å˜é‡ï¼Œæ¯”å¦‚ app åå­—ã€è®¾ç½®é‡Œçš„æ–‡å­— */
        .app-name, .set-text, .ios-alert-msg, .clock-text {
            font-family: var(--global-font-family);
            font-weight: var(--global-font-weight);
            /* font-size å¯ä»¥æ ¹æ®éœ€è¦å†³å®šæ˜¯å¦è·Ÿéšå…¨å±€ */
        }
        /* --- 1. å…¨å±€é…ç½® --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        
        body, html { 
            width: 100%; height: 100%; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            background: #000; color: white; 
        }
        
        #os-container { 
            width: 100vw; height: 100vh; 
            position: relative; 
            display: flex; flex-direction: column;
            background: #000;
        }

        #bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(160deg, #a1c4fd 0%, #c2e9fb 100%);
            background-size: cover; background-position: center;
            z-index: 0; transition: opacity 0.3s; opacity: 1;
        }

        .content-layer {
            position: relative; z-index: 1;
            flex: 1; display: flex; flex-direction: column;
            height: 100%;
            pointer-events: none; 
        }
        .content-layer > * { pointer-events: auto; }

        /* --- 2. çŠ¶æ€æ  --- */
        .status-bar {
            height: 47px; width: 100%; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 0 24px 10px 24px; font-weight: 600; font-size: 15px; color: #000;
        }
        .time-area { flex: 1; letter-spacing: -0.5px; }
        .status-right { display: flex; align-items: center; gap: 6px; }
        .icon-signal { width: 18px; height: 12px; display: flex; align-items: flex-end; gap: 2px; }
        .signal-bar { width: 3px; background-color: #000; border-radius: 1px; }
        .bar-1 { height: 30%; opacity: 0.3; } .bar-2 { height: 50%; } .bar-3 { height: 75%; } .bar-4 { height: 100%; }
        .icon-battery { width: 25px; height: 12px; position: relative; margin-left: 2px; }
        .battery-shell { width: 22px; height: 100%; border: 1px solid rgba(0,0,0,0.6); border-radius: 4px; opacity: 0.8; }
        .battery-level-bar { position: absolute; top: 2px; left: 2px; height: 8px; border-radius: 2px; background: #000; width: 18px; }
        .battery-cap { position: absolute; right: 0; top: 3.5px; width: 1.5px; height: 5px; background: rgba(0,0,0,0.6); border-radius: 0 2px 2px 0; }
        #battery-percent { font-size: 15px; font-weight: 600; color: #000; margin-right: 3px; }

        /* --- 3. è¶…çº§ç»„ä»¶ --- */
        .widget-area { padding: 10px 24px 0 24px; flex-shrink: 0; }
        .super-widget {
            width: 100%; height: auto; 
            position: relative; border-radius: 26px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.05); color: #000;
            overflow: hidden; padding: 25px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        #widget-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.45); 
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            z-index: 0; transition: opacity 0.2s;
            background-size: cover; background-position: center;
        }
        .widget-settings-btn {
            position: absolute; top: 15px; right: 15px;
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 10; transition: 0.2s; color: rgba(0,0,0,0.6);
        }
        .widget-settings-btn:hover { background: rgba(0,0,0,0.05); }
        .widget-content { position: relative; z-index: 1; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .top-info { margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; }
        .w-time { font-size: 48px; font-weight: 700; letter-spacing: -2px; line-height: 1; margin-bottom: 5px; }
        .w-date-cn { font-size: 15px; font-weight: 600; color: #333; margin-bottom: 2px; }
        .w-date-en { font-size: 13px; font-weight: 500; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .weather-tag { background: rgba(255,255,255,0.7); padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: 0.2s; font-size: 14px; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .middle-photo {
            width: 100%; height: 150px; background: #eee; border-radius: 18px;
            overflow: hidden; position: relative; cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .middle-photo img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .photo-hint { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; font-size: 12px; padding: 6px 0; opacity: 0; transition: 0.3s; }
        .middle-photo:hover .photo-hint { opacity: 1; }
        .prog-box { width: 100%; }
        .prog-text { font-size: 12px; color: #333; margin-bottom: 6px; display: flex; justify-content: space-between; font-weight: 600; padding: 0 2px; }
        .prog-track { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
        .prog-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #34c759, #30b0c7); transition: width 0.5s; }

        /* --- 4. æ¡Œé¢åŒºåŸŸ --- */
        .desktop {
            flex: 1; padding: 30px 24px;
            overflow-y: auto; padding-bottom: 220px; /* ç•™å‡ºæ›´å¤šç©ºé—´ç»™ Dock + éŸ³ä¹èƒ¶å›Š */
            display: grid; grid-template-columns: repeat(4, 1fr); 
            grid-auto-rows: min-content; gap: 20px 15px; 
            justify-items: center; align-content: start;
            pointer-events: auto; scrollbar-width: none;
        }
        .desktop::-webkit-scrollbar { display: none; }
        .app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; width: 100%; }
        .app-icon {
            width: 62px; height: 62px; min-width: 62px; min-height: 62px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease; color: white;
        }
        .app-icon:active { transform: scale(0.92); background: rgba(255, 255, 255, 0.35); }
        .app-icon svg { width: 30px; height: 30px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .app-name { font-size: 12px; color: #000; font-weight: 500; text-shadow: 0 1px 1px rgba(255,255,255,0.5); margin-top: 4px; }

        /* --- 5. Dock æ  (å›ºå®š 125px) --- */
        .dock-container {
            position: fixed !important; bottom: 125px !important;
            left: 0 !important; width: 100% !important; height: 0 !important;
            display: flex !important; justify-content: center !important;
            z-index: 9999 !important; pointer-events: none !important; padding: 0 !important;
        }
        .dock {
            width: 90% !important; max-width: 360px !important; height: 90px !important;
            background: rgba(255, 255, 255, 0.2); /* æ›´é€šé€ */
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 32px; border: 1px solid rgba(255,255,255,0.3);
            display: flex; justify-content: space-evenly; align-items: center;
            pointer-events: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        /* --- 6. éŸ³ä¹èƒ¶å›Š (æ–°ç»„ä»¶) --- */
        .music-capsule {
    position: fixed;
    /* Move UP above the Dock (Dock is at 125px + 90px height = 215px top) */
    bottom: 150px !important; 
    left: 50%; 
    transform: translateX(-50%);
    width: 330px; /* Make it slightly wider */
    height: 50px;
    
    /* Liquid Glass Style (Matching App Icons) */
    background: rgba(255, 255, 255, 0.15); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-top: 1px solid rgba(255, 255, 255, 0.6);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    
    border-radius: 30px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 5px 15px;
    z-index: 9998; 
    cursor: pointer; 
    transition: 0.3s;
}
        .music-capsule:active { transform: translateX(-50%) scale(0.95); }
        
        /* ä¸“è¾‘å°é¢ */
        .music-cover-box {
            width: 34px; height: 34px; border-radius: 50%; overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
            animation: spin 10s linear infinite; animation-play-state: paused;
        }
        .music-cover-box img { width: 100%; height: 100%; object-fit: cover; }
        
        /* å¾‹åŠ¨æ¡ */
        .music-visualizer { display: flex; gap: 3px; align-items: center; height: 100%; flex: 1; justify-content: center; }
        .bar { width: 3px; height: 10px; background: #34c759; border-radius: 2px; animation: equalizer 1s ease-in-out infinite; animation-play-state: paused; }
        .bar:nth-child(1) { animation-duration: 0.8s; height: 8px; }
        .bar:nth-child(2) { animation-duration: 1.2s; height: 14px; }
        .bar:nth-child(3) { animation-duration: 1.0s; height: 10px; }
        .bar:nth-child(4) { animation-duration: 0.6s; height: 6px; }
        
        /* ä¸Šä¼ æŒ‰é’® */
        .music-upload-btn { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.7); }
        .music-upload-btn svg { width: 16px; height: 16px; }
        .music-upload-btn:hover { color: #fff; background: rgba(255,255,255,0.2); }

        /* åŠ¨ç”»ä¸æ’­æ”¾çŠ¶æ€ */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes equalizer { 0%, 100% { height: 6px; opacity: 0.6; } 50% { height: 18px; opacity: 1; background: #30b0c7; } }
        .playing .music-cover-box { animation-play-state: running; }
        .playing .bar { animation-play-state: running; }

        .home-indicator { position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%); width: 130px; height: 5px; background: #000; border-radius: 10px; opacity: 0.8; pointer-events: none; z-index: 10000; }

        /* --- 7. å¼¹çª—æ ·å¼ --- */
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); z-index: 99999; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-body { background: #fff; width: 85%; max-width: 320px; padding: 24px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; color: #333; }
        .modal-title { font-size: 19px; font-weight: 700; margin-bottom: 20px; }
        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        .modal-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; background: #f2f2f7; color: #000; }
        .modal-btn:active { transform: scale(0.98); background: #e5e5ea; }
        .modal-btn.primary { background: #007aff; color: white; }
        .modal-btn.danger { color: #ff3b30; background: transparent; }
        .url-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e5e5ea; border-radius: 12px; font-size: 14px; background: #f9f9f9; outline: none; }
        .slider-container { margin-bottom: 20px; text-align: left; }
        .slider-label { font-size: 14px; font-weight: 600; margin-bottom: 8px; display: block; }
        .opacity-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #e5e5ea; outline: none; }
        .opacity-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #007aff; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .city-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 240px; overflow-y: auto; margin-bottom: 20px; padding: 4px; }
        .city-btn { background: #f2f2f7; border: none; padding: 12px; border-radius: 12px; font-size: 13px; cursor: pointer; text-align: left; font-weight: 500; }
        .city-tabs { display: flex; background: #f2f2f7; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .tab-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; font-weight: 500; color: #666; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: #fff; color: #000; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

/* --- å£çº¸ App æ ·å¼ --- */
.app-window {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #f2f2f7; /* iOS è®¾ç½®èƒŒæ™¯è‰² */
    z-index: 20000; /* å¿…é¡»æé«˜ï¼Œç›–ä½æ¡Œé¢ */
    display: none; flex-direction: column;
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* App å†…çŠ¶æ€æ é¢œè‰²é€‚é… */
.app-status-bar { background: #f2f2f7; color: #000; }

.app-header {
    padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
    background: #f2f2f7; flex-shrink: 0;
}
.app-title { font-size: 32px; font-weight: 700; color: #000; }
.close-btn {
    background: #e5e5ea; border: none; padding: 8px 16px; border-radius: 20px;
    font-weight: 600; color: #007aff; cursor: pointer;
}

.app-body { flex: 1; overflow-y: auto; padding: 20px; }

/* ä¸Šä¼ æ¡† */
.upload-zone {
    width: 100%; height: 120px;
    border: 2px dashed #c7c7cc; border-radius: 16px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    color: #8e8e93; cursor: pointer; transition: 0.2s; background: #fff;
    margin-bottom: 30px;
}
.upload-zone:active { background: #e5e5ea; border-color: #8e8e93; }
.upload-icon { font-size: 30px; margin-bottom: 5px; }
.upload-desc { font-weight: 600; font-size: 16px; }
.upload-sub { font-size: 12px; opacity: 0.7; }

/* é¢„è§ˆç½‘æ ¼ */
.section-title { font-size: 20px; font-weight: 700; margin-bottom: 15px; color: #000; }
.wallpaper-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
}
.wp-card {
    background: #fff; border-radius: 12px; overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative;
    aspect-ratio: 9/16; /* æ‰‹æœºå±å¹•æ¯”ä¾‹ */
    cursor: pointer; border: 3px solid transparent; transition: 0.2s;
}
.wp-card:active { transform: scale(0.98); }
.wp-card.active { border-color: #007aff; } /* é€‰ä¸­çŠ¶æ€ */

.wp-preview-media { width: 100%; height: 100%; object-fit: cover; }
.wp-tag {
    position: absolute; top: 8px; right: 8px;
    background: rgba(0,0,0,0.6); color: white;
    font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
}
.wp-apply-btn {
    position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
    background: #007aff; color: white; border: none;
    padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* è§†é¢‘èƒŒæ™¯å±‚ */
#bg-video {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; z-index: 0;
}

/* --- è®¾ç½® App æ ·å¼ --- */
.settings-view {
    width: 100%; height: 100%; display: flex; flex-direction: column;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    background: #f2f2f7; position: absolute; top: 0; left: 0;
    padding-top: 47px; /* é¿å¼€çŠ¶æ€æ  */
}

.settings-group {
    background: #fff; border-radius: 12px; margin: 0 16px 20px 16px;
    overflow: hidden;
}
.settings-group-title {
    margin: 10px 16px 6px 16px; font-size: 13px; color: #6d6d72; font-weight: 400;
}

.settings-item {
    display: flex; align-items: center; padding: 12px 16px;
    background: #fff; cursor: pointer; transition: 0.2s;
    border-bottom: 1px solid #e5e5ea;
}
.settings-item:last-child { border-bottom: none; }
.settings-item:active { background: #e5e5ea; }

.set-icon {
    width: 28px; height: 28px; border-radius: 6px; display: flex;
    align-items: center; justify-content: center; margin-right: 12px;
}
.set-icon svg { width: 18px; height: 18px; }
.set-text { flex: 1; font-size: 17px; color: #000; }
.set-arrow { color: #c7c7cc; font-size: 20px; font-weight: 600; }

/* å¤´éƒ¨å¯¼èˆªæ  */
.back-btn {
    border: none; background: transparent; color: #007aff; font-size: 17px;
    display: flex; align-items: center; cursor: pointer; padding: 10px;
}
/* --- ä¿®å¤ç‰ˆï¼šæ—¶åŒºé¡µé¢æ ‡é¢˜ --- */
.sub-title {
    font-weight: 600;
    font-size: 17px;
    
    /* ğŸ‘‡ æŠŠåŸæ¥çš„ç™½è‰²æ”¹ä¸ºé»‘è‰² */
    color: #000 !important; 
    
    /* é¡ºä¾¿ç¡®ä¿å®ƒç»å¯¹å±…ä¸­ */
    flex: 1;
    text-align: center;
}

/* æœç´¢æ¡† */
.search-container { padding: 10px 16px; background: #f2f2f7; }
.search-bar {
    background: #e3e3e8; border-radius: 10px; padding: 8px 12px;
    display: flex; align-items: center; gap: 8px;
}
.search-bar input {
    border: none; background: transparent; outline: none; font-size: 16px; width: 100%;
}

/* --- ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶æ˜¾ç¤º App å†…çŠ¶æ€æ  --- */
.app-status-bar {
    /* 1. é¢œè‰²é€‚é…ï¼šç°è‰²èƒŒæ™¯ï¼Œé»‘è‰²å­— */
    background: #f2f2f7 !important; 
    color: #000 !important;
    
    /* 2. ã€å…³é”®ã€‘å¼ºåˆ¶æµ®åŠ¨åœ¨æœ€é¡¶å±‚ */
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    z-index: 20005 !important; /* æ¯”é¡µé¢å†…å®¹é«˜ */
}

/* é¡ºä¾¿å¾®è°ƒä¸€ä¸‹è®¾ç½®é¡µé¢çš„é¡¶éƒ¨é—´è·ï¼Œé˜²æ­¢å†…å®¹è¢«çŠ¶æ€æ æŒ¡ä½ */
.settings-view {
    padding-top: 50px !important; 
}

/* --- API è®¾ç½®é¡µç²¾è£…ä¿® (iOS é£æ ¼) --- */

/* 1. é¡µé¢å®¹å™¨ï¼šé”ä½æ»šåŠ¨ï¼Œåªå…è®¸å†…éƒ¨æ»‘åŠ¨ */
.settings-view {
    /* ä¹‹å‰çš„æ ·å¼ä¿æŒä¸å˜ï¼Œç¡®ä¿æœ‰ display: flex; flex-direction: column; */
    background: #f2f2f7; /* iOS ç°è‰²èƒŒæ™¯ */
    overflow: hidden; /* ç¦æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ */
}

/* 2. å†…å®¹åŒºåŸŸï¼šè¿™æ˜¯å”¯ä¸€èƒ½æ»šåŠ¨çš„åœ°æ–¹ */
.app-body {
    flex: 1; 
    overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
    padding: 20px 16px 40px 16px; /* å¢åŠ åº•éƒ¨ç•™ç™½ */
    -webkit-overflow-scrolling: touch; /* ä¸æ»‘æ»šåŠ¨ */
}

/* 3. åˆ†ç»„å¡ç‰‡ï¼šæ¨¡ä»¿ iOS è®¾ç½®é‡Œçš„ç™½è‰²åœ†è§’å— */
.settings-group {
    background: #fff;
    border-radius: 10px;
    margin-bottom: 24px;
    overflow: hidden; /* é˜²æ­¢å­å…ƒç´ æº¢å‡ºåœ†è§’ */
    box-shadow: 0 1px 2px rgba(0,0,0,0.02); /* ææ·¡çš„é˜´å½± */
}

/* 4. æ ‡é¢˜æ–‡å­—ä¼˜åŒ– */
.settings-group-title {
    margin: 0 0 6px 12px;
    font-size: 13px;
    color: #6d6d72;
    font-weight: 400;
    text-transform: uppercase;
}

/* 5. è¾“å…¥æ¡†ç¾åŒ– (åƒåˆ—è¡¨é¡¹ä¸€æ ·) */
.api-input-row {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e5ea;
    display: flex; flex-direction: column;
}
.api-input-row:last-child { border-bottom: none; }

.api-label {
    font-size: 13px; color: #000; font-weight: 500; margin-bottom: 8px;
}

.api-input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #e5e5ea; /* æ·¡æ·¡çš„è¾¹æ¡† */
    background: #f2f2f7; /* æµ…ç°åº•è‰² */
    font-size: 15px;
    color: #000;
    outline: none;
    transition: 0.2s;
    box-sizing: border-box;
}
.api-input:focus {
    background: #fff;
    border-color: #007aff; /* èšç„¦å˜è“ */
}

/* 6. æŒ‰é’®ç¾åŒ– */
.api-btn {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-size: 16px; font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
    transition: background 0.2s;
}
.api-btn.secondary {
    background: #e5e5ea; color: #007aff; /* ç°è‰²åº•è“è‰²å­— */
}
.api-btn.secondary:active { background: #d1d1d6; }

.api-btn.primary {
    background: #007aff; color: #fff; /* è“è‰²åº•ç™½è‰²å­— */
}
.api-btn.primary:active { opacity: 0.8; }

.api-btn.save {
    background: #34c759; color: #fff; /* ç»¿è‰²åº• (ä¿å­˜) */
}

/* 7. ä¸‹æ‹‰èœå•ç¾åŒ– (å…³é”®ï¼) */
/* è®©å®ƒçœ‹èµ·æ¥åƒ iOS è®¾ç½®é‡Œå³è¾¹è“è‰²çš„é€‰é¡¹ */
.api-select {
    appearance: none; -webkit-appearance: none; /* å»æ‰é»˜è®¤ä¸‘æ ·å¼ */
    border: none;
    background: transparent;
    font-size: 17px;
    color: #007aff; /* è“è‰²æ–‡å­— */
    text-align: right;
    direction: rtl; /* æ–‡å­—é å³ */
    padding-right: 20px; /* ç»™ç®­å¤´ç•™ä½ç½® */
    cursor: pointer;
    font-weight: 400;
}
/* è¿™æ˜¯ä¸€ä¸ªå‡çš„ç®­å¤´ï¼Œç”¨ CSS ç”»çš„ */
.select-wrapper {
    position: relative;
    display: flex; align-items: center;
}
.select-wrapper::after {
    content: "â€º"; /* æˆ–è€…æ˜¯ä¸Šä¸‹ç®­å¤´ */
    position: absolute; right: 0;
    color: #c7c7cc; font-size: 20px; font-weight: 600; pointer-events: none;
    transform: rotate(90deg); /* å‘ä¸‹æŒ‡ */
}

/* 8. æµ‹è¯•é¢æ¿ç¾åŒ– */
.test-panel {
    background: #1c1c1e; /* é»‘è‰²ç»ˆç«¯é£ */
    color: #00ff00; /* ç»¿è‰²é»‘å®¢å­— */
    border-radius: 8px;
    padding: 12px;
    font-family: 'Menlo', 'Courier New', monospace;
    font-size: 12px;
    min-height: 80px;
    max-height: 150px;
    overflow-y: auto;
    margin-bottom: 15px;
    white-space: pre-wrap;
    border: 1px solid #333;
}

/* 9. é¢„è®¾åˆ—è¡¨é¡¹ */
.preset-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #e5e5ea;
    background: #fff;
}
.preset-item:last-child { border-bottom: none; }
.preset-name { font-size: 16px; font-weight: 500; color: #000; }
.preset-model { font-size: 12px; color: #8e8e93; margin-top: 2px; }

/* --- è‡ªå®šä¹‰ä¸‹æ‹‰èœå•æ ·å¼ --- */
.custom-select-trigger {
    font-size: 17px;
    color: #007aff;
    cursor: pointer;
    padding: 10px 0;
    min-width: 150px;
    text-align: right;
    user-select: none;
}

/* ä¸‹æ‹‰èœå•åˆ—è¡¨å®¹å™¨ */
.custom-options-list {
    display: none; /* é»˜è®¤éšè— */
    position: absolute;
    top: 100%; /* åœ¨æŒ‰é’®æ­£ä¸‹æ–¹ */
    right: 0;  /* é å³å¯¹é½ */
    width: 220px;
    max-height: 250px;
    overflow-y: auto;
    background: #ffffff; /* çº¯ç™½èƒŒæ™¯ */
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15); /* æ¼‚äº®çš„æŠ•å½± */
    z-index: 1000; /* ä¿è¯æµ®åœ¨æœ€ä¸Šé¢ */
    padding: 5px;
    margin-top: 5px;
}
/* å‡ºç°æ—¶çš„åŠ¨ç”» */
.custom-options-list.show {
    display: block;
    animation: fadeIn 0.2s ease;
}

/* æ¯ä¸€ä¸ªé€‰é¡¹ */
.custom-option {
    padding: 10px 12px;
    font-size: 15px;
    color: #000;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.1s;
    border-bottom: 1px solid #f2f2f7;
}
.custom-option:last-child { border-bottom: none; }
.custom-option:hover { background: #f2f2f7; }
.custom-option.disabled { color: #8e8e93; font-style: italic; cursor: default; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

/* --- 1. iOS é¡µå†…å¼¹çª—æ ·å¼ --- */
.ios-alert-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4); /* èƒŒæ™¯å˜æš— */
    z-index: 99999; /* æœ€é«˜å±‚çº§ */
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(2px);
    animation: fadeIn 0.2s ease;
}
.ios-alert-box {
    width: 270px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 14px;
    text-align: center;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: scale(1.1);
    animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
.ios-alert-title {
    font-weight: 600; font-size: 17px; margin-top: 20px; color: #000;
}
.ios-alert-msg {
    font-size: 13px; color: #000; margin: 5px 20px 20px 20px; line-height: 1.4;
}
.ios-alert-btn {
    border-top: 0.5px solid rgba(60, 60, 67, 0.29);
    padding: 12px;
    color: #007aff; font-size: 17px; font-weight: 600; cursor: pointer;
}
.ios-alert-btn:active { background: rgba(0,0,0,0.05); }

@keyframes popIn { to { transform: scale(1); } }

/* --- 2. ä¿®å¤é¢„è®¾æŒ‰é’®æ ·å¼ --- */
.preset-actions {
    display: flex; gap: 8px;
}
.preset-btn {
    border: none; padding: 6px 12px; border-radius: 15px;
    font-size: 12px; font-weight: 600; cursor: pointer;
}
.preset-btn.load { background: #e5f1ff; color: #007aff; }
.preset-btn.del { background: #ffeceb; color: #ff3b30; }

/* --- 3. ä¼˜åŒ–æµ‹è¯•è¾“å…¥æ¡† --- */
.test-input {
    width: 100%; padding: 10px; border-radius: 8px;
    border: 1px solid #e5e5ea; background: #fff;
    margin-bottom: 10px; font-size: 14px; box-sizing: border-box;
}

/* --- å­—ä½“è®¾ç½®æ ·å¼ --- */
.slider-row {
    display: flex; align-items: center; gap: 10px; padding: 5px 0;
}
input[type=range] {
    flex: 1; -webkit-appearance: none; height: 4px; background: #e5e5ea; border-radius: 2px;
}
input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 20px; height: 20px; background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-radius: 50%; cursor: pointer;
}

.color-circle {
    width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
    border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.check-icon {
    color: #007aff; font-weight: bold; display: none;
}
.active-font .check-icon { display: block; }

/* --- ä¿®å¤ï¼šå£çº¸ App è¢«çŠ¶æ€æ é®æŒ¡çš„é—®é¢˜ --- */
#app-wallpapers {
    /* å› ä¸ºçŠ¶æ€æ ç°åœ¨æ‚¬æµ®äº†ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç»™ app é¡¶éƒ¨ç•™å‡ºç©ºé—´ */
    padding-top: 47px !important; 
    box-sizing: border-box;
}

/* é¡ºä¾¿ä¼˜åŒ–ä¸€ä¸‹å£çº¸ App çš„æ ‡é¢˜æ ï¼Œè®©å®ƒè·Ÿæ–°å­—ä½“æ›´æ­ */
#app-wallpapers .app-header {
    background: transparent; /* å»æ‰ç°è‰²èƒŒæ™¯ï¼Œæ›´é€šé€ */
    padding-bottom: 10px;
}

/* --- ä¿®å¤ï¼šå¢åŠ å£çº¸ App ä¸­é—´çš„é—´è· --- */
#app-wallpapers .upload-zone {
    /* åŸæ¥å¯èƒ½æ˜¯ 20px æˆ– 30pxï¼Œè¿™é‡Œæˆ‘ä»¬æ”¹æˆ 50pxï¼ŒæŠŠä¸‹é¢é¡¶å¼€ */
    margin-bottom: 50px !important; 
}

/* å¦‚æœè§‰å¾—æ ‡é¢˜å’Œä¸‹é¢çš„å›¾ç‰‡ä¹Ÿå¤ªè¿‘ï¼Œå¯ä»¥é¡ºä¾¿è°ƒæ•´è¿™ä¸ª */
#app-wallpapers .section-title {
    margin-bottom: 20px !important;
}

/* --- ä¿®å¤ï¼šå¼ºåˆ¶åº”ç”¨å…¨å±€å­—ä½“é¢œè‰² --- */
/* è®© appåå­—ã€è®¾ç½®æ–‡å­—ã€æ ‡é¢˜ã€æ—¶é—´ ç­‰éƒ½å¬å˜é‡çš„è¯ */
.app-name, 
.set-text, 
.app-title, 
.sub-title,
.clock-text,
.settings-group-title,
.ios-alert-title,
.ios-alert-msg,
.api-label,
.custom-select-trigger,
.custom-option {
    color: var(--global-text-color) !important;
    transition: color 0.2s; /* é¡ºæ»‘å˜è‰² */
}

/* âš ï¸ ç‰¹æ®Šå¤„ç†ï¼šæ—¥æœŸå’Œå‰¯æ ‡é¢˜é€šå¸¸æ˜¯æµ…ç°è‰²çš„ï¼Œä¸åº”è¯¥è·Ÿç€å˜ï¼Œä¸ç„¶å¾ˆä¸‘ */
/* å¦‚æœä½ æƒ³è®©å®ƒä»¬ä¿æŒç°è‰²ï¼Œå°±ä¿ç•™ä¸‹é¢è¿™è¡Œï¼›å¦‚æœä½ æƒ³è®©å®ƒä»¬ä¹Ÿå˜è‰²ï¼Œå°±åˆ æ‰ */
.settings-group-title, .upload-sub, .preset-model {
    color: #8e8e93 !important; 
    opacity: 0.8;
}

/* --- çµåŠ¨èƒ¶å›ŠåŸºç¡€æ ·å¼ --- */
/* --- 1. èƒ¶å›Šçš„åŸºç¡€é•¿ç›¸ (çœŸå‡èƒ¶å›Šå…±ç”¨) --- */
.smart-capsule-base {
    /* ğŸ¨ åªå†™æ ·å­ï¼Œä¸å†™ä½ç½®ï¼ */
    width: 120px;
    height: 35px;
    background: #000;
    border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    color: white; overflow: hidden;
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* é¡ºæ»‘åŠ¨ç”» */
}

/* --- 2. çœŸÂ·çµåŠ¨å²› (IDé€‰æ‹©å™¨ï¼šç»™å®ƒæœ€é«˜æƒé™å’Œå›ºå®šä½ç½®) --- */
#smart-capsule {
    position: fixed !important; /* é’‰æ­»åœ¨å±å¹•ä¸Š */
    top: 11px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999999 !important; /* æœ€é«˜å±‚çº§ */
    pointer-events: auto;
    opacity: 0; /* é»˜è®¤éšè— */
}
/* åªæœ‰çœŸèƒ¶å›Šéœ€è¦ active æ¥æ˜¾ç¤º */
#smart-capsule.active {
    opacity: 1;
}

/* --- 3. é¢„è§ˆèƒ¶å›Š (å¼ºåˆ¶ç•™åœ¨è®¾ç½®é¡µé¢é‡Œ) --- */
#island-preview-box {
    position: relative !important; /* ä¹–ä¹–å¾…åœ¨ç›’å­é‡Œ */
    top: auto !important;
    left: auto !important;
    transform: none !important;
    opacity: 1 !important; /* é¢„è§ˆæ°¸è¿œå¯è§ */
    z-index: 1;
}

/* --- iOS å¼€å…³ (Toggle Switch) --- */
.toggle-switch {
    position: relative; width: 50px; height: 30px; display: inline-block;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #e5e5ea; border-radius: 34px; transition: .4s;
}
.slider:before {
    position: absolute; content: "";
    height: 26px; width: 26px; left: 2px; bottom: 2px;
    background-color: white; border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: .4s;
}
input:checked + .slider { background-color: #34c759; } /* ç»¿è‰²å¼€å¯ */
input:checked + .slider:before { transform: translateX(20px); }

/* --- ä¿®å¤ï¼šå…¨å±€çŠ¶æ€æ  (ä¸Šå¸æ¨¡å¼) --- */
#global-status-bar {
    position: fixed !important;
    top: 0; left: 0; width: 100%; height: 47px;
    z-index: 9999999 !important; /* æœ€é«˜å±‚çº§ï¼Œç›–ä½ä¸€åˆ‡ */
    display: flex; justify-content: space-between; align-items: flex-end;
    padding: 0 24px 10px 24px;
    font-weight: 600; font-size: 15px;
    color: #fff; /* é»˜è®¤ç™½è‰² (ä¸»é¡µç”¨) */
    transition: color 0.3s ease;
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
}

/* çŠ¶æ€æ å˜é»‘æ¨¡å¼ (App ç”¨) */
#global-status-bar.text-dark {
    color: #000 !important;
}
#global-status-bar.text-dark .signal-bar,
#global-status-bar.text-dark .battery-shell,
#global-status-bar.text-dark .battery-cap {
    background-color: #000 !important;
    border-color: #000 !important;
}
#global-status-bar.text-dark .battery-level-bar {
    background-color: #000 !important; /* æ²¡å……ç”µæ—¶é»‘è‰² */
}

/* --- ä¿®å¤ï¼šå…¨å±€çµåŠ¨å²› --- */
.smart-capsule-base {
    position: fixed !important; /* å¿…é¡»æ˜¯ fixed */
    top: 11px; left: 50%;
    transform: translateX(-50%);
    z-index: 9999999 !important; /* å’ŒçŠ¶æ€æ ä¸€æ ·é«˜ */
    pointer-events: auto; /* çµåŠ¨å²›å¯ä»¥ç‚¹ */
}

/* --- ä¿®å¤ï¼šApp é¡¶éƒ¨é¿è®© --- */
/* å› ä¸ºçŠ¶æ€æ ç°åœ¨æ‚¬æµ®äº†ï¼ŒApp å†…å®¹è¦å¾€ä¸‹æ¨ï¼Œä¸ç„¶è¢«æŒ¡ä½ */
.app-header {
    padding-top: 50px !important; 
}
.settings-view {
    padding-top: 50px !important;
}

/* --- ä¿®å¤ï¼šæŠŠä¸»å±å¹•å†…å®¹å¾€ä¸‹æ¨ --- */
.content-layer {
    /* æ—¢ç„¶çŠ¶æ€æ æ‚¬æµ®äº†ï¼Œå®¹å™¨æœ¬èº«éœ€è¦å¾€ä¸‹è®©å‡ºç©ºé—´ */
    padding-top: 50px !important; 
    box-sizing: border-box; /* ç¡®ä¿ padding ç®—åœ¨é«˜åº¦é‡Œ */
}

/* æˆ–è€…ï¼Œå¦‚æœä½ åªæƒ³æ¨ widget */
.widget-area {
    /* ç»™ç»„ä»¶åŒºåŸŸåŠ ä¸ªé¡¶éƒ¨å¤–è¾¹è·ï¼ŒæŠŠå®ƒé¡¶ä¸‹æ¥ */
    margin-top: 20px !important; 
    transition: margin 0.3s;
}

/* ç¡®ä¿æ¡Œé¢å›¾æ ‡åŒºä¹Ÿæœ‰è¶³å¤Ÿçš„å‘¼å¸ç©ºé—´ */
.desktop {
    padding-top: 20px !important;
}

/* --- ä¿®å¤ï¼šæ ‡é¢˜æ ä¸Šç§» (æ¶ˆé™¤åŒé‡é—´è·) --- */

/* 1. æŠŠå¤–å±‚å®¹å™¨çš„é¡¶éƒ¨é—´è·å‡å°ï¼Œåªç•™å‡ºçŠ¶æ€æ çš„é«˜åº¦ */
.settings-view, 
#app-wallpapers, 
#settings-main-view {
    padding-top: 60px !important; /* åˆšå¥½é¿å¼€çŠ¶æ€æ å³å¯ */
}

/* 2. ã€å…³é”®ã€‘å»æ‰ Header å†…éƒ¨å¤šä½™çš„é¡¶éƒ¨å¡«å…… */
.app-header {
    padding-top: 5px !important; /* åªè¦ä¸€ç‚¹ç‚¹ç¼éš™ï¼Œä¸è¦50pxäº† */
    padding-bottom: 5px !important; /* ç¨å¾®ç´§å‡‘ä¸€ç‚¹ */
    min-height: 50px; /* ä¿è¯é«˜åº¦è¶³å¤Ÿ */
    background: transparent; /* ä¿æŒé€šé€ */
}

/* 3. å¦‚æœè§‰å¾—æ ‡é¢˜æ–‡å­—ç¦»çŠ¶æ€æ è¿˜æ˜¯å¤ªè¿‘ï¼Œå¾®è°ƒè¿™é‡Œ */
.app-title {
    margin-top: 0 !important;
    line-height: 1.2;
}

/* 4. é’ˆå¯¹å£çº¸ App ç‰¹æ®Šå¾®è°ƒ */
#app-wallpapers .app-header {
    padding-top: 0 !important; /* å£çº¸é¡µå¯ä»¥æ›´é ä¸Š */
}

/* --- ä¿®å¤ï¼šå›¾æ ‡å•†åº— App é¡¶éƒ¨é¿è®© --- */
#app-icons {
    /* ç»™é¡¶éƒ¨ç•™å‡º 60px çš„ç©ºé—´ï¼Œè®©æ ‡é¢˜æ éœ²å‡ºæ¥ */
    padding-top: 60px !important; 
    box-sizing: border-box;
}

/* ç¨å¾®è°ƒæ•´ä¸€ä¸‹æ ‡é¢˜æ çš„å†…éƒ¨é—´è·ï¼Œè®©å®ƒå¥½çœ‹ç‚¹ */
#app-icons .app-header {
    padding-bottom: 10px !important;
    min-height: auto !important;
}

/* --- è§’è‰²ä¹¦ App æ ·å¼ --- */

/* 1. åˆ—è¡¨å¡ç‰‡ (ç«–æ’) */
.char-grid {
    display: flex; flex-direction: column; gap: 12px;
}
.char-card {
    background: #fff; border-radius: 16px; padding: 15px;
    display: flex; align-items: center; gap: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    cursor: pointer; transition: 0.2s;
}
.char-card:active { transform: scale(0.98); background: #f2f2f7; }

.char-card-avatar {
    width: 60px; height: 60px; border-radius: 50%; object-fit: cover;
    background: #eee; flex-shrink: 0;
}
.char-card-info { flex: 1; overflow: hidden; }
.char-card-name { font-size: 17px; font-weight: 600; color: #000; margin-bottom: 4px; }
.char-card-desc { font-size: 13px; color: #8e8e93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* 2. è¯¦æƒ…é¡µå¸ƒå±€ (åŠæ‚¬æµ®å¤´åƒæ ¸å¿ƒ) */
.char-banner {
    width: 100%; height: 180px; /* èƒŒæ™¯é«˜åº¦ */
    background-color: #eee; background-size: cover; background-position: center;
    position: relative; cursor: pointer;
}
.banner-hint {
    position: absolute; bottom: 10px; right: 10px;
    background: rgba(0,0,0,0.5); color: white;
    font-size: 12px; padding: 4px 8px; border-radius: 12px;
    opacity: 0; transition: 0.3s;
}
.char-banner:hover .banner-hint { opacity: 1; }

.char-profile-body {
    padding: 0 20px 40px 20px;
    position: relative; /* ä¸ºäº†å®šä½å¤´åƒ */
}

/* ğŸ”¥ å…³é”® CSSï¼šè´Ÿè¾¹è·å®ç°å¤´åƒä¸Šç§» */
.char-profile-avatar-box {
    width: 100px; height: 100px;
    border-radius: 50%;
    border: 4px solid #fff; /* ç™½è‰²è¾¹æ¡†ä¸èƒŒæ™¯éš”å¼€ */
    background: #fff;
    margin: -50px auto 15px auto; /* æ ¸å¿ƒï¼šå‘ä¸Šåç§» 50px */
    position: relative; z-index: 2;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
#char-detail-avatar { width: 100%; height: 100%; object-fit: cover; }

#char-detail-name {
    text-align: center; font-size: 24px; font-weight: 700; color: #000; margin-bottom: 20px;
}

.char-actions {
    display: flex; gap: 15px; justify-content: center; margin-bottom: 10px;
}
.char-btn {
    border: none; padding: 8px 20px; border-radius: 20px;
    font-size: 14px; font-weight: 600; cursor: pointer;
}
.char-btn.edit { background: #e5f1ff; color: #007aff; }
.char-btn.delete { background: #ffeceb; color: #ff3b30; }

.char-desc-text {
    font-size: 15px; line-height: 1.6; color: #333;
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
}

/* --- ä¿®å¤ï¼šè§’è‰²ä¹¦ App é¡¶éƒ¨é¿è®© --- */
#app-characters {
    /* ç»™é¡¶éƒ¨ç•™å‡º 60px çš„ç©ºé—´ï¼Œè®©æ ‡é¢˜æ éœ²å‡ºæ¥ï¼Œä¸å†è¢«çµåŠ¨å²›æŒ¡ä½ */
    padding-top: 60px !important; 
    box-sizing: border-box;
}

/* å¾®è°ƒæ ‡é¢˜æ é—´è·ï¼Œä¿æŒç¾è§‚ */
#app-characters .app-header {
    padding-bottom: 10px !important;
    min-height: auto !important;
}

/* --- ä¿®å¤ï¼šè¯¦æƒ…é¡µå…¨å±è¦†ç›–æ ·å¼ --- */

/* 1. è®©è¯¦æƒ…é¡µç›–ä½æ•´ä¸ª App (åŒ…æ‹¬æ ‡é¢˜æ ) */
.detail-overlay {
    position: absolute; /* ç»å¯¹å®šä½ */
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #fff;
    z-index: 100; /* å±‚çº§è¦é«˜ï¼Œç›–ä½åˆ—è¡¨é¡µ */
    display: none; /* é»˜è®¤éšè— */
    overflow-y: auto; /* å…è®¸æ»šåŠ¨ */
    /* åŠ¨ç”»ï¼šä»å³è¾¹æ»‘å…¥ï¼Œä¸æ»‘é¡ºç•… */
    animation: slideInRight 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

/* 2. è°ƒæ•´ Banner é«˜åº¦ï¼Œè®©å®ƒæ›´å¤§æ°” */
.char-banner {
    width: 100%; 
    height: 280px; /* åŠ é«˜èƒŒæ™¯å›¾ */
    background-color: #eee; 
    background-size: cover; 
    background-position: center;
    position: relative;
}

/* 3. é¡¶éƒ¨é€æ˜å¯¼èˆªæ  (æ ¸å¿ƒ) */
.char-nav-bar {
    position: absolute;
    top: 0; left: 0; width: 100%;
    padding-top: 55px; /* é¿å¼€çµåŠ¨å²›å’ŒçŠ¶æ€æ  */
    padding-left: 20px; padding-right: 20px;
    display: flex; justify-content: space-between;
    z-index: 10;
}

/* 4. æ¯›ç»ç’ƒåœ†å½¢æŒ‰é’® */
.nav-btn-blur {
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: none;
    height: 36px; padding: 0 14px;
    border-radius: 18px;
    display: flex; align-items: center; gap: 4px;
    font-size: 14px; font-weight: 600; color: #000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    cursor: pointer; transition: 0.2s;
}
.nav-btn-blur:active { transform: scale(0.95); background: rgba(255,255,255,0.8); }
.nav-btn-blur.danger { color: #ff3b30; }

/* 5. è°ƒæ•´å¤´åƒä½ç½® (Banner å˜é«˜äº†ï¼Œå¤´åƒä¹Ÿè¦é…åˆ) */
/* è¿™é‡Œå®ç°äº†â€œä¸€åŠåœ¨èƒŒæ™¯ï¼Œä¸€åŠåœ¨å¤–é¢â€ */
.char-profile-avatar-box {
    width: 110px; height: 110px;
    border-radius: 50%;
    border: 4px solid #fff;
    background: #fff;
    /* è´Ÿè¾¹è·æ ¸å¿ƒï¼šå‘ä¸Šåç§» 55px (æ­£å¥½æ˜¯é«˜åº¦çš„ä¸€åŠ) */
    margin: -55px auto 15px auto; 
    position: relative; z-index: 5;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    overflow: hidden;
}

/* --- ä¸–ç•Œä¹¦ App æ ·å¼ --- */

/* 1. åˆ—è¡¨å¸ƒå±€ */
.world-grid {
    display: flex; flex-direction: column; gap: 12px;
}

/* 2. çº¯æ–‡å­—å¡ç‰‡ */
.world-card {
    background: #fff; 
    border-radius: 12px; 
    padding: 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    border-left: 5px solid #007aff; /* å·¦è¾¹åŠ ä¸ªè“æ¡ï¼Œæ›´æœ‰â€œæ¡£æ¡ˆâ€çš„æ„Ÿè§‰ */
    cursor: pointer; 
    transition: 0.2s;
}
.world-card:active { transform: scale(0.98); background: #f2f2f7; }

.world-card-title {
    font-size: 17px; font-weight: 700; color: #000; margin-bottom: 6px;
}
.world-card-preview {
    font-size: 13px; color: #666;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; /* æœ€å¤šæ˜¾ç¤º2è¡Œ */
    line-height: 1.4;
}

/* 3. é¡¶éƒ¨é¿è®© (å’Œä¹‹å‰ä¸€æ ·) */
#app-worldbook {
    padding-top: 60px !important;
    box-sizing: border-box;
}
#app-worldbook .app-header {
    padding-bottom: 10px !important;
    min-height: auto !important;
}

/* --- éŸ³ä¹ App æ ·å¼ --- */

/* 1. é™æ—¶åŠ¨æ€ (Stories) */
.music-stories-area {
    padding: 10px 0;
    overflow: hidden;
}
.stories-scroll {
    display: flex; gap: 15px; padding: 10px 20px;
    overflow-x: auto; scrollbar-width: none;
}
.stories-scroll::-webkit-scrollbar { display: none; }

.story-item {
    display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;
}
.story-avatar {
    width: 60px; height: 60px; border-radius: 50%;
    object-fit: cover; border: 2px solid #e5e5ea; /* æ— åœ†åœˆï¼Œåªæœ‰ç»†è¾¹æ¡† */
    padding: 2px;
}
.story-name { font-size: 11px; color: #000; width: 60px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* 2. æ­Œæ›²åˆ—è¡¨ */
.add-song-btn {
    border: none; background: #e5e5ea; color: #007aff; 
    padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px; cursor: pointer;
}
.music-list-container { padding: 10px 20px; padding-bottom: 80px; }
.song-item {
    display: flex; align-items: center; gap: 12px; padding: 10px 0;
    border-bottom: 1px solid #f2f2f7; cursor: pointer;
}
.song-item:active { opacity: 0.6; }
.song-thumb { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: #eee; }
.song-info { flex: 1; }
.song-title-list { font-size: 16px; font-weight: 600; color: #000; }
.song-artist-list { font-size: 13px; color: #8e8e93; }

/* 3. åº•éƒ¨è¿·ä½ æ’­æ”¾å™¨ (é‡ç‚¹) */
.mini-player-pill {
    position: absolute; bottom: 20px; left: 20px; right: 20px;
    height: 64px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 32px; /* åœ†è§’èƒ¶å›Š */
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 8px;
    z-index: 50; /* æµ®åœ¨åˆ—è¡¨ä¸Š */
    border: 1px solid rgba(0,0,0,0.05);
}
.mini-left { display: flex; align-items: center; gap: 10px; flex: 1; overflow: hidden; }
.mini-cover-img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; animation: spin 10s linear infinite; animation-play-state: paused; }
.playing .mini-cover-img { animation-play-state: running; }
.mini-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
.mini-title { font-size: 14px; font-weight: 600; color: #000; white-space: nowrap; }
.mini-artist { font-size: 12px; color: #666; }
.mini-controls { display: flex; gap: 8px; margin-right: 10px; color: #000; }
.mini-controls button { background: none; border: none; cursor: pointer; padding: 5px; color: inherit; }

/* 4. å…¨å±æ’­æ”¾å™¨ */
.player-blur-bg {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center;
    filter: blur(40px) brightness(0.7); /* æ¨¡ç³Šå˜æš— */
    z-index: -1; transform: scale(1.2);
}
.nav-btn-icon {
    background: rgba(255,255,255,0.2); border: none; width: 36px; height: 36px; border-radius: 50%;
    color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.player-header-title { color: #fff; font-weight: 600; font-size: 16px; opacity: 0.9; }

.player-main-body {
    padding: 20px 30px; display: flex; flex-direction: column; height: 80%; justify-content: space-evenly;
}
.player-cover-box {
    width: 100%; aspect-ratio: 1/1; 
    border-radius: 20px; overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    margin-bottom: 20px;
}
#full-cover { width: 100%; height: 100%; object-fit: cover; }

.player-info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.full-title { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px; }
.full-artist { font-size: 18px; color: rgba(255,255,255,0.7); }

.player-progress-container { width: 100%; margin-bottom: 30px; }
.time-labels { display: flex; justify-content: space-between; color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 5px; }
/* è‡ªå®šä¹‰è¿›åº¦æ¡ */
input[type=range]::-webkit-slider-runnable-track { background: rgba(255,255,255,0.3); height: 4px; border-radius: 2px; }
input[type=range]::-webkit-slider-thumb { background: #fff; margin-top: -6px; }

.player-controls-row { display: flex; justify-content: space-between; align-items: center; color: #fff; }
.ctrl-btn-small { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 20px; cursor: pointer; }
.ctrl-btn-medium { background: none; border: none; color: #fff; cursor: pointer; }
.ctrl-btn-medium svg { width: 35px; height: 35px; }
.ctrl-btn-large { background: none; border: none; color: #fff; cursor: pointer; transform: scale(1); transition: 0.2s; }
.ctrl-btn-large svg { width: 70px; height: 70px; }
.ctrl-btn-large:active { transform: scale(0.9); }

/* 5. æ’­æ”¾åˆ—è¡¨æŠ½å±‰ */
.playlist-drawer {
    position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
    background: rgba(30,30,30,0.95); border-radius: 24px 24px 0 0;
    transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 200; display: flex; flex-direction: column; padding: 20px;
}
.playlist-drawer.show { transform: translateY(0); }
.drawer-header { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 15px; }
.drawer-list-content { flex: 1; overflow-y: auto; }
.drawer-item { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #fff; cursor: pointer; display: flex; justify-content: space-between; }
.drawer-item.active { color: #34c759; }
.drawer-close { margin-top: 15px; background: rgba(255,255,255,0.1); border: none; padding: 12px; width: 100%; border-radius: 12px; color: #fff; font-weight: 600; cursor: pointer; }

/* =========================================
   === âš¡ï¸ æœ€ç»ˆä¿®å¤ï¼šMusic App å¸ƒå±€è°ƒæ•´ ===
   ========================================= */

/* --- 1. ä¿®å¤ Music ä¸»é¡µæ ‡é¢˜è¢«æŒ¡ä½ --- */
#app-music {
    /* ç»™é¡¶éƒ¨ç•™å‡ºç©ºé—´ï¼Œè®© "Music" æ ‡é¢˜ä¸‹æ¥ */
    padding-top: 60px !important; 
    box-sizing: border-box;
}
#app-music .app-header {
    padding-bottom: 5px !important;
    min-height: auto !important;
    background: transparent; /* ä¿æŒé€šé€ */
}

/* --- 2. ä¿®å¤å…¨å±æ’­æ”¾å™¨ (å†…å®¹æŒ¤åœ¨ä¸€èµ·) --- */

/* A. è°ƒæ•´é¡¶éƒ¨å¯¼èˆªæ  ("Now Playing" é‚£ä¸€è¡Œ) */
#full-player .char-nav-bar {
    padding-top: 60px !important; /* å¾€ä¸‹æŒªï¼Œé¿å¼€çµåŠ¨å²› */
    height: auto !important;
    min-height: 50px;
    position: absolute; /* ç»å¯¹å®šä½åœ¨é¡¶éƒ¨ */
    top: 0; left: 0; width: 100%;
    z-index: 10; /* ä¿è¯åœ¨æœ€ä¸Šé¢ */
}

/* B. è°ƒæ•´ä¸­é—´å†…å®¹åŒº (æŠŠå°é¢å›¾å¾€ä¸‹æ¨) */
.player-main-body {
    /* å…³é”®ï¼šç»™é¡¶éƒ¨å¯¼èˆªæ ç•™å‡º 110px çš„ç©ºé—´ï¼Œä¸ç„¶å°é¢ä¼šé¡¶ä¸Šå» */
    padding-top: 90px !important; 
    padding-bottom: 40px !important;
    height: 100%;
    box-sizing: border-box;
    
    /* å¸ƒå±€è°ƒæ•´ï¼šç´§å‡‘æ’åˆ—ï¼Œä¸è¦æ‹‰å¾—å¤ªå¼€ */
    justify-content: flex-start !important; 
    gap: 20px; /* å…ƒç´ ä¹‹é—´çš„é—´è· */
}

/* C. ä¼˜åŒ–å°é¢å›¾æ ·å¼ (æ²¡å›¾æ—¶ä¹Ÿè¦å¥½çœ‹) */
.player-cover-box {
    width: 100%;
    max-width: 320px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå‚»å¤§ */
    aspect-ratio: 1/1; /* ä¿æŒæ­£æ–¹å½¢ */
    margin: 60px auto 0 auto !important;
    border-radius: 20px;
    background: rgba(255,255,255,0.1); /* æ²¡å›¾æ—¶çš„å ä½èƒŒæ™¯ */
    box-shadow: 0 15px 40px rgba(0,0,0,0.4); /* åŠ æ·±é˜´å½±ï¼Œæ›´æœ‰è´¨æ„Ÿ */
}

/* D. ä¼˜åŒ–ä¸‹æ–¹æ–‡å­—åŒºåŸŸ */
.player-info-row {
    margin-top: 10px;
    padding: 0 10px;
}

/* --- ä¿®å¤ï¼šæ’­æ”¾åˆ—è¡¨æŠ½å±‰ (å½»åº•éšè—) --- */
.playlist-drawer {
    /* 1. æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ä¸º fixedï¼Œé’‰æ­»åœ¨å±å¹•çª—å£ä¸Šï¼Œä¸éšé¡µé¢æ»šåŠ¨ */
    position: fixed !important; 
    bottom: 0;
    left: 0;
    width: 100%;
    height: 60vh; /* å æ®å±å¹• 60% é«˜åº¦ */
    
    /* 2. åˆå§‹çŠ¶æ€ï¼šå®Œå…¨ç§»å‡ºå±å¹•ä¸‹æ–¹ */
    transform: translateY(110%); /* ç§»åˆ° 110% å¤„ï¼Œä¿è¯å®Œå…¨çœ‹ä¸è§ */
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); /* ä¸æ»‘åŠ¨ç”» */
    
    /* 3. å¤–è§‚æ ·å¼ */
    background: rgba(28, 28, 30, 0.96);
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border-radius: 24px 24px 0 0;
    z-index: 99999; /* ä¿è¯å±‚çº§æœ€é«˜ï¼Œç›–ä½æ‰€æœ‰ä¸œè¥¿ */
    display: flex; 
    flex-direction: column; 
    padding: 20px;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.5); /* é¡¶éƒ¨åŠ æ·±é˜´å½± */
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ»‘ä¸Šæ¥ */
.playlist-drawer.show {
    transform: translateY(0) !important;
}

/* åˆ—è¡¨å†…å®¹åŒºåŸŸ */
.drawer-list-content {
    flex: 1;
    overflow-y: auto; /* åªæœ‰åˆ—è¡¨å†…éƒ¨å¯ä»¥æ»šåŠ¨ */
    margin-top: 10px;
}

/* è§£å†³å…¨å±æ’­æ”¾å™¨æœ¬èº«çš„æ»šåŠ¨æº¢å‡ºé—®é¢˜ */
#full-player {
    overflow: hidden !important; /* ç¦æ­¢æ’­æ”¾å™¨é¡µé¢æ•´ä½“æ»šåŠ¨ï¼Œåªå…è®¸å†…éƒ¨å…ƒç´ åŠ¨ */
}

/* --- âš¡ï¸ æœ€ç»ˆå¸ƒå±€ä¿®å¤ï¼šå¡«è¡¥åº•éƒ¨ç©ºç¼º --- */

/* 1. ä¸»å®¹å™¨ï¼šæ”¹æˆâ€œåº•éƒ¨å¯¹é½â€æ¨¡å¼ */
.player-main-body {
    /* ç»™é¡¶éƒ¨ç•™ç©ºï¼Œé¿å¼€æ ‡é¢˜æ  */
    padding-top: 100px !important; 
    /* ç»™åº•éƒ¨ç•™ç©ºï¼Œåˆ«è´´ç€å±å¹•è¾¹ç¼˜ */
    padding-bottom: 50px !important; 
    
    height: 100%;
    display: flex;
    flex-direction: column;
    
    /* æ ¸å¿ƒæ”¹åŠ¨ï¼šå…ˆæŠŠæ‰€æœ‰ä¸œè¥¿æ¨åˆ°åº•éƒ¨ï¼Œç„¶åç”¨å°é¢å›¾å»é¡¶ */
    justify-content: flex-end !important; 
    gap: 15px; /* å…ƒç´ ä¹‹é—´çš„é—´è·ç¨å¾®ç´§å‡‘ç‚¹ */
}

/* 2. å°é¢å›¾ï¼šè‡ªåŠ¨æŠŠä¸Šé¢æ’‘æ»¡ */
.player-cover-box {
    /* æ ¸å¿ƒé­”æ³•ï¼šmargin-bottom: auto ä¼šè‡ªåŠ¨å æ®å‰©ä½™çš„æ‰€æœ‰ç©ºé—´ï¼ŒæŠŠä¸‹é¢çš„ä¸œè¥¿å‹åˆ°åº•éƒ¨ */
    margin-bottom: auto !important; 
    
    width: 100%;
    max-width: 340px; /* ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ */
    aspect-ratio: 1/1;
    align-self: center; /* å·¦å³å±…ä¸­ */
    
    /* åŠ ç‚¹é˜´å½±ï¼Œæ›´æœ‰è´¨æ„Ÿ */
    box-shadow: 0 20px 50px rgba(0,0,0,0.5) !important;
}

/* 3. æ­Œæ›²ä¿¡æ¯åŒº */
.player-info-row {
    margin-bottom: 10px !important;
    padding: 0 10px;
}

/* 4. è¿›åº¦æ¡åŒºåŸŸ */
.player-progress-container {
    margin-bottom: 10px !important; /* ç¨å¾®æ‹‰è¿‘ä¸€ç‚¹ */
}

/* 5. æŒ‰é’®åŒºåŸŸ */
.player-controls-row {
    /* ç¡®ä¿æŒ‰é’®å‚ç›´å±…ä¸­ */
    padding-bottom: 10px; 
}

/* --- ä¿®å¤ï¼šè¿›åº¦æ¡æ ·å¼ (å·¦ç™½å³ç°) --- */

/* 1. æ¸…é™¤é»˜è®¤æ ·å¼ï¼Œè®¾ç½®åŸºç¡€è½¨é“ */
#music-seek-slider {
    -webkit-appearance: none; /* æ¸…é™¤ Webkit é»˜è®¤æ ·å¼ */
    width: 100%;
    height: 4px;
    border-radius: 2px;
    outline: none;
    margin: 0;
    /* å…³é”®ï¼šä½¿ç”¨ CSS å˜é‡æ¥æ§åˆ¶è¿›åº¦ï¼Œåˆå§‹ä¸º 0% */
    background: linear-gradient(to right, #ffffff var(--seek-before-width, 0%), rgba(255, 255, 255, 0.3) var(--seek-before-width, 0%));
}

/* 2. è‡ªå®šä¹‰æ»‘å— (Thumb) */
#music-seek-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 12px;
    width: 12px;
    border-radius: 50%;
    background: #ffffff;
    cursor: pointer;
    /* è°ƒæ•´æ»‘å—ä½ç½®ä½¿å…¶å‚ç›´å±…ä¸­ */
    margin-top: -4px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Firefox å…¼å®¹ (å¦‚æœéœ€è¦) */
#music-seek-slider::-moz-range-thumb { height: 12px; width: 12px; border:none; border-radius: 50%; background: #fff; }

/* --- æ­Œè¯æ˜¾ç¤ºåŒºæ ·å¼ --- */
.lyrics-container {
    width: 100%;
    height: 60px; /* é«˜åº¦é€‚ä¸­ï¼Œæ˜¾ç¤ºä¸¤è¡Œå·¦å³ */
    margin-bottom: 10px; /* å’Œä¸‹é¢æ­Œåæ‹‰å¼€è·ç¦» */
    position: relative;
    cursor: pointer;
    overflow: hidden;
    /* æ ¸å¿ƒï¼šä¸Šä¸‹è¾¹ç¼˜æ¸å˜é®ç½©ï¼Œåˆ¶é€ â€œæ»šç­’â€æ•ˆæœ */
    mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
}

.lyrics-content {
    text-align: center;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* æ»šåŠ¨åŠ¨ç”» */
    padding-top: 20px; /* åˆå§‹åç§» */
}

.lyric-line {
    font-size: 15px;
    color: rgba(255, 255, 255, 0.5); /* æœªæ¿€æ´»æ­Œè¯æ·¡è‰² */
    margin-bottom: 8px;
    font-weight: 500;
    transition: all 0.3s;
    min-height: 20px; /* é˜²æ­¢ç©ºè¡Œæ²¡é«˜åº¦ */
}

/* æ¿€æ´»çš„é‚£ä¸€è¡Œæ­Œè¯ï¼šå˜äº®ã€æ”¾å¤§ */
.lyric-line.active {
    color: #fff;
    font-size: 17px;
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    transform: scale(1.05);
}

/* --- âš¡ï¸ é€å­—æ¸²æŸ“æ ¸å¿ƒæ ·å¼ --- */

/* 1. æ•´è¡Œå®¹å™¨ */
.lyric-line {
    font-size: 16px;
    color: rgba(255, 255, 255, 0.3); /* æ²¡å”±åˆ°çš„å­—æ˜¯å¾ˆæš—çš„ */
    margin-bottom: 12px;
    font-weight: 500;
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); /* æ»šåŠ¨è¦ä¸æ»‘ */
    min-height: 24px;
    padding: 0 20px; /* ç»™ç‚¹å·¦å³è¾¹è· */
    white-space: pre-wrap; /* å…è®¸æ¢è¡Œ */
}

/* 2. æ¿€æ´»è¡Œçš„æ•´ä½“çŠ¶æ€ (ç¨å¾®æ”¾å¤§) */
.lyric-line.active {
    transform: scale(1.1); /* æ¿€æ´»æ—¶æ•´ä½“æ”¾å¤§ä¸€ç‚¹ç‚¹ */
}

/* 3. å•ä¸ªå­—çš„æ ·å¼ */
.lyric-char {
    display: inline-block; /* å¿…é¡»æ˜¯ inline-block æ‰èƒ½åº”ç”¨åŠ¨ç”» */
    transition: color 0.2s, text-shadow 0.2s; /* é¢œè‰²å˜åŒ–è¦æœ‰è¿‡æ¸¡ */
}

/* 4. å•ä¸ªå­—è¢«ç‚¹äº®çš„çŠ¶æ€ */
.lyric-char.lit {
    color: #fff; /* å˜ç™½ */
    font-weight: 700;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.6), 0 0 20px rgba(0, 122, 255, 0.4); /* åŠ ç‚¹è“è‰²å…‰æ™•ï¼Œè¶…é«˜çº§ */
}

/* --- ä¿®å¤ï¼šåˆ—è¡¨æŒ‰é’® & åº•éƒ¨èœå• --- */

/* 1. åˆ—è¡¨å³ä¾§æŒ‰é’®ç»„ */
.song-right-actions {
    display: flex; align-items: center; gap: 8px;
}
.list-btn {
    border: none; background: rgba(0,0,0,0.05); 
    width: 32px; height: 32px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center;
    color: #007aff; cursor: pointer; transition: 0.2s;
}
.list-btn:active { background: rgba(0,0,0,0.1); transform: scale(0.95); }
.list-btn.more { color: #8e8e93; background: transparent; }

/* 2. åº•éƒ¨åŠ¨ä½œèœå• (Action Sheet) */
.action-sheet {
    width: 100%; background: #fff;
    border-radius: 20px 20px 0 0;
    overflow: hidden;
    animation: slideUpSheet 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }

.action-header {
    text-align: center; padding: 15px; font-size: 13px; color: #8e8e93; border-bottom: 1px solid #e5e5ea;
}
.action-btn {
    width: 100%; padding: 16px; border: none; background: #fff;
    font-size: 17px; color: #007aff; cursor: pointer;
    border-bottom: 1px solid #f2f2f7; text-align: center;
}
.action-btn:active { background: #f2f2f7; }
.action-btn.danger { color: #ff3b30; }
.action-btn.cancel { font-weight: 600; border-bottom: none; }

/* =============================================
   === âš¡ï¸ çµåŠ¨å²›ç»ˆæä¿®å¤æ ·å¼ (ç™½è‰²ç‰ˆ + åœ†å½¢å°é¢) ===
   ============================================= */

/* 1. åŸºç¡€å®¹å™¨ */
.smart-capsule-base {
    position: fixed !important;
    top: 11px; left: 50%; transform: translateX(-50%);
    z-index: 100000 !important;
    width: 120px; height: 35px;
    background: #000; border-radius: 20px;
    color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: width 0.4s cubic-bezier(0.2, 0.9, 0.2, 1.1), 
                height 0.4s cubic-bezier(0.2, 0.9, 0.2, 1.1), 
                border-radius 0.4s, background 0.3s;
    overflow: hidden;
    display: flex; flex-direction: column; align-items: center;
}

/* 2. å±•å¼€çŠ¶æ€ (ç™½åº•å¤§å¡ç‰‡) */
.smart-capsule-base.expanded {
    width: 360px !important;
    height: 420px !important; /* é«˜åº¦è¶³å¤Ÿè£…ä¸‹æ‰€æœ‰ä¸œè¥¿ */
    border-radius: 40px !important;
    background: rgba(255, 255, 255, 0.95) !important; /* ç™½åº• */
    backdrop-filter: blur(50px);
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
}

/* 3. å¼ºåˆ¶å†…éƒ¨æ–‡å­—å˜é»‘ */
.smart-capsule-base.expanded .capsule-expanded { color: #000 !important; }
.smart-capsule-base.expanded svg { fill: #000 !important; color: #000 !important; }

/* 4. å†…éƒ¨å¸ƒå±€å®¹å™¨ */
.capsule-expanded {
    width: 100%; height: 100%; padding: 30px 20px;
    display: flex; flex-direction: column; 
    align-items: center; justify-content: space-between;
    opacity: 0; transition: opacity 0.3s 0.1s; pointer-events: none;
}
.smart-capsule-base.expanded .capsule-expanded { opacity: 1; pointer-events: auto; }

/* 5. å°é¢ (å…³é”®ä¿®å¤ï¼šé˜²æ­¢å˜æ¤­åœ†) */
.island-cover-wrapper {
    width: 160px; height: 160px;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    border: 4px solid rgba(240,240,240,0.5);
    margin-top: 10px;
    
    /* âœ…âœ…âœ… æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢è¢«æŒ¤æ‰ âœ…âœ…âœ… */
    flex-shrink: 0 !important; 
}
#island-cover { width: 100%; height: 100%; object-fit: cover; }

/* 6. ä¿¡æ¯åŒº */
.island-info-box { text-align: center; margin-top: 5px; flex-shrink: 0; }
.island-title { font-size: 22px; font-weight: 800; margin-bottom: 2px; color: #000; }
.island-artist { font-size: 15px; opacity: 0.6 !important; color: #000; }

/* 7. æ­Œè¯ & è¿›åº¦ */
.island-lyrics-area { height: 24px; display: flex; align-items: center; justify-content: center; width: 100%; margin: 5px 0; }
.island-lyric-line { font-size: 14px; font-weight: 700; color: #34c759 !important; text-shadow: none !important; }

.island-progress-box { width: 100%; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
.island-time { font-size: 11px; opacity: 0.5 !important; width: 30px; color: #000; font-weight: 600; }
#island-seek-slider { flex: 1; height: 5px; border-radius: 3px; background: rgba(0,0,0,0.1) !important; }

/* 8. æŒ‰é’®ç»„ (å…³é”®ä¿®å¤ï¼šå»è¾¹æ¡†) */
.island-controls { 
    width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; 
}
.island-btn { 
    background: transparent !important; /* âŒ å»èƒŒæ™¯ */
    border: none !important;            /* âŒ å»è¾¹æ¡† */
    box-shadow: none !important;        /* âŒ å»é˜´å½± */
    padding: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.island-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.05) !important; border-radius: 50%; }
.island-btn svg { width: 28px; height: 28px; fill: #000; }
.island-btn.play svg { width: 55px; height: 55px; }

/* ==================================================
   === ğŸš¨ ç´§æ€¥å¼ºåˆ¶ä¿®å¤ (Fix Z-Index & Borders) ===
   ================================================== */

/* 1. å¼ºåˆ¶æå‡åˆ—è¡¨å¼¹çª—å±‚çº§ (è®©å®ƒæµ®åœ¨çµåŠ¨å²›ä¸Šé¢) */
#modal-island-list {
    z-index: 2147483647 !important; /* CSSå…è®¸çš„æœ€å¤§å€¼ï¼Œç»å¯¹ç½®é¡¶ */
}

/* 2. ä¿®æ­£å°é¢å˜å½¢ (å¼ºåˆ¶æ­£åœ†) */
.island-cover-wrapper {
    width: 160px !important;
    height: 160px !important;
    min-width: 160px !important; /* é˜²æ­¢è¢«æŒ¤å‹ */
    min-height: 160px !important;
    border-radius: 50% !important;
    aspect-ratio: 1 / 1 !important; /* å¼ºåˆ¶ 1:1 æ¯”ä¾‹ */
    flex-shrink: 0 !important; /* ç¦æ­¢ç¼©æ”¾ */
    margin-top: 15px !important;
}

/* 3. æš´åŠ›å»é™¤æŒ‰é’®è¾¹æ¡† (è§£å†³é‚£ä¸ªä¸‘æ–¹æ¡†) */
.island-btn {
    background: transparent !important;
    border: 0 none !important;
    outline: none !important;
    box-shadow: none !important;
    -webkit-appearance: none !important; /* é’ˆå¯¹ Safari/Chrome */
    appearance: none !important;
}

/* 4. è°ƒæ•´å¼¹çª—ä½ç½® (è®©å®ƒå±…ä¸­æ˜¾ç¤ºï¼Œä¸è¦è´´ç€ä¸Šé¢) */
#modal-island-list .modal-body {
    position: relative !important;
    top: auto !important;
    bottom: auto !important;
    margin: auto !important; /* å±…ä¸­ */
    max-height: 500px !important;
    width: 85% !important;
    background: #fff !important;
    color: #000 !important; /* ç¡®ä¿åˆ—è¡¨æ–‡å­—æ˜¯é»‘è‰²çš„ */
    border-radius: 20px !important;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5) !important;
}

/* 5. ç¡®ä¿åˆ—è¡¨æ–‡å­—æ¸…æ™° */
#island-list-container div {
    color: #333 !important; /* å¼ºåˆ¶åˆ—è¡¨æ–‡å­—å˜é»‘ */
}
#island-list-container div span {
    color: #333 !important;
}
/* é€‰ä¸­é¡¹é«˜äº® */
#island-list-container .active {
    color: #007aff !important;
    background: #f5f5f7 !important;
}

/* ==================================================
   === ğŸš¨ åº•éƒ¨è¿·ä½ æ’­æ”¾å™¨å›¾æ ‡å¼ºåˆ¶æ˜¾å½¢ä¿®å¤ ===
   ================================================== */

/* 1. å¼ºåˆ¶æ‰€æœ‰è¿·ä½ æ’­æ”¾å™¨çš„å›¾æ ‡éƒ½æœ‰å°ºå¯¸ */
.mini-controls svg {
    width: 24px !important;
    height: 24px !important;
    min-width: 24px !important; /* é˜²æ­¢æŒ¤å‹ */
    min-height: 24px !important;
    display: block !important;
    fill: currentColor !important; /* è·Ÿéšæ–‡å­—é¢œè‰² */
}

/* 2. è®©ä¸­é—´çš„æ’­æ”¾æŒ‰é’®ç¨å¾®å¤§ä¸€ç‚¹ï¼Œæ›´æ˜¾çœ¼ */
#mini-play-btn svg {
    width: 32px !important;
    height: 32px !important;
    min-width: 32px !important;
    min-height: 32px !important;
}

/* 3. ç¡®ä¿æŒ‰é’®å®¹å™¨ flex å¸ƒå±€å±…ä¸­ï¼Œé˜²æ­¢å›¾æ ‡è·‘å */
.mini-controls button {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 44px !important; /* å¢å¤§ç‚¹å‡»çƒ­åŒº */
    height: 44px !important;
    padding: 0 !important;
}

/* 4. å¼ºåˆ¶é¢œè‰²ä¸ºé»‘è‰² (é˜²æ­¢è¢«å…¨å±€ç™½è‰²æ ·å¼å½±å“) */
.mini-controls {
    color: #000000 !important;
}

/* =========================================
   === ğŸ’¬ èŠå¤© App ä¸“å±æ ·å¼ ===
   ========================================= */

/* 1. åŸºç¡€å¸ƒå±€ */
#app-chat .app-body {
    background: #fff; /* çº¯ç™½èƒŒæ™¯ */
}

/* 2. åœ¨çº¿å¥½å‹ (æ¨ªå‘æ»šåŠ¨) */
.online-users-area {
    padding: 10px 0;
    margin-bottom: 10px;
}
.online-scroll {
    display: flex; gap: 15px; padding: 10px 20px;
    overflow-x: auto; scrollbar-width: none;
}
.online-scroll::-webkit-scrollbar { display: none; }

.online-item {
    display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer;
    position: relative;
}
/* å¤´åƒå®¹å™¨ */
.online-avatar-box {
    width: 64px; height: 64px;
    border-radius: 50%;
    padding: 3px; /* ç•™å‡ºç©ºéš™ */
    background: transparent;
    position: relative;
}
/* å‘¼å¸ç¯å…‰ç¯æ•ˆæœ */
.online-avatar-box::before {
    content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50%;
    border: 2px solid #34c759; /* ç»¿è‰²åœ¨çº¿æ¡† */
    opacity: 0.6;
}
.online-avatar-img {
    width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
    border: 2px solid #fff; /* ç™½è‰²å†…æè¾¹ */
}
/* ç»¿ç‚¹ */
.online-dot {
    position: absolute; bottom: 2px; right: 2px;
    width: 14px; height: 14px; background: #34c759;
    border: 2px solid #fff; border-radius: 50%;
    z-index: 2;
}
.online-name { font-size: 11px; color: #333; width: 64px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }

/* 3. èŠå¤©åˆ—è¡¨ç©ºçŠ¶æ€ */
.chat-list-container {
    padding: 20px; display: flex; justify-content: center; align-items: center;
    min-height: 200px;
}
.empty-state { text-align: center; margin-top: 50px; }

/* 4. åº•éƒ¨æ¶²æ€å¯¼èˆªæ  (Liquid Glass) */
.chat-tab-bar {
    position: absolute; bottom: 30px; left: 30px; right: 30px;
    height: 70px;
    
    /* æ¶²æ€ç»ç’ƒæ ¸å¿ƒ */
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    
    border-radius: 35px; /* å¤§åœ†è§’ */
    display: flex; justify-content: space-around; align-items: center;
    z-index: 100;
}

.chat-tab-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; color: #c7c7cc; /* é»˜è®¤ç°è‰² */
    cursor: pointer; transition: 0.3s;
    width: 60px;
}
.chat-tab-item svg { width: 26px; height: 26px; transition: 0.3s; }
.chat-tab-item span { font-size: 10px; font-weight: 600; transform: scale(0.9); transition: 0.3s; }

/* æ¿€æ´»çŠ¶æ€ */
.chat-tab-item.active { color: #007aff; /* è“è‰² */ }
.chat-tab-item.active svg { transform: translateY(-2px); }
.chat-tab-item:active { transform: scale(0.95); }

/* ==================================================
   === ğŸš¨ èŠå¤© App å¸ƒå±€å¼ºåˆ¶ä¿®å¤ (Header & TabBar) ===
   ================================================== */

/* 1. å¤´éƒ¨é¿è®©ï¼šç»™çµåŠ¨å²›ç•™å‡ºè¶³å¤Ÿçš„ç©ºé—´ */
#app-chat .app-header {
    padding-top: 70px !important; /* ğŸ‘‡ å…³é”®ï¼šå¾€ä¸‹æ¨ 70px */
    padding-bottom: 10px !important;
    height: auto !important;
    min-height: 100px !important; /* ä¿è¯å¤´éƒ¨é«˜åº¦è¶³å¤Ÿ */
    display: flex !important;
    align-items: flex-end !important; /* æ–‡å­—é ä¸‹å¯¹é½ */
    background: #fff !important; /* çº¯ç™½èƒŒæ™¯ */
    z-index: 500 !important;
}

/* 2. ä¿®æ­£æ ‡é¢˜å’Œå…³é—­æŒ‰é’®çš„ä½ç½® */
#app-chat .app-title {
    font-size: 30px !important;
    line-height: 1 !important;
    margin-bottom: 5px !important;
}
#chat-close-btn {
    margin-bottom: 5px !important; /* å¯¹é½æ ‡é¢˜ */
    background: #f2f2f7 !important;
    color: #007aff !important;
}

/* 3. åº•éƒ¨å¯¼èˆªæ ï¼šå¼ºåˆ¶å›ºå®šåœ¨åº•éƒ¨ä¸­å¤® */
.chat-tab-bar {
    position: absolute !important; /* ç»å¯¹å®šä½ */
    bottom: 30px !important;       /* è·ç¦»åº•éƒ¨ 30px */
    left: 50% !important;          /* æ°´å¹³å±…ä¸­èµ·ç‚¹ */
    transform: translateX(-50%) !important; /* ä¿®æ­£å±…ä¸­ */
    width: 90% !important;         /* å®½åº¦ */
    max-width: 360px !important;
    height: 70px !important;
    
    /* æ ·å¼ç¾åŒ– */
    background: rgba(255, 255, 255, 0.85) !important;
    backdrop-filter: blur(25px) !important;
    border-radius: 35px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
    border: 1px solid rgba(255,255,255,0.5) !important;
    z-index: 9999 !important;      /* æµ®åœ¨æœ€ä¸Šé¢ */
    
    /* å†…éƒ¨å¸ƒå±€ */
    display: flex !important;
    justify-content: space-around !important;
    align-items: center !important;
}

/* 4. ç»™å†…å®¹åŒºåº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢å†…å®¹è¢«å¯¼èˆªæ æŒ¡ä½ */
#app-chat .app-body {
    padding-bottom: 120px !important; /* å¤šç•™ç‚¹ç©ºé—´ç»™åº•éƒ¨å¯¼èˆª */
    overflow-y: auto !important;
    height: 100% !important;
}

/* =========================================
   === ğŸ“‡ å¥½å‹çŠ¶æ€åç‰‡ (Status Card) ===
   ========================================= */

/* 1. å¡ç‰‡ä¸»ä½“ */
.status-card-body {
    width: 300px;
    background: rgba(255, 255, 255, 0.8); /* åŠé€æ˜ç™½ */
    backdrop-filter: blur(40px); /* å¼ºæ¯›ç»ç’ƒ */
    border-radius: 35px;
    padding: 30px 20px;
    display: flex; flex-direction: column; align-items: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    border: 1px solid rgba(255,255,255,0.6);
    position: relative;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* 2. å…³é—­æŒ‰é’® */
.status-close-btn {
    position: absolute; top: 15px; right: 15px;
    width: 30px; height: 30px; border-radius: 50%;
    background: rgba(0,0,0,0.05); border: none;
    font-size: 20px; color: #666; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
}

/* 3. å¤´åƒä¸å‘¼å¸ç¯ */
.status-avatar-container {
    position: relative; margin-bottom: 15px;
    width: 100px; height: 100px;
}
.status-card-img {
    width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
    border: 4px solid #fff; position: relative; z-index: 2;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
/* å‘¼å¸å…‰ç¯åŠ¨ç”» */
.status-glow-ring {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%; border: 3px solid #34c759;
    animation: pulse-green 2s infinite; z-index: 1;
}
@keyframes pulse-green {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(1.4); opacity: 0; }
}
/* å®ä½“ç»¿ç‚¹ */
.status-online-badge {
    position: absolute; bottom: 5px; right: 5px;
    width: 20px; height: 20px; background: #34c759;
    border: 3px solid #fff; border-radius: 50%; z-index: 3;
}

/* 4. æ–‡å­—ä¿¡æ¯ */
.status-info { text-align: center; margin-bottom: 25px; }
#status-card-name { font-size: 22px; font-weight: 800; margin-bottom: 5px; color: #000; }
.status-bio { font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 500; }
.status-pill { 
    display: inline-block; padding: 4px 12px; 
    background: #e8f5e9; color: #34c759; 
    font-size: 11px; font-weight: 700; border-radius: 12px; 
}

/* 5. åº•éƒ¨æŒ‰é’®ç»„ */
.status-actions-row {
    display: flex; gap: 25px; justify-content: center; width: 100%;
}
.status-action-btn {
    background: none; border: none; cursor: pointer;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
}
/* --- ä¿®å¤ï¼šçŠ¶æ€åç‰‡å›¾æ ‡å¾®è°ƒ --- */
.icon-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

/* æ¶ˆæ¯å›¾æ ‡ï¼šè“åº•ç™½çº¿ */
.icon-circle.msg { 
    background: #007aff !important; 
    color: #fff !important; 
}

/* ç”µè¯å’Œè§†é¢‘ï¼šç™½åº•é»‘çº¿ */
.icon-circle.call, .icon-circle.video { 
    background: rgba(255,255,255,0.9) !important; 
    color: #000 !important; 
    border: 1px solid rgba(0,0,0,0.05);
}

/* å¼ºåˆ¶ SVG ç»§æ‰¿çˆ¶çº§é¢œè‰² */
.icon-circle svg {
    stroke: currentColor; 
}

.status-action-btn span { font-size: 11px; color: #999; font-weight: 500; }
.status-action-btn:active .icon-circle { transform: scale(0.9); }

/* åˆ—è¡¨é¡µé¡¶éƒ¨å¯¼èˆª */
.list-tab-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 20px; border-bottom: 1px solid #eee; background: #fff;
}
.list-tabs { display: flex; gap: 20px; }
.list-tab { font-size: 16px; color: #888; cursor: pointer; padding-bottom: 5px; }
.list-tab.active { color: #007aff; border-bottom: 2px solid #007aff; font-weight: bold; }
.list-add-btn { color: #007aff; cursor: pointer; }

/* åŠ å·å¼¹å‡ºèœå• */
.add-menu-pop {
    position: absolute; top: 110px; right: 20px; 
    background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
    border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    display: none; z-index: 100; border: 1px solid #eee;
}
.menu-item { padding: 12px 20px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee; }
.menu-item:last-child { border: none; }
.menu-item:active { background: #f0f0f0; }

/* å¼¹çª—ç»†èŠ‚ */
.ios-modal { width: 85%; background: #fff; border-radius: 20px; padding: 20px; }
.create-options { display: flex; gap: 10px; margin-bottom: 20px; }
.create-options button { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #007aff; background: #fff; color: #007aff; }
.input-group { margin-top: 15px; text-align: left; }
.input-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-top: 5px; }
.modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.modal-btns button.primary { background: #007aff; color: #fff; border: none; padding: 8px 20px; border-radius: 8px; }

/* --- åˆ—è¡¨é¡µé¡¶éƒ¨å¸ƒå±€ --- */
.chat-list-header {
    padding: 60px 20px 10px 20px; /* é¿å¼€çµåŠ¨å²› */
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
}

/* é¡¶éƒ¨åŠ å·æŒ‰é’® */
.list-add-btn-top {
    width: 36px;
    height: 36px;
    background: #f2f2f7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #007aff;
    cursor: pointer;
    transition: 0.2s;
}
.list-add-btn-top:active { transform: scale(0.9); background: #e5e5ea; }

/* âœ… æ¶²æ€ç»ç’ƒå­å¯¼èˆªæ ·å¼ (å±…ä¸­æ‚¬æµ®) */
.liquid-sub-nav-container {
    width: 100%;
    display: flex;
    justify-content: center;
    padding: 10px 0;
    background: #fff;
}

.liquid-sub-nav {
    display: flex;
    background: rgba(242, 242, 247, 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 4px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    gap: 5px;
}

.sub-nav-item {
    padding: 6px 20px;
    font-size: 14px;
    font-weight: 600;
    color: #8e8e93;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.sub-nav-item.active {
    background: #fff;
    color: #000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* å¼¹å‡ºèœå•å®šä½ä¿®æ­£ (ç´§è´´é¡¶éƒ¨åŠ å·) */
.add-menu-pop {
    position: absolute;
    top: 105px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    display: none;
    z-index: 1000;
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

/* --- 1. å¼ºåˆ¶æ¸…ç†ï¼šåˆ—è¡¨é¡µæ˜¾ç¤ºæ—¶ï¼Œä¿®æ”¹ä¸» Header å¸ƒå±€ --- */
#app-chat .app-header {
    position: relative !important;
    padding-top: 60px !important;
    min-height: 110px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding-right: 20px !important;
}

/* --- 2. éšè—åˆ—è¡¨é¡µå†…éƒ¨å¤šä½™çš„æ ‡é¢˜å®¹å™¨ (å¦‚æœæœ‰) --- */
.chat-list-header { display: none !important; }

/* --- 3. å¼ºåˆ¶åŠ å·æŒ‰é’®ä½ç½® --- */
.list-add-btn-top {
    width: 36px !important;
    height: 36px !important;
    background: #f2f2f7 !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: #007aff !important;
    cursor: pointer !important;
    /* æ‚¬æµ®åœ¨å³ä¸Šè§’ */
    position: absolute !important;
    right: 20px !important;
    bottom: 15px !important; 
}

/* --- 4. æ¶²æ€å¯¼èˆªæ é—´è·ä¿®æ­£ --- */
.liquid-sub-nav-container {
    background: #fff !important;
    padding: 15px 0 !important;
    border-bottom: 1px solid #f2f2f7 !important;
}

/* ç¡®ä¿åŠ å·æŒ‰é’®åœ¨åˆ—è¡¨é¡µ Header ä¸­æ­£ç¡®æ˜¾ç¤º */
.list-add-btn-top {
    width: 36px !important;
    height: 36px !important;
    background: #f2f2f7 !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: #007aff !important;
    cursor: pointer !important;
    position: absolute !important;
    right: 20px !important;
    bottom: 12px !important;
    z-index: 1001 !important;
}

/* å¼¹å‡ºèœå•å±‚çº§ */
.add-menu-pop {
    z-index: 2000 !important;
    top: 110px !important;
}

/* ä¿®æ­£æ¶²æ€å­å¯¼èˆªä½ç½® */
.liquid-sub-nav-container {
    padding: 15px 0 !important;
    border-bottom: 1px solid #f2f2f7 !important;
    background: #fff !important;
    flex-shrink: 0;
}

/* ==================================================
   === ğŸš¨ åˆ—è¡¨é¡µåŠ å·èœå• (Add Menu) å¼ºåˆ¶ä¿®å¤ ===
   ================================================== */

/* 1. å¼ºåˆ¶èœå•èƒŒæ™¯å’Œæ–‡å­—é¢œè‰² */
.add-menu-pop {
    background: rgba(255, 255, 255, 0.98) !important; /* å‡ ä¹çº¯ç™½ï¼Œå¸¦å¾®å¼±é€æ˜ */
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
    padding: 5px 0 !important;
    min-width: 140px !important;
    display: none; /* ç”± JS æ§åˆ¶æ˜¾ç¤º */
}

/* 2. å¼ºåˆ¶èœå•å†…çš„æ¯ä¸€é¡¹æ–‡å­—ä¸ºé»‘è‰² */
.add-menu-pop .menu-item {
    color: #000000 !important; /* ğŸ”¥ å¼ºåˆ¶å˜é»‘ */
    font-size: 15px !important;
    font-weight: 600 !important;
    padding: 12px 20px !important;
    text-align: left !important;
    display: block !important;
    border-bottom: 0.5px solid rgba(0, 0, 0, 0.05) !important;
    cursor: pointer !important;
    white-space: nowrap !important;
}

.add-menu-pop .menu-item:last-child {
    border-bottom: none !important;
}

/* 3. ç‚¹å‡»æ—¶çš„åé¦ˆé¢œè‰² */
.add-menu-pop .menu-item:active {
    background-color: rgba(0, 0, 0, 0.05) !important;
}

/* 4. ç¡®ä¿é‡Œé¢çš„ Emoji æˆ–å›¾æ ‡ä¹Ÿæ˜¯å¯è§çš„ */
.add-menu-pop .menu-item span {
    color: #000000 !important;
}

/* --- 1. åˆ›å»ºé€‰é¡¹æŒ‰é’®ï¼šé€‰ä¸­å¡«å……è“è‰² --- */
.create-options button {
    flex: 1; padding: 10px; border-radius: 12px;
    border: 1px solid #007aff; background: transparent;
    color: #007aff; font-weight: 600; cursor: pointer; transition: 0.3s;
}
.create-options button.active {
    background: #007aff !important; /* é€‰ä¸­æ—¶å¡«å……è“è‰² */
    color: #ffffff !important;
}

/* --- 2. å¤´åƒé¢„è§ˆåœ†åœˆ --- */
.avatar-preview-circle {
    width: 80px; height: 80px; border-radius: 50%;
    background: #f2f2f7; border: 2px dashed #c7c7cc;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; position: relative; cursor: pointer;
}
.avatar-preview-circle img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 2; }
.plus-icon-hint { font-size: 30px; color: #8e8e93; font-weight: 300; z-index: 1; }

/* --- 3. è§„èŒƒåŒ–å¼¹çª—æŒ‰é’® (å–æ¶ˆä¸å®Œæˆ) --- */
.modal-btns { display: flex; gap: 12px; margin-top: 25px; justify-content: flex-end; }

.modal-btn-cancel {
    background: #f2f2f7 !important;
    color: #8e8e93 !important;
    border: none !important;
    padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer;
}
.modal-btn-confirm {
    background: #007aff !important;
    color: #fff !important;
    border: none !important;
    padding: 10px 25px; border-radius: 10px; font-weight: 600; cursor: pointer;
}
.ios-input {
    width: 100%; padding: 12px; border-radius: 10px;
    border: 1px solid #e5e5ea; background: #f9f9f9; outline: none; font-size: 16px;
}

/* --- è§’è‰²ä¹¦å¯¼å…¥åˆ—è¡¨ç¾åŒ– --- */
#create-book-list {
    margin-top: 15px;
    padding: 5px;
}

.book-char-item {
    display: flex !important;
    align-items: center !important;
    padding: 12px 15px !important;
    margin-bottom: 8px !important;
    background: #f8f8fa !important; /* æµ…ç°èƒŒæ™¯ */
    border-radius: 14px !important;
    border: 1.5px solid transparent !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
}

/* åˆ—è¡¨é‡Œçš„å¤´åƒé¢„è§ˆ */
.book-char-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #eee;
    margin-right: 12px;
    object-fit: cover;
    flex-shrink: 0;
}

.book-char-name {
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

/* é€‰ä¸­çŠ¶æ€ï¼šè¾¹æ¡†å˜è“ï¼ŒèƒŒæ™¯å˜æµ…è“ */
.book-char-item.selected {
    background: #e5f1ff !important;
    border-color: #007aff !important;
}

.book-char-item.selected .book-char-name {
    color: #007aff !important;
}

/* è§’è‰²ä¹¦ä¸ºç©ºæ—¶çš„æç¤º */
.empty-book-tip {
    padding: 30px;
    text-align: center;
    color: #999;
    font-size: 14px;
}
/* ç¡®ä¿åˆ—è¡¨é¡¹æ˜¯æ¨ªå‘æ’åˆ—çš„ */
.chat-item {
    display: flex !important;
    align-items: center !important;
    padding: 12px 15px !important;
    background: #fff !important;
    border-bottom: 0.5px solid #c6c6c8 !important;
}

/* ç¡®ä¿å¤´åƒå¤§å°å›ºå®šåœ¨å·¦è¾¹ */
.chat-avatar {
    width: 50px !important;
    height: 50px !important;
    border-radius: 50% !important;
    margin-right: 15px !important;
    object-fit: cover !important;
    flex-shrink: 0 !important; /* é˜²æ­¢è¢«æŒ¤å‹ */
}

/* å³è¾¹å†…å®¹åŒºåŸŸæ’‘æ»¡ */
.chat-content {
    flex: 1 !important;
    min-width: 0 !important; /* é˜²æ­¢æ–‡æœ¬æº¢å‡ºé—®é¢˜ */
}

/* --- ä¿®å¤ï¼šå¥½å‹åˆ—è¡¨é¡¹ (åªæ˜¾ç¤ºå¤´åƒå’Œåå­—) --- */
.chat-item {
    display: flex !important;
    align-items: center !important;
    padding: 15px 20px !important; /* å¢åŠ ä¸€ç‚¹å†…è¾¹è· */
    background: #fff !important;
    border-bottom: 0.5px solid #f2f2f7 !important;
    cursor: pointer !important;
    height: 70px !important; /* å›ºå®šé«˜åº¦ï¼Œä¿è¯æ•´é½ */
}

.chat-avatar {
    width: 44px !important;
    height: 44px !important;
    border-radius: 50% !important;
    object-fit: cover !important;
    margin-right: 15px !important;
    background: #eee !important;
    flex-shrink: 0 !important;
}

.chat-content {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important; /* ç«–å‘æ’åˆ— */
    justify-content: center !important; /* å‚ç›´å±…ä¸­ */
    overflow: hidden !important;
}

.chat-name-row {
    display: flex !important;
    justify-content: flex-start !important; /* é å·¦ */
    align-items: center !important;
    width: 100% !important;
}

.chat-name {
    font-size: 17px !important;
    font-weight: 600 !important;
    color: #000 !important; /* å¼ºåˆ¶é»‘è‰² */
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    display: block !important; /* ç¡®ä¿å®ƒæ˜¯å—çº§å…ƒç´  */
}

/* éšè—çŠ¶æ€æ–‡å­— */
.chat-preview {
    display: none !important; 
}

/* =========================================
   === âš¡ï¸ åˆ—è¡¨ä¾§æ»‘ & ç‰¹åˆ«å…³å¿ƒæ ·å¼ ===
   ========================================= */

/* 1. åˆ—è¡¨é¡¹å®¹å™¨ (ä½œä¸ºé®ç½©) */
.list-item-wrapper {
    position: relative;
    width: 100%;
    height: 72px; /* å›ºå®šé«˜åº¦ */
    overflow: hidden; /* éšè—æº¢å‡ºçš„æŒ‰é’® */
    border-bottom: 0.5px solid #f2f2f7;
    background: #fff;
}

/* 2. å®é™…çš„èŠå¤©æ¡ (è¦†ç›–åœ¨ä¸Šé¢) */
.chat-item {
    position: relative;
    z-index: 10;
    width: 100%;
    height: 100% !important;
    background: #fff !important;
    transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); /* å›å¼¹åŠ¨ç”» */
    border-bottom: none !important; /* è¾¹æ¡†ç§»åˆ° wrapper ä¸Š */
    padding: 0 20px !important;
}

/* 3. å³ä¾§éšè—çš„æŒ‰é’®ç»„ */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    display: flex;
    z-index: 1; /* åœ¨å†…å®¹ä¸‹é¢ */
}

.action-btn {
    width: 70px;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
}

/* ğŸ—‘ï¸ åˆ é™¤æŒ‰é’® (çº¢è‰²) */
.action-btn.delete {
    background: #ff3b30;
}

/* â­ ç‰¹åˆ«å…³å¿ƒæŒ‰é’® (æµå…‰é‡‘) */
.action-btn.special {
    background: linear-gradient(135deg, #FFD700, #FFA500);
}
.action-btn svg { width: 24px; height: 24px; margin-bottom: 2px; }

/* ğŸŒŸ ç‰¹åˆ«å…³å¿ƒçŠ¶æ€ï¼šå¤´åƒå…‰åœˆ */
.chat-avatar.is-special {
    border: 2px solid #FFD700 !important;
    padding: 2px; /* ç•™å‡ºç©ºéš™ */
}

/* ğŸŒŸ ç‰¹åˆ«å…³å¿ƒçŠ¶æ€ï¼šåå­—æ—çš„å°æ˜Ÿæ˜Ÿ */
.star-badge {
    display: inline-block;
    color: #FFD700;
    font-size: 14px;
    margin-left: 5px;
    animation: spin-star 3s infinite linear;
}
@keyframes spin-star { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }


    </style>
</head>
<body>

    <div id="global-status-bar">
        <div class="time-area clock-text">--:--</div>
        <div class="status-right">
            <div class="icon-signal"><div class="signal-bar bar-1"></div><div class="signal-bar bar-2"></div><div class="signal-bar bar-3"></div><div class="signal-bar bar-4"></div></div>
            <span class="battery-text" id="global-battery-text">100%</span>
            <div class="icon-battery"><div class="battery-shell"></div><div class="battery-level-bar" id="global-battery-fill"></div><div class="battery-cap"></div></div>
        </div>
    </div>

    <div id="smart-capsule" class="smart-capsule-base" onclick="toggleIslandExpand()">
    
        <div class="capsule-collapsed">
            <div class="capsule-wave">
                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
            </div>
            <span id="capsule-text" class="capsule-text">Not Playing</span>
            <div id="capsule-mini-cover" class="capsule-mini-cover"></div>
        </div>

        <div class="capsule-expanded">
            
            <div class="island-cover-wrapper">
                <img id="island-cover" src="">
            </div>

            <div class="island-info-box">
                <div id="island-title" class="island-title">Song Name</div>
                <div id="island-artist" class="island-artist">Artist</div>
            </div>

            <div class="island-lyrics-area">
                <div id="island-lyric-text" class="island-lyric-line">Tap to play...</div>
            </div>
            
            <div class="island-progress-box">
                <div class="island-time" id="island-curr-time">0:00</div>
                <input type="range" id="island-seek-slider" min="0" max="100" value="0" onclick="event.stopPropagation()" oninput="seekMusic(this.value)">
                <div class="island-time" id="island-total-time">0:00</div>
            </div>

            <div class="island-controls" onclick="event.stopPropagation()">
                <button class="island-btn small" onclick="togglePlayMode()" id="island-mode-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v3z"/></svg>
                </button>
                <button class="island-btn" onclick="playPrev()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                <button class="island-btn play" onclick="togglePlayMusic()" id="island-play-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="island-btn" onclick="playNext()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
                <button class="island-btn small" onclick="openIslandPlaylist()">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="os-container">
        <div id="bg-layer"></div>

        <div class="content-layer">

            <div class="widget-area">
                <div class="super-widget" onclick="event.stopPropagation()">
                    <div id="widget-bg"></div>
                    <div class="widget-settings-btn" onclick="openWidgetSettings()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                    </div>
                    <div class="widget-content">
                        <div class="top-info">
                            <div class="w-time" id="w-time">--:--</div>
                            <div class="w-date-cn" id="w-date-cn">...</div>
                            <div class="w-date-en" id="w-date-en">...</div>
                            <span class="weather-tag" id="w-weather" onclick="openWeatherModal(); event.stopPropagation();">ğŸ“ Locating...</span>
                        </div>
                        <div class="middle-photo" onclick="openPhotoModal('photo'); event.stopPropagation();">
                            <img id="my-photo" src="https://images.unsplash.com/photo-1500964757637-c85e8a162699?w=800&q=80">
                            <div class="photo-hint">Change Photo</div>
                        </div>
                        <div class="prog-box">
                            <div class="prog-text"><span>Today's Progress</span><span id="prog-num">0%</span></div>
                            <div class="prog-track"><div class="prog-bar" id="prog-bar"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="desktop">
                <div id="smart-capsule" class="smart-capsule-base">...</div>

                <div class="app-item" onclick="event.stopPropagation(); openApp('wallpapers')">
                    <div class="app-icon" data-app-id="wallpapers"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
                    <span class="app-name">Wallpapers</span>
                </div>
                
                <div class="app-item" onclick="event.stopPropagation(); openApp('chat')">
                    <div class="app-icon" data-app-id="wechat">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width:34px;height:34px;"><path d="M17 11c0-2.3-2.1-4.2-4.8-4.2-2.7 0-4.8 1.9-4.8 4.2 0 2.3 2.1 4.2 4.8 4.2.3 0 .6 0 .9-.1l2.3 1.3v-2.3c1-.8 1.6-1.9 1.6-3.1zm-8.8 3c0-1.8-1.8-3.3-3.9-3.3-2.2 0-3.9 1.5-3.9 3.3 0 1.8 1.8 3.3 3.9 3.3.2 0 .5 0 .7-.1l1.8 1v-1.8c.8-.6 1.4-1.5 1.4-2.4z"/></svg>
                    </div>
                    <span class="app-name">Chat</span>
                </div>

                <div class="app-item" onclick="event.stopPropagation()">
                    <div class="app-icon" data-app-id="photos">
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width:32px;height:32px;"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </div>
                    <span class="app-name">Photos</span>
                </div>

                <div class="app-item" onclick="event.stopPropagation(); openSettingsApp()">
                    <div class="app-icon" data-app-id="settings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div>
                    <span class="app-name">Settings</span>
                </div>

                <div class="app-item" onclick="event.stopPropagation(); openApp('music')">
                    <div class="app-icon" data-app-id="music">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 18V5l12-2v13"></path>
                            <circle cx="6" cy="18" r="3"></circle>
                            <circle cx="18" cy="16" r="3"></circle>
                        </svg>
                    </div>
                    <span class="app-name">Music</span>
                </div>

                <div class="app-item" onclick="event.stopPropagation()">
                    <div class="app-icon" data-app-id="shopping"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg></div>
                    <span class="app-name">Shopping</span>
                </div>

                <div class="app-item" onclick="event.stopPropagation(); openApp('phone')">
                    <div class="app-icon" data-app-id="phone"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div>
                    <span class="app-name">Phone</span>
                </div>

                <div class="app-item" onclick="event.stopPropagation()">
                    <div class="app-icon" data-app-id="wallet"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12a2 2 0 0 0 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4z"></path></svg></div>
                    <span class="app-name">Wallet</span>
                </div>
            </div>

            <div class="dock-container">
                <div class="dock" onclick="event.stopPropagation()">
                    
                    <div class="app-icon" data-app-id="characters" onclick="openApp('characters')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            <line x1="10" y1="8" x2="16" y2="8"></line>
                            <line x1="10" y1="12" x2="16" y2="12"></line>
                            <line x1="10" y1="16" x2="14" y2="16"></line>
                        </svg>
                    </div>

                    <div class="app-icon" data-app-id="worldbook" onclick="openApp('worldbook')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                    </div>

                    <div class="app-icon" data-app-id="messages">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    </div>

                    <div class="app-icon" data-app-id="icons-app" onclick="openApp('icons')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <path d="M10 14L3 21"></path>
                        </svg>
                    </div>

                </div>
            </div>

            <div class="music-capsule" onclick="togglePlay()">
    
                <div class="music-cover-box" onclick="event.stopPropagation(); openPhotoModal('music-cover')">
                    <img id="music-album-img" src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=200&q=80">
                </div>

                <div class="music-visualizer">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>

                <div class="music-upload-btn" onclick="event.stopPropagation(); openAudioModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:20px; height:20px;">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <path d="M3 6h.01M3 12h.01M3 18h.01"></path>
                    </svg>
                </div>

                <audio id="hidden-player" loop></audio>
            </div>
            
            <div class="home-indicator"></div>
        </div>
    </div>

    <div class="modal-mask" id="modal-photo">
        <div class="modal-body">
            <div class="modal-title">Change Image</div>
            <input type="text" id="img-url-input" class="url-input" placeholder="Paste image URL...">
            <div class="btn-group">
                <button class="modal-btn primary" onclick="loadFromUrl('photo')">ğŸ”— Use URL</button>
                <button class="modal-btn" onclick="document.getElementById('file-upload-photo').click()">ğŸ“‚ Upload Local File</button>
                <button class="modal-btn danger" onclick="closeModal('modal-photo')">Cancel</button>
            </div>
            <input type="file" id="file-upload-photo" accept="image/*" style="display:none" onchange="uploadFile(this, 'photo')">
        </div>
    </div>

    <div class="modal-mask" id="modal-audio">
        <div class="modal-body">
            <div class="modal-title">Change Music</div>
            <input type="text" id="audio-url-input" class="url-input" placeholder="Paste MP3 URL...">
            <div class="btn-group">
                <button class="modal-btn primary" onclick="loadAudioFromUrl()">ğŸ”— Use URL</button>
                <button class="modal-btn" onclick="document.getElementById('file-upload-audio').click()">ğŸ“‚ Upload Local MP3</button>
                <button class="modal-btn danger" onclick="closeModal('modal-audio')">Close</button>
            </div>
            <input type="file" id="file-upload-audio" accept="audio/*" style="display:none" onchange="uploadAudioFile(this)">
        </div>
    </div>

    <div class="modal-mask" id="modal-weather">
        <div class="modal-body">
            <div class="modal-title">Switch City</div>
            <div class="city-tabs">
                <div class="tab-btn active" onclick="switchCityTab('cn', this)">ğŸ‡¨ğŸ‡³ Domestic</div>
                <div class="tab-btn" onclick="switchCityTab('intl', this)">ğŸŒ International</div>
            </div>
            <div class="city-grid" id="city-list-box"></div>
            <button class="modal-btn danger" onclick="closeModal('modal-weather')">Close</button>
        </div>
    </div>

    <div class="modal-mask" id="modal-widget-settings">
        <div class="modal-body">
            <div class="modal-title">Widget Style</div>
            <div class="slider-container">
                <label class="slider-label">Widget Opacity: <span id="w-opacity-val">45%</span></label>
                <input type="range" min="0" max="100" value="45" class="opacity-slider" id="w-opacity-slider" oninput="changeWidgetOpacity(this.value)">
            </div>
            <input type="text" id="wbg-url-input" class="url-input" placeholder="Paste Widget BG URL...">
            <div class="btn-group">
                <button class="modal-btn primary" onclick="loadFromUrl('widget-bg')">ğŸ”— Set Widget BG</button>
                <button class="modal-btn" onclick="document.getElementById('file-upload-wbg').click()">ğŸ“‚ Upload Widget BG</button>
                <button class="modal-btn danger" onclick="closeModal('modal-widget-settings')">Close</button>
            </div>
            <input type="file" id="file-upload-wbg" accept="image/*" style="display:none" onchange="uploadFile(this, 'widget-bg')">
        </div>
    </div>

    <div id="bg-layer">
        <video id="bg-video" loop muted playsinline style="display:none;"></video>
    </div>

<div id="app-wallpapers" class="app-window">

    <div class="app-header">
        <div class="app-title">Wallpapers</div>
        <button class="close-btn" onclick="closeApp('wallpapers')">Close</button>
    </div>

    <div class="app-body">
        <div class="upload-zone" onclick="document.getElementById('wp-upload').click()">
            <div class="upload-icon">+</div>
            <div class="upload-desc">Upload Image or Video</div>
            <div class="upload-sub">Supports JPG, PNG, MP4, WEBM</div>
        </div>
        <input type="file" id="wp-upload" accept="image/*,video/*" style="display:none" onchange="handleWallpaperUpload(this)">

        <div class="section-title">My Collection</div>
        <div class="wallpaper-grid" id="wp-grid">
            </div>
    </div>
</div>

<div id="app-settings" class="app-window">

    <div id="settings-main-view" class="settings-view">
        <div class="app-header">
            <div class="app-title">Settings</div>
            <button class="close-btn" onclick="closeApp('settings')">Close</button>
        </div>
        
        <div class="settings-group">
            <div class="settings-item" onclick="openTimeZonePage()">
                <div class="set-icon" style="background:#007aff"><svg viewBox="0 0 24 24" fill="#fff"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></div>
                <div class="set-text">æ—¶åŒº&æ—¶é—´</div>
                <div class="set-arrow">â€º</div>
            </div>
        </div>

        <div class="settings-group">
            <div class="settings-item" onclick="openAPIPage()">
                <div class="set-icon" style="background:#5e5ce6">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 14a4 4 0 1 1 4-4 4 4 0 0 1-4 4z"/>
                        <circle cx="12" cy="12" r="2" fill="#fff"/>
                    </svg>
                </div>
                <div class="set-text">APIè®¾ç½®</div>
                <div class="set-arrow">â€º</div>
            </div>
        </div>

        <div class="settings-group">
            <div class="settings-item" onclick="openFontPage()">
                <div class="set-icon" style="background:#ff2d55">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16" /></svg>
                </div>
                <div class="set-text">æ˜¾ç¤º&å­—ä½“</div>
                <div class="set-arrow">â€º</div>
            </div>
        </div>

        <div class="settings-group">
            <div class="settings-item" onclick="openIslandPage()">
                <div class="set-icon" style="background:#000">
                    <svg viewBox="0 0 24 24" fill="#fff"><rect x="6" y="8" width="12" height="8" rx="4" /></svg>
                </div>
                <div class="set-text">Smart Capsule</div>
                <div class="set-arrow">â€º</div>
            </div>
        </div>
    </div>

    <div id="settings-timezone-view" class="settings-view" style="display:none; transform: translateX(100%);">
        <div class="app-header">
            <button class="back-btn" onclick="backToMainSettings('settings-timezone-view')">â€¹ Back</button>
            <div class="sub-title">Time Zone</div>
            <div style="width:50px"></div> 
        </div>

        <div class="search-container">
            <div class="search-bar">
                <svg width="16" height="16" fill="#8e8e93" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2"/></svg>
                <input type="text" placeholder="Search City..." oninput="filterTimeZones(this.value)">
            </div>
        </div>

        <div class="settings-group-title">CURRENT</div>
        <div class="settings-group">
            <div class="settings-item">
                <div class="set-text" style="color:#007aff" id="current-tz-display">Default (System)</div>
                <svg id="tz-check" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007aff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="display:block"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </div>
        </div>

        <div id="timezone-list-container" class="app-body" style="padding-top:0"></div>
    </div> 
    <div id="settings-api-view" class="settings-view" style="display:none; transform: translateX(100%);">
        <div class="app-header">
            <button class="back-btn" onclick="backToMainSettings('settings-api-view')">â€¹ Back</button>
            <div class="sub-title" style="color:#000; flex:1; text-align:center">Model Settings</div>
            <div style="width:50px"></div>
        </div>

        <div class="app-body">
            <div class="settings-group-title">SERVER CONFIG</div>
            <div class="settings-group">
                <div class="api-input-row">
                    <label class="api-label">API Base URL</label>
                    <input type="text" id="api-url" class="api-input" placeholder="https://api.openai.com/v1">
                </div>
                <div class="api-input-row">
                    <label class="api-label">API Key</label>
                    <input type="password" id="api-key" class="api-input" placeholder="sk-...">
                </div>
                <div class="api-input-row" style="padding: 0;">
                    <button class="api-btn secondary" style="margin:0; border-radius:0;" onclick="fetchModels()">Fetch Models</button>
                </div>
            </div>

            <div class="settings-group-title">MODEL SELECTION</div>
            <div class="settings-group" style="padding: 0; overflow: visible;">
                <div class="settings-item" style="position: relative;">
                    <div class="set-text">Current Model</div>
                    <input type="hidden" id="model-select">
                    <div id="model-trigger" class="custom-select-trigger" onclick="toggleModelList()">Select Model â€º</div>
                    <div id="model-list" class="custom-options-list"></div>
                </div>
            </div>

            <div class="settings-group-title">CONNECTION TEST</div>
            <div class="settings-group" style="padding: 16px;">
                <input type="text" id="test-msg-input" class="test-input" placeholder="Type message to test (e.g. Hi)...">
                
                <div class="test-panel" id="test-output">Waiting for test...</div>
                <div style="display:flex; gap:12px;">
                    <button class="api-btn primary" onclick="testAPIConnection()">Test</button>
                    <button class="api-btn save" onclick="saveLLMConfig()">Save</button>
                </div>
            </div>

            <div class="settings-group-title">PRESETS</div>
            <div class="settings-group">
                <div class="api-input-row" style="flex-direction:row; align-items:center; gap:10px;">
                    <input type="text" id="preset-name" class="api-input" placeholder="Preset Name" style="flex:1;">
                    <button class="api-btn secondary" style="width:auto; margin:0; padding: 8px 16px;" onclick="saveAsPreset()">Add</button>
                </div>
                <div id="preset-list"></div>
            </div>
        </div>
    </div>

    <div id="settings-font-view" class="settings-view" style="display:none; transform: translateX(100%);">
        <div class="app-header">
            <button class="back-btn" onclick="backToMainSettings('settings-font-view')">â€¹ Back</button>
            <div class="sub-title" style="color:#000; flex:1; text-align:center">Font & Style</div>
            <div style="width:50px"></div>
        </div>

        <div class="app-body">
            <div class="settings-group-title">PREVIEW</div>
            <div class="settings-group" style="padding: 20px; display:flex; justify-content:center; background:#f2f2f7; box-shadow:none;">
                <div id="font-preview-card" style="background:#fff; padding:20px; border-radius:16px; width:100%; min-height:100px; display:flex; align-items:center; justify-content:center; text-align:center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <div id="preview-text" style="line-height:1.4; transition: 0.2s;">
                        The quick brown fox jumps over the lazy dog.<br>
                        0123456789
                    </div>
                </div>
            </div>

            <div class="settings-group-title">APPEARANCE</div>
            <div class="settings-group" style="padding: 16px;">
                
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span class="api-label">Size</span>
                    <span class="api-label" style="color:#007aff" id="lbl-font-size">16px</span>
                </div>
                <div class="slider-row">
                    <span style="font-size:12px; color:#8e8e93">A</span>
                    <input type="range" min="12" max="30" value="16" id="font-size-slider" oninput="updateFontPreview()">
                    <span style="font-size:18px; font-weight:bold; color:#8e8e93">A</span>
                </div>
                
                <div style="height:1px; background:#e5e5ea; margin:15px 0;"></div>

                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span class="api-label">Weight</span>
                    <span class="api-label" style="color:#007aff" id="lbl-font-weight">400</span>
                </div>
                <div class="slider-row">
                    <span style="font-size:12px; color:#8e8e93">Thin</span>
                    <input type="range" min="100" max="900" step="100" value="400" id="font-weight-slider" oninput="updateFontPreview()">
                    <span style="font-size:14px; font-weight:bold; color:#8e8e93">Bold</span>
                </div>

                <div style="height:1px; background:#e5e5ea; margin:15px 0;"></div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <span class="api-label" style="margin:0">Text Color</span>
                    <div style="display:flex; gap:12px;">
                        <div class="color-circle" style="background:#000000" onclick="setFontColor('#000000')"></div>
                        <div class="color-circle" style="background:#007aff" onclick="setFontColor('#007aff')"></div>
                        <div class="color-circle" style="background:#ff2d55" onclick="setFontColor('#ff2d55')"></div>
                        <div style="position:relative; width:24px; height:24px;">
                            <div class="color-circle" style="background:conic-gradient(red, yellow, lime, cyan, blue, magenta, red); border:none;"></div>
                            <input type="color" id="custom-color-picker" onchange="setFontColor(this.value)" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                        </div>
                    </div>
                </div>

                <button class="api-btn save" onclick="saveFontConfig()">Save Changes</button>
            </div>

            <div class="settings-group-title">FONT FAMILY</div>
            <div class="settings-group" id="font-list-container">
                <div class="settings-item" onclick="applyFont('Inter', 'system')">
                    <div class="set-text" style="font-family:'Inter'">Inter (System)</div>
                    <div class="check-icon" id="check-Inter">âœ“</div>
                </div>
                <div class="settings-item" onclick="applyFont('Noto Serif', 'system')">
                    <div class="set-text" style="font-family:'Noto Serif'">Serif (Elegant)</div>
                    <div class="check-icon" id="check-Noto Serif"></div>
                </div>
                <div class="settings-item" onclick="applyFont('Roboto Mono', 'system')">
                    <div class="set-text" style="font-family:'Roboto Mono'">Mono (Coding)</div>
                    <div class="check-icon" id="check-Roboto Mono"></div>
                </div>
                <div class="settings-item" onclick="applyFont('Dancing Script', 'system')">
                    <div class="set-text" style="font-family:'Dancing Script'">Handwriting</div>
                    <div class="check-icon" id="check-Dancing Script"></div>
                </div>
            </div>

            <div class="settings-group-title">CUSTOM</div>
            <div class="settings-group">
                <div class="settings-item" onclick="document.getElementById('font-upload').click()">
                    <div class="set-text" style="color:#007aff">Import Font File...</div>
                </div>
                <input type="file" id="font-upload" accept=".ttf,.otf,.woff,.woff2" style="display:none" onchange="handleFontUpload(this)">
                <div id="user-font-list"></div>
            </div>
        </div>
    </div>

    <div id="settings-island-view" class="settings-view" style="display:none; transform: translateX(100%);">
        <div class="app-header">
            <button class="back-btn" onclick="backToMainSettings('settings-island-view')">â€¹ Back</button>
            <div class="sub-title" style="color:#000; flex:1; text-align:center">Smart Capsule</div>
            <div style="width:50px"></div>
        </div>

        <div class="app-body">
            <div class="settings-group-title">REAL-TIME PREVIEW</div>
            <div class="settings-group" style="padding: 30px 0; background:#e5e5ea; display:flex; justify-content:center; position:relative; overflow:hidden;">
                <div id="island-preview-box" class="smart-capsule-base" style="position:relative; top:0; transform:none;">
                    <div class="capsule-content"><span style="font-size:10px; color:#666;">Preview</span></div>
                </div>
            </div>

            <div class="settings-group-title">CONFIGURATION</div>
            <div class="settings-group">
                <div class="settings-item">
                    <div class="set-text">Enable Capsule</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="island-toggle" onchange="handleIslandToggle(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group-title">CUSTOM CSS CODE</div>
            <div class="settings-group" style="padding: 0;">
                <div style="padding:10px 15px; background:#f9f9f9; font-size:12px; color:#8e8e93; border-bottom:1px solid #e5e5ea;">
                    Edit the style below. Class name is <b>.smart-capsule-base</b>
                </div>
                <textarea id="island-css-input" spellcheck="false" oninput="updateIslandPreview()"
                style="width:100%; height:150px; border:none; padding:15px; font-family:monospace; font-size:13px; background:#fff; color:#333; outline:none; box-sizing:border-box; resize:none;">
    /* Default Style */
    width: 120px;
    height: 35px;
    background: #000000;
    border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                </textarea>
            </div>

            <div class="settings-group" style="background:transparent; box-shadow:none;">
                <button class="api-btn save" onclick="saveIslandConfig()">Save & Apply</button>
                <button class="api-btn secondary" onclick="resetIslandConfig()" style="margin-top:10px; background:#fff; color:#ff3b30;">Reset Default</button>
            </div>
        </div>
    </div>

</div>

<div id="ios-alert" class="ios-alert-overlay" style="display: none;">
    <div class="ios-alert-box">
        <div class="ios-alert-title" id="ios-alert-title">Alert</div>
        <div class="ios-alert-msg" id="ios-alert-msg">Message goes here...</div>
        <div class="ios-alert-btn" onclick="closeIOSAlert()">OK</div>
    </div>
</div>

<div id="app-icons" class="app-window">
    <div class="app-header">
        <div class="app-title">Icon Store</div>
        <button class="close-btn" onclick="closeApp('icons')">Close</button>
    </div>

    <div class="app-body">
        <div class="settings-group-title">Tap an app to change icon</div>
        <div class="settings-group" id="icon-app-list">
            </div>
    </div>
</div>

<div class="modal-mask" id="modal-icon-change">
    <div class="modal-body">
        <div class="modal-title">Change Icon</div>
        <div style="display:flex; justify-content:center; margin-bottom:20px;">
            <div id="icon-preview-box" class="app-icon" style="width:80px; height:80px; font-size:40px; background:#eee; color:#000;">?</div>
        </div>
        <input type="text" id="icon-url-input" class="url-input" placeholder="Paste Image URL...">
        <div class="btn-group">
            <button class="modal-btn primary" onclick="confirmIconChange('url')">ğŸ”— Use URL</button>
            <button class="modal-btn" onclick="document.getElementById('icon-file-upload').click()">ğŸ“‚ Upload Local File</button>
            <button class="modal-btn danger" onclick="restoreDefaultIcon()" style="color:#ff3b30">â†º Reset Default</button>
            <button class="modal-btn" onclick="closeModal('modal-icon-change')" style="color:#666">Cancel</button>
        </div>
        <input type="file" id="icon-file-upload" accept="image/*" style="display:none" onchange="handleIconFileSelect(this)">
    </div>
</div>

<div id="app-characters" class="app-window">
    <div class="app-header">
        <div class="app-title">è§’è‰²ä¹¦</div>
        <button class="close-btn" onclick="closeApp('characters')">Close</button>
    </div>

    <div class="app-body" style="padding: 0;">
        
        <div id="char-list-view" style="padding: 20px;">
            <div class="settings-group-title">æˆ‘çš„è§’è‰²</div>
            <div id="character-list" class="char-grid">
                </div>
            
            <button class="api-btn primary" onclick="openCharModal()" style="margin-top:20px;">+ æ·»åŠ æ–°è§’è‰²</button>
        </div>

        <div id="char-detail-view" class="detail-overlay">
    
            <div id="char-detail-banner" class="char-banner" onclick="openBannerModal()">
                
                <div class="char-nav-bar" onclick="event.stopPropagation()">
                    <button class="nav-btn-blur" onclick="backToCharList()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                        åˆ—è¡¨
                    </button>
                    <button class="nav-btn-blur danger" onclick="closeApp('characters')">
                        å…³é—­
                    </button>
                </div>

                <div class="banner-hint">ç‚¹å‡»æ›´æ¢èƒŒæ™¯</div>
            </div>
            
            <div class="char-profile-body">
                <div class="char-profile-avatar-box" onclick="event.stopPropagation(); openCharModal(editingCharId)">
                    <img id="char-detail-avatar" src="">
                </div>
                
                <h1 id="char-detail-name">è§’è‰²å</h1>
                
                <div class="char-actions">
                    <button class="char-btn edit" onclick="editCurrentCharacter()">ç¼–è¾‘èµ„æ–™</button>
                    <button class="char-btn delete" onclick="deleteCurrentCharacter()">åˆ é™¤äººç‰©</button>
                </div>

                <div style="height:1px; background:#e5e5ea; margin: 20px 0;"></div>

                <div class="settings-group-title">äººè®¾è¯¦æƒ…</div>
                <div id="char-detail-desc" class="char-desc-text">
                    ...
                </div>
                
                <div style="height:100px;"></div>
            </div>
        </div>

    </div>
</div>

<div class="modal-mask" id="modal-char-edit">
    <div class="modal-body">
        <div class="modal-title" id="char-modal-title">æ·»åŠ è§’è‰²</div>
        
        <div style="display:flex; justify-content:center; margin-bottom:15px;">
            <div id="char-preview-box" class="app-icon" style="width:80px; height:80px; border-radius:50%; background:#eee; overflow:hidden;">
                <img src="" style="width:100%; height:100%; object-fit:cover; opacity:0;" id="char-preview-img">
            </div>
        </div>
        <button class="modal-btn" style="font-size:12px; padding:8px; margin-bottom:15px;" onclick="document.getElementById('char-avatar-upload').click()">ğŸ“· ä¸Šä¼ å¤´åƒ</button>
        <input type="file" id="char-avatar-upload" accept="image/*" style="display:none" onchange="handleCharAvatarSelect(this)">

        <input type="text" id="char-input-name" class="api-input" placeholder="è§’è‰²æ˜µç§°" style="margin-bottom:10px;">
        <textarea id="char-input-desc" class="api-input" placeholder="äººè®¾è¯¦æƒ… (ä¸é™å­—æ•°)..." style="height:120px; resize:none; font-family:inherit;"></textarea>
        
        <div class="btn-group" style="margin-top:15px;">
            <button class="modal-btn primary" onclick="saveCharacterData()">ä¿å­˜</button>
            <button class="modal-btn danger" onclick="closeModal('modal-char-edit')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div class="modal-mask" id="modal-char-banner">
    <div class="modal-body">
        <div class="modal-title">æ›´æ¢èƒŒæ™¯</div>
        <input type="text" id="banner-url-input" class="url-input" placeholder="è¾“å…¥å›¾ç‰‡ URL...">
        <div class="btn-group">
            <button class="modal-btn primary" onclick="saveBanner('url')">ğŸ”— ä½¿ç”¨ URL</button>
            <button class="modal-btn" onclick="document.getElementById('banner-file-upload').click()">ğŸ“‚ ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</button>
            <button class="modal-btn danger" onclick="closeModal('modal-char-banner')">å–æ¶ˆ</button>
        </div>
        <input type="file" id="banner-file-upload" accept="image/*" style="display:none" onchange="handleBannerFileSelect(this)">
    </div>
</div>
<div class="modal-mask" id="modal-delete-confirm">
    <div class="modal-body">
        <div class="modal-title" style="color:#ff3b30">åˆ é™¤è§’è‰²</div>
        <div style="margin-bottom: 20px; color:#333; font-size:15px; line-height:1.4;">
            ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿ<br>æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
        </div>
        <div class="btn-group">
            <button class="modal-btn danger" onclick="confirmDeleteCharacter()">åˆ é™¤</button>
            <button class="modal-btn" onclick="closeModal('modal-delete-confirm')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="app-worldbook" class="app-window">
    <div class="app-header">
        <div class="app-title">ä¸–ç•Œä¹¦</div>
        <button class="close-btn" onclick="closeApp('worldbook')">Close</button>
    </div>

    <div class="app-body" style="padding: 20px;">
        <div class="settings-group-title">ä¸–ç•Œè§‚è®¾å®š</div>
        
        <div id="world-list" class="world-grid">
            </div>

        <button class="api-btn primary" onclick="openWorldEditModal()" style="margin-top:20px;">+ æ–°å»ºä¸–ç•Œè§‚</button>
    </div>
</div>

<div class="modal-mask" id="modal-world-edit">
    <div class="modal-body">
        <div class="modal-title" id="world-modal-title">æ–°å»ºä¸–ç•Œè§‚</div>
        
        <input type="text" id="world-input-title" class="api-input" placeholder="ä¸–ç•Œè§‚åç§° (å¦‚: èµ›åšæœ‹å…‹2077)" style="margin-bottom:15px; font-weight:bold;">
        
        <textarea id="world-input-content" class="api-input" placeholder="è¯¦ç»†è®¾å®šå†…å®¹..." style="height:200px; resize:none; font-family:inherit; line-height:1.5;"></textarea>
        
        <div class="btn-group" style="margin-top:15px;">
            <button class="modal-btn primary" onclick="saveWorldData()">ä¿å­˜è®¾å®š</button>
            <button class="modal-btn danger" onclick="closeModal('modal-world-edit')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div class="modal-mask" id="modal-world-view">
    <div class="modal-body" style="max-width: 340px; text-align: left;">
        <div class="modal-title" id="view-world-title" style="text-align:center; font-size:22px; margin-bottom:10px;">æ ‡é¢˜</div>
        
        <div style="height:1px; background:#e5e5ea; margin-bottom:15px;"></div>
        
        <div id="view-world-content" style="max-height: 300px; overflow-y: auto; font-size:15px; line-height:1.6; color:#333; white-space: pre-wrap; margin-bottom:20px;">
            å†…å®¹...
        </div>

        <div class="btn-group">
            <button class="modal-btn" onclick="editCurrentWorld()" style="color:#007aff">ç¼–è¾‘</button>
            <button class="modal-btn" onclick="deleteCurrentWorld()" style="color:#ff3b30">åˆ é™¤</button>
            <button class="modal-btn primary" onclick="closeModal('modal-world-view')">å…³é—­</button>
        </div>
    </div>
</div>

<div id="app-music" class="app-window">
    <div class="app-header">
        <div class="app-title">Music</div>
        <button class="close-btn" onclick="closeApp('music')">Close</button>
    </div>

    <div class="app-body" style="padding: 0; padding-bottom: 90px;"> <div class="music-stories-area">
            <div class="settings-group-title" style="padding-left:20px;">Friends Listening</div>
            <div id="music-stories-scroll" class="stories-scroll">
                </div>
        </div>

        <div style="height:1px; background:#e5e5ea; margin: 10px 20px;"></div>

        <div class="music-list-header" style="padding: 0 20px; display:flex; justify-content:space-between; align-items:center;">
            <div class="settings-group-title" style="margin:0;">My Library</div>
            <button class="add-song-btn" onclick="openAddMusicModal()">+ Add</button>
        </div>
        
        <div id="music-library-list" class="music-list-container">
            </div>
    </div>

    <div id="mini-player" class="mini-player-pill" onclick="openFullPlayer()">
        <div class="mini-left">
            <img id="mini-cover" src="https://via.placeholder.com/50" class="mini-cover-img">
            <div class="mini-info">
                <div id="mini-title" class="mini-title">Not Playing</div>
                <div id="mini-artist" class="mini-artist">Select a song</div>
            </div>
        </div>
        <div class="mini-controls" onclick="event.stopPropagation()">
            <button onclick="playPrev()"><svg viewBox="0 0 24 24" fill="currentColor" width="20"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
            <button onclick="togglePlayMusic()" id="mini-play-btn"><svg viewBox="0 0 24 24" fill="currentColor" width="24"><path d="M8 5v14l11-7z"/></svg></button>
            <button onclick="playNext()"><svg viewBox="0 0 24 24" fill="currentColor" width="20"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
        </div>
    </div>

    <div id="full-player" class="detail-overlay" style="background: #333;">
        <div id="full-player-bg" class="player-blur-bg"></div>
        
        <div class="char-nav-bar" style="justify-content: space-between; align-items: center;">
            <button class="nav-btn-icon" onclick="closeFullPlayer()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
            </button>
            <div id="full-header-title" class="player-header-title">Now Playing</div>
            <button class="nav-btn-icon" onclick="openPlayerBgModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </button>
        </div>

        <div class="player-main-body">
            <div class="player-cover-box">
                <img id="full-cover" src="">
            </div>

            <div id="player-lyrics-box" class="lyrics-container" onclick="openLyricsModal()">
                <div id="lyrics-scroll-view" class="lyrics-content">
                    <p class="lyric-line active">Tap to add lyrics...</p>
                </div>
            </div>
            
            <div class="player-info-row">
                <div>
                    <div id="full-title" class="full-title">Song Name</div>
                    <div id="full-artist" class="full-artist">Artist</div>
                </div>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.7)" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </div>

            <div class="player-progress-container">
                <input type="range" id="music-seek-slider" min="0" max="100" value="0" oninput="seekMusic(this.value)">
                <div class="time-labels">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>

            <div class="player-controls-row">
                
                <button class="ctrl-btn-small" onclick="togglePlayMode()" id="play-mode-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v3z"/></svg>
                </button>
                
                <button class="ctrl-btn-medium" onclick="playPrev()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="35" height="35"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                
                <button class="ctrl-btn-large" onclick="togglePlayMusic()" id="full-play-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="70" height="70"><path d="M8 5v14l11-7z"/></svg>
                </button>
                
                <button class="ctrl-btn-medium" onclick="playNext()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="35" height="35"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
                
                <button class="ctrl-btn-small" onclick="togglePlaylistPanel()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                </button>

            </div>
        </div>
        
        <div id="playlist-drawer" class="playlist-drawer">
            <div class="drawer-header">Up Next</div>
            <div id="drawer-list" class="drawer-list-content">
                </div>
            <button class="drawer-close" onclick="togglePlaylistPanel()">Close</button>
        </div>
    </div>
</div>

<div class="modal-mask" id="modal-add-music">
    <div class="modal-body">
        <div class="modal-title">Add Music</div>
        
        <div style="display:flex; justify-content:center; margin-bottom:15px;">
            <div id="music-preview-box" class="app-icon" style="width:80px; height:80px; border-radius:12px; background:#eee; overflow:hidden;">
                <img src="" style="width:100%; height:100%; object-fit:cover; opacity:0;" id="music-preview-img">
            </div>
        </div>
        <button class="modal-btn" style="font-size:12px; padding:8px; margin-bottom:15px;" onclick="document.getElementById('music-cover-upload').click()">ğŸ“· Album Art</button>
        <input type="file" id="music-cover-upload" accept="image/*" style="display:none" onchange="handleMusicCoverSelect(this)">

        <input type="text" id="music-input-title" class="api-input" placeholder="Song Title" style="margin-bottom:10px;">
        <input type="text" id="music-input-artist" class="api-input" placeholder="Artist Name" style="margin-bottom:15px;">
        
        <div style="height:1px; background:#e5e5ea; margin-bottom:15px;"></div>
        
        <div class="btn-group">
            <button class="modal-btn primary" onclick="document.getElementById('music-file-upload').click()">ğŸ“‚ Select MP3 File</button>
            <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">OR</div>
            <input type="text" id="music-input-url" class="api-input" placeholder="Paste Audio URL">
            
            <button class="modal-btn save" onclick="confirmAddSong()">Save to Library</button>
            <button class="modal-btn danger" onclick="closeModal('modal-add-music')">Cancel</button>
        </div>
        <input type="file" id="music-file-upload" accept="audio/*" style="display:none" onchange="handleMusicFileSelect(this)">
    </div>
</div>

<div class="modal-mask" id="modal-player-bg">
    <div class="modal-body">
        <div class="modal-title">Player Background</div>
        <input type="text" id="pbg-url-input" class="url-input" placeholder="Image URL...">
        <div class="btn-group">
            <button class="modal-btn primary" onclick="setPlayerBg('url')">ğŸ”— Use URL</button>
            <button class="modal-btn" onclick="document.getElementById('pbg-file-upload').click()">ğŸ“‚ Local Image</button>
            <button class="modal-btn secondary" onclick="setPlayerBg('default')">â†º Default Blur</button>
            <button class="modal-btn danger" onclick="closeModal('modal-player-bg')">Cancel</button>
        </div>
        <input type="file" id="pbg-file-upload" accept="image/*" style="display:none" onchange="handlePlayerBgFile(this)">
    </div>
</div>

<div class="modal-mask" id="modal-lyrics-edit">
    <div class="modal-body">
        <div class="modal-title">Edit Lyrics</div>
        
        <div class="city-tabs" style="margin-bottom:15px;">
            <div class="tab-btn active" onclick="switchLyricsTab('manual', this)">ğŸ“ Manual Input</div>
            <div class="tab-btn" onclick="switchLyricsTab('file', this)">ğŸ“‚ Upload LRC</div>
        </div>

        <div id="lyrics-tab-manual">
            <textarea id="lyrics-input-text" class="api-input" placeholder="Paste lyrics here...&#10;For sync, use LRC format:&#10;[00:12.50]Hello world..." style="height:200px; font-family:monospace; font-size:12px; line-height:1.5; resize:none;"></textarea>
        </div>

        <div id="lyrics-tab-file" style="display:none; padding: 20px 0; text-align: center;">
            <div class="upload-zone" onclick="document.getElementById('lyrics-file-upload').click()" style="height:150px; margin-bottom:0;">
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-desc">Select .lrc or .txt</div>
            </div>
            <input type="file" id="lyrics-file-upload" accept=".lrc,.txt" style="display:none" onchange="handleLyricsFile(this)">
            <div id="lyrics-filename" style="margin-top:10px; font-size:12px; color:#007aff;"></div>
        </div>

        <div class="btn-group" style="margin-top:20px;">
            <button class="modal-btn primary" onclick="saveLyricsData()">Save Lyrics</button>
            <button class="modal-btn" onclick="clearLyrics()">ğŸ—‘ï¸ Clear</button>
            <button class="modal-btn danger" onclick="closeModal('modal-lyrics-edit')">Cancel</button>
        </div>
    </div>
</div>

<div class="modal-mask" id="modal-song-menu" style="align-items: flex-end;"> <div class="action-sheet">
        <div class="action-header" id="action-song-title">Song Name</div>
        
        <button class="action-btn" onclick="editSelectedSong()">
            <span style="font-size:18px;"></span> ç¼–è¾‘æ­Œæ›² (Edit)
        </button>
        
        <button class="action-btn danger" onclick="deleteSelectedSong()">
            <span style="font-size:18px;"></span> åˆ é™¤æ­Œæ›² (Delete)
        </button>
        
        <div style="height:8px; background:#f2f2f7;"></div> <button class="action-btn cancel" onclick="closeModal('modal-song-menu')">
            å–æ¶ˆ (Cancel)
        </button>
    </div>
</div>

<div class="modal-mask" id="modal-island-list">
    <div class="modal-body" style="max-height: 400px; display:flex; flex-direction:column; padding:0; overflow:hidden;">
        <div class="modal-title" style="padding: 20px 20px 10px 20px; margin:0;">Current Queue</div>
        <div style="height:1px; background:#e5e5ea; width:100%;"></div>
        
        <div id="island-list-container" style="flex:1; overflow-y:auto; text-align:left; padding:0;">
            </div>
        
        <div style="padding:15px;">
            <button class="modal-btn danger" onclick="closeModal('modal-island-list')">Close</button>
        </div>
    </div>
</div>

<div id="app-chat" class="app-window">
    
    <div class="app-header" id="chat-header">
        <div class="app-title">Messages</div>
        <button class="close-btn" id="chat-close-btn" onclick="closeApp('chat')">Close</button>
    </div>

    <div class="app-body" style="padding: 0; padding-bottom: 90px;"> <div id="chat-view-msg" class="chat-view active">
            <div class="online-users-area">
                <div class="settings-group-title" style="margin-left: 20px;">Active Now</div>
                <div class="online-scroll" id="chat-online-list">
                    </div>
            </div>

            <div class="chat-list-container" id="chat-list-box">
                <div class="empty-state">
                    <div style="font-size: 16px; color:#999; font-weight:500;">No messages yet</div>
                    <div style="font-size: 13px; color:#ccc;">Start a conversation with a friend</div>
                </div>
            </div>
        </div>

        <div id="chat-view-list" class="chat-view" style="display:none; flex-direction: column; height: 100%;">
    
            <div class="liquid-sub-nav-container">
                <div class="liquid-sub-nav">
                    <div class="sub-nav-item active" id="tab-friends" onclick="switchListSubTab('friends', this)">å¥½å‹</div>
                    <div class="sub-nav-item" id="tab-groups" onclick="switchListSubTab('groups', this)">ç¾¤èŠ</div>
                </div>
            </div>

            <div id="list-add-menu" class="add-menu-pop">
                <div class="menu-item" onclick="openCreateFriendModal()">åˆ›å»ºå¥½å‹</div>
                <div class="menu-item" onclick="openCreateGroupModal()">åˆ›å»ºç¾¤èŠ</div>
            </div>

            <div id="list-content-friends" class="list-scroll-area" style="flex: 1; overflow-y: auto;">
                <div class="empty-state" style="margin-top: 40px;">
                    <p style="color: #999; margin-top: 10px;">æš‚æ— å¥½å‹</p>
                </div>
            </div>
            
            <div id="list-content-groups" class="list-scroll-area" style="display:none; flex: 1; overflow-y: auto;">
                <div class="empty-state" style="margin-top: 40px;">
                    <p style="color: #999; margin-top: 10px;">æš‚æ— ç¾¤èŠ</p>
                </div>
            </div>
        </div>

        <div class="modal-mask" id="modal-create-friend">
            <div class="ios-modal">
                <div class="modal-title">åˆ›å»ºæ–°å¥½å‹</div>
                <div class="create-options">
                    <button id="btn-mode-manual" class="active" onclick="showManualCreate()">æ‰‹åŠ¨åˆ›å»º</button>
                    <button id="btn-mode-book" onclick="showBookSelect()">è§’è‰²ä¹¦å¯¼å…¥</button>
                </div>
                
                <div id="create-manual-form">
                    <div style="display:flex; justify-content:center; margin-bottom:15px;">
                        <div id="new-friend-avatar-box" class="avatar-preview-circle" onclick="document.getElementById('new-friend-avatar-upload').click()">
                            <img id="new-friend-avatar-img" src="" style="opacity:0;">
                            <div class="plus-icon-hint">+</div>
                        </div>
                    </div>
                    <input type="file" id="new-friend-avatar-upload" accept="image/*" style="display:none" onchange="handleNewFriendAvatar(this)">
                    
                    <div class="input-group">
                        <input type="text" id="new-friend-name" placeholder="è¯·è¾“å…¥å¥½å‹å" class="ios-input">
                    </div>
                </div>

                <div id="create-book-list" style="display:none; max-height: 250px; overflow-y: auto;">
                    </div>

                <div class="modal-btns">
                    <button class="modal-btn-cancel" onclick="closeModal('modal-create-friend')">å–æ¶ˆ</button>
                    <button class="modal-btn-confirm" onclick="confirmCreateFriend()">å®Œæˆ</button>
                </div>
            </div>
        </div>

        <div id="chat-view-moments" class="chat-view" style="display:none; padding:20px; text-align:center; color:#999;">
            <h3>Moments</h3>
            <p>Coming Soon...</p>
        </div>

        <div id="chat-view-profile" class="chat-view" style="display:none; padding:20px; text-align:center; color:#999;">
            <h3>My Profile</h3>
            <p>User Settings Here</p>
        </div>

    </div>

    <div class="chat-tab-bar">
        <div class="chat-tab-item active" onclick="switchChatTab('msg', this)">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            <span>æ¶ˆæ¯</span>
        </div>
        <div class="chat-tab-item" onclick="switchChatTab('list', this)">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </svg>
            <span>åˆ—è¡¨</span>
        </div>
        <div class="chat-tab-item" onclick="switchChatTab('moments', this)">
            <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><path d="M14.31 8l5.74 9.94M9.69 8h11.48M7.38 12l5.74-9.94M9.69 16H3.95M7.38 12L1.64 8M14.31 16H2.89"/></svg>
            <span>åŠ¨æ€</span>
        </div>
        <div class="chat-tab-item" onclick="switchChatTab('profile', this)">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>æˆ‘çš„</span>
        </div>
    </div>

</div>

<div class="modal-mask" id="modal-user-status" style="backdrop-filter: blur(15px);">
    <div class="status-card-body">
        <button class="status-close-btn" onclick="closeModal('modal-user-status')">Ã—</button>
        
        <div class="status-avatar-container">
            <div class="status-glow-ring"></div>
            <img id="status-card-avatar" src="" class="status-card-img">
            <div class="status-online-badge"></div>
        </div>

        <div class="status-info">
            <h2 id="status-card-name">User Name</h2>
            <p id="status-card-bio" class="status-bio">æ­£åœ¨å¬æ­Œ: å²¸è¾¹å®¢ ğŸµ</p>
            <div class="status-pill">Active Now</div>
        </div>

        <div class="status-actions-row">
            <button class="status-action-btn" onclick="startChatFromCard()">
                <div class="icon-circle msg">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                </div>
                <span>Message</span>
            </button>
            
            <button class="status-action-btn">
                <div class="icon-circle call">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </div>
                <span>Audio</span>
            </button>
            
            <button class="status-action-btn">
                <div class="icon-circle video">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                </div>
                <span>Video</span>
            </button>
        </div>
    </div>
</div>

<div class="modal-mask" id="modal-create-group">
    <div class="ios-modal">
        <div class="modal-title">å‘èµ·ç¾¤èŠ</div>
        <div class="input-group">
            <input type="text" id="group-name-input" placeholder="è¾“å…¥ç¾¤èŠåç§°" class="ios-input">
        </div>
        <div class="settings-group-title" style="margin-top:15px;">é€‰æ‹©æˆå‘˜</div>
        <div id="group-select-list" style="max-height:200px; overflow-y:auto; border:1px solid #f2f2f7; border-radius:10px; padding:5px;">
            </div>
        <div class="modal-btns">
            <button class="modal-btn-cancel" onclick="closeModal('modal-create-group')">å–æ¶ˆ</button>
            <button class="modal-btn-confirm" onclick="confirmCreateGroup()">åˆ›å»º</button>
        </div>
    </div>
</div>

<div class="modal-mask" id="modal-friend-delete">
    <div class="ios-modal" style="width: 280px; text-align: center;">
        <div class="modal-title" style="color: #000; margin-bottom: 10px;">åˆ é™¤å¥½å‹</div>
        <p style="color: #666; font-size: 14px; margin-bottom: 25px; line-height: 1.5;">
            åˆ é™¤åå°†æ— æ³•æ¢å¤èŠå¤©è®°å½•ã€‚<br>ç¡®å®šè¦åˆ é™¤ <span id="del-friend-name" style="color:#000; font-weight:bold;"></span> å—ï¼Ÿ
        </p>
        <div class="modal-btns" style="justify-content: center;">
            <button class="modal-btn-cancel" onclick="closeModal('modal-friend-delete')" style="flex:1;">å–æ¶ˆ</button>
            <button class="modal-btn-confirm" onclick="confirmRealDeleteFriend()" style="background: #ff3b30; color: #fff; flex:1;">åˆ é™¤</button>
        </div>
    </div>
</div>
<script>

    const appList = [
        // æ¡Œé¢ App
        { id: 'wallpapers', name: 'Wallpapers' },
        { id: 'wechat', name: 'WeChat' },
        { id: 'photos', name: 'Photos' },
        { id: 'settings', name: 'Settings' },
        { id: 'music', name: 'Music' },
        { id: 'shopping', name: 'Shopping' },
        { id: 'wallet', name: 'Wallet' },
        { id: 'phone', name: 'Phone' },
        
        // Dock æ  App
        { id: 'safari', name: 'Compass/Safari' },
        { id: 'worldbook', name: 'World Book' },
        { id: 'characters', name: 'Character Book' },
        { id: 'icons-app', name: 'Icon Store' } // ğŸ‘ˆ è¿™ä¸ªå°±æ˜¯ä½  Dock ä¸Šçš„ç¬¬4ä¸ªå›¾æ ‡
    ];

    let currentEditingAppId = null;
    /* --- 0. æ•°æ®åº“å¼•æ“ (ä¸“é—¨ç”¨æ¥å­˜å¤§æ–‡ä»¶) --- */
const dbRequest = indexedDB.open("OS_Database", 1);
let db;

let systemTimeOffset = null;

dbRequest.onupgradeneeded = function(e) {
    db = e.target.result;
    // åˆ›å»ºä¸¤ä¸ªä»“åº“ï¼šå­˜å£çº¸ã€å­˜éŸ³ä¹
    if (!db.objectStoreNames.contains('files')) {
        db.createObjectStore('files');
    }
};

dbRequest.onsuccess = function(e) {
    db = e.target.result;
    // æ•°æ®åº“æ‰“å¼€åï¼Œç«‹åˆ»å°è¯•æ¢å¤æ•°æ®
    loadFromDB();
};

function saveFileToDB(key, file) {
    if(!db) return;
    const tx = db.transaction(['files'], 'readwrite');
    tx.objectStore('files').put(file, key);
}

/* --- ä¿®å¤ 1ï¼šä»æ•°æ®åº“æ¢å¤æœ¬åœ°æ–‡ä»¶æ—¶ï¼ŒåŒæ—¶ä¹ŸåŠ åˆ°åˆ—è¡¨é‡Œ --- */
function loadFromDB() {
    if(!db) return;
    const tx = db.transaction(['files'], 'readonly');
    const store = tx.objectStore('files');

    // 1. æ¢å¤å£çº¸
    const wpReq = store.get('wallpaper');
    wpReq.onsuccess = () => {
        if (wpReq.result) {
            const url = URL.createObjectURL(wpReq.result);
            const type = wpReq.result.type.startsWith('video') ? 'video' : 'image';
            
            // A. åº”ç”¨åˆ°æ¡Œé¢èƒŒæ™¯
            applySystemWallpaper(url, type, false); 
            
            // B. ã€æ–°å¢ã€‘æŠŠè¿™ä¸ªæ–‡ä»¶ä¹ŸåŠ å›â€œå£çº¸Appâ€çš„åˆ—è¡¨é‡Œæ˜¾ç¤ºï¼
            addWallpaperToGrid(url, type);
        }
    };

    // 2. æ¢å¤éŸ³ä¹ (é€»è¾‘ä¸å˜)
    const musicReq = store.get('music');
    musicReq.onsuccess = () => {
        if (musicReq.result) {
            const url = URL.createObjectURL(musicReq.result);
            const player = document.getElementById('hidden-player');
            player.src = url;
        }
    };

    // 3. ã€æ–°å¢ã€‘æ¢å¤æ‰€æœ‰è‡ªå®šä¹‰å­—ä½“
    const userFonts = JSON.parse(localStorage.getItem('os_user_fonts') || '[]');
    userFonts.forEach(fontName => {
        const fontReq = store.get('font_' + fontName);
        fontReq.onsuccess = () => {
            if (fontReq.result) {
                // è¯»å–æ–‡ä»¶å†…å®¹å¹¶æ³¨å†Œ
                const reader = new FileReader();
                reader.onload = (e) => registerCustomFont(fontName, e.target.result);
                reader.readAsDataURL(fontReq.result);
            }
        };
    });

    loadAllCustomIcons();
    loadCharacters();
    loadWorlds();
    loadMusicApp();
    loadPlayerBackground();
}

    // --- æ ¸å¿ƒç³»ç»Ÿ ---
    /* --- ç»ˆæç‰ˆï¼šæ”¯æŒæ—¶åŒºä¿®æ”¹çš„ç³»ç»Ÿæ›´æ–°å‡½æ•° --- */
function updateSystem() {
    // 1. è·å–åŸºç¡€æ—¶é—´
    let date = new Date(); // ç°åœ¨çš„æœ¬åœ°æ—¶é—´

    // 2. å¦‚æœç”¨æˆ·è®¾ç½®äº†æ—¶åŒºï¼Œè¿›è¡Œåç§»è®¡ç®—
    if (systemTimeOffset !== null) {
        // ç®—æ³•ï¼š
        // date.getTime() = å½“å‰æ—¶é—´æˆ³
        // date.getTimezoneOffset() * 60000 = è¡¥å› UTC æ—¶é—´
        // systemTimeOffset * 3600000 = åŠ ä¸Šç›®æ ‡æ—¶åŒºçš„å°æ—¶æ•°
        const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
        date = new Date(utc + (3600000 * systemTimeOffset));
    }

    // 3. æå–æ—¶é—´éƒ¨ä»¶
    const h = String(date.getHours()).padStart(2,'0');
    const m = String(date.getMinutes()).padStart(2,'0');
    
    // 4. æ›´æ–°æ‰€æœ‰çŠ¶æ€æ  (Main + App) + è¶…çº§ç»„ä»¶
    document.querySelectorAll('.clock-text').forEach(el => el.textContent = `${h}:${m}`);
    const widgetTime = document.getElementById('w-time');
    if(widgetTime) widgetTime.textContent = `${h}:${m}`;
    const oldClock = document.getElementById('clock');
    if(oldClock) oldClock.textContent = `${h}:${m}`;

    // 5. æ›´æ–°æ—¥æœŸ (éœ€æ”¯æŒå¤šè¯­è¨€)
    const daysCN = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
    const wDateCn = document.getElementById('w-date-cn');
    // æ³¨æ„ï¼šè¿™é‡Œç”¨çš„æ˜¯è®¡ç®—åçš„ dateï¼Œæ‰€ä»¥æ—¥æœŸä¹Ÿä¼šè·ŸéšåŠå¤œè·¨å¤©è€Œå˜åŒ–ï¼
    if(wDateCn) wDateCn.textContent = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${daysCN[date.getDay()]}`;

    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const daysEN = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const wDateEn = document.getElementById('w-date-en');
    if(wDateEn) wDateEn.textContent = `${months[date.getMonth()]} ${date.getDate()}, ${daysEN[date.getDay()]}`;

    // 6. æ›´æ–°è¿›åº¦æ¡ (é€»è¾‘ä¿æŒä¸å˜)
    const totalMins = date.getHours() * 60 + date.getMinutes();
    const percent = (totalMins / 1440 * 100).toFixed(1);
    const progNum = document.getElementById('prog-num');
    const progBar = document.getElementById('prog-bar');
    if(progNum) progNum.textContent = percent + '%';
    if(progBar) progBar.style.width = percent + '%';
}

// å¹¶åœ¨ loadSavedSettings é‡ŒåŠ ä¸Šæ¢å¤æ—¶åŒºçš„é€»è¾‘ï¼š
/*
    const savedTZ = localStorage.getItem('os_timezone_offset');
    const savedTZName = localStorage.getItem('os_timezone_name');
    if(savedTZ !== null) {
        systemTimeOffset = parseFloat(savedTZ);
        document.getElementById('current-tz-display').textContent = `${savedTZName} (UTC ${savedTZ})`;
    }
*/
    setInterval(updateSystem, 1000);
    updateSystem();

    // --- 2. å£çº¸ App é€»è¾‘ ---
/* --- 1. ä¿®å¤ç”µæ± é€»è¾‘ (åªè®¤å…¨å±€ID) --- */
async function initBattery() {
    const fill = document.getElementById('global-battery-fill'); // æ”¹æˆå…¨å±€ID
    const text = document.getElementById('global-battery-text'); // æ”¹æˆå…¨å±€ID
    
    if ('getBattery' in navigator) {
        try {
            const b = await navigator.getBattery();
            const update = () => {
                const lvl = b.level;
                if(fill) fill.style.width = (lvl * 18) + 'px'; 
                if(text) text.textContent = Math.round(lvl * 100) + '%';
                
                // å……ç”µé€»è¾‘ï¼šå……ç”µå˜ç»¿ï¼Œä¸å……ç”µè·Ÿéšæ–‡å­—é¢œè‰²
                if(b.charging) {
                    if(fill) fill.style.background = '#34c759';
                } else {
                    if(fill) fill.style.background = 'currentColor'; // å…³é”®ï¼šè·Ÿéšçˆ¶å…ƒç´ é¢œè‰²
                }
            };
            b.addEventListener('levelchange', update);
            b.addEventListener('chargingchange', update);
            update();
        } catch(e){ if(text) text.textContent="100%"; }
    } else { if(text) text.textContent="100%"; }
}

/* --- 2. æ‰“å¼€ App (çŠ¶æ€æ å˜é»‘) --- */
/* --- ä¿®å¤ç‰ˆï¼šæ‰“å¼€ App (è§£å†³æ­»å¾ªç¯) --- */
function openApp(appName) {
    // 1. å…¨å±€çŠ¶æ€æ å˜é»‘
    const gb = document.getElementById('global-status-bar');
    if (gb) gb.classList.add('text-dark');

    // 2. ä¾æ¬¡åˆ¤æ–­æ‰“å¼€å“ªä¸ª App
    if(appName === 'wallpapers') document.getElementById('app-wallpapers').style.display = 'flex';
    if(appName === 'settings') document.getElementById('app-settings').style.display = 'flex';
    if(appName === 'phone') document.getElementById('app-phone').style.display = 'flex';
    if(appName === 'characters') {
        document.getElementById('app-characters').style.display = 'flex';
        if(typeof renderCharList === 'function') renderCharList(); 
    }
    if(appName === 'worldbook') {
        document.getElementById('app-worldbook').style.display = 'flex';
        if(typeof renderWorldList === 'function') renderWorldList();
    }

    // âœ… 3. å›¾æ ‡å•†åº—é€»è¾‘ (é‡ç‚¹æ£€æŸ¥è¿™é‡Œ)
    if(appName === 'icons') {
        const app = document.getElementById('app-icons');
        if(app) {
            app.style.display = 'flex';
            // è¿™é‡Œçš„ renderIconAppList å¿…é¡»åœ¨ä¹‹å‰å®šä¹‰è¿‡
            if(typeof renderIconAppList === 'function') {
                renderIconAppList(); 
            } else {
                console.error("renderIconAppList å‡½æ•°æ²¡æ‰¾åˆ°ï¼è¯·æ£€æŸ¥ä»£ç æ˜¯å¦å¤åˆ¶å®Œæ•´ï¼");
            }
        }
    }

    if(appName === 'music') {
        const app = document.getElementById('app-music');
        if(app) {
            app.style.display = 'flex';
            // é¡ºä¾¿åŠ è½½ä¸€ä¸‹éŸ³ä¹åˆ—è¡¨ï¼ˆå¦‚æœæœ‰è¿™ä¸ªå‡½æ•°çš„è¯ï¼‰
            if(typeof loadMusicApp === 'function') loadMusicApp();
        } else {
            console.error("æ‰¾ä¸åˆ° id='app-music' çš„çª—å£ï¼Œè¯·æ£€æŸ¥ HTML æ˜¯å¦å¤åˆ¶å®Œæ•´ï¼");
        }
    }

    if(appName === 'chat') {
        document.getElementById('app-chat').style.display = 'flex';
        initChatApp();      // åˆå§‹åŒ–åœ¨çº¿å¤´åƒ
        renderFriendsList(); // âœ… æ¸²æŸ“å¥½å‹åˆ—è¡¨
        renderGroupsList();  // âœ… æ¸²æŸ“ç¾¤èŠåˆ—è¡¨
    }


}

/* --- ä¿®å¤ç‰ˆï¼šä¿ç•™è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†å…¼å®¹ HTML é‡Œå†™æ­»çš„ onclick --- */
function openSettingsApp() {
    // ç›´æ¥è°ƒç”¨é€šç”¨çš„ openAppï¼Œè®©å®ƒå»å¤„ç†
    openApp('settings');
}

/* --- 3. å…³é—­ App (çŠ¶æ€æ å˜ç™½) --- */
function closeApp(appName) {
    document.getElementById('global-status-bar').classList.remove('text-dark');
    
    if(appName === 'wallpapers') document.getElementById('app-wallpapers').style.display = 'none';
    if(appName === 'settings') document.getElementById('app-settings').style.display = 'none';
    if(appName === 'phone') document.getElementById('app-phone').style.display = 'none';
    
    // âœ… æ–°å¢ï¼šå…³é—­ Icons App
    if(appName === 'icons') document.getElementById('app-icons').style.display = 'none';
    if(appName === 'characters') {
        document.getElementById('app-characters').style.display = 'none';
        // ç¨å¾®å»¶è¿Ÿé‡ç½®å›åˆ—è¡¨é¡µï¼Œä½“éªŒæ›´å¥½
        setTimeout(() => backToCharList(), 300);
    }

    if(appName === 'worldbook') document.getElementById('app-worldbook').style.display = 'none';

    if(appName === 'music') {
        document.getElementById('app-music').style.display = 'none';
        
        // å¯é€‰ä¼˜åŒ–ï¼šå…³é—­ App æ—¶ï¼ŒæŠŠå…¨å±æ’­æ”¾å™¨ä¹Ÿæ”¶èµ·æ¥
        // è¿™æ ·ä¸‹æ¬¡æ‰“å¼€æ—¶ï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ç›´æ¥æ€¼è„¸ä¸€å¼ å¤§å°é¢
        setTimeout(() => {
            closeFullPlayer();
        }, 300);
    }

    if(appName === 'chat') document.getElementById('app-chat').style.display = 'none';
}

// å¤„ç†ä¸Šä¼ 
// --- ä¿®æ”¹ï¼šä¸Šä¼ å£çº¸ (å­˜å…¥DB) ---
function handleWallpaperUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileType = file.type.startsWith('video') ? 'video' : 'image';
        const url = URL.createObjectURL(file);
        
        // 1. ç«‹åˆ»åº”ç”¨
        addWallpaperToGrid(url, fileType); 
        
        // 2. ã€å…³é”®ã€‘å­˜è¿›æ•°æ®åº“ï¼
        saveFileToDB('wallpaper', file);
        
        // 3. æ ‡è®°ä½ æ˜¯ç”¨äº†æœ¬åœ°æ–‡ä»¶
        localStorage.setItem('os_wp_source', 'local'); 
    }
}

// æ·»åŠ åˆ°é¢„è§ˆç½‘æ ¼
function addWallpaperToGrid(src, type) {
    const grid = document.getElementById('wp-grid');
    const div = document.createElement('div');
    div.className = 'wp-card';
    
    let mediaHtml = '';
    let tag = '';
    
    if (type === 'video') {
        mediaHtml = `<video class="wp-preview-media" src="${src}" loop muted autoplay></video>`;
        tag = '<span class="wp-tag">VIDEO</span>';
    } else {
        mediaHtml = `<img class="wp-preview-media" src="${src}">`;
        tag = '<span class="wp-tag">IMG</span>';
    }

    div.innerHTML = `
        ${mediaHtml}
        ${tag}
        <button class="wp-apply-btn">Apply</button>
    `;

    // ç‚¹å‡»åº”ç”¨å£çº¸
    div.onclick = function() {
        applySystemWallpaper(src, type);
        // è§†è§‰åé¦ˆ
        document.querySelectorAll('.wp-card').forEach(c => c.classList.remove('active'));
        div.classList.add('active');
    };

    grid.prepend(div); // æ–°ä¸Šä¼ çš„æ’åœ¨æœ€å‰
}

// çœŸæ­£çš„åº”ç”¨å£çº¸é€»è¾‘
// --- ä¿®æ”¹ï¼šåº”ç”¨å£çº¸ ---
function applySystemWallpaper(src, type, shouldSave = true) {
    const bgLayer = document.getElementById('bg-layer');
    const bgVideo = document.getElementById('bg-video');

    if (type === 'video') {
        bgLayer.style.backgroundImage = 'none';
        bgVideo.style.display = 'block';
        bgVideo.src = src;
        bgVideo.play().catch(e => console.log("ç­‰å¾…äº¤äº’"));
    } else {
        bgVideo.style.display = 'none';
        bgVideo.pause();
        bgLayer.style.backgroundImage = `url('${src}')`;
    }

    // å¦‚æœæ˜¯ç½‘ç»œé“¾æ¥ï¼Œè¿˜æ˜¯ç”¨ localStorage å­˜ url
    if (shouldSave && src.startsWith('http')) {
        localStorage.setItem('os_wp_source', 'url');
        localStorage.setItem('os_wp_url', src);
        localStorage.setItem('os_wp_type', type);
        // æ¸…ç©ºæ•°æ®åº“é‡Œçš„æœ¬åœ°æ–‡ä»¶ï¼Œå…å¾—æ··æ·†
        if(db) {
            const tx = db.transaction(['files'], 'readwrite');
            tx.objectStore('files').delete('wallpaper');
        }
    }
}

    /* --- 1. ä¿®å¤ç”µæ± é€»è¾‘ (åªè®¤å…¨å±€ID) --- */
async function initBattery() {
    const fill = document.getElementById('global-battery-fill'); // æ”¹æˆå…¨å±€ID
    const text = document.getElementById('global-battery-text'); // æ”¹æˆå…¨å±€ID
    
    if ('getBattery' in navigator) {
        try {
            const b = await navigator.getBattery();
            const update = () => {
                const lvl = b.level;
                if(fill) fill.style.width = (lvl * 18) + 'px'; 
                if(text) text.textContent = Math.round(lvl * 100) + '%';
                
                // å……ç”µé€»è¾‘ï¼šå……ç”µå˜ç»¿ï¼Œä¸å……ç”µè·Ÿéšæ–‡å­—é¢œè‰²
                if(b.charging) {
                    if(fill) fill.style.background = '#34c759';
                } else {
                    if(fill) fill.style.background = 'currentColor'; // å…³é”®ï¼šè·Ÿéšçˆ¶å…ƒç´ é¢œè‰²
                }
            };
            b.addEventListener('levelchange', update);
            b.addEventListener('chargingchange', update);
            update();
        } catch(e){ if(text) text.textContent="100%"; }
    } else { if(text) text.textContent="100%"; }
}
    initBattery();

    // --- åŸå¸‚æ•°æ® ---
    const cityDB = {
        'cn': [ // === å›½å†…åŸå¸‚ ===
            { name: "ğŸ“ ä¹Œé²æœ¨é½", lat: 43.82, lon: 87.62 }, // å®¶ä¹¡ (ç½®é¡¶)
            { name: "ğŸ‡¨ğŸ‡³ åŒ—äº¬", lat: 39.90, lon: 116.40 },
            { name: "ğŸ™ï¸ ä¸Šæµ·", lat: 31.23, lon: 121.47 },
            { name: "ğŸ² å¹¿å·", lat: 23.13, lon: 113.26 },
            { name: "ğŸŒ´ æ·±åœ³", lat: 22.54, lon: 114.05 },
            { name: "ğŸ¼ æˆéƒ½", lat: 30.57, lon: 104.06 },
            { name: "ğŸµ æ­å·", lat: 30.27, lon: 120.15 },
            { name: "ğŸŒ¶ï¸ é‡åº†", lat: 29.56, lon: 106.55 },
            { name: "ğŸ¦† å—äº¬", lat: 32.06, lon: 118.79 },
            { name: "ğŸœ æ­¦æ±‰", lat: 30.59, lon: 114.30 },
            { name: "ğŸ—¿ è¥¿å®‰", lat: 34.34, lon: 108.94 },
            { name: "ğŸï¸ å¦é—¨", lat: 24.47, lon: 118.08 },
            { name: "ğŸŒ¶ï¸ é•¿æ²™", lat: 28.23, lon: 112.93 },
            { name: "ğŸŒ¸ æ˜†æ˜", lat: 25.05, lon: 102.72 },
            { name: "ğŸ° å“ˆå°”æ»¨", lat: 45.80, lon: 126.53 },
            { name: "ğŸŒŠ ä¸‰äºš", lat: 18.25, lon: 109.51 },
            { name: "ğŸ¥Ÿ å¤©æ´¥", lat: 39.13, lon: 117.20 },
            { name: "ğŸ›¶ è‹å·", lat: 31.29, lon: 120.58 },
            { name: "ğŸš‚ éƒ‘å·", lat: 34.74, lon: 113.62 },
            { name: "ğŸ™ï¸ é¦™æ¸¯", lat: 22.31, lon: 114.16 },
            { name: "ğŸ° æ¾³é—¨", lat: 22.19, lon: 113.54 },
            { name: "ğŸ™ï¸ å°åŒ—", lat: 25.03, lon: 121.56 },
            { name: "ğŸœ å…°å·", lat: 36.06, lon: 103.83 },
            { name: "ğŸ”ï¸ æ‹‰è¨", lat: 29.65, lon: 91.11 },
            { name: "ğŸº é’å²›", lat: 36.07, lon: 120.38 },
            { name: "âš™ï¸ æ²ˆé˜³", lat: 41.80, lon: 123.43 },
            { name: "ğŸŒŠ å¤§è¿", lat: 38.91, lon: 121.60 },
            { name: "ğŸŒ³ è´µé˜³", lat: 26.64, lon: 106.63 },
            { name: "ğŸŒ¾ å—å®", lat: 22.81, lon: 108.36 },
            { name: "â›°ï¸ æµå—", lat: 36.65, lon: 117.12 }
        ],
        'intl': [ // === å›½é™…åŸå¸‚ ===
            { name: "ğŸ‡¯ğŸ‡µ ä¸œäº¬", lat: 35.68, lon: 139.69 },
            { name: "ğŸ‡ºğŸ‡¸ çº½çº¦", lat: 40.71, lon: -74.00 },
            { name: "ğŸ‡ºğŸ‡¸ æ´›æ‰çŸ¶", lat: 34.05, lon: -118.24 },
            { name: "ğŸ‡ºğŸ‡¸ æ—§é‡‘å±±", lat: 37.77, lon: -122.41 },
            { name: "ğŸ‡¬ğŸ‡§ ä¼¦æ•¦", lat: 51.50, lon: -0.12 },
            { name: "ğŸ‡«ğŸ‡· å·´é»", lat: 48.85, lon: 2.35 },
            { name: "ğŸ‡©ğŸ‡ª æŸæ—", lat: 52.52, lon: 13.40 },
            { name: "ğŸ‡·ğŸ‡º è«æ–¯ç§‘", lat: 55.75, lon: 37.61 },
            { name: "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡", lat: 1.35, lon: 103.81 },
            { name: "ğŸ‡°ğŸ‡· é¦–å°”", lat: 37.56, lon: 126.97 },
            { name: "ğŸ‡¹ğŸ‡­ æ›¼è°·", lat: 13.75, lon: 100.50 },
            { name: "ğŸ‡¦ğŸ‡º æ‚‰å°¼", lat: -33.86, lon: 151.20 },
            { name: "ğŸ‡¨ğŸ‡¦ å¤šä¼¦å¤š", lat: 43.65, lon: -79.38 },
            { name: "ğŸ‡¦ğŸ‡ª è¿ªæ‹œ", lat: 25.20, lon: 55.27 },
            { name: "ğŸ‡®ğŸ‡¹ ç½—é©¬", lat: 41.90, lon: 12.49 },
            { name: "ğŸ‡ªğŸ‡¸ é©¬å¾·é‡Œ", lat: 40.41, lon: -3.70 },
            { name: "ğŸ‡³ğŸ‡± é˜¿å§†æ–¯ç‰¹ä¸¹", lat: 52.36, lon: 4.90 },
            { name: "ğŸ‡¹ğŸ‡· ä¼Šæ–¯å¦å¸ƒå°”", lat: 41.00, lon: 28.97 },
            { name: "ğŸ‡ªğŸ‡¬ å¼€ç½—", lat: 30.04, lon: 31.23 },
            { name: "ğŸ‡§ğŸ‡· é‡Œçº¦çƒ­å†…å¢", lat: -22.90, lon: -43.17 },
            { name: "ğŸ‡¦ğŸ‡· å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯", lat: -34.60, lon: -58.38 }
        ]
    };

    function renderCityList(category) {
        const box = document.getElementById('city-list-box');
        box.innerHTML = ''; 
        const list = cityDB[category];
        list.forEach(city => {
            const btn = document.createElement('button');
            btn.className = 'city-btn';
            btn.textContent = city.name;
            btn.onclick = () => getRealWeather(city.lat, city.lon, city.name);
            box.appendChild(btn);
        });
    }
    function switchCityTab(category, btnElement) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        renderCityList(category);
    }
    renderCityList('cn');

    async function getRealWeather(lat, lon, name) {
        const tag = document.getElementById('w-weather');
        tag.textContent = "Updating...";
        closeModal('modal-weather');
        localStorage.setItem('os_city_data', JSON.stringify({ lat, lon, name }));
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            if(data.current_weather) {
                const temp = Math.round(data.current_weather.temperature);
                const code = data.current_weather.weathercode;
                let icon = 'â˜€ï¸';
                if(code > 3) icon = 'â›…';
                if(code > 45) icon = 'ğŸŒ«ï¸';
                if(code > 50) icon = 'ğŸŒ§ï¸';
                if(code > 70) icon = 'â„ï¸';
                const cleanName = name.substring(name.indexOf(' ') + 1);
                tag.textContent = `${icon} ${temp}Â°C ${cleanName}`;
            }
        } catch(e) { tag.textContent = "Failed"; }
    }

    // --- åŠ è½½/ä¿å­˜é€»è¾‘ (å«éŸ³ä¹) ---
    function loadFromUrl(target) {
        let inputId = '', modalId = '';
        if(target === 'bg') { inputId = 'bg-url-input'; modalId = 'modal-bg-settings'; }
        else if(target === 'widget-bg') { inputId = 'wbg-url-input'; modalId = 'modal-widget-settings'; }
        else if(target === 'photo') { inputId = 'img-url-input'; modalId = 'modal-photo'; }
        else { /* music-coverå¤ç”¨img-url-input */ inputId = 'img-url-input'; modalId = 'modal-photo'; }

        const url = document.getElementById(inputId).value;
        if(url) {
            applyImage(target, url);
            closeModal(modalId);
            document.getElementById(inputId).value = ''; 
        } else { alert("Please enter a URL!"); }
    }

    function uploadFile(input, target) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                applyImage(target, e.target.result);
                if(target==='bg') closeModal('modal-bg-settings');
                else if(target==='widget-bg') closeModal('modal-widget-settings');
                else closeModal('modal-photo');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function applyImage(target, src) {
        if(target === 'bg') {
            const s = `url('${src}')`; document.getElementById('bg-layer').style.backgroundImage = s;
            localStorage.setItem('os_bg', s);
        } else if(target === 'widget-bg') {
            const s = `url('${src}')`; document.getElementById('widget-bg').style.backgroundImage = s;
            localStorage.setItem('os_widget_bg', s);
        } else if(target === 'music-cover') {
            document.getElementById('music-album-img').src = src;
            localStorage.setItem('os_music_cover', src);
        } else {
            document.getElementById('my-photo').src = src;
            localStorage.setItem('os_widget_photo', src);
        }
    }

    // éŸ³ä¹æ’­æ”¾å™¨é€»è¾‘
    const player = document.getElementById('hidden-player');
    const capsule = document.querySelector('.music-capsule');
    let isPlaying = false;

    function togglePlay() {
        if (isPlaying) { player.pause(); capsule.classList.remove('playing'); } 
        else {
            if (!player.src) { openAudioModal(); return; }
            player.play().catch(e => alert("Please upload audio!"));
            capsule.classList.add('playing');
        }
        isPlaying = !isPlaying;
    }
    function openAudioModal() { document.getElementById('modal-audio').style.display = 'flex'; }
    function loadAudioFromUrl() {
        const url = document.getElementById('audio-url-input').value;
        if(url) {
            player.src = url; player.play();
            capsule.classList.add('playing'); isPlaying = true;
            closeModal('modal-audio');
            localStorage.setItem('os_music_src', url);
        }
    }
    // --- ä¿®æ”¹ï¼šä¸Šä¼ éŸ³ä¹ (å­˜å…¥DB) ---
    function uploadAudioFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);
            
            const player = document.getElementById('hidden-player');
            player.src = url;
            player.play();
            
            const capsule = document.querySelector('.music-capsule');
            capsule.classList.add('playing'); 
            isPlaying = true;
            
            closeModal('modal-audio');

            // ã€å…³é”®ã€‘å­˜è¿›æ•°æ®åº“ï¼
            saveFileToDB('music', file);
        }
    }

    // å¼¹çª—æ§åˆ¶
    function openBgModal() { document.getElementById('modal-bg-settings').style.display = 'flex'; }
    function changeBgOpacity(val) {
        // 1. è®¾ç½®èƒŒæ™¯é€æ˜åº¦ (è¿™è¡Œå¿…é¡»ä¿ç•™ï¼Œç”¨æ¥æ¢å¤å£çº¸æ•ˆæœ)
        const bgLayer = document.getElementById('bg-layer');
        if (bgLayer) bgLayer.style.opacity = val / 100;

        // 2. æ›´æ–°å¼¹çª—é‡Œçš„æ–‡å­— (åŠ ä¸ªåˆ¤æ–­ï¼šå¦‚æœå…ƒç´ å­˜åœ¨æ‰æ›´æ–°ï¼Œä¸å­˜åœ¨å°±è·³è¿‡)
        const textLabel = document.getElementById('opacity-val');
        if (textLabel) textLabel.textContent = val + '%';

        // 3. ä¿å­˜è®¾ç½®
        localStorage.setItem('os_bg_opacity', val);
    }
    function openWidgetSettings() { document.getElementById('modal-widget-settings').style.display = 'flex'; }
    function changeWidgetOpacity(val) {
        document.getElementById('widget-bg').style.opacity = val / 100;
        document.getElementById('w-opacity-val').textContent = val + '%';
        localStorage.setItem('os_widget_opacity', val);
    }
    // å¤ç”¨ç›¸å†Œå¼¹çª—ç»™éŸ³ä¹æ¢å°é¢
    function openPhotoModal(mode) { 
        // ä¸´æ—¶è¦†ç›– loadFromUrl çš„ target å‚æ•°
        const btnUrl = document.querySelector('#modal-photo .btn-group .primary');
        const btnFile = document.querySelector('#modal-photo .btn-group .modal-btn:nth-child(2)');
        const fileInput = document.getElementById('file-upload-photo');
        
        let target = mode === 'music-cover' ? 'music-cover' : 'photo';
        
        btnUrl.onclick = function() { loadFromUrl(target); };
        btnFile.onclick = function() { fileInput.click(); };
        fileInput.onchange = function() { uploadFile(this, target); };
        
        document.getElementById('modal-photo').style.display = 'flex'; 
    }
    function openWeatherModal() { document.getElementById('modal-weather').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- æ¢å¤è®¾ç½® ---
    /* --- ä¿®å¤ 2ï¼šä»ç¼“å­˜æ¢å¤é“¾æ¥æ—¶ï¼Œä¹ŸåŠ åˆ°åˆ—è¡¨é‡Œ --- */
function loadSavedSettings() {
    // 1. æ¢å¤ç½‘ç»œé“¾æ¥å£çº¸
    const source = localStorage.getItem('os_wp_source');
    if (source === 'url') {
        const url = localStorage.getItem('os_wp_url');
        const type = localStorage.getItem('os_wp_type');
        if(url) {
            applySystemWallpaper(url, type, false);
            // ã€æ–°å¢ã€‘å¦‚æœæ˜¯é“¾æ¥ï¼Œä¹ŸåŠ å›åˆ—è¡¨æ˜¾ç¤º
            addWallpaperToGrid(url, type);
        }
    }

    // 2. æ¢å¤é€æ˜åº¦ (ä¿æŒä¸å˜)
    let savedBgOp = localStorage.getItem('os_bg_opacity');
    if(savedBgOp) changeBgOpacity(savedBgOp);

    // 3. æ¢å¤ç»„ä»¶è®¾ç½® (ä¿æŒä¸å˜)
    const savedWBg = localStorage.getItem('os_widget_bg');
    if(savedWBg) document.getElementById('widget-bg').style.backgroundImage = savedWBg;

    const savedWOp = localStorage.getItem('os_widget_opacity');
    if(savedWOp) { changeWidgetOpacity(savedWOp); document.getElementById('w-opacity-slider').value = savedWOp; }

    const savedPhoto = localStorage.getItem('os_widget_photo');
    if(savedPhoto) document.getElementById('my-photo').src = savedPhoto;

    // 4. æ¢å¤éŸ³ä¹é“¾æ¥ (ä¿æŒä¸å˜)
    const savedMusicSrc = localStorage.getItem('os_music_src');
    if(savedMusicSrc) document.getElementById('hidden-player').src = savedMusicSrc;
    const savedMusicCover = localStorage.getItem('os_music_cover');
    if(savedMusicCover) document.getElementById('music-album-img').src = savedMusicCover;

    loadFontSettings();
    loadIslandSettings();

    // 5. æ¢å¤å¤©æ°” (ä¿æŒä¸å˜)
    const savedCity = localStorage.getItem('os_city_data');
    if(savedCity) {
        const d = JSON.parse(savedCity);
        getRealWeather(d.lat, d.lon, d.name);
    } else { getRealWeather(43.82, 87.62, "ğŸ“ Urumqi"); }

    // ğŸ‘‡ã€æ–°å¢ã€‘6. æ¢å¤æ—¶åŒºè®¾ç½® (åŠ åœ¨å‡½æ•°çš„æœ€åé¢)
    const savedTZ = localStorage.getItem('os_timezone_offset');
    const savedTZName = localStorage.getItem('os_timezone_name');
    
    if(savedTZ !== null && savedTZName) {
        // æ¢å¤å˜é‡
        systemTimeOffset = parseFloat(savedTZ);
        
        // æ¢å¤è®¾ç½®Appé‡Œçš„æ˜¾ç¤ºæ–‡å­—
        const tzDisplay = document.getElementById('current-tz-display');
        if(tzDisplay) {
            tzDisplay.textContent = `${savedTZName} (UTC ${savedTZ})`;
        }
        
        // ç«‹å³åˆ·æ–°ä¸€ä¸‹ç³»ç»Ÿæ—¶é—´
        updateSystem();
    }
}
    window.addEventListener('load', loadSavedSettings);

    /* --- æ—¶åŒºæ•°æ® (åˆ†ç±»æ•´ç†) --- */
/* --- æ—¶åŒºæ•°æ® (å…¨ä¸­æ–‡ç‰ˆ) --- */
const timeZoneDB = {
    "Asia (äºšæ´²)": [
        { city: "åŒ—äº¬ / ä¸Šæµ·", offset: 8 },
        { city: "é¦™æ¸¯", offset: 8 },
        { city: "å°åŒ—", offset: 8 },
        { city: "ä¹Œé²æœ¨é½", offset: 6 },
        { city: "ä¸œäº¬ / å¤§é˜ª", offset: 9 },
        { city: "é¦–å°”", offset: 9 },
        { city: "æ–°åŠ å¡", offset: 8 },
        { city: "å‰éš†å¡", offset: 8 },
        { city: "æ›¼è°·", offset: 7 },
        { city: "æ²³å†…", offset: 7 },
        { city: "é›…åŠ è¾¾", offset: 7 },
        { city: "æ–°å¾·é‡Œ / å­Ÿä¹°", offset: 5.5 },
        { city: "åŠ å¾·æ»¡éƒ½", offset: 5.75 },
        { city: "è¾¾å¡", offset: 6 },
        { city: "å¡æ‹‰å¥‡", offset: 5 },
        { city: "è¿ªæ‹œ / é˜¿å¸ƒæ‰æ¯”", offset: 4 },
        { city: "å¾·é»‘å…°", offset: 3.5 },
        { city: "åˆ©é›…å¾—", offset: 3 },
        { city: "è€¶è·¯æ’’å†·", offset: 2 }
    ],
    "Europe (æ¬§æ´²)": [
        { city: "ä¼¦æ•¦ (GMT)", offset: 0 },
        { city: "éƒ½æŸæ—", offset: 0 },
        { city: "å·´é»", offset: 1 },
        { city: "æŸæ—", offset: 1 },
        { city: "ç½—é©¬", offset: 1 },
        { city: "é©¬å¾·é‡Œ", offset: 1 },
        { city: "é˜¿å§†æ–¯ç‰¹ä¸¹", offset: 1 },
        { city: "è‹é»ä¸–", offset: 1 },
        { city: "æ–¯å¾·å“¥å°”æ‘©", offset: 1 },
        { city: "å¸ƒæ‹‰æ ¼", offset: 1 },
        { city: "é›…å…¸", offset: 2 },
        { city: "èµ«å°”è¾›åŸº", offset: 2 },
        { city: "åŸºè¾…", offset: 2 },
        { city: "è«æ–¯ç§‘", offset: 3 },
        { city: "ä¼Šæ–¯å¦å¸ƒå°”", offset: 3 }
    ],
    "Americas (ç¾æ´²)": [
        { city: "çº½çº¦ / åç››é¡¿", offset: -5 },
        { city: "å¤šä¼¦å¤š", offset: -5 },
        { city: "èŠåŠ å“¥", offset: -6 },
        { city: "ä¼‘æ–¯é¡¿", offset: -6 },
        { city: "å¢¨è¥¿å“¥åŸ", offset: -6 },
        { city: "ä¸¹ä½›", offset: -7 },
        { city: "æ´›æ‰çŸ¶ / æ—§é‡‘å±±", offset: -8 },
        { city: "æ¸©å“¥å", offset: -8 },
        { city: "è¥¿é›…å›¾", offset: -8 },
        { city: "å®‰å…‹é›·å¥‡", offset: -9 },
        { city: "æª€é¦™å±± (å¤å¨å¤·)", offset: -10 },
        { city: "åœ£ä¿ç½—", offset: -3 },
        { city: "é‡Œçº¦çƒ­å†…å¢", offset: -3 },
        { city: "å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯", offset: -3 },
        { city: "åœ£åœ°äºšå“¥", offset: -4 },
        { city: "åˆ©é©¬", offset: -5 },
        { city: "æ³¢å“¥å¤§", offset: -5 }
    ],
    "Pacific (å¤§æ´‹æ´²)": [
        { city: "æ‚‰å°¼ / å¢¨å°”æœ¬", offset: 11 },
        { city: "å¸ƒé‡Œæ–¯ç­", offset: 10 },
        { city: "é˜¿å¾·è±å¾·", offset: 10.5 },
        { city: "ç€æ–¯", offset: 8 },
        { city: "å¥¥å…‹å…°", offset: 13 },
        { city: "æƒ çµé¡¿", offset: 13 },
        { city: "æ–æµ", offset: 12 }
    ],
    "Africa (éæ´²)": [
        { city: "å¼€ç½—", offset: 2 },
        { city: "çº¦ç¿°å†…æ–¯å ¡", offset: 2 },
        { city: "å¼€æ™®æ•¦", offset: 2 },
        { city: "æ‹‰å„æ–¯", offset: 1 },
        { city: "å†…ç½—æ¯•", offset: 3 },
        { city: "å¡è¨å¸ƒå…°å¡", offset: 1 }
    ]
};

/* --- è®¾ç½® App é€»è¾‘ --- */
function openSettingsApp() {
    openApp('settings'); // å¤ç”¨ä¹‹å‰çš„ openApp å‡½æ•°ï¼Œè®°å¾—å» HTML é‡ŒæŠŠ Settings å›¾æ ‡çš„ onclick æ”¹äº†
    document.getElementById('app-settings').style.display = 'flex';
}

function openTimeZonePage() {
    document.getElementById('settings-timezone-view').style.display = 'flex';
    setTimeout(() => {
        document.getElementById('settings-timezone-view').style.transform = 'translateX(0)';
    }, 10); // åŠ¨æ•ˆå»¶è¿Ÿ
    renderTimeZones(); // æ¸²æŸ“åˆ—è¡¨
}

function backToMainSettings(viewId) {
    const view = document.getElementById(viewId);
    if(view) {
        view.style.transform = 'translateX(100%)';
        setTimeout(() => view.style.display = 'none', 300);
    }
}

// æ¸²æŸ“æ—¶åŒºåˆ—è¡¨
function renderTimeZones(filterText = "") {
    const container = document.getElementById('timezone-list-container');
    container.innerHTML = "";
    
    // éå†æ‰€æœ‰å¤§æ´²
    for (const [continent, cities] of Object.entries(timeZoneDB)) {
        // è¿‡æ»¤åŸå¸‚
        const filteredCities = cities.filter(c => c.city.toLowerCase().includes(filterText.toLowerCase()));
        
        if (filteredCities.length > 0) {
            const title = document.createElement('div');
            title.className = "settings-group-title";
            title.textContent = continent;
            container.appendChild(title);

            const group = document.createElement('div');
            group.className = "settings-group";
            
            filteredCities.forEach(item => {
                const div = document.createElement('div');
                div.className = "settings-item";
                // UTC æ˜¾ç¤ºæ ¼å¼ä¼˜åŒ–
                const offsetStr = item.offset >= 0 ? `+${item.offset}` : item.offset;
                
                div.innerHTML = `
                    <div class="set-text">${item.city}</div>
                    <div style="color:#8e8e93; font-size:14px">UTC ${offsetStr}</div>
                `;
                
                // ç‚¹å‡»åˆ‡æ¢æ—¶åŒº
                div.onclick = () => changeSystemTimeZone(item.offset, item.city);
                group.appendChild(div);
            });
            container.appendChild(group);
        }
    }
}

// æœç´¢åŠŸèƒ½
function filterTimeZones(text) {
    renderTimeZones(text);
}

// --- æ ¸å¿ƒï¼šåˆ‡æ¢ç³»ç»Ÿæ—¶é—´ç®—æ³• ---
function changeSystemTimeZone(targetOffset, cityName) {
    // 1. è®¡ç®—åç§»é‡
    // ç›®æ ‡æ—¶åŒºåç§»(å°æ—¶) * 60 * 60 * 1000 = æ¯«ç§’
    // è¿˜éœ€è¦å‡å»æµè§ˆå™¨æœ¬åœ°çš„æ—¶åŒºåç§»
    
    const now = new Date();
    const localOffsetMinutes = now.getTimezoneOffset(); // æµè§ˆå™¨æœ¬åœ°ä¸UTCçš„åˆ†é’Ÿå·® (æ³¨æ„ï¼šå®ƒæ˜¯åçš„ï¼Œä¸œå…«åŒºæ˜¯ -480)
    
    // è®¡ç®—ç›®æ ‡æ—¶åŒºç›¸å¯¹äºUTCçš„æ¯«ç§’æ•°
    const targetUTC = targetOffset * 60 * 60 * 1000;
    
    // è¿™é‡Œåªä¿å­˜â€œç›®æ ‡æ—¶åŒºâ€ï¼Œå…·ä½“çš„è®¡ç®—åœ¨ updateSystem é‡Œåšå®æ—¶ç®—
    localStorage.setItem('os_timezone_offset', targetOffset);
    localStorage.setItem('os_timezone_name', cityName);
    
    systemTimeOffset = parseFloat(targetOffset);
    
    // æ›´æ–° UI
    document.getElementById('current-tz-display').textContent = `${cityName} (UTC ${targetOffset})`;
    backToMainSettings();
    updateSystem(); // ç«‹å³åˆ·æ–°æ—¶é—´
}

/* ============================================================
   === æ ¸å¿ƒä¿®å¤ï¼šAI API æ¨¡å—å®Œæ•´ä»£ç  (å¤åˆ¶è¿™ä¸€æ•´å—) ===
   ============================================================ */

// --- 1. æ‰“å¼€/åˆå§‹åŒ– API é¡µé¢ ---
function openAPIPage() {
    const view = document.getElementById('settings-api-view');
    view.style.display = 'flex';
    setTimeout(() => view.style.transform = 'translateX(0)', 10);
    
    // æ‰“å¼€æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
    loadLLMConfig();
    renderPresets();
}

// --- 2. iOS å¼¹çª—æ§åˆ¶ç³»ç»Ÿ ---
function showIOSAlert(title, msg) {
    const titleEl = document.getElementById('ios-alert-title');
    const msgEl = document.getElementById('ios-alert-msg');
    const alertBox = document.getElementById('ios-alert');
    
    if(titleEl && msgEl && alertBox) {
        titleEl.textContent = title;
        msgEl.textContent = msg;
        alertBox.style.display = 'flex';
    } else {
        console.error("iOS Alert HTML missing! Check your body HTML."); 
        alert(msg); //ä»¥æ­¤ä¿åº•
    }
}

function closeIOSAlert() {
    const alertBox = document.getElementById('ios-alert');
    if(alertBox) alertBox.style.display = 'none';
}

// --- 3. ä¸‹æ‹‰èœå•äº¤äº’é€»è¾‘ ---
function toggleModelList() {
    const list = document.getElementById('model-list');
    list.classList.toggle('show');
    
    // ç‚¹å‡»å¤–éƒ¨è‡ªåŠ¨å…³é—­
    const closeMenu = function(e) {
        if(!e.target.closest('.settings-item')) {
            list.classList.remove('show');
            document.removeEventListener('click', closeMenu);
        }
    };
    setTimeout(() => document.addEventListener('click', closeMenu), 0);
}

function selectModel(modelName) {
    document.getElementById('model-select').value = modelName;
    const trigger = document.getElementById('model-trigger');
    trigger.textContent = modelName;
    trigger.style.color = "#000"; 
    document.getElementById('model-list').classList.remove('show');
}

// --- 4. è·å–æ¨¡å‹åˆ—è¡¨ (Fetch) ---
async function fetchModels() {
    const url = document.getElementById('api-url').value.replace(/\/$/, '');
    const key = document.getElementById('api-key').value;
    const list = document.getElementById('model-list');
    const trigger = document.getElementById('model-trigger');
    
    if(!url || !key) { showIOSAlert("Missing Info", "Please enter URL and Key first!"); return; }

    trigger.textContent = "Loading...";
    
    try {
        const res = await fetch(`${url}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
        if(!res.ok) throw new Error(`HTTP Error: ${res.status}`);
        const data = await res.json();
        
        list.innerHTML = ''; 
        const models = data.data || data;
        
        if(Array.isArray(models)) {
            models.forEach(m => {
                const div = document.createElement('div');
                div.className = 'custom-option';
                div.textContent = m.id;
                div.onclick = () => selectModel(m.id);
                list.appendChild(div);
            });
            trigger.textContent = "Select Model â€º"; 
            showIOSAlert("Success", `Found ${models.length} models. Tap 'Select Model' to choose.`);
            list.classList.add('show');
        }
    } catch (e) {
        trigger.textContent = "Fetch Failed";
        showIOSAlert("Error", e.message);
    }
}

// --- 5. æµ‹è¯•è¿æ¥ (Test) ---
async function testAPIConnection() {
    const url = document.getElementById('api-url').value.replace(/\/$/, '');
    const key = document.getElementById('api-key').value;
    const model = document.getElementById('model-select').value;
    const output = document.getElementById('test-output');
    const userMsg = document.getElementById('test-msg-input').value || "Hello!";

    if(!model) { showIOSAlert("No Model", "Please select a model first!"); return; }

    output.textContent = `Sending: "${userMsg}"...`;
    output.style.color = "#666";

    try {
        const res = await fetch(`${url}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: userMsg }],
                max_tokens: 60
            })
        });

        const data = await res.json();
        if(data.choices && data.choices.length > 0) {
            output.textContent = "âœ… Reply:\n" + data.choices[0].message.content;
            output.style.color = "#34c759"; 
        } else {
            throw new Error(JSON.stringify(data));
        }
    } catch (e) {
        output.textContent = "âŒ Error: " + e.message;
        output.style.color = "#ff3b30";
    }
}

// --- 6. ä¿å­˜è®¾ç½®åˆ°æœ¬åœ° (Save Config) ---
function saveLLMConfig() {
    const config = {
        url: document.getElementById('api-url').value,
        key: document.getElementById('api-key').value,
        model: document.getElementById('model-select').value
    };
    localStorage.setItem('os_llm_config', JSON.stringify(config));
    showIOSAlert("Saved", "System API settings have been updated.");
}

// --- 7. åŠ è½½è®¾ç½® (Load Config) ---
function loadLLMConfig() {
    const saved = localStorage.getItem('os_llm_config');
    if(saved) {
        const config = JSON.parse(saved);
        document.getElementById('api-url').value = config.url || '';
        document.getElementById('api-key').value = config.key || '';
        
        if(config.model) {
            document.getElementById('model-select').value = config.model;
            const trigger = document.getElementById('model-trigger');
            trigger.textContent = config.model;
            trigger.style.color = "#000";
        }
    }
}

// --- 8. é¢„è®¾ç®¡ç† (Presets) ---
function saveAsPreset() {
    const name = document.getElementById('preset-name').value;
    if(!name) { showIOSAlert("Naming", "Please enter a name for this preset."); return; }
    
    const config = {
        name: name,
        url: document.getElementById('api-url').value,
        key: document.getElementById('api-key').value,
        model: document.getElementById('model-select').value
    };

    let presets = JSON.parse(localStorage.getItem('os_llm_presets') || '[]');
    presets.push(config);
    localStorage.setItem('os_llm_presets', JSON.stringify(presets));
    
    document.getElementById('preset-name').value = ''; 
    renderPresets();
    showIOSAlert("Preset Added", `Config "${name}" saved.`);
}

function renderPresets() {
    const list = document.getElementById('preset-list');
    const presets = JSON.parse(localStorage.getItem('os_llm_presets') || '[]');
    
    list.innerHTML = '';
    presets.forEach((p, index) => {
        const div = document.createElement('div');
        div.className = 'preset-item';
        div.innerHTML = `
            <div>
                <div class="preset-name">${p.name}</div>
                <div class="preset-model">${p.model || 'No model'}</div>
            </div>
            <div class="preset-actions">
                <button class="preset-btn load" onclick="loadPreset(${index})">Load</button>
                <button class="preset-btn del" onclick="deletePreset(${index})">Del</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function loadPreset(index) {
    const presets = JSON.parse(localStorage.getItem('os_llm_presets') || '[]');
    const p = presets[index];
    if(p) {
        document.getElementById('api-url').value = p.url;
        document.getElementById('api-key').value = p.key;
        
        document.getElementById('model-select').value = p.model || '';
        const trigger = document.getElementById('model-trigger');
        trigger.textContent = p.model || 'Select Model â€º';
        if(p.model) trigger.style.color = "#000";

        showIOSAlert("Loaded", `Preset "${p.name}" loaded! Click Test to verify.`);
    }
}

function deletePreset(index) {
    let presets = JSON.parse(localStorage.getItem('os_llm_presets') || '[]');
    presets.splice(index, 1);
    localStorage.setItem('os_llm_presets', JSON.stringify(presets));
    renderPresets();
}

/* =========================================
   === å­—ä½“ & æ ·å¼ç®¡ç†ç³»ç»Ÿ ===
   ========================================= */

// 1. åˆå§‹åŒ–ä¸é¡µé¢æ§åˆ¶
function openFontPage() {
    const view = document.getElementById('settings-font-view');
    view.style.display = 'flex';
    setTimeout(() => view.style.transform = 'translateX(0)', 10);
    loadFontSettings(); // æ‰“å¼€æ—¶åŠ è½½è®¾ç½®
}

/* --- ä¿®å¤ï¼šå­—ä½“é¢„è§ˆ & æ•°å€¼æ˜¾ç¤º --- */
function updateFontPreview() {
    const size = document.getElementById('font-size-slider').value;
    const weight = document.getElementById('font-weight-slider').value;
    
    // 1. å®æ—¶æ›´æ–°æ ‡ç­¾æ•°å€¼ (è®©æ ‡ç¤ºæ›´æ¸…æ¥š)
    document.getElementById('lbl-font-size').textContent = size + 'px';
    document.getElementById('lbl-font-weight').textContent = weight;

    // 2. åº”ç”¨åˆ°é¢„è§ˆå¡ç‰‡
    const preview = document.getElementById('preview-text');
    preview.style.fontSize = size + 'px';
    preview.style.fontWeight = weight;
    
    // 3. å®æ—¶åº”ç”¨åˆ°ç³»ç»Ÿ (å¯é€‰ï¼šå¦‚æœä½ æƒ³ç‚¹ä¿å­˜æ‰ç”Ÿæ•ˆï¼Œå°±æŠŠä¸‹é¢è¿™ä¸¤è¡Œæ³¨é‡Šæ‰)
    document.documentElement.style.setProperty('--global-font-size', size + 'px');
    document.documentElement.style.setProperty('--global-font-weight', weight);
}

/* --- æ–°å¢ï¼šæ‰‹åŠ¨ä¿å­˜å­—ä½“è®¾ç½® --- */
function saveFontConfig() {
    const size = document.getElementById('font-size-slider').value;
    const weight = document.getElementById('font-weight-slider').value;
    
    // è·å–å½“å‰é€‰ä¸­çš„é¢œè‰²ï¼ˆä» CSS å˜é‡é‡Œæ‹¿æœ€å‡†ï¼‰
    const color = getComputedStyle(document.documentElement).getPropertyValue('--global-text-color').trim();

    // å­˜ï¼
    localStorage.setItem('os_font_size', size);
    localStorage.setItem('os_font_weight', weight);
    localStorage.setItem('os_font_color', color); // å…³é”®æ˜¯å­˜è¿™ä¸ª

    showIOSAlert("Saved", "Font style updated successfully.");
}

function setFontColor(color) {
    // åº”ç”¨åˆ°å…¨å±€
    document.documentElement.style.setProperty('--global-text-color', color);
    
    // é¢„è§ˆå¡ç‰‡ä¹Ÿå˜è‰²
    document.getElementById('preview-text').style.color = color;
    
    localStorage.setItem('os_font_color', color);
}

// 3. å­—ä½“åˆ‡æ¢é€»è¾‘
function applyFont(fontName, type) {
    // 1. åº”ç”¨åˆ°å…¨å±€
    document.documentElement.style.setProperty('--global-font-family', `"${fontName}", sans-serif`);
    
    // 2. é¢„è§ˆå¡ç‰‡åº”ç”¨
    document.getElementById('preview-text').style.fontFamily = fontName;
    
    // 3. UI é€‰ä¸­çŠ¶æ€æ›´æ–°
    document.querySelectorAll('.settings-item').forEach(el => el.classList.remove('active-font'));
    // æ‰¾åˆ°å¯¹åº”å­—ä½“çš„å‹¾é€‰æ¡† (ç®€å•çš„ ID åŒ¹é…)
    const checkId = 'check-' + fontName;
    const checkEl = document.getElementById(checkId);
    if(checkEl) checkEl.parentElement.classList.add('active-font');
    
    // 4. ä¿å­˜
    localStorage.setItem('os_font_family', fontName);
    localStorage.setItem('os_font_type', type); // 'system' or 'custom'
}

// 4. ç”¨æˆ·å¯¼å…¥å­—ä½“ (IndexedDB å­˜å‚¨)
function handleFontUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const fontName = file.name.split('.')[0]; // ç”¨æ–‡ä»¶åå½“å­—ä½“å
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const fontData = e.target.result;
            
            // A. æ³¨å†Œå­—ä½“åˆ°é¡µé¢
            registerCustomFont(fontName, fontData);
            
            // B. å­˜å…¥ IndexedDB
            saveFileToDB('font_' + fontName, file);
            
            // C. åŠ åˆ°åˆ—è¡¨å¹¶è‡ªåŠ¨é€‰ä¸­
            addUserFontToList(fontName);
            applyFont(fontName, 'custom');
            
            // ä¿å­˜å¯¼å…¥è®°å½•
            let userFonts = JSON.parse(localStorage.getItem('os_user_fonts') || '[]');
            if(!userFonts.includes(fontName)) {
                userFonts.push(fontName);
                localStorage.setItem('os_user_fonts', JSON.stringify(userFonts));
            }
            
            showIOSAlert("Font Added", `Font "${fontName}" installed successfully.`);
        };
        reader.readAsDataURL(file); // è¯»å–ä¸º base64
    }
}

// åŠ¨æ€æ³¨å†Œå­—ä½“ (@font-face)
function registerCustomFont(name, dataUrl) {
    const style = document.createElement('style');
    style.textContent = `
        @font-face {
            font-family: "${name}";
            src: url("${dataUrl}");
        }
    `;
    document.head.appendChild(style);
}

function addUserFontToList(name) {
    const list = document.getElementById('user-font-list');
    // é˜²æ­¢é‡å¤
    if(document.getElementById('check-' + name)) return;

    const div = document.createElement('div');
    div.className = 'settings-item';
    div.onclick = () => applyFont(name, 'custom');
    div.innerHTML = `
        <div class="set-text" style="font-family:'${name}'">${name}</div>
        <div class="check-icon" id="check-${name}">âœ“</div>
        <button onclick="event.stopPropagation(); deleteUserFont('${name}')" style="border:none;background:none;color:#ff3b30;font-size:12px">Del</button>
    `;
    list.appendChild(div);
}

function deleteUserFont(name) {
    // åˆ è®°å½•
    let userFonts = JSON.parse(localStorage.getItem('os_user_fonts') || '[]');
    userFonts = userFonts.filter(f => f !== name);
    localStorage.setItem('os_user_fonts', JSON.stringify(userFonts));
    
    // åˆ  DOM
    loadFontSettings(); // é‡æ–°åŠ è½½åˆ—è¡¨æœ€ç®€å•
    
    // æ¢å¤é»˜è®¤å­—ä½“
    applyFont('Inter', 'system');
    
    // åˆ æ•°æ®åº“ (å¯é€‰ï¼Œå¦‚æœä½ æƒ³çœç©ºé—´)
    if(db) {
        const tx = db.transaction(['files'], 'readwrite');
        tx.objectStore('files').delete('font_' + name);
    }
}

// 5. åŠ è½½æ‰€æœ‰è®¾ç½® (å¼€æœº/åˆ·æ–°æ—¶)
function loadFontSettings() {
    // A. æ¢å¤åŸºæœ¬æ•°å€¼
    const size = localStorage.getItem('os_font_size') || '16';
    const weight = localStorage.getItem('os_font_weight') || '400';
    const color = localStorage.getItem('os_font_color') || '#000000';
    
    document.getElementById('font-size-slider').value = size;
    document.getElementById('font-weight-slider').value = weight;
    
    // åº”ç”¨å…¨å±€å˜é‡
    document.documentElement.style.setProperty('--global-font-size', size + 'px');
    document.documentElement.style.setProperty('--global-font-weight', weight);
    document.documentElement.style.setProperty('--global-text-color', color);

    // B. æ¢å¤ç”¨æˆ·å­—ä½“åˆ—è¡¨
    const userFonts = JSON.parse(localStorage.getItem('os_user_fonts') || '[]');
    document.getElementById('user-font-list').innerHTML = ''; // æ¸…ç©º
    userFonts.forEach(name => addUserFontToList(name));
    
    // C. æ¢å¤é€‰ä¸­çš„å­—ä½“
    const currentFont = localStorage.getItem('os_font_family') || 'Inter';
    applyFont(currentFont, localStorage.getItem('os_font_type'));
    
    // D. å¦‚æœæ˜¯è‡ªå®šä¹‰å­—ä½“ï¼Œéœ€è¦ä» DB è¯»å‡ºæ¥é‡æ–°æ³¨å†Œ
    if(localStorage.getItem('os_font_type') === 'custom') {
        // è¿™ä¸ªé€»è¾‘å·²ç»ç”± dbRequest.onsuccess é‡Œçš„ loadFromDB å¤„ç†äº†
        // æˆ‘ä»¬åªéœ€è¦ç¡®ä¿ loadFromDB é‡Œé¢åŠ ä¸€æ®µæ¢å¤å­—ä½“çš„é€»è¾‘å³å¯ ğŸ‘‡
    }

}

/* =========================================
   === çµåŠ¨èƒ¶å›Š (Smart Capsule) ç®¡ç†ç³»ç»Ÿ ===
   ========================================= */

const DEFAULT_ISLAND_CSS = `width: 120px;
height: 35px;
background: #000000;
border-radius: 20px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);`;

// 1. æ‰“å¼€é¡µé¢ (ä¿®å¤ï¼šå¼ºåˆ¶åŒæ­¥å¼€å…³çŠ¶æ€)
function openIslandPage() {
    const view = document.getElementById('settings-island-view');
    view.style.display = 'flex';
    setTimeout(() => view.style.transform = 'translateX(0)', 10);
    
    // A. åŠ è½½ CSS ä»£ç 
    const savedCSS = localStorage.getItem('os_island_css');
    const input = document.getElementById('island-css-input');
    input.value = savedCSS || DEFAULT_ISLAND_CSS;
    
    // B. ã€ä¿®å¤ã€‘è¯»å–å¼€å…³çŠ¶æ€
    // åªè¦ä¸æ˜¯ 'false'ï¼Œæˆ‘ä»¬éƒ½è®¤ä¸ºæ˜¯å¼€å¯çš„ (æˆ–è€…ä½ å¯ä»¥ä¸¥è°¨ç‚¹åªè®¤ 'true')
    // è¿™é‡Œæˆ‘ä»¬ä¸¥è°¨ä¸€ç‚¹ï¼šå¿…é¡»æ˜¯å­—ç¬¦ä¸² 'true' æ‰æ˜¯å¼€
    const savedState = localStorage.getItem('os_island_enabled');
    const isEnabled = (savedState === 'true'); 
    
    // C. åŒæ­¥å¼€å…³ UI
    const toggle = document.getElementById('island-toggle');
    if (toggle) {
        toggle.checked = isEnabled;
    }
    
    // D. è§¦å‘é¢„è§ˆ
    updateIslandPreview();
}

// 2. ã€æ–°å¢ã€‘å¤„ç†å¼€å…³æ‹¨åŠ¨ (è‡ªåŠ¨ä¿å­˜)
function handleIslandToggle(isChecked) {
    // 1. è§†è§‰å˜åŒ–
    toggleIsland(isChecked);
    
    // 2. ç«‹å³ä¿å­˜çŠ¶æ€ï¼(ä¸éœ€è¦ç‚¹ä¸‹é¢çš„ Save æŒ‰é’®äº†)
    localStorage.setItem('os_island_enabled', isChecked);
    
    // 3. å¯é€‰ï¼šç»™ä¸ªéœ‡åŠ¨åé¦ˆæˆ–è€…å°æç¤º
    // showIOSAlert("Status", isChecked ? "Enabled" : "Disabled");
}

// 2. å®æ—¶é¢„è§ˆé€»è¾‘ (ä¿®å¤ç‰ˆ)
function updateIslandPreview() {
    const cssText = document.getElementById('island-css-input').value;
    const previewBox = document.getElementById('island-preview-box');
    
    // æŠ€å·§ï¼šæŠŠç”¨æˆ·å†™çš„ CSS åº”ç”¨ä¸Šå»ï¼Œä½†å¼ºåˆ¶è¦†ç›–å®šä½å±æ€§ï¼Œé˜²æ­¢é¢„è§ˆé£èµ°
    // æˆ‘ä»¬æŠŠ position: relative !important åŠ åœ¨æœ€åé¢ï¼Œæƒé™æœ€é«˜
    previewBox.style.cssText = cssText + " position: relative !important; top: 0 !important; left: auto !important; transform: none !important; opacity: 1 !important;"; 
}

// 3. æ‰§è¡Œå¼€å…³çš„è§†è§‰é€»è¾‘
function toggleIsland(checked) {
    const mainIsland = document.getElementById('smart-capsule');
    if(checked) {
        mainIsland.classList.add('active');
    } else {
        mainIsland.classList.remove('active');
    }
}

// 4. ä¿å­˜ CSS é…ç½® (åªè´Ÿè´£ CSS)
function saveIslandConfig() {
    const cssText = document.getElementById('island-css-input').value;
    
    // ä¿å­˜ CSS
    localStorage.setItem('os_island_css', cssText);
    
    // åº”ç”¨æ ·å¼
    applyIslandStyleToMain(cssText);
    
    // å†æ¬¡ç¡®è®¤å¼€å…³çŠ¶æ€ (åŒé‡ä¿é™©)
    const isEnabled = document.getElementById('island-toggle').checked;
    localStorage.setItem('os_island_enabled', isEnabled);
    toggleIsland(isEnabled);
    
    showIOSAlert("Applied", "Style settings updated.");
}

// 5. åº”ç”¨æ ·å¼åˆ°ä¸»èƒ¶å›Š (åŠ¨æ€æ³¨å…¥ Style)
function applyIslandStyleToMain(css) {
    const mainIsland = document.getElementById('smart-capsule');
    // å¼ºåˆ¶åŠ ä¸Šå®šä½å±æ€§ï¼Œé˜²æ­¢ç”¨æˆ·æŠŠå®šä½åˆ äº†å¯¼è‡´é”™ä½
    mainIsland.style.cssText = css; 
    
    // å¼ºåˆ¶ä¿®æ­£å®šä½ (é˜²æ­¢ç”¨æˆ·ä¹±æ”¹ top/left å¯¼è‡´é£å‡ºå±å¹•)
    // å¦‚æœä½ æƒ³è®©ç”¨æˆ·å®Œå…¨è‡ªç”±æ§åˆ¶ä½ç½®ï¼Œå¯ä»¥å»æ‰ä¸‹é¢è¿™å‡ è¡Œ
    mainIsland.style.position = 'absolute';
    mainIsland.style.top = '10px';
    mainIsland.style.left = '50%';
    mainIsland.style.transform = 'translateX(-50%)';
}

// 6. é‡ç½®
function resetIslandConfig() {
    document.getElementById('island-css-input').value = DEFAULT_ISLAND_CSS;
    updateIslandPreview();
}

// 7. å¼€æœºåŠ è½½ (Load Settings)
function loadIslandSettings() {
    const savedCSS = localStorage.getItem('os_island_css');
    const isEnabled = localStorage.getItem('os_island_enabled') === 'true';
    
    if(savedCSS) {
        applyIslandStyleToMain(savedCSS);
    }
    toggleIsland(isEnabled);
}

function renderIconAppList() {
    const list = document.getElementById('icon-app-list'); // æ³¨æ„è¿™é‡Œ ID å˜äº†
    list.innerHTML = '';
    
    appList.forEach(app => {
        const currentIconHtml = getAppIconHtml(app.id);
        const div = document.createElement('div');
        div.className = 'settings-item';
        // è¿™é‡Œçš„ç‚¹å‡»äº‹ä»¶å’Œä¹‹å‰ä¸€æ ·ï¼Œæ‰“å¼€å¼¹çª—
        div.onclick = () => openIconModal(app.id);
        
        div.innerHTML = `
            <div class="set-icon" style="background:transparent; border:1px solid #eee; overflow:hidden; display:flex; justify-content:center; align-items:center;">
                <div style="transform:scale(0.5); width:62px; height:62px; display:flex; justify-content:center; align-items:center;">
                    ${currentIconHtml}
                </div>
            </div>
            <div class="set-text">${app.name}</div>
            <div class="set-arrow" style="font-size:14px; color:#007aff; background:#f2f2f7; padding:5px 10px; border-radius:15px;">Change</div>
        `;
        list.appendChild(div);
    });
}

/* ============================================================
   === æ ¸å¿ƒä¿®å¤ï¼šå›¾æ ‡ç®¡ç†ç³»ç»Ÿ (Icons App Brain) ===
   ============================================================ */

// 1. å®šä¹‰ App åˆ—è¡¨ (è¿™ä¸‹ç³»ç»Ÿå°±è®¤è¯†å®ƒä»¬äº†)
// æ³¨æ„ï¼šè¿™é‡Œçš„ ID å¿…é¡»å’Œä½  HTML é‡Œçš„ data-app-id ä¸€æ¨¡ä¸€æ ·ï¼


// 2. æ¸²æŸ“å›¾æ ‡å•†åº—åˆ—è¡¨ (ä¿®å¤ç‰ˆ)
function renderIconAppList() {
    const list = document.getElementById('icon-app-list');
    if (!list) return; // é˜²æ­¢æ‰¾ä¸åˆ°å…ƒç´ æŠ¥é”™
    
    list.innerHTML = '';
    
    appList.forEach(app => {
        // è·å–å½“å‰å›¾æ ‡é•¿ä»€ä¹ˆæ · (å¯èƒ½æ˜¯ SVGï¼Œä¹Ÿå¯èƒ½æ˜¯ç”¨æˆ·æ¢è¿‡çš„å›¾)
        const currentIconHtml = getAppIconHtml(app.id);
        
        const div = document.createElement('div');
        div.className = 'settings-item'; // å¤ç”¨è®¾ç½®é¡¹æ ·å¼
        div.onclick = () => openIconModal(app.id); // ç‚¹å‡»å¼¹å‡ºä¸Šä¼ æ¡†
        
        div.innerHTML = `
            <div class="set-icon" style="background:transparent; border:1px solid #eee; overflow:hidden; display:flex; justify-content:center; align-items:center;">
                <div style="transform:scale(0.6); width:62px; height:62px; display:flex; justify-content:center; align-items:center;">
                    ${currentIconHtml}
                </div>
            </div>
            <div class="set-text">${app.name}</div>
            <div class="set-arrow" style="font-size:14px; color:#007aff; background:#f2f2f7; padding:5px 12px; border-radius:15px; font-weight:600;">Change</div>
        `;
        list.appendChild(div);
    });
}

// 3. æ‰“å¼€ä¸Šä¼ å¼¹çª—
function openIconModal(appId) {
    currentEditingAppId = appId;
    document.getElementById('modal-icon-change').style.display = 'flex';
    document.getElementById('icon-url-input').value = '';
    
    // åœ¨å¼¹çª—é‡Œé¢„è§ˆå½“å‰çš„å›¾æ ‡
    const previewBox = document.getElementById('icon-preview-box');
    previewBox.innerHTML = getAppIconHtml(appId);
    // å¦‚æœæ˜¯ SVGï¼ŒåŠ ç‚¹ç¼©æ”¾è®©å®ƒåœ¨é¢„è§ˆæ¡†é‡Œå¥½çœ‹ç‚¹
    if(previewBox.querySelector('svg')) {
        previewBox.style.display = 'flex';
        previewBox.style.alignItems = 'center';
        previewBox.style.justifyContent = 'center';
    }
}

// 4. å¤„ç†æ–‡ä»¶é€‰æ‹© (é¢„è§ˆå›¾ç‰‡)
function handleIconFileSelect(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            updateIconPreview(e.target.result);
            // è‡ªåŠ¨è¿›å…¥ç¡®è®¤æµç¨‹
            confirmIconChange('file', input.files[0]); 
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function updateIconPreview(src) {
    const box = document.getElementById('icon-preview-box');
    box.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:18px;">`;
}

// 5. ç¡®è®¤ä¿®æ”¹ (æ ¸å¿ƒä¿å­˜é€»è¾‘)
function confirmIconChange(type, file = null) {
    let src = '';
    
    if (type === 'url') {
        src = document.getElementById('icon-url-input').value;
        if(!src) { showIOSAlert("Error", "Please enter a URL"); return; }
        saveIconToSystem(currentEditingAppId, src);
    } 
    else if (type === 'file' && file) {
        // å­˜å…¥ IndexedDB æ•°æ®åº“ (å­˜å¤§å›¾ç‰‡)
        saveFileToDB('icon_' + currentEditingAppId, file);
        
        // åˆ›å»ºä¸´æ—¶ URL ç«‹åˆ»æ˜¾ç¤º
        src = URL.createObjectURL(file);
        saveIconToSystem(currentEditingAppId, src, true); // true æ ‡è®°ä¸ºæœ¬åœ°æ–‡ä»¶
    }
    
    closeModal('modal-icon-change');
    showIOSAlert("Updated", "App icon changed successfully!");
    renderIconAppList(); // åˆ·æ–°åˆ—è¡¨ï¼Œè®©åˆ—è¡¨é‡Œçš„å›¾æ ‡ä¹Ÿå˜
}

// 6. ä¿å­˜åˆ° localStorage å¹¶æ›´æ–°ç•Œé¢
function saveIconToSystem(appId, src, isBlob = false) {
    // å­˜è·¯å¾„
    if (!isBlob) {
        localStorage.setItem('icon_url_' + appId, src);
    } else {
        localStorage.setItem('icon_url_' + appId, 'blob'); // æ ‡è®°è¿™æ˜¯ä¸ªæ•°æ®åº“æ–‡ä»¶
    }
    
    // å®æ—¶æ›´æ–°æ¡Œé¢å’ŒDockä¸Šçš„å›¾æ ‡
    updateAllIcons(appId, src);
}

// 7. è¿˜åŸé»˜è®¤å›¾æ ‡
function restoreDefaultIcon() {
    // åˆ æ‰è®°å½•
    localStorage.removeItem('icon_url_' + currentEditingAppId);
    
    // å¦‚æœæ˜¯æ•°æ®åº“æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é¡ºä¾¿åˆ ä¸€ä¸‹(å¯é€‰)
    // åˆ·æ–°é¡µé¢æ˜¯æ¢å¤ SVG æœ€ç®€å•çš„åŠæ³•
    location.reload(); 
}

// 8. è¾…åŠ©ï¼šæ›´æ–°é¡µé¢ä¸Šæ‰€æœ‰è¯¥ ID çš„å›¾æ ‡ (Desktop + Dock)
function updateAllIcons(appId, src) {
    // æ‰¾åˆ°æ‰€æœ‰è´´äº†è¯¥ ID èº«ä»½è¯çš„å›¾æ ‡
    const icons = document.querySelectorAll(`.app-icon[data-app-id="${appId}"]`);
    icons.forEach(icon => {
        // æš´åŠ›æ›¿æ¢æˆå›¾ç‰‡
        icon.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:18px;">`;
        // å»æ‰åŸæœ¬ SVG çš„èƒŒæ™¯è‰²å’Œè¾¹æ¡†ï¼Œåªç•™åœ†è§’
        icon.style.background = 'transparent';
        icon.style.border = 'none';
        icon.style.boxShadow = 'none'; // å¯é€‰ï¼šå¦‚æœä½ æƒ³è¦å›¾ç‰‡ä¹Ÿæœ‰é˜´å½±å°±å»æ‰è¿™è¡Œ
    });
}

// 9. è¾…åŠ©ï¼šè·å–å½“å‰å›¾æ ‡çš„ HTML (ç”¨äºåˆ—è¡¨å±•ç¤º)
function getAppIconHtml(appId) {
    const existing = document.querySelector(`.app-icon[data-app-id="${appId}"]`);
    // å…‹éš†ä¸€ä»½ HTMLï¼Œä¸ç„¶ç›´æ¥æ‹¿èµ°æ¡Œé¢å›¾æ ‡å°±æ²¡äº†
    return existing ? existing.innerHTML : '?';
}

// 10. å¼€æœºåŠ è½½ (æœ€é‡è¦çš„ä¸€æ­¥ï¼)
function loadAllCustomIcons() {
    appList.forEach(app => {
        const type = localStorage.getItem('icon_url_' + app.id);
        
        if (type === 'blob') {
            // æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œå»æ•°æ®åº“å–
            if(db) {
                const tx = db.transaction(['files'], 'readonly');
                const req = tx.objectStore('files').get('icon_' + app.id);
                req.onsuccess = () => {
                    if(req.result) {
                        const url = URL.createObjectURL(req.result);
                        updateAllIcons(app.id, url);
                    }
                };
            }
        } else if (type) {
            // æ˜¯ç½‘ç»œé“¾æ¥ï¼Œç›´æ¥ç”¨
            updateAllIcons(app.id, type);
        }
    });
}

/* =========================================
   === è§’è‰²ä¹¦ (Character Book) ç³»ç»Ÿ ===
   ========================================= */

let characters = []; // å†…å­˜ä¸­çš„è§’è‰²åˆ—è¡¨
let editingCharId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘/æŸ¥çœ‹çš„è§’è‰²ID

// 1. åˆå§‹åŒ–ï¼šå¼€æœºåŠ è½½è§’è‰²
function loadCharacters() {
    const saved = localStorage.getItem('os_characters_data');
    if (saved) {
        characters = JSON.parse(saved);
        renderCharList(); // æ¸²æŸ“åˆ—è¡¨
    }
}
// âš ï¸ è®°å¾—æŠŠ loadCharacters() åŠ åˆ° loadFromDB çš„æœ€åä¸€è¡Œï¼

// 2. æ¸²æŸ“åˆ—è¡¨
function renderCharList() {
    const container = document.getElementById('character-list');
    container.innerHTML = '';
    
    characters.forEach(char => {
        const div = document.createElement('div');
        div.className = 'char-card';
        div.onclick = () => viewCharacter(char.id); // ç‚¹å‡»çœ‹è¯¦æƒ…
        
        // å°è¯•ä»DBè·å–å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºé»˜è®¤
        let avatarSrc = ''; // é»˜è®¤ç©º
        
        div.innerHTML = `
            <img class="char-card-avatar" id="list-avatar-${char.id}" src="">
            <div class="char-card-info">
                <div class="char-card-name">${char.name}</div>
                <div class="char-card-desc">${char.desc}</div>
            </div>
            <div style="color:#c7c7cc">â€º</div>
        `;
        container.appendChild(div);
        
        // å¼‚æ­¥åŠ è½½å¤´åƒ
        loadCharImage(char.id, 'avatar', `list-avatar-${char.id}`);
    });
}

// 3. æ‰“å¼€æ·»åŠ å¼¹çª—
function openCharModal(charId = null) {
    const modal = document.getElementById('modal-char-edit');
    const title = document.getElementById('char-modal-title');
    const nameInput = document.getElementById('char-input-name');
    const descInput = document.getElementById('char-input-desc');
    const previewImg = document.getElementById('char-preview-img');
    
    modal.style.display = 'flex';
    
    if (charId) {
        // ç¼–è¾‘æ¨¡å¼
        const char = characters.find(c => c.id === charId);
        editingCharId = charId;
        title.textContent = "ç¼–è¾‘è§’è‰²";
        nameInput.value = char.name;
        descInput.value = char.desc;
        // åŠ è½½ç°æœ‰å¤´åƒé¢„è§ˆ
        loadCharImage(charId, 'avatar', 'char-preview-img');
        previewImg.style.opacity = 1;
    } else {
        // æ–°å¢æ¨¡å¼
        editingCharId = null; // null è¡¨ç¤ºæ–°å¢
        title.textContent = "æ·»åŠ æ–°è§’è‰²";
        nameInput.value = '';
        descInput.value = '';
        previewImg.src = '';
        previewImg.style.opacity = 0;
    }
}

// 4. å¤„ç†å¤´åƒé€‰æ‹© (é¢„è§ˆ)
let tempAvatarFile = null; // æš‚å­˜æ–‡ä»¶
function handleCharAvatarSelect(input) {
    if (input.files && input.files[0]) {
        tempAvatarFile = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('char-preview-img');
            img.src = e.target.result;
            img.style.opacity = 1;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 5. ä¿å­˜è§’è‰² (æ ¸å¿ƒ)
function saveCharacterData() {
    const name = document.getElementById('char-input-name').value;
    const desc = document.getElementById('char-input-desc').value;
    
    if (!name) { showIOSAlert("æç¤º", "è¯·è¾“å…¥è§’è‰²æ˜µç§°"); return; }
    
    let charId = editingCharId;
    
    if (!charId) {
        // æ–°å¢ï¼šç”Ÿæˆ ID
        charId = Date.now().toString();
        characters.push({ id: charId, name: name, desc: desc });
    } else {
        // ä¿®æ”¹ï¼šæ›´æ–°æ•°æ®
        const char = characters.find(c => c.id === charId);
        char.name = name;
        char.desc = desc;
    }
    
    // ä¿å­˜åŸºæœ¬ä¿¡æ¯åˆ° LocalStorage
    localStorage.setItem('os_characters_data', JSON.stringify(characters));
    
    // å¦‚æœæœ‰æ–°å¤´åƒï¼Œä¿å­˜åˆ° IndexedDB
    if (tempAvatarFile) {
        saveFileToDB(`char_avatar_${charId}`, tempAvatarFile);
        tempAvatarFile = null; // æ¸…ç©ºæš‚å­˜
    }
    
    closeModal('modal-char-edit');
    renderCharList(); // åˆ·æ–°åˆ—è¡¨
    
    // å¦‚æœæ˜¯åœ¨è¯¦æƒ…é¡µç¼–è¾‘çš„ï¼Œä¹Ÿè¦åˆ·æ–°è¯¦æƒ…é¡µ
    if (document.getElementById('char-detail-view').style.display === 'block') {
        viewCharacter(charId);
    }
    
    showIOSAlert("æˆåŠŸ", "è§’è‰²ä¿¡æ¯å·²ä¿å­˜");
}

// 6. æŸ¥çœ‹è¯¦æƒ… (JS æ›´æ–°)
function viewCharacter(id) {
    const char = characters.find(c => c.id === id);
    if (!char) return;
    
    editingCharId = id;
    
    // åˆ‡æ¢è§†å›¾
    document.getElementById('char-list-view').style.display = 'none';
    const detailView = document.getElementById('char-detail-view');
    detailView.style.display = 'block'; // æ˜¾ç¤ºå…¨å±å±‚
    
    // ğŸ”¥ ç»†èŠ‚ä¼˜åŒ–ï¼šè¿›å…¥è¯¦æƒ…é¡µï¼ŒçŠ¶æ€æ æ–‡å­—å˜ç™½ (å› ä¸ºèƒŒæ™¯å›¾é€šå¸¸æ˜¯æ·±è‰²/å½©è‰²)
    // è¿™æ ·çœ‹èµ·æ¥æ›´åƒåŸç”Ÿ App
    const gb = document.getElementById('global-status-bar');
    if(gb) gb.classList.remove('text-dark'); 
    
    // å¡«å……æ•°æ®
    document.getElementById('char-detail-name').textContent = char.name;
    document.getElementById('char-detail-desc').textContent = char.desc;
    
    // åŠ è½½å¤´åƒå’ŒèƒŒæ™¯
    loadCharImage(id, 'avatar', 'char-detail-avatar');
    loadCharImage(id, 'banner', null, (url) => {
        if(url) document.getElementById('char-detail-banner').style.backgroundImage = `url('${url}')`;
        else document.getElementById('char-detail-banner').style.backgroundImage = 'none';
    });
}

// 7. è¿”å›åˆ—è¡¨ (JS æ›´æ–°)
function backToCharList() {
    // éšè—è¯¦æƒ…å±‚
    document.getElementById('char-detail-view').style.display = 'none';
    // æ˜¾ç¤ºåˆ—è¡¨å±‚
    document.getElementById('char-list-view').style.display = 'block';
    
    // ğŸ”¥ ç»†èŠ‚ä¼˜åŒ–ï¼šå›åˆ°åˆ—è¡¨é¡µ (ç™½åº•)ï¼Œå¼ºåˆ¶çŠ¶æ€æ å˜é»‘
    const gb = document.getElementById('global-status-bar');
    if(gb) gb.classList.add('text-dark');
    
    editingCharId = null;
}

// 8. ç¼–è¾‘ä¸åˆ é™¤
function editCurrentCharacter() {
    openCharModal(editingCharId);
}

/* --- ä¿®å¤ï¼šä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—åˆ é™¤ --- */

// 1. ç‚¹å‡»â€œåˆ é™¤äººç‰©â€æŒ‰é’®æ—¶ -> ä»…ä»…æ˜¯æ‰“å¼€å¼¹çª—
function deleteCurrentCharacter() {
    document.getElementById('modal-delete-confirm').style.display = 'flex';
}

// 2. åœ¨å¼¹çª—é‡Œç‚¹â€œåˆ é™¤â€æ—¶ -> æ‰§è¡ŒçœŸæ­£åˆ é™¤é€»è¾‘
function confirmDeleteCharacter() {
    // A. ä»å†…å­˜æ•°ç»„é‡Œåˆ æ‰
    characters = characters.filter(c => c.id !== editingCharId);
    
    // B. æ›´æ–°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('os_characters_data', JSON.stringify(characters));
    
    // C. å…³é—­å¼¹çª—
    closeModal('modal-delete-confirm');
    
    // D. è¿”å›åˆ—è¡¨é¡µå¹¶åˆ·æ–°
    backToCharList();
    renderCharList();
    
    // E. (å¯é€‰) æç¤ºæˆåŠŸï¼Œç”¨é¡¶éƒ¨é‚£ä¸ªå¥½çœ‹çš„èƒ¶å›Šæç¤º
    showIOSAlert("å·²åˆ é™¤", "è§’è‰²æ•°æ®å·²ç§»é™¤");
}

// 9. èƒŒæ™¯æ›´æ¢é€»è¾‘
function openBannerModal() {
    document.getElementById('modal-char-banner').style.display = 'flex';
}
function handleBannerFileSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        // ç›´æ¥å­˜ DB
        saveFileToDB(`char_banner_${editingCharId}`, file);
        
        // ç«‹å³é¢„è§ˆ
        const url = URL.createObjectURL(file);
        document.getElementById('char-detail-banner').style.backgroundImage = `url('${url}')`;
        
        closeModal('modal-char-banner');
    }
}
function saveBanner(type) {
    if (type === 'url') {
        const url = document.getElementById('banner-url-input').value;
        if(url) {
            // URL æ²¡æ³•å­˜ DB blobï¼Œæˆ‘ä»¬ç®€å•å¤„ç†ï¼šå­˜åˆ° LocalStorage çš„ extra å­—æ®µï¼Œæˆ–è€…è¿™é‡Œä»…æ”¯æŒæœ¬åœ°ä¸Šä¼ æœ€ç¨³å¦¥
            // ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬åªæ¼”ç¤ºæœ¬åœ°ä¸Šä¼ é€»è¾‘ï¼ŒURL é€»è¾‘å…ˆè·³è¿‡æˆ–ä»…ä½œä¸´æ—¶æ˜¾ç¤º
            document.getElementById('char-detail-banner').style.backgroundImage = `url('${url}')`;
            closeModal('modal-char-banner');
            alert("URL èƒŒæ™¯ä»…æœ¬æ¬¡æœ‰æ•ˆï¼Œå»ºè®®ä½¿ç”¨æœ¬åœ°ä¸Šä¼ ä»¥æ°¸ä¹…ä¿å­˜ã€‚");
        }
    }
}

// 10. é€šç”¨å›¾ç‰‡åŠ è½½å™¨ (ä» DB è¯»å–)
function loadCharImage(id, type, imgId, callback) {
    if (!db) return;
    const tx = db.transaction(['files'], 'readonly');
    const key = `char_${type}_${id}`;
    const req = tx.objectStore('files').get(key);
    
    req.onsuccess = () => {
        if (req.result) {
            const url = URL.createObjectURL(req.result);
            if (imgId) {
                const el = document.getElementById(imgId);
                if(el) { el.src = url; el.style.opacity = 1; }
            }
            if (callback) callback(url);
        } else {
            // æ²¡æœ‰å›¾ç‰‡æ—¶
            if (imgId) {
                const el = document.getElementById(imgId);
                if(el) el.src = 'https://via.placeholder.com/150'; // é»˜è®¤å›¾
            }
            if (callback) callback(null);
        }
    };
}

/* =========================================
   === ä¸–ç•Œä¹¦ (World Book) ç³»ç»Ÿ ===
   ========================================= */

let worlds = []; // å†…å­˜æ•°æ®
let editingWorldId = null; // å½“å‰æ“ä½œçš„ID

// 1. åˆå§‹åŒ–ï¼šåŠ è½½æ•°æ®
function loadWorlds() {
    const saved = localStorage.getItem('os_worlds_data');
    if (saved) {
        worlds = JSON.parse(saved);
        renderWorldList();
    }
}
// âš ï¸ è®°å¾—æŠŠ loadWorlds() åŠ åˆ° loadFromDB çš„æœ€åä¸€è¡Œï¼

// 2. æ¸²æŸ“åˆ—è¡¨
function renderWorldList() {
    const container = document.getElementById('world-list');
    container.innerHTML = '';
    
    if (worlds.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#999; font-size:14px; padding:20px;">æš‚æ— ä¸–ç•Œè§‚è®¾å®š<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div>`;
        return;
    }

    worlds.forEach(w => {
        const div = document.createElement('div');
        div.className = 'world-card';
        div.onclick = () => viewWorld(w.id); // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¼¹çª—
        
        div.innerHTML = `
            <div class="world-card-title">${w.title}</div>
            <div class="world-card-preview">${w.content}</div>
        `;
        container.appendChild(div);
    });
}

// 3. æ‰“å¼€ç¼–è¾‘/æ·»åŠ å¼¹çª—
function openWorldEditModal(id = null) {
    const modal = document.getElementById('modal-world-edit');
    const titleEl = document.getElementById('world-modal-title');
    const inputTitle = document.getElementById('world-input-title');
    const inputContent = document.getElementById('world-input-content');
    
    modal.style.display = 'flex';
    
    if (id) {
        // ç¼–è¾‘æ¨¡å¼
        const w = worlds.find(item => item.id === id);
        editingWorldId = id;
        titleEl.textContent = "ç¼–è¾‘è®¾å®š";
        inputTitle.value = w.title;
        inputContent.value = w.content;
    } else {
        // æ–°å¢æ¨¡å¼
        editingWorldId = null;
        titleEl.textContent = "æ–°å»ºä¸–ç•Œè§‚";
        inputTitle.value = '';
        inputContent.value = '';
    }
}

// 4. ä¿å­˜æ•°æ®
function saveWorldData() {
    const title = document.getElementById('world-input-title').value;
    const content = document.getElementById('world-input-content').value;
    
    if (!title) { showIOSAlert("æç¤º", "è¯·è¾“å…¥ä¸–ç•Œè§‚åç§°"); return; }
    
    if (editingWorldId) {
        // ä¿®æ”¹
        const w = worlds.find(item => item.id === editingWorldId);
        w.title = title;
        w.content = content;
    } else {
        // æ–°å¢
        const newId = Date.now().toString();
        worlds.push({ id: newId, title: title, content: content });
    }
    
    // å­˜å…¥æœ¬åœ°
    localStorage.setItem('os_worlds_data', JSON.stringify(worlds));
    
    closeModal('modal-world-edit');
    
    // å¦‚æœæ­£åœ¨æŸ¥çœ‹å¼¹çª—ï¼Œä¹Ÿé¡ºä¾¿æ›´æ–°ä¸€ä¸‹æŸ¥çœ‹å¼¹çª—çš„å†…å®¹
    if (document.getElementById('modal-world-view').style.display === 'flex' && editingWorldId) {
        viewWorld(editingWorldId);
    }
    
    renderWorldList();
    showIOSAlert("æˆåŠŸ", "ä¸–ç•Œè§‚è®¾å®šå·²ä¿å­˜");
}

// 5. æŸ¥çœ‹è¯¦æƒ… (å¼¹çª—æ¨¡å¼)
function viewWorld(id) {
    const w = worlds.find(item => item.id === id);
    if (!w) return;
    
    editingWorldId = id; // è®°å½•å½“å‰æ­£åœ¨çœ‹çš„IDï¼Œæ–¹ä¾¿åç»­ç¼–è¾‘/åˆ é™¤
    
    const viewModal = document.getElementById('modal-world-view');
    document.getElementById('view-world-title').textContent = w.title;
    document.getElementById('view-world-content').textContent = w.content;
    
    viewModal.style.display = 'flex';
}

// 6. åœ¨æŸ¥çœ‹å¼¹çª—é‡Œç‚¹å‡»â€œç¼–è¾‘â€
function editCurrentWorld() {
    closeModal('modal-world-view'); // å…ˆå…³æ‰æŸ¥çœ‹
    openWorldEditModal(editingWorldId); // æ‰“å¼€ç¼–è¾‘
}

// 7. åˆ é™¤
function deleteCurrentWorld() {
    // å¤ç”¨ä¹‹å‰çš„åˆ é™¤ç¡®è®¤å¼¹çª—
    const confirmModal = document.getElementById('modal-delete-confirm');
    
    // è¿™é‡Œæˆ‘ä»¬éœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ç¡®è®¤æŒ‰é’®çš„ onclickï¼Œè®©å®ƒæŒ‡å‘åˆ é™¤ä¸–ç•Œè§‚çš„é€»è¾‘
    // ä¸ºäº†ä¸ç ´åè§’è‰²ä¹¦çš„é€»è¾‘ï¼Œæˆ‘ä»¬åŠ¨æ€ä¿®æ”¹ onclick
    const confirmBtn = confirmModal.querySelector('.btn-group .danger');
    
    // å…ˆä¿å­˜åŸæ¥çš„ onclick (è™½ç„¶è¿™é‡Œå…¶å®ä¸éœ€è¦ï¼Œå› ä¸ºæ¯æ¬¡æ‰“å¼€éƒ½ä¼šé‡æ–°ç»‘)
    // ç»‘å®šæ–°çš„åˆ é™¤é€»è¾‘
    confirmBtn.onclick = function() {
        worlds = worlds.filter(w => w.id !== editingWorldId);
        localStorage.setItem('os_worlds_data', JSON.stringify(worlds));
        
        closeModal('modal-delete-confirm');
        closeModal('modal-world-view'); // é¡ºä¾¿å…³æ‰æŸ¥çœ‹çª—å£
        renderWorldList();
        showIOSAlert("å·²åˆ é™¤", "è®¾å®šå·²ç§»é™¤");
    };
    
    confirmModal.style.display = 'flex';
}

/* =========================================
   === éŸ³ä¹ App æ ¸å¿ƒé€»è¾‘ ===
   ========================================= */

let musicLibrary = [];
let currentPlaylist = []; // å½“å‰æ’­æ”¾é˜Ÿåˆ—
let currentTrackIndex = 0;
let playMode = 0; // 0: é¡ºåº, 1: å¾ªç¯, 2: éšæœº
const modes = ['ğŸ”', 'ğŸ”‚', 'ğŸ”€'];

// 1. åˆå§‹åŒ–
function loadMusicApp() {
    // åŠ è½½æ­Œæ›²åº“
    const saved = localStorage.getItem('os_music_library');
    if (saved) {
        musicLibrary = JSON.parse(saved);
        currentPlaylist = musicLibrary; // é»˜è®¤æ’­æ”¾å…¨éƒ¨
    }
    renderMusicList();
    renderMusicStories(); // åŠ è½½å¥½å‹åŠ¨æ€
}
// âš ï¸ è®°å¾—åœ¨ loadFromDB() æœ€ååŠ  loadMusicApp();

// 2. æ¸²æŸ“ Stories (è¯»å–è§’è‰²ä¹¦æ•°æ®)
function renderMusicStories() {
    const box = document.getElementById('music-stories-scroll');
    const charData = localStorage.getItem('os_characters_data');
    box.innerHTML = '';
    
    if (charData) {
        const chars = JSON.parse(charData);
        chars.forEach(c => {
            const div = document.createElement('div');
            div.className = 'story-item';
            div.innerHTML = `<img id="story-av-${c.id}" class="story-avatar" src=""><div class="story-name">${c.name}</div>`;
            box.appendChild(div);
            loadCharImage(c.id, 'avatar', `story-av-${c.id}`); // å¤ç”¨è§’è‰²ä¹¦çš„å›¾ç‰‡åŠ è½½å™¨
        });
    } else {
        box.innerHTML = '<span style="color:#999;font-size:12px;padding:10px;">Add friends in Character Book first</span>';
    }
}

// 3. æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
function renderMusicList() {
    const list = document.getElementById('music-library-list');
    list.innerHTML = '';
    musicLibrary.forEach((song, idx) => {
        const div = document.createElement('div');
        div.className = 'song-item';
        div.onclick = () => playSongAtIndex(idx);
        div.innerHTML = `
            <img id="song-cover-${song.id}" class="song-thumb" src="">
            <div class="song-info">
                <div class="song-title-list">${song.title}</div>
                <div class="song-artist-list">${song.artist}</div>
            </div>
            <button style="border:none;background:none;color:#c7c7cc">â‹¯</button>
        `;
        list.appendChild(div);
        loadSongCover(song.id, `song-cover-${song.id}`);
    });
}

// 4. æ·»åŠ æ­Œæ›² (å¼¹çª—é€»è¾‘)
let tempMusicCover = null;
let tempMusicFile = null;

function handleMusicCoverSelect(input) {
    if (input.files[0]) {
        tempMusicCover = input.files[0];
        document.getElementById('music-preview-img').src = URL.createObjectURL(tempMusicCover);
        document.getElementById('music-preview-img').style.opacity = 1;
    }
}
function handleMusicFileSelect(input) {
    if (input.files[0]) tempMusicFile = input.files[0];
}

/* --- ä¿®å¤ï¼šæ”¯æŒç¼–è¾‘ä¿å­˜çš„é€»è¾‘ --- */
function confirmAddSong() {
    const title = document.getElementById('music-input-title').value;
    const artist = document.getElementById('music-input-artist').value;
    const urlInput = document.getElementById('music-input-url').value;
    
    if(!title || !artist) { showIOSAlert("Error", "Title and Artist required"); return; }
    
    // âœ… åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯ä¿®æ”¹
    let songId;
    let isEdit = false;
    
    // å¦‚æœ actingSongId æœ‰å€¼ï¼Œè¯´æ˜æ˜¯ç¼–è¾‘æ¨¡å¼ (ä¸”å¿…é¡»æ˜¯åœ¨ç¼–è¾‘å¼¹çª—æ‰“å¼€å‰è®¾ç½®çš„)
    // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬åœ¨ openAddMusicModal æ—¶é‡ç½® actingSongIdï¼Œåªæœ‰ editSelectedSong æ‰ä¼šèµ‹å€¼
    // è¿™é‡Œæˆ‘ä»¬å‡è®¾ editSelectedSong å·²ç»èµ‹å€¼äº† actingSongId
    // ä½†æ˜¯ï¼ä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼Œæˆ‘ä»¬æœ€å¥½åœ¨ openAddMusicModal é‡ŒåŠ ä¸ªå‚æ•°ã€‚
    
    // ç®€å•æ”¹æ³•ï¼šå¦‚æœ actingSongId ä¸ä¸ºç©ºï¼Œä¸”æˆ‘ä»¬åœ¨ç¼–è¾‘çŠ¶æ€
    if (actingSongId && document.querySelector('#modal-add-music').style.display === 'flex') {
        songId = actingSongId;
        isEdit = true;
    } else {
        songId = Date.now().toString();
    }
    
    // æ„é€ å¯¹è±¡
    let newSong = { id: songId, title, artist, type: 'url', src: '' };
    
    // å¦‚æœæ˜¯ç¼–è¾‘ï¼Œå…ˆä¿ç•™åŸæ¥çš„ srcï¼Œé˜²æ­¢ç”¨æˆ·æ²¡ä¸Šä¼ æ–°æ–‡ä»¶å¯¼è‡´æ–‡ä»¶ä¸¢å¤±
    if (isEdit) {
        const oldSong = musicLibrary.find(s => s.id === songId);
        if(oldSong) {
            newSong.type = oldSong.type;
            newSong.src = oldSong.src;
            newSong.hasCover = oldSong.hasCover;
        }
    }

    // å¤„ç†æ–°ä¸Šä¼ çš„éŸ³é¢‘
    if (tempMusicFile) {
        newSong.type = 'blob';
        saveFileToDB(`music_audio_${songId}`, tempMusicFile);
    } else if (urlInput) {
        newSong.src = urlInput;
        newSong.type = 'url';
    } else {
        if (!isEdit) { showIOSAlert("Error", "No audio source selected"); return; }
    }
    
    // å¤„ç†æ–°ä¸Šä¼ çš„å°é¢
    if (tempMusicCover) {
        saveFileToDB(`music_cover_${songId}`, tempMusicCover);
        newSong.hasCover = true;
    }
    
    if (isEdit) {
        // æ›´æ–°æ•°ç»„
        const idx = musicLibrary.findIndex(s => s.id === songId);
        if(idx > -1) musicLibrary[idx] = newSong;
    } else {
        // æ–°å¢
        musicLibrary.push(newSong);
    }
    
    localStorage.setItem('os_music_library', JSON.stringify(musicLibrary));
    
    closeModal('modal-add-music');
    renderMusicList();
    
    // é‡ç½®å˜é‡
    tempMusicFile = null; tempMusicCover = null;
    actingSongId = null; // é‡ç½®æ“ä½œID
    
    document.getElementById('music-input-title').value = '';
    document.getElementById('music-input-artist').value = '';
    document.getElementById('music-input-url').value = '';
    document.getElementById('music-preview-img').style.opacity = 0;
}

// åˆ«å¿˜äº†ä¿®æ”¹ openAddMusicModalï¼Œè®©å®ƒæ¯æ¬¡æ‰“å¼€éƒ½é‡ç½®çŠ¶æ€
function openAddMusicModal() { 
    actingSongId = null; // é»˜è®¤ä¸ºæ–°å¢
    document.getElementById('modal-add-music').style.display = 'flex'; 
    // æ¸…ç©ºè¾“å…¥æ¡†...
    document.getElementById('music-input-title').value = '';
    document.getElementById('music-input-artist').value = '';
    document.getElementById('music-input-url').value = '';
    document.getElementById('music-preview-img').style.opacity = 0;
}

// 5. æ’­æ”¾æ§åˆ¶æ ¸å¿ƒ
function playSongAtIndex(idx) {
    currentTrackIndex = idx;
    const song = musicLibrary[idx];
    if(!song) return;
    
    const player = document.getElementById('hidden-player'); // å¤ç”¨ç°æœ‰çš„æ’­æ”¾å™¨
    
    // è·å–éŸ³é¢‘æº
    if (song.type === 'blob') {
        const tx = db.transaction(['files'], 'readonly');
        tx.objectStore('files').get(`music_audio_${song.id}`).onsuccess = (e) => {
            if(e.target.result) {
                player.src = URL.createObjectURL(e.target.result);
                player.play();
                updatePlayerUI(song);
            }
        };
    } else {
        player.src = song.src;
        player.play();
        updatePlayerUI(song);
    }
}

/* --- ä¿®å¤ï¼šåˆ‡æ­Œæ—¶ä¿ç•™è‡ªå®šä¹‰èƒŒæ™¯ --- */
function updatePlayerUI(song) {
    // 1. æ›´æ–°è¿·ä½ æ’­æ”¾å™¨
    document.getElementById('mini-title').textContent = song.title;
    document.getElementById('mini-artist').textContent = song.artist;
    loadSongCover(song.id, 'mini-cover');
    document.getElementById('mini-player').classList.add('playing');
    document.getElementById('mini-play-btn').innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
    
    // 2. æ›´æ–°å…¨å±æ’­æ”¾å™¨
    document.getElementById('full-title').textContent = song.title;
    document.getElementById('full-artist').textContent = song.artist;
    
    // é¡¶éƒ¨æ ‡é¢˜
    const headerTitle = document.getElementById('full-header-title');
    if(headerTitle) headerTitle.textContent = song.title;

    document.getElementById('full-play-btn').innerHTML = document.getElementById('mini-play-btn').innerHTML;

    // âœ…âœ…âœ… æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥å½“å‰æ˜¯ä»€ä¹ˆèƒŒæ™¯æ¨¡å¼ âœ…âœ…âœ…
    const bgMode = localStorage.getItem('os_music_bg_mode');
    
    // åªæœ‰å½“æ¨¡å¼æ˜¯ 'default' (æˆ–è€…æ²¡è®¾ç½®è¿‡) æ—¶ï¼Œæ‰å…è®¸åˆ‡æ­Œæ”¹å˜èƒŒæ™¯
    // å¦‚æœä½ æ˜¯ 'custom' (æœ¬åœ°å›¾) æˆ– 'url' (ç½‘ç»œå›¾)ï¼Œè¿™é‡Œå°±æ˜¯ falseï¼ŒèƒŒæ™¯å°±ä¸ä¼šå˜ï¼
    const shouldUpdateBg = (bgMode === 'default' || !bgMode);
    
    // ä¼ ç»™åŠ è½½å‡½æ•°
    loadSongCover(song.id, 'full-cover', shouldUpdateBg); 
    
    // 3. åŒæ­¥èƒ¶å›ŠçŠ¶æ€
    const capsule = document.querySelector('.music-capsule');
    if(capsule) capsule.classList.add('playing');
    
    // 4. é«˜äº®æ’­æ”¾åˆ—è¡¨
    renderDrawerList();
    loadSongLyrics(song.id); 
}

function togglePlayMusic() {
    const player = document.getElementById('hidden-player');
    
    // å®šä¹‰å›¾æ ‡ SVG
    const playIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
    const pauseIcon = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
    
    // 1. æ‰§è¡Œæ’­æ”¾/æš‚åœ
    if (player.paused) {
        player.play();
        document.getElementById('mini-player').classList.add('playing');
        document.querySelector('.music-capsule').classList.add('playing');
        
        // 2. âœ… åŒæ­¥æ‰€æœ‰æ’­æ”¾æŒ‰é’®ä¸º "æš‚åœå›¾æ ‡"
        document.getElementById('mini-play-btn').innerHTML = pauseIcon;
        document.getElementById('full-play-btn').innerHTML = pauseIcon;
        
        const islandBtn = document.getElementById('island-play-btn');
        if(islandBtn) islandBtn.innerHTML = pauseIcon; // ğŸ‘ˆ ä¿®å¤è¿™é‡Œ
        
    } else {
        player.pause();
        document.getElementById('mini-player').classList.remove('playing');
        document.querySelector('.music-capsule').classList.remove('playing');
        
        // 3. âœ… åŒæ­¥æ‰€æœ‰æ’­æ”¾æŒ‰é’®ä¸º "æ’­æ”¾å›¾æ ‡"
        document.getElementById('mini-play-btn').innerHTML = playIcon;
        document.getElementById('full-play-btn').innerHTML = playIcon;
        
        const islandBtn = document.getElementById('island-play-btn');
        if(islandBtn) islandBtn.innerHTML = playIcon; // ğŸ‘ˆ ä¿®å¤è¿™é‡Œ
    }
}

function playNext() {
    if(playMode === 2) { // éšæœº
        currentTrackIndex = Math.floor(Math.random() * musicLibrary.length);
    } else {
        currentTrackIndex++;
        if(currentTrackIndex >= musicLibrary.length) currentTrackIndex = 0;
    }
    playSongAtIndex(currentTrackIndex);
}

function playPrev() {
    currentTrackIndex--;
    if(currentTrackIndex < 0) currentTrackIndex = musicLibrary.length - 1;
    playSongAtIndex(currentTrackIndex);
}

// --- ä¿®å¤ï¼šç»Ÿä¸€å¾ªç¯/éšæœºæŒ‰é’®é£æ ¼ ---

// å®šä¹‰ä¸‰ç§æ¨¡å¼çš„ SVG å›¾æ ‡å­—ç¬¦ä¸²
const modeSVGs = [
    // 0: é¡ºåºæ’­æ”¾ (Repeat All)
    '<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v3z"/></svg>',
    // 1: å•æ›²å¾ªç¯ (Repeat One)
    '<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v3z"/><text x="10.5" y="15" fill="currentColor" font-size="8px" font-weight="bold">1</text></svg>',
    // 2: éšæœºæ’­æ”¾ (Shuffle)
    '<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>'
];

function togglePlayMode() {
    playMode++;
    if(playMode > 2) playMode = 0;
    
    // è·å–å½“å‰æ¨¡å¼çš„å›¾æ ‡
    const currentSVG = modeSVGs[playMode];
    
    // 1. æ›´æ–°ä¸»ç•Œé¢
    document.getElementById('play-mode-btn').innerHTML = currentSVG;
    
    // 2. âœ… æ›´æ–°çµåŠ¨å²›ç•Œé¢
    const islandModeBtn = document.getElementById('island-mode-btn');
    if(islandModeBtn) islandModeBtn.innerHTML = currentSVG; // ğŸ‘ˆ ä¿®å¤è¿™é‡Œ
}

// 6. å…¨å±æ’­æ”¾å™¨é€»è¾‘
function openFullPlayer() {
    document.getElementById('full-player').style.display = 'block';
    // éšè—çŠ¶æ€æ æ–‡å­— (å› ä¸ºèƒŒæ™¯æ·±)
    document.getElementById('global-status-bar').classList.remove('text-dark');
}
function closeFullPlayer() {
    document.getElementById('full-player').style.display = 'none';
    // æ¢å¤åˆ—è¡¨é¡µçŠ¶æ€æ  (å˜é»‘)
    document.getElementById('global-status-bar').classList.add('text-dark');
}

// --- ä¿®å¤ï¼šJS å®æ—¶æ›´æ–°è¿›åº¦æ¡é¢œè‰² ---

const audioPlayer = document.getElementById('hidden-player');
const seekSlider = document.getElementById('music-seek-slider'); // è·å–æ»‘å—å…ƒç´ 

audioPlayer.addEventListener('timeupdate', () => {
    const duration = audioPlayer.duration || 0;
    const currentTime = audioPlayer.currentTime || 0;
    const pct = (currentTime / duration) * 100 || 0;
    
    // 1. æ›´æ–°æ»‘å—ä½ç½®
    seekSlider.value = pct;
    
    // âœ…âœ…âœ… 2. å…³é”®ï¼šæ›´æ–° CSS å˜é‡ï¼Œè®©è¿›åº¦æ¡å·¦è¾¹å˜ç™½ âœ…âœ…âœ…
    seekSlider.style.setProperty('--seek-before-width', `${pct}%`);

    // 3. æ›´æ–°æ—¶é—´æ–‡å­—
    document.getElementById('current-time').textContent = formatTime(currentTime);
    document.getElementById('total-time').textContent = formatTime(duration);

    syncLyricsUI(audioPlayer.currentTime);

    syncIslandProgress(audioPlayer.currentTime, audioPlayer.duration, pct);
    syncIslandLyrics();
});

// æ‹–åŠ¨æ»‘å—æ—¶çš„å¤„ç†ä¹Ÿè¦åŠ ä¸Š
function seekMusic(val) {
    const audioPlayer = document.getElementById('hidden-player');
    const time = (val / 100) * audioPlayer.duration;
    audioPlayer.currentTime = time;
    // æ‹–åŠ¨æ—¶ä¹Ÿç«‹é©¬æ›´æ–°ä¸€ä¸‹è§†è§‰
    document.getElementById('music-seek-slider').style.setProperty('--seek-before-width', `${val}%`);
}
function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${m}:${sec<10?'0':''}${sec}`;
}

// 7. æ’­æ”¾åˆ—è¡¨æŠ½å±‰
function togglePlaylistPanel() {
    document.getElementById('playlist-drawer').classList.toggle('show');
    renderDrawerList();
}
function renderDrawerList() {
    const list = document.getElementById('drawer-list');
    list.innerHTML = '';
    musicLibrary.forEach((song, idx) => {
        const div = document.createElement('div');
        div.className = `drawer-item ${idx === currentTrackIndex ? 'active' : ''}`;
        div.textContent = `${song.title} - ${song.artist}`;
        div.onclick = () => { playSongAtIndex(idx); togglePlaylistPanel(); };
        list.appendChild(div);
    });
}

// 8. æ›´æ¢èƒŒæ™¯é€»è¾‘
function openPlayerBgModal() { document.getElementById('modal-player-bg').style.display = 'flex'; }
function handlePlayerBgFile(input) {
    if (input.files[0]) {
        const url = URL.createObjectURL(input.files[0]);
        document.getElementById('full-player-bg').style.backgroundImage = `url('${url}')`;
        document.getElementById('full-player-bg').style.filter = 'none'; // å»æ‰æ¨¡ç³Š
        closeModal('modal-player-bg');
    }
}
function setPlayerBg(type) {
    if(type === 'default') {
        // æ¢å¤é»˜è®¤æ¨¡ç³Šå°é¢
        loadSongCover(musicLibrary[currentTrackIndex].id, 'full-cover', true);
        closeModal('modal-player-bg');
    }
}

// è¾…åŠ©ï¼šåŠ è½½å°é¢
function loadSongCover(id, imgId, updateBg = false) {
    if (!db) return;
    const tx = db.transaction(['files'], 'readonly');
    tx.objectStore('files').get(`music_cover_${id}`).onsuccess = (e) => {
        const img = document.getElementById(imgId);
        if (e.target.result) {
            const url = URL.createObjectURL(e.target.result);
            if(img) img.src = url;
            if(updateBg) {
                const bg = document.getElementById('full-player-bg');
                bg.style.backgroundImage = `url('${url}')`;
                bg.style.filter = 'blur(40px) brightness(0.7)';
            }
        } else {
            if(img) img.src = 'https://via.placeholder.com/150';
        }
    };
}

/* =========================================
   === âš¡ï¸ ç»ˆæä¿®å¤ï¼šèƒŒæ™¯æŒä¹…åŒ–ä¿å­˜ ===
   ========================================= */

// 1. åˆå§‹åŒ–ï¼šå¼€æœºæ—¶åŠ è½½ä¿å­˜çš„èƒŒæ™¯
function loadPlayerBackground() {
    const bgMode = localStorage.getItem('os_music_bg_mode'); // è·å–ä¿å­˜çš„æ¨¡å¼
    const bgView = document.getElementById('full-player-bg');
    
    if (bgMode === 'url') {
        // æ¨¡å¼ A: ç½‘ç»œ URL
        const url = localStorage.getItem('os_music_bg_url');
        if(url) {
            bgView.style.backgroundImage = `url('${url}')`;
            bgView.style.filter = 'none';
        }
    } else if (bgMode === 'custom') {
        // æ¨¡å¼ B: æœ¬åœ°ä¸Šä¼ çš„æ–‡ä»¶ (ä» DB è¯»å–)
        if (!db) return;
        const tx = db.transaction(['files'], 'readonly');
        tx.objectStore('files').get('music_custom_bg_file').onsuccess = (e) => {
            if (e.target.result) {
                 bgView.style.backgroundImage = `url('${URL.createObjectURL(e.target.result)}')`;
                 bgView.style.filter = 'none';
            }
        };
    } else {
        // æ¨¡å¼ C: é»˜è®¤ (ä»€ä¹ˆéƒ½ä¸åšï¼Œäº¤è¿˜ä¼šç»™ loadSongCover å¤„ç†)
    }
}
// âš ï¸âš ï¸âš ï¸ é‡è¦ï¼šä¸€å®šè¦åœ¨ loadFromDB() çš„æœ€åé¢åŠ ä¸Š loadPlayerBackground(); âš ï¸âš ï¸âš ï¸


// 2. å¤„ç†ä¸Šä¼ æ–‡ä»¶
function handlePlayerBgFile(input) {
    if (input.files[0]) {
        const file = input.files[0];
        const url = URL.createObjectURL(file);
        // ç«‹åˆ»åº”ç”¨è§†è§‰
        document.getElementById('full-player-bg').style.backgroundImage = `url('${url}')`;
        document.getElementById('full-player-bg').style.filter = 'none';
        
        // âœ… ä¿å­˜åˆ°æ•°æ®åº“
        saveFileToDB('music_custom_bg_file', file); 
        // âœ… è®°å½•æ¨¡å¼
        localStorage.setItem('os_music_bg_mode', 'custom');
        
        closeModal('modal-player-bg');
    }
}

// 3. å¤„ç† URL å’Œæ¢å¤é»˜è®¤
function setPlayerBg(type) {
    const bgView = document.getElementById('full-player-bg');
    
    if(type === 'default') {
        // æ¢å¤é»˜è®¤
        localStorage.setItem('os_music_bg_mode', 'default');
        // é‡æ–°åŠ è½½å½“å‰æ­Œæ›²çš„æ¨¡ç³Šå°é¢
        if(musicLibrary[currentTrackIndex]) {
            loadSongCover(musicLibrary[currentTrackIndex].id, 'full-cover', true);
        }
    } else if (type === 'url') {
        // ä½¿ç”¨ URL
        const urlInput = document.getElementById('pbg-url-input').value;
        if(urlInput) {
            bgView.style.backgroundImage = `url('${urlInput}')`;
            bgView.style.filter = 'none';
            // âœ… ä¿å­˜ URL å’Œæ¨¡å¼
            localStorage.setItem('os_music_bg_url', urlInput);
            localStorage.setItem('os_music_bg_mode', 'url');
        }
    }
    closeModal('modal-player-bg');
}

/* =========================================
   === æ­Œè¯ç³»ç»Ÿ (Lyrics Engine) ===
   ========================================= */

let currentLyrics = []; // å­˜å‚¨è§£æåçš„æ­Œè¯å¯¹è±¡æ•°ç»„ [{time: 12.5, text: "..."}]
let hasLyrics = false;

// 1. æ‰“å¼€å¼¹çª—
function openLyricsModal() {
    const modal = document.getElementById('modal-lyrics-edit');
    modal.style.display = 'flex';
    
    // å¦‚æœå½“å‰æœ‰æ­Œè¯ï¼Œå¡«å……åˆ°æ–‡æœ¬æ¡†é‡Œæ–¹ä¾¿ä¿®æ”¹
    const songId = musicLibrary[currentTrackIndex].id;
    const saved = localStorage.getItem(`lyrics_${songId}`);
    if (saved) {
        document.getElementById('lyrics-input-text').value = saved;
    } else {
        document.getElementById('lyrics-input-text').value = '';
    }
}

// 2. åˆ‡æ¢è¾“å…¥æ–¹å¼ (Tab)
function switchLyricsTab(mode, btn) {
    document.querySelectorAll('#modal-lyrics-edit .tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    document.getElementById('lyrics-tab-manual').style.display = mode === 'manual' ? 'block' : 'none';
    document.getElementById('lyrics-tab-file').style.display = mode === 'file' ? 'block' : 'none';
}

// 3. å¤„ç† LRC æ–‡ä»¶ä¸Šä¼ 
function handleLyricsFile(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        document.getElementById('lyrics-filename').textContent = file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // æŠŠæ–‡ä»¶å†…å®¹è¯»åˆ°æ–‡æœ¬æ¡†é‡Œï¼Œæœ€åç»Ÿä¸€ç”±â€œä¿å­˜â€æŒ‰é’®å¤„ç†
            document.getElementById('lyrics-input-text').value = e.target.result;
            // è‡ªåŠ¨åˆ‡å›æ‰‹åŠ¨ Tab è®©äººçœ‹åˆ°å†…å®¹
            switchLyricsTab('manual', document.querySelector('#modal-lyrics-edit .tab-btn:first-child'));
        };
        reader.readAsText(file); // è¯»å–æ–‡æœ¬
    }
}

// 4. ä¿å­˜æ­Œè¯
function saveLyricsData() {
    const text = document.getElementById('lyrics-input-text').value;
    const songId = musicLibrary[currentTrackIndex].id;
    
    if (text.trim()) {
        localStorage.setItem(`lyrics_${songId}`, text);
        parseAndLoadLyrics(text);
        showIOSAlert("Success", "Lyrics saved & synced");
    } else {
        localStorage.removeItem(`lyrics_${songId}`);
        currentLyrics = [];
        hasLyrics = false;
        renderLyricsUI();
    }
    closeModal('modal-lyrics-edit');
}

function clearLyrics() {
    document.getElementById('lyrics-input-text').value = '';
}

// 5. æ ¸å¿ƒï¼šLRC è§£æå™¨
function parseAndLoadLyrics(lrcText) {
    const lines = lrcText.split('\n');
    const result = [];
    const timeReg = /\[(\d{2}):(\d{2})(\.\d{2,3})?\]/g;
    
    lines.forEach(line => {
        // æå–æ‰€æœ‰æ—¶é—´æ ‡ç­¾ (ä¸€è¡Œå¯èƒ½æœ‰å¤šä¸ªæ—¶é—´)
        const matches = [...line.matchAll(timeReg)];
        if (matches.length > 0) {
            const text = line.replace(timeReg, '').trim(); // å»æ‰æ—¶é—´æ ‡ç­¾ï¼Œå‰©ä¸‹æ­Œè¯
            matches.forEach(match => {
                const min = parseInt(match[1]);
                const sec = parseInt(match[2]);
                const ms = match[3] ? parseFloat(match[3]) : 0;
                const time = min * 60 + sec + ms;
                if (text) result.push({ time, text });
            });
        } else if (line.trim()) {
            // æ²¡æœ‰æ—¶é—´çš„çº¯æ–‡æœ¬ï¼Œé»˜è®¤ç»™ä¸ª -1 æˆ–è€…æå¤§å€¼ï¼Œæˆ–è€…ä½œä¸ºé™æ€å±•ç¤º
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œå¦‚æœçº¯æ–‡æœ¬å°±ä¸æ»šåŠ¨ï¼Œæˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨ç»™ä¸ªæ—¶é—´
            // ç®€å•å¤„ç†ï¼šä½œä¸º 0ç§’ å¼€å§‹
            // result.push({ time: 0, text: line.trim() });
        }
    });
    
    // æŒ‰æ—¶é—´æ’åº
    result.sort((a, b) => a.time - b.time);
    
    currentLyrics = result;
    hasLyrics = result.length > 0;
    
    // å¦‚æœæ²¡æœ‰æ—¶é—´è½´ï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼Œå°±ç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
    if (!hasLyrics && lrcText.trim()) {
       // ç‰¹æ®Šå¤„ç†çº¯æ–‡æœ¬... 
       // è¿™é‡Œç®€å•ç‚¹ï¼šæ²¡è§£æå‡ºæ—¶é—´å°±å½“åšçº¯æ–‡æœ¬å±•ç¤º
       document.getElementById('lyrics-scroll-view').innerHTML = `<p class="lyric-line active" style="font-size:14px; white-space:pre-wrap;">${lrcText}</p>`;
       document.getElementById('lyrics-scroll-view').style.transform = `translateY(0px)`;
       return;
    }

    renderLyricsUI();
}

// 6. æ¸²æŸ“æ­Œè¯ç•Œé¢
/* --- ä¿®å¤ï¼šæ¸²æŸ“æ—¶å°†æ­Œè¯æ‹†è§£ä¸ºå•ä¸ªå­—ç¬¦ --- */
function renderLyricsUI() {
    const box = document.getElementById('lyrics-scroll-view');
    box.innerHTML = '';
    
    if (!hasLyrics) {
        box.innerHTML = '<p class="lyric-line active">Tap to add lyrics...</p>';
        box.style.transform = `translateY(0px)`;
        return;
    }
    
    currentLyrics.forEach((line, index) => {
        const p = document.createElement('p');
        p.className = 'lyric-line';
        p.id = `lyric-${index}`;
        
        // âœ…âœ…âœ… æ ¸å¿ƒä¿®æ”¹ï¼šä¸ç›´æ¥æ”¾ textï¼Œè€Œæ˜¯æ‹†å¼€æˆ span âœ…âœ…âœ…
        // split('') ä¼šæŠŠå­—ç¬¦ä¸²æ‹†æˆæ•°ç»„ï¼š['ä½ ', 'å¥½', ' ', 'ä¸–', 'ç•Œ']
        const chars = line.text.split('');
        
        chars.forEach(char => {
            const span = document.createElement('span');
            span.textContent = char;
            span.className = 'lyric-char'; // åŠ ä¸Šå•ä¸ªå­—çš„ç±»å
            // å¦‚æœæ˜¯ç©ºæ ¼ï¼Œä¿ç•™å ä½
            if(char === ' ') span.innerHTML = '&nbsp;'; 
            p.appendChild(span);
        });

        box.appendChild(p);
    });
}

// 7. æ­Œè¯åŒæ­¥ (æ¯ç§’è°ƒç”¨)
/* --- âš¡ï¸ ç»ˆæä¿®å¤ï¼šé€å­—ç²¾ç¡®ç‚¹äº®ç®—æ³• --- */
let lastActiveIndex = -1; 

function syncLyricsUI(currentTime) {
    if (!hasLyrics) return;
    
    // 1. æ‰¾åˆ°å½“å‰è¡Œ
    let activeIndex = -1;
    for (let i = 0; i < currentLyrics.length; i++) {
        if (currentTime >= currentLyrics[i].time) {
            activeIndex = i;
        } else {
            break; 
        }
    }
    
    // 2. åªæœ‰è¡Œæ•°å˜äº†æ‰æ‰§è¡ŒåŠ¨ç”» (é˜²æ­¢æ¯ç§’é‡å¤è§¦å‘)
    if (activeIndex !== -1 && activeIndex !== lastActiveIndex) {
        
        // A. é‡ç½®æ—§è¡Œï¼šæŠŠæ‰€æœ‰ä»¥å‰äº®è¿‡çš„è¡Œéƒ½ç†„ç­
        // (ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥æ¸…ç†æ‰€æœ‰è¡Œçš„ active å’Œ lit çŠ¶æ€)
        const allLines = document.querySelectorAll('.lyric-line');
        allLines.forEach(line => {
            line.classList.remove('active');
            // ç†„ç­é‡Œé¢çš„æ¯ä¸ªå­—
            const chars = line.querySelectorAll('.lyric-char');
            chars.forEach(c => {
                c.classList.remove('lit');
                c.style.transitionDelay = '0s'; // æ¸…é™¤å»¶è¿Ÿï¼Œé˜²æ­¢å›æ»šæ—¶ä¹±é—ª
            });
        });
        
        // B. æ¿€æ´»æ–°è¡Œ
        const activeEl = document.getElementById(`lyric-${activeIndex}`);
        if(activeEl) {
            activeEl.classList.add('active'); // æ•´ä½“æ”¾å¤§
            
            // --- ğŸ¤– ç®—æ³•æ ¸å¿ƒï¼šè®¡ç®—æ¯ä¸ªå­—çš„é€Ÿåº¦ ---
            const duration = currentLyrics[activeIndex].duration || 3; // è¿™å¥å”±å‡ ç§’ (é»˜è®¤3ç§’)
            const chars = activeEl.querySelectorAll('.lyric-char');
            const count = chars.length;
            
            if(count > 0) {
                // æ¯ä¸ªå­—åˆ†åˆ°çš„æ—¶é—´ = æ€»æ—¶é•¿ / å­—æ•°
                // æ¯”å¦‚å”± 3ç§’ï¼Œæœ‰ 10ä¸ªå­—ï¼Œæ¯ä¸ªå­—å°±æ˜¯ 0.3ç§’
                const perCharTime = duration / count; 
                
                chars.forEach((char, i) => {
                    // ç»™æ¯ä¸ªå­—åŠ å»¶è¿Ÿï¼šç¬¬1ä¸ªå­—0ç§’ï¼Œç¬¬2ä¸ªå­—0.3ç§’ï¼Œç¬¬3ä¸ªå­—0.6ç§’...
                    char.style.transitionDelay = `${i * perCharTime}s`;
                    
                    // å¼ºåˆ¶åŠ ç±»å (é…åˆ delay ç”Ÿæ•ˆ)
                    // å¿…é¡»åŠ ä¸ªå¾®å°çš„ setTimeout ç¡®ä¿ transitionDelay å·²ç»è¢«æµè§ˆå™¨è¯»å–äº†
                    setTimeout(() => {
                        char.classList.add('lit');
                    }, 10); 
                });
            }
        }
        
        // C. æ»šåŠ¨ (ä¿æŒé«˜äº®è¡Œå±…ä¸­)
        const rowHeight = 36; // è¡Œé«˜
        // è¿™é‡Œçš„ 20 æ˜¯å¾®è°ƒåç§»é‡ï¼Œè®©å­—æ›´å±…ä¸­
        const offset = - (activeIndex * rowHeight) + 10; 
        document.getElementById('lyrics-scroll-view').style.transform = `translateY(${offset}px)`;
        
        lastActiveIndex = activeIndex; 
    }
}

// 8. æŒ‚è½½åˆ°æ’­æ”¾å™¨
// è¯·æŠŠè¿™ä¸ªå‡½æ•°è°ƒç”¨æ”¾åˆ°ä½ çš„ updatePlayerUI é‡Œé¢
function loadSongLyrics(songId) {
    const saved = localStorage.getItem(`lyrics_${songId}`);
    if (saved) {
        parseAndLoadLyrics(saved);
    } else {
        currentLyrics = [];
        hasLyrics = false;
        renderLyricsUI();
    }
}

/* =========================================
   === æ­Œæ›²é«˜çº§æ“ä½œ (Action & Queue) ===
   ========================================= */

let actingSongId = null; // å½“å‰æ­£åœ¨æ“ä½œå“ªé¦–æ­Œ (ç‚¹èœå•æ—¶è®°å½•)

// 1. æ›¿æ¢åŸæ¥çš„æ¸²æŸ“åˆ—è¡¨å‡½æ•° (renderMusicList)
function renderMusicList() {
    const list = document.getElementById('music-library-list');
    list.innerHTML = '';
    
    musicLibrary.forEach((song, idx) => {
        const div = document.createElement('div');
        div.className = 'song-item';
        
        // ç‚¹å‡»æ•´ä¸ªæ¡ç›®æ’­æ”¾
        div.onclick = (e) => {
            // å¦‚æœç‚¹çš„æ˜¯æŒ‰é’®ï¼Œåˆ«è§¦å‘æ’­æ”¾
            if(e.target.closest('button')) return;
            playSongAtIndex(idx);
        };

        div.innerHTML = `
            <img id="song-cover-${song.id}" class="song-thumb" src="">
            <div class="song-info">
                <div class="song-title-list">${song.title}</div>
                <div class="song-artist-list">${song.artist}</div>
            </div>
            
            <div class="song-right-actions">
                <button class="list-btn" onclick="playNextInQueue('${song.id}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>
                </button>
                
                <button class="list-btn more" onclick="openSongMenu('${song.id}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/><circle cx="5" cy="12" r="2"/></svg>
                </button>
            </div>
        `;
        list.appendChild(div);
        loadSongCover(song.id, `song-cover-${song.id}`);
    });
}

// 2. é€»è¾‘ï¼šä¸‹ä¸€é¦–æ’­æ”¾ (æ’é˜Ÿ)
function playNextInQueue(id) {
    const song = musicLibrary.find(s => s.id === id);
    if (!song) return;

    // æ‰¾åˆ°å½“å‰æ­£åœ¨æ’­çš„é‚£é¦–åœ¨åˆ—è¡¨é‡Œçš„ä½ç½®
    // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ç®€å•å¤„ç†ï¼Œç›´æ¥æŠŠè¿™é¦–æ­Œå†æ’å…¥åˆ° musicLibrary é‡Œï¼Œ
    // æˆ–è€…æ›´é«˜çº§çš„åšæ³•æ˜¯ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„ playingQueueã€‚
    // ä¸ºäº†ä¸ç ´åä½ ç°æœ‰çš„ç®€å•é€»è¾‘ï¼Œæˆ‘ä»¬åšä¸€ä¸ªè§†è§‰æç¤ºï¼š
    
    showIOSAlert("å·²æ·»åŠ ", `"${song.title}" å°†åœ¨ä¸‹ä¸€é¦–æ’­æ”¾`);
    
    // é€»è¾‘é­”æ³•ï¼š
    // å¦‚æœæ˜¯é¡ºåºæ’­æ”¾ï¼Œæˆ‘ä»¬å…¶å®åªè¦æŠŠè¿™é¦–æ­Œåœ¨æ•°ç»„é‡ŒæŒªåˆ°å½“å‰æ­Œæ›²åé¢å°±è¡Œ
    // ä½†ä¸ºäº†ä¸æ‰“ä¹±ä½ çš„åº“ï¼Œæˆ‘ä»¬è¿™é‡Œåªåšä¸€ä¸ªç®€å•çš„é€»è¾‘ï¼š
    // å¦‚æœç”¨æˆ·çœŸæƒ³æ’é˜Ÿï¼Œæˆ‘ä»¬å¯ä»¥ä¸´æ—¶æŠŠ currentTrackIndex æŒ‡å‘è¿™é¦–æ­Œçš„å‰ä¸€ä¸ª? 
    // ä¸ï¼Œæœ€ç¨³å¦¥çš„æ˜¯ï¼š
    // æ—¢ç„¶æˆ‘ä»¬æ²¡æœ‰åšå¤æ‚çš„é˜Ÿåˆ—ç³»ç»Ÿï¼Œé‚£å°±ä»…ä»…æç¤ºä¸€ä¸‹ç”¨æˆ· (æˆ–è€…æˆ‘ä»¬çœŸçš„æŠŠæ•°ç»„é¡ºåºæ”¹äº†)
    
    // è¿™é‡Œæˆ‘ä»¬ç”¨æœ€â€œçœŸå®â€çš„æ–¹æ³•ï¼šç§»åŠ¨æ•°ç»„å…ƒç´ ï¼
    const fromIndex = musicLibrary.findIndex(s => s.id === id);
    const toIndex = currentTrackIndex + 1;
    
    if (fromIndex > -1) {
        // å…ˆåˆ æ‰æ—§ä½ç½®
        musicLibrary.splice(fromIndex, 1);
        // å†æ’åˆ°å½“å‰æ’­æ”¾çš„åé¢
        // æ³¨æ„ï¼šå¦‚æœ fromIndex < currentTrackIndexï¼Œåˆ é™¤åå½“å‰ç´¢å¼•è¦å‡1
        let finalDest = toIndex;
        if (fromIndex < currentTrackIndex) {
            currentTrackIndex--; // ä¿®æ­£å½“å‰ç´¢å¼•
            finalDest--; 
        }
        
        musicLibrary.splice(finalDest, 0, song);
        
        // ä¿å­˜å¹¶åˆ·æ–°
        localStorage.setItem('os_music_library', JSON.stringify(musicLibrary));
        renderMusicList();
    }
}

// 3. é€»è¾‘ï¼šæ‰“å¼€èœå•
function openSongMenu(id) {
    actingSongId = id;
    const song = musicLibrary.find(s => s.id === id);
    if(song) {
        document.getElementById('action-song-title').textContent = song.title;
        document.getElementById('modal-song-menu').style.display = 'flex';
    }
}

// 4. é€»è¾‘ï¼šåˆ é™¤æ­Œæ›²
function deleteSelectedSong() {
    // 1. ä»æ•°ç»„ç§»é™¤
    musicLibrary = musicLibrary.filter(s => s.id !== actingSongId);
    
    // 2. æ›´æ–°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('os_music_library', JSON.stringify(musicLibrary));
    
    // 3. (å¯é€‰) åˆ é™¤æ•°æ®åº“é‡Œçš„æ–‡ä»¶ï¼Œä¸ºäº†èŠ‚çœç©ºé—´
    if(db) {
        const tx = db.transaction(['files'], 'readwrite');
        tx.objectStore('files').delete(`music_audio_${actingSongId}`);
        tx.objectStore('files').delete(`music_cover_${actingSongId}`);
    }
    
    // 4. åˆ·æ–°ç•Œé¢
    closeModal('modal-song-menu');
    renderMusicList();
    showIOSAlert("Deleted", "Song removed from library");
    
    // å¦‚æœåˆ çš„æ˜¯å½“å‰æ­£åœ¨æ”¾çš„ï¼Œåˆ‡åˆ°ä¸‹ä¸€é¦–
    // ...
}

// 5. é€»è¾‘ï¼šç¼–è¾‘æ­Œæ›² (å¤ç”¨æ·»åŠ å¼¹çª—)
function editSelectedSong() {
    closeModal('modal-song-menu'); // å…ˆå…³èœå•
    const song = musicLibrary.find(s => s.id === actingSongId);
    if(!song) return;
    
    // æ‰“å¼€å¼¹çª—
    openAddMusicModal();
    
    // å¡«å……æ—§æ•°æ®
    document.getElementById('music-input-title').value = song.title;
    document.getElementById('music-input-artist').value = song.artist;
    if(song.src && !song.src.startsWith('blob')) {
        document.getElementById('music-input-url').value = song.src;
    }
    
    // åŠ è½½å°é¢é¢„è§ˆ
    loadSongCover(song.id, 'music-preview-img', false); // è¿™é‡Œçš„ false æ˜¯ä¸æ›´æ–°èƒŒæ™¯ï¼Œåªæ›´æ–°img
    document.getElementById('music-preview-img').style.opacity = 1;
    
    // âš ï¸ å…³é”®ï¼šæˆ‘ä»¬è¦ä¿®æ”¹ confirmAddSong å‡½æ•°ï¼Œè®©å®ƒçŸ¥é“ç°åœ¨æ˜¯â€œç¼–è¾‘æ¨¡å¼â€
    // æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¨å±€å˜é‡ let isEditingMusic = false;
    // è¿™ä¸€ç‚¹ç¨å¾®æœ‰ç‚¹éº»çƒ¦ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç®€å•é»‘ç§‘æŠ€ï¼š
    // æŠŠ actingSongId å­˜èµ·æ¥ï¼Œä¿®æ”¹ confirmAddSong
}

/* --- çµåŠ¨å²›æ•°æ®åŒæ­¥ --- */
function updateIslandUI(song) {
    if (!song) return;

    // 1. åŒæ­¥æ–‡å­—
    document.getElementById('capsule-text').textContent = song.title;
    document.getElementById('island-title').textContent = song.title;
    document.getElementById('island-artist').textContent = song.artist;

    // 2. åŒæ­¥å°é¢ (ä»ä¸»æ’­æ”¾å™¨é•œåƒï¼Œé˜²æ­¢æŸ¥åº“æŠ¥é”™)
    const mainCoverImg = document.getElementById('full-cover');
    let coverSrc = 'https://via.placeholder.com/150'; // é»˜è®¤å›¾
    
    if (mainCoverImg && mainCoverImg.src && mainCoverImg.src !== window.location.href) {
        coverSrc = mainCoverImg.src;
    }

    // è®¾ç½®å¤§å°é¢
    const bigCover = document.getElementById('island-cover');
    if(bigCover) bigCover.src = coverSrc;

    // è®¾ç½®å°å°é¢èƒŒæ™¯
    const miniCover = document.getElementById('capsule-mini-cover');
    if(miniCover) miniCover.style.backgroundImage = `url('${coverSrc}')`;

    // 3. åŒæ­¥æŒ‰é’®
    const mainPlayBtn = document.getElementById('full-play-btn');
    if(mainPlayBtn) document.getElementById('island-play-btn').innerHTML = mainPlayBtn.innerHTML;
    
    const mainModeBtn = document.getElementById('play-mode-btn');
    if(mainModeBtn) document.getElementById('island-mode-btn').innerHTML = mainModeBtn.innerHTML;
}

/* =========================================
   === âš¡ï¸ çµåŠ¨å²›æ ¸å¿ƒäº¤äº’ (Smart Island Logic) ===
   ========================================= */

// 1. å±•å¼€/æ”¶èµ·åˆ‡æ¢
function toggleIslandExpand() {
    const island = document.getElementById('smart-capsule');
    // åˆ‡æ¢ expanded ç±»å
    island.classList.toggle('expanded');
    
    // å¦‚æœå±•å¼€äº†ï¼Œé¡ºä¾¿åˆ·æ–°ä¸€ä¸‹é‡Œé¢çš„æ•°æ®ï¼Œé˜²æ­¢æ˜¾ç¤ºç©ºç™½
    if(island.classList.contains('expanded')) {
        // å¦‚æœæœ‰æ­£åœ¨æ’­æ”¾çš„æ­Œï¼Œå°±æ›´æ–°UI
        if(musicLibrary[currentTrackIndex]) {
            updateIslandUI(musicLibrary[currentTrackIndex]);
        }
    }
}

// 2. ç•Œé¢æ•°æ®åŒæ­¥ (é•œåƒç‰ˆ - ä¸æŸ¥åº“ï¼Œé˜²æŠ¥é”™)
function updateIslandUI(song) {
    if (!song) return;

    // A. æ–‡å­—åŒæ­¥
    const title = song.title || "Unknown";
    const artist = song.artist || "Unknown";

    // æ”¶èµ·çŠ¶æ€æ–‡å­—
    const capsuleText = document.getElementById('capsule-text');
    if(capsuleText) capsuleText.textContent = title;
    
    // å±•å¼€çŠ¶æ€æ–‡å­—
    const islandTitle = document.getElementById('island-title');
    const islandArtist = document.getElementById('island-artist');
    if(islandTitle) islandTitle.textContent = title;
    if(islandArtist) islandArtist.textContent = artist;

    // B. å°é¢åŒæ­¥ (ç›´æ¥å·ä¸»æ’­æ”¾å™¨çš„å›¾)
    const mainCoverImg = document.getElementById('full-cover');
    let coverSrc = 'https://via.placeholder.com/150'; // é»˜è®¤å›¾
    
    // åªè¦ä¸»å›¾æœ‰æ¥æºï¼Œå°±ç”¨ä¸»å›¾
    if (mainCoverImg && mainCoverImg.src && mainCoverImg.src !== window.location.href) {
        coverSrc = mainCoverImg.src;
    }

    // è®¾ç½®å¤§å°é¢
    const bigCover = document.getElementById('island-cover');
    if(bigCover) bigCover.src = coverSrc;

    // è®¾ç½®å°å°é¢èƒŒæ™¯
    const miniCover = document.getElementById('capsule-mini-cover');
    if(miniCover) miniCover.style.backgroundImage = `url('${coverSrc}')`;

    // C. æŒ‰é’®çŠ¶æ€åŒæ­¥
    const mainPlayBtn = document.getElementById('full-play-btn');
    const islandPlayBtn = document.getElementById('island-play-btn');
    if(mainPlayBtn && islandPlayBtn) islandPlayBtn.innerHTML = mainPlayBtn.innerHTML;
    
    const mainModeBtn = document.getElementById('play-mode-btn');
    const islandModeBtn = document.getElementById('island-mode-btn');
    if(mainModeBtn && islandModeBtn) islandModeBtn.innerHTML = mainModeBtn.innerHTML;
}

// 3. æ­Œè¯åŒæ­¥ (ç®€æ˜“ç‰ˆ)
function syncIslandLyrics() {
    const lyricEl = document.getElementById('island-lyric-text');
    // ç›´æ¥è¯»å–ä¸»ç•Œé¢å½“å‰é«˜äº®çš„é‚£ä¸€å¥
    const activeLine = document.querySelector('.lyric-line.active');
    
    if(activeLine && lyricEl) {
        // åªå–æ–‡å­—ï¼Œä¸è¦é‡Œé¢çš„HTMLæ ‡ç­¾
        lyricEl.textContent = activeLine.textContent;
    }
}

// 4. è¿›åº¦æ¡åŒæ­¥
function syncIslandProgress(currentTime, duration, pct) {
    const currEl = document.getElementById('island-curr-time');
    const totalEl = document.getElementById('island-total-time');
    const slider = document.getElementById('island-seek-slider');

    if(currEl) currEl.textContent = formatTime(currentTime);
    if(totalEl) totalEl.textContent = formatTime(duration);
    
    if(slider) {
        slider.value = pct || 0;
        // æ›´æ–°å·¦ç™½å³ç°æ•ˆæœ
        slider.style.setProperty('--seek-before-width', `${pct}%`);
    }
}

// 5. æ‰“å¼€çµåŠ¨å²›æ’­æ”¾åˆ—è¡¨ (å¼¹çª—)
// --- ä¿®å¤ï¼šåˆ—è¡¨å¼¹çª—é€»è¾‘ ---
function openIslandPlaylist() {
    const modal = document.getElementById('modal-island-list');
    const container = document.getElementById('island-list-container');
    
    // è°ƒè¯•æ£€æŸ¥ï¼šå¦‚æœè¿˜æ‰¾ä¸åˆ°ï¼Œè¯´æ˜HTMLæ²¡åŠ å¯¹
    if(!modal || !container) {
        console.error("ä¸¥é‡é”™è¯¯ï¼šæ‰¾ä¸åˆ° id='modal-island-list'ã€‚è¯·æ£€æŸ¥ç¬¬ä¸€æ­¥æ˜¯å¦æ·»åŠ äº†HTMLï¼");
        alert("è¯·å…ˆæ·»åŠ  HTML ä»£ç ï¼");
        return;
    }

    container.innerHTML = '';
    musicLibrary.forEach((song, idx) => {
        const div = document.createElement('div');
        div.style.padding = '15px 20px';
        div.style.borderBottom = '1px solid #f2f2f7';
        div.style.cursor = 'pointer';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';
        
        // é«˜äº®æ­£åœ¨æ’­æ”¾çš„
        if(idx === currentTrackIndex) {
            div.style.color = '#007aff';
            div.style.fontWeight = 'bold';
            div.style.backgroundColor = '#f9f9f9';
        } else {
            div.style.color = '#333';
        }

        div.innerHTML = `
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:16px;">${song.title}</span>
                <span style="font-size:12px; opacity:0.6;">${song.artist}</span>
            </div>
            ${idx === currentTrackIndex ? '<span></span>' : ''}
        `;
        
        div.onclick = () => {
            playSongAtIndex(idx);
            setTimeout(() => closeModal('modal-island-list'), 100);
        };
        container.appendChild(div);
    });
    
    modal.style.display = 'flex';
}

/* ==================================================
   === âš¡ï¸ ç»ˆæä¿®å¤ï¼šæ’­æ”¾æŒ‰é’®å›¾æ ‡å…¨å±€åŒæ­¥ ===
   ================================================== */

// 1. å®šä¹‰å›¾æ ‡ SVG (é˜²æ­¢åˆ°å¤„å†™ä¸ä¸€è‡´)
const SVG_ICON_PLAY = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
const SVG_ICON_PAUSE = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';

// 2. è·å–æ’­æ”¾å™¨æ ¸å¿ƒ
const globalAudio = document.getElementById('hidden-player');

// 3. ç›‘å¬ "æ’­æ”¾" äº‹ä»¶ (åªè¦å¼€å§‹å“ï¼Œå°±ç»Ÿç»Ÿå˜æš‚åœå›¾æ ‡)
globalAudio.addEventListener('play', () => {
    // åŒæ­¥æ‰€æœ‰ç•Œé¢çš„æŒ‰é’®ä¸º "æš‚åœ (||)"
    updateAllButtons(SVG_ICON_PAUSE);
    
    // è®©å”±ç‰‡è½¬èµ·æ¥
    document.getElementById('mini-player').classList.add('playing');
    document.querySelector('.music-capsule').classList.add('playing');
});

// 4. ç›‘å¬ "æš‚åœ" äº‹ä»¶ (åªè¦åœäº†ï¼Œå°±ç»Ÿç»Ÿå˜æ’­æ”¾å›¾æ ‡)
globalAudio.addEventListener('pause', () => {
    // åŒæ­¥æ‰€æœ‰ç•Œé¢çš„æŒ‰é’®ä¸º "æ’­æ”¾ (â–¶)"
    updateAllButtons(SVG_ICON_PLAY);
    
    // è®©å”±ç‰‡åœä¸‹æ¥
    document.getElementById('mini-player').classList.remove('playing');
    document.querySelector('.music-capsule').classList.remove('playing');
});

// 5. ç»Ÿä¸€æ›´æ–°å‡½æ•°
function updateAllButtons(svgContent) {
    // è¿·ä½ æ’­æ”¾å™¨
    const btnMini = document.getElementById('mini-play-btn');
    if(btnMini) btnMini.innerHTML = svgContent;
    
    // å…¨å±æ’­æ”¾å™¨
    const btnFull = document.getElementById('full-play-btn');
    if(btnFull) btnFull.innerHTML = svgContent;
    
    // çµåŠ¨å²›æ’­æ”¾å™¨
    const btnIsland = document.getElementById('island-play-btn');
    if(btnIsland) btnIsland.innerHTML = svgContent;
}

/* =========================================
   === ğŸ’¬ èŠå¤© App é€»è¾‘ (Chat Logic) ===
   ========================================= */

// 1. åˆå§‹åŒ– (åŠ è½½å¥½å‹)
// ä½ å¯ä»¥åœ¨ openApp('chat') é‡Œè°ƒç”¨è¿™ä¸ª
function initChatApp() {
    const list = document.getElementById('chat-online-list');
    list.innerHTML = '';
    
    // å¤ç”¨ characters æ•°ç»„ (è§’è‰²ä¹¦çš„æ•°æ®)
    // å¦‚æœè¿˜æ²¡åŠ è½½ï¼Œå°±å…ˆè¯»ä¸€ä¸‹
    let chars = characters;
    if(chars.length === 0) {
        const saved = localStorage.getItem('os_characters_data');
        if(saved) chars = JSON.parse(saved);
    }

    // æ¸²æŸ“åœ¨çº¿å¤´åƒ
    chars.forEach(c => {
        const div = document.createElement('div');
        div.className = 'online-item';
        div.innerHTML = `
            <div class="online-avatar-box">
                <img id="chat-av-${c.id}" class="online-avatar-img" src="">
                <div class="online-dot"></div>
            </div>
            <div class="online-name">${c.name}</div>
        `;
        list.appendChild(div);
        // å¼‚æ­¥åŠ è½½å¤´åƒ
        loadCharImage(c.id, 'avatar', `chat-av-${c.id}`);
    });
    
    // å¦‚æœæ²¡æœ‰å¥½å‹ï¼Œæ˜¾ç¤ºä¸ªæ·»åŠ æç¤º
    if(chars.length === 0) {
        list.innerHTML = '<div style="padding:10px; font-size:12px; color:#999;">No friends added yet.<br>Go to Character Book.</div>';
    }
}

// 2. Tab åˆ‡æ¢é€»è¾‘ (å·²é€‚é…â€œåˆ—è¡¨â€é¡µ)
function switchChatTab(tabName, btnElement) {
    // A. è§†è§‰ï¼šåº•éƒ¨å¯¼èˆªæ é«˜äº®åˆ‡æ¢
    document.querySelectorAll('.chat-tab-item').forEach(btn => btn.classList.remove('active'));
    if(btnElement) btnElement.classList.add('active');

    // B. å†…å®¹ï¼šåˆ‡æ¢è§†å›¾
    document.querySelectorAll('.chat-view').forEach(view => view.style.display = 'none');
    const targetView = document.getElementById(`chat-view-${tabName}`);
    if (targetView) targetView.style.display = (tabName === 'list' ? 'flex' : 'block');

    // C. æ ‡é¢˜å’ŒåŠ¨æ€æŒ‰é’®é€»è¾‘
    const chatHeader = document.getElementById('chat-header');
    const closeBtn = document.getElementById('chat-close-btn');
    const title = chatHeader.querySelector('.app-title');
    
    // æ¸…é™¤æ—§çš„åŠ å·
    const existingPlus = chatHeader.querySelector('.list-add-btn-top');
    if(existingPlus) existingPlus.remove();

    if (tabName === 'msg') {
        closeBtn.style.display = 'block';
        title.textContent = 'Messages';
    } else if (tabName === 'list') {
        closeBtn.style.display = 'none';
        title.textContent = 'Contacts';
        // æ³¨å…¥åŠ å·
        const plusBtn = document.createElement('div');
        plusBtn.className = 'list-add-btn-top';
        plusBtn.innerHTML = `<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
        plusBtn.onclick = (e) => { e.stopPropagation(); toggleAddMenu(); };
        chatHeader.appendChild(plusBtn);
    } else {
        closeBtn.style.display = 'none';
        title.textContent = tabName === 'moments' ? 'Moments' : 'Profile';
    }
}

/* =========================================
   === ğŸ“‡ çŠ¶æ€åç‰‡é€»è¾‘ (Status Logic) ===
   ========================================= */

// 1. æ‰“å¼€çŠ¶æ€åç‰‡
function openUserStatus(charId) {
    // æ‰¾åˆ°è§’è‰²æ•°æ®
    const char = characters.find(c => c.id === charId);
    if (!char) return;

    // å¡«å……æ•°æ®
    document.getElementById('status-card-name').textContent = char.name;
    // æ¨¡æ‹Ÿä¸€ä¸ªç­¾åï¼Œå¦‚æœæœ‰çœŸå®ç®€ä»‹å°±ç”¨ç®€ä»‹ï¼Œå¦åˆ™éšæœºæä¸€ä¸ª
    const statuses = ["æ­£åœ¨å¬æ­Œ ğŸµ", "å·¥ä½œä¸­ ğŸ’¼", "å‘å‘†ä¸­ ğŸ˜¶", "åˆšåˆšæ‹äº†å¼ ç…§ç‰‡ ğŸ“·", "Active Now"];
    const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
    // å¦‚æœè§’è‰²ä¹¦é‡Œæœ‰ desc å°±ç”¨ descï¼Œå¤ªé•¿å°±æˆªæ–­
    const bio = char.desc ? (char.desc.length > 20 ? char.desc.substring(0, 20) + '...' : char.desc) : randomStatus;
    
    document.getElementById('status-card-bio').textContent = bio;

    // åŠ è½½é«˜æ¸…å¤§å›¾
    loadCharImage(char.id, 'avatar', 'status-card-avatar');

    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('modal-user-status').style.display = 'flex';
}

// 2. æ¨¡æ‹Ÿï¼šä»åç‰‡å‘èµ·èŠå¤©
function startChatFromCard() {
    closeModal('modal-user-status');
    // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°èŠå¤©ç•Œé¢ï¼Œæˆ–è€…ä»…ä»…æ˜¯ä¸ªè§†è§‰åé¦ˆ
    showIOSAlert("Chat", "Entering chat room...");
}

// 3. ã€å…³é”®ã€‘ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶
// è¯·æ‰¾åˆ°åŸæ¥çš„ initChatAppï¼ŒæŠŠå®ƒé‡Œé¢ç”Ÿæˆ div çš„éƒ¨åˆ†æ”¹æˆä¸‹é¢è¿™æ ·ï¼š
/*
    åŸæ¥çš„: div.innerHTML = `...`;
    
    ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ”¹æˆä¸‹é¢è¿™æ ·ï¼Œé‡ç‚¹æ˜¯åŠ äº† onclick ğŸ‘‡ğŸ‘‡ğŸ‘‡
*/
const originalInitChatFunc = window.initChatApp; 
window.initChatApp = function() {
    const list = document.getElementById('chat-online-list');
    if(!list) return;
    list.innerHTML = '';
    
    let chars = characters;
    if(chars.length === 0) {
        try { chars = JSON.parse(localStorage.getItem('os_characters_data') || '[]'); } catch(e){}
    }

    chars.forEach(c => {
        const div = document.createElement('div');
        div.className = 'online-item';
        
        // âœ… è¿™é‡Œç»‘å®šäº†ç‚¹å‡»äº‹ä»¶ï¼
        div.onclick = () => openUserStatus(c.id);
        
        div.innerHTML = `
            <div class="online-avatar-box">
                <img id="chat-av-${c.id}" class="online-avatar-img" src="">
                <div class="online-dot"></div>
            </div>
            <div class="online-name">${c.name}</div>
        `;
        list.appendChild(div);
        loadCharImage(c.id, 'avatar', `chat-av-${c.id}`);
    });
    
    // åˆ«å¿˜äº†æ¸²æŸ“ä¸‹é¢çš„åˆ—è¡¨
    if(typeof renderChatList === 'function') renderChatList();
};

// 1. åˆ—è¡¨å†…éƒ¨å­é¡µåˆ‡æ¢
function switchListSubTab(sub, btnElement) {
    // è§†è§‰åˆ‡æ¢
    document.querySelectorAll('.sub-nav-item').forEach(t => t.classList.remove('active'));
    if(btnElement) btnElement.classList.add('active');
    
    // å†…å®¹åˆ‡æ¢
    document.getElementById('list-content-friends').style.display = sub === 'friends' ? 'block' : 'none';
    document.getElementById('list-content-groups').style.display = sub === 'groups' ? 'block' : 'none';
}

// 2. åŠ å·èœå•å¼€å…³
function toggleAddMenu() {
    const menu = document.getElementById('list-add-menu');
    const isShow = menu.style.display === 'block';
    menu.style.display = isShow ? 'none' : 'block';
    
    if(!isShow) {
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        setTimeout(() => {
            const closeHandler = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeHandler);
            };
            document.addEventListener('click', closeHandler);
        }, 0);
    }
}

// 3. æ‰“å¼€åˆ›å»ºå¼¹çª—
let createMode = 'manual'; 
function openCreateFriendModal() {
    toggleAddMenu();
    document.getElementById('modal-create-friend').style.display = 'flex';
    showManualCreate(); // é»˜è®¤æ‰‹åŠ¨
}

/* =========================================
   === ğŸ‘¤ åˆ›å»ºå¥½å‹é€»è¾‘ (å…¨åŠŸèƒ½ä¿®å¤ç‰ˆ) ===
   ========================================= */

let tempNewFriendAvatarFile = null; // å­˜å‚¨æ‰‹åŠ¨ä¸Šä¼ çš„å¤´åƒ
let selectedBookCharId = null;     // å­˜å‚¨è§’è‰²ä¹¦é€‰æ‹©çš„ID

// 1. åˆ‡æ¢åˆ°æ‰‹åŠ¨åˆ›å»º
function showManualCreate() {
    createMode = 'manual';
    // åˆ‡æ¢æŒ‰é’®é¢œè‰²
    document.getElementById('btn-mode-manual').classList.add('active');
    document.getElementById('btn-mode-book').classList.remove('active');
    // åˆ‡æ¢å†…å®¹
    document.getElementById('create-manual-form').style.display = 'block';
    document.getElementById('create-book-list').style.display = 'none';
}

// 2. åˆ‡æ¢åˆ°è§’è‰²ä¹¦é€‰æ‹© (ä¿®å¤æŠ¥é”™ï¼šè¡¥å…¨ selectBookChar)
function showBookSelect() {
    createMode = 'book';
    selectedBookCharId = null; // é‡ç½®é€‰ä¸­
    
    // UI æŒ‰é’®åˆ‡æ¢
    document.getElementById('btn-mode-book').classList.add('active');
    document.getElementById('btn-mode-manual').classList.remove('active');
    document.getElementById('create-manual-form').style.display = 'none';
    
    const listArea = document.getElementById('create-book-list');
    listArea.style.display = 'block';
    
    // è·å–è§’è‰²ä¹¦æ•°æ®
    let chars = [];
    try { chars = JSON.parse(localStorage.getItem('os_characters_data') || '[]'); } catch(e){}
    
    if (chars.length === 0) {
        listArea.innerHTML = '<div class="empty-book-tip">ğŸ“š è§’è‰²ä¹¦æ˜¯ç©ºçš„<br>è¯·å…ˆåœ¨è§’è‰²ä¹¦Appåˆ›å»ºäººç‰©</div>';
        return;
    }

    // æ¸²æŸ“å¸¦å¤´åƒçš„åˆ—è¡¨
    listArea.innerHTML = chars.map(c => `
        <div class="book-char-item" id="book-char-${c.id}" onclick="selectBookChar('${c.id}')">
            <img class="book-char-avatar" id="book-list-av-${c.id}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
            <span class="book-char-name">${c.name}</span>
        </div>
    `).join('');

    // å¼‚æ­¥åŠ è½½æ¯ä¸ªäººçš„å¤´åƒ
    chars.forEach(c => {
        loadCharImage(c.id, 'avatar', `book-list-av-${c.id}`);
    });
}

// âœ… è¡¥å…¨ï¼šä¿®å¤æ§åˆ¶å°æŠ¥é”™çš„å‡½æ•°
function selectBookChar(id) {
    selectedBookCharId = id;
    
    // ç§»é™¤æ‰€æœ‰æ—§çš„é€‰ä¸­æ ·å¼
    document.querySelectorAll('.book-char-item').forEach(el => {
        el.classList.remove('selected');
    });
    
    // ç»™å½“å‰é€‰ä¸­çš„åŠ ä¸Š selected ç±»
    const selectedEl = document.getElementById(`book-char-${id}`);
    if (selectedEl) {
        selectedEl.classList.add('selected');
    }
}

// âœ… è¡¥å…¨ï¼šå¤„ç†æ‰‹åŠ¨åˆ›å»ºå¤´åƒçš„é¢„è§ˆ
function handleNewFriendAvatar(input) {
    if (input.files && input.files[0]) {
        tempNewFriendAvatarFile = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('new-friend-avatar-img');
            img.src = e.target.result;
            img.style.opacity = 1;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 3. æœ€ç»ˆç¡®è®¤åˆ›å»º
// âœ… ä¿®å¤åçš„ç¡®è®¤åˆ›å»ºå‡½æ•°ï¼šç›´æ¥æ¸²æŸ“åˆ°åˆ—è¡¨
function confirmCreateFriend() {
    // 1. æ‰¾åˆ°å¥½å‹åˆ—è¡¨çš„å®¹å™¨
    const friendsListContainer = document.getElementById('list-content-friends');
    if (!friendsListContainer) {
        console.error("ä¸¥é‡é”™è¯¯ï¼šæ‰¾ä¸åˆ° id ä¸º 'list-content-friends' çš„å®¹å™¨ï¼è¯·æ£€æŸ¥ HTMLã€‚");
        return;
    }

    // 2. å‡†å¤‡æ–°å¥½å‹çš„æ•°æ®
    let newFriendId = '';
    let newFriendName = '';
    let isManual = false;

    // æ ¹æ®å½“å‰æ¨¡å¼è·å–æ•°æ®
    if (createMode === 'manual') {
        // --- æ‰‹åŠ¨æ¨¡å¼ ---
        newFriendName = document.getElementById('new-friend-name').value;
        if (!newFriendName) return showIOSAlert("æç¤º", "è¯·è¾“å…¥æ˜µç§°");
        newFriendId = 'manual_' + Date.now(); // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ID
        isManual = true;
    } else {
        // --- è§’è‰²ä¹¦æ¨¡å¼ ---
        if (!selectedBookCharId) return showIOSAlert("æç¤º", "è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²");
        // æ‰¾åˆ°é€‰ä¸­çš„é‚£ä¸ªè§’è‰²å¯¹è±¡
        const char = characters.find(c => c.id === selectedBookCharId);
        if (!char) return; // å®‰å…¨æ£€æŸ¥
        newFriendId = char.id;
        newFriendName = char.name;
        isManual = false;
    }

    // 3. ğŸ”¥ æ ¸å¿ƒï¼šæ„å»ºè¦æ’å…¥çš„åˆ—è¡¨é¡¹ HTML ç»“æ„
    // è¿™é‡Œçš„ç»“æ„å°±æ˜¯ï¼šå·¦è¾¹å¤´åƒ -> å³è¾¹åå­—
    const newItemHTML = `
        <div class="chat-item" id="friend-item-${newFriendId}">
            <img class="chat-avatar" id="friend-av-img-${newFriendId}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
            <div class="chat-content">
                <div class="chat-name-row">
                    <span class="chat-name">${newFriendName}</span>
                </div>
                <div class="chat-preview" style="color:#999;">æ–°æ·»åŠ çš„å¥½å‹</div>
            </div>
        </div>
    `;

    // 4. æŠŠæ–°çš„ä¸€æ¡æ’åˆ°åˆ—è¡¨æœ€å‰é¢
    friendsListContainer.insertAdjacentHTML('afterbegin', newItemHTML);

    // 5. ğŸš€ æ ¸å¿ƒï¼šç«‹åˆ»è®©å¤´åƒæ˜¾ç¤ºå‡ºæ¥
    const imgElement = document.getElementById(`friend-av-img-${newFriendId}`);
    
    if (isManual) {
        // å¦‚æœæ˜¯åˆšæ‰æ‰‹åŠ¨ä¸Šä¼ çš„å›¾ç‰‡ï¼Œç›´æ¥è¯»å‡ºæ¥æ˜¾ç¤º
        if (tempNewFriendAvatarFile) {
            const reader = new FileReader();
            reader.onload = (e) => { imgElement.src = e.target.result; };
            reader.readAsDataURL(tempNewFriendAvatarFile);
        } else {
            // æ²¡ä¸Šä¼ å°±ç”¨é»˜è®¤å›¾
            imgElement.src = 'https://via.placeholder.com/50/cccccc/ffffff?text=' + newFriendName[0];
        }
    } else {
        // å¦‚æœæ˜¯è§’è‰²ä¹¦å¯¼å…¥çš„ï¼Œè°ƒç”¨å·²æœ‰å‡½æ•°å»åŠ è½½å®ƒçš„å¤´åƒ
        loadCharImage(newFriendId, 'avatar', `friend-av-img-${newFriendId}`);
    }

    // 6. æ”¶å°¾å·¥ä½œï¼šå…³é—­å¼¹çª—ï¼Œæç¤ºæˆåŠŸ
    closeModal('modal-create-friend');
    showIOSAlert("æˆåŠŸ", `å·²æ·»åŠ å¥½å‹: ${newFriendName}`);

    // 7. é‡ç½®è¡¨å•ï¼Œä¸ºä¸‹æ¬¡åˆ›å»ºåšå‡†å¤‡
    document.getElementById('new-friend-name').value = '';
    document.getElementById('new-friend-avatar-img').src = '';
    document.getElementById('new-friend-avatar-img').style.opacity = 0;
    tempNewFriendAvatarFile = null;
    selectedBookCharId = null;
    // æ¸…é™¤è§’è‰²ä¹¦åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.book-char-item').forEach(el => el.classList.remove('selected'));
}

// 5. åˆ›å»ºç¾¤èŠå ä½ (é€»è¾‘ä¸å¥½å‹ç±»ä¼¼)
// æ‰“å¼€ç¾¤èŠåˆ›å»ºå¼¹çª—
function openCreateGroupModal() {
    toggleAddMenu();
    const listArea = document.getElementById('group-select-list');
    listArea.innerHTML = '';
    
    if (chatFriends.length === 0) {
        listArea.innerHTML = '<div style="padding:10px; color:#999; font-size:12px;">å…ˆå»æ·»åŠ ä¸€äº›å¥½å‹å§</div>';
    } else {
        chatFriends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'book-char-item';
            div.style.padding = '8px 12px';
            div.innerHTML = `
                <input type="checkbox" value="${f.id}" class="group-member-checkbox" style="margin-right:10px;">
                <span class="book-char-name">${f.name}</span>
            `;
            listArea.appendChild(div);
        });
    }
    document.getElementById('modal-create-group').style.display = 'flex';
}

// ç¡®è®¤åˆ›å»ºç¾¤èŠ
function confirmCreateGroup() {
    const name = document.getElementById('group-name-input').value;
    const checkboxes = document.querySelectorAll('.group-member-checkbox:checked');
    
    if (!name) return showIOSAlert("æç¤º", "è¯·è¾“å…¥ç¾¤èŠåç§°");
    if (checkboxes.length === 0) return showIOSAlert("æç¤º", "è¯·é€‰æ‹©è‡³å°‘ä¸€åæˆå‘˜");

    const members = Array.from(checkboxes).map(cb => cb.value);
    const newGroup = {
        id: "group_" + Date.now(),
        name: name,
        members: members
    };

    chatGroups.push(newGroup);
    localStorage.setItem('os_chat_groups', JSON.stringify(chatGroups));
    
    renderGroupsList();
    closeModal('modal-create-group');
    showIOSAlert("æˆåŠŸ", `ç¾¤èŠ "${name}" å·²åˆ›å»º`);
    document.getElementById('group-name-input').value = '';
}

/* =========================================
   === ğŸ‘¥ ç¤¾äº¤å…³ç³»ç®¡ç† (Friends & Groups) ===
   ========================================= */

// 1. æ•°æ®åˆå§‹åŒ–ï¼šä»æœ¬åœ°è¯»å–å·²ä¿å­˜çš„å…³ç³»
let chatFriends = JSON.parse(localStorage.getItem('os_chat_friends') || '[]');
let chatGroups = JSON.parse(localStorage.getItem('os_chat_groups') || '[]');

// 2. æ ¸å¿ƒï¼šæ¸²æŸ“å¥½å‹åˆ—è¡¨ (å¸¦ä¾§æ»‘åŠŸèƒ½)
function renderFriendsList() {
    const container = document.getElementById('list-content-friends');
    if (!container) return;

    if (chatFriends.length === 0) {
        container.innerHTML = '<div class="empty-state" style="margin-top:40px;"><div style="font-size:40px;">ğŸ‘¥</div><p style="color:#999; margin-top:10px;">æš‚æ— å¥½å‹</p></div>';
        return;
    }

    // ğŸ”¥ æ ¸å¿ƒæ’åºï¼šæŠŠâ€œç‰¹åˆ«å…³å¿ƒâ€çš„å¥½å‹æ’åœ¨æœ€å‰é¢
    chatFriends.sort((a, b) => (b.isSpecial ? 1 : 0) - (a.isSpecial ? 1 : 0));

    container.innerHTML = chatFriends.map(f => `
        <div class="list-item-wrapper" id="wrapper-${f.id}">
            
            <div class="swipe-actions">
                <div class="action-btn special" onclick="toggleSpecial('${f.id}')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    <span>ç‰¹åˆ«</span>
                </div>
                <div class="action-btn delete" onclick="deleteFriend('${f.id}')">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    <span>åˆ é™¤</span>
                </div>
            </div>

            <div class="chat-item" id="item-${f.id}" 
                 ontouchstart="handleTouchStart(event, '${f.id}')"
                 ontouchmove="handleTouchMove(event, '${f.id}')"
                 ontouchend="handleTouchEnd(event, '${f.id}')"
                 onclick="openChatWithFriend('${f.id}')">
                
                <img class="chat-avatar ${f.isSpecial ? 'is-special' : ''}" id="friend-av-${f.id}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                
                <div class="chat-content">
                    <div class="chat-name-row">
                        <span class="chat-name">${f.name}</span>
                        ${f.isSpecial ? '<span class="star-badge">â˜…</span>' : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // åŠ è½½å¤´åƒ
    chatFriends.forEach(f => {
        if (f.fromBook) loadCharImage(f.id, 'avatar', `friend-av-${f.id}`);
        else loadCustomAvatar(f.id, `friend-av-${f.id}`);
    });
}

// é¡ºä¾¿è¡¥ä¸€ä¸ªå ä½çš„ç‚¹å‡»å‡½æ•°ï¼Œé˜²æ­¢æŠ¥é”™
function openChatWithFriend(id) {
    showIOSAlert("Chat", "Coming soon: Chat interface for " + id);
}

// 3. æ ¸å¿ƒï¼šæ¸²æŸ“ç¾¤èŠåˆ—è¡¨
function renderGroupsList() {
    const container = document.getElementById('list-content-groups');
    if (!container) return;

    if (chatGroups.length === 0) {
        container.innerHTML = '<div class="empty-state" style="margin-top:40px;"><div style="font-size:40px;">ğŸ’¬</div><p style="color:#999; margin-top:10px;">æš‚æ— ç¾¤èŠ</p></div>';
        return;
    }

    container.innerHTML = chatGroups.map(g => `
        <div class="chat-item">
            <div class="chat-avatar" style="background:#007aff; color:white; display:flex; align-items:center; justify-content:center; font-size:20px;">ğŸ‘¥</div>
            <div class="chat-content">
                <div class="chat-name-row">
                    <span class="chat-name">${g.name}</span>
                    <span class="chat-time">${g.members.length}äºº</span>
                </div>
                <div class="chat-preview">ç¾¤èŠå·²å¼€å¯</div>
            </div>
        </div>
    `).join('');
}

// 4. ä¿®æ”¹ç¡®è®¤åˆ›å»ºé€»è¾‘
function confirmCreateFriend() {
    let newFriend = null;

    if (createMode === 'manual') {
        const name = document.getElementById('new-friend-name').value;
        if (!name) return showIOSAlert("æç¤º", "è¯·è¾“å…¥æ˜µç§°");
        const id = "manual_" + Date.now();
        newFriend = { id, name, fromBook: false };
        // å¦‚æœæœ‰ä¸Šä¼ å¤´åƒæ–‡ä»¶ï¼Œä¿å­˜åˆ°æ•°æ®åº“
        if (tempNewFriendAvatarFile) {
            saveFileToDB(`custom_avatar_${id}`, tempNewFriendAvatarFile);
        }
    } else {
        if (!selectedBookCharId) return showIOSAlert("æç¤º", "è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²");
        const char = characters.find(c => c.id === selectedBookCharId);
        // é˜²æ­¢é‡å¤æ·»åŠ 
        if (chatFriends.some(f => f.id === char.id)) return showIOSAlert("æç¤º", "è¯¥å¥½å‹å·²åœ¨åˆ—è¡¨ä¸­");
        newFriend = { id: char.id, name: char.name, fromBook: true };
    }

    chatFriends.push(newFriend);
    localStorage.setItem('os_chat_friends', JSON.stringify(chatFriends));
    
    renderFriendsList(); // ç«‹å³æ¸²æŸ“
    closeModal('modal-create-friend');
    showIOSAlert("æˆåŠŸ", "å¥½å‹å·²æ·»åŠ åˆ°åˆ—è¡¨");
    
    // é‡ç½®å˜é‡
    tempNewFriendAvatarFile = null;
    selectedBookCharId = null;
    document.getElementById('new-friend-avatar-img').style.opacity = 0;
    document.getElementById('new-friend-name').value = '';
}

// è¾…åŠ©å‡½æ•°ï¼šåŠ è½½æ‰‹åŠ¨åˆ›å»ºçš„å¤´åƒ
function loadCustomAvatar(id, imgId) {
    if (!db) return;
    const tx = db.transaction(['files'], 'readonly');
    const req = tx.objectStore('files').get(`custom_avatar_${id}`);
    req.onsuccess = () => {
        if (req.result) {
            document.getElementById(imgId).src = URL.createObjectURL(req.result);
        } else {
            document.getElementById(imgId).src = 'https://via.placeholder.com/100';
        }
    };
}

/* =========================================
   === ğŸ‘† ä¾§æ»‘äº¤äº’ (åŒå‘ä¿®å¤ç‰ˆ) & åˆ é™¤é€»è¾‘ ===
   ========================================= */

let startX = 0;
let startY = 0;
let initialTranslate = 0; // è®°å½•è§¦æ‘¸æ—¶çš„åˆå§‹ä½ç½®
let touchingId = null;    // å½“å‰æ­£åœ¨æ‘¸çš„é‚£ä¸ªå…ƒç´ ID
let tempDeleteId = null;  // å¾…åˆ é™¤çš„å¥½å‹ID

// 1. è§¦æ‘¸å¼€å§‹
function handleTouchStart(e, id) {
    const item = document.getElementById(`item-${id}`);
    if(!item) return;
    
    touchingId = id;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    
    // è·å–å½“å‰çš„åç§»é‡ (æ˜¯0è¿˜æ˜¯-140)
    const style = window.getComputedStyle(item);
    const matrix = new WebKitCSSMatrix(style.transform);
    initialTranslate = matrix.m41; // è·å–å½“å‰çš„ X ä½ç§»
    
    item.style.transition = 'none'; // æ‹–åŠ¨æ—¶å»æ‰åŠ¨ç”»ï¼Œä¿è¯è·Ÿæ‰‹
}

// 2. è§¦æ‘¸ç§»åŠ¨ (æ ¸å¿ƒä¿®å¤ï¼šæ”¯æŒå·¦å³æ»‘)
function handleTouchMove(e, id) {
    if(touchingId !== id) return;
    
    const currentX = e.touches[0].clientX;
    const currentY = e.touches[0].clientY;
    const diffX = currentX - startX;
    const diffY = currentY - startY;

    // å¦‚æœå‚ç›´æ»‘åŠ¨å¹…åº¦å¤§ï¼Œå°±ä¸å¤„ç†æ°´å¹³æ»‘åŠ¨ (é˜²è¯¯è§¦)
    if(Math.abs(diffY) > Math.abs(diffX)) return;

    // è®¡ç®—ç›®æ ‡ä½ç½® = åˆå§‹ä½ç½® + ç§»åŠ¨è·ç¦»
    let targetX = initialTranslate + diffX;

    // é™åˆ¶è¾¹ç•Œï¼šä¸èƒ½è¶…è¿‡ 0 (æœ€å³)ï¼Œä¸èƒ½è¶…è¿‡ -140 (æœ€å·¦ï¼Œä¸¤ä¸ªæŒ‰é’®å®½åº¦)
    if (targetX > 0) targetX = 0;
    if (targetX < -140) targetX = -140;

    const item = document.getElementById(`item-${id}`);
    if(item) {
        item.style.transform = `translateX(${targetX}px)`;
        e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
    }
}

// 3. è§¦æ‘¸ç»“æŸ (è‡ªåŠ¨å¸é™„)
function handleTouchEnd(e, id) {
    if(touchingId !== id) return;
    
    const item = document.getElementById(`item-${id}`);
    item.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; // åŠ å›å¼¹åŠ¨ç”»
    
    // è·å–æœ€ç»ˆæ¾æ‰‹æ—¶çš„ä½ç½®
    const style = window.getComputedStyle(item);
    const matrix = new WebKitCSSMatrix(style.transform);
    const currentX = matrix.m41;

    // åˆ¤æ–­é€»è¾‘ï¼š
    // å¦‚æœå·²ç»æ‹‰å¼€è¶…è¿‡ -70 (ä¸€åŠ)ï¼Œå°±å…¨å¼€ (-140)
    // å¦åˆ™å°±å¼¹å›å» (0)
    if (currentX < -70) {
        item.style.transform = 'translateX(-140px)';
    } else {
        item.style.transform = 'translateX(0px)';
    }
    
    touchingId = null;
}

// --- åŠŸèƒ½ï¼šè§¦å‘åˆ é™¤ (æ‰“å¼€è‡ªå®šä¹‰å¼¹çª—) ---
function deleteFriend(id) {
    const friend = chatFriends.find(f => f.id === id);
    if(!friend) return;

    // 1. è®°å½•è¦åˆ è°
    tempDeleteId = id;
    
    // 2. å¡«å……åå­—
    document.getElementById('del-friend-name').textContent = friend.name;
    
    // 3. æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª— (ä¸æ˜¯ confirm äº†ï¼)
    document.getElementById('modal-friend-delete').style.display = 'flex';
    
    // 4. è®©ä¾§æ»‘æ¡æ»‘å›å» (è§†è§‰ä¼˜åŒ–)
    const item = document.getElementById(`item-${id}`);
    if(item) item.style.transform = 'translateX(0)'; 
}

// --- åŠŸèƒ½ï¼šç¡®è®¤çœŸå®åˆ é™¤ (å¼¹çª—é‡Œç‚¹ç¡®å®šåæ‰§è¡Œ) ---
function confirmRealDeleteFriend() {
    if(!tempDeleteId) return;

    // 1. æ•°æ®ç§»é™¤
    chatFriends = chatFriends.filter(f => f.id !== tempDeleteId);
    localStorage.setItem('os_chat_friends', JSON.stringify(chatFriends));
    
    // 2. è§†è§‰ç§»é™¤ (åŠ¨ç”»)
    const wrapper = document.getElementById(`wrapper-${tempDeleteId}`);
    if(wrapper) {
        wrapper.style.height = '0px';
        wrapper.style.opacity = '0';
        wrapper.style.transition = 'all 0.3s ease';
    }

    // 3. å…³é—­å¼¹çª—
    closeModal('modal-friend-delete');
    
    // 4. åˆ·æ–°åˆ—è¡¨ (å»¶è¿Ÿä¸€ä¸‹ç­‰åŠ¨ç”»æ’­å®Œ)
    setTimeout(() => {
        renderFriendsList();
    }, 300);
    
    tempDeleteId = null;
}
</script>
</body>
</html>
