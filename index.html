<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Phone UI</title>
    <style>
        /* --- 全局设置 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            /* 换个稍微亮一点的壁纸图，更能显出磨砂玻璃效果 */
            background: url('https://images.unsplash.com/photo-1620121692029-d088224ddc74?q=80&w=2832&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            color: white; position: relative;
        }

        /* --- 1. 状态栏 --- */
        .status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 44px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 22px; z-index: 600;
            font-size: 15px; font-weight: 600; pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .status-right { display: flex; align-items: center; gap: 8px; }
        .battery-group { display: flex; align-items: center; gap: 5px; }
        .battery-shell {
            width: 25px; height: 12px; border: 1px solid rgba(255,255,255,0.5);
            border-radius: 3px; position: relative; padding: 1px; display: flex; align-items: center;
        }
        .battery-shell::after {
            content: ''; position: absolute; right: -4px; top: 50%; transform: translateY(-50%);
            width: 2px; height: 4px; background: rgba(255,255,255,0.5); border-radius: 0 2px 2px 0;
        }
        .battery-level { height: 100%; width: 100%; background-color: white; border-radius: 1px; }
        .charging-icon { display: none; font-size: 10px; color: #FFD700; }
        .signal-bars { display: flex; align-items: flex-end; gap: 2px; height: 12px; }
        .bar { width: 3px; background: rgba(255,255,255,0.3); border-radius: 1px; }
        .bar.active { background: white; }
        .bar:nth-child(1) { height: 4px; } .bar:nth-child(2) { height: 6px; }
        .bar:nth-child(3) { height: 9px; } .bar:nth-child(4) { height: 12px; }

        /* --- 2. 主屏幕滑动容器 --- */
        .home-slider {
            width: 100%; height: 100%; display: flex; overflow-x: auto;
            scroll-snap-type: x mandatory; padding-top: 50px;
        }
        .home-slider::-webkit-scrollbar { display: none; }

        .home-page {
            min-width: 100vw; height: 100%; scroll-snap-align: start;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 15px;
        }

        /* --- 3. 天气小组件 (完美复刻版) --- */
        .widget-weather {
            grid-column: span 2; grid-row: span 2;

            /* [关键] 高斯模糊 + 极淡的白色背景 */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); /* 毛玻璃核心 */
            border: 1px solid rgba(255, 255, 255, 0.15); /* 极细的边框 */
            border-radius: 22px;

            position: relative; /* 为了绝对定位城市名 */
            display: flex; flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */

            padding: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* 城市名：固定左上角 */
        .weather-city {
            position: absolute;
            top: 15px; left: 18px;
            font-size: 15px; font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        /* 中间内容包裹层 */
        .weather-center-content {
            display: flex; flex-direction: column; align-items: center;
            margin-top: 30px; /* 稍微避开顶部的城市名 */
        }

        /* 图标 */
        .weather-svg {
            width: 52px; height: 52px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* 温度：大号白色字体 */
        .weather-temp {
            font-size: 34px; font-weight: 300;
            margin-bottom: 2px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 描述：稍微小一点，带透明度 */
        .weather-desc {
            font-size: 13px; font-weight: 400;
            opacity: 0.8; /* 灰色质感 */
            margin-bottom: 15px;
        }

        /* 底部日期：堆叠居中 */
        .weather-date-info {
            display: flex; flex-direction: column; align-items: center;
            font-size: 12px;
            opacity: 0.6; /* 也是灰色质感 */
            font-weight: 500;
            margin-top: auto; /* 推到底部 */
        }
        .date-row { margin-top: 2px; }


        /* --- 4. Dock 栏 (配合整体风格) --- */
        .dock-container {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 88%; height: 85px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 26px;
            display: flex; justify-content: space-evenly; align-items: center; z-index: 200;
        }
        .app-icon {
            width: 54px; height: 54px; border-radius: 14px;
            background: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            font-size: 26px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.9); }

        /* --- 5. 升级版弹窗样式 (替换原来的弹窗样式) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4); z-index: 500;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; }

        .modal-content {
            width: 85%; max-height: 70%;
            background: rgba(30,30,35,0.9);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            color: white; transform: scale(0.95); transition: all 0.3s;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        /* 标题栏 */
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: 600; }

        /* 搜索栏 */
        .search-box {
            width: 100%; padding: 10px 15px; margin-bottom: 15px;
            background: rgba(255,255,255,0.1); border-radius: 12px;
            border: none; outline: none; color: white; font-size: 14px;
        }
        .search-box::placeholder { color: rgba(255,255,255,0.4); }

        /* 地区分类 Tab */
        .tab-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; padding: 8px; border-radius: 8px;
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6); font-size: 13px; cursor: pointer;
        }
        .tab-btn.active { background: white; color: black; border-color: white; font-weight: 600; }

        /* 城市列表 (滚动区域) */
        .city-list {
            flex: 1; overflow-y: auto; margin-bottom: 15px;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
        }
        .city-item {
            padding: 12px; margin-bottom: 5px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .city-item:active { background: rgba(255,255,255,0.1); }
        .city-item.selected { background: rgba(33, 150, 243, 0.3); border: 1px solid #2196F3; }
        .city-name { font-size: 15px; }
        .city-sub { font-size: 12px; opacity: 0.5; }

        /* 底部按钮组 */
        .modal-footer { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            font-size: 15px; font-weight: 500; cursor: pointer;
        }
        .btn-cancel { background: rgba(255,255,255,0.1); color: white; }
        .btn-save { background: #2196F3; color: white; }

        /* --- 照片小组件样式 --- */
        .widget-photo {
            /* 同样占据 2x2 的格子 */
            grid-column: span 2;
            grid-row: span 2;

            /* 保持和天气组件一样的玻璃风格 */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 22px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);

            /* 布局设置 */
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; /* 保证图片圆角不溢出 */
            cursor: pointer; position: relative;
            transition: transform 0.1s;
        }
        .widget-photo:active { transform: scale(0.96); }

        /* 默认显示的加号提示 */
        .photo-placeholder {
            display: flex; flex-direction: column; align-items: center;
            color: white; opacity: 0.7;
        }
        .plus-icon { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .add-text { font-size: 13px; font-weight: 500; }

        /* 真正显示图片的区域 (默认隐藏) */
        .photo-display {
            width: 100%; height: 100%;
            background-size: cover; background-position: center;
            display: none; /* 选了图再显示 */
        }

        /* --- 5. 音乐小组件 (精修版) --- */
        .widget-music {
            /* 1. 位置和背景 */
            grid-row: span 2;
            grid-column: span 4;
            background: rgba(255, 255, 255, 0.1); /* 背景淡一点 */
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); /* 阴影加重，更有立体感 */

            /* 2. 内部布局 */
            display: flex;
            align-items: center; /* 垂直居中 */
            padding: 20px 25px; /* 增加左右内边距 */
            gap: 20px; /* 封面和右边的间距 */
        }

        /* 封面图 */
        .music-cover {
            width: 85px; height: 85px; /* 稍微放大一点 */
            flex-shrink: 0;
            border-radius: 18px;
            background-size: cover; background-position: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* 封面阴影 */
            cursor: pointer; position: relative; overflow: hidden;
        }
        .music-cover:active { transform: scale(0.95); transition: 0.1s; }

        /* 右侧容器：核心修改 */
        .music-details-container {
            flex: 1;
            height: 85px; /* 强制高度和封面一样，方便对齐 */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 关键：让 歌名(上) 进度条(中) 按钮(下) 均匀分布 */
            overflow: hidden;
        }

        /* 歌名和歌手 */
        .music-text-group { cursor: pointer; }
        .song-title {
            font-size: 17px; font-weight: 700; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .artist-name {
            font-size: 13px; color: rgba(255,255,255,0.7);
            margin-top: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 进度条 */
        .progress-bar-bg {
            width: 100%; height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            cursor: pointer;
            margin-top: auto; margin-bottom: auto; /* 自动居中 */
        }
        .progress-bar-fill {
            width: 0%; height: 100%;
            background: white;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5); /* 进度条发光 */
            transition: width 0.1s linear;
        }

        /* 控制按钮 */
        .music-controls {
            display: flex;
            align-items: center;
            justify-content: center; /* 按钮居中 */
            gap: 25px; /* 按钮之间的间距加大 */
        }
        .control-btn {
            background: none; border: none; padding: 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .control-btn:active { transform: scale(0.85); opacity: 0.8; }

        /* 图标样式 */
        .ctrl-svg {
            width: 24px; height: 24px;
            fill: white; opacity: 0.8;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .play-pause-btn .ctrl-svg {
            width: 32px; height: 32px; /* 播放键更大 */
            opacity: 1;
        }
        /* --- 6. 个人信息小组件 (透明背景) --- */
        .widget-profile {
            /* 占据第5行，第1-2列 */
            grid-row: 5; grid-column: span 2;

            /* 透明背景，无边框阴影 */
            background: transparent;
            box-shadow: none; border: none;

            /* 布局：垂直居中 */
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 10px;
        }

        /* 头像区域 */
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%; /* 圆形 */
            /* 默认头像占位图 (灰色人像) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" opacity="0.5"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
            background-size: cover; background-position: center;
            background-color: rgba(255,255,255,0.1); /* 微弱底色 */
            border: 2px solid rgba(255,255,255,0.3); /* 细白边框 */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; position: relative; overflow: hidden;
            margin-bottom: 10px; transition: transform 0.1s;
        }
        .profile-avatar:active { transform: scale(0.95); }

        /* 文字区域容器 */
        .profile-text { text-align: center; }

        /* 昵称样式 */
        .profile-nickname {
            font-size: 18px; font-weight: 700; color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;
            margin-bottom: 4px;
        }

        /* 个性签名样式 */
        .profile-signature {
            font-size: 13px; color: rgba(255,255,255,0.7);
            cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;
        }

        /* --- 编辑弹窗专用样式 (复用基础结构，微调输入框) --- */
        #profile-edit-input {
            background: rgba(255,255,255,0.15);
            font-size: 16px; padding: 15px;
            text-align: center;
        }

        /* --- 7. App 图标 (液态玻璃终极版) --- */
        .grid-app-item {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }

        /* 液态玻璃主体 */
        .app-icon-shape {
            width: 64px; height: 64px;
            border-radius: 18px; /* 圆角稍微大一点，更像水滴 */
            display: flex; align-items: center; justify-content: center;

            /* 核心1：强力毛玻璃 */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);

            /* 核心2：玻璃质感的边框 (上亮下暗) */
            border-top: 1.5px solid rgba(255, 255, 255, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);

            /* 核心3：内发光 + 外部投影 (制造液态厚度感) */
            box-shadow:
                inset 0 0 15px rgba(255, 255, 255, 0.2), /* 内部通透光 */
                0 8px 20px rgba(0, 0, 0, 0.15); /* 底部柔和投影 */

            margin-bottom: 6px;
            transition: transform 0.1s; cursor: pointer;
            position: relative; overflow: hidden;
        }

        /* 增加一个流光高光层，让它看起来更润 */
        .app-icon-shape::before {
            content: ''; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 40%);
            pointer-events: none;
        }

        .app-icon-shape:active { transform: scale(0.92); filter: brightness(1.1); }

        /* 图标里的 SVG */
        .app-svg {
            width: 30px; height: 30px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); /* 图标悬浮感 */
            z-index: 2; /* 浮在流光上面 */
        }

        .app-label {
            font-size: 12px; font-weight: 500; color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            letter-spacing: 0.3px;
        }

        /* --- 液态特调色 (半透明渐变，透出背景) --- */

        /* 壁纸：液态紫粉 */
        .bg-wallpaper {
            background: linear-gradient(135deg, rgba(199, 158, 253, 0.5) 0%, rgba(246, 128, 132, 0.5) 100%);
        }

        /* 设置：液态银灰 (带一点冷蓝) */
        .bg-settings {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(155, 197, 195, 0.4) 100%);
        }

        /* 聊天：液态薄荷绿 */
        .bg-chat {
            background: linear-gradient(135deg, rgba(66, 230, 149, 0.5) 0%, rgba(59, 178, 184, 0.5) 100%);
        }

        /* 音乐：液态果冻橙 */
        .bg-music {
            background: linear-gradient(135deg, rgba(255, 154, 158, 0.5) 0%, rgba(254, 207, 239, 0.5) 100%);
        }

        /* --- 8. Dock 栏图标 (液态玻璃版) --- */
        .dock-icon {
            width: 55px; height: 55px;
            border-radius: 16px; /* 稍微圆润一点 */
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;

            /* 核心：液态玻璃质感 (和上面保持一致) */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1.5px solid rgba(255, 255, 255, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.25), 0 5px 15px rgba(0, 0, 0, 0.2);

            position: relative; overflow: hidden; transition: transform 0.1s;
        }

        /* 流光效果 */
        .dock-icon::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 50%);
            pointer-events: none;
        }

        .dock-icon:active { transform: scale(0.9); filter: brightness(1.1); }

        /* --- 专属颜色 (半透明液态) --- */

        /* 1. 角色书 (Role Book): 梦幻蓝紫 -> 代表人物灵魂 */
        .bg-role { background: linear-gradient(135deg, rgba(64, 196, 255, 0.6) 0%, rgba(101, 31, 255, 0.6) 100%); }

        /* 2. 世界书 (World Book): 深邃青绿 -> 代表宏大世界 */
        .bg-world { background: linear-gradient(135deg, rgba(29, 233, 182, 0.6) 0%, rgba(0, 105, 92, 0.6) 100%); }

        /* 3. 说明书 (Manual): 温暖琥珀 -> 代表指引 */
        .bg-manual { background: linear-gradient(135deg, rgba(255, 215, 64, 0.6) 0%, rgba(255, 111, 0, 0.6) 100%); }

        /* 4. 图标App (Icons): 炫彩粉红 -> 代表设计与美 */
        .bg-gallery { background: linear-gradient(135deg, rgba(255, 64, 129, 0.6) 0%, rgba(197, 17, 98, 0.6) 100%); }

        /* --- 9. 壁纸 App (全屏覆盖) --- */
        .app-window {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(20, 20, 25, 0.95); /* 深色背景，突出内容 */
            backdrop-filter: blur(20px);
            z-index: 400; /* 盖住主屏幕 */
            display: none; flex-direction: column;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .app-window.active { opacity: 1; }

        /* --- 修改后的头部样式 (适配状态栏) --- */
        .app-header {
            /* 高度加高：44px(状态栏) + 46px(实际标题栏) = 90px */
            height: 90px;
            /* 顶部留白：把内容往下顶，避开状态栏 */
            padding-top: 44px;

            display: flex; align-items: center; justify-content: center;
            position: relative;
            border-bottom: 1px solid rgba(255,255,255,0.1);

            /* 加深一点背景，防止壁纸太花导致看不清状态栏 */
            background: rgba(20, 20, 25, 0.8);
            backdrop-filter: blur(20px);
        }

        .app-back-btn {
            position: absolute;
            left: 15px;
            /* 关键修改：按钮往下移，不再和时间重叠 */
            top: 58px;

            font-size: 16px; color: #2196F3; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
            z-index: 10;
        }

        /* 内容区域 */
        .wallpaper-content {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* 分类标题 */
        .section-title { font-size: 20px; font-weight: 700; margin-bottom: 10px; color: white; }

        /* 预览卡片 */
        .preview-card {
            background: rgba(255,255,255,0.1);
            border-radius: 18px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* 预览视窗 (模拟手机屏幕比例) */
        .preview-viewport {
            width: 160px; height: 284px; /* 约 9:16 比例 */
            background: #333; border-radius: 12px; margin-bottom: 15px;
            overflow: hidden; position: relative;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* 预览图/视频 */
        .preview-img, .preview-video { width: 100%; height: 100%; object-fit: cover; }

        /* 按钮组 */
        .btn-group { display: flex; gap: 10px; width: 100%; }
        .action-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-upload { background: rgba(255,255,255,0.15); color: white; }
        .btn-apply { background: #2196F3; color: white; opacity: 0.5; pointer-events: none; } /* 默认禁用 */
        .btn-apply.ready { opacity: 1; pointer-events: all; }

        /* --- 12. 设置页高级 UI (iOS 分组风格) --- */

        /* 搜索栏容器 */
        .search-container {
            padding: 10px 16px;
            background: #1c1c1e; /* 与页面背景一致 */
            position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.05); /* 极细分割线 */
        }
        /* 搜索输入框 */
        .settings-search {
            width: 100%; height: 38px;
            background: #2c2c2e; /* 稍微亮一点的灰 */
            border-radius: 10px; border: none; outline: none;
            color: white; font-size: 16px; text-align: center;
            transition: all 0.2s;
        }
        .settings-search:focus { text-align: left; padding-left: 36px; background: #3a3a3c; }

        /* 列表容器 */
        #timezone-list-container {
            padding: 0 16px 40px 16px; /* 给底部留点空 */
            background: #000000; /* 纯黑背景，对比卡片 */
        }

        /* 分类标题 (如：亚洲) */
        .group-header {
            font-size: 13px; color: #8e8e93; font-weight: 500;
            margin: 20px 0 8px 12px; /* 留出一点缩进 */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 卡片分组容器 */
        .settings-group {
            background: #1c1c1e; /* 卡片颜色 */
            border-radius: 12px;
            overflow: hidden;
        }

        /* 单个列表项 */
        .settings-item {
            background: transparent;
            padding: 14px 16px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; position: relative;
            transition: background 0.2s;
        }
        .settings-item:active { background: #3a3a3c; }

        /* 分割线 (核心高级感来源：左侧缩进) */
        .settings-item:not(:last-child)::after {
            content: ''; position: absolute;
            bottom: 0; right: 0; height: 0.5px; /* 极细 */
            width: calc(100% - 16px); /* 左侧留出间距 */
            background: #38383a;
        }

        /* 城市文字 */
        .city-name { font-size: 17px; color: white; font-weight: 400; }
        .city-detail { font-size: 12px; color: #8e8e93; margin-top: 2px; }

        /* 选中状态 */
        .check-icon { color: #0a84ff; font-weight: 600; font-size: 16px; display: none; }
        .settings-item.selected .check-icon { display: block; }
        .settings-item.selected .city-name { color: #0a84ff; font-weight: 500; }

        /* --- 关键修复：子页面样式 (没这个点击就没反应) --- */
        .sub-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #1c1c1e; /* 纯黑背景 */
            z-index: 500; /* 层级要高 */
            display: flex; flex-direction: column;
            transform: translateX(100%); /* 默认藏在右边 */
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); /* 滑动动画 */
        }
        .sub-page.active { transform: translateX(0); /* 激活时滑出来 */ }

        /* --- 关键修复：胶囊通知样式 (没这个保存会报错) --- */
        .toast-capsule {
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(255, 255, 255, 0.95); color: #333;
            padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: all 0.4s;
        }
        .toast-capsule.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-icon {
            width: 18px; height: 18px; background: #4CAF50; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;
        }

        /* --- 14. 主题系统 & 代码编辑器 --- */

        /* 浅色模式 (Light Mode) 的覆盖样式 */
        /* 当 body 带有 .light-theme 类名时生效 */
        body.light-theme {
            color: #000000; /* 全局文字变黑 */
        }
        body.light-theme .app-window,
        body.light-theme .sub-page,
        body.light-theme .app-header,
        body.light-theme .search-container,
        body.light-theme .settings-group,
        body.light-theme .preview-card,
        body.light-theme .chat-input-area {
            background: rgba(242, 242, 247, 0.95) !important; /* 变成亮灰白 */
            color: #000;
        }
        body.light-theme .settings-item {
            background: white !important; /* 列表项变纯白 */
            color: #000;
        }
        body.light-theme .app-title,
        body.light-theme .city-name,
        body.light-theme .settings-search {
            color: #000 !important;
        }
        body.light-theme .settings-search {
            background: rgba(118, 118, 128, 0.12); /* 搜索框变浅 */
        }
        body.light-theme .item-value,
        body.light-theme .city-detail,
        body.light-theme .item-arrow {
            color: rgba(60, 60, 67, 0.6) !important;
        }
        body.light-theme .chat-input {
            background: rgba(0,0,0,0.05); color: black;
        }
        body.light-theme .chat-input::placeholder { color: rgba(0,0,0,0.3); }

        /* 代码编辑器样式 */
        .code-editor-container {
            width: 100%; height: 300px;
            background: #1e1e1e; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px; margin-top: 15px;
            font-family: 'Courier New', monospace;
            display: none; /* 默认隐藏，选自定义时显示 */
        }
        .code-textarea {
            width: 100%; height: 100%;
            background: transparent; border: none; outline: none;
            color: #d4d4d4; font-size: 13px; line-height: 1.5;
            resize: none;
        }
        .theme-options { display: flex; gap: 10px; margin-bottom: 15px; }
        .theme-btn {
            flex: 1; padding: 15px; border-radius: 12px;
            background: rgba(255,255,255,0.1); border: 2px solid transparent;
            color: white; font-size: 14px; cursor: pointer; text-align: center;
        }
        .theme-btn.active { border-color: #0a84ff; background: rgba(10, 132, 255, 0.1); }

        /* --- 修复浅色模式下的时区列表背景 --- */
        body.light-theme #timezone-list-container,
        body.light-theme #lang-list-container {
            background: #f2f2f7 !important; /* 变成浅灰色背景 */
        }

        /* 修复浅色模式下的分组标题颜色 */
        body.light-theme .group-header {
            color: #6d6d72 !important; /* 深灰色文字 */
        }

        /* 修复浅色模式下的分割线 */
        body.light-theme .settings-item:not(:last-child)::after {
            background: #c6c6c8 !important;
        }

       /* ================== AI 设置页 (防弹修复版) ================== */

        /* 1. 页面容器：强制允许滚动 */
        #sub-ai-model .wallpaper-content {
            padding: 20px 16px 150px 16px !important; /* 底部留足空间 */
            overflow-y: auto !important;
            height: 100% !important;
            display: block !important; /* 防止 flex 布局导致被挤压 */
        }

        /* 2. 分组卡片：深色背景 */
        .ai-group-card {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            margin-bottom: 24px !important;
            overflow: hidden !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
        }

        /* 3. 单行列表：标准高度，白色文字 */
        .ai-list-item {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 16px !important;
            min-height: 54px !important; /* 保证高度 */
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1) !important;
            background: transparent !important;
        }
        .ai-list-item:last-child { border-bottom: none !important; }
        .ai-list-item:active { background: rgba(255,255,255,0.1) !important; }

        /* 4. 左侧标签 */
        .ai-item-label {
            font-size: 16px !important;
            color: white !important;
            white-space: nowrap !important;
            width: 80px !important; /* 固定宽度 */
            flex-shrink: 0 !important;
        }
        .ai-item-label.blue { color: #0a84ff !important; width: auto !important; flex: 1 !important; }

        /* 5. 右侧输入框/文字：强制白色，无背景 */
        .ai-item-input {
            flex: 1 !important;
            width: 100% !important;
            background: transparent !important;
            border: none !important;
            outline: none !important;
            text-align: right !important;
            font-size: 16px !important;
            color: rgba(255,255,255,0.8) !important; /* 亮灰色 */
            padding: 0 !important;
            height: auto !important;
        }
        .ai-item-input:focus { color: white !important; }
        /* 占位符颜色 */
        .ai-item-input::placeholder { color: rgba(255,255,255,0.3) !important; }

        /* 6. 测试面板：黑底绿字 */
        .ai-test-box {
            background: #1c1c1e !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }
        .ai-test-log {
            background: #000 !important;
            color: #00ff00 !important;
            font-family: monospace !important;
            padding: 15px !important;
            height: 150px !important; /* 固定高度 */
            overflow-y: auto !important;
            font-size: 12px !important;
        }
        .ai-test-input-bar {
            padding: 10px !important;
            background: #2c2c2e !important;
            display: flex !important;
            gap: 10px !important;
        }
        .ai-test-input {
            flex: 1 !important;
            height: 36px !important;
            background: rgba(118, 118, 128, 0.5) !important; /* 灰色背景 */
            border-radius: 18px !important;
            border: none !important;
            padding: 0 15px !important;
            color: white !important;
        }

        /* 标题 */
        .ai-header-text {
            font-size: 13px !important; color: #8e8e93 !important;
            margin: 0 0 8px 12px !important; text-transform: uppercase !important;
        }

        /* ================== 21. AI 设置页浅色模式适配 (Light Mode Patch) ================== */

        /* 1. 页面背景变亮灰 */
        body.light-theme #sub-ai-model,
        body.light-theme #sub-model-select,
        body.light-theme #sub-config-list {
            background: #f2f2f7 !important; /* iOS 浅色背景 */
        }

        /* 2. 卡片变纯白 */
        body.light-theme .ai-group-card {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important; /* 极淡的边框 */
        }

        /* 3. 分割线变浅 */
        body.light-theme .ai-list-item {
            border-bottom: 0.5px solid rgba(60, 60, 67, 0.18) !important; /* 浅灰分割线 */
        }

        /* 4. 左侧文字变黑 */
        body.light-theme .ai-item-label {
            color: #000000 !important;
        }
        /* 蓝色文字保持蓝色，不用改 */

        /* 5. 右侧输入框/文字变深灰 */
        body.light-theme .ai-item-input {
            color: rgba(60, 60, 67, 0.6) !important; /* 次级文字深灰 */
        }
        /* 输入时全黑 */
        body.light-theme .ai-item-input:focus {
            color: #000000 !important;
        }
        /* 占位符浅灰 */
        body.light-theme .ai-item-input::placeholder {
            color: rgba(60, 60, 67, 0.3) !important;
        }

        /* 6. 分组标题变深灰 */
        body.light-theme .ai-header-text {
            color: #6d6d72 !important;
        }

        /* 7. 测试面板适配 */
        body.light-theme .ai-test-box {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
        }
        /* 底部输入栏变浅灰 */
        body.light-theme .ai-test-input-bar {
            background: #f2f2f7 !important;
        }
        /* 输入框变白 */
        body.light-theme .ai-test-input {
            background: #ffffff !important;
            color: #000000 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* 加一点小投影 */
        }

        /* 8. 顶部导航栏适配 */
        body.light-theme .app-header {
            background: rgba(249, 249, 249, 0.9) !important;
            border-bottom: 1px solid rgba(0,0,0,0.1) !important;
        }
        body.light-theme .app-title {
            color: #000000 !important;
        }

        /* ================== 22. 字体设置页 (Font Settings) ================== */

        /* 1. 定义全局变量 (默认值) */
        :root {
            --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --ui-weight: 400;
            --ui-size-adjust: 0px; /* 字体大小微调值 */
        }

        /* 2. 强制应用到全局 */
        body, button, input, select, textarea {
            font-family: var(--ui-font) !important;
            font-weight: var(--ui-weight) !important;
            /* 这里我们用 transform 或者 calc 来微调大小，防止布局炸裂 */
            /* 但为了简单有效，我们在 body 上微调 fontSize */
        }

        /* 3. 字体预览卡片 */
        .font-preview-card {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            padding: 30px 20px !important;
            margin: 0 16px 24px 16px !important;
            text-align: center !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
            transition: all 0.2s;
        }
        .preview-text-en { font-size: 24px; margin-bottom: 10px; display: block; }
        .preview-text-cn { font-size: 20px; opacity: 0.8; display: block; }

        /* 4. 滑块容器 */
        .slider-container {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            padding: 16px !important;
            margin: 0 16px 24px 16px !important;
        }
        .slider-header {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-size: 14px; color: white;
        }

        /* 5. 美化滑块 (Range Input) */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]:focus { outline: none; }
        /* 轨道 */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: rgba(118, 118, 128, 0.24); border-radius: 3px;
        }
        /* 滑块头 */
        input[type=range]::-webkit-slider-thumb {
            height: 24px; width: 24px; border-radius: 50%;
            background: #ffffff; cursor: pointer;
            -webkit-appearance: none; margin-top: -9px; /* 居中 */
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* 浅色模式适配 */
        body.light-theme .font-preview-card,
        body.light-theme .slider-container {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important;
        }
        body.light-theme .slider-header { color: black !important; }

        /* --- 23. 字体页滑动修复补丁 --- */

        /* 强制给字体页内容区加超大底部留白，保证按钮能滑上来 */
        #sub-font .wallpaper-content {
            padding-bottom: 180px !important;
            overflow-y: auto !important;
            height: 100% !important;
            display: block !important; /* 防止 Flex 布局导致无法滚动 */
        }

        /* 修复预览卡片在小屏幕可能太高的问题 */
        .font-preview-card {
            padding: 20px !important;
            margin-bottom: 20px !important;
        }

        /* ================== 24. 字体大小全局联动补丁 ================== */

        :root {
            /* 定义一个默认值，防止JS未加载时变乱 */
            --app-font-size: 16px;
        }

        /* 1. 强制所有主要文字跟随变量 */
        body,
        .settings-item,
        .ai-label,
        .ai-input,
        .form-label,
        .form-input,
        .city-name,
        .chat-input,
        .msg-bubble,
        .song-title,
        .profile-nickname {
            /* 使用 calc 计算，确保优先级最高 */
            font-size: var(--app-font-size) !important;
        }

        /* 2. 标题类 (比正文大 2px) */
        .app-title,
        .preview-text-en,
        .preview-text-cn {
            font-size: calc(var(--app-font-size) + 4px) !important;
        }

        /* 3. 辅助文字类 (比正文小 3px) */
        .city-detail,
        .item-value,
        .ios-header,
        .group-header,
        .ai-section-header,
        .app-label,
        .profile-signature,
        .artist-name {
            font-size: calc(var(--app-font-size) - 3px) !important;
        }

        /* 4. 预览卡片文字跟随 */
        #font-preview-box span {
            font-family: var(--ui-font) !important;
            font-weight: var(--ui-weight) !important;
        }
                /* --- 25. 按钮样式强制补丁 --- */

        /* 按钮容器 */
        .ai-btn-group {
            display: flex !important;
            gap: 15px !important;
            margin: 20px 16px 40px 16px !important;
        }

        /* 按钮通用样式 */
        .ai-btn {
            flex: 1 !important;
            height: 48px !important;
            border-radius: 12px !important;
            border: none !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: opacity 0.2s !important;
        }
        .ai-btn:active { opacity: 0.7 !important; transform: scale(0.98) !important; }

        /* 主按钮 (深蓝) */
        .ai-btn-primary {
            background: #0a84ff !important;
            color: white !important;
        }

        /* 次按钮 (浅蓝透明) */
        .ai-btn-secondary {
            background: rgba(10, 132, 255, 0.15) !important;
            color: #0a84ff !important;
        }

        /* 浅色模式适配 */
        body.light-theme .ai-btn-secondary {
            background: rgba(0, 122, 255, 0.1) !important;
        }

        /* ================== 26. 图标设置 App 样式 ================== */

        /* 图标预览容器 (复用 preview-card，但更紧凑) */
        .icon-preview-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 16px !important;
            padding: 15px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            margin-bottom: 15px !important;
        }

        /* 左侧：图标名称和预览 */
        .icon-info-group {
            display: flex; align-items: center; gap: 15px;
        }

        /* 预览图标本身的形状 (复用主屏幕图标样式) */
        .preview-icon-shape {
            width: 54px; height: 54px;
            border-radius: 14px;
            /* 默认样式，会被 JS 覆盖 */
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
            position: relative; overflow: hidden;
        }

        /* 预览图标里的默认SVG */
        .preview-icon-svg {
            width: 24px; height: 24px; fill: white; opacity: 0.8;
            z-index: 2;
        }

        /* 右侧：按钮组 */
        .icon-btn-group {
            display: flex; gap: 10px;
        }
        /* 小按钮样式 */
        .icon-btn {
            padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none;
        }
        .btn-change { background: rgba(10, 132, 255, 0.15); color: #0a84ff; }
        .btn-reset { background: rgba(255, 59, 48, 0.15); color: #FF3B30; }

        /* 浅色模式适配 */
        body.light-theme .icon-preview-card {
            background: #ffffff !important; border-color: rgba(0,0,0,0.05) !important;
        }
        body.light-theme .preview-icon-shape {
            border-top-color: rgba(255,255,255,0.8);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* ================== 28. 图标显示强制修复补丁 (Final Fix) ================== */

        /* 1. 强制设置背景图大小和位置 (没了这句，图片会放大几十倍导致看不见) */
        #icon-home-wallpaper, #icon-home-settings, #icon-home-chat, #icon-home-music,
        #icon-dock-role, #icon-dock-world, #icon-dock-manual, #icon-dock-gallery,
        .preview-icon-shape {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        /* 2. 当有背景图时，移除默认背景色和模糊 (避免透底) */
        /* 注意：这里使用属性选择器来检测行内样式 */
        .app-icon-shape[style*="background-image"],
        .dock-icon[style*="background-image"],
        .preview-icon-shape[style*="background-image"] {
            background-color: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important; /* 可选：去掉阴影让图片更纯粹 */
            border: none !important;     /* 可选：去掉边框 */
        }

        /* ================== 29. 角色书 App 样式 (列表版) ================== */

        /* 1. 列表容器：改为垂直排列 */
        .role-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
            padding: 10px 0 80px 0 !important; /* 底部留白 */
        }

        /* 2. 角色卡片：横向布局 (左图右文) */
        .role-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 16px !important;
            padding: 15px !important;
            display: flex !important;
            flex-direction: row !important; /* 横向排列 */
            align-items: center !important; /* 垂直居中 */
            border: 1px solid rgba(255,255,255,0.1) !important;
            cursor: pointer !important;
            transition: background 0.2s !important;
        }
        .role-card:active { background: rgba(255,255,255,0.15) !important; }

        /* 3. 头像：变成圆形，固定大小 */
        .role-card-img {
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important; /* 圆形 */
            object-fit: cover !important;
            background-color: #333 !important;
            background-size: cover !important;
            background-position: center !important;
            flex-shrink: 0 !important; /* 禁止压缩 */
            margin-right: 15px !important; /* 和文字的间距 */
            border: 1px solid rgba(255,255,255,0.2) !important;
        }

        /* 4. 文字信息区 */
        .role-card-info {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            overflow: hidden !important; /* 防止文字溢出 */
            padding: 0 !important; /* 去掉之前的内边距 */
        }

        /* 名字 */
        .role-card-name {
            font-size: 17px !important;
            font-weight: 600 !important;
            color: white !important;
            margin-bottom: 4px !important;
        }

        /* 描述 (单行省略) */
        .role-card-desc {
            font-size: 13px !important;
            color: rgba(255,255,255,0.6) !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* --- 角色详情页样式 (保持不变，但确保适配) --- */
        .role-header-bg {
            width: 100%; height: 240px;
            background-color: #333;
            background-size: cover; background-position: center;
            position: relative;
        }
        .role-header-bg::after {
            content: '点击更换背景'; position: absolute; bottom: 10px; right: 10px;
            font-size: 10px; color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.4); padding: 4px 8px; border-radius: 4px;
            backdrop-filter: blur(4px);
        }
        .role-avatar-container {
            margin-top: -60px; display: flex; justify-content: center; position: relative; z-index: 10;
        }
        .role-big-avatar {
            width: 110px; height: 110px; border-radius: 50%;
            border: 4px solid #1c1c1e; /* 深色模式下的描边 */
            background-size: cover; background-position: center; background-color: #444;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .role-detail-content { padding: 15px 20px 100px 20px; text-align: center; }
        .role-detail-name { font-size: 24px; font-weight: 700; color: white; margin-bottom: 10px; }
        .role-detail-desc {
            font-size: 15px; color: rgba(255,255,255,0.85); line-height: 1.6; text-align: left;
            white-space: pre-wrap; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px;
        }

        /* --- 浅色模式适配 (关键要求) --- */
        body.light-theme .role-card {
            background: #ffffff !important; /* 白底 */
            border: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important;
        }
        body.light-theme .role-card-name { color: #000000 !important; }
        body.light-theme .role-card-desc { color: rgba(60,60,67,0.6) !important; }

        /* 详情页浅色适配 */
        body.light-theme .role-big-avatar { border-color: #f2f2f7 !important; } /* 头像描边变白 */
        body.light-theme .role-detail-name { color: #000000 !important; }
        body.light-theme .role-detail-desc { background: #ffffff !important; color: #333 !important; }

        /* ================== 30. 世界书 App 样式 ================== */

        /* 1. 世界书列表项 */
        .world-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 12px !important;
            padding: 16px !important;
            margin-bottom: 12px !important;
            display: flex !important;
            align-items: flex-start !important;
            cursor: pointer !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            transition: background 0.2s !important;
        }
        .world-card:active { background: rgba(255,255,255,0.15) !important; }

        /* 左侧固定图标 */
        .world-icon-box {
            width: 40px; height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #11998e, #38ef7d); /* 青绿色渐变 */
            display: flex; justify-content: center; align-items: center;
            margin-right: 15px; flex-shrink: 0;
        }

        /* 右侧文字 */
        .world-info { flex: 1; overflow: hidden; }
        .world-title { font-size: 17px; font-weight: 600; color: white; margin-bottom: 6px; }
        .world-preview {
            font-size: 13px; color: rgba(255,255,255,0.5);
            display: -webkit-box; -webkit-line-clamp: 2; /* 最多显示2行 */
            -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.5;
        }

        /* 2. 世界书详情页 */
        .world-detail-container {
            padding: 20px;
            height: 100%;
            display: flex; flex-direction: column;
        }
        .world-detail-header {
            font-size: 28px; font-weight: 800; color: white;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .world-detail-body {
            font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.9);
            white-space: pre-wrap; /* 保留换行符 */
            flex: 1; overflow-y: auto;
        }

        /* 浅色模式适配 */
        body.light-theme .world-card { background: white !important; border-color: rgba(0,0,0,0.05) !important; }
        body.light-theme .world-title, body.light-theme .world-detail-header { color: black !important; }
        body.light-theme .world-preview, body.light-theme .world-detail-body { color: #333 !important; }

        /* ================== 音乐 App 终极修复 CSS ================== */

/* 1. 弹窗层级修复 (强制置顶) */
.modal-overlay {
    z-index: 2000 !important; /* 必须最高，防止点不动 */
}

/* 2. 音乐 App 主窗口容器 */
#app-music {
    background: #121212; /* 默认黑底 */
    overflow: hidden;
}

/* 3. 列表视图 (层级 10) */
#music-view-list {
    position: relative;
    z-index: 10;
    height: 100%;
    display: flex; flex-direction: column;
    background: linear-gradient(180deg, rgba(30,30,30,0.8) 0%, #000 100%); /* 列表自带渐变底 */
}

/* 列表头部按钮 (修复重叠元凶) */
.header-add-btn {
    position: absolute; right: 15px; top: 58px;
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.1); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 20; /* 只要比列表背景高就行 */
}

/* 4. 全屏播放器 (层级 100 - 彻底盖住列表) */
#music-view-full {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100; /* 比列表高 */
    display: flex; flex-direction: column;

    /* 关键修复：给一个实心背景，不再依赖透明遮罩 */
    background-color: #1c1c1e;
    /* 动态背景图会覆盖在上面，这里是保底色 */

    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    background: transparent; /* 关键：变成透明，让下面的图片透出来 */
}

#music-view-full.active {
    transform: translateY(0);
}

/* 全屏动态背景层 */
/* 修改后：*/
#full-player-bg {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #1c1c1e; /* 关键：默认底色移到这里 */
    background-size: cover; background-position: center;
    z-index: -1;
    /* 如果不想让背景太模糊，可以把 blur(30px) 改小或者去掉 */
    filter: blur(30px);
    transition: background-image 0.5s;
}

/* 5. 布局优化 (解决下方空隙) */
.full-player-content {
    flex: 1;
    display: flex; flex-direction: column;
    justify-content: space-evenly; /* 均匀分布 */
    align-items: center;
    padding: 0 30px 40px 30px;
}

/* 唱片 (加大尺寸) */
.disk-wrapper {
    flex: 2; display: flex; align-items: center; justify-content: center;
    width: 100%;
}
.disk-cover {
    width: 280px; height: 280px; border-radius: 50%;
    background-color: #333; background-size: cover; background-position: center;
    border: 4px solid rgba(255,255,255,0.1);
    box-shadow: 0 30px 60px rgba(0,0,0,0.6);
    animation: rotate 24s linear infinite; animation-play-state: paused;
}
.disk-cover.playing { animation-play-state: running; }

/* 进度条 */
.fp-progress-container { width: 100%; margin: 20px 0; }
.fp-slider {
    width: 100%; height: 4px; background: rgba(255,255,255,0.2);
    border-radius: 2px; -webkit-appearance: none;
}
.fp-slider::-webkit-slider-thumb {
    -webkit-appearance: none; width: 12px; height: 12px;
    background: white; border-radius: 50%;
}
.time-row {
    display: flex; justify-content: space-between;
    font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;
}

/* 6. 图标按钮美化 */
.fp-controls {
    width: 100%; display: flex; justify-content: space-between; align-items: center;
}
.fp-ctrl-btn {
    background: none; border: none; padding: 0; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: white; /* 确保 SVG 继承颜色 */
}
.fp-ctrl-btn svg { fill: white; width: 26px; height: 26px; }
.fp-ctrl-btn.small svg { width: 22px; height: 22px; opacity: 0.5; }
.fp-ctrl-btn.big svg { width: 60px; height: 60px; } /* 播放键加大 */
.fp-ctrl-btn:active { opacity: 0.7; transform: scale(0.95); }

/* 头部功能按钮 */
.fp-icon-btn {
    width: 40px; height: 40px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: none;
    display: flex; align-items: center; justify-content: center;
    margin-left: 10px; cursor: pointer;
}
.fp-icon-btn svg { width: 20px; height: 20px; fill: white; }
        /* --- 1. 修复音乐列表样式 --- */
.music-list-item {
    display: flex;             /* 让图片和文字横排 */
    align-items: center;       /* 垂直居中 */
    padding: 12px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.08); /* 玻璃半透明背景 */
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: background 0.2s;
}
.music-list-item:active { background: rgba(255,255,255,0.15); }
.music-list-item.active-playing { border-color: #0a84ff; background: rgba(10,132,255,0.1); }

/* 列表里的封面小图 */
.song-img-box {
    width: 50px; height: 50px;
    border-radius: 8px;
    background-size: cover; background-position: center;
    background-color: #333;
    margin-right: 15px; flex-shrink: 0;
}

/* 列表里的文字区 */
.song-info-box {
    flex: 1;
    display: flex; flex-direction: column; justify-content: center;
    overflow: hidden;
}
.song-list-title { font-size: 16px; font-weight: 600; color: white; margin-bottom: 4px; }
.song-list-artist { font-size: 13px; color: rgba(255,255,255,0.6); }

/* 列表里的按钮 */
.song-action-btn {
    width: 36px; height: 36px;
    border-radius: 50%; border: none; background: transparent;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; cursor: pointer;
}

/* --- 2. 修复迷你播放器样式 --- */
.mini-player {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    width: 90%; height: 64px;
    background: rgba(40,40,45,0.95); /* 深色背景 */
    border-radius: 32px;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; padding: 0 8px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    z-index: 50; /* 保证浮在列表上面 */
}
.mini-cover {
    width: 48px; height: 48px; border-radius: 50%;
    background-color: #333; background-size: cover; background-position: center;
    margin-right: 12px; margin-left: 2px;
}
.mini-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
.mini-title { font-size: 14px; font-weight: 600; color: white; }
.mini-artist { font-size: 12px; color: #888; }
.mini-controls { display: flex; gap: 5px; margin-right: 5px; }
.mini-btn { background: none; border: none; font-size: 20px; color: white; padding: 5px; cursor: pointer; }

/* --- 3. 修复旋转动画 (如果没转就是少了这段) --- */
@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
        /* --- 底部动作菜单样式 (Action Sheet) --- */
.action-sheet-content {
    width: 95%; max-width: 400px;
    z-index: 2100; /* 比遮罩层高 */
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 激活时滑上来 */
#modal-song-menu.active .action-sheet-content {
    transform: translateY(0);
}

.sheet-group {
    background: rgba(30, 30, 35, 0.9);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 14px;
    overflow: hidden;
}

.sheet-item {
    height: 56px;
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; color: white;
    cursor: pointer;
    background: transparent;
}
.sheet-item:active { background: rgba(255,255,255,0.1); }
        /* ================== 修复补丁：去模糊 & 浅色模式适配 ================== */

/* 1. 【核心修复】去背景虚化 */
#full-player-bg {
    filter: none !important; /* 强制去掉模糊 */
    opacity: 1 !important;   /* 强制不透明，显示原图色彩 */
    background-color: #222;  /* 如果没图时的保底色 */
}

/* 2. 【核心修复】浅色模式适配 (Light Mode) */

/* 列表页背景变白 */
body.light-theme #app-music {
    background: #f2f2f7 !important; /* 浅灰底 */
}
body.light-theme #music-view-list {
    background: transparent !important; /* 去掉之前的深色渐变 */
}

/* 列表头部文字和按钮变黑 */
body.light-theme .app-title,
body.light-theme .app-back-btn {
    color: #000000 !important;
}
body.light-theme .app-back-btn svg,
body.light-theme .header-add-btn svg {
    fill: #000000 !important;
}
body.light-theme .header-add-btn {
    background: rgba(0,0,0,0.05) !important;
}

/* 列表项变白底黑字 */
body.light-theme .music-list-item {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.05) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}
body.light-theme .song-list-title {
    color: #000000 !important;
}
body.light-theme .song-list-artist {
    color: rgba(60,60,67,0.6) !important;
}

/* 列表右侧的三个点和插队图标 -> 变成黑色 */
/* 这里使用滤镜直接反转白色图标，省去改 JS 的麻烦 */
body.light-theme .song-action-btn svg {
    filter: invert(1) !important; /* 白色变黑色 */
    opacity: 0.6;
}

/* 迷你播放器适配 */
body.light-theme .mini-player {
    background: rgba(255,255,255,0.95) !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1) !important;
}
body.light-theme .mini-title { color: #000 !important; }
body.light-theme .mini-controls svg {
    fill: #000 !important; /* 按钮变黑 */
}

/* --- 全屏播放器浅色适配 (仅在没有自定义背景图时生效) --- */
/* 如果用户没传背景图，背景也是浅色的 */
body.light-theme #full-player-bg {
    background-color: #f2f2f7 !important;
}

/* 全屏播放器文字变黑 (为了防止自定义背景图也是浅色看不清，加一点文字阴影) */
body.light-theme .fp-title {
    color: #000 !important;
    text-shadow: 0 0 10px rgba(255,255,255,0.8);
}
body.light-theme .fp-artist {
    color: rgba(0,0,0,0.6) !important;
    text-shadow: 0 0 10px rgba(255,255,255,0.8);
}
body.light-theme #current-lyric-line {
    color: rgba(0,0,0,0.8) !important;
}
body.light-theme .time-text,
body.light-theme #time-current,
body.light-theme #time-total {
    color: rgba(0,0,0,0.5) !important;
}

/* 全屏控制按钮变黑 */
body.light-theme .fp-ctrl-btn svg,
body.light-theme .fp-btn svg,
body.light-theme .fp-icon-btn svg {
    fill: #000000 !important;
}
body.light-theme .fp-icon-btn {
    background: rgba(0,0,0,0.05) !important;
}

/* 进度条底色变深一点 */
body.light-theme .fp-slider {
    background: rgba(0,0,0,0.1) !important;
}
body.light-theme .fp-slider::-webkit-slider-thumb {
    background: #000000 !important; /* 滑块变黑 */
}

/* 底部弹窗 (Action Sheet) 浅色适配 */
body.light-theme .sheet-group {
    background: rgba(255,255,255,0.95) !important;
}
body.light-theme .sheet-item {
    color: #000000 !important;
    border-top-color: rgba(0,0,0,0.1) !important;
}
        /* --- 迷你播放器图标修复 --- */

/* 默认样式 (深色模式) */
.mini-btn svg {
    width: 28px; height: 28px;
    fill: white; /* 默认为白 */
    transition: fill 0.2s;
}

/* 浅色模式适配 (核心修复) */
body.light-theme .mini-btn svg {
    fill: #333333 !important; /* 强制变深灰/黑 */
}

/* 按钮点击反馈 */
.mini-btn:active { opacity: 0.6; transform: scale(0.9); }
        /* ================== 灵动岛逻辑修正 CSS ================== */

/* 1. 灵动岛容器基础 */
.island-container {
    position: absolute;
    top: 11px; left: 50%; transform: translateX(-50%);
    background: black;
    border-radius: 20px;
    z-index: 9999;
    /* 关键：默认高度和宽度 */
    width: 0; height: 0; opacity: 0; /* 默认完全隐藏 */

    transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                border-radius 0.4s,
                opacity 0.2s;
    overflow: hidden;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    color: white;
    pointer-events: none; /* 平时能不能点 */
}

/* 状态 A: 待机 (只有开了设置才显示这个小黑条) */
.island-container.idle-show {
    width: 120px; height: 35px; border-radius: 18px; opacity: 1;
}

/* 状态 B: 音乐常驻 (播放音乐时，即使收缩了也要显示波形) */
.island-container.music-active {
    width: 150px; height: 35px; border-radius: 18px; opacity: 1;
    cursor: pointer; pointer-events: auto;
}

/* 状态 C: 展开 (通知弹窗) */
.island-container.active {
    width: 340px; height: 60px; border-radius: 30px; opacity: 1;
    z-index: 10000;
}

/* 内容区域 */
.island-content {
    width: 100%; height: 100%;
    display: flex; justify-content: space-between; align-items: center;
    opacity: 0; transition: opacity 0.2s;
}
/* 展开或音乐常驻时显示内容 */
.island-container.active .island-content,
.island-container.music-active .island-content {
    opacity: 1;
}

/* 只有在音乐常驻模式下，隐藏中间和右边的文字，只留左边波形 */
.island-container.music-active .island-center,
.island-container.music-active .island-right {
    display: none;
}
/* 但如果展开了，就显示 */
.island-container.active .island-center,
.island-container.active .island-right {
    display: block;
}
        /* ================== 灵动岛显示修复补丁 ================== */

/* 1. 音乐常驻状态 (播放中收缩状态) */
.island-container.music-active {
    width: 130px !important; /* 宽度适中 */
    height: 35px !important;
    border-radius: 18px !important;
    opacity: 1 !important;
    cursor: pointer;
    pointer-events: auto;
    background: black; /* 确保背景黑 */
}

/* 2. 核心修复：波形颜色和位置 */
/* 只要是在灵动岛里的波形，全部强制显示颜色 */
.island-sound-wave span {
    background-color: #34C759 !important; /* 亮绿色，黑底上很明显 */
    width: 3px !important;
    border-radius: 2px;
    /* 确保动画运行 */
    animation: wave 1s infinite ease-in-out;
}

/* 3. 布局控制：常驻模式下只显示左边的波形 */
.island-container.music-active .island-content {
    opacity: 1 !important;
    justify-content: center !important; /* 居中显示 */
}

/* 隐藏中间和右边的文字，防止挤压 */
.island-container.music-active #island-text,
.island-container.music-active #island-info {
    display: none !important;
}

/* 确保左侧图标区显示 */
.island-container.music-active #island-icon {
    display: flex !important;
    align-items: center;
    justify-content: center;
    width: 100%; /* 占满整个小岛 */
}

/* 4. 动画定义 (防止动画丢失) */
@keyframes wave {
    0%, 100% { height: 6px; }
    50% { height: 16px; }
}

/* 针对不同柱子的延迟，产生律动感 */
.island-sound-wave span:nth-child(1) { animation-delay: 0.0s; }
.island-sound-wave span:nth-child(2) { animation-delay: 0.2s; }
.island-sound-wave span:nth-child(3) { animation-delay: 0.4s; }
.island-sound-wave span:nth-child(4) { animation-delay: 0.1s; }

        /* ================== 灵动岛显示强制修复 ================== */

/* 1. 确保灵动岛在最顶层，不被遮挡 */
#dynamic-island {
    z-index: 2147483647 !important; /* 浏览器允许的最大 Z-Index */
    background: black !important;
}

/* 2. 强制波形可见 (关键修复) */
.island-sound-wave {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 20px !important;
    gap: 3px !important;
}

.island-sound-wave span {
    display: block !important;
    background-color: #34C759 !important; /* 亮绿色 */
    width: 3px !important;
    height: 10px !important; /* 给一个默认高度，防止动画没加载时看不见 */
    border-radius: 2px !important;
    animation: wave 1s infinite ease-in-out !important;
}

/* 3. 确保常驻模式下的布局正确 */
.island-container.music-active {
    width: 130px !important;
    height: 35px !important;
    opacity: 1 !important;
    display: flex !important;
}

/* 强制显示左侧区域，并居中 */
.island-container.music-active #island-icon {
    display: flex !important;
    width: 100% !important;
    justify-content: center !important;
    align-items: center !important;
}

/* 隐藏不需要的文字 */
.island-container.music-active #island-text,
.island-container.music-active #island-info {
    display: none !important;
}

/* 定义动画 (防止动画丢失) */
@keyframes wave {
    0%, 100% { height: 6px; }
    50% { height: 18px; }
}
        /* ================== 灵动岛动效增强包 (注入灵魂) ================== */

/* 1. 定义更剧烈的跳动动画 (Wave Rhythm) */
@keyframes wave-rhythm {
    0% {
        height: 3px;
        opacity: 0.6;
        transform: scaleY(1);
    }
    50% {
        height: 18px; /* 拉得更高，动感更强 */
        opacity: 1;
        transform: scaleY(1.1);
    }
    100% {
        height: 3px;
        opacity: 0.6;
        transform: scaleY(1);
    }
}

/* 2. 强制应用动画到波形条 */
.island-sound-wave span {
    display: block !important;
    width: 3px !important;
    background-color: #34C759 !important; /* 荧光绿 */
    border-radius: 10px !important;
    margin: 0 2px !important; /* 增加间距，别挤在一起 */

    /* 关键：引用上面的新动画，速度加快到 0.6s */
    animation: wave-rhythm 0.6s infinite ease-in-out !important;

    /* 默认起始高度，防止动画加载前不可见 */
    height: 6px;
}

/* 3. 错开时间差 (制造波浪感，而不是整齐划一的起立蹲下) */
.island-sound-wave span:nth-child(1) { animation-delay: 0.0s !important; animation-duration: 0.6s !important; }
.island-sound-wave span:nth-child(2) { animation-delay: 0.2s !important; animation-duration: 0.8s !important; }
.island-sound-wave span:nth-child(3) { animation-delay: 0.4s !important; animation-duration: 0.7s !important; }
.island-sound-wave span:nth-child(4) { animation-delay: 0.1s !important; animation-duration: 0.9s !important; }

/* 4. 灵动岛容器的“Q弹”变形效果 */
.island-container {
    /* 使用贝塞尔曲线 (Cubic Bezier) 模拟物理弹簧效果 */
    transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                border-radius 0.5s ease !important;
}

/* 5. 确保常驻模式下的容器高度足够容纳跳动 */
.island-container.music-active {
    align-items: center !important; /* 垂直居中 */
    display: flex !important;
    /* 确保背景纯黑，不然看不清绿色 */
    background: #000000 !important;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
}
        /* ================== 灵动岛悬浮播放器 UI (高级深色版) ================== */

/* 1. 悬浮卡片本体 */
.island-popup {
    position: fixed;
    top: 11px; left: 50%; transform: translateX(-50%) scale(0.9);
    width: 350px; height: 190px; /* 高度稍微加一点容纳进度条 */
    border-radius: 32px;
    z-index: 9998;
    opacity: 0; pointer-events: none;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.15);
    transform-origin: top center;
}

.island-popup.active {
    opacity: 1; pointer-events: auto;
    top: 55px;
    transform: translateX(-50%) scale(1);
}

/* 2. 玻璃背景 */
.popup-backdrop {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(30, 30, 35, 0.85); /* 深色半透明 */
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border-radius: 32px;
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    z-index: 0;
}

/* 3. 内容布局 */
.popup-content {
    position: relative; z-index: 1;
    padding: 20px 24px;
    display: flex; flex-direction: column; justify-content: space-between;
    height: 100%;
}

/* 上半部分 */
.popup-top { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }

.popup-cover {
    width: 56px; height: 56px; border-radius: 10px;
    background-color: #333; background-size: cover; background-position: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    flex-shrink: 0;
}

.popup-info { flex: 1; overflow: hidden; }
.popup-title {
    font-size: 17px; font-weight: 600; color: white; margin-bottom: 3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.popup-artist {
    font-size: 13px; color: rgba(255,255,255,0.6);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* 右上角列表按钮 */
.popup-icon-btn {
    width: 32px; height: 32px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: none;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: white;
}
.popup-icon-btn svg { width: 18px; height: 18px; fill: white; opacity: 0.8; }

/* 进度条区域 */
.popup-progress {
    display: flex; align-items: center; gap: 8px;
    margin-top: auto; margin-bottom: 10px;
}
.time-tiny { font-size: 10px; color: rgba(255,255,255,0.4); width: 25px; text-align: center; }
.popup-slider {
    flex: 1; height: 3px; border-radius: 2px;
    background: rgba(255,255,255,0.2);
    -webkit-appearance: none;
}
.popup-slider::-webkit-slider-thumb {
    -webkit-appearance: none; width: 10px; height: 10px;
    background: white; border-radius: 50%;
}

/* 底部按钮组 */
.popup-controls {
    display: flex; justify-content: center; align-items: center; gap: 30px;
}
.popup-btn {
    background: none; border: none; cursor: pointer;
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
}
.popup-btn svg { width: 26px; height: 26px; fill: white; }
.popup-btn.big svg { width: 42px; height: 42px; }
.popup-btn:active { opacity: 0.7; transform: scale(0.9); }

/* 浅色模式适配 (Light Mode) */
body.light-theme .popup-backdrop {
    background: rgba(255, 255, 255, 0.85);
    border-color: rgba(0,0,0,0.1);
}
body.light-theme .popup-title { color: black; }
body.light-theme .popup-artist { color: rgba(0,0,0,0.6); }
body.light-theme .popup-btn svg,
body.light-theme .popup-icon-btn svg { fill: black; }
body.light-theme .popup-icon-btn { background: rgba(0,0,0,0.05); }
body.light-theme .popup-slider { background: rgba(0,0,0,0.1); }
body.light-theme .popup-slider::-webkit-slider-thumb { background: black; }
body.light-theme .time-tiny { color: rgba(0,0,0,0.5); }
    </style>
</head>
<body>
<div id="dynamic-island" class="island-container idle-show">
    <div class="island-content">
        <div class="island-left" id="island-icon"></div>
        <div class="island-center" id="island-text"></div>
        <div class="island-right" id="island-info"></div>
    </div>
</div>
<video id="global-video-bg" autoplay loop muted playsinline style="
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; z-index: -1; display: none; pointer-events: none;
"></video>

<div class="status-bar">
    <div id="clock">15:36</div>
    <div class="status-right">
        <div class="signal-bars">
            <div class="bar active"></div><div class="bar active"></div><div class="bar active"></div><div class="bar active"></div>
        </div>
        <div class="battery-group">
            <span class="charging-icon" id="charging-bolt">⚡</span>
            <span id="battery-text" style="font-size: 12px; margin-right: 2px;">--%</span>
            <div class="battery-shell"><div class="battery-level" id="battery-fill"></div></div>
        </div>
    </div>
</div>

<div class="home-slider">
    <div class="home-page">

        <div class="widget-weather">
            <div class="weather-city" onclick="openCityModal()">
                <span id="current-city">曼谷</span>
            </div>

            <div class="weather-center-content">
                <div id="weather-icon-container">
                    <svg class="weather-svg" viewBox="0 0 64 64" fill="none">
                        <circle cx="32" cy="32" r="14" fill="#FFC107" />
                        <g stroke="#FF9800" stroke-width="4" stroke-linecap="round">
                            <path d="M32 6V10 M32 54V58 M6 32H10 M54 32H58 M13.6 13.6L16.4 16.4 M47.6 47.6L50.4 50.4 M13.6 50.4L16.4 47.6 M47.6 16.4L50.4 13.6" />
                        </g>
                    </svg>
                </div>
                <div class="weather-temp">28°C</div>
                <div class="weather-desc">局部多云</div>
            </div>

            <div class="weather-date-info">
                <span id="weekday-text" class="date-row">星期二</span>
                <span id="date-text" class="date-row">11月25日</span>
            </div>
        </div>

        <div class="widget-photo" onclick="triggerPhotoUpload()">

            <div class="photo-placeholder" id="photo-placeholder">
                <span class="plus-icon">+</span>
                <span class="add-text">添加照片</span>
            </div>

            <div class="photo-display" id="photo-display"></div>

            <input type="file" id="photo-input" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this)">
        </div>

        <div class="widget-music">

            <div class="music-cover" id="music-cover" onclick="triggerCoverUpload()"></div>

            <div class="music-details-container">

                <div class="music-text-group" onclick="openMusicModal()">
                    <div class="song-title">Midnight City</div>
                    <div class="artist-name">M83 · Hurry Up, We're Dreaming</div>
                </div>

                <div class="progress-bar-bg">
                    <div class="progress-bar-fill"></div>
                </div>

                <div class="music-controls">
                    <button class="control-btn">
                        <svg class="ctrl-svg" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>

                    <button class="control-btn play-pause-btn" id="playPauseBtn">
                        <svg class="ctrl-svg" id="play-icon" viewBox="0 0 24 24" style="display: block;">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg class="ctrl-svg" id="pause-icon" viewBox="0 0 24 24" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>

                    <button class="control-btn">
                        <svg class="ctrl-svg" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="widget-profile">

            <div class="profile-avatar" id="profile-avatar" onclick="triggerProfileUpload()"></div>
            <input type="file" id="profile-input" accept="image/*" style="display: none;" onchange="handleProfileUpload(this)">

            <div class="profile-text">
                <div class="profile-nickname" id="profile-nickname" onclick="openProfileEditModal('nickname')">点击设置昵称</div>
                <div class="profile-signature" id="profile-signature" onclick="openProfileEditModal('signature')">点击设置个性签名</div>
            </div>

        </div>

        <div class="grid-app-item" style="grid-row: 5; grid-column: 3; transform: translateY(-35px);">
            <div class="app-icon-shape bg-wallpaper" id="icon-home-wallpaper" onclick="openApp('app-wallpaper')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_wp">壁纸</span>
        </div>

        <div class="grid-app-item" style="grid-row: 5; grid-column: 4; transform: translateY(-35px);">
            <div class="app-icon-shape bg-settings" id="icon-home-settings" onclick="openApp('app-settings')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .36.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.17 0-.36-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_set">设置</span>
        </div>

        <div class="grid-app-item" style="grid-row: 6; grid-column: 3; transform: translateY(-80px);">
            <div class="app-icon-shape bg-chat" id="icon-home-chat" onclick="openApp('app-chat')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_chat">聊天</span>
        </div>

        <div class="grid-app-item" style="grid-row: 6; grid-column: 4; transform: translateY(-80px);">
            <div class="app-icon-shape bg-music" id="icon-home-music" onclick="openApp('app-music')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_music">音乐</span>
        </div>

    </div>
    <div class="home-page"></div>
</div>

<div class="dock-container">

    <div class="dock-icon bg-role" id="icon-dock-role" onclick="openApp('app-rolebook')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
    </div>
    <div class="dock-icon bg-world" id="icon-dock-world" onclick="openApp('app-worldbook')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    </div>
    <div class="dock-icon bg-manual" id="icon-dock-manual">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
    </div>
    <div class="dock-icon bg-gallery" id="icon-dock-gallery" onclick="openApp('app-icons')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
    </div>

</div>

<div class="modal-overlay" id="city-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">选择城市</span>
        </div>

        <input type="text" class="search-box" id="city-search" placeholder="搜索城市 (如: 东京, 纽约)..." oninput="filterCities()">

        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('domestic')">国内</button>
            <button class="tab-btn" onclick="switchTab('international')">国际</button>
        </div>

        <div class="city-list" id="city-list-container">
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeCityModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveCitySelection()">保存</button>
        </div>
    </div>
</div>

<input type="file" id="cover-input" accept="image/*" style="display: none;">
<input type="file" id="mp3-input" accept="audio/mpeg,audio/mp3" style="display: none;">

<div class="modal-overlay" id="music-modal">
    <div class="modal-content" style="width: 90%;">
        <div class="modal-header"><span class="modal-title">编辑歌曲信息</span></div>

        <label class="modal-label">歌曲名称</label>
        <input type="text" class="search-box" id="edit-song-title" placeholder="例如: Midnight City">

        <label class="modal-label">歌手 / 专辑</label>
        <input type="text" class="search-box" id="edit-artist-name" placeholder="例如: M83">

        <label class="modal-label">音频来源</label>
        <button class="file-upload-btn" onclick="document.getElementById('mp3-input').click()">选择本地 MP3 文件</button>
        <div id="music-file-name">未选择文件</div>

        <div style="text-align: center; margin: 10px 0; opacity: 0.5;">- 或 -</div>
        <input type="text" class="search-box" id="edit-music-url" placeholder="输入在线音乐链接 (URL)">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeMusicModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveMusicInfo()">保存并播放</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="profile-modal">
    <div class="modal-content" style="width: 80%; max-width: 300px;">
        <div class="modal-header">
            <span class="modal-title" id="profile-modal-title">编辑</span>
        </div>

        <input type="text" class="search-box" id="profile-edit-input" placeholder="请输入内容...">
        <input type="hidden" id="current-edit-type">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeProfileModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveProfileText()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-wallpaper">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-wallpaper')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">壁纸设置</div>
    </div>

    <div class="wallpaper-content">

        <div>
            <div class="section-title">静态壁纸 (图片)</div>
            <div class="preview-card">
                <div class="preview-viewport">
                    <div id="wp-img-preview" style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#666;">预览</div>
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-upload" onclick="document.getElementById('wp-img-input').click()">
                        📁 选择图片
                    </button>
                    <button class="action-btn btn-apply" id="btn-apply-img" onclick="applyWallpaper('image')">
                        ✨ 设为壁纸
                    </button>
                </div>
                <input type="file" id="wp-img-input" accept="image/*" hidden onchange="handleWpPreview('image', this)">
            </div>
        </div>

        <div>
            <div class="section-title">动态壁纸 (视频)</div>
            <div class="preview-card">
                <div class="preview-viewport">
                    <video id="wp-video-preview" loop muted playsinline style="width:100%; height:100%; object-fit: cover; display:none;"></video>
                    <div id="wp-video-placeholder" style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#666;">预览</div>
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-upload" onclick="document.getElementById('wp-video-input').click()">
                        🎥 选择视频
                    </button>
                    <button class="action-btn btn-apply" id="btn-apply-video" onclick="applyWallpaper('video')">
                        🚀 设为动态壁纸
                    </button>
                </div>
                <input type="file" id="wp-video-input" accept="video/mp4,video/webm" hidden onchange="handleWpPreview('video', this)">
            </div>
        </div>

    </div>
</div>

<div class="app-window" id="app-settings">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-settings')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">设置</div>
    </div>

    <div class="wallpaper-content" style="padding-top: 20px;">
        <div class="settings-list">
            <div class="settings-item" onclick="openSubPage('sub-timezone')">
                <span>日期与时间</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-timezone-label">自动</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-theme')">
                <span data-i18n="set_theme">主题</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-theme-label">深色</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-ai-model')">
                <span data-i18n="set_model">AI 模型</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-model-label">未配置</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-font')">
                <span data-i18n="set_font">字体</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-font-label">系统默认</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-island')">
                <span style="display:flex; align-items:center; gap:8px;">
                    <span style="background:black; border-radius:8px; width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
                        <div style="width:12px; height:4px; background:white; border-radius:2px;"></div>
                    </span>
                    灵动岛
                </span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="island-status-label">已开启</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-timezone" style="background: #1c1c1e;">

    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-timezone')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">选择时区</div>
    </div>

    <div class="search-container">
        <input type="text" class="settings-search" id="timezone-search" placeholder="搜索城市或国家" oninput="filterTimeZones()">
    </div>

    <div id="timezone-list-container" style="flex:1; overflow-y: auto;">
    </div>
</div>
<div class="toast-capsule" id="global-toast">
    <div class="toast-icon">✔</div>
    <span id="toast-text">设置成功</span>
</div>

<div class="sub-page" id="sub-theme" style="background: #1c1c1e;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-theme')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title">主题设置</div>
    </div>

    <div class="wallpaper-content">

        <div class="theme-options">
            <div class="theme-btn active" id="btn-theme-dark" onclick="switchTheme('dark')">
                🌑 深色
            </div>
            <div class="theme-btn" id="btn-theme-light" onclick="switchTheme('light')">
                ☀️ 浅色
            </div>
            <div class="theme-btn" id="btn-theme-custom" onclick="switchTheme('custom')">
                🎨 自定义
            </div>
        </div>

        <div class="code-editor-container" id="custom-css-area">
            <div style="color:#666; font-size:12px; margin-bottom:5px;">输入 CSS 代码 (实时覆盖):</div>
            <textarea class="code-textarea" id="css-input" placeholder="/* 例如: */
                .app-window { background: rgba(50,0,0,0.9) !important; }
                .settings-item { border-radius: 0 !important; }"></textarea>

            <button class="action-btn btn-apply" style="margin-top:10px; opacity:1; pointer-events:all; background:#4CAF50;" onclick="applyCustomCSS()">
                ⚡ 应用并保存
            </button>
        </div>

    </div>
</div>

<div class="sub-page" id="sub-ai-model" style="background: #1c1c1e;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-ai-model')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title" data-i18n="ai_set_title">模型设置</div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">

        <div class="ai-header-text">配置管理</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="renderConfigList(); openSubPage('sub-config-list')">
                <div class="ai-item-label blue">📚 切换已保存的配置</div>
                <div class="ai-item-input" id="current-config-name" style="pointer-events:none; color:white;">默认</div>
                <span style="color:#666; font-size:14px; margin-left:8px;">›</span>
            </div>
        </div>

        <div class="ai-header-text">服务器参数</div>
        <div class="ai-group-card">
            <div class="ai-list-item">
                <div class="ai-item-label">地址</div>
                <input type="text" class="ai-item-input" id="ai-endpoint" placeholder="https://api.openai.com">
            </div>
            <div class="ai-list-item">
                <div class="ai-item-label">密钥</div>
                <input type="password" class="ai-item-input" id="ai-key" placeholder="sk-...">
            </div>
        </div>

        <div class="ai-header-text">模型</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="fetchModelList()">
                <div class="ai-item-label blue">🔄 拉取模型列表</div>
            </div>
            <div class="ai-list-item" onclick="if(typeof cachedModelList!=='undefined' && cachedModelList.length>0) openSubPage('sub-model-select'); else fetchModelList();">
                <div class="ai-item-label">当前</div>
                <div class="ai-item-input" id="display-current-model" style="pointer-events:none; color:white;">未选择</div>
                <span style="color:#666; font-size:14px; margin-left:8px;">›</span>
            </div>
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 30px;">
            <button onclick="saveAISettings()" style="flex:1; height:48px; background:#0a84ff; color:white; border:none; border-radius:12px; font-size:16px; font-weight:600;">保存配置</button>
            <button onclick="testSimpleConnection()" style="flex:1; height:48px; background:rgba(10,132,255,0.15); color:#0a84ff; border:none; border-radius:12px; font-size:16px; font-weight:600;">连接测试</button>
        </div>

        <div class="ai-header-text">对话测试</div>
        <div class="ai-test-box">
            <div class="ai-test-log" id="ai-test-log">// Ready...</div>
            <div class="ai-test-input-bar">
                <input type="text" class="ai-test-input" id="ai-test-msg" placeholder="发送测试内容...">
                <button onclick="testAIConnection()" style="width:36px; height:36px; background:#0a84ff; border-radius:50%; border:none; display:flex; align-items:center; justify-content:center;">
                    <svg style="width:16px;height:16px;fill:white; margin-left:2px;" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

    </div>
</div>
<div class="sub-page" id="sub-model-select" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-model-select')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">选择模型</div>
    </div>

    <div class="search-container">
        <input type="text" class="settings-search" id="model-search" placeholder="搜索模型 (gpt, claude...)" oninput="renderModelList()">
    </div>

    <div id="model-list-container" style="flex:1; overflow-y: auto; padding-bottom: 40px;">
        <div style="text-align:center; color:#666; padding:40px;">请先在上一页点击“拉取”</div>
    </div>
</div>

<div class="sub-page" id="sub-config-list" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-config-list')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">我的配置</div>
    </div>

    <div id="config-list-container" style="flex:1; overflow-y: auto; padding-bottom: 40px;">
    </div>
</div>

<div class="sub-page" id="sub-font" style="background: #1c1c1e;">

    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-font')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title" data-i18n="font_title">字体显示</div>
    </div>

    <div class="wallpaper-content" style="padding: 0; padding-bottom: 150px;">

        <div class="ai-header-text">效果预览</div>
        <div class="font-preview-card" id="font-preview-box">
            <span class="preview-text-en">The quick brown fox</span>
            <span class="preview-text-cn">永和九年，岁在癸丑</span>
        </div>

        <div class="ai-header-text">显示调整</div>
        <div class="slider-container">
            <div class="slider-header">
                <span>大小</span>
                <span id="val-size">16px</span>
            </div>
            <input type="range" id="range-size" min="12" max="24" step="1" value="16" oninput="updateFontConfig()">

            <div class="slider-header" style="margin-top: 20px;">
                <span>粗细</span>
                <span id="val-weight">400</span>
            </div>
            <input type="range" id="range-weight" min="100" max="900" step="100" value="400" oninput="updateFontConfig()">
        </div>

        <div class="ai-header-text">选择字体</div>
        <div class="ai-group-card" id="font-list-container">
        </div>

        <div class="ai-header-text">自定义</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="document.getElementById('font-file-input').click()">
                <div class="ai-item-label blue">📁 上传字体文件 (.ttf/.otf)</div>
                <span class="ai-arrow">›</span>
            </div>
        </div>
        <input type="file" id="font-file-input" accept=".ttf,.otf,.woff,.woff2" style="display:none;" onchange="handleFontUpload(this)">

        <div class="ai-btn-group">
            <button class="ai-btn ai-btn-secondary" onclick="resetFontSettings()">恢复默认</button>
            <button class="ai-btn ai-btn-primary" onclick="showToast('✅ 字体设置已保存')">保存设置</button>
        </div>

    </div>
</div>

<div class="modal-overlay" id="config-name-modal">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">保存配置</span>
        </div>

        <div style="margin-bottom: 10px; color: rgba(255,255,255,0.6); font-size: 14px;">给当前配置起个名字：</div>

        <input type="text" class="search-box" id="config-name-input" placeholder="例如: DeepSeek 官方" style="background: rgba(255,255,255,0.1); color: white; text-align: left; padding-left: 15px;">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeConfigNameModal()">取消</button>
            <button class="modal-btn btn-save" onclick="confirmSaveConfig()">确认保存</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-island" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-island')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">灵动岛</div>
    </div>

    <div class="wallpaper-content">
        <div class="group-header">总开关</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>启用灵动岛</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-master" onchange="toggleIslandMaster()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="group-header">交互场景</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>充电提示</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-charge" onchange="saveIslandConfig()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <span>音乐播放可视化</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-music" onchange="saveIslandConfig()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="group-header">调试</div>
        <div class="ai-btn-group" style="margin:0;">
            <button class="ai-btn ai-btn-secondary" onclick="testIsland('charge')">测试充电动画</button>
            <button class="ai-btn ai-btn-secondary" onclick="testIsland('music')">测试音乐动画</button>
        </div>
        <div style="text-align:center; color:#666; font-size:12px; margin-top:10px;">
            点击测试按钮查看效果
        </div>
    </div>
</div>

<div class="modal-overlay" id="clear-config-modal">
    <div class="modal-content" style="width: 80%; max-width: 300px;">
        <div class="modal-header">
            <span class="modal-title" style="color: #FF3B30;">危险操作</span>
        </div>

        <div style="text-align: center; margin: 10px 0 25px 0; color: rgba(255,255,255,0.7); font-size: 14px; line-height: 1.5;">
            确定要删除所有保存的模型配置吗？<br>此操作<b>无法撤销</b>。
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeClearConfigModal()">取消</button>
            <button class="modal-btn" onclick="confirmClearConfig()" style="background: #FF3B30; color: white; font-weight: 600;">
                删除全部
            </button>
        </div>
    </div>
</div>

<div class="app-window" id="app-icons">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-icons')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">图标设置</div>
    </div>

    <div class="wallpaper-content">

        <div class="ai-header-text">主屏幕应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-wallpaper" id="preview-home-wallpaper">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </div>
                <div class="city-name">壁纸</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-wallpaper')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-wallpaper')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-settings" id="preview-home-settings">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .36.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.17 0-.36-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </div>
                <div class="city-name">设置</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-settings')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-settings')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-chat" id="preview-home-chat">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                </div>
                <div class="city-name">聊天</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-chat')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-chat')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-music" id="preview-home-music">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="city-name">音乐</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-music')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-music')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">Dock 栏应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-role" id="preview-dock-role" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <div class="city-name">角色书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-role')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-role')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-world" id="preview-dock-world" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="city-name">世界书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-world')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-world')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-manual" id="preview-dock-manual" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                </div>
                <div class="city-name">说明书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-manual')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-manual')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-gallery" id="preview-dock-gallery" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
                </div>
                <div class="city-name">图标</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-gallery')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-gallery')">还原</button>
            </div>
        </div>

        <input type="file" id="icon-file-input" accept="image/png,image/jpeg,image/jpg" style="display:none;" onchange="handleIconFileSelect(this)">
    </div>
</div>

<div class="app-window" id="app-rolebook">
    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-rolebook')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">角色书</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-size: 28px; cursor: pointer; font-weight: 300;" onclick="openRoleEditModal()">+</div>
    </div>

    <div class="wallpaper-content">
        <div class="role-grid" id="role-list-container">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-role-detail" style="background: #1c1c1e;">
    <div style="position: absolute; top: 50px; left: 15px; z-index: 20;">
        <div onclick="closeSubPage('sub-role-detail')" style="background: rgba(0,0,0,0.5); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">
        <div class="role-header-bg" id="role-detail-bg" onclick="triggerRoleBgUpload()"></div>
        <input type="file" id="role-bg-input" accept="image/*" hidden onchange="handleRoleBgUpload(this)">

        <div class="role-avatar-container">
            <div class="role-big-avatar" id="role-detail-avatar"></div>
        </div>

        <div class="role-detail-content">
            <div class="role-detail-name" id="role-detail-name">角色名</div>
            <div class="role-detail-desc" id="role-detail-desc">人设详情...</div>

            <div class="ai-btn-group" style="margin-top: 40px;">
                <button class="ai-btn ai-btn-secondary" style="color: #FF3B30; background: rgba(255, 59, 48, 0.1);" onclick="deleteCurrentRole()">删除角色</button>
                <button class="ai-btn ai-btn-primary" onclick="editCurrentRole()">编辑资料</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-role-edit">
    <div class="modal-content" style="width: 90%; max-height: 85%;">
        <div class="modal-header">
            <span class="modal-title" id="role-modal-title">新建角色</span>
        </div>

        <div style="overflow-y: auto; flex: 1;">
            <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                <div id="role-edit-avatar-preview" onclick="document.getElementById('role-avatar-input').click()"
                     style="width: 80px; height: 80px; border-radius: 50%; background: #333; border: 2px dashed #666; display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center;">
                    <span style="font-size: 24px; color: #666;">+</span>
                </div>
                <input type="file" id="role-avatar-input" accept="image/*" hidden onchange="previewRoleAvatar(this)">
            </div>

            <div class="ai-item-label" style="margin-bottom: 5px;">昵称</div>
            <input type="text" class="search-box" id="role-edit-name" placeholder="角色名字" style="text-align: left; padding-left: 10px;">

            <div class="ai-item-label" style="margin: 15px 0 5px 0;">人设详情</div>
            <textarea class="code-textarea" id="role-edit-desc" placeholder="输入详细设定..." style="height: 150px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; font-family: inherit; font-size: 15px;"></textarea>
        </div>

        <div class="modal-footer" style="margin-top: 15px;">
            <button class="modal-btn btn-cancel" onclick="closeRoleModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveRoleData()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-worldbook">
    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-worldbook')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">世界书</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-size: 28px; cursor: pointer; font-weight: 300;" onclick="openWorldEditModal()">+</div>
    </div>

    <div class="wallpaper-content">
        <div id="world-list-container">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-world-detail" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-world-detail')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">设定详情</div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">
        <div class="world-detail-container">
            <div class="world-detail-header" id="view-world-title">标题</div>
            <div class="world-detail-body" id="view-world-content">内容...</div>

            <div class="ai-btn-group" style="margin-top: 30px;">
                <button class="ai-btn ai-btn-secondary" style="color: #FF3B30; background: rgba(255, 59, 48, 0.1);" onclick="deleteCurrentWorld()">删除</button>
                <button class="ai-btn ai-btn-primary" onclick="editCurrentWorld()">编辑</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-world-edit">
    <div class="modal-content" style="width: 90%; max-height: 85%;">
        <div class="modal-header">
            <span class="modal-title" id="world-modal-title">新建设定</span>
        </div>

        <div style="flex: 1; overflow-y: auto;">
            <div class="ai-item-label" style="margin-bottom: 5px;">设定名称</div>
            <input type="text" class="search-box" id="world-edit-title" placeholder="例如: 魔法体系、地理环境" style="text-align: left; padding-left: 10px;">

            <div class="ai-item-label" style="margin: 15px 0 5px 0;">详细内容</div>
            <textarea class="code-textarea" id="world-edit-content" placeholder="输入详细的世界观设定..." style="height: 300px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; font-family: inherit; font-size: 15px; line-height: 1.6;"></textarea>
        </div>

        <div class="modal-footer" style="margin-top: 15px;">
            <button class="modal-btn btn-cancel" onclick="closeWorldModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveWorldData()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-music">

    <div id="music-view-list">
        <div class="app-header" style="background:transparent; border-bottom:none;">
            <div class="app-back-btn" onclick="closeApp('app-music')">
                <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                主屏幕
            </div>
            <div class="app-title" style="color:white;">音乐库</div>

            <div class="header-add-btn" onclick="openMusicUploadModal()">
                <svg style="width:18px;height:18px;fill:white;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
        </div>

        <div class="wallpaper-content" id="app-music-list-container" style="padding-bottom: 120px;">
        </div>

        <div class="mini-player" id="mini-player-bar" onclick="openFullPlayer()">
            <div class="mini-cover" id="mini-cover"></div>
            <div class="mini-info">
                <div class="mini-title" id="mini-title">未播放</div>
                <div class="mini-artist" id="mini-artist">--</div>
            </div>
            <div class="mini-controls">
                <button class="mini-btn" onclick="event.stopPropagation(); togglePlayState()" id="mini-play-btn">
                    <svg id="mini-icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="mini-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <button class="mini-btn" onclick="event.stopPropagation(); playNextSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="music-view-full">
        <div id="full-player-bg"></div>

        <div class="full-player-header" style="padding: 50px 20px 0 20px; display:flex; justify-content:space-between; align-items:center;">
            <div class="fp-btn" onclick="closeFullPlayer()">
                <svg viewBox="0 0 24 24" fill="white" width="30" height="30"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            </div>
            <div class="fp-actions" style="display:flex;">
                <button class="fp-icon-btn" onclick="triggerMusicBgUpload()">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </button>
                <button class="fp-icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                </button>
            </div>
            <input type="file" id="music-bg-input" accept="image/*" hidden onchange="handleMusicBgUpload(this)">
        </div>

        <div class="full-player-content">
            <div class="disk-wrapper">
                <div class="disk-cover" id="full-cover"></div>
            </div>

            <div style="width:100%; text-align:left; margin-bottom:10px;">
                <div class="fp-title" id="full-title" style="font-size:24px; font-weight:700; color:white; margin-bottom:5px;">Song Name</div>
                <div class="fp-artist" id="full-artist" style="font-size:16px; color:rgba(255,255,255,0.6);">Artist</div>
            </div>

            <div class="lyrics-box" onclick="openLyricsModal()" style="height:40px; color:rgba(255,255,255,0.8);">
                <span id="current-lyric-line">暂无歌词 - 点击添加</span>
            </div>

            <div class="fp-progress-container">
                <input type="range" class="fp-slider" id="music-slider" min="0" value="0" max="100" oninput="seekAudio(this.value)">
                <div class="time-row">
                    <span id="time-current">0:00</span>
                    <span id="time-total">0:00</span>
                </div>
            </div>

            <div class="fp-controls">
                <button class="fp-ctrl-btn small" onclick="togglePlayMode()">
                    <svg id="icon-mode-0" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    <svg id="icon-mode-1" viewBox="0 0 24 24" style="display:none"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z"/></svg>
                    <svg id="icon-mode-2" viewBox="0 0 24 24" style="display:none"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                </button>

                <button class="fp-ctrl-btn" onclick="playPrevSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>

                <button class="fp-ctrl-btn big" onclick="togglePlayState()" id="full-play-btn">
                    <svg id="fp-icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="fp-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <button class="fp-ctrl-btn" onclick="playNextSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>

                <button class="fp-ctrl-btn small" onclick="openPlaylistSheet()">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-music-upload">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">添加歌曲</span></div>
        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div id="upload-cover-preview" onclick="document.getElementById('new-song-cover').click()"
                 style="width:70px; height:70px; background:rgba(255,255,255,0.1); border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover;">
                <span style="font-size:24px; color:rgba(255,255,255,0.5);">+</span>
            </div>
            <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                <input type="text" class="search-box" id="new-song-title" placeholder="歌曲名称" style="margin:0;">
                <input type="text" class="search-box" id="new-song-artist" placeholder="歌手" style="margin:0;">
            </div>
        </div>
        <input type="file" id="new-song-cover" accept="image/*" hidden onchange="previewNewSongCover(this)">

        <div class="ai-item-label" style="margin-bottom:5px;">音频来源</div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="tab-btn active" onclick="switchAudioSource('file')" id="btn-src-file">本地文件</button>
            <button class="tab-btn" onclick="switchAudioSource('url')" id="btn-src-url">在线 URL</button>
        </div>

        <div id="src-file-area" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px;">
            <button class="file-upload-btn" onclick="document.getElementById('new-song-file').click()">选择 MP3 文件</button>
            <div id="new-song-filename" style="font-size:12px; color:#999; margin-top:5px;">未选择</div>
            <input type="file" id="new-song-file" accept="audio/*" hidden onchange="handleNewSongFile(this)">
        </div>
        <div id="src-url-area" style="display:none; margin-top: 15px;">
            <input type="text" class="search-box" id="new-song-url" placeholder="https://example.com/music.mp3">
        </div>

        <div class="modal-footer" style="margin-top:20px;">
            <button class="modal-btn btn-cancel" onclick="closeMusicUploadModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveNewSong()">保存</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-lyrics">
    <div class="modal-content" style="height:70%;">
        <div class="modal-header"><span class="modal-title">编辑歌词</span></div>
        <textarea class="code-textarea" id="lyrics-input" placeholder="在此粘贴歌词..." style="height:100%; margin-bottom:15px;"></textarea>
        <div class="modal-footer" style="justify-content: space-between;">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('lrc-file').click()">📂 导入 LRC</button>
            <input type="file" id="lrc-file" accept=".lrc,.txt" hidden onchange="handleLrcFile(this)">

            <div style="display:flex; gap:10px;">
                <button class="modal-btn btn-save" onclick="saveLyrics()">保存</button>
                <button class="modal-btn btn-cancel" onclick="document.getElementById('modal-lyrics').classList.remove('active'); setTimeout(()=>document.getElementById('modal-lyrics').style.display='none',300);">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="sub-page" id="sheet-playlist" style="top:auto; bottom:0; height:60vh; border-radius:24px 24px 0 0; transform:translateY(100%); transition:transform 0.3s; background:#1c1c1e; z-index:900;">
    <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; font-size:18px; color:white;">播放列表</span>
        <span onclick="closePlaylistSheet()" style="cursor:pointer; padding:5px; color:#0a84ff;">关闭</span>
    </div>
    <div id="sheet-list-content" style="overflow-y:auto; height:calc(100% - 60px); padding:10px;"></div>
</div>
<div class="modal-overlay" id="modal-song-menu" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closeSongMenu()"></div>

    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="openEditSongModal()">
                <span style="color: #0a84ff;">编辑歌曲信息</span>
            </div>
            <div class="sheet-item" onclick="openDeleteConfirmModal()" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #FF3B30;">删除歌曲</span>
            </div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closeSongMenu()" style="font-weight: 600;">
                取消
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-edit-song">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">编辑信息</span>
        </div>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">歌曲名称</div>
                <input type="text" class="search-box" id="edit-title-input" style="margin:0;">
            </div>
            <div>
                <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">歌手 / 专辑</div>
                <input type="text" class="search-box" id="edit-artist-input" style="margin:0;">
            </div>
        </div>

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeEditSongModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveSongEdit()">保存修改</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-delete-confirm">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 20px;">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">删除歌曲</div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 25px; line-height: 1.5;">
            确定要删除 <span id="del-song-name" style="color:white;">这首歌</span> 吗？<br>此操作无法恢复。
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeDeleteConfirmModal()">取消</button>
            <button class="modal-btn" onclick="confirmDeleteSong()" style="background: #FF3B30; color: white; border: none;">删除</button>
        </div>
    </div>
</div>
<div id="island-popup-mask" onclick="closeIslandPopup()"></div>
<div id="island-popup-player" class="island-popup">
    <div class="popup-backdrop"></div>

    <div class="popup-content">
        <div class="popup-top">
            <div class="popup-cover" id="popup-cover"></div>

            <div class="popup-info">
                <div class="popup-title" id="popup-title">Song Name</div>
                <div class="popup-artist" id="popup-artist">Artist</div>
            </div>

            <button class="popup-icon-btn" onclick="openPlaylistSheet(); closeIslandPopup();">
                <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
            </button>
        </div>

        <div class="popup-progress">
            <span class="time-tiny" id="popup-time-current">0:00</span>
            <input type="range" class="fp-slider popup-slider" id="popup-slider" min="0" value="0" max="100" oninput="seekAudio(this.value)">
            <span class="time-tiny" id="popup-time-total">0:00</span>
        </div>

        <div class="popup-controls">
            <button class="popup-btn" onclick="playPrevSong()">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </button>

            <button class="popup-btn big" onclick="togglePlayState()" id="popup-play-btn">
                <svg id="popup-icon-play" viewBox="0 0 24 24" style="margin-left:2px;"><path d="M8 5v14l11-7z"/></svg>
                <svg id="popup-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>

            <button class="popup-btn" onclick="playNextSong()">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
        </div>
    </div>
</div>
<script>
    // --- 补上通用的弹窗函数 ---
    function showToast(msg) {
        const toast = document.getElementById('global-toast');
        const text = document.getElementById('toast-text');
        if (toast && text) {
            text.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        } else {
            // 如果还没加 HTML，就退化成普通弹窗，防止报错
            alert(msg);
        }
    }
    // --- 0. 数据库工具 (升级版) ---
    const dbName = "AIPhoneDB_V2";
    const storeName = "media_files";
    const dbHelper = {
        open: function() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName);
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        },
        save: async function(key, value) {
            const db = await this.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readwrite");
                const request = tx.objectStore(storeName).put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        },
        get: async function(key) {
            const db = await this.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readonly");
                const request = tx.objectStore(storeName).get(key);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }
    };
    // --- 1. 基础 UI 逻辑 (时钟/电池) ---
    // ================== 全局时钟与时区逻辑 (修复完整版) ==================

    // 1. 海量时区数据库 (必须包含 name, detail, id)
    const timeZones = [
        // 亚洲
        { name: "北京", detail: "中国标准时间", id: "Asia/Shanghai" },
        { name: "香港", detail: "香港时间", id: "Asia/Hong_Kong" },
        { name: "台北", detail: "台北时间", id: "Asia/Taipei" },
        { name: "东京", detail: "日本", id: "Asia/Tokyo" },
        { name: "首尔", detail: "韩国", id: "Asia/Seoul" },
        { name: "新加坡", detail: "新加坡", id: "Asia/Singapore" },
        { name: "曼谷", detail: "泰国", id: "Asia/Bangkok" },
        { name: "迪拜", detail: "阿联酋", id: "Asia/Dubai" },
        { name: "新德里", detail: "印度", id: "Asia/Kolkata" },

        // 美洲
        { name: "纽约", detail: "美国东部", id: "America/New_York" },
        { name: "洛杉矶", detail: "美国太平洋", id: "America/Los_Angeles" },
        { name: "芝加哥", detail: "美国中部", id: "America/Chicago" },
        { name: "温哥华", detail: "加拿大", id: "America/Vancouver" },
        { name: "多伦多", detail: "加拿大", id: "America/Toronto" },
        { name: "墨西哥城", detail: "墨西哥", id: "America/Mexico_City" },
        { name: "圣保罗", detail: "巴西", id: "America/Sao_Paulo" },

        // 欧洲
        { name: "伦敦", detail: "英国", id: "Europe/London" },
        { name: "巴黎", detail: "法国", id: "Europe/Paris" },
        { name: "柏林", detail: "德国", id: "Europe/Berlin" },
        { name: "罗马", detail: "意大利", id: "Europe/Rome" },
        { name: "莫斯科", detail: "俄罗斯", id: "Europe/Moscow" },
        { name: "阿姆斯特丹", detail: "荷兰", id: "Europe/Amsterdam" },
        { name: "马德里", detail: "西班牙", id: "Europe/Madrid" },
        { name: "苏黎世", detail: "瑞士", id: "Europe/Zurich" },

        // 大洋洲
        { name: "悉尼", detail: "澳大利亚", id: "Australia/Sydney" },
        { name: "墨尔本", detail: "澳大利亚", id: "Australia/Melbourne" },
        { name: "奥克兰", detail: "新西兰", id: "Pacific/Auckland" },

        // 非洲
        { name: "开罗", detail: "埃及", id: "Africa/Cairo" },
        { name: "约翰内斯堡", detail: "南非", id: "Africa/Johannesburg" }
    ];

    // 2. 地区名称映射表
    const regionMap = {
        "Asia": "亚洲",
        "America": "美洲",
        "Europe": "欧洲",
        "Australia": "大洋洲",
        "Pacific": "大洋洲",
        "Africa": "非洲",
        "Etc": "其他"
    };

    // 3. 渲染时区列表 (修复版逻辑)
    function initTimeZoneList() {
        filterTimeZones(); // 初始化时渲染一次
    }

    function filterTimeZones() {
        const container = document.getElementById('timezone-list-container');
        const searchInput = document.getElementById('timezone-search');
        // 防止报错：如果还没加载输入框，就默认为空
        const keyword = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const currentZone = localStorage.getItem('userTimeZone') || 'Asia/Shanghai';

        container.innerHTML = ''; // 清空列表

        // 过滤数据
        let filteredList = timeZones.filter(tz => {
            if (!keyword) return true;
            // 这里的 detail 必须存在，否则会报错。上面的数据里我已经补全了 detail
            return tz.name.toLowerCase().includes(keyword) || (tz.detail && tz.detail.toLowerCase().includes(keyword));
        });

        if (filteredList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:40px; font-size:14px;">未找到结果</div>';
            return;
        }

        // 分组逻辑
        const groups = {};
        filteredList.forEach(tz => {
            const regionKey = tz.id.split('/')[0];
            const regionName = regionMap[regionKey] || "其他地区";
            if (!groups[regionName]) groups[regionName] = [];
            groups[regionName].push(tz);
        });

        const regionOrder = ["亚洲", "欧洲", "美洲", "大洋洲", "非洲", "其他地区"];
        const sortedKeys = regionOrder.filter(k => groups[k]).concat(Object.keys(groups).filter(k => !regionOrder.includes(k)));

        sortedKeys.forEach(regionName => {
            const cityList = groups[regionName];

            // 分组标题
            const header = document.createElement('div');
            header.className = 'group-header';
            header.textContent = regionName;
            container.appendChild(header);

            // 分组卡片
            const groupCard = document.createElement('div');
            groupCard.className = 'settings-group';

            cityList.forEach(tz => {
                const isSelected = tz.id === currentZone;
                const item = document.createElement('div');
                item.className = `settings-item ${isSelected ? 'selected' : ''}`;
                item.onclick = () => setTimeZone(tz.id, tz.name);

                item.innerHTML = `
                    <div>
                        <div class="city-name">${tz.name}</div>
                        <div class="city-detail">${tz.detail}</div>
                    </div>
                    <span class="check-icon">✔</span>
                `;
                groupCard.appendChild(item);
            });
            container.appendChild(groupCard);
        });
    }

    // 4. 设置时区功能
    function setTimeZone(zoneId, zoneName) {
        localStorage.setItem('userTimeZone', zoneId);

        // 清空搜索框
        const searchInput = document.getElementById('timezone-search');
        if(searchInput) searchInput.value = '';

        filterTimeZones();
        updateTime();
        showToast(`时区已切换至 ${zoneName}`);
        closeSubPage('sub-timezone');
    }

    // 打开子页面的功能
    function openSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.add('active');
        } else {
            console.error("找不到子页面:", id);
        }
    }

    // 关闭子页面的功能
    function closeSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.remove('active');
        }
    }

    // 6. 核心时间更新
    function updateTime() {
        const userZone = localStorage.getItem('userTimeZone') || 'Asia/Shanghai';
        const now = new Date();

        try {
            // 更新时钟
            const timeString = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit', minute: '2-digit', hour12: false, timeZone: userZone
            }).format(now);

            const clockEl = document.getElementById('clock');
            if(clockEl) clockEl.textContent = timeString;

            // 更新日期
            const dateParts = new Intl.DateTimeFormat('zh-CN', {
                month: 'numeric', day: 'numeric', weekday: 'long', timeZone: userZone
            }).formatToParts(now);

            const weekdayEl = document.getElementById('weekday-text');
            const dateEl = document.getElementById('date-text');

            if (weekdayEl && dateEl) {
                weekdayEl.textContent = dateParts.find(p => p.type === 'weekday').value;
                dateEl.textContent = `${dateParts.find(p => p.type === 'month').value}月${dateParts.find(p => p.type === 'day').value}日`;
            }

            // 更新设置页当前状态
            const currentObj = timeZones.find(t => t.id === userZone);
            const label = document.getElementById('current-timezone-label');
            if(label) label.textContent = currentObj ? currentObj.name : '未知';

        } catch(e) {
            console.error("时间更新出错:", e);
        }
    }

    // 启动
    initTimeZoneList();
    // 这里的 setInterval 是为了防止重复定义，先清除再设置
    if (window.clockInterval) clearInterval(window.clockInterval);
    window.clockInterval = setInterval(updateTime, 1000);
    updateTime();

    function initBattery() {
        const batteryLevel = document.getElementById('battery-fill');
        const batteryText = document.getElementById('battery-text');
        const chargingIcon = document.getElementById('charging-bolt');
        if('getBattery' in navigator) navigator.getBattery().then(b => {
            const update = () => {
                const level = b.level * 100;
                batteryText.textContent = Math.round(level) + "%";
                batteryLevel.style.width = level + "%";
                if(b.charging) { batteryLevel.style.backgroundColor = "#4CD964"; chargingIcon.style.display = "block"; }
                else if(level <= 20) { batteryLevel.style.backgroundColor = "#FF3B30"; chargingIcon.style.display = "none"; }
                else { batteryLevel.style.backgroundColor = "white"; chargingIcon.style.display = "none"; }
            };
            update(); b.addEventListener('levelchange', update); b.addEventListener('chargingchange', update);
        });
    }
    initBattery();

    // --- 2. 城市数据 (超大杯完整版) ---
    const cityDatabase = {
        domestic: [
            // --- 一线/新一线 ---
            { name: "北京", lat: 39.9042, lon: 116.4074 },
            { name: "上海", lat: 31.2304, lon: 121.4737 },
            { name: "广州", lat: 23.1291, lon: 113.2644 },
            { name: "深圳", lat: 22.5431, lon: 114.0579 },
            { name: "成都", lat: 30.5728, lon: 104.0668 },
            { name: "重庆", lat: 29.5627, lon: 106.5528 },
            { name: "杭州", lat: 30.2741, lon: 120.1551 },
            { name: "武汉", lat: 30.5928, lon: 114.3055 },
            { name: "西安", lat: 34.3416, lon: 108.9398 },
            { name: "南京", lat: 32.0603, lon: 118.7969 },
            { name: "天津", lat: 39.0842, lon: 117.2009 },
            { name: "苏州", lat: 31.2989, lon: 120.5853 },
            { name: "长沙", lat: 28.2282, lon: 112.9388 },
            { name: "郑州", lat: 34.7466, lon: 113.6253 },

            // --- 东部沿海 ---
            { name: "青岛", lat: 36.0671, lon: 120.3826 },
            { name: "大连", lat: 38.9140, lon: 121.6147 },
            { name: "厦门", lat: 24.4798, lon: 118.0894 },
            { name: "宁波", lat: 29.8683, lon: 121.5440 },
            { name: "福州", lat: 26.0745, lon: 119.2965 },
            { name: "济南", lat: 36.6512, lon: 117.1201 },

            // --- 东北/西北 ---
            { name: "哈尔滨", lat: 45.8038, lon: 126.5349 },
            { name: "沈阳", lat: 41.8057, lon: 123.4315 },
            { name: "长春", lat: 43.8171, lon: 125.3235 },
            { name: "兰州", lat: 36.0611, lon: 103.8343 },
            { name: "乌鲁木齐", lat: 43.8256, lon: 87.6168 },
            { name: "呼和浩特", lat: 40.8419, lon: 111.7492 },

            // --- 西南/旅游热门 ---
            { name: "昆明", lat: 24.8801, lon: 102.8329 },
            { name: "丽江", lat: 26.8721, lon: 100.2297 },
            { name: "大理", lat: 25.6065, lon: 100.2676 },
            { name: "拉萨", lat: 29.6525, lon: 91.1721 },
            { name: "贵阳", lat: 26.6470, lon: 106.6302 },
            { name: "三亚", lat: 18.2528, lon: 109.5120 },
            { name: "海口", lat: 20.0440, lon: 110.1999 },
            { name: "桂林", lat: 25.2345, lon: 110.1800 },

            // --- 港澳台 ---
            { name: "香港", lat: 22.3193, lon: 114.1694 },
            { name: "澳门", lat: 22.1987, lon: 113.5439 },
            { name: "台北", lat: 25.0330, lon: 121.5654 },
            { name: "高雄", lat: 22.6273, lon: 120.3014 }
        ],
        international: [
            // --- 亚洲 ---
            { name: "东京", lat: 35.6895, lon: 139.6917 },
            { name: "大阪", lat: 34.6937, lon: 135.5023 },
            { name: "京都", lat: 35.0116, lon: 135.7681 },
            { name: "首尔", lat: 37.5665, lon: 126.9780 },
            { name: "曼谷", lat: 13.7563, lon: 100.5018 },
            { name: "新加坡", lat: 1.3521, lon: 103.8198 },
            { name: "吉隆坡", lat: 3.1390, lon: 101.6869 },
            { name: "胡志明市", lat: 10.8231, lon: 106.6297 },
            { name: "雅加达", lat: -6.2088, lon: 106.8456 },
            { name: "马尼拉", lat: 14.5995, lon: 120.9842 },
            { name: "新德里", lat: 28.6139, lon: 77.2090 },
            { name: "迪拜", lat: 25.2048, lon: 55.2708 },

            // --- 欧洲 ---
            { name: "伦敦", lat: 51.5074, lon: -0.1278 },
            { name: "巴黎", lat: 48.8566, lon: 2.3522 },
            { name: "柏林", lat: 52.5200, lon: 13.4050 },
            { name: "慕尼黑", lat: 48.1351, lon: 11.5820 },
            { name: "罗马", lat: 41.9028, lon: 12.4964 },
            { name: "米兰", lat: 45.4642, lon: 9.1900 },
            { name: "马德里", lat: 40.4168, lon: -3.7038 },
            { name: "巴塞罗那", lat: 41.3851, lon: 2.1734 },
            { name: "莫斯科", lat: 55.7558, lon: 37.6173 },
            { name: "阿姆斯特丹", lat: 52.3676, lon: 4.9041 },
            { name: "苏黎世", lat: 47.3769, lon: 8.5417 },

            // --- 北美 ---
            { name: "纽约", lat: 40.7128, lon: -74.0060 },
            { name: "洛杉矶", lat: 34.0522, lon: -118.2437 },
            { name: "旧金山", lat: 37.7749, lon: -122.4194 },
            { name: "芝加哥", lat: 41.8781, lon: -87.6298 },
            { name: "西雅图", lat: 47.6062, lon: -122.3321 },
            { name: "多伦多", lat: 43.6510, lon: -79.3470 },
            { name: "温哥华", lat: 49.2827, lon: -123.1207 },

            // --- 其他 ---
            { name: "悉尼", lat: -33.8688, lon: 151.2093 },
            { name: "墨尔本", lat: -37.8136, lon: 144.9631 },
            { name: "奥克兰", lat: -36.8485, lon: 174.7633 },
            { name: "开罗", lat: 30.0444, lon: 31.2357 },
            { name: "里约热内卢", lat: -22.9068, lon: -43.1729 },
            { name: "布宜诺斯艾利斯", lat: -34.6037, lon: -58.3816 }
        ]
    };

    let currentTab = 'domestic';
    let selectedCity = null; // 临时选中的城市对象

    // --- 3. 弹窗与列表逻辑 ---
    const modal = document.getElementById('city-modal');
    const listContainer = document.getElementById('city-list-container');
    const searchInput = document.getElementById('city-search');

    function openCityModal() {
        modal.style.display = 'flex';
        renderCityList(); // 每次打开重新渲染列表
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeCityModal() {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
        selectedCity = null; // 重置选择
    }

    // 切换 国内/国际 Tab
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        searchInput.value = ''; // 切换时清空搜索
        renderCityList();
    }

    // 渲染列表 (支持搜索过滤)
    function renderCityList() {
        listContainer.innerHTML = '';
        const keyword = searchInput.value.trim();
        const cities = cityDatabase[currentTab];

        cities.forEach(city => {
            // 如果有搜索词，必须匹配名字
            if (keyword && !city.name.includes(keyword)) return;

            const item = document.createElement('div');
            item.className = 'city-item';
            if (selectedCity && selectedCity.name === city.name) {
                item.classList.add('selected');
            }

            item.innerHTML = `
                <div class="city-name">${city.name}</div>
                <div class="city-sub">Lat: ${city.lat.toFixed(1)}</div>
            `;

            item.onclick = () => {
                selectedCity = city;
                renderCityList(); // 重新渲染以更新高亮状态
            };
            listContainer.appendChild(item);
        });
    }

    function filterCities() {
        renderCityList();
    }

    // --- 4. 核心：真实天气 API 获取 ---
    function saveCitySelection() {
        if (selectedCity) {
            // 1. 获取天气
            fetchWeather(selectedCity);

            // 2. 【新增】把选中的城市存起来
            // JSON.stringify 是把对象变成字符串，因为 storage 只能存字符串
            localStorage.setItem('userCity', JSON.stringify(selectedCity));

            // 3. 关闭弹窗
            closeCityModal();
        } else {
            alert("请先选择一个城市！");
        }
    }

    // 调用 Open-Meteo 免费 API
    async function fetchWeather(city) {
        const cityEl = document.getElementById('current-city');
        const tempEl = document.querySelector('.weather-temp');
        const descEl = document.querySelector('.weather-desc');
        const iconEl = document.getElementById('weather-icon-container');

        // 先显示加载状态
        cityEl.textContent = city.name;
        descEl.textContent = "更新中...";

        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true&timezone=auto`;
            const response = await fetch(url);
            const data = await response.json();
            const weather = data.current_weather;

            // 更新 UI
            tempEl.textContent = Math.round(weather.temperature) + "°";
            const weatherInfo = getWeatherInfo(weather.weathercode);
            descEl.textContent = weatherInfo.desc;
            iconEl.innerHTML = weatherInfo.icon;

        } catch (error) {
            console.error(error);
            descEl.textContent = "获取失败";
        }
    }

    // --- 5. 天气代码映射 (全套图标) ---
    // 根据 WMO Code 返回对应图标和描述
    function getWeatherInfo(code) {
        // ☀️ 晴天 (0, 1)
        if (code <= 1) return {
            desc: "晴朗",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="14" fill="#FFC107"/><g stroke="#FF9800" stroke-width="4" stroke-linecap="round"><path d="M32 6V10 M32 54V58 M6 32H10 M54 32H58 M13.6 13.6L16.4 16.4 M47.6 47.6L50.4 50.4 M13.6 50.4L16.4 47.6 M47.6 16.4L50.4 13.6"/></g></svg>`
        };

        // ⛅ 多云 (2, 3)
        if (code <= 3) return {
            desc: "多云",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M18 42H46C51.5 42 56 37.5 56 32C56 26.5 51.5 22 46 22C46 16.5 41.5 12 36 12C30.5 12 26 16.5 26 22C20.5 22 16 26.5 16 32C16 37.5 20.5 42 26 42Z" fill="white" fill-opacity="0.9" filter="drop-shadow(0 4px 4px rgba(0,0,0,0.1))"/></svg>`
        };

        // 🌫️ 雾 (45, 48)
        if (code <= 48) return {
            desc: "有雾",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M16 24H48 M12 32H52 M16 40H48" stroke="white" stroke-width="4" stroke-linecap="round" stroke-opacity="0.6"/></svg>`
        };

        // 🌧️ 雨 (51-67, 80-82)
        if (code <= 67 || (code >= 80 && code <= 82)) return {
            desc: "降雨",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 32C20 25.3 25.3 20 32 20C38.6 20 44 25.3 44 32" fill="white" fill-opacity="0.9"/><path d="M20 32 H44 V34 H20 Z" fill="white" fill-opacity="0.9"/><path d="M24 40L22 48 M32 40L30 48 M40 40L38 48" stroke="#64B5F6" stroke-width="3" stroke-linecap="round"/></svg>`
        };

        // 🌨️ 雪 (71-77, 85-86)
        if (code <= 77 || (code >= 85 && code <= 86)) return {
            desc: "降雪",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 32C20 25.3 25.3 20 32 20C38.6 20 44 25.3 44 32" fill="white" fill-opacity="0.9"/><circle cx="24" cy="46" r="2" fill="white"/><circle cx="32" cy="50" r="2" fill="white"/><circle cx="40" cy="46" r="2" fill="white"/></svg>`
        };

        // ⛈️ 雷暴 (95-99)
        return {
            desc: "雷暴",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 30C20 23.3 25.3 18 32 18C38.6 18 44 23.3 44 30" fill="gray" fill-opacity="0.9"/><path d="M34 32L26 44H32L28 56L40 40H32L34 32Z" fill="#FFD700" stroke="#FFA000" stroke-width="1"/></svg>`
        };
    }

    // --- 启动时：检查有没有存过的城市 ---
    function initWeather() {
        // 1. 尝试从本地拿城市数据
        const savedCityStr = localStorage.getItem('userCity');

        if (savedCityStr) {
            // 2. 如果拿到了，就把它变回对象，然后查天气
            const savedCity = JSON.parse(savedCityStr);
            fetchWeather(savedCity);
        } else {
            // 3. 如果从没存过，默认显示北京
            fetchWeather(cityDatabase.domestic[0]);
        }
    }

    // 运行初始化
    initWeather();

    // --- 照片组件逻辑 ---

    // 1. 点击组件，触发隐藏的 file input 点击事件
    function triggerPhotoUpload() {
        document.getElementById('photo-input').click();
    }

    // 修改后的上传逻辑 (支持大文件)
    function handlePhotoUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                const imageData = e.target.result;

                // 1. 更新 UI
                const display = document.getElementById('photo-display');
                const placeholder = document.getElementById('photo-placeholder');
                display.style.backgroundImage = `url(${imageData})`;
                placeholder.style.display = 'none';
                display.style.display = 'block';

                // 2. 存入大容量数据库 (IndexedDB)
                try {
                    // 'userPhoto_1' 是这张图的ID，如果你以后有多个图，可以换名字
                    await dbHelper.save('userPhoto_1', imageData);
                    console.log("图片已保存到本地数据库");
                } catch (err) {
                    console.error("保存失败", err);
                    alert("保存失败，可能是空间不足");
                }
            }
            reader.readAsDataURL(file);
        }
    }

    // 修改后的初始化逻辑
    async function initSavedPhoto() {
        try {
            // 从大容量数据库读取
            const savedImage = await dbHelper.get('userPhoto_1');

            if (savedImage) {
                const display = document.getElementById('photo-display');
                const placeholder = document.getElementById('photo-placeholder');

                display.style.backgroundImage = `url(${savedImage})`;
                placeholder.style.display = 'none';
                display.style.display = 'block';
            }
        } catch (err) {
            console.log("还没有保存过照片");
        }
    }

    // 立即运行
    initSavedPhoto();

    // ================== 音乐组件核心逻辑 ==================
    const audioPlayer = new Audio();
    let isPlaying = false;
    let tempMp3File = null;

    // 1. 封面上传
    function triggerCoverUpload() { document.getElementById('cover-input').click(); }
    document.getElementById('cover-input').onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                document.getElementById('music-cover').style.backgroundImage = `url(${evt.target.result})`;
                await dbHelper.save('music_cover_img', evt.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    // 2. 弹窗控制
    const musicModal = document.getElementById('music-modal');
    const fileNameDisplay = document.getElementById('music-file-name');

    function openMusicModal() {
        const meta = JSON.parse(localStorage.getItem('musicMeta') || '{}');
        document.getElementById('edit-song-title').value = meta.title || '';
        document.getElementById('edit-artist-name').value = meta.artist || '';
        fileNameDisplay.textContent = "未选择新文件";
        tempMp3File = null;
        musicModal.style.display = 'flex';
        setTimeout(()=>musicModal.classList.add('active'), 10);
    }

    function closeMusicModal() {
        musicModal.classList.remove('active');
        setTimeout(()=>musicModal.style.display = 'none', 300);
    }

    // 3. 监听MP3选择
    document.getElementById('mp3-input').onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            tempMp3File = e.target.files[0];
            fileNameDisplay.textContent = "已选择: " + tempMp3File.name;
        }
    };

    // 4. 保存并播放
    async function saveMusicInfo() {
        const title = document.getElementById('edit-song-title').value || '未知歌曲';
        const artist = document.getElementById('edit-artist-name').value || '未知艺术家';
        const url = document.getElementById('edit-music-url').value;

        const meta = { title, artist, url, hasLocalFile: !!tempMp3File };
        localStorage.setItem('musicMeta', JSON.stringify(meta));

        // 更新文字
        document.querySelector('.song-title').textContent = title;
        document.querySelector('.artist-name').textContent = artist;

        // 处理音频
        if (tempMp3File) {
            await dbHelper.save('music_audio_file', tempMp3File); // 存入数据库
            loadAndPlayAudio(URL.createObjectURL(tempMp3File));
        } else if (url) {
            await dbHelper.save('music_audio_file', null);
            loadAndPlayAudio(url);
        }
        closeMusicModal();
    }

    function loadAndPlayAudio(src) {
        audioPlayer.src = src;
        audioPlayer.play().then(() => {
            isPlaying = true; updatePlayPauseIcon();
        }).catch(e => console.error("播放失败", e));
    }

    // 5. 播放控制按钮
    const playBtn = document.getElementById('playPauseBtn');
    playBtn.onclick = function() {
        if (!audioPlayer.src) { openMusicModal(); return; }
        if (isPlaying) audioPlayer.pause(); else audioPlayer.play();
        isPlaying = !isPlaying;
        updatePlayPauseIcon();
    };

    function updatePlayPauseIcon() {
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        if (isPlaying) {
            playIcon.style.display = 'none'; pauseIcon.style.display = 'block';
        } else {
            playIcon.style.display = 'block'; pauseIcon.style.display = 'none';
        }
    }

    // 6. 进度条更新
    const progressBar = document.querySelector('.progress-bar-fill');
    audioPlayer.ontimeupdate = function() {
        if (audioPlayer.duration) {
            progressBar.style.width = (audioPlayer.currentTime / audioPlayer.duration * 100) + '%';
        }
    };
    audioPlayer.onended = function() {
        isPlaying = false; updatePlayPauseIcon(); progressBar.style.width = '0%';
    };

    // 7. 初始化加载 (记忆功能)
    async function initMusicState() {
        const metaStr = localStorage.getItem('musicMeta');
        if (metaStr) {
            const meta = JSON.parse(metaStr);
            document.querySelector('.song-title').textContent = meta.title;
            document.querySelector('.artist-name').textContent = meta.artist;

            // 加载音频
            if (meta.hasLocalFile) {
                const audioBlob = await dbHelper.get('music_audio_file');
                if (audioBlob) audioPlayer.src = URL.createObjectURL(audioBlob);
            } else if (meta.url) {
                audioPlayer.src = meta.url;
            }
        }
        // 加载封面
        const savedCover = await dbHelper.get('music_cover_img');
        if (savedCover) document.getElementById('music-cover').style.backgroundImage = `url(${savedCover})`;
    }
    initMusicState();

    // ================== 个人信息组件逻辑 ==================

    // --- A. 头像上传逻辑 (存 IndexedDB 大仓库) ---
    function triggerProfileUpload() { document.getElementById('profile-input').click(); }

    document.getElementById('profile-input').onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                // 1. 更新界面
                document.getElementById('profile-avatar').style.backgroundImage = `url(${evt.target.result})`;
                // 2. 存入数据库
                await dbHelper.save('userAvatar_main', evt.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    // --- B. 文字编辑弹窗逻辑 ---
    const profileModal = document.getElementById('profile-modal');
    const profileInput = document.getElementById('profile-edit-input');
    const modalTitle = document.getElementById('profile-modal-title');
    const editTypeHidden = document.getElementById('current-edit-type');

    // 打开弹窗 (type 传入 'nickname' 或 'signature')
    function openProfileEditModal(type) {
        // 根据类型设置标题和回显内容
        if (type === 'nickname') {
            modalTitle.textContent = "修改昵称";
            profileInput.value = document.getElementById('profile-nickname').textContent;
        } else {
            modalTitle.textContent = "修改个性签名";
            profileInput.value = document.getElementById('profile-signature').textContent;
        }
        // 记录当前编辑类型
        editTypeHidden.value = type;

        profileModal.style.display = 'flex';
        setTimeout(() => {
            profileModal.classList.add('active');
            profileInput.focus(); // 自动聚焦输入框
        }, 10);
    }

    // 关闭弹窗
    function closeProfileModal() {
        profileModal.classList.remove('active');
        setTimeout(() => profileModal.style.display = 'none', 300);
    }

    // 保存文字 (存 localStorage 小本子)
    function saveProfileText() {
        const type = editTypeHidden.value;
        const text = profileInput.value.trim();

        if (text) {
            if (type === 'nickname') {
                document.getElementById('profile-nickname').textContent = text;
                localStorage.setItem('userNickname', text);
            } else {
                document.getElementById('profile-signature').textContent = text;
                localStorage.setItem('userSignature', text);
            }
        }
        closeProfileModal();
    }

    // --- C. 初始化加载 (断电记忆) ---
    async function initProfileState() {
        // 1. 加载文字 (localStorage)
        const nick = localStorage.getItem('userNickname');
        const sign = localStorage.getItem('userSignature');
        if (nick) document.getElementById('profile-nickname').textContent = nick;
        if (sign) document.getElementById('profile-signature').textContent = sign;

        // 2. 加载头像 (IndexedDB)
        const savedAvatar = await dbHelper.get('userAvatar_main');
        if (savedAvatar) {
            document.getElementById('profile-avatar').style.backgroundImage = `url(${savedAvatar})`;
        }
    }

    // 启动时加载
    initProfileState();

    // ================== 壁纸 App 逻辑 ==================

    // 临时存储，用于预览后保存
    let tempWpImg = null;
    let tempWpVideo = null;

    // 1. 打开/关闭 App 动画
    function openApp(appId) {
        const app = document.getElementById(appId);
        app.style.display = 'flex';
        setTimeout(() => app.classList.add('active'), 10);
    }
    function closeApp(appId) {
        const app = document.getElementById(appId);
        app.classList.remove('active');
        setTimeout(() => app.style.display = 'none', 300);
    }

    // 2. 处理上传预览
    function handleWpPreview(type, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);

            if (type === 'image') {
                const preview = document.getElementById('wp-img-preview');
                preview.innerHTML = ''; // 清空文字
                preview.style.background = `url(${url}) center/cover no-repeat`;
                tempWpImg = file; // 存入临时变量
                document.getElementById('btn-apply-img').classList.add('ready'); // 激活按钮
            } else {
                const video = document.getElementById('wp-video-preview');
                const placeholder = document.getElementById('wp-video-placeholder');
                video.src = url;
                video.style.display = 'block';
                video.play();
                placeholder.style.display = 'none';
                tempWpVideo = file;
                document.getElementById('btn-apply-video').classList.add('ready');
            }
        }
    }

    // 3. 应用壁纸 (核心保存逻辑)
    async function applyWallpaper(type) {
        const body = document.body;
        const globalVideo = document.getElementById('global-video-bg');

        if (type === 'image' && tempWpImg) {
            // --- 静态逻辑 ---
            // 1. 存入数据库
            await dbHelper.save('wallpaper_file', tempWpImg);
            await dbHelper.save('wallpaper_type', 'image');

            // 2. 应用 UI
            const url = URL.createObjectURL(tempWpImg);
            body.style.backgroundImage = `url(${url})`;
            globalVideo.style.display = 'none'; // 隐藏视频层
            globalVideo.src = ""; // 停止视频节省资源

            alert("静态壁纸已应用！");
            closeApp('app-wallpaper');

        } else if (type === 'video' && tempWpVideo) {
            // --- 动态逻辑 ---
            if (tempWpVideo.size > 50 * 1024 * 1024) {
                alert("视频有点大(超过50MB)，保存可能会慢一点，请稍等...");
            }

            // 1. 存入数据库
            await dbHelper.save('wallpaper_file', tempWpVideo);
            await dbHelper.save('wallpaper_type', 'video');

            // 2. 应用 UI
            const url = URL.createObjectURL(tempWpVideo);
            globalVideo.src = url;
            globalVideo.style.display = 'block';
            globalVideo.play();
            // 把 body 背景图去掉，否则会挡住视频
            body.style.backgroundImage = 'none';

            alert("动态壁纸已应用！");
            closeApp('app-wallpaper');
        }
    }

    // 4. 初始化加载 (开机读取壁纸)
    async function initWallpaper() {
        try {
            const type = await dbHelper.get('wallpaper_type');
            const file = await dbHelper.get('wallpaper_file');

            if (type && file) {
                const url = URL.createObjectURL(file);
                const globalVideo = document.getElementById('global-video-bg');

                if (type === 'image') {
                    document.body.style.backgroundImage = `url(${url})`;
                    globalVideo.style.display = 'none';
                } else if (type === 'video') {
                    document.body.style.backgroundImage = 'none';
                    globalVideo.src = url;
                    globalVideo.style.display = 'block';
                    globalVideo.play();
                }
            }
        } catch (e) {
            console.log("使用默认壁纸");
        }
    }

    // 启动
    initWallpaper();

    // ================== 8. 主题系统逻辑 (静音修复版) ==================

    // 1. 切换主题模式 (增加 isSilent 参数)
    function switchTheme(mode, isSilent = false) {
        // 更新按钮状态
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-theme-${mode}`);
        if(btn) btn.classList.add('active');

        // 保存模式
        localStorage.setItem('userThemeMode', mode);

        // 更新设置页文字
        const label = document.getElementById('current-theme-label');
        if(label) label.textContent = (mode === 'dark' ? '深色' : (mode === 'light' ? '浅色' : '自定义'));

        // --- 执行模式切换 ---
        const body = document.body;
        const editor = document.getElementById('custom-css-area');

        // 重置状态
        body.classList.remove('light-theme');
        removeCustomStyle();

        if (mode === 'light') {
            body.classList.add('light-theme');
            editor.style.display = 'none';
            // 只有在不是静音(手动点击)时才弹窗
            if(!isSilent) showToast('已切换至浅色模式');
        }
        else if (mode === 'dark') {
            editor.style.display = 'none';
            if(!isSilent) showToast('已切换至深色模式');
        }
        else if (mode === 'custom') {
            editor.style.display = 'block';
            const savedCSS = localStorage.getItem('userCustomCSS') || '';
            document.getElementById('css-input').value = savedCSS;
            applyCustomCSS(true); // 加载代码时默认静音
        }
    }

    // 2. 应用自定义 CSS
    function applyCustomCSS(isSilent = false) {
        const cssText = document.getElementById('css-input').value;
        removeCustomStyle();

        const styleTag = document.createElement('style');
        styleTag.id = 'user-custom-style';
        styleTag.textContent = cssText;
        document.head.appendChild(styleTag);

        localStorage.setItem('userCustomCSS', cssText);

        if(!isSilent) showToast('自定义主题已应用');
    }

    // 移除自定义样式标签
    function removeCustomStyle() {
        const oldStyle = document.getElementById('user-custom-style');
        if (oldStyle) oldStyle.remove();
    }

    // 3. 初始化主题 (开机读取 - 开启静音模式)
    function initTheme() {
        const mode = localStorage.getItem('userThemeMode') || 'dark';
        // 这里传 true，表示静音加载，不弹窗
        switchTheme(mode, true);
    }

    // 启动
    initTheme();

    // ================== 9. AI 模型设置逻辑 (多配置版) ==================

    // 1. 初始化
    function initAISettings() {
        // 读取当前激活的配置
        const activeConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');

        document.getElementById('ai-endpoint').value = activeConfig.endpoint || '';
        document.getElementById('ai-key').value = activeConfig.key || '';

        // 更新UI显示
        if (activeConfig.model) {
            updateModelDisplay(activeConfig.model);
        }
        if (activeConfig.name) {
            document.getElementById('current-config-name').textContent = activeConfig.name;
        }
    }

    // 更新显示辅助函数
    function updateModelDisplay(name) {
        const el = document.getElementById('display-current-model');
        const label = document.getElementById('current-model-label');
        if(el) el.textContent = name || '未选择';
        if(label) label.textContent = name || '未配置';
    }

    // 2. 拉取模型列表 (保持不变)
    async function fetchModelList() {
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();

        if (!endpoint || !key) { showToast("请先填写地址和密钥"); return; }
        showToast("正在连接...");

        try {
            const response = await fetch(`${endpoint}/v1/models`, {
                method: 'GET', headers: { 'Authorization': `Bearer ${key}` }
            });
            if (!response.ok) throw new Error("HTTP " + response.status);
            const data = await response.json();
            const list = Array.isArray(data.data) ? data.data : data;

            if (list && list.length > 0) {
                cachedModelList = list.sort((a, b) => a.id.localeCompare(b.id));
                renderModelList();
                openSubPage('sub-model-select');
                showToast(`获取到 ${list.length} 个模型`);
            } else { throw new Error("列表为空"); }
        } catch (err) { showToast("拉取失败: " + err.message); }
    }

    // 3. 渲染模型列表 (保持不变)
    function renderModelList() {
        const container = document.getElementById('model-list-container');
        const keyword = document.getElementById('model-search').value.toLowerCase().trim();
        container.innerHTML = '';

        const group = document.createElement('div'); group.className = 'settings-group';

        cachedModelList.filter(m => !keyword || m.id.toLowerCase().includes(keyword)).forEach(m => {
            const item = document.createElement('div');
            item.className = 'settings-item';
            item.onclick = () => {
                document.getElementById('display-current-model').textContent = m.id;
                document.getElementById('display-current-model').dataset.value = m.id;
                closeSubPage('sub-model-select');
            };
            item.innerHTML = `<div class="city-name" style="font-size:15px;">${m.id}</div>`;
            group.appendChild(item);
        });
        container.appendChild(group);
    }

    // 4. 【核心】保存配置 (UI 弹窗版)

    // 步骤 A: 校验并打开弹窗
    function saveAISettings() {
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();
        const modelEl = document.getElementById('display-current-model');
        const model = modelEl.dataset.value || modelEl.textContent.trim();

        if (!endpoint || !key || model === '未选择') { showToast("配置不完整"); return; }

        // 获取当前名字作为默认值
        const currentName = document.getElementById('current-config-name').textContent;
        const input = document.getElementById('config-name-input');
        input.value = currentName === '默认' ? '' : currentName;

        // 打开命名弹窗
        const modal = document.getElementById('config-name-modal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
            input.focus(); // 自动聚焦
        }, 10);
    }

    // 步骤 B: 关闭弹窗
    function closeConfigNameModal() {
        const modal = document.getElementById('config-name-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // 步骤 C: 确认保存 (点击弹窗按钮触发)
    function confirmSaveConfig() {
        const nameInput = document.getElementById('config-name-input');
        const configName = nameInput.value.trim() || "我的配置"; // 默认名

        // 再次获取数据 (因为只是隔了一层弹窗，DOM里的数据还在)
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();
        const modelEl = document.getElementById('display-current-model');
        const model = modelEl.dataset.value || modelEl.textContent.trim();

        // 1. 构建配置对象
        const newConfig = {
            id: Date.now(),
            name: configName,
            endpoint: endpoint,
            key: key,
            model: model
        };

        // 2. 保存到历史列表
        let configList = JSON.parse(localStorage.getItem('ai_config_list') || '[]');
        const existIndex = configList.findIndex(c => c.name === configName);
        if (existIndex >= 0) {
            configList[existIndex] = newConfig; // 覆盖旧的
        } else {
            configList.push(newConfig); // 新增
        }
        localStorage.setItem('ai_config_list', JSON.stringify(configList));

        // 3. 激活并关闭
        activateConfig(newConfig);
        showToast(`✅ 已保存: ${configName}`);
        closeConfigNameModal();
    }

    // 5. 激活配置
    function activateConfig(config) {
        localStorage.setItem('ai_active_config', JSON.stringify(config));

        // 兼容旧的存储方式 (给聊天App用)
        localStorage.setItem('ai_endpoint', config.endpoint);
        localStorage.setItem('ai_key', config.key);
        localStorage.setItem('ai_model', config.model);

        // 更新UI
        document.getElementById('ai-endpoint').value = config.endpoint;
        document.getElementById('ai-key').value = config.key;
        document.getElementById('current-config-name').textContent = config.name;
        updateModelDisplay(config.model);
        document.getElementById('current-model-label').textContent = config.model;
    }

    // 6. 渲染已保存的配置列表 (UI弹窗版)
    function renderConfigList() {
        const container = document.getElementById('config-list-container');
        const list = JSON.parse(localStorage.getItem('ai_config_list') || '[]');
        container.innerHTML = '';

        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:40px;">暂无保存的配置</div>';
            return;
        }

        const group = document.createElement('div'); group.className = 'settings-group';

        list.forEach(config => {
            const item = document.createElement('div');
            item.className = 'settings-item';

            // 点击加载配置
            item.onclick = () => {
                activateConfig(config);
                showToast(`已切换至: ${config.name}`);
                closeSubPage('sub-config-list');
            };

            item.innerHTML = `
                <div>
                    <div class="city-name">${config.name}</div>
                    <div class="city-detail">${config.model}</div>
                </div>
                <span style="color:#666; font-size:12px;">${config.endpoint.replace('https://', '').replace('http://', '')}</span>
            `;
            group.appendChild(item);
        });

        container.appendChild(group);

        // 底部清空按钮 (改为调用新弹窗)
        const clearBtn = document.createElement('div');
        clearBtn.style.textAlign = 'center';
        clearBtn.style.padding = '20px';
        clearBtn.style.color = '#FF3B30';
        clearBtn.style.cursor = 'pointer';
        clearBtn.style.fontSize = '14px';
        clearBtn.innerHTML = '🗑️ 清空所有配置';

        // 关键修改：不再用 confirm，而是打开自定义弹窗
        clearBtn.onclick = openClearConfigModal;

        container.appendChild(clearBtn);
    }

    // --- 清空确认弹窗逻辑 ---
    function openClearConfigModal() {
        const modal = document.getElementById('clear-config-modal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeClearConfigModal() {
        const modal = document.getElementById('clear-config-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function confirmClearConfig() {
        // 执行删除
        localStorage.removeItem('ai_config_list');
        // 刷新列表
        renderConfigList();
        // 提示并关闭
        showToast("已清空所有配置");
        closeClearConfigModal();
    }

    // 7. 测试逻辑 (保持不变)
    async function testSimpleConnection() { /* ...同前... */ }
    async function testAIConnection() { /* ...同前... */ }
    function getCleanEndpoint() { /* ...同前... */ return document.getElementById('ai-endpoint').value.trim().replace(/\/v1\/?$/, '').replace(/\/$/, ''); }
    function logTest(t) { const l=document.getElementById('ai-test-log'); l.innerText+=t+"\n"; l.scrollTop=l.scrollHeight; }

    // 启动
    initAISettings();

    // ================== 10. 字体设置逻辑 (Pro) ==================

    // 系统预设字体 (扩充版 - 安全无版权)
    const systemFonts = [
        { name: "系统默认", family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
        { name: "圆体 (Rounded)", family: 'ui-rounded, "Hiragino Maru Gothic ProN", "Quicksand", "Arial Rounded MT Bold", sans-serif' },
        { name: "黑体 (Sans)", family: '"Noto Sans SC", "Heiti SC", "Microsoft YaHei", sans-serif' },
        { name: "宋体 (Serif)", family: '"Songti SC", "Noto Serif SC", "SimSun", serif' },
        { name: "楷体 (KaiTi)", family: '"KaiTi", "STKaiti", "BiauKai", serif' },
        { name: "仿宋 (FangSong)", family: '"FangSong", "STFangsong", serif' },
        { name: "手写 (Handwriting)", family: '"Comic Sans MS", "Chalkboard SE", "Wawati SC", cursive' },
        { name: "代码 (Mono)", family: 'Monaco, Consolas, "Courier New", monospace' }
    ];

    // 当前配置
    let currentFontConfig = {
        family: systemFonts[0].family,
        name: systemFonts[0].name,
        size: 16,   // 实际上作为 base size 参考
        weight: 400,
        isCustom: false
    };

    // 1. 初始化字体
    async function initFontSettings() {
        const saved = JSON.parse(localStorage.getItem('userFontConfig') || 'null');

        if (saved) {
            currentFontConfig = saved;
            // 恢复滑块位置
            document.getElementById('range-size').value = saved.size;
            document.getElementById('range-weight').value = saved.weight;
        }

        // 如果是自定义字体，从数据库加载并注册
        if (currentFontConfig.isCustom) {
            await loadCustomFontFromDB();
        }

        applyFontToBody();
        renderFontList();
    }

    // 2. 应用到全局 (变量驱动版)
    function applyFontToBody() {
        const root = document.documentElement;

        // 1. 设置字体族 (Font Family)
        root.style.setProperty('--ui-font', currentFontConfig.family);

        // 2. 设置粗细 (Font Weight)
        root.style.setProperty('--ui-weight', currentFontConfig.weight);

        // 3. 【关键】设置全局字体大小变量
        // 这样 CSS 里的 var(--app-font-size) 就会收到通知
        root.style.setProperty('--app-font-size', currentFontConfig.size + "px");

        // 更新设置页的数字显示
        document.getElementById('current-font-label').textContent = currentFontConfig.name;
        const sizeLabel = document.getElementById('val-size');
        const weightLabel = document.getElementById('val-weight');

        if(sizeLabel) sizeLabel.textContent = currentFontConfig.size + "px";
        if(weightLabel) weightLabel.textContent = currentFontConfig.weight;
    }

    // 3. 实时调整 (滑块事件)
    function updateFontConfig() {
        const size = document.getElementById('range-size').value;
        const weight = document.getElementById('range-weight').value;

        currentFontConfig.size = size;
        currentFontConfig.weight = weight;

        applyFontToBody();
        saveFontConfig();
    }

    // 4. 选择字体
    function selectFont(index) {
        const font = systemFonts[index];
        currentFontConfig.family = font.family;
        currentFontConfig.name = font.name;
        currentFontConfig.isCustom = false;

        applyFontToBody();
        renderFontList();
        saveFontConfig();
        showToast("字体已切换");
    }

    // 5. 上传自定义字体
    async function handleFontUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const fontName = "UserCustomFont";

            showToast("正在处理字体...");

            try {
                const arrayBuffer = await file.arrayBuffer();
                // 1. 注册字体 (浏览器 API)
                const fontFace = new FontFace(fontName, arrayBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);

                // 2. 存入数据库
                await dbHelper.save('custom_font_blob', file); // 存原文件

                // 3. 应用
                currentFontConfig.family = fontName;
                currentFontConfig.name = "自定义 (" + file.name + ")";
                currentFontConfig.isCustom = true;

                applyFontToBody();
                renderFontList();
                saveFontConfig();
                showToast("✅ 字体上传成功");

            } catch (err) {
                showToast("❌ 字体加载失败: " + err.message);
            }
        }
    }

    // 6. 从数据库加载自定义字体 (开机用)
    async function loadCustomFontFromDB() {
        try {
            const file = await dbHelper.get('custom_font_blob');
            if (file) {
                const arrayBuffer = await file.arrayBuffer();
                const fontFace = new FontFace("UserCustomFont", arrayBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);
            }
        } catch (e) {
            console.log("无自定义字体");
        }
    }

    // 7. 渲染列表
    function renderFontList() {
        const container = document.getElementById('font-list-container');
        if(!container) return;
        container.innerHTML = '';

        // 合并系统字体和当前自定义字体(如果存在)
        let displayList = [...systemFonts];
        if (currentFontConfig.isCustom) {
            displayList.push({ name: currentFontConfig.name, family: "UserCustomFont", isCustom: true });
        }

        displayList.forEach((font, index) => {
            const isSelected = currentFontConfig.family === font.family;
            const item = document.createElement('div');
            item.className = 'ai-list-item'; // 复用之前的样式

            // 点击逻辑
            item.onclick = () => {
                if(font.isCustom) return; // 自定义的是上传后自动选中的
                selectFont(index);
            };

            item.innerHTML = `
                <div class="ai-item-label full" style="font-family:${font.family}">${font.name}</div>
                ${isSelected ? '<span style="color:#0a84ff;font-weight:bold;">✔</span>' : ''}
            `;
            container.appendChild(item);
        });
    }

    function saveFontConfig() {
        localStorage.setItem('userFontConfig', JSON.stringify(currentFontConfig));
    }

    // 恢复默认字体
    function resetFontSettings() {
        // 1. 重置数据
        currentFontConfig = {
            family: systemFonts[0].family,
            name: systemFonts[0].name,
            size: 16,
            weight: 400,
            isCustom: false
        };

        // 2. 恢复 UI 状态
        document.getElementById('range-size').value = 16;
        document.getElementById('range-weight').value = 400;

        // 3. 应用并保存
        applyFontToBody();
        renderFontList();
        saveFontConfig();

        showToast("已恢复系统默认字体");
    }

    // 启动
    initFontSettings();

    // ================== 11. 图标自定义逻辑 (Pro Plus) ==================

    // 定义所有可修改图标的配置 (ID 和 默认背景类名)
    const iconConfig = {
        'home-wallpaper': { defaultClass: 'bg-wallpaper' },
        'home-settings':  { defaultClass: 'bg-settings' },
        'home-chat':      { defaultClass: 'bg-chat' },
        'home-music':     { defaultClass: 'bg-music' },
        'dock-role':      { defaultClass: 'bg-role' },
        'dock-world':     { defaultClass: 'bg-world' },
        'dock-manual':    { defaultClass: 'bg-manual' },
        'dock-gallery':   { defaultClass: 'bg-gallery' }
    };

    let currentEditIconId = null;

    // 1. 初始化
    async function initIconSettings() {
        for (const key in iconConfig) {
            try {
                const blob = await dbHelper.get(`icon_${key}`);
                if (blob) updateAppIconUI(key, blob);
            } catch (e) {}
        }
    }

    // 2. 触发上传
    function triggerIconUpload(key) {
        currentEditIconId = key;
        document.getElementById('icon-file-input').click();
    }

    // 3. 处理文件
    async function handleIconFileSelect(input) {
        if (input.files && input.files[0] && currentEditIconId) {
            const file = input.files[0];
            await dbHelper.save(`icon_${currentEditIconId}`, file);
            updateAppIconUI(currentEditIconId, file);
            showToast("✅ 图标已更换");
            input.value = '';
        }
    }

    // 4. 还原
    async function resetIcon(key) {
        if(confirm('还原为默认图标？')) {
            await dbHelper.save(`icon_${key}`, null);
            updateAppIconUI(key, null);
            showToast("已还原");
        }
    }

    // 5. 更新 UI (核心)
    function updateAppIconUI(key, blob) {
        const url = blob ? URL.createObjectURL(blob) : null;
        const defaultClass = iconConfig[key].defaultClass;

        // 1. 更新主屏幕/Dock上的真实图标
        const realIcon = document.getElementById(`icon-${key}`);
        if (realIcon) {
            const svg = realIcon.querySelector('.app-svg');
            if (url) {
                realIcon.style.backgroundImage = `url(${url})`;
                realIcon.classList.remove(defaultClass); // 移除默认渐变色
                if(svg) svg.style.display = 'none';      // 隐藏图标
            } else {
                realIcon.style.backgroundImage = 'none';
                realIcon.classList.add(defaultClass);    // 恢复默认渐变色
                if(svg) svg.style.display = 'block';     // 显示图标
            }
        }

        // 2. 更新设置页里的预览图标
        const previewIcon = document.getElementById(`preview-${key}`);
        if (previewIcon) {
            const svg = previewIcon.querySelector('.preview-icon-svg');
            if (url) {
                previewIcon.style.backgroundImage = `url(${url})`;
                previewIcon.classList.remove(defaultClass);
                if(svg) svg.style.display = 'none';
            } else {
                previewIcon.style.backgroundImage = 'none';
                previewIcon.classList.add(defaultClass);
                if(svg) svg.style.display = 'block';
            }
        }
    }

    initIconSettings();

    // ================== 12. 角色书逻辑 (Role Book) ==================

    let roleList = [];
    let currentRoleId = null; // 当前查看的角色ID
    let tempRoleAvatar = null; // 编辑时的临时头像

    // 1. 初始化：加载列表
    function initRoleBook() {
        const saved = localStorage.getItem('role_list_meta');
        roleList = saved ? JSON.parse(saved) : [];
        renderRoleList();
    }

    // 2. 渲染列表
    async function renderRoleList() {
        const container = document.getElementById('role-list-container');
        if(!container) return;
        container.innerHTML = '';

        if (roleList.length === 0) {
            container.innerHTML = '<div style="grid-column:span 2; text-align:center; color:#666; padding:50px;">点击右上角 + 新建角色</div>';
            return;
        }

        for (const role of roleList) {
            const card = document.createElement('div');
            card.className = 'role-card';
            card.onclick = () => openRoleDetail(role.id);

            // 获取头像 (从IndexedDB)
            let avatarUrl = '';
            try {
                const blob = await dbHelper.get(`role_${role.id}_avatar`);
                if (blob) avatarUrl = URL.createObjectURL(blob);
            } catch (e) {}

            card.innerHTML = `
                <div class="role-card-img" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : ''}"></div>
                <div class="role-card-info">
                    <div class="role-card-name">${role.name}</div>
                    <div class="role-card-desc">${role.desc}</div>
                </div>
            `;
            container.appendChild(card);
        }
    }

    // 3. 打开编辑弹窗 (新建或编辑)
    function openRoleEditModal(roleId = null) {
        const modal = document.getElementById('modal-role-edit');
        const title = document.getElementById('role-modal-title');
        const nameInput = document.getElementById('role-edit-name');
        const descInput = document.getElementById('role-edit-desc');
        const avatarPreview = document.getElementById('role-edit-avatar-preview');

        tempRoleAvatar = null; // 重置临时头像
        currentRoleId = roleId; // 标记当前ID (如果是null则为新建)

        if (roleId) {
            // 编辑模式：回显数据
            const role = roleList.find(r => r.id === roleId);
            title.textContent = "编辑角色";
            nameInput.value = role.name;
            descInput.value = role.desc;
            // 回显头像
            dbHelper.get(`role_${roleId}_avatar`).then(blob => {
                if(blob) avatarPreview.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                else avatarPreview.style.backgroundImage = 'none';
            });
        } else {
            // 新建模式
            title.textContent = "新建角色";
            nameInput.value = '';
            descInput.value = '';
            avatarPreview.style.backgroundImage = 'none';
            avatarPreview.innerHTML = '<span style="font-size: 24px; color: #666;">+</span>';
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeRoleModal() {
        document.getElementById('modal-role-edit').classList.remove('active');
        setTimeout(() => document.getElementById('modal-role-edit').style.display = 'none', 300);
    }

    // 4. 预览上传的头像
    function previewRoleAvatar(input) {
        if (input.files && input.files[0]) {
            tempRoleAvatar = input.files[0];
            const url = URL.createObjectURL(tempRoleAvatar);
            const preview = document.getElementById('role-edit-avatar-preview');
            preview.style.backgroundImage = `url(${url})`;
            preview.innerHTML = ''; // 清除加号
        }
    }

    // 5. 保存角色数据
    async function saveRoleData() {
        const name = document.getElementById('role-edit-name').value.trim();
        const desc = document.getElementById('role-edit-desc').value.trim();

        if (!name) { showToast("请输入角色昵称"); return; }

        let roleId = currentRoleId;
        if (!roleId) {
            // 新建：生成ID
            roleId = Date.now().toString();
            roleList.push({ id: roleId, name, desc });
        } else {
            // 编辑：更新列表
            const role = roleList.find(r => r.id === roleId);
            role.name = name;
            role.desc = desc;
        }

        // 保存元数据到 LocalStorage
        localStorage.setItem('role_list_meta', JSON.stringify(roleList));

        // 保存头像到 IndexedDB (如果有更新)
        if (tempRoleAvatar) {
            await dbHelper.save(`role_${roleId}_avatar`, tempRoleAvatar);
        }

        showToast("角色已保存");
        closeRoleModal();
        renderRoleList(); // 刷新列表

        // 如果是在详情页编辑的，刷新详情页
        if(document.getElementById('sub-role-detail').classList.contains('active')) {
            openRoleDetail(roleId);
        }
    }

    // 6. 打开详情页
    async function openRoleDetail(id) {
        currentRoleId = id;
        const role = roleList.find(r => r.id === id);
        if (!role) return;

        // 填充文字
        document.getElementById('role-detail-name').textContent = role.name;
        document.getElementById('role-detail-desc').textContent = role.desc;

        // 加载头像
        const avatarBlob = await dbHelper.get(`role_${id}_avatar`);
        const avatarEl = document.getElementById('role-detail-avatar');
        if (avatarBlob) avatarEl.style.backgroundImage = `url(${URL.createObjectURL(avatarBlob)})`;
        else avatarEl.style.backgroundImage = 'none';

        // 加载自定义背景
        const bgBlob = await dbHelper.get(`role_${id}_bg`);
        const bgEl = document.getElementById('role-detail-bg');
        if (bgBlob) bgEl.style.backgroundImage = `url(${URL.createObjectURL(bgBlob)})`;
        else bgEl.style.backgroundImage = 'none'; // 或者设一个默认图

        // 打开页面
        openSubPage('sub-role-detail');
    }

    // 7. 详情页：更换背景图
    function triggerRoleBgUpload() { document.getElementById('role-bg-input').click(); }
    async function handleRoleBgUpload(input) {
        if (input.files && input.files[0] && currentRoleId) {
            const file = input.files[0];
            await dbHelper.save(`role_${currentRoleId}_bg`, file);

            // 即时更新显示
            document.getElementById('role-detail-bg').style.backgroundImage = `url(${URL.createObjectURL(file)})`;
            showToast("背景已更新");
        }
    }

    // 8. 详情页：编辑当前
    function editCurrentRole() {
        openRoleEditModal(currentRoleId);
    }

    // 9. 详情页：删除当前
    async function deleteCurrentRole() {
        if (confirm("确定要删除这个角色吗？无法恢复。")) {
            // 删列表
            roleList = roleList.filter(r => r.id !== currentRoleId);
            localStorage.setItem('role_list_meta', JSON.stringify(roleList));

            // 删图片 (IndexedDB) - 存 null 覆盖
            await dbHelper.save(`role_${currentRoleId}_avatar`, null);
            await dbHelper.save(`role_${currentRoleId}_bg`, null);

            closeSubPage('sub-role-detail');
            renderRoleList();
            showToast("角色已删除");
        }
    }

    // 启动
    initRoleBook();

    // ================== 13. 世界书逻辑 (World Book) ==================

    let worldList = [];
    let currentWorldId = null;

    // 1. 初始化
    function initWorldBook() {
        const saved = localStorage.getItem('world_book_data');
        worldList = saved ? JSON.parse(saved) : [];
        renderWorldList();
    }

    // 2. 渲染列表
    function renderWorldList() {
        const container = document.getElementById('world-list-container');
        if(!container) return;
        container.innerHTML = '';

        if (worldList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:50px;">暂无设定<br>点击右上角 + 添加</div>';
            return;
        }

        // 按时间倒序排列
        const sortedList = [...worldList].reverse();

        sortedList.forEach(item => {
            const card = document.createElement('div');
            card.className = 'world-card';
            card.onclick = () => openWorldDetail(item.id);

            card.innerHTML = `
                <div class="world-icon-box">
                    <svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="world-info">
                    <div class="world-title">${item.title}</div>
                    <div class="world-preview">${item.content}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // 3. 打开/关闭 编辑弹窗
    function openWorldEditModal(id = null) {
        const modal = document.getElementById('modal-world-edit');
        const titleInput = document.getElementById('world-edit-title');
        const contentInput = document.getElementById('world-edit-content');
        const modalTitle = document.getElementById('world-modal-title');

        currentWorldId = id; // 标记当前编辑ID

        if (id) {
            const item = worldList.find(w => w.id === id);
            modalTitle.textContent = "编辑设定";
            titleInput.value = item.title;
            contentInput.value = item.content;
        } else {
            modalTitle.textContent = "新建设定";
            titleInput.value = '';
            contentInput.value = '';
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeWorldModal() {
        document.getElementById('modal-world-edit').classList.remove('active');
        setTimeout(() => document.getElementById('modal-world-edit').style.display = 'none', 300);
    }

    // 4. 保存数据
    function saveWorldData() {
        const title = document.getElementById('world-edit-title').value.trim();
        const content = document.getElementById('world-edit-content').value.trim();

        if (!title) { showToast("请输入标题"); return; }

        if (currentWorldId) {
            // 编辑
            const item = worldList.find(w => w.id === currentWorldId);
            item.title = title;
            item.content = content;
        } else {
            // 新建
            worldList.push({
                id: Date.now().toString(),
                title: title,
                content: content
            });
        }

        localStorage.setItem('world_book_data', JSON.stringify(worldList));
        showToast("设定已保存");
        closeWorldModal();
        renderWorldList();

        // 如果详情页开着，实时更新
        if(document.getElementById('sub-world-detail').classList.contains('active')) {
            document.getElementById('view-world-title').textContent = title;
            document.getElementById('view-world-content').textContent = content;
        }
    }

    // 5. 查看详情
    function openWorldDetail(id) {
        const item = worldList.find(w => w.id === id);
        if (!item) return;

        currentWorldId = id;
        document.getElementById('view-world-title').textContent = item.title;
        document.getElementById('view-world-content').textContent = item.content;

        openSubPage('sub-world-detail');
    }

    function editCurrentWorld() {
        openWorldEditModal(currentWorldId);
    }

    function deleteCurrentWorld() {
        if(confirm('确定要删除这条设定吗？')) {
            worldList = worldList.filter(w => w.id !== currentWorldId);
            localStorage.setItem('world_book_data', JSON.stringify(worldList));
            closeSubPage('sub-world-detail');
            renderWorldList();
            showToast("已删除");
        }
    }

    // 启动
    initWorldBook();

    // ================== 音乐 App 完整逻辑 (修复版) ==================

// 全局变量定义
let appMusicList = [];
let appPlayQueue = [];
let currentAppSongIndex = -1;
let appPlayMode = 0; // 0:顺序, 1:单曲, 2:随机
let tempSongFile = null;
let tempSongCover = null;
const appAudio = new Audio();

// 1. 初始化
function initMusicApp() {
    // 恢复列表数据
    const savedList = localStorage.getItem('app_music_playlist');
    appMusicList = savedList ? JSON.parse(savedList) : [];

    // 恢复全屏背景
    dbHelper.get('music_app_bg').then(blob => {
        if(blob) {
            document.getElementById('full-player-bg').style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
        }
    });

    // 渲染列表 (这就是之前报错找不到的函数)
    renderAppMusicList();

    // 监听播放事件
    appAudio.onended = () => {
        if(appPlayMode === 1) { // 单曲循环
            appAudio.currentTime = 0;
            appAudio.play();
        } else {
            playNextSong();
        }
    };
    appAudio.ontimeupdate = updateFullPlayerUI;
}

// ================== 修复后的列表渲染函数 ==================
async function renderAppMusicList() {
    const container = document.getElementById('app-music-list-container');
    const sheetContainer = document.getElementById('sheet-list-content');

    // 防止页面元素还没加载时报错
    if(!container) return;

    container.innerHTML = '';
    if(sheetContainer) sheetContainer.innerHTML = '';

    if (appMusicList.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#666; margin-top:100px;">暂无歌曲<br>点击右上角 + 添加</div>';
        return;
    }

    // 更新播放队列
    appPlayQueue = [...appMusicList];

    // 定义图标 (使用单引号包裹，防止和HTML的双引号冲突)
    const iconInsert = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;opacity:0.7"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.89 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
    const iconMenu = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;opacity:0.7"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>';

    for (let i = 0; i < appMusicList.length; i++) {
        const song = appMusicList[i];

        let coverUrl = '';
        try {
            const blob = await dbHelper.get('song_cover_' + song.id);
            if(blob) coverUrl = URL.createObjectURL(blob);
        } catch(e){}

        // 生成 HTML 字符串
        const itemHTML = `
            <div class="song-img-box" style="${coverUrl ? 'background-image:url('+coverUrl+')' : ''}"></div>
            <div class="song-info-box" onclick="playAppMusic(${i})">
                <div class="song-list-title">${song.title}</div>
                <div class="song-list-artist">${song.artist}</div>
            </div>

            <div style="display:flex; gap:0px; align-items:center;">
                <button class="song-action-btn" onclick="event.stopPropagation(); playNextImmediately(${i})">
                     ${iconInsert}
                </button>
                <button class="song-action-btn" onclick="event.stopPropagation(); openSongMenu('${song.id}')">
                     ${iconMenu}
                </button>
            </div>
        `;

        // 添加到主列表
        const item = document.createElement('div');
        item.className = 'music-list-item';
        if(i === currentAppSongIndex) item.classList.add('active-playing');
        item.innerHTML = itemHTML;
        container.appendChild(item);

        // 添加到底部 Sheet
        if(sheetContainer) {
            const sheetItem = document.createElement('div');
            sheetItem.className = 'music-list-item';
            sheetItem.innerHTML = itemHTML;
            // Sheet 里点击是播放并关闭
            sheetItem.querySelector('.song-info-box').onclick = function() {
                playAppMusic(i);
                closePlaylistSheet();
            };
            sheetContainer.appendChild(sheetItem);
        }
    }
}

// 补全这两个缺失的功能函数，防止点击报错
function playNextImmediately(index) {
    if (index === currentAppSongIndex) return;
    const song = appPlayQueue[index];
    // 简单提示
    showToast('已设为下一首播放');
    // 如果你要做复杂的插队逻辑，可以在这里操作 appPlayQueue 数组
}

function openSongMenu(songId) {
    if(confirm("确定要删除这首歌吗？")) {
        const index = appMusicList.findIndex(s => s.id === songId);
        if(index > -1) deleteSong(index);
    }
}

// 3. 播放逻辑
async function playAppMusic(index) {
    if (index < 0 || index >= appPlayQueue.length) return;

    currentAppSongIndex = index;
    const song = appPlayQueue[index];

    // A. 设置音频源
    if (song.type === 'file') {
        const audioBlob = await dbHelper.get(`song_audio_${song.id}`);
        if(audioBlob) {
            appAudio.src = URL.createObjectURL(audioBlob);
        } else {
            showToast("音频文件丢失");
            return;
        }
    } else {
        appAudio.src = song.url;
    }

    appAudio.play().catch(e => console.log("播放需要交互"));

    // B. 更新 UI
    updateMiniPlayer(song);
    updateFullPlayerInfo(song);
    renderAppMusicList(); // 更新高亮
}

async function updateMiniPlayer(song) {
    document.getElementById('mini-title').textContent = song.title;
    document.getElementById('mini-artist').textContent = song.artist;
    document.getElementById('mini-play-btn').textContent = "⏸"; // 这里如果有SVG图标会被文字覆盖，最好用 innerHTML 换图标

    const miniCover = document.getElementById('mini-cover');
    const blob = await dbHelper.get(`song_cover_${song.id}`);
    if(blob) miniCover.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
}

async function updateFullPlayerInfo(song) {
    document.getElementById('full-title').textContent = song.title;
    document.getElementById('full-artist').textContent = song.artist;

    // 更新大封面
    const fullCover = document.getElementById('full-cover');
    fullCover.classList.add('playing');
    const blob = await dbHelper.get(`song_cover_${song.id}`);
    if(blob) fullCover.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
    else fullCover.style.backgroundImage = 'none';

    // 歌词
    const lyrics = song.lyrics || "暂无歌词 - 点击添加";
    document.getElementById('current-lyric-line').textContent = lyrics.split('\n')[0];
}

// 4. 播放控制
// --- 更新播放控制逻辑 (同步所有播放器) ---
function togglePlayState() {
    // 1. 核心音频控制
    if (appAudio.paused) {
        appAudio.play();
    } else {
        appAudio.pause();
    }

    // 2. 同步全屏播放器图标
    const fullPlayIcon = document.getElementById('fp-icon-play');
    const fullPauseIcon = document.getElementById('fp-icon-pause');
    const fullCover = document.getElementById('full-cover');
    const miniCover = document.getElementById('mini-cover'); // 迷你封面

    if (appAudio.paused) {
        if(fullPlayIcon) fullPlayIcon.style.display = 'block';
        if(fullPauseIcon) fullPauseIcon.style.display = 'none';
        if(fullCover) fullCover.classList.remove('playing');
        if(miniCover) miniCover.classList.remove('playing');
    } else {
        if(fullPlayIcon) fullPlayIcon.style.display = 'none';
        if(fullPauseIcon) fullPauseIcon.style.display = 'block';
        if(fullCover) fullCover.classList.add('playing');
        if(miniCover) miniCover.classList.add('playing');
    }

    // 3. 同步迷你播放器图标
    const miniPlayIcon = document.getElementById('mini-icon-play');
    const miniPauseIcon = document.getElementById('mini-icon-pause');
    if(miniPlayIcon && miniPauseIcon) {
        if (appAudio.paused) {
            miniPlayIcon.style.display = 'block';
            miniPauseIcon.style.display = 'none';
        } else {
            miniPlayIcon.style.display = 'none';
            miniPauseIcon.style.display = 'block';
        }
    }

    // 4. 【关键】同步悬浮窗图标 (修复你的报错)
    syncPopupPlayIcon();
}

// 5. 弹窗与上传逻辑 (修复 TypeError)
function openMusicUploadModal() {
    // 重置输入框
    document.getElementById('new-song-title').value = '';
    document.getElementById('new-song-artist').value = '';
    document.getElementById('new-song-filename').textContent = '未选择';
    tempSongFile = null;
    tempSongCover = null;

    const modal = document.getElementById('modal-music-upload');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}

function closeMusicUploadModal() {
    const modal = document.getElementById('modal-music-upload');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
}

function handleNewSongFile(input) {
    if (input.files && input.files[0]) {
        tempSongFile = input.files[0];
        document.getElementById('new-song-filename').textContent = tempSongFile.name;
        switchAudioSource('file');
    }
}

function switchAudioSource(type) {
    if(type === 'file') {
        document.getElementById('src-file-area').style.display = 'block';
        document.getElementById('src-url-area').style.display = 'none';
        document.getElementById('btn-src-file').classList.add('active');
        document.getElementById('btn-src-url').classList.remove('active');
    } else {
        document.getElementById('src-file-area').style.display = 'none';
        document.getElementById('src-url-area').style.display = 'block';
        document.getElementById('btn-src-file').classList.remove('active');
        document.getElementById('btn-src-url').classList.add('active');
    }
}

function previewNewSongCover(input) {
    if (input.files && input.files[0]) {
        tempSongCover = input.files[0];
        document.getElementById('upload-cover-preview').style.backgroundImage = `url(${URL.createObjectURL(tempSongCover)})`;
    }
}

async function saveNewSong() {
    const title = document.getElementById('new-song-title').value.trim() || '未知歌曲';
    const artist = document.getElementById('new-song-artist').value.trim() || '未知歌手';
    const isFile = document.getElementById('btn-src-file').classList.contains('active');

    const songId = Date.now().toString();
    const newSong = { id: songId, title, artist, type: isFile ? 'file' : 'url', lyrics: '' };

    showToast("正在保存...");

    if (isFile) {
        if (!tempSongFile) { showToast("请选择MP3文件"); return; }
        await dbHelper.save(`song_audio_${songId}`, tempSongFile);
    } else {
        const url = document.getElementById('new-song-url').value;
        if (!url) { showToast("请输入URL"); return; }
        newSong.url = url;
    }

    if (tempSongCover) {
        await dbHelper.save(`song_cover_${songId}`, tempSongCover);
    }

    appMusicList.push(newSong);
    localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

    closeMusicUploadModal();
    renderAppMusicList();
    showToast("添加成功！");
}

// 删除歌曲
async function deleteSong(index) {
    if(confirm('确定删除吗？')) {
        const song = appMusicList[index];
        appMusicList.splice(index, 1);
        localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));
        await dbHelper.save(`song_audio_${song.id}`, null);
        await dbHelper.save(`song_cover_${song.id}`, null);
        renderAppMusicList();
        showToast("已删除");
    }
}

// 6. 全屏界面交互
function openFullPlayer() {
    document.getElementById('music-view-full').classList.add('active');

    // --- 新增：同步播放状态 ---
    const fullPlayIcon = document.getElementById('fp-icon-play');
    const fullPauseIcon = document.getElementById('fp-icon-pause');
    const fullCover = document.getElementById('full-cover');

    if (appAudio.paused) {
        // 如果是暂停的，显示播放(三角形)
        fullPlayIcon.style.display = 'block';
        fullPauseIcon.style.display = 'none';
        fullCover.classList.remove('playing');
    } else {
        // 如果正在播放，显示暂停(双竖线)
        fullPlayIcon.style.display = 'none';
        fullPauseIcon.style.display = 'block';
        fullCover.classList.add('playing');
    }
    // -----------------------
}
function closeFullPlayer() {
    document.getElementById('music-view-full').classList.remove('active');
}

// ================== 统一 UI 更新逻辑 (全屏 + 悬浮窗) ==================
// --- 更新进度条逻辑 (包含悬浮窗) ---
function updateFullPlayerUI() {
    if(!appAudio.duration) return;

    const current = appAudio.currentTime;
    const total = appAudio.duration;
    const percent = (current / total) * 100;

    // 格式化时间 00:00
    const fmt = (t) => {
        const m = Math.floor(t/60);
        const s = Math.floor(t%60);
        return `${m}:${s<10?'0':''}${s}`;
    };

    const timeStrCurrent = fmt(current);
    const timeStrTotal = fmt(total);

    // 1. 更新全屏播放器
    const fullSlider = document.getElementById('music-slider');
    if(fullSlider) {
        fullSlider.value = percent;
        document.getElementById('time-current').textContent = timeStrCurrent;
        document.getElementById('time-total').textContent = timeStrTotal;
    }

    // 2. 更新悬浮窗播放器 (新增)
    const popupSlider = document.getElementById('popup-slider');
    if(popupSlider) {
        popupSlider.value = percent;
        document.getElementById('popup-time-current').textContent = timeStrCurrent;
        document.getElementById('popup-time-total').textContent = timeStrTotal;
    }
}

function seekAudio(val) {
    if(appAudio.duration) {
        appAudio.currentTime = (val/100) * appAudio.duration;
    }
}

function openPlaylistSheet() {
    document.getElementById('sheet-playlist').style.transform = 'translateY(0)';
}
function closePlaylistSheet() {
    document.getElementById('sheet-playlist').style.transform = 'translateY(100%)';
}

function togglePlayMode() {
    document.getElementById(`icon-mode-${appPlayMode}`).style.display = 'none';
    appPlayMode = (appPlayMode + 1) % 3;
    document.getElementById(`icon-mode-${appPlayMode}`).style.display = 'block';
    showToast(["顺序播放", "单曲循环", "随机播放"][appPlayMode]);
}

// 歌词逻辑
function openLyricsModal() {
    const song = appPlayQueue[currentAppSongIndex];
    if(!song) return;
    document.getElementById('lyrics-input').value = song.lyrics || '';
    const modal = document.getElementById('modal-lyrics');
    modal.style.display = 'flex';
    modal.style.zIndex = '2000';
    setTimeout(()=>modal.classList.add('active'), 10);
}
function saveLyrics() {
    const text = document.getElementById('lyrics-input').value;
    if(currentAppSongIndex >= 0) {
        appPlayQueue[currentAppSongIndex].lyrics = text;
        const id = appPlayQueue[currentAppSongIndex].id;
        const mainItem = appMusicList.find(s => s.id === id);
        if(mainItem) mainItem.lyrics = text;
        localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));
        document.getElementById('current-lyric-line').textContent = text.split('\n')[0];
    }
    document.getElementById('modal-lyrics').classList.remove('active');
    setTimeout(()=>document.getElementById('modal-lyrics').style.display='none',300);
}

// 处理歌词文件导入
function handleLrcFile(input) {
    if(input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            // 把文件内容填入文本框
            document.getElementById('lyrics-input').value = e.target.result;
            showToast("歌词已导入，请点击保存");
        };
        reader.readAsText(input.files[0]);
    }
}

// 插队播放 (下一首)
function playNextImmediately(index) {
    if (index === currentAppSongIndex) return; // 正在放的不用插队
    const song = appPlayQueue[index];

    // 简单的逻辑：先从列表删掉，再插到当前位置后面
    // 注意：这里只是演示逻辑，真实逻辑可能需要处理 appMusicList 和 appPlayQueue 的同步
    // 为了简单，我们只弹个窗提示，或者你可以只做逻辑不删原位置

    // 这里做最简单的：提示
    showToast(`已将《${song.title}》添加到下一首`);
    // 复杂逻辑你可以后续再加，先把按钮显示出来要紧
}

// 打开菜单 (三个点) - 之前写过，这里确认一下
function openSongMenu(songId) {
    // 你的 HTML 里需要有 id="modal-song-menu" 的弹窗结构
    // 如果没有，可以先用 alert 代替，或者补上弹窗 HTML
    if(confirm("确定要删除这首歌吗？")) {
        // 找到 index
        const index = appMusicList.findIndex(s => s.id === songId);
        if(index > -1) deleteSong(index);
    }
}

// ================== 增强版菜单逻辑 ==================

let activeMenuSongId = null; // 记录当前点击的是哪首歌的 ID

// 1. 打开底部菜单
function openSongMenu(songId) {
    activeMenuSongId = songId; // 记住ID
    const modal = document.getElementById('modal-song-menu');
    modal.style.display = 'flex';
    // 强制层级最高
    modal.style.zIndex = '2100';
    setTimeout(() => modal.classList.add('active'), 10);
}

function closeSongMenu() {
    const modal = document.getElementById('modal-song-menu');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
}

// 2. 编辑歌曲逻辑
function openEditSongModal() {
    closeSongMenu(); // 先关掉底部菜单

    // 找到当前歌曲信息
    const song = appMusicList.find(s => s.id === activeMenuSongId);
    if (!song) return;

    // 回显数据
    document.getElementById('edit-title-input').value = song.title;
    document.getElementById('edit-artist-input').value = song.artist;

    // 打开编辑弹窗
    const modal = document.getElementById('modal-edit-song');
    modal.style.display = 'flex';
    modal.style.zIndex = '2200';
    setTimeout(() => modal.classList.add('active'), 10);
}

function closeEditSongModal() {
    const modal = document.getElementById('modal-edit-song');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
}

function saveSongEdit() {
    const newTitle = document.getElementById('edit-title-input').value.trim();
    const newArtist = document.getElementById('edit-artist-input').value.trim();

    if (!newTitle) { showToast("标题不能为空"); return; }

    // 更新内存数据
    const songIndex = appMusicList.findIndex(s => s.id === activeMenuSongId);
    if (songIndex > -1) {
        appMusicList[songIndex].title = newTitle;
        appMusicList[songIndex].artist = newArtist;

        // 更新 localStorage
        localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

        // 刷新列表界面
        renderAppMusicList();

        // 如果正在放这首歌，顺便更新播放器界面
        if (currentAppSongIndex === songIndex) {
            document.getElementById('mini-title').textContent = newTitle;
            document.getElementById('mini-artist').textContent = newArtist;
            document.getElementById('full-title').textContent = newTitle;
            document.getElementById('full-artist').textContent = newArtist;
        }

        showToast("修改已保存");
        closeEditSongModal();
    }
}

// 3. 删除确认逻辑
function openDeleteConfirmModal() {
    closeSongMenu(); // 先关掉底部菜单

    const song = appMusicList.find(s => s.id === activeMenuSongId);
    if(song) {
        document.getElementById('del-song-name').textContent = `《${song.title}》`;
    }

    const modal = document.getElementById('modal-delete-confirm');
    modal.style.display = 'flex';
    modal.style.zIndex = '2200';
    setTimeout(() => modal.classList.add('active'), 10);
}

function closeDeleteConfirmModal() {
    const modal = document.getElementById('modal-delete-confirm');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
}

async function confirmDeleteSong() {
    // 执行删除
    const index = appMusicList.findIndex(s => s.id === activeMenuSongId);
    if (index > -1) {
        // 1. 删数据
        appMusicList.splice(index, 1);
        localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

        // 2. 删文件 (IndexedDB)
        await dbHelper.save(`song_audio_${activeMenuSongId}`, null);
        await dbHelper.save(`song_cover_${activeMenuSongId}`, null);

        // 3. 刷新界面
        renderAppMusicList();
        showToast("已删除");

        // 如果删的是当前正在放的，停止播放
        if (index === currentAppSongIndex) {
            appAudio.pause();
            appAudio.src = "";
            document.getElementById('mini-player-bar').style.display = 'none'; // 隐藏播放条
        }
    }
    closeDeleteConfirmModal();
}

// ================== 补全播放器背景上传功能 ==================

// 1. 触发点击隐藏的 input
function triggerMusicBgUpload() {
    const input = document.getElementById('music-bg-input');
    if (input) {
        input.click();
    } else {
        console.error("找不到 id='music-bg-input' 的元素，请检查 HTML");
    }
}

// 2. 处理图片文件
function handleMusicBgUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // 保存到数据库 (下次打开还能记得)
        dbHelper.save('music_app_bg', file);

        // 立即更新界面背景
        const url = URL.createObjectURL(file);

        // 注意：我们之前把背景层改到了 #full-player-bg
        const bgLayer = document.getElementById('full-player-bg');
        if (bgLayer) {
            bgLayer.style.backgroundImage = `url(${url})`;
            showToast("播放器背景已更新");
        }
    }
}

// 启动
initMusicApp();

    // ================== 灵动岛核心逻辑 (修复完整版) ==================

// 默认配置
let islandConfig = {
    master: true,
    charge: true,
    music: true
};
let islandTimer = null;

// 1. 初始化
function initDynamicIsland() {
    const saved = localStorage.getItem('island_config');
    if (saved) islandConfig = JSON.parse(saved);

    // 初始化 UI 状态
    updateIslandState();

    // 更新设置页开关显示 (防止报错)
    const swCharge = document.getElementById('switch-island-charge');
    const swMusic = document.getElementById('switch-island-music');
    if(swCharge) swCharge.checked = islandConfig.charge;
    if(swMusic) swMusic.checked = islandConfig.music;

    // 绑定电池监听
    if ('getBattery' in navigator) {
        navigator.getBattery().then(b => {
            b.addEventListener('chargingchange', () => {
                if (b.charging) {
                    triggerIsland('charge', { text: Math.round(b.level * 100) + '%' });
                }
            });
        });
    }

    // 绑定音乐监听
    appAudio.addEventListener('play', () => {
        const currentSong = appPlayQueue[currentAppSongIndex];
        const title = currentSong ? currentSong.title : '正在播放';
        // 触发展开动画
        triggerIsland('music', { text: title });
    });

    appAudio.addEventListener('pause', () => {
        updateIslandState(); // 暂停时缩回
    });
}

// ================== 修复后的状态刷新函数 ==================
function updateIslandState() {
    const island = document.getElementById('dynamic-island');
    const left = document.getElementById('island-icon');
    const center = document.getElementById('island-text');
    const right = document.getElementById('island-info');

    // A. 音乐常驻模式 (只要正在播放，且没播完)
    if (appAudio && !appAudio.paused && !appAudio.ended) {
        island.className = 'island-container music-active';

        // 核心修复：强制注入波形 HTML
        left.innerHTML = `
            <div class="island-sound-wave">
                <span></span><span></span><span></span><span></span>
            </div>
        `;

        // 清空其他文字，防止干扰
        center.textContent = '';
        right.textContent = '';

        // 点击回音乐App
        island.onclick = () => openApp('app-music');
        return;
    }

    // B. 待机模式
    if (islandConfig.master) {
        island.className = 'island-container idle-show';
        // 清空所有内容
        left.innerHTML = '';
        center.textContent = '';
        right.textContent = '';
        island.onclick = null;
    } else {
        island.className = 'island-container'; // 隐藏
        island.onclick = null;
    }
}

// 3. 触发通知动画 (核心修改：音乐布局)
function triggerIsland(type, data) {
    // 检查子开关 (如果没开对应的功能，就不弹窗，但如果是强制测试则忽略)
    if (type === 'charge' && !islandConfig.charge) return;
    if (type === 'music' && !islandConfig.music) return;

    const island = document.getElementById('dynamic-island');
    const left = document.getElementById('island-icon');
    const center = document.getElementById('island-text');
    const right = document.getElementById('island-info');

    if (islandTimer) clearTimeout(islandTimer);

    // --- 布局填充 ---
    if (type === 'charge') {
        // 充电：左闪电，中文字，右电量
        left.innerHTML = '<span style="color:#34C759">⚡</span>';
        center.innerHTML = 'Charging';
        right.innerHTML = `<span style="color:#34C759">${data.text}</span>`;
    }
    else if (type === 'music') {
        // 音乐：左音符，中歌名+波形，右空
        left.innerHTML = '🎵';
        // 核心修改：歌名旁边加律动效果
        center.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
                <span>${data.text}</span>
                <div class="island-sound-wave">
                    <span style="background:#fff"></span>
                    <span style="background:#fff"></span>
                    <span style="background:#fff"></span>
                </div>
            </div>
        `;
        right.innerHTML = '';
    }

    // 强制展开
    island.classList.remove('idle-show', 'music-active');
    island.classList.add('active');

    // 3秒后自动收缩
    islandTimer = setTimeout(() => {
        island.classList.remove('active');
        updateIslandState(); // 恢复到该有的状态
    }, 3000);
}

// 4. 设置相关函数 (之前缺失的)
function toggleIslandMaster() {
    islandConfig.master = document.getElementById('switch-island-master').checked;
    saveIslandConfig(); // 保存
    updateIslandState(); // 刷新显示
}

// 修复报错：定义保存函数
function saveIslandConfig() {
    const swCharge = document.getElementById('switch-island-charge');
    const swMusic = document.getElementById('switch-island-music');

    // 更新配置
    if(swCharge) islandConfig.charge = swCharge.checked;
    if(swMusic) islandConfig.music = swMusic.checked;

    localStorage.setItem('island_config', JSON.stringify(islandConfig));
}

// 修复报错：定义测试函数
function testIsland(mode) {
    if(mode === 'charge') {
        // 强制触发，忽略开关检查
        const island = document.getElementById('dynamic-island');
        // 临时模拟开关开启以确保能看到效果
        const oldState = islandConfig.charge;
        islandConfig.charge = true;
        triggerIsland('charge', { text: '100%' });
        islandConfig.charge = oldState;
    } else {
        const oldState = islandConfig.music;
        islandConfig.music = true;
        triggerIsland('music', { text: 'Test Song' });
        islandConfig.music = oldState;
    }
}

// ================== 修复版：灵动岛悬浮窗逻辑 ==================

function openIslandPopup() {
    // 1. 安全检查：如果没有正在播放的歌，就不弹窗
    if (currentAppSongIndex < 0 || !appPlayQueue[currentAppSongIndex]) {
        console.log("当前没有播放歌曲");
        return;
    }
    const song = appPlayQueue[currentAppSongIndex];

    // 2. 填充数据
    const titleEl = document.getElementById('popup-title');
    const artistEl = document.getElementById('popup-artist');
    if (titleEl) titleEl.textContent = song.title;
    if (artistEl) artistEl.textContent = song.artist;

    // 填充封面
    dbHelper.get('song_cover_' + song.id).then(blob => {
        const img = blob ? URL.createObjectURL(blob) : '';
        const coverEl = document.getElementById('popup-cover');
        if (coverEl) {
            if (img) coverEl.style.backgroundImage = `url(${img})`;
            else coverEl.style.backgroundImage = 'none';
        }
    });

    // 同步播放按钮
    syncPopupPlayIcon();

    // 3. 显示动画 (核心修复：加了判断是否存在)
    const popup = document.getElementById('island-popup-player');
    const mask = document.getElementById('island-popup-mask');

    if (popup) popup.classList.add('active');
    else console.error("错误：HTML中找不到 id='island-popup-player'");

    if (mask) mask.classList.add('active');
}

function closeIslandPopup() {
    const popup = document.getElementById('island-popup-player');
    const mask = document.getElementById('island-popup-mask');

    if (popup) popup.classList.remove('active');
    if (mask) mask.classList.remove('active');
}

// ================== 修改 updateIslandState (核心绑定) ==================
// 请找到原本的 updateIslandState 函数，修改 if 里的 onclick 绑定

function updateIslandState() {
    const island = document.getElementById('dynamic-island');
    const left = document.getElementById('island-icon');

    // A. 音乐常驻模式
    if (appAudio && !appAudio.paused && !appAudio.ended) {
        island.className = 'island-container music-active';
        left.innerHTML = '<div class="island-sound-wave"><span></span><span></span><span></span><span></span></div>';

        // --- 修改这里：点击改为打开悬浮窗 ---
        island.onclick = () => openIslandPopup();
        // --------------------------------
        return;
    }

    // B. 待机模式
    if (islandConfig.master) {
        island.className = 'island-container idle-show';
        left.innerHTML = '';
        island.onclick = null;
    } else {
        island.className = 'island-container';
        island.onclick = null;
    }
}

// --- 补全缺失的辅助函数 ---
function syncPopupPlayIcon() {
    const playIcon = document.getElementById('popup-icon-play');
    const pauseIcon = document.getElementById('popup-icon-pause');

    // 安全检查，防止报错
    if (!playIcon || !pauseIcon) return;

    if (appAudio.paused) {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
    } else {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
    }
}

// 启动
initDynamicIsland();
</script>
</body>
</html>
