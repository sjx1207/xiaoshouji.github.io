<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Phone UI</title>
    <style>
        /* --- 全局设置 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            /* 换个稍微亮一点的壁纸图，更能显出磨砂玻璃效果 */
            background: url('https://images.unsplash.com/photo-1620121692029-d088224ddc74?q=80&w=2832&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            color: white; position: relative;
        }

        /* --- 1. 状态栏 --- */
        .status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 44px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 22px; z-index: 600;
            font-size: 15px; font-weight: 600; pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .status-right { display: flex; align-items: center; gap: 8px; }
        .battery-group { display: flex; align-items: center; gap: 5px; }
        .battery-shell {
            width: 25px; height: 12px; border: 1px solid rgba(255,255,255,0.5);
            border-radius: 3px; position: relative; padding: 1px; display: flex; align-items: center;
        }
        .battery-shell::after {
            content: ''; position: absolute; right: -4px; top: 50%; transform: translateY(-50%);
            width: 2px; height: 4px; background: rgba(255,255,255,0.5); border-radius: 0 2px 2px 0;
        }
        .battery-level { height: 100%; width: 100%; background-color: white; border-radius: 1px; }
        .charging-icon { display: none; font-size: 10px; color: #FFD700; }
        .signal-bars { display: flex; align-items: flex-end; gap: 2px; height: 12px; }
        .bar { width: 3px; background: rgba(255,255,255,0.3); border-radius: 1px; }
        .bar.active { background: white; }
        .bar:nth-child(1) { height: 4px; } .bar:nth-child(2) { height: 6px; }
        .bar:nth-child(3) { height: 9px; } .bar:nth-child(4) { height: 12px; }

        /* --- 2. 主屏幕滑动容器 --- */
        .home-slider {
            width: 100%; height: 100%; display: flex; overflow-x: auto;
            scroll-snap-type: x mandatory; padding-top: 50px;
        }
        .home-slider::-webkit-scrollbar { display: none; }

        .home-page {
            min-width: 100vw; height: 100%; scroll-snap-align: start;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 15px;
        }

        /* --- 3. 天气小组件 (完美复刻版) --- */
        .widget-weather {
            grid-column: span 2; grid-row: span 2;

            /* [关键] 高斯模糊 + 极淡的白色背景 */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); /* 毛玻璃核心 */
            border: 1px solid rgba(255, 255, 255, 0.15); /* 极细的边框 */
            border-radius: 22px;

            position: relative; /* 为了绝对定位城市名 */
            display: flex; flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */

            padding: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* 城市名：固定左上角 */
        .weather-city {
            position: absolute;
            top: 15px; left: 18px;
            font-size: 15px; font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        /* 中间内容包裹层 */
        .weather-center-content {
            display: flex; flex-direction: column; align-items: center;
            margin-top: 30px; /* 稍微避开顶部的城市名 */
        }

        /* 图标 */
        .weather-svg {
            width: 52px; height: 52px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* 温度：大号白色字体 */
        .weather-temp {
            font-size: 34px; font-weight: 300;
            margin-bottom: 2px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 描述：稍微小一点，带透明度 */
        .weather-desc {
            font-size: 13px; font-weight: 400;
            opacity: 0.8; /* 灰色质感 */
            margin-bottom: 15px;
        }

        /* 底部日期：堆叠居中 */
        .weather-date-info {
            display: flex; flex-direction: column; align-items: center;
            font-size: 12px;
            opacity: 0.6; /* 也是灰色质感 */
            font-weight: 500;
            margin-top: auto; /* 推到底部 */
        }
        .date-row { margin-top: 2px; }


        /* --- 4. Dock 栏 (配合整体风格) --- */
        .dock-container {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 88%; height: 85px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 26px;
            display: flex; justify-content: space-evenly; align-items: center; z-index: 200;
        }
        .app-icon {
            width: 54px; height: 54px; border-radius: 14px;
            background: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            font-size: 26px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.9); }

        /* --- 5. 升级版弹窗样式 (替换原来的弹窗样式) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4); z-index: 500;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; }

        .modal-content {
            width: 85%; max-height: 70%;
            background: rgba(30,30,35,0.9);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            color: white; transform: scale(0.95); transition: all 0.3s;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        /* 标题栏 */
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: 600; }

        /* 搜索栏 */
        .search-box {
            width: 100%; padding: 10px 15px; margin-bottom: 15px;
            background: rgba(255,255,255,0.1); border-radius: 12px;
            border: none; outline: none; color: white; font-size: 14px;
        }
        .search-box::placeholder { color: rgba(255,255,255,0.4); }

        /* 地区分类 Tab */
        .tab-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; padding: 8px; border-radius: 8px;
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6); font-size: 13px; cursor: pointer;
        }
        .tab-btn.active { background: white; color: black; border-color: white; font-weight: 600; }

        /* 城市列表 (滚动区域) */
        .city-list {
            flex: 1; overflow-y: auto; margin-bottom: 15px;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
        }
        .city-item {
            padding: 12px; margin-bottom: 5px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .city-item:active { background: rgba(255,255,255,0.1); }
        .city-item.selected { background: rgba(33, 150, 243, 0.3); border: 1px solid #2196F3; }
        .city-name { font-size: 15px; }
        .city-sub { font-size: 12px; opacity: 0.5; }

        /* 底部按钮组 */
        .modal-footer { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            font-size: 15px; font-weight: 500; cursor: pointer;
        }
        .btn-cancel { background: rgba(255,255,255,0.1); color: white; }
        .btn-save { background: #2196F3; color: white; }

        /* --- 照片小组件样式 --- */
        .widget-photo {
            /* 同样占据 2x2 的格子 */
            grid-column: span 2;
            grid-row: span 2;

            /* 保持和天气组件一样的玻璃风格 */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 22px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);

            /* 布局设置 */
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; /* 保证图片圆角不溢出 */
            cursor: pointer; position: relative;
            transition: transform 0.1s;
        }
        .widget-photo:active { transform: scale(0.96); }

        /* 默认显示的加号提示 */
        .photo-placeholder {
            display: flex; flex-direction: column; align-items: center;
            color: white; opacity: 0.7;
        }
        .plus-icon { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .add-text { font-size: 13px; font-weight: 500; }

        /* 真正显示图片的区域 (默认隐藏) */
        .photo-display {
            width: 100%; height: 100%;
            background-size: cover; background-position: center;
            display: none; /* 选了图再显示 */
        }

        /* --- 5. 音乐小组件 (精修版) --- */
        .widget-music {
            /* 1. 位置和背景 */
            grid-row: span 2;
            grid-column: span 4;
            background: rgba(255, 255, 255, 0.1); /* 背景淡一点 */
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); /* 阴影加重，更有立体感 */

            /* 2. 内部布局 */
            display: flex;
            align-items: center; /* 垂直居中 */
            padding: 20px 25px; /* 增加左右内边距 */
            gap: 20px; /* 封面和右边的间距 */
        }

        /* 封面图 */
        .music-cover {
            width: 85px; height: 85px; /* 稍微放大一点 */
            flex-shrink: 0;
            border-radius: 18px;
            background-size: cover; background-position: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* 封面阴影 */
            cursor: pointer; position: relative; overflow: hidden;
        }
        .music-cover:active { transform: scale(0.95); transition: 0.1s; }

        /* 右侧容器：核心修改 */
        .music-details-container {
            flex: 1;
            height: 85px; /* 强制高度和封面一样，方便对齐 */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 关键：让 歌名(上) 进度条(中) 按钮(下) 均匀分布 */
            overflow: hidden;
        }

        /* 歌名和歌手 */
        .music-text-group { cursor: pointer; }
        .song-title {
            font-size: 17px; font-weight: 700; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .artist-name {
            font-size: 13px; color: rgba(255,255,255,0.7);
            margin-top: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 进度条 */
        .progress-bar-bg {
            width: 100%; height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            cursor: pointer;
            margin-top: auto; margin-bottom: auto; /* 自动居中 */
        }
        .progress-bar-fill {
            width: 0%; height: 100%;
            background: white;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5); /* 进度条发光 */
            transition: width 0.1s linear;
        }

        /* 控制按钮 */
        .music-controls {
            display: flex;
            align-items: center;
            justify-content: center; /* 按钮居中 */
            gap: 25px; /* 按钮之间的间距加大 */
        }
        .control-btn {
            background: none; border: none; padding: 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .control-btn:active { transform: scale(0.85); opacity: 0.8; }

        /* 图标样式 */
        .ctrl-svg {
            width: 24px; height: 24px;
            fill: white; opacity: 0.8;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .play-pause-btn .ctrl-svg {
            width: 32px; height: 32px; /* 播放键更大 */
            opacity: 1;
        }
        /* --- 6. 个人信息小组件 (透明背景) --- */
        .widget-profile {
            /* 占据第5行，第1-2列 */
            grid-row: 5; grid-column: span 2;

            /* 透明背景，无边框阴影 */
            background: transparent;
            box-shadow: none; border: none;

            /* 布局：垂直居中 */
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 10px;
        }

        /* 头像区域 */
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%; /* 圆形 */
            /* 默认头像占位图 (灰色人像) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" opacity="0.5"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
            background-size: cover; background-position: center;
            background-color: rgba(255,255,255,0.1); /* 微弱底色 */
            border: 2px solid rgba(255,255,255,0.3); /* 细白边框 */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; position: relative; overflow: hidden;
            margin-bottom: 10px; transition: transform 0.1s;
        }
        .profile-avatar:active { transform: scale(0.95); }

        /* 文字区域容器 */
        .profile-text { text-align: center; }

        /* 昵称样式 */
        .profile-nickname {
            font-size: 18px; font-weight: 700; color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;
            margin-bottom: 4px;
        }

        /* 个性签名样式 */
        .profile-signature {
            font-size: 13px; color: rgba(255,255,255,0.7);
            cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;
        }

        /* --- 编辑弹窗专用样式 (复用基础结构，微调输入框) --- */
        #profile-edit-input {
            background: rgba(255,255,255,0.15);
            font-size: 16px; padding: 15px;
            text-align: center;
        }

        /* --- 7. App 图标 (液态玻璃终极版) --- */
        .grid-app-item {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }

        /* 液态玻璃主体 */
        .app-icon-shape {
            width: 64px; height: 64px;
            border-radius: 18px; /* 圆角稍微大一点，更像水滴 */
            display: flex; align-items: center; justify-content: center;

            /* 核心1：强力毛玻璃 */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);

            /* 核心2：玻璃质感的边框 (上亮下暗) */
            border-top: 1.5px solid rgba(255, 255, 255, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);

            /* 核心3：内发光 + 外部投影 (制造液态厚度感) */
            box-shadow:
                inset 0 0 15px rgba(255, 255, 255, 0.2), /* 内部通透光 */
                0 8px 20px rgba(0, 0, 0, 0.15); /* 底部柔和投影 */

            margin-bottom: 6px;
            transition: transform 0.1s; cursor: pointer;
            position: relative; overflow: hidden;
        }

        /* 增加一个流光高光层，让它看起来更润 */
        .app-icon-shape::before {
            content: ''; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 40%);
            pointer-events: none;
        }

        .app-icon-shape:active { transform: scale(0.92); filter: brightness(1.1); }

        /* 图标里的 SVG */
        .app-svg {
            width: 30px; height: 30px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); /* 图标悬浮感 */
            z-index: 2; /* 浮在流光上面 */
        }

        .app-label {
            font-size: 12px; font-weight: 500; color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            letter-spacing: 0.3px;
        }

        /* --- 液态特调色 (半透明渐变，透出背景) --- */

        /* 壁纸：液态紫粉 */
        .bg-wallpaper {
            background: linear-gradient(135deg, rgba(199, 158, 253, 0.5) 0%, rgba(246, 128, 132, 0.5) 100%);
        }

        /* 设置：液态银灰 (带一点冷蓝) */
        .bg-settings {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(155, 197, 195, 0.4) 100%);
        }

        /* 聊天：液态薄荷绿 */
        .bg-chat {
            background: linear-gradient(135deg, rgba(66, 230, 149, 0.5) 0%, rgba(59, 178, 184, 0.5) 100%);
        }

        /* 音乐：液态果冻橙 */
        .bg-music {
            background: linear-gradient(135deg, rgba(255, 154, 158, 0.5) 0%, rgba(254, 207, 239, 0.5) 100%);
        }

        /* --- 8. Dock 栏图标 (液态玻璃版) --- */
        .dock-icon {
            width: 55px; height: 55px;
            border-radius: 16px; /* 稍微圆润一点 */
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;

            /* 核心：液态玻璃质感 (和上面保持一致) */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1.5px solid rgba(255, 255, 255, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.25), 0 5px 15px rgba(0, 0, 0, 0.2);

            position: relative; overflow: hidden; transition: transform 0.1s;
        }

        /* 流光效果 */
        .dock-icon::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 50%);
            pointer-events: none;
        }

        .dock-icon:active { transform: scale(0.9); filter: brightness(1.1); }

        /* --- 专属颜色 (半透明液态) --- */

        /* 1. 角色书 (Role Book): 梦幻蓝紫 -> 代表人物灵魂 */
        .bg-role { background: linear-gradient(135deg, rgba(64, 196, 255, 0.6) 0%, rgba(101, 31, 255, 0.6) 100%); }

        /* 2. 世界书 (World Book): 深邃青绿 -> 代表宏大世界 */
        .bg-world { background: linear-gradient(135deg, rgba(29, 233, 182, 0.6) 0%, rgba(0, 105, 92, 0.6) 100%); }

        /* 3. 说明书 (Manual): 温暖琥珀 -> 代表指引 */
        .bg-manual { background: linear-gradient(135deg, rgba(255, 215, 64, 0.6) 0%, rgba(255, 111, 0, 0.6) 100%); }

        /* 4. 图标App (Icons): 炫彩粉红 -> 代表设计与美 */
        .bg-gallery { background: linear-gradient(135deg, rgba(255, 64, 129, 0.6) 0%, rgba(197, 17, 98, 0.6) 100%); }

        /* --- 9. 壁纸 App (全屏覆盖) --- */
        .app-window {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(20, 20, 25, 0.95); /* 深色背景，突出内容 */
            backdrop-filter: blur(20px);
            z-index: 400; /* 盖住主屏幕 */
            display: none; flex-direction: column;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .app-window.active { opacity: 1; }

        /* --- 修改后的头部样式 (适配状态栏) --- */
        .app-header {
            /* 高度加高：44px(状态栏) + 46px(实际标题栏) = 90px */
            height: 90px;
            /* 顶部留白：把内容往下顶，避开状态栏 */
            padding-top: 44px;

            display: flex; align-items: center; justify-content: center;
            position: relative;
            border-bottom: 1px solid rgba(255,255,255,0.1);

            /* 加深一点背景，防止壁纸太花导致看不清状态栏 */
            background: rgba(20, 20, 25, 0.8);
            backdrop-filter: blur(20px);
        }

        .app-back-btn {
            position: absolute;
            left: 15px;
            /* 关键修改：按钮往下移，不再和时间重叠 */
            top: 58px;

            font-size: 16px; color: #2196F3; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
            z-index: 10;
        }

        /* 内容区域 */
        .wallpaper-content {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* 分类标题 */
        .section-title { font-size: 20px; font-weight: 700; margin-bottom: 10px; color: white; }

        /* 预览卡片 */
        .preview-card {
            background: rgba(255,255,255,0.1);
            border-radius: 18px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* 预览视窗 (模拟手机屏幕比例) */
        .preview-viewport {
            width: 160px; height: 284px; /* 约 9:16 比例 */
            background: #333; border-radius: 12px; margin-bottom: 15px;
            overflow: hidden; position: relative;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* 预览图/视频 */
        .preview-img, .preview-video { width: 100%; height: 100%; object-fit: cover; }

        /* 按钮组 */
        .btn-group { display: flex; gap: 10px; width: 100%; }
        .action-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-upload { background: rgba(255,255,255,0.15); color: white; }
        .btn-apply { background: #2196F3; color: white; opacity: 0.5; pointer-events: none; } /* 默认禁用 */
        .btn-apply.ready { opacity: 1; pointer-events: all; }

        /* --- 12. 设置页高级 UI (iOS 分组风格) --- */

        /* 搜索栏容器 */
        .search-container {
            padding: 10px 16px;
            background: #1c1c1e; /* 与页面背景一致 */
            position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.05); /* 极细分割线 */
        }
        /* 搜索输入框 */
        .settings-search {
            width: 100%; height: 38px;
            background: #2c2c2e; /* 稍微亮一点的灰 */
            border-radius: 10px; border: none; outline: none;
            color: white; font-size: 16px; text-align: center;
            transition: all 0.2s;
        }
        .settings-search:focus { text-align: left; padding-left: 36px; background: #3a3a3c; }

        /* 列表容器 */
        #timezone-list-container {
            padding: 0 16px 40px 16px; /* 给底部留点空 */
            background: #000000; /* 纯黑背景，对比卡片 */
        }

        /* 分类标题 (如：亚洲) */
        .group-header {
            font-size: 13px; color: #8e8e93; font-weight: 500;
            margin: 20px 0 8px 12px; /* 留出一点缩进 */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 卡片分组容器 */
        .settings-group {
            background: #1c1c1e; /* 卡片颜色 */
            border-radius: 12px;
            overflow: hidden;
        }

        /* 单个列表项 */
        .settings-item {
            background: transparent;
            padding: 14px 16px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; position: relative;
            transition: background 0.2s;
        }
        .settings-item:active { background: #3a3a3c; }

        /* 分割线 (核心高级感来源：左侧缩进) */
        .settings-item:not(:last-child)::after {
            content: ''; position: absolute;
            bottom: 0; right: 0; height: 0.5px; /* 极细 */
            width: calc(100% - 16px); /* 左侧留出间距 */
            background: #38383a;
        }

        /* 城市文字 */
        .city-name { font-size: 17px; color: white; font-weight: 400; }
        .city-detail { font-size: 12px; color: #8e8e93; margin-top: 2px; }

        /* 选中状态 */
        .check-icon { color: #0a84ff; font-weight: 600; font-size: 16px; display: none; }
        .settings-item.selected .check-icon { display: block; }
        .settings-item.selected .city-name { color: #0a84ff; font-weight: 500; }

        /* --- 关键修复：子页面样式 (没这个点击就没反应) --- */
        .sub-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #1c1c1e; /* 纯黑背景 */
            z-index: 500; /* 层级要高 */
            display: flex; flex-direction: column;
            transform: translateX(100%); /* 默认藏在右边 */
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); /* 滑动动画 */
        }
        .sub-page.active { transform: translateX(0); /* 激活时滑出来 */ }

        /* --- 关键修复：胶囊通知样式 (没这个保存会报错) --- */
        .toast-capsule {
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(255, 255, 255, 0.95); color: #333;
            padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: all 0.4s;
        }
        .toast-capsule.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-icon {
            width: 18px; height: 18px; background: #4CAF50; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;
        }

        /* --- 14. 主题系统 & 代码编辑器 --- */

        /* 浅色模式 (Light Mode) 的覆盖样式 */
        /* 当 body 带有 .light-theme 类名时生效 */
        body.light-theme {
            color: #000000; /* 全局文字变黑 */
        }
        body.light-theme .app-window,
        body.light-theme .sub-page,
        body.light-theme .app-header,
        body.light-theme .search-container,
        body.light-theme .settings-group,
        body.light-theme .preview-card,
        body.light-theme .chat-input-area {
            background: rgba(242, 242, 247, 0.95) !important; /* 变成亮灰白 */
            color: #000;
        }
        body.light-theme .settings-item {
            background: white !important; /* 列表项变纯白 */
            color: #000;
        }
        body.light-theme .app-title,
        body.light-theme .city-name,
        body.light-theme .settings-search {
            color: #000 !important;
        }
        body.light-theme .settings-search {
            background: rgba(118, 118, 128, 0.12); /* 搜索框变浅 */
        }
        body.light-theme .item-value,
        body.light-theme .city-detail,
        body.light-theme .item-arrow {
            color: rgba(60, 60, 67, 0.6) !important;
        }
        body.light-theme .chat-input {
            background: rgba(0,0,0,0.05); color: black;
        }
        body.light-theme .chat-input::placeholder { color: rgba(0,0,0,0.3); }

        /* 代码编辑器样式 */
        .code-editor-container {
            width: 100%; height: 300px;
            background: #1e1e1e; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px; margin-top: 15px;
            font-family: 'Courier New', monospace;
            display: none; /* 默认隐藏，选自定义时显示 */
        }
        .code-textarea {
            width: 100%; height: 100%;
            background: transparent; border: none; outline: none;
            color: #d4d4d4; font-size: 13px; line-height: 1.5;
            resize: none;
        }
        .theme-options { display: flex; gap: 10px; margin-bottom: 15px; }
        .theme-btn {
            flex: 1; padding: 15px; border-radius: 12px;
            background: rgba(255,255,255,0.1); border: 2px solid transparent;
            color: white; font-size: 14px; cursor: pointer; text-align: center;
        }
        .theme-btn.active { border-color: #0a84ff; background: rgba(10, 132, 255, 0.1); }

        /* --- 修复浅色模式下的时区列表背景 --- */
        body.light-theme #timezone-list-container,
        body.light-theme #lang-list-container {
            background: #f2f2f7 !important; /* 变成浅灰色背景 */
        }

        /* 修复浅色模式下的分组标题颜色 */
        body.light-theme .group-header {
            color: #6d6d72 !important; /* 深灰色文字 */
        }

        /* 修复浅色模式下的分割线 */
        body.light-theme .settings-item:not(:last-child)::after {
            background: #c6c6c8 !important;
        }

       /* ================== AI 设置页 (防弹修复版) ================== */

        /* 1. 页面容器：强制允许滚动 */
        #sub-ai-model .wallpaper-content {
            padding: 20px 16px 150px 16px !important; /* 底部留足空间 */
            overflow-y: auto !important;
            height: 100% !important;
            display: block !important; /* 防止 flex 布局导致被挤压 */
        }

        /* 2. 分组卡片：深色背景 */
        .ai-group-card {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            margin-bottom: 24px !important;
            overflow: hidden !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
        }

        /* 3. 单行列表：标准高度，白色文字 */
        .ai-list-item {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 16px !important;
            min-height: 54px !important; /* 保证高度 */
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1) !important;
            background: transparent !important;
        }
        .ai-list-item:last-child { border-bottom: none !important; }
        .ai-list-item:active { background: rgba(255,255,255,0.1) !important; }

        /* 4. 左侧标签 */
        .ai-item-label {
            font-size: 16px !important;
            color: white !important;
            white-space: nowrap !important;
            width: 80px !important; /* 固定宽度 */
            flex-shrink: 0 !important;
        }
        .ai-item-label.blue { color: #0a84ff !important; width: auto !important; flex: 1 !important; }

        /* 5. 右侧输入框/文字：强制白色，无背景 */
        .ai-item-input {
            flex: 1 !important;
            width: 100% !important;
            background: transparent !important;
            border: none !important;
            outline: none !important;
            text-align: right !important;
            font-size: 16px !important;
            color: rgba(255,255,255,0.8) !important; /* 亮灰色 */
            padding: 0 !important;
            height: auto !important;
        }
        .ai-item-input:focus { color: white !important; }
        /* 占位符颜色 */
        .ai-item-input::placeholder { color: rgba(255,255,255,0.3) !important; }

        /* 6. 测试面板：黑底绿字 */
        .ai-test-box {
            background: #1c1c1e !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }
        .ai-test-log {
            background: #000 !important;
            color: #00ff00 !important;
            font-family: monospace !important;
            padding: 15px !important;
            height: 150px !important; /* 固定高度 */
            overflow-y: auto !important;
            font-size: 12px !important;
        }
        .ai-test-input-bar {
            padding: 10px !important;
            background: #2c2c2e !important;
            display: flex !important;
            gap: 10px !important;
        }
        .ai-test-input {
            flex: 1 !important;
            height: 36px !important;
            background: rgba(118, 118, 128, 0.5) !important; /* 灰色背景 */
            border-radius: 18px !important;
            border: none !important;
            padding: 0 15px !important;
            color: white !important;
        }

        /* 标题 */
        .ai-header-text {
            font-size: 13px !important; color: #8e8e93 !important;
            margin: 0 0 8px 12px !important; text-transform: uppercase !important;
        }

        /* ================== 21. AI 设置页浅色模式适配 (Light Mode Patch) ================== */

        /* 1. 页面背景变亮灰 */
        body.light-theme #sub-ai-model,
        body.light-theme #sub-model-select,
        body.light-theme #sub-config-list {
            background: #f2f2f7 !important; /* iOS 浅色背景 */
        }

        /* 2. 卡片变纯白 */
        body.light-theme .ai-group-card {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important; /* 极淡的边框 */
        }

        /* 3. 分割线变浅 */
        body.light-theme .ai-list-item {
            border-bottom: 0.5px solid rgba(60, 60, 67, 0.18) !important; /* 浅灰分割线 */
        }

        /* 4. 左侧文字变黑 */
        body.light-theme .ai-item-label {
            color: #000000 !important;
        }
        /* 蓝色文字保持蓝色，不用改 */

        /* 5. 右侧输入框/文字变深灰 */
        body.light-theme .ai-item-input {
            color: rgba(60, 60, 67, 0.6) !important; /* 次级文字深灰 */
        }
        /* 输入时全黑 */
        body.light-theme .ai-item-input:focus {
            color: #000000 !important;
        }
        /* 占位符浅灰 */
        body.light-theme .ai-item-input::placeholder {
            color: rgba(60, 60, 67, 0.3) !important;
        }

        /* 6. 分组标题变深灰 */
        body.light-theme .ai-header-text {
            color: #6d6d72 !important;
        }

        /* 7. 测试面板适配 */
        body.light-theme .ai-test-box {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
        }
        /* 底部输入栏变浅灰 */
        body.light-theme .ai-test-input-bar {
            background: #f2f2f7 !important;
        }
        /* 输入框变白 */
        body.light-theme .ai-test-input {
            background: #ffffff !important;
            color: #000000 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* 加一点小投影 */
        }

        /* 8. 顶部导航栏适配 */
        body.light-theme .app-header {
            background: rgba(249, 249, 249, 0.9) !important;
            border-bottom: 1px solid rgba(0,0,0,0.1) !important;
        }
        body.light-theme .app-title {
            color: #000000 !important;
        }

        /* ================== 22. 字体设置页 (Font Settings) ================== */

        /* 1. 定义全局变量 (默认值) */
        :root {
            --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --ui-weight: 400;
            --ui-size-adjust: 0px; /* 字体大小微调值 */
        }

        /* 2. 强制应用到全局 */
        body, button, input, select, textarea {
            font-family: var(--ui-font) !important;
            font-weight: var(--ui-weight) !important;
            /* 这里我们用 transform 或者 calc 来微调大小，防止布局炸裂 */
            /* 但为了简单有效，我们在 body 上微调 fontSize */
        }

        /* 3. 字体预览卡片 */
        .font-preview-card {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            padding: 30px 20px !important;
            margin: 0 16px 24px 16px !important;
            text-align: center !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
            transition: all 0.2s;
        }
        .preview-text-en { font-size: 24px; margin-bottom: 10px; display: block; }
        .preview-text-cn { font-size: 20px; opacity: 0.8; display: block; }

        /* 4. 滑块容器 */
        .slider-container {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            padding: 16px !important;
            margin: 0 16px 24px 16px !important;
        }
        .slider-header {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-size: 14px; color: white;
        }

        /* 5. 美化滑块 (Range Input) */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]:focus { outline: none; }
        /* 轨道 */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: rgba(118, 118, 128, 0.24); border-radius: 3px;
        }
        /* 滑块头 */
        input[type=range]::-webkit-slider-thumb {
            height: 24px; width: 24px; border-radius: 50%;
            background: #ffffff; cursor: pointer;
            -webkit-appearance: none; margin-top: -9px; /* 居中 */
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* 浅色模式适配 */
        body.light-theme .font-preview-card,
        body.light-theme .slider-container {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important;
        }
        body.light-theme .slider-header { color: black !important; }

        /* --- 23. 字体页滑动修复补丁 --- */

        /* 强制给字体页内容区加超大底部留白，保证按钮能滑上来 */
        #sub-font .wallpaper-content {
            padding-bottom: 180px !important;
            overflow-y: auto !important;
            height: 100% !important;
            display: block !important; /* 防止 Flex 布局导致无法滚动 */
        }

        /* 修复预览卡片在小屏幕可能太高的问题 */
        .font-preview-card {
            padding: 20px !important;
            margin-bottom: 20px !important;
        }

        /* ================== 24. 字体大小全局联动补丁 ================== */

        :root {
            /* 定义一个默认值，防止JS未加载时变乱 */
            --app-font-size: 16px;
        }

        /* 1. 强制所有主要文字跟随变量 */
        body,
        .settings-item,
        .ai-label,
        .ai-input,
        .form-label,
        .form-input,
        .city-name,
        .chat-input,
        .msg-bubble,
        .song-title,
        .profile-nickname {
            /* 使用 calc 计算，确保优先级最高 */
            font-size: var(--app-font-size) !important;
        }

        /* 2. 标题类 (比正文大 2px) */
        .app-title,
        .preview-text-en,
        .preview-text-cn {
            font-size: calc(var(--app-font-size) + 4px) !important;
        }

        /* 3. 辅助文字类 (比正文小 3px) */
        .city-detail,
        .item-value,
        .ios-header,
        .group-header,
        .ai-section-header,
        .app-label,
        .profile-signature,
        .artist-name {
            font-size: calc(var(--app-font-size) - 3px) !important;
        }

        /* 4. 预览卡片文字跟随 */
        #font-preview-box span {
            font-family: var(--ui-font) !important;
            font-weight: var(--ui-weight) !important;
        }
                /* --- 25. 按钮样式强制补丁 --- */

        /* 按钮容器 */
        .ai-btn-group {
            display: flex !important;
            gap: 15px !important;
            margin: 20px 16px 40px 16px !important;
        }

        /* 按钮通用样式 */
        .ai-btn {
            flex: 1 !important;
            height: 48px !important;
            border-radius: 12px !important;
            border: none !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: opacity 0.2s !important;
        }
        .ai-btn:active { opacity: 0.7 !important; transform: scale(0.98) !important; }

        /* 主按钮 (深蓝) */
        .ai-btn-primary {
            background: #0a84ff !important;
            color: white !important;
        }

        /* 次按钮 (浅蓝透明) */
        .ai-btn-secondary {
            background: rgba(10, 132, 255, 0.15) !important;
            color: #0a84ff !important;
        }

        /* 浅色模式适配 */
        body.light-theme .ai-btn-secondary {
            background: rgba(0, 122, 255, 0.1) !important;
        }

        /* ================== 26. 图标设置 App 样式 ================== */

        /* 图标预览容器 (复用 preview-card，但更紧凑) */
        .icon-preview-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 16px !important;
            padding: 15px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            margin-bottom: 15px !important;
        }

        /* 左侧：图标名称和预览 */
        .icon-info-group {
            display: flex; align-items: center; gap: 15px;
        }

        /* 预览图标本身的形状 (复用主屏幕图标样式) */
        .preview-icon-shape {
            width: 54px; height: 54px;
            border-radius: 14px;
            /* 默认样式，会被 JS 覆盖 */
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
            position: relative; overflow: hidden;
        }

        /* 预览图标里的默认SVG */
        .preview-icon-svg {
            width: 24px; height: 24px; fill: white; opacity: 0.8;
            z-index: 2;
        }

        /* 右侧：按钮组 */
        .icon-btn-group {
            display: flex; gap: 10px;
        }
        /* 小按钮样式 */
        .icon-btn {
            padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none;
        }
        .btn-change { background: rgba(10, 132, 255, 0.15); color: #0a84ff; }
        .btn-reset { background: rgba(255, 59, 48, 0.15); color: #FF3B30; }

        /* 浅色模式适配 */
        body.light-theme .icon-preview-card {
            background: #ffffff !important; border-color: rgba(0,0,0,0.05) !important;
        }
        body.light-theme .preview-icon-shape {
            border-top-color: rgba(255,255,255,0.8);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* ================== 28. 图标显示强制修复补丁 (Final Fix) ================== */

        /* 1. 强制设置背景图大小和位置 (没了这句，图片会放大几十倍导致看不见) */
        #icon-home-wallpaper, #icon-home-settings, #icon-home-chat, #icon-home-music,
        #icon-dock-role, #icon-dock-world, #icon-dock-manual, #icon-dock-gallery,
        .preview-icon-shape {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        /* 2. 当有背景图时，移除默认背景色和模糊 (避免透底) */
        /* 注意：这里使用属性选择器来检测行内样式 */
        .app-icon-shape[style*="background-image"],
        .dock-icon[style*="background-image"],
        .preview-icon-shape[style*="background-image"] {
            background-color: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important; /* 可选：去掉阴影让图片更纯粹 */
            border: none !important;     /* 可选：去掉边框 */
        }

        /* ================== 29. 角色书 App 样式 (列表版) ================== */

        /* 1. 列表容器：改为垂直排列 */
        .role-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
            padding: 10px 0 80px 0 !important; /* 底部留白 */
        }

        /* 2. 角色卡片：横向布局 (左图右文) */
        .role-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 16px !important;
            padding: 15px !important;
            display: flex !important;
            flex-direction: row !important; /* 横向排列 */
            align-items: center !important; /* 垂直居中 */
            border: 1px solid rgba(255,255,255,0.1) !important;
            cursor: pointer !important;
            transition: background 0.2s !important;
        }
        .role-card:active { background: rgba(255,255,255,0.15) !important; }

        /* 3. 头像：变成圆形，固定大小 */
        .role-card-img {
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important; /* 圆形 */
            object-fit: cover !important;
            background-color: #333 !important;
            background-size: cover !important;
            background-position: center !important;
            flex-shrink: 0 !important; /* 禁止压缩 */
            margin-right: 15px !important; /* 和文字的间距 */
            border: 1px solid rgba(255,255,255,0.2) !important;
        }

        /* 4. 文字信息区 */
        .role-card-info {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            overflow: hidden !important; /* 防止文字溢出 */
            padding: 0 !important; /* 去掉之前的内边距 */
        }

        /* 名字 */
        .role-card-name {
            font-size: 17px !important;
            font-weight: 600 !important;
            color: white !important;
            margin-bottom: 4px !important;
        }

        /* 描述 (单行省略) */
        .role-card-desc {
            font-size: 13px !important;
            color: rgba(255,255,255,0.6) !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* --- 角色详情页样式 (保持不变，但确保适配) --- */
        .role-header-bg {
            width: 100%; height: 240px;
            background-color: #333;
            background-size: cover; background-position: center;
            position: relative;
        }
        .role-header-bg::after {
            content: '点击更换背景'; position: absolute; bottom: 10px; right: 10px;
            font-size: 10px; color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.4); padding: 4px 8px; border-radius: 4px;
            backdrop-filter: blur(4px);
        }
        .role-avatar-container {
            margin-top: -60px; display: flex; justify-content: center; position: relative; z-index: 10;
        }
        .role-big-avatar {
            width: 110px; height: 110px; border-radius: 50%;
            border: 4px solid #1c1c1e; /* 深色模式下的描边 */
            background-size: cover; background-position: center; background-color: #444;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .role-detail-content { padding: 15px 20px 100px 20px; text-align: center; }
        .role-detail-name { font-size: 24px; font-weight: 700; color: white; margin-bottom: 10px; }
        .role-detail-desc {
            font-size: 15px; color: rgba(255,255,255,0.85); line-height: 1.6; text-align: left;
            white-space: pre-wrap; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px;
        }

        /* --- 浅色模式适配 (关键要求) --- */
        body.light-theme .role-card {
            background: #ffffff !important; /* 白底 */
            border: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important;
        }
        body.light-theme .role-card-name { color: #000000 !important; }
        body.light-theme .role-card-desc { color: rgba(60,60,67,0.6) !important; }

        /* 详情页浅色适配 */
        body.light-theme .role-big-avatar { border-color: #f2f2f7 !important; } /* 头像描边变白 */
        body.light-theme .role-detail-name { color: #000000 !important; }
        body.light-theme .role-detail-desc { background: #ffffff !important; color: #333 !important; }

        /* ================== 30. 世界书 App 样式 ================== */

        /* 1. 世界书列表项 */
        .world-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 12px !important;
            padding: 16px !important;
            margin-bottom: 12px !important;
            display: flex !important;
            align-items: flex-start !important;
            cursor: pointer !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            transition: background 0.2s !important;
        }
        .world-card:active { background: rgba(255,255,255,0.15) !important; }

        /* 左侧固定图标 */
        .world-icon-box {
            width: 40px; height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #11998e, #38ef7d); /* 青绿色渐变 */
            display: flex; justify-content: center; align-items: center;
            margin-right: 15px; flex-shrink: 0;
        }

        /* 右侧文字 */
        .world-info { flex: 1; overflow: hidden; }
        .world-title { font-size: 17px; font-weight: 600; color: white; margin-bottom: 6px; }
        .world-preview {
            font-size: 13px; color: rgba(255,255,255,0.5);
            display: -webkit-box; -webkit-line-clamp: 2; /* 最多显示2行 */
            -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.5;
        }

        /* 2. 世界书详情页 */
        .world-detail-container {
            padding: 20px;
            height: 100%;
            display: flex; flex-direction: column;
        }
        .world-detail-header {
            font-size: 28px; font-weight: 800; color: white;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .world-detail-body {
            font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.9);
            white-space: pre-wrap; /* 保留换行符 */
            flex: 1; overflow-y: auto;
        }

        /* 浅色模式适配 */
        body.light-theme .world-card { background: white !important; border-color: rgba(0,0,0,0.05) !important; }
        body.light-theme .world-title, body.light-theme .world-detail-header { color: black !important; }
        body.light-theme .world-preview, body.light-theme .world-detail-body { color: #333 !important; }

        /* ================== 音乐 App 终极修复 CSS ================== */

        /* 1. 弹窗层级修复 (强制置顶) */
        .modal-overlay {
            z-index: 2000 !important; /* 必须最高，防止点不动 */
        }

        /* 2. 音乐 App 主窗口容器 */
        #app-music {
            background: #121212; /* 默认黑底 */
            overflow: hidden;
        }

        /* 3. 列表视图 (层级 10) */
        #music-view-list {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex; flex-direction: column;
            background: linear-gradient(180deg, rgba(30,30,30,0.8) 0%, #000 100%); /* 列表自带渐变底 */
        }

        /* 列表头部按钮 (修复重叠元凶) */
        .header-add-btn {
            position: absolute; right: 15px; top: 58px;
            width: 32px; height: 32px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; /* 只要比列表背景高就行 */
        }

        /* 4. 全屏播放器 (层级 100 - 彻底盖住列表) */
        #music-view-full {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; /* 比列表高 */
            display: flex; flex-direction: column;

            /* 关键修复：给一个实心背景，不再依赖透明遮罩 */
            background-color: #1c1c1e;
            /* 动态背景图会覆盖在上面，这里是保底色 */

            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            background: transparent; /* 关键：变成透明，让下面的图片透出来 */
        }

        #music-view-full.active {
            transform: translateY(0);
        }

        /* 全屏动态背景层 */
        /* 修改后：*/
        #full-player-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1c1c1e; /* 关键：默认底色移到这里 */
            background-size: cover; background-position: center;
            z-index: -1;
            /* 如果不想让背景太模糊，可以把 blur(30px) 改小或者去掉 */
            filter: blur(30px);
            transition: background-image 0.5s;
        }

        /* 5. 布局优化 (解决下方空隙) */
        .full-player-content {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: space-evenly; /* 均匀分布 */
            align-items: center;
            padding: 0 30px 40px 30px;
        }

        /* 唱片 (加大尺寸) */
        .disk-wrapper {
            flex: 2; display: flex; align-items: center; justify-content: center;
            width: 100%;
        }
        .disk-cover {
            width: 280px; height: 280px; border-radius: 50%;
            background-color: #333; background-size: cover; background-position: center;
            border: 4px solid rgba(255,255,255,0.1);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            animation: rotate 24s linear infinite; animation-play-state: paused;
        }
        .disk-cover.playing { animation-play-state: running; }

        /* 进度条 */
        .fp-progress-container { width: 100%; margin: 20px 0; }
        .fp-slider {
            width: 100%; height: 4px; background: rgba(255,255,255,0.2);
            border-radius: 2px; -webkit-appearance: none;
        }
        .fp-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: white; border-radius: 50%;
        }
        .time-row {
            display: flex; justify-content: space-between;
            font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;
        }

        /* 6. 图标按钮美化 */
        .fp-controls {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
        }
        .fp-ctrl-btn {
            background: none; border: none; padding: 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: white; /* 确保 SVG 继承颜色 */
        }
        .fp-ctrl-btn svg { fill: white; width: 26px; height: 26px; }
        .fp-ctrl-btn.small svg { width: 22px; height: 22px; opacity: 0.5; }
        .fp-ctrl-btn.big svg { width: 60px; height: 60px; } /* 播放键加大 */
        .fp-ctrl-btn:active { opacity: 0.7; transform: scale(0.95); }

        /* 头部功能按钮 */
        .fp-icon-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: none;
            display: flex; align-items: center; justify-content: center;
            margin-left: 10px; cursor: pointer;
        }
        .fp-icon-btn svg { width: 20px; height: 20px; fill: white; }
                /* --- 1. 修复音乐列表样式 --- */
        .music-list-item {
            display: flex;             /* 让图片和文字横排 */
            align-items: center;       /* 垂直居中 */
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.08); /* 玻璃半透明背景 */
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
        }
        .music-list-item:active { background: rgba(255,255,255,0.15); }
        .music-list-item.active-playing { border-color: #0a84ff; background: rgba(10,132,255,0.1); }

        /* 列表里的封面小图 */
        .song-img-box {
            width: 50px; height: 50px;
            border-radius: 8px;
            background-size: cover; background-position: center;
            background-color: #333;
            margin-right: 15px; flex-shrink: 0;
        }

        /* 列表里的文字区 */
        .song-info-box {
            flex: 1;
            display: flex; flex-direction: column; justify-content: center;
            overflow: hidden;
        }
        .song-list-title { font-size: 16px; font-weight: 600; color: white; margin-bottom: 4px; }
        .song-list-artist { font-size: 13px; color: rgba(255,255,255,0.6); }

        /* 列表里的按钮 */
        .song-action-btn {
            width: 36px; height: 36px;
            border-radius: 50%; border: none; background: transparent;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer;
        }

        /* --- 2. 修复迷你播放器样式 --- */
        .mini-player {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 64px;
            background: rgba(40,40,45,0.95); /* 深色背景 */
            border-radius: 32px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; padding: 0 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 50; /* 保证浮在列表上面 */
        }
        .mini-cover {
            width: 48px; height: 48px; border-radius: 50%;
            background-color: #333; background-size: cover; background-position: center;
            margin-right: 12px; margin-left: 2px;
        }
        .mini-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .mini-title { font-size: 14px; font-weight: 600; color: white; }
        .mini-artist { font-size: 12px; color: #888; }
        .mini-controls { display: flex; gap: 5px; margin-right: 5px; }
        .mini-btn { background: none; border: none; font-size: 20px; color: white; padding: 5px; cursor: pointer; }

        /* --- 3. 修复旋转动画 (如果没转就是少了这段) --- */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
                /* --- 底部动作菜单样式 (Action Sheet) --- */
        .action-sheet-content {
            width: 95%; max-width: 400px;
            z-index: 2100; /* 比遮罩层高 */
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* 激活时滑上来 */
        #modal-song-menu.active .action-sheet-content {
            transform: translateY(0);
        }

        .sheet-group {
            background: rgba(30, 30, 35, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 14px;
            overflow: hidden;
        }

        .sheet-item {
            height: 56px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; color: white;
            cursor: pointer;
            background: transparent;
        }
        .sheet-item:active { background: rgba(255,255,255,0.1); }
                /* ================== 修复补丁：去模糊 & 浅色模式适配 ================== */

        /* 1. 【核心修复】去背景虚化 */
        #full-player-bg {
            filter: none !important; /* 强制去掉模糊 */
            opacity: 1 !important;   /* 强制不透明，显示原图色彩 */
            background-color: #222;  /* 如果没图时的保底色 */
        }

        /* 2. 【核心修复】浅色模式适配 (Light Mode) */

        /* 列表页背景变白 */
        body.light-theme #app-music {
            background: #f2f2f7 !important; /* 浅灰底 */
        }
        body.light-theme #music-view-list {
            background: transparent !important; /* 去掉之前的深色渐变 */
        }

        /* 列表头部文字和按钮变黑 */
        body.light-theme .app-title,
        body.light-theme .app-back-btn {
            color: #000000 !important;
        }
        body.light-theme .app-back-btn svg,
        body.light-theme .header-add-btn svg {
            fill: #000000 !important;
        }
        body.light-theme .header-add-btn {
            background: rgba(0,0,0,0.05) !important;
        }

        /* 列表项变白底黑字 */
        body.light-theme .music-list-item {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        body.light-theme .song-list-title {
            color: #000000 !important;
        }
        body.light-theme .song-list-artist {
            color: rgba(60,60,67,0.6) !important;
        }

        /* 列表右侧的三个点和插队图标 -> 变成黑色 */
        /* 这里使用滤镜直接反转白色图标，省去改 JS 的麻烦 */
        body.light-theme .song-action-btn svg {
            filter: invert(1) !important; /* 白色变黑色 */
            opacity: 0.6;
        }

        /* 迷你播放器适配 */
        body.light-theme .mini-player {
            background: rgba(255,255,255,0.95) !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1) !important;
        }
        body.light-theme .mini-title { color: #000 !important; }
        body.light-theme .mini-controls svg {
            fill: #000 !important; /* 按钮变黑 */
        }

        /* --- 全屏播放器浅色适配 (仅在没有自定义背景图时生效) --- */
        /* 如果用户没传背景图，背景也是浅色的 */
        body.light-theme #full-player-bg {
            background-color: #f2f2f7 !important;
        }

        /* 全屏播放器文字变黑 (为了防止自定义背景图也是浅色看不清，加一点文字阴影) */
        body.light-theme .fp-title {
            color: #000 !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        body.light-theme .fp-artist {
            color: rgba(0,0,0,0.6) !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        body.light-theme #current-lyric-line {
            color: rgba(0,0,0,0.8) !important;
        }
        body.light-theme .time-text,
        body.light-theme #time-current,
        body.light-theme #time-total {
            color: rgba(0,0,0,0.5) !important;
        }

        /* 全屏控制按钮变黑 */
        body.light-theme .fp-ctrl-btn svg,
        body.light-theme .fp-btn svg,
        body.light-theme .fp-icon-btn svg {
            fill: #000000 !important;
        }
        body.light-theme .fp-icon-btn {
            background: rgba(0,0,0,0.05) !important;
        }

        /* 进度条底色变深一点 */
        body.light-theme .fp-slider {
            background: rgba(0,0,0,0.1) !important;
        }
        body.light-theme .fp-slider::-webkit-slider-thumb {
            background: #000000 !important; /* 滑块变黑 */
        }

        /* 底部弹窗 (Action Sheet) 浅色适配 */
        body.light-theme .sheet-group {
            background: rgba(255,255,255,0.95) !important;
        }
        body.light-theme .sheet-item {
            color: #000000 !important;
            border-top-color: rgba(0,0,0,0.1) !important;
        }
                /* --- 迷你播放器图标修复 --- */

        /* 默认样式 (深色模式) */
        .mini-btn svg {
            width: 28px; height: 28px;
            fill: white; /* 默认为白 */
            transition: fill 0.2s;
        }

        /* 浅色模式适配 (核心修复) */
        body.light-theme .mini-btn svg {
            fill: #333333 !important; /* 强制变深灰/黑 */
        }

        /* 按钮点击反馈 */
        .mini-btn:active { opacity: 0.6; transform: scale(0.9); }
                /* ================== 灵动岛逻辑修正 CSS ================== */

        /* 1. 灵动岛容器基础 */
        .island-container {
            position: absolute;
            top: 11px; left: 50%; transform: translateX(-50%);
            background: black;
            border-radius: 20px;
            z-index: 9999;
            /* 关键：默认高度和宽度 */
            width: 0; height: 0; opacity: 0; /* 默认完全隐藏 */

            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        border-radius 0.4s,
                        opacity 0.2s;
            overflow: hidden;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: white;
            pointer-events: none; /* 平时能不能点 */
        }

        /* 状态 A: 待机 (只有开了设置才显示这个小黑条) */
        .island-container.idle-show {
            width: 120px; height: 35px; border-radius: 18px; opacity: 1;
        }

        /* 状态 B: 音乐常驻 (播放音乐时，即使收缩了也要显示波形) */
        .island-container.music-active {
            width: 150px; height: 35px; border-radius: 18px; opacity: 1;
            cursor: pointer; pointer-events: auto;
        }

        /* 状态 C: 展开 (通知弹窗) */
        .island-container.active {
            width: 340px; height: 60px; border-radius: 30px; opacity: 1;
            z-index: 10000;
        }

        /* 内容区域 */
        .island-content {
            width: 100%; height: 100%;
            display: flex; justify-content: space-between; align-items: center;
            opacity: 0; transition: opacity 0.2s;
        }
        /* 展开或音乐常驻时显示内容 */
        .island-container.active .island-content,
        .island-container.music-active .island-content {
            opacity: 1;
        }

        /* 只有在音乐常驻模式下，隐藏中间和右边的文字，只留左边波形 */
        .island-container.music-active .island-center,
        .island-container.music-active .island-right {
            display: none;
        }
        /* 但如果展开了，就显示 */
        .island-container.active .island-center,
        .island-container.active .island-right {
            display: block;
        }
                /* ================== 灵动岛显示修复补丁 ================== */

        /* 1. 音乐常驻状态 (播放中收缩状态) */
        .island-container.music-active {
            width: 130px !important; /* 宽度适中 */
            height: 35px !important;
            border-radius: 18px !important;
            opacity: 1 !important;
            cursor: pointer;
            pointer-events: auto;
            background: black; /* 确保背景黑 */
        }

        /* 2. 核心修复：波形颜色和位置 */
        /* 只要是在灵动岛里的波形，全部强制显示颜色 */
        .island-sound-wave span {
            background-color: #34C759 !important; /* 亮绿色，黑底上很明显 */
            width: 3px !important;
            border-radius: 2px;
            /* 确保动画运行 */
            animation: wave 1s infinite ease-in-out;
        }

        /* 3. 布局控制：常驻模式下只显示左边的波形 */
        .island-container.music-active .island-content {
            opacity: 1 !important;
            justify-content: center !important; /* 居中显示 */
        }

        /* 隐藏中间和右边的文字，防止挤压 */
        .island-container.music-active #island-text,
        .island-container.music-active #island-info {
            display: none !important;
        }

        /* 确保左侧图标区显示 */
        .island-container.music-active #island-icon {
            display: flex !important;
            align-items: center;
            justify-content: center;
            width: 100%; /* 占满整个小岛 */
        }

        /* 4. 动画定义 (防止动画丢失) */
        @keyframes wave {
            0%, 100% { height: 6px; }
            50% { height: 16px; }
        }

        /* 针对不同柱子的延迟，产生律动感 */
        .island-sound-wave span:nth-child(1) { animation-delay: 0.0s; }
        .island-sound-wave span:nth-child(2) { animation-delay: 0.2s; }
        .island-sound-wave span:nth-child(3) { animation-delay: 0.4s; }
        .island-sound-wave span:nth-child(4) { animation-delay: 0.1s; }

                /* ================== 灵动岛显示强制修复 ================== */

        /* 1. 确保灵动岛在最顶层，不被遮挡 */
        #dynamic-island {
            z-index: 2147483647 !important; /* 浏览器允许的最大 Z-Index */
            background: black !important;
        }

        /* 2. 强制波形可见 (关键修复) */
        .island-sound-wave {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 20px !important;
            gap: 3px !important;
        }

        .island-sound-wave span {
            display: block !important;
            background-color: #34C759 !important; /* 亮绿色 */
            width: 3px !important;
            height: 10px !important; /* 给一个默认高度，防止动画没加载时看不见 */
            border-radius: 2px !important;
            animation: wave 1s infinite ease-in-out !important;
        }

        /* 3. 确保常驻模式下的布局正确 */
        .island-container.music-active {
            width: 130px !important;
            height: 35px !important;
            opacity: 1 !important;
            display: flex !important;
        }

        /* 强制显示左侧区域，并居中 */
        .island-container.music-active #island-icon {
            display: flex !important;
            width: 100% !important;
            justify-content: center !important;
            align-items: center !important;
        }

        /* 隐藏不需要的文字 */
        .island-container.music-active #island-text,
        .island-container.music-active #island-info {
            display: none !important;
        }

        /* 定义动画 (防止动画丢失) */
        @keyframes wave {
            0%, 100% { height: 6px; }
            50% { height: 18px; }
        }
                /* ================== 灵动岛动效增强包 (注入灵魂) ================== */

        /* 1. 定义更剧烈的跳动动画 (Wave Rhythm) */
        @keyframes wave-rhythm {
            0% {
                height: 3px;
                opacity: 0.6;
                transform: scaleY(1);
            }
            50% {
                height: 18px; /* 拉得更高，动感更强 */
                opacity: 1;
                transform: scaleY(1.1);
            }
            100% {
                height: 3px;
                opacity: 0.6;
                transform: scaleY(1);
            }
        }

        /* 2. 强制应用动画到波形条 */
        .island-sound-wave span {
            display: block !important;
            width: 3px !important;
            background-color: #34C759 !important; /* 荧光绿 */
            border-radius: 10px !important;
            margin: 0 2px !important; /* 增加间距，别挤在一起 */

            /* 关键：引用上面的新动画，速度加快到 0.6s */
            animation: wave-rhythm 0.6s infinite ease-in-out !important;

            /* 默认起始高度，防止动画加载前不可见 */
            height: 6px;
        }

        /* 3. 错开时间差 (制造波浪感，而不是整齐划一的起立蹲下) */
        .island-sound-wave span:nth-child(1) { animation-delay: 0.0s !important; animation-duration: 0.6s !important; }
        .island-sound-wave span:nth-child(2) { animation-delay: 0.2s !important; animation-duration: 0.8s !important; }
        .island-sound-wave span:nth-child(3) { animation-delay: 0.4s !important; animation-duration: 0.7s !important; }
        .island-sound-wave span:nth-child(4) { animation-delay: 0.1s !important; animation-duration: 0.9s !important; }

        /* 4. 灵动岛容器的“Q弹”变形效果 */
        .island-container {
            /* 使用贝塞尔曲线 (Cubic Bezier) 模拟物理弹簧效果 */
            transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        border-radius 0.5s ease !important;
        }

        /* 5. 确保常驻模式下的容器高度足够容纳跳动 */
        .island-container.music-active {
            align-items: center !important; /* 垂直居中 */
            display: flex !important;
            /* 确保背景纯黑，不然看不清绿色 */
            background: #000000 !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
        }
                /* ================== 灵动岛悬浮播放器 UI (高级深色版) ================== */

        /* 1. 悬浮卡片本体 */
        .island-popup {
            position: fixed;
            top: 11px; left: 50%; transform: translateX(-50%) scale(0.9);
            width: 350px; height: 190px; /* 高度稍微加一点容纳进度条 */
            border-radius: 32px;
            z-index: 9998;
            opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.15);
            transform-origin: top center;
        }

        .island-popup.active {
            opacity: 1; pointer-events: auto;
            top: 55px;
            transform: translateX(-50%) scale(1);
        }

        /* 2. 玻璃背景 */
        .popup-backdrop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 30, 35, 0.85); /* 深色半透明 */
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: 32px;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 0;
        }

        /* 3. 内容布局 */
        .popup-content {
            position: relative; z-index: 1;
            padding: 20px 24px;
            display: flex; flex-direction: column; justify-content: space-between;
            height: 100%;
        }

        /* 上半部分 */
        .popup-top { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }

        .popup-cover {
            width: 56px; height: 56px; border-radius: 10px;
            background-color: #333; background-size: cover; background-position: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .popup-info { flex: 1; overflow: hidden; }
        .popup-title {
            font-size: 17px; font-weight: 600; color: white; margin-bottom: 3px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .popup-artist {
            font-size: 13px; color: rgba(255,255,255,0.6);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 右上角列表按钮 */
        .popup-icon-btn {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white;
        }
        .popup-icon-btn svg { width: 18px; height: 18px; fill: white; opacity: 0.8; }

        /* 进度条区域 */
        .popup-progress {
            display: flex; align-items: center; gap: 8px;
            margin-top: auto; margin-bottom: 10px;
        }
        .time-tiny { font-size: 10px; color: rgba(255,255,255,0.4); width: 25px; text-align: center; }
        .popup-slider {
            flex: 1; height: 3px; border-radius: 2px;
            background: rgba(255,255,255,0.2);
            -webkit-appearance: none;
        }
        .popup-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 10px; height: 10px;
            background: white; border-radius: 50%;
        }

        /* 底部按钮组 */
        .popup-controls {
            display: flex; justify-content: center; align-items: center; gap: 30px;
        }
        .popup-btn {
            background: none; border: none; cursor: pointer;
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
        }
        .popup-btn svg { width: 26px; height: 26px; fill: white; }
        .popup-btn.big svg { width: 42px; height: 42px; }
        .popup-btn:active { opacity: 0.7; transform: scale(0.9); }

        /* 浅色模式适配 (Light Mode) */
        body.light-theme .popup-backdrop {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(0,0,0,0.1);
        }
        body.light-theme .popup-title { color: black; }
        body.light-theme .popup-artist { color: rgba(0,0,0,0.6); }
        body.light-theme .popup-btn svg,
        body.light-theme .popup-icon-btn svg { fill: black; }
        body.light-theme .popup-icon-btn { background: rgba(0,0,0,0.05); }
        body.light-theme .popup-slider { background: rgba(0,0,0,0.1); }
        body.light-theme .popup-slider::-webkit-slider-thumb { background: black; }
        body.light-theme .time-tiny { color: rgba(0,0,0,0.5); }

                /* ================== 一起听歌 UI ================== */

        /* 1. 核心可视化区 */
        .listen-visualizer {
            height: 180px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            position: relative;
            margin-top: 20px;
        }

        /* 头像盒子 */
        .visual-avatar-box {
            display: flex; flex-direction: column; align-items: center;
            z-index: 2; /* 在线上面 */
        }
        .visual-avatar {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #888;
            background-size: cover; background-position: center;
            cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .visual-avatar:active { transform: scale(0.95); }
        .visual-name {
            margin-top: 8px; font-size: 13px; color: white; font-weight: 600;
            max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 1. 连接线区域 (修复居中问题) */
        .visual-connection {
            position: absolute;
            top: 50%; /* 垂直居中基准线 */
            transform: translateY(-50%); /* 向上拉回自身高度的一半，实现完美居中 */

            left: 80px; /* 避开左侧头像宽度 */
            right: 80px; /* 避开右侧头像宽度 */
            height: 100px;

            display: flex; align-items: center; justify-content: center;
            z-index: 1; /* 在头像后面 */
        }

        /* 爱心 */
        .visual-heart {
            font-size: 24px; z-index: 3;
            animation: heart-beat 1.5s infinite ease-in-out;
            filter: drop-shadow(0 0 10px rgba(255,0,0,0.5));
        }
        @keyframes heart-beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* 静态横线 (暂停时显示) */
        .line-static {
            position: absolute; width: 100%; height: 2px;
            background: rgba(255,255,255,0.2);
            display: block;
        }

        /* 2. 心电图线条 (优化描边效果) */
        .line-ekg {
            position: absolute; width: 100%; height: 100%;
            overflow: visible; /* 允许波峰超出一点点 */
            display: none;
        }

        .ekg-path {
            fill: none;
            stroke: #0a84ff;
            stroke-width: 2px; /* 线条细一点更像心率仪 */
            stroke-linejoin: round;
            stroke-linecap: round;

            /* 动画参数 */
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;

            /* 发光效果 */
            filter: drop-shadow(0 0 4px rgba(10, 132, 255, 0.8));
        }

        /* 播放动画：像电流一样快速流过 */
        .visual-connection.playing .line-ekg { display: block; }
        .visual-connection.playing .ekg-path {
            animation: ekg-flow 1.5s linear infinite; /* 加快速度到 1.5s */
        }

        @keyframes ekg-flow {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }

        /* 2. 聊天区域 */
        .listen-chat-area {
            flex: 1; overflow-y: auto;
            padding: 15px; margin-bottom: 10px;
        }
        .chat-msg {
            margin-bottom: 15px; display: flex;
        }
        .chat-msg.system { justify-content: center; opacity: 0.5; font-size: 12px; }
        .chat-msg.left { justify-content: flex-start; }
        .chat-msg.right { justify-content: flex-end; }

        .msg-bubble-listen {
            padding: 10px 14px; border-radius: 18px;
            max-width: 75%; font-size: 15px; line-height: 1.4;
            position: relative;
        }
        .left .msg-bubble-listen { background: rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .right .msg-bubble-listen { background: #0a84ff; color: white; border-bottom-right-radius: 4px; }

        /* 3. 底部输入区 */
        .listen-input-wrapper {
            padding: 10px 15px 30px 15px;
            background: rgba(30,30,35,0.9);
        }
        .listen-input-bar {
            display: flex; gap: 10px; align-items: center;
        }
        #listen-input {
            flex: 1; height: 44px; border-radius: 22px;
            background: rgba(255,255,255,0.1); border: none; outline: none;
            color: white; padding: 0 15px; font-size: 15px;
        }
        .listen-icon-btn {
            width: 44px; height: 44px; border-radius: 50%;
            border: none; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .listen-icon-btn:active { transform: scale(0.9); }
        .listen-icon-btn svg { width: 22px; height: 22px; fill: white; }

        .magic-btn { background: linear-gradient(135deg, #FF2E93, #FF7D54); }
        .send-btn { background: #0a84ff; }

        .listen-clear-btn {
            text-align: center; font-size: 12px; color: rgba(255,255,255,0.4);
            margin-top: 15px; cursor: pointer;
        }
                /* ================== 一起听歌页面的强制修复 ================== */

        #sub-listen-together {
            /* 1. 强制层级最高 (比全屏播放器100高，比弹窗2000低) */
            z-index: 1500 !important;

            /* 2. 强制动画方向：从下往上 (覆盖默认的从右往左) */
            transform: translateY(100%) !important;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) !important;

            /* 3. 确保背景不透明 */
            background-color: #121212 !important;

            /* 4. 确保位置占满全屏 */
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            display: flex !important; /* 确保是 flex 布局 */
        }

        /* 激活状态：滑上来 */
        #sub-listen-together.active {
            transform: translateY(0) !important;
        }
                /* ================== 一起听歌 UI 重构 (浅色适配 & 动效增强) ================== */

        /* 1. 浅色模式适配 (Light Mode) */
        body.light-theme #sub-listen-together {
            background-color: #f2f2f7 !important; /* 背景变灰白 */
        }
        body.light-theme #sub-listen-together .app-title,
        body.light-theme #sub-listen-together .visual-name,
        body.light-theme .chat-msg.system span {
            color: #000000 !important; /* 文字变黑 */
        }
        body.light-theme .app-back-btn svg {
            fill: #000000 !important; /* 返回按钮变黑 */
        }
        body.light-theme .listen-input-wrapper {
            background: #ffffff !important; /* 输入框底色变白 */
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        body.light-theme #listen-input {
            background: #f2f2f7 !important;
            color: #000 !important;
        }
        body.light-theme .line-static {
            background: rgba(0,0,0,0.1) !important; /* 静态线变深灰 */
        }

        /* 2. 可视化区域布局微调 */
        .listen-visualizer {
            height: 200px; /* 高度增加一点 */
            margin-top: 40px;
            padding: 0 30px; /* 两侧留白增加 */
        }

        /* 3. 动感爱心 (重绘) */
        .visual-heart-wrapper {
            position: relative;
            width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            z-index: 5;
            background: #121212; /* 默认黑背景遮挡线条 */
            border-radius: 50%; /* 圆形背景 */
        }
        /* 浅色模式下爱心背景变白 */
        body.light-theme .visual-heart-wrapper { background: #f2f2f7; }

        .visual-heart-icon {
            width: 32px; height: 32px;
            fill: #FF2E93; /* 玫红色 */
            filter: drop-shadow(0 2px 5px rgba(255, 46, 147, 0.4));
            transform-origin: center;
        }

        /* 心跳动画 (Heartbeat) */
        @keyframes heart-pump {
            0% { transform: scale(1); }
            15% { transform: scale(1.25); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
            60% { transform: scale(1); }
            100% { transform: scale(1); }
        }

        /* 播放时心跳 */
        .visual-connection.playing .visual-heart-icon {
            animation: heart-pump 1.2s infinite ease-in-out;
        }

        /* 4. 心电图线条 (ECG) */
        .line-ekg {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            z-index: 1;
            display: none; /* 默认隐藏 */
        }
        .ekg-path {
            fill: none;
            stroke: #0a84ff; /* 科技蓝 */
            stroke-width: 2.5px;
            stroke-linecap: round;
            stroke-linejoin: round;
            /* 虚线效果，用于流动动画 */
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.6)); /* 发光效果 */
        }

        /* 播放时显示线条并开始流动 */
        .visual-connection.playing .line-ekg { display: block; }
        .visual-connection.playing .line-static { display: none; }
        .visual-connection.playing .ekg-path {
            animation: ekg-flow 2.5s linear infinite;
        }

        @keyframes ekg-flow {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }

        /* 3. 静态线 (暂停时) */
        .line-static {
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 2px;
            margin-top: -1px; /* 精确微调 */
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }
        /* 浅色模式适配静态线 */
        body.light-theme .line-static { background: rgba(0,0,0,0.1) !important; }

        /* 6. 修复头像点击区域和样式 */
        .visual-avatar {
            width: 80px; height: 80px; /* 加大头像 */
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.1); /* 更明显的边框 */
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .visual-name { font-size: 14px; margin-top: 12px; opacity: 0.8; }

        /* --- 一起听歌：物理搭桥+动效最终版 --- */

.listen-visualizer {
    height: 160px;
    width: 100%;
    margin-top: 40px;
    position: relative;
    /* 没有任何 flex 干扰，纯绝对定位 */
}

/* --- 1. 头像定位 --- */
.visual-avatar-box {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    width: 70px;
    display: flex; flex-direction: column; align-items: center;
    z-index: 10;
}
.left-box { left: 30px; }
.right-box { right: 30px; }

.visual-avatar {
    width: 64px; height: 64px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; color: rgba(255,255,255,0.5);
    background-color: rgba(30,30,30,0.5);
    border: 2px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s;
}
.visual-name { margin-top: 8px; font-size: 13px; color: #aaa; }

/* 状态样式 */
.visual-avatar.empty { box-shadow: none; }
.visual-avatar.active-me, .visual-avatar.active-role {
    border-color: #FF3B30; color: white;
    /* 增加头像的呼吸光效 */
    box-shadow: 0 0 15px rgba(255, 59, 48, 0.5);
    animation: avatar-glow 2s infinite alternate;
}

/* --- 2. 爱心定位 --- */
.visual-heart-center {
    position: absolute;
    left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: 50px; height: 50px;
    z-index: 10;
    display: flex; align-items: center; justify-content: center;
}
.visual-heart-icon-red {
    width: 42px; height: 42px; fill: #FF3B30;
    filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
    /* 爱心默认跳动 */
    animation: heart-beat-normal 1.2s infinite ease-in-out;
}

/* --- 3. 桥梁连线 (关键动效) --- */
.connection-bridge {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    height: 60px;
    z-index: 5;
    overflow: visible; /* 允许光晕溢出 */
}

.left-bridge {
    left: 100px; right: 50%; margin-right: 25px;
    opacity: 1; transition: opacity 0.5s ease;
}
/* JS 控制显示 */
.left-bridge.show { opacity: 1 !important; }

.right-bridge {
    left: 50%; right: 100px; margin-left: 25px;
}

/* SVG 容器 */
.bridge-svg { width: 100%; height: 100%; overflow: visible; }

/* --- 核心：线条动画 --- */
.line-path {
    fill: none;
    stroke: #FF3B30; /* 红色 */
    stroke-width: 2.5px; /* 线条加粗 */
    stroke-linecap: round;
    stroke-linejoin: round;

    /* 霓虹发光效果 */
    filter: drop-shadow(0 0 6px rgba(255, 59, 48, 0.9));

    /* 关键属性：防止拉伸变形 */
    vector-effect: non-scaling-stroke;

    /* === 动效魔法 === */
    /* 定义虚线：实线段 300px (足够长覆盖整条线)，空隙 300px */
    stroke-dasharray: 300 300;
    /* 初始偏移 300，相当于把实线藏在左边 */
    stroke-dashoffset: 300;
    /* 动画：让偏移量变到 0，实线就会像画出来一样流过去 */
    animation: ekg-draw-anim 1.5s linear infinite;
}

/* 动效关键帧：不断从左往右画线 */
@keyframes ekg-draw-anim {
    to { stroke-dashoffset: 0; }
}

/* 头像呼吸光 */
@keyframes avatar-glow {
    from { box-shadow: 0 0 10px rgba(255, 59, 48, 0.3); }
    to { box-shadow: 0 0 20px rgba(255, 59, 48, 0.8); }
}

/* 爱心跳动 */
@keyframes heart-beat-normal {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}

/* 播放时爱心狂跳 */
.visual-heart-center.beating .visual-heart-icon-red {
    animation: heart-beat-strong 0.8s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
}
@keyframes heart-beat-strong {
    0%, 100% { transform: scale(1); }
    15% { transform: scale(1.35); }
    50% { transform: scale(1); }
}

/* 浅色模式适配 */
body.light-theme .visual-avatar.empty {
    border-color: rgba(0,0,0,0.1); color: #999; background: rgba(0,0,0,0.05);
}

        /* --- 一起听歌：时长计时器样式 --- */
.listen-timer-box {
    text-align: center;
    margin-top: -5px; /* 稍微往上提一点，紧贴着心电图 */
    margin-bottom: 15px;
    z-index: 10;
    color: rgba(255, 255, 255, 0.5); /* 文字稍微暗一点 */
    font-size: 13px;
    /* 关键：防止数字变化时左右抖动 */
    font-variant-numeric: tabular-nums;
    letter-spacing: 1px;
}

#listen-timer-text {
    font-weight: 600;
    color: #FF3B30; /* 和心跳一样的红色，突出时间 */
    margin-left: 6px;
    font-size: 15px;
    text-shadow: 0 0 10px rgba(255, 59, 48, 0.3); /* 微微发光 */
}

/* 浅色模式适配 */
body.light-theme .listen-timer-box {
    color: rgba(0,0,0,0.4);
}

        /* --- 灵动岛悬浮窗遮罩 (点击空白关闭) --- */
#island-popup-mask {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.3); /* 深色半透明背景 */
    z-index: 9990; /* 必须比悬浮窗(9998)低，但比其他元素高 */
    opacity: 0;
    pointer-events: none; /* 默认点透 */
    transition: opacity 0.3s;
}

#island-popup-mask.active {
    opacity: 1;
    pointer-events: auto; /* 激活时阻挡点击 */
}

/* 右上角关闭按钮样式 */
.btn-close-popup {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: white;
    margin-left: 8px; /* 和播放列表按钮拉开距离 */
}
.btn-close-popup:active { background: rgba(255, 255, 255, 0.3); }

        /* --- 角色选择弹窗 & 列表适配 --- */

/* 1. 列表项布局 (头像+名字) */
.role-select-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: background 0.2s;
    border-radius: 12px;
    margin-bottom: 5px;
}
.role-select-item:active { background: rgba(255,255,255,0.1); }

/* 列表里的微型头像 */
.role-tiny-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background-color: #333;
    background-size: cover; background-position: center;
    margin-right: 15px;
    border: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; color: #888;
}

/* 列表里的名字 */
.role-select-name {
    font-size: 16px;
    color: white; /* 默认深色模式为白字 */
    font-weight: 500;
}

/* --- 2. 浅色模式适配 (Light Mode) --- */

/* 弹窗背景变白 */
body.light-theme .modal-content {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15) !important;
}

/* 弹窗标题变黑 */
body.light-theme .modal-title {
    color: #000000 !important;
}

/* 列表项边框变浅 */
body.light-theme .role-select-item {
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
body.light-theme .role-select-item:active {
    background: rgba(0,0,0,0.05);
}

/* 列表文字变黑 (核心修复) */
body.light-theme .role-select-name {
    color: #000000 !important;
}

/* 列表头像边框变浅 */
body.light-theme .role-tiny-avatar {
    border-color: rgba(0,0,0,0.1);
    background-color: #f2f2f7;
}

/* 暂无数据的提示文字变黑 */
body.light-theme #listen-role-list div[style*="color:#666"] {
    color: rgba(0,0,0,0.4) !important;
}

        /* ================== 浅色模式头像修复 (安全版) ================== */

/* 1. 默认状态 (无图片时)：显示白底 + 虚线框 */
body.light-theme .visual-avatar,
body.light-theme .role-card-img,
body.light-theme .role-tiny-avatar {
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
}

/* 2. 空状态：显示浅灰 */
body.light-theme .visual-avatar.empty {
    background-color: #f2f2f7 !important;
    color: #999 !important;
    border: 2px dashed rgba(0,0,0,0.1) !important;
}

/* 3. 【核心】当检测到有图片时：强制背景透明 */
/* 只要 HTML 里有 style="...url..."，就说明 JS 设置了图片 */
body.light-theme .visual-avatar[style*="url"],
body.light-theme .role-card-img[style*="url"],
body.light-theme .role-tiny-avatar[style*="url"],
body.light-theme .profile-avatar[style*="url"] {

    background-color: transparent !important; /* 关键：底色变透明 */

    /* 强制重申图片属性，防止被干扰 */
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;

    border: 1px solid rgba(0,0,0,0.1) !important; /* 保持浅色边框 */
}

/* 4. 选中状态/自己：红圈 (背景依然根据有没有图变透明) */
body.light-theme .visual-avatar.active-me,
body.light-theme .visual-avatar.active-role {
    border: 2px solid #FF3B30 !important;
    color: #FF3B30 !important;
    box-shadow: 0 5px 15px rgba(255, 59, 48, 0.2) !important;
}

        /* ================== 浅色模式输入框看不见修复 ================== */

/* 1. 针对所有通用输入框 (.search-box) 和特定的编辑框 */
body.light-theme .search-box,
body.light-theme #profile-edit-input,
body.light-theme .code-textarea,
body.light-theme input[type="text"],
body.light-theme input[type="password"] {

    /* 核心：文字变成黑色 */
    color: #000000 !important;

    /* 背景变成淡淡的灰色，跟白底区分开 */
    background-color: rgba(0, 0, 0, 0.05) !important;

    /* 加一个极淡的边框，让输入框轮廓更清晰 */
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
}

/* 2. 修复占位符 (Placeholder) 的颜色 */
/* 就是 "请输入昵称" 这种提示文字，也要变成深灰色 */
body.light-theme .search-box::placeholder,
body.light-theme input::placeholder,
body.light-theme textarea::placeholder {
    color: rgba(0, 0, 0, 0.4) !important;
}

/* 3. 输入时的光标颜色 */
body.light-theme input,
body.light-theme textarea {
    caret-color: #007aff !important; /* iOS 蓝光标 */
}

        /* ================== 浅色模式按钮文字修复 ================== */

/* 1. 修复所有弹窗里的“取消”按钮 */
body.light-theme .btn-cancel {
    /* 背景变浅灰，和白底区分开 */
    background-color: rgba(0, 0, 0, 0.05) !important;
    /* 文字变深灰，确保能看见 */
    color: #333333 !important;
}

/* 2. 修复“一起听”页面底部的“清空聊天记录”文字 */
body.light-theme .listen-clear-btn {
    /* 之前的白色半透明改成黑色半透明 */
    color: rgba(0, 0, 0, 0.5) !important;
}

/* 按下时的反馈颜色 */
body.light-theme .listen-clear-btn:active {
    color: #000000 !important;
}

        /* --- 倒数日小组件 (Photo Style) --- */
.widget-countdown {
    grid-column: span 4;
    grid-row: span 2;

    /* 默认背景：极淡的玻璃，不再是灰蒙蒙的 */
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 26px;

    position: relative; overflow: hidden;
    cursor: pointer; transition: transform 0.2s;
    /* 给个阴影让它浮起来 */
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}
.widget-countdown:active { transform: scale(0.98); }

/* 背景图片层 */
.cd-bg-image {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center;
    z-index: 0; display: none; /* 默认隐藏 */
}

/* 黑色渐变遮罩 (保证有图时文字也能看清) */
.cd-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.6));
    z-index: 1;
    pointer-events: none;
}

/* 内容层 (浮在最上面) */
.cd-content-layer {
    position: relative; z-index: 2;
    height: 100%; width: 100%;
    padding: 20px 24px;
    display: flex; flex-direction: column; justify-content: space-between;
    color: white; /* 强制白色文字 */
}

/* 顶部：图标+标题 */
.cd-top-row { display: flex; align-items: center; gap: 10px; }

/* 新设计的图标 */
.cd-icon-box {
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.2); /* 半透明白底 */
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}
.cd-svg-icon {
    width: 18px; height: 18px; fill: white;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.cd-name {
    font-size: 16px; font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
}

/* 中间数字 */
.cd-main-content {
    display: flex; align-items: baseline;
    margin-top: -5px;
}
.cd-number {
    font-size: 68px; font-weight: 300; /* 细体大字 */
    line-height: 1; margin-right: 10px;
    text-shadow: 0 5px 15px rgba(0,0,0,0.3);
    font-variant-numeric: tabular-nums;
}
.cd-meta {
    display: flex; flex-direction: column; justify-content: center;
    font-size: 11px; font-weight: 700; letter-spacing: 1.5px; opacity: 0.8;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* 底部日期 */
.cd-bottom-row {
    display: flex; justify-content: space-between; align-items: center;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 12px;
}
.cd-target-date {
    font-size: 13px; font-family: monospace; opacity: 0.8;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.cd-arrow-icon { width: 18px; height: 18px; fill: white; opacity: 0.6; }

/* 浅色模式适配 */
/* 只有在没背景图时，才变黑字；有背景图时依然保持白字 */
body.light-theme .widget-countdown:not(.has-bg) {
    background: #ffffff;
    border-color: rgba(0,0,0,0.05);
}
body.light-theme .widget-countdown:not(.has-bg) .cd-content-layer {
    color: #333;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-icon-box {
    background: #f0f0f0;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-svg-icon {
    fill: #333;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-bottom-row {
    border-top-color: rgba(0,0,0,0.1);
}
body.light-theme .widget-countdown:not(.has-bg) .cd-arrow-icon {
    fill: #333;
}

        /* ================== 倒数日组件：高颜值重制版 CSS ================== */

.widget-countdown {
    grid-column: span 4;
    grid-row: span 2;

    /* 1. 背景优化：更白的磨砂玻璃，不再发灰 */
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(35px) saturate(180%);
    -webkit-backdrop-filter: blur(35px) saturate(180%);

    border: 1px solid rgba(255, 255, 255, 0.3); /* 亮边框 */
    border-radius: 24px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.15); /* 柔和投影 */

    padding: 24px;
    display: flex; flex-direction: column; justify-content: space-between;
    position: relative; overflow: hidden;
    cursor: pointer; transition: all 0.2s;
    color: white; /* 默认白字 */
}
.widget-countdown:active { transform: scale(0.98); }

/* 背景图片层 */
.cd-bg-image {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center;
    z-index: 0; display: none; transition: opacity 0.3s;
}
/* 有图片时显示的遮罩 */
.cd-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.5));
    z-index: 1; display: none;
}
/* 当有背景图时显示遮罩 */
.widget-countdown.has-bg .cd-overlay { display: block; }

/* 内容层 */
.cd-content-layer {
    position: relative; z-index: 2;
    height: 100%; display: flex; flex-direction: column; justify-content: space-between;
}

/* 顶部：图标 + 标题 */
.cd-top-row { display: flex; align-items: center; gap: 12px; }

.cd-icon-box {
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.9); /* 纯白底色图标 */
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/* 换个好看的图标颜色 */
.cd-svg-icon { width: 20px; height: 20px; fill: #FF3B30; }

.cd-name {
    font-size: 17px; font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    letter-spacing: 0.5px;
}

/* 中间数字 */
.cd-main-content { display: flex; align-items: baseline; margin-top: 5px; }
.cd-number {
    font-size: 64px; font-weight: 400;
    line-height: 1; margin-right: 8px;
    /* 数字带一点渐变光泽 */
    text-shadow: 0 5px 20px rgba(0,0,0,0.2);
    font-family: -apple-system, sans-serif;
}
.cd-meta {
    display: flex; flex-direction: column;
    font-size: 12px; font-weight: 700; opacity: 0.9;
    letter-spacing: 1px;
}

/* 底部 */
.cd-bottom-row {
    border-top: 1px solid rgba(255,255,255,0.3);
    padding-top: 12px; display: flex; justify-content: space-between;
}
.cd-target-date { font-size: 13px; font-weight: 500; opacity: 0.9; }

/* --- 浅色模式适配 (如果没有背景图) --- */
body.light-theme .widget-countdown:not(.has-bg) {
    background: #ffffff !important; /* 纯白卡片 */
    border: 1px solid rgba(0,0,0,0.05) !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08) !important;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-content-layer { color: #333 !important; text-shadow: none !important; }
body.light-theme .widget-countdown:not(.has-bg) .cd-icon-box { background: #f2f2f7 !important; }
body.light-theme .widget-countdown:not(.has-bg) .cd-bottom-row { border-top-color: rgba(0,0,0,0.1) !important; }

        /* --- 新增 App 专属液态渐变色 --- */

/* 日记: 温暖的日记本 (杏色/淡粉) */
.bg-diary { background: linear-gradient(135deg, rgba(255, 226, 159, 0.6) 0%, rgba(255, 167, 81, 0.6) 100%); }

/* 钱包: 金融质感 (宝石蓝) */
.bg-wallet { background: linear-gradient(135deg, rgba(58, 123, 213, 0.6) 0%, rgba(58, 96, 115, 0.6) 100%); }

/* 购物: 促销活力 (橙红色) */
.bg-shop { background: linear-gradient(135deg, rgba(255, 81, 47, 0.6) 0%, rgba(221, 36, 118, 0.6) 100%); }

/* 备忘录: 便签纸 (柠檬黄) */
.bg-memo { background: linear-gradient(135deg, rgba(255, 242, 0, 0.5) 0%, rgba(247, 148, 29, 0.5) 100%); }

/* 论坛: 交流气泡 (紫罗兰) */
.bg-forum { background: linear-gradient(135deg, rgba(161, 140, 209, 0.6) 0%, rgba(251, 194, 235, 0.6) 100%); }

/* 电话: 通讯绿 (青草绿) */
.bg-phone { background: linear-gradient(135deg, rgba(17, 153, 142, 0.6) 0%, rgba(56, 239, 125, 0.6) 100%); }

/* 陪伴: 爱心温暖 (樱花粉) */
.bg-companion { background: linear-gradient(135deg, rgba(255, 154, 158, 0.6) 0%, rgba(254, 207, 239, 0.6) 100%); }

/* 抽卡: 稀有度金光 (彩虹/金) */
.bg-gacha { background: linear-gradient(135deg, rgba(255, 215, 0, 0.6) 0%, rgba(252, 246, 186, 0.6) 50%, rgba(191, 155, 48, 0.6) 100%); }

        /* --- 语音小组件 (Row 5 专属版) --- */
.widget-voice-card {
    grid-column: span 4; /* 占满整行 */
    grid-row: span 1;    /* 占一行高度 */

    /* 玻璃拟态背景 */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 24px;

    display: flex; align-items: center; justify-content: space-between;
    padding: 0 16px; /* 稍微减小内边距 */
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    margin-top: 10px; /* 与上方图标拉开一点距离 */
}

/* 左侧：圆形封面 (上传图片) */
.v-cover-box {
    width: 50px; height: 50px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.15);
    background-size: cover; background-position: center;
    border: 2px solid rgba(255,255,255,0.4);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-shrink: 0;
    transition: transform 0.1s;
}
.v-cover-box:active { transform: scale(0.9); }
.v-plus-mark { font-size: 24px; color: white; font-weight: 300; opacity: 0.8; }

/* 中间：声波区域 (播放/暂停) */
.v-wave-container {
    flex: 1; height: 100%;
    display: flex; align-items: center; justify-content: center;
    gap: 5px; margin: 0 15px;
    cursor: pointer; /* 提示可点击 */
    /* 增加一个隐形的热区背景，方便点击 */
    border-radius: 12px;
}
.v-wave-container:active { background: rgba(255,255,255,0.05); }

/* 波纹条 */
.v-bar {
    width: 4px; border-radius: 4px;
    background: #fff; opacity: 0.9;
    height: 6px; /* 默认静止高度 */
    transition: height 0.2s;
    box-shadow: 0 0 8px rgba(255,255,255,0.4);
}

/* 播放时的律动动画 */
.v-wave-container.playing .v-bar {
    animation: voice-rhythm 1s infinite ease-in-out;
}

@keyframes voice-rhythm {
    0%, 100% { height: 6px; opacity: 0.6; }
    50% { height: 28px; opacity: 1; }
}

/* 给波纹加延迟，制造波浪感 */
.v-bar:nth-child(1) { animation-delay: 0s; }
.v-bar:nth-child(2) { animation-delay: 0.1s; }
.v-bar:nth-child(3) { animation-delay: 0.2s; }
.v-bar:nth-child(4) { animation-delay: 0.3s; }
.v-bar:nth-child(5) { animation-delay: 0.4s; }
.v-bar:nth-child(6) { animation-delay: 0.2s; }
.v-bar:nth-child(7) { animation-delay: 0.1s; }

/* 右侧：星星按钮 (上传音频) - 透明版 */
.v-btn-star {
    width: 50px; height: 50px; /* 稍微加大一点，与左侧对称 */
    border-radius: 50%;

    /* --- 修改部分 开始 --- */
    background: rgba(255, 255, 255, 0.15); /* 透明玻璃背景 */
    border: 2px solid rgba(255,255,255,0.4); /* 与左侧一致的边框 */
    box-shadow: none; /* 去掉金色的阴影 */
    /* --- 修改部分 结束 --- */

    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: transform 0.1s, background-color 0.2s;
}

/* 点击时的效果 */
.v-btn-star:active {
    transform: scale(0.9);
    background-color: rgba(255,255,255,0.3); /* 点击时稍微变亮一点 */
}

/* 星星图标保持白色 */
.v-star-icon {
    width: 24px; height: 24px;
    fill: white;
    opacity: 0.9;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
}

/* 浅色模式适配 */
body.light-theme .widget-voice-card { background: #ffffff; border-color: rgba(0,0,0,0.05); }
body.light-theme .v-cover-box { border-color: rgba(0,0,0,0.1); background-color: #f2f2f7; }
body.light-theme .v-bar { background: #333; box-shadow: none; }
body.light-theme .v-plus-mark { color: #999; }
/* 浅色模式下，星星按钮依然保持金色，因为它是特色按钮 */

        /* ================== 28. 图标显示强制修复补丁 (Final Fix) ================== */

        /* 1. 强制设置背景图大小和位置 (关键修复) */
        /* 把所有图标的 ID 都列在这里，确保图片自动缩放适应 */
        #icon-home-wallpaper, #icon-home-settings, #icon-home-chat, #icon-home-music,
        #icon-dock-role, #icon-dock-world, #icon-dock-manual, #icon-dock-gallery,
        /* --- 下面是第二页新增的 8 个 App --- */
        #icon-home-diary, #icon-home-wallet, #icon-home-shop, #icon-home-memo,
        #icon-home-forum, #icon-home-phone, #icon-home-companion, #icon-home-gacha,
        /* 预览框 */
        .preview-icon-shape {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        /* 2. 当有背景图时，移除默认背景色和模糊 (避免透底) */
        /* 只要检测到有背景图，就让玻璃变透明 */
        .app-icon-shape[style*="background-image"],
        .dock-icon[style*="background-image"],
        .preview-icon-shape[style*="background-image"] {
            background-color: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* ================== 组件背景设置专用 CSS ================== */

/* 1. 核心补丁：当组件有背景图时，移除毛玻璃和默认背景色 */
/* 这样你的图片才能清晰显示，不会被半透明白色遮挡 */
#widget-weather-box[style*="background-image"],
#widget-music-box[style*="background-image"],
#widget-voice-a-box[style*="background-image"],
.widget-preview-shape[style*="background-image"] {
    background-color: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    background-size: cover !important;
    background-position: center !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
    border: none !important; /* 可选：如果有图，去掉边框更沉浸 */
}

/* 2. 设置页里的预览卡片 */
.widget-set-card {
    background: #2c2c2e;
    border-radius: 18px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.1);
}

/* 3. 模拟组件形状的预览框 */
.widget-preview-box {
    width: 100%;
    background: #333; /* 默认深灰底 */
    border-radius: 20px;
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid rgba(255,255,255,0.1);
}

/* 模拟不同组件的比例 */
.ratio-square { aspect-ratio: 1/1; width: 140px; margin: 0 auto 15px auto; } /* 天气 2x2 */
.ratio-rect   { aspect-ratio: 2/1; } /* 音乐 4x2 */
.ratio-strip  { aspect-ratio: 4/1; } /* 语音 4x1 */

/* 预览框里的占位文字 */
.widget-preview-text {
    color: rgba(255,255,255,0.3); font-size: 13px; font-weight: 500; pointer-events: none;
}

/* 预览框本身也要支持毛玻璃 (默认状态) */
.widget-preview-shape {
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    display: flex; align-items: center; justify-content: center;
}

/* 浅色模式适配 */
body.light-theme .widget-set-card { background: #ffffff; border-color: rgba(0,0,0,0.05); }
body.light-theme .widget-preview-box { background: #f2f2f7; border-color: rgba(0,0,0,0.1); }
body.light-theme .widget-preview-shape { background: rgba(255,255,255,0.5); }
body.light-theme .widget-preview-text { color: rgba(0,0,0,0.3); }

        /* ================== 聊天 App 专属样式 ================== */

/* 1. 聊天 App 容器布局 */
#app-chat {
    background: url('https://images.unsplash.com/photo-1557683316-973673baf926?q=80&w=2029&auto=format&fit=crop') no-repeat center center fixed;
    background-size: cover;
}
/* 给聊天背景加一层深色遮罩，防止太花看不清字 */
#app-chat::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.3); z-index: -1;
}

/* 2. 顶部选项卡 (Segmented Control) */
.chat-top-tabs-container {
    padding: 10px 16px;
    /* 玻璃背景 */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    margin: 0 16px 10px 16px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.15);

    display: flex; gap: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.chat-tab-btn {
    flex: 1;
    padding: 8px 0;
    text-align: center;
    font-size: 14px; color: rgba(255,255,255,0.7);
    border-radius: 10px;
    transition: all 0.2s;
    cursor: pointer;
}

/* 选中状态：更亮，轻微背景 */
.chat-tab-btn.active {
    background: rgba(255, 255, 255, 0.2);
    color: white; font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* 3. 中间内容视窗 */
.chat-page-content {
    flex: 1; overflow-y: auto;
    padding: 0 16px 100px 16px; /* 底部留出导航栏的高度 */
    display: none; /* 默认隐藏，JS控制显示 */
}
.chat-page-content.active { display: block; }

/* 占位提示 */
.chat-placeholder-text {
    text-align: center; margin-top: 50px; color: rgba(255,255,255,0.5); font-size: 14px;
}

/* 4. 底部导航栏 (Floating Dock Style) */
.chat-bottom-nav {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    width: 90%; height: 70px;

    /* 强力玻璃质感 */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 35px; /* 两头圆 */
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);

    display: flex; justify-content: space-around; align-items: center;
    z-index: 50;
}

.chat-nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    width: 60px; height: 100%;
    opacity: 0.6; transition: all 0.2s; cursor: pointer;
}
.chat-nav-item.active {
    opacity: 1; transform: translateY(-2px);
}
.chat-nav-item.active svg { fill: #0a84ff; filter: drop-shadow(0 0 8px rgba(10,132,255,0.5)); }
.chat-nav-item.active span { color: white; font-weight: 500; }

.chat-nav-icon { width: 24px; height: 24px; fill: white; margin-bottom: 2px; transition: fill 0.2s; }
.chat-nav-text { font-size: 10px; color: white; }
        /* ================== 聊天 App 背景适配 ================== */

/* 1. 深色模式 (默认) */
#app-chat {
    /* 深色背景图 */
    background: url('https://images.unsplash.com/photo-1557683316-973673baf926?q=80&w=2029&auto=format&fit=crop') no-repeat center center fixed;
    background-size: cover;
    /* 确保文字是白的 */
    color: white;
}

/* 深色模式下的遮罩 (让背景暗一点，突出文字) */
#app-chat::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4);
    z-index: -1;
    pointer-events: none;
}

/* 2. 浅色模式 (Light Mode) */
body.light-theme #app-chat {
    /* 强制覆盖背景图，改为浅灰白 */
    background: #f2f2f7 !important;
    color: #000000 !important;
}

/* 浅色模式下去掉黑色遮罩 */
body.light-theme #app-chat::before {
    display: none !important;
}

/* 浅色模式下标题变黑 */
body.light-theme #app-chat .app-title {
    color: #000000 !important;
}

/* 浅色模式下加号变蓝 (可选，为了好看) */
body.light-theme #app-chat .app-header div[style*="font-size: 24px"] {
    color: #0a84ff !important;
}

        /* ================== 聊天 App 浅色模式字体/图标修复 ================== */

/* 1. 头部导航栏 (Header) */
body.light-theme #app-chat .app-title {
    color: #000000 !important; /* 标题变黑 */
}
body.light-theme #app-chat .app-back-btn {
    color: #007aff !important; /* 返回按钮变 iOS 蓝 */
}
body.light-theme #app-chat .app-back-btn svg {
    fill: #007aff !important; /* 图标变蓝 */
}
/* 右上角的加号 */
body.light-theme #app-chat .app-header div[style*="right: 20px"] {
    color: #007aff !important;
}

/* 2. 顶部选项卡 (Top Tabs) */
body.light-theme .chat-top-tabs-container {
    background: rgba(255, 255, 255, 0.8) !important; /* 背景变白 */
    border: 1px solid rgba(0,0,0,0.05) !important;
}
/* 未选中的 Tab 文字 */
body.light-theme .chat-tab-btn {
    color: #8e8e93 !important; /* 深灰色 */
}
/* 选中的 Tab */
body.light-theme .chat-tab-btn.active {
    background: #ffffff !important; /* 纯白底 */
    color: #000000 !important;      /* 纯黑字 */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

/* 3. 中间内容区 (Content) */
/* 占位文字 (暂无消息...) */
body.light-theme .chat-placeholder-text {
    color: rgba(60, 60, 67, 0.4) !important;
}

/* 好友列表项修复 */
/* 列表背景变白 */
body.light-theme #view-chat-friend div[style*="background:rgba(255,255,255,0.1)"] {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.05) !important;
}
/* 列表文字变黑 */
body.light-theme #view-chat-friend div[style*="color:white"] {
    color: #000000 !important;
}
/* 默认头像背景变浅灰 */
body.light-theme #view-chat-friend div[style*="background:#333"] {
    background: #f2f2f7 !important;
    color: #999 !important;
}

/* 4. 底部导航栏 (Bottom Nav) */
body.light-theme .chat-bottom-nav {
    background: rgba(255, 255, 255, 0.9) !important; /* 变白 */
    border: 1px solid rgba(0,0,0,0.1) !important;
}

/* 未选中的图标和文字 -> 灰色 */
body.light-theme .chat-nav-item .chat-nav-icon {
    fill: #999999 !important;
}
body.light-theme .chat-nav-item .chat-nav-text {
    color: #999999 !important;
}

/* 选中的图标和文字 -> 蓝色 */
body.light-theme .chat-nav-item.active .chat-nav-icon {
    fill: #007aff !important;
}
body.light-theme .chat-nav-item.active .chat-nav-text {
    color: #007aff !important;
}

        /* ================== 聊天创建相关样式 ================== */

/* 1. 操作菜单 (Action Sheet) 复用现有逻辑，增加样式 */
.sheet-icon { width: 20px; height: 20px; margin-right: 10px; fill: #0a84ff; }

/* 2. 创建窗口通用布局 */
.create-chat-tabs {
    display: flex; background: rgba(0,0,0,0.2);
    padding: 4px; border-radius: 10px; margin-bottom: 20px;
}
.create-chat-tab {
    flex: 1; text-align: center; padding: 8px 0;
    font-size: 13px; color: rgba(255,255,255,0.6);
    border-radius: 8px; cursor: pointer; transition: all 0.2s;
}
.create-chat-tab.active {
    background: rgba(255,255,255,0.2); color: white; font-weight: 600;
}

/* 3. 头像上传圆圈 */
.chat-avatar-upload {
    width: 80px; height: 80px; border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 1px dashed rgba(255,255,255,0.3);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; background-size: cover; background-position: center;
    margin: 0 auto 15px auto; transition: all 0.2s;
}
.chat-avatar-upload:active { transform: scale(0.95); }
.chat-avatar-icon { font-size: 24px; color: rgba(255,255,255,0.5); }

/* 4. 群成员动态列表 */
.group-member-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px; background: rgba(255,255,255,0.05);
    border-radius: 12px; margin-bottom: 8px;
}
.group-member-avatar-small {
    width: 44px; height: 44px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    background-size: cover; flex-shrink: 0; cursor: pointer;
}

/* 5. 角色选择列表 (支持多选) */
.role-select-check {
    width: 20px; height: 20px; border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.3);
    margin-left: auto; display: flex; align-items: center; justify-content: center;
}
.role-select-item.selected .role-select-check {
    background: #0a84ff; border-color: #0a84ff;
}
.role-select-item.selected .role-select-check::after {
    content: '✔'; font-size: 12px; color: white;
}

/* --- 浅色模式适配 --- */
body.light-theme .create-chat-tabs { background: rgba(0,0,0,0.05); }
body.light-theme .create-chat-tab { color: #666; }
body.light-theme .create-chat-tab.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
body.light-theme .chat-avatar-upload { background: #f2f2f7; border-color: rgba(0,0,0,0.1); }
body.light-theme .chat-avatar-icon { color: #999; }
body.light-theme .group-member-row { background: rgba(0,0,0,0.03); }
body.light-theme .group-member-avatar-small { background: white; border-color: rgba(0,0,0,0.1); }
body.light-theme .role-select-check { border-color: rgba(0,0,0,0.2); }

        /* ================== 弹窗显示强制修复 ================== */

/* 1. 强制激活时的动画位置 */
/* 这一句是之前漏掉的关键，加上它，弹窗就会乖乖滑上来 */
#modal-chat-type.active .action-sheet-content {
    transform: translateY(0) !important;
}

/* 2. 优化底部间距，防止贴底太紧不好看 */
#modal-chat-type {
    padding-bottom: 30px !important; /* 底部留白 */
    align-items: flex-end !important; /* 确保从底部对齐 */
}

/* 3. 确保内容区样式正确 */
#modal-chat-type .action-sheet-content {
    width: 95% !important;
    max-width: 400px !important;
    margin: 0 auto !important; /* 水平居中 */
    transform: translateY(100%); /* 默认藏在下面 */
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 10001 !important; /* 内容层级最高 */
}

        /* ================== 列表左滑菜单 & 置顶样式 ================== */

/* 1. 列表项容器 (作为滚动容器) */
.chat-swipe-wrapper {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory; /* 关键：滚动吸附 */
    width: 100%;
    border-radius: 16px;
    margin-bottom: 10px;
    background: transparent;
    /* 隐藏滚动条 */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE */
}
.chat-swipe-wrapper::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
}

/* 2. 聊天卡片主体 (宽度占满 100%) */
.chat-main-card {
    min-width: 100%; /* 强制占满视窗宽度 */
    scroll-snap-align: start; /* 吸附点：左边 */

    /* 复用之前的卡片样式，但要去掉 margin，因为 margin 在 wrapper 上了 */
    background: rgba(255,255,255,0.1);
    padding: 15px;
    display: flex; align-items: center;
    box-sizing: border-box;
    transition: background 0.2s;
}
.chat-main-card:active { background: rgba(255,255,255,0.15); }

/* ================== 置顶样式增强版 ================== */

/* 1. 置顶卡片背景：蓝紫色渐变光晕 */
.chat-swipe-wrapper.pinned .chat-main-card {
    /* 深色模式：带有蓝色的磨砂感 */
    background: linear-gradient(90deg, rgba(10, 132, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%) !important;
    border: 1px solid rgba(10, 132, 255, 0.3) !important; /* 蓝色细边框 */
    position: relative; /* 确保角标能定位 */
    overflow: hidden;   /* 确保角标不溢出圆角 */
}

/* 2. 右上角：蓝色三角角标 (用 CSS 画出来的) */
.chat-swipe-wrapper.pinned .chat-main-card::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 0; height: 0;
    /* 画一个三角形 */
    border-style: solid;
    border-width: 0 30px 30px 0;
    border-color: transparent #0a84ff transparent transparent;
    z-index: 2;
}

/* 3. 角标里的小图钉图标 (SVG) */
.chat-swipe-wrapper.pinned .chat-main-card::before {
    content: '';
    position: absolute;
    top: 3px; right: 3px;
    width: 12px; height: 12px;
    /* 白色图钉图标 */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M16 12V4H17V2H7V4H8V12L6 14V16H11V22H13V16H18V14L16 12Z'/%3E%3C/svg%3E");
    background-size: cover;
    z-index: 3;
    transform: rotate(45deg); /* 让图钉正过来 */
}

/* --- 浅色模式适配 (置顶) --- */
body.light-theme .chat-swipe-wrapper.pinned .chat-main-card {
    /* 浅色模式：淡蓝色背景 */
    background: #f0f8ff !important; /* 爱丽丝蓝 */
    border-color: rgba(10, 132, 255, 0.2) !important;
    border-bottom: 1px solid rgba(10, 132, 255, 0.2) !important;
}

/* 3. 右侧操作按钮区 */
.chat-swipe-actions {
    display: flex;
    scroll-snap-align: end; /* 吸附点：右边 */
}

/* 通用按钮样式 */
.swipe-btn {
    width: 70px; /* 两个按钮共 140px */
    height: 100%;
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 600; font-size: 14px;
    letter-spacing: 1px;
}

/* 置顶按钮 (灰色/蓝色) */
.btn-pin { background: #5E5CE6; }
/* 删除按钮 (红色) */
.btn-del { background: #FF453A; }

/* --- 浅色模式适配 --- */
body.light-theme .chat-main-card {
    background: #ffffff; border-bottom: 1px solid rgba(0,0,0,0.05);
}
body.light-theme .chat-main-card:active { background: #f2f2f7; }
body.light-theme .chat-swipe-wrapper.pinned .chat-main-card {
    background: #f2f2f7; border-color: rgba(0,0,0,0.1);
}
/* 浅色模式下按钮保持鲜艳颜色，不用改 */
        /* 删除页浅色适配 */
body.light-theme #sub-chat-delete { background: #f2f2f7 !important; }
body.light-theme #sub-chat-delete .app-title { color: #FF3B30 !important; } /* 标题红 */
body.light-theme #del-chat-target-name { color: black !important; }
body.light-theme .ai-btn-secondary { color: #000 !important; background: rgba(0,0,0,0.05) !important; }

        /* ================== 聊天详情页 (对话界面) ================== */

/* 1. 聊天详情页容器 (修复：去掉 !important，允许 JS 覆盖背景) */
#sub-chat-detail {
    background-color: #1c1c1e; /* 默认深色底 */
    display: flex;
    flex-direction: column;
    /* 关键：确保背景图能铺满 */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}
/* 如果是深色模式，为了看清文字，加一层淡淡的渐变遮罩 */
#sub-chat-detail::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 20%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.4) 100%); [cite: 930]
    pointer-events: none; z-index: -1;
}

/* 2. 头部特殊设计 */
.chat-detail-header {
    height: 100px; /* 含状态栏高度 */
    padding-top: 44px; padding-left: 15px; padding-right: 15px;
    display: flex; align-items: center; justify-content: space-between;
    z-index: 50;
}

/* 液态玻璃圆形按钮 (返回键) */
.glass-circle-btn {
    width: 40px; height: 40px; border-radius: 50%;
    background: rgba(255, 255, 255, 0.15); /* 淡淡的玻璃白 */
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: transform 0.1s;
}
.glass-circle-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.25); }
.glass-circle-btn svg { width: 20px; height: 20px; fill: white; }

/* 中间用户信息 */
.chat-user-info {
    display: flex; flex-direction: column; align-items: center;
}
.chat-user-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background-size: cover; background-position: center; background-color: #333;
    margin-bottom: 2px; border: 1px solid rgba(255,255,255,0.2);
}
.chat-user-name { font-size: 14px; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
.chat-user-status { font-size: 10px; color: #4CD964; font-weight: 500; display:flex; align-items:center; gap:3px;}
.chat-user-status::before { content:''; width:6px; height:6px; background:#4CD964; border-radius:50%; }

/* 3. 消息内容区 */
.chat-detail-body {
    flex: 1; overflow-y: auto;
    padding: 10px 15px 20px 15px;
    display: flex; flex-direction: column; gap: 15px;
}

/* 4. 底部输入栏 (完全透明布局) */
.chat-detail-footer {
    padding: 10px 15px 30px 15px; /* 底部留白给 Home Bar */
    display: flex; align-items: center; gap: 10px;
    background: transparent; /* 背景完全透明 */
}

/* 透明图标按钮 (+, AI, 发送) */
.chat-footer-btn {
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none; /* 无背景 */
    cursor: pointer; transition: transform 0.1s;
}
.chat-footer-btn:active { transform: scale(0.9); opacity: 0.7; }
.chat-footer-btn svg { width: 26px; height: 26px; fill: white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }

/* 长条圆角输入框 */
.chat-input-pill {
    flex: 1; height: 40px;
    background: rgba(255, 255, 255, 0.15); /* 半透明底 */
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    display: flex; align-items: center; padding: 0 15px;
}
.chat-input-real {
    width: 100%; height: 100%;
    background: transparent; border: none; outline: none;
    color: white; font-size: 15px;
}
.chat-input-real::placeholder { color: rgba(255,255,255,0.5); }

/* 2. 浅色模式适配 (修复：只设底色，不挡图片) */
body.light-theme #sub-chat-detail {
    background-color: #f2f2f7 !important; /* 只覆盖颜色，不重置图片 */
    color: #000000 !important;
}
body.light-theme #sub-chat-detail::before { display: none; }

/* 头部适配 */
body.light-theme .glass-circle-btn {
    background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.05);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
body.light-theme .glass-circle-btn svg { fill: #000; }
body.light-theme .chat-user-name { color: #000; text-shadow: none; }

/* 底部适配 */
body.light-theme .chat-footer-btn svg { fill: #007aff; filter: none; }
body.light-theme .chat-input-pill {
    background: #ffffff; border-color: rgba(0,0,0,0.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
body.light-theme .chat-input-real { color: #000; }
body.light-theme .chat-input-real::placeholder { color: #999; }

        /* ================== 消息上下文菜单样式 (Popover Style) ================== */

/* === 修复：确保 Action Sheet 完整显示，增加底部留白 === */

#modal-message-menu {
    /* 核心 FIX：增加底部留白，防止被浏览器或系统 UI 裁切 */
    padding-bottom: 500px !important; /* 从 20px 增加到 40px */

    /* 确保对齐方式正确 */
    align-items: flex-end !important;

    /* 确保层级最高 */
    z-index: 3001 !important;
}

/* 2. 定义 Popover 菜单主体样式 */
.message-popover-menu {
    position: absolute; /* 绝对定位，由 JS 负责坐标 */

    /* 玻璃背景：比气泡主体更深一点的颜色 */
    background: rgba(30, 30, 35, 0.9);
    backdrop-filter: blur(15px);
    border-radius: 12px;
    padding: 5px 0; /* 内部留白 */
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    z-index: 3001; /* 确保菜单在所有内容之上 */
    overflow: hidden;
}

/* 3. 菜单项样式 */
.popover-item {
    padding: 8px 15px;
    font-size: 15px;
    color: white;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.1s;
}
.popover-item:hover, .popover-item:active {
    background: rgba(255, 255, 255, 0.15); /* 悬浮高亮 */
}
.popover-item.action-delete {
    color: #FF3B30; /* 删除键用红色 */
    font-weight: 500;
}

/* 浅色模式适配 */
body.light-theme .message-popover-menu {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0,0,0,0.1);
}
body.light-theme .popover-item { color: #000; }
body.light-theme .popover-item:hover { background: #f2f2f7; }

        /* ================== 聊天输入栏功能菜单样式 (固定 Grid 布局) ================== */

/* 1. 菜单容器 (绝对定位在输入栏上方) */
#chat-input-menu {
    position: absolute;
    bottom: 70px; /* 位于输入框上方，高度刚好避开输入栏 */
    left: 10px;
    right: 10px;

    background: rgba(30, 30, 35, 0.9); /* Opaque dark background */
    backdrop-filter: blur(15px);
    border-radius: 18px; /* 大圆角 */

    padding: 18px 16px 20px 16px; /* 内部留白 */
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);

    /* 动画控制 */
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    z-index: 40;

    display: none; /* 默认隐藏 */
}
#chat-input-menu.active {
    transform: translateY(0);
    display: block; /* 激活时显示 Grid */
}

/* 2. 核心：4x3 网格布局 */
.input-menu-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 列固定 */
    gap: 20px 0; /* 垂直和水平间距 */
    text-align: center;
}

/* 3. 单个菜单项样式 */
.input-menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    opacity: 0.9;
    transition: opacity 0.1s;
}

/* 4. 图标方块和文字 (深色模式) */
.input-menu-icon-square {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.1); /* 玻璃背景，匹配你的深色 App */
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 5px;
}
.input-menu-icon-square svg {
    width: 26px; height: 26px; fill: white;
}
.input-menu-text {
    font-size: 13px;
    color: white;
}

/* 浅色模式适配 */
body.light-theme #chat-input-menu { background: rgba(249, 249, 249, 0.95); }
body.light-theme .input-menu-icon-square { background: #e5e5ea; }
body.light-theme .input-menu-icon-square svg { fill: #333; }
body.light-theme .input-menu-text { color: #333; }

        /* ================== 聊天功能菜单 (横向滑动胶囊版) ================== */

/* 1. 菜单外层容器 (定位) */
#chat-input-menu {
    position: absolute;
    bottom: 70px;
    left: 10px;
    right: 10px;

    /* 这里的样式保持不变 */
    background: transparent;
    z-index: 40;
    transform: translateY(120%); /* 默认藏得更深一点 */
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    display: none;
}

#chat-input-menu.active {
    transform: translateY(0);
    display: block;
}

/* 2. 横向滚动容器 (Flex Row) */
.chat-scroll-menu {
    display: flex;
    flex-direction: row;       /* 强制横向排列 */
    overflow-x: auto;          /* 允许横向滚动 */
    overflow-y: hidden;        /* 禁止纵向滚动 */
    white-space: nowrap;       /* 防止换行 */
    gap: 12px;                 /* 卡片间距 */
    padding-bottom: 10px;      /* 预留滚动条空间(虽然隐藏了) */

    /* 隐藏滚动条 */
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.chat-scroll-menu::-webkit-scrollbar {
    display: none;
}

/* 3. 单个胶囊卡片 (Pill Card) - 透明版 */
.menu-pill-card {
    flex: 0 0 auto;            /* 禁止压缩，保持宽度 */
    height: 56px;
    min-width: 120px;          /* 最小宽度 */

    /* === 核心改动：极度透明的背景和边框 === */
    background: rgba(255, 255, 255, 0.05); /* 只有 5% 不透明度的白色，极淡 */
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); /* 轻微的磨砂模糊 */
    border: 1px solid rgba(255, 255, 255, 0.08); /* 极细微的边框 */
    border-radius: 28px;       /* 胶囊圆角 */

    /* 内部布局：左图右文 */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 20px;
    cursor: pointer;
    transition: transform 0.1s, background 0.2s;
}

.menu-pill-card:active {
    transform: scale(0.96);
    /* 点击时稍微亮一点点，提供反馈 */
    background: rgba(255, 255, 255, 0.15);
}

/* ... (中间的图标和文字样式不用变) ... */

/* 浅色模式适配 (透明版) */
body.light-theme .menu-pill-card {
    /* 浅色模式下用极淡的黑色背景 */
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.05);
    box-shadow: none; /* 移除阴影，更扁平透明 */
}
body.light-theme .menu-pill-card:active {
    background: rgba(0, 0, 0, 0.1);
}

/* 4. 图标与文字 */
.pill-icon {
    width: 24px; height: 24px;
    fill: white;
    margin-right: 10px;        /* 图标和文字的间距 */
}

.pill-text {
    font-size: 15px;
    font-weight: 500;
    color: white;
    letter-spacing: 0.5px;
}

/* 浅色模式适配 */
body.light-theme .menu-pill-card {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
body.light-theme .pill-icon { fill: #333; }
body.light-theme .pill-text { color: #333; }

        /* ================== 强制修复：功能菜单容器透明化 ================== */

#chat-input-menu {
    /* 1. 强制背景透明，去掉之前的深色底 */
    background: transparent !important;

    /* 2. 去掉外层的高斯模糊 (模糊只加在胶囊按钮上) */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;

    /* 3. 去掉外层的阴影和边框 */
    box-shadow: none !important;
    border: none !important;

    /* 4. 调整位置 (确保紧贴输入框上方) */
    padding: 10px 0 !important;
    bottom: 60px !important;
}

/* 确保胶囊卡片本身有淡淡的背景 */
.menu-pill-card {
    /* 极淡的白色背景，透出壁纸 */
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

/* 浅色模式适配 */
body.light-theme #chat-input-menu {
    background: transparent !important;
    border: none !important;
}
body.light-theme .menu-pill-card {
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.05) !important;
}

        /* ================== 聊天设置页进阶样式 ================== */

/* ================== 修复：人设预览样式 (省略号版) ================== */
.setting-text-preview {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;

    /* 核心：超过 3 行显示省略号 (...) */
    display: -webkit-box;
    -webkit-line-clamp: 3;  /* 只显示3行 */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;

    border: 1px solid rgba(255,255,255,0.1);
    transition: background 0.2s;
}
.setting-text-preview:active { background: rgba(255,255,255,0.1); }

/* 新增：完整显示样式 (给 User 用) */
.setting-text-full {
    font-size: 14px;
    color: rgba(255,255,255,0.8);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;

    /* 核心：完整显示，不折叠 */
    display: block;
    white-space: pre-wrap; /* 保留换行 */

    border: 1px solid rgba(255,255,255,0.1);
}

/* 世界观标签 (优化版) */
.world-tag {
    padding: 6px 14px;
    border-radius: 20px; /* 更圆润 */
    font-size: 13px;
    color: rgba(255,255,255,0.9);

    /* 核心修改：改成深色玻璃，而不是亮蓝色 */
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);

    display: inline-flex; /* 防止换行错位 */
    align-items: center;
    gap: 8px;
    cursor: default;
    transition: background 0.2s;
}

/* 鼠标悬停效果 */
.world-tag:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* 删除按钮 X */
.world-tag-remove {
    cursor: pointer;
    opacity: 0.6;
    font-weight: bold;
    font-size: 14px;
    padding: 2px; /* 增加一点点击面积 */
}
.world-tag-remove:hover {
    opacity: 1;
    color: #FF3B30; /* 悬停变红 */
}

/* 3. 气泡样式选择器 */
.bubble-style-scroll {
    display: flex; overflow-x: auto; gap: 10px; padding: 5px 0;
    scrollbar-width: none;
}
.bubble-preset-item {
    min-width: 80px; height: 60px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: rgba(255,255,255,0.7);
    border: 2px solid transparent; cursor: pointer;
    flex-direction: column; gap: 5px;
}
.bubble-preset-item.active {
    border-color: #0a84ff; background: rgba(10, 132, 255, 0.1); color: white;
}
/* 预览小气泡 */
.mini-bubble-preview {
    width: 40px; height: 24px; border-radius: 12px;
    background: #0a84ff;
}

/* 4. 危险按钮区域 */
.danger-zone {
    margin-top: 30px;
    display: flex; flex-direction: column; gap: 15px;
}
.btn-danger-outline {
    background: transparent; border: 1px solid #FF3B30; color: #FF3B30;
    padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
}
.btn-danger-fill {
    background: #FF3B30; border: none; color: white;
    padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
}

/* 浅色适配 */
body.light-theme .setting-text-preview { background: rgba(0,0,0,0.05); color: #666; }
body.light-theme .world-tag { background: rgba(0, 122, 255, 0.1); color: #007aff; }
body.light-theme .bubble-preset-item { background: #fff; border-color: rgba(0,0,0,0.1); color: #333; }
body.light-theme .bubble-preset-item.active { border-color: #007aff; background: #f0f8ff; }

        /* ================== 强制修复：功能菜单透明化 (High Priority) ================== */

/* 1. 菜单容器：完全透明，无背景，无阴影 */
#chat-input-menu {
    background: transparent !important; /* 关键：去掉深色背景 */
    backdrop-filter: none !important;   /* 去掉外层模糊 */
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;        /* 去掉外层阴影 */
    border: none !important;            /* 去掉边框 */

    /* 位置调整：紧贴输入框上方 */
    bottom: 65px !important;
    padding: 10px 0 !important;
}

/* 2. 胶囊卡片：保持半透明玻璃感 */
.menu-pill-card {
    /* 这里的背景色要非常淡，才能透出壁纸 */
    background: rgba(30, 30, 35, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;

    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 28px !important; /* 确保是圆角胶囊 */

    /* 阴影 */
    box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
}

/* 3. 滚动容器：去掉多余的内边距 */
.chat-scroll-menu {
    padding: 0 16px !important; /* 两侧留白 */
    overflow-x: auto !important;
    display: flex !important;
    gap: 12px !important;
}

/* 浅色模式适配 */
body.light-theme .menu-pill-card {
    background: rgba(255, 255, 255, 0.9) !important;
    border-color: rgba(0,0,0,0.1) !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05) !important;
}

        /* ================== 修复：人设文本改为滚动显示 ================== */
.setting-text-preview {
    font-size: 14px;
    color: rgba(255,255,255,0.7);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 12px;
    margin-top: 8px;
    cursor: pointer;

    /* 🚨 核心修改：不再截断，而是限制高度并允许滚动 */
    display: block;          /* 恢复块级显示 */
    max-height: 120px;       /* 限制最大高度 (约5-6行) */
    overflow-y: auto;        /* 内容多了显示滚动条 */
    white-space: pre-wrap;   /* 保留换行符 */

    /* 移除之前的截断属性 */
    -webkit-line-clamp: unset;
    -webkit-box-orient: unset;
    text-overflow: unset;

    border: 1px solid rgba(255,255,255,0.1);
}
        /* ================== 聊天设置页：强制显形补丁 ================== */

/* 1. 让卡片背景变亮，与底色区分开 */
#sub-chat-settings .settings-group {
    background-color: #2c2c2e !important; /* 亮一点的灰色 */
    border: 1px solid rgba(255,255,255,0.1) !important; /* 加个边框 */
    overflow: visible !important; /* 🚨 关键：禁止截断内容！ */
}

/* 2. 修复头像显示 (强制大小和占位色) */
#sub-chat-settings .v-cover-box {
    width: 50px !important;
    height: 50px !important;
    min-width: 50px !important; /* 防止被压缩 */
    background-color: rgba(255,255,255,0.2) !important; /* 明显的底色 */
    border: 2px solid rgba(255,255,255,0.3) !important;
    border-radius: 50% !important;

    /* 如果没图，显示一个加号 */
    display: flex !important;
    align-items: center;
    justify-content: center;
}
/* 给没图的头像加个图标提示 */
#sub-chat-settings .v-cover-box:empty::after {
    content: '+'; color: white; font-size: 24px; opacity: 0.5;
}

/* 3. 修复输入框 (加背景和边框，让它能被看见) */
#sub-chat-settings input[type="text"] {
    background: rgba(0, 0, 0, 0.3) !important; /* 深色底 */
    border: 1px solid rgba(255, 255, 255, 0.2) !important; /* 亮边框 */
    border-radius: 8px !important;
    color: white !important;
    padding: 8px 10px !important;
    height: 36px !important;
    width: 100% !important;
}

/* 4. 修复按钮显示 (防止被截断) */
#sub-chat-settings .tab-btn {
    background: rgba(255,255,255,0.1) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: white !important;
    padding: 8px 15px !important;
    border-radius: 8px !important;
}

/* 浅色模式适配 */
body.light-theme #sub-chat-settings .settings-group {
    background-color: #ffffff !important;
    border-color: rgba(0,0,0,0.1) !important;
}
body.light-theme #sub-chat-settings input[type="text"] {
    background: rgba(0,0,0,0.05) !important;
    border-color: rgba(0,0,0,0.1) !important;
    color: black !important;
}
body.light-theme #sub-chat-settings .v-cover-box {
    background-color: #f2f2f7 !important;
    border-color: rgba(0,0,0,0.1) !important;
}
body.light-theme #sub-chat-settings .v-cover-box:empty::after {
    color: #999;
}
        /* ================== 1. 人设文本统一截断样式 ================== */
.setting-text-preview {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;

    /* 核心：强制只显示 3 行，超出省略 */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;

    border: 1px solid rgba(255,255,255,0.1);
    transition: background 0.2s;
}
.setting-text-preview:active { background: rgba(255,255,255,0.1); }

/* 浅色模式适配 */
body.light-theme .setting-text-preview {
    background: rgba(0,0,0,0.05); color: #666;
}

        /* ================== 修复：浅色模式背景被遮挡 ================== */
body.light-theme #sub-chat-detail {
    /* 🚨 核心修复：去掉 !important，让 JS 设置的背景图能显示出来 */
    background-color: #f2f2f7;
}

/* ================== 优化：世界观选择列表 ================== */
#world-select-list .world-select-item {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: background 0.2s;
}
#world-select-list .world-select-item:active {
    background: rgba(255,255,255,0.1);
}
/* 标题 */
.world-select-title {
    font-size: 16px; font-weight: 600; color: white; margin-bottom: 4px;
}
/* 内容预览 (限制2行) */
.world-select-desc {
    font-size: 13px; color: rgba(255,255,255,0.6);
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden; line-height: 1.4;
}

/* 浅色适配 */
body.light-theme .world-select-item { border-bottom-color: rgba(0,0,0,0.05); }
body.light-theme .world-select-title { color: black; }
body.light-theme .world-select-desc { color: #666; }

        /* ================== 最终样式修复补丁 ================== */

/* 1. 修复：浅色模式聊天背景 (只设底色，不挡图片) */
body.light-theme #sub-chat-detail {
    background-color: #f2f2f7 !important; /* 关键：不能用 background 简写 */
    background-image: none; /* 默认无图，JS 会覆盖这个属性 */
}

/* 2. 修复：浅色模式世界观标签 (变深色字) */
body.light-theme .world-tag {
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.1) !important;
    color: #333 !important; /* 关键：文字变黑 */
}

/* 3. 新增：聊天气泡头像样式 */
.chat-msg-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    flex-shrink: 0;
    background-size: cover; background-position: center;
    background-color: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.1);
}
/* 头像位置调整 */
.chat-msg.left .chat-msg-avatar { margin-right: 10px; }
.chat-msg.right .chat-msg-avatar { margin-left: 10px; }

/* 浅色模式头像边框 */
body.light-theme .chat-msg-avatar {
    border-color: rgba(0,0,0,0.1);
    background-color: #fff;
}

/* 4. 功能类：隐藏头像 (当设置关闭时) */
.hide-avatars .chat-msg-avatar {
    display: none !important;
}

        /* ================== 终极修复：聊天设置页浅色适配 ================== */

/* 1. 修复“选择设定”和“自定义”按钮 (优先级覆盖之前的强制白色) */
body.light-theme #sub-chat-settings .tab-btn {
    color: #007aff !important; /* 变回蓝色 */
    background: rgba(0, 0, 0, 0.05) !important; /* 浅灰背景 */
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    box-shadow: none !important;
}

/* 2. 修复已添加的世界观标签 (确保深色字) */
body.light-theme #sub-chat-settings .world-tag {
    color: #333333 !important; /* 深灰字 */
    background: rgba(0, 0, 0, 0.05) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
}

/* 3. 修复人设预览框的文字颜色 */
body.light-theme #sub-chat-settings .setting-text-preview,
body.light-theme #sub-chat-settings .setting-text-full {
    color: #333333 !important;
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.1) !important;
}

/* 4. 修复输入框 (昵称编辑框) */
body.light-theme #sub-chat-settings input[type="text"] {
    color: #000000 !important;
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.1) !important;
}
    </style>
</head>
<body>
<div id="dynamic-island" class="island-container idle-show">
    <div class="island-content">
        <div class="island-left" id="island-icon"></div>
        <div class="island-center" id="island-text"></div>
        <div class="island-right" id="island-info"></div>
    </div>
</div>
<video id="global-video-bg" autoplay loop muted playsinline style="
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; z-index: -1; display: none; pointer-events: none;
"></video>

<div class="status-bar">
    <div id="clock">15:36</div>
    <div class="status-right">
        <div class="signal-bars">
            <div class="bar active"></div><div class="bar active"></div><div class="bar active"></div><div class="bar active"></div>
        </div>
        <div class="battery-group">
            <span class="charging-icon" id="charging-bolt">⚡</span>
            <span id="battery-text" style="font-size: 12px; margin-right: 2px;">--%</span>
            <div class="battery-shell"><div class="battery-level" id="battery-fill"></div></div>
        </div>
    </div>
</div>

<div class="home-slider">
    <div class="home-page">

        <div class="widget-weather" id="widget-weather-box">
            <div class="weather-city" onclick="openCityModal()">
                <span id="current-city">曼谷</span>
            </div>

            <div class="weather-center-content">
                <div id="weather-icon-container">
                    <svg class="weather-svg" viewBox="0 0 64 64" fill="none">
                        <circle cx="32" cy="32" r="14" fill="#FFC107" />
                        <g stroke="#FF9800" stroke-width="4" stroke-linecap="round">
                            <path d="M32 6V10 M32 54V58 M6 32H10 M54 32H58 M13.6 13.6L16.4 16.4 M47.6 47.6L50.4 50.4 M13.6 50.4L16.4 47.6 M47.6 16.4L50.4 13.6" />
                        </g>
                    </svg>
                </div>
                <div class="weather-temp">28°C</div>
                <div class="weather-desc">局部多云</div>
            </div>

            <div class="weather-date-info">
                <span id="weekday-text" class="date-row">星期二</span>
                <span id="date-text" class="date-row">11月25日</span>
            </div>
        </div>

        <div class="widget-photo" onclick="triggerPhotoUpload()">

            <div class="photo-placeholder" id="photo-placeholder">
                <span class="plus-icon">+</span>
                <span class="add-text">添加照片</span>
            </div>

            <div class="photo-display" id="photo-display"></div>

            <input type="file" id="photo-input" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this)">
        </div>

        <div class="widget-music" id="widget-music-box">

            <div class="music-cover" id="music-cover" onclick="triggerCoverUpload()"></div>

            <div class="music-details-container">

                <div class="music-text-group" onclick="openMusicModal()">
                    <div class="song-title">Midnight City</div>
                    <div class="artist-name">M83 · Hurry Up, We're Dreaming</div>
                </div>

                <div class="progress-bar-bg">
                    <div class="progress-bar-fill"></div>
                </div>

                <div class="music-controls">
                    <button class="control-btn">
                        <svg class="ctrl-svg" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>

                    <button class="control-btn play-pause-btn" id="playPauseBtn">
                        <svg class="ctrl-svg" id="play-icon" viewBox="0 0 24 24" style="display: block;">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg class="ctrl-svg" id="pause-icon" viewBox="0 0 24 24" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>

                    <button class="control-btn">
                        <svg class="ctrl-svg" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="widget-profile">

            <div class="profile-avatar" id="profile-avatar" onclick="triggerProfileUpload()"></div>
            <input type="file" id="profile-input" accept="image/*" style="display: none;" onchange="handleProfileUpload(this)">

            <div class="profile-text">
                <div class="profile-nickname" id="profile-nickname" onclick="openProfileEditModal('nickname')">点击设置昵称</div>
                <div class="profile-signature" id="profile-signature" onclick="openProfileEditModal('signature')">点击设置个性签名</div>
            </div>

        </div>

        <div class="grid-app-item" style="grid-row: 5; grid-column: 3; transform: translateY(-35px);">
            <div class="app-icon-shape bg-wallpaper" id="icon-home-wallpaper" onclick="openApp('app-wallpaper')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_wp">壁纸</span>
        </div>

        <div class="grid-app-item" style="grid-row: 5; grid-column: 4; transform: translateY(-35px);">
            <div class="app-icon-shape bg-settings" id="icon-home-settings" onclick="openApp('app-settings')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .36.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.17 0-.36-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_set">设置</span>
        </div>

        <div class="grid-app-item" style="grid-row: 6; grid-column: 3; transform: translateY(-80px);">
            <div class="app-icon-shape bg-chat" id="icon-home-chat" onclick="openApp('app-chat')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_chat">聊天</span>
        </div>

        <div class="grid-app-item" style="grid-row: 6; grid-column: 4; transform: translateY(-80px);">
            <div class="app-icon-shape bg-music" id="icon-home-music" onclick="openApp('app-music')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_music">音乐</span>
        </div>

    </div>
    <div class="home-page">
        <div class="widget-countdown" id="widget-countdown-card" onclick="openCountdownModal()">
            <div class="cd-bg-image" id="cd-bg-layer"></div>
            <div class="cd-overlay"></div>
            <div class="cd-content-layer">
                <div class="cd-top-row">
                    <div class="cd-icon-box">
                        <svg class="cd-svg-icon" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
                    </div>
                    <span class="cd-name" id="widget-cd-title">点击设置纪念日</span>
                </div>
                <div class="cd-main-content">
                    <span class="cd-number" id="widget-cd-days">0</span>
                    <div class="cd-meta"><span class="cd-unit">DAYS</span><span class="cd-label">LEFT</span></div>
                </div>
                <div class="cd-bottom-row">
                    <span class="cd-target-date" id="widget-cd-date">YYYY-MM-DD</span>
                    <svg class="cd-arrow-icon" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
            </div>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-diary" id="icon-home-diary" onclick="showToast('日记')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
            </div>
            <span class="app-label">日记</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-wallet" id="icon-home-wallet" onclick="showToast('钱包')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8z"/></svg>
            </div>
            <span class="app-label">钱包</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-shop" id="icon-home-shop" onclick="showToast('购物')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </div>
            <span class="app-label">购物</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-memo" id="icon-home-memo" onclick="showToast('备忘录')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M3 18h12v-2H3v2zM3 6v2h18V6H3zm0 7h18v-2H3v2z"/></svg>
            </div>
            <span class="app-label">备忘录</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-forum" id="icon-home-forum" onclick="showToast('论坛')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
            </div>
            <span class="app-label">论坛</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-phone" id="icon-home-phone" onclick="showToast('电话')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
            </div>
            <span class="app-label">电话</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-companion" id="icon-home-companion" onclick="showToast('陪伴')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
            <span class="app-label">陪伴</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-gacha" id="icon-home-gacha" onclick="showToast('抽卡')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
            </div>
            <span class="app-label">抽卡</span>
        </div>

        <div class="widget-voice-card" id="widget-voice-a-box">
            <div class="v-cover-box" id="voice-a-cover" onclick="triggerVoiceCover('A')">
                <span class="v-plus-mark">+</span>
            </div>

            <div class="v-wave-container" id="voice-a-wave" onclick="toggleVoicePlay('A')">
                <div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div>
            </div>

            <div class="v-btn-star" onclick="triggerVoiceUpload('A')">
                <svg class="v-star-icon" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
            </div>

            <input type="file" id="input-voice-a-img" accept="image/*" hidden onchange="saveVoiceImg('A', this)">
            <input type="file" id="input-voice-a-audio" accept="audio/*" hidden onchange="saveVoiceAudio('A', this)">
        </div>
    </div>
</div>

<div class="dock-container">

    <div class="dock-icon bg-role" id="icon-dock-role" onclick="openApp('app-rolebook')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
    </div>
    <div class="dock-icon bg-world" id="icon-dock-world" onclick="openApp('app-worldbook')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    </div>
    <div class="dock-icon bg-manual" id="icon-dock-manual">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
    </div>
    <div class="dock-icon bg-gallery" id="icon-dock-gallery" onclick="openApp('app-icons')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
    </div>

</div>

<div class="modal-overlay" id="city-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">选择城市</span>
        </div>

        <input type="text" class="search-box" id="city-search" placeholder="搜索城市 (如: 东京, 纽约)..." oninput="filterCities()">

        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('domestic')">国内</button>
            <button class="tab-btn" onclick="switchTab('international')">国际</button>
        </div>

        <div class="city-list" id="city-list-container">
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeCityModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveCitySelection()">保存</button>
        </div>
    </div>
</div>

<input type="file" id="cover-input" accept="image/*" style="display: none;">
<input type="file" id="mp3-input" accept="audio/mpeg,audio/mp3" style="display: none;">

<div class="modal-overlay" id="music-modal">
    <div class="modal-content" style="width: 90%;">
        <div class="modal-header"><span class="modal-title">编辑歌曲信息</span></div>

        <label class="modal-label">歌曲名称</label>
        <input type="text" class="search-box" id="edit-song-title" placeholder="例如: Midnight City">

        <label class="modal-label">歌手 / 专辑</label>
        <input type="text" class="search-box" id="edit-artist-name" placeholder="例如: M83">

        <label class="modal-label">音频来源</label>
        <button class="file-upload-btn" onclick="document.getElementById('mp3-input').click()">选择本地 MP3 文件</button>
        <div id="music-file-name">未选择文件</div>

        <div style="text-align: center; margin: 10px 0; opacity: 0.5;">- 或 -</div>
        <input type="text" class="search-box" id="edit-music-url" placeholder="输入在线音乐链接 (URL)">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeMusicModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveMusicInfo()">保存并播放</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="profile-modal">
    <div class="modal-content" style="width: 80%; max-width: 300px;">
        <div class="modal-header">
            <span class="modal-title" id="profile-modal-title">编辑</span>
        </div>

        <input type="text" class="search-box" id="profile-edit-input" placeholder="请输入内容...">
        <input type="hidden" id="current-edit-type">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeProfileModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveProfileText()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-wallpaper">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-wallpaper')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">壁纸设置</div>
    </div>

    <div class="wallpaper-content">

        <div>
            <div class="section-title">静态壁纸 (图片)</div>
            <div class="preview-card">
                <div class="preview-viewport">
                    <div id="wp-img-preview" style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#666;">预览</div>
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-upload" onclick="document.getElementById('wp-img-input').click()">
                        选择图片
                    </button>
                    <button class="action-btn btn-apply" id="btn-apply-img" onclick="applyWallpaper('image')">
                        设为壁纸
                    </button>
                </div>
                <input type="file" id="wp-img-input" accept="image/*" hidden onchange="handleWpPreview('image', this)">
            </div>
        </div>

        <div>
            <div class="section-title">动态壁纸 (视频)</div>
            <div class="preview-card">
                <div class="preview-viewport">
                    <video id="wp-video-preview" loop muted playsinline style="width:100%; height:100%; object-fit: cover; display:none;"></video>
                    <div id="wp-video-placeholder" style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#666;">预览</div>
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-upload" onclick="document.getElementById('wp-video-input').click()">
                        选择视频
                    </button>
                    <button class="action-btn btn-apply" id="btn-apply-video" onclick="applyWallpaper('video')">
                        设为动态壁纸
                    </button>
                </div>
                <input type="file" id="wp-video-input" accept="video/mp4,video/webm" hidden onchange="handleWpPreview('video', this)">
            </div>
        </div>

    </div>
</div>

<div class="app-window" id="app-settings">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-settings')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">设置</div>
    </div>

    <div class="wallpaper-content" style="padding-top: 20px;">
        <div class="settings-list">
            <div class="settings-item" onclick="openSubPage('sub-timezone')">
                <span>日期与时间</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-timezone-label">自动</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-theme')">
                <span data-i18n="set_theme">主题</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-theme-label">深色</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-ai-model')">
                <span data-i18n="set_model">AI 模型</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-model-label">未配置</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-font')">
                <span data-i18n="set_font">字体</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-font-label">系统默认</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-island')">
                <span style="display:flex; align-items:center; gap:8px;">
                    <span style="background:black; border-radius:8px; width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
                        <div style="width:12px; height:4px; background:white; border-radius:2px;"></div>
                    </span>
                    灵动岛
                </span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="island-status-label">已开启</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-widget-bg')">
                <span data-i18n="set_widget">组件背景</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value">自定义</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-timezone" style="background: #1c1c1e;">

    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-timezone')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">选择时区</div>
    </div>

    <div class="search-container">
        <input type="text" class="settings-search" id="timezone-search" placeholder="搜索城市或国家" oninput="filterTimeZones()">
    </div>

    <div id="timezone-list-container" style="flex:1; overflow-y: auto;">
    </div>
</div>
<div class="toast-capsule" id="global-toast">
    <div class="toast-icon">✔</div>
    <span id="toast-text">设置成功</span>
</div>

<div class="sub-page" id="sub-theme" style="background: #1c1c1e;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-theme')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title">主题设置</div>
    </div>

    <div class="wallpaper-content">

        <div class="theme-options">
            <div class="theme-btn active" id="btn-theme-dark" onclick="switchTheme('dark')">
                深色
            </div>
            <div class="theme-btn" id="btn-theme-light" onclick="switchTheme('light')">
                浅色
            </div>
            <div class="theme-btn" id="btn-theme-custom" onclick="switchTheme('custom')">
                自定义
            </div>
        </div>

        <div class="code-editor-container" id="custom-css-area">
            <div style="color:#666; font-size:12px; margin-bottom:5px;">输入 CSS 代码 (实时覆盖):</div>
            <textarea class="code-textarea" id="css-input" placeholder="/* 例如: */
                .app-window { background: rgba(50,0,0,0.9) !important; }
                .settings-item { border-radius: 0 !important; }"></textarea>

            <button class="action-btn btn-apply" style="margin-top:10px; opacity:1; pointer-events:all; background:#4CAF50;" onclick="applyCustomCSS()">
                ⚡ 应用并保存
            </button>
        </div>

    </div>
</div>

<div class="sub-page" id="sub-ai-model" style="background: #1c1c1e;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-ai-model')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title" data-i18n="ai_set_title">模型设置</div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">

        <div class="ai-header-text">配置管理</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="renderConfigList(); openSubPage('sub-config-list')">
                <div class="ai-item-label blue">切换已保存的配置</div>
                <div class="ai-item-input" id="current-config-name" style="pointer-events:none; color:white;">默认</div>
                <span style="color:#666; font-size:14px; margin-left:8px;">›</span>
            </div>
        </div>

        <div class="ai-header-text">服务器参数</div>
        <div class="ai-group-card">
            <div class="ai-list-item">
                <div class="ai-item-label">地址</div>
                <input type="text" class="ai-item-input" id="ai-endpoint" placeholder="https://api.openai.com">
            </div>
            <div class="ai-list-item">
                <div class="ai-item-label">密钥</div>
                <input type="password" class="ai-item-input" id="ai-key" placeholder="sk-...">
            </div>
        </div>

        <div class="ai-header-text">模型</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="fetchModelList()">
                <div class="ai-item-label blue">拉取模型列表</div>
            </div>
            <div class="ai-list-item" onclick="if(typeof cachedModelList!=='undefined' && cachedModelList.length>0) openSubPage('sub-model-select'); else fetchModelList();">
                <div class="ai-item-label">当前</div>
                <div class="ai-item-input" id="display-current-model" style="pointer-events:none; color:white;">未选择</div>
                <span style="color:#666; font-size:14px; margin-left:8px;">›</span>
            </div>
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 30px;">
            <button onclick="saveAISettings()" style="flex:1; height:48px; background:#0a84ff; color:white; border:none; border-radius:12px; font-size:16px; font-weight:600;">保存配置</button>
            <button onclick="testSimpleConnection()" style="flex:1; height:48px; background:rgba(10,132,255,0.15); color:#0a84ff; border:none; border-radius:12px; font-size:16px; font-weight:600;">连接测试</button>
        </div>

        <div class="ai-header-text">对话测试</div>
        <div class="ai-test-box">
            <div class="ai-test-log" id="ai-test-log">// Ready...</div>
            <div class="ai-test-input-bar">
                <input type="text" class="ai-test-input" id="ai-test-msg" placeholder="发送测试内容...">
                <button onclick="testAIConnection()" style="width:36px; height:36px; background:#0a84ff; border-radius:50%; border:none; display:flex; align-items:center; justify-content:center;">
                    <svg style="width:16px;height:16px;fill:white; margin-left:2px;" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

    </div>
</div>
<div class="sub-page" id="sub-model-select" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-model-select')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">选择模型</div>
    </div>

    <div class="search-container">
        <input type="text" class="settings-search" id="model-search" placeholder="搜索模型 (gpt, claude...)" oninput="renderModelList()">
    </div>

    <div id="model-list-container" style="flex:1; overflow-y: auto; padding-bottom: 40px;">
        <div style="text-align:center; color:#666; padding:40px;">请先在上一页点击“拉取”</div>
    </div>
</div>

<div class="sub-page" id="sub-config-list" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-config-list')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">我的配置</div>
    </div>

    <div id="config-list-container" style="flex:1; overflow-y: auto; padding-bottom: 40px;">
    </div>
</div>

<div class="sub-page" id="sub-font" style="background: #1c1c1e;">

    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-font')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title" data-i18n="font_title">字体显示</div>
    </div>

    <div class="wallpaper-content" style="padding: 0; padding-bottom: 150px;">

        <div class="ai-header-text">效果预览</div>
        <div class="font-preview-card" id="font-preview-box">
            <span class="preview-text-en">The quick brown fox</span>
            <span class="preview-text-cn">永和九年，岁在癸丑</span>
        </div>

        <div class="ai-header-text">显示调整</div>
        <div class="slider-container">
            <div class="slider-header">
                <span>大小</span>
                <span id="val-size">16px</span>
            </div>
            <input type="range" id="range-size" min="12" max="24" step="1" value="16" oninput="updateFontConfig()">

            <div class="slider-header" style="margin-top: 20px;">
                <span>粗细</span>
                <span id="val-weight">400</span>
            </div>
            <input type="range" id="range-weight" min="100" max="900" step="100" value="400" oninput="updateFontConfig()">
        </div>

        <div class="ai-header-text">选择字体</div>
        <div class="ai-group-card" id="font-list-container">
        </div>

        <div class="ai-header-text">自定义</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="document.getElementById('font-file-input').click()">
                <div class="ai-item-label blue">上传字体文件 (.ttf/.otf)</div>
                <span class="ai-arrow">›</span>
            </div>
        </div>
        <input type="file" id="font-file-input" accept=".ttf,.otf,.woff,.woff2" style="display:none;" onchange="handleFontUpload(this)">

        <div class="ai-btn-group">
            <button class="ai-btn ai-btn-secondary" onclick="resetFontSettings()">恢复默认</button>
            <button class="ai-btn ai-btn-primary" onclick="showToast('✅ 字体设置已保存')">保存设置</button>
        </div>

    </div>
</div>

<div class="modal-overlay" id="config-name-modal">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">保存配置</span>
        </div>

        <div style="margin-bottom: 10px; color: rgba(255,255,255,0.6); font-size: 14px;">给当前配置起个名字：</div>

        <input type="text" class="search-box" id="config-name-input" placeholder="例如: DeepSeek 官方" style="background: rgba(255,255,255,0.1); color: white; text-align: left; padding-left: 15px;">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeConfigNameModal()">取消</button>
            <button class="modal-btn btn-save" onclick="confirmSaveConfig()">确认保存</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-island" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-island')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">灵动岛</div>
    </div>

    <div class="wallpaper-content">
        <div class="group-header">总开关</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>启用灵动岛</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-master" onchange="toggleIslandMaster()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="group-header">交互场景</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>充电提示</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-charge" onchange="saveIslandConfig()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <span>音乐播放可视化</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-music" onchange="saveIslandConfig()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="group-header">调试</div>
        <div class="ai-btn-group" style="margin:0;">
            <button class="ai-btn ai-btn-secondary" onclick="testIsland('charge')">测试充电动画</button>
            <button class="ai-btn ai-btn-secondary" onclick="testIsland('music')">测试音乐动画</button>
        </div>
        <div style="text-align:center; color:#666; font-size:12px; margin-top:10px;">
            点击测试按钮查看效果
        </div>
    </div>
</div>

<div class="modal-overlay" id="clear-config-modal">
    <div class="modal-content" style="width: 80%; max-width: 300px;">
        <div class="modal-header">
            <span class="modal-title" style="color: #FF3B30;">危险操作</span>
        </div>

        <div style="text-align: center; margin: 10px 0 25px 0; color: rgba(255,255,255,0.7); font-size: 14px; line-height: 1.5;">
            确定要删除所有保存的模型配置吗？<br>此操作<b>无法撤销</b>。
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeClearConfigModal()">取消</button>
            <button class="modal-btn" onclick="confirmClearConfig()" style="background: #FF3B30; color: white; font-weight: 600;">
                删除全部
            </button>
        </div>
    </div>
</div>

<div class="app-window" id="app-icons">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-icons')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">图标设置</div>
    </div>

    <div class="wallpaper-content">

        <div class="ai-header-text">主屏幕应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-wallpaper" id="preview-home-wallpaper">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </div>
                <div class="city-name">壁纸</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-wallpaper')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-wallpaper')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-settings" id="preview-home-settings">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .36.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.17 0-.36-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </div>
                <div class="city-name">设置</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-settings')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-settings')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-chat" id="preview-home-chat">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                </div>
                <div class="city-name">聊天</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-chat')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-chat')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-music" id="preview-home-music">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="city-name">音乐</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-music')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-music')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">第二页应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-diary" id="preview-home-diary">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                </div>
                <div class="city-name">日记</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-diary')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-diary')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-wallet" id="preview-home-wallet">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8z"/></svg>
                </div>
                <div class="city-name">钱包</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-wallet')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-wallet')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-shop" id="preview-home-shop">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                </div>
                <div class="city-name">购物</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-shop')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-shop')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-memo" id="preview-home-memo">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M3 18h12v-2H3v2zM3 6v2h18V6H3zm0 7h18v-2H3v2z"/></svg>
                </div>
                <div class="city-name">备忘录</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-memo')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-memo')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-forum" id="preview-home-forum">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
                </div>
                <div class="city-name">论坛</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-forum')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-forum')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-phone" id="preview-home-phone">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
                </div>
                <div class="city-name">电话</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-phone')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-phone')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-companion" id="preview-home-companion">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </div>
                <div class="city-name">陪伴</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-companion')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-companion')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-gacha" id="preview-home-gacha">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
                </div>
                <div class="city-name">抽卡</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-gacha')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-gacha')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">Dock 栏应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-role" id="preview-dock-role" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <div class="city-name">角色书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-role')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-role')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-world" id="preview-dock-world" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="city-name">世界书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-world')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-world')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-manual" id="preview-dock-manual" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                </div>
                <div class="city-name">说明书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-manual')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-manual')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-gallery" id="preview-dock-gallery" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
                </div>
                <div class="city-name">图标</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-gallery')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-gallery')">还原</button>
            </div>
        </div>

        <input type="file" id="icon-file-input" accept="image/png,image/jpeg,image/jpg" style="display:none;" onchange="handleIconFileSelect(this)">
    </div>
</div>

<div class="app-window" id="app-rolebook">
    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-rolebook')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">角色书</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-size: 28px; cursor: pointer; font-weight: 300;" onclick="openRoleEditModal()">+</div>
    </div>

    <div class="wallpaper-content">
        <div class="role-grid" id="role-list-container">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-role-detail" style="background: #1c1c1e;">
    <div style="position: absolute; top: 50px; left: 15px; z-index: 20;">
        <div onclick="closeSubPage('sub-role-detail')" style="background: rgba(0,0,0,0.5); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">
        <div class="role-header-bg" id="role-detail-bg" onclick="triggerRoleBgUpload()"></div>
        <input type="file" id="role-bg-input" accept="image/*" hidden onchange="handleRoleBgUpload(this)">

        <div class="role-avatar-container">
            <div class="role-big-avatar" id="role-detail-avatar"></div>
        </div>

        <div class="role-detail-content">
            <div class="role-detail-name" id="role-detail-name">角色名</div>
            <div class="role-detail-desc" id="role-detail-desc">人设详情...</div>

            <div class="ai-btn-group" style="margin-top: 40px;">
                <button class="ai-btn ai-btn-secondary" style="color: #FF3B30; background: rgba(255, 59, 48, 0.1);" onclick="deleteCurrentRole()">删除角色</button>
                <button class="ai-btn ai-btn-primary" onclick="editCurrentRole()">编辑资料</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-role-edit">
    <div class="modal-content" style="width: 90%; max-height: 85%;">
        <div class="modal-header">
            <span class="modal-title" id="role-modal-title">新建角色</span>
        </div>

        <div style="overflow-y: auto; flex: 1;">
            <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                <div id="role-edit-avatar-preview" onclick="document.getElementById('role-avatar-input').click()"
                     style="width: 80px; height: 80px; border-radius: 50%; background: #333; border: 2px dashed #666; display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center;">
                    <span style="font-size: 24px; color: #666;">+</span>
                </div>
                <input type="file" id="role-avatar-input" accept="image/*" hidden onchange="previewRoleAvatar(this)">
            </div>

            <div class="ai-item-label" style="margin-bottom: 5px;">昵称</div>
            <input type="text" class="search-box" id="role-edit-name" placeholder="角色名字" style="text-align: left; padding-left: 10px;">

            <div class="ai-item-label" style="margin: 15px 0 5px 0;">人设详情</div>
            <textarea class="code-textarea" id="role-edit-desc" placeholder="输入详细设定..." style="height: 150px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; font-family: inherit; font-size: 15px;"></textarea>
        </div>

        <div class="modal-footer" style="margin-top: 15px;">
            <button class="modal-btn btn-cancel" onclick="closeRoleModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveRoleData()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-worldbook">
    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-worldbook')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">世界书</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-size: 28px; cursor: pointer; font-weight: 300;" onclick="openWorldEditModal()">+</div>
    </div>

    <div class="wallpaper-content">
        <div id="world-list-container">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-world-detail" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-world-detail')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">设定详情</div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">
        <div class="world-detail-container">
            <div class="world-detail-header" id="view-world-title">标题</div>
            <div class="world-detail-body" id="view-world-content">内容...</div>

            <div class="ai-btn-group" style="margin-top: 30px;">
                <button class="ai-btn ai-btn-secondary" style="color: #FF3B30; background: rgba(255, 59, 48, 0.1);" onclick="deleteCurrentWorld()">删除</button>
                <button class="ai-btn ai-btn-primary" onclick="editCurrentWorld()">编辑</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-world-edit">
    <div class="modal-content" style="width: 90%; max-height: 85%;">
        <div class="modal-header">
            <span class="modal-title" id="world-modal-title">新建设定</span>
        </div>

        <div style="flex: 1; overflow-y: auto;">
            <div class="ai-item-label" style="margin-bottom: 5px;">设定名称</div>
            <input type="text" class="search-box" id="world-edit-title" placeholder="例如: 魔法体系、地理环境" style="text-align: left; padding-left: 10px;">

            <div class="ai-item-label" style="margin: 15px 0 5px 0;">详细内容</div>
            <textarea class="code-textarea" id="world-edit-content" placeholder="输入详细的世界观设定..." style="height: 300px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; font-family: inherit; font-size: 15px; line-height: 1.6;"></textarea>
        </div>

        <div class="modal-footer" style="margin-top: 15px;">
            <button class="modal-btn btn-cancel" onclick="closeWorldModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveWorldData()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-music">

    <div id="music-view-list">
        <div class="app-header" style="background:transparent; border-bottom:none;">
            <div class="app-back-btn" onclick="closeApp('app-music')">
                <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                主屏幕
            </div>
            <div class="app-title" style="color:white;">音乐库</div>

            <div class="header-add-btn" onclick="openMusicUploadModal()">
                <svg style="width:18px;height:18px;fill:white;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
        </div>

        <div class="wallpaper-content" id="app-music-list-container" style="padding-bottom: 120px;">
        </div>

        <div class="mini-player" id="mini-player-bar" onclick="openFullPlayer()">
            <div class="mini-cover" id="mini-cover"></div>
            <div class="mini-info">
                <div class="mini-title" id="mini-title">未播放</div>
                <div class="mini-artist" id="mini-artist">--</div>
            </div>
            <div class="mini-controls">
                <button class="mini-btn" onclick="event.stopPropagation(); togglePlayState()" id="mini-play-btn">
                    <svg id="mini-icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="mini-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <button class="mini-btn" onclick="event.stopPropagation(); playNextSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="music-view-full">
        <div id="full-player-bg"></div>

        <div class="full-player-header" style="padding: 50px 20px 0 20px; display:flex; justify-content:space-between; align-items:center;">
            <div class="fp-btn" onclick="closeFullPlayer()">
                <svg viewBox="0 0 24 24" fill="white" width="30" height="30"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            </div>
            <div class="fp-actions" style="display:flex;">
                <button class="fp-icon-btn" onclick="triggerMusicBgUpload()">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </button>
                <button class="fp-icon-btn" onclick="openListenTogetherPage()">
                    <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                </button>
            </div>
            <input type="file" id="music-bg-input" accept="image/*" hidden onchange="handleMusicBgUpload(this)">
        </div>

        <div class="full-player-content">
            <div class="disk-wrapper">
                <div class="disk-cover" id="full-cover"></div>
            </div>

            <div style="width:100%; text-align:left; margin-bottom:10px;">
                <div class="fp-title" id="full-title" style="font-size:24px; font-weight:700; color:white; margin-bottom:5px;">Song Name</div>
                <div class="fp-artist" id="full-artist" style="font-size:16px; color:rgba(255,255,255,0.6);">Artist</div>
            </div>

            <div class="lyrics-box" onclick="openLyricsModal()" style="height:40px; color:rgba(255,255,255,0.8);">
                <span id="current-lyric-line">暂无歌词 - 点击添加</span>
            </div>

            <div class="fp-progress-container">
                <input type="range" class="fp-slider" id="music-slider" min="0" value="0" max="100" oninput="seekAudio(this.value)">
                <div class="time-row">
                    <span id="time-current">0:00</span>
                    <span id="time-total">0:00</span>
                </div>
            </div>

            <div class="fp-controls">
                <button class="fp-ctrl-btn small" onclick="togglePlayMode()">
                    <svg id="icon-mode-0" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    <svg id="icon-mode-1" viewBox="0 0 24 24" style="display:none"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z"/></svg>
                    <svg id="icon-mode-2" viewBox="0 0 24 24" style="display:none"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                </button>

                <button class="fp-ctrl-btn" onclick="playPrevSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>

                <button class="fp-ctrl-btn big" onclick="togglePlayState()" id="full-play-btn">
                    <svg id="fp-icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="fp-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <button class="fp-ctrl-btn" onclick="playNextSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>

                <button class="fp-ctrl-btn small" onclick="openPlaylistSheet()">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-music-upload">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">添加歌曲</span></div>
        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div id="upload-cover-preview" onclick="document.getElementById('new-song-cover').click()"
                 style="width:70px; height:70px; background:rgba(255,255,255,0.1); border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover;">
                <span style="font-size:24px; color:rgba(255,255,255,0.5);">+</span>
            </div>
            <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                <input type="text" class="search-box" id="new-song-title" placeholder="歌曲名称" style="margin:0;">
                <input type="text" class="search-box" id="new-song-artist" placeholder="歌手" style="margin:0;">
            </div>
        </div>
        <input type="file" id="new-song-cover" accept="image/*" hidden onchange="previewNewSongCover(this)">

        <div class="ai-item-label" style="margin-bottom:5px;">音频来源</div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="tab-btn active" onclick="switchAudioSource('file')" id="btn-src-file">本地文件</button>
            <button class="tab-btn" onclick="switchAudioSource('url')" id="btn-src-url">在线 URL</button>
        </div>

        <div id="src-file-area" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px;">
            <button class="file-upload-btn" onclick="document.getElementById('new-song-file').click()">选择 MP3 文件</button>
            <div id="new-song-filename" style="font-size:12px; color:#999; margin-top:5px;">未选择</div>
            <input type="file" id="new-song-file" accept="audio/*" hidden onchange="handleNewSongFile(this)">
        </div>
        <div id="src-url-area" style="display:none; margin-top: 15px;">
            <input type="text" class="search-box" id="new-song-url" placeholder="https://example.com/music.mp3">
        </div>

        <div class="modal-footer" style="margin-top:20px;">
            <button class="modal-btn btn-cancel" onclick="closeMusicUploadModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveNewSong()">保存</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-lyrics">
    <div class="modal-content" style="height:70%;">
        <div class="modal-header"><span class="modal-title">编辑歌词</span></div>
        <textarea class="code-textarea" id="lyrics-input" placeholder="在此粘贴歌词..." style="height:100%; margin-bottom:15px;"></textarea>
        <div class="modal-footer" style="justify-content: space-between;">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('lrc-file').click()">📂 导入 LRC</button>
            <input type="file" id="lrc-file" accept=".lrc,.txt" hidden onchange="handleLrcFile(this)">

            <div style="display:flex; gap:10px;">
                <button class="modal-btn btn-save" onclick="saveLyrics()">保存</button>
                <button class="modal-btn btn-cancel" onclick="document.getElementById('modal-lyrics').classList.remove('active'); setTimeout(()=>document.getElementById('modal-lyrics').style.display='none',300);">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="sub-page" id="sheet-playlist" style="top:auto; bottom:0; height:60vh; border-radius:24px 24px 0 0; transform:translateY(100%); transition:transform 0.3s; background:#1c1c1e; z-index:900;">
    <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; font-size:18px; color:white;">播放列表</span>
        <span onclick="closePlaylistSheet()" style="cursor:pointer; padding:5px; color:#0a84ff;">关闭</span>
    </div>
    <div id="sheet-list-content" style="overflow-y:auto; height:calc(100% - 60px); padding:10px;"></div>
</div>
<div class="modal-overlay" id="modal-song-menu" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closeSongMenu()"></div>

    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="openEditSongModal()">
                <span style="color: #0a84ff;">编辑歌曲信息</span>
            </div>
            <div class="sheet-item" onclick="openDeleteConfirmModal()" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #FF3B30;">删除歌曲</span>
            </div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closeSongMenu()" style="font-weight: 600;">
                取消
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-edit-song">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">编辑信息</span>
        </div>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">歌曲名称</div>
                <input type="text" class="search-box" id="edit-title-input" style="margin:0;">
            </div>
            <div>
                <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">歌手 / 专辑</div>
                <input type="text" class="search-box" id="edit-artist-input" style="margin:0;">
            </div>
        </div>

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeEditSongModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveSongEdit()">保存修改</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-delete-confirm">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 20px;">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">删除歌曲</div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 25px; line-height: 1.5;">
            确定要删除 <span id="del-song-name" style="color:white;">这首歌</span> 吗？<br>此操作无法恢复。
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeDeleteConfirmModal()">取消</button>
            <button class="modal-btn" onclick="confirmDeleteSong()" style="background: #FF3B30; color: white; border: none;">删除</button>
        </div>
    </div>
</div>
<div id="island-popup-mask" onclick="closeIslandPopup()"></div>

<div id="island-popup-player" class="island-popup">
    <div class="popup-backdrop"></div>

    <div class="popup-content">
        <div class="popup-top">
            <div class="popup-cover" id="popup-cover"></div>

            <div class="popup-info">
                <div class="popup-title" id="popup-title">Song Name</div>
                <div class="popup-artist" id="popup-artist">Artist</div>
            </div>

            <div style="display:flex; align-items:center;">
                <button class="popup-icon-btn" onclick="openPlaylistSheet(); closeIslandPopup();">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                </button>

                <button class="btn-close-popup" onclick="closeIslandPopup()">
                    <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
        </div>

        <div class="popup-progress">
            <span class="time-tiny" id="popup-time-current">0:00</span>
            <input type="range" class="fp-slider popup-slider" id="popup-slider" min="0" value="0" max="100" oninput="seekAudio(this.value)">
            <span class="time-tiny" id="popup-time-total">0:00</span>
        </div>

        <div class="popup-controls">
            <button class="popup-btn" onclick="playPrevSong()">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </button>

            <button class="popup-btn big" onclick="togglePlayState()" id="popup-play-btn">
                <svg id="popup-icon-play" viewBox="0 0 24 24" style="margin-left:2px;"><path d="M8 5v14l11-7z"/></svg>
                <svg id="popup-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>

            <button class="popup-btn" onclick="playNextSong()">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-listen-together" style="background: #121212; z-index: 300;">

    <div class="app-header" style="background: transparent; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-listen-together')">
            <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </div>
        <div class="app-title">一起听</div>
    </div>

    <div class="listen-visualizer">
        <div class="visual-avatar-box left-box">
            <div class="visual-avatar empty" id="listen-role-avatar" onclick="openListenRoleSelector()">
                <span>+</span>
            </div>
            <div class="visual-name" id="listen-role-name">点击选择</div>
        </div>

        <div class="connection-bridge left-bridge" id="bridge-left">
            <svg class="bridge-svg" preserveAspectRatio="none" viewBox="0 0 100 60">
                <path class="line-path" d="M0,30 L40,30 L50,10 L60,50 L70,30 L100,30" />
            </svg>
        </div>

        <div class="visual-heart-center">
            <svg class="visual-heart-icon-red" viewBox="0 0 24 24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        </div>

        <div class="connection-bridge right-bridge">
            <svg class="bridge-svg" preserveAspectRatio="none" viewBox="0 0 100 60">
                <path class="line-path" d="M0,30 L30,30 L40,10 L50,50 L60,30 L100,30" />
            </svg>
        </div>

        <div class="visual-avatar-box right-box">
            <div class="visual-avatar active-me" id="listen-user-avatar" onclick="openListenUserEdit()">
                <span style="font-size: 16px; font-weight:600;">Me</span>
            </div>
            <div class="visual-name" id="listen-user-name">我</div>
        </div>
    </div>

    <div class="listen-timer-box">
        <span class="timer-label">一起听时长</span>
        <span id="listen-timer-text">00:00</span>
    </div>

    <div class="listen-chat-area" id="listen-chat-box">
        <div class="chat-msg system">
            <span>开始一起听歌吧~</span>
        </div>
    </div>

    <div class="listen-input-wrapper">
        <div class="listen-input-bar">
            <input type="text" id="listen-input" placeholder="说点什么...">
            <button class="listen-icon-btn magic-btn" onclick="triggerAiReply()">
                <svg viewBox="0 0 24 24"><path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/></svg>
            </button>
            <button class="listen-icon-btn send-btn" onclick="sendListenMessage()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
        <div class="listen-clear-btn" onclick="clearListenChat()">
            清空聊天记录
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-select-role">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">选择角色</span></div>
        <div id="listen-role-list" style="max-height: 300px; overflow-y: auto;">
        </div>
        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-select-role')">取消</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-edit-user">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">完善我的信息</span></div>

        <div style="display:flex; justify-content:center; margin-bottom:15px;">
            <div id="edit-user-preview" onclick="document.getElementById('listen-user-file').click()"
                 style="width:80px; height:80px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover;">
                📷
            </div>
            <input type="file" id="listen-user-file" accept="image/*" hidden onchange="previewListenUserAvatar(this)">
        </div>

        <div class="ai-item-label" style="margin-bottom:5px;">昵称</div>
        <input type="text" class="search-box" id="listen-user-nick-input" style="margin:0;">

        <div class="ai-item-label" style="margin:10px 0 5px 0;">身份/设定</div>
        <input type="text" class="search-box" id="listen-user-identity-input" placeholder="例如: 你的同学" style="margin:0;">

        <div class="modal-footer" style="margin-top:20px;">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-edit-user')">取消</button>
            <button class="modal-btn btn-save" onclick="saveListenUser()">保存</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-countdown">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">倒数日设置</span>
        </div>

        <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">事件名称</div>
        <input type="text" class="search-box" id="input-cd-title" placeholder="例如: 恋爱纪念日" style="margin-bottom:15px;">

        <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">目标日期</div>
        <input type="date" class="search-box" id="input-cd-date" style="background:rgba(255,255,255,0.1); color:white; margin-bottom:15px;">

        <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">背景图片 (可选)</div>
        <div class="settings-item" onclick="document.getElementById('input-cd-bg').click()" style="border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:10px; justify-content:center;">
            <span style="color:#0a84ff;">📷 更换背景图</span>
        </div>
        <input type="file" id="input-cd-bg" accept="image/*" hidden onchange="handleCdBgUpload(this)">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeCountdownModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveCountdown()">保存</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-widget-bg" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-widget-bg')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">组件背景</div>
    </div>

    <div class="wallpaper-content">
        <div style="font-size:13px; color:#888; margin:0 0 20px 5px; line-height:1.4;">
            为组件设置背景图后，将自动移除原本的磨砂玻璃效果。
        </div>

        <div class="ai-header-text">天气</div>
        <div class="widget-set-card">
            <div class="widget-preview-box ratio-square">
                <div class="widget-preview-shape" id="preview-widget-weather">
                    <span class="widget-preview-text">天气组件预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="triggerWidgetBgUpload('weather')">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetWidgetBg('weather')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">音乐</div>
        <div class="widget-set-card">
            <div class="widget-preview-box ratio-rect">
                <div class="widget-preview-shape" id="preview-widget-music">
                    <span class="widget-preview-text">音乐组件预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="triggerWidgetBgUpload('music')">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetWidgetBg('music')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">语音条 (第二页)</div>
        <div class="widget-set-card">
            <div class="widget-preview-box ratio-strip">
                <div class="widget-preview-shape" id="preview-widget-voice-a">
                    <span class="widget-preview-text">语音组件预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="triggerWidgetBgUpload('voice-a')">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetWidgetBg('voice-a')">还原</button>
            </div>
        </div>

        <input type="file" id="input-widget-bg" accept="image/*" hidden onchange="handleWidgetBgFile(this)">
    </div>
</div>

<div class="modal-overlay" id="modal-reset-widget">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 25px 20px;">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">还原默认样式</div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 25px; line-height: 1.5;">
            确定要移除背景图片，恢复默认的毛玻璃效果吗？
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeResetModal()">取消</button>
            <button class="modal-btn" onclick="confirmResetExec()" style="background: #FF3B30; color: white;">还原</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-chat">

    <!-- 1. 透明头部 -->
    <div class="app-header" style="background: transparent; border-bottom: none; z-index: 60;">
        <div class="app-back-btn" id="chat-back-btn" onclick="closeApp('app-chat')">
            <svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title" style="color:white; font-weight:600;">聊天</div>
        <!-- 右侧加个加号，方便后面做创建功能 -->
        <div style="position: absolute; right: 20px; font-size: 24px; color: white; cursor: pointer;" onclick="openChatTypeMenu()">+</div>
    </div>

    <!-- 2. 主体内容区 (Message 模块) -->
    <!-- 只有当底部选“消息”时显示 -->
    <div id="chat-module-msg" class="chat-module-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">

        <!-- 顶部圆角选项卡 (只在消息页显示) -->
        <div class="chat-top-tabs-container">
            <div class="chat-tab-btn active" onclick="switchChatTopTab('list')">消息列表</div>
            <div class="chat-tab-btn" onclick="switchChatTopTab('group')">群聊</div>
            <div class="chat-tab-btn" onclick="switchChatTopTab('friend')">好友</div>
        </div>

        <!-- 2.1 消息列表视图 -->
        <div class="chat-page-content active" id="view-chat-list">
            <div class="chat-placeholder-text">暂无消息<br>找个好友聊聊天吧</div>
            <!-- 这里以后放真正的消息列表 -->
        </div>

        <!-- 2.2 群聊视图 -->
        <div class="chat-page-content" id="view-chat-group">
            <div class="chat-placeholder-text">暂无群聊</div>
        </div>

        <!-- 2.3 好友视图 (角色列表) -->
        <div class="chat-page-content" id="view-chat-friend">
            <div class="chat-placeholder-text">好友列表加载中...</div>
        </div>
    </div>

    <!-- 3. 动态模块 -->
    <div id="chat-module-moments" class="chat-module-container" style="flex:1; display:none; padding-top:20px;">
        <div class="chat-placeholder-text">朋友圈 / 动态<br>(开发中)</div>
    </div>

    <!-- 4. 我的模块 -->
    <div id="chat-module-me" class="chat-module-container" style="flex:1; display:none; padding-top:20px;">
        <div class="chat-placeholder-text">个人中心<br>(开发中)</div>
    </div>

    <!-- 5. 底部悬浮导航栏 -->
    <div class="chat-bottom-nav">
        <!-- 消息 -->
        <div class="chat-nav-item active" onclick="switchChatBottomNav('msg', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            <span class="chat-nav-text">消息</span>
        </div>
        <!-- 动态 -->
        <div class="chat-nav-item" onclick="switchChatBottomNav('moments', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
            <span class="chat-nav-text">动态</span>
        </div>
        <!-- 我的 -->
        <div class="chat-nav-item" onclick="switchChatBottomNav('me', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span class="chat-nav-text">我的</span>
        </div>
    </div>

</div>

<div class="modal-overlay" id="modal-chat-type" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closeChatTypeMenu()"></div>
    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="openCreateSingleModal()">
                <span style="font-weight:600;">单人聊天</span>
            </div>
            <div class="sheet-item" onclick="openCreateGroupModal()" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <span style="font-weight:600;">群组聊天</span>
            </div>
        </div>
        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closeChatTypeMenu()" style="font-weight: 600;">取消</div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-create-single" style="background: #1c1c1e;">
    <div class="app-header" style="background:inherit; border-bottom:none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-create-single')">取消</div>
        <div class="app-title">创建单聊</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-weight: 600;" onclick="saveSingleChat()">完成</div>
    </div>

    <div class="wallpaper-content">
        <div class="create-chat-tabs">
            <div class="create-chat-tab active" onclick="switchSingleTab('custom', this)">自定义创建</div>
            <div class="create-chat-tab" onclick="switchSingleTab('import', this)">从角色书导入</div>
        </div>

        <div id="single-custom-area">
            <div class="chat-avatar-upload" id="single-avatar-preview" onclick="document.getElementById('input-single-avatar').click()">
                <span class="chat-avatar-icon">+</span>
            </div>
            <input type="file" id="input-single-avatar" accept="image/*" hidden onchange="previewChatAvatar('single-avatar-preview', this)">

            <div class="settings-group">
                <div class="settings-item">
                    <span>昵称</span>
                    <input type="text" id="input-single-name" placeholder="请输入名字" style="border:none; background:transparent; color:white; text-align:right; outline:none;">
                </div>
            </div>
        </div>

        <div id="single-import-area" style="display:none; overflow-y:auto; height:calc(100vh - 200px);">
            <div id="import-role-list-single"></div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-create-group" style="background: #1c1c1e;">
    <div class="app-header" style="background:inherit; border-bottom:none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-create-group')">取消</div>
        <div class="app-title">创建群聊</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-weight: 600;" onclick="saveGroupChat()">完成</div>
    </div>

    <div class="wallpaper-content">
        <div class="settings-group" style="margin-bottom:15px;">
            <div class="settings-item">
                <span>群名称</span>
                <input type="text" id="input-group-name" placeholder="例如: 摸鱼小分队" style="border:none; background:transparent; color:white; text-align:right; outline:none;">
            </div>
        </div>

        <div class="create-chat-tabs">
            <div class="create-chat-tab active" onclick="switchGroupTab('custom', this)">自定义成员</div>
            <div class="create-chat-tab" onclick="switchGroupTab('import', this)">从角色书选择</div>
        </div>

        <div id="group-custom-area">
            <div class="settings-group">
                <div class="settings-item">
                    <span>群成员数量</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="icon-btn" style="background:rgba(255,255,255,0.1);" onclick="adjustMemberCount(-1)">-</button>
                        <span id="group-member-count" style="width:20px; text-align:center;">3</span>
                        <button class="icon-btn" style="background:rgba(255,255,255,0.1);" onclick="adjustMemberCount(1)">+</button>
                    </div>
                </div>
            </div>
            <div style="margin:10px 0 5px 5px; font-size:12px; color:#888;">成员信息设置</div>
            <div id="group-custom-list">
            </div>
        </div>

        <div id="group-import-area" style="display:none; overflow-y:auto; height:calc(100vh - 300px);">
            <div id="import-role-list-group"></div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-chat-delete" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-chat-delete')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title" style="color: #FF3B30;">删除聊天</div>
    </div>

    <div class="wallpaper-content" style="display: flex; flex-direction: column; align-items: center; padding-top: 60px;">

        <div style="width: 80px; height: 80px; background: rgba(255, 59, 48, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <svg style="width: 40px; height: 40px; fill: #FF3B30;" viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
        </div>

        <div style="font-size: 20px; font-weight: 600; color: white; margin-bottom: 10px;">
            删除该对话？
        </div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); text-align: center; max-width: 80%; line-height: 1.5;">
            删除后，您将无法查看与 <span id="del-chat-target-name" style="color:white; font-weight:bold;"></span> 的聊天记录。<br>此操作不可撤销。
        </div>

        <div style="position: absolute; bottom: 50px; width: 90%; display: flex; flex-direction: column; gap: 15px;">
            <button class="ai-btn" onclick="confirmDeleteChatAction()" style="background: #FF3B30; color: white;">
                确认删除
            </button>
            <button class="ai-btn ai-btn-secondary" onclick="closeSubPage('sub-chat-delete')" style="background: rgba(255,255,255,0.1); color: white;">
                取消
            </button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-chat-detail">

    <div id="chat-input-menu">
        <div class="chat-scroll-menu">

            <div class="menu-pill-card" onclick="handleMenuAction('photo')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                <span class="pill-text">Photo</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('voice')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3.9-3.23 6.9-7.3 6.9S4.7 13.9 4.7 11H3c0 4.1 3.5 7.5 8 8v3h2v-3c4.5-.5 8-3.9 8-8h-1.7z"/></svg>
                <span class="pill-text">Voice</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('video')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                <span class="pill-text">Video</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('location')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                <span class="pill-text">Location</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('money')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-3-6c0-1.1-.9-2-2-2H9v-2h4v1h2V7H9v2H7v-2H5v2H9c1.1 0 2 .9 2 2v4h6v-4h-4v-1h4v-2z"/></svg>
                <span class="pill-text">Money</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('heart')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span class="pill-text">Heart</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('shop')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                <span class="pill-text">Shop</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('gift')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20 9H4v2h16V9zm-1 5H5v-2h14v2zm-1 4H5v-2h14v2zM21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H3V6h18v12z"/></svg>
                <span class="pill-text">Gift</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('game')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20 6h-8v4H8V6H4v4H2v10h2v-3h2v-1h4v-2h2v4h8V6zm0 12h-8v-4h4v2h2v-2h2v2zm-4-8h-4V6h4v4z"/></svg>
                <span class="pill-text">Game</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('phone')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
                <span class="pill-text">Phone</span>
            </div>

        </div>
    </div>

    <div class="chat-detail-header">
        <div class="glass-circle-btn" onclick="closeSubPage('sub-chat-detail')">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>

        <div class="chat-user-info">
            <div class="chat-user-avatar" id="chat-detail-avatar"></div>
            <div class="chat-user-name" id="chat-detail-name">用户名称</div>
            <div class="chat-user-status">Online</div>
        </div>

        <div class="glass-circle-btn" onclick="openChatSettings()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </div>
    </div>

    <div class="chat-detail-body" id="chat-detail-msgs">
        <div class="chat-msg system"><span>2月26日 16:20</span></div>
        <div class="chat-msg left"><div class="msg-bubble-listen">你好呀！最近怎么样？</div></div>
        <div class="chat-msg right"><div class="msg-bubble-listen">挺好的，刚刚在听歌。</div></div>
    </div>

    <div class="chat-detail-footer">
        <button class="chat-footer-btn" onclick="toggleInputMenu()">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </button>

        <div class="chat-input-pill">
            <input type="text" class="chat-input-real" id="chat-msg-input" placeholder="发消息...">
        </div>

        <button class="chat-footer-btn" onclick="triggerChatDetailAI()">
            <svg viewBox="0 0 24 24">
                <path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/>
            </svg>
        </button>

        <button class="chat-footer-btn" onclick="sendChatDetailMsg()">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>

</div>

<div class="modal-overlay" id="modal-message-menu" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closeMessageMenu()"></div>

    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="handleMessageAction('quote')">引用 (Quote)</div>
            <div class="sheet-item" onclick="handleMessageAction('forward')">转发 (Forward)</div>
            <div class="sheet-item" onclick="handleMessageAction('favorite')">收藏 (Favorite)</div>
            <div class="sheet-item" onclick="handleMessageAction('edit')">编辑 (Edit)</div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="handleMessageAction('recall')">撤回 (Recall)</div>
            <div class="sheet-item" onclick="handleMessageAction('delete')">删除 (Delete)</div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="handleMessageAction('multi-select')">多选 (Multi-select)</div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closeMessageMenu()" style="font-weight: 600;">取消</div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-chat-settings" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-chat-settings')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">聊天设置</div>
        <div style="position:absolute; right:15px; color:#0a84ff; font-weight:600; cursor:pointer;" onclick="saveChatSettingsDetail()">保存</div>
    </div>

    <div class="wallpaper-content">

        <div class="group-header">聊天背景</div>
        <div class="widget-set-card">
            <div class="widget-preview-box" style="aspect-ratio: 16/9; height: 150px;">
                <div class="widget-preview-shape" id="preview-chat-bg" style="width:100%; height:100%; border-radius: 12px; background-size: cover; background-position: center;">
                    <span class="widget-preview-text">当前背景预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="document.getElementById('input-chat-bg').click()">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetChatBackground()">恢复默认</button>
            </div>
        </div>

        <input type="file" id="input-chat-bg" accept="image/*" hidden onchange="handleChatBgUpload(this)">

        <div style="padding: 0 10px; font-size: 13px; color: #666; line-height: 1.5;">
            提示：设置背景图后，聊天气泡和输入栏会自动适应背景，保持磨砂玻璃效果。
        </div>

        <div class="group-header">对方设定 (Char)</div>
        <div class="settings-group" style="padding: 15px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <div class="v-cover-box" id="setting-char-avatar" onclick="triggerSettingAvatar('char')"></div>
                <input type="file" id="input-setting-char-avatar" hidden onchange="previewSettingAvatar('char', this)">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">昵称 (点击修改)</div>
                    <input type="text" id="setting-char-name" class="search-box" style="margin:0; text-align:left; background:rgba(255,255,255,0.05);">
                </div>
            </div>

            <div style="font-size:12px; color:#888;">人设详情 (点击展开编辑)</div>
            <div class="setting-text-preview" id="setting-char-desc-preview" onclick="openTextEditModal('char-desc')">
                暂无人设信息...
            </div>
        </div>

        <div class="group-header">世界观 (World)</div>
        <div class="settings-group" style="padding: 15px;">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="tab-btn active" onclick="openWorldSelectModal()">+ 选择设定</button>
                <button class="tab-btn" onclick="addCustomWorldTag()">+ 自定义</button>
            </div>
            <div class="world-tags-container" id="setting-world-tags">
            </div>
        </div>

        <div class="group-header">我的设定 (User)</div>
        <div class="settings-group" style="padding: 15px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <div class="v-cover-box" id="setting-user-avatar" onclick="triggerSettingAvatar('user')"></div>
                <input type="file" id="input-setting-user-avatar" hidden onchange="previewSettingAvatar('user', this)">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">我的昵称</div>
                    <input type="text" id="setting-user-name" class="search-box" style="margin:0; text-align:left; background:rgba(255,255,255,0.05);">
                </div>
            </div>
            <div style="font-size:12px; color:#888;">我的人设</div>
            <div class="setting-text-preview" id="setting-user-desc-preview" onclick="openTextEditModal('user-desc')">
                暂无...
            </div>
        </div>

        <div class="group-header">显示与气泡</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>聊天显示头像</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-show-avatar" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-group" style="padding:15px; margin-top:10px;">
            <div style="font-size:12px; color:#888; margin-bottom:10px;">气泡样式</div>
            <div class="bubble-style-scroll">
                <div class="bubble-preset-item active" onclick="selectBubbleStyle('default', this)">
                    <div class="mini-bubble-preview" style="border-radius:18px;"></div>
                    <span>默认</span>
                </div>
                <div class="bubble-preset-item" onclick="selectBubbleStyle('box', this)">
                    <div class="mini-bubble-preview" style="border-radius:4px;"></div>
                    <span>方块</span>
                </div>
                <div class="bubble-preset-item" onclick="selectBubbleStyle('trans', this)">
                    <div class="mini-bubble-preview" style="background:rgba(255,255,255,0.2); border:1px solid white;"></div>
                    <span>透明</span>
                </div>
                <div class="bubble-preset-item" onclick="selectBubbleStyle('custom', this)">
                    <span>自定义CSS</span>
                </div>
            </div>
            <textarea id="custom-bubble-css" class="code-textarea" style="height:80px; margin-top:10px; display:none;" placeholder="输入 .msg-bubble-listen { ... }"></textarea>
        </div>

        <div class="group-header">记录与管理</div>

        <div class="search-container" style="border-radius:12px; padding:0; margin-bottom:10px;">
            <input type="text" class="settings-search" id="chat-history-search" placeholder="🔍 搜索聊天记录..." oninput="searchChatHistory(this.value)">
        </div>
        <div id="search-result-box" style="max-height:150px; overflow-y:auto; display:none; background:rgba(0,0,0,0.2); border-radius:10px; padding:10px;"></div>

        <div class="danger-zone">
            <button class="btn-danger-outline" onclick="clearCurrentChatHistory()">清空聊天记录</button>
            <button class="btn-danger-outline" id="btn-block-user" onclick="toggleBlockUser()">拉黑该好友</button>
            <button class="btn-danger-fill" onclick="deleteCurrentChatAndFriend()">删除好友并退出</button>
        </div>

        <div style="height:50px;"></div>
    </div>
</div>

<div class="modal-overlay" id="modal-text-edit">
    <div class="modal-content" style="height:60%;">
        <div class="modal-header"><span class="modal-title">编辑内容</span></div>
        <textarea class="code-textarea" id="big-text-input" style="height:100%; font-size:16px;"></textarea>
        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeTextEditModal()">取消</button>
            <button class="modal-btn btn-save" onclick="confirmTextEdit()">确定</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-world-select">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">选择世界观</span></div>
        <div id="world-select-list" style="max-height:300px; overflow-y:auto;"></div>
        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('modal-world-select').classList.remove('active')">关闭</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-general-input">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title" id="gen-input-title">标题</span>
        </div>

        <div class="ai-item-label" id="gen-input-label" style="margin-bottom:10px;">请输入内容</div>
        <input type="text" class="search-box" id="gen-input-field" style="margin-bottom:20px; text-align:left;">

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeGenInputModal()">取消</button>
            <button class="modal-btn btn-save" id="gen-input-confirm-btn">确定</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-general-confirm">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 25px 20px;">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;" id="gen-confirm-title">确认操作</div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 25px; line-height: 1.5;" id="gen-confirm-desc">
            描述文本
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeGenConfirmModal()">取消</button>
            <button class="modal-btn" id="gen-confirm-btn" style="background: #FF3B30; color: white;">确认</button>
        </div>
    </div>
</div>
<script>
    // --- 补上通用的弹窗函数 ---
    function showToast(msg) {
        const toast = document.getElementById('global-toast');
        const text = document.getElementById('toast-text');
        if (toast && text) {
            text.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        } else {
            // 如果还没加 HTML，就退化成普通弹窗，防止报错
            alert(msg);
        }
    }
    // --- 0. 数据库工具 (升级版) ---
    const dbName = "AIPhoneDB_V2";
    const storeName = "media_files";
    const dbHelper = {
        open: function() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName);
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        },
        save: async function(key, value) {
            const db = await this.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readwrite");
                const request = tx.objectStore(storeName).put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        },
        get: async function(key) {
            const db = await this.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readonly");
                const request = tx.objectStore(storeName).get(key);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }
    };
    // --- 1. 基础 UI 逻辑 (时钟/电池) ---
    // ================== 全局时钟与时区逻辑 (修复完整版) ==================

    // 1. 海量时区数据库 (必须包含 name, detail, id)
    const timeZones = [
        // 亚洲
        { name: "北京", detail: "中国标准时间", id: "Asia/Shanghai" },
        { name: "香港", detail: "香港时间", id: "Asia/Hong_Kong" },
        { name: "台北", detail: "台北时间", id: "Asia/Taipei" },
        { name: "东京", detail: "日本", id: "Asia/Tokyo" },
        { name: "首尔", detail: "韩国", id: "Asia/Seoul" },
        { name: "新加坡", detail: "新加坡", id: "Asia/Singapore" },
        { name: "曼谷", detail: "泰国", id: "Asia/Bangkok" },
        { name: "迪拜", detail: "阿联酋", id: "Asia/Dubai" },
        { name: "新德里", detail: "印度", id: "Asia/Kolkata" },

        // 美洲
        { name: "纽约", detail: "美国东部", id: "America/New_York" },
        { name: "洛杉矶", detail: "美国太平洋", id: "America/Los_Angeles" },
        { name: "芝加哥", detail: "美国中部", id: "America/Chicago" },
        { name: "温哥华", detail: "加拿大", id: "America/Vancouver" },
        { name: "多伦多", detail: "加拿大", id: "America/Toronto" },
        { name: "墨西哥城", detail: "墨西哥", id: "America/Mexico_City" },
        { name: "圣保罗", detail: "巴西", id: "America/Sao_Paulo" },

        // 欧洲
        { name: "伦敦", detail: "英国", id: "Europe/London" },
        { name: "巴黎", detail: "法国", id: "Europe/Paris" },
        { name: "柏林", detail: "德国", id: "Europe/Berlin" },
        { name: "罗马", detail: "意大利", id: "Europe/Rome" },
        { name: "莫斯科", detail: "俄罗斯", id: "Europe/Moscow" },
        { name: "阿姆斯特丹", detail: "荷兰", id: "Europe/Amsterdam" },
        { name: "马德里", detail: "西班牙", id: "Europe/Madrid" },
        { name: "苏黎世", detail: "瑞士", id: "Europe/Zurich" },

        // 大洋洲
        { name: "悉尼", detail: "澳大利亚", id: "Australia/Sydney" },
        { name: "墨尔本", detail: "澳大利亚", id: "Australia/Melbourne" },
        { name: "奥克兰", detail: "新西兰", id: "Pacific/Auckland" },

        // 非洲
        { name: "开罗", detail: "埃及", id: "Africa/Cairo" },
        { name: "约翰内斯堡", detail: "南非", id: "Africa/Johannesburg" }
    ];

    // 2. 地区名称映射表
    const regionMap = {
        "Asia": "亚洲",
        "America": "美洲",
        "Europe": "欧洲",
        "Australia": "大洋洲",
        "Pacific": "大洋洲",
        "Africa": "非洲",
        "Etc": "其他"
    };

    // 3. 渲染时区列表 (修复版逻辑)
    function initTimeZoneList() {
        filterTimeZones(); // 初始化时渲染一次
    }

    function filterTimeZones() {
        const container = document.getElementById('timezone-list-container');
        const searchInput = document.getElementById('timezone-search');
        // 防止报错：如果还没加载输入框，就默认为空
        const keyword = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const currentZone = localStorage.getItem('userTimeZone') || 'Asia/Shanghai';

        container.innerHTML = ''; // 清空列表

        // 过滤数据
        let filteredList = timeZones.filter(tz => {
            if (!keyword) return true;
            // 这里的 detail 必须存在，否则会报错。上面的数据里我已经补全了 detail
            return tz.name.toLowerCase().includes(keyword) || (tz.detail && tz.detail.toLowerCase().includes(keyword));
        });

        if (filteredList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:40px; font-size:14px;">未找到结果</div>';
            return;
        }

        // 分组逻辑
        const groups = {};
        filteredList.forEach(tz => {
            const regionKey = tz.id.split('/')[0];
            const regionName = regionMap[regionKey] || "其他地区";
            if (!groups[regionName]) groups[regionName] = [];
            groups[regionName].push(tz);
        });

        const regionOrder = ["亚洲", "欧洲", "美洲", "大洋洲", "非洲", "其他地区"];
        const sortedKeys = regionOrder.filter(k => groups[k]).concat(Object.keys(groups).filter(k => !regionOrder.includes(k)));

        sortedKeys.forEach(regionName => {
            const cityList = groups[regionName];

            // 分组标题
            const header = document.createElement('div');
            header.className = 'group-header';
            header.textContent = regionName;
            container.appendChild(header);

            // 分组卡片
            const groupCard = document.createElement('div');
            groupCard.className = 'settings-group';

            cityList.forEach(tz => {
                const isSelected = tz.id === currentZone;
                const item = document.createElement('div');
                item.className = `settings-item ${isSelected ? 'selected' : ''}`;
                item.onclick = () => setTimeZone(tz.id, tz.name);

                item.innerHTML = `
                    <div>
                        <div class="city-name">${tz.name}</div>
                        <div class="city-detail">${tz.detail}</div>
                    </div>
                    <span class="check-icon">✔</span>
                `;
                groupCard.appendChild(item);
            });
            container.appendChild(groupCard);
        });
    }

    // 4. 设置时区功能
    function setTimeZone(zoneId, zoneName) {
        localStorage.setItem('userTimeZone', zoneId);

        // 清空搜索框
        const searchInput = document.getElementById('timezone-search');
        if(searchInput) searchInput.value = '';

        filterTimeZones();
        updateTime();
        showToast(`时区已切换至 ${zoneName}`);
        closeSubPage('sub-timezone');
    }

    // 打开子页面的功能
    function openSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.add('active');
        } else {
            console.error("找不到子页面:", id);
        }
    }

    // 关闭子页面的功能
    function closeSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.remove('active');
        }
    }

    // 6. 核心时间更新
    function updateTime() {
        const userZone = localStorage.getItem('userTimeZone') || 'Asia/Shanghai';
        const now = new Date();

        try {
            // 更新时钟
            const timeString = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit', minute: '2-digit', hour12: false, timeZone: userZone
            }).format(now);

            const clockEl = document.getElementById('clock');
            if(clockEl) clockEl.textContent = timeString;

            // 更新日期
            const dateParts = new Intl.DateTimeFormat('zh-CN', {
                month: 'numeric', day: 'numeric', weekday: 'long', timeZone: userZone
            }).formatToParts(now);

            const weekdayEl = document.getElementById('weekday-text');
            const dateEl = document.getElementById('date-text');

            if (weekdayEl && dateEl) {
                weekdayEl.textContent = dateParts.find(p => p.type === 'weekday').value;
                dateEl.textContent = `${dateParts.find(p => p.type === 'month').value}月${dateParts.find(p => p.type === 'day').value}日`;
            }

            // 更新设置页当前状态
            const currentObj = timeZones.find(t => t.id === userZone);
            const label = document.getElementById('current-timezone-label');
            if(label) label.textContent = currentObj ? currentObj.name : '未知';

        } catch(e) {
            console.error("时间更新出错:", e);
        }
    }

    // 启动
    initTimeZoneList();
    // 这里的 setInterval 是为了防止重复定义，先清除再设置
    if (window.clockInterval) clearInterval(window.clockInterval);
    window.clockInterval = setInterval(updateTime, 1000);
    updateTime();

    function initBattery() {
        const batteryLevel = document.getElementById('battery-fill');
        const batteryText = document.getElementById('battery-text');
        const chargingIcon = document.getElementById('charging-bolt');
        if('getBattery' in navigator) navigator.getBattery().then(b => {
            const update = () => {
                const level = b.level * 100;
                batteryText.textContent = Math.round(level) + "%";
                batteryLevel.style.width = level + "%";
                if(b.charging) { batteryLevel.style.backgroundColor = "#4CD964"; chargingIcon.style.display = "block"; }
                else if(level <= 20) { batteryLevel.style.backgroundColor = "#FF3B30"; chargingIcon.style.display = "none"; }
                else { batteryLevel.style.backgroundColor = "white"; chargingIcon.style.display = "none"; }
            };
            update(); b.addEventListener('levelchange', update); b.addEventListener('chargingchange', update);
        });
    }
    initBattery();

    // --- 2. 城市数据 (超大杯完整版) ---
    const cityDatabase = {
        domestic: [
            // --- 一线/新一线 ---
            { name: "北京", lat: 39.9042, lon: 116.4074 },
            { name: "上海", lat: 31.2304, lon: 121.4737 },
            { name: "广州", lat: 23.1291, lon: 113.2644 },
            { name: "深圳", lat: 22.5431, lon: 114.0579 },
            { name: "成都", lat: 30.5728, lon: 104.0668 },
            { name: "重庆", lat: 29.5627, lon: 106.5528 },
            { name: "杭州", lat: 30.2741, lon: 120.1551 },
            { name: "武汉", lat: 30.5928, lon: 114.3055 },
            { name: "西安", lat: 34.3416, lon: 108.9398 },
            { name: "南京", lat: 32.0603, lon: 118.7969 },
            { name: "天津", lat: 39.0842, lon: 117.2009 },
            { name: "苏州", lat: 31.2989, lon: 120.5853 },
            { name: "长沙", lat: 28.2282, lon: 112.9388 },
            { name: "郑州", lat: 34.7466, lon: 113.6253 },

            // --- 东部沿海 ---
            { name: "青岛", lat: 36.0671, lon: 120.3826 },
            { name: "大连", lat: 38.9140, lon: 121.6147 },
            { name: "厦门", lat: 24.4798, lon: 118.0894 },
            { name: "宁波", lat: 29.8683, lon: 121.5440 },
            { name: "福州", lat: 26.0745, lon: 119.2965 },
            { name: "济南", lat: 36.6512, lon: 117.1201 },

            // --- 东北/西北 ---
            { name: "哈尔滨", lat: 45.8038, lon: 126.5349 },
            { name: "沈阳", lat: 41.8057, lon: 123.4315 },
            { name: "长春", lat: 43.8171, lon: 125.3235 },
            { name: "兰州", lat: 36.0611, lon: 103.8343 },
            { name: "乌鲁木齐", lat: 43.8256, lon: 87.6168 },
            { name: "呼和浩特", lat: 40.8419, lon: 111.7492 },

            // --- 西南/旅游热门 ---
            { name: "昆明", lat: 24.8801, lon: 102.8329 },
            { name: "丽江", lat: 26.8721, lon: 100.2297 },
            { name: "大理", lat: 25.6065, lon: 100.2676 },
            { name: "拉萨", lat: 29.6525, lon: 91.1721 },
            { name: "贵阳", lat: 26.6470, lon: 106.6302 },
            { name: "三亚", lat: 18.2528, lon: 109.5120 },
            { name: "海口", lat: 20.0440, lon: 110.1999 },
            { name: "桂林", lat: 25.2345, lon: 110.1800 },

            // --- 港澳台 ---
            { name: "香港", lat: 22.3193, lon: 114.1694 },
            { name: "澳门", lat: 22.1987, lon: 113.5439 },
            { name: "台北", lat: 25.0330, lon: 121.5654 },
            { name: "高雄", lat: 22.6273, lon: 120.3014 }
        ],
        international: [
            // --- 亚洲 ---
            { name: "东京", lat: 35.6895, lon: 139.6917 },
            { name: "大阪", lat: 34.6937, lon: 135.5023 },
            { name: "京都", lat: 35.0116, lon: 135.7681 },
            { name: "首尔", lat: 37.5665, lon: 126.9780 },
            { name: "曼谷", lat: 13.7563, lon: 100.5018 },
            { name: "新加坡", lat: 1.3521, lon: 103.8198 },
            { name: "吉隆坡", lat: 3.1390, lon: 101.6869 },
            { name: "胡志明市", lat: 10.8231, lon: 106.6297 },
            { name: "雅加达", lat: -6.2088, lon: 106.8456 },
            { name: "马尼拉", lat: 14.5995, lon: 120.9842 },
            { name: "新德里", lat: 28.6139, lon: 77.2090 },
            { name: "迪拜", lat: 25.2048, lon: 55.2708 },

            // --- 欧洲 ---
            { name: "伦敦", lat: 51.5074, lon: -0.1278 },
            { name: "巴黎", lat: 48.8566, lon: 2.3522 },
            { name: "柏林", lat: 52.5200, lon: 13.4050 },
            { name: "慕尼黑", lat: 48.1351, lon: 11.5820 },
            { name: "罗马", lat: 41.9028, lon: 12.4964 },
            { name: "米兰", lat: 45.4642, lon: 9.1900 },
            { name: "马德里", lat: 40.4168, lon: -3.7038 },
            { name: "巴塞罗那", lat: 41.3851, lon: 2.1734 },
            { name: "莫斯科", lat: 55.7558, lon: 37.6173 },
            { name: "阿姆斯特丹", lat: 52.3676, lon: 4.9041 },
            { name: "苏黎世", lat: 47.3769, lon: 8.5417 },

            // --- 北美 ---
            { name: "纽约", lat: 40.7128, lon: -74.0060 },
            { name: "洛杉矶", lat: 34.0522, lon: -118.2437 },
            { name: "旧金山", lat: 37.7749, lon: -122.4194 },
            { name: "芝加哥", lat: 41.8781, lon: -87.6298 },
            { name: "西雅图", lat: 47.6062, lon: -122.3321 },
            { name: "多伦多", lat: 43.6510, lon: -79.3470 },
            { name: "温哥华", lat: 49.2827, lon: -123.1207 },

            // --- 其他 ---
            { name: "悉尼", lat: -33.8688, lon: 151.2093 },
            { name: "墨尔本", lat: -37.8136, lon: 144.9631 },
            { name: "奥克兰", lat: -36.8485, lon: 174.7633 },
            { name: "开罗", lat: 30.0444, lon: 31.2357 },
            { name: "里约热内卢", lat: -22.9068, lon: -43.1729 },
            { name: "布宜诺斯艾利斯", lat: -34.6037, lon: -58.3816 }
        ]
    };

    let currentTab = 'domestic';
    let selectedCity = null; // 临时选中的城市对象

    // --- 3. 弹窗与列表逻辑 ---
    const modal = document.getElementById('city-modal');
    const listContainer = document.getElementById('city-list-container');
    const searchInput = document.getElementById('city-search');

    function openCityModal() {
        modal.style.display = 'flex';
        renderCityList(); // 每次打开重新渲染列表
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeCityModal() {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
        selectedCity = null; // 重置选择
    }

    // 切换 国内/国际 Tab
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        searchInput.value = ''; // 切换时清空搜索
        renderCityList();
    }

    // 渲染列表 (支持搜索过滤)
    function renderCityList() {
        listContainer.innerHTML = '';
        const keyword = searchInput.value.trim();
        const cities = cityDatabase[currentTab];

        cities.forEach(city => {
            // 如果有搜索词，必须匹配名字
            if (keyword && !city.name.includes(keyword)) return;

            const item = document.createElement('div');
            item.className = 'city-item';
            if (selectedCity && selectedCity.name === city.name) {
                item.classList.add('selected');
            }

            item.innerHTML = `
                <div class="city-name">${city.name}</div>
                <div class="city-sub">Lat: ${city.lat.toFixed(1)}</div>
            `;

            item.onclick = () => {
                selectedCity = city;
                renderCityList(); // 重新渲染以更新高亮状态
            };
            listContainer.appendChild(item);
        });
    }

    function filterCities() {
        renderCityList();
    }

    // --- 4. 核心：真实天气 API 获取 ---
    function saveCitySelection() {
        if (selectedCity) {
            // 1. 获取天气
            fetchWeather(selectedCity);

            // 2. 【新增】把选中的城市存起来
            // JSON.stringify 是把对象变成字符串，因为 storage 只能存字符串
            localStorage.setItem('userCity', JSON.stringify(selectedCity));

            // 3. 关闭弹窗
            closeCityModal();
        } else {
            alert("请先选择一个城市！");
        }
    }

    // 调用 Open-Meteo 免费 API
    async function fetchWeather(city) {
        const cityEl = document.getElementById('current-city');
        const tempEl = document.querySelector('.weather-temp');
        const descEl = document.querySelector('.weather-desc');
        const iconEl = document.getElementById('weather-icon-container');

        // 先显示加载状态
        cityEl.textContent = city.name;
        descEl.textContent = "更新中...";

        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true&timezone=auto`;
            const response = await fetch(url);
            const data = await response.json();
            const weather = data.current_weather;

            // 更新 UI
            tempEl.textContent = Math.round(weather.temperature) + "°";
            const weatherInfo = getWeatherInfo(weather.weathercode);
            descEl.textContent = weatherInfo.desc;
            iconEl.innerHTML = weatherInfo.icon;

        } catch (error) {
            console.error(error);
            descEl.textContent = "获取失败";
        }
    }

    // --- 5. 天气代码映射 (全套图标) ---
    // 根据 WMO Code 返回对应图标和描述
    function getWeatherInfo(code) {
        // ☀️ 晴天 (0, 1)
        if (code <= 1) return {
            desc: "晴朗",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="14" fill="#FFC107"/><g stroke="#FF9800" stroke-width="4" stroke-linecap="round"><path d="M32 6V10 M32 54V58 M6 32H10 M54 32H58 M13.6 13.6L16.4 16.4 M47.6 47.6L50.4 50.4 M13.6 50.4L16.4 47.6 M47.6 16.4L50.4 13.6"/></g></svg>`
        };

        // ⛅ 多云 (2, 3)
        if (code <= 3) return {
            desc: "多云",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M18 42H46C51.5 42 56 37.5 56 32C56 26.5 51.5 22 46 22C46 16.5 41.5 12 36 12C30.5 12 26 16.5 26 22C20.5 22 16 26.5 16 32C16 37.5 20.5 42 26 42Z" fill="white" fill-opacity="0.9" filter="drop-shadow(0 4px 4px rgba(0,0,0,0.1))"/></svg>`
        };

        // 🌫️ 雾 (45, 48)
        if (code <= 48) return {
            desc: "有雾",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M16 24H48 M12 32H52 M16 40H48" stroke="white" stroke-width="4" stroke-linecap="round" stroke-opacity="0.6"/></svg>`
        };

        // 🌧️ 雨 (51-67, 80-82)
        if (code <= 67 || (code >= 80 && code <= 82)) return {
            desc: "降雨",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 32C20 25.3 25.3 20 32 20C38.6 20 44 25.3 44 32" fill="white" fill-opacity="0.9"/><path d="M20 32 H44 V34 H20 Z" fill="white" fill-opacity="0.9"/><path d="M24 40L22 48 M32 40L30 48 M40 40L38 48" stroke="#64B5F6" stroke-width="3" stroke-linecap="round"/></svg>`
        };

        // 🌨️ 雪 (71-77, 85-86)
        if (code <= 77 || (code >= 85 && code <= 86)) return {
            desc: "降雪",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 32C20 25.3 25.3 20 32 20C38.6 20 44 25.3 44 32" fill="white" fill-opacity="0.9"/><circle cx="24" cy="46" r="2" fill="white"/><circle cx="32" cy="50" r="2" fill="white"/><circle cx="40" cy="46" r="2" fill="white"/></svg>`
        };

        // ⛈️ 雷暴 (95-99)
        return {
            desc: "雷暴",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 30C20 23.3 25.3 18 32 18C38.6 18 44 23.3 44 30" fill="gray" fill-opacity="0.9"/><path d="M34 32L26 44H32L28 56L40 40H32L34 32Z" fill="#FFD700" stroke="#FFA000" stroke-width="1"/></svg>`
        };
    }

    // --- 启动时：检查有没有存过的城市 ---
    function initWeather() {
        // 1. 尝试从本地拿城市数据
        const savedCityStr = localStorage.getItem('userCity');

        if (savedCityStr) {
            // 2. 如果拿到了，就把它变回对象，然后查天气
            const savedCity = JSON.parse(savedCityStr);
            fetchWeather(savedCity);
        } else {
            // 3. 如果从没存过，默认显示北京
            fetchWeather(cityDatabase.domestic[0]);
        }
    }

    // 运行初始化
    initWeather();

    // --- 照片组件逻辑 ---

    // 1. 点击组件，触发隐藏的 file input 点击事件
    function triggerPhotoUpload() {
        document.getElementById('photo-input').click();
    }

    // 修改后的上传逻辑 (支持大文件)
    function handlePhotoUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                const imageData = e.target.result;

                // 1. 更新 UI
                const display = document.getElementById('photo-display');
                const placeholder = document.getElementById('photo-placeholder');
                display.style.backgroundImage = `url(${imageData})`;
                placeholder.style.display = 'none';
                display.style.display = 'block';

                // 2. 存入大容量数据库 (IndexedDB)
                try {
                    // 'userPhoto_1' 是这张图的ID，如果你以后有多个图，可以换名字
                    await dbHelper.save('userPhoto_1', imageData);
                    console.log("图片已保存到本地数据库");
                } catch (err) {
                    console.error("保存失败", err);
                    alert("保存失败，可能是空间不足");
                }
            }
            reader.readAsDataURL(file);
        }
    }

    // 修改后的初始化逻辑
    async function initSavedPhoto() {
        try {
            // 从大容量数据库读取
            const savedImage = await dbHelper.get('userPhoto_1');

            if (savedImage) {
                const display = document.getElementById('photo-display');
                const placeholder = document.getElementById('photo-placeholder');

                display.style.backgroundImage = `url(${savedImage})`;
                placeholder.style.display = 'none';
                display.style.display = 'block';
            }
        } catch (err) {
            console.log("还没有保存过照片");
        }
    }

    // 立即运行
    initSavedPhoto();

    // ================== 音乐组件核心逻辑 ==================
    const audioPlayer = new Audio();
    let isPlaying = false;
    let tempMp3File = null;

    // 1. 封面上传
    function triggerCoverUpload() { document.getElementById('cover-input').click(); }
    document.getElementById('cover-input').onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                document.getElementById('music-cover').style.backgroundImage = `url(${evt.target.result})`;
                await dbHelper.save('music_cover_img', evt.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    // 2. 弹窗控制
    const musicModal = document.getElementById('music-modal');
    const fileNameDisplay = document.getElementById('music-file-name');

    function openMusicModal() {
        const meta = JSON.parse(localStorage.getItem('musicMeta') || '{}');
        document.getElementById('edit-song-title').value = meta.title || '';
        document.getElementById('edit-artist-name').value = meta.artist || '';
        fileNameDisplay.textContent = "未选择新文件";
        tempMp3File = null;
        musicModal.style.display = 'flex';
        setTimeout(()=>musicModal.classList.add('active'), 10);
    }

    function closeMusicModal() {
        musicModal.classList.remove('active');
        setTimeout(()=>musicModal.style.display = 'none', 300);
    }

    // 3. 监听MP3选择
    document.getElementById('mp3-input').onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            tempMp3File = e.target.files[0];
            fileNameDisplay.textContent = "已选择: " + tempMp3File.name;
        }
    };

    // 4. 保存并播放
    async function saveMusicInfo() {
        const title = document.getElementById('edit-song-title').value || '未知歌曲';
        const artist = document.getElementById('edit-artist-name').value || '未知艺术家';
        const url = document.getElementById('edit-music-url').value;

        const meta = { title, artist, url, hasLocalFile: !!tempMp3File };
        localStorage.setItem('musicMeta', JSON.stringify(meta));

        // 更新文字
        document.querySelector('.song-title').textContent = title;
        document.querySelector('.artist-name').textContent = artist;

        // 处理音频
        if (tempMp3File) {
            await dbHelper.save('music_audio_file', tempMp3File); // 存入数据库
            loadAndPlayAudio(URL.createObjectURL(tempMp3File));
        } else if (url) {
            await dbHelper.save('music_audio_file', null);
            loadAndPlayAudio(url);
        }
        closeMusicModal();
    }

    function loadAndPlayAudio(src) {
        audioPlayer.src = src;
        audioPlayer.play().then(() => {
            isPlaying = true; updatePlayPauseIcon();
        }).catch(e => console.error("播放失败", e));
    }

    // 5. 播放控制按钮
    const playBtn = document.getElementById('playPauseBtn');
    playBtn.onclick = function() {
        if (!audioPlayer.src) { openMusicModal(); return; }
        if (isPlaying) audioPlayer.pause(); else audioPlayer.play();
        isPlaying = !isPlaying;
        updatePlayPauseIcon();
    };

    function updatePlayPauseIcon() {
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        if (isPlaying) {
            playIcon.style.display = 'none'; pauseIcon.style.display = 'block';
        } else {
            playIcon.style.display = 'block'; pauseIcon.style.display = 'none';
        }
    }

    // 6. 进度条更新
    const progressBar = document.querySelector('.progress-bar-fill');
    audioPlayer.ontimeupdate = function() {
        if (audioPlayer.duration) {
            progressBar.style.width = (audioPlayer.currentTime / audioPlayer.duration * 100) + '%';
        }
    };
    audioPlayer.onended = function() {
        isPlaying = false; updatePlayPauseIcon(); progressBar.style.width = '0%';
    };

    // 7. 初始化加载 (记忆功能)
    async function initMusicState() {
        const metaStr = localStorage.getItem('musicMeta');
        if (metaStr) {
            const meta = JSON.parse(metaStr);
            document.querySelector('.song-title').textContent = meta.title;
            document.querySelector('.artist-name').textContent = meta.artist;

            // 加载音频
            if (meta.hasLocalFile) {
                const audioBlob = await dbHelper.get('music_audio_file');
                if (audioBlob) audioPlayer.src = URL.createObjectURL(audioBlob);
            } else if (meta.url) {
                audioPlayer.src = meta.url;
            }
        }
        // 加载封面
        const savedCover = await dbHelper.get('music_cover_img');
        if (savedCover) document.getElementById('music-cover').style.backgroundImage = `url(${savedCover})`;
    }
    initMusicState();

    // ================== 个人信息组件逻辑 ==================

    // --- A. 头像上传逻辑 (存 IndexedDB 大仓库) ---
    function triggerProfileUpload() { document.getElementById('profile-input').click(); }

    document.getElementById('profile-input').onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                // 1. 更新界面
                document.getElementById('profile-avatar').style.backgroundImage = `url(${evt.target.result})`;
                // 2. 存入数据库
                await dbHelper.save('userAvatar_main', evt.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    // --- B. 文字编辑弹窗逻辑 ---
    const profileModal = document.getElementById('profile-modal');
    const profileInput = document.getElementById('profile-edit-input');
    const modalTitle = document.getElementById('profile-modal-title');
    const editTypeHidden = document.getElementById('current-edit-type');

    // 打开弹窗 (type 传入 'nickname' 或 'signature')
    function openProfileEditModal(type) {
        // 根据类型设置标题和回显内容
        if (type === 'nickname') {
            modalTitle.textContent = "修改昵称";
            profileInput.value = document.getElementById('profile-nickname').textContent;
        } else {
            modalTitle.textContent = "修改个性签名";
            profileInput.value = document.getElementById('profile-signature').textContent;
        }
        // 记录当前编辑类型
        editTypeHidden.value = type;

        profileModal.style.display = 'flex';
        setTimeout(() => {
            profileModal.classList.add('active');
            profileInput.focus(); // 自动聚焦输入框
        }, 10);
    }

    // 关闭弹窗
    function closeProfileModal() {
        profileModal.classList.remove('active');
        setTimeout(() => profileModal.style.display = 'none', 300);
    }

    // 保存文字 (存 localStorage 小本子)
    function saveProfileText() {
        const type = editTypeHidden.value;
        const text = profileInput.value.trim();

        if (text) {
            if (type === 'nickname') {
                document.getElementById('profile-nickname').textContent = text;
                localStorage.setItem('userNickname', text);
            } else {
                document.getElementById('profile-signature').textContent = text;
                localStorage.setItem('userSignature', text);
            }
        }
        closeProfileModal();
    }

    // --- C. 初始化加载 (断电记忆) ---
    async function initProfileState() {
        // 1. 加载文字 (localStorage)
        const nick = localStorage.getItem('userNickname');
        const sign = localStorage.getItem('userSignature');
        if (nick) document.getElementById('profile-nickname').textContent = nick;
        if (sign) document.getElementById('profile-signature').textContent = sign;

        // 2. 加载头像 (IndexedDB)
        const savedAvatar = await dbHelper.get('userAvatar_main');
        if (savedAvatar) {
            document.getElementById('profile-avatar').style.backgroundImage = `url(${savedAvatar})`;
        }
    }

    // 启动时加载
    initProfileState();

    // ================== 壁纸 App 逻辑 ==================

    // 临时存储，用于预览后保存
    let tempWpImg = null;
    let tempWpVideo = null;

    // 1. 打开/关闭 App 动画
    function openApp(appId) {
        const app = document.getElementById(appId);
        app.style.display = 'flex';
        setTimeout(() => app.classList.add('active'), 10);
    }
    function closeApp(appId) {
        const app = document.getElementById(appId);
        app.classList.remove('active');
        setTimeout(() => app.style.display = 'none', 300);
    }

    // 2. 处理上传预览
    function handleWpPreview(type, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);

            if (type === 'image') {
                const preview = document.getElementById('wp-img-preview');
                preview.innerHTML = ''; // 清空文字
                preview.style.background = `url(${url}) center/cover no-repeat`;
                tempWpImg = file; // 存入临时变量
                document.getElementById('btn-apply-img').classList.add('ready'); // 激活按钮
            } else {
                const video = document.getElementById('wp-video-preview');
                const placeholder = document.getElementById('wp-video-placeholder');
                video.src = url;
                video.style.display = 'block';
                video.play();
                placeholder.style.display = 'none';
                tempWpVideo = file;
                document.getElementById('btn-apply-video').classList.add('ready');
            }
        }
    }

    // 3. 应用壁纸 (核心保存逻辑)
    async function applyWallpaper(type) {
        const body = document.body;
        const globalVideo = document.getElementById('global-video-bg');

        if (type === 'image' && tempWpImg) {
            // --- 静态逻辑 ---
            // 1. 存入数据库
            await dbHelper.save('wallpaper_file', tempWpImg);
            await dbHelper.save('wallpaper_type', 'image');

            // 2. 应用 UI
            const url = URL.createObjectURL(tempWpImg);
            body.style.backgroundImage = `url(${url})`;
            globalVideo.style.display = 'none'; // 隐藏视频层
            globalVideo.src = ""; // 停止视频节省资源

            alert("静态壁纸已应用！");
            closeApp('app-wallpaper');

        } else if (type === 'video' && tempWpVideo) {
            // --- 动态逻辑 ---
            if (tempWpVideo.size > 50 * 1024 * 1024) {
                alert("视频有点大(超过50MB)，保存可能会慢一点，请稍等...");
            }

            // 1. 存入数据库
            await dbHelper.save('wallpaper_file', tempWpVideo);
            await dbHelper.save('wallpaper_type', 'video');

            // 2. 应用 UI
            const url = URL.createObjectURL(tempWpVideo);
            globalVideo.src = url;
            globalVideo.style.display = 'block';
            globalVideo.play();
            // 把 body 背景图去掉，否则会挡住视频
            body.style.backgroundImage = 'none';

            alert("动态壁纸已应用！");
            closeApp('app-wallpaper');
        }
    }

    // 4. 初始化加载 (开机读取壁纸)
    async function initWallpaper() {
        try {
            const type = await dbHelper.get('wallpaper_type');
            const file = await dbHelper.get('wallpaper_file');

            if (type && file) {
                const url = URL.createObjectURL(file);
                const globalVideo = document.getElementById('global-video-bg');

                if (type === 'image') {
                    document.body.style.backgroundImage = `url(${url})`;
                    globalVideo.style.display = 'none';
                } else if (type === 'video') {
                    document.body.style.backgroundImage = 'none';
                    globalVideo.src = url;
                    globalVideo.style.display = 'block';
                    globalVideo.play();
                }
            }
        } catch (e) {
            console.log("使用默认壁纸");
        }
    }

    // 启动
    initWallpaper();

    // ================== 8. 主题系统逻辑 (静音修复版) ==================

    // 1. 切换主题模式 (增加 isSilent 参数)
    function switchTheme(mode, isSilent = false) {
        // 更新按钮状态
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-theme-${mode}`);
        if(btn) btn.classList.add('active');

        // 保存模式
        localStorage.setItem('userThemeMode', mode);

        // 更新设置页文字
        const label = document.getElementById('current-theme-label');
        if(label) label.textContent = (mode === 'dark' ? '深色' : (mode === 'light' ? '浅色' : '自定义'));

        // --- 执行模式切换 ---
        const body = document.body;
        const editor = document.getElementById('custom-css-area');

        // 重置状态
        body.classList.remove('light-theme');
        removeCustomStyle();

        if (mode === 'light') {
            body.classList.add('light-theme');
            editor.style.display = 'none';
            // 只有在不是静音(手动点击)时才弹窗
            if(!isSilent) showToast('已切换至浅色模式');
        }
        else if (mode === 'dark') {
            editor.style.display = 'none';
            if(!isSilent) showToast('已切换至深色模式');
        }
        else if (mode === 'custom') {
            editor.style.display = 'block';
            const savedCSS = localStorage.getItem('userCustomCSS') || '';
            document.getElementById('css-input').value = savedCSS;
            applyCustomCSS(true); // 加载代码时默认静音
        }
    }

    // 2. 应用自定义 CSS
    function applyCustomCSS(isSilent = false) {
        const cssText = document.getElementById('css-input').value;
        removeCustomStyle();

        const styleTag = document.createElement('style');
        styleTag.id = 'user-custom-style';
        styleTag.textContent = cssText;
        document.head.appendChild(styleTag);

        localStorage.setItem('userCustomCSS', cssText);

        if(!isSilent) showToast('自定义主题已应用');
    }

    // 移除自定义样式标签
    function removeCustomStyle() {
        const oldStyle = document.getElementById('user-custom-style');
        if (oldStyle) oldStyle.remove();
    }

    // 3. 初始化主题 (开机读取 - 开启静音模式)
    function initTheme() {
        const mode = localStorage.getItem('userThemeMode') || 'dark';
        // 这里传 true，表示静音加载，不弹窗
        switchTheme(mode, true);
    }

    // 启动
    initTheme();

    // ================== 9. AI 模型设置逻辑 (多配置版) ==================

    // 1. 初始化
    function initAISettings() {
        // 读取当前激活的配置
        const activeConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');

        document.getElementById('ai-endpoint').value = activeConfig.endpoint || '';
        document.getElementById('ai-key').value = activeConfig.key || '';

        // 更新UI显示
        if (activeConfig.model) {
            updateModelDisplay(activeConfig.model);
        }
        if (activeConfig.name) {
            document.getElementById('current-config-name').textContent = activeConfig.name;
        }
    }

    // 更新显示辅助函数
    function updateModelDisplay(name) {
        const el = document.getElementById('display-current-model');
        const label = document.getElementById('current-model-label');
        if(el) el.textContent = name || '未选择';
        if(label) label.textContent = name || '未配置';
    }

    // 2. 拉取模型列表 (保持不变)
    async function fetchModelList() {
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();

        if (!endpoint || !key) { showToast("请先填写地址和密钥"); return; }
        showToast("正在连接...");

        try {
            const response = await fetch(`${endpoint}/v1/models`, {
                method: 'GET', headers: { 'Authorization': `Bearer ${key}` }
            });
            if (!response.ok) throw new Error("HTTP " + response.status);
            const data = await response.json();
            const list = Array.isArray(data.data) ? data.data : data;

            if (list && list.length > 0) {
                cachedModelList = list.sort((a, b) => a.id.localeCompare(b.id));
                renderModelList();
                openSubPage('sub-model-select');
                showToast(`获取到 ${list.length} 个模型`);
            } else { throw new Error("列表为空"); }
        } catch (err) { showToast("拉取失败: " + err.message); }
    }

    // 3. 渲染模型列表 (保持不变)
    function renderModelList() {
        const container = document.getElementById('model-list-container');
        const keyword = document.getElementById('model-search').value.toLowerCase().trim();
        container.innerHTML = '';

        const group = document.createElement('div'); group.className = 'settings-group';

        cachedModelList.filter(m => !keyword || m.id.toLowerCase().includes(keyword)).forEach(m => {
            const item = document.createElement('div');
            item.className = 'settings-item';
            item.onclick = () => {
                document.getElementById('display-current-model').textContent = m.id;
                document.getElementById('display-current-model').dataset.value = m.id;
                closeSubPage('sub-model-select');
            };
            item.innerHTML = `<div class="city-name" style="font-size:15px;">${m.id}</div>`;
            group.appendChild(item);
        });
        container.appendChild(group);
    }

    // 4. 【核心】保存配置 (UI 弹窗版)

    // 步骤 A: 校验并打开弹窗
    function saveAISettings() {
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();
        const modelEl = document.getElementById('display-current-model');
        const model = modelEl.dataset.value || modelEl.textContent.trim();

        if (!endpoint || !key || model === '未选择') { showToast("配置不完整"); return; }

        // 获取当前名字作为默认值
        const currentName = document.getElementById('current-config-name').textContent;
        const input = document.getElementById('config-name-input');
        input.value = currentName === '默认' ? '' : currentName;

        // 打开命名弹窗
        const modal = document.getElementById('config-name-modal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
            input.focus(); // 自动聚焦
        }, 10);
    }

    // 步骤 B: 关闭弹窗
    function closeConfigNameModal() {
        const modal = document.getElementById('config-name-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // 步骤 C: 确认保存 (点击弹窗按钮触发)
    function confirmSaveConfig() {
        const nameInput = document.getElementById('config-name-input');
        const configName = nameInput.value.trim() || "我的配置"; // 默认名

        // 再次获取数据 (因为只是隔了一层弹窗，DOM里的数据还在)
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();
        const modelEl = document.getElementById('display-current-model');
        const model = modelEl.dataset.value || modelEl.textContent.trim();

        // 1. 构建配置对象
        const newConfig = {
            id: Date.now(),
            name: configName,
            endpoint: endpoint,
            key: key,
            model: model
        };

        // 2. 保存到历史列表
        let configList = JSON.parse(localStorage.getItem('ai_config_list') || '[]');
        const existIndex = configList.findIndex(c => c.name === configName);
        if (existIndex >= 0) {
            configList[existIndex] = newConfig; // 覆盖旧的
        } else {
            configList.push(newConfig); // 新增
        }
        localStorage.setItem('ai_config_list', JSON.stringify(configList));

        // 3. 激活并关闭
        activateConfig(newConfig);
        showToast(`✅ 已保存: ${configName}`);
        closeConfigNameModal();
    }

    // 5. 激活配置
    function activateConfig(config) {
        localStorage.setItem('ai_active_config', JSON.stringify(config));

        // 兼容旧的存储方式 (给聊天App用)
        localStorage.setItem('ai_endpoint', config.endpoint);
        localStorage.setItem('ai_key', config.key);
        localStorage.setItem('ai_model', config.model);

        // 更新UI
        document.getElementById('ai-endpoint').value = config.endpoint;
        document.getElementById('ai-key').value = config.key;
        document.getElementById('current-config-name').textContent = config.name;
        updateModelDisplay(config.model);
        document.getElementById('current-model-label').textContent = config.model;
    }

    // 6. 渲染已保存的配置列表 (UI弹窗版)
    function renderConfigList() {
        const container = document.getElementById('config-list-container');
        const list = JSON.parse(localStorage.getItem('ai_config_list') || '[]');
        container.innerHTML = '';

        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:40px;">暂无保存的配置</div>';
            return;
        }

        const group = document.createElement('div'); group.className = 'settings-group';

        list.forEach(config => {
            const item = document.createElement('div');
            item.className = 'settings-item';

            // 点击加载配置
            item.onclick = () => {
                activateConfig(config);
                showToast(`已切换至: ${config.name}`);
                closeSubPage('sub-config-list');
            };

            item.innerHTML = `
                <div>
                    <div class="city-name">${config.name}</div>
                    <div class="city-detail">${config.model}</div>
                </div>
                <span style="color:#666; font-size:12px;">${config.endpoint.replace('https://', '').replace('http://', '')}</span>
            `;
            group.appendChild(item);
        });

        container.appendChild(group);

        // 底部清空按钮 (改为调用新弹窗)
        const clearBtn = document.createElement('div');
        clearBtn.style.textAlign = 'center';
        clearBtn.style.padding = '20px';
        clearBtn.style.color = '#FF3B30';
        clearBtn.style.cursor = 'pointer';
        clearBtn.style.fontSize = '14px';
        clearBtn.innerHTML = '清空所有配置';

        // 关键修改：不再用 confirm，而是打开自定义弹窗
        clearBtn.onclick = openClearConfigModal;

        container.appendChild(clearBtn);
    }

    // --- 清空确认弹窗逻辑 ---
    function openClearConfigModal() {
        const modal = document.getElementById('clear-config-modal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeClearConfigModal() {
        const modal = document.getElementById('clear-config-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function confirmClearConfig() {
        // 执行删除
        localStorage.removeItem('ai_config_list');
        // 刷新列表
        renderConfigList();
        // 提示并关闭
        showToast("已清空所有配置");
        closeClearConfigModal();
    }

    // 7. 测试逻辑 (保持不变)
    async function testSimpleConnection() { /* ...同前... */ }
    async function testAIConnection() { /* ...同前... */ }
    function getCleanEndpoint() { /* ...同前... */ return document.getElementById('ai-endpoint').value.trim().replace(/\/v1\/?$/, '').replace(/\/$/, ''); }
    function logTest(t) { const l=document.getElementById('ai-test-log'); l.innerText+=t+"\n"; l.scrollTop=l.scrollHeight; }

    // 启动
    initAISettings();

    // ================== 10. 字体设置逻辑 (Pro) ==================

    // 系统预设字体 (扩充版 - 安全无版权)
    const systemFonts = [
        { name: "系统默认", family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
        { name: "圆体 (Rounded)", family: 'ui-rounded, "Hiragino Maru Gothic ProN", "Quicksand", "Arial Rounded MT Bold", sans-serif' },
        { name: "黑体 (Sans)", family: '"Noto Sans SC", "Heiti SC", "Microsoft YaHei", sans-serif' },
        { name: "宋体 (Serif)", family: '"Songti SC", "Noto Serif SC", "SimSun", serif' },
        { name: "楷体 (KaiTi)", family: '"KaiTi", "STKaiti", "BiauKai", serif' },
        { name: "仿宋 (FangSong)", family: '"FangSong", "STFangsong", serif' },
        { name: "手写 (Handwriting)", family: '"Comic Sans MS", "Chalkboard SE", "Wawati SC", cursive' },
        { name: "代码 (Mono)", family: 'Monaco, Consolas, "Courier New", monospace' }
    ];

    // 当前配置
    let currentFontConfig = {
        family: systemFonts[0].family,
        name: systemFonts[0].name,
        size: 16,   // 实际上作为 base size 参考
        weight: 400,
        isCustom: false
    };

    // 1. 初始化字体
    async function initFontSettings() {
        const saved = JSON.parse(localStorage.getItem('userFontConfig') || 'null');

        if (saved) {
            currentFontConfig = saved;
            // 恢复滑块位置
            document.getElementById('range-size').value = saved.size;
            document.getElementById('range-weight').value = saved.weight;
        }

        // 如果是自定义字体，从数据库加载并注册
        if (currentFontConfig.isCustom) {
            await loadCustomFontFromDB();
        }

        applyFontToBody();
        renderFontList();
    }

    // 2. 应用到全局 (变量驱动版)
    function applyFontToBody() {
        const root = document.documentElement;

        // 1. 设置字体族 (Font Family)
        root.style.setProperty('--ui-font', currentFontConfig.family);

        // 2. 设置粗细 (Font Weight)
        root.style.setProperty('--ui-weight', currentFontConfig.weight);

        // 3. 【关键】设置全局字体大小变量
        // 这样 CSS 里的 var(--app-font-size) 就会收到通知
        root.style.setProperty('--app-font-size', currentFontConfig.size + "px");

        // 更新设置页的数字显示
        document.getElementById('current-font-label').textContent = currentFontConfig.name;
        const sizeLabel = document.getElementById('val-size');
        const weightLabel = document.getElementById('val-weight');

        if(sizeLabel) sizeLabel.textContent = currentFontConfig.size + "px";
        if(weightLabel) weightLabel.textContent = currentFontConfig.weight;
    }

    // 3. 实时调整 (滑块事件)
    function updateFontConfig() {
        const size = document.getElementById('range-size').value;
        const weight = document.getElementById('range-weight').value;

        currentFontConfig.size = size;
        currentFontConfig.weight = weight;

        applyFontToBody();
        saveFontConfig();
    }

    // 4. 选择字体
    function selectFont(index) {
        const font = systemFonts[index];
        currentFontConfig.family = font.family;
        currentFontConfig.name = font.name;
        currentFontConfig.isCustom = false;

        applyFontToBody();
        renderFontList();
        saveFontConfig();
        showToast("字体已切换");
    }

    // 5. 上传自定义字体
    async function handleFontUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const fontName = "UserCustomFont";

            showToast("正在处理字体...");

            try {
                const arrayBuffer = await file.arrayBuffer();
                // 1. 注册字体 (浏览器 API)
                const fontFace = new FontFace(fontName, arrayBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);

                // 2. 存入数据库
                await dbHelper.save('custom_font_blob', file); // 存原文件

                // 3. 应用
                currentFontConfig.family = fontName;
                currentFontConfig.name = "自定义 (" + file.name + ")";
                currentFontConfig.isCustom = true;

                applyFontToBody();
                renderFontList();
                saveFontConfig();
                showToast("✅ 字体上传成功");

            } catch (err) {
                showToast("❌ 字体加载失败: " + err.message);
            }
        }
    }

    // 6. 从数据库加载自定义字体 (开机用)
    async function loadCustomFontFromDB() {
        try {
            const file = await dbHelper.get('custom_font_blob');
            if (file) {
                const arrayBuffer = await file.arrayBuffer();
                const fontFace = new FontFace("UserCustomFont", arrayBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);
            }
        } catch (e) {
            console.log("无自定义字体");
        }
    }

    // 7. 渲染列表
    function renderFontList() {
        const container = document.getElementById('font-list-container');
        if(!container) return;
        container.innerHTML = '';

        // 合并系统字体和当前自定义字体(如果存在)
        let displayList = [...systemFonts];
        if (currentFontConfig.isCustom) {
            displayList.push({ name: currentFontConfig.name, family: "UserCustomFont", isCustom: true });
        }

        displayList.forEach((font, index) => {
            const isSelected = currentFontConfig.family === font.family;
            const item = document.createElement('div');
            item.className = 'ai-list-item'; // 复用之前的样式

            // 点击逻辑
            item.onclick = () => {
                if(font.isCustom) return; // 自定义的是上传后自动选中的
                selectFont(index);
            };

            item.innerHTML = `
                <div class="ai-item-label full" style="font-family:${font.family}">${font.name}</div>
                ${isSelected ? '<span style="color:#0a84ff;font-weight:bold;">✔</span>' : ''}
            `;
            container.appendChild(item);
        });
    }

    function saveFontConfig() {
        localStorage.setItem('userFontConfig', JSON.stringify(currentFontConfig));
    }

    // 恢复默认字体
    function resetFontSettings() {
        // 1. 重置数据
        currentFontConfig = {
            family: systemFonts[0].family,
            name: systemFonts[0].name,
            size: 16,
            weight: 400,
            isCustom: false
        };

        // 2. 恢复 UI 状态
        document.getElementById('range-size').value = 16;
        document.getElementById('range-weight').value = 400;

        // 3. 应用并保存
        applyFontToBody();
        renderFontList();
        saveFontConfig();

        showToast("已恢复系统默认字体");
    }

    // 启动
    initFontSettings();

    // ================== 11. 图标自定义逻辑 (Pro Plus) ==================

    // 定义所有可修改图标的配置
    const iconConfig = {
        // 第一页
        'home-wallpaper': { defaultClass: 'bg-wallpaper' },
        'home-settings':  { defaultClass: 'bg-settings' },
        'home-chat':      { defaultClass: 'bg-chat' },
        'home-music':     { defaultClass: 'bg-music' },
        // Dock
        'dock-role':      { defaultClass: 'bg-role' },
        'dock-world':     { defaultClass: 'bg-world' },
        'dock-manual':    { defaultClass: 'bg-manual' },
        'dock-gallery':   { defaultClass: 'bg-gallery' },
        // 第二页 (新增)
        'home-diary':     { defaultClass: 'bg-diary' },
        'home-wallet':    { defaultClass: 'bg-wallet' },
        'home-shop':      { defaultClass: 'bg-shop' },
        'home-memo':      { defaultClass: 'bg-memo' },
        'home-forum':     { defaultClass: 'bg-forum' },
        'home-phone':     { defaultClass: 'bg-phone' },
        'home-companion': { defaultClass: 'bg-companion' },
        'home-gacha':     { defaultClass: 'bg-gacha' }
    };

    let currentEditIconId = null;

    // 1. 初始化
    async function initIconSettings() {
        for (const key in iconConfig) {
            try {
                const blob = await dbHelper.get(`icon_${key}`);
                if (blob) updateAppIconUI(key, blob);
            } catch (e) {}
        }
    }

    // 2. 触发上传
    function triggerIconUpload(key) {
        currentEditIconId = key;
        document.getElementById('icon-file-input').click();
    }

    // 3. 处理文件
    async function handleIconFileSelect(input) {
        if (input.files && input.files[0] && currentEditIconId) {
            const file = input.files[0];
            await dbHelper.save(`icon_${currentEditIconId}`, file);
            updateAppIconUI(currentEditIconId, file);
            showToast("✅ 图标已更换");
            input.value = '';
        }
    }

    // 4. 还原
    async function resetIcon(key) {
        if(confirm('还原为默认图标？')) {
            await dbHelper.save(`icon_${key}`, null);
            updateAppIconUI(key, null);
            showToast("已还原");
        }
    }

    // 5. 更新 UI (核心)
    function updateAppIconUI(key, blob) {
        const url = blob ? URL.createObjectURL(blob) : null;
        const defaultClass = iconConfig[key].defaultClass;

        // 1. 更新主屏幕/Dock上的真实图标
        const realIcon = document.getElementById(`icon-${key}`);
        if (realIcon) {
            const svg = realIcon.querySelector('.app-svg');
            if (url) {
                realIcon.style.backgroundImage = `url(${url})`;
                realIcon.classList.remove(defaultClass); // 移除默认渐变色
                if(svg) svg.style.display = 'none';      // 隐藏图标
            } else {
                realIcon.style.backgroundImage = 'none';
                realIcon.classList.add(defaultClass);    // 恢复默认渐变色
                if(svg) svg.style.display = 'block';     // 显示图标
            }
        }

        // 2. 更新设置页里的预览图标
        const previewIcon = document.getElementById(`preview-${key}`);
        if (previewIcon) {
            const svg = previewIcon.querySelector('.preview-icon-svg');
            if (url) {
                previewIcon.style.backgroundImage = `url(${url})`;
                previewIcon.classList.remove(defaultClass);
                if(svg) svg.style.display = 'none';
            } else {
                previewIcon.style.backgroundImage = 'none';
                previewIcon.classList.add(defaultClass);
                if(svg) svg.style.display = 'block';
            }
        }
    }

    initIconSettings();

    // ================== 12. 角色书逻辑 (Role Book) ==================

    let roleList = [];
    let currentRoleId = null; // 当前查看的角色ID
    let tempRoleAvatar = null; // 编辑时的临时头像

    // 1. 初始化：加载列表
    function initRoleBook() {
        const saved = localStorage.getItem('role_list_meta');
        roleList = saved ? JSON.parse(saved) : [];
        renderRoleList();
    }

    // 2. 渲染列表
    async function renderRoleList() {
        const container = document.getElementById('role-list-container');
        if(!container) return;
        container.innerHTML = '';

        if (roleList.length === 0) {
            container.innerHTML = '<div style="grid-column:span 2; text-align:center; color:#666; padding:50px;">点击右上角 + 新建角色</div>';
            return;
        }

        for (const role of roleList) {
            const card = document.createElement('div');
            card.className = 'role-card';
            card.onclick = () => openRoleDetail(role.id);

            // 获取头像 (从IndexedDB)
            let avatarUrl = '';
            try {
                const blob = await dbHelper.get(`role_${role.id}_avatar`);
                if (blob) avatarUrl = URL.createObjectURL(blob);
            } catch (e) {}

            card.innerHTML = `
                <div class="role-card-img" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : ''}"></div>
                <div class="role-card-info">
                    <div class="role-card-name">${role.name}</div>
                    <div class="role-card-desc">${role.desc}</div>
                </div>
            `;
            container.appendChild(card);
        }
    }

    // 3. 打开编辑弹窗 (新建或编辑)
    function openRoleEditModal(roleId = null) {
        const modal = document.getElementById('modal-role-edit');
        const title = document.getElementById('role-modal-title');
        const nameInput = document.getElementById('role-edit-name');
        const descInput = document.getElementById('role-edit-desc');
        const avatarPreview = document.getElementById('role-edit-avatar-preview');

        tempRoleAvatar = null; // 重置临时头像
        currentRoleId = roleId; // 标记当前ID (如果是null则为新建)

        if (roleId) {
            // 编辑模式：回显数据
            const role = roleList.find(r => r.id === roleId);
            title.textContent = "编辑角色";
            nameInput.value = role.name;
            descInput.value = role.desc;
            // 回显头像
            dbHelper.get(`role_${roleId}_avatar`).then(blob => {
                if(blob) avatarPreview.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                else avatarPreview.style.backgroundImage = 'none';
            });
        } else {
            // 新建模式
            title.textContent = "新建角色";
            nameInput.value = '';
            descInput.value = '';
            avatarPreview.style.backgroundImage = 'none';
            avatarPreview.innerHTML = '<span style="font-size: 24px; color: #666;">+</span>';
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeRoleModal() {
        document.getElementById('modal-role-edit').classList.remove('active');
        setTimeout(() => document.getElementById('modal-role-edit').style.display = 'none', 300);
    }

    // 4. 预览上传的头像
    function previewRoleAvatar(input) {
        if (input.files && input.files[0]) {
            tempRoleAvatar = input.files[0];
            const url = URL.createObjectURL(tempRoleAvatar);
            const preview = document.getElementById('role-edit-avatar-preview');
            preview.style.backgroundImage = `url(${url})`;
            preview.innerHTML = ''; // 清除加号
        }
    }

    // 5. 保存角色数据
    async function saveRoleData() {
        const name = document.getElementById('role-edit-name').value.trim();
        const desc = document.getElementById('role-edit-desc').value.trim();

        if (!name) { showToast("请输入角色昵称"); return; }

        let roleId = currentRoleId;
        if (!roleId) {
            // 新建：生成ID
            roleId = Date.now().toString();
            roleList.push({ id: roleId, name, desc });
        } else {
            // 编辑：更新列表
            const role = roleList.find(r => r.id === roleId);
            role.name = name;
            role.desc = desc;
        }

        // 保存元数据到 LocalStorage
        localStorage.setItem('role_list_meta', JSON.stringify(roleList));

        // 保存头像到 IndexedDB (如果有更新)
        if (tempRoleAvatar) {
            await dbHelper.save(`role_${roleId}_avatar`, tempRoleAvatar);
        }

        showToast("角色已保存");
        closeRoleModal();
        renderRoleList(); // 刷新列表

        // 如果是在详情页编辑的，刷新详情页
        if(document.getElementById('sub-role-detail').classList.contains('active')) {
            openRoleDetail(roleId);
        }
    }

    // 6. 打开详情页
    async function openRoleDetail(id) {
        currentRoleId = id;
        const role = roleList.find(r => r.id === id);
        if (!role) return;

        // 填充文字
        document.getElementById('role-detail-name').textContent = role.name;
        document.getElementById('role-detail-desc').textContent = role.desc;

        // 加载头像
        const avatarBlob = await dbHelper.get(`role_${id}_avatar`);
        const avatarEl = document.getElementById('role-detail-avatar');
        if (avatarBlob) avatarEl.style.backgroundImage = `url(${URL.createObjectURL(avatarBlob)})`;
        else avatarEl.style.backgroundImage = 'none';

        // 加载自定义背景
        const bgBlob = await dbHelper.get(`role_${id}_bg`);
        const bgEl = document.getElementById('role-detail-bg');
        if (bgBlob) bgEl.style.backgroundImage = `url(${URL.createObjectURL(bgBlob)})`;
        else bgEl.style.backgroundImage = 'none'; // 或者设一个默认图

        // 打开页面
        openSubPage('sub-role-detail');
    }

    // 7. 详情页：更换背景图
    function triggerRoleBgUpload() { document.getElementById('role-bg-input').click(); }
    async function handleRoleBgUpload(input) {
        if (input.files && input.files[0] && currentRoleId) {
            const file = input.files[0];
            await dbHelper.save(`role_${currentRoleId}_bg`, file);

            // 即时更新显示
            document.getElementById('role-detail-bg').style.backgroundImage = `url(${URL.createObjectURL(file)})`;
            showToast("背景已更新");
        }
    }

    // 8. 详情页：编辑当前
    function editCurrentRole() {
        openRoleEditModal(currentRoleId);
    }

    // 9. 详情页：删除当前
    async function deleteCurrentRole() {
        if (confirm("确定要删除这个角色吗？无法恢复。")) {
            // 删列表
            roleList = roleList.filter(r => r.id !== currentRoleId);
            localStorage.setItem('role_list_meta', JSON.stringify(roleList));

            // 删图片 (IndexedDB) - 存 null 覆盖
            await dbHelper.save(`role_${currentRoleId}_avatar`, null);
            await dbHelper.save(`role_${currentRoleId}_bg`, null);

            closeSubPage('sub-role-detail');
            renderRoleList();
            showToast("角色已删除");
        }
    }

    // 启动
    initRoleBook();

    // ================== 13. 世界书逻辑 (World Book) ==================

    let worldList = [];
    let currentWorldId = null;

    // 1. 初始化
    function initWorldBook() {
        const saved = localStorage.getItem('world_book_data');
        worldList = saved ? JSON.parse(saved) : [];
        renderWorldList();
    }

    // 2. 渲染列表
    function renderWorldList() {
        const container = document.getElementById('world-list-container');
        if(!container) return;
        container.innerHTML = '';

        if (worldList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:50px;">暂无设定<br>点击右上角 + 添加</div>';
            return;
        }

        // 按时间倒序排列
        const sortedList = [...worldList].reverse();

        sortedList.forEach(item => {
            const card = document.createElement('div');
            card.className = 'world-card';
            card.onclick = () => openWorldDetail(item.id);

            card.innerHTML = `
                <div class="world-icon-box">
                    <svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="world-info">
                    <div class="world-title">${item.title}</div>
                    <div class="world-preview">${item.content}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // 3. 打开/关闭 编辑弹窗
    function openWorldEditModal(id = null) {
        const modal = document.getElementById('modal-world-edit');
        const titleInput = document.getElementById('world-edit-title');
        const contentInput = document.getElementById('world-edit-content');
        const modalTitle = document.getElementById('world-modal-title');

        currentWorldId = id; // 标记当前编辑ID

        if (id) {
            const item = worldList.find(w => w.id === id);
            modalTitle.textContent = "编辑设定";
            titleInput.value = item.title;
            contentInput.value = item.content;
        } else {
            modalTitle.textContent = "新建设定";
            titleInput.value = '';
            contentInput.value = '';
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeWorldModal() {
        document.getElementById('modal-world-edit').classList.remove('active');
        setTimeout(() => document.getElementById('modal-world-edit').style.display = 'none', 300);
    }

    // 5. 查看详情
    function openWorldDetail(id) {
        const item = worldList.find(w => w.id === id);
        if (!item) return;

        currentWorldId = id;
        document.getElementById('view-world-title').textContent = item.title;
        document.getElementById('view-world-content').textContent = item.content;

        openSubPage('sub-world-detail');
    }

    function editCurrentWorld() {
        openWorldEditModal(currentWorldId);
    }

    function deleteCurrentWorld() {
        if(confirm('确定要删除这条设定吗？')) {
            worldList = worldList.filter(w => w.id !== currentWorldId);
            localStorage.setItem('world_book_data', JSON.stringify(worldList));
            closeSubPage('sub-world-detail');
            renderWorldList();
            showToast("已删除");
        }
    }

    // 启动
    initWorldBook();

    // ================== 音乐 App 完整逻辑 (修复版) ==================

    // 全局变量定义
    let appMusicList = [];
    let appPlayQueue = [];
    let currentAppSongIndex = -1;
    let appPlayMode = 0; // 0:顺序, 1:单曲, 2:随机
    let tempSongFile = null;
    let tempSongCover = null;
    const appAudio = new Audio();

    // ================== 补回丢失的：音乐列表渲染函数 ==================
    async function renderAppMusicList() {
        const container = document.getElementById('app-music-list-container');
        const sheetContainer = document.getElementById('sheet-list-content');

        // 防止页面元素还没加载时报错
        if(!container) return;

        container.innerHTML = '';
        if(sheetContainer) sheetContainer.innerHTML = '';

        if (appMusicList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; margin-top:100px;">暂无歌曲<br>点击右上角 + 添加</div>';
            return;
        }

        // 更新播放队列
        appPlayQueue = [...appMusicList];

        // 定义图标
        const iconInsert = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;opacity:0.7"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.89 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
        const iconMenu = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;opacity:0.7"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>';

        for (let i = 0; i < appMusicList.length; i++) {
            const song = appMusicList[i];

            let coverUrl = '';
            try {
                const blob = await dbHelper.get('song_cover_' + song.id);
                if(blob) coverUrl = URL.createObjectURL(blob);
            } catch(e){}

            // 生成 HTML 字符串
            const itemHTML = `
                <div class="song-img-box" style="${coverUrl ? 'background-image:url('+coverUrl+')' : ''}"></div>
                <div class="song-info-box" onclick="playAppMusic(${i})">
                    <div class="song-list-title">${song.title}</div>
                    <div class="song-list-artist">${song.artist}</div>
                </div>

                <div style="display:flex; gap:0px; align-items:center;">
                    <button class="song-action-btn" onclick="event.stopPropagation(); playNextImmediately(${i})">
                         ${iconInsert}
                    </button>
                    <button class="song-action-btn" onclick="event.stopPropagation(); openSongMenu('${song.id}')">
                         ${iconMenu}
                    </button>
                </div>
            `;

            // 添加到主列表
            const item = document.createElement('div');
            item.className = 'music-list-item';
            if(i === currentAppSongIndex) item.classList.add('active-playing');
            item.innerHTML = itemHTML;
            container.appendChild(item);

            // 添加到底部 Sheet
            if(sheetContainer) {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'music-list-item';
                sheetItem.innerHTML = itemHTML;
                // Sheet 里点击是播放并关闭
                sheetItem.querySelector('.song-info-box').onclick = function() {
                    playAppMusic(i);
                    closePlaylistSheet();
                };
                sheetContainer.appendChild(sheetItem);
            }
        }
    }

    // 1. 初始化
    function initMusicApp() {
        // 恢复列表数据
        const savedList = localStorage.getItem('app_music_playlist');
        appMusicList = savedList ? JSON.parse(savedList) : [];

        // 恢复全屏背景
        dbHelper.get('music_app_bg').then(blob => {
            if(blob) {
                document.getElementById('full-player-bg').style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
            }
        });

        // 渲染列表 (这就是之前报错找不到的函数)
        renderAppMusicList();

        // 监听播放事件
        appAudio.onended = () => {
            if(appPlayMode === 1) { // 单曲循环
                appAudio.currentTime = 0;
                appAudio.play();
            } else {
                playNextSong();
            }
        };
        appAudio.ontimeupdate = updateFullPlayerUI;
    }

    // ================== 修复后的列表渲染函数 ==================

    // 补全这两个缺失的功能函数，防止点击报错
    function playNextImmediately(index) {
        if (index === currentAppSongIndex) return;
        const song = appPlayQueue[index];
        // 简单提示
        showToast('已设为下一首播放');
        // 如果你要做复杂的插队逻辑，可以在这里操作 appPlayQueue 数组
    }

    function openSongMenu(songId) {
        if(confirm("确定要删除这首歌吗？")) {
            const index = appMusicList.findIndex(s => s.id === songId);
            if(index > -1) deleteSong(index);
        }
    }

    // 3. 播放逻辑
    async function playAppMusic(index) {
        if (index < 0 || index >= appPlayQueue.length) return;

        currentAppSongIndex = index;
        const song = appPlayQueue[index];

        // A. 设置音频源
        if (song.type === 'file') {
            const audioBlob = await dbHelper.get(`song_audio_${song.id}`);
            if(audioBlob) {
                appAudio.src = URL.createObjectURL(audioBlob);
            } else {
                showToast("音频文件丢失");
                return;
            }
        } else {
            appAudio.src = song.url;
        }

        appAudio.play().catch(e => console.log("播放需要交互"));

        // B. 更新 UI
        updateMiniPlayer(song);
        updateFullPlayerInfo(song);
        renderAppMusicList(); // 更新高亮
    }

    async function updateMiniPlayer(song) {
        document.getElementById('mini-title').textContent = song.title;
        document.getElementById('mini-artist').textContent = song.artist;
        document.getElementById('mini-play-btn').textContent = "⏸"; // 这里如果有SVG图标会被文字覆盖，最好用 innerHTML 换图标

        const miniCover = document.getElementById('mini-cover');
        const blob = await dbHelper.get(`song_cover_${song.id}`);
        if(blob) miniCover.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
    }

    async function updateFullPlayerInfo(song) {
        document.getElementById('full-title').textContent = song.title;
        document.getElementById('full-artist').textContent = song.artist;

        // 更新大封面
        const fullCover = document.getElementById('full-cover');
        fullCover.classList.add('playing');
        const blob = await dbHelper.get(`song_cover_${song.id}`);
        if(blob) fullCover.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
        else fullCover.style.backgroundImage = 'none';

        // 歌词
        const lyrics = song.lyrics || "暂无歌词 - 点击添加";
        document.getElementById('current-lyric-line').textContent = lyrics.split('\n')[0];
    }

    // 4. 播放控制
    // --- 更新播放控制逻辑 (同步所有播放器) ---
    function togglePlayState() {
        // 1. 核心音频控制
        if (appAudio.paused) {
            appAudio.play();
        } else {
            appAudio.pause();
        }

        // 2. 同步全屏播放器图标
        const fullPlayIcon = document.getElementById('fp-icon-play');
        const fullPauseIcon = document.getElementById('fp-icon-pause');
        const fullCover = document.getElementById('full-cover');
        const miniCover = document.getElementById('mini-cover'); // 迷你封面

        if (appAudio.paused) {
            if(fullPlayIcon) fullPlayIcon.style.display = 'block';
            if(fullPauseIcon) fullPauseIcon.style.display = 'none';
            if(fullCover) fullCover.classList.remove('playing');
            if(miniCover) miniCover.classList.remove('playing');
        } else {
            if(fullPlayIcon) fullPlayIcon.style.display = 'none';
            if(fullPauseIcon) fullPauseIcon.style.display = 'block';
            if(fullCover) fullCover.classList.add('playing');
            if(miniCover) miniCover.classList.add('playing');
        }

        // 3. 同步迷你播放器图标
        const miniPlayIcon = document.getElementById('mini-icon-play');
        const miniPauseIcon = document.getElementById('mini-icon-pause');
        if(miniPlayIcon && miniPauseIcon) {
            if (appAudio.paused) {
                miniPlayIcon.style.display = 'block';
                miniPauseIcon.style.display = 'none';
            } else {
                miniPlayIcon.style.display = 'none';
                miniPauseIcon.style.display = 'block';
            }
        }

        // 4. 【关键】同步悬浮窗图标 (修复你的报错)
        syncPopupPlayIcon();
    }

    // 5. 弹窗与上传逻辑 (修复 TypeError)
    function openMusicUploadModal() {
        // 重置输入框
        document.getElementById('new-song-title').value = '';
        document.getElementById('new-song-artist').value = '';
        document.getElementById('new-song-filename').textContent = '未选择';
        tempSongFile = null;
        tempSongCover = null;

        const modal = document.getElementById('modal-music-upload');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeMusicUploadModal() {
        const modal = document.getElementById('modal-music-upload');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function handleNewSongFile(input) {
        if (input.files && input.files[0]) {
            tempSongFile = input.files[0];
            document.getElementById('new-song-filename').textContent = tempSongFile.name;
            switchAudioSource('file');
        }
    }

    function switchAudioSource(type) {
        if(type === 'file') {
            document.getElementById('src-file-area').style.display = 'block';
            document.getElementById('src-url-area').style.display = 'none';
            document.getElementById('btn-src-file').classList.add('active');
            document.getElementById('btn-src-url').classList.remove('active');
        } else {
            document.getElementById('src-file-area').style.display = 'none';
            document.getElementById('src-url-area').style.display = 'block';
            document.getElementById('btn-src-file').classList.remove('active');
            document.getElementById('btn-src-url').classList.add('active');
        }
    }

    function previewNewSongCover(input) {
        if (input.files && input.files[0]) {
            tempSongCover = input.files[0];
            document.getElementById('upload-cover-preview').style.backgroundImage = `url(${URL.createObjectURL(tempSongCover)})`;
        }
    }

    async function saveNewSong() {
        const title = document.getElementById('new-song-title').value.trim() || '未知歌曲';
        const artist = document.getElementById('new-song-artist').value.trim() || '未知歌手';
        const isFile = document.getElementById('btn-src-file').classList.contains('active');

        const songId = Date.now().toString();
        const newSong = { id: songId, title, artist, type: isFile ? 'file' : 'url', lyrics: '' };

        showToast("正在保存...");

        if (isFile) {
            if (!tempSongFile) { showToast("请选择MP3文件"); return; }
            await dbHelper.save(`song_audio_${songId}`, tempSongFile);
        } else {
            const url = document.getElementById('new-song-url').value;
            if (!url) { showToast("请输入URL"); return; }
            newSong.url = url;
        }

        if (tempSongCover) {
            await dbHelper.save(`song_cover_${songId}`, tempSongCover);
        }

        appMusicList.push(newSong);
        localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

        closeMusicUploadModal();
        renderAppMusicList();
        showToast("添加成功！");
    }

    // 删除歌曲
    async function deleteSong(index) {
        if(confirm('确定删除吗？')) {
            const song = appMusicList[index];
            appMusicList.splice(index, 1);
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));
            await dbHelper.save(`song_audio_${song.id}`, null);
            await dbHelper.save(`song_cover_${song.id}`, null);
            renderAppMusicList();
            showToast("已删除");
        }
    }

    // 6. 全屏界面交互
    function openFullPlayer() {
        document.getElementById('music-view-full').classList.add('active');

        // --- 新增：同步播放状态 ---
        const fullPlayIcon = document.getElementById('fp-icon-play');
        const fullPauseIcon = document.getElementById('fp-icon-pause');
        const fullCover = document.getElementById('full-cover');

        if (appAudio.paused) {
            // 如果是暂停的，显示播放(三角形)
            fullPlayIcon.style.display = 'block';
            fullPauseIcon.style.display = 'none';
            fullCover.classList.remove('playing');
        } else {
            // 如果正在播放，显示暂停(双竖线)
            fullPlayIcon.style.display = 'none';
            fullPauseIcon.style.display = 'block';
            fullCover.classList.add('playing');
        }
        // -----------------------
    }
    function closeFullPlayer() {
        document.getElementById('music-view-full').classList.remove('active');
    }

    // ================== 统一 UI 更新逻辑 (全屏 + 悬浮窗) ==================
    // --- 更新进度条逻辑 (包含悬浮窗) ---
    function updateFullPlayerUI() {
        if(!appAudio.duration) return;

        const current = appAudio.currentTime;
        const total = appAudio.duration;
        const percent = (current / total) * 100;

        // 格式化时间 00:00
        const fmt = (t) => {
            const m = Math.floor(t/60);
            const s = Math.floor(t%60);
            return `${m}:${s<10?'0':''}${s}`;
        };

        const timeStrCurrent = fmt(current);
        const timeStrTotal = fmt(total);

        // 1. 更新全屏播放器
        const fullSlider = document.getElementById('music-slider');
        if(fullSlider) {
            fullSlider.value = percent;
            document.getElementById('time-current').textContent = timeStrCurrent;
            document.getElementById('time-total').textContent = timeStrTotal;
        }

        // 2. 更新悬浮窗播放器 (新增)
        const popupSlider = document.getElementById('popup-slider');
        if(popupSlider) {
            popupSlider.value = percent;
            document.getElementById('popup-time-current').textContent = timeStrCurrent;
            document.getElementById('popup-time-total').textContent = timeStrTotal;
        }
    }

    function seekAudio(val) {
        if(appAudio.duration) {
            appAudio.currentTime = (val/100) * appAudio.duration;
        }
    }

    function openPlaylistSheet() {
        document.getElementById('sheet-playlist').style.transform = 'translateY(0)';
    }
    function closePlaylistSheet() {
        document.getElementById('sheet-playlist').style.transform = 'translateY(100%)';
    }

    function togglePlayMode() {
        document.getElementById(`icon-mode-${appPlayMode}`).style.display = 'none';
        appPlayMode = (appPlayMode + 1) % 3;
        document.getElementById(`icon-mode-${appPlayMode}`).style.display = 'block';
        showToast(["顺序播放", "单曲循环", "随机播放"][appPlayMode]);
    }

    // 歌词逻辑
    function openLyricsModal() {
        const song = appPlayQueue[currentAppSongIndex];
        if(!song) return;
        document.getElementById('lyrics-input').value = song.lyrics || '';
        const modal = document.getElementById('modal-lyrics');
        modal.style.display = 'flex';
        modal.style.zIndex = '2000';
        setTimeout(()=>modal.classList.add('active'), 10);
    }
    function saveLyrics() {
        const text = document.getElementById('lyrics-input').value;
        if(currentAppSongIndex >= 0) {
            appPlayQueue[currentAppSongIndex].lyrics = text;
            const id = appPlayQueue[currentAppSongIndex].id;
            const mainItem = appMusicList.find(s => s.id === id);
            if(mainItem) mainItem.lyrics = text;
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));
            document.getElementById('current-lyric-line').textContent = text.split('\n')[0];
        }
        document.getElementById('modal-lyrics').classList.remove('active');
        setTimeout(()=>document.getElementById('modal-lyrics').style.display='none',300);
    }

    // 处理歌词文件导入
    function handleLrcFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // 把文件内容填入文本框
                document.getElementById('lyrics-input').value = e.target.result;
                showToast("歌词已导入，请点击保存");
            };
            reader.readAsText(input.files[0]);
        }
    }

    // 插队播放 (下一首)
    function playNextImmediately(index) {
        if (index === currentAppSongIndex) return; // 正在放的不用插队
        const song = appPlayQueue[index];

        // 简单的逻辑：先从列表删掉，再插到当前位置后面
        // 注意：这里只是演示逻辑，真实逻辑可能需要处理 appMusicList 和 appPlayQueue 的同步
        // 为了简单，我们只弹个窗提示，或者你可以只做逻辑不删原位置

        // 这里做最简单的：提示
        showToast(`已将《${song.title}》添加到下一首`);
        // 复杂逻辑你可以后续再加，先把按钮显示出来要紧
    }

    // 打开菜单 (三个点) - 之前写过，这里确认一下
    function openSongMenu(songId) {
        // 你的 HTML 里需要有 id="modal-song-menu" 的弹窗结构
        // 如果没有，可以先用 alert 代替，或者补上弹窗 HTML
        if(confirm("确定要删除这首歌吗？")) {
            // 找到 index
            const index = appMusicList.findIndex(s => s.id === songId);
            if(index > -1) deleteSong(index);
        }
    }

    // ================== 增强版菜单逻辑 ==================

    let activeMenuSongId = null; // 记录当前点击的是哪首歌的 ID

    // 1. 打开底部菜单
    function openSongMenu(songId) {
        activeMenuSongId = songId; // 记住ID
        const modal = document.getElementById('modal-song-menu');
        modal.style.display = 'flex';
        // 强制层级最高
        modal.style.zIndex = '2100';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeSongMenu() {
        const modal = document.getElementById('modal-song-menu');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // 2. 编辑歌曲逻辑
    function openEditSongModal() {
        closeSongMenu(); // 先关掉底部菜单

        // 找到当前歌曲信息
        const song = appMusicList.find(s => s.id === activeMenuSongId);
        if (!song) return;

        // 回显数据
        document.getElementById('edit-title-input').value = song.title;
        document.getElementById('edit-artist-input').value = song.artist;

        // 打开编辑弹窗
        const modal = document.getElementById('modal-edit-song');
        modal.style.display = 'flex';
        modal.style.zIndex = '2200';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeEditSongModal() {
        const modal = document.getElementById('modal-edit-song');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function saveSongEdit() {
        const newTitle = document.getElementById('edit-title-input').value.trim();
        const newArtist = document.getElementById('edit-artist-input').value.trim();

        if (!newTitle) { showToast("标题不能为空"); return; }

        // 更新内存数据
        const songIndex = appMusicList.findIndex(s => s.id === activeMenuSongId);
        if (songIndex > -1) {
            appMusicList[songIndex].title = newTitle;
            appMusicList[songIndex].artist = newArtist;

            // 更新 localStorage
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

            // 刷新列表界面
            renderAppMusicList();

            // 如果正在放这首歌，顺便更新播放器界面
            if (currentAppSongIndex === songIndex) {
                document.getElementById('mini-title').textContent = newTitle;
                document.getElementById('mini-artist').textContent = newArtist;
                document.getElementById('full-title').textContent = newTitle;
                document.getElementById('full-artist').textContent = newArtist;
            }

            showToast("修改已保存");
            closeEditSongModal();
        }
    }

    // 3. 删除确认逻辑
    function openDeleteConfirmModal() {
        closeSongMenu(); // 先关掉底部菜单

        const song = appMusicList.find(s => s.id === activeMenuSongId);
        if(song) {
            document.getElementById('del-song-name').textContent = `《${song.title}》`;
        }

        const modal = document.getElementById('modal-delete-confirm');
        modal.style.display = 'flex';
        modal.style.zIndex = '2200';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeDeleteConfirmModal() {
        const modal = document.getElementById('modal-delete-confirm');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    async function confirmDeleteSong() {
        // 执行删除
        const index = appMusicList.findIndex(s => s.id === activeMenuSongId);
        if (index > -1) {
            // 1. 删数据
            appMusicList.splice(index, 1);
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

            // 2. 删文件 (IndexedDB)
            await dbHelper.save(`song_audio_${activeMenuSongId}`, null);
            await dbHelper.save(`song_cover_${activeMenuSongId}`, null);

            // 3. 刷新界面
            renderAppMusicList();
            showToast("已删除");

            // 如果删的是当前正在放的，停止播放
            if (index === currentAppSongIndex) {
                appAudio.pause();
                appAudio.src = "";
                document.getElementById('mini-player-bar').style.display = 'none'; // 隐藏播放条
            }
        }
        closeDeleteConfirmModal();
    }

    // ================== 补全播放器背景上传功能 ==================

    // 1. 触发点击隐藏的 input
    function triggerMusicBgUpload() {
        const input = document.getElementById('music-bg-input');
        if (input) {
            input.click();
        } else {
            console.error("找不到 id='music-bg-input' 的元素，请检查 HTML");
        }
    }

    // 2. 处理图片文件
    function handleMusicBgUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];

            // 保存到数据库 (下次打开还能记得)
            dbHelper.save('music_app_bg', file);

            // 立即更新界面背景
            const url = URL.createObjectURL(file);

            // 注意：我们之前把背景层改到了 #full-player-bg
            const bgLayer = document.getElementById('full-player-bg');
            if (bgLayer) {
                bgLayer.style.backgroundImage = `url(${url})`;
                showToast("播放器背景已更新");
            }
        }
    }

    // 启动
    initMusicApp();

        // ================== 灵动岛核心逻辑 (修复完整版) ==================

    // 默认配置
    let islandConfig = {
        master: true,
        charge: true,
        music: true
    };
    let islandTimer = null;

    // 1. 初始化
    function initDynamicIsland() {
        const saved = localStorage.getItem('island_config');
        if (saved) islandConfig = JSON.parse(saved);

        // 初始化 UI 状态
        updateIslandState();

        // 更新设置页开关显示 (防止报错)
        const swCharge = document.getElementById('switch-island-charge');
        const swMusic = document.getElementById('switch-island-music');
        if(swCharge) swCharge.checked = islandConfig.charge;
        if(swMusic) swMusic.checked = islandConfig.music;

        // 绑定电池监听
        if ('getBattery' in navigator) {
            navigator.getBattery().then(b => {
                b.addEventListener('chargingchange', () => {
                    if (b.charging) {
                        triggerIsland('charge', { text: Math.round(b.level * 100) + '%' });
                    }
                });
            });
        }

        // 绑定音乐监听
        appAudio.addEventListener('play', () => {
            const currentSong = appPlayQueue[currentAppSongIndex];
            const title = currentSong ? currentSong.title : '正在播放';
            // 触发展开动画
            triggerIsland('music', { text: title });
        });

        appAudio.addEventListener('pause', () => {
            updateIslandState(); // 暂停时缩回
        });
    }

    // ================== 修复后的状态刷新函数 ==================
    function updateIslandState() {
        const island = document.getElementById('dynamic-island');
        const left = document.getElementById('island-icon');
        const center = document.getElementById('island-text');
        const right = document.getElementById('island-info');

        // A. 音乐常驻模式 (只要正在播放，且没播完)
        if (appAudio && !appAudio.paused && !appAudio.ended) {
            island.className = 'island-container music-active';

            // 核心修复：强制注入波形 HTML
            left.innerHTML = `
                <div class="island-sound-wave">
                    <span></span><span></span><span></span><span></span>
                </div>
            `;

            // 清空其他文字，防止干扰
            center.textContent = '';
            right.textContent = '';

            // 点击回音乐App
            island.onclick = () => openApp('app-music');
            return;
        }

        // B. 待机模式
        if (islandConfig.master) {
            island.className = 'island-container idle-show';
            // 清空所有内容
            left.innerHTML = '';
            center.textContent = '';
            right.textContent = '';
            island.onclick = null;
        } else {
            island.className = 'island-container'; // 隐藏
            island.onclick = null;
        }
    }

    // 3. 触发通知动画 (核心修改：音乐布局)
    function triggerIsland(type, data) {
        // 检查子开关 (如果没开对应的功能，就不弹窗，但如果是强制测试则忽略)
        if (type === 'charge' && !islandConfig.charge) return;
        if (type === 'music' && !islandConfig.music) return;

        const island = document.getElementById('dynamic-island');
        const left = document.getElementById('island-icon');
        const center = document.getElementById('island-text');
        const right = document.getElementById('island-info');

        if (islandTimer) clearTimeout(islandTimer);

        // --- 布局填充 ---
        if (type === 'charge') {
            // 充电：左闪电，中文字，右电量
            left.innerHTML = '<span style="color:#34C759">⚡</span>';
            center.innerHTML = 'Charging';
            right.innerHTML = `<span style="color:#34C759">${data.text}</span>`;
        }
        else if (type === 'music') {
            // 音乐：左音符，中歌名+波形，右空
            left.innerHTML = '🎵';
            // 核心修改：歌名旁边加律动效果
            center.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    <span>${data.text}</span>
                    <div class="island-sound-wave">
                        <span style="background:#fff"></span>
                        <span style="background:#fff"></span>
                        <span style="background:#fff"></span>
                    </div>
                </div>
            `;
            right.innerHTML = '';
        }

        // 强制展开
        island.classList.remove('idle-show', 'music-active');
        island.classList.add('active');

        // 3秒后自动收缩
        islandTimer = setTimeout(() => {
            island.classList.remove('active');
            updateIslandState(); // 恢复到该有的状态
        }, 3000);
    }

    // 4. 设置相关函数 (之前缺失的)
    function toggleIslandMaster() {
        islandConfig.master = document.getElementById('switch-island-master').checked;
        saveIslandConfig(); // 保存
        updateIslandState(); // 刷新显示
    }

    // 修复报错：定义保存函数
    function saveIslandConfig() {
        const swCharge = document.getElementById('switch-island-charge');
        const swMusic = document.getElementById('switch-island-music');

        // 更新配置
        if(swCharge) islandConfig.charge = swCharge.checked;
        if(swMusic) islandConfig.music = swMusic.checked;

        localStorage.setItem('island_config', JSON.stringify(islandConfig));
    }

    // 修复报错：定义测试函数
    function testIsland(mode) {
        if(mode === 'charge') {
            // 强制触发，忽略开关检查
            const island = document.getElementById('dynamic-island');
            // 临时模拟开关开启以确保能看到效果
            const oldState = islandConfig.charge;
            islandConfig.charge = true;
            triggerIsland('charge', { text: '100%' });
            islandConfig.charge = oldState;
        } else {
            const oldState = islandConfig.music;
            islandConfig.music = true;
            triggerIsland('music', { text: 'Test Song' });
            islandConfig.music = oldState;
        }
    }

    // ================== 修复版：灵动岛悬浮窗逻辑 ==================

    function openIslandPopup() {
        // 1. 安全检查：如果没有正在播放的歌，就不弹窗
        if (currentAppSongIndex < 0 || !appPlayQueue[currentAppSongIndex]) {
            console.log("当前没有播放歌曲");
            return;
        }
        const song = appPlayQueue[currentAppSongIndex];

        // 2. 填充数据
        const titleEl = document.getElementById('popup-title');
        const artistEl = document.getElementById('popup-artist');
        if (titleEl) titleEl.textContent = song.title;
        if (artistEl) artistEl.textContent = song.artist;

        // 填充封面
        dbHelper.get('song_cover_' + song.id).then(blob => {
            const img = blob ? URL.createObjectURL(blob) : '';
            const coverEl = document.getElementById('popup-cover');
            if (coverEl) {
                if (img) coverEl.style.backgroundImage = `url(${img})`;
                else coverEl.style.backgroundImage = 'none';
            }
        });

        // 同步播放按钮
        syncPopupPlayIcon();

        // 3. 显示动画 (核心修复：加了判断是否存在)
        const popup = document.getElementById('island-popup-player');
        const mask = document.getElementById('island-popup-mask');

        if (popup) popup.classList.add('active');
        else console.error("错误：HTML中找不到 id='island-popup-player'");

        if (mask) mask.classList.add('active');
    }

    function closeIslandPopup() {
        const popup = document.getElementById('island-popup-player');
        const mask = document.getElementById('island-popup-mask');

        if (popup) popup.classList.remove('active');
        if (mask) mask.classList.remove('active');
    }

    // ================== 修改 updateIslandState (核心绑定) ==================
    // 请找到原本的 updateIslandState 函数，修改 if 里的 onclick 绑定

    function updateIslandState() {
        const island = document.getElementById('dynamic-island');
        const left = document.getElementById('island-icon');

        // A. 音乐常驻模式
        if (appAudio && !appAudio.paused && !appAudio.ended) {
            island.className = 'island-container music-active';
            left.innerHTML = '<div class="island-sound-wave"><span></span><span></span><span></span><span></span></div>';

            // --- 修改这里：点击改为打开悬浮窗 ---
            island.onclick = () => openIslandPopup();
            // --------------------------------
            return;
        }

        // B. 待机模式
        if (islandConfig.master) {
            island.className = 'island-container idle-show';
            left.innerHTML = '';
            island.onclick = null;
        } else {
            island.className = 'island-container';
            island.onclick = null;
        }
    }

    // --- 补全缺失的辅助函数 ---
    function syncPopupPlayIcon() {
        const playIcon = document.getElementById('popup-icon-play');
        const pauseIcon = document.getElementById('popup-icon-pause');

        // 安全检查，防止报错
        if (!playIcon || !pauseIcon) return;

        if (appAudio.paused) {
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        } else {
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
        }
    }

    // 启动
    initDynamicIsland();

        // ================== 【独立追加】一起听歌功能模块 ==================

    // 1. 打开页面逻辑
    function openListenTogetherPage() {
        console.log("正在尝试打开一起听..."); // 调试用

        const page = document.getElementById('sub-listen-together');

        if (page) {
            // 1. 强制弹出
            page.classList.add('active');

            // 2. 尝试同步心电图状态 (如果函数存在)
            if (typeof syncVisualizerState === 'function') {
                syncVisualizerState();
            }
        } else {
            // 如果找不到页面，弹窗提示你（说明HTML贴错位置了）
            alert("错误：找不到 id='sub-listen-together' 的页面！请检查HTML是否粘贴在 body 内。");
        }
    }

    // 关闭函数
    function closeSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.remove('active');
        }
    }

    // 2. 心电图联动逻辑 (控制 .playing 类名)
    function syncVisualizerState() {
        const connection = document.querySelector('.visual-connection');
        // 如果 connection 存在，并且音乐正在播放，就加 playing 让它跳动
        if (connection) {
            if (appAudio && !appAudio.paused) {
                connection.classList.add('playing');
            } else {
                connection.classList.remove('playing');
            }
        }
    }

    // 3. 监听器：让心电图跟随音乐自动启停
    // (这段代码会自动挂载到你现有的播放器上)
    if (typeof appAudio !== 'undefined') {
        appAudio.addEventListener('play', syncVisualizerState);
        appAudio.addEventListener('pause', syncVisualizerState);
    }

    // 4. 角色选择与用户编辑 (逻辑补全)
    let currentListenRole = null;
    let currentListenUser = { name: '我', identity: 'User' };
    let tempListenUserAvatar = null;

    // ================== 角色选择逻辑修复版 ==================

// ================== 角色选择列表 (修复版：带头像+适配浅色) ==================

function openListenRoleSelector() {
    const list = document.getElementById('listen-role-list');
    if (!list) return;

    list.innerHTML = ''; // 清空列表

    // 检查是否有角色数据
    if (typeof roleList === 'undefined' || roleList.length === 0) {
        list.innerHTML = '<div style="padding:30px;text-align:center;color:#666;font-size:14px;">暂无角色<br>请先去角色书添加</div>';
    } else {
        // 遍历生成列表
        roleList.forEach((role, index) => {
            // 创建容器
            const div = document.createElement('div');
            div.className = 'role-select-item'; // 使用新定义的 CSS 类

            // 默认头像占位
            let avatarHtml = `<div class="role-tiny-avatar" id="temp-avatar-${role.id}">${role.name[0]}</div>`;

            // 插入 HTML (注意：这里不再写 style="color:white")
            div.innerHTML = `
                ${avatarHtml}
                <span class="role-select-name">${role.name}</span>
            `;

            // 绑定点击事件
            div.onclick = function() {
                selectListenRole(index);
            };

            list.appendChild(div);

            // 异步加载真实头像 (如果有)
            dbHelper.get('role_' + role.id + '_avatar').then(blob => {
                if (blob) {
                    const imgUrl = URL.createObjectURL(blob);
                    const avatarEl = document.getElementById(`temp-avatar-${role.id}`);
                    if (avatarEl) {
                        avatarEl.style.backgroundImage = `url(${imgUrl})`;
                        avatarEl.textContent = ''; // 有图就不显示文字了
                    }
                }
            });
        });
    }

    // 显示弹窗
    const modal = document.getElementById('modal-select-role');
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }
}

// 选择角色回调
    function selectListenRole(index) {
        // 兼容处理：如果传入的是对象(旧逻辑)还是索引(新逻辑)
        let role;
        if (typeof index === 'object') role = index;
        else role = roleList[index];

        if (!role) return;

        currentListenRole = role;
        document.getElementById('listen-role-name').textContent = role.name;

        // 加载头像
        dbHelper.get('role_' + role.id + '_avatar').then(blob => {
            const el = document.getElementById('listen-role-avatar');
            if(blob) {
                // 有图：设置图片
                el.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                el.style.backgroundColor = 'transparent'; // <--- 手动强制透明
                el.innerHTML = '';
            } else {
                // 没图
                el.style.backgroundImage = 'none';
                el.innerHTML = role.name[0];
            }
        });

        // 2. 激活样式 (关键)
        const leftAvatar = document.getElementById('listen-role-avatar');
        if(leftAvatar) {
            leftAvatar.classList.remove('empty');     // 移除“空”样式
            leftAvatar.classList.add('active-role');  // 添加“激活”样式
        }

        // 3. 激活连线
        const leftBridge = document.getElementById('bridge-left');
        if (leftBridge) leftBridge.classList.add('show');

        closeModal('modal-select-role');
        addChatMsg('system', `已邀请 ${role.name} 加入`);
    }

    function openListenUserEdit() {
        const modal = document.getElementById('modal-edit-user');
        if(modal) {
            modal.style.display = 'flex';
            setTimeout(()=>modal.classList.add('active'),10);
            document.getElementById('listen-user-nick-input').value = currentListenUser.name;
            document.getElementById('listen-user-identity-input').value = currentListenUser.identity || '';
        }
    }

    function saveListenUser() {
        const name = document.getElementById('listen-user-nick-input').value.trim();
        const identity = document.getElementById('listen-user-identity-input').value.trim();

        if(name) currentListenUser.name = name;
        if(identity) currentListenUser.identity = identity;

        // 处理头像
        if(tempListenUserAvatar) {
            const el = document.getElementById('listen-user-avatar');
            el.style.backgroundImage = `url(${URL.createObjectURL(tempListenUserAvatar)})`;
            el.innerHTML = '';
        }

        document.getElementById('listen-user-name').textContent = currentListenUser.name;
        closeModal('modal-edit-user');
    }

    function previewListenUserAvatar(input) {
        if(input.files && input.files[0]) {
            tempListenUserAvatar = input.files[0];
            const el = document.getElementById('edit-user-preview');
            el.style.backgroundImage = `url(${URL.createObjectURL(tempListenUserAvatar)})`;
            el.innerHTML = '';
        }
    }

    // 5. 聊天相关
    function sendListenMessage() {
        const input = document.getElementById('listen-input');
        const text = input.value.trim();
        if(!text) return;
        addChatMsg('right', text);
        input.value = '';
    }

    function triggerAiReply() {
        if(!currentListenRole) {
            showToast("请先选择左侧角色");
            return;
        }
        showToast("思考中...");
        setTimeout(() => {
            const replies = ["这首歌的旋律真不错。", "我也很喜欢听这首。", "和你一起听歌真好。"];
            const reply = replies[Math.floor(Math.random() * replies.length)];
            addChatMsg('left', reply);
        }, 1000);
    }

    function addChatMsg(side, text) {
        const box = document.getElementById('listen-chat-box');
        const div = document.createElement('div');
        if(side === 'system') {
            div.className = 'chat-msg system';
            div.innerHTML = `<span>${text}</span>`;
        } else {
            div.className = `chat-msg ${side}`;
            div.innerHTML = `<div class="msg-bubble-listen">${text}</div>`;
        }
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function clearListenChat() {
        if(confirm("清空记录？")) {
            document.getElementById('listen-chat-box').innerHTML = '<div class="chat-msg system"><span>记录已清空</span></div>';
        }
    }

    // 通用关闭
    function closeModal(id) {
        const m = document.getElementById(id);
        if(m) {
            m.classList.remove('active');
            setTimeout(()=>m.style.display='none', 300);
        }
    }

    // 心电图联动逻辑
function syncVisualizerState() {
    const connection = document.querySelector('.visual-connection');
    // 如果 connection 存在，并且音乐正在播放，就加 playing 让爱心狂跳
    if (connection) {
        if (appAudio && !appAudio.paused) {
            connection.classList.add('playing');
        } else {
            connection.classList.remove('playing');
        }
    }
}

// 确保监听了播放事件
if (typeof appAudio !== 'undefined') {
    appAudio.addEventListener('play', syncVisualizerState);
    appAudio.addEventListener('pause', syncVisualizerState);
}

    // ================== 一起听歌：强力计时器逻辑 ==================

// 1. 定义全局变量
window.listenTotalSeconds = 0;
window.listenTimerID = null;

// 2. 更新 UI 的函数
function updateTimerDisplay() {
    const el = document.getElementById('listen-timer-text');
    if (el) {
        window.listenTotalSeconds++;
        const m = Math.floor(window.listenTotalSeconds / 60).toString().padStart(2, '0');
        const s = (window.listenTotalSeconds % 60).toString().padStart(2, '0');
        el.textContent = `${m}:${s}`;
    }
}

// 3. 启动计时器
function startTimer() {
    if (!window.listenTimerID) {
        console.log("▶️ 计时器启动");
        window.listenTimerID = setInterval(updateTimerDisplay, 1000);

        // 同时让爱心跳动 (确保动效同步)
        const heart = document.querySelector('.visual-heart-icon-red');
        if (heart) heart.classList.add('beating');
    }
}

// 4. 停止计时器
function stopTimer() {
    if (window.listenTimerID) {
        console.log("⏸️ 计时器暂停");
        clearInterval(window.listenTimerID);
        window.listenTimerID = null;

        // 停止爱心跳动
        const heart = document.querySelector('.visual-heart-icon-red');
        if (heart) heart.classList.remove('beating');
    }
}

// 5. 绑定播放器事件 (确保 appAudio 存在)
if (typeof appAudio !== 'undefined') {
    // 监听播放
    appAudio.addEventListener('play', startTimer);
    // 监听暂停
    appAudio.addEventListener('pause', stopTimer);
    // 监听结束
    appAudio.addEventListener('ended', stopTimer);

    // ⚡️ 补救措施：如果刷新页面时音乐已经在放了，立即开始计时
    if (!appAudio.paused && !appAudio.ended) {
        startTimer();
    }
} else {
    console.error("❌ 错误：找不到 appAudio 播放器对象！请确保 JS 放在 appAudio 定义之后。");
}

    // ================== 一起听歌：AI 深度交互逻辑 ==================

// 定义一个专门用于一起听的聊天记录数组
let listenChatHistory = [];

// 1. 发送消息 (User) - 重写版
function sendListenMessage() {
    const input = document.getElementById('listen-input');
    const text = input.value.trim();
    if (!text) return;

    // A. 上屏
    addChatMsg('right', text);

    // B. 存入历史记录
    listenChatHistory.push({ role: "user", content: text });

    // C. 清空输入框
    input.value = '';
}

// 2. 触发 AI 回复 (AI) - 核心重写版
async function triggerAiReply() {
    // --- 步骤 1: 检查必要条件 ---

    // 检查角色
    if (!currentListenRole) {
        showToast("请先点击左侧圆圈选择一个角色");
        return;
    }

    // 检查 API 配置
    const aiConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');
    if (!aiConfig.key) {
        showToast("请先在【设置 -> AI模型】中配置 API Key");
        return;
    }

    // --- 步骤 2: 构建“环境信息” (Prompt) ---

    // A. 获取正在播放的歌曲信息
    let musicInfo = "当前环境安静，没有播放音乐。";
    if (typeof appAudio !== 'undefined' && !appAudio.paused && appPlayQueue[currentAppSongIndex]) {
        const song = appPlayQueue[currentAppSongIndex];
        musicInfo = `当前正在一起听的歌曲是：《${song.title}》，歌手是：${song.artist}。`;
    }

    // B. 构建系统提示词 (注入灵魂)
    // 包含：角色设定 + 用户设定 + 音乐环境
    const systemPrompt = `
        你现在需要进行一场沉浸式角色扮演。

        【你的身份】
        名字：${currentListenRole.name}
        人设详情：${currentListenRole.desc}

        【对话对象】
        名字：${currentListenUser.name}
        身份/关系：${currentListenUser.identity || '朋友'}

        【当前场景】
        你们正在“一起听”房间里听歌。
        ${musicInfo}

        【回复要求】
        1. 必须完全代入${currentListenRole.name}的语调和性格。
        2. 回复要简短、口语化，像在微信/即时通讯软件里聊天。
        3. 结合当前的音乐氛围，或者针对${currentListenUser.name}刚才说的话进行回复。
        4. 不要出现“AI语言”，不要说自己是模型。
    `.trim();

    // --- 步骤 3: 准备发送给模型的消息列表 ---

    // 组合：系统提示词 + 最近的聊天记录 (为了节省token，可以只取最近10条)
    const messagesToSend = [
        { role: "system", content: systemPrompt },
        ...listenChatHistory.slice(-10) // 取最后10条记录作为上下文
    ];

    // --- 步骤 4: 发起 API 请求 ---

    // 显示加载动画
    const loadingId = addChatMsg('left', '<span style="opacity:0.5;">正在思考...</span>');

    try {
        const response = await fetch(`${aiConfig.endpoint}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.key}`
            },
            body: JSON.stringify({
                model: aiConfig.model,
                messages: messagesToSend,
                temperature: 0.8, // 稍微高一点，让聊天更有趣
                max_tokens: 150   // 限制回复长度，避免长篇大论
            })
        });

        if (!response.ok) {
            throw new Error(`API错误: ${response.status}`);
        }

        const data = await response.json();
        const replyContent = data.choices[0].message.content;

        // --- 步骤 5: 处理结果 ---

        // 移除“正在思考”
        const loadingEl = document.getElementById(loadingId); // addChatMsg 需要稍作修改返回ID，下面会讲
        if(loadingEl) loadingEl.remove();

        // AI 回复上屏
        addChatMsg('left', replyContent);

        // 存入历史
        listenChatHistory.push({ role: "assistant", content: replyContent });

    } catch (error) {
        console.error(error);
        const loadingEl = document.getElementById(loadingId); // 简单的移除
        if(loadingEl) loadingEl.innerHTML = `<span style="color:#FF3B30;">连接断开: ${error.message}</span>`;
    }
}

// 3. 辅助函数：清空记录时也要清空内存
function clearListenChat() {
    if(confirm("清空记录？这会遗忘之前的对话记忆。")) {
        document.getElementById('listen-chat-box').innerHTML = '<div class="chat-msg system"><span>记录已清空</span></div>';
        listenChatHistory = []; // 关键：清空内存里的历史
    }
}

// 4. 修改 addChatMsg 让它返回元素 ID (为了能删除“正在思考”)
// 请替换掉原来的 addChatMsg 函数
function addChatMsg(side, text) {
    const box = document.getElementById('listen-chat-box');
    const div = document.createElement('div');
    const id = 'chat-msg-' + Date.now() + Math.random(); // 生成唯一ID
    div.id = id;

    if(side === 'system') {
        div.className = 'chat-msg system';
        div.innerHTML = `<span>${text}</span>`;
    } else {
        div.className = `chat-msg ${side}`;
        // 这里的头像逻辑：如果是左边，显示当前角色小头像
        let avatarHtml = '';
        /* 如果你想在气泡旁边显示小头像，可以在这里加逻辑，目前保持简洁 */

        div.innerHTML = `<div class="msg-bubble-listen">${text}</div>`;
    }
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    return id; // 返回ID方便后续操作
}

    // ================== AI 设置页：连接测试与调试逻辑 ==================

// 1. URL 清洗工具 (防止用户多填或少填斜杠)
function getCleanEndpoint() {
    let url = document.getElementById('ai-endpoint').value.trim();
    if (!url) return '';
    // 去掉末尾的 /
    while (url.endsWith('/')) url = url.slice(0, -1);
    // 去掉末尾的 /v1 (因为很多 API 习惯不同，我们统一标准)
    if (url.endsWith('/v1')) url = url.slice(0, -3);
    return url;
}

// 2. 简单的连接测试 (点击“连接测试”按钮)
async function testSimpleConnection() {
    const endpoint = getCleanEndpoint();
    const key = document.getElementById('ai-key').value.trim();

    if (!endpoint || !key) {
        showToast("❌ 请先填写服务器地址和密钥");
        return;
    }

    showToast("正在尝试连接服务器...");

    try {
        // 尝试请求模型列表，这是最轻量的验证方式
        const response = await fetch(`${endpoint}/v1/models`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${key}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            // 缓存模型列表，方便后续选择
            if (data && (data.data || Array.isArray(data))) {
                window.cachedModelList = data.data || data;
                showToast(`✅ 连接成功！获取到 ${window.cachedModelList.length} 个模型`);
                // 自动刷新一下模型选择列表
                renderModelList();
            } else {
                showToast("✅ 连接成功，但模型列表格式未知");
            }
        } else {
            throw new Error(`状态码 ${response.status}`);
        }
    } catch (error) {
        console.error(error);
        showToast(`❌ 连接失败: ${error.message}`);
        alert("连接失败，请检查：\n1. 地址是否正确 (不需要加 /chat/completions)\n2. 密钥是否有效\n3. 是否需要科学上网");
    }
}

// 3. 对话发送测试 (点击“发送”图标)
async function testAIConnection() {
    const input = document.getElementById('ai-test-msg');
    const logBox = document.getElementById('ai-test-log');
    const text = input.value.trim();

    if (!text) return;

    // 获取配置
    const endpoint = getCleanEndpoint();
    const key = document.getElementById('ai-key').value.trim();
    // 获取当前选中的模型 (显示在界面上的那个)
    const modelLabel = document.getElementById('display-current-model');
    const model = modelLabel.dataset.value || modelLabel.textContent;

    if (!endpoint || !key) {
        logTest("❌ 错误：请先配置地址和密钥");
        return;
    }
    if (model === '未选择' || !model) {
        logTest("❌ 错误：请先点击上方“拉取模型列表”并选择一个模型");
        return;
    }

    // UI 更新
    logTest(`User: ${text}`);
    input.value = ''; // 清空输入框
    logTest(`System: 正在发送请求给 [${model}]...`);

    try {
        const response = await fetch(`${endpoint}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: text }],
                temperature: 0.7,
                max_tokens: 100
            })
        });

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`HTTP ${response.status} - ${errText}`);
        }

        const data = await response.json();
        const reply = data.choices[0].message.content;

        logTest(`AI: ${reply}`);
        logTest(`------------------`);

        // 顺便保存一下这次成功的配置到 LocalStorage，防止刷新丢失
        localStorage.setItem('ai_active_config', JSON.stringify({
            endpoint: document.getElementById('ai-endpoint').value, // 存原始值
            key: key,
            model: model,
            name: document.getElementById('current-config-name').textContent
        }));

    } catch (error) {
        logTest(`❌ 请求失败: ${error.message}`);
    }
}

// 4. 辅助函数：向黑色日志框打印文字
function logTest(text) {
    const log = document.getElementById('ai-test-log');
    if (!log) return;

    // 如果是第一条日志，清空默认提示
    if (log.textContent.includes('Ready...')) log.textContent = '';

    const time = new Date().toLocaleTimeString('en-US', {hour12:false});
    log.innerText += `[${time}] ${text}\n`;
    log.scrollTop = log.scrollHeight; // 自动滚动到底部
}

    // ================== 倒数日小组件逻辑 (最终修正版) ==================

let tempCdBg = null; // 临时存储上传的图片

// 1. 初始化
function initCountdownWidget() {
    // 尝试读取保存的数据
    const data = JSON.parse(localStorage.getItem('widget_countdown_data') || 'null');
    if (data) {
        updateCountdownUI(data);
    }

    // 尝试读取保存的背景图
    dbHelper.get('widget_cd_bg').then(blob => {
        if (blob) {
            const url = URL.createObjectURL(blob);
            setCountdownBg(url);
        }
    });
}

// 2. 设置背景图 UI
function setCountdownBg(url) {
    const bgLayer = document.getElementById('cd-bg-layer');
    const widget = document.getElementById('widget-countdown-card');

    if (bgLayer && widget) {
        bgLayer.style.backgroundImage = `url(${url})`;
        bgLayer.style.display = 'block'; // 显示背景层
        widget.classList.add('has-bg');  // 添加标记，通知 CSS 适配浅色模式
    }
}

// 3. 预览上传的图片
function handleCdBgUpload(input) {
    if (input.files && input.files[0]) {
        tempCdBg = input.files[0]; // 存入临时变量
        showToast("已选择图片，保存后生效");
    }
}

// 4. 打开设置弹窗
function openCountdownModal() {
    const modal = document.getElementById('modal-countdown');
    if (!modal) return;

    // 回显数据
    const data = JSON.parse(localStorage.getItem('widget_countdown_data') || '{}');
    document.getElementById('input-cd-title').value = data.title || '';
    document.getElementById('input-cd-date').value = data.date || '';

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}

// 5. 关闭设置弹窗
function closeCountdownModal() {
    const modal = document.getElementById('modal-countdown');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }
}

// 6. 保存设置 (核心逻辑)
async function saveCountdown() {
    const title = document.getElementById('input-cd-title').value.trim();
    const date = document.getElementById('input-cd-date').value;

    if (!title || !date) {
        showToast("请填写完整信息");
        return;
    }

    // 保存文字数据
    const data = { title, date };
    localStorage.setItem('widget_countdown_data', JSON.stringify(data));

    // 保存图片数据 (如果有新上传的)
    if (tempCdBg) {
        await dbHelper.save('widget_cd_bg', tempCdBg);
        // 立即更新界面
        setCountdownBg(URL.createObjectURL(tempCdBg));
        tempCdBg = null; // 清空临时变量
    }

    // 刷新 UI 并关闭
    updateCountdownUI(data);
    closeCountdownModal();
    showToast("倒数日设置已保存");
}

// 7. 更新 UI 显示 (计算天数)
function updateCountdownUI(data) {
    document.getElementById('widget-cd-title').textContent = data.title;
    document.getElementById('widget-cd-date').textContent = "目标: " + data.date;

    const target = new Date(data.date);
    const now = new Date();
    // 清除时分秒，只计算日期差
    target.setHours(0,0,0,0);
    now.setHours(0,0,0,0);

    const diff = target - now;
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));

    const numEl = document.getElementById('widget-cd-days');
    const labelEl = document.querySelector('.cd-label');

    if (days >= 0) {
        numEl.textContent = days;
        if(labelEl) labelEl.textContent = "LEFT"; // 剩余
    } else {
        numEl.textContent = Math.abs(days);
        if(labelEl) labelEl.textContent = "AGO";  // 已过
    }
}

// 页面加载时启动
initCountdownWidget();

    // ================== 语音小组件逻辑 (更新版) ==================

    const voiceState = {
        A: { audio: new Audio(), hasFile: false, isPlaying: false }
    };

    // 1. 初始化
    async function initVoiceWidgets() {
        const id = 'A'; // 我们只保留了 A

        // 加载封面
        const imgBlob = await dbHelper.get(`voice_${id}_img`);
        if (imgBlob) {
            const el = document.getElementById(`voice-${id.toLowerCase()}-cover`);
            if(el) {
                el.style.backgroundImage = `url(${URL.createObjectURL(imgBlob)})`;
                el.querySelector('span').style.display = 'none';
            }
        }

        // 加载音频
        const audioBlob = await dbHelper.get(`voice_${id}_audio`);
        if (audioBlob) {
            voiceState[id].audio.src = URL.createObjectURL(audioBlob);
            voiceState[id].hasFile = true;
        }

        // 监听播放结束
        voiceState[id].audio.onended = () => {
            voiceState[id].isPlaying = false;
            document.getElementById(`voice-${id.toLowerCase()}-wave`).classList.remove('playing');
        };
    }

    // 2. 封面上传 (左侧圆形)
    function triggerVoiceCover(id) {
        document.getElementById(`input-voice-${id.toLowerCase()}-img`).click();
    }

    async function saveVoiceImg(id, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            await dbHelper.save(`voice_${id}_img`, file);

            const el = document.getElementById(`voice-${id.toLowerCase()}-cover`);
            el.style.backgroundImage = `url(${URL.createObjectURL(file)})`;
            el.querySelector('span').style.display = 'none';
        }
    }

    // 3. 音频上传 (右侧星星按钮)
    function triggerVoiceUpload(id) {
        document.getElementById(`input-voice-${id.toLowerCase()}-audio`).click();
    }

    async function saveVoiceAudio(id, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            await dbHelper.save(`voice_${id}_audio`, file);

            voiceState[id].audio.src = URL.createObjectURL(file);
            voiceState[id].hasFile = true;

            // 上传成功后，重置播放状态
            voiceState[id].isPlaying = false;
            document.getElementById(`voice-${id.toLowerCase()}-wave`).classList.remove('playing');

            showToast("音频已上传，点击中间播放");
        }
    }

    // 4. 播放控制 (点击中间波纹)
    function toggleVoicePlay(id) {
        if (!voiceState[id].hasFile) {
            showToast("请先点击右侧星星上传音频");
            return;
        }

        const s = voiceState[id];
        const wave = document.getElementById(`voice-${id.toLowerCase()}-wave`);

        if (s.isPlaying) {
            s.audio.pause();
            s.isPlaying = false;
            wave.classList.remove('playing');
        } else {
            // 如果背景音乐正在放，先暂停背景音乐（可选）
            if (typeof appAudio !== 'undefined' && !appAudio.paused) {
                appAudio.pause();
                // 记得更新主播放器UI，如果需要的话可以调用 updatePlayPauseIcon()
            }

            s.audio.play();
            s.isPlaying = true;
            wave.classList.add('playing');
        }
    }

    // 启动
    initVoiceWidgets();

    // ================== 组件背景设置逻辑 ==================

    let currentWidgetBgId = null; // 当前正在修改哪个组件

    // 1. 初始化：加载所有组件背景
    async function initWidgetBackgrounds() {
        const widgets = ['weather', 'music', 'voice-a'];

        for (const id of widgets) {
            try {
                const blob = await dbHelper.get(`widget_bg_${id}`);
                if (blob) {
                    const url = URL.createObjectURL(blob);
                    applyWidgetBg(id, url);
                }
            } catch (e) { console.log(e); }
        }
    }

    // 2. 应用背景 (同时更新主屏幕真实组件 + 设置页预览)
    function applyWidgetBg(id, url) {
        // 更新主屏幕上的真实组件
        const realWidget = document.getElementById(`widget-${id}-box`);
        if (realWidget) {
            if (url) realWidget.style.backgroundImage = `url(${url})`;
            else realWidget.style.backgroundImage = 'none';
        }

        // 更新设置页里的预览
        const previewWidget = document.getElementById(`preview-widget-${id}`);
        if (previewWidget) {
            if (url) previewWidget.style.backgroundImage = `url(${url})`;
            else previewWidget.style.backgroundImage = 'none';
        }
    }

    // 3. 触发上传
    function triggerWidgetBgUpload(id) {
        currentWidgetBgId = id;
        document.getElementById('input-widget-bg').click();
    }

    // 4. 处理文件选择
    async function handleWidgetBgFile(input) {
        if (input.files && input.files[0] && currentWidgetBgId) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);

            // 存入数据库
            await dbHelper.save(`widget_bg_${currentWidgetBgId}`, file);

            // 应用
            applyWidgetBg(currentWidgetBgId, url);
            showToast("组件背景已更新");

            // 清空输入框，防止重复触发
            input.value = '';
        }
    }

    // ================== 还原逻辑修改版 (使用自定义弹窗) ==================

    let tempWidgetIdToReset = null; // 临时记录当前要还原哪个组件

    // 1. 点击“还原”按钮时触发：打开弹窗
    function resetWidgetBg(id) {
        tempWidgetIdToReset = id; // 记住是哪个组件（weather/music/voice-a）

        const modal = document.getElementById('modal-reset-widget');
        modal.style.display = 'flex';
        // 强制层级最高，遮住设置页
        modal.style.zIndex = '2000';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    // 2. 关闭弹窗
    function closeResetModal() {
        const modal = document.getElementById('modal-reset-widget');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // 3. 确认还原 (点击红色按钮时触发)
    async function confirmResetExec() {
        if (tempWidgetIdToReset) {
            // 删库
            await dbHelper.save(`widget_bg_${tempWidgetIdToReset}`, null);
            // 刷新 UI (传 null 会恢复 CSS 默认样式)
            applyWidgetBg(tempWidgetIdToReset, null);

            showToast("已还原默认样式");
        }
        closeResetModal();
    }

    // 启动加载
    initWidgetBackgrounds();

    // ================== 聊天 App 导航逻辑 ==================

    // 1. 切换顶部 Tab (列表/群聊/好友)
    function switchChatTopTab(tabId) {
        // 切换按钮样式
        document.querySelectorAll('.chat-top-tabs-container .chat-tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes(
                tabId === 'list' ? '消息' : (tabId === 'group' ? '群聊' : '好友')
            )) {
                btn.classList.add('active');
            }
        });

        // 切换内容显示
        document.querySelectorAll('.chat-page-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-chat-${tabId}`).classList.add('active');

        // 如果切到好友，刷新一下好友列表 (复用角色书数据)
        if (tabId === 'friend') {
            loadChatFriends();
        }
    }

    // 2. 切换底部 Nav (消息/动态/我的) - 更新版
    function switchChatBottomNav(moduleId, btnEl) {
        // 1. 切换按钮高亮样式
        document.querySelectorAll('.chat-nav-item').forEach(el => el.classList.remove('active'));
        btnEl.classList.add('active');

        // 2. 切换中间大模块显示
        document.querySelectorAll('.chat-module-container').forEach(el => el.style.display = 'none');
        document.getElementById(`chat-module-${moduleId}`).style.display = 'flex';

        // 3. 动态修改标题
        const titleMap = { 'msg': '聊天', 'moments': '动态', 'me': '我的' };
        document.querySelector('#app-chat .app-title').textContent = titleMap[moduleId];

        // 4. 【核心修改】控制返回按钮显示/隐藏
        const backBtn = document.getElementById('chat-back-btn');
        if (moduleId === 'msg') {
            backBtn.style.display = 'flex'; // 在消息页显示返回
        } else {
            backBtn.style.display = 'none'; // 在动态/我的页隐藏
        }
    }

    // ================== 好友列表逻辑 (滑动+头像修复+点击修复) ==================

    let deleteTargetType = 'chat'; // 标记当前要删除的是 'chat'(会话) 还是 'friend'(好友)

    // 1. 加载好友列表 (核心重写)
    async function loadChatFriends() {
        const container = document.getElementById('view-chat-friend');
        // 读取角色书数据
        let roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

        if (roles.length === 0) {
            container.innerHTML = '<div class="chat-placeholder-text">暂无好友<br>去角色书创建几个吧</div>';
            return;
        }

        // 排序：置顶的排前面
        roles.sort((a, b) => {
            if (a.isPinned && !b.isPinned) return -1;
            if (!a.isPinned && b.isPinned) return 1;
            return 0;
        });

        container.innerHTML = ''; // 清空列表

        for (const role of roles) { // <-- 循环变量是 'role'
            // A. 核心修复：先从数据库读头像
            let avatarUrl = '';
            try {
                const blob = await dbHelper.get(`role_${role.id}_avatar`);
                if(blob) avatarUrl = URL.createObjectURL(blob);
            } catch(e){}

            // B. 构建滑动容器
            const wrapper = document.createElement('div');
            wrapper.className = `chat-swipe-wrapper ${role.isPinned ? 'pinned' : ''}`;

            // C. 主卡片 (头像 + 名字)
            const mainCard = document.createElement('div');
            mainCard.className = 'chat-main-card';

            // --- 🚨 修复点：将 chat 替换为 role，并使用 role 的头像 ID 🚨 ---
            mainCard.onclick = function() {
                createOrOpenChatFromFriend(role.id, role.name);
            };
            // -------------------------------------------------------------

            // 这里的样式和消息列表保持高度一致
            mainCard.innerHTML = `
                <div class="role-card-img" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : ''}; width:50px; height:50px; border-radius:50%; margin-right:15px; background-size:cover; background-position:center; background-color:#333; flex-shrink:0;">
                    ${!avatarUrl ? `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#888;">${role.name[0]}</div>` : ''}
                </div>
                <div class="role-card-info" style="flex:1;">
                    <div class="role-card-name" style="font-size:17px; font-weight:600;">${role.name}</div>
                    <div class="role-card-desc" style="font-size:13px; opacity:0.6; margin-top:2px;">${role.desc || '暂无介绍'}</div>
                </div>
            `;

            // D. 右侧操作按钮
            const actions = document.createElement('div');
            actions.className = 'chat-swipe-actions';

            // 置顶按钮
            const pinBtn = document.createElement('div');
            pinBtn.className = 'swipe-btn btn-pin';
            pinBtn.textContent = role.isPinned ? '取消' : '置顶';
            pinBtn.onclick = (e) => {
                e.stopPropagation();
                toggleFriendPin(role.id);
            };

            // 删除按钮
            const delBtn = document.createElement('div');
            delBtn.className = 'swipe-btn btn-del';
            delBtn.textContent = '删除';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                // 调用通用的删除页面，传入 'friend' 类型
                openDeletePageCommon('friend', role.id, role.name);
            };

            actions.appendChild(pinBtn);
            actions.appendChild(delBtn);

            wrapper.appendChild(mainCard);
            wrapper.appendChild(actions);
            container.appendChild(wrapper);
        }
    }

    // ================== 聊天创建逻辑 (完整版) ==================

    // 临时存储
    let tempSingleAvatar = null;
    let tempGroupAvatars = {}; // { index: file }
    let selectedImportRoleId = null; // 单人导入选中
    let selectedImportRoleIds = [];  // 群聊导入选中

    // 1. 入口：点击聊天页右上角 + 号
    // (请确保HTML里那个加号的 onclick="openChatTypeMenu()")
    function openChatTypeMenu() {
        const modal = document.getElementById('modal-chat-type');
        modal.style.display = 'flex';
        modal.style.zIndex = '2100';
        setTimeout(() => modal.classList.add('active'), 10);
    }
    function closeChatTypeMenu() {
        const modal = document.getElementById('modal-chat-type');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // --- 单人聊天逻辑 ---

    function openCreateSingleModal() {
        closeChatTypeMenu();
        // 重置状态
        document.getElementById('input-single-name').value = '';
        document.getElementById('input-single-avatar').value = '';
        document.getElementById('single-avatar-preview').style.backgroundImage = 'none';
        document.getElementById('single-avatar-preview').innerHTML = '<span class="chat-avatar-icon">+</span>';
        tempSingleAvatar = null;
        selectedImportRoleId = null;

        // 渲染导入列表
        renderImportList('single');
        openSubPage('sub-create-single');
    }

    function switchSingleTab(mode, btn) {
        document.querySelectorAll('#sub-create-single .create-chat-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(mode === 'custom') {
            document.getElementById('single-custom-area').style.display = 'block';
            document.getElementById('single-import-area').style.display = 'none';
        } else {
            document.getElementById('single-custom-area').style.display = 'none';
            document.getElementById('single-import-area').style.display = 'block';
        }
    }

    // --- 群聊逻辑 ---

    let currentMemberCount = 3;

    function openCreateGroupModal() {
        closeChatTypeMenu();
        document.getElementById('input-group-name').value = '';
        currentMemberCount = 3;
        tempGroupAvatars = {};
        selectedImportRoleIds = [];

        renderGroupMemberInputs();
        renderImportList('group');
        openSubPage('sub-create-group');
    }

    function switchGroupTab(mode, btn) {
        document.querySelectorAll('#sub-create-group .create-chat-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(mode === 'custom') {
            document.getElementById('group-custom-area').style.display = 'block';
            document.getElementById('group-import-area').style.display = 'none';
        } else {
            document.getElementById('group-custom-area').style.display = 'none';
            document.getElementById('group-import-area').style.display = 'block';
        }
    }

    function adjustMemberCount(delta) {
        const newCount = currentMemberCount + delta;
        if(newCount >= 2 && newCount <= 20) {
            currentMemberCount = newCount;
            document.getElementById('group-member-count').textContent = currentMemberCount;
            renderGroupMemberInputs();
        }
    }

    // 动态生成群成员输入框
    function renderGroupMemberInputs() {
        const container = document.getElementById('group-custom-list');
        // 保留已输入的数据比较麻烦，这里简化为重新生成，或者只增减
        // 为了体验好，我们简单重绘，但实际项目可能需要保留值
        let html = '';
        for(let i=0; i<currentMemberCount; i++) {
            // 检查是否有临时预览图
            const hasImg = tempGroupAvatars[i];
            const bgStyle = hasImg ? `background-image:url(${URL.createObjectURL(hasImg)})` : '';
            const iconDisplay = hasImg ? 'none' : 'block';

            html += `
                <div class="group-member-row">
                    <div class="group-member-avatar-small" id="group-av-${i}" style="${bgStyle}" onclick="document.getElementById('input-g-av-${i}').click()">
                        <span style="display:${iconDisplay}">+</span>
                    </div>
                    <input type="file" id="input-g-av-${i}" accept="image/*" hidden onchange="handleGroupAvatar(${i}, this)">
                    <input type="text" id="input-g-name-${i}" placeholder="成员 ${i+1} 昵称" style="flex:1; border:none; background:transparent; color:white; outline:none;">
                </div>
            `;
        }
        container.innerHTML = html;
    }

    function handleGroupAvatar(index, input) {
        if(input.files && input.files[0]) {
            tempGroupAvatars[index] = input.files[0];
            const url = URL.createObjectURL(input.files[0]);
            const el = document.getElementById(`group-av-${index}`);
            el.style.backgroundImage = `url(${url})`;
            el.querySelector('span').style.display = 'none';
        }
    }

    // --- 通用：头像预览 ---
    function previewChatAvatar(viewId, input) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            if(viewId === 'single-avatar-preview') tempSingleAvatar = file;

            const el = document.getElementById(viewId);
            el.style.backgroundImage = `url(${URL.createObjectURL(file)})`;
            el.querySelector('span').style.display = 'none';
        }
    }

    // --- 通用：渲染角色导入列表 ---
    function renderImportList(type) {
        const container = document.getElementById(`import-role-list-${type}`);
        const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
        container.innerHTML = '';

        if(roles.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">角色书为空</div>';
            return;
        }

        roles.forEach(role => {
            const div = document.createElement('div');
            div.className = 'role-card role-select-item'; // 复用之前的样式
            div.style.marginBottom = '8px';

            // 点击逻辑
            div.onclick = () => {
                if(type === 'single') {
                    // 单选
                    document.querySelectorAll('#import-role-list-single .role-select-item').forEach(el=>el.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedImportRoleId = role.id;
                } else {
                    // 多选
                    if(selectedImportRoleIds.includes(role.id)) {
                        selectedImportRoleIds = selectedImportRoleIds.filter(id => id !== role.id);
                        div.classList.remove('selected');
                    } else {
                        selectedImportRoleIds.push(role.id);
                        div.classList.add('selected');
                    }
                }
            };

            // 获取头像
            dbHelper.get(`role_${role.id}_avatar`).then(blob => {
                const imgStyle = blob ? `background-image:url(${URL.createObjectURL(blob)})` : '';
                div.innerHTML = `
                    <div class="role-card-img" style="${imgStyle}"></div>
                    <div class="role-card-info">
                        <div class="role-card-name">${role.name}</div>
                    </div>
                    <div class="role-select-check"></div>
                `;
            });
            container.appendChild(div);
        });
    }

    // ================== 保存与数据生成 ==================

    // 保存单聊
    // ================== 修复：自定义创建同时保存到好友列表 ==================

    async function saveSingleChat() {
        const activeTab = document.querySelector('#sub-create-single .create-chat-tab.active').innerText;

        // 生成一个通用 ID
        const commonId = Date.now().toString();

        let chatName = '';
        let avatarBlob = null;

        // --- 分支 A：自定义创建 ---
        if (activeTab.includes('自定义')) {
            chatName = document.getElementById('input-single-name').value.trim();
            if (!chatName) { showToast("请输入昵称"); return; }
            avatarBlob = tempSingleAvatar;

            // 【核心修复步骤】
            // 1. 把它存进角色书 (这样好友列表才能看到)
            let roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
            roles.push({
                id: commonId,
                name: chatName,
                desc: '自定义添加的好友'
            });
            localStorage.setItem('role_list_meta', JSON.stringify(roles));

            // 2. 存角色头像 (给好友列表用)
            if (avatarBlob) {
                await dbHelper.save(`role_${commonId}_avatar`, avatarBlob);
            }

            // 3. 顺便刷新一下角色书列表（如果后台开着的话）
            if (typeof renderRoleList === 'function') renderRoleList();
        }

        // --- 分支 B：从角色书导入 ---
        else {
            if (!selectedImportRoleId) { showToast("请选择一个角色"); return; }
            const roles = JSON.parse(localStorage.getItem('role_list_meta'));
            const role = roles.find(r => r.id === selectedImportRoleId);

            chatName = role.name;
            // 尝试获取原有角色的头像
            const existBlob = await dbHelper.get(`role_${role.id}_avatar`);
            if (existBlob) avatarBlob = existBlob;
        }

        // --- 公共步骤：创建会话 ---
        const chatData = {
            id: commonId,
            type: 'single',
            name: chatName,
            lastMsg: '我们已经是好友了，开始聊天吧',
            time: '刚刚'
        };

        // 存会话头像 (给消息列表用)
        if (avatarBlob) {
            await dbHelper.save(`chat_avatar_${commonId}`, avatarBlob);
        }

        // 添加到消息列表
        addChatToSessionList(chatData);

        // 【关键】强制刷新好友列表 UI
        loadChatFriends();

        closeSubPage('sub-create-single');
        showToast("创建成功，好友已添加");
    }

    // 保存群聊
    async function saveGroupChat() {
        const groupName = document.getElementById('input-group-name').value.trim();
        if(!groupName) { showToast("请输入群名称"); return; }

        const activeTab = document.querySelector('#sub-create-group .create-chat-tab.active').innerText;
        let members = []; // { name, avatarBlob? }

        if(activeTab.includes('自定义')) {
            // 收集输入框数据
            for(let i=0; i<currentMemberCount; i++) {
                const name = document.getElementById(`input-g-name-${i}`).value.trim();
                const blob = tempGroupAvatars[i];
                if(name) members.push({ name, blob });
            }
            if(members.length < 2) { showToast("至少需要2名成员"); return; }
        } else {
            // 收集导入数据
            if(selectedImportRoleIds.length < 2) { showToast("至少选择2个角色"); return; }
            const roles = JSON.parse(localStorage.getItem('role_list_meta'));
            for(const rid of selectedImportRoleIds) {
                const r = roles.find(x => x.id === rid);
                const blob = await dbHelper.get(`role_${rid}_avatar`);
                members.push({ name: r.name, blob });
            }
        }

        const chatId = Date.now().toString();
        // 保存群头像 (这里简单处理：用第一个成员的头像，或者默认图)
        if(members[0].blob) {
            await dbHelper.save(`chat_avatar_${chatId}`, members[0].blob);
        }

        const chatData = {
            id: chatId,
            type: 'group',
            name: groupName,
            memberCount: members.length, // 记录人数
            lastMsg: `${members[0].name}: (表情)`,
            time: '刚刚'
        };

        addChatToSessionList(chatData);
        closeSubPage('sub-create-group');
        showToast("群聊创建成功");
    }

    // 核心：添加到会话列表并刷新 UI
    function addChatToSessionList(chat) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        list.unshift(chat); // 加到最前面
        localStorage.setItem('chat_sessions', JSON.stringify(list));

        // 既然创建了，就应该刷新消息列表页
        renderChatSessionList();
    }

    // ================== 列表渲染逻辑 (最终修正版) ==================
    async function renderChatSessionList() {
        const container = document.getElementById('view-chat-list');
        if (!container) return; // 防止找不到容器报错

        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');

        if(list.length === 0) {
            container.innerHTML = '<div class="chat-placeholder-text">暂无消息<br>点击右上角 + 创建</div>';
            return;
        }

        // 排序：置顶的排前面
        list.sort((a, b) => {
            if (a.isPinned && !b.isPinned) return -1;
            if (!a.isPinned && b.isPinned) return 1;
            return 0;
        });

        container.innerHTML = ''; // 清空列表

        // --- 循环开始 ---
        for(const chat of list) {

            // 1. 获取头像
            let avatarUrl = '';
            try {
                const blob = await dbHelper.get(`chat_avatar_${chat.id}`);
                if(blob) avatarUrl = URL.createObjectURL(blob);
            } catch(e){}

            // 2. 创建结构
            const wrapper = document.createElement('div');
            wrapper.className = `chat-swipe-wrapper ${chat.isPinned ? 'pinned' : ''}`;

            const mainCard = document.createElement('div');
            mainCard.className = 'chat-main-card';

            // --- 🚨 核心修复点：这里必须调用 openChatDetail 🚨 ---
            // 不要改动这里的任何标点符号
            mainCard.onclick = function() {
                openChatDetail(chat.id, chat.name, `chat_avatar_${chat.id}`);
            };
            // -----------------------------------------------------

            mainCard.innerHTML = `
                <div class="role-card-img" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : ''}; width:50px; height:50px; border-radius:50%; margin-right:15px; background-size:cover; background-position:center; background-color:#333;">
                    ${!avatarUrl ? `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#888;">${chat.name[0]}</div>` : ''}
                </div>
                <div class="role-card-info" style="flex:1;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <div class="role-card-name" style="font-size:17px; font-weight:600;">${chat.name} ${chat.type==='group' ? '<span style="font-size:12px;opacity:0.6;">(群)</span>' : ''}</div>
                        <div style="font-size:12px; opacity:0.5;">${chat.time}</div>
                    </div>
                    <div class="role-card-desc" style="font-size:14px; opacity:0.7; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${chat.lastMsg}</div>
                </div>
            `;

            // 3. 右侧按钮
            const actions = document.createElement('div');
            actions.className = 'chat-swipe-actions';

            const pinBtn = document.createElement('div');
            pinBtn.className = 'swipe-btn btn-pin';
            pinBtn.textContent = chat.isPinned ? '取消' : '置顶';
            pinBtn.onclick = (e) => {
                e.stopPropagation();
                toggleChatPin(chat.id);
            };

            const delBtn = document.createElement('div');
            delBtn.className = 'swipe-btn btn-del';
            delBtn.textContent = '删除';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                openChatDeletePage(chat.id, chat.name);
            };

            actions.appendChild(pinBtn);
            actions.appendChild(delBtn);

            wrapper.appendChild(mainCard);
            wrapper.appendChild(actions);
            container.appendChild(wrapper);
        }
    }

    // ================== 列表功能：置顶 / 取消置顶 ==================

    function toggleChatPin(chatId) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        const index = list.findIndex(c => c.id === chatId);

        if (index > -1) {
            // 切换状态
            list[index].isPinned = !list[index].isPinned;
            localStorage.setItem('chat_sessions', JSON.stringify(list));

            // 重新渲染 (会自动排序和更新 UI)
            renderChatSessionList();
            showToast(list[index].isPinned ? "已置顶" : "已取消置顶");
        }
    }

    // ================== 通用删除逻辑 (会话 & 好友) ==================

    // 1. 打开删除确认页 (通用入口)
    // type: 'chat' | 'friend'
    function openDeletePageCommon(type, id, name) {
        deleteTargetType = type; // 标记当前要删什么
        tempChatIdToDelete = id; // 复用这个变量存 ID

        // 更新页面文案
        document.getElementById('del-chat-target-name').textContent = name;
        const titleEl = document.querySelector('#sub-chat-delete .app-title');

        if (type === 'friend') {
            titleEl.textContent = "删除好友";
            // 提示文案也可以微调
            document.querySelector('#sub-chat-delete .wallpaper-content div[style*="font-size: 20px"]').textContent = "删除该好友？";
        } else {
            titleEl.textContent = "删除聊天";
            document.querySelector('#sub-chat-delete .wallpaper-content div[style*="font-size: 20px"]').textContent = "删除该对话？";
        }

        openSubPage('sub-chat-delete');
    }

    // 为了兼容旧代码，保留这个旧函数名，直接转调通用函数
    function openChatDeletePage(chatId, name) {
        openDeletePageCommon('chat', chatId, name);
    }

    // 2. 确认删除 (执行动作)
    async function confirmDeleteChatAction() {
        if (!tempChatIdToDelete) return;

        if (deleteTargetType === 'chat') {
            // --- 删除会话逻辑 ---
            let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
            const newlist = list.filter(c => c.id !== tempChatIdToDelete);
            localStorage.setItem('chat_sessions', JSON.stringify(newlist));
            await dbHelper.save(`chat_avatar_${tempChatIdToDelete}`, null);
            renderChatSessionList();
            showToast("会话已删除");

        } else if (deleteTargetType === 'friend') {
            // --- 删除好友逻辑 (同步删除角色书) ---
            let roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
            const newRoles = roles.filter(r => r.id !== tempChatIdToDelete);
            localStorage.setItem('role_list_meta', JSON.stringify(newRoles));

            // 清理图片数据
            await dbHelper.save(`role_${tempChatIdToDelete}_avatar`, null);
            await dbHelper.save(`role_${tempChatIdToDelete}_bg`, null);

            // 刷新好友列表
            loadChatFriends();
            // 如果角色书页面也在后台，这里也可以尝试刷新一下
            if(typeof renderRoleList === 'function') renderRoleList();

            showToast("好友(角色)已删除");
        }

        closeSubPage('sub-chat-delete');
    }

    // ================== 聊天详情页逻辑 ==================

    let currentChatId = null; // 当前正在聊天的 ID

    // ================== 聊天详情页逻辑 (History & Send/Receive) ==================

    // 1. 进入聊天详情 (由列表点击触发)
    async function openChatDetail(chatId, name, avatarBlobName) {
        currentChatId = chatId;

        // 设置头部信息
        document.getElementById('chat-detail-name').textContent = name;
        const avatarEl = document.getElementById('chat-detail-avatar');

        // 加载头像
        if (avatarBlobName) {
            try {
                const blob = await dbHelper.get(avatarBlobName);
                if(blob) avatarEl.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                else avatarEl.style.backgroundImage = 'none';
            } catch(e) { avatarEl.style.backgroundImage = 'none'; }
        } else {
            avatarEl.style.backgroundImage = 'none';
        }

        // --- 加载历史记录并渲染 ---
        const msgBox = document.getElementById('chat-detail-msgs');
        msgBox.innerHTML = ''; // 清空 existing dummy messages

        const history = await loadChatHistory(chatId);

        if (history.length === 0) {
            msgBox.innerHTML = `<div class="chat-msg system"><span>新会话已开启</span></div>`;
        } else {
            history.forEach(msg => {
                appendChatBubble(msg.sender, msg.text, false); // 渲染历史消息，不自动滚动
            });
        }
        // ------------------------

        // 打开页面，并强制滚动到底部一次 (解决历史记录加载后的位置问题)
        openSubPage('sub-chat-detail');
        msgBox.scrollTop = msgBox.scrollHeight;
    }

    applyChatSettingsToView(); // 应用高级设置

    // ================== 输入栏功能菜单逻辑 ==================

    function toggleInputMenu() {
        const menu = document.getElementById('chat-input-menu');
        const footer = document.querySelector('.chat-detail-footer');

        // 核心 FIX：确保菜单在显示时，输入栏不会被遮挡
        if (menu.classList.contains('active')) {
            // 隐藏菜单
            menu.classList.remove('active');
            menu.style.display = 'none'; // 确保鼠标事件不被阻挡
        } else {
            // 显示菜单
            // 1. 获取输入栏的底部位置 (包括 padding)
            const footerHeight = footer.offsetHeight;
            // 2. 将菜单定位到 footer 上方 (50px 是输入框的高度, 留出空间)
            menu.style.bottom = `${footerHeight}px`;

            menu.classList.add('active');
            menu.style.display = 'block';
        }
    }

    function handleMenuAction(action) {
        toggleInputMenu(); // 点击任何功能都先收起菜单
        showToast(`功能开发中：打开 [${action}] 界面`);
        // 未来可以在这里编写逻辑，例如：if (action === 'photo') openPhotoSelector();
    }

    // 2. 发送消息 (User Send)
    async function sendChatDetailMsg() {
        const input = document.getElementById('chat-msg-input');
        const text = input.value.trim();
        if(!text) return;

        // 1. Append message to DOM and scroll
        appendChatBubble('right', text, true);

        // 2. Update history
        const history = await loadChatHistory(currentChatId);
        history.push({ sender: 'right', text: text, timestamp: Date.now() });
        await saveChatHistory(currentChatId, history);

        // 3. 💾 更新 localStorage 的最后一条消息 (最重要)
        updateChatLastMessage(currentChatId, text);

        input.value = '';
    }

    // ================== 3. AI 回复 (Logic 4.0: 强制随机连发数) ==================
    async function triggerChatDetailAI() {
        if (!currentChatId) return;

        // 1. 检查配置
        const aiConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');
        if (!aiConfig.key || !aiConfig.endpoint) {
            showToast("请先配置 AI 模型 key");
            return;
        }

        // 2. 读取设定
        const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');

        const charName = settings.charName || document.getElementById('chat-detail-name').textContent || "对方";
        const charDesc = settings.charDesc || "你的朋友。";
        const userName = settings.userName || "我";
        const userDesc = settings.userDesc || "聊天伙伴。";
        const worldviews = settings.worldviews && settings.worldviews.length > 0
                           ? settings.worldviews.join('，') : "现代日常";

        // 🎲 核心修改：由前端代码决定本次回复几条 (2 ~ 5 条)
        // Math.random() 生成 0~1，逻辑如下：
        // < 0.3: 2条 (30%概率)
        // < 0.7: 3条 (40%概率)
        // 剩下: 4-5条 (30%概率)
        const rand = Math.random();
        let targetCount = 3;
        if (rand < 0.3) targetCount = 2;
        else if (rand < 0.7) targetCount = 3;
        else targetCount = Math.floor(Math.random() * 2) + 4; // 4或5

        // 3. 注入灵魂的 System Prompt (动态指令版)
        const systemPrompt = `
【指令】
你正在进行沉浸式语C，扮演"${charName}"与"${userName}"对话。

【设定】
人设：${charDesc}
对象：${userDesc}
世界：${worldviews}

【回复铁律】
1. 🚫 **严禁**使用括号、星号描写动作。把动作神态融入语言。
2. 🚫 **严禁**扮演用户。
3. 💬 **强制连发模式**：
   - 本次回复请**严格拆分成 ${targetCount} 条**消息。
   - 必须用**换行符**分隔每一句话。
   - 每一句都要简短、口语化。不要长篇大论。
4. 如果上一条是你发的，请继续补充话题。
`;

        // 4. 构建消息队列
        let messagesToSend = [
            { role: "system", content: systemPrompt }
        ];

        const history = await loadChatHistory(currentChatId);
        // 增加上下文长度到 40，让它更懂前因后果
        const recentHistory = history.slice(-40);

        recentHistory.forEach(msg => {
            messagesToSend.push({
                role: msg.sender === 'right' ? 'user' : 'assistant',
                content: msg.text
            });
        });

        // 防复读逻辑
        if (messagesToSend.length > 0 && messagesToSend[messagesToSend.length - 1].role === 'assistant') {
            messagesToSend.push({
                role: "system",
                content: `(System: ${charName}，请继续补充 ${targetCount} 句不同的话，不要重复之前的内容。)`
            });
        }

        // UI 显示正在输入
        const loadingId = Date.now().toString();
        const box = document.getElementById('chat-detail-msgs');
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'chat-msg left';
        loadingDiv.innerHTML = `<div class="msg-bubble-listen" style="opacity:0.7; font-style:italic;">正在输入...</div>`;
        box.appendChild(loadingDiv);
        box.scrollTop = box.scrollHeight;

        // 5. 发起请求
        try {
            let url = aiConfig.endpoint;
            if (url.endsWith('/')) url = url.slice(0, -1);
            if (!url.endsWith('/v1')) url += '/v1';

            const response = await fetch(`${url}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.key}`
                },
                body: JSON.stringify({
                    model: aiConfig.model,
                    messages: messagesToSend,
                    temperature: 1.0, // 温度拉满，增加随机性和活人感
                    max_tokens: 800,
                    presence_penalty: 0.7,
                    frequency_penalty: 0.4
                })
            });

            // 移除“正在输入”
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.remove();

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();
            let rawText = data.choices[0].message.content;

            if (rawText.startsWith(`${charName}:`)) {
                rawText = rawText.replace(`${charName}:`, '').trim();
            }

            // --- 6. 连发模拟 (处理空行) ---
            let replies = rawText.split('\n').filter(line => line.trim() !== '');

            // 如果模型偶尔没听话只回了一句长句，我们尝试按标点符号强行切分一下
            if (replies.length === 1 && replies[0].length > 30) {
                 // 按句号、问号、感叹号拆分，但保留标点
                 replies = replies[0].match(/[^。？！]+[。？！]+/g) || replies;
            }

            processReplies(replies, 0);

        } catch (error) {
            console.error("AI Error:", error);
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.innerHTML = `<div class="msg-bubble-listen" style="color:#FF3B30;">连接断开</div>`;
        }
    }

    // ================== 🚨 补回丢失的连发助手函数 🚨 ==================
    // 这个函数负责把 AI 的长回复切开，一条条地发出来，模拟真人打字

    async function processReplies(replies, index) {
        // 如果发完了，就结束
        if (index >= replies.length) return;

        const text = replies[index].trim();
        // 如果是空行，跳过，发下一条
        if (!text) {
            processReplies(replies, index + 1);
            return;
        }

        // 1. 消息上屏
        appendChatBubble('left', text, true);

        // 2. 存入历史记录
        // 注意：这里需要重新读取最新的历史，防止连续写入时的覆盖问题
        const history = await loadChatHistory(currentChatId);
        history.push({ sender: 'left', text: text, timestamp: Date.now() });
        await saveChatHistory(currentChatId, history);

        // 3. 更新消息列表的预览
        updateChatLastMessage(currentChatId, text);

        // 4. 计算延迟 (模拟打字速度)
        // 基础 800ms + 每个字 50ms + 随机波动
        const delay = 800 + (text.length * 50) + Math.random() * 500;

        // 5. 等待后发送下一条
        setTimeout(() => {
            processReplies(replies, index + 1);
        }, Math.min(delay, 3000)); // 最长等待 3 秒，防止太慢
    }

    // ================== 好友列表点击后的会话创建逻辑 ==================

    async function createOrOpenChatFromFriend(roleId, roleName) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        let chatSession = list.find(chat => chat.id === roleId); // 检查是否已存在会话

        // 如果会话不存在，则创建新会话
        if (!chatSession) {

            // 1. 获取角色头像 (用于会话列表显示)
            const avatarBlob = await dbHelper.get(`role_${roleId}_avatar`);

            // 2. 定义新会话数据
            chatSession = {
                id: roleId, // 使用 roleId 作为会话 ID
                type: 'single',
                name: roleName,
                lastMsg: '新会话已创建，开始聊天吧',
                time: new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'})
            };

            // 3. 💾 存入会话列表和缓存 (自动刷新消息列表)
            if (avatarBlob) {
                await dbHelper.save(`chat_avatar_${roleId}`, avatarBlob); // 存头像到聊天缓存
            }

            addChatToSessionList(chatSession);
            // addChatToSessionList 函数会自动把新的 session 加到 list 里并刷新 Message List

            showToast(`已创建与 ${roleName} 的新会话`);
        }

        // 4. 打开聊天详情页
        openChatDetail(roleId, chatSession.name, `chat_avatar_${roleId}`);
    }

    // ... (所有函数定义结束之后) ...
    // ===========================================
    // 【强制修复】聊天App 启动初始化
    // ===========================================

    function initChatAppLoad() {
        // 1. 强制初始化消息列表 (必须执行，负责从 localStorage 读数据并绘制)
        renderChatSessionList();

        // 2. 预加载好友列表 (确保好友数据和头像提前加载)
        loadChatFriends();

        // 3. 确保默认选中消息 Tab
        // 调用一次底部导航，强制进入消息页 (msg) 并激活顶部 Tab (list)
        switchChatBottomNav('msg', document.querySelector('.chat-bottom-nav .chat-nav-item.active'));
        switchChatTopTab('list');
    }

    // 页面加载完成后立即执行初始化
    initChatAppLoad();

    // ===========================================
    // ... (可能还有其他 App 的初始化代码，确保放在这之后) ...

    // ================== 聊天记录持久化工具 (IndexedDB) ==================

    // 载入历史记录
    async function loadChatHistory(chatId) {
        return await dbHelper.get(`chat_history_${chatId}`) || [];
    }

    // 保存历史记录
    async function saveChatHistory(chatId, history) {
        await dbHelper.save(`chat_history_${chatId}`, history);
    }

    // 实时更新消息列表的最后一条消息 (LocalStorage) 并置顶
    function updateChatLastMessage(chatId, lastMsg) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        const index = list.findIndex(c => c.id === chatId);

        if (index > -1) {
            list[index].lastMsg = lastMsg;
            list[index].time = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'}); // 更新时间

            // 将该会话移到列表最顶部 (标准的聊天App行为)
            const chatToMove = list.splice(index, 1)[0];
            list.unshift(chatToMove);

            localStorage.setItem('chat_sessions', JSON.stringify(list));

            // 刷新消息列表 UI
            renderChatSessionList();
        }
    }

    // ================== 消息上下文菜单逻辑 ==================

    let currentMessageId = null; // 跟踪哪个消息气泡被点击了

    // 1. 打开菜单
    function openMessageMenu(msgId) {
        currentMessageId = msgId;
        const modal = document.getElementById('modal-message-menu');
        modal.style.display = 'flex';
        modal.style.zIndex = '3000'; // 确保盖住所有东西
        setTimeout(() => modal.classList.add('active'), 10);
    }

    // 2. 关闭菜单
    function closeMessageMenu() {
        const modal = document.getElementById('modal-message-menu');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
        currentMessageId = null;
    }

    // 3. 处理操作 (Placeholder)
    function handleMessageAction(action) {
        closeMessageMenu();
        showToast(`功能开发中: 执行 [${action}] 针对消息 ID: ${currentMessageId}`);

        // 🚨 未来你可以在这里实现真正的逻辑，例如：
        // if (action === 'delete') {
        //    deleteMessageFromHistory(currentChatId, currentMessageId);
        // }
    }


    // 4. 气泡上屏工具 (修改：添加点击事件)
    // 1. 气泡上屏工具 (修改版：带头像结构)
    function appendChatBubble(side, text, doScroll = true) {
        const box = document.getElementById('chat-detail-msgs');
        if (!box) return;

        const msgId = Date.now() + Math.random().toString(36).substring(2, 6);
        const div = document.createElement('div');
        div.className = `chat-msg ${side}`;

        // 核心修改：使用 CSS 变量显示头像 (稍后在 openChatDetail 里定义变量)
        const avatarHtml = `<div class="chat-msg-avatar" style="background-image: var(--avatar-${side})"></div>`;
        const bubbleHtml = `<div class="msg-bubble-listen" onclick="openMessageMenu('${msgId}', '${side}', event)">${text}</div>`;

        // 根据左右不同，排列头像和气泡的顺序
        if (side === 'left') {
            div.innerHTML = avatarHtml + bubbleHtml;
        } else {
            div.innerHTML = bubbleHtml + avatarHtml;
        }

        box.appendChild(div);

        if (doScroll) {
            box.scrollTop = box.scrollHeight;
        }
    }

    // ================== 聊天背景设置逻辑 ==================

    // 1. 初始化：加载保存的背景 (打开设置页时调用)
    async function initChatBackground() {
        const previewEl = document.getElementById('preview-chat-bg');
        try {
            const blob = await dbHelper.get('chat_custom_bg');
            if (blob) {
                const url = URL.createObjectURL(blob);
                // 更新设置页里的预览
                if(previewEl) {
                    previewEl.style.backgroundImage = `url(${url})`;
                    previewEl.innerHTML = '';
                }
                // 顺便确保聊天页背景也应用了
                applyChatBg(url);
            } else {
                if(previewEl) {
                    previewEl.style.backgroundImage = 'none';
                    previewEl.innerHTML = '<span class="widget-preview-text">当前背景预览</span>';
                }
            }
        } catch (e) { console.log("无自定义聊天背景"); }
    }

    // 2. 处理上传
    async function handleChatBgUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);

            // 存入数据库
            await dbHelper.save('chat_custom_bg', file);

            // 应用到当前预览和页面
            applyChatBg(url);
            document.getElementById('preview-chat-bg').style.backgroundImage = `url(${url})`;
            document.getElementById('preview-chat-bg').innerHTML = '';

            showToast("聊天背景已更新");
            input.value = '';
        }
    }

    // 3. 应用背景 (终极修复：强制显示图片，覆盖 CSS)
    function applyChatBg(url) {
        const chatPage = document.getElementById('sub-chat-detail');
        if (!chatPage) return;

        if (url) {
            // 🚨 核心修改：使用 setProperty 并加上 'important' 参数
            // 这能确保图片强制显示，哪怕 CSS 里写了 !important 也能覆盖
            chatPage.style.setProperty('background-image', `url(${url})`, 'important');

            // 同时强制相关属性，防止变形
            chatPage.style.setProperty('background-size', 'cover', 'important');
            chatPage.style.setProperty('background-position', 'center', 'important');
            chatPage.style.setProperty('background-repeat', 'no-repeat', 'important');
        } else {
            // 清除背景图 (恢复默认)
            chatPage.style.removeProperty('background-image');
            chatPage.style.removeProperty('background-size');
            chatPage.style.removeProperty('background-position');
            chatPage.style.removeProperty('background-repeat');
        }
    }

    // 4. 恢复默认
    async function resetChatBackground() {
        if(confirm("确定要恢复默认背景吗？")) {
            await dbHelper.save('chat_custom_bg', null);
            applyChatBg(null);
            // 重置预览
            const previewEl = document.getElementById('preview-chat-bg');
            if(previewEl) {
                previewEl.style.backgroundImage = 'none';
                previewEl.innerHTML = '<span class="widget-preview-text">当前背景预览</span>';
            }
            showToast("已恢复默认背景");
        }
    }

    // 页面加载时尝试应用一次背景
    initChatBackground();

    // ================== 聊天高级设置逻辑 ==================

    // 临时数据缓存
    let tempSettings = {};
    let editingTextField = ''; // 当前正在编辑哪个字段 (char-desc, user-desc)

    // 1. 打开设置页 (入口)
    async function openChatSettings() {
        if (!currentChatId) return;

        // 加载现有设置或默认值
        const savedSettings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');

        // 如果没有保存过，尝试从会话列表和角色书初始化
        const sessions = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        const session = sessions.find(c => c.id === currentChatId);

        // 初始化 tempSettings
        tempSettings = {
            charName: savedSettings.charName || session.name,
            charDesc: savedSettings.charDesc || "暂无人设",
            charAvatar: null, // Blob 稍后加载

            userName: savedSettings.userName || "我",
            userDesc: savedSettings.userDesc || "",
            userAvatar: null,

            worldviews: savedSettings.worldviews || [], // Array of strings

            showAvatar: savedSettings.hasOwnProperty('showAvatar') ? savedSettings.showAvatar : true,
            bubbleStyle: savedSettings.bubbleStyle || 'default',
            customCss: savedSettings.customCss || '',

            isBlocked: savedSettings.isBlocked || false
        };

        // 渲染 UI
        renderSettingsUI();

        // 加载头像预览
        loadSettingAvatar('char', `chat_avatar_${currentChatId}`);
        loadSettingAvatar('user', `user_avatar_${currentChatId}`); // 用户在这个聊天的专属头像

        dbHelper.get('chat_custom_bg').then(blob => {
        const previewEl = document.getElementById('preview-chat-bg');
        if (previewEl) {
            if (blob) {
                previewEl.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                previewEl.innerHTML = ''; // 有图就清空文字
            } else {
                previewEl.style.backgroundImage = 'none';
                previewEl.innerHTML = '<span class="widget-preview-text">当前背景预览</span>';
            }
        }
    });

        openSubPage('sub-chat-settings');
    }

    // 2. 渲染 UI 界面
    function renderSettingsUI() {
        // 填充文本
        document.getElementById('setting-char-name').value = tempSettings.charName;
        document.getElementById('setting-char-desc-preview').textContent = tempSettings.charDesc;

        document.getElementById('setting-user-name').value = tempSettings.userName;
        document.getElementById('setting-user-desc-preview').textContent = tempSettings.userDesc || "暂无...";

        // 填充开关
        document.getElementById('switch-show-avatar').checked = tempSettings.showAvatar;

        // 填充黑名单按钮状态
        const blockBtn = document.getElementById('btn-block-user');
        blockBtn.textContent = tempSettings.isBlocked ? "已拉黑 (点击解除)" : "拉黑该好友";
        blockBtn.style.background = tempSettings.isBlocked ? "#333" : "transparent";

        // 渲染世界观标签
        renderWorldTags();

        // 气泡样式高亮
        selectBubbleStyle(tempSettings.bubbleStyle, null, true); // true 表示仅渲染不保存
    }

    // 3. 头像加载与上传
    async function loadSettingAvatar(type, key) {
        try {
            const blob = await dbHelper.get(key);
            const el = document.getElementById(`setting-${type}-avatar`);
            if (blob) {
                el.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                // 缓存到 temp (如果是读取的，就不存 blob 对象，只标记)
            } else {
                // 尝试默认头像
                if (type === 'user') {
                     const mainAvatar = await dbHelper.get('userAvatar_main');
                     if(mainAvatar) el.style.backgroundImage = `url(${URL.createObjectURL(mainAvatar)})`;
                }
            }
        } catch(e){}
    }

    function triggerSettingAvatar(type) {
        document.getElementById(`input-setting-${type}-avatar`).click();
    }

    function previewSettingAvatar(type, input) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);
            document.getElementById(`setting-${type}-avatar`).style.backgroundImage = `url(${url})`;

            // 存入临时对象，保存时写入数据库
            tempSettings[`${type}AvatarBlob`] = file;
        }
    }

    // 4. 长文本编辑模态窗
    function openTextEditModal(field) {
        editingTextField = field;
        const val = field === 'char-desc' ? tempSettings.charDesc : tempSettings.userDesc;
        document.getElementById('big-text-input').value = val;

        const modal = document.getElementById('modal-text-edit');
        modal.style.display = 'flex';
        setTimeout(()=>modal.classList.add('active'),10);
    }

    function confirmTextEdit() {
        const val = document.getElementById('big-text-input').value;
        if (editingTextField === 'char-desc') {
            tempSettings.charDesc = val;
            document.getElementById('setting-char-desc-preview').textContent = val;
        } else {
            tempSettings.userDesc = val;
            document.getElementById('setting-user-desc-preview').textContent = val;
        }
        document.getElementById('modal-text-edit').classList.remove('active');
        setTimeout(()=>document.getElementById('modal-text-edit').style.display='none',300);
    }
    function closeTextEditModal() {
        document.getElementById('modal-text-edit').classList.remove('active');
        setTimeout(()=>document.getElementById('modal-text-edit').style.display='none',300);
    }

    // 5. 世界观管理
    function renderWorldTags() {
        const container = document.getElementById('setting-world-tags');
        container.innerHTML = '';
        tempSettings.worldviews.forEach((tag, index) => {
            const span = document.createElement('span');
            span.className = 'world-tag';
            span.innerHTML = `${tag} <span class="world-tag-remove" onclick="removeWorldTag(${index})">×</span>`;
            container.appendChild(span);
        });
    }

    function removeWorldTag(index) {
        tempSettings.worldviews.splice(index, 1);
        renderWorldTags();
    }

    // ================== 通用弹窗控制逻辑 ==================

    let genInputCallback = null;
    let genConfirmCallback = null;

    // 1. 打开输入弹窗
    function openGenInputModal(title, label, placeholder, callback) {
        document.getElementById('gen-input-title').textContent = title;
        document.getElementById('gen-input-label').textContent = label;
        const input = document.getElementById('gen-input-field');
        input.value = '';
        input.placeholder = placeholder;

        genInputCallback = callback;

        const modal = document.getElementById('modal-general-input');
        modal.style.display = 'flex';
        setTimeout(()=>modal.classList.add('active'),10);
        input.focus();
    }

    function closeGenInputModal() {
        document.getElementById('modal-general-input').classList.remove('active');
        setTimeout(()=>document.getElementById('modal-general-input').style.display='none',300);
    }

    // 绑定输入确认按钮
    document.getElementById('gen-input-confirm-btn').onclick = function() {
        const val = document.getElementById('gen-input-field').value.trim();
        if(val && genInputCallback) genInputCallback(val);
        closeGenInputModal();
    };

    // 2. 打开确认弹窗
    function openGenConfirmModal(title, desc, btnText, callback) {
        document.getElementById('gen-confirm-title').textContent = title;
        document.getElementById('gen-confirm-desc').innerHTML = desc;
        const btn = document.getElementById('gen-confirm-btn');
        btn.textContent = btnText;

        genConfirmCallback = callback;

        const modal = document.getElementById('modal-general-confirm');
        modal.style.display = 'flex';
        // 强制层级
        modal.style.zIndex = '2500';
        setTimeout(()=>modal.classList.add('active'),10);
    }

    function closeGenConfirmModal() {
        document.getElementById('modal-general-confirm').classList.remove('active');
        setTimeout(()=>document.getElementById('modal-general-confirm').style.display='none',300);
    }

    // 绑定确认按钮
    document.getElementById('gen-confirm-btn').onclick = function() {
        if(genConfirmCallback) genConfirmCallback();
        closeGenConfirmModal();
    };

    // 6. 气泡样式选择
    function selectBubbleStyle(style, el, isInit) {
        if (!isInit) {
            tempSettings.bubbleStyle = style;
            // UI 更新
            document.querySelectorAll('.bubble-preset-item').forEach(d => d.classList.remove('active'));
            if(el) el.classList.add('active');
        } else {
            // 初始化时根据 tempSettings 找元素
            // (这里简化，假设顺序对应，实际最好给 item 加 id)
        }

        const cssInput = document.getElementById('custom-bubble-css');
        if (style === 'custom') {
            cssInput.style.display = 'block';
            cssInput.value = tempSettings.customCss || '';
        } else {
            cssInput.style.display = 'none';
        }
    }

    // 7. 保存所有设置 (Core)
    async function saveChatSettingsDetail() {
        // 收集输入框最新值
        tempSettings.charName = document.getElementById('setting-char-name').value;
        tempSettings.userName = document.getElementById('setting-user-name').value;
        tempSettings.showAvatar = document.getElementById('switch-show-avatar').checked;
        if (tempSettings.bubbleStyle === 'custom') {
            tempSettings.customCss = document.getElementById('custom-bubble-css').value;
        }

        // 1. 存配置到 LocalStorage
        localStorage.setItem(`chat_settings_${currentChatId}`, JSON.stringify(tempSettings));

        // 2. 存图片到 IndexedDB
        if (tempSettings.charAvatarBlob) {
            await dbHelper.save(`chat_avatar_${currentChatId}`, tempSettings.charAvatarBlob);
        }
        if (tempSettings.userAvatarBlob) {
            await dbHelper.save(`user_avatar_${currentChatId}`, tempSettings.userAvatarBlob);
        }

        // 3. 应用样式 (立即生效)
        applyChatSettingsToView();

        // 4. 更新消息列表的名字预览
        updateChatLastMessage(currentChatId, "(设置已更新)"); // 触发列表刷新并更新名字显示逻辑需要修改列表渲染函数，这里暂时只刷列表

        closeSubPage('sub-chat-settings');
        showToast("设置已保存并应用");
    }

    // 3. 应用设置到视图 (背景、头像开关、头像更新、气泡样式) - 最终修复版
    async function applyChatSettingsToView() {
        if (!currentChatId) return;
        const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');
        const page = document.getElementById('sub-chat-detail');

        // A. 应用背景
        try {
            const blob = await dbHelper.get('chat_custom_bg');
            if (blob) {
                applyChatBg(URL.createObjectURL(blob));
            } else {
                applyChatBg(null);
            }
        } catch(e){ applyChatBg(null); }

        // B. 应用头像开关
        if (settings.showAvatar === false) {
            page.classList.add('hide-avatars');
        } else {
            page.classList.remove('hide-avatars');
        }

        // C. 更新头部名字
        if (settings.charName) {
             const nameEl = document.getElementById('chat-detail-name');
             if(nameEl) nameEl.textContent = settings.charName;
        }

        // D. 🚨 核心修复：实时更新头像 (注入 CSS 变量) 🚨

        // D1. 更新对方头像 (Char)
        try {
            // 优先读取该会话专属头像
            const charBlob = await dbHelper.get(`chat_avatar_${currentChatId}`);
            if (charBlob) {
                const url = URL.createObjectURL(charBlob);
                // 更新头部大图
                const headerAvatar = document.getElementById('chat-detail-avatar');
                if(headerAvatar) headerAvatar.style.backgroundImage = `url(${url})`;
                // 更新气泡旁的小图
                page.style.setProperty('--avatar-left', `url(${url})`);
            }
        } catch(e) {}

        // D2. 更新我的头像 (User)
        try {
            // 1. 先试着找“这个会话专属”的用户头像
            let userBlob = await dbHelper.get(`user_avatar_${currentChatId}`);
            // 2. 如果没有，就用“全局默认”的用户头像
            if (!userBlob) {
                userBlob = await dbHelper.get('userAvatar_main');
            }

            if (userBlob) {
                const url = URL.createObjectURL(userBlob);
                page.style.setProperty('--avatar-right', `url(${url})`);
            } else {
                page.style.setProperty('--avatar-right', 'none');
            }
        } catch(e) {}

        // E. 气泡样式应用
        let styleTag = document.getElementById('dynamic-bubble-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'dynamic-bubble-style';
            document.head.appendChild(styleTag);
        }

        let css = '';
        if (settings.bubbleStyle === 'box') {
            css = `.msg-bubble-listen { border-radius: 4px !important; }`;
        } else if (settings.bubbleStyle === 'trans') {
            css = `.msg-bubble-listen { background: rgba(255,255,255,0.1) !important; border: 1px solid rgba(255,255,255,0.3) !important; }`;
        } else if (settings.bubbleStyle === 'custom') {
            css = settings.customCss;
        }
        styleTag.textContent = css;
    }

    // 8. 应用设置到聊天视图 (Apply)
    // 1. 进入聊天详情 (修复版：正确加载双方头像)
    async function openChatDetail(chatId, name, avatarBlobName) {
        currentChatId = chatId;

        // 设置头部默认信息
        const nameEl = document.getElementById('chat-detail-name');
        if(nameEl) nameEl.textContent = name;

        const avatarEl = document.getElementById('chat-detail-avatar');
        if(avatarEl) avatarEl.style.backgroundImage = 'none'; // 先重置

        // --- 加载历史记录 ---
        const msgBox = document.getElementById('chat-detail-msgs');
        if(msgBox) {
            msgBox.innerHTML = '';
            const history = await loadChatHistory(chatId);

            if (history.length === 0) {
                msgBox.innerHTML = `<div class="chat-msg system"><span>新会话已开启</span></div>`;
            } else {
                history.forEach(msg => {
                    appendChatBubble(msg.sender, msg.text, false);
                });
            }
            // 强制滚动
            setTimeout(() => { msgBox.scrollTop = msgBox.scrollHeight; }, 0);
        }

        // 打开页面
        openSubPage('sub-chat-detail');

        // 🚨 最后调用一次全量应用函数，负责加载头像、背景和样式
        // 这样我们就不需要在 openChatDetail 里重复写读取头像的代码了
        applyChatSettingsToView();
    }

    // 9. 危险操作
    async function clearCurrentChatHistory() {
        if(confirm("清空所有记录？")) {
            await dbHelper.save(`chat_history_${currentChatId}`, []);
            document.getElementById('chat-detail-msgs').innerHTML = '';
            showToast("记录已清空");
        }
    }

    function toggleBlockUser() {
        tempSettings.isBlocked = !tempSettings.isBlocked;
        renderSettingsUI(); // 更新按钮文字
    }

    function deleteCurrentChatAndFriend() {
        if(confirm("删除当前好友及所有记录？")) {
            // 调用之前的删除逻辑
            openDeletePageCommon('friend', currentChatId, tempSettings.charName);
            closeSubPage('sub-chat-settings');
        }
    }

    // 10. 搜索聊天记录
    async function searchChatHistory(keyword) {
        const box = document.getElementById('search-result-box');
        if (!keyword) {
            box.style.display = 'none';
            return;
        }

        const history = await loadChatHistory(currentChatId);
        const results = history.filter(msg => msg.text.includes(keyword));

        box.innerHTML = '';
        if (results.length > 0) {
            box.style.display = 'block';
            results.forEach(msg => {
                const div = document.createElement('div');
                div.style.fontSize = '12px';
                div.style.color = 'white';
                div.style.padding = '5px 0';
                div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                div.textContent = `${msg.sender==='right'?'我':'Ta'}: ${msg.text}`;
                box.appendChild(div);
            });
        } else {
             box.style.display = 'block';
             box.innerHTML = '<div style="color:#999;font-size:12px;">无搜索结果</div>';
        }
    }

    // ================== 世界观与弹窗逻辑修复版 ==================

    // 标记：是否是从聊天设置页发起的“添加世界观”操作
    let isAddingWorldFromChat = false;

    // 1. 打开世界观选择列表 (显示详情版)
    function openWorldSelectModal() {
        const modal = document.getElementById('modal-world-select');
        const list = document.getElementById('world-select-list');

        // 读取世界书
        const worlds = JSON.parse(localStorage.getItem('world_book_data') || '[]');
        list.innerHTML = '';

        if (worlds.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">暂无设定，请先去世界书或点击自定义添加</div>';
        }

        worlds.forEach(w => {
            const div = document.createElement('div');
            div.className = 'world-select-item';
            div.innerHTML = `
                <div class="world-select-title">${w.title}</div>
                <div class="world-select-desc">${w.content}</div>
            `;

            div.onclick = () => {
                // 选中逻辑：添加 Tag 并关闭
                if(!tempSettings.worldviews.includes(w.title)) {
                    tempSettings.worldviews.push(w.title);
                    renderWorldTags();
                }
                modal.classList.remove('active');
                setTimeout(()=>modal.style.display='none',300);
            };
            list.appendChild(div);
        });

        modal.style.display = 'flex';
        setTimeout(()=>modal.classList.add('active'),10);
    }

    // 2. 自定义世界观 (调用世界书的大弹窗)
    function addCustomWorldTag() {
        // 标记来源
        isAddingWorldFromChat = true;
        // 复用世界书的编辑弹窗
        openWorldEditModal();
    }

    // 3. 保存世界书数据 (修改版：支持回调到聊天设置)
    // ⚠️ 请替换掉原来的 saveWorldData 函数
    function saveWorldData() {
        const title = document.getElementById('world-edit-title').value.trim();
        const content = document.getElementById('world-edit-content').value.trim();

        if (!title) { showToast("请输入标题"); return; }

        // 保存到世界书列表
        if (currentWorldId) {
            // 编辑模式
            const item = worldList.find(w => w.id === currentWorldId);
            item.title = title;
            item.content = content;
        } else {
            // 新建模式
            worldList.push({
                id: Date.now().toString(),
                title: title,
                content: content
            });
        }

        localStorage.setItem('world_book_data', JSON.stringify(worldList));

        // --- 🆕 新增逻辑：如果是从聊天设置页来的 ---
        if (isAddingWorldFromChat) {
            // 自动把新标题加入到聊天设置的 Tag 里
            if(!tempSettings.worldviews.includes(title)) {
                tempSettings.worldviews.push(title);
                renderWorldTags(); // 刷新标签显示
            }
            isAddingWorldFromChat = false; // 重置标记
            showToast("已添加到世界观和当前聊天");
        } else {
            showToast("设定已保存");
            renderWorldList(); // 刷新世界书主页列表
        }

        closeWorldModal();
    }

    // 4. 恢复默认背景 (使用自定义弹窗)
    async function resetChatBackground() {
        // 必须确保 openGenConfirmModal 已定义 (上一步代码里有)
        openGenConfirmModal(
            "恢复默认背景",
            "确定要移除当前的聊天背景图片吗？<br>将恢复为默认样式。",
            "恢复",
            async () => {
                await dbHelper.save('chat_custom_bg', null);
                applyChatBg(null);
                showToast("已恢复默认背景");
            }
        );
    }

    // 5. 清空聊天记录 (使用自定义弹窗)
    async function clearCurrentChatHistory() {
        openGenConfirmModal(
            "清空记录",
            "确定要清空与该好友的所有聊天记录吗？<br>此操作不可撤销。",
            "清空",
            async () => {
                await dbHelper.save(`chat_history_${currentChatId}`, []);
                // 如果聊天页面开着，清空 DOM
                const msgBox = document.getElementById('chat-detail-msgs');
                if(msgBox) msgBox.innerHTML = '';
                showToast("记录已清空");
            }
        );
    }

    // 6. 删除好友并退出 (使用自定义弹窗)
    function deleteCurrentChatAndFriend() {
        openGenConfirmModal(
            "删除好友",
            `确定要删除好友 <b>${tempSettings.charName}</b> 吗？<br>所有数据将被永久删除。`,
            "删除",
            () => {
                openDeletePageCommon('friend', currentChatId, tempSettings.charName);
                // 关闭设置页
                closeSubPage('sub-chat-settings');
                // 关闭聊天详情页 (返回列表)
                closeSubPage('sub-chat-detail');
            }
        );
    }

    // ================== 修复：移除世界观标签 ==================
    function removeWorldTag(index) {
        // 从数组中删除
        tempSettings.worldviews.splice(index, 1);
        // 重新渲染界面
        renderWorldTags();
    }

</script>
</body>
</html>

