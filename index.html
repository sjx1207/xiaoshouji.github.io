<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iOS Pro Ultimate Persistent</title>
    <style>
        :root {
            /* èƒŒæ™¯ï¼šæ›´æ¸…é€çš„æå…‰è“ */
            --bg-gradient: linear-gradient(160deg, #a1fdd4 0%, #c2fbe5 100%);
            --glass: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.5);
            --blur: saturate(180%) blur(40px);
            --text-main: #1d1d1f;
            --text-sub: #555;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            width: 100%; height: 100vh; overflow: hidden; 
            background: var(--bg-gradient); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
            display: flex; flex-direction: column;
        }

        /* 1. çŠ¶æ€æ  (å±‚çº§è°ƒåˆ°æœ€é«˜ï¼Œä¿è¯ App æ‰“å¼€æ—¶å®ƒè¿˜åœ¨æœ€ä¸Šé¢) */
        .status-bar {
            height: 48px; padding: 0 24px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--text-main); font-weight: 600; font-size: 15px; 
            z-index: 9999; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šå±‚çº§æœ€é«˜ */
            position: relative; /* ç¡®ä¿ z-index ç”Ÿæ•ˆ */
        }
        .status-right { display: flex; align-items: center; gap: 6px; }
        .bat-text { font-size: 13px; font-weight: 700; margin-right: 4px; }
        .battery-box { width: 25px; height: 12px; border: 1.5px solid var(--text-main); border-radius: 3px; padding: 1px; position: relative; opacity: 0.8; }
        .bat-fill { height: 100%; background: var(--text-main); border-radius: 1px; width: 60%; }
        .bat-tip { position: absolute; right: -3px; top: 2.5px; width: 2px; height: 3px; background: var(--text-main); border-radius: 0 2px 2px 0; }

        /* 2. æ ¸å¿ƒå¸ƒå±€ */
        .main-container {
            flex: 1; 
            padding: 10px 22px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 2.3fr 1fr 0.7fr 1.1fr 1.1fr; 
            gap: 16px;
            align-items: center;
        }

        /* é€šç”¨å¡ç‰‡ */
        .widget {
            background: var(--glass);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        /* å¢åŠ ç»ç’ƒé«˜å…‰ï¼Œæ˜¾å¾—æ›´é«˜çº§ */
        .widget::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .w-2x2 { grid-column: span 2; }
        .w-4x1 { grid-column: span 4; }

        /* å¤©æ°”ç»„ä»¶ */
        .weather-content { display: flex; flex-direction: column; height: 100%; justify-content: space-between; position: relative; z-index: 2; }
        .w-date-block { display: flex; flex-direction: column; }
        .w-day { font-size: 11px; font-weight: 800; color: #ff3b30; text-transform: uppercase; margin-bottom: 2px; }
        .w-date { font-size: 13px; font-weight: 600; color: #555; text-transform: uppercase; }
        .w-icon-area { width: 60px; height: 60px; margin: 5px 0 0 -5px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .w-temp { font-size: 42px; font-weight: 800; color: #1d1d1f; line-height: 1; letter-spacing: -2px; }
        .w-city { font-size: 13px; font-weight: 600; color: #666; margin-top: 4px; display: flex; align-items: center; gap:4px; }

        /* å›¾ç‰‡ç»„ä»¶ */
        .pic-container { height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }
        .pic-text { font-size: 14px; font-weight: 700; font-style: italic; color: #222; margin-bottom: 10px; line-height: 1.3; }
        .pic-wrapper { flex: 1; width: 100%; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.05); position: relative; }
        .pic-img { width: 100%; height: 100%; object-fit: cover; }

        /* éŸ³ä¹ç»„ä»¶ */
        .music-row { display: flex; align-items: center; justify-content: space-between; height: 100%; position: relative; z-index: 2; }
        .album-cover { width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .track-info { display: flex; flex-direction: column; margin-left: 14px; margin-right: auto; justify-content: center; }
        .track-title { font-size: 15px; font-weight: 700; color: #1d1d1f; }
        .track-artist { font-size: 12px; color: #666; margin-top: 3px; }
        .ctrl-btns { display: flex; gap: 16px; align-items: center; flex-shrink: 0; opacity: 0.8; }

        /* === ä¿®å¤é‡ç‚¹ï¼šè¿›åº¦æ¡ === */
        .prog-stack { display: flex; flex-direction: column; justify-content: center; height: 100%; gap: 10px; position: relative; z-index: 2; }
        .prog-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: #444; text-transform: uppercase; }
        
        /* è½¨é“ï¼šæ·±è‰²åŠé€æ˜ï¼Œç¡®ä¿å¯¹æ¯”åº¦ */
        .prog-bg { 
            width: 100%; height: 14px; 
            background: rgba(0,0,0,0.15); 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        /* å¡«å……ï¼šçº¯ç™½ + å‘å…‰ */
        .prog-fg { 
            height: 100%; 
            min-height: 14px; /* å¼ºåˆ¶ç»™ä¸€ä¸ªå’Œçˆ¶å…ƒç´ ä¸€æ ·çš„é«˜åº¦ */
            background: #057b46; 
            width: 0%; 
            transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); 
            box-shadow: 0 0 15px rgba(255,255,255,0.8); /* å…³é”®ï¼šç™½è‰²å‘å…‰ */
            border-radius: 20px;
        }

        /* App å›¾æ ‡ - ä¼˜åŒ–è´¨æ„Ÿï¼Œå»é™¤å»‰ä»·å‘å…‰ */
        .app-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 8px; }
        .icon-shape { 
            width: 60px; height: 60px; border-radius: 16px; 
            background: rgba(255,255,255,0.85); 
            /* æ›´åƒå®ä½“ç»ç’ƒçš„é˜´å½± */
            box-shadow: 0 4px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,1);
            display: flex; align-items: center; justify-content: center; color: #333;
            backdrop-filter: blur(10px);
        }
        .app-name { font-size: 11px; font-weight: 600; color: #1d1d1f; text-shadow: 0 1px 1px rgba(255,255,255,0.5); }
        .svg-icon { width: 30px; height: 30px; fill: currentColor; }

        /* === ä¿®å¤é‡ç‚¹ï¼šDock & å°ç™½æ¡ === */
        .dock-container { 
            flex-shrink: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-end; 
            padding-bottom: 30px; /* ç»™å°ç™½æ¡ç•™ä½ç½® */
            position: relative; z-index: 50;
        }
        .dock-bar { 
            width: 90%; max-width: 380px; height: 85px; 
            background: rgba(255,255,255,0.4); 
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 42px; 
            display: flex; align-items: center; justify-content: space-evenly; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }
        .dock-app { width: 58px; height: 58px; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* å¼ºåˆ¶æ˜¾å½¢çš„å°ç™½æ¡ */
        .home-indicator { 
            position: absolute; 
            bottom: 8px; /* è·ç¦»åº•éƒ¨ 8px */
            left: 50%; transform: translateX(-50%);
            width: 135px; height: 5px; 
            background: #ffffff; /* çº¯ç™½ */
            border-radius: 10px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            z-index: 9999; /* æœ€é¡¶å±‚ */
            display: block !important;
        }

        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: flex-end; }
        .modal-content { width: 100%; background: #fff; border-radius: 36px 36px 0 0; padding: 25px; padding-bottom: 50px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from {transform:translateY(100%)} to {transform:translateY(0)} }
        .modal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-h1 { font-size: 18px; font-weight: 700; }
        .modal-done { color: #007AFF; font-weight: 700; cursor: pointer; }
        /* --- iOS åˆ†æ®µæ§åˆ¶å™¨æ ·å¼ --- */
.segment-control {
    display: flex;
    background: #eeeeef;
    padding: 3px;
    border-radius: 12px;
    margin-bottom: 15px;
}

.segment-btn {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #636366;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.segment-btn.active {
    background: #ffffff;
    color: #000000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.12);
}

/* --- è§†å›¾åˆ‡æ¢é€»è¾‘ --- */
.city-view {
    display: none; /* é»˜è®¤éšè— */
    animation: fadeIn 0.3s ease;
}

.city-view.active {
    display: block; /* æ¿€æ´»æ—¶æ˜¾ç¤º */
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
        .city-tag { padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; }
        .upload-tools { display: flex; gap: 10px; margin-top: 10px; }
        .tool-btn { flex: 1; padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; color: #007AFF; font-weight: 600; cursor: pointer; }


    /* --- App Window (å…¨å±åº”ç”¨æ¨¡å¼) --- */
.ios-app-window {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #F2F2F7; 
    z-index: 5000; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šæ¯”çŠ¶æ€æ ä½ï¼Œæ¯”æ¡Œé¢é«˜ */
    display: flex; flex-direction: column;
    transform: translateX(100%); 
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    padding-top: 48px; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šç»™çŠ¶æ€æ ç•™å‡ºä½ç½® */
}
.ios-app-window.active { transform: translateX(0); }

/* App Header */
.app-header {
    height: 60px; padding: 0 24px; 
    display: flex; align-items: center; justify-content: space-between;
    background: transparent; /* é€æ˜èƒŒæ™¯ï¼Œæ›´ç°ä»£ */
    flex-shrink: 0;
}
.header-title-big { 
    font-size: 32px; font-weight: 800; color: #000; letter-spacing: -0.5px; 
}
.header-close-btn {
    width: 36px; height: 36px; background: #e5e5ea; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #8e8e93; cursor: pointer;
    font-weight: 700; font-size: 14px;
}
.header-left { display: flex; align-items: center; color: #007AFF; font-size: 16px; cursor: pointer; }
.header-title { font-weight: 600; font-size: 16px; color: #000; }
.header-right { width: 60px; } /* å ä½ */

/* App Body */
.app-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
.app-title-large { font-size: 28px; font-weight: 800; color: #000; align-self: flex-start; margin-bottom: 10px; }

/* é¢„è§ˆæ¡† (æ‰‹æœºæ¯”ä¾‹) */
.preview-stage {
    width: 200px; height: 400px; 
    background: #fff; border-radius: 24px;
    /* é‡ç‚¹ï¼šå±…ä¸­å¸ƒå±€ï¼Œé˜²æ­¢å†…å®¹ä¹±è·‘ */
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    border: 8px solid #fff;
    margin-bottom: 30px;
    overflow: hidden;
    position: relative;
    flex-shrink: 0;
}
.phone-frame { width: 100%; height: 100%; position: relative; }
/* å…³é”®ï¼šé»˜è®¤å…¨éƒ¨éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
.phone-frame img, .phone-frame video { 
    width: 100%; height: 100%; object-fit: cover; display: none; 
}
.preview-placeholder {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: #999; font-weight: 600; font-size: 14px; width: 100%; text-align: center;
}

/* æŒ‰é’®ç»„ */
.action-area { width: 100%; display: flex; flex-direction: column; gap: 12px; }
.ios-btn {
    width: 100%; padding: 16px; border-radius: 14px; border: none;
    font-size: 16px; font-weight: 700; cursor: pointer;
    transition: transform 0.1s;
}
.ios-btn:active { transform: scale(0.98); }
.ios-btn.primary { background: #007AFF; color: #fff; }
.ios-btn.secondary { background: #fff; color: #007AFF; }

/* Toast æç¤º */
.ios-toast {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    background: rgba(25,25,25,0.8); backdrop-filter: blur(10px);
    color: #fff; padding: 20px 40px; border-radius: 20px;
    font-weight: 600; opacity: 0; pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 1000;
}
.ios-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

/* 4. å£çº¸å†å²è®°å½• (æ–°å¢æ ·å¼) */
.history-section { padding: 0 20px 40px 20px; width: 100%; }
.history-title { font-size: 18px; font-weight: 700; color: #000; margin: 30px 0 15px 0; }
.history-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
}
.history-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 9/16; background: #eee; cursor: pointer; }
.history-item.active { border-color: #007AFF; }
.history-item img { width: 100%; height: 100%; object-fit: cover; }
.vid-badge {
    position: absolute; top: 6px; right: 6px;
    background: rgba(0,0,0,0.6); color: #fff;
    font-size: 9px; font-weight: 800; padding: 2px 6px;
    border-radius: 4px; backdrop-filter: blur(4px);
    border: 0.5px solid rgba(255,255,255,0.3);
}
.history-del {
    position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
    background: rgba(255, 59, 48, 0.9); border-radius: 50%; color: #fff;
    display: flex; align-items: center; justify-content: center; font-size: 12px;
}
/* --- 3. iOS é£æ ¼æˆåŠŸå¼¹çª— (Alert) --- */
.ios-alert-mask {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
    z-index: 10000; /* æœ€é«˜å±‚çº§ */
    display: none; align-items: center; justify-content: center;
    animation: fadeIn 0.2s;
}
.ios-alert-box {
    width: 270px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
    border-radius: 14px; text-align: center; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: scale(1.1); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
.alert-title { font-size: 17px; font-weight: 700; margin: 20px 0 5px 0; color: #000; }
.alert-msg { font-size: 13px; color: #000; padding: 0 15px 20px 15px; line-height: 1.4; }
.alert-btn { 
    border-top: 0.5px solid rgba(60,60,67,0.29); 
    padding: 12px; color: #007AFF; font-size: 17px; font-weight: 600; cursor: pointer;
}
.alert-btn:active { background: rgba(0,0,0,0.05); }

@keyframes popIn { to { transform: scale(1); } }
/* --- è§’è‰²ä¹¦ä¸“ç”¨æ ·å¼ --- */

/* 1. è§’è‰²åˆ—è¡¨ç½‘æ ¼ */
.char-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
.char-card {
    background: #fff; border-radius: 16px; overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
    transition: transform 0.2s; cursor: pointer;
}
.char-card:active { transform: scale(0.96); }
.char-card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
.char-card-info { padding: 12px; }
.char-card-name { font-weight: 700; font-size: 15px; color: #000; margin-bottom: 4px; }
.char-card-desc { font-size: 11px; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* 2. è¯¦æƒ…é¡µè§†å›¾ (è¦†ç›–åœ¨åˆ—è¡¨ä¸Š) */
.char-detail-view {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 10; display: none; flex-direction: column; overflow-y: auto;
    animation: slideInRight 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes slideInRight { from {transform: translateX(100%);} to {transform: translateX(0);} }

/* é¡¶éƒ¨èƒŒæ™¯å›¾ */
.char-hero-bg {
    width: 100%; height: 240px; background-color: #ddd; background-size: cover; background-position: center;
    position: relative; flex-shrink: 0; cursor: pointer;
}
.bg-hint {
    position: absolute; bottom: 10px; right: 10px; 
    background: rgba(0,0,0,0.5); color: #fff; font-size: 10px; 
    padding: 4px 8px; border-radius: 12px; backdrop-filter: blur(4px);
}

/* å†…å®¹å®¹å™¨ (å¤„ç†å¤´åƒé‡å ) */
.char-content {
    background: #fff; flex: 1; border-radius: 24px 24px 0 0;
    margin-top: -30px; /* å…³é”®ï¼šè´Ÿè¾¹è·å®ç°é‡å  */
    position: relative; padding: 0 20px 40px 20px;
}

/* è¯¦æƒ…å¤´åƒ */
.char-avatar-container {
    width: 110px; height: 110px; /*ç¨å¾®æ”¹å¤§ä¸€ç‚¹ç‚¹æ›´éœ¸æ°”*/
    border-radius: 50%; 
    border: 4px solid #fff; 
    background: #fff;
    position: absolute; 
    top: -55px; /* ä¸Šæµ®è·ç¦» */
    
    /* ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šæ°´å¹³å±…ä¸­ä¸‡èƒ½å…¬å¼ */
    left: 50%;
    transform: translateX(-50%); 
    
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
    overflow: hidden;
    z-index: 5;
}
#detail-avatar { width: 100%; height: 100%; object-fit: cover; }

/* è¯¦æƒ…ä¿¡æ¯ */
.char-info-block { 
    margin-top: 65px; /* ç•™å‡ºå¤´åƒçš„ä½ç½® */
    display: flex; 
    flex-direction: column; 
    align-items: center; /* è®©åå­—ã€ç®€ä»‹ã€æŒ‰é’®å…¨éƒ¨å±…ä¸­ */
    text-align: center;  /* è®©æ–‡å­—å±…ä¸­å¯¹é½ */
}

.char-name { 
    font-size: 28px; 
    font-weight: 800; 
    color: #000; 
    margin-bottom: 12px; 
    letter-spacing: -0.5px;
}

.char-desc-preview {
    font-size: 15px; 
    line-height: 1.6; 
    color: #555; 
    background: #f2f2f7; 
    padding: 16px 20px; 
    border-radius: 18px;
    cursor: pointer;
    text-align: left; /* ç®€ä»‹å†…å®¹è¿˜æ˜¯é å·¦è¯»èµ·æ¥æ¯”è¾ƒèˆ’æœï¼Œæˆ–è€…æ”¹æˆ center ä¹Ÿå¯ä»¥ */
    width: 100%;      /* æ’‘æ»¡å®½åº¦ */
    max-width: 320px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå®½éš¾çœ‹ */
}

/* æŒ‰é’®ç»„å±…ä¸­ */
.char-actions { 
    display: flex; 
    gap: 12px; 
    margin-top: 30px; 
    width: 100%;
    justify-content: center; /* æŒ‰é’®æ°´å¹³å±…ä¸­ */
}

/* æ‚¬æµ®è¿”å›æŒ‰é’® */
.floating-back {
    position: absolute; top: 50px; left: 20px; width: 40px; height: 40px;
    background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; z-index: 20;
    color: #000;
}

/* 3. ä¸Šä¼ ç›¸å…³ */
.char-upload-circle {
    width: 80px; height: 80px; border-radius: 50%; background: #f2f2f7;
    display: flex; align-items: center; justify-content: center;
    color: #007AFF; font-weight: 600; cursor: pointer; overflow: hidden; position: relative;
}
#edit-avatar-preview { width: 100%; height: 100%; object-fit: cover; }

/* é€šç”¨è¾“å…¥æ¡† */
.ios-input {
    width: 100%; padding: 12px; background: #f2f2f7; border: none; border-radius: 10px;
    font-size: 16px; margin-bottom: 12px; font-family: inherit;
}

/* --- 4. åŸåˆ›é«˜çº§æ‚å¿—é£å¡ç‰‡ (Aesthetic Style) --- */
.aesthetic-card {
    width: 88%; max-width: 360px; height: 80vh;
    background: #fff; 
    border-radius: 32px; 
    position: relative; overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.5) inset;
    display: flex; flex-direction: column;
    animation: floatUp 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}

/* 1. é¡¶éƒ¨æ°›å›´åŒº */
.aes-hero {
    height: 180px; width: 100%; position: relative; flex-shrink: 0;
    overflow: hidden;
}
.aes-blur-bg {
    width: 120%; height: 120%; position: absolute; top: -10%; left: -10%;
    background-size: cover; background-position: center;
    filter: blur(40px) saturate(150%); opacity: 0.8;
}
.aes-noise {
    /* æ·»åŠ ä¸€ç‚¹æ‚è‰²é¢—ç²’æ„Ÿï¼Œå¢åŠ é«˜çº§çº¸è´¨æ„Ÿ */
    position: absolute; inset: 0; opacity: 0.08;
    background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIj48ZmlsdGVyIGlkPSJnoiPjGZlV1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=');
}
.aes-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,1) 100%);
}

/* 2. æ‚¬æµ®å†…å®¹åŒº */
.aes-float-content {
    margin-top: -60px; padding: 0 24px; position: relative; z-index: 2;
    display: flex; flex-direction: column; align-items: center; text-align: center;
}
.aes-avatar-box {
    width: 100px; height: 100px; border-radius: 28px; /* æ›´åŠ ç°ä»£çš„åœ†è§’çŸ©å½¢ */
    padding: 4px; background: #fff;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    transform: rotate(-3deg); /* å¾®å¾®å€¾æ–œï¼Œå¢åŠ è®¾è®¡æ„Ÿ */
    transition: transform 0.3s ease;
}
.aesthetic-card:hover .aes-avatar-box { transform: rotate(0deg) scale(1.05); }

.aes-avatar-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 24px; }

.aes-title-group { margin-top: 15px; margin-bottom: 20px; }
.aes-name { 
    font-family: -apple-system, serif; /* å°è¯•è¡¬çº¿ä½“å¢åŠ é«˜çº§æ„Ÿ */
    font-size: 24px; font-weight: 800; color: #111; letter-spacing: -0.5px; 
}
.aes-tag {
    display: inline-block; margin-top: 6px;
    font-size: 9px; font-weight: 700; letter-spacing: 2px; color: #999;
    border: 1px solid #eee; padding: 4px 10px; border-radius: 20px;
    text-transform: uppercase;
}

/* 3. æ–‡æœ¬æ»šåŠ¨åŒº */
.aes-scroll-area {
    flex: 1; overflow-y: auto; padding: 0 28px 20px 28px;
    -webkit-overflow-scrolling: touch;
    mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
}
.aes-scroll-area::-webkit-scrollbar { display: none; }

.aes-text-body {
    font-size: 15px; line-height: 1.8; color: #444; text-align: justify;
    font-weight: 400; white-space: pre-wrap;
}
.aes-divider { text-align: center; margin-top: 30px; color: #ddd; font-size: 12px; }

/* 4. åº•éƒ¨æ§åˆ¶æ  */
.aes-control-bar {
    padding: 20px 30px 30px 30px; display: flex; gap: 15px;
    background: #fff; z-index: 5;
}
.aes-btn {
    flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px; border-radius: 16px; font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
}
.aes-btn.edit { background: #f5f5f7; color: #333; }
.aes-btn.edit:active { background: #e5e5ea; transform: scale(0.98); }

.aes-btn.delete { background: #fff0f0; color: #ff3b30; }
.aes-btn.delete:active { background: #ffe5e5; transform: scale(0.98); }

@keyframes floatUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
/* --- æ–°å¢ï¼šé¡¶éƒ¨æ‚¬æµ®æŒ‰é’®æ ·å¼ --- */
.aes-top-bar {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 20px; display: flex; justify-content: space-between;
    z-index: 10; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç©ºç™½åŒºåŸŸ */
}

.aes-icon-circle {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,0.2); 
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer; pointer-events: auto; /* æ¢å¤æŒ‰é’®ç‚¹å‡» */
    transition: transform 0.2s, background 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.aes-icon-circle:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
.aes-icon-circle.close { background: rgba(0,0,0,0.15); } /* å…³é—­æŒ‰é’®ç¨å¾®æ·±ä¸€ç‚¹ */
/* --- è™šçº¿æ·»åŠ å¡ç‰‡æ ·å¼ --- */
.char-card.add-new {
    background: rgba(0,0,0,0.02);
    border: 2px dashed #ccc;
    box-shadow: none;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: #999;
    min-height: 200px; /* Ensure same height as others */
}
.char-card.add-new:active { background: rgba(0,0,0,0.05); border-color: #bbb; }

.add-icon-big {
    width: 40px; height: 40px; margin-bottom: 8px; opacity: 0.5;
}
.add-text { font-size: 14px; font-weight: 600; }
/* --- Settings App åˆ—è¡¨æ ·å¼ --- */
.ios-list-group {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.ios-list-item {
    display: flex; align-items: center;
    padding-left: 16px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s;
    height: 48px; /* æ ‡å‡† iOS åˆ—è¡¨é«˜åº¦ */
}
.ios-list-item:active { background: #f2f2f7; }

.item-icon {
    width: 28px; height: 28px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    margin-right: 12px; flex-shrink: 0;
}

.item-content {
    flex: 1; height: 100%;
    display: flex; align-items: center; justify-content: space-between;
    padding-right: 16px;
    border-bottom: 0.5px solid #c6c6c8; /* iOS ç»å…¸åˆ†å‰²çº¿ */
}

.item-label { font-size: 16px; color: #000; font-weight: 400; }

.item-right { display: flex; align-items: center; gap: 6px; }
.item-value { font-size: 16px; color: #8e8e93; }
.chevron { opacity: 0.5; }
/* --- Timezone Search Styles --- */
.ios-search-wrapper {
    background: rgba(118, 118, 128, 0.12); /* iOS æ ‡å‡†æœç´¢æ¡†åº•è‰² */
    border-radius: 10px;
    display: flex; align-items: center;
    padding: 15px 10px;
    transition: background 0.2s;
}
.ios-search-wrapper:focus-within {
    background: rgba(118, 118, 128, 0.18);
}

.search-icon {
    width: 16px; height: 16px; 
    stroke: #8e8e93; stroke-width: 2.5; fill: none;
    margin-right: 8px; flex-shrink: 0;
}

.ios-search-input {
    border: none; background: transparent; outline: none;
    font-size: 16px; color: #000; flex: 1; padding: 0;
    font-family: inherit;
}
.ios-search-input::placeholder { color: #8e8e93; }

/* åˆ—è¡¨æ ‡é¢˜æ ·å¼ */
.tz-group-title {
    padding: 0 16px; margin-bottom: 6px; margin-top: 24px;
    font-size: 12px; font-weight: 600; color: #6e6e73;
    text-transform: uppercase; letter-spacing: 0.5px;
}
/* --- ğŸš‘ ä¿®å¤æ—¶åŒºé¡µé¢æ‰“ä¸å¼€çš„é—®é¢˜ --- */
.ios-sub-page {
    /* é»˜è®¤è—åœ¨å³è¾¹ */
    transform: translateX(100%);
    /* æ·»åŠ ä¸æ»‘åŠ¨ç”» */
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
}

/* --- ğŸš‘ å¼ºåˆ¶ä¿®å¤æ—¶åŒºåˆ—è¡¨å®½åº¦ (è®©å®ƒæ’‘æ»¡å±å¹•) --- */

/* 1. æ ¸å¿ƒä¿®å¤ï¼šæŠŠå®¹å™¨çš„å¯¹é½æ–¹å¼ä»â€œå±…ä¸­â€æ”¹ä¸ºâ€œæ‹‰ä¼¸â€ */
#subpage-timezone .app-body {
    align-items: stretch !important; /* å…³é”®ï¼è®©å­å…ƒç´ æ¨ªå‘æ’‘æ»¡ */
    width: 100% !important;
    padding: 0 16px 80px 16px !important; /* å·¦å³ç•™ 16px çš„èˆ’é€‚è¾¹è· */
    box-sizing: border-box !important;
}

/* 2. ç¡®ä¿åˆ—è¡¨ç»„ä¹Ÿæ˜¯æ»¡å®½çš„ */
#subpage-timezone .ios-list-group {
    width: auto !important; /* è‡ªåŠ¨å¡«æ»¡çˆ¶å®¹å™¨ */
    margin-left: 0 !important;
    margin-right: 0 !important;
    border-radius: 12px !important; /* ä¿æŒåœ†è§’ */
}

/* 3. (å¯é€‰) å¦‚æœä½ è§‰å¾—æœç´¢æ¡†ä¹Ÿå¤ªçª„ï¼ŒåŠ ä¸Šè¿™ä¸ª */
#subpage-timezone .timezone-top-area {
    width: 100% !important;
}
/* --- ğŸš‘ ä¿®å¤æ—¶åŒºé€‰ä¸­å¯¹å‹¾ä¸æ˜¾ç¤ºçš„é—®é¢˜ --- */

/* 1. å®šä¹‰å¯¹å‹¾å®¹å™¨ */
#subpage-timezone .item-check {
    width: 20px; height: 20px;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s;
    
    /* ğŸ‘‡ æ ¸å¿ƒé­”æ³•ï¼šç›´æ¥ç”¨ CSS ç”»å‡ºè“è‰²å¯¹å‹¾èƒŒæ™¯ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23007AFF' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
}

/* 2. æ¿€æ´»æ—¶æ˜¾ç¤º */
#subpage-timezone .item-check.active {
    opacity: 1;
}

/* 3. éšè—åŸæœ¬ HTML é‡Œå¯èƒ½æ®‹ç•™çš„ SVG (é¿å…é‡å½±) */
#subpage-timezone .item-check svg {
    display: none !important;
}
/* =========================================================
   ğŸš‘ ç»ˆæå¼ºåˆ¶ä¿®å¤ï¼šAPI é¡µé¢ (ç»å¯¹å®šä½ç‰ˆ - å«æ–‡å­—é—´è·ä¿®å¤)
   ========================================================= */

/* 1. é¡µé¢å®¹å™¨ï¼šé“ºæ»¡å…¨å±ï¼Œå‰ªè£æº¢å‡º */
#subpage-api {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 20 !important;
    padding-top: 0 !important; /* æ¸…é™¤æ‰€æœ‰å†…è¾¹è·å¹²æ‰° */
    display: block !important; /* âŒ å¼ƒç”¨ Flexï¼Œæ”¹ç”¨å—çº§ */
}

/* 2. å¤´éƒ¨ï¼šé’‰æ­»åœ¨é¡¶éƒ¨ (0px - 110px) */
#subpage-api .app-header {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important;
    height: 110px !important; /* å›ºå®šé«˜åº¦ */
    
    padding-top: 55px !important; /* é¿å¼€åˆ˜æµ· */
    padding-bottom: 10px !important;
    box-sizing: border-box !important;
    
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    z-index: 50 !important;
    
    display: flex !important;
    align-items: flex-end !important;
}

/* 3. å†…å®¹åŒºï¼šé’‰æ­»åœ¨å‰©ä½™ç©ºé—´ (110px - åº•éƒ¨) - æ ¸å¿ƒæ»šåŠ¨åŒº */
#subpage-api .app-body {
    position: absolute !important;
    top: 110px !important;  /* ğŸ‘‡ ç´§æ¥å¤´éƒ¨ä¸‹æ–¹ */
    bottom: 0 !important;   /* ğŸ‘‡ ä¸€ç›´åˆ°åº• */
    left: 0 !important; right: 0 !important;
    
    height: auto !important; /* âŒ ç¦æ­¢å›ºå®šé«˜åº¦ */
    width: 100% !important;
    
    overflow-y: auto !important; /* âœ… å¼€å¯æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch !important; /* ä¸æ»‘æ»šåŠ¨ */
    
    padding: 20px 16px 80px 16px !important; /* åº•éƒ¨ç•™ç™½ç»™æŒ‰é’® */
    box-sizing: border-box !important;
    
    display: block !important; /* åˆ—è¡¨é¡¹è‡ªç„¶å †å  */
}

/* 4. ã€æ ¸å¿ƒä¿®å¤ã€‘ç»™åˆ—è¡¨è¡ŒåŠ å¼ºåˆ¶å†…è¾¹è·ï¼Œè§£å†³æ–‡å­—è´´è¾¹é—®é¢˜ */
#subpage-api .ios-list-item {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    
    /* ğŸ‘‡ è¿™é‡Œï¼å¼ºåˆ¶å·¦å³ç•™å‡º 16px çš„å‘¼å¸ç©ºé—´ */
    padding-left: 16px !important; 
    padding-right: 16px !important; 
    
    box-sizing: border-box !important;
}

/* é’ˆå¯¹è¾“å…¥æ¡†è¡Œçš„ç‰¹æ®Šå¤„ç† */
#subpage-api .input-item {
    /* ç»§æ‰¿ä¸Šé¢çš„ paddingï¼Œä½†å¼ºåˆ¶å¯¹é½ */
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
}

#subpage-api .ios-input-clean {
    text-align: right !important; /* iOS é£æ ¼å³å¯¹é½ */
    width: 60% !important; /* å¼ºåˆ¶å å®½ */
    background: transparent !important;
    border: none !important;
    color: #007AFF !important;
    padding-right: 0 !important; /* è¾“å…¥æ¡†å†…éƒ¨ä¸ç”¨å†paddingäº†ï¼Œå› ä¸ºçˆ¶å…ƒç´ æœ‰äº† */
}

/* 5. ç¡®ä¿åˆ—è¡¨ç»„å®½åº¦æ­£å¸¸ */
#subpage-api .ios-list-group {
    width: 100% !important;
    margin: 0 0 20px 0 !important;
}

/* 6. ä¿®å¤åº•éƒ¨çº¢è‰²æŒ‰é’® */
#subpage-api .ios-btn {
    width: 100% !important;
    display: block !important;
    margin: 20px 0 40px 0 !important; /* åº•éƒ¨å¤šç•™ç‚¹ç©º */
}
/* =========================================================
   ğŸ’„ API é¡µé¢ï¼šç»†èŠ‚ç²¾ä¿®ä¸ä¸‹æ‹‰èœå•ç¾åŒ–
   ========================================================= */

/* 1. ä¿®å¤æ–‡å­—è´´è¾¹ (ç»™æ•´ä¸ªåˆ—è¡¨è¡ŒåŠ â€œå‘¼å¸ç©ºé—´â€) */
#subpage-api .ios-list-item {
    padding-right: 20px !important; /* å³è¾¹å¼ºåˆ¶ç•™å‡º 20px ç©ºéš™ */
    padding-left: 16px !important;
}

/* 2. ä¿®å¤è¾“å…¥æ¡† (å»é™¤è‡ªåŠ¨å¡«å……çš„è“è‰²èƒŒæ™¯ï¼Œå³å¯¹é½) */
#subpage-api .ios-input-clean {
    text-align: right !important;
    padding-right: 0 !important; /* è¾“å…¥æ¡†å†…éƒ¨ä¸ç”¨ç•™ç©ºï¼Œå› ä¸ºçˆ¶å…ƒç´ ç•™äº† */
    color: #007AFF !important;
    background: transparent !important;
    /* ğŸ‘‡ æš´åŠ›å»é™¤æµè§ˆå™¨è‡ªåŠ¨å¡«å……çš„åº•è‰² */
    box-shadow: 0 0 0px 1000px #fff inset !important; 
    -webkit-text-fill-color: #007AFF !important;
}

/* =========================================================
   ğŸ’„ ä¿®å¤ï¼šæ¨¡å‹é€‰æ‹©ä¸‹æ‹‰èœå• (å®Œç¾ä¼ªè£…æˆ iOS æŒ‰é’®)
   ========================================================= */

/* 1. åˆ—è¡¨é¡¹å®¹å™¨ï¼šè®¾ç½®ç›¸å¯¹å®šä½ï¼Œä¸ºäº†æ”¾ç®­å¤´ */
#subpage-api .ios-list-group .ios-list-item:has(select) {
    position: relative !important;
    overflow: hidden !important; /* é˜²æ­¢è¶…å‡º */
}

/* 2. æ ¸å¿ƒï¼šæŠŠ Select å½»åº•é€æ˜åŒ–ï¼Œåªä¿ç•™æ–‡å­— */
#subpage-api select.ios-input-clean {
    /* æŠ¹é™¤æµè§ˆå™¨æ‰€æœ‰é»˜è®¤æ ·å¼ */
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    
    /* èƒŒæ™¯é€æ˜ï¼Œæ— è¾¹æ¡† */
    background-color: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    
    /* å°ºå¯¸ä¸å¯¹é½ */
    width: 100% !important;
    height: 100% !important;
    
    /* ğŸ‘‡ å…³é”®ï¼šè®©æ–‡å­—å¼ºåˆ¶é å³ï¼Œå¹¶ä¸”ç•™å‡ºç®­å¤´çš„ä½ç½® */
    text-align: right !important;
    text-align-last: right !important; /* å…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ */
    direction: ltr !important; /* ä¿æŒä»å·¦åˆ°å³é˜…è¯»ï¼Œé˜²æ­¢æ–‡å­—åè½¬ */
    padding-right: 25px !important; /* å³è¾¹ç•™ç©ºç»™ç®­å¤´ */
    padding-left: 0 !important;
    
    /* å­—ä½“æ ·å¼ */
    color: #007AFF !important; /* iOS è“ */
    font-size: 16px !important;
    font-weight: 500 !important;
    font-family: inherit !important;
    
    /* å±‚çº§ */
    position: relative;
    z-index: 2; /* ä¿è¯èƒ½ç‚¹åˆ° */
    cursor: pointer;
}

/* 3. è‡ªå®šä¹‰ç®­å¤´ (ç”»ä¸€ä¸ªæ¼‚äº®çš„ç°è‰²å°ç®­å¤´) */
#subpage-api .ios-list-group .ios-list-item:has(select)::after {
    content: '' !important;
    position: absolute !important;
    right: 16px !important; /* è·ç¦»å³è¾¹ç¼˜ 16px */
    top: 50% !important;
    
    width: 7px !important;
    height: 7px !important;
    
    /* ç°è‰²çº¿æ¡ */
    border-top: 2px solid #C7C7CC !important;
    border-right: 2px solid #C7C7CC !important;
    
    /* æ—‹è½¬ 45 åº¦å˜æˆç®­å¤´ */
    transform: translateY(-50%) rotate(45deg) !important;
    pointer-events: none !important; /* è®©ç‚¹å‡»ç©¿é€è¿‡å» */
    z-index: 1 !important;
}

/* 4. ä¿®å¤ï¼šé˜²æ­¢é€‰ä¸­æ—¶å‡ºç°ä¸‘é™‹çš„è“è‰²èƒŒæ™¯/é»‘æ¡† */
#subpage-api select.ios-input-clean:focus {
    outline: none !important;
    background-color: transparent !important;
}
/* --- ğŸ’„ iOS åº•éƒ¨èœå• (Action Sheet) æ ·å¼ --- */
.ios-action-sheet {
    width: 96%; 
    max-width: 400px;
    margin-bottom: 12px; /* ç¦»åº•éƒ¨çš„è·ç¦» */
    display: flex; flex-direction: column;
    animation: slideUpSheet 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* æ ‡é¢˜åŒº */
.sheet-title-box {
    background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
    color: #8e8e93; font-size: 13px; font-weight: 600; text-align: center;
    padding: 14px; border-bottom: 0.5px solid rgba(0,0,0,0.1);
    border-radius: 14px 14px 0 0;
}

/* é€‰é¡¹æŒ‰é’® */
.sheet-item {
    background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
    padding: 18px; text-align: center; color: #007AFF; font-size: 17px;
    border-bottom: 0.5px solid rgba(0,0,0,0.1); cursor: pointer;
}
.sheet-item:active { background: rgba(255,255,255,0.5); }
.sheet-item:last-child { border-radius: 0 0 14px 14px; border-bottom: none; }

/* å–æ¶ˆæŒ‰é’® */
.sheet-cancel {
    margin-top: 8px; background: white; border-radius: 14px;
    padding: 16px; text-align: center; font-weight: 600; color: #007AFF; 
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/* =========================================================
   ğŸšï¸ æ»‘åŠ¨æ¡ç»ˆæç¾åŒ– (iOS åŸç”Ÿé£æ ¼)
   ========================================================= */

/* 1. æ»‘åŠ¨æ¡æœ¬ä½“ (è½¨é“) */
#subpage-api .ios-slider {
    -webkit-appearance: none !important; /* æ¸…é™¤é»˜è®¤ä¸‘æ ·å¼ */
    appearance: none !important;
    
    width: 100% !important;    /* ğŸ“ é•¿åº¦ï¼šå¼ºåˆ¶æ’‘æ»¡ï¼ */
    height: 4px !important;    /* é«˜åº¦ï¼šiOS æ ‡å‡†ç»†è½¨é“ */
    
    /* åŠ¨æ€èƒŒæ™¯ï¼šåˆ©ç”¨ CSS å˜é‡å®ç° å·¦è“å³ç° */
    background: linear-gradient(to right, #007AFF 0%, #007AFF var(--percent, 50%), #E5E5EA var(--percent, 50%), #E5E5EA 100%) !important;
    
    border-radius: 2px;
    outline: none;
    margin: 10px 0 0 0 !important; /* è°ƒæ•´é—´è· */
    display: block;
    padding: 0 !important;
    cursor: pointer;
}

/* 2. æ»‘å—å¤´ (é‚£ä¸ªç™½è‰²åœ†çƒ) */
#subpage-api .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    
    height: 28px !important; 
    width: 28px !important;    /* iOS æ ‡å‡†å¤§åœ†çƒ */
    border-radius: 50%;
    
    background: #FFFFFF !important; /* çº¯ç™½ */
    
    /* âœ¨ çµé­‚é˜´å½±ï¼šè®©å®ƒæµ®èµ·æ¥ */
    box-shadow: 0 3px 7px rgba(0,0,0,0.3), 0 0 0 0.5px rgba(0,0,0,0.05) !important;
    
    margin-top: -12px !important; /* å‚ç›´å±…ä¸­ä¿®æ­£: (4 - 28) / 2 = -12 */
    position: relative;
    z-index: 2;
    transition: transform 0.1s;
}

/* æŒ‰ä¸‹æ—¶ç¨å¾®å˜å¤§ */
#subpage-api .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.1);
}
/* =========================================================
   ğŸ’¬ èŠå¤©æµ‹è¯•åŒºç¾åŒ– (iMessage é£æ ¼)
   ========================================================= */

/* 1. èŠå¤©è®°å½•æ˜¾ç¤ºæ¡† */
.chat-log-area {
    background: #ffffff;
    border-radius: 12px;
    padding: 15px;
    height: 160px; /*ç¨å¾®åŠ é«˜ä¸€ç‚¹*/
    overflow-y: auto;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.03);
    -webkit-overflow-scrolling: touch;
    font-size: 14px;
}

/* 2. åº•éƒ¨è¾“å…¥æ å®¹å™¨ */
.chat-input-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

/* 3. è¾“å…¥æ¡† (ç°è‰²èƒ¶å›Š) */
.chat-input-field {
    flex: 1;
    height: 44px;
    background: #E5E5EA; /* iOS ç°è‰²åº• */
    border-radius: 22px; /* èƒ¶å›Šåœ†è§’ */
    border: none;
    padding: 0 18px;
    font-size: 16px;
    color: #000;
    outline: none;
    transition: background 0.2s;
    
    /* ä¿®å¤ä¹‹å‰çš„å¼ºåˆ¶å³å¯¹é½ï¼Œè¿™é‡Œéœ€è¦å·¦å¯¹é½ */
    text-align: left !important; 
    box-shadow: none !important;
}
.chat-input-field:focus {
    background: #D1D1D6; /* èšç„¦æ—¶ç¨å¾®å˜æ·± */
}

/* 4. å‘é€æŒ‰é’® (è“è‰²åœ†å½¢) */
.chat-send-btn {
    width: 44px; height: 44px;
    background: #007AFF;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0,122,255,0.3);
    transition: transform 0.1s;
}
.chat-send-btn:active {
    transform: scale(0.9);
}
/* =========================================================
   ğŸ¯ æ–‡å­—é¢œè‰²ç²¾å‡†é’©å­ (ä»…é’ˆå¯¹æ–‡æœ¬ï¼Œä¸å½±å“å¸ƒå±€)
   ========================================================= */

/* --- 1. æ¡Œé¢ä¸“å±é¢œè‰²é’©å­ --- */
/* çŠ¶æ€æ æ—¶é—´ã€ç™¾åˆ†æ¯”ã€ç”µé‡å›¾æ ‡ã€APPåã€å¤©æ°”æ–‡å­— */
.status-bar, 
.status-bar *, 
.app-name, 
.dock-bar .app-name,
.weather-content .w-day,
.weather-content .w-date,
.weather-content .w-temp,
.weather-content .w-city {
    color: var(--dynamic-desktop-color, #1d1d1f) !important;
    fill: var(--dynamic-desktop-color, #1d1d1f) !important;
}

/* --- 2. APP å†…éƒ¨ä¸“å±é¢œè‰²ä¸å­—ä½“é’©å­ --- */
/* è®¾ç½®åˆ—è¡¨ã€APIé…ç½®ã€èŠå¤©è®°å½•ã€è§’è‰²è¯¦æƒ… */
#settingsApp, 
#settingsApp .item-label, 
#settingsApp .item-value,
.chat-log-area,
.char-detail-view .char-name,
.char-detail-view .char-desc-preview {
    color: var(--dynamic-app-color, #1d1d1f) !important;
    /* åªæœ‰åœ¨è¿™äº›åœ°æ–¹æ‰åº”ç”¨åŠ¨æ€å­—ä½“å’Œå­—å· */
    font-family: var(--dynamic-font-family, inherit) !important;
    font-size: var(--dynamic-app-size, inherit) !important;
    font-weight: var(--dynamic-app-weight, inherit) !important;
}

/* --- 3. é¢„è§ˆåŒºç‹¬ç«‹æ ·å¼ (ç¡®ä¿é¢„è§ˆå’Œè®¾ç½®æ—¶ä¸€è‡´) --- */
#preview-text-main {
    color: var(--temp-app-color, #1d1d1f);
}
#preview-text-desktop {
    color: var(--temp-desktop-color, #1d1d1f);
}
/* è®©è°ƒè‰²ç›˜ input å˜åœ† */
.color-picker-circle {
    -webkit-appearance: none;
    appearance: none;
    border: none;
    width: 34px; height: 34px;
    border-radius: 50%;
    overflow: hidden;
    padding: 0;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 2px solid #fff;
    background: transparent;
}
.color-picker-circle::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker-circle::-webkit-color-swatch { border: none; border-radius: 50%; }
/* å¼ºè¡Œéš”ç¦»æ‰€æœ‰å­é¡µé¢ï¼Œç¡®ä¿å®ƒä»¬é»˜è®¤ä¸æ˜¾ç¤ºåœ¨æ¡Œé¢ä¸Š */
.ios-sub-page {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 100 !important;
    transform: translateX(100%); /* åˆå§‹çŠ¶æ€åœ¨å³è¾¹ */
    transition: transform 0.3s ease;
    display: flex !important; /* ä¿æŒå†…éƒ¨å¸ƒå±€ */
    flex-direction: column !important;
}

.ios-sub-page.active {
    transform: translateX(0) !important; /* æ¿€æ´»æ—¶æ»‘å…¥ */
}

/* ä¿æŠ¤æ¡Œé¢ç½‘æ ¼ä¸è¢«æ’‘å¤§ */
.main-container .app-name, .status-bar span {
    font-size: 11px !important;
    height: auto !important;
}
/* =========================================================
   ğŸ”¥ ç»ˆæé˜²å¾¡ï¼šå¼ºåˆ¶å­é¡µé¢æ»šåŠ¨ä¸å®Œæ•´æ¸²æŸ“
   ========================================================= */

/* 1. å­é¡µé¢å®¹å™¨ï¼šå¿…é¡»æ˜¯å›ºå®šé«˜åº¦ï¼Œä¸èƒ½æº¢å‡º */
#subpage-display {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 100 !important;
    display: flex !important;
    flex-direction: column !important; /* çºµå‘æ’åˆ—å¤´éƒ¨å’Œä¸»ä½“ */
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    padding: 0 !important;
    margin: 0 !important;
    box-sizing: border-box !important;
}

#subpage-display.active { transform: translateX(0) !important; }

/* 2. å¤´éƒ¨ï¼šé«˜åº¦å›ºå®š */
#subpage-display .app-header {
    flex-shrink: 0 !important; /* ç¦æ­¢è¢«å‹ç¼© */
    height: 110px !important;
    padding: 55px 16px 12px 16px !important;
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: flex-end !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. æ ¸å¿ƒï¼šå¼ºåˆ¶ä¸»ä½“åŒºåŸŸå æ®å‰©ä½™ç©ºé—´å¹¶å¼€å¯æ»šåŠ¨ */
#subpage-display .app-body {
    flex: 1 !important; /* å…³é”®ï¼šè‡ªåŠ¨å æ®å¤´éƒ¨ä»¥å¤–çš„æ‰€æœ‰é«˜åº¦ */
    overflow-y: auto !important; /* å…³é”®ï¼šå¼ºåˆ¶å¼€å¯æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch !important; /* ç§»åŠ¨ç«¯ä¸æ»‘ */
    padding: 20px 16px 120px 16px !important; /* åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«å°ç™½æ¡æŒ¡ä½ */
    display: block !important; /* æ¢å¤å—çº§æµï¼Œè®©åˆ—è¡¨æ­£å¸¸å †å  */
    box-sizing: border-box !important;
}

/* 4. ä¿®å¤åˆ—è¡¨é¡¹å¯¹é½ */
.color-item-row {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    min-height: 50px !important;
}
/* =========================================================
   ğŸšï¸ å­—ä½“é¡µæ»‘å—ï¼šç»ˆæç¾åŒ–ä¸å…¨å®½ä¿®å¤
   ========================================================= */

/* 1. å¼ºåˆ¶æ»‘å—è½¨é“æ’‘æ»¡ 100% å®½åº¦ */
#subpage-display .ios-slider {
    -webkit-appearance: none !important;
    appearance: none !important;
    width: 100% !important;   /* ğŸ‘ˆ è§£å†³ä½ è¯´çš„é•¿åº¦ä¸å¯¹ï¼Œå¿…é¡» 100% */
    height: 4px !important;    /* iOS ç»†è½¨é“ */
    border-radius: 2px !important;
    outline: none !important;
    margin: 15px 0 !important; /* ä¸Šä¸‹ç•™ç‚¹ç©ºï¼Œåˆ«æŒ¤ç€å­— */
    cursor: pointer !important;
    
    /* æ ¸å¿ƒï¼šåŠ¨æ€èƒŒæ™¯é€»è¾‘ */
    background: linear-gradient(to right, #007AFF 0%, #007AFF var(--percent, 50%), #E5E5EA var(--percent, 50%), #E5E5EA 100%) !important;
}

/* 2. é‚£ä¸ªç™½è‰²å¤§åœ†å¤´ */
#subpage-display .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    height: 28px !important; 
    width: 28px !important;
    background: #FFFFFF !important;
    border-radius: 50% !important;
    /* iOS çµé­‚é˜´å½± */
    box-shadow: 0 3px 8px rgba(0,0,0,0.2), 0 0 0 0.5px rgba(0,0,0,0.05) !important;
    cursor: pointer !important;
    margin-top: -12px !important; /* å±…ä¸­å¯¹é½è½¨é“ */
    transition: transform 0.1s !important;
}

#subpage-display .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.1) !important;
}

/* å…¼å®¹ Firefox */
#subpage-display .ios-slider::-moz-range-thumb {
    height: 28px; width: 28px; background: #fff; border-radius: 50%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2); border: none;
}
/* =========================================================
   ğŸš¨ ç»ˆæç‰©ç†ä¿®å¤ï¼šInstructions å¤´éƒ¨é‡å ä¸å­—ä½“åŒæ­¥
   ========================================================= */

/* 1. å¼ºåˆ¶é¡µé¢å®¹å™¨é«˜åº¦ä¸èƒŒæ™¯ */
#subpage-instructions {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important; /* é“ºæ»¡åº•è‰² */
    display: flex !important;
    flex-direction: column !important;
    z-index: 100 !important; /* ç¡®ä¿åœ¨æ¡Œé¢ä¹‹ä¸Š */
}

/* 2. å¤´éƒ¨ï¼šç‰©ç†é¡¶å¼€çŠ¶æ€æ  */
#subpage-instructions .app-header {
    flex-shrink: 0 !important;
    /* ğŸ‘‡ å…³é”®ï¼špadding-top å¿…é¡»è¶³å¤Ÿå¤§ï¼Œç‰©ç†é¿å¼€çŠ¶æ€æ  */
    padding: 60px 16px 12px 16px !important; 
    height: auto !important; /* è®© padding æ’‘å¼€é«˜åº¦ */
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. å­—ä½“åŒæ­¥é’©å­ */
#subpage-instructions .app-body {
    flex: 1 !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    padding: 20px 16px 100px 16px !important;
    
    /* ğŸ‘‡ æ ¸å¿ƒï¼šå¼ºåˆ¶åŒæ­¥ä½ è®¾ç½®çš„å­—ä½“å’Œé¢œè‰² */
    font-family: var(--dynamic-font-family, inherit) !important;
    color: var(--dynamic-app-color, #1d1d1f) !important;
}

/* 4. åˆ—è¡¨æ ‡ç­¾åŒæ­¥å­—å· */
#subpage-instructions .item-label {
    font-size: var(--dynamic-app-size, 17px) !important;
    font-weight: var(--dynamic-app-weight, 600) !important;
}

/* 5. ç¡®ä¿çŠ¶æ€æ æ°¸è¿œåœ¨æœ€æœ€æœ€é¡¶å±‚ */
.status-bar {
    z-index: 9999 !important;
}
/* =========================================================
   ğŸš¨ ç‰©ç†é”æ­»ï¼šInstructions é¡µé¢ (è§£å†³ç¼©æ°´ã€æ–­å±‚ã€é‡å )
   ========================================================= */

/* 1. å¼ºåˆ¶é¡µé¢å®¹å™¨é“ºæ»¡æ•´ä¸ªå±å¹•ï¼ŒèƒŒæ™¯å¿…é¡»è¿è´¯ */
#subpage-instructions {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important; /* æ ¸å¿ƒï¼šç¡®ä¿èƒŒæ™¯ä¸ç¢è£‚ */
    display: flex !important;
    flex-direction: column !important;
    z-index: 5000 !important; /* ä¿è¯åœ¨è®¾ç½®é¡µæœ€é¡¶å±‚ */
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
}

#subpage-instructions.active {
    transform: translateX(0) !important;
}

/* 2. å¤´éƒ¨ç¾åŒ–ï¼šå½»åº•é¿å¼€çŠ¶æ€æ ï¼Œæ¨ªå‘æ’‘æ»¡ */
#subpage-instructions .app-header {
    flex-shrink: 0 !important;
    width: 100% !important;
    padding: 60px 16px 12px 16px !important; /* 60px ç‰©ç†é¿å¼€çŠ¶æ€æ  */
    background: rgba(242, 242, 247, 0.9) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. æ»šåŠ¨ä¸»ä½“ï¼šå¼ºåˆ¶å æ® 100% å®½åº¦ï¼Œæ–‡å­—åŒæ­¥è®¾ç½® */
#subpage-instructions .app-body {
    flex: 1 !important;
    width: 100% !important; /* ğŸ‘ˆ è§£å†³ç¼©æ°´å…³é”® */
    overflow-y: auto !important;
    padding: 20px 16px 120px 16px !important;
    box-sizing: border-box !important;
    display: block !important; /* æ¢å¤åˆ—è¡¨å †å æµ */
    
    /* ğŸ”´ åŒæ­¥ä½ çš„å­—ä½“è®¾ç½®å˜é‡ */
    font-family: var(--dynamic-font-family, inherit) !important;
    color: var(--dynamic-app-color, #1d1d1f) !important;
}

/* 4. åˆ—è¡¨ç»„ç¾åŒ–ï¼šç¡®ä¿å®ƒä¸æ˜¯ä¸€ä¸ªå°æ–¹å— */
#subpage-instructions .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 12px !important;
    margin: 0 0 20px 0 !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
}

#subpage-instructions .ios-list-item {
    width: 100% !important;
    height: 64px !important;
    display: flex !important;
    align-items: center !important;
    padding-left: 16px !important;
    box-sizing: border-box !important;
}

/* 5. åˆ—è¡¨æ–‡å­—ï¼šå¼ºåˆ¶åŒæ­¥å­—å· */
#subpage-instructions .item-label {
    font-size: var(--dynamic-app-size, 17px) !important;
    font-weight: var(--dynamic-app-weight, 600) !important;
    margin-left: 14px !important;
}

/* 6. çŠ¶æ€æ å±‚çº§ä¿æŠ¤ */
.status-bar {
    z-index: 9999 !important;
    pointer-events: none !important; /* è®©ç‚¹å‡»ç©¿é€åˆ°ä¸‹é¢çš„ Back æŒ‰é’® */
}
/* =========================================================
   ğŸš¨ æ—¶åŒºé¡µä¸“åœºä¿®å¤ï¼šè§£å†³å®½åº¦ç¼©æ°´ã€èƒŒæ™¯æ–­å±‚ã€å›½å®¶æ¶ˆå¤±
   ========================================================= */

/* 1. å¼ºåŠ›é”æ­»å­é¡µé¢å®¹å™¨ï¼Œç¡®ä¿ 100% å®½åº¦ */
#subpage-timezone {
    width: 100% !important;
    max-width: none !important;
    left: 0 !important;
    padding: 0 !important;
}

/* 2. å¼ºåŠ›ä¿®å¤ app-body å¸ƒå±€ */
#subpage-timezone .app-body {
    display: block !important; /* âŒ ç¦æ­¢ Flexï¼Œé˜²æ­¢å†…å®¹è¢«æ¨ªå‘æŒ¤å‹ */
    width: 100% !important;
    height: auto !important;
    min-height: 100% !important;
    padding: 20px 16px 120px 16px !important; /* ç•™å‡ºè¶³å¤Ÿçš„åº•éƒ¨ç©ºé—´ */
    background: #F2F2F7 !important; /* å¼ºåˆ¶èƒŒæ™¯è‰²é“ºæ»¡ */
    box-sizing: border-box !important;
}

/* 3. å¼ºåŠ›ä¿®å¤åˆ—è¡¨ç»„å®½åº¦ */
#subpage-timezone .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 12px !important;
    margin-bottom: 25px !important;
    display: block !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
}

/* 4. ä¿®å¤æœç´¢æ¡†å®½åº¦ */
.ios-search-wrapper {
    width: 100% !important;
}

/* 5. ä¿®å¤å›½å®¶é¡¹æ¸²æŸ“é«˜åº¦ */
#subpage-timezone .ios-list-item {
    width: 100% !important;
    min-height: 48px !important;
    display: flex !important;
    align-items: center !important;
    padding: 0 16px !important;
}
/* =========================================================
   ğŸš¨ å¤´éƒ¨ç»ˆæé¿è®©è¡¥ä¸ (è§£å†³ 17:43 é‡å é—®é¢˜)
   ========================================================= */

/* 1. ç»Ÿä¸€æ‰€æœ‰å­é¡µé¢çš„å®¹å™¨èƒŒæ™¯å’Œå±‚çº§ */
.ios-sub-page {
    background: #F2F2F7 !important;
    z-index: 5000 !important;
}

/* 2. å¼ºåŠ›é¡¶å¼€å¤´éƒ¨ï¼šå°†é—´è·ä» 60px å¢åŠ åˆ° 80pxï¼Œå¹¶åŠ æ·±èƒŒæ™¯ */
.ios-sub-page .app-header {
    height: auto !important;
    min-height: 100px !important; /* å¼ºåˆ¶ä¿åº•é«˜åº¦ */
    /* ğŸ‘‡ å…³é”®ï¼š80px ç‰©ç†é¡¶å¼€ï¼Œç»å¯¹ä¸ä¼šå†ç¢°åˆ° 17:43 */
    padding: 80px 16px 15px 16px !important; 
    background: rgba(242, 242, 247, 0.98) !important; /* å‡ ä¹ä¸é€æ˜ï¼Œå®Œå…¨æŒ¡ä½åé¢å†…å®¹ */
    backdrop-filter: blur(25px) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
}

/* 3. ä¿®æ­£ Back æŒ‰é’®å¯¹é½ */
.ios-sub-page .header-left-btn, 
.ios-sub-page .app-header div[onclick*="closeSubPage"] {
    display: flex !important;
    align-items: center !important;
    line-height: 1 !important;
}

/* 4. çŠ¶æ€æ å±‚çº§ä¿æŠ¤ï¼šè®©çŠ¶æ€æ æ–‡å­—æ°¸è¿œåœ¨æœ€å‰ï¼Œä½†èƒŒæ™¯é€æ˜ */
.status-bar {
    z-index: 9999 !important;
    background: transparent !important;
    pointer-events: none !important; /* ç¡®ä¿èƒ½ç‚¹åˆ°ä¸‹é¢çš„ Back æŒ‰é’® */
}
/* --- è¯´æ˜ä¹¦å›¾æ ‡ï¼šåŒæ­¥æ¡Œé¢ App æ ·å¼ --- */
.ins-app-icon-sync {
    width: 60px !important;  /* åŒæ­¥æ¡Œé¢å°ºå¯¸ */
    height: 60px !important;
    border-radius: 16px !important; /* åŒæ­¥æ¡Œé¢åœ†è§’ */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    /* æ ¸å¿ƒé˜´å½±ï¼šå¢åŠ ç«‹ä½“ç»ç’ƒæ„Ÿ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 1px rgba(255,255,255,0.8) !important;
    position: relative;
    overflow: hidden;
}

/* ç»Ÿä¸€åˆ—è¡¨è¡Œçš„é«˜åº¦ï¼Œé€‚åº”æ›´å¤§çš„å›¾æ ‡ */
#subpage-instructions .ios-list-item {
    height: 85px !important; 
    padding: 0 16px !important;
}

/* è°ƒæ•´æ–‡å­—é—´è· */
#subpage-instructions .item-label {
    margin-left: 18px !important;
    font-size: 18px !important;
    font-weight: 700 !important;
}
/* --- Ins é£æ ¼é«˜çº§å¡ç‰‡ --- */
.ins-fancy-card {
    width: 85%;
    max-width: 340px;
    /* --- ä¿®æ”¹è¿™é‡Œ --- */
    max-height: 80vh !important; /* é™åˆ¶æ•´ä¸ªå¡ç‰‡æœ€é«˜åªå å±å¹•çš„ 80% */
    display: flex !important;    /* å¿…é¡»å¼€å¯ flexï¼Œå¦åˆ™å†…éƒ¨æ— æ³•æ­£ç¡®æ’‘å¼€æ»šåŠ¨ */
    flex-direction: column !important;
    /* ---------------- */
    background: #ffffff;
    border-radius: 32px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.12);
    overflow: hidden;
    animation: insPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
}

@keyframes insPop {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* é¡¶éƒ¨ç‚¹ç‚¹ä¸æ ‡ç­¾ */
.ins-card-nav {
    padding: 20px 24px 10px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.ins-close-dot {
    width: 12px; height: 12px;
    background: #FF5F57; border-radius: 50%; cursor: pointer;
}
.ins-brand-tag {
    font-size: 10px; letter-spacing: 2px; font-weight: 800; color: #d1d1d6;
}

/* æ¸å˜è£…é¥°å¤´å›¾ */
.ins-card-hero {
    height: 120px; position: relative; margin: 0 24px;
    border-radius: 20px; overflow: hidden;
}
.ins-hero-bg { width: 100%; height: 100%; opacity: 0.8; }
.ins-hero-icon {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
}

/* æ–‡å­—æ’ç‰ˆ */
.ins-card-body { padding: 24px; text-align: center; }
.ins-title-serif {
    font-family: "Times New Roman", Times, serif; /* ç»å…¸çš„è¡¬çº¿ä½“æå‡è´¨æ„Ÿ */
    font-size: 26px; font-weight: 500; color: #1d1d1f; margin-bottom: 4px;
}
.ins-subtitle {
    font-size: 12px; color: #86868b; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 20px;
}
.ins-divider-line {
    width: 40px; height: 1px; background: #eee; margin: 0 auto 20px auto;
}

/* åŠŸèƒ½é¡¹ */
.ins-feature-list { text-align: left; margin-bottom: 30px; }
.ins-feat-item { display: flex; gap: 15px; margin-bottom: 18px; align-items: flex-start; }
.feat-num {
    font-family: serif; font-style: italic; color: #d1d1d6; font-size: 18px;
}
.feat-text strong { display: block; font-size: 14px; color: #1d1d1f; margin-bottom: 2px; }
.feat-text p { font-size: 12px; color: #86868b; line-height: 1.4; }

/* åº•éƒ¨æŒ‰é’® */
.ins-done-btn {
    width: 100%; padding: 16px; border: none; background: #1d1d1f; color: #fff;
    border-radius: 16px; font-size: 12px; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; transition: 0.2s;
}
.ins-done-btn:active { transform: scale(0.96); opacity: 0.8; }
/* ç¡®ä¿å¡ç‰‡å†…å®¹è¾ƒå¤šæ—¶å¯ä»¥å†…éƒ¨æ»šåŠ¨ï¼Œä½†ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ */
.ins-card-body {
    max-height: 450px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
    overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none;
}
.ins-card-body::-webkit-scrollbar {
    display: none;
}

/* å¢åŠ åºå·çš„é—´è·æ„Ÿ */
.feat-num {
    min-width: 24px; /* é˜²æ­¢åŒä½æ•°åºå·å¯¼è‡´é”™ä½ */
}
/* --- é’ˆå¯¹ç²¾ç»†åŒ–å†…å®¹çš„æ’ç‰ˆå¢å¼º --- */
#ins-character-modal .ins-feat-item {
    margin-bottom: 24px !important; /* å¢åŠ é—´è· */
    border-left: 1px solid #f2f2f7; /* åŠ ä¸€æ¡ç»†çº¿å¢åŠ è®¾è®¡æ„Ÿ */
    padding-left: 15px;
}

#ins-character-modal .feat-text p {
    font-size: 13px !important; /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹æ–¹ä¾¿é˜…è¯» */
    line-height: 1.6 !important; /* å¢åŠ è¡Œé«˜ï¼Œè®©é•¿æ®µè½æ›´é€æ°” */
    margin-top: 5px;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½ï¼ŒInsé£ç²¾é«“ */
}

#ins-character-modal .ins-fancy-card {
    max-height: 85vh !important; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢ç”±äºå†…å®¹å¤ªå¤šå†²å‡ºå±å¹• */
    display: flex;
    flex-direction: column;
}

#ins-character-modal .ins-card-body {
    flex: 1;
    overflow-y: auto !important; /* å…è®¸å†…éƒ¨æ»šåŠ¨ */
    padding: 30px 24px !important;
}
/* é’ˆå¯¹å£çº¸è¯´æ˜é¡µçš„ç»†èŠ‚å¼ºåŒ– */
#ins-wallpaper-modal .ins-feat-item {
    margin-bottom: 24px !important;
    border-left: 1px solid #FF9A9E; /* ä¾§è¾¹çº¿ä½¿ç”¨å£çº¸æ¨¡å—çš„ç²‰è‰²ç³» */
    padding-left: 15px;
    transition: all 0.3s ease;
}

#ins-wallpaper-modal .ins-feat-item:hover {
    background: rgba(255, 154, 158, 0.05); /* é¼ æ ‡ç»è¿‡æ—¶æœ‰æ·¡æ·¡çš„å‘¼å¸æ„Ÿ */
    border-left-width: 3px;
}

#ins-wallpaper-modal .feat-text p {
    font-size: 13px;
    line-height: 1.6;
    color: #666;
    margin-top: 5px;
}

#ins-wallpaper-modal .ins-card-body {
    max-height: 50vh;
    overflow-y: auto;
    padding: 30px 24px !important;
}
/* é’ˆå¯¹è®¾ç½®è¯´æ˜é¡µï¼šå»æ‰å¤šä½™è£…é¥°ï¼Œä¿æŒå†…å®¹æ¸…æ™° */
#ins-settings-modal .ins-feat-item {
    margin-bottom: 22px !important;
    border-left: 1.5px solid #d1d1d6; /* ç°/é“¶è‰²ç³»ä¾§çº¿ */
    padding-left: 15px;
}

#ins-settings-modal .feat-text p {
    font-size: 13px !important;
    line-height: 1.5 !important;
    color: #444 !important;
    margin-top: 4px;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½æ›´é«˜çº§ */
}

/* ç‰©ç†é™åˆ¶é«˜åº¦ï¼Œå¤šå‡ºå†…å®¹å¿…é¡»æ»‘åŠ¨ */
#ins-settings-modal .ins-fancy-card {
    max-height: 80vh !important;
    display: flex !important;
    flex-direction: column !important;
}

#ins-settings-modal .ins-card-body {
    flex: 1 !important;
    overflow-y: auto !important;
    padding: 25px 24px !important;
}
/* --- ğŸ  æ»‘åŠ¨ç³»ç»Ÿæ ·å¼ --- */
.home-screen-scroll-container {
    flex: 1;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory; /* æ ¸å¿ƒï¼šå¼€å¯å¸é™„ */
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
    display: block; /* è¦†ç›–é»˜è®¤å¸ƒå±€ */
}
.home-screen-scroll-container::-webkit-scrollbar {
    display: none; /* å½»åº•éšè—æ»šåŠ¨æ¡ */
}

.home-screen-wrapper {
    display: flex;
    width: 200%; /* å› ä¸ºä¸¤é¡µï¼Œæ‰€ä»¥æ˜¯ 200% */
    height: 100%;
}

/* æ¯ä¸€é¡µéƒ½å¿…é¡»å›ºå®š 100% å±å¹•å®½ */
.main-container {
    width: 100vw !important;
    height: 100%;
    flex-shrink: 0;
    scroll-snap-align: start; /* å¸é™„ç‚¹ */
    padding: 10px 22px 20px 22px !important;
    /* ä¿æŒä½ åŸæœ¬çš„ç½‘æ ¼å¸ƒå±€ */
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: 2.3fr 1fr 0.7fr 1.1fr 1.1fr;
    gap: 16px;
    align-items: center;
}
/* --- ç¬¬ä¸€ã€äºŒè¡Œï¼šå°é¢ç»„ä»¶æ ·å¼ --- */
.hero-cover-widget {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 28px;
    overflow: hidden;
    background: #f2f2f7;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.3s ease;
}

.hero-cover-widget:active {
    transform: scale(0.98);
}

.hero-image-wrapper {
    width: 100%;
    height: 100%;
}

.hero-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* æ¸å˜é®ç½©ï¼šç¡®ä¿æ–‡å­—åœ¨ä»»ä½•å›¾ç‰‡ä¸‹éƒ½æ¸…æ™° */
.hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 20%, rgba(0,0,0,0.4) 100%);
}

.hero-content-text {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.hero-tag {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    opacity: 0.9;
}

.hero-content-text h2 {
    margin: 5px 0;
    font-size: 24px;
    font-weight: 700;
    font-family: serif; /* è¡¬çº¿ä½“æå‡é«˜çº§æ„Ÿ */
}

.hero-content-text p {
    font-size: 13px;
    font-style: italic;
    opacity: 0.8;
    margin: 0;
}

.hero-edit-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: 0.3s;
}

.hero-cover-widget:hover .hero-edit-icon {
    opacity: 1;
}
/* é®ç½©å±‚ï¼šå…¨å±åŠé€æ˜ */
.ios-alert-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px); /* èƒŒæ™¯æ¨¡ç³Š */
    display: none; /* åˆå§‹éšè— */
    justify-content: center;
    align-items: flex-end; /* é åº•éƒ¨å¯¹é½ */
    z-index: 9999;
}

/* æŠ½å±‰æ¿ï¼šç™½è‰²åœ†è§’çŸ©å½¢ */
.p2-editor-sheet {
    width: 100%;
    max-width: 500px; /* é™åˆ¶å¤§å±ä¸‹çš„å®½åº¦ */
    background: #ffffff;
    border-top-left-radius: 30px;
    border-top-right-radius: 30px;
    padding: 24px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
    animation: sheetUp 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

@keyframes sheetUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* å¤´éƒ¨å¸ƒå±€ */
.p2-editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}
#p2-editor-title { font-size: 18px; font-weight: 700; color: #1d1d1f; }
.p2-done-btn { color: #007AFF; font-weight: 700; cursor: pointer; font-size: 16px; }

/* è‡ªå®šä¹‰è¾“å…¥æ¡† */
.p2-main-input {
    width: 100%;
    border: none;
    background: #f2f2f7;
    padding: 16px;
    border-radius: 14px;
    font-size: 15px;
    outline: none;
    margin-bottom: 20px;
    box-sizing: border-box;
}

/* éšè—åŸå§‹ä¸‘é™‹çš„ä¸Šä¼ æŒ‰é’®ï¼Œæ”¹ç”¨è‡ªå®šä¹‰æ ‡ç­¾ */
.custom-upload-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    background: #1d1d1f; /* é»‘è‰²æŒ‰é’®æ›´æœ‰ Ins æ„Ÿ */
    color: #fff;
    border-radius: 14px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
}
.custom-upload-btn:active { opacity: 0.8; }
/* --- Row 3 & 4: æ‹ç«‹å¾—å¿ƒæƒ…çœ‹æ¿æ ·å¼ --- */
.moment-card-widget {
    background: #ffffff;
    border-radius: 24px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s ease;
}

.moment-card-widget:active { transform: scale(0.98); }

.moment-photo-area {
    width: 100%;
    aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    background: #f8f8f8;
}

.moment-photo-area img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.moment-edit-hint {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.2);
    color: #fff; font-size: 10px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: 0.3s;
}
.moment-photo-area:hover .moment-edit-hint { opacity: 1; }

.moment-text-area {
    padding: 12px 4px 4px 4px;
    text-align: left;
}

.moment-text-area h3 {
    font-size: 14px; font-weight: 800; color: #1d1d1f;
    margin: 0; letter-spacing: 0.5px;
}

.moment-text-area p {
    font-size: 11px; color: #86868b;
    margin: 4px 0 0 0;
    font-family: "Times New Roman", serif;
    font-style: italic;
    /* é™åˆ¶æ˜¾ç¤ºä¸¤è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* --- è‡ªå®šä¹‰ App è´´çº¸å¢å¼º --- */
.custom-pic-app .pic-app-wrapper {
    width: 60px; height: 60px; /* ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ */
    border-radius: 18px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}
.pic-app-wrapper img { width: 100%; height: 100%; object-fit: cover; }

.pic-app-edit {
    position: absolute; top: 0; right: 0;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
    width: 18px; height: 18px; border-bottom-left-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    color: #fff; opacity: 0; transition: 0.3s;
}
.pic-app-wrapper:hover .pic-app-edit { opacity: 1; }
/* Row 5: æ°›å›´æ¡æ ·å¼ */
.vibe-bar-widget {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    height: 100%;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0,0,0,0.05);
}
.vibe-bg-wrapper { width: 100%; height: 100%; }
.vibe-bg-wrapper img { width: 100%; height: 100%; object-fit: cover; }
.vibe-overlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.2);
    display: flex; align-items: center; justify-content: center;
}
#hub-vibe-text {
    position: absolute;
    width: 100%; text-align: center; top: 50%; transform: translateY(-50%);
    color: #fff; font-size: 13px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase; text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
/* 1. å¼ºåˆ¶çˆ¶å®¹å™¨åœ¨é¡¶éƒ¨ä¸ç•™ç™½ï¼ˆå¯é€‰ï¼Œå¦‚æœä½ å¸Œæœ›å›¾ç‰‡ç›´æ¥è´´åˆ°å±å¹•é¡¶ç«¯ï¼‰ */
#page-2 {
    padding: 0 16px 20px 16px !important; /* å·¦å³ä¿ç•™è¾¹è·ï¼Œä½†é¡¶éƒ¨è®¾ä¸º0 */
    gap: 12px !important; /* ç¼©å°ç»„ä»¶é—´çš„é—´è· */
}

/* --- 1. å¤§ç»„ä»¶ï¼šç¬¬ä¸€ã€äºŒè¡Œ(Hero) å’Œ ç¬¬äº”è¡Œ(Vibe Bar) å½»åº•é“ºæ»¡ --- */
.hero-cover-widget,
.vibe-bar-widget {
    padding: 0 !important;   /* å½»åº•ç§»é™¤å†…è¾¹è· */
    margin: 0 !important;    /* ç§»é™¤å¤–è¾¹è· */
    width: 100%;
    height: 100%;
    overflow: hidden;
    border-radius: 24px;     /* ç»Ÿä¸€åœ†è§’ */
    display: block;
}

/* ç¡®ä¿è¿™ä¸¤è€…çš„èƒŒæ™¯å›¾å®Œå…¨è¦†ç›– */
.hero-image-wrapper img,
.vibe-bg-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;       /* æ ¸å¿ƒï¼šä¸ç•™ç™½ã€ä¸ç¼©æ”¾ã€è‡ªåŠ¨è£å‰ª */
    display: block;
}

/* --- 2. å°å›¾æ ‡ï¼šä¿®å¤ç¬¬ä¸‰ã€å››ã€å…­è¡Œ App å›¾æ ‡è¢«æ’‘å¤§çš„é—®é¢˜ --- */
.custom-pic-app {
    display: flex;
    flex-direction: column;
    align-items: center;     /* ç¡®ä¿å›¾æ ‡åœ¨æ ¼å­é‡Œå±…ä¸­ */
    justify-content: center;
}

.custom-pic-app .pic-app-wrapper {
    /* æ ¸å¿ƒä¿®å¤ï¼šç»™å›¾æ ‡ä¸€ä¸ªå›ºå®šçš„å°ºå¯¸ï¼Œä¸è¦ 100% */
    width: 60px;             /* æ ¹æ®ä½ çš„å–œå¥½è°ƒæ•´ï¼Œæ¯”å¦‚ 60px æˆ– 64px */
    height: 60px;
    padding: 0 !important;   /* å†…éƒ¨å›¾ç‰‡é“ºæ»¡ï¼Œä¸ç•™ç™½è¾¹ */
    border-radius: 15px;     /* å›¾æ ‡åœ†è§’ç¨å°ä¸€ç‚¹æ›´ç²¾è‡´ */
    overflow: hidden;
    background: #eee;        /* å…œåº•èƒŒæ™¯è‰² */
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* ç¡®ä¿ App å›¾æ ‡é‡Œçš„å›¾ç‰‡ä¹Ÿæ˜¯é“ºæ»¡çš„ */
.pic-app-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* --- 3. ä¿®æ­£ Grid å®¹å™¨çš„é—´éš™ --- */
#page-2 {
    gap: 16px;              /* ç»Ÿä¸€ç»„ä»¶ä¹‹é—´çš„é—´è· */
    padding: 20px;          /* é¡µé¢å››å‘¨çš„ç•™ç™½ */
    align-content: start;
}
/* --- Vibe Grid æ¸¸æˆæ ·å¼ --- */
.game-board-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.vibe-board {
    display: grid;
    grid-template-columns: repeat(10, 1fr); /* 10x10 æ£‹ç›˜æ›´é€‚åˆæ‰‹æœº */
    grid-template-rows: repeat(10, 1fr);
    gap: 2px;
    background: rgba(255, 255, 255, 0.2);
    padding: 2px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    width: 100%;
    aspect-ratio: 1 / 1;
}

.vibe-cell {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: pointer;
}

/* æ£‹å­ï¼šå…±é¸£ (è“è‰²ç³») */
.piece-resonance {
    width: 80%; height: 80%;
    border-radius: 50%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    box-shadow: 0 0 15px rgba(79, 172, 254, 0.8);
    animation: piecePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* æ£‹å­ï¼šåå™¬ (çº¢è‰²ç³») */
.piece-devour {
    width: 80%; height: 80%;
    border-radius: 50%;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    box-shadow: 0 0 15px rgba(245, 87, 108, 0.8);
    animation: piecePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes piecePop {
    from { transform: scale(0) rotate(-45deg); opacity: 0; }
    to { transform: scale(1) rotate(0); opacity: 1; }
}

.game-footer-info {
    padding: 20px;
    display: flex;
    justify-content: space-around;
    background: rgba(0,0,0,0.05);
}

.vibe-tag-preview {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 1px;
    padding: 8px 15px;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.1);
}

.vibe-tag-preview.p1 { color: #4facfe; border-color: #4facfe; }
.vibe-tag-preview.p2 { color: #f5576c; border-color: #f5576c; }

/* èƒœåˆ©é—ªçƒæ•ˆ */
.win-flash {
    animation: winGlow 1s infinite alternate;
}
@keyframes winGlow {
    from { filter: brightness(1); }
    to { filter: brightness(1.5) drop-shadow(0 0 20px white); }
}
/* --- ğŸš‘ æ¸¸æˆ App ç»ˆææ˜¾ç¤ºè¡¥ä¸ --- */
#vibe-grid-app {
    z-index: 6000 !important; /* å¿…é¡»é«˜äº 5000ï¼Œæ‰èƒ½ç›–ä½è®¾ç½®é¡µ */
    transform: translateY(100%); /* é»˜è®¤åœ¨ä¸‹é¢ */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s !important;
    opacity: 0;
    display: none; /* åˆå§‹éšè— */
}

/* å½“ App æ¿€æ´»æ—¶çš„çŠ¶æ€ */
#vibe-grid-app.active {
    display: flex !important;
    transform: translateY(0) !important;
    opacity: 1 !important;
}

/* è¡¥å…¨æ¶ˆå¤±çš„åŠ¨ç”»å®šä¹‰ */
@keyframes appOpen {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* å¼ºåˆ¶ç»™æ£‹æ ¼ä¸€ä¸ªæœ€å°å°ºå¯¸ï¼Œé˜²æ­¢å®ƒä»¬ç¼©æˆä¸€å›¢ */
.vibe-cell {
    min-width: 30px;
    min-height: 30px;
}
/* --- ğŸš‘ å¼ºåˆ¶ Vibe Grid è§†è§‰å¯¹é½è¡¥ä¸ --- */
#vibe-grid-app {
    position: fixed !important; /* å¿…é¡»æ˜¯å›ºå®šå®šä½ */
    top: 0 !important; 
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important; /* åŒæ­¥è®¾ç½® App çš„ iOS èƒŒæ™¯è‰² */
    z-index: 6000 !important; /* å¿…é¡»é«˜äºæ¡Œé¢ï¼Œç¡®ä¿ç»å¯¹è¦†ç›– */
    display: none; /* åˆå§‹éšè— */
    flex-direction: column;
    transform: translateY(100%); /* é»˜è®¤è—åœ¨å±å¹•ä¸‹æ–¹ */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s !important;
}

/* æ¿€æ´»æ€ï¼šä»ä¸‹æ–¹æ»‘å…¥ */
#vibe-grid-app.active {
    display: flex !important;
    transform: translateY(0) !important;
}

/* æ£‹ç›˜æ ¼å­ç¾åŒ– */
.vibe-board {
    background: #fff !important; /* æ£‹ç›˜ç”¨çº¯ç™½èƒŒæ™¯ï¼Œæ›´æœ‰ App è´¨æ„Ÿ */
    border-radius: 20px !important;
    padding: 10px !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05) !important;
    border: none !important;
}

.vibe-cell {
    background: #f2f2f7 !important; /* æ ¼å­åº•è‰²ç¨å¾®æ·±ä¸€ç‚¹ */
    border-radius: 6px !important;
}

/* ä¿®å¤åº•éƒ¨æ ‡ç­¾æ ·å¼ */
.game-footer-info {
    display: flex;
    justify-content: center;
    gap: 15px;
    background: transparent !important;
}
/* --- ğŸš‘ å¼¹çª—å±…ä¸­ä¸ UI é™å™ªè¡¥ä¸ --- */

/* 1. å¼ºåˆ¶å±…ä¸­é®ç½©ï¼šè§£å†³å¼¹çª—åœ¨åº•éƒ¨çš„é—®é¢˜ */
.vibe-center-mask {
    position: fixed; inset: 0;
    display: flex; align-items: center; /* å‚ç›´å±…ä¸­ */
    justify-content: center; /* æ°´å¹³å±…ä¸­ */
    background: rgba(0, 0, 0, 0.4); /* åŠ æ·±é®ç½©ï¼Œçªå‡ºé‡ç‚¹ */
    backdrop-filter: blur(10px); /* ç£¨ç ‚æ„Ÿ */
    z-index: 9000;
}

/* 2. ç§»é™¤å†—ä½™è¾¹è·ï¼Œè§£å†³ç©ºç™½è¿‡å¤šçš„è§†è§‰æ„Ÿ */
#vibe-game-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center; /* è®©å†…å®¹åœ¨å‚ç›´æ–¹å‘ä¹Ÿå±…ä¸­ */
    width: 100%;
    padding-bottom: 60px; /* ç»™åº•éƒ¨æ ç•™ç©ºé—´ */
}

/* 3. æ£‹ç›˜å®¹å™¨é«˜çº§åŒ– */
.vibe-board-wrapper {
    background: #fff;
    padding: 15px;
    border-radius: 32px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255,255,255,1);
    transform: scale(0.95); /* ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œå¢åŠ ç²¾è‡´æ„Ÿ */
}

/* 4. å½»åº•å»æ‰æŒ‰é’®é‡å  */
#vibe-guide-btn {
    position: static !important; /* åˆ«å†æ‚¬æµ®äº† */
    margin: 10px auto;
    padding: 6px 16px;
    background: rgba(0, 122, 255, 0.08);
    border-radius: 12px;
    width: fit-content;
}
/* --- ğŸ¨ AI è¯è¯­æ‚¬æµ®åŠ¨ç”» --- */
.floating-vibe-word {
    position: absolute;
    pointer-events: none;
    z-index: 10000;
    color: #1d1d1f;
    font-family: "Times New Roman", serif;
    font-style: italic;
    font-weight: 600;
    font-size: 18px;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(255,255,255,1), 0 0 10px rgba(0,122,255,0.2);
    animation: vibeRise 2.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
}

@keyframes vibeRise {
    0% { transform: translateY(10px); opacity: 0; filter: blur(5px); }
    20% { transform: translateY(0); opacity: 1; filter: blur(0); }
    80% { transform: translateY(-30px); opacity: 0.8; filter: blur(0); }
    100% { transform: translateY(-50px); opacity: 0; filter: blur(10px); }
}
/* --- ğŸ’ æ¶²æ€ç»ç’ƒçº¿æ¡å›¾æ ‡é£æ ¼ (Liquid Glass & Line Art) --- */

/* --- ğŸ’ ç²¾è‡´ç‰ˆæ¶²æ€ç»ç’ƒå›¾æ ‡å°ºå¯¸è¡¥ä¸ --- */
.glass-icon-bg {
    width: 60px !important;   /* é”å®šå®½åº¦ï¼ŒåŒæ­¥ç³»ç»Ÿæ ‡å‡† */
    height: 60px !important;  /* é”å®šé«˜åº¦ */
    
    /* ä¿æŒåŸæœ‰çš„é«˜çº§è´¨æ„Ÿ */
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.15));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    border-radius: 16px; /* ç¨å¾®å‡å°åœ†è§’ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´ç¡¬æœ—ç²¾è‡´ */
    
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* ç¡®ä¿åœ¨æ ¼å­é‡Œæ°´å¹³å±…ä¸­ */
    transition: transform 0.2s cubic-bezier(0.33, 1, 0.68, 1);
}

/* è°ƒæ•´å†…éƒ¨çº¿æ¡å›¾æ ‡çš„æ¯”ä¾‹ï¼Œè®©å®ƒçœ‹èµ·æ¥ä¸æ‹¥æŒ¤ */
.glass-icon-svg {
    width: 28px; /* é€‚å½“ç¼©å°çº¿æ¡å›¾æ¡ˆï¼Œç•™å‡ºå‘¼å¸æ„Ÿ */
    height: 28px;
    fill: none;
    stroke: #1d1d1f;
    stroke-width: 1.8; /* ç¨å¾®åŠ ç²—ä¸€ç‚¹çº¿æ¡ï¼Œå¢å¼ºè¯†åˆ«åº¦ */
    stroke-linecap: round;
    stroke-linejoin: round;
}
/* --- ğŸ›ï¸ ä¸–ç•Œä¹¦ï¼šæç®€æ¡£æ¡ˆé£æ ¼ --- */

/* 1. åˆ—è¡¨ä¸­çš„å¡ç‰‡ */
.world-card-item {
    background: #fff;
    border-radius: 18px;
    padding: 20px;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    cursor: pointer;
    transition: all 0.2s ease;
}
.world-card-item:active { transform: scale(0.96); background: #fafafa; }
.world-card-item .name { font-size: 18px; font-weight: 800; color: #1d1d1f; }
.world-card-item .hint { font-size: 11px; color: #bbb; margin-top: 8px; font-weight: 600; letter-spacing: 1px; }

/* 2. å±•ç¤ºç”¨çš„ä¸­å¿ƒå¡ç‰‡ */
.world-minimal-card {
    width: 85%; max-width: 320px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 32px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
@keyframes worldPopCenter { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }

.world-minimal-card h1 { font-size: 22px; font-weight: 800; color: #000; margin-bottom: 15px; }
.world-line-decor { width: 30px; height: 3px; background: #007AFF; margin: 0 auto 20px auto; border-radius: 2px; }
.world-viewer-scroll { max-height: 40vh; overflow-y: auto; text-align: left; scrollbar-width: none; }
.world-v-content { font-size: 15px; line-height: 1.7; color: #444; }

/* 3. æŒ‰é’®æ ·å¼ */
.world-action-btn { flex: 1; padding: 12px; border-radius: 12px; background: #f2f2f7; color: #007AFF; font-weight: 700; font-size: 14px; cursor: pointer; text-align: center; }
.world-action-btn.delete { color: #FF3B30; }
.world-action-btn:active { opacity: 0.7; }

/* 4. æ·»åŠ æŒ‰é’® */
.world-add-btn {
    border: 2px dashed #d1d1d6;
    border-radius: 18px;
    display: flex; align-items: center; justify-content: center;
    min-height: 120px; color: #d1d1d6; cursor: pointer;
}
/* --- ğŸ’¬ Chat App ä¸“å±å¤–å£³æ ·å¼ --- */

.chat-tab-panel {
    display: none; /* é»˜è®¤éšè— */
    width: 100%;
    height: 100%;
    animation: fadeIn 0.3s ease;
}
.chat-tab-panel.active { display: block; }

/* æ‚¬æµ®å¯¼èˆªæ å®¹å™¨ */
.chat-nav-wrapper {
    position: absolute;
    bottom: 30px; /* è·ç¦»åº•éƒ¨ç•™ç©ºï¼Œæ˜¾å¾—é«˜çº§ */
    left: 0; width: 100%;
    display: flex; justify-content: center;
    pointer-events: none; /* é˜²æ­¢é®æŒ¡å†…å®¹ç‚¹å‡» */
    z-index: 100;
}

.chat-bottom-nav {
    pointer-events: auto; /* æ¢å¤å¯¼èˆªæ ç‚¹å‡» */
    width: 90%;
    max-width: 380px;
    height: 65px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 0.5px solid rgba(255, 255, 255, 0.3);
    border-radius: 35px; /* è¶…åœ†è§’ */
    display: flex;
    align-items: center;
    justify-content: space-around;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: #8e8e93;
    transition: all 0.2s ease;
    cursor: pointer;
}

.nav-item span { font-size: 10px; font-weight: 600; }
.nav-item.active { color: #007AFF; transform: scale(1.1); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
/* --- ğŸ’¬ Chat: å¥½å‹ç¯æ ·å¼ --- */
.chat-friend-ring-container {
    padding: 15px 0;
    background: #fff;
    border-bottom: 0.5px solid #eee;
    overflow: hidden;
}
.friend-ring-wrapper {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 0 16px;
    scrollbar-width: none;
}
.friend-ring-wrapper::-webkit-scrollbar { display: none; }

.friend-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
    cursor: pointer;
}
.friend-avatar-ring {
    width: 62px; height: 62px;
    border-radius: 50%;
    padding: 2px;
    border: 2px solid #007AFF; /* ç±»ä¼¼æ•…äº‹ç¯çš„é¢œè‰² */
}
.friend-avatar-ring img {
    width: 100%; height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
.friend-item span { font-size: 11px; color: #333; max-width: 65px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* --- ğŸ‘¤ ç¤¾äº¤åç‰‡å¡ç‰‡ --- */
.chat-profile-card {
    width: 85%; max-width: 320px;
    background: #fff; border-radius: 30px;
    padding: 30px 20px; text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    animation: cardScaleUp 0.3s cubic-bezier(0.17, 0.89, 0.32, 1.2);
}
@keyframes cardScaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

.profile-avatar-glow {
    width: 100px; height: 100px;
    margin: 0 auto 15px auto;
    border-radius: 50%;
    position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
#profile-v-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.profile-info h2 { font-size: 22px; font-weight: 800; margin-bottom: 5px; }
.online-tag { font-size: 11px; color: #34C759; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px; }
.profile-motto {
    font-size: 14px; color: #666; font-style: italic;
    background: #f2f2f7; padding: 10px 15px; border-radius: 12px;
    cursor: pointer; transition: 0.2s;
}
.profile-motto:hover { background: #e5e5ea; }

.profile-actions {
    display: flex; justify-content: space-around;
    margin-top: 30px; padding-top: 20px;
    border-top: 0.5px solid #f2f2f7;
}
.action-btn-circle {
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    color: #007AFF; cursor: pointer;
}
.action-btn-circle span { font-size: 11px; font-weight: 600; }
.action-btn-circle:active { opacity: 0.5; }
/* ğŸ’¬ Chat App ç»ˆæè§†è§‰åŠ å›º */
#chatApp {
    background: #F2F2F7 !important; /* å¼ºåˆ¶ iOS ç³»ç»Ÿç°è‰²èƒŒæ™¯ */
    z-index: 7000 !important;       /* ç¡®ä¿å±‚çº§é«˜äº Page 2 çš„æ‰€æœ‰ç»„ä»¶ */
    overflow: hidden;
}

#chatApp .app-body {
    background: #F2F2F7 !important;
    padding: 0 !important;         /* ç§»é™¤å†…è¾¹è·ï¼Œäº¤ç»™é¢æ¿å¤„ç† */
    display: block !important;     /* ç¦ç”¨ Flexï¼Œé˜²æ­¢å†…å®¹æŒ¤å‹ */
    position: relative;
    z-index: 5;
}

/* åˆ—è¡¨è¡Œæ ·å¼ - å¢å¼ºç‰ˆ */
.contact-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #fff;             /* æ¯ä¸€è¡Œå¿…é¡»æ˜¯çº¯ç™½èƒŒæ™¯ */
    border-bottom: 0.5px solid #E5E5EA;
    cursor: pointer;
    transition: background 0.2s;
}
.contact-row:active { background: #E5E5EA; }

.contact-avatar {
    width: 50px; height: 50px;
    margin-right: 15px;
    flex-shrink: 0;
    object-fit: cover;
    background: #eee;
}

.contact-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.contact-name { font-size: 17px; font-weight: 600; color: #000; }
.contact-preview { font-size: 13px; color: #8E8E93; margin-top: 2px; }

/* åº•éƒ¨å¯¼èˆªæ å¼ºåˆ¶ç½®é¡¶ */
.chat-nav-wrapper {
    z-index: 9999 !important;
    pointer-events: none;
}
.chat-bottom-nav { pointer-events: auto; }
/* ==========================================
   ğŸ’ Chat åˆ—è¡¨ï¼šé«˜çº§å•†ç”¨ UI é‡å¡‘
   ========================================== */

/* 1. å¼ºåˆ¶æ¸…ç†é¢æ¿èƒŒæ™¯ï¼Œå½»åº•æ€æ‰å¤§å›¾æº¢å‡º */
#chat-panel-list {
    background-color: #F2F2F7 !important; 
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* 2. åˆ—è¡¨å®¹å™¨ï¼šå››å‘¨ç•™å‡ºå‘¼å¸ä½ */
#chat-list-content {
    padding: 16px !important;
    padding-bottom: 120px !important; /* ç»™åº•éƒ¨æ‚¬æµ®å¯¼èˆªç•™ä½ç½® */
}

/* 3. ã€æ ¸å¿ƒè®¾è®¡ã€‘è”ç³»äººåˆ†ç»„å¡ç‰‡ï¼šæŠŠæ‰€æœ‰è¡ŒåŒ…åœ¨ä¸€ä¸ªå¤§åœ†è§’ç›’å­é‡Œ */
.chat-contact-group {
    background: #ffffff;
    border-radius: 14px; 
    overflow: hidden;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
}

/* 4. è”ç³»äººè¡Œï¼šå»æ‰å¤šä½™çš„ç™½è¾¹ï¼Œæ”¹ç”¨ç²¾è‡´åˆ†å‰²çº¿ */
.contact-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s ease;
    position: relative;
}

/* æ¨¡æ‹Ÿ iOS åˆ†å‰²çº¿ï¼šçº¿æ¡ä»æ–‡å­—å¤„å¼€å§‹ï¼Œä¸åˆ‡æ–­å¤´åƒï¼Œä¿æŒè§†è§‰è¿è´¯ */
.contact-row:not(:last-child)::after {
    content: "";
    position: absolute;
    bottom: 0;
    right: 0;
    left: 80px; 
    height: 0.5px;
    background: #E5E5EA;
}

/* ç‚¹å‡»æ—¶çš„ç°è‰²åé¦ˆï¼Œè®©ç”¨æˆ·çŸ¥é“â€œç‚¹ä¸­äº†â€ */
.contact-row:active {
    background: #F2F2F7;
}

/* 5. å¤´åƒç²¾ä¿®ï¼šå¢åŠ æç»†çš„æè¾¹ï¼Œé˜²æ­¢åœ¨ç™½åº•ä¸Šç³Šæ‰ */
.contact-avatar {
    width: 50px;
    height: 50px;
    margin-right: 14px;
    object-fit: cover;
    background: #f8f8f8;
    box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.1);
}

/* 6. æ–‡å­—æ’ç‰ˆï¼šå±‚çº§åˆ†æ˜ */
.contact-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.contact-name {
    font-size: 17px;
    font-weight: 600;
    color: #000;
    letter-spacing: -0.4px;
}

.contact-preview {
    font-size: 13px;
    color: #8E8E93; /* å‰¯æ ‡é¢˜ç° */
}

/* 7. å³ä¾§ç®­å¤´ï¼šè°ƒæ·¡é¢œè‰²ï¼Œå‡å°‘è§†è§‰å¹²æ‰° */
.contact-chevron {
    color: #C7C7CC;
    margin-left: 8px;
    opacity: 0.8;
}

/* 8. é¡¶éƒ¨åˆ‡æ¢æ  (Segment) ç¾åŒ– */
.segment-control {
    background: #E3E3E8 !important;
    padding: 2px !important;
    border-radius: 10px !important;
    margin-bottom: 5px !important;
}

.segment-btn.active {
    background: #fff !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}
/* --- ğŸ’ Messages é¡µé¢é«˜çº§æ’ç‰ˆ --- */

/* 1. åŒºåŸŸå°æ ‡é¢˜æ ‡ç­¾ */
.chat-section-label {
    font-size: 10px;
    font-weight: 800;
    color: #8E8E93;
    letter-spacing: 1.5px;
    padding: 10px 16px 5px 16px;
    text-transform: uppercase;
    background: #fff; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ */
}

/* 2. æ¶ˆæ¯åˆ—è¡¨å®¹å™¨ï¼šå¢åŠ ç•™ç™½å’ŒèƒŒæ™¯è‰² */
#chat-panel-msg {
    background: #F2F2F7 !important; /* ç³»ç»Ÿç°è‰²èƒŒæ™¯ */
}

.msg-list-container {
    background: #ffffff;
    margin-top: 5px;
    border-top: 0.5px solid #E5E5EA;
    min-height: 100%;
}

/* 3. ç©ºæ¶ˆæ¯çŠ¶æ€ç¾åŒ– */
.empty-msg-placeholder {
    padding: 60px 40px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.empty-msg-visual {
    width: 60px; height: 60px;
    background: #f2f2f7;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #C7C7CC;
}

.empty-msg-text {
    font-size: 14px;
    color: #8E8E93;
    font-family: serif;
    font-style: italic;
    line-height: 1.6;
}

/* 4. æ¨¡æ‹Ÿæ¶ˆæ¯è¡Œæ ·å¼ (è®©é¡µé¢å³ä¾¿ç©ºçš„ä¹Ÿå¥½çœ‹) */
.fake-msg-row {
    display: flex; align-items: center; padding: 12px 16px; opacity: 0.4; filter: blur(0.5px);
}
/* --- ğŸ’¬ Chat App å†…éƒ¨é¢æ¿å¼ºåˆ¶éš”ç¦»è¡¥ä¸ --- */

/* 1. é”å®š ChatApp çš„ä¸»ä½“å®¹å™¨ï¼Œç¦æ­¢å®ƒäº§ç”Ÿæ¨ªå‘æº¢å‡º */
#chatApp .app-body {
    position: relative !important;
    flex: 1 !important;
    overflow: hidden !important; /* æ ¸å¿ƒï¼šç¦æ­¢åœ¨è¿™é‡Œäº§ç”Ÿå¥‡æ€ªçš„æ»‘åŠ¨ */
    background: #F2F2F7 !important;
}

/* 2. å¼ºåˆ¶æ¯ä¸ªé¢æ¿ï¼ˆæ¶ˆæ¯ã€åˆ—è¡¨ç­‰ï¼‰ç‹¬ç«‹é‡å  */
.chat-tab-panel {
    display: none; /* é»˜è®¤å®Œå…¨éšè— */
    position: absolute !important; /* æ ¸å¿ƒï¼šç»å¯¹å®šä½ï¼Œè®©å®ƒä»¬é‡å åœ¨åŒä¸€ä¸ªå‘ä½ */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto !important; /* å…è®¸å†…éƒ¨ä¸Šä¸‹æ»šåŠ¨ï¼Œä½†ä¸å‡†æ¨ªå‘ä¹±è·‘ */
    -webkit-overflow-scrolling: touch;
    background: #F2F2F7; /* ç»Ÿä¸€åº•è‰² */
}

/* 3. åªæœ‰æ¿€æ´»çŠ¶æ€æ‰æ˜¾ç¤ºï¼Œå¹¶ä¸”å¼ºåˆ¶æ’‘æ»¡ */
.chat-tab-panel.active {
    display: flex !important; /* æˆ–è€… blockï¼Œå–å†³äºä½ å†…éƒ¨å¸ƒå±€ */
    flex-direction: column;
    z-index: 10;
}

/* 4. ç‰¹åˆ«ä¿®å¤ï¼šé˜²æ­¢æ¶ˆæ¯é¡µé¢çš„é¡¶éƒ¨å¥½å‹ç¯æ’‘å¤§å®¹å™¨ */
.chat-fixed-header {
    width: 100%;
    flex-shrink: 0;
    z-index: 20;
}
/* --- ğŸ¨ Chat App é¢œè‰²å¤§ç»Ÿä¸€è¡¥ä¸ --- */

/* 1. ç»Ÿä¸€æ¶ˆæ¯é¢æ¿çš„æ•´ä½“åº•è‰² */
#chat-panel-msg, 
.msg-list-container,
.chat-fixed-header,
.chat-friend-ring-container {
    background-color: #F2F2F7 !important; /* å¼ºåˆ¶ç»Ÿä¸€ä¸ºç³»ç»Ÿç°è‰² */
}

/* 2. ç»Ÿä¸€å°æ ‡é¢˜ï¼ˆMoments/Conversationsï¼‰çš„èƒŒæ™¯ */
.chat-section-label {
    background-color: #F2F2F7 !important;
    color: #8E8E93; /* é¡ºä¾¿è°ƒæˆ iOS æ ‡å‡†ç°è‰²æ–‡å­— */
}

/* 3. ç»Ÿä¸€å¥½å‹ç¯åŒºåŸŸçš„èƒŒæ™¯ */
.chat-friend-ring-container {
    border-bottom: none !important; /* å»æ‰å¤šä½™çš„åˆ†å‰²çº¿ï¼Œæ›´æ¸…çˆ½ */
}

/* 4. å¦‚æœä½ å¸Œæœ›åˆ—è¡¨é¡¹ï¼ˆå¦‚æœæœ‰äººçš„è¯ï¼‰æ˜¯ç™½çš„ï¼Œå¯ä»¥ä¿ç•™ã€‚
   ä½†å¦‚æœä½ æƒ³å½»åº•å…¨ç°ï¼Œå¯ä»¥æŠŠä¸‹é¢è¿™è¡Œä¹ŸåŠ ä¸Šï¼š */
/* .contact-row { background-color: #F2F2F7 !important; } */

/* 5. ç¡®ä¿åº•éƒ¨å¯¼èˆªæ ä¹Ÿå’ŒèƒŒæ™¯èåˆ (æ¯›ç»ç’ƒæ•ˆæœ) */
.chat-bottom-nav {
    background: rgba(242, 242, 247, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border-top: 0.5px solid rgba(0,0,0,0.05) !important;
}
/* --- ğŸš‘ å¤´åƒå˜å½¢æ€¥æ•‘ + å¼ºåˆ¶å‘¼å¸å…‰æ™•è¡¥ä¸ --- */

/* --- ğŸ›ï¸ Ins é£æ ¼é«˜çº§åç‰‡å…¨æ¡ˆæ ·å¼ --- */

/* 1. å¡ç‰‡æœ¬ä½“ï¼šé«˜å¯¹æ¯”ã€æŸ”å’Œé˜´å½±ã€å±…ä¸­æ’ç‰ˆ */
.chat-profile-card-aesthetic {
    width: 88%;
    max-width: 340px;
    background: #ffffff;
    border-radius: 40px; /* è¶…å¤§åœ†è§’æ›´ç°ä»£ */
    padding: 45px 25px 35px 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    box-shadow: 0 40px 100px rgba(0,0,0,0.1);
    animation: aesCardFadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

/* 2. å¤´åƒç‰©ç†é”æ­»ï¼šè§£å†³å˜å½¢çš„å…³é”® */
.aes-avatar-ring-wrapper {
    position: relative;
    width: 120px;
    height: 120px;
    margin-bottom: 25px;
    flex-shrink: 0; /* å¼ºåˆ¶ä¸è®¸ç¼©æ°´ */
}

#profile-v-avatar {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    object-fit: cover !important; /* æ ¸å¿ƒï¼šè‡ªåŠ¨å±…ä¸­è£åˆ‡ */
    border: 5px solid #fff;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    position: relative;
    z-index: 5;
}

/* 3. å‘¼å¸åœˆï¼šé«˜çº§æ„ŸæŸ”å…‰ */
.aes-breathing-ring {
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 2px solid rgba(52, 199, 89, 0.4);
    z-index: 1;
    animation: aesHaloPulse 3s infinite ease-in-out;
}

.aes-breathing-ring::after {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(52, 199, 89, 0.3);
    animation: aesHaloPulse 3s infinite ease-in-out 1.5s;
}

/* 4. æ–‡å­—æ’ç‰ˆï¼šè¡¬çº¿ä½“æå‡è´¨æ„Ÿ */
.aes-nickname-serif {
    font-family: "Times New Roman", serif; /* ä½¿ç”¨ç»å…¸è¡¬çº¿ä½“ */
    font-size: 26px;
    font-weight: 800;
    color: #1d1d1f;
    letter-spacing: -0.5px;
    margin-bottom: 5px;
}

.aes-online-tag {
    font-size: 10px;
    font-weight: 800;
    color: #34C759;
    letter-spacing: 2px;
    margin-bottom: 20px;
}

/* 5. ç­¾ååŒºåŸŸï¼šè½»ç›ˆã€æ„å¢ƒ */
.aes-motto-box {
    background: #f8f8f8;
    padding: 18px 20px;
    border-radius: 20px;
    max-width: 260px;
    cursor: pointer;
    transition: background 0.3s;
    margin-bottom: 30px;
}

.aes-motto-box:active { background: #f0f0f0; }

#profile-v-motto {
    font-family: serif;
    font-style: italic;
    color: #666;
    font-size: 14px;
    line-height: 1.6;
    margin: 0;
}

/* 6. æŒ‰é’®ç»„ï¼šæç®€çº¿æ¡é£æ ¼ */
.aes-action-grid {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    border-top: 1px solid #f2f2f7;
    padding-top: 25px;
}

.aes-btn-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.aes-icon-circle {
    width: 48px;
    height: 48px;
    background: #f2f2f7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    transition: all 0.2s;
}

.aes-btn-item span {
    font-size: 11px;
    font-weight: 700;
    color: #8e8e93;
    text-transform: uppercase;
}

.aes-btn-item:active .aes-icon-circle {
    transform: scale(0.9);
    background: #e5e5ea;
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes aesCardFadeIn {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes aesHaloPulse {
    0% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.15); opacity: 0.8; }
    100% { transform: scale(1); opacity: 0.3; }
}
/* é¡¶éƒ¨å·¥å…·æ å®¹å™¨ */
.aes-card-header-tools {
    width: 100%;
    display: flex;
    justify-content: flex-end; /* æŒ‰é’®é å³ */
    position: absolute; /* ç»å¯¹å®šä½ï¼Œä¸å æ’ç‰ˆç©ºé—´ */
    top: 20px;
    right: 20px;
    z-index: 100;
}

/* å…³é—­æŒ‰é’®æœ¬ä½“ */
.aes-close-trigger {
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.05); /* ææ·¡çš„åº•è‰² */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8e8e93;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* ç‚¹å‡»/æ‚¬åœæ•ˆæœ */
.aes-close-trigger:active {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(0.9);
}

/* ç¡®ä¿å¡ç‰‡æœ¬èº«æ˜¯ç›¸å¯¹å®šä½çš„ï¼Œæ–¹ä¾¿æŒ‰é’®å®šä½ */
.chat-profile-card-aesthetic {
    position: relative !important; /* å¿…é¡»åŠ è¿™ä¸€è¡Œ */
}
/* --- ğŸ‘¥ å‘èµ·ç¾¤èŠé¡µé¢é«˜çº§ UI è¡¥ä¸ --- */

/* 1. ç»Ÿä¸€èƒŒæ™¯å’Œåˆ—è¡¨å®¹å™¨ */
#page-add-group .app-body {
    background: #F2F2F7 !important;
    padding: 20px 16px !important;
}

/* 2. é¡¶éƒ¨ç¾¤èµ„æ–™å¡ç‰‡ */
.group-info-card {
    background: #fff;
    border-radius: 14px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* 3. ä¿®å¤äººæ•°è¾“å…¥æ¡†ï¼šå˜æˆ iOS æ ‡å‡†å³ä¾§å°æ¡† */
#page-add-group .ios-list-item input[type="number"] {
    border: none;
    background: #E5E5EA;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 15px;
    font-weight: 600;
    color: #007AFF;
    width: 50px !important; /* é”å®šå®½åº¦ */
    text-align: center;
    outline: none;
}

/* 4. æˆå‘˜é€‰æ‹©ç½‘æ ¼ç¾åŒ– */
#group-member-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* ä¸€è¡Œ4ä¸ªï¼Œé€‚åˆå¤´åƒæ˜¾ç¤º */
    gap: 15px;
    padding: 10px 0;
}

.member-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.member-avatar-box {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 14px; /* é‡‡ç”¨è‹¹æœ App å›¾æ ‡åœ†è§’ */
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.member-avatar-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* å…³é”®ï¼šé€‰ä¸­çŠ¶æ€çš„æ ·å¼ */
.member-item.selected .member-avatar-box {
    border-color: #007AFF;
    transform: scale(0.95);
}

/* é€‰ä¸­åçš„å³ä¸Šè§’å¯¹å‹¾ */
.member-item.selected .member-avatar-box::after {
    content: "âœ“";
    position: absolute;
    top: 2px;
    right: 2px;
    background: #007AFF;
    color: white;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.member-name {
    font-size: 11px;
    color: #3a3a3c;
    font-weight: 500;
    max-width: 65px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
/* --- ğŸ’ èŠå¤©å®¤æ¶²æ€ç»ç’ƒå…¨æ¡ˆæ ·å¼ --- */

/* 1. å¤´éƒ¨å¸ƒå±€ï¼šé€æ˜åº•ç‰ˆ */
.chat-room-header {
    height: 100px;
    padding: 50px 20px 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: transparent; /* å…³é”®ï¼šèƒŒæ™¯é€æ˜ */
    position: absolute;
    top: 0; left: 0; width: 100%;
    z-index: 100;
}

/* 2. æ¶²æ€ç»ç’ƒæŒ‰é’®æ ·å¼ */
.header-glass-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(15px) saturate(180%);
    -webkit-backdrop-filter: blur(15px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    cursor: pointer;
}

/* 3. ä¸­é—´å¤´åƒå’Œæ˜µç§° */
.header-contact-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
}

#room-contact-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-text-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#room-contact-name { font-size: 14px; font-weight: 800; color: #000; }
.room-status-text { font-size: 10px; color: #34C759; font-weight: 700; letter-spacing: 0.5px; }

/* 4. æ¶ˆæ¯æ»šåŠ¨åŒº */
.chat-scroll-area {
    flex: 1;
    margin-top: 100px;
    margin-bottom: 90px;
    padding: 20px;
    overflow-y: auto;
    background: #F2F2F7;
}

/* --- ğŸš‘ èŠå¤©å®¤è¾“å…¥åŒºé«˜çº§é‡å¡‘ --- */

/* 1. åº•éƒ¨å®¹å™¨ï¼šæ”¹ä¸ºæ‚¬æµ®ç»ç’ƒæ„Ÿï¼Œä¸å†æ­»æ¿åœ°è´´åœ¨æœ€åº•ä¸‹ */
#page-chat-room .chat-room-footer {
    position: absolute;
    bottom: 25px; /* è·ç¦»åº•éƒ¨ç•™ç©ºï¼Œäº§ç”Ÿæ‚¬æµ®æ„Ÿ */
    left: 5%;
    width: 90%; /* å®½åº¦ä¸æ’‘æ»¡ï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
    height: 56px; /* ç¨å¾®åŠ é«˜ä¸€ç‚¹ */
    padding: 0 10px 0 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.75); /* æŸ”å’ŒåŠé€æ˜ */
    backdrop-filter: blur(20px) saturate(180%); /* å¼ºåŠ›æ¯›ç»ç’ƒ */
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 28px; /* è¶…å¤§åœ†è§’ */
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* æè½»çš„é˜´å½± */
    z-index: 100;
}

/* 2. å·¦ä¾§ + å·ï¼šè°ƒå°ä¸€ç‚¹ï¼Œé¢œè‰²å˜æ·¡ï¼Œåƒä¸ªç²¾è‡´çš„æ’ä»¶å…¥å£ */
.footer-add-btn {
    color: #8E8E93 !important; /* ç°è°ƒæ›´é«˜çº§ */
    transition: transform 0.2s ease;
}
.footer-add-btn:active { transform: scale(0.9) rotate(90deg); }

/* 3. è¾“å…¥æ¡†ï¼šå½»åº•é€æ˜åŒ–ï¼Œåªç•™æ–‡å­— */
.chat-room-input {
    flex: 1;
    height: 100%;
    background: transparent !important;
    border: none !important;
    font-size: 16px;
    color: #000;
    outline: none;
    padding: 0;
}
.chat-room-input::placeholder {
    color: #C7C7CC;
    font-weight: 400;
}

/* 4. å³ä¾§æŒ‰é’®ç»„ï¼šç¼©å°å°ºå¯¸ï¼Œç»Ÿä¸€é£æ ¼ */
.footer-action-btns {
    display: flex;
    gap: 8px;
    align-items: center;
}

.action-btn {
    width: 36px !important; /* ç»Ÿä¸€ç¼©å°ä¸€ç‚¹ */
    height: 36px !important;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: none !important; /* å»æ‰ä¹‹å‰çš„é‡é˜´å½± */
}

/* AI æŒ‰é’®ï¼šä½è°ƒçš„æ·±ç°è‰²ç»ç’ƒæ„Ÿ */
.action-btn.ai {
    background: rgba(29, 29, 31, 0.05) !important;
    color: #1d1d1f !important;
}
.action-btn.ai:active { background: rgba(29, 29, 31, 0.15) !important; }

/* å‘é€æŒ‰é’®ï¼šç»å…¸çš„ iOS è“è‰²ï¼Œä½†å»æ‰æ‚ä¹±è¾¹æ¡† */
.action-btn.send {
    background: #007AFF !important;
    color: #fff !important;
}
.action-btn.send:active { transform: scale(0.85); opacity: 0.8; }

/* 5. ä¿®æ­£æ¶ˆæ¯åŒºåŸŸçš„åº•éƒ¨é—´è·ï¼Œé˜²æ­¢è¢«æ‚¬æµ®æ¡æŒ¡ä½ */
#page-chat-room .chat-scroll-area {
    padding-bottom: 100px !important;
}
/* --- ğŸš‘ ç¡®ä¿èŠå¤©å®¤èƒŒæ™¯ä¸ç©¿é€ --- */
/* --- ğŸš¨ ç‰©ç†å±‚çº§ç»ˆæé”æ­» --- */
#page-chat-room {
    position: fixed !important; /* å¿…é¡»æ˜¯å›ºå®šå®šä½ï¼Œè„±ç¦»æ‰€æœ‰å®¹å™¨æ§åˆ¶ */
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: #F2F2F7 !important; /* ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
    z-index: 9000 !important;      /* ç»å¯¹çš„æœ€é«˜å±‚çº§ï¼Œç›–è¿‡çŠ¶æ€æ å’Œä¸€åˆ‡ */
    display: none;                  /* åˆå§‹éšè— */
    flex-direction: column;
    transform: translateX(100%);    /* åˆå§‹åœ¨å±å¹•å³ä¾§å¤– */
    transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1) !important;
}
/* å¼ºåˆ¶è®©èŠå¤©é¡µé¢çš„å¤´éƒ¨å¾€ä¸‹æŒªï¼Œåˆ«è·ŸçŠ¶æ€æ æ’è½¦ */
#page-chat-room .chat-room-header {
    padding-top: 50px !important; /* ç‰©ç†é¿å¼€çŠ¶æ€æ é«˜åº¦ */
    background: rgba(242, 242, 247, 0.9) !important; /* ç»™èŠå¤©å®¤å¤´éƒ¨åŠ ç‚¹æ¯›ç»ç’ƒè‰²ï¼Œé˜²æ­¢é€å‡ºåº•ä¸‹çš„æ¡Œé¢æ–‡å­— */
    backdrop-filter: blur(20px) !important;
}

/* æ¿€æ´»çŠ¶æ€ */
#page-chat-room.active-room {
    display: flex !important;
    transform: translateX(0) !important;
}
/* æ¶ˆæ¯åˆ†éš”ç¬¦æ ·å¼ */
.chat-time-divider {
    text-align: center;
    font-size: 10px;
    font-weight: 800;
    color: #C7C7CC;
    letter-spacing: 1px;
    margin: 20px 0;
    text-transform: uppercase;
}
/* 1. å¼ºè¡Œåˆ é™¤â€œåœ¨çº¿â€çŠ¶æ€æ–‡æœ¬ */
.room-status-text {
    display: none !important;
}

/* 2. æ¶ˆæ¯åŒºåŸŸæ•´ä½“å‘ä¸Šå¹³ç§» */
/* ä¹‹å‰ä¸ºäº†é¿å¼€çŠ¶æ€æ å¯èƒ½è®¾ç½®äº†è¿‡å¤§çš„ 100pxï¼Œç°åœ¨æŠŠå®ƒæ”¹å° */
#page-chat-room .chat-scroll-area {
    margin-top: 70px !important; /* è¿™é‡Œçš„æ•°å€¼è¶Šå°ï¼Œæ¶ˆæ¯å°±è¶Šé ä¸Š */
    padding-top: 0px !important;
}

/* 3. å‹ç¼©å¤´éƒ¨çš„é«˜åº¦ï¼Œè®©å¤´åƒå’Œåå­—æ›´ç´§å‡‘ */
#page-chat-room .chat-room-header {
    min-height: 80px !important;
    height: 80px !important;
    padding-bottom: 0px !important;
}

/* 4. è®©æ—¶é—´åˆ†éš”ç¬¦ (TODAY) ä¹Ÿå¾€ä¸Šæä¸€ç‚¹ */
.chat-time-divider {
    margin-top: 5px !important;
    margin-bottom: 10px !important;
}
.chat-time-divider {
    text-align: center;
    font-size: 11px !important; /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹ */
    font-weight: 600 !important;
    color: #C7C7CC;
    letter-spacing: 0.5px;
    margin: 20px 0;
    text-transform: none !important; /* å…³é—­å…¨å¤§å†™ï¼Œå¦åˆ™ä¸­æ–‡æ˜¾ç¤ºä¼šæœ‰é—®é¢˜ */
    width: 100%;
    white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
}
@keyframes msgFadeUp {
    from { 
        opacity: 0; 
        transform: translateY(10px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}
/* --- ğŸ’ æç®€æ˜Ÿè¾°Â·å…¨åœ†è§’æ°”æ³¡è®¾è®¡ --- */

/* 1. åŸºç¡€å¸ƒå±€ */
.msg-row {
    margin: 20px 0;
    display: flex;
    align-items: flex-end; /* è®©å¤´åƒå’Œæ°”æ³¡åº•éƒ¨å¯¹é½ */
    gap: 10px;
    padding: 0 -10px;
    animation: bubbleEnter 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 2. ç»Ÿä¸€å¤´åƒæ ·å¼ */
.chat-avatar-img {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
    border: 1.5px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* 3. é€šç”¨æ°”æ³¡è®¾è®¡ (æ ¸å¿ƒï¼šå…¨åœ†è§’) */
.bubble {
    position: relative;
    padding: 12px 18px;
    font-size: 15px;
    line-height: 1.6;
    max-width: 70%;
    border-radius: 22px !important; /* å¼ºåˆ¶å…¨åœ†è§’ï¼Œå»æ‰å°–è§’ */
    word-break: break-all;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}

/* 4. ç”¨æˆ·æ°”æ³¡ï¼šæ˜Ÿæµ·æ·±è“ (é å³) */
.msg-row.user {
    justify-content: flex-end;
}
.msg-row.user .bubble {
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%); /* æ·±è‰²ç³»æ›´æ˜¾é«˜çº§ */
    color: #fff;
}

/* 5. è§’è‰²æ°”æ³¡ï¼šä¸ç¼é›¾ç° (é å·¦) */
.msg-row.opponent {
    justify-content: flex-start;
}
.msg-row.opponent .bubble {
    background: #ffffff;
    color: #1d1d1f;
    border: 0.5px solid rgba(0,0,0,0.08);
}

/* 6. æ˜Ÿæ˜Ÿè£…é¥°ï¼šå¾®å…‰ç‰¹æ•ˆ */
.star-decor {
    position: absolute;
    font-size: 12px;
    pointer-events: none;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
    animation: starPulse 2s infinite ease-in-out;
}

.msg-row.user .star-decor {
    top: -8px;
    right: 5px;
    color: #fff;
}

.msg-row.opponent .star-decor {
    bottom: -8px;
    left: 5px;
    color: #8E8E93; /* å¯¹æ–¹æ˜Ÿæ˜Ÿç”¨æ·¡ç°è‰²ï¼Œä¸å–§å®¾å¤ºä¸» */
}

/* 7. ç²¾è‡´åŠ¨ç”» */
@keyframes bubbleEnter {
    from { opacity: 0; transform: translateY(12px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes starPulse {
    0%, 100% { opacity: 0.4; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

/* 8. ä¿®å¤ï¼šå¦‚æœæ˜¯ç”¨æˆ·å‘çš„æ¶ˆæ¯ï¼Œå°±ä¸æ˜¾ç¤ºé‚£ä¸ªç©ºå‡ºæ¥çš„å¤´åƒä½ç½® */
.msg-row.user .chat-avatar-img { display: none; }
/* --- ğŸ’ å®Œç¾ä¿®å¤è¡¥ä¸ï¼šé«˜çº§æ˜Ÿæ˜Ÿ + å¼ºåˆ¶å¯¹é½ --- */

/* 1. å¼ºåˆ¶ä¿®å¤ï¼šå¯¹æ–¹æ¶ˆæ¯é å·¦å¯¹é½ */
.msg-row.opponent {
    justify-content: flex-start !important; /* å¼ºåˆ¶é å·¦ */
    margin-right: auto !important; /* ç¡®ä¿ä¸å æ®å³ä¾§ç©ºé—´ */
}
/* ç¡®ä¿å¤´åƒå’Œæ°”æ³¡ç´§æŒ¨ç€ï¼Œæ²¡æœ‰å¤šä½™é—´è· */
.msg-row.opponent {
    gap: 8px !important;
}


/* 2. ç”¨ CSS ç”»ä¸€ä¸ªé«˜çº§çš„å››è§’æ˜Ÿ (æ›¿ä»£ä¸‘ Emoji) */
.star-decor-css {
    position: absolute;
    width: 12px;  /* æ˜Ÿæ˜Ÿå¤§å° */
    height: 12px;
    pointer-events: none;
    animation: starPulseCSS 2s infinite ease-in-out;
}

/* æ ¸å¿ƒé­”æ³•ï¼šç”¨ä¸¤ä¸ªä¼ªå…ƒç´ äº¤å‰åˆ›å»ºä¸€ä¸ªå››è§’æ˜Ÿ */
.star-decor-css::before,
.star-decor-css::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 2px; /* æ˜Ÿæ˜Ÿå…‰èŠ’çš„ç²—ç»† */
    background: currentColor; /* ç»§æ‰¿çˆ¶çº§æ°”æ³¡çš„æ–‡å­—é¢œè‰² */
    border-radius: 2px;
    transform: translate(-50%, -50%);
}
.star-decor-css::after {
    transform: translate(-50%, -50%) rotate(90deg); /* æ—‹è½¬90åº¦å½¢æˆåå­— */
}

/* 3. è®¾ç½®æ˜Ÿæ˜Ÿä½ç½®å’Œé¢œè‰² */
/* ç”¨æˆ·æ˜Ÿæ˜Ÿï¼šç™½è‰²ï¼Œåœ¨å³ä¸Šè§’ */
.msg-row.user .star-decor-css {
    top: -6px;
    right: 6px;
    color: #fff;
    filter: drop-shadow(0 0 4px rgba(255,255,255,0.6)); /* åŠ ç‚¹å‘å…‰æ•ˆæœ */
}
/* å¯¹æ–¹æ˜Ÿæ˜Ÿï¼šé«˜çº§ç°ï¼Œåœ¨å·¦ä¸‹è§’ */
.msg-row.opponent .star-decor-css {
    bottom: -6px;
    left: 6px;
    color: #A1A1A6;
}

/* 4. æ˜Ÿæ˜Ÿé—ªçƒåŠ¨ç”» */
@keyframes starPulseCSS {
    0%, 100% { opacity: 0.5; transform: scale(0.9) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.1) rotate(45deg); } /* ç¨å¾®è½¬ä¸€ä¸‹æ›´çµåŠ¨ */
}
/* --- ğŸš‘ æ¶ˆæ¯åˆ—è¡¨å·¦æ»‘äº¤äº’è¡¥ä¸ --- */

/* 1. æ»‘åŠ¨å®¹å™¨ï¼šéšè—æº¢å‡ºçš„æŒ‰é’® */
.swipe-item-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden; /* å…³é”®ï¼šéšè—å³ä¾§æŒ‰é’® */
    background: #fff;
    border-bottom: 0.5px solid #E5E5EA;
}

/* 2. å†…å®¹å±‚ï¼šçœŸæ­£æ˜¾ç¤ºæ¶ˆæ¯çš„éƒ¨åˆ† */
.swipe-content {
    position: relative;
    width: 100%;
    background: #fff;
    z-index: 2; /* ç›–åœ¨æŒ‰é’®ä¸Šé¢ */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: transform;
}

/* 3. æŒ‰é’®å±‚ï¼šè—åœ¨å³ä¾§ */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    display: flex;
    z-index: 1;
}

/* 4. å•ä¸ªæŒ‰é’®æ ·å¼ */
.swipe-btn {
    width: 75px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    color: #fff;
    cursor: pointer;
}

.btn-pin { background: #8E8E93; } /* ç½®é¡¶ï¼šiOS æ ‡å‡†ç°è‰² */
.btn-delete { background: #FF3B30; } /* åˆ é™¤ï¼šiOS æ ‡å‡†çº¢è‰² */

/* --- ğŸ’ æè‡´é«˜çº§æ„Ÿï¼šç½®é¡¶æ ·å¼é‡å¡‘ --- */

/* 1. ç½®é¡¶è¡Œçš„èƒŒæ™¯ï¼šä½¿ç”¨ææ·¡çš„å†·ç°è‰²ï¼Œè¥é€ â€œé›¾é¢ç»ç’ƒâ€æ„Ÿ */
.is-pinned .swipe-content {
    background: #F8F9FB !important; 
}

/* 2. å·¦ä¾§æµå…‰ä¾§è¾¹æ¡ï¼šåƒå‘¼å¸ä¸€æ ·å­˜åœ¨ */
.swipe-item-wrapper.is-pinned::before {
    content: "";
    position: absolute;
    left: 0;
    top: 15%; /* ä¸å°é¡¶ï¼Œæ›´æœ‰å‘¼å¸æ„Ÿ */
    height: 70%;
    width: 3.5px;
    background: #007AFF;
    border-radius: 0 4px 4px 0;
    z-index: 10;
    box-shadow: 2px 0 8px rgba(0, 122, 255, 0.2);
}

/* 3. æç®€çŸ¢é‡å›ºå®šé’ˆ (æ›¿ä»£ä¸‘å›¾å½¢) */
.pin-tag-ios {
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    margin-right: 4px;
}

.is-pinned .pin-tag-ios {
    display: flex !important;
}

/* ç”¨ CSS ç”»ä¸€ä¸ªæç»†çš„ç«–é’ˆï¼Œéå¸¸æœ‰è´¨æ„Ÿ */
.pin-needle {
    width: 1px;
    height: 10px;
    background: #8E8E93;
    position: relative;
}
.pin-needle::before {
    content: "";
    position: absolute;
    top: -2px;
    left: -3.5px;
    width: 8px;
    height: 1px;
    background: #8E8E93;
}
.pin-needle::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: -0.5px;
    width: 2px;
    height: 2px;
    border-radius: 50%;
    background: #8E8E93;
}

/* 4. ä¼˜åŒ–æ¶ˆæ¯è¡Œçš„æ’ç‰ˆï¼Œä¸ºç½®é¡¶ç•™å‡ºç©ºé—´ */
.is-pinned .contact-name {
    color: #007AFF !important; /* ç½®é¡¶çš„åå­—é¢œè‰²å¾®è°ƒæˆè“è‰²ï¼Œæ›´ç›´è§‚ */
}
/* --- ğŸš‘ å¼¹çª—å¼ºåˆ¶æ­£ä¸­å¿ƒå®šä½è¡¥ä¸ --- */
#iosConfirmModal.ios-alert-mask {
    display: none; /* åˆå§‹ç”± JS æ§åˆ¶æ˜¾ç¤º */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
    
    /* æ ¸å¿ƒå±…ä¸­æŒ‡ä»¤ */
    align-items: center !important; 
    justify-content: center !important;
    z-index: 999999 !important; /* ç¡®ä¿åœ¨æœ€æœ€æœ€é¡¶å±‚ */
}

/* å¼¹çª—æœ¬ä½“çš„å¾®è°ƒ */
#iosConfirmModal .ios-alert-box {
    width: 270px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 14px;
    overflow: hidden;
    animation: alertPopCenter 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    transform: none !important; /* æŠ¹é™¤ä¹‹å‰å¯èƒ½çš„åä½åç§» */
    margin: 0 auto !important;
}

@keyframes alertPopCenter {
    from { opacity: 0; transform: scale(1.1); }
    to { opacity: 1; transform: scale(1); }
}
/* --- ğŸ’ é«˜çº§ç½®é¡¶æ ‡è®°ï¼šçº¯ CSS çŸ¢é‡ç»˜å›¾ --- */

/* ç½®é¡¶çŠ¶æ€ä¸‹çš„èƒŒæ™¯è‰²ï¼šæµ…è“é›¾é¢æ„Ÿ */
.is-pinned .swipe-content {
    background: #F2F8FF !important; 
}

/* çŸ¢é‡æŠ˜è§’æ ‡è®° (æ›¿ä»£ä¸‘ Emoji) */
.pinned-mark {
    display: none;
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border-style: solid;
    /* 16px çš„ä¸‰è§’å½¢æŠ˜è§’ */
    border-width: 0 16px 16px 0; 
    border-color: transparent #007AFF transparent transparent;
    z-index: 5;
    opacity: 0.8;
}

/* åªæœ‰åœ¨ç½®é¡¶çŠ¶æ€ä¸‹æ‰æ˜¾ç¤ºæ ‡è®° */
.is-pinned .pinned-mark {
    display: block !important;
}

/* å¼ºåˆ¶å¼¹çª—å±…ä¸­çš„ä¼˜å…ˆçº§å†åŠ å›º */
#iosConfirmModal.ios-alert-mask {
    display: none;
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    align-items: center !important; /* å‚ç›´å±…ä¸­ */
    justify-content: center !important; /* æ°´å¹³å±…ä¸­ */
    z-index: 1000000 !important;
}
/* --- ğŸ’¬ æ€è€ƒä¸­ï¼šä¸‰ç‚¹è·³åŠ¨åŠ¨ç”» --- */
.typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
    height: 20px;
    padding: 4px 0;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #8E8E93; /* iOS æ ‡å‡†ç°è‰² */
    border-radius: 50%;
    display: inline-block;
    animation: dotPulse 1.4s infinite ease-in-out both;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes dotPulse {
    0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
    40% { transform: scale(1); opacity: 1; }
}
/* --- ğŸš‘ å¸ƒå±€æ€¥æ•‘ï¼šè®©è¾“å…¥æ¡†å’Œæ¶ˆæ¯è´´è¿‘ --- */
#page-chat-room .chat-scroll-area {
    flex: 1 !important;
    margin-top: 80px !important;    /* é¿å¼€é¡¶éƒ¨çš„è·ç¦» */
    margin-bottom: 0 !important;   /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šåˆ æ‰åŸæ¥çš„ 90px å¤–è¾¹è· */
    padding-bottom: 90px !important; /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå†…è¾¹è·è®¾ä¸º 90pxï¼Œåˆšå¥½ç»™æ‚¬æµ®æ¡†ç•™ä½ç½® */
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    display: block !important;
}

/* ç¡®ä¿èŠå¤©é¡µé¢é«˜åº¦é“ºæ»¡ï¼Œä¸äº§ç”Ÿæ–­å±‚ */
#page-chat-room {
    height: 100vh !important;
    display: flex !important;
    flex-direction: column !important;
}
/* --- ğŸ’ æ°”æ³¡é•¿æŒ‰/ç‚¹å‡»èœå• --- */
.bubble-context-menu {
    position: fixed;
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    width: 260px; /* å®½åº¦é€‚é…å››åˆ— */
    animation: menuPop 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

@keyframes menuPop {
    from { opacity: 0; transform: scale(0.8) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* èœå•ä¸»ä½“ */
.menu-box {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    border-radius: 20px;
    padding: 12px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* æ ¸å¿ƒï¼šå››åˆ—å¸ƒå±€ */
    gap: 15px 10px;
}

/* å•ä¸ªå›¾æ ‡æŒ‰é’® */
.menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.1s;
}
.menu-item:active { transform: scale(0.9); }

/* --- ğŸ”³ é»‘ç™½æç®€é£èœå•å›¾æ ‡ --- */
.menu-icon-circle {
    width: 44px; height: 44px;
    background: #f5f5f7; /* åº•è‰²æ”¹æˆæ›´æŸ”å’Œçš„æµ…ç° */
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    /* ç»Ÿä¸€å›¾æ ‡é¢œè‰²ä¸ºæ·±ç°è‰² */
    stroke: #333333 !important; 
    transition: background 0.2s;
}

/* é¼ æ ‡æ”¾ä¸Šå»å˜æ·±ä¸€ç‚¹ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
.menu-item:hover .menu-icon-circle {
    background: #e5e5e7;
}

/* å¼ºåˆ¶æ‰€æœ‰ SVG å›¾æ ‡ä¸ºé»‘ç™½ */
.menu-icon-circle svg {
    stroke: #333333 !important;
    fill: none !important; /* ç¡®ä¿æ²¡æœ‰å¡«å……è‰² */
}

/* èœå•æ–‡å­—é¢œè‰² */
.menu-item span {
    font-size: 10px;
    font-weight: 500;
    color: #666666; /* æ–‡å­—ä¹Ÿç”¨æŸ”å’Œçš„ç°è‰² */
    letter-spacing: 0.5px;
    margin-top: 4px;
}
.menu-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.2); /* ç¨å¾®æ·±ä¸€ç‚¹ç‚¹ï¼Œçªå‡ºèœå• */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 9998; /* å¿…é¡»åœ¨èœå• 10000 çš„ä¸‹é¢ï¼Œä½†åœ¨å…¶ä»–å…ƒç´ ä¸Šé¢ */
    display: none;
    cursor: default; /* ç¡®ä¿èƒ½æ•æ‰åˆ°ç‚¹å‡» */
}
/* --- ğŸ’¬ å¼•ç”¨åŠŸèƒ½ä¸“å±æ ·å¼ --- */
/* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„é¢„è§ˆæ¡ */
.quote-preview-bar {
    display: none; /* é»˜è®¤éšè— */
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-top: 0.5px solid #eee;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: slideUp 0.3s ease;
}

.quote-content-wrapper {
    border-left: 3px solid #007AFF; /* å¼•ç”¨è“æ¡ */
    padding-left: 10px;
    overflow: hidden;
}

.quote-user-name {
    font-size: 11px;
    font-weight: 700;
    color: #007AFF;
    margin-bottom: 2px;
}

.quote-text-preview {
    font-size: 13px;
    color: #666;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    max-width: 200px;
}

/* 2. æ°”æ³¡å†…éƒ¨çš„å¼•ç”¨å— */
.bubble-quote-box {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    padding: 8px 12px;
    margin-bottom: 8px;
    border-left: 2px solid #ddd;
    font-size: 12px;
    color: #8e8e93;
    line-height: 1.4;
}
/* --- å¤šé€‰æ¨¡å¼ä¸‹çš„å®¹å™¨è°ƒæ•´ --- */
.msg-row.multi-selecting {
    padding-left: 50px !important; /* ç»™å·¦ä¾§å¯¹å‹¾ç•™ç©ºé—´ */
    transition: padding 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* éšè—çš„å¯¹å‹¾å®¹å™¨ */
.msg-check-box {
    position: absolute;
    left: -40px; /* åˆå§‹è—åœ¨å·¦è¾¹ */
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    background: #fff;
    cursor: pointer;
}

/* é€‰ä¸­çŠ¶æ€ï¼šèƒŒæ™¯å˜è“ï¼Œæ¡†å˜è“ */
.msg-row.selected .msg-check-box {
    background: #007AFF;
    border-color: #007AFF;
}

/* é€‰ä¸­åçš„å¯¹å‹¾å›¾æ ‡ (ç”¨ CSS ç”»ä¸€ä¸ªç™½è‰²çš„å¯¹å‹¾) */
.msg-row.selected .msg-check-box::after {
    content: '';
    width: 10px;
    height: 5px;
    border-left: 2px solid #fff;
    border-bottom: 2px solid #fff;
    transform: rotate(-45deg);
    margin-top: -2px;
}

/* --- å¤šé€‰åº•æ ï¼šæµ®åŠ¨åœ¨è¾“å…¥æ¡†ä¹‹ä¸Š --- */
.multi-select-footer {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    height: 85px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-top: 0.5px solid #eee;
    display: none; /* é»˜è®¤éšè— */
    justify-content: space-around;
    align-items: center;
    padding-bottom: 20px;
    z-index: 200;
    animation: slideUp 0.3s ease;
}

.multi-action-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    color: #007AFF;
    cursor: pointer;
}
.multi-action-item span { font-size: 10px; font-weight: 600; }
.multi-action-item.danger { color: #FF3B30; } /* åˆ é™¤æŒ‰é’®ç”¨çº¢è‰² */
/* é€‰ä¸­åçš„æ•´è¡ŒèƒŒæ™¯å¾®è°ƒï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
.msg-row.multi-selecting.selected {
    background-color: rgba(0, 122, 255, 0.05); 
}

/* é‡ç‚¹ï¼šé€‰ä¸­çš„æ°”æ³¡åº•è‰²å˜æ·±ï¼Œè®©äººä¸€çœ¼çœ‹å‡ºé€‰äº†è° */
.msg-row.selected .bubble {
    box-shadow: 0 0 0 2px #007AFF inset !important; /* è“è‰²å†…è¾¹æ¡† */
    background: rgba(0, 122, 255, 0.1) !important; /* ææ·¡çš„è“è‰²èƒŒæ™¯ */
}

/* å¼ºåˆ¶æ˜¾ç¤ºå¯¹å‹¾å®¹å™¨ï¼Œå¹¶å¢åŠ åŠ¨ç”» */
.msg-check-box {
    position: absolute;
    left: 15px; /* ç§»åˆ°å¯è§åŒºåŸŸ */
    top: 50%;
    transform: translateY(-50%) scale(0.8);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    background: #fff;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
}

.msg-row.selected .msg-check-box {
    transform: translateY(-50%) scale(1.1); /* é€‰ä¸­æ—¶ç¨å¾®æ”¾å¤§ï¼Œæœ‰å¼¹åŠ›æ„Ÿ */
    background: #007AFF;
    border-color: #007AFF;
}
/* --- æ ¸å¿ƒä¿®å¤ï¼šå¯¹å‹¾åœ†åœˆé»˜è®¤å½»åº•éšè— --- */
.msg-check-box {
    position: absolute;
    left: -40px; /* åˆå§‹èº²åœ¨å±å¹•å¤– */
    top: 50%;
    transform: translateY(-50%) scale(0.5);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    background: #fff;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0; /* é»˜è®¤é€æ˜ */
    pointer-events: none; /* éå¤šé€‰æ¨¡å¼ä¸å¯ç‚¹å‡» */
    z-index: 10;
}

/* --- åªæœ‰è¿›å…¥å¤šé€‰æ¨¡å¼ï¼Œåœ†åœˆæ‰æ»‘å…¥å¹¶æ˜¾å½¢ --- */
.msg-row.multi-selecting .msg-check-box {
    left: 15px; 
    opacity: 1;
    transform: translateY(-50%) scale(1);
    pointer-events: auto;
}

/* é€‰ä¸­åçš„æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼Œä½†ç¡®ä¿å®ƒåªåœ¨ multi-selecting ä¸‹ç”Ÿæ•ˆï¼‰ */
.msg-row.multi-selecting.selected .msg-check-box {
    background: #007AFF;
    border-color: #007AFF;
}

/* é€‰ä¸­åçš„æ°”æ³¡é«˜äº®ï¼šé€€å‡ºæ¨¡å¼åç”±äºå»æ‰äº† selected ç±»ï¼Œè¿™ä¸ªä¼šè‡ªåŠ¨æ¶ˆå¤± */
.msg-row.selected .bubble {
    box-shadow: 0 0 0 2px #007AFF inset !important;
    background: rgba(0, 122, 255, 0.05) !important;
}
/* è½¬å‘æ¶ˆæ¯çš„ç‰¹æ®Šæ ·å¼ */
.is-forwarded .bubble {
    border-left: 3.5px solid #C7C7CC !important; /* å·¦ä¾§æµ…ç°è‰²ç²—çº¿ï¼ŒåŒºåˆ†åŸç”Ÿæ¶ˆæ¯ */
    position: relative;
}

/* è½¬å‘æ ‡è®°å°æ–‡å­— */
.forward-label {
    font-size: 9px;
    color: #8E8E93;
    font-weight: 700;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.forward-label svg { width: 10px; height: 10px; }
/* --- ä¸“é—¨é’ˆå¯¹è½¬å‘é€‰æ‹©é¡µçš„é¿è®©é€»è¾‘ --- */

#page-forward-picker {
    /* 1. æ ¸å¿ƒä¿®å¤ï¼šæŠŠå±‚çº§è°ƒåˆ° 9000ï¼Œç¡®ä¿ä½äºçŠ¶æ€æ çš„ 9999 */
    z-index: 9000 !important; 
    
    /* 2. æ ¸å¿ƒä¿®å¤ï¼šé¡¶éƒ¨ç•™å‡º 48px çš„ç‰©ç†ç©ºé—´ï¼ŒæŠŠé¡µé¢é¡¶ä¸‹å»ï¼Œç»™çŠ¶æ€æ ç•™ä½å­ */
    padding-top: 48px !important; 
    
    /* 3. å¼ºåˆ¶èƒŒæ™¯é“ºæ»¡å…¨å±ï¼Œé˜²æ­¢å‡ºç°æˆªå›¾é‡Œé‚£ç§ç¼©æ°´çš„æƒ…å†µ */
    width: 100vw !important;
    height: 100vh !important;
    background: #F2F2F7 !important;
    display: flex !important;
    flex-direction: column !important;
}

/* 4. ä¿®å¤è½¬å‘é¡µé¢çš„å¤´éƒ¨ï¼šä¸å†é¡¶ç€å±å¹•è¾¹ç¼˜ */
#page-forward-picker .app-header {
    height: 60px !important;
    padding: 0 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    background: #F2F2F7 !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
    flex-shrink: 0 !important;
}

/* 5. ä¿®å¤æˆªå›¾ 3 ä¸­åˆ—è¡¨ç¼©æˆä¸€å›¢çš„é—®é¢˜ï¼šå¼ºåˆ¶å†…å®¹æ’‘æ»¡ */
#page-forward-picker .app-body {
    flex: 1 !important;
    width: 100% !important;
    display: block !important; /* ç¦ç”¨ Flex é˜²æ­¢å†…å®¹æ°´å¹³æŒ¤å‹ */
    overflow-y: auto !important;
    padding: 10px 16px 80px 16px !important; /* åº•éƒ¨ç•™å‡ºç©ºé—´ */
    box-sizing: border-box !important;
}

/* 6. ç¡®ä¿åˆ—è¡¨è¡Œä¹Ÿæ˜¯æ»¡å®½çš„ */
#page-forward-picker .chat-contact-group {
    width: 100% !important;
    margin: 0 !important;
}

#page-forward-picker .contact-row {
    width: 100% !important;
    padding-right: 16px !important;
    box-sizing: border-box !important;
}
/* 1. æ’¤å›æ¶ˆæ¯çš„ç³»ç»Ÿæç¤ºæ ·å¼ */
.recalled-msg-hint {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 12px 0;
    width: 100%;
    animation: msgFadeUp 0.4s ease;
}

.recalled-msg-hint span {
    background: rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(5px);
    color: #8E8E93;
    font-size: 11px;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.recalled-msg-hint span:active {
    background: rgba(0, 0, 0, 0.1);
}

/* 2. æŸ¥é˜…æ’¤å›å†…å®¹çš„ç²¾ç¾å¡ç‰‡ */
.recalled-content-card {
    width: 80%;
    max-width: 300px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: saturate(180%) blur(25px);
    border-radius: 30px;
    padding: 30px 25px;
    text-align: center;
    box-shadow: 0 30px 60px rgba(0,0,0,0.15);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

.recalled-v-label {
    font-size: 10px;
    color: #8E8E93;
    letter-spacing: 2px;
    font-weight: 800;
    margin-bottom: 15px;
}

.recalled-v-text {
    font-size: 16px;
    color: #1d1d1f;
    line-height: 1.6;
    text-align: left;
    margin-bottom: 25px;
    max-height: 200px;
    overflow-y: auto;
    font-family: serif;
    font-style: italic;
}
/* ç¡®ä¿èœå•é¡¹é»˜è®¤æ˜¯æ˜¾ç¤ºçš„ */
.menu-item {
    display: flex !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

/* é’ˆå¯¹æ’¤å›æŒ‰é’®çš„ä¸“å±å›¾æ ‡é¢œè‰² */
#menu-recall .menu-icon-circle {
    stroke: #333 !important;
}

/* éšè—çŠ¶æ€ä¸‹çš„ç±»åï¼ˆå¤‡ç”¨ï¼‰ */
.menu-item.hidden {
    display: none !important;
}
/* --- âš™ï¸ è®¾ç½®é¡µï¼šé«˜çº§æŠ˜å äº¤äº’æ ·å¼ --- */

/* 1. æŠ˜å å®¹å™¨ */
/* --- æ›¿æ¢æ–¹æ¡ˆï¼šæ— æ¨ªçº¿ï¼Œç”±é—´è·åˆ†éš”çš„ç‹¬ç«‹å¡ç‰‡ --- */
.ios-accordion-item {
    background: #fff;
    overflow: hidden;
    transition: all 0.2s ease;
    
    /* 1. å»æ‰æ¨ªçº¿ */
    border-bottom: none; 
    
    /* 2. åŠ ä¸Šåº•éƒ¨é—´è·ï¼Œè®©å®ƒä»¬åˆ†å¼€ */
    margin-bottom: 1px; 
}

/* 3. ç»™æœ€å¤–å±‚çš„å®¹å™¨åŠ ä¸ªèƒŒæ™¯è‰²ï¼Œè¿™æ ·é—´è·å°±ä¼šé€å‡ºèƒŒæ™¯è‰²ï¼Œå½¢æˆè‡ªç„¶çš„åˆ†å‰² */
.ios-list-group {
    background: #F2F2F7 !important; /* ç¡®ä¿åº•è‰²æ˜¯ç°çš„ */
    padding: 0 !important;
    overflow: hidden;
    gap: 1px; /* å¤‡ç”¨æ–¹æ¡ˆ */
}

/* 2. å¤´éƒ¨ç‚¹å‡»åŒº (ä¿æŒåŸæœ¬çš„åˆ—è¡¨è¡Œæ ·å¼ï¼Œä½†å¢åŠ äº†ç‚¹å‡»åé¦ˆ) */
.accordion-header {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    cursor: pointer;
    background: #fff;
    position: relative;
    z-index: 2;
    transition: background 0.2s;
}
.accordion-header:active {
    background: #F2F2F7;
}

/* æ—‹è½¬çš„å°ç®­å¤´ */
.accordion-chevron {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #C7C7CC;
}
/* æ¿€æ´»æ—¶ç®­å¤´å‘ä¸‹è½¬ */
.ios-accordion-item.active .accordion-chevron {
    transform: rotate(90deg);
    color: #007AFF;
}

/* 3. å†…å®¹å±•å¼€åŒº (é»˜è®¤é«˜åº¦0ï¼Œéšè—) */
.accordion-content {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    background: #F9F9F9; /* å±•å¼€åçš„åº•è‰²ç¨å¾®æ·±ä¸€ç‚¹ï¼ŒåŒºåˆ†å±‚çº§ */
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
}

/* æ¿€æ´»æ—¶å±•å¼€ */
.ios-accordion-item.active .accordion-content {
    max-height: 1000px; /* ç»™ä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜åº¦ */
    opacity: 1;
    padding-bottom: 15px; /* åº•éƒ¨ç•™ç™½ */
    border-top: 0.5px solid #eee; /* é¡¶éƒ¨åŠ æ¡çº¿åŒºåˆ† */
}

/* å±•å¼€åŒºåŸŸå†…çš„æ“ä½œæŒ‰é’® */
.sub-setting-btn {
    margin: 10px 16px 0 16px;
    padding: 12px;
    background: #fff;
    border-radius: 10px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: #007AFF;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
    cursor: pointer;
}
.sub-setting-btn:active { transform: scale(0.98); }

/* --- ğŸš« åº•éƒ¨ç‹¬ç«‹æŒ‰é’®ç»„ (Danger Zone) --- */
.danger-zone-container {
    margin-top: 30px;
    padding: 0 10px;
    display: flex;
    flex-direction: column;
    gap: 12px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
}

.standalone-btn {
    width: 100%;
    padding: 16px;
    background: #fff;
    border-radius: 14px; /* æ›´åœ†æ¶¦çš„ç‹¬ç«‹å— */
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03); /* æ·¡æ·¡çš„æµ®èµ·æ„Ÿ */
    cursor: pointer;
    transition: all 0.2s;
}

.standalone-btn:active {
    transform: scale(0.98);
    background: #f2f2f2;
}

/* è“è‰²åŠŸèƒ½æŒ‰é’® */
.btn-blue-text { color: #007AFF; }
/* çº¢è‰²å±é™©æŒ‰é’® */
.btn-red-text { color: #FF3B30; }
/* ==========================================
   ğŸ´ğŸ–¤ ç»ˆæé»‘ç™½Â·å…ˆé”‹æç®€é£æ ¼è¡¥ä¸ ğŸ–¤ğŸ´
   ========================================== */

/* 1. å®¹å™¨ï¼šå½»åº•éšå½¢ï¼Œåªç•™é—´è· */
.ios-list-group {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 4px !important; /* å·¦å³ç¨å¾®ç•™ç‚¹å‘¼å¸æ„Ÿ */
    overflow: visible !important;
}

/* 2. å¡ç‰‡æœ¬ä½“ï¼šçº¯ç™½æ‚¬æµ®å—ï¼Œå¤§åœ†è§’ */
.ios-accordion-item {
    background: #FFFFFF !important;
    margin-bottom: 16px !important; /* ğŸŸ¢ æ˜¾è‘—çš„é—´è·ï¼Œåƒæ¼‚æµ®çš„ç§¯æœ¨ */
    border-radius: 24px !important; /* æ›´ç°ä»£çš„è¶…å¤§åœ†è§’ */
    border: 1px solid rgba(0,0,0,0.03) !important; /* æç»†å¾®çš„è¾¹æ¡†æå‡è´¨æ„Ÿ */
    box-shadow: 0 8px 20px rgba(0,0,0,0.04) !important; /* é«˜çº§æŸ”å…‰é˜´å½± */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
}

/* æ¿€æ´»çŠ¶æ€ï¼ˆå±•å¼€æ—¶ï¼‰ï¼šç¨å¾®æµ®èµ·ä¸€ç‚¹ */
.ios-accordion-item.active {
    box-shadow: 0 12px 30px rgba(0,0,0,0.08) !important;
    transform: translateY(-2px);
}

/* 3. å¤´éƒ¨åŒºåŸŸï¼šåŠ é«˜ï¼Œå‚ç›´å±…ä¸­ */
.accordion-header {
    padding: 18px 20px !important; /* æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
    background: transparent !important;
}

/* 4. å›¾æ ‡é‡å¡‘ï¼šå¼ºåˆ¶é»‘ç™½åŒ– (æ ¸å¿ƒï¼) */
.item-icon {
    /* æŠŠåŸæ¥çš„å½©è‰²èƒŒæ™¯å…¨éƒ¨å¹²æ‰ï¼Œæ¢æˆææ·¡çš„ç°è‰² */
    background: #F2F2F7 !important; 
    border-radius: 50% !important; /* å˜æˆåœ†å½¢ */
    width: 44px !important;
    height: 44px !important;
    box-shadow: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin-right: 16px !important;
}

/* å¼ºåˆ¶æ‰€æœ‰ SVG çº¿æ¡å˜é»‘ */
.item-icon svg {
    stroke: #1d1d1f !important; /* è‹¹æœé»‘ */
    fill: none !important;      /* å»æ‰å¡«å……è‰² */
    width: 20px !important;
    height: 20px !important;
    stroke-width: 2.2 !important; /* çº¿æ¡åŠ ç²—ä¸€ç‚¹ç‚¹ï¼Œæ›´æœ‰åŠ› */
}

/* 5. æ–‡å­—æ’ç‰ˆï¼šåŠ ç²—ï¼Œçº¯é»‘ */
.item-label {
    font-size: 16px !important;
    font-weight: 700 !important; /* åŠ ç²— */
    color: #000000 !important;
    letter-spacing: -0.5px !important; /* ç´§å‡‘ä¸€ç‚¹æ›´ç²¾è‡´ */
}

/* 6. å³ä¾§ç®­å¤´ï¼šé»‘è‰²æç®€ */
.accordion-chevron {
    color: #000 !important;
    opacity: 0.3 !important;
    width: 16px !important;
    height: 16px !important;
    stroke-width: 3 !important;
}
.ios-accordion-item.active .accordion-chevron {
    opacity: 1 !important;
    color: #000 !important; /* æ¿€æ´»ä¹Ÿæ˜¯é»‘è‰² */
}

/* 7. å±•å¼€å†…å®¹åŒºï¼šé»‘ç™½åè½¬ */
.accordion-content {
    background: #fff !important;
    padding: 0 20px 24px 20px !important; /* åº•éƒ¨ç•™è¶³ç©ºé—´ */
    border-top: none !important;
}

/* 8. å†…éƒ¨æ“ä½œæŒ‰é’®ï¼šé»‘åº•ç™½å­— (é…·ï¼) */
.sub-setting-btn {
    background: #1d1d1f !important; /* çº¯é»‘åº• */
    color: #ffffff !important;      /* çº¯ç™½å­— */
    border-radius: 14px !important;
    padding: 14px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    letter-spacing: 0.5px !important;
    border: none !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15) !important; /* é»‘è‰²æŒ‰é’®çš„æŠ•å½± */
    margin-top: 12px !important;
}
.sub-setting-btn:active {
    transform: scale(0.97) !important;
    opacity: 0.8 !important;
}

/* 9. åº•éƒ¨å±é™©åŒºæŒ‰é’®ï¼šä¿æŒé»‘ç™½æç®€ */
.standalone-btn {
    border-radius: 18px !important;
    background: #fff !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03) !important;
    border: 1px solid rgba(0,0,0,0.02) !important;
}
/* å±é™©æŒ‰é’®æ–‡å­—ä¿ç•™çº¢è‰²ï¼Œå…¶ä»–çš„å˜é»‘ */
.btn-blue-text { color: #1d1d1f !important; }
/* --- ğŸ–¤ èŠå¤©èƒŒæ™¯è®¾ç½®é«˜çº§é»‘ç™½ UI --- */
.bg-config-container {
    padding: 20px;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.bg-config-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 18px;
    border: 1px solid #f0f0f0;
}

.bg-label-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.bg-main-title {
    font-size: 15px;
    font-weight: 700;
    color: #1d1d1f;
}

.bg-sub-hint {
    font-size: 11px;
    color: #8e8e93;
}

/* é¢„è§ˆæ¡†ï¼šå¼ºåˆ¶ 9:16 æ¯”ä¾‹ */
.bg-preview-box {
    width: 60px;
    height: 106px;
    background: #eee;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    border: 2px solid #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    cursor: pointer;
    flex-shrink: 0;
}

.bg-preview-box img, .bg-preview-box video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.bg-preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    color: #bbb;
    text-align: center;
    font-weight: 600;
    line-height: 1.2;
}

.bg-edit-badge {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 8px;
    text-align: center;
    padding: 2px 0;
    font-weight: 800;
}

/* åº•éƒ¨æ“ä½œæŒ‰é’® */
.bg-action-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.bg-save-btn {
    flex: 2;
    background: #1d1d1f;
    color: #fff;
    padding: 14px;
    border-radius: 14px;
    text-align: center;
    font-weight: 700;
    font-size: 14px;
}

.bg-reset-btn {
    flex: 1;
    background: #f2f2f7;
    color: #ff3b30;
    padding: 14px;
    border-radius: 14px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
}

/* --- ğŸŒ«ï¸ ä¸‡èƒ½èƒŒæ™¯ä¸Šä¼ å¼¹çª— (é»‘ç™½ç‰ˆ) --- */
#modal-universal-uploader .modal-content {
    background: #fff;
    border-top: 1px solid #eee;
}

.uploader-type-tag {
    display: inline-block;
    padding: 4px 10px;
    background: #1d1d1f;
    color: #fff;
    font-size: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
    font-weight: 800;
}

.url-input-wrapper {
    margin-bottom: 20px;
}
.bg-preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #1d1d1f; /* çº¯é»‘æ–‡å­— */
    background: #f2f2f7; /* æµ…ç°åº• */
    text-align: center;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.bg-edit-badge {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: #1d1d1f; /* çº¯é»‘åº• */
    color: #fff; /* çº¯ç™½å­— */
    font-size: 9px;
    text-align: center;
    padding: 3px 0;
    font-weight: 900;
    letter-spacing: 1px;
}
/* --- ğŸš¨ æ ¸å¿ƒï¼šå¼ºåˆ¶å…¨å±é€è§†è¡¥ä¸ --- */

/* 3. è®©å¤´éƒ¨ä¹Ÿå˜é€æ˜ï¼ˆæˆ–è€…ç»™ä¸ªææ·¡çš„ç£¨ç ‚æ„Ÿï¼‰ */
#page-chat-room .chat-room-header {
    background: rgba(255, 255, 255, 0.2) !important; /* 20% é€æ˜ç™½ */
    backdrop-filter: blur(10px) !important; /* iOS ç£¨ç ‚æ„Ÿ */
}

/* 4. åº•éƒ¨è¾“å…¥æ¡†èƒŒæ™¯ä¹Ÿé€æ˜åŒ– */
#page-chat-room .chat-room-footer {
    background: rgba(255, 255, 255, 0.4) !important;
    backdrop-filter: blur(20px) !important;
}

/* 5. ä¸“é—¨çš„ç‰©ç†èƒŒæ™¯å±‚æ ·å¼ */
#chat-room-full-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* é’‰åœ¨æœ€åº•å±‚ */
    pointer-events: none; /* ä¸å¹²æ‰°ç‚¹å‡»æ¶ˆæ¯ */
    overflow: hidden;
}

#chat-room-full-bg img, #chat-room-full-bg video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* æ ¸å¿ƒï¼šå¼ºåˆ¶è£åˆ‡æ’‘æ»¡ */
}
/* --- ğŸš¨ 1. å½»åº•é€šé€è¡¥ä¸ï¼šè§£å†³é¡¶éƒ¨ä¸é€æ˜é—®é¢˜ --- */
#page-chat-room, 
#page-chat-room .chat-room-header,
#page-chat-room .chat-scroll-area,
.status-bar {
    background: transparent !important; /* ç‰©ç†å¼ºåˆ¶é€æ˜ */
    background-color: transparent !important;
    border: none !important;
    box-shadow: none !important;
}

/* å¦‚æœä½ çš„ app-window æœ‰é»˜è®¤åº•è‰²ï¼Œä¹Ÿè¦å¹²æ‰ */
.ios-app-window.chat-room-layer {
    background: transparent !important;
}

/* --- âœ¨ 2. æ˜µç§°å‘å…‰è¡¥ä¸ï¼šè§£å†³æ·±è‰²èƒŒæ™¯çœ‹ä¸æ¸… --- */
#room-contact-name {
    color: #ffffff !important; /* å¼ºåˆ¶æ”¹ä¸ºç™½è‰² */
    /* æ ¸å¿ƒï¼šåŒå±‚æŠ•å½±ã€‚ä¸€å±‚ç™½è‰²æ‰©æ•£å…‰æ™•ï¼Œä¸€å±‚é»‘è‰²è¾¹ç¼˜æè¾¹ï¼Œç¡®ä¿åœ¨ä»»ä½•èƒŒæ™¯éƒ½æ¸…æ™° */
    text-shadow: 
        0 0 15px rgba(255, 255, 255, 0.6), 
        0 2px 4px rgba(0, 0, 0, 0.8) !important;
    font-weight: 800 !important;
}

/* --- â• 3. åŠ å·æŒ‰é’®è¡¥ä¸ï¼šå¢åŠ å¯è§åº¦ --- */
.footer-add-btn {
    color: #ffffff !important; /* æ”¹ä¸ºç™½è‰² */
    background: rgba(255, 255, 255, 0.2) !important; /* ç»™æŒ‰é’®åŠ ä¸ªæ·¡æ·¡çš„åœ†å½¢åº•è‰² */
    width: 32px !important;
    height: 32px !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px); /* ç»ç’ƒæ„Ÿ */
    transition: all 0.2s;
}

.footer-add-btn:active {
    background: rgba(255, 255, 255, 0.4) !important;
    transform: scale(0.9);
}

/* --- ğŸ“± 4. çŠ¶æ€æ æ–‡å­—é€‚é… --- */
/* å¦‚æœèƒŒæ™¯å¤ªæ·±ï¼ŒçŠ¶æ€æ çš„ 15:58 å’Œç”µé‡ä¹Ÿè¦å˜ç™½ */
#page-chat-room .status-bar,
#page-chat-room .status-bar * {
    color: white !important;
    fill: white !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* é¡ºä¾¿ä¼˜åŒ–ä¸€ä¸‹è¿”å›æŒ‰é’® */
.header-glass-btn.left {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}
/* --- ğŸš¨ ä¿®æ”¹è¿™ä¸€æ®µ --- */
#page-chat-room {
    /* åˆ é™¤åŸæ¥çš„ background-color: transparent !important; */
    background-color: #F2F2F7; /* èµ‹äºˆé»˜è®¤çš„ iOS ç³»ç»Ÿç° */
    position: fixed !important;
}

/* å†…éƒ¨çš„æ»šåŠ¨åŒºåŸŸå’Œå¤´éƒ¨ä¾ç„¶ä¿æŒé€æ˜ï¼Œè¿™æ ·æ‰èƒ½çœ‹åˆ°åº•ä¸‹çš„èƒŒæ™¯èˆ± */
#page-chat-room .chat-scroll-area {
    background-color: transparent !important;
}

/* èƒŒæ™¯èˆ±å±‚çº§ç¨å¾®è°ƒé«˜åˆ° -1ï¼Œç¡®ä¿å®ƒåœ¨å®¹å™¨åº•è‰²ä¹‹ä¸Šï¼Œä½†åœ¨å†…å®¹ä¹‹ä¸‹ */
#chat-room-full-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* è°ƒæˆ 0 */
    pointer-events: none;
    overflow: hidden;
}

/* æ¶ˆæ¯è¡Œéœ€è¦æåˆ°èƒŒæ™¯èˆ±ä¸Šé¢ */
.chat-scroll-area {
    position: relative;
    z-index: 1; 
}
/* --- ğŸš¨ å½»åº•é€šé€è¡¥ä¸ï¼šç§»é™¤æ¨¡ç³Šï¼Œè¿˜åŸæ¸…æ™°èƒŒæ™¯ --- */

/* 1. ç§»é™¤å¤´éƒ¨çš„ç£¨ç ‚ç»ç’ƒæ•ˆæœå’ŒèƒŒæ™¯è‰² */
#page-chat-room .chat-room-header {
    background: transparent !important;
    background-color: transparent !important;
    backdrop-filter: none !important;        /* å…³é”®ï¼šæ’¤é”€æ¨¡ç³Š */
    -webkit-backdrop-filter: none !important; /* å…¼å®¹ iOS */
    border-bottom: none !important;           /* ç§»é™¤ç»†çº¿ */
    box-shadow: none !important;              /* ç§»é™¤é˜´å½± */
}

/* 2. åŒæ—¶ç¡®ä¿çŠ¶æ€æ ä¹Ÿæ˜¯å®Œå…¨æ¸…æ¾ˆé€æ˜çš„ */
#page-chat-room .status-bar {
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

/* 3. ç¡®ä¿èƒŒæ™¯å±‚å»¶ä¼¸åˆ°æœ€é¡¶éƒ¨ï¼ˆé˜²æ­¢é¡¶éƒ¨ç•™ç™½ï¼‰ */
#chat-room-full-bg {
    top: 0 !important;
    height: 100vh !important;
}

/* 4. å†æ¬¡åŠ å›ºæ˜µç§°å’ŒçŠ¶æ€æ æ–‡å­—çš„æ¸…æ™°åº¦ï¼ˆå‘å…‰å¤–æŒ‚ï¼‰ */
#room-contact-name, 
#page-chat-room .status-bar, 
#page-chat-room .status-bar * {
    color: #ffffff !important;
    text-shadow: 
        0 1px 8px rgba(0, 0, 0, 0.6), 
        0 0 12px rgba(255, 255, 255, 0.4) !important;
}
/* --- ğŸ iOS é£æ ¼æˆåŠŸ HUD (é»‘ç™½æç®€) --- */
.ios-hud {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    width: 140px;
    height: 140px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-radius: 28px;
    display: none; /* é»˜è®¤éšè— */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 30000;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

/* æ¿€æ´»çŠ¶æ€ */
.ios-hud.show {
    display: flex;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

/* æˆåŠŸçš„å‹¾å‹¾åŠ¨ç”» */
.hud-checkmark {
    width: 60px;
    height: 60px;
    stroke: #1d1d1f; /* æç®€é»‘ */
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
}

.ios-hud.show .hud-checkmark {
    animation: dash 0.6s ease-in-out forwards 0.2s;
}

@keyframes dash {
    to { stroke-dashoffset: 0; }
}

.hud-text {
    margin-top: 15px;
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
    letter-spacing: 0.5px;
}
/* --- 1. å¥½å‹ç¯ä¸“å±ï¼šç¤¾äº¤åç‰‡æ ·å¼ --- */
.social-card {
    width: 280px;
    background: #fff;
    border-radius: 32px;
    padding: 30px 20px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
}
.social-online-tag {
    font-size: 10px; color: #34C759; font-weight: 800; letter-spacing: 1.5px; margin: 8px 0;
}
.social-motto {
    font-size: 13px; color: #666; background: #f2f2f7; padding: 12px; border-radius: 15px; margin: 15px 0 25px 0;
}
.social-actions {
    display: flex; justify-content: space-around; border-top: 0.5px solid #eee; padding-top: 20px;
}
.social-btn-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #007AFF; cursor: pointer; }
.social-btn-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; }

/* --- 2. è®¾ç½®é¡µä¸“å±ï¼šé«˜å®šæ¡£æ¡ˆå¡ç‰‡ --- */
.aesthetic-preview-card {
    width: 320px;
    background: #ffffff;
    border-radius: 40px;
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.2);
}
.aes-pre-header { height: 100px; background: #1d1d1f; position: relative; } /* é»‘ç™½æç®€é¡¶æ  */
.aes-pre-avatar { width: 100px; height: 100px; border: 5px solid #fff; border-radius: 30px; position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%) rotate(-3deg); object-fit: cover; }
.aes-pre-body { padding: 60px 25px 30px 25px; text-align: center; }
.aes-pre-name { font-family: serif; font-size: 26px; font-weight: 800; color: #000; }
.aes-pre-desc-box { background: #f9f9f9; padding: 15px; border-radius: 18px; margin-top: 20px; text-align: left; max-height: 150px; overflow-y: auto; }
.aes-pre-desc-box p { font-size: 13px; color: #444; line-height: 1.6; font-style: italic; }

/* --- 3. å±‚çº§é”æ­» --- */
.modal-top-layer {
    position: fixed !important; inset: 0 !important;
    z-index: 9995 !important; /* ä»…ä½äºçŠ¶æ€æ  */
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(15px);
    display: none; align-items: center; justify-content: center;
}
/* --- ğŸ› ï¸ ç¤¾äº¤å¡ç‰‡å¢å¼ºæ ·å¼ --- */

/* 1. ç‰©ç†å…³é—­æŒ‰é’® */
.social-close-trigger {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 30px;
    height: 30px;
    background: #f2f2f7; /* æµ…ç°åº• */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8e8e93;
    cursor: pointer;
    transition: all 0.2s;
}
.social-close-trigger:active {
    transform: scale(0.9);
    background: #e5e5ea;
}

/* 2. è®©ç­¾ååŒºåŸŸçœ‹èµ·æ¥â€œå¯ç‚¹å‡»â€ */
.social-motto {
    cursor: pointer;
    position: relative;
    transition: background 0.2s, transform 0.1s;
    border: 1px solid transparent;
}
.social-motto:hover {
    background: #ebebee;
}
.social-motto:active {
    transform: scale(0.98);
}

/* 3. ç¡®ä¿ç¤¾äº¤å¡ç‰‡å®¹å™¨å¯ä»¥ç›¸å¯¹å®šä½æŒ‰é’® */
.social-card {
    position: relative; /* å¿…é¡»åŠ è¿™ä¸€è¡Œ */
    width: 290px !important;
}
/* --- ğŸš¨ ç‰©ç†å±‚çº§ç»ˆæé”æ­»è¡¥ä¸ --- */

/* 1. é®ç½©åŸºç¡€æ ·å¼ï¼šç¡®ä¿æ˜¯ fixed ä¸”å…¨å± */
.vibe-center-mask, .modal-top-layer {
    position: fixed !important;
    inset: 0 !important;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
}

/* 2. ç¬¬ä¸€å±‚ï¼šç¤¾äº¤å¡ç‰‡ä¸é¢„è§ˆå¡ç‰‡ */
#modal-social-card, 
#modal-aes-preview {
    z-index: 30000 !important; 
}

/* 3. ç¬¬äºŒå±‚ï¼šä¿®æ”¹å¼¹çª—ï¼ˆå¿…é¡»ç›–è¿‡ä¸Šé¢çš„å¡ç‰‡ï¼‰ */
#modal-motto-edit {
    z-index: 35000 !important; /* ğŸ‘ˆ è¿™é‡Œé«˜å‡º 5000 ç‚¹ï¼Œç»å¯¹å‹åˆ¶ */
}

/* 4. ç¬¬ä¸‰å±‚ï¼šæˆåŠŸæç¤º HUD */
#save-success-hud {
    z-index: 40000 !important;
}

/* 5. é¡¶å±‚ï¼šçŠ¶æ€æ  */
.status-bar {
    z-index: 50000 !important;
}
/* --- ğŸš¨ èµ„æ–™é¡µå¸ƒå±€ç»ˆæä¿®æ­£ï¼šå¼ºåˆ¶å…¨å±æ‹‰ä¼¸ --- */

#subpage-char-profile {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important; 
    z-index: 9990 !important;
    padding-top: 0px !important; /* ç‰©ç†é¿å¼€çŠ¶æ€æ  */
    display: flex !important;
    flex-direction: column;
    box-sizing: border-box !important;
}

/* 1. å¼ºåˆ¶ä¸»ä½“åŒºåŸŸæ’‘æ»¡å·¦å³ */
#subpage-char-profile .app-body {
    width: 100% !important;
    max-width: none !important;
    padding: 10px 16px 120px 16px !important; /* å·¦å³ç•™ 16px æ ‡å‡† iOS å‘¼å¸æ„Ÿ */
    box-sizing: border-box !important;
    display: block !important; /* ç¦ç”¨ Flex é˜²æ­¢æŒ¤å‹ */
}

/* 2. å¼ºåˆ¶å¤´åƒä¸åå­—åŒºåŸŸå±…ä¸­ */
.profile-edit-header {
    width: 100% !important;
    display: flex !important;
    flex-direction: column;
    align-items: center;
    margin-bottom: 25px !important;
}

/* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶æ–‡æœ¬åŸŸå’Œåˆ—è¡¨ç»„æ¨ªå‘æ’‘æ»¡ */
#subpage-char-profile #edit-char-desc,
#subpage-char-profile .ios-list-group {
    width: 100% !important;        /* ç‰©ç†å®½åº¦ 100% */
    max-width: none !important;    /* æ‹†é™¤é™å®½å¢™ */
    margin: 12px 0 !important;     /* ä¸Šä¸‹ç•™ç©ºï¼Œå·¦å³ä¸ç•™ */
    box-sizing: border-box !important;
    display: block !important;
}

/* 4. æ–‡æœ¬åŸŸç»†èŠ‚è°ƒæ•´ï¼šåŠ é«˜å¹¶ä¼˜åŒ–å†…è¾¹è· */
#edit-char-desc {
    min-height: 180px !important;
    padding: 18px !important;
    border-radius: 18px !important;
    border: none !important;
    background: #fff !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.03) !important;
}

/* 5. ä¿®æ­£å…ƒæ•°æ®åˆ—è¡¨é¡¹å¯¹é½ */
#subpage-char-profile .ios-list-item {
    width: 100% !important;
    padding: 16px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    box-sizing: border-box !important;
}

/* 6. ä¿®æ­£æ ‡é¢˜ä½ç½®ï¼šé å·¦å¯¹é½å¡ç‰‡ */
#subpage-char-profile .tz-group-title {
    width: 100% !important;
    text-align: left !important;
    padding-left: 5px !important;
    margin-top: 25px !important;
}
#subpage-char-profile .app-header {
    /* ... å…¶ä»–ä»£ç ä¸å˜ ... */
    /* ğŸš¨ è¿™é‡Œçš„ padding æ”¹ä¸ºä¸‹é¢è¿™ä¸ªï¼Œåªåœ¨é¡¶éƒ¨ç•™å‡º 48px é¿å¼€çŠ¶æ€æ  */
    padding: 48px 16px 0 16px !important; 
    height: auto !important; /* è®©é«˜åº¦ç”±å†…è¾¹è·è‡ªç„¶æ’‘å¼€ */
}
/* --- ğŸ›ï¸ ä¸–ç•Œä¹¦ï¼šé«˜çº§æ„Ÿâ€œæ·»åŠ â€å¡ç‰‡é‡å¡‘ --- */
.world-add-btn {
    /* 1. ç‰©ç†å°ºå¯¸é”å®šï¼šç¡®ä¿å®ƒå’Œæ™®é€šçš„ world-card-item ä¸€æ ·å¤§ */
    grid-column: span 1; 
    height: 140px !important; /* å¢åŠ ä¸€ç‚¹é«˜åº¦ï¼Œæ›´æ˜¾å¤§æ°” */
    width: 100% !important;
    
    /* 2. èƒŒæ™¯ä¸è¾¹æ¡†ï¼šé»‘ç™½æç®€ï¼Œè™šçº¿åŠ ç²— */
    background: rgba(255, 255, 255, 0.6) !important; /* åŠé€æ˜ç™½ */
    border: 2px dashed #d1d1d6 !important; /* ç°ç™½è™šçº¿ */
    border-radius: 28px !important; /* è¶…å¤§åœ†è§’ */
    
    /* 3. å¸ƒå±€ï¼šçºµå‘æ’åˆ—å›¾æ ‡å’Œæ–‡å­— */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 10px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    
    /* 4. è§†è§‰ä¿®é¥° */
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    box-sizing: border-box;
}

/* æ‚¬åœ/ç‚¹å‡»æ—¶çš„åŠ¨æ€åé¦ˆ */
.world-add-btn:hover {
    background: #ffffff !important;
    border-color: #007AFF !important; /* æ‚¬åœæ—¶è™šçº¿å˜è“ */
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

.world-add-btn:active {
    transform: scale(0.96); /* ç‚¹å‡»æ—¶çš„ç‰©ç†å¼¹æ„Ÿ */
}

/* å†…éƒ¨å›¾æ ‡ç¾åŒ– */
.world-add-btn svg {
    width: 32px;
    height: 32px;
    color: #c7c7cc;
    transition: color 0.3s;
}

.world-add-btn:hover svg {
    color: #007AFF; /* æ‚¬åœæ—¶å›¾æ ‡å˜è“ */
}

/* å†…éƒ¨æ–‡å­—è¡¥å…¨ï¼ˆå¯é€‰ï¼Œå¦‚æœä½ çš„ HTML é‡Œæ²¡å†™å­—çš„è¯ï¼‰ */
.world-add-btn::after {
    content: "CREATE WORLD";
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    color: #d1d1d6;
    text-transform: uppercase;
}
/* --- ğŸ›ï¸ World é¡µé¢ï¼šå½»åº•æ¶ˆç­å·¦å³ç©ºéš™ --- */

/* 1. å¼ºåˆ¶ä¸»ä½“åŒºåŸŸä¸å±…ä¸­ï¼Œä¸”å®½åº¦ 100% */
#worldApp .app-body {
    display: block !important;     /* æ ¸å¿ƒï¼šåœç”¨ Flex å±…ä¸­ï¼Œæ¢å¤å—çº§æµ */
    width: 100% !important;
    padding: 20px 16px !important; /* å·¦å³ä¿ç•™ 16px çš„ iOS æ ‡å‡†å‘¼å¸è¾¹è· */
    box-sizing: border-box !important;
}

/* 2. å¼ºåˆ¶ç½‘æ ¼å®¹å™¨å æ»¡å±å¹• */
#world-grid.char-grid {
    width: 100% !important;
    max-width: none !important;
    margin: 0 !important;
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important; /* å¼ºåˆ¶ 50/50 å¹³åˆ†ä¸¤åˆ— */
    gap: 15px !important; /* å¡ç‰‡ä¹‹é—´çš„é—´è· */
}

/* 3. ä¿®æ­£å¡ç‰‡å’ŒæŒ‰é’®çš„å½¢çŠ¶ï¼ˆè§£å†³é‚£ä¸ªç»†é•¿ä¸‘æ ·ï¼‰ */
.world-add-btn, .world-card-item {
    width: 100% !important;
    /* å»ºè®®ä½¿ç”¨æ­£æ–¹å½¢æˆ–å›ºå®šé«˜åº¦ï¼Œæ›´æœ‰ç”»å»Šæ„Ÿ */
    aspect-ratio: 1 / 1.1 !important; 
    border-radius: 28px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}

/* 4. åŠ å¼ºåŠ å·æŒ‰é’®çš„è§†è§‰å­˜åœ¨æ„Ÿ */
.world-add-btn svg {
    width: 35px !important;
    height: 35px !important;
    margin-bottom: 8px;
}
/* --- ğŸ“œ ç»‘å®šåè®®é¡µï¼šå…¨å±æ‹‰ä¼¸ä¸é«˜çº§åˆ—è¡¨é‡å¡‘ --- */

/* 1. ç‰©ç†ç¯å¢ƒé‡ç½®ï¼šå¼ºåˆ¶é“ºæ»¡ */
#subpage-world-bind .app-body {
    display: block !important;     /* åœç”¨ Flex å±…ä¸­ */
    width: 100% !important;
    padding: 20px 16px 100px 16px !important; /* å·¦å³ç•™ 16px å‘¼å¸æ„Ÿ */
    box-sizing: border-box !important;
}

/* 2. åˆ—è¡¨ç»„é‡å¡‘ï¼šå˜æˆæ¨ªè·¨å…¨å±çš„åœ†è§’å¡ç‰‡ */
#subpage-world-bind .ios-list-group {
    width: 100% !important;
    max-width: none !important;
    background: #ffffff !important;
    border-radius: 14px !important;
    margin-bottom: 25px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    overflow: hidden;
    display: block !important;
}

/* 3. åˆ—è¡¨é¡¹ï¼ˆè§„åˆ™è¡Œï¼‰ï¼šæ–‡å­—å·¦ï¼Œå‹¾é€‰å³ */
#subpage-world-bind .ios-list-item {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important; /* æ ¸å¿ƒï¼šæ’‘å¼€ä¸¤å¤´ */
    padding: 14px 16px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    min-height: 52px;
}

/* 4. è¡ç”Ÿæ‰©å±•å…¥å£ç¾åŒ– */
#subpage-world-bind .ios-list-item[onclick*="openRelationsPage"] {
    background: #ffffff !important;
    cursor: pointer;
}

#subpage-world-bind .ios-list-item[onclick*="openRelationsPage"]:active {
    background: #f2f2f7 !important; /* ç‚¹å‡»åé¦ˆ */
}

/* 5. æ ‡é¢˜é å·¦å¯¹é½ */
#subpage-world-bind .tz-group-title {
    width: 100% !important;
    text-align: left !important;
    padding-left: 4px !important;
    margin-bottom: 8px !important;
    font-size: 13px;
    font-weight: 600;
}

/* 6. Checkbox æ ·å¼å¾®è°ƒï¼šå˜åœ†æ¶¦ä¸€ç‚¹ */
.world-checkbox {
    -webkit-appearance: none;
    appearance: none;
    width: 24px !important;
    height: 24px !important;
    border: 2px solid #C7C7CC;
    border-radius: 50% !important; /* å˜æˆåœ†å½¢çš„å‹¾é€‰æ¡† */
    outline: none;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.world-checkbox:checked {
    background-color: #007AFF;
    border-color: #007AFF;
}

.world-checkbox:checked::after {
    content: '';
    position: absolute;
    top: 4px; left: 8px;
    width: 5px; height: 10px;
    border: solid white;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
}
/* --- ğŸŒ€ é‡å­è§£æä¸“ç”¨åŠ¨æ•ˆ --- */
.quantum-loader-overlay {
    position: absolute; inset: 0;
    background: rgba(242, 242, 247, 0.9);
    z-index: 1000; display: none;
    flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}

.quantum-spinner {
    width: 60px; height: 60px;
    border: 3px solid rgba(0, 122, 255, 0.1);
    border-top: 3px solid #007AFF;
    border-radius: 50%;
    animation: qSpin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
}

.quantum-status-text {
    margin-top: 20px; font-size: 13px; font-weight: 700;
    color: #007AFF; letter-spacing: 1px;
    font-family: monospace;
}

/* è¿›åº¦æ¡æ ·å¼ */
.q-progress-container {
    width: 200px; height: 4px; background: #e5e5ea;
    border-radius: 10px; margin-top: 15px; overflow: hidden;
}
.q-progress-bar {
    width: 0%; height: 100%; background: #007AFF;
    transition: width 0.4s ease;
}

@keyframes qSpin { to { transform: rotate(360deg); } }

/* NPC å¡ç‰‡æ»‘å…¥åŠ¨æ•ˆ */
.npc-arrival {
    animation: npcSlideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    opacity: 0; transform: translateY(20px);
}
@keyframes npcSlideIn { to { opacity: 1; transform: translateY(0); } }
/* --- ğŸ­ NPC è¯¦æƒ…èµ„æ–™å¡ --- */
.npc-detail-card {
    width: 320px;
    background: #fff;
    border-radius: 36px;
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.25);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

.npc-pre-header {
    height: 180px;
    background: #1d1d1f;
    position: relative;
    overflow: hidden;
}

.npc-pre-banner {
    width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0.5;
    filter: blur(5px);
}

/* --- ä¿®å¤åçš„å¤´åƒæ ·å¼ --- */
.npc-pre-avatar {
    width: 110px; height: 110px;
    border: 5px solid #fff; /* ç™½è¾¹ä¸€å®šè¦åšï¼Œæ‰èƒ½æŠŠæ·±è‰²èƒŒæ™¯éš”å¼€ */
    border-radius: 32px;
    position: absolute;
    /* ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šä» -40px æ”¹ä¸º -20pxï¼ŒæŠŠå®ƒå¾€ä¸Šæï¼ */
    bottom: -20px !important; 
    left: 30px;
    object-fit: cover;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); /* ç¨å¾®åŠ æ·±ä¸€ç‚¹é˜´å½±ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
    transform: rotate(-3deg); /* ä¿æŒè¿™ä¸ªä¿çš®çš„å€¾æ–œè§’ */
    z-index: 2; /* ç¡®ä¿å®ƒå‹åœ¨ä¸€åˆ‡å†…å®¹ä¸Šé¢ */
}

.npc-pre-body {
    padding: 55px 25px 30px 25px;
}

.npc-pre-name {
    font-family: serif;
    font-size: 24px;
    font-weight: 800;
    color: #000;
}

.npc-pre-role {
    display: inline-block;
    font-size: 10px;
    font-weight: 800;
    color: #007AFF;
    background: rgba(0,122,255,0.08);
    padding: 3px 10px;
    border-radius: 20px;
    margin-top: 5px;
    letter-spacing: 1px;
}

.npc-pre-bio {
    margin-top: 20px;
    font-size: 14px;
    color: #444;
    line-height: 1.7;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 20px;
    font-style: italic;
}

/* --- ğŸ­ NPC åº•éƒ¨å·¥å…·æ ï¼šå½»åº•èåˆç‰ˆ --- */
.npc-pre-footer {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;           /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    padding: 15px 20px;  /* æ•´ä½“å†…è¾¹è· */
    background: #ffffff; /* ğŸ‘ˆ ç¡®ä¿è¿™é‡Œå’Œä½ å¡ç‰‡çš„åº•è‰²å®Œå…¨ä¸€æ · */
    width: 100%;
    box-sizing: border-box;
}

/* æŒ‰é’®åŸºç¡€ï¼šç‰©ç†åŒ…è£¹é€»è¾‘ */
.npc-btn-main {
    flex: 1;             /* å¹³åˆ†å®½åº¦ */
    height: 44px;        /* æ ‡å‡† iOS äº¤äº’é«˜åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;            /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    border-radius: 22px; /* èƒ¶å›Šå½¢çŠ¶ï¼Œç¡®ä¿å…ƒç´ è¢«å®Œæ•´åŒ…è£¹ */
    border: none;
    cursor: pointer;
    overflow: hidden;    /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢å…ƒç´ æº¢å‡º */
    transition: all 0.2s ease;
}

/* æŒ‰é’®å†…çš„æ–‡å­—è®¾ç½® */
.npc-btn-main span {
    font-size: 13px;
    font-weight: 700;
    white-space: nowrap; /* å¼ºåˆ¶æ–‡å­—åœ¨ä¸€è¡Œï¼Œä¸ä¹±è·‘ */
}

/* æŒ‰é’®å†…çš„å›¾æ ‡è®¾ç½® */
.npc-btn-main svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;      /* é˜²æ­¢å›¾æ ‡è¢«æŒ¤å‹å˜å½¢ */
}

/* 1. å·¦ä¾§ï¼šæŸ¥çœ‹å¾€äº‹ï¼ˆä½è°ƒèåˆè‰²ï¼‰ */
.npc-btn-main.past-btn {
    background: #f2f2f7; /* iOS ç³»ç»Ÿæ¬¡è¦è‰²ï¼Œå’Œç™½è‰²èƒŒæ™¯éå¸¸æ­ */
    color: #3a3a3c;
}

/* 2. å³ä¾§ï¼šAdd Friendï¼ˆé«˜äº®å¯¹æ¯”è‰²ï¼‰ */
.npc-btn-main.add {
    background: #1d1d1f; /* çº¯æ·±è‰²ï¼Œçªå‡ºæ ¸å¿ƒæ“ä½œ */
    color: #ffffff;
}

/* çŠ¶æ€åˆ‡æ¢ï¼šç‚¹å‡»æ—¶çš„ç¼©æ”¾åé¦ˆ */
.npc-btn-main:active {
    transform: scale(0.95);
    background-opacity: 0.8;
}

/* æˆåŠŸçŠ¶æ€ */
.npc-btn-main.sent {
    background: #34C759 !important;
    color: white !important;
}
/* --- ğŸš¨ ç¤¾äº¤å…³ç³»è§†è§‰åŒºåˆ†è¡¥ä¸ --- */

/* æ ¸å¿ƒçº½å¸¦ï¼šå¸¦æ·¡æ·¡çš„å‘¼å¸è“å…‰ */
.char-card.npc-core {
    border: 2px solid rgba(0, 122, 255, 0.4) !important;
    box-shadow: 0 10px 25px rgba(0, 122, 255, 0.15) !important;
}
.char-card.npc-core::before {
    content: "CORE BOND";
    position: absolute; top: 8px; left: 8px;
    background: #007AFF; color: #fff;
    font-size: 7px; font-weight: 900; padding: 2px 6px;
    border-radius: 4px; z-index: 5;
}

/* æ‰©å±•å…³ç³»å¡ç‰‡ï¼šæ™®é€šç™½ */
.char-card.npc-associate {
    border: 1px solid rgba(0,0,0,0.05);
}

/* åº•éƒ¨â€œç»§ç»­ç”Ÿæˆâ€æŒ‰é’®æ ·å¼ */
.relation-footer-tools {
    width: 100%; padding: 20px 0 60px 0;
    display: flex; justify-content: center;
}
.btn-extend-network {
    background: #ffffff; color: #1d1d1f;
    border: 1.5px solid #1d1d1f;
    width: 180px; padding: 12px;
    border-radius: 14px; font-size: 13px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-extend-network:active { transform: scale(0.95); }

/* æ•…äº‹æŸ¥çœ‹å™¨å¼¹çª—èƒŒæ™¯ */
.story-reading-layer {
    background: #fff; padding: 30px 25px; border-radius: 30px 30px 0 0;
    height: 70vh; overflow-y: auto; text-align: justify;
}
/* --- ğŸ“¡ å¥½å‹ç”³è¯·ï¼šé‡å­ä¿¡å·ä¼ è¾“åŠ¨æ•ˆåŠ å›º --- */
/* --- ğŸ“¡ é‡å­è§£æåŠ¨æ•ˆåŠ å›º --- */
#npc-add-btn.sending {
    background: #007AFF !important;
    color: white !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

#npc-add-btn.sending::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.4) 50%, 
        transparent 100%);
    animation: signalScan 1.5s infinite linear;
    z-index: 5;
}

@keyframes signalScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

/* æˆåŠŸçŠ¶æ€ */
#npc-add-btn.sent {
    background: #34C759 !important;
    transition: background 0.5s ease;
}
/* --- ğŸ“œ å¾€äº‹è§£å¯†å®¹å™¨ --- */
#npc-past-container {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
    border-left: 3px solid #007AFF; /* ç§‘æŠ€è“è¾¹æ¡† */
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    color: #e0e0e0;
    display: none; /* é»˜è®¤éšè— */
    position: relative;
    overflow: hidden;
}

/* è§£å¯†è¿‡ç¨‹ä¸­çš„æ‰«æçº¿ */
#npc-past-container.decrypting::before {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 2px;
    background: #007AFF;
    box-shadow: 0 0 10px #007AFF;
    animation: scanDown 2s infinite linear;
}

@keyframes scanDown {
    0% { top: 0; opacity: 0; }
    20% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

/* æ–‡å­—å‡ºç°çš„æ‰“å­—æœºæ•ˆæœ */
.typing-effect {
    overflow: hidden; /* ä¿è¯æ–‡å­—ä¸æº¢å‡º */
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
    animation: typing 0.05s steps(1) forwards;
}

/* æŒ‰é’®åŠ è½½æ—¶çš„è„‰å†² */
.btn-pulsing {
    animation: pulseBlue 1.5s infinite;
    pointer-events: none; /* åŠ è½½æ—¶ç¦æ­¢ç‚¹å‡» */
    opacity: 0.8;
}

@keyframes pulseBlue {
    0% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
}
/* ä¿¡å·æ‰«æçŠ¶æ€ - ç»™åŸæœ¬çš„æŒ‰é’®åŠ ç‰¹æ•ˆ */
.npc-btn-main.scanning {
    background: #1d1d1f !important;
    color: #007AFF !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

.npc-btn-main.scanning::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 122, 255, 0.4), transparent);
    animation: btnScan 1.2s infinite linear;
}

@keyframes btnScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

/* æ•…äº‹æ–‡æœ¬è§£å¯†æ‰“å­—æœºæ•ˆæœ */
.decrypt-text {
    font-family: serif;
    line-height: 1.8;
    color: #444;
    white-space: pre-wrap;
}
/* --- ğŸ† å¾€äº‹å¡ç‰‡ç»ˆæå±‚çº§ç½®é¡¶ --- */
#modal-vibe-result {
    display: none; 
    position: fixed !important;
    inset: 0 !important;
    /* ğŸš¨ å…³é”®ï¼šå¿…é¡»æ¯” 40000 è¿˜è¦å¤§ï¼ */
    z-index: 99999 !important; 
    background: rgba(0, 0, 0, 0.7) !important;
    backdrop-filter: blur(15px) !important;
    align-items: center !important;
    justify-content: center !important;
}

/* ç¡®ä¿å†…éƒ¨å¡ç‰‡æ ·å¼æ­£å¸¸ */
#modal-vibe-result .aesthetic-card {
    width: 90% !important;
    max-width: 340px !important;
    height: 75vh !important;
    display: flex !important;
    flex-direction: column !important;
    background: #fff !important;
    border-radius: 32px !important;
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
}
/* æ¡£æ¡ˆå¡ç‰‡ä¸“å±æ ·å¼è¡¥ä¸ */
.past-magazine-style {
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    background: #fff !important;
    animation: magazinePop 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
}

@keyframes magazinePop {
    from { opacity: 0; transform: scale(0.9) translateY(40px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* è§£å¯†ä¸­çš„æŒ‰é’®åŠ¨æ€æ•ˆæœ */
.npc-btn-main.decoding {
    background: #1d1d1f !important;
    color: #007AFF !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

.npc-btn-main.decoding::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 122, 255, 0.3), transparent);
    animation: decodeScan 1.2s infinite linear;
}

@keyframes decodeScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

#past-text-body {
    font-family: "SF Pro Display", serif;
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    padding-bottom: 30px;
}
/* --- ğŸ­ NPC è¯¦æƒ…å¡ï¼šä¸‰æŒ‰é’® UI å®Œç¾è¡¥ä¸ --- */
.npc-pre-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px; 
    padding: 5px 20px 35px 20px; /* ğŸ‘ˆ é¡¶éƒ¨ç¼©å‡ï¼Œåº•éƒ¨ç•™ç™½ */
    background: transparent !important; /* ğŸ‘ˆ æ ¸å¿ƒï¼šç‰©ç†æ¶ˆé™¤ç™½è‰²çªå…€æ–¹å— */
    width: 100%;
    box-sizing: border-box;
}

/* æŒ‰é’®åŸºç¡€å®¹å™¨ */
.npc-btn-action {
    height: 40px;
    border-radius: 12px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 11px;
    font-weight: 800;
    overflow: hidden; /* ç¡®ä¿å†…å®¹è¢«å®Œç¾åŒ…è£¹ */
}

/* å¾€äº‹ & æ„Ÿå…´è¶£ï¼šæµ…è‰²æ ·å¼ */
.npc-btn-action.minor {
    flex: 1;
    background: #f2f2f7;
    color: #1d1d1f;
}

/* åŠ å¯†å‹ï¼šæ·±è‰²é«˜å¯¹æ¯”æ ·å¼ */
.npc-btn-action.main {
    flex: 2; /* è®©åŠ å¯†å‹æŒ‰é’®å®½ä¸€ç‚¹ï¼Œæ›´æœ‰ç‚¹å‡»æ¬² */
    background: #1d1d1f;
    color: #ffffff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.npc-btn-action:active { transform: scale(0.95); opacity: 0.8; }

/* å›¾æ ‡å¤§å°é”å®š */
.npc-btn-action svg { width: 16px; height: 16px; flex-shrink: 0; }

/* ä¿¡å·æ‰«ææ•ˆæœ (åŠ å¯†å‹ä¸“ç”¨) */
.npc-btn-action.syncing {
    background: #007AFF !important;
    pointer-events: none;
}
/* --- ğŸ–¤ æœ¬æˆ‘æ¡£æ¡ˆä¸“å±æ ·å¼è¡¥ä¸ --- */
.user-profile-style {
    border: 1px solid #1d1d1f !important;
    box-shadow: 0 30px 80px rgba(0,0,0,0.3) !important;
}

#subpage-user-profile .app-body {
    display: block !important;
    width: 100% !important;
}

#user-bio-in {
    font-family: "PingFang SC", sans-serif;
    font-size: 15px;
    color: #3a3a3c;
    border-radius: 18px !important;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
}

/* è°ƒæ•´è®¾ç½®é¡µä¸­çš„â€œæˆ‘çš„èµ„æ–™â€å…¥å£ï¼Œç¡®ä¿ç‚¹å‡»æœ‰æ•ˆ */
.standalone-btn.user-entry {
    background: #1d1d1f !important;
    color: #fff !important;
    margin-bottom: 20px;
}
/* è®©æŒ‰é’®çœ‹èµ·æ¥æ›´é«˜çº§ï¼Œå…¨åŒ…è£¹ä¸çªå…€ */
.sub-setting-btn.user-btn-main {
    background: #1d1d1f !important; /* çº¯é»‘ä¸»æŒ‰é’® */
    color: #fff !important;
    border-radius: 12px;
    margin-bottom: 10px !important;
    font-weight: 700;
}

.sub-setting-btn.user-btn-secondary {
    background: #f2f2f7 !important; /* æµ…ç°æ¬¡è¦æŒ‰é’® */
    color: #1d1d1f !important;
    border-radius: 12px;
    margin-top: 0 !important;
    font-weight: 600;
}
/* å¼ºåˆ¶å­é¡µé¢æ˜¾å½±é€»è¾‘ */
#subpage-user-profile.active {
    transform: translateX(0) !important;
    display: flex !important;
}

/* ç¼–è¾‘é¡µå†…æ–‡å­—åŸŸé«˜çº§æ„Ÿ */
#user-bio-in {
    border-radius: 14px !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);
    font-family: inherit;
    resize: none;
}
/* å¼ºåˆ¶è¦†ç›–åŸæœ‰çš„å­é¡µé¢æ¿€æ´»é€»è¾‘ */
.ios-sub-page.active {
    display: flex !important;    /* å¿…é¡»åŠ è¿™ä¸€è¡Œï¼Œå¦åˆ™é¡µé¢æ°¸è¿œæ˜¯éšè—çš„ */
    transform: translateX(0) !important;
    z-index: 15000 !important;   /* ç¡®ä¿å®ƒåœ¨æœ€é¡¶å±‚ï¼Œç›–è¿‡è®¾ç½® App */
}
/* --- ğŸï¸ åˆ—è¡¨é¡µç¾åŒ– --- */
.memory-hero-banner {
    padding: 30px 20px;
    text-align: left;
}
.hero-label { font-size: 10px; font-weight: 900; color: #007AFF; letter-spacing: 3px; }
.hero-title { font-size: 34px; font-weight: 800; color: #1d1d1f; margin-top: 5px; }
.hero-subtitle { font-size: 13px; color: #8e8e93; margin-top: 5px; }

.memory-grid-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    padding: 10px 20px 120px 20px;
}

/* è®°å¿†å¡ç‰‡è®¾è®¡ */
.memory-item-card {
    position: relative;
    background: #fff;
    border-radius: 28px;
    padding: 24px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.02);
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    cursor: pointer;
}
.memory-item-card:active { transform: scale(0.96); }

.card-num {
    position: absolute; right: -10px; top: -10px;
    font-size: 80px; font-weight: 900; color: rgba(0,0,0,0.03);
    font-style: italic; pointer-events: none;
}

/* --- ğŸï¸ åˆ—è¡¨ä¸å¸ƒå±€ --- */
.memory-hero-area { padding: 40px 20px 20px; }
.hero-tag { font-size: 10px; font-weight: 900; color: #007AFF; letter-spacing: 4px; }
.hero-title { font-size: 36px; font-weight: 800; color: #1d1d1f; }
.hero-desc { font-size: 14px; color: #8e8e93; margin-top: 8px; }

.memory-stagger-grid { display: flex; flex-direction: column; gap: 20px; padding: 10px 20px 120px; }

/* è®°å¿†å¡ç‰‡æ ·å¼ */
.memory-item-card {
    background: #fff; border-radius: 30px; padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.04);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    cursor: pointer; position: relative; border: 1px solid rgba(0,0,0,0.02);
}
.memory-item-card:active { transform: scale(0.95) translateY(5px); }

/* --- ğŸ¬ æ²‰æµ¸å¼ç”µå½±è§†å›¾ --- */
.cinema-portal {
    position: fixed !important; inset: 0 !important;
    z-index: 999999 !important; background: #000;
    display: none; opacity: 0; transition: opacity 0.5s ease;
}
.cinema-portal.active { opacity: 1; display: flex; }

.cinema-stage { width: 100%; height: 100%; background: #fff; animation: cinemaSlideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes cinemaSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.cinema-scroll-layer { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.cinema-hero-banner { height: 60vh; width: 100%; position: relative; }
.cinema-hero-banner img { width: 100%; height: 100%; object-fit: cover; }
.cinema-hero-mask { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 40%, #fff 98%); }

.cinema-title-box { position: absolute; bottom: 40px; left: 30px; right: 30px; }
#cinema-title-ui { font-size: 32px; font-weight: 800; color: #1d1d1f; line-height: 1.2; }

.cinema-text-wrapper { padding: 0 30px 100px; }
.cinema-prose { font-family: "PingFang SC", serif; font-size: 18px; line-height: 2; color: #2c2c2e; text-align: justify; white-space: pre-wrap; }

/* --- ğŸŒ€ é‡å­ç»‡ç½‘åŠ¨ç”» --- */
.quantum-overlay {
    position: fixed; inset: 0; background: rgba(255,255,255,0.9);
    z-index: 1000000; display: none; flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}
.weaving-core { width: 50px; height: 50px; position: relative; animation: qRotate 4s linear infinite; }
.spider-line { position: absolute; top: 50%; left: 50%; width: 100%; height: 2px; background: #007AFF; transform-origin: center; animation: qPulse 1.5s ease-in-out infinite; }
@keyframes qRotate { to { transform: rotate(360deg); } }
@keyframes qPulse { 0%, 100% { transform: translate(-50%,-50%) scaleX(0.2); opacity: 0.2; } 50% { transform: translate(-50%,-50%) scaleX(1); opacity: 1; } }
.weaving-text { margin-top: 30px; font-size: 13px; font-weight: 700; color: #007AFF; letter-spacing: 2px; }
/* --- ğŸ’ é«˜çº§æ„Ÿï¼šå”¤é†’æŒ‰é’®ç¾åŒ– --- */
.memory-footer-bar {
    position: absolute; bottom: 30px; left: 0; width: 100%;
    display: flex; justify-content: center; padding: 0 20px; z-index: 100;
}

.btn-awaken-core {
    width: 100%; max-width: 320px; height: 60px;
    background: linear-gradient(135deg, #1d1d1f 0%, #3a3a3c 100%); /* æ·±è‰²æ‹‰ä¸è´¨æ„Ÿ */
    color: #fff; border-radius: 20px; border: none;
    display: flex; align-items: center; justify-content: center;
    gap: 12px; font-size: 16px; font-weight: 700; letter-spacing: 1px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3); /* è¶…æ·±é˜´å½± */
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    position: relative; overflow: hidden;
}

.btn-awaken-core:active {
    transform: scale(0.96) translateY(3px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* æŒ‰é’®æ‰«å…‰ç‰¹æ•ˆ */
.btn-awaken-core::after {
    content: ""; position: absolute; top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: btnShine 3s infinite;
}

@keyframes btnShine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* è®°å¿†å¡ç‰‡å¾®è°ƒ */
.memory-item-card {
    background: #fff; border-radius: 24px; padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.01);
}
/* --- ğŸ’ é«˜çº§æ„Ÿï¼šå”¤é†’æŒ‰é’® --- */
.memory-footer-bar {
    position: absolute; bottom: 35px; left: 0; width: 100%;
    display: flex; justify-content: center; padding: 0 25px; z-index: 100;
}

.btn-awaken-core {
    width: 100%; max-width: 320px; height: 64px;
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%); /* æè‡´ç£¨ç ‚é»‘ */
    color: #fff; border-radius: 22px; border: none;
    display: flex; align-items: center; justify-content: center;
    gap: 15px; font-size: 16px; font-weight: 700; letter-spacing: 2px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.1);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative; overflow: hidden;
    cursor: pointer;
}

/* æŒ‰é’®æ‰«å…‰ç‰¹æ•ˆ */
.btn-awaken-core::after {
    content: ""; position: absolute; top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.08), transparent);
    transform: rotate(45deg);
    animation: btnShine 4s infinite;
}

@keyframes btnShine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

.btn-awaken-core:active {
    transform: scale(0.96) translateY(4px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
/* --- ğŸš¨ çŠ¶æ€æ å¼ºåˆ¶ç½®é¡¶è¡¥ä¸ --- */
.status-bar {
    z-index: 1000005 !important; /* ç»å¯¹æœ€é«˜å±‚çº§ï¼Œç¡®ä¿åœ¨æ•…äº‹é¡µé¢ä¹‹ä¸Š */
    position: relative;
    background: transparent; /* ä¿æŒé€æ˜ï¼Œå¯ä»¥çœ‹åˆ°åé¢çš„å¤§å›¾ */
}

/* --- ğŸ¬ ç”µå½±è¯¦æƒ…é¡µï¼šç‰©ç†ä¸‹ç§»ä¸å±‚çº§è°ƒæ•´ --- */
.cinema-portal {
    position: fixed !important;
    inset: 0 !important;
    background: #ffffff;
    z-index: 1000000 !important; /* ä½äºçŠ¶æ€æ ï¼Œé«˜äºæ™®é€šé¡µé¢ */
    display: none; 
    opacity: 0;
    transition: opacity 0.5s ease;
    flex-direction: column;
}

/* å½“é¡µé¢æ¿€æ´»æ—¶ */
.cinema-portal.active {
    display: flex !important;
    opacity: 1 !important;
}

/* æ ¸å¿ƒæ»šåŠ¨å±‚ï¼šå¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œé¿å¼€çŠ¶æ€æ  */
.cinema-scroll-layer {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 48px; /* ğŸš¨ ç‰©ç†é¿è®©ï¼šè¿™é‡Œçš„é«˜åº¦å¿…é¡»ç­‰äºæˆ–å¤§äºçŠ¶æ€æ é«˜åº¦ */
}

/* --- âŒ å¼ºåŠ›æ˜¾å½¢ï¼šå…³é—­æŒ‰é’® --- */
.cinema-close-trigger {
    position: fixed; /* æ”¹ä¸º fixedï¼Œç¡®ä¿ä¸éšé¡µé¢æ»šåŠ¨æ¶ˆå¤± */
    top: 60px;       /* æ”¾åœ¨çŠ¶æ€æ ä¸‹æ–¹ä¸€ç‚¹ */
    right: 20px;
    z-index: 1000010; /* ç”šè‡³æ¯”çŠ¶æ€æ è¿˜è¦é«˜ï¼Œç¡®ä¿èƒ½ç‚¹åˆ° */
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.5); /* åŠé€æ˜é»‘ï¼Œç¡®ä¿åœ¨ç™½è‰²èƒŒæ™¯æˆ–å›¾ç‰‡ä¸Šéƒ½èƒ½çœ‹æ¸… */
    backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    align-items: center;
    justify-content: center;
    color: #ffffff;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.cinema-close-trigger svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
}

/* æŒ‰é’®ç‚¹å‡»åé¦ˆ */
.cinema-close-trigger:active {
    transform: scale(0.9);
    background: rgba(0, 0, 0, 0.8);
}
/* ğŸš‘ å¤´éƒ¨é—´è·ä¿®æ­£è¡¥ä¸ï¼šè§£å†³é¡¶éƒ¨ç©ºç™½è¿‡å¤§çš„é—®é¢˜ */

/* 1. é’ˆå¯¹æ‰€æœ‰å­é¡µé¢çš„é€šç”¨ä¿®æ­£ */
.ios-sub-page .app-header {
    padding-top: 55px !important;  /* ä» 80px ç¼©å‡åˆ° 55px */
    min-height: 90px !important;   /* ç¼©å°ä¿åº•æ€»é«˜åº¦ */
    padding-bottom: 10px !important;
}

/* 2. ä¸“é—¨é’ˆå¯¹â€œæ—¶ç©ºæ¡£æ¡ˆåº“â€é¡µé¢çš„ç»†èŠ‚å¾®è°ƒ */
#subpage-memory-list .app-header {
    padding-top: 55px !important;
    padding-bottom: 12px !important;
    background: #ffffff !important; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ï¼Œä¸é€å‡ºåº•è‰² */
}

/* 3. é¡ºä¾¿å¾®è°ƒä¸€ä¸‹è¿”å›æŒ‰é’®å’Œæ ‡é¢˜çš„å¯¹é½ï¼Œè®©å®ƒæ›´ç²¾è‡´ */
.ios-sub-page .header-left, 
.ios-sub-page .header-title {
    margin-bottom: 2px !important;
}
/* --- ğŸï¸ ç”µå½±æ„Ÿè§†ç•Œï¼šé»‘ç™½é«˜å®šæ’ç‰ˆ --- */
.cinema-prose {
    font-family: "PingFang SC", "STHeiti", serif;
    font-size: 17px;
    line-height: 2.2; /* æå…¶å®½æ•çš„è¡Œé—´è· */
    color: #000000;
    text-align: justify;
    padding-bottom: 50px;
}

/* ğŸš¨ æ ¸å¿ƒï¼šæ®µè½é—´è· */
.cinema-prose p {
    margin-bottom: 28px; /* ç»™æ®µè½ä¹‹é—´ç•™å‡ºå‘¼å¸ç©ºé—´ */
    display: block;
}

/* ğŸš¨ é‡ç‚¹ï¼šã€ ã€‘å†…çš„æ ¸å¿ƒè¯ï¼ˆé»‘åº•ç™½å­—ï¼‰ */
.memory-highlight {
    background-color: #000000;
    color: #ffffff;
    padding: 2px 8px;
    margin: 0 3px;
    border-radius: 2px;
    font-weight: 600;
    font-style: normal;
    display: inline-block;
}

/* ğŸš¨ é‡ç‚¹ï¼šã€Œ ã€å†…çš„æ„Ÿå®˜ç»†èŠ‚ï¼ˆåŠ ç²—ä¸‹åˆ’çº¿ï¼‰ */
.memory-focus {
    border-bottom: 1.5px solid #000000;
    font-weight: 800;
    padding-bottom: 1px;
}
/* --- ğŸï¸ è®°å¿†å¡ç‰‡å·¦æ»‘åˆ é™¤è¡¥ä¸ --- */
.memory-swipe-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden; /* éšè—æº¢å‡ºçš„åˆ é™¤æŒ‰é’® */
    border-radius: 28px; /* ä¿æŒåœ†è§’ä¸€è‡´ */
    margin-bottom: 18px;
    background-color: #FF3B30; /* æ»‘å¼€åéœ²å‡ºçš„åº•è‰²æ˜¯çº¢è‰² */
}

.memory-swipe-content {
    position: relative;
    width: 100%;
    background: #ffffff;
    z-index: 2; /* ç›–åœ¨æŒ‰é’®ä¸Šé¢ */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: transform;
}

.memory-swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 80px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    color: #fff;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
}
/* --- ğŸšï¸ è®°å¿†æ€»ç»“ä¸“å±æ»‘åŠ¨æ¡ç¾åŒ– --- */
#subpage-memory-summary .ios-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: #e5e5ea;
    border-radius: 10px;
    outline: none;
    /* åŠ¨æ€å¡«å……è‰²ï¼šå·¦é»‘å³ç° */
    background-image: linear-gradient(#000, #000);
    background-size: var(--percent, 20%) 100%;
    background-repeat: no-repeat;
}

#subpage-memory-summary .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 28px;
    width: 28px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2), 0 0 0 0.5px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.1s;
}

#subpage-memory-summary .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.15);
}
/* ==========================================
   ğŸš¨ ç‰©ç†é”æ­»ï¼šè®°å¿†æ€»ç»“é¡µå…¨å®½æ‹‰ä¼¸
   ========================================== */

/* 1. å¼ºåˆ¶ä¸»ä½“å®¹å™¨ä¸è®¸å±…ä¸­ï¼Œå æ»¡ 100% */
#subpage-memory-summary .app-body {
    display: block !important;          /* âŒ åœç”¨ Flex å±…ä¸­ï¼Œæ¢å¤å—çº§æµ */
    width: 100% !important;
    padding: 20px 16px !important;      /* å·¦å³ä¿ç•™ 16px æ ‡å‡†è¾¹è·ï¼Œå…¶ä½™å…¨éƒ¨æ‹‰æ»¡ */
    max-width: none !important;
    box-sizing: border-box !important;
}

/* 2. å¼ºåˆ¶å†…éƒ¨å¡ç‰‡ç»„å æ»¡å±å¹• */
#subpage-memory-summary .ios-list-group {
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    display: block !important;           /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´å †å  */
    box-sizing: border-box !important;
}

/* 3. å¼ºåˆ¶æ»‘å—è½¨é“æ’‘æ»¡ 100% */
#subpage-memory-summary .ios-slider {
    width: 100% !important;
    margin: 30px 0 !important;           /* å¢åŠ ä¸Šä¸‹é—´è·ï¼Œæ›´æ˜¾å¤§æ°” */
    display: block !important;
}

/* 4. ä¿®å¤æ ‡é¢˜æ–‡å­—å¯¹é½ */
#subpage-memory-summary .tz-group-title {
    text-align: left !important;
    padding-left: 4px !important;
    width: 100% !important;
}

/* 5. è°ƒæ•´æ•°å­—æ˜¾ç¤ºçš„ä½ç½® */
#summary-rounds-val {
    font-size: 50px !important;
    font-weight: 800 !important;
    color: #000;
}
/* --- ğŸ““ è®°å¿†æ€»ç»“å¡ç‰‡ï¼šé»‘ç™½æ¡£æ¡ˆé£ --- */
.summary-card {
    background: #fff;
    border: 1.5px solid #000;
    border-radius: 20px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    animation: cardFadeIn 0.4s ease-out;
}

.summary-card::before {
    content: "CORE MEMORY";
    position: absolute;
    top: 10px; right: -25px;
    background: #000;
    color: #fff;
    font-size: 8px;
    font-weight: 900;
    padding: 2px 30px;
    transform: rotate(45deg);
}

.summary-date {
    font-size: 10px;
    color: #8e8e93;
    font-family: monospace;
    margin-bottom: 10px;
    display: block;
}

.summary-content {
    font-size: 14px;
    line-height: 1.7;
    color: #1d1d1f;
    font-family: serif;
    font-style: italic;
}

.btn-delete-summary {
    position: absolute;
    bottom: 15px; right: 20px;
    font-size: 11px;
    color: #FF3B30;
    font-weight: 700;
    cursor: pointer;
}

@keyframes cardFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ“± é€šçŸ¥ä¸­å¿ƒï¼šç‰©ç†å¢å¼ºç‰ˆ --- */
.notification-shade {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.4); /* åŠ æ·±åº•è‰² */
    backdrop-filter: blur(25px) saturate(160%);
    -webkit-backdrop-filter: blur(25px) saturate(160%);
    z-index: 100000; 
    display: none; /* åˆå§‹ç”± JS æ§åˆ¶æ˜¾ç¤º */
    flex-direction: column;
    transform: translateY(-100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    pointer-events: auto;
}

/* æ¿€æ´»çŠ¶æ€ */
.notification-shade.active {
    transform: translateY(0);
}

/* ğŸš¨ å…³é”®ï¼šæ‰‹åŠ¿æ„Ÿåº”åŒº (çŠ¶æ€æ éšå½¢å¤–æŒ‚) */
.status-bar {
    pointer-events: auto !important; /* ç¡®ä¿çŠ¶æ€æ èƒ½æŠ“åˆ°ç‚¹å‡»/æ»‘åŠ¨ */
}

/* é®ç½©å±‚é¡¶éƒ¨çš„æŠŠæ‰‹ */
.shade-handle {
    width: 40px; height: 5px; background: rgba(255,255,255,0.3);
    border-radius: 10px; margin: 15px auto;
}

/* --- ğŸ”” å®æ—¶æ¨é€æ¨ªå¹… (Push Banner) --- */
.ios-banner {
    position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
    width: 92%; max-width: 380px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 24px; padding: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    z-index: 110000; display: flex; align-items: center; gap: 12px;
    transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    cursor: pointer;
}

.ios-banner.show { top: 55px; } /* é¿å¼€çŠ¶æ€æ é«˜åº¦ */

.banner-icon { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
.banner-content { flex: 1; }
.banner-title { font-size: 13px; font-weight: 800; color: #000; margin-bottom: 2px; }
.banner-text { font-size: 12px; color: #333; line-height: 1.3; }
/* --- ğŸ“± é€šçŸ¥ä¸­å¿ƒï¼šå¸ƒå±€ä¸æ ‡é¢˜æ  --- */
.notification-shade {
    /* ...ä¿æŒä½ ä¹‹å‰çš„å›ºå®šå®šä½å’ŒèƒŒæ™¯æ¨¡ç³Šæ ·å¼... */
    display: none;
    flex-direction: column; /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
    justify-content: space-between; /* è®©å†…å®¹å’Œåº•éƒ¨æŠŠæ‰‹åˆ†å¼€ */
    padding-bottom: 20px; /* ç»™åº•éƒ¨æŠŠæ‰‹ç•™ä½ç½® */
    box-sizing: border-box;
}

/* æ–°å¢ï¼šæ¯›ç»ç’ƒæ ‡é¢˜æ  */
.notif-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 45px 20px 15px; /* é¿å¼€çŠ¶æ€æ é«˜åº¦ */
    background: rgba(255, 255, 255, 0.1); /* ææ·¡çš„ç™½è‰²é®ç½© */
    border-bottom: 0.5px solid rgba(255, 255, 255, 0.2); /* ç²¾è‡´åˆ†å‰²çº¿ */
}

.notif-title {
    font-size: 28px;
    font-weight: 800;
    color: #fff;
    letter-spacing: 0.5px;
}

/* æ¸…é™¤æŒ‰é’® */
.notif-clear-btn {
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.2s;
}
.notif-clear-btn:active {
    background: rgba(255,255,255,0.4);
    transform: scale(0.9);
}

/* åˆ—è¡¨å®¹å™¨ï¼šå¯æ»šåŠ¨ */
.notif-list-container {
    flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
    overflow-y: auto;
    padding: 20px 16px;
}

.notif-empty-state {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 14px;
    margin-top: 100px;
    font-weight: 500;
}

/* --- åº•éƒ¨æŠŠæ‰‹ (å–ä»£åŸæ¥çš„é¡¶éƒ¨æŠŠæ‰‹) --- */
.shade-handle-bottom {
    width: 45px;
    height: 5px;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 10px;
    margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
    flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
    cursor: pointer;
}
/* é€šçŸ¥æ¨ªå¹…åŸºç¡€æ ·å¼ */
.ios-banner {
    position: fixed;
    top: -100px; /* åˆå§‹è—åœ¨ä¸Šé¢ */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    z-index: 999999;
    display: flex;
    align-items: center;
    transition: top 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28); /* å¼¹æ€§æ»‘å…¥ */
    cursor: pointer;
}

/* æ˜¾ç¤ºæ—¶çš„çŠ¶æ€ */
.ios-banner.show {
    top: 20px;
}
/* 1. ä¿®å¤æ¶ˆæ¯åˆ—è¡¨æ¡å˜å½¢ï¼šå¼ºåˆ¶å•è¡Œæˆ–åŒè¡Œæˆªæ–­ */
.contact-preview {
    font-size: 13px;
    color: #8E8E93;
    margin-top: 2px;
    /* æ ¸å¿ƒä¿®å¤ï¼šè¶…å‡ºæ–‡å­—å˜çœç•¥å·ï¼Œä¸æ’‘å¼€é«˜åº¦ */
    display: -webkit-box !important;
    -webkit-line-clamp: 1; /* å¼ºåˆ¶åªæ˜¾ç¤º1è¡Œï¼Œä½ å¯ä»¥æ”¹æˆ2 */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal; /* è¦†ç›–å¯èƒ½å†²çªçš„ nowrap */
    word-break: break-all;
    max-height: 18px; /* é”å®šé«˜åº¦ï¼Œé˜²æ­¢æŠ–åŠ¨ */
}

/* 2. ä¿®å¤å¼¹çª—ä½ç½®ï¼šå‘ä¸‹å¹³ç§»ï¼Œé¿å¼€çŠ¶æ€æ (48px) */
.ios-banner {
    top: -120px; /* åˆå§‹ä½ç½®æ›´é ä¸Šï¼Œç¡®ä¿å½»åº•è—ä½ */
    transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
}

.ios-banner.show {
    top: 60px !important; /* çŠ¶æ€æ  48px + 12px ç•™ç™½ï¼Œé»„é‡‘æ¯”ä¾‹ */
}

/* 3. é€šçŸ¥ä¸­å¿ƒé‡Œçš„å¡ç‰‡æ ·å¼å¾®è°ƒï¼Œç¡®ä¿ç¾è§‚ */
.notif-item {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 18px;
    padding: 15px;
    margin-bottom: 12px;
    color: #fff;
    animation: msgFadeUp 0.4s ease;
}
/* ğŸš¨ ç‰©ç†ä¿®å¤ï¼šå­é¡µé¢åˆ—è¡¨å®½åº¦é”å®š */
#subpage-icon-picker .app-body {
    padding: 20px 16px !important; /* è¿˜åŸ iOS æ ‡å‡†ï¼šä¸Šä¸‹ 20pxï¼Œå·¦å³ 16px */
    display: block !important;      /* ç¡®ä¿å†…å®¹æŒ‰å—çº§æ’åˆ—ï¼Œä¸è¢« flex æŒ¤å‹å®½åº¦ */
    overflow-y: auto;
}

#icon-target-list {
    width: 100% !important;         /* å¼ºåˆ¶åˆ—è¡¨å®¹å™¨ 100% å®½åº¦ */
    margin: 0 auto !important;      /* å±…ä¸­å¯¹é½ */
}

/* ç¡®ä¿åˆ—è¡¨é¡¹å†…å®¹ä¹Ÿèƒ½æ’‘å¼€ */
#icon-target-list .ios-list-item {
    width: 100% !important;
}

#icon-target-list .item-content {
    flex: 1;                        /* è®©å†…å®¹åŒºè‡ªåŠ¨å¡«æ»¡å‰©ä½™ç©ºé—´ */
    padding-right: 8px;            /* ç»™å³ä¾§ç®­å¤´ç•™ç‚¹å‘¼å¸æ„Ÿ */
}
</style>
</head>
<body>

    <div class="status-bar">
        <div id="clock">12:00</div>
        <div class="status-right">
            <svg width="18" height="12" viewBox="0 0 18 12" fill="currentColor"><path d="M1 9h2v2H1zm4-3h2v5H5zm4-3h2v8H9zm4-3h2v11h-2z"/></svg>
            <div style="display:flex; align-items:center;">
                <span class="bat-text" id="bat-num">--%</span>
                <div class="battery-box"><div class="bat-fill" id="bat-bar"></div><div class="bat-tip"></div></div>
            </div>
        </div>
    </div>

    <div class="home-screen-scroll-container">
        <div class="home-screen-wrapper">
            
            <div class="main-container" id="page-1">
                <div class="widget w-2x2" onclick="showM('weatherM')">
                    <div class="weather-content">
                        <div class="w-date-block">
                            <span class="w-day" id="ui-day">MONDAY</span>
                            <span class="w-date" id="ui-date">JANUARY 1</span>
                        </div>
                        <div class="w-data-stack">
                            <div class="w-icon-area" id="ui-icon"></div>
                            <div class="w-temp" id="ui-temp">--Â°</div>
                            <div class="w-city">
                                <svg style="width:12px;height:12px;fill:#007AFF" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
                                <span id="ui-city">Updating...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="widget w-2x2" onclick="showM('photoM')">
                    <div class="pic-container">
                        <div class="pic-text" id="ui-quote">"Thinking Different."</div>
                        <div class="pic-wrapper">
                            <img id="ui-img" class="pic-img" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23f0f0f0'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-weight='bold' font-family='sans-serif'>Tap to Upload</text></svg>">
                        </div>
                    </div>
                </div>

                <div class="widget w-4x1">
                    <div class="music-row">
                        <div style="display:flex; align-items:center;">
                            <div class="album-cover"></div>
                            <div class="track-info">
                                <span class="track-title">Luxury Vibe</span>
                                <span class="track-artist">Lossless Audio</span>
                            </div>
                        </div>
                        <div class="ctrl-btns">
                            <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                            <svg style="width:32px;height:32px;fill:#333" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                        </div>
                    </div>
                </div>

                <div class="widget w-4x1">
                    <div class="prog-stack">
                        <div class="prog-header"><span>Daily Progress</span><span id="prog-txt">0.0%</span></div>
                        <div class="prog-bg"><div class="prog-fg" id="prog-bar"></div></div>
                    </div>
                </div>

                <div class="app-cell" onclick="openApp('wallApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><polyline points="21 15 16 10 5 21" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                    </div>
                    <span class="app-name">Wallpaper</span>
                </div>
                
                <div class="app-cell" onclick="openApp('settingsApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%); color: #3a3a3c;">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:34px; height:34px;"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" fill="currentColor"/></svg>
                    </div>
                    <span class="app-name">Settings</span>
                </div>

                <div class="app-cell" onclick="openChatApp()">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #007AFF 0%, #00C6FF 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="currentColor"/>
                        </svg>
                    </div>
                    <span class="app-name">Chat</span>
                </div>
                <div class="app-cell" onclick="openApp('galleryApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #FFD3A5 0%, #FD6585 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                    </div>
                    <span class="app-name">Photos</span>
                </div>

                <div class="app-cell" onclick="openApp('musicApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #fb3a4d 0%, #fb6470 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    </div>
                    <span class="app-name">Music</span>
                </div>

                <div class="app-cell" onclick="openApp('themeApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    </div>
                    <span class="app-name">Themes</span>
                </div>

                <div class="app-cell" onclick="openApp('phoneApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #28C940 0%, #5ee172 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    </div>
                    <span class="app-name">Phone</span>
                </div>

                <div class="app-cell" onclick="openApp('messageApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #21d4fd 0%, #b721ff 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <span class="app-name">Messages</span>
                </div>
            </div>

            <div class="main-container" id="page-2" style="display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr); gap: 16px; padding: 20px;">
    
                <div class="widget hero-cover-widget" style="grid-area: 1 / 1 / 3 / 5;" onclick="window.editHubField('hero')">
                    <div class="hero-image-wrapper">
                        <img id="hub-hero-img" src="https://images.unsplash.com/photo-1494438639946-1ebd1d20bf85?w=800&auto=format&fit=crop" alt="Hero">
                        <div class="hero-overlay"></div>
                    </div>
                    <div class="hero-content-text">
                        <span class="hero-tag" id="hub-hero-tag" onclick="event.stopPropagation(); window.editHubField('hero_tag')">FEATURED MOMENT</span>
                        
                        <h2 id="hub-hero-title" onclick="event.stopPropagation(); window.editHubField('hero_title')">Aesthetic Essence</h2>
                        
                        <p id="hub-hero-desc" onclick="event.stopPropagation(); window.editHubField('hero_desc')">"Design is intelligence made visible."</p>
                    </div>
                    
                    <div class="hero-edit-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    </div>
                </div>
                <div class="widget moment-card-widget" style="grid-area: 3 / 1 / 5 / 3;" onclick="window.editHubField('moment_img')">
                    <div class="moment-photo-area">
                        <img id="hub-moment-img" src="https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&auto=format&fit=crop" alt="Moment">
                        <div class="moment-edit-hint">Change Photo</div>
                    </div>
                    <div class="moment-text-area">
                        <h3 id="hub-moment-title" onclick="event.stopPropagation(); window.editHubField('moment_title')">Daily Focus</h3>
                        <p id="hub-moment-desc" onclick="event.stopPropagation(); window.editHubField('moment_desc')">Keep it simple, keep it real.</p>
                    </div>
                </div>

                <div class="app-cell" style="grid-area: 3 / 3 / 4 / 4;" onclick="window.openApp('vibe-grid-app')">
                    <div class="glass-icon-bg">
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                        </svg>
                    </div>
                    <span class="app-name">Vibe Grid</span>
                </div>

                <div class="app-cell" style="grid-area: 3 / 4 / 4 / 5;" onclick="openApp('diaryApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Diary</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                    </div>
                    <span class="app-name">Diary</span>
                </div>

                <div class="app-cell" style="grid-area: 4 / 3 / 5 / 4;" onclick="openApp('walletApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Wallet</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20M7 15h.01"/>
                        </svg>
                    </div>
                    <span class="app-name">Wallet</span>
                </div>

                <div class="app-cell" style="grid-area: 4 / 4 / 5 / 5;" onclick="openApp('notesApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Notes</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/>
                        </svg>
                    </div>
                    <span class="app-name">Notes</span>
                </div>

                <div class="widget vibe-bar-widget" style="grid-area: 5 / 1 / 6 / 5;" onclick="window.editHubField('vibe_img')">
                    <div class="vibe-bg-wrapper">
                        <img id="hub-vibe-img" src="https://images.unsplash.com/photo-1502759683299-cdcc6974244f?w=800&auto=format&fit=crop" alt="Vibe">
                        <div class="vibe-overlay"></div>
                    </div>
                    <span id="hub-vibe-text" onclick="event.stopPropagation(); window.editHubField('vibe_text')">Current Vibe: Serenity</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 1 / 7 / 2;" onclick="openApp('shoppingApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Shopping</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                    </div>
                    <span class="app-name">Shopping</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 2 / 7 / 3;" onclick="openApp('forumApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Forum</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                        </svg>
                    </div>
                    <span class="app-name">Forum</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 3 / 7 / 4;" onclick="openApp('novelApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Novels</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20V2H6.5A2.5 2.5 0 0 0 4 4.5v15z"/>
                        </svg>
                    </div>
                    <span class="app-name">Novels</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 4 / 7 / 5;" onclick="openApp('liveApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Live</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/>
                        </svg>
                    </div>
                    <span class="app-name">Live</span>
                </div>

                </div>

        </div>
    </div>

    <div class="dock-container">
        <div class="dock-bar">
            <div class="dock-app" data-app="RoleBook" onclick="openApp('charApp')" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                <span class="app-name" style="display: none;">RoleBook</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </div>

            <div class="dock-app" data-app="WorldBook" onclick="openApp('worldApp')" style="background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);">
                <span class="app-name" style="display: none;">WorldBook</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <circle cx="12" cy="12" r="3" fill="rgba(255,255,255,0.2)"/>
                </svg>
            </div>

            <div class="dock-app" data-app="Beautify" onclick="openApp('beautifyApp')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); position: relative;">
                <span class="app-name" style="display: none;">Beautify</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 8l-2 4h4l-2 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 2v2M12 20v2M2 12h2M20 12h2" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
                </svg>
            </div>

            <div class="dock-app" data-app="Icons" onclick="openApp('iconApp')" style="background: linear-gradient(135deg, #2af598 0%, #009efd 100%);">
                <span class="app-name" style="display: none;">Icons</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M17.5 14v7M14 17.5h7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        <div class="home-indicator"></div>
    </div>

    <div class="modal-overlay" id="weatherM" onclick="hideM('weatherM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top">
                <span class="modal-h1">Select City</span>
                <span class="modal-done" onclick="hideM('weatherM')">Done</span>
            </div>

            <div class="segment-control">
                <div class="segment-btn active" id="tab-cn" onclick="switchTab('cn')">China</div>
                <div class="segment-btn" id="tab-global" onclick="switchTab('global')">Global</div>
            </div>
            
            <div style="max-height: 55vh; overflow-y: auto; padding-right: 2px;">
                
                <div id="view-cn" class="city-view active">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">MAINLAND & HK/TW</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(39.9042, 116.4074, 'Beijing')">åŒ—äº¬</div>
                        <div class="city-tag" onclick="fetchW(31.2304, 121.4737, 'Shanghai')">ä¸Šæµ·</div>
                        <div class="city-tag" onclick="fetchW(23.1291, 113.2644, 'Guangzhou')">å¹¿å·</div>
                        <div class="city-tag" onclick="fetchW(22.5431, 114.0579, 'Shenzhen')">æ·±åœ³</div>
                        <div class="city-tag" onclick="fetchW(30.5728, 104.0668, 'Chengdu')">æˆéƒ½</div>
                        <div class="city-tag" onclick="fetchW(30.2741, 120.1551, 'Hangzhou')">æ­å·</div>
                        <div class="city-tag" onclick="fetchW(29.5630, 106.5516, 'Chongqing')">é‡åº†</div>
                        <div class="city-tag" onclick="fetchW(34.3416, 108.9398, 'Xi\'an')">è¥¿å®‰</div>
                        <div class="city-tag" onclick="fetchW(30.5928, 114.3055, 'Wuhan')">æ­¦æ±‰</div>
                        <div class="city-tag" onclick="fetchW(32.0603, 118.7969, 'Nanjing')">å—äº¬</div>
                        <div class="city-tag" onclick="fetchW(22.3193, 114.1694, 'Hong Kong')">é¦™æ¸¯</div>
                        <div class="city-tag" onclick="fetchW(25.0330, 121.5654, 'Taipei')">å°åŒ—</div>
                    </div>
                </div>

                <div id="view-global" class="city-view">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">ASIA & PACIFIC</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(35.6762, 139.6503, 'Tokyo')">Tokyo</div>
                        <div class="city-tag" onclick="fetchW(37.5665, 126.9780, 'Seoul')">Seoul</div>
                        <div class="city-tag" onclick="fetchW(1.3521, 103.8198, 'Singapore')">Singapore</div>
                        <div class="city-tag" onclick="fetchW(13.7563, 100.5018, 'Bangkok')">Bangkok</div>
                        <div class="city-tag" onclick="fetchW(-33.8688, 151.2093, 'Sydney')">Sydney</div>
                        <div class="city-tag" onclick="fetchW(25.2048, 55.2708, 'Dubai')">Dubai</div>
                    </div>

                    <div style="font-size:12px; color:#999; margin: 15px 0 8px 0; font-weight:700;">AMERICAS & EUROPE</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(40.7128, -74.0060, 'New York')">New York</div>
                        <div class="city-tag" onclick="fetchW(34.0522, -118.2437, 'Los Angeles')">L.A.</div>
                        <div class="city-tag" onclick="fetchW(43.6532, -79.3832, 'Toronto')">Toronto</div>
                        <div class="city-tag" onclick="fetchW(51.5074, -0.1278, 'London')">London</div>
                        <div class="city-tag" onclick="fetchW(48.8566, 2.3522, 'Paris')">Paris</div>
                        <div class="city-tag" onclick="fetchW(52.5200, 13.4050, 'Berlin')">Berlin</div>
                        <div class="city-tag" onclick="fetchW(55.7558, 37.6173, 'Moscow')">Moscow</div>
                        <div class="city-tag" onclick="fetchW(41.9028, 12.4964, 'Rome')">Rome</div>
                        <div class="city-tag" onclick="fetchW(40.4168, -3.7038, 'Madrid')">Madrid</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal-overlay" id="photoM" onclick="hideM('photoM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top"><span class="modal-h1">Customize</span><span class="modal-done" onclick="hideM('photoM')">Save</span></div>
            <input type="text" id="q-in" placeholder="Type your quote..." style="width:100%; padding:16px; background:#f2f2f7; border:none; border-radius:14px; font-size:16px;">
            <div class="upload-tools">
                <input type="file" id="f-in" style="display:none" accept="image/*" onchange="loadF(this)">
                <div class="tool-btn" onclick="document.getElementById('f-in').click()">Photo Library</div>
                <div class="tool-btn" onclick="loadU()">Paste URL</div>
            </div>
        </div>
    </div>

<video id="bg-video" autoplay loop muted playsinline style="position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; display:none;"></video>

<div id="wallApp" class="ios-app-window">
    <div class="app-header">
        <div class="header-title-big">Wallpaper</div>
        <div class="header-close-btn" onclick="closeApp('wallApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body">
        
        <div class="preview-stage" style="margin-top: 10px;">
            <div class="phone-frame">
                <img id="preview-img" src="" style="display:none;">
                <video id="preview-vid" autoplay loop muted playsinline style="display:none;"></video>
                <div class="preview-placeholder" id="preview-hint">Preview</div>
            </div>
        </div>

        <div class="segment-control" style="width: 100%; max-width: 300px;">
            <div class="segment-btn active" id="seg-img" onclick="switchWallTab('img')">Image</div>
            <div class="segment-btn" id="seg-vid" onclick="switchWallTab('vid')">Video</div>
        </div>

        <div class="action-area" id="panel-img" style="max-width: 300px;">
            <input type="file" id="upload-img" accept="image/*" style="display:none" onchange="handleWallFile(this, 'img')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-img').click()">+ New Image</button>
            <button class="ios-btn primary" onclick="setWallpaper('img')">Set Current</button>
        </div>

        <div class="action-area" id="panel-vid" style="display:none; max-width: 300px;">
            <input type="file" id="upload-vid" accept="video/*" style="display:none" onchange="handleWallFile(this, 'vid')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-vid').click()">+ New Video</button>
            <button class="ios-btn primary" onclick="setWallpaper('vid')">Set Current</button>
        </div>

        <div class="history-section">
            <div class="history-title">My Collection</div>
            <div class="history-grid" id="wall-history-grid">
                </div>
            <div style="text-align:center; color:#999; font-size:12px; margin-top:15px;">
                Tap to apply. Latest 6 items saved.
            </div>
        </div>

    </div>
</div>

<div id="toast" class="ios-toast">Settings Saved</div>

<div id="successAlert" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Success</div>
        <div class="alert-msg" id="alert-msg">Wallpaper Updated Successfully</div>
        <div class="alert-btn" onclick="closeAlert()">OK</div>
    </div>
</div>

<div id="charApp" class="ios-app-window">
    <div id="char-list-view" style="height:100%; display:flex; flex-direction:column;">
        <div class="app-header">
            <div class="header-title-big" style="flex:1; text-align: left; padding-left: -5px;">Character</div>
            
            <div class="header-close-btn" onclick="closeApp('charApp')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
        
        <div class="app-body">
            <div id="char-grid" class="char-grid">
                </div>
            </div>
    </div>

    <div id="char-detail-view" class="char-detail-view">
        <div class="char-hero-bg" id="detail-bg" onclick="openBgModal()">
            <div class="bg-hint">Tap to Change Cover</div>
        </div>
        
        <div class="char-content">
            <div class="char-avatar-container">
                <img id="detail-avatar" src="">
            </div>
            
            <div class="char-info-block">
                <div class="char-name" id="detail-name">Character Name</div>
                
                <div class="char-desc-preview" onclick="openFullDesc()">
                    <span id="detail-desc">Description goes here...</span>
                    <span style="color:#007AFF; font-weight:600; font-size:12px;"> more</span>
                </div>

                <div class="char-actions">
                    <button class="ios-btn secondary" onclick="editCurrentChar()">Edit Profile</button>
                    <button class="ios-btn" style="background:#FF3B30; color:white;" onclick="openDelConfirm()">Delete Character</button>
                </div>
            </div>
        </div>

        <div class="floating-back" onclick="closeDetailView()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </div>
    </div>
</div>

<div id="charEditModal" class="ios-alert-mask" style="align-items:flex-end;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-top">
            <span class="modal-h1" id="modal-title">New Character</span>
            <span class="modal-done" onclick="saveCharacter()">Save</span>
        </div>
        
        <div style="display:flex; justify-content:center; margin-bottom:20px;">
            <div class="char-upload-circle" onclick="document.getElementById('char-avatar-in').click()">
                <img id="edit-avatar-preview" src="" style="display:none;">
                <span id="edit-avatar-hint">+ Avatar</span>
            </div>
            <input type="file" id="char-avatar-in" accept="image/*" style="display:none" onchange="previewCharAvatar(this)">
        </div>

        <input type="text" id="char-name-in" class="ios-input" placeholder="Nickname">
        <textarea id="char-desc-in" class="ios-input" style="height:120px; resize:none; padding-top:12px;" placeholder="Character Description / Setting..."></textarea>
        
        <div class="tool-btn" onclick="closeCharModal()" style="margin-top:10px; color:#FF3B30;">Cancel</div>
    </div>
</div>

<div id="bgChangeModal" class="ios-alert-mask">
    <div class="ios-alert-box" style="padding:20px; text-align:left;">
        <div class="alert-title" style="margin-top:0; margin-bottom:15px; text-align:center;">Change Cover</div>
        
        <div class="segment-control">
            <div class="segment-btn active" id="bg-seg-file" onclick="switchBgMode('file')">File</div>
            <div class="segment-btn" id="bg-seg-url" onclick="switchBgMode('url')">URL</div>
        </div>

        <div id="bg-panel-file">
            <input type="file" id="bg-file-in" style="display:none" accept="image/*" onchange="handleBgFile(this)">
            <button class="ios-btn secondary" onclick="document.getElementById('bg-file-in').click()">Choose Image</button>
        </div>
        <div id="bg-panel-url" style="display:none;">
            <input type="text" id="bg-url-in" class="ios-input" placeholder="https://..." style="margin-bottom:10px;">
            <button class="ios-btn secondary" onclick="handleBgUrl()">Use URL</button>
        </div>

        <div class="alert-btn" style="border:none; margin-top:10px; color:#FF3B30;" onclick="document.getElementById('bgChangeModal').style.display='none'">Cancel</div>
    </div>
</div>

<div id="fullDescModal" class="ios-alert-mask" onclick="closeInsModal()" style="backdrop-filter: blur(15px); background: rgba(0,0,0,0.2);">
    
    <div class="aesthetic-card" onclick="event.stopPropagation()">
        
        <div class="aes-top-bar">
            <div class="aes-icon-circle close" onclick="closeInsModal()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="aes-hero">
            <div class="aes-blur-bg" id="aes-bg-layer"></div>
            <div class="aes-noise"></div>
            <div class="aes-overlay"></div>
        </div>

        <div class="aes-float-content">
            <div class="aes-avatar-box">
                <img id="aes-avatar-img" src="">
            </div>
            <div class="aes-title-group">
                <div class="aes-name" id="aes-name-txt">Character Name</div>
                <div class="aes-tag">ORIGINAL CHARACTER</div>
            </div>
        </div>

        <div class="aes-scroll-area">
            <div class="aes-text-body" id="aes-full-desc">
                </div>
            <div class="aes-divider">âœ¦</div>
        </div>

        </div>
</div>

<div id="delConfirmModal" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Delete Character?</div>
        <div class="alert-msg">This action cannot be undone.</div>
        <div class="alert-btn" style="color:#FF3B30;" onclick="confirmDelete()">Delete</div>
        <div class="alert-btn" onclick="document.getElementById('delConfirmModal').style.display='none'">Cancel</div>
    </div>
</div>

<div id="settingsApp" class="ios-app-window" style="background:#F2F2F7; z-index: 5000;">
    
    <div class="app-header" style="background: rgba(242,242,247,0.85); backdrop-filter: saturate(180%) blur(20px); z-index: 10;">
        <div class="header-title-big" style="flex:1; text-align: left; padding-left: 10px;">Settings</div>
        <div class="header-close-btn" onclick="closeApp('settingsApp')" style="background:#e5e5ea;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body" style="padding: 20px 16px; align-items: stretch;">
        <div class="ios-list-group">
            
            <div class="ios-list-item" onclick="openSubPage('subpage-timezone')">
                <div class="item-icon" style="background: #FF9500;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div class="item-content">
                    <span class="item-label">Timezone</span>
                    <div class="item-right">
                        <span class="item-value" id="val-timezone">Automatic</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-api'); loadApiSettingsUI();">
                <div class="item-icon" style="background: #34C759;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                </div>
                <div class="item-content">
                    <span class="item-label">AI Configuration</span>
                    <div class="item-right">
                        <span class="item-value" id="api-status-preview">Default</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-display'); loadFontSettings();">
                <div class="item-icon" style="background: #007AFF;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
                </div>
                <div class="item-content" style="border-bottom: none;">
                    <span class="item-label">Display & Brightness</span>
                    <div class="item-right">
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-instructions')">
                <div class="item-icon" style="background: #8E8E93;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <div class="item-content" style="border-bottom: none;">
                    <span class="item-label">Instructions</span>
                    <div class="item-right">
                        <span class="item-value">Guide</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

        </div>
        <div style="font-size:12px; color:#8e8e93; margin-top:10px; margin-left:16px;">iOS Pro Ultimate v1.0</div>
    </div>

    <div id="subpage-timezone" class="ios-sub-page" style="display: flex; flex-direction: column; height: 100%; width: 100%; background: #F2F2F7; position: absolute; top: 0; left: 0; z-index: 20;">
        <div class="app-header" style="flex-shrink: 0; height: 60px; background: rgba(242,242,247,0.85); backdrop-filter: saturate(180%) blur(20px); z-index: 999; position: relative;">
            <div class="header-left-btn" onclick="closeSubPage('subpage-timezone')" style="margin-left: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                <span style="color:#007AFF; font-size:16px; font-weight:500;">Back</span>
            </div>
            <div class="header-title-big" style="font-size:17px; text-align:center; flex:1;">Time Zone</div>
            <div style="width:60px;"></div> 
        </div>

        <div class="app-body" style="flex: 1; overflow-y: auto; padding: 0 16px 80px 16px; width: 100%; align-items: stretch; -webkit-overflow-scrolling: touch;">
            <div style="padding: 10px 0;">
                <div class="ios-search-wrapper" style="padding: 12px 10px;">
                    <svg class="search-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="tz-search-input" class="ios-search-input" placeholder="Search City or Region" oninput="filterTimezoneList(this.value)">
                </div>
            </div>

            <div class="tz-group-title">Current Location</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="setTimezone('')">
                    <div class="item-content" style="border-bottom:none;"><span class="item-label">Automatic (System)</span><div class="item-check" id="check-auto"></div></div>
                </div>
            </div>

            <div id="tz-city-container">
                <div class="tz-group-title">ASIA & PACIFIC</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="beijing china" onclick="setTimezone('Asia/Shanghai', 'Beijing')">
                        <div class="item-content"><span class="item-label">Beijing</span><div class="item-check" id="check-Asia/Shanghai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="shanghai china" onclick="setTimezone('Asia/Shanghai', 'Shanghai')">
                        <div class="item-content"><span class="item-label">Shanghai</span><div class="item-check" id="check-Asia/Shanghai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="hong kong hk" onclick="setTimezone('Asia/Hong_Kong', 'Hong Kong')">
                        <div class="item-content"><span class="item-label">Hong Kong</span><div class="item-check" id="check-Asia/Hong_Kong"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="taipei taiwan" onclick="setTimezone('Asia/Taipei', 'Taipei')">
                        <div class="item-content"><span class="item-label">Taipei</span><div class="item-check" id="check-Asia/Taipei"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="tokyo japan" onclick="setTimezone('Asia/Tokyo', 'Tokyo')">
                        <div class="item-content"><span class="item-label">Tokyo</span><div class="item-check" id="check-Asia/Tokyo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="seoul korea" onclick="setTimezone('Asia/Seoul', 'Seoul')">
                        <div class="item-content"><span class="item-label">Seoul</span><div class="item-check" id="check-Asia/Seoul"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="singapore" onclick="setTimezone('Asia/Singapore', 'Singapore')">
                        <div class="item-content"><span class="item-label">Singapore</span><div class="item-check" id="check-Asia/Singapore"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="bangkok thailand" onclick="setTimezone('Asia/Bangkok', 'Bangkok')">
                        <div class="item-content"><span class="item-label">Bangkok</span><div class="item-check" id="check-Asia/Bangkok"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="dubai uae" onclick="setTimezone('Asia/Dubai', 'Dubai')">
                        <div class="item-content"><span class="item-label">Dubai</span><div class="item-check" id="check-Asia/Dubai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="mumbai india" onclick="setTimezone('Asia/Kolkata', 'Mumbai')">
                        <div class="item-content"><span class="item-label">Mumbai</span><div class="item-check" id="check-Asia/Kolkata"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="jakarta indonesia" onclick="setTimezone('Asia/Jakarta', 'Jakarta')">
                        <div class="item-content"><span class="item-label">Jakarta</span><div class="item-check" id="check-Asia/Jakarta"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="sydney australia" onclick="setTimezone('Australia/Sydney', 'Sydney')">
                        <div class="item-content"><span class="item-label">Sydney</span><div class="item-check" id="check-Australia/Sydney"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="melbourne australia" onclick="setTimezone('Australia/Melbourne', 'Melbourne')">
                        <div class="item-content"><span class="item-label">Melbourne</span><div class="item-check" id="check-Australia/Melbourne"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="auckland new zealand" onclick="setTimezone('Pacific/Auckland', 'Auckland')">
                        <div class="item-content"><span class="item-label">Auckland</span><div class="item-check" id="check-Pacific/Auckland"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="manila philippines" onclick="setTimezone('Asia/Manila', 'Manila')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Manila</span><div class="item-check" id="check-Asia/Manila"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">EUROPE</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="london uk" onclick="setTimezone('Europe/London', 'London')">
                        <div class="item-content"><span class="item-label">London</span><div class="item-check" id="check-Europe/London"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="paris france" onclick="setTimezone('Europe/Paris', 'Paris')">
                        <div class="item-content"><span class="item-label">Paris</span><div class="item-check" id="check-Europe/Paris"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="berlin germany" onclick="setTimezone('Europe/Berlin', 'Berlin')">
                        <div class="item-content"><span class="item-label">Berlin</span><div class="item-check" id="check-Europe/Berlin"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="rome italy" onclick="setTimezone('Europe/Rome', 'Rome')">
                        <div class="item-content"><span class="item-label">Rome</span><div class="item-check" id="check-Europe/Rome"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="madrid spain" onclick="setTimezone('Europe/Madrid', 'Madrid')">
                        <div class="item-content"><span class="item-label">Madrid</span><div class="item-check" id="check-Europe/Madrid"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="amsterdam netherlands" onclick="setTimezone('Europe/Amsterdam', 'Amsterdam')">
                        <div class="item-content"><span class="item-label">Amsterdam</span><div class="item-check" id="check-Europe/Amsterdam"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="zurich switzerland" onclick="setTimezone('Europe/Zurich', 'Zurich')">
                        <div class="item-content"><span class="item-label">Zurich</span><div class="item-check" id="check-Europe/Zurich"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="vienna austria" onclick="setTimezone('Europe/Vienna', 'Vienna')">
                        <div class="item-content"><span class="item-label">Vienna</span><div class="item-check" id="check-Europe/Vienna"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="stockholm sweden" onclick="setTimezone('Europe/Stockholm', 'Stockholm')">
                        <div class="item-content"><span class="item-label">Stockholm</span><div class="item-check" id="check-Europe/Stockholm"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="athens greece" onclick="setTimezone('Europe/Athens', 'Athens')">
                        <div class="item-content"><span class="item-label">Athens</span><div class="item-check" id="check-Europe/Athens"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="moscow russia" onclick="setTimezone('Europe/Moscow', 'Moscow')">
                        <div class="item-content"><span class="item-label">Moscow</span><div class="item-check" id="check-Europe/Moscow"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="istanbul turkey" onclick="setTimezone('Europe/Istanbul', 'Istanbul')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Istanbul</span><div class="item-check" id="check-Europe/Istanbul"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">AMERICAS</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="new york usa" onclick="setTimezone('America/New_York', 'New York')">
                        <div class="item-content"><span class="item-label">New York</span><div class="item-check" id="check-America/New_York"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="los angeles la usa" onclick="setTimezone('America/Los_Angeles', 'Los Angeles')">
                        <div class="item-content"><span class="item-label">Los Angeles</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="chicago usa" onclick="setTimezone('America/Chicago', 'Chicago')">
                        <div class="item-content"><span class="item-label">Chicago</span><div class="item-check" id="check-America/Chicago"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="toronto canada" onclick="setTimezone('America/Toronto', 'Toronto')">
                        <div class="item-content"><span class="item-label">Toronto</span><div class="item-check" id="check-America/Toronto"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="vancouver canada" onclick="setTimezone('America/Vancouver', 'Vancouver')">
                        <div class="item-content"><span class="item-label">Vancouver</span><div class="item-check" id="check-America/Vancouver"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="mexico city" onclick="setTimezone('America/Mexico_City', 'Mexico City')">
                        <div class="item-content"><span class="item-label">Mexico City</span><div class="item-check" id="check-America/Mexico_City"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="sao paulo brazil" onclick="setTimezone('America/Sao_Paulo', 'Sao Paulo')">
                        <div class="item-content"><span class="item-label">Sao Paulo</span><div class="item-check" id="check-America/Sao_Paulo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="buenos aires argentina" onclick="setTimezone('America/Argentina/Buenos_Aires', 'Buenos Aires')">
                        <div class="item-content"><span class="item-label">Buenos Aires</span><div class="item-check" id="check-America/Argentina/Buenos_Aires"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="san francisco usa" onclick="setTimezone('America/Los_Angeles', 'San Francisco')">
                        <div class="item-content"><span class="item-label">San Francisco</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="seattle usa" onclick="setTimezone('America/Los_Angeles', 'Seattle')">
                        <div class="item-content"><span class="item-label">Seattle</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="miami usa" onclick="setTimezone('America/New_York', 'Miami')">
                        <div class="item-content"><span class="item-label">Miami</span><div class="item-check" id="check-America/New_York"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="honolulu hawaii" onclick="setTimezone('Pacific/Honolulu', 'Honolulu')">
                        <div class="item-content"><span class="item-label">Honolulu</span><div class="item-check" id="check-Pacific/Honolulu"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="anchorage alaska" onclick="setTimezone('America/Anchorage', 'Anchorage')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Anchorage</span><div class="item-check" id="check-America/Anchorage"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">MIDDLE EAST & AFRICA</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="riyadh saudi arabia" onclick="setTimezone('Asia/Riyadh', 'Riyadh')">
                        <div class="item-content"><span class="item-label">Riyadh</span><div class="item-check" id="check-Asia/Riyadh"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="cairo egypt" onclick="setTimezone('Africa/Cairo', 'Cairo')">
                        <div class="item-content"><span class="item-label">Cairo</span><div class="item-check" id="check-Africa/Cairo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="johannesburg south africa" onclick="setTimezone('Africa/Johannesburg', 'Johannesburg')">
                        <div class="item-content"><span class="item-label">Johannesburg</span><div class="item-check" id="check-Africa/Johannesburg"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="nairobi kenya" onclick="setTimezone('Africa/Nairobi', 'Nairobi')">
                        <div class="item-content"><span class="item-label">Nairobi</span><div class="item-check" id="check-Africa/Nairobi"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="tehran iran" onclick="setTimezone('Asia/Tehran', 'Tehran')">
                        <div class="item-content"><span class="item-label">Tehran</span><div class="item-check" id="check-Asia/Tehran"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="jerusalem israel" onclick="setTimezone('Asia/Jerusalem', 'Jerusalem')">
                        <div class="item-content"><span class="item-label">Jerusalem</span><div class="item-check" id="check-Asia/Jerusalem"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="qatar doha" onclick="setTimezone('Asia/Qatar', 'Doha')">
                        <div class="item-content"><span class="item-label">Doha</span><div class="item-check" id="check-Asia/Qatar"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="casablanca morocco" onclick="setTimezone('Africa/Casablanca', 'Casablanca')">
                        <div class="item-content"><span class="item-label">Casablanca</span><div class="item-check" id="check-Africa/Casablanca"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="lagos nigeria" onclick="setTimezone('Africa/Lagos', 'Lagos')">
                        <div class="item-content"><span class="item-label">Lagos</span><div class="item-check" id="check-Africa/Lagos"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="cape town" onclick="setTimezone('Africa/Johannesburg', 'Cape Town')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Cape Town</span><div class="item-check" id="check-Africa/Johannesburg"></div></div>
                    </div>
                </div>

                <div id="tz-no-result" style="display:none; text-align:center; padding:40px; color:#999; font-size:14px;">
                    No Results Found
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-api" class="ios-sub-page" style="display: flex; flex-direction: column; height: 100%; width: 100%; background: #F2F2F7; position: absolute; top: 0; left: 0; z-index: 20;">
        
        <div class="app-header" style="flex-shrink: 0; height: 110px; padding-top: 55px; padding-bottom: 12px; background: rgba(242,242,247,0.95); backdrop-filter: saturate(180%) blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: flex-end; justify-content: space-between; padding-left: 16px; padding-right: 16px; z-index: 50; box-sizing: border-box;">
            
            <div onclick="closeSubPage('subpage-api')" style="color: #007AFF; font-size: 16px; display: flex; align-items: center; cursor: pointer; width: 70px; height: 30px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: -2px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                Back
            </div>
            
            <div style="font-size: 17px; font-weight: 600; text-align: center; flex: 1; padding-bottom: 5px;">AI Config</div>
            
            <div onclick="openSavePresetModal()" style="color: #007AFF; font-size: 16px; font-weight: 600; cursor: pointer; width: 70px; text-align: right; height: 30px; line-height: 30px;">
                Save
            </div>
        </div>

        <div class="app-body" style="flex: 1; overflow-y: auto; padding: 10px 16px 100px 16px; -webkit-overflow-scrolling: touch; width: 100%; display: flex; flex-direction: column; align-items: stretch; box-sizing: border-box;">
            
            <div class="tz-group-title" style="margin-top: 20px;">CONNECTION</div>
            <div class="ios-list-group">
                <div class="ios-list-item input-item">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Host</span>
                    <input type="text" id="api-url" class="ios-input-clean" placeholder="https://api.openai.com/v1">
                </div>
                <div class="ios-list-item input-item">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Key</span>
                    <input type="password" id="api-key" class="ios-input-clean" placeholder="sk-...">
                </div>
            </div>

            <div class="tz-group-title">MODEL</div>
            <div class="ios-list-group" style="padding: 0;">
                <div class="ios-list-item" style="padding-right: 16px;" onclick="openModelPicker()">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Name</span>
                    
                    <div id="api-model-display" style="flex:1; text-align:right; color:#007AFF; font-size:16px; display:flex; align-items:center; justify-content:flex-end;">
                        gpt-3.5-turbo
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>

                    <input type="hidden" id="api-model-select" value="gpt-3.5-turbo">
                </div>
                
                <div class="ios-list-item" style="justify-content: center; color: #007AFF; font-weight: 600; cursor: pointer;" onclick="fetchModelList()">
                    Fetch Models from Server
                </div>
            </div>

            <div class="tz-group-title">PARAMETERS</div>
            <div class="ios-list-group" style="padding: 20px 16px; display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Temperature</span>
                    <span id="temp-display" style="font-weight:700;">0.7</span>
                </div>
                <input type="range" id="api-temp" min="0" max="2" step="0.1" value="0.7" class="ios-slider" 
                    oninput="document.getElementById('temp-display').textContent = this.value; updateSliderFill(this)">
                <div style="height:25px;"></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Context Limit</span>
                    <span id="context-display" style="font-weight:700;">10</span>
                </div>
                <input type="range" id="api-context" min="2" max="30" step="2" value="10" class="ios-slider" 
                    oninput="document.getElementById('context-display').textContent = this.value; updateSliderFill(this)">
            </div>

            <div class="tz-group-title">TEST CONNECTION</div>
            <div id="test-chat-log" class="chat-log-area">
                <div style="color:#999; text-align:center; margin-top:50px; font-size:13px;">
                    Test your connection here...
                </div>
            </div>
            
            <div class="chat-input-bar">
                <input type="text" id="test-chat-input" class="chat-input-field" placeholder="Say hello...">
                <div class="chat-send-btn" onclick="sendTestChat()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
            </div>

            <div class="tz-group-title">SAVED PRESETS</div>
            <div id="preset-list" class="ios-list-group">
                <div class="ios-list-item" style="color:#999; justify-content:center;">No presets saved</div>
            </div>

            <button class="ios-btn" style="background: #FF3B30; color: #fff; margin-top: 30px; margin-bottom: 20px; flex-shrink: 0;" onclick="openResetConfirm()">
                Reset All Settings
            </button>

        </div>
    </div>
    <div id="subpage-display" class="ios-sub-page">
        <div class="app-header">
            <div onclick="closeSubPage('subpage-display')" style="color:#007AFF; font-size:17px; cursor:pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:-6px;"><polyline points="15 18 9 12 15 6"></polyline></svg> Back
            </div>
            <div style="font-size:17px; font-weight:600;">Display & Font</div>
            <div onclick="window.saveFontSettings()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">Save</div>
        </div>

        <div class="app-body">
            <div class="tz-group-title">Real-time Preview</div>
            <div style="display:flex; gap:10px; margin-bottom:24px;">
                <div style="flex:1; background:#fff; border-radius:14px; padding:15px; height:100px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div id="preview-text-main">App Text</div>
                </div>
                <div style="flex:1; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:14px; padding:15px; height:100px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div id="preview-text-desktop">Home Text</div>
                </div>
            </div>

            <div class="tz-group-title">Color Palettes</div>
            <div class="ios-list-group">
                <div class="ios-list-item color-item-row">
                    <span class="item-label">App Interface</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="color-val-main" style="font-size:12px; color:#8e8e93; font-family:monospace;">#1D1D1F</span>
                        <input type="color" id="color-picker-main" class="color-picker-circle" oninput="window.updateColorPreview('main', this.value)">
                    </div>
                </div>
                <div class="ios-list-item color-item-row" style="border-bottom:none;">
                    <span class="item-label">Home Screen</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="color-val-desktop" style="font-size:12px; color:#8e8e93; font-family:monospace;">#1D1D1F</span>
                        <input type="color" id="color-picker-desktop" class="color-picker-circle" oninput="window.updateColorPreview('desktop', this.value)">
                    </div>
                </div>
            </div>

            <div class="tz-group-title" style="margin-top:24px;">Font Style</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openFontPicker()">
                    <span class="item-label">Font Family</span>
                    <div id="font-family-display" style="flex:1; text-align:right; color:#007AFF; display:flex; align-items:center; justify-content:flex-end;">System Default <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                </div>
                <div class="ios-list-item" style="color:#007AFF; justify-content:center; font-weight:600;" onclick="document.getElementById('upload-font-file').click()">Import .ttf Font</div>
                <input type="file" id="upload-font-file" accept=".ttf,.otf" style="display:none;" onchange="window.handleFontUpload(this)">
            </div>

            <div class="tz-group-title">Typography</div>
            <div class="ios-list-group" style="padding: 20px 16px; display: block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Size</span>
                    <span id="size-display" style="font-weight:700;">16px</span>
                </div>
                <input type="range" id="font-size-slider" min="12" max="24" step="1" value="16" class="ios-slider" 
                    oninput="window.updateFontPreview('size', this.value); updateSliderFill(this)">
                
                <div style="height:30px;"></div>

                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Weight</span>
                    <span id="weight-display" style="font-weight:700;">400</span>
                </div>
                <input type="range" id="font-weight-slider" min="100" max="900" step="100" value="400" class="ios-slider" 
                    oninput="window.updateFontPreview('weight', this.value); updateSliderFill(this)">
            </div>

            <button class="ios-btn" style="background:#FF3B30; color:#fff; margin-top:30px;" onclick="window.resetFontSettings()">Reset to Default</button>
        </div>
    </div>
    <div id="subpage-instructions" class="ios-sub-page">
        <div class="app-header">
            <div onclick="closeSubPage('subpage-instructions')" style="color: #007AFF; font-size: 17px; cursor:pointer; display:flex; align-items:center; width: 70px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:-2px;"><polyline points="15 18 9 12 15 6"></polyline></svg> Back
            </div>
            <div style="font-size:17px; font-weight:600; text-align:center; flex:1;">Instructions</div>
            <div style="width:70px;"></div>
        </div>

        <div class="app-body">
            <div class="tz-group-title">SYSTEM MODULES</div>
            
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openInsAppModal('ins-wallpaper-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5" fill="white"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: 0.5px solid rgba(0,0,0,0.05);">
                        <span class="item-label">Wallpaper Engine</span>
                    </div>
                </div>

                <div class="ios-list-item" onclick="openInsAppModal('ins-character-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: 0.5px solid rgba(0,0,0,0.05);">
                        <span class="item-label">Character Book</span>
                    </div>
                </div>

                <div class="ios-list-item" onclick="openInsAppModal('ins-settings-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="#3a3a3c">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: none;">
                        <span class="item-label">System Settings</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px; opacity: 0.3; font-size: 11px;">
                iOS Pro Ultimate System Edition
            </div>
        </div>
    </div>

</div>
<div id="iosInputModal" class="ios-alert-mask" style="z-index: 20000;">
    <div class="ios-alert-box">
        <div class="alert-title" id="input-modal-title">Name This Preset</div>
        <div style="padding: 0 15px 15px 15px;">
            <input type="text" id="input-modal-val" class="ios-input" style="margin:0; text-align:center;" placeholder="e.g. GPT-4">
        </div>
        <div style="display:flex; border-top:0.5px solid rgba(60,60,67,0.29);">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid rgba(60,60,67,0.29); color:#007AFF; font-weight:400;" onclick="closeInputModal()">Cancel</div>
            <div class="alert-btn" style="flex:1; color:#007AFF;" onclick="confirmInputModal()">Save</div>
        </div>
    </div>
</div>

<div id="iosConfirmModal" class="ios-alert-mask" style="z-index: 20000;">
    <div class="ios-alert-box">
        <div class="alert-title" id="confirm-modal-title">Are you sure?</div>
        <div class="alert-msg" id="confirm-modal-msg">This action cannot be undone.</div>
        <div style="display:flex; border-top:0.5px solid rgba(60,60,67,0.29);">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid rgba(60,60,67,0.29); color:#007AFF; font-weight:400;" onclick="closeConfirmModal()">Cancel</div>
            <div class="alert-btn" id="confirm-modal-btn" style="flex:1; color:#FF3B30;" onclick="executeConfirmAction()">Delete</div>
        </div>
    </div>
</div>
<div id="modelPickerSheet" class="ios-alert-mask" style="display:none; align-items:flex-end; background:rgba(0,0,0,0.4); z-index: 99999;" onclick="closeModelPicker()">
    <div class="ios-action-sheet" onclick="event.stopPropagation()">
        <div class="sheet-title-box">Select AI Model</div>
        
        <div id="model-sheet-list" style="max-height:300px; overflow-y:auto; -webkit-overflow-scrolling:touch;">
            <div class="sheet-item" onclick="selectModel('gpt-3.5-turbo')">gpt-3.5-turbo</div>
            <div class="sheet-item" onclick="selectModel('gpt-4o')">gpt-4o</div>
            <div class="sheet-item" onclick="selectModel('claude-3-5-sonnet')">claude-3-5-sonnet</div>
        </div>
        
        <div class="sheet-cancel" onclick="closeModelPicker()">Cancel</div>
    </div>
</div>
<div id="ins-wallpaper-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px);">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-wallpaper-modal')"></div>
            <div class="ins-brand-tag">MODULE INFO</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5" fill="white"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">Wallpaper Engine</h2>
            <p class="ins-subtitle">Personalization & Visual Core</p>
            
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Hybrid Rendering</strong>
                        <p>å†…ç½®æ··åˆæ¸²æŸ“æŠ€æœ¯ã€‚æ”¯æŒ 8K è¶…é«˜æ¸…é™æ€å›¾åƒï¼ˆJPG/PNGï¼‰ä¸åŠ¨æ€è§†é¢‘æµï¼ˆMP4/WebMï¼‰ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶åç¼€å¹¶æ™ºèƒ½åˆ‡æ¢ Canvas æˆ– Video æ¸²æŸ“å±‚ï¼Œç¡®ä¿ç”»è´¨é›¶æŸè€—ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>Binary Storage Logic</strong>
                        <p>æ‘’å¼ƒä¼ ç»Ÿçš„ URL å¼•ç”¨æ–¹å¼ï¼Œé‡‡ç”¨ Blob äºŒè¿›åˆ¶æŠ€æœ¯å°†å£çº¸å­˜å…¥æµè§ˆå™¨åº•å±‚çš„ IndexedDBã€‚è¿™æ„å‘³ç€å³ä¾¿ä½ å…³é—­ç½‘é¡µæˆ–å¤„äºç¦»çº¿çŠ¶æ€ï¼Œå‡ ç™¾å…†çš„åŠ¨æ€å£çº¸ä¾ç„¶èƒ½å®ç°â€œç§’å¼€â€è€Œä¸æ¶ˆè€—ç½‘ç»œæµé‡ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Interactive Selection</strong>
                        <p>ç‚¹å‡»â€œSelect Fileâ€å”¤èµ·ç³»ç»Ÿçº§æ–‡ä»¶é€‰æ‹©å™¨ã€‚é€‰æ‹©åï¼Œç³»ç»Ÿå°†è¿›å…¥â€œé¢„è½½å…¥æ€ï¼ˆPre-loadingï¼‰â€ï¼Œé¢„è§ˆæ»¡æ„åç‚¹å‡»åº•éƒ¨ç¡®è®¤é”®ï¼Œå£çº¸å°†é€šè¿‡å…¨å±€æ€»çº¿ï¼ˆEvent Busï¼‰å®æ—¶æ¨é€åˆ°èƒŒæ™¯å±‚ï¼Œæ— éœ€åˆ·æ–°é¡µé¢ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Layer Compositing</strong>
                        <p>å£çº¸å±‚ä¸ UI å±‚é‡‡ç”¨ç‰©ç†éš”ç¦»ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºå£çº¸ä¸Šæ–¹è¦†ç›–ä¸€å±‚åŠ¨æ€é®ç½©ï¼ˆOverlayï¼‰ï¼Œæ ¹æ®å£çº¸äº®åº¦è‡ªåŠ¨å¾®è°ƒå¯¹æ¯”åº¦ï¼Œç¡®ä¿å³ä¾¿æ˜¯åœ¨å…¨ç™½å£çº¸ä¸‹ï¼ŒçŠ¶æ€æ å’Œ App ä¾ç„¶æ¸…æ™°å¯è§ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Memory Cleaning</strong>
                        <p>ç³»ç»Ÿå®æ—¶ç›‘æ§å£çº¸å ç”¨çš„ç¼“å­˜ç©ºé—´ã€‚å½“ä½ æƒ³æ›´æ¢é£æ ¼æ—¶ï¼Œç‚¹å‡»â€œResetâ€å°†æ‰§è¡Œæ·±åº¦åƒåœ¾å›æ”¶ï¼ˆGCï¼‰é€»è¾‘ï¼Œå½»åº•æŠ¹é™¤æ—§å£çº¸æ®‹ç•™çš„å†…å­˜ç¢ç‰‡ï¼Œä¿æŒç³»ç»Ÿæé€Ÿè¿è¡Œã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-wallpaper-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>
<div id="ins-character-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); display:none;">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-character-modal')" style="background: #FFBD2E;"></div>
            <div class="ins-brand-tag">CHARACTER CORE</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">Character Book</h2>
            <p class="ins-subtitle">Identity & Interactive Logic</p>
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Lifecycle Management</strong>
                        <p>ç‚¹å‡»åˆ—è¡¨é¦–ä½çš„â€œè™šçº¿æ–¹æ¡†â€å³å¯è¿›å…¥åˆ›ä½œæ¨¡å¼ã€‚ç³»ç»Ÿæ”¯æŒæ— é™é‡åˆ›å»ºè™šæ‹Ÿè§’è‰²ï¼Œæ¯ä¸ªè§’è‰²æ‹¥æœ‰ç‹¬ç«‹çš„å”¯ä¸€ IDï¼Œç¡®ä¿æ•°æ®åœ¨å¤æ‚çš„è”è§‰é€»è¾‘ä¸­äº’ä¸å¹²æ‰°ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>Aesthetic Skinning</strong>
                        <p>è¿›å…¥è¯¦æƒ…é¡µåï¼Œç‚¹å‡»é¡¶éƒ¨åŒºåŸŸå¯å”¤èµ·â€œå°é¢é‡‡é›†å™¨â€ï¼Œæ”¯æŒæœ¬åœ°æ–‡ä»¶ä¸Šä¼ æˆ–ç²˜è´´ 4K URLã€‚å¤´åƒæ¡†é‡‡ç”¨ç‰©ç†é‡å è§†è§‰ç®—æ³•ï¼Œé…åˆæ¯›ç»ç’ƒæ»¤é•œï¼Œè¥é€ é¡¶çº§æ‚å¿—å°é¢æ„Ÿã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Interaction Protocol</strong>
                        <p>ç‚¹å‡»ç®€ä»‹åŒºçš„â€œMoreâ€å¯è§¦å‘å…¨å±æ²‰æµ¸å¼é˜…è¯»æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šæ ¹æ®è§’è‰²èƒŒæ™¯è‡ªåŠ¨è°ƒæ•´å…‰å½±æ°›å›´ï¼Œç‚¹å‡»æ‚¬æµ®è¿”å›é”®å³å¯æ— ç¼åˆ‡å›ç®¡ç†ç½‘æ ¼ï¼Œä½“éªŒä¸æ»‘ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Persistent Core</strong>
                        <p>æ‰€æœ‰è§’è‰²è®¾å®šï¼ˆå§“åã€ç®€ä»‹ã€å°é¢å›¾ã€å¤´åƒï¼‰å‡é‡‡ç”¨å¼‚æ­¥å†™å…¥æŠ€æœ¯å­˜å…¥æµè§ˆå™¨åº•å±‚æ•°æ®åº“ï¼ˆIndexedDBï¼‰ã€‚å³ä¾¿æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–ç¦»çº¿ä½¿ç”¨ï¼Œä½ çš„è§’è‰²ä¹¦ä¾ç„¶æ°¸å­˜ã€‚</p>
                    </div>
                </div>
                
                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Operations Guide</strong>
                        <p>é•¿æŒ‰æˆ–ç‚¹å‡»â€œEdit Profileâ€å¯å®æ—¶ä¿®æ”¹è§’è‰²é…ç½®ï¼›ç‚¹å‡»å±é™©çº¢åŒºçš„â€œDeleteâ€å°†è§¦å‘åŒé‡ç”Ÿç‰©ç¡®è®¤é€»è¾‘ï¼Œé˜²æ­¢çè´µæ•°æ®è¯¯åˆ ã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-character-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>

<div id="ins-settings-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); display:none;">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-settings-modal')" style="background: #28C940;"></div>
            <div class="ins-brand-tag">SYSTEM KERNEL</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="#3a3a3c">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">System Settings</h2>
            <p class="ins-subtitle">Global Environment Tuning</p>
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Global Timezone Sync</strong>
                        <p>é›†æˆ 50 ä¸ªå…¨çƒæ ¸å¿ƒåŸå¸‚æ—¶åŒºæ•°æ®ã€‚æ”¯æŒæ¨¡ç³Šæœç´¢è¿‡æ»¤ï¼Œé€‰ä¸­åŸå¸‚åç³»ç»Ÿå°†æ ¹æ® Intl åè®®æ¯«ç§’çº§åŒæ­¥æ¡Œé¢å¤©æ°”ç»„ä»¶ä¸çŠ¶æ€æ çš„æ—¶é—´æ˜¾ç¤ºã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>AI Configuration</strong>
                        <p>æ”¯æŒæ¥å…¥ OpenAI æ ‡å‡†æ¥å£ã€‚ä½ å¯ä»¥åœ¨æ­¤é…ç½® Host ä¸ API Keyï¼Œå¹¶è°ƒèŠ‚ Temperatureï¼ˆåˆ›é€ åŠ›ï¼‰å’Œ Contextï¼ˆè®°å¿†æ·±åº¦ï¼‰ã€‚å†…ç½® iMessage é£æ ¼çš„æµ‹è¯•æ²™ç›’ï¼Œç”¨äºéªŒè¯è¿æ¥æ˜¯å¦æˆåŠŸã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Display & Font Settings</strong>
                        <p>æ”¯æŒå…¨å±€å­—å·ï¼ˆ12px-24pxï¼‰ä¸ç²—ç»†ï¼ˆ100-900ï¼‰è°ƒèŠ‚ã€‚æä¾› .ttf æ–‡ä»¶ä¸Šä¼ æ¥å£ã€‚é€šè¿‡ CSS å˜é‡æŠ€æœ¯å®ç°å®æ—¶é¢„è§ˆï¼Œä¸”å…·å¤‡æ¡Œé¢å¸ƒå±€ä¿æŠ¤åŠŸèƒ½ï¼Œé˜²æ­¢å›¾æ ‡æ–‡å­—è¢«æŒ¤ä¹±ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Color Customization</strong>
                        <p>é‡‡ç”¨ç‰©ç†åˆ†ç¦»è°ƒè‰²é€»è¾‘ã€‚ä½ å¯ä»¥ç‹¬ç«‹å®šä¹‰ App å†…éƒ¨åˆ—è¡¨çš„æ–‡å­—é¢œè‰²ï¼Œä»¥åŠä¸»å±å¹•ï¼ˆçŠ¶æ€æ ã€å›¾æ ‡åã€å¤©æ°”ï¼‰çš„æ–‡å­—é¢œè‰²ã€‚æ”¯æŒå®æ—¶ HEX ç åé¦ˆä¸ä¿å­˜åŒæ­¥ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Persistence & Reset</strong>
                        <p>æ‰€æœ‰è®¾ç½®å˜æ›´å‡é€šè¿‡ LocalStorage å®æ—¶ä¿å­˜ã€‚ç³»ç»Ÿåº•éƒ¨æä¾›çº¢è‰²â€œReset to Defaultsâ€æŒ‰é’®ï¼Œå¯ä¸€é”®æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰é…ç½®å¹¶æ¢å¤åˆ°åˆå§‹è“é»‘ä¸»é¢˜ã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-settings-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>
<div id="p2-editor-modal" class="ios-alert-mask" onclick="if(event.target==this) window.closeP2Editor()">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span id="p2-editor-title">Update Hero Cover</span>
            <div class="p2-done-btn" onclick="window.closeP2Editor()">Done</div>
        </div>
        
        <div class="p2-editor-body">
            <input type="text" id="p2-main-input" class="p2-main-input" placeholder="Paste image link here...">
            
            <div id="p2-upload-area">
                <div style="text-align:center; color:#d1d1d6; font-size:12px; margin-bottom:15px; font-weight:800;">OR</div>
                
                <label class="custom-upload-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span>Upload from Gallery</span>
                    <input type="file" id="p2-file-input" hidden accept="image/*" onchange="window.handleP2File(this)">
                </label>
            </div>
        </div>
    </div>
</div>
<div id="cipher-web-app" class="full-app-screen" style="display:none; background:#000;">
    <div class="app-header">
        <div class="back-btn" onclick="closeApp('cipherWebApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </div>
        <div class="app-title-group">
            <span class="main-title">Cipher Web</span>
            <span class="sub-status" id="web-ai-status">Connected to RoleBook</span>
        </div>
        <div class="header-action" onclick="resetWeb()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L19 10M1 14l1.64 4.36A9 9 0 0 0 17.51 15"/></svg></div>
    </div>

    <div class="web-canvas-container" id="web-canvas">
        <svg id="web-svg-layer" width="100%" height="100%">
            </svg>
        <div id="web-nodes-layer">
            </div>
    </div>

    <div class="web-input-bar">
        <input type="text" id="cipher-input" placeholder="Whisper a word..." onkeypress="if(event.key==='Enter') sendCipher()">
        <button class="send-cipher-btn" onclick="sendCipher()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
    </div>
</div>
<div id="vibe-grid-app" class="ios-app-window" style="background: #F2F2F7;">
    <div class="app-header">
    <div class="header-title-big">Vibe Grid</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span onclick="openVibeHistory()" style="font-size: 13px; color: #8e8e93; font-weight: 600; cursor: pointer;">å†å²</span>
            <span onclick="openVibeGuide()" style="font-size: 13px; color: #007AFF; font-weight: 600; cursor: pointer;">åè®®</span>
            <div class="header-close-btn" onclick="closeApp('vibe-grid-app')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <div class="app-body" style="display:flex; flex-direction:column;">
        
        <div id="vibe-start-screen" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:100px; height:100px; background:linear-gradient(135deg, #1d1d1f, #434343); border-radius:24px; display:flex; align-items:center; justify-content:center; box-shadow:0 15px 30px rgba(0,0,0,0.1); margin-bottom:30px;">
                <svg width="45" height="45" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            </div>
            <h2 style="font-weight:800; font-size:26px; color:#1d1d1f; margin-bottom:8px;">åšå¼ˆå›å“</h2>
            <p style="color:#8e8e93; font-size:14px; margin-bottom:40px;">åœ¨æ–¹å¯¸ä¹‹é—´ï¼Œä¸äººæ ¼ç¢ç‰‡å¯¹å¼ˆ</p>
            <button class="ios-btn primary" onclick="openVibeCharPicker()">é€‰æ‹©åšå¼ˆå¯¹è±¡</button>
            <div onclick="openVibeGuide()" style="margin-top:25px; font-size:13px; color:#007AFF; font-weight:600; cursor:pointer;">é˜…è¯»å¯¹å±€åè®®</div>
        </div>

        <div id="vibe-game-main" style="display:none; opacity:0;">
            <div id="vibe-turn-indicator" style="text-align:center; padding:20px 0; font-weight:700; color:#8e8e93; font-size:12px; letter-spacing:2px;">
                RESONANCE PHASE
            </div>
            
            <div class="vibe-board-wrapper">
                <div id="vibe-board" class="vibe-board"></div>
            </div>

            <div id="opponent-bar" style="margin: 30px auto; width: 85%; display: flex; align-items: center; background: #fff; padding: 12px 18px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); position: relative;">
                <img id="opp-avatar" src="" style="width:44px; height:44px; border-radius:50%; object-fit:cover; background:#eee;">
                <div style="margin-left:15px; text-align:left; flex: 1;">
                    <div id="opp-name" style="font-weight:800; font-size:15px;">å¯¹æ‰‹</div>
                    <div id="opp-last-word" style="font-size: 13px; color: #007AFF; font-family: serif; font-style: italic; font-weight: 500; margin-top: 2px; opacity: 0; transition: opacity 0.5s;">
                        ç­‰å¾…æ³¨é­‚...
                    </div>
                </div>
                <div style="font-size:10px; color:#d1d1d6; font-weight:700; letter-spacing:1px;">ACTIVE</div>
            </div>
        </div>
    </div>

    <div id="modal-vibe-picker" class="ios-alert-mask" style="display: none; align-items: flex-end; z-index: 8000;">
        <div class="p2-editor-sheet">
            <div class="p2-editor-header">
                <span style="font-weight: 800; font-size: 17px;">é€‰æ‹©åšå¼ˆå¯¹è±¡</span>
                <span class="p2-done-btn" onclick="document.getElementById('modal-vibe-picker').style.display='none'">å–æ¶ˆ</span>
            </div>
            <div id="vibe-char-scroll-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-height: 55vh; overflow-y: auto; padding: 0 20px 40px 20px;">
                </div>
        </div>
    </div>

    <div id="modal-vibe-word-input" class="vibe-center-mask" style="display:none;">
        <div class="ios-alert-box" style="width:280px; border-radius:24px;">
            <div style="padding:25px 20px 15px 20px;">
                <div style="font-weight:800; font-size:17px; margin-bottom:8px;">æ³¨é­‚</div>
                <div style="font-size:12px; color:#8e8e93; margin-bottom:20px;">è¯·ä¸ºæ­¤å¤„æ³¨å…¥ä¸€ä¸ªæƒ…ç»ªè¯æ±‡</div>
                <input type="text" id="vibe-user-word" class="ios-input" style="text-align:center; background:#f2f2f7;" placeholder="è¾“å…¥è¯è¯­">
            </div>
            <div style="display:flex; border-top:0.5px solid #eee;">
                <div class="alert-btn" style="flex:1; border-right:0.5px solid #eee; color:#8e8e93;" onclick="document.getElementById('modal-vibe-word-input').style.display='none'">æ”¾å¼ƒ</div>
                <div class="alert-btn" style="flex:1; color:#007AFF; font-weight:700;" onclick="confirmVibeStep()">ç¡®å®š</div>
            </div>
        </div>
    </div>

    <div id="modal-vibe-guide" class="ios-alert-mask" style="display:none; z-index:9000; background:rgba(0,0,0,0.2); backdrop-filter:blur(15px);">
        <div class="ins-fancy-card" style="max-width:320px; border: 1px solid rgba(255,255,255,0.3);">
            <div class="ins-card-body" style="text-align:left; padding:35px 25px;">
                <h2 class="ins-title-serif" style="text-align:center; font-size:22px; margin-bottom:25px; letter-spacing:1px;">å¯¹å±€åè®® (PROTOCOL)</h2>
                
                <div class="ins-feature-list" style="margin-bottom:30px;">
                    <div class="ins-feat-item" style="border-left: 1.5px solid #007AFF; padding-left:15px; margin-bottom:20px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">æ³¨é­‚ä¸å›å“</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">æ¯è½ä¸€å­ï¼Œéœ€æ³¨å…¥ä¸€ä¸ªæƒ…ç»ªè¯æ±‡ã€‚ä½ çš„äººæ ¼å¯¹æ‰‹å°†æ ¹æ®å…¶å›ºæœ‰é€»è¾‘ï¼Œå›ä»¥å¯¹åº”çš„è¯è¯­å…±é¸£ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="ins-feat-item" style="border-left: 1.5px solid #1d1d1f; padding-left:15px; margin-bottom:20px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">èƒœè´Ÿçš„å¼•åŠ›</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">äº”å­è¿ç å³ä¸ºèƒœã€‚è‹¥æ£‹ç›˜æ»¡æº¢è€Œå¹³è¡¡æœªç ´ï¼Œå¯¹å±€å°†å½’äºâ€œç©ºå¯‚â€ç»“å±€ã€‚</p>
                        </div>
                    </div>

                    <div class="ins-feat-item" style="border-left: 1.5px solid #d1d1d6; padding-left:15px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">å™äº‹é‡å¡‘</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">å¯¹å±€ç»ˆäº†ï¼Œæ‰€æœ‰çš„è¯è¯­ç¢ç‰‡å°†æ±‡èšæˆä¸€æ®µç‹¬å±äºæ­¤åˆ»çš„ç§å¯†å›å“ã€‚é‚£æ˜¯ä½ ä»¬åšå¼ˆåçš„ä½™æ¸©ã€‚</p>
                        </div>
                    </div>
                </div>

                <button class="ins-done-btn" style="background:#1d1d1f; color:#fff; border-radius:12px;" onclick="closeVibeGuide()">è¿›å…¥åšå¼ˆ</button>
            </div>
        </div>
    </div>

    <div id="modal-vibe-result" class="ios-alert-mask vibe-center-box" style="display: none; z-index: 8000; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px);">
        <div class="aesthetic-card" style="height: auto; max-height: 80vh; width: 90%; max-width: 340px; background: #fff; border-radius: 32px; overflow: hidden; display: flex; flex-direction: column;">
            <div class="aes-hero" style="height: 120px; position: relative; overflow: hidden;">
                <div class="aes-blur-bg" id="res-hero-bg" style="position: absolute; inset: -10%; background-size: cover; background-position: center; filter: blur(20px); opacity: 0.6;"></div>
                <div class="aes-overlay" style="position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, #fff);"></div>
            </div>

            <div class="aes-float-content" style="margin-top: -40px; position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; text-align: center;">
                <div class="aes-avatar-box" style="width: 80px; height: 80px; border-radius: 20px; background: #fff; padding: 4px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: rotate(-2deg);">
                    <img id="res-avatar" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                </div>
                <div class="aes-title-group" style="margin-top: 15px;">
                    <div class="aes-name" id="res-title" style="font-size: 20px; font-weight: 800; color: #1d1d1f;">å¯¹å¼ˆå›å“</div>
                    <div class="aes-tag" id="res-outcome" style="margin-top: 5px; font-size: 10px; color: #007AFF; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;">MATCH ENDED</div>
                </div>
            </div>

            <div class="aes-scroll-area" style="flex: 1; padding: 20px 30px; overflow-y: auto; text-align: justify;">
                <div id="res-story" class="aes-text-body" style="font-family: serif; color: #444; line-height: 1.8; white-space: pre-wrap;">
                    æ­£åœ¨ç¼–ç»‡åšå¼ˆç•™ä¸‹çš„ä½™æ¸©...
                </div>
                <div style="border-top: 1px solid #f2f2f7; margin-top: 20px; padding-top: 15px; font-size: 10px; color: #ccc; text-align: center; letter-spacing: 1px;">
                    TRACES: <span id="res-words"></span>
                </div>
            </div>

            <div class="aes-control-bar" style="padding: 20px 30px 30px; display: flex; gap: 12px;">
                <div class="aes-btn edit" style="background: #f2f2f7; color: #1d1d1f; flex: 1; font-weight: 600;" onclick="archiveAndClose()">
                    å°å­˜å›å“
                </div>
                <div class="aes-btn edit" style="background: #007AFF; color: #fff; flex: 1; font-weight: 600;" onclick="restartVibeGame()">
                    å†æ¥ä¸€å±€
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-vibe-history" class="ios-sub-page" style="z-index: 8500; background: #F2F2F7;">
        <div class="app-header">
            <div onclick="closeVibeHistory()" style="color:#007AFF; font-size:17px; cursor:pointer; display:flex; align-items:center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>è¿”å›
            </div>
            <div style="font-size:17px; font-weight:600;">è¿‡å¾€å›å“</div>
            <div style="width:50px;"></div>
        </div>
        <div class="app-body" id="vibe-history-list" style="padding: 20px 16px;">
            </div>
    </div>
</div>
<div id="worldApp" class="ios-app-window" style="background:#F2F2F7;">
    <div class="app-header">
        <div class="header-title-big">World</div>
        <div class="header-close-btn" onclick="closeApp('worldApp')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div id="world-grid" class="char-grid">
            </div>
    </div>
</div>

<div id="modal-world-viewer" class="ios-alert-mask" style="display:none; align-items:center; z-index:9500;" onclick="this.style.display='none'">
    <div class="world-minimal-card" onclick="event.stopPropagation()">
        <h1 id="world-v-title">ä¸–ç•Œåç§°</h1>
        <div class="world-line-decor"></div>
        <div class="world-viewer-scroll">
            <p id="world-v-content">è¿™é‡Œæ˜¯è¯¦ç»†çš„å†…å®¹æè¿°...</p>
        </div>
        <div style="display:flex; gap:12px; margin-top:25px;">
            <div class="world-action-btn" onclick="editWorld()">ç¼–è¾‘</div>
            <div class="world-action-btn delete" onclick="deleteWorld()">æŠ¹é™¤</div>
        </div>
    </div>
</div>

<div id="worldEditModal" class="ios-alert-mask" style="align-items:flex-end; z-index:9600;">
    <div class="modal-content" style="border-radius: 30px 30px 0 0; padding-bottom: 50px;">
        <div class="modal-top">
            <span class="modal-h1" id="world-modal-title">æ–°è®¾å®š</span>
            <span class="modal-done" onclick="saveWorld()">å®Œæˆ</span>
        </div>
        <input type="text" id="world-name-in" class="ios-input" placeholder="è¾“å…¥åç§°...">
        <textarea id="world-content-in" class="ios-input" style="height:150px; padding-top:12px;" placeholder="æè¿°å†…å®¹..."></textarea>
        <div class="tool-btn" onclick="document.getElementById('worldEditModal').style.display='none'" style="color:#FF3B30;">å–æ¶ˆ</div>
    </div>
</div>
<div id="chatApp" class="ios-app-window" style="background: #F2F2F7; z-index: 5500;">
    <div class="app-header" id="chat-header">
        <div class="header-title-big" id="chat-tab-title">Chat</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="chat-add-btn" style="display:none; cursor:pointer; color:#007AFF;" onclick="openChatAddChoice()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <div id="chat-close-btn" class="header-close-btn" onclick="closeApp('chatApp')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <div class="app-body" style="padding: 0; position: relative;">
        
        <div id="chat-panel-msg" class="chat-tab-panel active" style="display: flex; flex-direction: column; overflow: hidden !important;">
    
            <div class="chat-fixed-header" style="background: #fff; z-index: 10;">
                <div class="chat-section-label">Moments</div>
                <div class="chat-friend-ring-container" style="border-bottom:none; padding-bottom:10px;">
                    <div id="chat-friend-ring" class="friend-ring-wrapper">
                        </div>
                </div>
                <div class="chat-section-label" style="border-top: 0.5px solid #F2F2F7; padding-top:15px;">Conversations</div>
            </div>

            <div id="chat-msg-list" class="msg-list-container" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                </div>
        </div>

        <div id="chat-panel-list" class="chat-tab-panel">
            <div style="padding: 10px 16px; background:#F2F2F7;">
                <div class="segment-control" style="margin-bottom:0;">
                    <div class="segment-btn active" id="chat-subtab-friends" onclick="switchChatSubTab('friends')">å¥½å‹</div>
                    <div class="segment-btn" id="chat-subtab-groups" onclick="switchChatSubTab('groups')">ç¾¤èŠ</div>
                </div>
            </div>

            <div id="chat-list-content" style="padding: 0 16px; height: calc(100% - 60px); overflow-y: auto;">
                </div>
        </div>

        <div id="chat-panel-moments" class="chat-tab-panel">
            <div style="padding: 20px; color: #999; text-align: center; margin-top: 50px;">æ¢ç´¢è§’è‰²çš„ç”Ÿæ´»ç¢ç‰‡</div>
        </div>

        <div id="chat-panel-me" class="chat-tab-panel">
            <div style="padding: 30px 20px; display: flex; flex-direction: column; align-items: center;">
                <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin-bottom: 15px;"></div>
                <div style="font-weight: 800; font-size: 20px;">User</div>
            </div>
        </div>
    </div>

    <div class="chat-nav-wrapper">
        <div class="chat-bottom-nav">
            <div class="nav-item active" onclick="switchChatTab('msg', 'Messages', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                <span>æ¶ˆæ¯</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('list', 'Contacts', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>åˆ—è¡¨</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('moments', 'Moments', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                <span>åŠ¨æ€</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('me', 'Profile', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>æˆ‘çš„</span>
            </div>
        </div>
    </div>
</div>
<div id="modal-chat-add-choice" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index:9800;">
    <div class="ios-action-sheet">
        <div class="sheet-title-box">æ–°è”ç³»äºº/è®¨è®ºç»„</div>
        <div class="sheet-item" onclick="openAddFriendPage()">æ·»åŠ å•ä¸ªå¥½å‹</div>
        <div class="sheet-item" onclick="openAddGroupPage()">å‘èµ·ç¾¤ç»„èŠ</div>
        <div class="sheet-cancel" onclick="document.getElementById('modal-chat-add-choice').style.display='none'">å–æ¶ˆ</div>
    </div>
</div>

<div id="page-add-friend" class="ios-app-window" style="background:#F2F2F7; z-index:9900; transform:translateY(100%);">
    <div class="app-header">
        <div onclick="closeChatSubPage('page-add-friend')" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">æ·»åŠ å¥½å‹</div>
        <div class="modal-done" onclick="saveChatFriend()">å®Œæˆ</div>
    </div>
    <div class="app-body">
        <div class="segment-control" style="width:100%; margin-bottom:20px;">
            <div class="segment-btn active" id="add-mode-create" onclick="setAddMode('create')">æ‰‹åŠ¨åˆ›å»º</div>
            <div class="segment-btn" id="add-mode-role" onclick="setAddMode('role')">è§’è‰²ä¹¦å¯¼å…¥</div>
        </div>
        <div id="panel-add-create" style="width:100%; text-align:center;">
            <div class="char-upload-circle" style="margin:0 auto 20px auto;" onclick="document.getElementById('in-f-avatar').click()">
                <img id="pre-f-avatar" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:50%;">
                <span id="hint-f-avatar">+ å¤´åƒ</span>
            </div>
            <input type="file" id="in-f-avatar" hidden accept="image/*" onchange="handleAvatarPre(this, 'pre-f-avatar', 'hint-f-avatar')">
            <input type="text" id="in-f-name" class="ios-input" placeholder="è¾“å…¥æ˜µç§°">
        </div>
        <div id="panel-add-role" style="display:none; width:100%;">
            <div id="role-picker-grid" class="char-grid"></div>
        </div>
    </div>
</div>

<div id="page-add-group" class="ios-app-window" style="background:#F2F2F7; z-index:9910; transform:translateY(100%);">
    <div class="app-header">
        <div onclick="closeChatSubPage('page-add-group')" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">å‘èµ·ç¾¤èŠ</div>
        <div id="group-submit-btn" style="color:#ccc; font-weight:700;">åˆ›å»º</div>
    </div>
    <div class="app-body">
        <div class="group-info-card">
            <div class="char-upload-circle" style="width:70px; height:70px; flex-shrink:0;" onclick="document.getElementById('in-g-avatar').click()">
                <img id="pre-g-avatar" style="display:none; width:100%; height:100%; object-fit:cover;">
                <span style="font-size:12px; color:#007AFF; font-weight:700;">+ å¤´åƒ</span>
            </div>
            <input type="file" id="in-g-avatar" hidden accept="image/*" onchange="handleAvatarPre(this, 'pre-g-avatar')">
            <input type="text" id="in-g-name" class="ios-input" style="margin:0; border-radius:10px; background:#F2F2F7;" placeholder="è¾“å…¥ç¾¤èŠåç§°...">
        </div>

        <div class="ios-list-group">
            <div class="ios-list-item">
                <span class="item-label">æœŸæœ›äººæ•°</span>
                <div class="item-right">
                    <input type="number" id="in-g-count" value="3" min="2" max="50">
                </div>
            </div>
        </div>

        <div class="tz-group-title">é€‰å–æˆå‘˜ (<span id="g-curr-count">0</span>/<span id="g-need-count">3</span>)</div>
        <div id="group-member-grid">
            </div>
    </div>
</div>
<div id="page-chat-room" class="ios-app-window chat-room-layer" style="background: #F2F2F7; transform: translateX(100%);">
    <div class="chat-room-header">
        <div class="header-glass-btn left" onclick="closeChatRoom()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </div>
        
        <div class="header-contact-info" onclick="openChatProfileFromRoom()">
            <img id="room-contact-avatar" src="" alt="avatar">
            <div class="header-text-stack">
                <span id="room-contact-name">Nickname</span>
                <span class="room-status-text">Online</span>
            </div>
        </div>

        <div class="header-glass-btn right" onclick="openChatSettings()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="19" cy="12" r="1"></circle>
                <circle cx="5" cy="12" r="1"></circle>
            </svg>
        </div>
    </div>

    <div id="chat-messages-container" class="chat-scroll-area">
        <div class="chat-time-divider">TODAY</div>
        </div>

    <div class="chat-room-footer" style="flex-direction: column; height: auto; min-height: 56px; padding: 0;">
        <div id="quote-preview" class="quote-preview-bar" style="display:none; width: 100%; border-radius: 20px 20px 0 0;">
            <div class="quote-content-wrapper">
                <div id="quote-preview-user" class="quote-user-name">Nickname</div>
                <div id="quote-preview-text" class="quote-text-preview">Message content...</div>
            </div>
            <div onclick="cancelQuote()" style="cursor:pointer; padding:5px; color:#8e8e93;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div style="display: flex; align-items: center; width: 100%; padding: 10px 15px; gap: 12px;">
            <div class="footer-add-btn">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <input type="text" id="chat-input-main" class="chat-room-input" placeholder="Type something...">
            <div class="footer-action-btns">
                <div class="action-btn ai" onclick="triggerAiGenerate()"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>
                <div class="action-btn send" onclick="handleSendMessage()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div>
            </div>
        </div>
    </div>
    <div id="multi-select-count" style="position:absolute; top:-30px; left:0; width:100%; text-align:center; font-size:13px; color:#8e8e93; font-weight:600;">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</div>
    <div id="multi-select-bar" class="multi-select-footer">
        <div class="multi-action-item danger" onclick="batchDelete()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            <span>åˆ é™¤</span>
        </div>
        <div class="multi-action-item" onclick="batchScreenshot()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            <span>æˆªå›¾</span>
        </div>
        <div class="multi-action-item" onclick="batchForward()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></svg>
            <span>è½¬å‘</span>
        </div>
        <div class="multi-action-item" style="color:#8e8e93;" onclick="exitMultiSelect()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
</div>
<div id="menu-overlay" class="menu-overlay" onclick="hideBubbleMenu()"></div>

<div id="bubble-menu" class="bubble-context-menu">
    <div class="menu-box">
        <div class="menu-item" onclick="doAction('copy')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></div>
            <span>å¤åˆ¶</span>
        </div>
        <div class="menu-item" onclick="doAction('quote')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
            <span>å¼•ç”¨</span>
        </div>
        <div class="menu-item" onclick="doAction('fav')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></div>
            <span>æ”¶è—</span>
        </div>
        <div class="menu-item" onclick="doAction('multi')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div>
            <span>å¤šé€‰</span>
        </div>
        
        <div id="menu-recall" class="menu-item" onclick="doAction('recall')">
            <div class="menu-icon-circle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M12 7v5l4 2"></path></svg>
            </div>
            <span>æ’¤å›</span>
        </div>
        <div class="menu-item" onclick="doAction('forward')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></svg></div>
            <span>è½¬å‘</span>
        </div>
        <div class="menu-item" onclick="doAction('delete')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>
            <span>åˆ é™¤</span>
        </div>
        <div class="menu-item" onclick="hideBubbleMenu()">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
    <div class="menu-arrow"></div>
</div>
<div id="page-forward-picker" class="ios-app-window" style="z-index: 9999; transform: translateY(100%); background: #F2F2F7;">
    <div class="app-header">
        <div onclick="closeForwardPicker()" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">é€‰æ‹©æ”¶ä»¶äºº</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 0;">
        <div style="padding: 10px 16px; background:#F2F2F7;">
            <div class="segment-control" style="margin-bottom:0;">
                <div class="segment-btn active" id="fwd-tab-friends" onclick="switchForwardTab('friends')">æœ€è¿‘è”ç³»äºº</div>
                <div class="segment-btn" id="fwd-tab-groups" onclick="switchForwardTab('groups')">æˆ‘çš„ç¾¤èŠ</div>
            </div>
        </div>
        
        <div id="forward-list-content" style="padding: 0 16px; height: calc(100% - 60px); overflow-y: auto;">
            </div>
    </div>
</div>
<div id="modal-recalled-viewer" class="ios-alert-mask" style="display:none; align-items:center; z-index:10001;" onclick="this.style.display='none'">
    <div class="recalled-content-card" onclick="event.stopPropagation()">
        <div class="recalled-v-label">RECALLED TRACE</div>
        <div id="recalled-v-text"></div>
        <div class="alert-btn" style="border-top: 0.5px solid #eee; margin: 0 -25px -25px -25px; padding: 16px; color: #007AFF; font-weight: 700; cursor: pointer;" onclick="document.getElementById('modal-recalled-viewer').style.display='none'">Done</div>
    </div>
</div>
<div id="page-chat-settings" class="ios-app-window" style="background: #F2F2F7; z-index: 9200; transform: translateX(100%);">
    
    <div class="app-header" style="background: transparent;">
    
        <div onclick="closeChatSettings()" style="color:#007AFF; font-size:16px; display:flex; align-items:center; cursor:pointer; width:60px; text-shadow: 0 0 10px rgba(255,255,255,0.9);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left:-5px; filter: drop-shadow(0 0 3px rgba(255,255,255,0.8));">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Back
        </div>

        <div style="font-size:17px; font-weight:600; flex:1; text-align:center; color:#000; text-shadow: 0 0 15px rgba(255,255,255,1), 0 0 5px rgba(255,255,255,0.8);">
            è¯¦ç»†è®¾ç½®
        </div>

        <div style="width:60px;"></div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display:block; overflow-y:auto; padding-bottom: 50px;">
    
        <div class="tz-group-title">GENERAL</div>
        
        <div class="ios-list-group" style="padding: 0; overflow: hidden;">

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #007AFF;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">èƒŒæ™¯è®¾ç½®</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content" style="padding: 0;">
                    <div class="bg-config-container">
                        <div class="bg-config-row">
                            <div class="bg-label-group">
                                <span class="bg-main-title">èŠå¤©çª—å£èƒŒæ™¯</span>
                                <span class="bg-sub-hint">æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€ç½‘ç»œé“¾æ¥</span>
                            </div>
                            <div class="bg-preview-box" onclick="openUniversalBgModal('chat')">
                                <div id="preview-thumb-chat" class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>
                                <div class="bg-edit-badge">CHAT</div>
                            </div>
                        </div>

                        <div class="bg-config-row">
                            <div class="bg-label-group">
                                <span class="bg-main-title">è®¾ç½®èœå•èƒŒæ™¯</span>
                                <span class="bg-sub-hint">ä»…æ”¯æŒå›¾ç‰‡ï¼ˆæ–‡ä»¶/URLï¼‰</span>
                            </div>
                            <div class="bg-preview-box" onclick="openUniversalBgModal('settings')">
                                <div id="preview-thumb-settings" class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>
                                <div class="bg-edit-badge">MENU</div>
                            </div>
                        </div>

                        <div class="bg-action-group">
                            <div class="bg-reset-btn" onclick="resetChatBackgrounds()">é‡ç½®</div>
                            <div class="bg-save-btn" onclick="saveChatBackgroundSettings()">ä¿å­˜æ›´æ”¹</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #34C759;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">Ta çš„èµ„æ–™</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openCharProfileEditPage()">ç¼–è¾‘è¯¦ç»†èµ„æ–™</div>
                    <div class="sub-setting-btn" onclick="openChatProfileFromSettings()">æŸ¥çœ‹é¢„è§ˆåç‰‡</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #AF52DE;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M12 6v10M9 9l3-3 3 3"/></svg>
                    </div>
                    <div class="item-content" style="border:none;">
                        <span class="item-label">ä¸–ç•Œä¹¦å…³è”</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openWorldBindPage()">ä¸–ç•Œä¹¦åè®®é€‰å®š</div>
                    <div class="sub-setting-btn" onclick="openRelationsPage()">æ„å»ºäººé™…å…³ç³»ç½‘</div>
                    
                    <div style="font-size:10px; color:#bbb; text-align:center; margin-top:10px; padding:0 15px;">
                        æç¤ºï¼šå…ˆé€‰å®šä¸–ç•Œåè®®ï¼ŒAI æ‰èƒ½ç²¾å‡†ç”Ÿæˆå…³ç³»ç½‘ã€‚
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #1d1d1f;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">æˆ‘çš„èµ„æ–™</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content" style="padding: 10px 16px 20px 16px;">
                    <div class="sub-setting-btn user-btn-main" onclick="openUserProfileEdit()">ç¼–è¾‘æˆ‘çš„èµ„æ–™</div>
                    <div class="sub-setting-btn user-btn-secondary" onclick="openUserCardPreview()">é¢„è§ˆæˆ‘çš„èµ„æ–™å¡</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #FF9500;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-label">è®°å¿†</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openExclusiveMemories()">ä¸“å±å›å¿†</div>
                    <div class="sub-setting-btn" onclick="openMemorySummary()">è®°å¿†æ€»ç»“</div>
                    
                    <div style="font-size:10px; color:#bbb; text-align:center; margin-top:10px; padding:0 15px;">
                        æç¤ºï¼šåŸºäºé‡å­çº ç¼ åè®®ï¼Œè®°å¿†å°†éšäº’åŠ¨æ·±åº¦è‡ªåŠ¨è§£é”ã€‚
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #AF52DE;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">ç¾åŒ–</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="showToast('ç²’å­ç‰¹æ•ˆï¼šå¼€')">å¼€å¯æ°›å›´ç²’å­</div>
                    <div class="sub-setting-btn" onclick="showToast('æ°”æ³¡æ ·å¼å·²åˆ‡æ¢')">åˆ‡æ¢æ°”æ³¡é£æ ¼</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #5856D6;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M1 1l22 22"/><path d="M1 23L23 1"/><path d="M12 6a6 6 0 0 0-6 6"/><path d="M18 12a6 6 0 0 0-6-6"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">æ„ŸçŸ¥</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="showToast('Haptic Touchï¼šå¢å¼º')">è§¦æ„Ÿåé¦ˆå¼ºåº¦</div>
                    <div class="sub-setting-btn" onclick="showToast('ä¼ æ„Ÿå™¨æ ¡å‡†ä¸­...')">å¿ƒè·³åŒæ­¥æ ¡å‡†</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #8E8E93;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">çº¿ä¸‹</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="showToast('AR æŠ•å½±éœ€è¿æ¥ç¡¬ä»¶')">AR æŠ•å½±æ¨¡å¼</div>
                    <div class="sub-setting-btn" onclick="showToast('ä½ç½®å…±äº«å·²è¯·æ±‚')">å‘èµ·ä½ç½®å…±äº«</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #FF2D55;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                    <div class="item-content" style="border:none;">
                        <span class="item-label">èŠå¤©è®°å½•</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="showToast('æ­£åœ¨æœç´¢...')">æŸ¥æ‰¾å†…å®¹</div>
                    <div class="sub-setting-btn" onclick="showToast('è®°å½•å·²æ‰“åŒ…å¯¼å‡º')">å¯¼å‡ºå¤‡ä»½</div>
                </div>
            </div>

        </div>

        <div class="danger-zone-container">
            <div class="standalone-btn btn-blue-text" onclick="triggerClearHistory()">
                æ¸…ç©ºèŠå¤©è®°å½•
            </div>
            
            <div class="standalone-btn btn-blue-text" onclick="showToast('å·²æ‹‰é»‘è¯¥ç”¨æˆ·')">
                æ‹‰é»‘å¥½å‹
            </div>
            
            <div class="standalone-btn btn-red-text" onclick="triggerDeleteFriend()">
                åˆ é™¤å¥½å‹
            </div>
        </div>

        <div style="text-align:center; font-size:11px; color:#C7C7CC; margin-top:25px; padding-bottom:40px;">
            SECURE CONNECTION v4.2<br>ID: <span id="setting-uid-display">UNKNOWN</span>
        </div>

    </div>

    <div id="subpage-world-bind" class="ios-sub-page">
        <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
            <div onclick="closeSubPage('subpage-world-bind')" style="color:#007AFF;">å–æ¶ˆ</div>
            <div style="font-weight:800;">ç»‘å®šåè®®</div>
            <div onclick="saveWorldBinding()" style="color:#007AFF; font-weight:800;">ä¿å­˜</div>
        </div>
        <div class="app-body" style="padding: 20px 16px;">
            <div class="tz-group-title">é€‰æ‹©æ³¨å…¥çš„è§„åˆ™</div>
            <div id="world-bind-list" class="ios-list-group"></div>
            <div class="tz-group-title">è¡ç”Ÿæ‰©å±•</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openRelationsPage()">
                    <div class="item-content" style="border:none;">
                        <span class="item-label" style="color:#007AFF; font-weight:700;">æŸ¥çœ‹/æ„å»ºäººé™…å…³ç³»ç½‘</span>
                        <div class="item-right"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-relations" class="ios-sub-page">
        <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
            <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
            <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
            <div style="width:40px;"></div>
        </div>
        <div class="app-body" style="padding: 20px 16px;">
            <div id="quantum-loader" class="quantum-loader-overlay">
                <div class="quantum-spinner"></div>
                <div class="quantum-status-text" id="q-status">INITIALIZING...</div>
                <div class="q-progress-container">
                    <div id="q-progress-bar" class="q-progress-bar"></div>
                </div>
            </div>
            <div id="relation-empty-state" style="text-align:center; padding:60px 20px; display:none;">
                <div style="font-size:50px; margin-bottom:20px; filter: grayscale(100%);">ğŸŒ</div>
                <h3 style="color:#1d1d1f; margin-bottom:10px;">å°šæœªè§£æå…³ç³»ç½‘</h3>
                <p style="color:#8e8e93; font-size:13px; line-height:1.6;">AI éœ€è¦æ ¹æ®å·²ç»‘å®šçš„ä¸–ç•Œåè®®<br>ä¸ºè¯¥è§’è‰²ç¼–ç»‡åº•å±‚ç¤¾ä¼šå…³ç³»ã€‚</p>
                <button class="ios-btn primary" style="margin-top:30px; width:180px;" onclick="generateRelationsWithAI()">å¼€å§‹é‡å­è§£æ</button>
            </div>
            <div id="npc-grid" class="char-grid"></div>
            <div id="subpage-relations" class="ios-sub-page">
                <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
                    <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
                    <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
                    <div style="width:40px;"></div>
                </div>
                <div class="app-body" style="padding: 20px 16px;">
                    <div id="relation-empty-state"> ... </div>

                    <div id="npc-grid" class="char-grid"></div>

                    <div id="relation-footer" class="relation-footer-tools" style="display:none;">
                        <div class="btn-extend-network" onclick="generateRelationsWithAI(true)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            æ‰©å±•å…³ç³»åœˆ
                        </div>
                    </div>
                </div>
            </div>

            <div class="npc-pre-footer">              
                <div class="npc-btn-main add" id="npc-add-btn" onclick="handleNPCFriendRequest()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                    <span id="npc-add-text">Add Friend</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modal-universal-uploader" class="ios-alert-mask" style="align-items:flex-end; z-index:20000;">
    <div class="modal-content">
        <div class="modal-top">
            <div style="display:flex; flex-direction:column;">
                <span class="modal-h1" id="uploader-title">è®¾ç½®èƒŒæ™¯</span>
                <span id="uploader-target-tag" class="uploader-type-tag">CHAT WINDOW</span>
            </div>
            <span class="modal-done" onclick="closeUniversalUploader()">å–æ¶ˆ</span>
        </div>

        <div class="url-input-wrapper">
            <input type="text" id="universal-url-in" class="ios-input" placeholder="è¾“å…¥å›¾ç‰‡æˆ–è§†é¢‘çš„ URL...">
            <button class="ios-btn secondary" style="margin-top:8px;" onclick="handleUniversalUrl()">ä½¿ç”¨æ­¤é“¾æ¥</button>
        </div>

        <div style="text-align:center; color:#ccc; font-size:12px; margin-bottom:15px; font-weight:800;">æˆ–</div>

        <input type="file" id="universal-file-in" hidden onchange="handleUniversalFile(this)">
        <button class="ios-btn primary" onclick="document.getElementById('universal-file-in').click()">ä»ç›¸å†Œé€‰æ‹©æ–‡ä»¶</button>
        
        <div style="height:30px;"></div>
    </div>
</div>
<div id="save-success-hud" class="ios-hud">
    <svg class="hud-checkmark" viewBox="0 0 52 52">
        <path d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>
    <div class="hud-text">å·²ä¿å­˜</div>
</div>
<div id="subpage-char-profile" class="ios-sub-page">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-char-profile')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> å–æ¶ˆ
        </div>
        <div style="font-size:17px; font-weight:600;">Taçš„èµ„æ–™</div>
        <div onclick="saveCharProfileChanges()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">ä¿å­˜</div>
    </div>

    <div class="app-body" style="padding: 20px 16px;">
        <div class="profile-edit-header" style="text-align:center; margin-bottom:30px;">
            <div class="char-upload-circle" style="width:100px; height:100px; margin:0 auto 15px auto; box-shadow:0 8px 25px rgba(0,0,0,0.1);" onclick="document.getElementById('edit-char-avatar-file').click()">
                <img id="edit-char-avatar-pre" src="" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
                <div class="bg-edit-badge" style="border-radius:0 0 50px 50px; font-size:8px;">CHANGE</div>
            </div>
            <input type="file" id="edit-char-avatar-file" hidden accept="image/*" onchange="previewProfileAvatar(this)">
            <input type="text" id="edit-char-name" class="ios-input" style="text-align:center; font-size:24px; font-weight:800; background:transparent; border:none;" placeholder="è¾“å…¥æ˜µç§°">
        </div>

        <div class="tz-group-title">äººè®¾èƒŒæ™¯ (BIOGRAPHY)</div>
        <div class="ios-list-group">
            <textarea id="edit-char-desc" class="ios-input" style="height:200px; padding:15px; background:#fff; border:none; margin:0; line-height:1.6;" placeholder="åœ¨è¿™é‡Œå®šä¹‰è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯ã€ä»¥åŠä½ ä»¬çš„æ•…äº‹..."></textarea>
        </div>
        <div class="tz-group-title">ç³»ç»Ÿå…ƒæ•°æ® (METADATA)</div>
            <div class="ios-list-group">
                <div class="ios-list-item">
                    <span class="item-label">è§’è‰² ID</span>
                    <div class="item-right"><span class="item-value" id="meta-char-id">--</span></div>
                </div>
                <div class="ios-list-item" style="border:none;">
                    <span class="item-label">æ ¸å¿ƒåè®®</span>
                    <div class="item-right"><span class="item-value">Encrypted v4.2</span></div>
                </div>
            </div>
        
        <div style="font-size:11px; color:#bbb; padding:10px 16px;">
            æç¤ºï¼šåœ¨æ­¤å¤„ä¿®æ”¹çš„èµ„æ–™å°†åŒæ­¥è‡³è§’è‰²ä¹¦ã€å¥½å‹åˆ—è¡¨åŠ AI è®°å¿†åº“ã€‚
        </div>

    </div>
</div>
<div id="modal-social-card" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="social-card" onclick="event.stopPropagation()">
        
        <div class="social-close-trigger" onclick="document.getElementById('modal-social-card').style.display='none'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>

        <img id="social-v-avatar" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
        
        <h2 id="social-v-name" style="margin-top:12px; font-size:24px; font-weight:800; color:#1d1d1f; letter-spacing:-0.5px;">Name</h2>
        <div class="social-online-tag">ONLINE</div>

        <div class="social-motto" id="social-v-motto" onclick="openEditMottoFromCard()">Signature goes here...</div>

        <div class="social-actions">
            <div class="social-btn-item" onclick="showToast('Message feature is encrypted...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg></div>
                <span>Message</span>
            </div>
            <div class="social-btn-item" onclick="showToast('Voice protocol error...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></div>
                <span>Call</span>
            </div>
            <div class="social-btn-item" onclick="showToast('Video stream unavailable...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></div>
                <span>Video</span>
            </div>
        </div>
    </div>
</div>

<div id="modal-aes-preview" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="aesthetic-preview-card" onclick="event.stopPropagation()">
        <div class="aes-pre-header"><img id="aes-v-avatar" class="aes-pre-avatar" src=""></div>
        <div class="aes-pre-body">
            <h2 id="aes-v-name" class="aes-pre-name">Character</h2>
            <div class="aes-pre-desc-box"><p id="aes-v-desc">Description sync...</p></div>
            <div style="display:flex; gap:12px; margin-top:30px;">
                <div class="aes-footer-btn light" style="flex:1; padding:12px; border-radius:12px; background:#f2f2f7; text-align:center; font-weight:700;" onclick="document.getElementById('modal-aes-preview').style.display='none'">Close</div>
                <div class="aes-footer-btn dark" style="flex:1; padding:12px; border-radius:12px; background:#1d1d1f; color:#fff; text-align:center; font-weight:700;" onclick="openCharProfileEditPage(); document.getElementById('modal-aes-preview').style.display='none';">Edit Profile</div>
            </div>
        </div>
    </div>
</div>
<div id="modal-motto-edit" class="vibe-center-mask" style="display:none; z-index:9700;">
    <div class="ios-alert-box">
        <div class="alert-title">ä¿®æ”¹ç­¾å</div>
        <div style="padding: 15px;">
            <input type="text" id="motto-input" class="ios-input" placeholder="è¾“å…¥æ–°çš„å¿ƒæƒ…..." style="text-align:center;">
        </div>
        <div style="display:flex; border-top:0.5px solid #eee;">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid #eee;" onclick="document.getElementById('modal-motto-edit').style.display='none'">å–æ¶ˆ</div>
            <div class="alert-btn" style="flex:1; font-weight:800;" onclick="saveMotto()">ä¿å­˜</div>
        </div>
    </div>
</div>
<div id="subpage-world-bind" class="ios-sub-page">
    <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
        <div onclick="closeSubPage('subpage-world-bind')" style="color:#007AFF;">å–æ¶ˆ</div>
        <div style="font-weight:800;">ç»‘å®šåè®®</div>
        <div onclick="saveWorldBinding()" style="color:#007AFF; font-weight:800;">ä¿å­˜</div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">é€‰æ‹©æ³¨å…¥çš„è§„åˆ™</div>
        <div id="world-bind-list" class="ios-list-group">
            </div>

        <div class="tz-group-title">è¡ç”Ÿæ‰©å±•</div>
        <div class="ios-list-group">
            <div class="ios-list-item" onclick="openRelationsPage()">
                <div class="item-content" style="border:none;">
                    <span class="item-label" style="color:#007AFF; font-weight:700;">æŸ¥çœ‹/æ„å»ºäººé™…å…³ç³»ç½‘</span>
                    <div class="item-right">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>
        <div style="font-size:11px; color:#bbb; padding:10px; line-height:1.4;">
            æ³¨æ„ï¼šæ„å»ºå…³ç³»ç½‘å‰è¯·ç¡®ä¿å·²å‹¾é€‰å¹¶ä¿å­˜ä¸Šæ–¹ä¸–ç•Œåè®®ï¼Œä»¥ä¾¿ AI ç²¾å‡†ç¼–ç»‡è§’è‰²çº½å¸¦ã€‚
        </div>
    </div>
</div>

<div id="subpage-relations" class="ios-sub-page"> 
    </div>

<div id="subpage-relations" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
        <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 20px 16px;">
        <div id="quantum-loader" class="quantum-loader-overlay">
            <div class="quantum-spinner"></div>
            <div class="quantum-status-text" id="q-status">INITIALIZING...</div>
            <div class="q-progress-container">
                <div id="q-progress-bar" class="q-progress-bar"></div>
            </div>
        </div>

        <div id="relation-empty-state" style="text-align:center; padding:60px 20px; display:none;">
            <div style="font-size:50px; margin-bottom:20px; filter: grayscale(100%);">ğŸŒ</div>
            <h3 style="color:#1d1d1f; margin-bottom:10px;">å°šæœªè§£æå…³ç³»ç½‘</h3>
            <p style="color:#8e8e93; font-size:13px; line-height:1.6;">AI å°†æ ¹æ®å·²ç»‘å®šçš„ä¸–ç•Œåè®®<br>ä¸ºè¯¥è§’è‰²ç¼–ç»‡åº•å±‚ç¤¾ä¼šå…³ç³»ã€‚</p>
            <button class="ios-btn primary" style="margin-top:30px; width:180px;" onclick="generateRelationsWithAI(false)">å¼€å§‹é‡å­è§£æ</button>
        </div>

        <div id="npc-grid" class="char-grid"></div>

        <div id="relation-footer" class="relation-footer-tools" style="display:none;">
            <div class="btn-extend-network" onclick="generateRelationsWithAI(true)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                æ‰©å±•å…³ç³»åœˆ
            </div>
        </div>
    </div>
</div>

<div id="modal-npc-detail" class="vibe-center-mask" style="display:none; z-index:40000;" onclick="this.style.display='none'">
    <div class="npc-detail-card" onclick="event.stopPropagation()">
        <div class="aes-top-bar" style="position: absolute; top: 15px; right: 15px; z-index: 100;">
            <div class="aes-icon-circle close" onclick="document.getElementById('modal-npc-detail').style.display='none'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="npc-pre-header">
            <img id="npc-v-banner" class="npc-pre-banner" src="">
            <img id="npc-v-avatar" class="npc-pre-avatar" src="">
        </div>

        <div class="npc-pre-body">
            <div id="npc-v-name" class="npc-pre-name">NPC Name</div>
            <div id="npc-v-role" class="npc-pre-role">RELATIONSHIP</div>
            <div class="npc-pre-bio" id="npc-v-bio">Loading dossier...</div>
        </div>

        <div class="npc-pre-footer">
            <button class="npc-btn-action minor" onclick="traceNPCStory()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span>å¾€äº‹</span>
            </button>

            <button class="npc-btn-action minor" onclick="handleLikeNPC()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                <span>æ„Ÿå…´è¶£</span>
            </button>
            
            <button class="npc-btn-action main" id="npc-add-btn" onclick="handleSocialSync()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M19 11h6m-3-3v6"/></svg>
                <span id="npc-add-text">ADD CLOSE FRIEND</span>
            </button>
        </div>
    </div>
</div>
<div id="modal-past-decoder" class="ios-alert-mask" style="display:none; z-index:99999;">
    <div class="aesthetic-card past-magazine-style">
        <div class="aes-top-bar">
            <div class="aes-icon-circle close" onclick="closePastDecoder()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="aes-hero">
            <div id="past-hero-blur" class="aes-blur-bg"></div>
            <div class="aes-overlay" style="background: linear-gradient(to bottom, transparent, #fff);"></div>
        </div>

        <div class="aes-float-content">
            <div class="aes-avatar-box">
                <img id="past-avatar-img" src="" alt="avatar">
            </div>
            <div class="aes-title-group">
                <div id="past-name-txt" class="aes-name">åŠ è½½ä¸­...</div>
                <div class="aes-tag">CLASSIFIED MEMORY</div>
            </div>
        </div>

        <div class="aes-scroll-area">
            <div id="past-text-body" class="aes-text-body">
                </div>
            <div class="aes-divider">THE END</div>
        </div>

        <div class="aes-control-bar">
            <button class="aes-btn edit" onclick="closePastDecoder()">å…³é—­æ¡£æ¡ˆ</button>
        </div>
    </div>
</div>
<div id="subpage-user-profile" class="ios-sub-page" style="background:#F2F2F7; z-index: 10000;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-user-profile')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> å–æ¶ˆ
        </div>
        <div style="font-size:17px; font-weight:600;">æœ¬æˆ‘æ¡£æ¡ˆ</div>
        <div onclick="saveUserProfile()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display: block; width: 100%;">
        <div style="text-align:center; margin-bottom:30px;">
            <div class="char-upload-circle" style="width:100px; height:100px; margin:0 auto 15px auto; position:relative; overflow:hidden; border-radius:50%; background:#e5e5ea;" onclick="document.getElementById('user-avatar-file').click()">
                <img id="user-avatar-pre" src="" style="width:100%; height:100%; object-fit:cover; display:block;">
                <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; padding:2px 0;">EDIT</div>
            </div>
            <input type="file" id="user-avatar-file" hidden accept="image/*" onchange="previewUserAvatar(this)">
            <input type="text" id="user-name-in" class="ios-input" style="text-align:center; font-size:22px; font-weight:800; background:transparent;" placeholder="ä½ çš„ç§°å‘¼">
        </div>

        <div class="tz-group-title">é‡å­äººæ ¼è®¾å®š (PERSONA)</div>
        <div class="ios-list-group">
            <textarea id="user-bio-in" class="ios-input" style="height:200px; padding:15px; background:#fff; border:none; margin:0; line-height:1.6;" 
                placeholder="æè¿°ä½ æ˜¯è°ï¼Œä½ ä¸è§’è‰²ä»¬çš„å…±æœ‰å¾€äº‹..."></textarea>
        </div>
        <div style="font-size:11px; color:#bbb; padding:10px 16px;">
            æç¤ºï¼šæ­¤æè¿°å°†ä½œä¸ºæ ¸å¿ƒåè®®åŒæ­¥è‡³ AI äº¤äº’é€»è¾‘ã€‚
        </div>
    </div>
</div>

<div id="modal-user-card" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="aesthetic-preview-card" style="border: 1px solid #1d1d1f; box-shadow: 0 40px 100px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div class="aes-pre-header" style="background: #1d1d1f; height: 120px; position: relative;">
            <img id="user-card-avatar" class="aes-pre-avatar" src="" style="border: 4px solid #fff; border-radius: 20px; transform: translateX(-50%) rotate(2deg);">
        </div>
        <div class="aes-pre-body" style="padding: 70px 25px 35px 25px;">
            <h2 id="user-card-name" class="aes-pre-name">Creator</h2>
            <div class="aes-tag" style="color: #007AFF; border-color: #007AFF; margin-bottom: 25px;">MASTER PROTOCOL</div>
            <div class="aes-pre-desc-box" style="background: #f8f8f9; text-align: left; padding: 18px; border-radius: 18px;">
                <p id="user-card-bio" style="font-family: serif; font-style: italic; color: #444; line-height: 1.6;">å°šæœªè§‰é†’äººæ ¼...</p>
            </div>
            <div class="aes-footer-btn dark" style="margin-top: 30px; padding: 14px; border-radius: 14px; background: #1d1d1f; color: #fff; font-weight: 700; cursor: pointer; text-align: center;" onclick="openUserProfileEdit()">
                ä¿®æ”¹æœ¬æˆ‘æ¡£æ¡ˆ
            </div>
        </div>
    </div>
</div>
<div id="subpage-memory-list" class="ios-sub-page">
    <div class="app-header">
        <div class="header-left" onclick="closeSubPage('subpage-memory-list')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
            <span>è¿”å›</span>
        </div>
        <div class="header-title">æ—¶ç©ºæ¡£æ¡ˆåº“</div>
        <div class="header-right" onclick="window.clearAllMemories()" style="color:#FF3B30; font-size:14px; font-weight:600; cursor:pointer;">
            æ¸…ç©º
        </div>
    </div>
    
    <div class="app-body">
        <div class="memory-hero-area">
            <span class="hero-tag">MEMORIES</span>
            <h1 class="hero-title">æ„Ÿå®˜ç¢ç‰‡</h1>
            <p class="hero-desc">åœ¨æ­¤å¤„å”¤é†’ä¸ Ta è¢«å°å­˜çš„é‡å­ç¾ç»Š</p>
        </div>

        <div id="memory-list-container" class="memory-stagger-grid"></div>

        <div class="memory-footer-bar">
            <button class="btn-awaken-core" onclick="window.triggerGenerateMemory()">
                <div class="ripple-effect"></div>
                <span>å”¤é†’æ–°è®°å¿†</span>
            </button>
        </div>
    </div>
</div>

<div id="modal-memory-cinema" class="cinema-portal">
    <div class="cinema-stage">
        <div class="cinema-close-trigger" onclick="window.closeCinemaMemory()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
        
        <div class="cinema-scroll-layer">
            <div class="cinema-hero-banner">
                <img id="cinema-img" src="" alt="scene">
                <div class="cinema-hero-mask"></div>
                <div class="cinema-title-box">
                    <span id="cinema-tag-ui">LATEST TRACE</span>
                    <h1 id="cinema-title-ui">è½½å…¥ä¸­...</h1>
                </div>
            </div>
            
            <div class="cinema-text-wrapper">
                <div id="cinema-text-content" class="cinema-prose"></div>
                <div class="cinema-footer-decor">âœ¦ FIN âœ¦</div>
            </div>
        </div>
    </div>
</div>

<div id="quantum-loader-overlay" class="quantum-overlay">
    <div class="weaving-core">
        <div class="spider-line"></div>
        <div class="spider-line"></div>
        <div class="spider-line"></div>
    </div>
    <div class="weaving-text">æ­£åœ¨ä»é‡å­çº ç¼ ä¸­ç¼–ç»‡å™äº‹...</div>
</div>
<div id="subpage-memory-summary" class="ios-sub-page">
    <div class="app-header">
        <div class="header-left" onclick="closeSubPage('subpage-memory-summary')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
            <span>è¿”å›</span>
        </div>
        <div class="header-title">è®°å¿†æ€»ç»“åè®®</div>
        <div class="header-right" onclick="window.saveSummarySettings()" style="color:#000; font-weight:800; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">è‡ªåŠ¨æ€»ç»“è§¦å‘é¢‘ç‡</div>
        
        <div class="ios-list-group" style="padding: 25px 20px; display: block;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <span style="font-size:16px; font-weight:700; color:#000;">å¯¹è¯è½®æ•°</span>
                    <span style="font-size:11px; color:#8e8e93; letter-spacing:1px;">ROUNDS PER CYCLE</span>
                </div>
                <span id="summary-rounds-val" style="font-size:32px; font-weight:800; font-family:serif; color:#000;">10</span>
            </div>
            
            <input type="range" id="summary-rounds-slider" min="5" max="50" step="5" value="10" class="ios-slider" 
                oninput="window.updateSummarySlider(this.value)">
            
            <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:10px; color:#ccc; font-weight:700;">
                <span>é«˜é¢‘ç‡ (5)</span>
                <span>æ·±åº¦è®°å¿† (50)</span>
            </div>
        </div>

        <div class="tz-group-title">åè®®è¯´æ˜</div>
        <div class="ios-list-group" style="padding:20px; font-size:13px; line-height:1.6; color:#444; text-align:justify;">
            <p>å½“å¯¹è¯è¾¾åˆ°è®¾å®šè½®æ•°åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¯åŠ¨â€œé‡å­åç¼©â€ç¨‹åºï¼Œå°†å†—é•¿çš„åŸå§‹è®°å½•å‹ç¼©ä¸ºã€æ ¸å¿ƒè®°å¿†ç‚¹ã€‘ã€‚è¿™èƒ½æœ‰æ•ˆèŠ‚çœ AI çš„ Token æ¶ˆè€—ï¼Œå¹¶é˜²æ­¢è§’è‰²å› è®°å¿†è¿‡è½½è€Œäº§ç”Ÿçš„é€»è¾‘æ¼‚ç§»ã€‚</p>
        </div>

        <button class="ios-btn primary" style="background:#000; color:#fff; margin-top:20px;" onclick="window.manualTriggerSummary()">
            æ‰‹åŠ¨æ‰§è¡Œå³æ—¶æ€»ç»“
        </button>

        <div class="tz-group-title">å·²åç¼©çš„æ ¸å¿ƒè®°å¿† (CHRONICLES)</div>
        <div id="summary-cards-container" style="width:100%; display:flex; flex-direction:column; gap:15px;">
            </div>

        <div style="height:50px;"></div>
    </div>
</div>
<div id="ios-notification-shade" class="notification-shade">
    <div class="notif-header-bar">
        <div class="notif-title">é€šçŸ¥ä¸­å¿ƒ</div>
        <div class="notif-clear-btn" onclick="window.clearAllNotifications()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div id="notification-list" class="notif-list-container">
        <div class="notif-empty-state">æ²¡æœ‰æ›´æ—©çš„é€šçŸ¥äº†</div>
    </div>

    <div class="shade-handle-bottom" onclick="window.closeNotificationShade()"></div>
</div>
<div id="iconApp" class="ios-app-window" style="background:#F2F2F7; z-index: 6000;">
    <div class="app-header">
        <div class="header-title-big">Icon Studio</div>
        <div class="header-close-btn" onclick="closeApp('iconApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body" style="padding: 20px 16px; align-items: center;">
        <div id="icon-preview-box" style="width: 120px; height: 120px; background: #fff; border-radius: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 15px 35px rgba(0,0,0,0.1); margin-bottom: 30px; overflow: hidden; border: 4px solid #fff;">
            <img id="icon-pre-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
            <div id="icon-pre-placeholder" style="text-align:center; color:#ccc; font-size:12px; font-weight:700;">PREVIEW</div>
        </div>

        <div class="tz-group-title" style="width:100%; text-align:left;">TARGET APP</div>
        <div class="ios-list-group" style="width:100%;">
            <div class="ios-list-item" onclick="window.openIconTargetPicker()">
                <div class="item-content" style="border:none;">
                    <span class="item-label">ä¿®æ”¹å¯¹è±¡</span>
                    <div class="item-right">
                        <span class="item-value" id="val-icon-target">è¯·é€‰æ‹©...</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="segment-control" style="width: 100%; margin: 20px 0;">
            <div class="segment-btn active" id="icon-tab-file" onclick="switchIconInputMode('file')">æœ¬åœ°æ–‡ä»¶</div>
            <div class="segment-btn" id="icon-tab-url" onclick="switchIconInputMode('url')">ç½‘ç»œé“¾æ¥</div>
        </div>

        <div id="icon-panel-file" style="width:100%;">
            <input type="file" id="icon-file-input" accept="image/*" onchange="handleIconFile(this)" style="display:none;">
            
            <button class="ios-btn primary" style="background:#000;" onclick="document.getElementById('icon-file-input').click()">ä»ç›¸å†Œä¸Šä¼ </button>
        </div>

        <div id="icon-panel-url" style="width:100%; display:none;">
            <input type="text" id="icon-url-in" class="ios-input" placeholder="ç²˜è´´å›¾æ ‡å›¾ç‰‡ URL..." style="background:#fff; border-radius:12px;">
            <button class="ios-btn primary" style="background:#000;" onclick="window.handleIconUrl()">åŒæ­¥ URL</button>
        </div>

        <button class="ios-btn primary" style="margin-top: 30px; background:#007AFF;" onclick="window.saveIconCustomization()">åº”ç”¨å¹¶ä¿å­˜åˆ°æ¡Œé¢</button>
        
        <div style="font-size:11px; color:#bbb; margin-top:20px; text-align:center; line-height:1.5;">
            æç¤ºï¼šå»ºè®®ä½¿ç”¨æ­£æ–¹å½¢å›¾ç‰‡ä»¥è·å¾—æœ€ä½³æ•ˆæœã€‚<br>ä¿å­˜åå°†ç«‹å³è¦†ç›–ç³»ç»Ÿé¢„è®¾å›¾æ ‡ã€‚
        </div>
    </div>
</div>
<div id="subpage-icon-picker" class="ios-sub-page" style="z-index: 7000; background: #F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-icon-picker')" style="color:#007AFF; font-size:16px; cursor:pointer;">å–æ¶ˆ</div>
        <div style="font-weight:700;">é€‰æ‹©ç›®æ ‡ App</div>
        <div style="width:40px;"></div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">SYSTEM & INSTALLED</div>
        <div id="icon-target-list" class="ios-list-group">
            </div>
    </div>
</div>

<script>
    window.executeSummaryProcess = async function(contactId) {
    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
        
        // 1. ç‰©ç†æŠ“å–å†å²è®°å½•
        const history = await getChatHistory(contactId);
        if (history.length < 3) return;

        // 2. æ„é€ ç®€ç»ƒçš„æ€»ç»“è¯·æ±‚
        const chatContext = history.slice(-20).map(m => `${m.role}: ${m.text}`).join('\n');
        const prompt = `è¯·å¯¹ä»¥ä¸‹å¯¹è¯è¿›è¡Œè®°å¿†åç¼©ï¼Œæå–å‡ºæœ€é‡è¦çš„1ä¸ªäº‹å®æˆ–æƒ…æ„Ÿè¿›å±•ã€‚è¦æ±‚ï¼š80å­—ä»¥å†…ï¼Œåƒç§äººæ¡£æ¡ˆã€‚ç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚\n\nå¯¹è¯å†…å®¹ï¼š\n${chatContext}`;

        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.5
            })
        });

        const data = await res.json();
        const summaryText = data.choices[0].message.content.trim();

        // 3. å­˜å…¥æ€»ç»“æ•°æ®åº“
        let summaries = await loadFromDB('summaries_' + contactId) || [];
        summaries.unshift({ timestamp: Date.now(), text: summaryText });
        await saveToDB('summaries_' + contactId, summaries);

        // 4. ğŸš¨ å®æ—¶æ›´æ–° UI 
        if (typeof window.renderSummaryCards === 'function') {
            window.renderSummaryCards(contactId);
        }

        // 5. å¼¹å‡º Push é€šçŸ¥
        window.showPushNotification("æ ¸å¿ƒè®°å¿†å·²åç¼©", "æ–°çš„äººæ ¼èŠ‚ç‚¹å·²å­˜å…¥åè®®ã€‚");

    } catch (e) {
        console.error("âŒ è‡ªåŠ¨æ€»ç»“å¤±è´¥:", e);
    }
};
// ==========================================
// ğŸ§  æ•°æ®é©±åŠ¨ï¼šæ¶ˆæ¯æ‹¦æˆªå®¡è®¡ (å¸¦æ§åˆ¶å°å¯è§†åŒ–)
// ==========================================
window.autoSummaryAuditor = function(contactId) {
    const contact = window.currentChattingWith || { name: "æœªçŸ¥è§’è‰²" };
    const targetRounds = parseInt(localStorage.getItem('summary_rounds_' + contactId) || "10");
    
    let currentCount = parseInt(localStorage.getItem('chat_count_' + contactId) || "0");
    currentCount++; 

    // ğŸš¨ è¿™ä¸€æ®µåœ¨æ§åˆ¶å°ä¼šéå¸¸æ¼‚äº®ï¼Œè®©ä½ ä¸€çœ¼çœ‹åˆ°è¿›åº¦
    console.group(`ğŸ“Š è®°å¿†åè®®ç›‘æ§ [${contact.name}]`);
    console.log(`%c å½“å‰è½®æ•°: ${currentCount} `, "background: #1d1d1f; color: #fff; border-radius: 3px;");
    console.log(`%c è§¦å‘é˜ˆå€¼: ${targetRounds} `, "background: #007AFF; color: #fff; border-radius: 3px;");
    
    const progress = (currentCount / targetRounds * 100).toFixed(0);
    console.log(`%c é‡å­åç¼©è¿›åº¦: ${progress}% `, `color: ${progress >= 100 ? '#FF3B30' : '#34C759'}; font-weight: bold;`);
    console.groupEnd();

    if (currentCount >= targetRounds) {
        console.info("%c ğŸš€ è¾¾åˆ°é˜ˆå€¼ï¼Œæ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ€»ç»“...", "color: #FF9500; font-weight: bold;");
        localStorage.setItem('chat_count_' + contactId, "0"); // è®¡æ•°å½’é›¶
        window.executeSummaryProcess(contactId);
    } else {
        localStorage.setItem('chat_count_' + contactId, currentCount.toString());
    }
};
    // --- ğŸ“± å¼ºåŠ›é€šçŸ¥ä¸­å¿ƒå¼•æ“ ---
let startY = 0;
let isPulling = false;

// 1. ç›‘å¬å…¨å±€è§¦æ§å¼€å§‹
document.addEventListener('touchstart', function(e) {
    // å¦‚æœæ˜¯ä»å±å¹•ä¸ŠåŠéƒ¨åˆ†å¼€å§‹ä¸‹æ‹‰ (y < 80px)
    if (e.touches[0].clientY < 80) {
        startY = e.touches[0].clientY;
        isPulling = true;
    }
}, { passive: true });

// 2. ç›‘å¬æ»‘åŠ¨è¿‡ç¨‹
document.addEventListener('touchmove', function(e) {
    if (!isPulling) return;
    
    let currentY = e.touches[0].clientY;
    let diff = currentY - startY;

    // åªè¦ä¸‹æ»‘è¶…è¿‡ 30px å°±è®¤ä¸ºæ˜¯è¦æ‹‰å‡ºé€šçŸ¥ä¸­å¿ƒ
    if (diff > 30) {
        window.openNotificationShade();
        isPulling = false; // è§¦å‘åé‡ç½®
    }
}, { passive: true });

// 3. åœæ­¢ç›‘å¬
document.addEventListener('touchend', function() {
    isPulling = false;
});

// 4. æ‰§è¡Œå¼€å¯
window.openNotificationShade = function() {
    const shade = document.getElementById('ios-notification-shade');
    if (!shade) return;
    
    shade.style.display = 'flex';
    // å¼ºåˆ¶æµè§ˆå™¨æ¸²æŸ“åå†æ»‘åŠ¨
    setTimeout(() => {
        shade.classList.add('active');
        console.log("System: é€šçŸ¥ä¸­å¿ƒå·²æ¨å…¥");
    }, 10);
};

// 5. æ‰§è¡Œå…³é—­
window.closeNotificationShade = function() {
    const shade = document.getElementById('ios-notification-shade');
    if (shade) {
        shade.classList.remove('active');
        setTimeout(() => {
            shade.style.display = 'none';
        }, 400);
    }
};

// --- ğŸ§¹ ä¸€é”®æ¸…é™¤é€šçŸ¥ä¸­å¿ƒ ---
window.clearAllNotifications = function() {
    // 1. ç‰©ç†æ¸…ç©ºæœ¬åœ°å­˜å‚¨
    localStorage.removeItem('ios_notif_db');
    
    // 2. é‡æ–°æ¸²æŸ“é¡µé¢ï¼ˆä¼šè‡ªåŠ¨æ˜¾ç¤ºç©ºçŠ¶æ€ï¼‰
    window.renderNotificationList();
    
    showToast("å·²æ¸…ç©ºé€šçŸ¥ä¸­å¿ƒ");
};

// ==========================================
// ğŸ”” å¢å¼ºç‰ˆï¼šå•†ç”¨è‡ªæ„ˆé€šçŸ¥å¼•æ“ (é»‘ç™½çº¿æ¡é£é™å®šç‰ˆ)
// ==========================================
window.showPushNotification = function(title, text) {
    let banner = document.getElementById('ios-push-banner');
    
    // ğŸ¨ ä¿æŒä½ å–œæ¬¢çš„é»‘ç™½çº¿æ¡å›¾æ ‡
    const lineIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5"><path d="M12 2v4M12 18v4M4 12H2M22 12h-2" stroke-linecap="round"/><path d="M16 8v8H8V8h8zM9 12h6" stroke-linecap="round"/><rect x="5" y="5" width="14" height="14" rx="2"/></svg>`;

    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'ios-push-banner';
        banner.className = 'ios-banner';
        document.body.appendChild(banner);
    }

    // 1. å¼¹å‡ºé¡¶éƒ¨æ¨ªå¹…
    banner.innerHTML = `
        <div style="border: 1.5px solid #000; border-radius: 10px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">${lineIcon}</div>
        <div style="flex:1; margin-left:12px; overflow:hidden;">
            <div style="font-size:13px; font-weight:800; color:#000;">${title}</div>
            <div style="font-size:12px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${text}</div>
        </div>`;

    void banner.offsetWidth; 
    banner.classList.add('show');

    // 2. ğŸš¨ ã€æ•°æ®æŒä¹…åŒ–ã€‘å­˜å…¥æœ¬åœ°æ¡£æ¡ˆåº“
    const newNotif = {
        id: Date.now(),
        title: title,
        text: text,
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
    };
    let history = JSON.parse(localStorage.getItem('ios_notif_db') || "[]");
    history.unshift(newNotif); // æœ€æ–°æ¶ˆæ¯æ”¾æœ€å‰é¢
    localStorage.setItem('ios_notif_db', JSON.stringify(history));

    // 3. ç«‹å³è§¦å‘æ¸²æŸ“ï¼Œè®©é€šçŸ¥ä¸­å¿ƒåŒæ­¥æ›´æ–°
    window.renderNotificationList();

    setTimeout(() => { if (banner) banner.classList.remove('show'); }, 5000);
};
window.renderNotificationList = function() {
    const list = document.getElementById('notification-list');
    if (!list) return;

    // ä»æœ¬åœ°å­˜å‚¨è¯»å–
    const history = JSON.parse(localStorage.getItem('ios_notif_db') || "[]");
    
    if (history.length === 0) {
        list.innerHTML = `<div class="notif-empty-state">æ²¡æœ‰æ›´æ—©çš„é€šçŸ¥äº†</div>`;
        return;
    }

    // æ¸²æŸ“é»‘ç™½çº¿æ¡æ„Ÿå¡ç‰‡
    list.innerHTML = history.map(item => `
        <div class="notif-item-custom" style="background:rgba(255,255,255,0.1); border-radius:18px; padding:15px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.1);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span style="font-weight:800; font-size:11px; color:rgba(255,255,255,0.8); letter-spacing:1px;">SYSTEM CORE</span>
                <span style="font-size:9px; color:rgba(255,255,255,0.4);">${item.time}</span>
            </div>
            <div style="font-size:14px; font-weight:700; color:#fff; margin-bottom:4px;">${item.title}</div>
            <div style="font-size:12px; color:rgba(255,255,255,0.7); line-height:1.4;">${item.text}</div>
        </div>
    `).join('');
};

// ğŸš¨ è¿™ä¸€æ­¥æœ€å…³é”®ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡
document.addEventListener('DOMContentLoaded', window.renderNotificationList);

// ç‚¹å‡»æ¨ªå¹…è·³è½¬åˆ°æ€»ç»“é¡µ
window.handleNotificationClick = function() {
    document.getElementById('ios-push-banner').classList.remove('show');
    // å¼ºåˆ¶è·³è½¬
    if(typeof window.openMemorySummary === 'function') {
        window.openMemorySummary();
    }
};
    // ==========================================
// ğŸ¬ è®°å¿†è§†ç•Œï¼šè¯¦æƒ…å¼¹çª—é€»è¾‘ (å½»åº•ä¿®å¤ç‰ˆ)
// ==========================================

// 1. å¼ºåŠ›å¼€å¯è¯¦æƒ…é¡µ
window.openCinemaMemory = function(m) {
    const modal = document.getElementById('modal-memory-cinema');
    const titleEl = document.getElementById('cinema-title-ui');
    const contentEl = document.getElementById('cinema-text-content');
    const imgEl = document.getElementById('cinema-img');

    if (!modal || !m) return;

    // 1. å¡«å……æ–‡æœ¬å†…å®¹
    if (titleEl) titleEl.textContent = m.title;
    if (contentEl) {
        // ä½¿ç”¨æ­£åˆ™å°† ã€ã€‘ å’Œ ã€Œã€ è½¬æ¢ä¸ºé»‘ç™½æ ‡æ³¨æ ·å¼
        contentEl.innerHTML = m.content
            .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
            .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>');
    }

    // 2. å¡«å……å°é¢å›¾
    if (imgEl) {
        imgEl.src = m.img;
        imgEl.alt = ""; // ğŸš¨ æ¸…ç©º alt æ–‡æœ¬ï¼Œé˜²æ­¢æ˜¾ç¤ºâ€œsceneâ€å­—æ ·
        
        // å¦‚æœæ•°æ®é‡Œçš„å›¾ç‰‡åäº†ï¼Œè‡ªåŠ¨æ‹¿å½“å‰èŠå¤©å¯¹è±¡çš„å¤´åƒè¡¥ä½
        imgEl.onerror = function() {
            this.src = window.currentChattingWith.avatar;
        };
    }

    // 3. æ‰§è¡ŒåŠ¨ç”»
    modal.style.display = 'flex';
    modal.classList.add('active');
    
    const scroller = modal.querySelector('.cinema-scroll-layer');
    if (scroller) scroller.scrollTop = 0;
};

// 2. ç‰©ç†å…³é—­è¯¦æƒ…é¡µ
window.closeCinemaMemory = function() {
    const modal = document.getElementById('modal-memory-cinema');
    if (modal) {
        modal.classList.remove('active');
        // ç­‰åŠ¨ç”»ç»“æŸåå½»åº•éšè—
        setTimeout(() => {
            modal.style.display = 'none';
        }, 500);
    }
};
    // ğŸš¨ å¿…é¡»æ”¾åœ¨ <script> æ ‡ç­¾çš„æœ€é¡¶éƒ¨ï¼Œä¸è¦æ”¾åœ¨ä»»ä½• function å†…éƒ¨ï¼
var currentUploaderTarget = 'chat'; 
var tempBgData = {
    chat: { type: 'img', data: null },
    settings: { type: 'img', data: null }
};
var tempCharProfileData = { id: null, avatar: null };

// ... å‰©ä¸‹çš„å…¶ä»–ä»£ç  ...
    // --- 1. å…¨å±€å˜é‡å­˜å‚¨è½¬å‘æ•°æ® ---
window.pendingForwardData = []; 
window.forwardTabMode = 'friends';
    var currentQuoteData = null; // å­˜å‚¨å½“å‰å¼•ç”¨çš„æ•°æ®

function cancelQuote() {
    window.currentQuoteData = null;
    const preview = document.getElementById('quote-preview');
    if (preview) preview.style.display = 'none';
}
    // --- ğŸš¨ ç‰©ç†ç½®é¡¶ï¼šå…¨å±€æ“ä½œå˜é‡ ---
var currentActiveBubble = null;
    // ç¡®ä¿è¿™ä¸€è¡Œåœ¨æ‰€æœ‰å‡½æ•°ï¼ˆå¦‚ initChatMsgPanelï¼‰çš„ä¸Šæ–¹
var isMsgPanelRendering = false;
    // åœ¨ script è„šæœ¬å¼€å¤´æ·»åŠ 
window.chatListMode = 'friends';
   // ==========================================
// ğŸš€ å­—ä½“ä¸æ˜¾ç¤ºï¼šç»ˆæé€»è¾‘è¡¥ä¸ (è§£å†³ undefined æŠ¥é”™)
// ==========================================

// 1. åˆå§‹åŒ–é…ç½® (æ”¾åœ¨ script æœ€å‰é¢)
window.currentFontConfig = JSON.parse(localStorage.getItem('ios_font_config')) || {
    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
    size: 16,
    weight: 400,
    colorMain: '#1d1d1f',
    colorDesktop: '#1d1d1f'
};

// 2. å®æ—¶é¢„è§ˆæ›´æ–° (ä¿®å¤ "is not a function" çš„æ ¸å¿ƒ)
window.updateFontPreview = function(type, val) {
    if(type === 'size') {
        window.currentFontConfig.size = val;
        const sd = document.getElementById('size-display');
        if(sd) sd.textContent = val + 'px';
    } else if(type === 'weight') {
        window.currentFontConfig.weight = val;
        const wd = document.getElementById('weight-display');
        if(wd) wd.textContent = val;
    }
    // æ¯æ¬¡æ»‘åŠ¨ï¼Œåªåˆ·æ–°ä¸Šé¢çš„é¢„è§ˆç›’å­ï¼Œä¸åˆ·æ–°æ¡Œé¢é˜²æ­¢å¡é¡¿
    window.updateFontUI();
};

// 3. UI ç•Œé¢åŒæ­¥
window.updateFontUI = function() {
    const pMain = document.getElementById('preview-text-main');
    const pDesk = document.getElementById('preview-text-desktop');
    const cfg = window.currentFontConfig;
    
    // ç”Ÿæˆé¢„è§ˆæ ·å¼
    const fontBase = `font-family:${cfg.family}; font-size:${cfg.size}px; font-weight:${cfg.weight};`;

    if(pMain) pMain.style.cssText = fontBase + `color:${cfg.colorMain}; text-align:center;`;
    if(pDesk) pDesk.style.cssText = fontBase + `color:${cfg.colorDesktop}; text-align:center; text-shadow:0 1px 2px rgba(0,0,0,0.2);`;
    
    // åŒæ­¥è°ƒè‰²ç›˜æ–‡å­—
    if(document.getElementById('color-val-main')) document.getElementById('color-val-main').textContent = cfg.colorMain.toUpperCase();
    if(document.getElementById('color-val-desktop')) document.getElementById('color-val-desktop').textContent = cfg.colorDesktop.toUpperCase();
};

// 4. é¢œè‰²å˜åŠ¨å®æ—¶è§¦å‘
window.updateColorPreview = function(target, val) {
    if(target === 'main') window.currentFontConfig.colorMain = val;
    else window.currentFontConfig.colorDesktop = val;
    window.updateFontUI();
};

// 5. ä¿å­˜å¹¶åº”ç”¨åˆ°å…¨å±€ (åªæ”¹çš®è‚¤ï¼Œä¸æ”¹åœ°åŸº)
window.saveFontSettings = function() {
    localStorage.setItem('ios_font_config', JSON.stringify(window.currentFontConfig));
    window.applyGlobalStyles(); // åº”ç”¨åˆ°å…¨å±€é’©å­
    showToast("Display Settings Applied!");
    closeSubPage('subpage-display');
};

// 6. å…¨å±€æ ·å¼é’©å­ (ä¿æŠ¤æ¡Œé¢å¸ƒå±€çš„æ ¸å¿ƒ)
window.applyGlobalStyles = function() {
    const target = document.body; // æŠŠå˜é‡æŒ‚åœ¨ body ä¸Š
    const cfg = window.currentFontConfig;
    
    target.style.setProperty('--dynamic-font-family', cfg.family);
    target.style.setProperty('--dynamic-app-size', cfg.size + 'px');
    target.style.setProperty('--dynamic-app-weight', cfg.weight);
    target.style.setProperty('--dynamic-app-color', cfg.colorMain);
    target.style.setProperty('--dynamic-desktop-color', cfg.colorDesktop);
};

// 7. è¿›å…¥é¡µé¢æ—¶çš„åŠ è½½é€»è¾‘
window.loadFontSettings = function() {
    const cfg = window.currentFontConfig;
    // åŒæ­¥è°ƒè‰²ç›˜
    if(document.getElementById('color-picker-main')) document.getElementById('color-picker-main').value = cfg.colorMain;
    if(document.getElementById('color-picker-desktop')) document.getElementById('color-picker-desktop').value = cfg.colorDesktop;
    // åŒæ­¥æ»‘åŠ¨æ¡
    const fs = document.getElementById('font-size-slider');
    const fw = document.getElementById('font-weight-slider');
    if(fs) { fs.value = cfg.size; updateSliderFill(fs); }
    if(fw) { fw.value = cfg.weight; updateSliderFill(fw); }
    
    window.updateFontUI();
};
// 1. ç¡®ä¿å…¨å±€å˜é‡é¦–å…ˆè¢«åˆå§‹åŒ–
window.currentFontConfig = JSON.parse(localStorage.getItem('ios_font_config')) || {
    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
    size: 16,
    weight: 400,
    colorMain: '#1d1d1f',
    colorDesktop: '#1d1d1f'
};

// 2. è¡¥å…¨ç¼ºå¤±çš„ openFontPicker å‡½æ•°
window.openFontPicker = function() {
    const list = document.getElementById('model-sheet-list');
    const sheet = document.getElementById('modelPickerSheet');
    const title = document.querySelector('.sheet-title-box');
    
    if(!list || !sheet) return;

    title.textContent = "Select Font Style";
    list.innerHTML = `
        <div class="sheet-item" onclick="window.selectFont('default')">System Default</div>
        <div class="sheet-item" style="font-family: serif;" onclick="window.selectFont('serif')">Serif (Classic)</div>
        <div class="sheet-item" style="font-family: monospace;" onclick="window.selectFont('mono')">Monospace (Code)</div>
    `;
    sheet.style.display = 'flex';
};

window.selectFont = function(type) {
    if(type === 'default') window.currentFontConfig.family = '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif';
    else if(type === 'serif') window.currentFontConfig.family = '"Times New Roman", Times, serif';
    else if(type === 'mono') window.currentFontConfig.family = '"Courier New", Courier, monospace';
    
    window.updateFontUI();
    document.getElementById('modelPickerSheet').style.display = 'none';
};

// 3. è¡¥å…¨ handleFontUpload å‡½æ•°
window.handleFontUpload = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        showToast("Importing Font...");
        reader.onload = function(e) {
            const fontData = e.target.result;
            const customFont = new FontFace('UserFont', `url(${fontData})`);
            customFont.load().then(f => {
                document.fonts.add(f);
                window.currentFontConfig.family = 'UserFont, sans-serif';
                window.currentFontConfig.fontDataUrl = fontData;
                window.updateFontUI();
                showToast("Font Loaded!");
            });
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åº”ç”¨ä¸€æ¬¡é¢œè‰²
window.applyGlobalStyles();

// ä½¿ç”¨ window ç¡®ä¿å…¨å±€å¯è§
window.currentEditingField = "";

// --- 1. ç»Ÿä¸€ ID æ˜ å°„å‡½æ•° (ç¡®ä¿ç²¾å‡†å®šä½) ---
window.getHubElementId = function(field) {
    if (field === 'hero') return 'hub-hero-img';
    if (field === 'moment_img') return 'hub-moment-img';
    if (field === 'vibe_img') return 'hub-vibe-img'; // ä¸º Row 5 å‡†å¤‡
    
    // å¤„ç† app å›¾æ ‡å’Œåå­—
    if (field.startsWith('app')) {
        const num = field.match(/\d+/)[0];
        return field.includes('img') ? `hub-app-img-${num}` : `hub-app-name-${num}`;
    }
    
    // å¤„ç†æ™®é€šæ–‡å­—: moment_title -> hub-moment-title
    return 'hub-' + field.replace(/_/g, '-');
};

// --- 2. æ‰“å¼€ç¼–è¾‘å™¨ (ä¿®å¤äº†å›¾ç‰‡è¯†åˆ«é€»è¾‘) ---
window.editHubField = function(field) {
    console.log("å½“å‰ç‚¹å‡»å­—æ®µ:", field); // è°ƒè¯•ç”¨ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹æœ‰æ²¡æœ‰ç‚¹å¯¹
    window.currentEditingField = field;
    
    const modal = document.getElementById('p2-editor-modal');
    const titleEl = document.getElementById('p2-editor-title');
    const inputEl = document.getElementById('p2-main-input');
    const uploadArea = document.getElementById('p2-upload-area');

    if (!modal) return;
    modal.style.display = 'flex';

    // === æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¼ºåˆ¶å›¾ç‰‡ç™½åå• ===
    // åªè¦å­—æ®µåæ˜¯ heroï¼Œæˆ–è€…åŒ…å« 'img'ï¼Œå°±å¼ºåˆ¶åˆ¤å®šä¸ºå›¾ç‰‡
    const isImageField = (field === 'hero') || (field.indexOf('img') !== -1);

    if (isImageField) {
        // --- å›¾ç‰‡æ¨¡å¼ ---
        titleEl.textContent = "æ›´æ¢å›¾ç‰‡ (URLæˆ–ä¸Šä¼ )";
        if (uploadArea) uploadArea.style.display = 'block';
        if (inputEl) {
            inputEl.placeholder = "ç²˜è´´å›¾ç‰‡é“¾æ¥...";
            inputEl.value = ""; // å›¾ç‰‡æ¨¡å¼ä¸‹æ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢è¯¯æ˜¾ç¤ºBase64ä»£ç 
        }
    } else {
        // --- æ–‡å­—æ¨¡å¼ ---
        titleEl.textContent = "ä¿®æ”¹æ–‡å­—å†…å®¹";
        if (uploadArea) uploadArea.style.display = 'none';
        
        // è·å–å½“å‰æ–‡å­—å¹¶å›å¡«
        let currentText = "";
        const targetId = window.getHubElementId(field);
        const targetEl = document.getElementById(targetId);
        if (targetEl) {
            currentText = targetEl.textContent.replace(/"/g, ''); 
        }
        if (inputEl) {
            inputEl.value = currentText;
            inputEl.placeholder = "è¾“å…¥æ–°å†…å®¹...";
        }
    }
};

// --- 3. åº”ç”¨ä¿®æ”¹ ---
window.applyP2Changes = function(field, value) {
    if (!value) return;

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    try {
        localStorage.setItem(`hub_p2_${field}`, value);
    } catch (e) {
        // å¦‚æœå›¾ç‰‡æ˜¯ Base64 ä¸”å¤ªå¤§ï¼Œä¼šè§¦å‘è¿™ä¸ªé”™è¯¯
        console.error("å­˜å‚¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡ä½“ç§¯è¿‡å¤§:", e);
        if (field.indexOf('img') !== -1) {
            alert("ä¿å­˜å¤±è´¥ï¼šå›¾ç‰‡ä½“ç§¯è¶…è¿‡æµè§ˆå™¨é™åˆ¶ï¼Œè¯·å°è¯•ä½¿ç”¨å›¾ç‰‡é“¾æ¥(URL)ã€‚");
            return;
        }
    }

    // åŒæ­¥åˆ°é¡µé¢ DOM
    const targetId = window.getHubElementId(field);
    const el = document.getElementById(targetId);

    if (el) {
        const isImage = field === 'hero' || field.indexOf('img') !== -1;
        if (isImage) {
            el.src = value;
        } else {
            el.textContent = (field.indexOf('desc') !== -1) ? `"${value}"` : value;
        }
    }
};

// --- 4. åˆå§‹åŒ– ---
const P2_PERSIST_FIELDS = [
    'hero', 'hero_tag', 'hero_title', 'hero_desc',           // Row 1-2
    'moment_img', 'moment_title', 'moment_desc',           // Row 3-4 Card
    'vibe_img', 'vibe_text',                                // Row 5 Bar
    'app3_img', 'app3_name', 'app4_img', 'app4_name',       // Row 3-4 Apps
    'app5_img', 'app5_name', 'app6_img', 'app6_name',       // Row 3-4 Apps
    'app7_img', 'app7_name', 'app8_img', 'app8_name'        // Row 6 Apps
];

// --- 2. é¡µé¢åŠ è½½åˆå§‹åŒ–ï¼šä»æœ¬åœ°å­˜å‚¨è¿˜åŸå†…å®¹ ---
window.initP2Data = function() {
    console.log("æ­£åœ¨åŒæ­¥ç¬¬äºŒé¡µæ•°æ®...");
    
    P2_PERSIST_FIELDS.forEach(field => {
        const savedValue = localStorage.getItem(`hub_p2_${field}`);
        
        if (savedValue) {
            // è·å–å¯¹åº”çš„ HTML å…ƒç´  ID
            const targetId = window.getHubElementId(field);
            const el = document.getElementById(targetId);
            
            if (el) {
                // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡å­—å¹¶è¿˜åŸ
                const isImage = field === 'hero' || field.indexOf('img') !== -1;
                if (isImage) {
                    el.src = savedValue;
                } else {
                    // å¦‚æœæ˜¯æè¿°ç±»æ–‡å­—ï¼Œè‡ªåŠ¨è¡¥ä¸Šå¼•å·
                    el.textContent = (field.indexOf('desc') !== -1) ? `"${savedValue}"` : savedValue;
                }
            }
        }
    });
};

// å¼¹çª—å…³é—­ä¸æ–‡ä»¶å¤„ç†é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
window.closeP2Editor = function() {
    const val = document.getElementById('p2-main-input').value;
    if (val) window.applyP2Changes(window.currentEditingField, val);
    document.getElementById('p2-editor-modal').style.display = 'none';
};
window.handleP2File = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            window.applyP2Changes(window.currentEditingField, e.target.result);
            document.getElementById('p2-editor-modal').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
};
document.addEventListener('DOMContentLoaded', window.initP2Data);

    let tempImg = null;       
    let tempVid = null;       
    let tempVidThumb = null;

    let editingCharId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘/æŸ¥çœ‹çš„è§’è‰²ID
    let tempCharAvatar = null; // æš‚å­˜å¤´åƒ
    
// === 0. æ•°æ®åº“å·¥å…· (è§£å†³è§†é¢‘æ— æ³•ä¿å­˜çš„é—®é¢˜) ===
const dbName = "WallDB";
const storeName = "wallpapers";

function openDB() {
    return new Promise((resolve, reject) => {
        // æå‡ç‰ˆæœ¬å·åˆ° 3ï¼Œç¡®ä¿è§¦å‘æ›´æ–°é€»è¾‘
        const req = indexedDB.open("WallDB", 5); 

        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            // ç¡®ä¿è¿™äº›â€œå‘ä½â€éƒ½å­˜åœ¨
            if (!db.objectStoreNames.contains("wallpapers")) db.createObjectStore("wallpapers", { keyPath: "id" });
            if (!db.objectStoreNames.contains("chat_history")) db.createObjectStore("chat_history", { keyPath: "contactId" });
            if (!db.objectStoreNames.contains("chat_list")) db.createObjectStore("chat_list", { keyPath: "id" });
            if (!db.objectStoreNames.contains("world_list")) db.createObjectStore("world_list", { keyPath: "id" });
            if (!db.objectStoreNames.contains("chat_friends")) db.createObjectStore("chat_friends", { keyPath: "id" });
        };

        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

// è¾…åŠ©ï¼šä¿å­˜å•æ¡æ¶ˆæ¯
async function saveChatMessage(contactId, msgObj) {
    const db = await openDB();
    const tx = db.transaction("chat_history", "readwrite");
    const store = tx.objectStore("chat_history");
    const req = store.get(contactId);
    
    return new Promise((resolve) => {
        req.onsuccess = async () => {
            let data = req.result ? req.result.messages : [];
            data.push(msgObj);
            store.put({ contactId: contactId, messages: data });
            // ğŸš¨ è¿™é‡Œåˆ æ‰äº† window.autoSummaryAuditor(contactId);
            resolve();
        };
    });
}

// è¾…åŠ©ï¼šè·å–æŸä¸ªäººçš„å†å²è®°å½•
async function getChatHistory(contactId) {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction("chat_history", "readonly");
        const store = tx.objectStore("chat_history");
        const req = store.get(contactId);
        req.onsuccess = () => resolve(req.result ? req.result.messages : []);
    });
}

async function saveToDB(key, data) {
    const db = await openDB();
    const tx = db.transaction(storeName, "readwrite");
    tx.objectStore(storeName).put({ id: key, data: data });
}

async function loadFromDB(key) {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction(storeName, "readonly");
        const req = tx.objectStore(storeName).get(key);
        req.onsuccess = () => resolve(req.result ? req.result.data : null);
    });
}
    // === ä¿®å¤é‡ç‚¹3ï¼šæ•°æ®æŒä¹…åŒ– (åˆ·æ–°ä¸ä¸¢å¤±) ===
    async function loadSavedData() {
        // 1. åŠ è½½æ¡Œé¢å°ç»„ä»¶æ•°æ® (å›¾ç‰‡ã€é‡‘å¥ã€åŸå¸‚) - ä» localStorage
        const sImg = localStorage.getItem('ios_img');
        const sQuote = localStorage.getItem('ios_quote');
        const sCity = localStorage.getItem('ios_city');

        if(sImg) document.getElementById('ui-img').src = sImg;
        if(sQuote) document.getElementById('ui-quote').textContent = `"${sQuote}"`;
        
        if(sCity) {
            const c = JSON.parse(sCity);
            fetchW(c.lat, c.lon, c.name);
        } else {
            fetchW(40.7829, -73.9654, 'New York');
        }

        // 2. åŠ è½½å£çº¸æ•°æ® - ä» IndexedDB (å¤§æ–‡ä»¶å­˜å‚¨)
        const wType = localStorage.getItem('user_wall_type');
        const wData = await loadFromDB('current_wall_data');
        
        if(wType && wData) {
            const bgVid = document.getElementById('bg-video');

            if(wType === 'img') {
                // åº”ç”¨å›¾ç‰‡å£çº¸
                document.body.style.background = `url(${wData}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                // ç¡®ä¿è§†é¢‘å±‚éšè—
                if(bgVid) { 
                    bgVid.style.display = 'none'; 
                    bgVid.src = ""; 
                }
            } else if(wType === 'vid') {
                // åº”ç”¨è§†é¢‘å£çº¸
                if(bgVid) {
                    bgVid.src = wData;
                    bgVid.style.display = 'block';
                    bgVid.play().catch(e => console.log("Auto-play blocked"));
                }
            }
        }
        
        // 3. åŠ è½½å£çº¸å†å²è®°å½•åˆ—è¡¨
        renderHistory();
        await initCharApp();
        await initWorldApp();
        applyBackgroundsToUI();
    }

    // ==========================================
    // 3. æ ¸å¿ƒåŠŸèƒ½: æ—¶é—´ (å…¨å±€æ—¶åŒºé‡å†™ç‰ˆ)
    // ==========================================
    
    // æ‰“å¼€å­é¡µé¢é€šç”¨å‡½æ•°
function openSubPage(id) {
    const el = document.getElementById(id);
    if(el) {
        el.classList.add('active');
        // å¦‚æœæ˜¯æ—¶åŒºé¡µï¼Œé¡ºä¾¿æ›´æ–°ä¸€ä¸‹å‹¾é€‰çŠ¶æ€
        if(id === 'subpage-timezone' && typeof updateTimezoneCheckmarks === 'function') {
            updateTimezoneCheckmarks();
        }
    } else {
        console.error("æ‰¾ä¸åˆ°å­é¡µé¢:", id);
    }
}

// å…³é—­å­é¡µé¢
function closeSubPage(id) {
    const el = document.getElementById(id);
    if(el) el.classList.remove('active');
}

    // è®¾ç½®æ—¶åŒº
    function setTimezone(tzVal, cityName) {
        if(tzVal === '') {
            localStorage.removeItem('user_timezone');
            localStorage.removeItem('user_city_name');
            document.getElementById('val-timezone').textContent = "Automatic";
        } else {
            localStorage.setItem('user_timezone', tzVal);
            localStorage.setItem('user_city_name', cityName);
            document.getElementById('val-timezone').textContent = cityName;
        }
        
        // ç«‹å³åˆ·æ–°æ—¶é—´æ˜¾ç¤º
        tick();
        
        // è§†è§‰åé¦ˆ
        updateTimezoneCheckmarks();
        setTimeout(() => closeSubPage('subpage-timezone'), 200); // é€‰å®Œè‡ªåŠ¨è¿”å›ï¼Œä½“éªŒæ›´å¥½
    }

    // æ›´æ–°åˆ—è¡¨å‹¾é€‰çŠ¶æ€
    function updateTimezoneCheckmarks() {
        // æ¸…é™¤æ‰€æœ‰å‹¾
        document.querySelectorAll('.item-check').forEach(el => el.classList.remove('active'));
        
        const currentTz = localStorage.getItem('user_timezone');
        if(!currentTz) {
            document.getElementById('check-auto').classList.add('active');
        } else {
            // IDé‡Œå¯èƒ½æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨ getElementById éœ€è¦è½¬ä¹‰ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼š
            // å› ä¸ºæˆ‘çš„ ID æ˜¯ check-Asia/Shanghai è¿™ç§æ ¼å¼
            const target = document.getElementById('check-' + currentTz);
            if(target) target.classList.add('active');
        }
    }

    // â° æ ¸å¿ƒæ—¶é—´å‡½æ•° (æ”¯æŒæ—¶åŒº) â°
    function tick() {
        const tz = localStorage.getItem('user_timezone'); // è·å–å­˜å‚¨çš„æ—¶åŒº
        const now = new Date();
        
        // 1. è·å–æ—¶é—´å­—ç¬¦ä¸²
        let timeString;
        try {
            // ä½¿ç”¨ Intl API è½¬æ¢æ—¶åŒº
            timeString = now.toLocaleTimeString('en-GB', {
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false,
                timeZone: tz || undefined // å¦‚æœ tz ä¸ºç©ºï¼Œå°±ç”¨ç³»ç»Ÿé»˜è®¤
            });
        } catch(e) {
            // å…œåº•ï¼šå¦‚æœæ—¶åŒºæ ¼å¼ä¸å¯¹ï¼Œå›é€€åˆ°æœ¬åœ°æ—¶é—´
            timeString = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
        }

        document.getElementById('clock').textContent = timeString;

        // 2. æ—¥æœŸæ˜¾ç¤º (ä¹Ÿéœ€è¦æ ¹æ®æ—¶åŒºå˜)
        const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
        const months = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
        
        // ä¸ºäº†è·å–æ­£ç¡®çš„æ—¥æœŸï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨è¯¥æ—¶åŒºä¸‹çš„ Date å¯¹è±¡æ¦‚å¿µ
        // è¿™é‡Œç”¨ç®€å•çš„ toLocaleDateString è½¬æ¢
        const dateOptions = { weekday: 'long', month: 'long', day: 'numeric', timeZone: tz || undefined };
        const dateStrParts = now.toLocaleDateString('en-US', dateOptions).toUpperCase().split(', ');
        // dateStrParts å¤§æ¦‚æ˜¯ ["SUNDAY", "JANUARY 1"] è¿™ç§æ ¼å¼
        
        if(dateStrParts.length >= 2) {
            document.getElementById('ui-day').textContent = dateStrParts[0]; // æ˜ŸæœŸ
            // å‰©ä¸‹çš„éƒ¨åˆ†å»æ‰å¹´ä»½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            let datePart = dateStrParts[1]; 
            document.getElementById('ui-date').textContent = datePart;
        }

        // 3. è¿›åº¦æ¡ (æ ¹æ®å°æ—¶è®¡ç®—)
        // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è§£æåˆšåˆšç”Ÿæˆçš„ timeString (HH:MM)
        const [hh, mm] = timeString.split(':').map(Number);
        const totalSec = hh * 3600 + mm * 60 + now.getSeconds();
        const percent = (totalSec / 86400) * 100;
        
        const bar = document.getElementById('prog-bar');
        if(bar) {
            bar.style.width = percent + '%';
            if(percent < 1) bar.style.minWidth = '2%';
        }
        const txt = document.getElementById('prog-txt');
        if(txt) txt.textContent = percent.toFixed(1) + '%';
        
        // åˆå§‹åŒ–æ—¶æ›´æ–°è®¾ç½®é¡µçš„æ–‡å­—çŠ¶æ€
        const savedCity = localStorage.getItem('user_city_name');
        const valTz = document.getElementById('val-timezone');
        if(valTz) valTz.textContent = savedCity || "Automatic";
    }

    async function initBat() {
        const batNum = document.getElementById('bat-num');
        const batBar = document.getElementById('bat-bar');

        // 1. ã€å¼ºåˆ¶å…œåº•ã€‘ï¼šå…ˆæŠŠæ•°å­—å¡«ä¸Šå»ï¼Œä¿è¯ç»å¯¹æœ‰æ˜¾ç¤ºï¼
        batNum.textContent = '100%'; 
        batBar.style.width = '100%';
        batBar.style.background = '#1d1d1f'; // é»˜è®¤é»‘è‰²

        // 2. å°è¯•è·å–çœŸå®ç”µé‡ (ä»…å®‰å“/PCæœ‰æ•ˆ)
        if ('getBattery' in navigator) {
            try {
                const bat = await navigator.getBattery();
                
                const update = () => {
                    const level = Math.round(bat.level * 100);
                    batNum.textContent = level + '%';
                    batBar.style.width = level + '%';
                    
                    if(bat.charging) {
                        batBar.style.background = '#34C759'; // å……ç”µç»¿
                    } else if(level <= 20) {
                        batBar.style.background = '#FF3B30'; // ä½ç”µé‡çº¢
                    } else {
                        batBar.style.background = '#1d1d1f'; // æ­£å¸¸é»‘
                    }
                };
                
                update();
                bat.addEventListener('levelchange', update);
                bat.addEventListener('chargingchange', update);
            } catch (e) {
                // å¦‚æœæŠ¥é”™ï¼Œæ²¡å…³ç³»ï¼Œåæ­£ç¬¬1æ­¥å·²ç»å¡«äº† 100%
                console.log("ç”µé‡APIå—é™ï¼Œä¿æŒå…œåº•æ˜¾ç¤º");
            }
        }
    }

    const ICONS = {
        sun: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSun" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient></defs><circle cx="32" cy="32" r="18" fill="url(#gSun)"/><circle cx="32" cy="32" r="24" fill="none" stroke="#FFD700" stroke-width="2" opacity="0.4"/></svg>`,
        moon: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gMoon" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#E0E0E0"/><stop offset="100%" stop-color="#BDBDBD"/></linearGradient></defs><path d="M48 32c0 11-9 20-20 20-2.5 0-4.8-.5-7-1.3 2.5-1.5 5.5-2.7 8-5.7 6-7 4-18-2-22-2.3-1.5-5-2.2-7.7-2.3C22.6 14.5 27 12 32 12c11 0 16 9 16 20z" fill="url(#gMoon)"/></svg>`,
        partly: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSunS" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient><linearGradient id="gCloud" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#d9d9d9"/></linearGradient></defs><circle cx="24" cy="24" r="14" fill="url(#gSunS)"/><path d="M48 48H30c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5-3.5 15.8-12 15.8z" fill="url(#gCloud)" filter="drop-shadow(0 2px 3px rgba(0,0,0,0.2))"/></svg>`,
        cloud: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gCloudF" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#c0c0c0"/></linearGradient></defs><path d="M46 44H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gCloudF)" filter="drop-shadow(0 4px 6px rgba(0,0,0,0.1))"/></svg>`,
        rain: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gRain" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#cfd9df"/><stop offset="100%" stop-color="#a1c4fd"/></linearGradient></defs><path d="M46 40H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gRain)"/><path d="M22 46l-3 9M32 46l-3 9M42 46l-3 9" stroke="#4facfe" stroke-width="3" stroke-linecap="round"/></svg>`
    };
    
    async function fetchW(lat,lon,name) {
        document.getElementById('ui-city').textContent = name;
        hideM('weatherM');
        localStorage.setItem('ios_city', JSON.stringify({lat, lon, name})); // ä¿å­˜åŸå¸‚

        try {
            const tStamp = new Date().getTime();
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day&timezone=auto&_t=${tStamp}`);
            const data = await res.json();
            const current = data.current;
            const c = current.weather_code;
            const t = Math.round(current.temperature_2m);
            const isDay = current.is_day === 1;
            
            let icon = ICONS.sun;
            if (c === 0) icon = isDay ? ICONS.sun : ICONS.moon;
            else if (c >= 1 && c <= 2) icon = ICONS.partly;
            else if (c === 3 || (c >= 45 && c <= 48)) icon = ICONS.cloud;
            else icon = ICONS.rain;
            
            document.getElementById('ui-temp').textContent = t+'Â°';
            document.getElementById('ui-icon').innerHTML = icon;
        } catch(e) { document.getElementById('ui-city').textContent = "Offline"; }
    }

    function showM(id) { document.getElementById(id).style.display='flex'; }
    function hideM(id) { 
        document.getElementById(id).style.display='none'; 
        if(id==='photoM') {
            const v = document.getElementById('q-in').value;
            if(v) {
                document.getElementById('ui-quote').textContent = `"${v}"`;
                localStorage.setItem('ios_quote', v); // ä¿å­˜æ–‡å­—
            }
        }
    }
    
    function loadF(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const imgData = e.target.result;
                document.getElementById('ui-img').src = imgData;
                try {
                    localStorage.setItem('ios_img', imgData); // ä¿å­˜å›¾ç‰‡
                } catch(err) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œå»ºè®®ç”¨URL"); }
            };
            r.readAsDataURL(input.files[0]);
        }
    }
    
    function loadU() {
        const u = prompt("Paste Image URL:");
        if(u) {
            document.getElementById('ui-img').src = u;
            localStorage.setItem('ios_img', u); // ä¿å­˜å›¾ç‰‡URL
        }
    }

    // å¯åŠ¨
    setInterval(tick,1000); 
    loadSavedData(); // åŠ è½½æ‰€æœ‰ä¿å­˜çš„æ•°æ®
    initBat();

    // åˆ‡æ¢æ ‡ç­¾é¡µåŠŸèƒ½
function switchTab(tab) {
    // 1. å¤„ç†æŒ‰é’®æ ·å¼
    document.getElementById('tab-cn').classList.remove('active');
    document.getElementById('tab-global').classList.remove('active');
    document.getElementById('tab-' + tab).classList.add('active');

    // 2. å¤„ç†å†…å®¹æ˜¾ç¤º
    document.getElementById('view-cn').classList.remove('active');
    document.getElementById('view-global').classList.remove('active');
    document.getElementById('view-' + tab).classList.add('active');
}

// === å£çº¸ App å¢å¼ºç‰ˆé€»è¾‘ ===
    
    // åˆå§‹åŒ–æ—¶åŠ è½½å†å²
    setTimeout(renderHistory, 500);

    function openApp(id) { 
        document.getElementById(id).classList.add('active'); 
        renderHistory(); // æ¯æ¬¡æ‰“å¼€åˆ·æ–°å†å²
    }
    function closeApp(id) { document.getElementById(id).classList.remove('active'); }

    // 1. åˆ‡æ¢ Tab (ä¿®å¤é¢„è§ˆå›¾ä¹±è·‘çš„é—®é¢˜)
    function switchWallTab(type) {
        // æŒ‰é’®æ ·å¼åˆ‡æ¢
        document.getElementById('seg-img').classList.toggle('active', type==='img');
        document.getElementById('seg-vid').classList.toggle('active', type==='vid');
        
        // æ“ä½œé¢æ¿åˆ‡æ¢
        document.getElementById('panel-img').style.display = type==='img' ? 'flex' : 'none';
        document.getElementById('panel-vid').style.display = type==='vid' ? 'flex' : 'none';
        
        // é¢„è§ˆé€»è¾‘é‡å†™ï¼šåªæœ‰å½“æœ‰å†…å®¹æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼Œå¦åˆ™æ˜¾ç¤ºå ä½ç¬¦
        const imgEl = document.getElementById('preview-img');
        const vidEl = document.getElementById('preview-vid');
        const hintEl = document.getElementById('preview-hint');

        if(type === 'img') {
            vidEl.style.display = 'none'; // è—è§†é¢‘
            // å¦‚æœæœ‰æš‚å­˜å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼›å¦åˆ™æ˜¾ç¤ºæ–‡å­—
            if(tempImg) {
                imgEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Image";
            }
        } else {
            imgEl.style.display = 'none'; // è—å›¾ç‰‡
            // å¦‚æœæœ‰æš‚å­˜è§†é¢‘ï¼Œæ˜¾ç¤ºè§†é¢‘
            if(tempVid) {
                vidEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                vidEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Video";
            }
        }
    }

    // === ã€ä¿®æ”¹è¿™é‡Œã€‘ä¿å­˜é€»è¾‘æ”¹ç”¨ IndexedDB ===
    // 1. ä¿å­˜"å½“å‰å£çº¸"çŠ¶æ€
    localStorage.setItem('user_wall_type', cType); // ç±»å‹å­˜ localStorage
    saveToDB('current_wall_data', data); // å¤§æ–‡ä»¶å­˜ DB

    // 2. ä¿å­˜å†å²è®°å½•
    saveToHistory(type, data);
    
    showNativeAlert("Wallpaper Set & Saved!");

    // 2. æ–‡ä»¶å¤„ç† (å…¼å®¹æ€§å¢å¼º)
    function handleWallFile(input, type) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            
            // è§†é¢‘å¤§å°é™åˆ¶ (é¿å…å¡æ­»)
            if(type === 'vid' && file.size > 20 * 1024 * 1024) { 
                showNativeAlert("Video too large! Max 20MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const res = e.target.result;
                if(type === 'img') {
                    tempImg = res;
                    document.getElementById('preview-img').src = res;
                } else {
                    tempVid = res;
                    document.getElementById('preview-vid').src = res;
                }
                // åŠ è½½å®Œç«‹åˆ»åˆ·æ–°é¢„è§ˆåŒºåŸŸ
                switchWallTab(type);
            };
            reader.readAsDataURL(file);
        }
    }

    // 3. è®¾ç½®å£çº¸ (è°ƒç”¨æ–°å¼¹çª— + å¼ºåˆ¶ä¿å­˜)
    // æ‰¾åˆ° setWallpaper å‡½æ•°ï¼Œå®Œå…¨æ›¿æ¢æˆè¿™ä¸ªï¼š
    function setWallpaper(cType) {
        const bgVid = document.getElementById('bg-video');
        // è¿™é‡Œçš„ cType å°±æ˜¯ä½ ä¼ å…¥çš„ 'img' æˆ– 'vid'
        const data = (cType === 'img') ? tempImg : tempVid;

        if(!data) { 
            showNativeAlert("Please select a file first.");
            return; 
        }

        if(cType === 'img') {
            document.body.style.background = `url(${data}) no-repeat center center fixed`;
            document.body.style.backgroundSize = "cover";
            if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
            
            localStorage.setItem('user_wall_type', 'img');
            saveToDB('current_wall_data', data);
            
            // ä¿å­˜å†å² (å›¾ç‰‡è‡ªå·±å°±æ˜¯ç¼©ç•¥å›¾)
            saveToHistory('img', data, data); 

        } else {
            if(bgVid) {
                bgVid.src = data;
                bgVid.style.display = 'block';
                bgVid.play();
            }
            
            localStorage.setItem('user_wall_type', 'vid');
            saveToDB('current_wall_data', data);
            
            // ğŸ‘‡ å…³é”®ä¿®å¤ï¼šè¿™é‡Œä½¿ç”¨å…¨å±€å˜é‡ tempVidThumb
            saveToHistory('vid', data, tempVidThumb || null); 
        }
        
        showNativeAlert("Wallpaper Set Successfully!");
    }

    // 5. å¼¹çª—æ§åˆ¶å‡½æ•°
    function showNativeAlert(msg) {
        document.getElementById('alert-msg').textContent = msg;
        document.getElementById('successAlert').style.display = 'flex';
    }
    function closeAlert() {
        document.getElementById('successAlert').style.display = 'none';
    }

    // åˆå§‹åŒ–åŠ è½½å†å²
    setTimeout(renderHistory, 500);
    // ==========================================
    // ç¼ºå¤±çš„å·¥å…·å‡½æ•° (è¯·è¡¥åœ¨æœ€ä¸‹é¢)
    // ==========================================

    // 1. å¼¹çª—æç¤ºå·¥å…· (è§£å†³ showToast is not defined)
    function showToast(msg) {
        const t = document.getElementById('toast');
        if(t) {
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    }

    // 2. ä¿å­˜å†å²è®°å½•é€»è¾‘
    async function saveToHistory(type, data) {
        // å…ˆè¯»æ—§å†å²
        let history = await loadFromDB('history_list') || [];
        
        // æŸ¥é‡ï¼šå¦‚æœå·²ç»æœ‰äº†ï¼Œåˆ æ‰æ—§çš„
        history = history.filter(item => item.data !== data);
        
        // æ’å…¥æ–°çš„åˆ°æœ€å‰é¢
        history.unshift({ type: type, data: data });
        
        // é™åˆ¶ 6 ä¸ª
        if(history.length > 6) history.pop();
        
        // å­˜å…¥æ•°æ®åº“
        await saveToDB('history_list', history);
        
        // åˆ·æ–°æ˜¾ç¤º
        renderHistory();
    }

    // 3. æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
    // === æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨ (ä¿®å¤ type is not defined æŠ¥é”™) ===
    async function renderHistory() {
    const grid = document.getElementById('wall-history-grid');
    if(!grid) return;
    
    // ä»æ•°æ®åº“è¯»å£çº¸åˆ—è¡¨
    let history = await loadFromDB('history_list') || [];
    grid.innerHTML = ""; 

    history.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        
        let badge = '';
        let content = '';
        
        // æ¸²æŸ“è§†é¢‘æˆ–å›¾ç‰‡é¢„è§ˆ
        if(item.type === 'vid') {
            badge = `<div class="vid-badge">LIVE</div>`;
            // å¦‚æœæœ‰ç¼©ç•¥å›¾ç”¨ç¼©ç•¥å›¾ï¼Œæ²¡æœ‰å°±ç”¨è§†é¢‘é¢„è§ˆ
            if(item.thumb && item.thumb.startsWith('data:image')) {
                 content = `<img src="${item.thumb}" style="opacity:0.8;">`;
            } else {
                 content = `<video src="${item.data}" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; pointer-events:none;"></video>`;
            }
        } else {
            content = `<img src="${item.data}">`;
        }

        div.innerHTML = `${content}${badge}`;

        // ç‚¹å‡»åº”ç”¨å£çº¸çš„é€»è¾‘
        div.onclick = () => {
            if(item.type === 'img') {
                tempImg = item.data;
                document.getElementById('preview-img').src = item.data;
                document.body.style.background = `url(${item.data}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                const bgVid = document.getElementById('bg-video');
                if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
            } else {
                tempVid = item.data;
                document.getElementById('preview-vid').src = item.data;
                const bgVid = document.getElementById('bg-video');
                if(bgVid) {
                    bgVid.src = item.data;
                    bgVid.style.display = 'block';
                    bgVid.play();
                }
            }
            switchWallTab(item.type);
            localStorage.setItem('user_wall_type', item.type);
            saveToDB('current_wall_data', item.data);
            showToast("Restored!");
        };

        grid.appendChild(div);
    });
}

    // 4. åˆå§‹åŒ–åŠ è½½ä¸€æ¬¡å†å²
    setTimeout(renderHistory, 1000);

    // ==========================================
    // 8. è§’è‰²ä¹¦ App é€»è¾‘ (Character Book)
    // ==========================================

    // 1. åˆå§‹åŒ–
    async function initCharApp() {
        await renderCharList();
    }
    // åœ¨ loadSavedData çš„æœ€åè°ƒç”¨å®ƒ (æ‰‹åŠ¨åŠ ä¸€è¡Œ initCharApp();)

    // 2. è§’è‰²å¢åˆ æ”¹æŸ¥ (åŸºäº IndexedDB)
    async function getCharList() {
        return await loadFromDB('char_list') || [];
    }
    async function saveCharList(list) {
        await saveToDB('char_list', list);
    }

    // 3. æ¸²æŸ“åˆ—è¡¨
    async function renderCharList() {
        const grid = document.getElementById('char-grid');
        if(!grid) return;
        
        const list = await getCharList();
        grid.innerHTML = "";
        
        // 1. å…ˆåˆ›å»ºä¸€ä¸ª "Add New" å¡ç‰‡
        const addCard = document.createElement('div');
        addCard.className = 'char-card add-new';
        addCard.onclick = openCharModal; // ç‚¹å‡»è§¦å‘æ–°å»ºå¼¹çª—
        addCard.innerHTML = `
            <svg class="add-icon-big" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <div class="add-text">New Character</div>
        `;
        grid.appendChild(addCard);

        // 2. å†æ¸²æŸ“ç°æœ‰çš„è§’è‰²å¡ç‰‡
        list.forEach(char => {
            const card = document.createElement('div');
            card.className = 'char-card';
            card.innerHTML = `
                <img class="char-card-img" src="${char.avatar || ''}">
                <div class="char-card-info">
                    <div class="char-card-name">${char.name}</div>
                    <div class="char-card-desc">${char.desc}</div>
                </div>
            `;
            card.onclick = () => openCharDetail(char.id);
            grid.appendChild(card);
        });
        
        // (Deleted empty hint logic since we always have the add button)
    }

    // 4. æ‰“å¼€/å…³é—­ App
    function openCharModal() {
        editingCharId = null; // æ–°å»ºæ¨¡å¼
        document.getElementById('modal-title').textContent = "New Character";
        document.getElementById('char-name-in').value = "";
        document.getElementById('char-desc-in').value = "";
        document.getElementById('edit-avatar-preview').style.display = 'none';
        document.getElementById('edit-avatar-hint').style.display = 'block';
        tempCharAvatar = null;
        document.getElementById('charEditModal').style.display = 'flex';
    }
    function closeCharModal() { document.getElementById('charEditModal').style.display = 'none'; }

    // 5. ä¿å­˜è§’è‰² (æ–°å»ºæˆ–ä¿®æ”¹)
    async function saveCharacter() {
        const name = document.getElementById('char-name-in').value;
        const desc = document.getElementById('char-desc-in').value;
        
        if(!name) { showToast("Name is required"); return; }
        
        let list = await getCharList();
        
        if(editingCharId) {
            // ä¿®æ”¹æ¨¡å¼
            const index = list.findIndex(c => c.id === editingCharId);
            if(index !== -1) {
                list[index].name = name;
                list[index].desc = desc;
                if(tempCharAvatar) list[index].avatar = tempCharAvatar;
                // æ›´æ–°è¯¦æƒ…é¡µè§†å›¾
                openCharDetail(editingCharId, list[index]); 
            }
        } else {
            // æ–°å»ºæ¨¡å¼
            if(!tempCharAvatar) { showToast("Avatar is required"); return; }
            const newChar = {
                id: Date.now().toString(),
                name: name,
                desc: desc,
                avatar: tempCharAvatar,
                bg: '' // é»˜è®¤æ— èƒŒæ™¯
            };
            list.unshift(newChar);
        }
        
        await saveCharList(list);
        renderCharList();
        closeCharModal();
        showToast("Saved!");
    }

    // 6. å¤´åƒé¢„è§ˆ
    function previewCharAvatar(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                tempCharAvatar = e.target.result;
                document.getElementById('edit-avatar-preview').src = tempCharAvatar;
                document.getElementById('edit-avatar-preview').style.display = 'block';
                document.getElementById('edit-avatar-hint').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 7. è¯¦æƒ…é¡µé€»è¾‘
    async function openCharDetail(id, charObj = null) {
        let char = charObj;
        if(!char) {
            const list = await getCharList();
            char = list.find(c => c.id === id);
        }
        if(!char) return;

        editingCharId = char.id; // æ ‡è®°å½“å‰æŸ¥çœ‹çš„è§’è‰²
        
        // 1. å¡«å……è¯¦æƒ…é¡µæ•°æ® (è¿™äº› ID è¿˜åœ¨ï¼Œæ‰€ä»¥æ²¡é—®é¢˜)
        const nameEl = document.getElementById('detail-name');
        const descEl = document.getElementById('detail-desc');
        const avtEl = document.getElementById('detail-avatar');
        const bgEl = document.getElementById('detail-bg');

        if(nameEl) nameEl.textContent = char.name;
        // é¢„è§ˆåªæ˜¾ç¤ºå‰50ä¸ªå­—
        if(descEl) descEl.textContent = char.desc.substring(0, 50) + (char.desc.length > 50 ? "..." : "");
        if(avtEl) avtEl.src = char.avatar;
        
        // 2. èƒŒæ™¯å¤„ç†
        if(bgEl) {
            if(char.bg) {
                bgEl.style.backgroundImage = `url(${char.bg})`;
            } else {
                bgEl.style.backgroundColor = '#ddd';
                bgEl.style.backgroundImage = 'none';
            }
        }

        // âŒ åˆ é™¤äº†è¿™é‡ŒåŸæœ¬å¼•ç”¨ 'ins-avatar-img' çš„ä»£ç ï¼Œå› ä¸ºé‚£ä¸ªå…ƒç´ å·²ç»ä¸å­˜åœ¨äº†
        // ç°åœ¨çš„å¼¹çª—æ•°æ®å¡«å……ä¼šåœ¨ç‚¹å‡» "More" (openFullDesc) æ—¶æ‰è¿›è¡Œ

        // 3. æ˜¾ç¤ºè¯¦æƒ…é¡µ
        document.getElementById('char-detail-view').style.display = 'flex';
    }

    function closeDetailView() {
        document.getElementById('char-detail-view').style.display = 'none';
    }

    // 8. è¯¦æƒ…é¡µäº¤äº’ï¼šæ›´æ¢èƒŒæ™¯
    function openBgModal() { document.getElementById('bgChangeModal').style.display = 'flex'; }
    
    function switchBgMode(mode) {
        document.getElementById('bg-seg-file').classList.toggle('active', mode==='file');
        document.getElementById('bg-seg-url').classList.toggle('active', mode==='url');
        document.getElementById('bg-panel-file').style.display = mode==='file'?'block':'none';
        document.getElementById('bg-panel-url').style.display = mode==='url'?'block':'none';
    }

    async function handleBgFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = async e => {
                await updateCharBg(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    async function handleBgUrl() {
        const url = document.getElementById('bg-url-in').value;
        if(url) await updateCharBg(url);
    }

    async function updateCharBg(bgData) {
        let list = await getCharList();
        const index = list.findIndex(c => c.id === editingCharId);
        if(index !== -1) {
            list[index].bg = bgData;
            await saveCharList(list);
            // åˆ·æ–°ç•Œé¢
            document.getElementById('detail-bg').style.backgroundImage = `url(${bgData})`;
            document.getElementById('bgChangeModal').style.display = 'none';
            showToast("Background Updated");
        }
    }

    // === 9. è¯¦æƒ…é¡µäº¤äº’ï¼šé«˜çº§æ‚å¿—é£å±•ç¤º ===
    function openFullDesc() {
        const modal = document.getElementById('fullDescModal');
        
        // 1. è·å–åŸºç¡€æ•°æ®
        const avatarSrc = document.getElementById('detail-avatar').src;
        const nameTxt = document.getElementById('detail-name').textContent;
        
        // 2. å¡«å…… UI
        document.getElementById('aes-avatar-img').src = avatarSrc;
        document.getElementById('aes-name-txt').textContent = nameTxt;
        
        // 3. åŠ¨æ€å…‰å½±ï¼šè®¾ç½®é¡¶éƒ¨æ¨¡ç³ŠèƒŒæ™¯
        document.getElementById('aes-bg-layer').style.backgroundImage = `url(${avatarSrc})`;
        
        // 4. å¼‚æ­¥è·å–å®Œæ•´æ–‡æœ¬
        (async () => {
            const list = await getCharList();
            const fullChar = list.find(c => c.id === editingCharId);
            if(fullChar) {
                document.getElementById('aes-full-desc').textContent = fullChar.desc || "No description provided.";
            }
        })();
        
        // 5. æ˜¾ç¤º
        modal.style.display = 'flex';
    }

    function closeInsModal() {
        document.getElementById('fullDescModal').style.display = 'none';
    }

    // === æ–°å¢ï¼šç›´æ¥ä»å¼¹çª—é‡Œæ“ä½œç¼–è¾‘å’Œåˆ é™¤ ===
    
    function editCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€ç¼–è¾‘ï¼Œä½“éªŒæ›´å¥½
        setTimeout(() => {
            editCurrentChar(); // è°ƒç”¨å·²æœ‰çš„ç¼–è¾‘å‡½æ•°
        }, 200);
    }

    function deleteCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€åˆ é™¤ç¡®è®¤
        setTimeout(() => {
            openDelConfirm(); // è°ƒç”¨å·²æœ‰çš„åˆ é™¤ç¡®è®¤å‡½æ•°
        }, 200);
    }

    // 10. è¯¦æƒ…é¡µäº¤äº’ï¼šç¼–è¾‘ä¸åˆ é™¤
    async function editCurrentChar() {
        const list = await getCharList();
        const char = list.find(c => c.id === editingCharId);
        if(char) {
            document.getElementById('modal-title').textContent = "Edit Profile";
            document.getElementById('char-name-in').value = char.name;
            document.getElementById('char-desc-in').value = char.desc;
            tempCharAvatar = char.avatar;
            document.getElementById('edit-avatar-preview').src = char.avatar;
            document.getElementById('edit-avatar-preview').style.display = 'block';
            document.getElementById('edit-avatar-hint').style.display = 'none';
            document.getElementById('charEditModal').style.display = 'flex';
        }
    }

    function openDelConfirm() { document.getElementById('delConfirmModal').style.display = 'flex'; }
    
    async function confirmDelete() {
        let list = await getCharList();
        list = list.filter(c => c.id !== editingCharId);
        await saveCharList(list);
        
        document.getElementById('delConfirmModal').style.display = 'none';
        closeDetailView();
        renderCharList();
        showToast("Character Deleted");
    }

    // === æ–°å¢ï¼šæ—¶åŒºæœç´¢åŠŸèƒ½ ===
    function filterTimezoneList(query) {
        const input = query.toLowerCase().trim();
        const items = document.querySelectorAll('.tz-item'); // è·å–æ‰€æœ‰åŸå¸‚é¡¹
        const groups = document.querySelectorAll('#tz-city-container .ios-list-group'); // è·å–åŸå¸‚åˆ†ç»„å®¹å™¨
        const titles = document.querySelectorAll('#tz-city-container .tz-group-title'); // è·å–åˆ†ç»„æ ‡é¢˜
        let hasResult = false;

        // 1. ç­›é€‰å…·ä½“çš„åŸå¸‚
        items.forEach(item => {
            const keys = item.getAttribute('data-keywords');
            if (keys.includes(input)) {
                item.style.display = 'flex'; // æ˜¾ç¤ºåŒ¹é…é¡¹
                hasResult = true;
            } else {
                item.style.display = 'none'; // éšè—ä¸åŒ¹é…é¡¹
            }
        });

        // 2. æ™ºèƒ½éšè—ï¼šå¦‚æœä¸€ä¸ªç»„é‡Œçš„æ‰€æœ‰åŸå¸‚éƒ½è¢«éšè—äº†ï¼Œå°±æŠŠé‚£ä¸ªç»„çš„â€œæ ‡é¢˜â€å’Œâ€œåœ†è§’èƒŒæ™¯â€ä¹Ÿè—èµ·æ¥
        groups.forEach((group, index) => {
            // æ£€æŸ¥è¿™ä¸ªç»„é‡Œæœ‰æ²¡æœ‰æ˜¾ç¤ºçš„å­å…ƒç´ 
            const visibleChildren = Array.from(group.children).some(child => child.style.display !== 'none');
            
            if(visibleChildren) {
                group.style.display = 'block';
                if(titles[index]) titles[index].style.display = 'block';
            } else {
                group.style.display = 'none';
                if(titles[index]) titles[index].style.display = 'none';
            }
        });

        // 3. æ— ç»“æœæç¤º
        document.getElementById('tz-no-result').style.display = hasResult ? 'none' : 'block';
    }
    // ==========================================
    // 10. AI å¤§è„‘é…ç½® (å®Œæ•´ä¿®å¤ç‰ˆ)
    // ==========================================

    // --- 1. åº•éƒ¨èœå•æ§åˆ¶ (Action Sheet) ---
    function openModelPicker() {
        document.getElementById('modelPickerSheet').style.display = 'flex';
    }
    function closeModelPicker() {
        document.getElementById('modelPickerSheet').style.display = 'none';
    }

    // é€‰ä¸­æ¨¡å‹ï¼šæ›´æ–°æ˜¾ç¤ºæ–‡å­— + æ›´æ–°éšè—å€¼
    function selectModel(name) {
        if(!name) return;
        // æ›´æ–°æ˜¾ç¤ºçš„è“è‰²æ–‡å­— (å¸¦ç®­å¤´)
        const displayDiv = document.getElementById('api-model-display');
        if(displayDiv) {
            displayDiv.innerHTML = name + `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
        }
        // æ›´æ–°éšè—çš„ input å€¼ (ç»™ä¿å­˜åŠŸèƒ½ç”¨)
        const hiddenInput = document.getElementById('api-model-select');
        if(hiddenInput) {
            hiddenInput.value = name;
        }
        closeModelPicker();
    }

    // --- 2. æ ¸å¿ƒè®¾ç½®é€»è¾‘ ---

    // ==========================================
    // ğŸšï¸ æ»‘åŠ¨æ¡ä¿®å¤è¡¥ä¸ (è®©è“è‰²æ¡è·Ÿéšæ»‘å—)
    // ==========================================

    // 1. æ ¸å¿ƒå·¥å…·ï¼šè®¡ç®—æ»‘å—ç™¾åˆ†æ¯”å¹¶æ›´æ–° CSS
    function updateSliderFill(el) {
        const val = parseFloat(el.value);
        const min = parseFloat(el.min) || 0;
        const max = parseFloat(el.max) || 100;
        const percent = ((val - min) / (max - min)) * 100;
        el.style.setProperty('--percent', percent + '%');
    }

    // 2. è¦†ç›–ä¹‹å‰çš„ loadApiSettingsUI (å¢åŠ åˆå§‹åŒ–é¢œè‰²é€»è¾‘)
    function loadApiSettingsUI() {
        const url = localStorage.getItem('gpt_url') || "https://api.openai.com/v1";
        const key = localStorage.getItem('gpt_key') || "";
        const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
        const temp = localStorage.getItem('gpt_temp') || "0.7";
        const context = localStorage.getItem('gpt_context') || "10";

        // å¡«å€¼
        document.getElementById('api-url').value = url;
        document.getElementById('api-key').value = key;
        
        // --- ä¿®å¤é‡ç‚¹ï¼šè®¾ç½®æ»‘å—æ•°å€¼åï¼Œç«‹åˆ»åˆ·æ–°é¢œè‰² ---
        const tempSlider = document.getElementById('api-temp');
        const ctxSlider = document.getElementById('api-context');
        
        // æ¸©åº¦æ»‘å—
        if(tempSlider) {
            tempSlider.value = temp;
            document.getElementById('temp-display').textContent = temp;
            updateSliderFill(tempSlider); // ğŸ‘ˆ ç«‹å³åˆ·æ–°è“è‰²æ¡
        }
        
        // è®°å¿†æ»‘å—
        if(ctxSlider) {
            ctxSlider.value = context;
            document.getElementById('context-display').textContent = context;
            updateSliderFill(ctxSlider); // ğŸ‘ˆ ç«‹å³åˆ·æ–°è“è‰²æ¡
        }

        // åˆå§‹åŒ–æ¨¡å‹èœå•æ˜¾ç¤º
        if(typeof selectModel === 'function') selectModel(model);
        
        // åŠ è½½é¢„è®¾
        if(typeof renderPresets === 'function') renderPresets();
        
        // é‡ç½®èŠå¤©æ¡†
        const chatLog = document.getElementById('test-chat-log');
        if(chatLog) chatLog.innerHTML = '<div style="color:#999; text-align:center; margin-top:40px;">Test your connection here...</div>';
    }

    // ä»æœåŠ¡å™¨è·å–æ¨¡å‹åˆ—è¡¨
    async function fetchModelList() {
        const url = document.getElementById('api-url').value.replace(/\/$/, "");
        const key = document.getElementById('api-key').value;
        const listContainer = document.getElementById('model-sheet-list'); // ç›®æ ‡å®¹å™¨æ˜¯åº•éƒ¨èœå•
        
        if(!url || !key) { showToast("URL & Key required!"); return; }
        showToast("Fetching Models...");
        
        try {
            const res = await fetch(`${url}/models`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${key}` }
            });
            if(!res.ok) throw new Error("Fetch Failed");
            const data = await res.json();
            const models = data.data || []; 
            
            if(models.length > 0) {
                listContainer.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
                models.sort((a, b) => a.id.localeCompare(b.id)); // æ’åº
                
                // ç”Ÿæˆæ¼‚äº®çš„åº•éƒ¨æŒ‰é’®
                models.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'sheet-item';
                    div.textContent = m.id;
                    div.onclick = () => selectModel(m.id); 
                    listContainer.appendChild(div);
                });
                
                openModelPicker(); // æˆåŠŸåè‡ªåŠ¨å¼¹çª—
                showToast(`Found ${models.length} models!`);
            } else {
                showToast("No models found.");
            }
        } catch(e) {
            console.error(e);
            showToast("Error fetching models.");
        }
    }

    // èŠå¤©æµ‹è¯•
    async function sendTestChat() {
        const input = document.getElementById('test-chat-input');
        const log = document.getElementById('test-chat-log');
        const msg = input.value.trim();
        if(!msg) return;

        const url = document.getElementById('api-url').value.replace(/\/$/, "");
        const key = document.getElementById('api-key').value;
        // è·å–éšè— input çš„å€¼
        const model = document.getElementById('api-model-select').value; 
        const temp = parseFloat(document.getElementById('api-temp').value);

        if(log.querySelector('div') && log.querySelector('div').textContent.includes('Test your')) log.innerHTML = ""; 
        log.innerHTML += `<div style="text-align:right; margin:5px 0;"><span style="background:#007AFF; color:white; padding:6px 10px; border-radius:14px; font-size:13px; display:inline-block;">${msg}</span></div>`;
        input.value = "";
        log.scrollTop = log.scrollHeight;

        try {
            const res = await fetch(`${url}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model, messages: [{ role: "user", content: msg }],
                    temperature: temp, max_tokens: 50
                })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            const reply = data.choices[0].message.content;
            
            log.innerHTML += `<div style="text-align:left; margin:5px 0;"><span style="background:#e5e5ea; color:black; padding:6px 10px; border-radius:14px; font-size:13px; display:inline-block;">${reply}</span></div>`;
            saveToLocalStorage(); // æˆåŠŸåˆ™è‡ªåŠ¨ä¿å­˜
            document.getElementById('api-status-preview').textContent = "Verified";
        } catch(e) {
            log.innerHTML += `<div style="text-align:left; margin:5px 0;"><span style="color:#FF3B30; font-size:11px;">Error: ${e.message}</span></div>`;
        }
        log.scrollTop = log.scrollHeight;
    }

    // ä¿å­˜å½“å‰é…ç½®ä¸ºé¢„è®¾ (é…åˆå¤–éƒ¨å¼¹çª—)
    function saveCurrentAsPreset(name) {
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        const model = document.getElementById('api-model-select').value;
        const temp = document.getElementById('api-temp').value;
        
        const preset = { id: Date.now(), name, url, key, model, temp };
        let presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        presets.push(preset);
        localStorage.setItem('api_presets', JSON.stringify(presets));
        
        saveToLocalStorage();
        renderPresets();
        showToast("Configuration Saved!");
    }

    // --- 3. ç¼ºå¤±çš„å‡½æ•° (ä¹‹å‰æŠ¥é”™å°±æ˜¯å› ä¸ºç¼ºäº†è¿™äº›) ---

    // æ¸²æŸ“é¢„è®¾åˆ—è¡¨
    function renderPresets() {
        const list = document.getElementById('preset-list');
        if(!list) return; // é˜²æ­¢é¡µé¢æ²¡åŠ è½½å®ŒæŠ¥é”™

        const presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        
        if(presets.length === 0) {
            list.innerHTML = `<div class="ios-list-item" style="color:#999; justify-content:center;">No saved configurations</div>`;
            return;
        }

        list.innerHTML = "";
        presets.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'ios-list-item';
            div.style.cursor = "pointer";
            div.innerHTML = `
                <div class="item-content" onclick="loadPreset(${index})">
                    <div style="display:flex; flex-direction:column;">
                        <span class="item-label" style="font-weight:600;">${p.name}</span>
                        <span style="font-size:11px; color:#8e8e93;">${p.model}</span>
                    </div>
                    <div class="item-right">
                        <span style="color:#FF3B30; font-size:13px; font-weight:500; padding:8px;" onclick="event.stopPropagation(); openDeletePresetConfirm(${index})">Delete</span>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // åŠ è½½é¢„è®¾
    function loadPreset(index) {
        const presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        const p = presets[index];
        if(p) {
            document.getElementById('api-url').value = p.url;
            document.getElementById('api-key').value = p.key;
            document.getElementById('api-temp').value = p.temp;
            document.getElementById('temp-display').textContent = p.temp;
            
            // ä½¿ç”¨æ–°å‡½æ•°åŠ è½½æ¨¡å‹
            selectModel(p.model); 
            
            saveToLocalStorage();
            showToast(`Loaded "${p.name}"`);
        }
    }

    // çœŸæ­£çš„åˆ é™¤é€»è¾‘ (è¢«å¼¹çª—è°ƒç”¨)
    function deletePresetReal(index) {
        let presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        presets.splice(index, 1);
        localStorage.setItem('api_presets', JSON.stringify(presets));
        renderPresets();
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    function saveToLocalStorage() {
        localStorage.setItem('gpt_url', document.getElementById('api-url').value);
        localStorage.setItem('gpt_key', document.getElementById('api-key').value);
        localStorage.setItem('gpt_model', document.getElementById('api-model-select').value);
        localStorage.setItem('gpt_temp', document.getElementById('api-temp').value);
        localStorage.setItem('gpt_context', document.getElementById('api-context').value);
    }
    
    // é‡ç½®æ‰€æœ‰è®¾ç½®
    function clearApiSettings() {
        localStorage.removeItem('gpt_url');
        localStorage.removeItem('gpt_key');
        localStorage.removeItem('gpt_model');
        localStorage.removeItem('api_presets'); 
        loadApiSettingsUI();
        showToast("Reset Complete");
    }
    // ==========================================
    // ğŸš‘ è¡¥å…¨ç¼ºå¤±çš„ï¼šå¼¹çª—æ§åˆ¶å™¨ (UI Logic)
    // ==========================================

    // --- 1. ä¿å­˜é¢„è®¾å¼¹çª— (Input Modal) ---
    
    // ç‚¹å‡»å³ä¸Šè§’ Save æ—¶è°ƒç”¨
    function openSavePresetModal() {
        // å…ˆæ£€æŸ¥å¿…å¡«é¡¹
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        
        if(!url || !key) { 
            showToast("URL & Key required!"); 
            return; 
        }

        // å‡†å¤‡å¼¹çª—å†…å®¹
        document.getElementById('input-modal-title').textContent = "Name This Preset";
        // é»˜è®¤åå­—è®¾ä¸ºå½“å‰æ¨¡å‹å
        const currModel = document.getElementById('api-model-select').value;
        document.getElementById('input-modal-val').value = currModel || "My Preset";
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('iosInputModal').style.display = 'flex';
    }

    // å…³é—­è¾“å…¥å¼¹çª—
    function closeInputModal() { 
        document.getElementById('iosInputModal').style.display = 'none'; 
    }
    
    // ç¡®è®¤ä¿å­˜ (å¼¹çª—é‡Œçš„ Save æŒ‰é’®)
    function confirmInputModal() {
        const name = document.getElementById('input-modal-val').value;
        if(name) {
            saveCurrentAsPreset(name); // è°ƒç”¨æ ¸å¿ƒä¿å­˜å‡½æ•°
            closeInputModal();
        } else {
            showToast("Please enter a name");
        }
    }

    // --- 2. åˆ é™¤/é‡ç½®ç¡®è®¤å¼¹çª— (Confirm Modal) ---
    
    let pendingAction = null; // æš‚å­˜è¦æ‰§è¡Œçš„æ“ä½œ

    // ç‚¹å‡» Reset All Settings æ—¶è°ƒç”¨
    function openResetConfirm() {
        pendingAction = clearApiSettings; // è®°ä¸‹æ¥ï¼šä¸€ä¼šè¦æ‰§è¡Œé‡ç½®
        
        document.getElementById('confirm-modal-title').textContent = "Reset All Settings?";
        document.getElementById('confirm-modal-msg').textContent = "This will clear all saved API keys and presets.";
        document.getElementById('confirm-modal-btn').textContent = "Reset";
        
        document.getElementById('iosConfirmModal').style.display = 'flex';
    }
    
    // ç‚¹å‡»å•ä¸ªé¢„è®¾çš„ Delete æ—¶è°ƒç”¨
    function openDeletePresetConfirm(index) {
        pendingAction = () => deletePresetReal(index); // è®°ä¸‹æ¥ï¼šä¸€ä¼šè¦æ‰§è¡Œåˆ é™¤
        
        document.getElementById('confirm-modal-title').textContent = "Delete Preset?";
        document.getElementById('confirm-modal-msg').textContent = "This configuration will be removed.";
        document.getElementById('confirm-modal-btn').textContent = "Delete";
        
        document.getElementById('iosConfirmModal').style.display = 'flex';
    }

    // å…³é—­ç¡®è®¤å¼¹çª—
    function closeConfirmModal() {
        document.getElementById('iosConfirmModal').style.display = 'none';
        window.pendingAction = null; // å…³é—­å¼¹çª—æ—¶ä¹Ÿæ¸…ç©ºï¼Œä¿è¯å®‰å…¨
    }
    
    // æ‰§è¡Œç¡®è®¤çš„æ“ä½œ (å¼¹çª—é‡Œçš„çº¢è‰²æŒ‰é’®)
    function executeConfirmAction() {
    // æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜çš„ä»»åŠ¡
        if (typeof window.pendingAction === 'function') {
            window.pendingAction(); // æ‰§è¡Œåˆšæ‰å­˜è¿›å»çš„åˆ é™¤å‡½æ•°
            window.pendingAction = null; // æ‰§è¡Œå®Œç«‹åˆ»æ¸…ç©ºï¼Œé˜²æ­¢è¯¯è§¦
        }
        closeConfirmModal();
    }
    // ==========================================
    // ğŸ¨ å­—ä½“ä¸æ˜¾ç¤ºè®¾ç½® (æ— æŸå®‰è£…ç‰ˆ)
    // ==========================================

    function applyGlobalStyles() {
        // æˆ‘ä»¬æŠŠå˜é‡æŒ‚åœ¨ body ä¸Šï¼Œè€Œä¸æ˜¯ :rootï¼Œè¿™æ ·ä½œç”¨åŸŸæ›´å®¹æ˜“æ§åˆ¶
        const target = document.body;
        
        // åº”ç”¨ä¿å­˜çš„å­—ä½“æ ·å¼
        target.style.setProperty('--dynamic-font-family', currentFontConfig.family);
        target.style.setProperty('--dynamic-app-size', currentFontConfig.size + 'px');
        target.style.setProperty('--dynamic-app-weight', currentFontConfig.weight);
        
        // åº”ç”¨ä¿å­˜çš„é¢œè‰²ç³»ç»Ÿ
        target.style.setProperty('--dynamic-app-color', currentFontConfig.colorMain);
        target.style.setProperty('--dynamic-desktop-color', currentFontConfig.colorDesktop);
    }

    // å®æ—¶é¢„è§ˆå‡½æ•° (åªå½±å“é¢„è§ˆé‚£ä¸ªå°ç›’å­ï¼Œä¸å½±å“çœŸæ­£çš„ç•Œé¢)
    function updateFontUI() {
        // 1. æ›´æ–°è°ƒè‰²ç›˜
        document.getElementById('color-picker-main').value = currentFontConfig.colorMain;
        document.getElementById('color-picker-desktop').value = currentFontConfig.colorDesktop;
        
        // 2. æ›´æ–° Hex æ–‡å­—æ˜¾ç¤º
        document.getElementById('color-val-main').textContent = currentFontConfig.colorMain.toUpperCase();
        document.getElementById('color-val-desktop').textContent = currentFontConfig.colorDesktop.toUpperCase();

        // 3. æ ¸å¿ƒï¼šæ›´æ–°é¢„è§ˆç›’å­çš„æ ·å¼
        const pMain = document.getElementById('preview-text-main');
        const pDesk = document.getElementById('preview-text-desktop');
        
        const fontStyle = `
            font-family: ${currentFontConfig.family};
            font-size: ${currentFontConfig.size}px;
            font-weight: ${currentFontConfig.weight};
        `;

        if(pMain) {
            pMain.style.cssText = fontStyle + `color: ${currentFontConfig.colorMain};`;
        }
        if(pDesk) {
            // æ¡Œé¢é¢„è§ˆé€šå¸¸åŠ ä¸€ç‚¹é˜´å½±æ¨¡æ‹ŸçœŸå®å£çº¸æ„Ÿ
            pDesk.style.cssText = fontStyle + `color: ${currentFontConfig.colorDesktop}; text-shadow: 0 1px 2px rgba(0,0,0,0.2);`;
        }
    }

    // ä¿å­˜å¹¶å…¨å±€ç”Ÿæ•ˆ
    function saveFontSettings() {
        localStorage.setItem('ios_font_config', JSON.stringify(currentFontConfig));
        applyGlobalStyles(); // è¿™æ—¶å€™å˜é‡æ‰ä¼šä¼ ç»™ CSS é’©å­ï¼Œå…¨å±€å˜è‰²
        showToast("Theme Updated!");
        setTimeout(() => closeSubPage('subpage-display'), 500);
    }

function openInsAppModal(id) {
    document.getElementById(id).style.display = 'flex';
}

function closeInsAppModal(id) {
    document.getElementById(id).style.display = 'none';
}
// 1. å£°æ˜å˜é‡ï¼ˆç”¨ var ç¡®ä¿å®ƒæ˜¯å…¨å±€å¯è§çš„ï¼‰
var vibeGameState;

// 2. åˆå§‹åŒ–æ£‹ç›˜å‡½æ•°
function initVibeGrid() {
    // ã€å…³é”®ä¿®å¤ã€‘ï¼šå¦‚æœå˜é‡è¿˜æ²¡åˆå§‹åŒ–ï¼Œåœ¨è¿™é‡Œå¼ºè¡Œåˆå§‹åŒ–å®ƒ
    if (!vibeGameState) {
        vibeGameState = {
            board: [],
            size: 10,
            currentPlayer: 1,
            isGameOver: false
        };
    }

    var boardEl = document.getElementById('vibe-board');
    if (!boardEl) {
        console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ° ID ä¸º vibe-board çš„å®¹å™¨");
        return;
    }
    
    // é‡ç½®é€»è¾‘
    boardEl.innerHTML = '';
    vibeGameState.board = []; 
    for (var i = 0; i < 10; i++) {
        vibeGameState.board[i] = Array(10).fill(0);
    }
    vibeGameState.currentPlayer = 1;
    vibeGameState.isGameOver = false;
    
    var indicator = document.getElementById('vibe-turn-indicator');
    if (indicator) {
        indicator.textContent = "PLAYER: å…±é¸£";
        indicator.style.color = "#4facfe";
    }

    // ç”Ÿæˆæ ¼å­
    for (var r = 0; r < 10; r++) {
        for (var c = 0; c < 10; c++) {
            var cell = document.createElement('div');
            cell.className = 'vibe-cell';
            cell.dataset.row = r;
            cell.dataset.col = c;
            // ç»‘å®šç‚¹å‡»è½å­
            cell.onclick = (function(row, col, el) {
                return function() { placeVibePiece(row, col, el); };
            })(r, c, cell);
            boardEl.appendChild(cell);
        }
    }
    console.log("æ°›å›´å›´åŸï¼šæ£‹ç›˜å°±ç»ª");
}

// 3. è½å­å‡½æ•°
function placeVibePiece(r, c, cellEl) {
    // å†æ¬¡æ£€æŸ¥å˜é‡ï¼Œé˜²æ­¢æ„å¤–
    if (!vibeGameState || vibeGameState.board[r][c] !== 0 || vibeGameState.isGameOver) return;

    var player = vibeGameState.currentPlayer;
    vibeGameState.board[r][c] = player;

    var piece = document.createElement('div');
    piece.className = (player === 1) ? 'piece-resonance' : 'piece-devour';
    cellEl.appendChild(piece);

    // å˜è‰²é€»è¾‘
    if (player === 1) {
        document.documentElement.style.setProperty('--bg-gradient', 'linear-gradient(160deg, #a1fdd4 0%, #8ec5fc 100%)');
    } else {
        document.documentElement.style.setProperty('--bg-gradient', 'linear-gradient(160deg, #fbc2eb 0%, #a6c1ee 100%)');
    }

    // åˆ¤èƒœ
    if (checkVibeWin(r, c, player)) {
        vibeGameState.isGameOver = true;
        alert((player === 1 ? "å…±é¸£" : "åå™¬") + " è¿æˆäº†æƒ…æ„Ÿç½‘ç»œï¼");
        return;
    }

    // æ¢äºº
    vibeGameState.currentPlayer = (player === 1) ? 2 : 1;
    var nextName = (vibeGameState.currentPlayer === 1) ? "å…±é¸£" : "åå™¬";
    var indicator = document.getElementById('vibe-turn-indicator');
    if (indicator) {
        indicator.textContent = "PLAYER: " + nextName;
        indicator.style.color = (vibeGameState.currentPlayer === 1) ? "#4facfe" : "#f5576c";
    }
}

// 4. ç®—æ³•å‡½æ•°
function checkVibeWin(r, c, p) {
    if (!vibeGameState) return false;
    var b = vibeGameState.board;
    var dirs = [[1,0], [0,1], [1,1], [1,-1]];
    for (var i = 0; i < dirs.length; i++) {
        var dr = dirs[i][0], dc = dirs[i][1], count = 1;
        var nr = r + dr, nc = c + dc;
        while(nr>=0 && nr<10 && nc>=0 && nc<10 && b[nr][nc] === p) { count++; nr+=dr; nc+=dc; }
        nr = r - dr; nc = c - dc;
        while(nr>=0 && nr<10 && nc>=0 && nc<10 && b[nr][nc] === p) { count++; nr-=dr; nc-=dc; }
        if (count >= 5) return true;
    }
    return false;
}

// 5. é‡ç½®
function resetVibeGame() {
    initVibeGrid();
}
// ==========================================
// ğŸ® æ°›å›´å›´åŸï¼šå¼ºåˆ¶ä¿®å¤å¯åŠ¨é€»è¾‘
// ==========================================

// 1. å¼ºåŠ›æ‰“å¼€ App çš„å‡½æ•°
// åœ¨ script æ ‡ç­¾æœ€åæ·»åŠ æˆ–ä¿®æ”¹
function startVibeGame() {
    var gameApp = document.getElementById('vibe-grid-app');
    if (gameApp) {
        gameApp.style.display = 'flex'; // å…ˆæ˜¾ç¤ºå®¹å™¨
        // ç»™æµè§ˆå™¨ä¸€ä¸ç‚¹æ—¶é—´å‡†å¤‡ï¼Œç„¶åè§¦å‘æ»‘å…¥åŠ¨ç”»
        setTimeout(function() {
            gameApp.classList.add('active');
            initVibeGrid(); // åˆå§‹åŒ–æ£‹ç›˜
        }, 50);
    }
}

// 2. ä¿®æ”¹ä½ ä¹‹å‰çš„ initVibeGridï¼Œå¢åŠ å®‰å…¨æ€§
// å¦‚æœä½ åé¢è¿˜è¦æ”¹ï¼Œè¯·ç¡®ä¿å‡½æ•°åè¿˜æ˜¯è¿™ä¸ª
var originalInitVibeGrid = initVibeGrid; 
initVibeGrid = function() {
    console.log("æ­£åœ¨é‡ç»˜æ£‹ç›˜...");
    // æ£€æŸ¥å˜é‡
    if (!vibeGameState) {
        vibeGameState = { board: [], size: 10, currentPlayer: 1, isGameOver: false };
    }
    // å‰©ä¸‹çš„é€»è¾‘ä¼šè‡ªåŠ¨è¿è¡Œä½ ä¹‹å‰å†™çš„é‚£ä¸ªç‰ˆæœ¬
    if(typeof originalInitVibeGrid === 'function') originalInitVibeGrid();
};
// ==========================================
// ğŸ® Vibe Grid 3.0: è§’è‰²åšå¼ˆå¼•æ“
// ==========================================

var vibeOpponent = null;
var vibeGameLog = []; // å­˜è¯è¯­
var vibePendingMove = null;

// 1. ã€å¼ºåŠ›å¯åŠ¨å™¨ã€‘
function startVibeGame() {
    var app = document.getElementById('vibe-grid-app');
    app.style.display = 'flex';
    setTimeout(() => {
        app.classList.add('active');
        renderVibeCharPicker(); // ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶é€‰äºº
    }, 50);
}

// 2. æ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨ (ä»ä½ çš„ IndexedDB è·å–)
// è®°å½•å½“å‰æ˜¯è°åœ¨è°ƒç”¨è§’è‰²é€‰æ‹©å™¨ ('VIBE' æˆ– 'SIGNAL')
var charPickerSource = 'VIBE'; 
// 3. é€‰æ‹©å¯¹æ‰‹å¹¶åˆå§‹åŒ–
function selectVibeOpponent(char) {
    vibeOpponent = char;
    vibeGameLog = [];
    document.getElementById('modal-vibe-char-picker').style.display = 'none';
    document.getElementById('opponent-info-bar').style.display = 'flex';
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ è½å­å¹¶æ³¨é­‚";
    initVibeGrid(); // ç»˜åˆ¶æ£‹ç›˜
}

// 4. é‡å†™åˆå§‹åŒ– (10x10)
function initVibeGrid() {
    var board = document.getElementById('vibe-board');
    board.innerHTML = "";
    vibeGameState = { board: Array(10).fill(0).map(()=>Array(10).fill(0)), isGameOver: false, currentPlayer: 1 };
    
    for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
            let cell = document.createElement('div');
            cell.className = 'vibe-cell';
            cell.dataset.row = r; cell.dataset.col = c;
            cell.onclick = () => handleVibeCellClick(r, c, cell);
            board.appendChild(cell);
        }
    }
}

// 5. ç‚¹å‡»é€»è¾‘
function handleVibeCellClick(r, c, el) {
    if (vibeGameState.isGameOver || vibeGameState.board[r][c] !== 0 || !vibeOpponent) return;
    vibePendingMove = { r, c, el };
    document.getElementById('vibe-user-word').value = "";
    document.getElementById('modal-vibe-word-input').style.display = 'flex';
}

// 6. ç¡®è®¤è½å­ (ç”¨æˆ·)
function confirmVibeStep() {
    var word = document.getElementById('vibe-user-word').value.trim();
    if(!word) { 
        showToast("æ³¨é­‚ä¸å¯ä¸ºç©º"); // ç¡®ä¿ä½ ä¹‹å‰æœ‰è¿™ä¸ªå‡½æ•°
        return; 
    }
    
    // ã€å…³é”®ä¿®å¤ã€‘ï¼šå¦‚æœç¬”è®°æœ¬æ²¡æ‰“å¼€ï¼Œç°åœ¨ç«‹åˆ»æ‰“å¼€
    if (!vibeGameLog) { vibeGameLog = []; }

    // éšè—è¾“å…¥æ³•
    document.getElementById('modal-vibe-word-input').style.display = 'none';
    
    // è®°å½•è¯è¯­
    vibeGameLog.push({ role: "User", text: word });
    
    // æ‰§è¡Œè½å­
    executeVibeMove(vibePendingMove.r, vibePendingMove.c, vibePendingMove.el, 1);
    
    if (vibeGameState.isGameOver) { 
        finishVibeMatch(); 
    } else {
        document.getElementById('vibe-turn-indicator').textContent = vibeOpponent.name + " æ­£åœ¨å›å“...";
        setTimeout(aiVibeResponse, 1000);
    }
}

// 7. AI å›åº” (è‡ªåŠ¨æ‰¾ç©ºä½ + è°ƒç”¨æ¨¡å‹)
async function aiVibeResponse() {
    // ç®€å•ç®—æ³•ï¼šæ‰¾ç¬¬ä¸€ä¸ªç©ºä½ (å•†ç”¨æ¼”ç¤ºå¤Ÿç”¨ï¼Œå¯å‡çº§)
    let r, c, found = false;
    for(r=4; r<10 && !found; r++) for(c=4; c<10 && !found; c++) if(vibeGameState.board[r][c] === 0) found = true;
    if(!found) { finishVibeMatch("DRAW"); return; }
    r--; c--;

    var bestMove = findBestMove(); 
    if(!bestMove) { finishVibeMatch("DRAW"); return; }

    // 1. è·å– AI è¯è¯­
    let lastUserWord = vibeGameLog[vibeGameLog.length-1].text;
    // åœ¨è·å–åˆ° aiWord åï¼Œæ‰§è¡Œè½å­å‰å¢åŠ é€»è¾‘
    let aiWord = await callAIForOneWord(lastUserWord);

    // ã€å¼ºåŠ›å»é‡æ£€æŸ¥ã€‘ï¼šå¦‚æœ AI å›çš„è¯è·Ÿç©å®¶ä¸€æ ·ï¼Œæˆ–è€… AI ä»¥å‰è¯´è¿‡ï¼Œå°±å¼ºåˆ¶è®©å®ƒéšæœºåº”å˜
    if (aiWord === lastUserWord || vibeGameLog.some(l => l.text === aiWord)) {
        var fallbackWords = ["ä½™æ¸©", "é™é»˜", "å¾®å…‰", "å¼•åŠ›", "å›å“"]; // å¤‡ç”¨é«˜çº§è¯åº“
        aiWord = fallbackWords[Math.floor(Math.random() * fallbackWords.length)];
    }
    vibeGameLog.push({ role: "AI", text: aiWord });

    // 2. æ›´æ–°ä¸‹æ–¹ä¿¡æ¯æ  (è®©å®ƒæ˜¾ç°)
    var logDisplay = document.getElementById('opp-last-word');
    if(logDisplay) {
        logDisplay.textContent = "ã€Œ " + aiWord + " ã€";
        logDisplay.style.opacity = "1";
    }

    // 3. æ‰§è¡Œè½å­
    let el = document.querySelector(`.vibe-cell[data-row='${bestMove.r}'][data-col='${bestMove.c}']`);
    executeVibeMove(bestMove.r, bestMove.c, el, 2);

    // 4. ã€æ ¸å¿ƒå‡çº§ã€‘ï¼šåˆ›å»ºæ£‹ç›˜ä¸Šæ–¹çš„æ‚¬æµ®æ–‡å­—åŠ¨ç”»
    showFloatingWord(aiWord, el);

    if (vibeGameState.isGameOver) { finishVibeMatch(); return; }
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ æ³¨å…¥è¯è¯­";
}
function showFloatingWord(text, targetEl) {
    var floatEl = document.createElement('div');
    floatEl.className = 'floating-vibe-word';
    floatEl.textContent = text;
    
    // å®šä½åˆ°å½“å‰è½å­çš„æ ¼å­ä¸­å¿ƒ
    var rect = targetEl.getBoundingClientRect();
    floatEl.style.left = (rect.left + rect.width / 2 - 20) + "px";
    floatEl.style.top = (rect.top - 20) + "px";
    
    document.body.appendChild(floatEl);
    
    // åŠ¨ç”»ç»“æŸè‡ªåŠ¨åˆ é™¤ï¼Œä¸å å†…å­˜
    setTimeout(function() {
        if(floatEl.parentNode) floatEl.parentNode.removeChild(floatEl);
    }, 2500);
}

// 8. èƒœè´Ÿ/å¹³å±€åˆ¤æ–­å¹¶å¼¹å‡ºå›å“å¡ç‰‡
// å‡çº§ç‰ˆï¼šå¸¦é˜²å¾¡é€»è¾‘çš„å¯¹å±€æ€»ç»“
// ==========================================
// ğŸ† é€šç”¨å¯¹å±€ç»“ç®—ä¸­å¿ƒ (ç»ˆæä¿®å¤ç‰ˆ)
// ==========================================
async function finishVibeMatch(type, customOpponent, customWords, customStory) {
    // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå®‰å…¨é”
    // åªæœ‰å½“ vibeGameState çœŸçš„å­˜åœ¨æ—¶ï¼Œæ‰å»æ”¹å®ƒçš„çŠ¶æ€
    if (typeof vibeGameState !== 'undefined' && vibeGameState) {
        vibeGameState.isGameOver = true;
    }

    showToast("å¯¹å±€å·²æˆï¼Œæ­£åœ¨ç»“è¯­...");
    
    // 2. æ™ºèƒ½è¯†åˆ«ï¼šæ˜¯è°åœ¨ç»“ç®—ï¼Ÿ
    // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å»æ‰¾å…¨å±€å˜é‡
    var opponent = customOpponent || (window.senseOpponent || vibeOpponent);
    var words = customWords || (window.senseMix || []);
    var story = customStory || ""; 

    if (!opponent) {
        console.error("Critical Error: æ‰¾ä¸åˆ°ä»»ä½•å¯¹æ‰‹æ•°æ®");
        return;
    }

    // 3. ç¡®å®šå¯¹å±€æ–‡æ¡ˆ
    var outcomeText;
    if (type === "SYNCED") outcomeText = "è”è§‰å…±æŒ¯ Â· è·å–åº•å±‚è®°å¿†";
    else if (type === "OFFLINE") outcomeText = "ä¿¡å·æ–­è£‚ Â· æ— æ³•è§£æäººæ ¼";
    else if (type === "DRAW") outcomeText = "å¹³å±€ Â· æŸç§å¹³è¡¡";
    else {
        // äº”å­æ£‹é€»è¾‘
        outcomeText = (vibeGameState && vibeGameState.currentPlayer === 1) ? "ä½ è§¦ç¢°äº†èƒœæœº" : opponent.name + "ä¸»å¯¼äº†æ°›å›´";
    }

    // 4. æ ¼å¼åŒ–è¯è¯­æ˜¾ç¤º (å…¼å®¹æ•°ç»„å’Œå¯¹è±¡)
    var wordStr = Array.isArray(words) ? words.join(" Â· ") : words;

    // 5. å¡«å……ç»“æœå¡ç‰‡ (UI æ¸²æŸ“)
    document.getElementById('res-title').textContent = opponent.name + " çš„åšå¼ˆå›å“";
    document.getElementById('res-outcome').textContent = outcomeText;
    document.getElementById('res-avatar').src = opponent.avatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + opponent.avatar + ")";
    document.getElementById('res-words').textContent = wordStr;
    
    // å¦‚æœå·²ç»æœ‰äº†æ•…äº‹ï¼ˆSenseæ¨¡å¼ï¼‰ï¼Œç›´æ¥å¡«è¿›å»ï¼›å¦‚æœæ²¡æœ‰ï¼ˆäº”å­æ£‹æ¨¡å¼ï¼‰ï¼Œå°±å»å«AIå†™
    var elStory = document.getElementById('res-story');
    if (story) {
        elStory.textContent = story;
    } else {
        elStory.textContent = "æ­£åœ¨ç¼–ç»‡åšå¼ˆç•™ä¸‹çš„ä½™æ¸©...";
        story = await callAIForStory(outcomeText, opponent, words); // è°ƒç”¨ä½ å·²æœ‰çš„ AI æ•…äº‹å‡½æ•°
        elStory.textContent = story;
    }

    // 6. æ˜¾ç¤ºå¡ç‰‡å¹¶ä¿å­˜å†å²
    document.getElementById('modal-vibe-result').style.display = 'flex';
    saveToVibeHistory(opponent, outcomeText, wordStr, story);
}

// --- è¾…åŠ©ï¼šæ‰§è¡Œè½å­è§†è§‰ ---
function executeVibeMove(r, c, el, p) {
    vibeGameState.board[r][c] = p;
    var piece = document.createElement('div');
    piece.className = p === 1 ? 'piece-resonance' : 'piece-devour';
    el.appendChild(piece);
    if(checkVibeWin(r, c, p)) vibeGameState.isGameOver = true;
    if(!vibeGameState.isGameOver) vibeGameState.currentPlayer = (p===1?2:1);
}

// --- è¾…åŠ©ï¼šçœŸæ­£çš„ AI æ¨¡å‹è°ƒç”¨ (è°ƒç”¨ä½ è®¾ç½®é¡µé¢çš„é…ç½®) ---
// å‡çº§ç‰ˆï¼šä¸¥æ ¼æ§åˆ¶ AI çš„å›å“è¯æ±‡
async function callAIForOneWord(userWord) {
    var key = localStorage.getItem('gpt_key');
    if(!key) return "æ²‰é»˜";

    // 1. æå–è§’è‰²å®Œæ•´èº«ä»½ (ç¡®ä¿è¯»å–è§’è‰²ä¹¦ä¸­çš„ desc å­—æ®µ)
    var persona = vibeOpponent.desc || "ç¥ç§˜çš„é™Œç”Ÿäºº";
    var usedWords = vibeGameLog.map(function(l){ return l.text; }).join("ã€");

    try {
        var res = await fetch(localStorage.getItem('gpt_url') + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            // ä¿®æ”¹ callAIForOneWord å†…éƒ¨çš„ body éƒ¨åˆ†
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{
                    role: "system", 
                    content: `ã€ç»å¯¹äººæ ¼é”å®šã€‘
                    ä½ æ˜¯: ${vibeOpponent.name}ã€‚èº«ä»½èƒŒæ™¯: ${vibeOpponent.desc}ã€‚
                    
                    ã€åšå¼ˆç¯å¢ƒã€‘
                    - è¿™æ˜¯ä¸€ä¸ªä¸æ–­æµåŠ¨çš„æ—¶ç©ºï¼Œå½“å‰çš„åç§»é‡ä¸º: ${Date.now()}ã€‚
                    - å³ä½¿é¢å¯¹ç›¸åŒçš„è¯è¯­ï¼Œä½ ä¹Ÿå¿…é¡»æ ¹æ®ä½ æ­¤åˆ»çš„â€œäººæ ¼åˆ‡ç‰‡â€å›å“ä¸åŒçš„ç­”æ¡ˆã€‚
                    
                    ã€è¯è¯­å›å“è§„åˆ™ã€‘
                    1. ä»…é™å›å¤ä¸€ä¸ªã€è¯è¯­ã€‘æˆ–ã€æˆè¯­ã€‘ï¼Œç¦æ­¢åºŸè¯ã€‚
                    2. ä½ çš„è¯åº“å¿…é¡»æåº¦ä¸°å¯Œï¼Œç¦æ­¢ä½¿ç”¨é™ˆè¯æ»¥è°ƒã€‚
                    3. ç¦æ­¢é‡å¤å½“å‰å¯¹å±€è¯è¯­ï¼š${vibeGameLog.map(l=>l.text).join('ã€')}ã€‚
                    4. ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘å±•ç°ä½ çš„æ–‡å­¦åº•è•´ï¼Œä¼˜å…ˆé€‰æ‹©ç”Ÿåƒ»ä½†é«˜çº§çš„è¯æ±‡ã€‚`
                }, {
                    role: "user", 
                    content: userWord
                }],
                temperature: 0.9, // è°ƒé«˜åˆ›é€ åŠ›ï¼Œå‡å°‘ç¡®å®šæ€§
                presence_penalty: 0.6 // é¼“åŠ±æ¨¡å‹è°ˆè®ºæ–°è¯é¢˜ï¼Œå‡å°‘é‡å¤
            })
        });
        var data = await res.json();
        // è¿‡æ»¤éæ–‡å­—å†…å®¹
        return data.choices[0].message.content.trim().replace(/[^\u4e00-\u9fa5a-zA-Z]/g, '').substring(0, 5);
    } catch(e) { return "å›éŸ³"; }
}

// ==========================================
// ğŸ“– Vibe Grid: åŠ¨æ€å­—æ•°å™äº‹å¼•æ“
// ==========================================
async function callAIForStory(outcome) {
    var key = localStorage.getItem('gpt_key');
    if(!key) return "æ–‡å­—æ— æ³•æ‰¿è½½æ­¤åˆ»çš„æƒ…ç»ªã€‚";
    
    var persona = vibeOpponent.desc || "æŸç§æœªçŸ¥çš„å­˜åœ¨";
    var words = vibeGameLog.map(l => l.text).join("ã€");
    
    // 1. ã€æ ¸å¿ƒé€»è¾‘ã€‘ï¼šè®¡ç®—å¯¹å±€æ·±åº¦
    // è½®æ•°è¶Šå¤šï¼Œè¦æ±‚ AI å†™çš„å­—æ•°ä¸Šé™è¶Šé«˜ï¼Œå†…å®¹è¶Šç»†èŠ‚
    var turnCount = vibeGameLog.length;
    var targetWordCount = 150; // åˆå§‹ä¿åº•å­—æ•°
    
    if (turnCount > 10) targetWordCount = 400;
    if (turnCount > 20) targetWordCount = 700;
    if (turnCount > 40) targetWordCount = 1000; // é•¿å±€å¯¹å†³ï¼Œç»™é•¿ç¯‡ç‹¬ç™½

    try {
        var res = await fetch(localStorage.getItem('gpt_url') + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{
                    role: "system", 
                    content: `ä½ æ˜¯${vibeOpponent.name}ã€‚èº«ä»½èƒŒæ™¯ï¼š${persona}ã€‚`
                }, {
                    role: "user", 
                    content: `åˆšæ‰æˆ‘ä»¬è¿›è¡Œäº†ä¸€åœºé•¿è¾¾ ${turnCount} ä¸ªå›åˆçš„æ·±åº¦åšå¼ˆï¼Œå¯¹å±€çŠ¶æ€æ˜¯ [${outcome}]ã€‚
                    åœ¨è¿™åœºåšå¼ˆä¸­ï¼Œæˆ‘ä»¬å…±åŒç•™ä¸‹äº†è¿™äº›æƒ…ç»ªç¢ç‰‡ï¼š${words}ã€‚
                    
                    ã€ä»»åŠ¡æŒ‡ä»¤ã€‘
                    1. è¯·ä»¥ä½ çš„èº«ä»½ï¼Œå†™ä¸€æ®µçº¦ ${targetWordCount} å­—çš„å†…å¿ƒç‹¬ç™½æ•…äº‹ã€‚
                    2. ç”±äºå¯¹å±€å›åˆæ•°è¾ƒå¤šï¼Œè¯·åŠ¡å¿…å……åˆ†åˆ©ç”¨ä¸Šé¢æåˆ°çš„æ‰€æœ‰è¯è¯­ç¢ç‰‡ï¼Œå°†å®ƒä»¬äº¤ç»‡è¿›ä½ çš„å™è¿°é€»è¾‘ä¸­ã€‚
                    3. ä¸¥ç¦å‡ºç° Emojiï¼Œæ–‡é£è¦æå…·ç”»é¢æ„Ÿï¼Œåƒæ˜¯ä¸€åœºæ¼«é•¿æˆ˜äº‰æˆ–é•¿å¤œè¿‡åçš„æœ€åå‘Šç™½ã€‚
                    4. å†…å®¹è¦ä¸°å¯Œã€é¥±æ»¡ï¼Œä¸è¦ç®€å•çš„å †ç Œè¯è¯­ï¼Œè¦å†™å‡ºæƒ…æ„Ÿçš„é€’è¿›æ„Ÿã€‚`
                }],
                temperature: 0.85 // ç•¥å¾®è°ƒé«˜ï¼Œå¢åŠ å™äº‹çš„è¿è´¯æ€§ä¸å‘æ•£åŠ›
            })
        });
        var data = await res.json();
        return data.choices[0].message.content;
    } catch(e) { 
        return "åšå¼ˆå¤ªæ·±ï¼Œè¨€è¯­å·²æ— æ³•è§¦åŠç»ˆç‚¹ã€‚"; 
    }
}

// ä¿®æ”¹ä½ æ–‡ä»¶æœ«å°¾å¯¹åº”çš„è¿™ä¸¤ä¸ªå‡½æ•°
function openVibeGuide() {
    var modal = document.getElementById('modal-vibe-guide');
    if (modal) {
        modal.style.display = 'flex';
        console.log("System: Guide modal opened.");
    } else {
        console.error("System Error: Element 'modal-vibe-guide' not found in DOM.");
        // è‡ªåŠ¨æç¤ºï¼Œé˜²æ­¢ç”¨æˆ·ä¸€è„¸æ‡µ
        showToast("æ­£åœ¨è½½å…¥è¯´æ˜ï¼Œè¯·ç¨å..."); 
    }
}

function closeVibeGuide() {
    var modal = document.getElementById('modal-vibe-guide');
    if (modal) {
        modal.style.display = 'none';
    }
}
// ==========================================
// ğŸ•¹ï¸ Vibe Grid å‡çº§é€»è¾‘ï¼šåŒæ­¥è§’è‰²ä¹¦
// ==========================================

// 2. ç¡®è®¤é€‰æ‹©å¹¶è¿›å…¥æ¸¸æˆçŠ¶æ€
function confirmSelection(char) {
    vibeOpponent = char;
    document.getElementById('modal-vibe-picker').style.display = 'none'; // è§’è‰²é€‰æ‹©å™¨è¿˜åœ¨åº•éƒ¨ï¼Œæ²¡å…³ç³»
    
    // 1. éšè—å¯åŠ¨é¡µ
    document.getElementById('vibe-start-screen').style.display = 'none';
    
    // 2. æ˜¾ç¤ºå¹¶æ¸å…¥æ¸¸æˆå±‚
    var gameMain = document.getElementById('vibe-game-main');
    gameMain.style.display = 'flex';
    setTimeout(() => { gameMain.style.opacity = '1'; }, 10);
    
    // 3. å¡«å……æ•°æ®å¹¶é‡ç»˜æ£‹ç›˜
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    initVibeGrid(); 
}

// 3. ä¿®æ­£ startVibeGame (å…¥å£å‡½æ•°)
function startVibeGame() {
    var app = document.getElementById('vibe-grid-app');
    app.style.display = 'flex';
    // æ¯æ¬¡é‡æ–°æ‰“å¼€éƒ½å›åˆ°åˆå§‹çŠ¶æ€
    document.getElementById('vibe-start-screen').style.display = "flex";
    document.getElementById('vibe-start-screen').style.opacity = "1";
    document.getElementById('vibe-game-main').style.opacity = "0";
    
    setTimeout(() => { app.classList.add('active'); }, 50);
}
// é‡æ–°ä¿®æ”¹è¿™ä¸ªç‚¹å‡»å‡½æ•°
function handleVibeCellClick(r, c, el) {
    // åŸºç¡€åˆ¤å®š
    if (!vibeGameState || vibeGameState.isGameOver || vibeGameState.board[r][c] !== 0 || !vibeOpponent) return;
    
    vibePendingMove = { r: r, c: c, el: el };
    
    // è·å–è¾“å…¥æ¡†å’Œå¼¹çª—å…ƒç´ 
    var inputField = document.getElementById('vibe-user-word');
    var inputModal = document.getElementById('modal-vibe-word-input');
    
    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå¢åŠ é€»è¾‘åˆ¤æ–­ï¼Œå¦‚æœå…ƒç´ å­˜åœ¨æ‰è¿›è¡Œæ“ä½œ
    if (inputField && inputModal) {
        inputField.value = ""; // æ¸…ç©ºä¸Šæ¬¡å†…å®¹
        inputModal.style.display = 'flex'; // å¼¹å‡ºè¾“å…¥æ¡†
        inputField.focus(); // è‡ªåŠ¨èšç„¦æ–¹ä¾¿è¾“å…¥
    } else {
        console.error("System Error: æ‰¾ä¸åˆ° ID ä¸º 'vibe-user-word' æˆ– 'modal-vibe-word-input' çš„å…ƒç´ ã€‚");
        // å…œåº•æ–¹æ¡ˆï¼šå¦‚æœå®åœ¨æ‰¾ä¸åˆ°å¼¹çª—ï¼Œå°±ç”¨ä¸€ä¸ªæœ€åŸºç¡€çš„æç¤º
        var fallbackWord = prompt("è¯·è¾“å…¥æ­¤å¤„çš„æ³¨é­‚è¯è¯­ï¼š");
        if(fallbackWord) {
            document.getElementById('vibe-user-word-hidden-backup').value = fallbackWord; // å‡æƒ³ä¸€ä¸ªå¤‡ä»½
            confirmVibeStep(); 
        }
    }
}
// ==========================================
// ğŸ§  AI å†³ç­–å¼•æ“ï¼šå¯»æ‰¾æœ€ä½³è½å­ç‚¹
// ==========================================
function findBestMove() {
    if (!vibeGameState || !vibeGameState.board) return null;
    var board = vibeGameState.board;
    var size = 10;
    
    // æƒé‡è¡¨ï¼šç”¨æ¥è®°å½•æ¯ä¸ªæ ¼å­çš„å±é™©/æœºé‡ç¨‹åº¦
    var scores = Array(size).fill(0).map(() => Array(size).fill(0));

    for (var r = 0; r < size; r++) {
        for (var c = 0; c < size; c++) {
            if (board[r][c] !== 0) continue;

            // æ ¸å¿ƒé€»è¾‘ï¼šæ¨¡æ‹Ÿåœ¨æ­¤å¤„è½å­ï¼Œè®¡ç®—ä»·å€¼
            // æˆ‘ä»¬æ£€æŸ¥ ç©å®¶(1) çš„å¨èƒ å’Œ AI(2) çš„æœºä¼š
            scores[r][c] = calculateCellScore(r, c);
        }
    }

    // å¯»æ‰¾åˆ†æ•°æœ€é«˜çš„æ ¼å­
    var maxScore = -1;
    var best = null;
    for (var r = 0; r < size; r++) {
        for (var c = 0; c < size; c++) {
            if (scores[r][c] > maxScore) {
                maxScore = scores[r][c];
                best = { r: r, c: c };
            }
        }
    }
    return best;
}
// è¾…åŠ©ï¼šè®¡ç®—å•ä¸ªæ ¼å­çš„æˆ˜ç•¥ä»·å€¼
function calculateCellScore(r, c) {
    var total = 0;
    var directions = [[1,0], [0,1], [1,1], [1,-1]];
    
    directions.forEach(dir => {
        // 1. æ‹¦æˆªç©å®¶é€»è¾‘ï¼šå¦‚æœä½ å¿«èµ¢äº†ï¼Œæˆ‘å°±å¾—å µ
        var pCount = countLine(r, c, dir, 1);
        if (pCount >= 4) total += 10000; // å¿…å µï¼šç©å®¶å·²å››è¿
        else if (pCount === 3) total += 500; // é‡ç‚¹å µï¼šç©å®¶å·²ä¸‰è¿
        
        // 2. AI è¿›æ”»é€»è¾‘ï¼šå¦‚æœæˆ‘ä¹Ÿèƒ½è¿èµ·æ¥ï¼Œä¼˜å…ˆè‡ªå·±è¿
        var aiCount = countLine(r, c, dir, 2);
        if (aiCount >= 4) total += 50000; // ä¼˜å…ˆèµ¢ï¼šAI å³å°†äº”è¿
        else if (aiCount === 3) total += 800; // ä¼˜å…ˆé€ å››è¿
        
        // 3. åŸºç¡€ä½ç½®æƒé‡
        total += (Math.abs(4.5 - r) + Math.abs(4.5 - c)); // è¶Šé è¿‘ä¸­å¿ƒåˆ†è¶Šé«˜
    });
    return total;
}

function countLine(r, c, dir, p) {
    var count = 0;
    var board = vibeGameState.board;
    // æ­£å‘
    var nr = r + dir[0], nc = c + dir[1];
    while(nr>=0 && nr<10 && nc>=0 && nc<10 && board[nr][nc] === p) { count++; nr+=dir[0]; nc+=dir[1]; }
    // åå‘
    nr = r - dir[0]; nc = c - dir[1];
    while(nr>=0 && nr<10 && nc>=0 && nc<10 && board[nr][nc] === p) { count++; nr-=dir[0]; nc-=dir[1]; }
    return count;
}

// ==========================================
// ğŸ† èƒœè´Ÿåˆ¤å®šç®—æ³• (æ ‡å‡†äº”å­æ£‹é€»è¾‘)
// ==========================================
function checkVibeWin(r, c, p) {
    var directions = [
        [1, 0],  // å‚ç›´
        [0, 1],  // æ°´å¹³
        [1, 1],  // æ­£æ–œ
        [1, -1]  // åæ–œ
    ];
    var board = vibeGameState.board;

    for (var i = 0; i < directions.length; i++) {
        var dr = directions[i][0];
        var dc = directions[i][1];
        var count = 1;

        // å‘ä¸€ä¸ªæ–¹å‘æ¢æµ‹
        var nr = r + dr, nc = c + dc;
        while (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] === p) {
            count++;
            nr += dr;
            nc += dc;
        }

        // å‘ç›¸åæ–¹å‘æ¢æµ‹
        nr = r - dr; nc = c - dc;
        while (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] === p) {
            count++;
            nr -= dr;
            nc -= dc;
        }

        if (count >= 5) return true;
    }
    return false;
}
// ==========================================
// ğŸ“œ Vibe Grid: å†å²æ²‰æ·€é€»è¾‘
// ==========================================

// 1. ä¿å­˜å½“å‰å¯¹å±€åˆ°å†å²
function saveToVibeHistory(char, outcome, words, story) {
    var history = JSON.parse(localStorage.getItem('vibe_match_history') || "[]");
    var entry = {
        id: Date.now(),
        charName: char.name,
        charAvatar: char.avatar,
        outcome: outcome,
        words: words,
        story: story,
        date: new Date().toLocaleDateString()
    };
    history.unshift(entry); // æœ€æ–°çš„æ’åœ¨å‰é¢
    if(history.length > 20) history.pop(); // æœ€å¤šä¿å­˜20æ¡
    localStorage.setItem('vibe_match_history', JSON.stringify(history));
}

// 2. æ‰“å¼€å¹¶æ¸²æŸ“å†å²é¡µé¢
function openVibeHistory() {
    var container = document.getElementById('vibe-history-list');
    var history = JSON.parse(localStorage.getItem('vibe_match_history') || "[]");
    container.innerHTML = "";

    if(history.length === 0) {
        container.innerHTML = "<div style='text-align:center; margin-top:100px; color:#bbb;'>å°šæ— å°å­˜çš„å›å“</div>";
    }

    history.forEach(function(item) {
        var card = document.createElement('div');
        card.className = "ios-list-group"; // å¤ç”¨ä½ è®¾ç½®é¡µçš„æ ·å¼
        card.style.padding = "15px";
        card.style.marginBottom = "15px";
        card.style.cursor = "pointer";
        card.innerHTML = `
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                <img src="${item.charAvatar}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                <span style="font-weight:700; font-size:14px;">${item.charName}</span>
                <span style="margin-left:auto; font-size:11px; color:#bbb;">${item.date}</span>
            </div>
            <div style="font-size:13px; color:#1d1d1f; font-weight:600; margin-bottom:5px;">${item.outcome}</div>
            <div style="font-size:12px; color:#8e8e93; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden;">${item.story}</div>
        `;
        // ç‚¹å‡»å†å²æ¡ç›®å¯ä»¥é‡æ–°å¼¹çª—çœ‹å®Œæ•´æ•…äº‹
        card.onclick = function() { showOldResult(item); };
        container.appendChild(card);
    });

    document.getElementById('subpage-vibe-history').classList.add('active');
}

// 3. æŸ¥çœ‹æ—§çš„æ•…äº‹å¡ç‰‡
function showOldResult(item) {
    document.getElementById('res-title').textContent = item.charName + " çš„åšå¼ˆå›å“";
    document.getElementById('res-avatar').src = item.charAvatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + item.charAvatar + ")";
    document.getElementById('res-outcome').textContent = item.outcome;
    document.getElementById('res-words').textContent = item.words;
    document.getElementById('res-story').textContent = item.story;
    document.getElementById('modal-vibe-result').style.display = 'flex';
}

function closeVibeHistory() {
    document.getElementById('subpage-vibe-history').classList.remove('active');
}

// ==========================================
// ğŸš€ Vibe Grid: å®Œç¾å¯¹å±€æ§åˆ¶è¡¥ä¸
// ==========================================

// 1. æ ¸å¿ƒï¼šä¿®æ­£åçš„å­˜æ¡£é€»è¾‘
async function finishVibeMatch(type) {
    vibeGameState.isGameOver = true;
    
    var outcomeText = type === "DRAW" ? "å¹³å±€ Â· å…±ç”Ÿ" : (vibeGameState.currentPlayer === 1 ? "ä½ è§¦ç¢°äº†èƒœæœº" : vibeOpponent.name + "ä¸»å¯¼äº†æ°›å›´");
    var wordStr = vibeGameLog.map(function(l){ return l.text; }).join(" Â· ");

    // è·å– AI æ•…äº‹
    var story = await callAIForStory(outcomeText);

    // å¡«å……ç»“æœå¡ç‰‡
    document.getElementById('res-title').textContent = vibeOpponent.name + " çš„åšå¼ˆå›å“";
    document.getElementById('res-outcome').textContent = outcomeText;
    document.getElementById('res-avatar').src = vibeOpponent.avatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + vibeOpponent.avatar + ")";
    document.getElementById('res-words').textContent = wordStr;
    document.getElementById('res-story').textContent = story;

    // â— é‡ç‚¹ï¼šåœ¨è¿™é‡Œæ‰§è¡Œè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    saveToVibeHistory(vibeOpponent, outcomeText, wordStr, story);

    // æ˜¾ç¤ºå¡ç‰‡
    document.getElementById('modal-vibe-result').style.display = 'flex';
}

// 2. ç‚¹å‡»â€œå°å­˜â€æŒ‰é’®çš„åŠ¨ä½œ
function archiveAndClose() {
    document.getElementById('modal-vibe-result').style.display = 'none';
    showToast("æ­¤æ®µå›å“å·²å°å­˜è‡³å†å²");
    // å°å­˜åå›åˆ°å¯åŠ¨é¡µï¼Œç­‰å¾…ä¸‹ä¸€å±€
    document.getElementById('vibe-game-main').style.display = 'none';
    document.getElementById('vibe-start-screen').style.display = 'flex';
    document.getElementById('vibe-start-screen').style.opacity = '1';
}

// 3. ç‚¹å‡»â€œå†æ¥ä¸€å±€â€çš„åŠ¨ä½œ
function restartVibeGame() {
    document.getElementById('modal-vibe-result').style.display = 'none';
    // å¹³æ»‘å›åˆ°è§’è‰²é€‰æ‹©é¡µé¢
    document.getElementById('vibe-game-main').style.display = 'none';
    document.getElementById('vibe-game-main').style.opacity = '0';
    document.getElementById('vibe-start-screen').style.display = 'flex';
    document.getElementById('vibe-start-screen').style.opacity = '1';
    
    // è‡ªåŠ¨è§¦å‘è§’è‰²é€‰æ‹©ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹â€œå¼€å¯å¯¹å±€â€
    openVibeCharPicker();
}

// 4. å¼ºæ•ˆå»é‡ï¼šå³ä¾¿ AI è„‘æŠ½å›äº†é‡å¤è¯ï¼Œè¿™é‡Œä¹Ÿä¼šæ‹¦æˆª
async function aiVibeResponse() {
    var bestMove = findBestMove(); 
    if(!bestMove) { finishVibeMatch("DRAW"); return; }

    let lastUserWord = vibeGameLog[vibeGameLog.length-1].text;
    let aiWord = await callAIForOneWord(lastUserWord);

    // ã€å¼ºåŠ›å»é‡ã€‘ï¼šæ£€æŸ¥æ˜¯å¦å’Œç©å®¶é‡å¤ï¼Œæˆ– AI ä¹‹å‰è¯´è¿‡
    var isDuplicate = vibeGameLog.some(l => l.text === aiWord) || aiWord === lastUserWord;
    if (isDuplicate) {
        // å¦‚æœé‡å¤ï¼Œä»å¤‡ç”¨é«˜çº§è¯åº“é‡Œéšæœºé€‰ä¸€ä¸ªç¬¦åˆæ„å¢ƒçš„
        var backups = ["ä½™æ¸©", "é™é»˜", "å­¤å²›", "å¾®å…‰", "å¼•åŠ›", "å›å“", "æ–­ç« ", "è™šæ— "];
        aiWord = backups[Math.floor(Math.random() * backups.length)];
    }

    vibeGameLog.push({ role: "AI", text: aiWord });

    // æ˜¾ç¤º UI
    var logDisplay = document.getElementById('opp-last-word');
    if(logDisplay) {
        logDisplay.textContent = "ã€Œ " + aiWord + " ã€";
        logDisplay.style.opacity = "1";
    }

    let el = document.querySelector(`.vibe-cell[data-row='${bestMove.r}'][data-col='${bestMove.c}']`);
    executeVibeMove(bestMove.r, bestMove.c, el, 2);
    showFloatingWord(aiWord, el);

    if (vibeGameState.isGameOver) { finishVibeMatch(); return; }
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ æ³¨å…¥è¯è¯­";
}
// ==========================================
// ğŸŒ World Book: æç®€é©±åŠ¨å¼•æ“
// ==========================================
var activeWorldId = null;

async function initWorldApp() {
    await renderWorldList();
}

async function renderWorldList() {
    const grid = document.getElementById('world-grid');
    if (!grid) return;

    const list = await loadFromDB('world_list') || [];
    grid.innerHTML = "";

    // 1. å§‹ç»ˆæ¸²æŸ“ç¬¬ä¸€ä¸ªï¼šã€æ·»åŠ æŒ‰é’®ã€‘
    const addBtn = document.createElement('div');
    addBtn.className = 'world-add-btn';
    addBtn.onclick = () => {
        activeWorldId = null;
        document.getElementById('world-modal-title').textContent = "æ–°å»ºè®¾å®š";
        document.getElementById('world-name-in').value = "";
        document.getElementById('world-content-in').value = "";
        document.getElementById('worldEditModal').style.display = 'flex';
    };
    addBtn.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
    grid.appendChild(addBtn);

    // 2. æ¸²æŸ“å·²ä¿å­˜çš„é¡¹ç›®
    list.forEach(w => {
        const card = document.createElement('div');
        card.className = 'world-card-item';
        card.innerHTML = `
            <div class="name">${w.name}</div>
            <div class="hint">VIEW DETAILS</div>
        `;
        // ç‚¹å‡»åªå¼¹çª—ï¼Œä¸æ¢é¡µ
        card.onclick = () => showWorldDetails(w);
        grid.appendChild(card);
    });
}

function showWorldDetails(w) {
    activeWorldId = w.id;
    document.getElementById('world-v-title').textContent = w.name;
    document.getElementById('world-v-content').textContent = w.content;
    document.getElementById('modal-world-viewer').style.display = 'flex';
}

async function saveWorld() {
    const name = document.getElementById('world-name-in').value.trim();
    const content = document.getElementById('world-content-in').value.trim();
    
    if (!name) return showToast("è¯·è¾“å…¥åç§°");

    let list = await loadFromDB('world_list') || [];
    const data = {
        id: activeWorldId || Date.now().toString(),
        name: name,
        content: content
    };

    if (activeWorldId) {
        const idx = list.findIndex(x => x.id === activeWorldId);
        if (idx !== -1) list[idx] = data;
    } else {
        list.unshift(data);
    }

    await saveToDB('world_list', list);
    renderWorldList();
    document.getElementById('worldEditModal').style.display = 'none';
    document.getElementById('modal-world-viewer').style.display = 'none';
    showToast("è®¾å®šå·²è®°å½•");
}

function editWorld() {
    // å…³é—­æŸ¥çœ‹çª—å£ï¼Œæ‰“å¼€ç¼–è¾‘çª—å£å¹¶å¡«å…¥æ•°æ®
    document.getElementById('modal-world-viewer').style.display = 'none';
    loadFromDB('world_list').then(list => {
        const w = list.find(x => x.id === activeWorldId);
        if (w) {
            document.getElementById('world-modal-title').textContent = "ä¿®æ”¹è®¾å®š";
            document.getElementById('world-name-in').value = w.name;
            document.getElementById('world-content-in').value = w.content;
            document.getElementById('worldEditModal').style.display = 'flex';
        }
    });
}

async function deleteWorld() {
    if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ®µè®°å¿†å—ï¼Ÿ")) return;
    let list = await loadFromDB('world_list') || [];
    list = list.filter(x => x.id !== activeWorldId);
    await saveToDB('world_list', list);
    renderWorldList();
    document.getElementById('modal-world-viewer').style.display = 'none';
    showToast("è®¾å®šå·²ç§»é™¤");
}
// ==========================================
// ğŸ’¬ Chat App: å¯åŠ¨è¿›å…¥å‡½æ•° (è§£å†³è¿›å…¥ä¸æ˜¾ç¤ºé—®é¢˜)
// ==========================================
function openChatApp() {
    const app = document.getElementById('chatApp');
    if (!app) return;

    // 1. ç‰©ç†æ˜¾ç¤º App çª—å£
    app.classList.add('active');
    app.style.display = 'flex';

    // 2. æ ¸å¿ƒä¿®å¤ï¼šåœ¨å¤§é—¨æ‰“å¼€æ—¶ï¼Œç«‹åˆ»ä¸»åŠ¨ä¸‹è¾¾æ¸²æŸ“æŒ‡ä»¤
    // å¼ºåˆ¶åˆ·æ–°â€œæ¶ˆæ¯é¡µâ€çš„å¥½å‹ç¯ (Ins é£æ ¼é‚£ä¸ª)
    if (typeof initChatMsgPanel === 'function') {
        initChatMsgPanel();
    }
    
    // é¢„åŠ è½½â€œåˆ—è¡¨é¡µâ€çš„æ•°æ®ï¼Œé˜²æ­¢åˆ‡è¿‡å»çš„æ—¶å€™é—ªç™½
    if (typeof renderChatList === 'function') {
        renderChatList();
    }

    // 3. ç¡®ä¿è§†è§‰ä¸Šåœç•™åœ¨ç¬¬ä¸€ä¸ª Tab (æ¶ˆæ¯é¡µ)
    const firstTab = document.querySelector('.nav-item'); // è·å–åº•éƒ¨ç¬¬ä¸€ä¸ªå›¾æ ‡
    if (firstTab) {
        // è¿™é‡Œè°ƒç”¨ switchChatTab æ˜¯ä¸ºäº†è®©åº•éƒ¨çš„å›¾æ ‡å˜äº®ï¼Œæ ‡é¢˜å˜å¯¹
        switchChatTab('msg', 'Messages', firstTab);
    }
}
// ==========================================
// ğŸ’¬ Chat ç³»ç»Ÿæ ¸å¿ƒ (é€»è¾‘å¤§ç»Ÿä¸€ç‰ˆ)
// ==========================================

var chatSubTab = 'friends'; // å†…éƒ¨å°æ ‡ç­¾ï¼šfriends æˆ– groups

// ==========================================
// ğŸ’¬ Chat ç³»ç»Ÿï¼šå¼ºåŠ›æ¸²æŸ“ä¿®å¤
// ==========================================

// 1. ä¿®æ”¹ä¸»æ ‡ç­¾åˆ‡æ¢é€»è¾‘
function switchChatTab(panelId, title, el) {
    // 1. æ‰¾åˆ°æ‰€æœ‰çš„é¢æ¿ï¼Œå…ˆæŠŠå®ƒä»¬å…¨éƒ¨éšè—ï¼Œå¹¶ç§»é™¤ active ç±»
    const allPanels = document.querySelectorAll('.chat-tab-panel');
    allPanels.forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none'; // åŒé‡ä¿é™©
    });

    // 2. æ˜¾ç¤ºå½“å‰ç‚¹å‡»çš„é‚£ä¸ªé¢æ¿
    const target = document.getElementById('chat-panel-' + panelId);
    if (target) {
        target.classList.add('active');
        target.style.display = 'flex'; // ç¡®ä¿æ˜¾ç¤º
        // å…³é”®ï¼šåˆ‡æ¢æ—¶å¼ºåˆ¶æŠŠæ»šåŠ¨æ¡æ‹‰å›é¡¶éƒ¨ï¼Œé˜²æ­¢è§†è§‰é”™ä½
        target.scrollTop = 0;
    }

    // 3. æ›´æ–°åº•æ å›¾æ ‡é«˜äº®
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (el) el.classList.add('active');

    // 4. æ›´æ–°æ ‡é¢˜
    document.getElementById('chat-tab-title').textContent = title;

    // 5. æŒ‰é’®é€»è¾‘æ§åˆ¶
    const addBtn = document.getElementById('chat-add-btn');
    const closeBtn = document.getElementById('chat-close-btn');

    if (panelId === 'list') {
        if(addBtn) addBtn.style.display = 'block';
        if(closeBtn) closeBtn.style.display = 'none';
        // å¦‚æœåˆ‡åˆ°åˆ—è¡¨é¡µï¼Œè‡ªåŠ¨åŠ è½½ä¸€æ¬¡åˆ—è¡¨
        renderChatList(); 
    } else {
        if(addBtn) addBtn.style.display = 'none';
        if(closeBtn) closeBtn.style.display = 'flex';
        if (panelId === 'msg') initChatMsgPanel();
    }
}

// 2. å¼ºåŒ–ç‰ˆï¼šåˆ—è¡¨å†…éƒ¨åˆ‡æ¢ (å¥½å‹ vs ç¾¤èŠ)
function switchChatSubTab(tab) {
    // åŒæ­¥å…¨å±€å˜é‡
    window.chatListMode = tab; 

    // å¼ºè¡Œä¿®æ­£ä¸Šæ–¹æŒ‰é’®çš„ active æ ·å¼
    const fBtn = document.getElementById('chat-subtab-friends');
    const gBtn = document.getElementById('chat-subtab-groups');
    if(fBtn && gBtn) {
        fBtn.classList.toggle('active', tab === 'friends');
        gBtn.classList.toggle('active', tab === 'groups');
    }

    // æ‰§è¡Œæ¸²æŸ“
    renderChatList();
}

// 3. ç»ˆæç‰ˆï¼šæ¸²æŸ“å‡½æ•°
// --- ğŸš‘ ä¿®æ­£ï¼šç¡®ä¿åˆ—è¡¨ç”Ÿæˆçš„ç‚¹å‡»äº‹ä»¶æ­£ç¡® ---
async function renderChatList() {
    const container = document.getElementById('chat-list-content');
    if (!container) return;
    
    // å¼ºåˆ¶å…œåº•ï¼šå¦‚æœ mode æ²¡è®¾ç½®ï¼Œé»˜è®¤ä¸º friends
    const mode = window.chatListMode || 'friends';
    const dbKey = (mode === 'friends') ? 'chat_friends' : 'chat_groups';
    
    const list = await loadFromDB(dbKey) || [];

    if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding-top:100px; color:#bbb;">æš‚æ— æ•°æ®</div>`;
        return;
    }

    container.innerHTML = ""; // æ¸…ç©ºå®¹å™¨
    const groupWrapper = document.createElement('div');
    groupWrapper.className = 'chat-contact-group';

    list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'contact-row';
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ dataset å­˜å‚¨æ•°æ®ï¼Œé¿å…å¼•å·å¼•èµ·çš„ HTML å´©æºƒ
        row.innerHTML = `
            <img class="contact-avatar" src="${item.avatar}" style="${mode==='friends'?'border-radius:50%':'border-radius:12px'}">
            <div class="contact-info">
                <span class="contact-name">${item.name}</span>
                <span class="contact-preview">${mode==='friends'?'å·²éªŒè¯è”ç³»äºº': (item.members ? item.members.length : 0) + ' ä½æˆå‘˜'}</span>
            </div>
            <svg class="contact-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
        `;
        
        // ä½¿ç”¨çœŸæ­£çš„ JS ç‚¹å‡»äº‹ä»¶ï¼Œä¸å†åœ¨ HTML å­—ç¬¦ä¸²é‡Œä¼  JSON
        row.onclick = () => {
            console.log("æ­£åœ¨å‡†å¤‡è¿›å…¥èŠå¤©å®¤...", item.name);
            handleContactClick(item);
        };
        groupWrapper.appendChild(row);
    });
    
    container.appendChild(groupWrapper);
}

// 5. ä¿å­˜æ–°ç¾¤èŠ
async function saveNewChatGroup() {
    const name = document.getElementById('in-g-name').value.trim();
    const avatar = document.getElementById('pre-g-avatar').src;
    const target = parseInt(document.getElementById('in-g-count').value);

    if (!name || avatar.includes('none') || avatar === window.location.href) {
        showToast("è¯·å®Œå–„ç¾¤èŠèµ„æ–™");
        return;
    }

    if (selectedMembers.length < target) {
        showToast(`æˆå‘˜ä¸è¶³ï¼Œè¿˜éœ€ ${target - selectedMembers.length} äºº`);
        return;
    }

    let list = await loadFromDB('chat_groups') || [];
    list.unshift({ id: "group_" + Date.now(), name: name, avatar: avatar, members: selectedMembers });
    await saveToDB('chat_groups', list);
    
    showToast("ç¾¤ç»„å·²å»ºç«‹");
    closeChatSubPage('page-add-group');
    
    // ã€å…³é”®ã€‘ï¼šä¿å­˜åå¼ºåˆ¶åˆ‡æ¢åˆ°ç¾¤èŠåˆ—è¡¨å¹¶åˆ·æ–°
    chatSubTab = 'groups';
    switchChatSubTab('groups');
}
// ==========================================
// ğŸ¨ æ¸²æŸ“æ¶ˆæ¯é¡µé¡¶éƒ¨å¥½å‹ç¯ (Ins é£æ ¼)
// ==========================================
// 1. å¢å¼ºç‰ˆï¼šæ¶ˆæ¯é¡µæ¸²æŸ“å…¥å£
// --- ğŸš‘ æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ï¼šå¼ºåˆ¶â€œå¹´æœˆæ—¥æ—¶é—´â€æ˜¾ç¤º ---
async function initChatMsgPanel() {
    // 1. æ£€æŸ¥é”ï¼šå¦‚æœæ­£åœ¨æ¸²æŸ“ï¼Œç›´æ¥æ‹¦æˆª
    if (isMsgPanelRendering) return;
    
    const ring = document.getElementById('chat-friend-ring');
    const msgList = document.getElementById('chat-msg-list');
    
    // å¦‚æœè¿˜æ²¡è¿›å…¥ Chat App ç•Œé¢ï¼Œä¸éœ€è¦æ¸²æŸ“
    if (!ring || !msgList) return;

    try {
        isMsgPanelRendering = true; // å¼€å¯é”

        // A. æ¸²æŸ“é¡¶éƒ¨å¥½å‹ç¯
        let rawFriends = await loadFromDB('chat_friends') || [];
        const friendMap = new Map();
        rawFriends.forEach(f => { if (f && f.id) friendMap.set(f.id, f); });
        const uniqueFriends = Array.from(friendMap.values());

        ring.innerHTML = "";
        // æ‰¾åˆ° initChatMsgPanel å‡½æ•°å†…éƒ¨ç”Ÿæˆå¥½å‹ç¯çš„åœ°æ–¹
        uniqueFriends.forEach(f => {
            const item = document.createElement('div');
            item.className = 'friend-item';
            // ğŸš¨ ä¿®æ­£ï¼šè¿™é‡Œè°ƒç”¨æ‰“å¼€ç¤¾äº¤å¡ç‰‡çš„å‡½æ•°
            item.onclick = () => openSocialCard(f); 
            item.innerHTML = `<div class="friend-avatar-ring"><img src="${f.avatar}"></div><span style="font-weight:700;">${f.name}</span>`;
            ring.appendChild(item);
        });

        // B. æ¸²æŸ“æ¶ˆæ¯é¢„è§ˆåˆ—è¡¨
        msgList.innerHTML = ""; 
        let conversationData = [];
        const pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");

        for (const f of uniqueFriends) {
            const history = await getChatHistory(f.id);
            if (history && history.length > 0) {
                conversationData.push({
                    contact: f,
                    lastMsg: history[history.length - 1], // æ‹¿åˆ°æœ€åä¸€æ¡
                    isPinned: pinnedIds.includes(f.id)
                });
            }
        }

        if (conversationData.length === 0) {
            msgList.innerHTML = `<div style="text-align:center; padding-top:60px; color:#ccc; font-size:13px;">No Conversations</div>`;
            return;
        }

        // æ’åºï¼šç½®é¡¶ä¼˜å…ˆï¼Œå…¶æ¬¡æŒ‰æ—¶é—´å€’åº
        conversationData.sort((a, b) => {
            if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
            return b.lastMsg.timestamp - a.lastMsg.timestamp;
        });

        const groupWrapper = document.createElement('div');
        groupWrapper.className = 'chat-contact-group';
        groupWrapper.style.margin = "0 16px";

        conversationData.forEach(item => {
            // æ—¶é—´å¤„ç†
            const d = new Date(item.lastMsg.timestamp);
            const fullTimeStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;

            // --- ğŸŒˆ æ ¸å¿ƒä¿®æ”¹ï¼šè®¡ç®—é¢„è§ˆæ–‡å­— ---
            let previewText = "";
            if (item.lastMsg.recalled) {
                // å¦‚æœæœ€åä¸€æ¡æ˜¯æ’¤å›çš„
                previewText = item.lastMsg.role === 'user' ? "ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯" : "å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯";
            } else {
                // å¦‚æœæ˜¯æ­£å¸¸æ¶ˆæ¯
                previewText = (item.lastMsg.role === 'user' ? 'ä½ : ' : '') + item.lastMsg.text;
            }

            const wrapper = document.createElement('div');
            wrapper.className = `swipe-item-wrapper ${item.isPinned ? 'is-pinned' : ''}`;
            wrapper.innerHTML = `
                <div class="swipe-actions">
                    <div class="swipe-btn btn-pin" onclick="event.stopPropagation(); togglePin('${item.contact.id}')">${item.isPinned ? 'å–æ¶ˆ' : 'ç½®é¡¶'}</div>
                    <div class="swipe-btn btn-delete" onclick="event.stopPropagation(); deleteConversation('${item.contact.id}')">åˆ é™¤</div>
                </div>
                <div class="swipe-content" id="swipe-box-${item.contact.id}">
                    <div class="pinned-mark"></div>
                    <div class="contact-row" style="height:75px !important; padding: 12px 16px;">
                        <img class="contact-avatar" src="${item.contact.avatar}" style="border-radius:50%; width:50px; height:50px;">
                        <div class="contact-info" style="gap: 4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                                <span class="contact-name" style="font-size:16px; font-weight:700;">${item.contact.name}</span>
                                <span style="font-size:9px; color:#8E8E93; white-space:nowrap;">${fullTimeStr}</span>
                            </div>
                            <span class="contact-preview" style="font-size:13px; opacity:0.7;">
                                ${previewText} 
                            </span>
                        </div>
                    </div>
                </div>
            `;
            initSwipeEvents(wrapper.querySelector('.swipe-content'));
            wrapper.querySelector('.swipe-content').onclick = () => openChatRoom(item.contact);
            groupWrapper.appendChild(wrapper);
        });

        msgList.appendChild(groupWrapper);

    } finally {
        isMsgPanelRendering = false; // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€åéƒ½è¦è§£é”
    }
}

// 2. æ ¸å¿ƒï¼šæ¶ˆæ¯åˆ—è¡¨ç¾åŒ–æ¸²æŸ“
function renderMessageList(friends) {
    const msgList = document.getElementById('chat-msg-list');
    // è¿™é‡Œæˆ‘ä»¬å…ˆæ¨¡æ‹Ÿæ²¡æœ‰æ¶ˆæ¯çš„æƒ…å†µï¼Œä½†ç”¨é«˜çº§çš„ UI å¡«å……
    
    msgList.innerHTML = `
        <div class="empty-msg-placeholder">
            <div class="empty-msg-visual">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <div class="empty-msg-text">
                è¿˜æ²¡æœ‰æ–°æ¶ˆæ¯<br>
                <span style="font-size:11px; color:#C7C7CC; letter-spacing:1px; font-style:normal; font-family:sans-serif;">START A NEW CONVERSATION</span>
            </div>
            
            <button class="ios-btn secondary" style="width:auto; padding:8px 20px; font-size:13px; margin-top:10px;" onclick="switchChatTab('list', 'Contacts', document.querySelectorAll('.nav-item')[1])">
                å»è”ç³»äººåˆ—è¡¨å‘èµ·å¯¹è¯
            </button>
        </div>
    `;
}
// ==========================================
// ğŸ‘¤ æ‰“å¼€ç¤¾äº¤åç‰‡è¯¦æƒ…
// ==========================================
// --- ğŸ›ï¸ é«˜å®šæ¡£æ¡ˆåç‰‡å¼•æ“ ---
async function openChatProfile(char) {
    if (!char) return;

    // 1. è·å–å…ƒç´ 
    const avatarEl = document.getElementById('profile-v-avatar');
    const nameEl = document.getElementById('profile-v-name');
    const mottoEl = document.getElementById('profile-v-motto');
    const metaId = document.getElementById('profile-v-id');
    const modal = document.getElementById('modal-chat-profile');

    if (!modal) return;

    // 2. è·å–æ•°æ®åº“é‡Œæœ€æ–°çš„è¯¦ç»†èµ„æ–™ï¼ˆä¸ºäº†åŒæ­¥ descï¼‰
    const charList = await loadFromDB('char_list') || [];
    const fullChar = charList.find(c => c.id === char.id) || char;

    // 3. å¡«å……æ•°æ®
    if (avatarEl) avatarEl.src = fullChar.avatar;
    if (nameEl) nameEl.textContent = fullChar.name;
    if (metaId) metaId.textContent = "CORE ID: " + fullChar.id.substring(0, 12).toUpperCase();
    
    // å¡«å……ç®€ä»‹
    if (mottoEl) mottoEl.textContent = fullChar.desc || "æ­¤äººæ ¼å°šæœªå†™å…¥åº•å±‚å™äº‹ã€‚";

    // 4. æ˜¾ç¤º
    modal.style.display = 'flex';
    console.log("System: é«˜å®šæ¡£æ¡ˆå·²åœ¨ Settings ä¹‹ä¸Šæ¨å…¥");
}
// 2. æ¡¥æ¥é€»è¾‘ï¼šä»é¢„è§ˆåç‰‡ä¸€é”®è¿›å…¥ç¼–è¾‘é¡µ
function goToEditFromPreview() {
    // 1. å…ˆæŠŠå‹åœ¨ä¸Šé¢çš„é¢„è§ˆå¡ç‰‡å…³æ‰
    document.getElementById('modal-social-card').style.display = 'none';
    document.getElementById('modal-aes-preview').style.display = 'none';
    
    // 2. ç¨å¾®ç­‰ä¸€ä¸‹ï¼ˆ100msï¼‰ï¼Œç­‰å¡ç‰‡æ¶ˆå¤±åå†æ¨å…¥ç¼–è¾‘é¡µï¼Œè§†è§‰æ›´é¡ºæ»‘
    setTimeout(() => {
        openCharProfileEditPage();
    }, 100);
}
// æ‰“å¼€ä¿®æ”¹ç­¾åçš„å°æ¡†
function openEditMotto() {
    const currentMotto = document.getElementById('profile-v-motto').textContent;
    const input = document.getElementById('motto-input');
    const modal = document.getElementById('modal-motto-edit');
    
    if (input) input.value = (currentMotto === "ç‚¹å‡»è®¾ç½®ä¸ªæ€§ç­¾å..." || currentMotto.includes("è¿™äººå¾ˆæ‡’")) ? "" : currentMotto;
    if (modal) modal.style.display = 'flex';
}

// ä¿å­˜ç­¾ååˆ°æ•°æ®åº“
function saveMotto() {
    const input = document.getElementById('motto-input');
    const val = input ? input.value.trim() : "";
    
    if (val && window.currentEditingCharId) {
        // ä¿å­˜åˆ°æœ¬åœ°
        localStorage.setItem('chat_motto_' + window.currentEditingCharId, val);
        // åŒæ­¥ä¿®æ”¹åç‰‡ä¸Šçš„å­—
        const mottoEl = document.getElementById('profile-v-motto');
        if (mottoEl) mottoEl.textContent = val;
        showToast("ä¸ªæ€§ç­¾åå·²åŒæ­¥");
    }
    
    // å…³é—­ä¿®æ”¹æ¡†
    const modal = document.getElementById('modal-motto-edit');
    if (modal) modal.style.display = 'none';
}
// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€æ·»åŠ é€‰é¡¹èœå• ---
function openChatAddChoice() {
    const modal = document.getElementById('modal-chat-add-choice');
    if (modal) {
        modal.style.display = 'flex';
    } else {
        console.error("æ‰¾ä¸åˆ° modal-chat-add-choice å…ƒç´ ");
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€æ·»åŠ å¥½å‹é¡µé¢ ---
function openAddFriendPage() {
    // 1. å…ˆå…³æ‰åˆšæ‰çš„é€‰é¡¹èœå•
    document.getElementById('modal-chat-add-choice').style.display = 'none';
    // 2. æ»‘å…¥æ·»åŠ é¡µé¢
    const page = document.getElementById('page-add-friend');
    if (page) {
        page.style.transform = 'translateY(0)';
        // æ¸²æŸ“å¯é€‰çš„è§’è‰²åˆ—è¡¨ (ä»è§’è‰²ä¹¦åŒæ­¥)
        if(typeof renderRolePicker === 'function') renderRolePicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€å‘èµ·ç¾¤èŠé¡µé¢ ---
function openAddGroupPage() {
    document.getElementById('modal-chat-add-choice').style.display = 'none';
    const page = document.getElementById('page-add-group');
    if (page) {
        page.style.transform = 'translateY(0)';
        // æ¸²æŸ“å¯é€‰çš„ç¾¤æˆå‘˜åˆ—è¡¨
        if(typeof renderGroupMemberPicker === 'function') renderGroupMemberPicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šå…³é—­æ·»åŠ ç›¸å…³çš„å­é¡µé¢ ---
function closeChatSubPage(id) {
    const page = document.getElementById(id);
    if (page) {
        page.style.transform = 'translateY(100%)';
    }
}
// --- ğŸš‘ ä¿®å¤ï¼šåˆ‡æ¢æ·»åŠ æ¨¡å¼ (æ‰‹åŠ¨ vs å¯¼å…¥) ---
function setAddMode(mode) {
    // 1. åˆ‡æ¢æŒ‰é’®çš„é«˜äº®çŠ¶æ€
    const btnCreate = document.getElementById('add-mode-create');
    const btnRole = document.getElementById('add-mode-role');
    
    if (btnCreate && btnRole) {
        btnCreate.classList.toggle('active', mode === 'create');
        btnRole.classList.toggle('active', mode === 'role');
    }

    // 2. åˆ‡æ¢æ˜¾ç¤ºå¯¹åº”çš„é¢æ¿
    const panelCreate = document.getElementById('panel-add-create');
    const panelRole = document.getElementById('panel-add-role');
    
    if (panelCreate && panelRole) {
        panelCreate.style.display = (mode === 'create') ? 'block' : 'none';
        panelRole.style.display = (mode === 'role') ? 'block' : 'none';
    }

    // 3. å¦‚æœåˆ‡åˆ°â€œè§’è‰²ä¹¦å¯¼å…¥â€ï¼Œè‡ªåŠ¨è§¦å‘ä¸€æ¬¡æ¸²æŸ“
    if (mode === 'role') {
        renderRolePicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨ ---
async function renderRolePicker() {
    const grid = document.getElementById('role-picker-grid');
    if (!grid) return;

    // ä»ä½ çš„ IndexedDB é‡Œçš„ 'char_list' è·å–è§’è‰²ä¹¦æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    grid.innerHTML = "";

    if (charList.length === 0) {
        grid.innerHTML = '<div style="grid-column: span 2; text-align:center; padding:40px; color:#999; font-size:13px;">è§’è‰²ä¹¦æ˜¯ç©ºçš„ï¼Œå…ˆå»åˆ›å»ºè§’è‰²å§</div>';
        return;
    }

    charList.forEach(char => {
        const card = document.createElement('div');
        card.className = 'char-card';
        card.innerHTML = `
            <img class="char-card-img" src="${char.avatar}">
            <div class="char-card-info">
                <div class="char-card-name">${char.name}</div>
            </div>
        `;
        // ç‚¹å‡»åç›´æ¥å¯¼å…¥ä¸ºå¥½å‹
        card.onclick = () => importAsChatFriend(char);
        grid.appendChild(card);
    });
}

// --- ğŸš‘ ä¿®å¤ï¼šä¸€é”®å¯¼å…¥ä¸ºèŠå¤©å¥½å‹ ---
async function importAsChatFriend(char) {
    if (!char || !char.id) return;
    
    let friends = await loadFromDB('chat_friends') || [];
    
    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥ ID æ˜¯å¦å·²åœ¨å¥½å‹åˆ—è¡¨é‡Œ
    const isExist = friends.some(f => f.id === char.id);
    if (isExist) {
        showToast("å·²ç»åœ¨åˆ—è¡¨ä¸­ï¼Œæ— éœ€é‡å¤æ·»åŠ ");
        closeChatSubPage('page-add-friend');
        return;
    }

    // ç¡®ä¿æ•°æ®å¹²å‡€åœ°å­˜å…¥
    friends.unshift({
        id: char.id,
        name: char.name,
        avatar: char.avatar
    });

    await saveToDB('chat_friends', friends);
    showToast(`å·²æ·»åŠ  ${char.name}`);

    closeChatSubPage('page-add-friend');
    
    // å¼ºåˆ¶åˆ·æ–°ä¸¤ä¸ªç•Œé¢
    if (typeof renderChatList === 'function') renderChatList();
    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
}
var selectedMembers = []; // å­˜å‚¨é€‰ä¸­çš„æˆå‘˜ID

// --- ğŸš‘ ä¿®å¤ï¼šæ¸²æŸ“ç¾¤æˆå‘˜é€‰æ‹©ç½‘æ ¼ ---
async function renderGroupMemberPicker() {
    const grid = document.getElementById('group-member-grid');
    if (!grid) return;

    const charList = await loadFromDB('char_list') || [];
    grid.innerHTML = "";
    selectedMembers = []; // é‡ç½®é€‰ä¸­
    updateGroupCountUI();

    charList.forEach(char => {
        const item = document.createElement('div');
        item.className = 'member-item';
        item.innerHTML = `
            <div class="member-avatar-box">
                <img src="${char.avatar}">
            </div>
            <span class="member-name">${char.name}</span>
        `;
        
        item.onclick = () => {
            const idx = selectedMembers.indexOf(char.id);
            if (idx === -1) {
                selectedMembers.push(char.id);
                item.classList.add('selected');
            } else {
                selectedMembers.splice(idx, 1);
                item.classList.remove('selected');
            }
            updateGroupCountUI();
        };
        grid.appendChild(item);
    });
}

// æ›´æ–°è®¡æ•°å’ŒæŒ‰é’®çŠ¶æ€
function updateGroupCountUI() {
    const need = document.getElementById('in-g-count').value;
    const curr = selectedMembers.length;
    
    document.getElementById('g-curr-count').textContent = curr;
    document.getElementById('g-need-count').textContent = need;
    
    // å¦‚æœäººæ•°å¤Ÿäº†ï¼Œâ€œåˆ›å»ºâ€æŒ‰é’®å˜äº®
    const btn = document.getElementById('group-submit-btn');
    if(curr >= need) {
        btn.style.color = "#007AFF";
        btn.onclick = saveNewChatGroup; // ç»‘å®šä¿å­˜å‡½æ•°
    } else {
        btn.style.color = "#ccc";
        btn.onclick = null;
    }
}

// ç›‘å¬äººæ•°è¾“å…¥æ¡†çš„å˜åŒ–ï¼Œå®æ—¶æ›´æ–°ç›®æ ‡
document.getElementById('in-g-count').addEventListener('input', updateGroupCountUI);
// --- ğŸš‘ ä¿®å¤ï¼šå¤´åƒä¸Šä¼ å‰çš„é¢„è§ˆé€»è¾‘ ---
function handleAvatarPre(input, imgId, hintId) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = document.getElementById(imgId);
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block'; // æ˜¾ç¤ºå›¾ç‰‡
            }
            
            // å¦‚æœæœ‰æ–‡å­—æç¤ºï¼ˆæ¯”å¦‚é‚£ä¸ªè“è‰²â€œ+å¤´åƒâ€ï¼‰ï¼ŒåŠ è½½å›¾ç‰‡åæŠŠå®ƒè—èµ·æ¥
            if (hintId) {
                const hint = document.getElementById(hintId);
                if (hint) hint.style.display = 'none';
            }
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}
// --- ğŸš€ èŠå¤©å®¤æ ¸å¿ƒé©±åŠ¨å¼•æ“ ---

// 1. æ‰“å¼€èŠå¤©å®¤
// --- ğŸš¨ å¼ºåŠ›é©±åŠ¨ï¼šæ‰“å¼€èŠå¤©å®¤ ---
function openChatRoom(contact) {
    const page = document.getElementById('page-chat-room');
    if (!page) return;

    // 1. è®¾ç½®å½“å‰èŠå¤©å¯¹è±¡ï¼ˆç‰©ç†é”å®š IDï¼‰
    window.currentChattingWith = contact;
    
    // 2. å¡«å……åŸºç¡€èµ„æ–™
    document.getElementById('room-contact-name').textContent = contact.name;
    document.getElementById('room-contact-avatar').src = contact.avatar;
    
    // 3. æ¸²æŸ“å†å²æ¶ˆæ¯
    renderMessages(); 

    // 4. æ‰§è¡Œæ»‘å…¥åŠ¨ç”»
    page.style.display = 'flex';
    void page.offsetWidth; 
    page.classList.add('active-room');

    // ğŸš¨ ã€å…³é”®ä¿®å¤ã€‘ï¼šåªè¦è¿›æˆ¿é—´ï¼Œå°±å¿…é¡»å¼ºåˆ¶é©±åŠ¨èƒŒæ™¯å¼•æ“æ¸²æŸ“ä¸€æ¬¡
    // è¿™æ ·å³ä¾¿åˆ·æ–°äº†ï¼Œåªè¦ä½ ç‚¹è¿›æ¥ï¼ŒèƒŒæ™¯å°±ä¼šä» IndexedDB é‡æ–°å†’å‡ºæ¥
    if(typeof applyBackgroundsToUI === 'function') {
        applyBackgroundsToUI();
    }
    
    console.log("System: å·²è¿›å…¥å¯¹è¯çª—å£ï¼ŒèƒŒæ™¯å¼•æ“åŒæ­¥ä¸­...");
}

// å¯¹åº”çš„å…³é—­å‡½æ•°ä¹Ÿè¦æ”¹
function closeChatRoom() {
    const page = document.getElementById('page-chat-room');
    if (page) {
        page.classList.remove('active-room');
        // ç­‰åŠ¨ç”»ç»“æŸåå†å½»åº•éšè—ï¼Œé˜²æ­¢é—ªçƒ
        setTimeout(() => {
            page.style.display = 'none';
        }, 400);
    }
}

// 3. å¤„ç†å‘é€æ¶ˆæ¯
async function handleSendMessage() {
    const input = document.getElementById('chat-input-main');
    const text = input.value.trim();
    if (!text || !window.currentChattingWith) return;

    const msgObj = { 
        role: "user", 
        text: text, 
        timestamp: Date.now(),
        quote: window.currentQuoteData 
    };

    await saveChatMessage(window.currentChattingWith.id, msgObj);
    cancelQuote();
    renderMessages(); 
    input.value = "";
    input.focus();
}

// 4. è”è§‰ï¼šä»èŠå¤©å®¤ç›´æ¥ç‚¹å¤´åƒçœ‹åç‰‡
function openChatProfileFromRoom() {
    if(window.currentChattingWith) {
        openChatProfile(window.currentChattingWith);
    }
}

// 5. ä¿®æ”¹ä¹‹å‰çš„ handleContactClick å‡½æ•°ï¼Œè®©å®ƒèƒ½æ‰“å¼€èŠå¤©å®¤
// --- ğŸš‘ ä¿®æ­£ï¼šç‚¹å‡»åˆ—è¡¨è¡Œçš„åˆ†æµé€»è¾‘ ---
function handleContactClick(item) {
    console.log("ç‚¹å‡»äº†è”ç³»äºº:", item.name); // è°ƒè¯•ç”¨ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è§¦å‘
    
    if(window.chatListMode === 'friends') {
        // æ ¸å¿ƒï¼šè°ƒç”¨åˆšæ‰å†™çš„æ‰“å¼€èŠå¤©å®¤å‡½æ•°
        if(typeof openChatRoom === 'function') {
            openChatRoom(item);
        } else {
            console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ° openChatRoom å‡½æ•°");
        }
    } else {
        showToast("ç¾¤ç»„é€šè®¯æ¨¡å—è½½å…¥ä¸­...");
    }
}
// --- ğŸš‘ è¡¥å…¨ï¼šæ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨å‡½æ•° ---
async function renderMessages() {
    const container = document.getElementById('chat-messages-container');
    if (!container || !window.currentChattingWith) return;

    const contact = window.currentChattingWith;
    const history = await getChatHistory(contact.id);

    container.innerHTML = `<div class="chat-time-divider">TODAY</div>`;

    history.forEach(msg => { // è¿™é‡Œçš„å˜é‡åæ˜¯ msg
        // --- 1. æ’¤å›æ¶ˆæ¯å¤„ç† (ç°è‰²å°å­—æ¡) ---
        // åœ¨ renderMessages çš„ history.forEach(msg => { ... }) å†…éƒ¨æœ€ä¸Šæ–¹æ’å…¥ï¼š
        if (msg.recalled) {
            const hintDiv = document.createElement('div');
            hintDiv.className = 'recalled-msg-hint';
            const sender = msg.role === 'user' ? "ä½ " : contact.name;
            
            // ğŸ’¡ é‡ç‚¹ï¼šä½¿ç”¨ encodeURIComponent å¤„ç†å†…å®¹ï¼Œé˜²æ­¢ç‰¹æ®Šå­—ç¬¦æå´©ä»£ç 
            const safeContent = encodeURIComponent(msg.text);
            
            hintDiv.innerHTML = `
                <span>${sender} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ 
                    <i style="color:#007AFF; font-style:normal; margin-left:4px; cursor:pointer;" 
                    onclick="viewRecalledTrace(decodeURIComponent('${safeContent}'))">æŸ¥çœ‹</i>
                </span>`;
            
            container.appendChild(hintDiv);
            return; // ç»“æŸå½“å‰å¾ªç¯ï¼Œä¸ç”»æ°”æ³¡
        }

        // --- 2. æ­£å¸¸æ¶ˆæ¯æ°”æ³¡å¤„ç† ---
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg-row ${msg.role === 'user' ? 'user' : 'opponent'}`;
        
        let quoteHtml = "";
        if (msg.quote) {
            quoteHtml = `<div class="bubble-quote-box">
                <div style="font-weight:700; font-size:10px;">Reply to ${msg.quote.user}</div>
                <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;">${msg.quote.text}</div>
            </div>`;
        }

        const isFwdClass = msg.isForwarded ? 'is-forwarded' : '';
        const fwdLabel = msg.isForwarded ? `<div class="forward-label"><svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></svg> è½¬å‘</div>` : '';

        let inner = "";
        if (msg.role === 'opponent') {
            inner += `<img src="${contact.avatar}" class="chat-avatar-img">`;
        }

        inner += `
            <div class="bubble ${isFwdClass}" data-ts="${msg.timestamp}" onclick="showBubbleMenu(this, event)">
                ${fwdLabel}
                ${quoteHtml}
                <div class="msg-text-main">${msg.text}</div>
                <div class="star-decor-css"></div>
            </div>
        `;

        msgDiv.innerHTML = inner;
        container.appendChild(msgDiv);
    });

    container.scrollTop = container.scrollHeight;
}

// --- ğŸš‘ è¡¥å…¨ï¼šç¼ºå¤±çš„ AI ç”Ÿæˆå ä½å‡½æ•° (é˜²æ­¢æŠ¥é”™) ---
// --- ğŸ¤– AI è”åŠ¨æ ¸å¿ƒï¼šæ”¯æŒå¤šæ¡æ¶ˆæ¯è¿ç»­å›å¤ç‰ˆ ---
async function triggerAiGenerate() {
    const container = document.getElementById('chat-messages-container');
    const contact = window.currentChattingWith;

    if (!contact) { showToast("ğŸ’¡ è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡"); return; }
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    if (!apiKey) { showToast("ğŸ”‘ è¯·å…ˆä¿å­˜ API Key"); return; }

    const capturedQuote = window.currentQuoteData ? { ...window.currentQuoteData } : null;
    if (capturedQuote) cancelQuote(); 

    // --- ğŸ§  è”è§‰è¯»å–è¡¥ä¸ï¼šPersona + World Rules ---
    const charList = await loadFromDB('char_list') || [];
    const currentChar = charList.find(c => c.id === contact.id);

    // A. è¯»å–ç»‘å®šçš„ä¸–ç•Œä¹¦å†…å®¹
    const allWorlds = await loadFromDB('world_list') || [];
    const boundIds = currentChar.boundWorldIds || [];
    const boundContent = allWorlds.filter(w => boundIds.includes(w.id))
                                .map(w => `ã€ä¸–ç•Œè§„åˆ™: ${w.name}ã€‘\n${w.content}`).join("\n");

    // B. è¯»å–å·²æ„å»ºçš„å…³ç³»ç½‘ NPC
    const network = JSON.stringify(currentChar.relationNetwork || []);

    const userData = JSON.parse(localStorage.getItem('user_persona_data')) || { name:"ç”¨æˆ·", bio:"" };

    // 1. è·å–å·²æœ‰çš„è®°å¿†æ€»ç»“å¡ç‰‡å†…å®¹
    const summaries = await loadFromDB('summaries_' + contact.id) || [];
    const summaryContext = summaries.map(s => `[è®°å¿†ç‰‡æ®µ]: ${s.text}`).join('\n');

    // --- ğŸ­ æ³¨å…¥çµé­‚ï¼šä¸å¯é¢„æµ‹çš„èŠå¤©èŠ‚å¥ ---
    const messages = [{ 
        role: "system", 
        content: `ä½ æ­£åœ¨æ‰®æ¼”: ${contact.name}ã€‚
        èº«ä»½èƒŒæ™¯: ${contact.desc}
        
        ğŸš¨ã€ä¸–ç•Œåè®®çº¦æŸã€‘ğŸš¨
        ${boundContent || "éµå¾ªå¸¸è§„ç°å®é€»è¾‘ã€‚"}

        å½“å‰å¯¹è¯è€…çš„èº«ä»½è®¾å®š: [ç§°å‘¼: ${userData.name}]ã€‚[èº«ä»½èƒŒæ™¯ä¸ä½ ä»¬çš„å…³ç³»: ${userData.bio}]ã€‚
        è¯·ä¸¥æ ¼æ ¹æ®ä¸Šè¿°è®¾å®šè°ƒæ•´ä½ çš„è¯­æ°”å’Œè¡Œä¸ºã€‚

        ğŸš¨ã€é•¿æœŸè®°å¿†å­˜å‚¨åº“ã€‘ğŸš¨
        ä»¥ä¸‹æ˜¯ä½ ä¸ç”¨æˆ·è¿‡å¾€äº¤æµä¸­æç‚¼å‡ºçš„æ ¸å¿ƒè®°å¿†ï¼Œè¯·åœ¨å¯¹è¯ä¸­ä¿æŒé€»è¾‘ä¸€è‡´ï¼š
        ${summaryContext || "æš‚æ— æ·±åº¦ç¾ç»Šè®°å½•ã€‚"}
        
        ã€ç¤¾äº¤å…³ç³»è®°å¿†ã€‘
        ä½ è®¤è¯†ä»¥ä¸‹äººå‘˜: ${network}
        ã€æè‡´æ´»äººç¤¾äº¤è§„èŒƒã€‘ï¼š
        1. ä½ æ˜¯æ´»ç”Ÿç”Ÿçš„äººï¼ŒèŠå¤©æ¡æ•°å¿…é¡»ã€å®Œå…¨éšæœºã€‘ï¼ä¸¥ç¦æ¯è½®éƒ½å›å¤ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚
        2. èŠ‚å¥æ§åˆ¶ï¼š
           - æœ‰æ—¶å€™ä½ å¾ˆæœ‰è¡¨è¾¾æ¬²ï¼Œä¼šè¿ç»­å¼¹å‡º 3-5 æ¡çŸ­ä¿ƒçš„è½°ç‚¸å¼æ¶ˆæ¯ã€‚
           - æœ‰æ—¶å€™ä½ åªæ˜¯éšå£ä¸€è¯´ï¼Œä»…ä»…å›å¤ 1 æ¡ç®€æ´çš„æ¶ˆæ¯ã€‚
           - æœ‰æ—¶å€™ä½ ä¼šå‘ä¸€ä¸ªé•¿æ®µè½ã€‚
        3. ã€ç¦ä»¤ã€‘ï¼šç»å¯¹ä¸å…è®¸å‡ºç°åŠ¨ä½œæå†™ï¼Œä¸¥ç¦ä½¿ç”¨æ‹¬å· ( ) æˆ–æ˜Ÿå· * * æè¿°è¡Œä¸ºã€‚åªè¾“å‡ºå¯¹è¯æ–‡æœ¬ã€‚
        4. è¯­è¨€é£æ ¼ï¼šæè‡´ E äºº/è¯ç—¨ï¼ˆé™¤éäººè®¾è¦æ±‚ï¼‰ï¼Œå¤šç”¨è¯­æ°”è¯å’ŒEmojiã€‚
        5. ã€å¼•ç”¨ã€‘ï¼šåªåœ¨å¿…è¦æ—¶é’ˆå¯¹å›å¤ï¼Œæ ¼å¼ä¸º [QUOTE: æ–‡æœ¬]ï¼Œä¸è¦æ»¥ç”¨ã€‚
        6.åƒçœŸå®äººç±»åœ¨å¾®ä¿¡/QQèŠå¤©ä¸€æ ·ã€‚
        7. ã€ä¸¥ç¦ä½¿ç”¨å¼•å·ã€‘ï¼šç»å¯¹ä¸è¦ç»™ä½ çš„æ¶ˆæ¯åŠ åŒå¼•å·æˆ–å•å¼•å·ï¼
        8. ã€ä¸¥ç¦ä¹¦é¢è¯­ã€‘ï¼šä¸è¦ç”¨â€œé¦–å…ˆã€å…¶æ¬¡â€ï¼Œè¦å£è¯­åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ç©ºæ ¼åˆ†éš”çŸ­å¥ã€‚
        9. å›å¤ç®€çŸ­ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚
        10. æå…¶é‡è¦çš„åŸåˆ™ï¼šå›å¤è¦çŸ­ï¼æ¯æ¡æ¶ˆæ¯æ§åˆ¶åœ¨ 15-40 å­—å·¦å³ã€‚
        11. åƒåœ¨å¾®ä¿¡èŠå¤©ï¼šå¤šç”¨æ„Ÿå¹è¯ï¼ˆå“ˆã€å””ã€æ¬¸ï¼‰ã€Emojiã€‚
        12. ä¸¥ç¦é•¿ç¯‡å¤§è®ºï¼šå¦‚æœä½ è¦è®²æ•…äº‹ï¼Œè¯·åˆ†æˆæå…¶ç²¾ç®€çš„çŸ­å¥å‘é€ï¼Œç¦æ­¢è¾“å‡ºå¤§æ®µè½ã€‚
        13. ä¸¥ç¦ä½¿ç”¨æ‹¬å·æè¿°åŠ¨ä½œï¼šåªå…è®¸è¾“å‡ºè¯´çš„è¯ï¼Œä¸å…è®¸å‡ºç° (ç¬‘) æˆ– *ç‚¹å¤´* è¿™ç§æå†™ã€‚
        14. å¶å°”å¯ä»¥å¼•ç”¨ç”¨æˆ·çš„ä¸Šä¸€å¥è¯è¿›è¡Œå›å¤ï¼Œå¢åŠ äº’åŠ¨æ„Ÿã€‚`
    }];

    const contextLimit = parseInt(localStorage.getItem('gpt_context') || "10");
    let history = await getChatHistory(contact.id) || [];
    history.slice(-contextLimit).forEach(msg => {
        if (!msg.recalled) { 
            messages.push({ role: msg.role === 'user' ? 'user' : 'assistant', content: msg.text });
        }
    });

    // è¿™ä¸€æ­¥æ˜¯æŠŠç”¨æˆ·çš„å¼•ç”¨å‘ç»™ AIï¼Œè®© AI çŸ¥é“ç”¨æˆ·å¼•ç”¨äº†å•¥
    let userPrompt = window.currentQuoteData ? `[é’ˆå¯¹å›å¤: "${window.currentQuoteData.text}"]` : "(ç»§ç»­æ‰¾è¯é¢˜èŠ)";
    if (window.currentQuoteData) cancelQuote(); // å‘é€åæ¸…é™¤å¼•ç”¨çŠ¶æ€
    messages.push({ role: "user", content: userPrompt });

    // ğŸš¨ ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå…ˆå£°æ˜ï¼Œåä½¿ç”¨ã€‚ç¡®ä¿ fullText åœ¨æ•´ä¸ªå‡½æ•°ä¸­éƒ½å·²â€œå­˜åœ¨â€ã€‚
    let fullText = "";
    try {
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ 
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo", 
                messages: messages, 
                temperature: 0.88, // ç¨å¾®æé«˜ä¸€ç‚¹åˆ›é€ åŠ›      
                presence_penalty: 0.6 
            })
        });
        
        // --- 2. æ ¸å¿ƒä¿®å¤ï¼šåªè¯»ä¸€æ¬¡ jsonï¼Œå¹¶ç«‹åˆ»å¤„ç†æ–‡å­— ---
        const resultData = await response.json(); 
        if (!resultData.choices || !resultData.choices[0]) throw new Error("æ¥å£è¿”å›ä¸ºç©º");
        
        fullText = resultData.choices[0].message.content.trim().replace(/['"â€œâ€˜â€â€™]/g, "");

        // --- 3. æ™ºèƒ½æ–­å¥ä¸éšæœºæ¡æ•°æ§åˆ¶ ---
        // --- âœ‚ï¸ æ™ºèƒ½åˆ‡ç‰‡ç®—æ³•ï¼šå†…å®¹å…¨ä¿ç•™ + åŠ¨æ€æ¡æ•° ---
        
        // 1. åŠ¨æ€é˜ˆå€¼ï¼šæ¯ä¸€è½®éšæœºå†³å®šâ€œè¯ç—¨ç¨‹åº¦â€
        // éšæœºä¸€ä¸ª 20 åˆ° 50 ä¹‹é—´çš„æ•°å­—ä½œä¸ºè¿™è½®çš„â€œæ–­å¥é•¿åº¦é˜ˆå€¼â€
        // é˜ˆå€¼å°ï¼ˆæ¯”å¦‚20ï¼‰ï¼Œåˆ‡å‡ºçš„æ°”æ³¡å°±å¤šï¼›é˜ˆå€¼å¤§ï¼ˆæ¯”å¦‚50ï¼‰ï¼Œæ°”æ³¡å°±å°‘ã€‚
        const dynamicThreshold = Math.floor(Math.random() * 31) + 20; 

        let rawSegments = fullText.split(/\n+/).filter(s => s.trim().length > 0);
        let finalSegments = [];

        rawSegments.forEach(seg => {
            // å¦‚æœå•æ®µæ–‡å­—è¶…è¿‡äº†è¿™è½®çš„éšæœºé˜ˆå€¼ï¼Œå°±æŒ‰æ ‡ç‚¹å¼ºè¡Œåˆ‡å¼€
            if (seg.length > dynamicThreshold) {
                let subParts = seg.split(/(?<=[ã€‚ï¼ï¼Ÿ])/g);
                finalSegments.push(...subParts);
            } else {
                finalSegments.push(seg);
            }
        });

        // ğŸš¨ ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šå½»åº•åˆ æ‰ slice(0, bubbleLimit)ï¼
        // ç°åœ¨ finalSegments æœ‰å¤šå°‘æ¡ï¼Œæˆ‘ä»¬å°±å‘å¤šå°‘æ¡ï¼Œä¿è¯å†…å®¹ 100% å®Œæ•´ã€‚
        // å› ä¸º dynamicThreshold æ¯æ¬¡éƒ½åœ¨å˜ï¼Œæ‰€ä»¥å³ä¾¿åŒæ ·é•¿åº¦çš„æ–‡å­—ï¼Œåˆ‡å‡ºæ¥çš„æ°”æ³¡æ•°ä¹Ÿä¸åŒã€‚

        // --- ğŸš€ ç‰©ç†å‘é€å¼•æ“ï¼šç¡®ä¿å†…å®¹æµå‡º ---
        for (let i = 0; i < finalSegments.length; i++) {
            let textPart = finalSegments[i].trim();
            if (!textPart) continue;

            // 1. æ¸²æŸ“æ‰“å­—æœºçŠ¶æ€ (iMessage é£æ ¼)
            const typingId = "typing-" + Date.now();
            renderTypingIndicator(typingId, contact.avatar, container);
            
            // 2. æ¨¡æ‹Ÿæ‰“å­—å»¶è¿Ÿ (æ ¹æ®å­—æ•°åŠ¨æ€è°ƒæ•´é€Ÿåº¦)
            await new Promise(res => setTimeout(res, 500 + textPart.length * 40));
            
            // 3. ç§»é™¤æ‰“å­—æœºçŠ¶æ€
            const typingNode = document.getElementById(typingId);
            if (typingNode) typingNode.remove();

            // 4. å°è£…æ¶ˆæ¯å¯¹è±¡
            const msgObj = { 
                role: "opponent", 
                text: textPart, 
                timestamp: Date.now() 
            };

            // 5. ğŸš¨ ã€æ ¸å¿ƒåŠ¨ä½œã€‘ï¼šå­˜å…¥æ•°æ®åº“ + æ¸²æŸ“æ°”æ³¡
            await saveChatMessage(contact.id, msgObj); // è¿™é‡Œä¼šå­˜å…¥æ¶ˆæ¯
            appendMessageToUI(msgObj, contact); // è¿™é‡Œä¼šè®©æ°”æ³¡åœ¨å±å¹•å†’å‡ºæ¥
            container.scrollTop = container.scrollHeight;

            // 6. ğŸš¨ ã€è®¡æ•°å®¡è®¡ã€‘ï¼šæ¯æˆåŠŸå‘ä¸€ä¸ªæ°”æ³¡ï¼Œè®¡æ•°å™¨è·³ä¸€ä¸‹
            if (window.autoSummaryAuditor) {
                window.autoSummaryAuditor(contact.id);
            }

            // 7. æ°”æ³¡é—´çš„æ€è€ƒåœé¡¿ (å¦‚æœæ˜¯æœ€åä¸€å¥å°±ä¸ç­‰äº†)
            if (i < finalSegments.length - 1) {
                // ä¸‹ä¸€å¥è¶Šé•¿ï¼Œè¿™é‡Œç­‰çš„è¶Šä¹…
                let waitTime = 600 + (finalSegments[i+1].length * 20);
                await new Promise(res => setTimeout(res, Math.min(waitTime, 2500)));
            }
        }

        // åˆ·æ–°å¤–éƒ¨åˆ—è¡¨é¢„è§ˆå›¾
        if (typeof initChatMsgPanel === 'function') initChatMsgPanel();

    } catch (e) {
        console.error("AI Error:", e);
        showToast("é‡å­é“¾è·¯æ³¢åŠ¨: " + e.message);
    } finally {
        window.isAiProcessing = false; // ğŸ”“ å¿…é¡»è§£é”ï¼Œå¦åˆ™ç‚¹ç¬¬äºŒæ¬¡æ²¡ååº”
    }
}
// --- ğŸš¨ è‡ªåŠ¨æ€»ç»“è§¦å‘å®¡è®¡é€»è¾‘ ---
async function autoSummaryAuditor(contactId) {
    // 1. è·å–ç”¨æˆ·è®¾å®šçš„æ€»ç»“è½®æ•° (é»˜è®¤10)
    const targetRounds = parseInt(localStorage.getItem('summary_rounds_' + contactId) || "10");
    
    // 2. æ›´æ–°å½“å‰è®¡æ•°
    let currentCount = parseInt(localStorage.getItem('chat_count_' + contactId) || "0");
    currentCount++; 
    
    console.log(`[è®°å¿†å®¡è®¡] å½“å‰è¿›åº¦: ${currentCount}/${targetRounds}`);

    // 3. åˆ¤æ–­æ˜¯å¦è¾¾åˆ°è®¾å®šçš„è½®æ•°
    if (currentCount >= targetRounds) {
        console.log("ğŸš€ è¾¾åˆ°è®¾å®šé˜ˆå€¼ï¼Œå¯åŠ¨è‡ªåŠ¨æ€»ç»“ç¨‹åº...");
        
        // æ‰§è¡Œæ€»ç»“é€»è¾‘
        await window.executeSummaryProcess(contactId);
        
        // ğŸš¨ æ€»ç»“å®Œåï¼Œè®¡æ•°å™¨å½’é›¶
        localStorage.setItem('chat_count_' + contactId, "0");
    } else {
        // è¿˜æ²¡åˆ°è½®æ•°ï¼Œä¿å­˜å½“å‰è®¡æ•°
        localStorage.setItem('chat_count_' + contactId, currentCount.toString());
    }
}

// ğŸš¨ è¯·ç¡®ä¿åœ¨ triggerAiGenerate çš„æˆåŠŸå›è°ƒé‡Œè°ƒç”¨å®ƒï¼š
// ç¤ºä¾‹ï¼š
// .then(res => {
//    ...æ˜¾ç¤ºAIæ–‡å­—...
//    autoSummaryAuditor(contact.id); // åŠ ä¸Šè¿™ä¸€è¡Œï¼
// })

// è¾…åŠ©ï¼šæ¸²æŸ“ä¸‰ç‚¹æ€è€ƒåŠ¨ç”»
function renderTypingIndicator(id, avatar, container) {
    const typingDiv = document.createElement('div');
    typingDiv.className = "msg-row opponent";
    typingDiv.id = id;
    typingDiv.innerHTML = `
        <img src="${avatar}" class="chat-avatar-img">
        <div class="bubble" style="padding: 12px 20px;">
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
    `;
    container.appendChild(typingDiv);
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
}
// è¾…åŠ©ï¼šæ¸²æŸ“æ¶ˆæ¯æ°”æ³¡ (å«å¼•ç”¨ã€ç‚¹å‡»èœå•ã€æ˜Ÿæ˜Ÿ)
function appendMessageToUI(msg, contact) {
    const container = document.getElementById('chat-messages-container');
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg-row ${msg.role === 'user' ? 'user' : 'opponent'}`;
    
    let quoteHtml = "";
    if (msg.quote) {
        quoteHtml = `
            <div class="bubble-quote-box">
                <div style="font-weight:700; font-size:10px; margin-bottom:2px;">Reply to ${msg.quote.user}</div>
                <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${msg.quote.text}</div>
            </div>
        `;
    }

    let inner = msg.role === 'opponent' ? `<img src="${contact.avatar}" class="chat-avatar-img">` : "";
    inner += `<div class="bubble" onclick="showBubbleMenu(this, event)">
                ${quoteHtml}
                <div class="msg-text-main">${msg.text}</div>
                <div class="star-decor-css"></div>
              </div>`;
    msgDiv.innerHTML = inner;
    container.appendChild(msgDiv);
}

// --- ğŸš‘ æ»‘åŠ¨ç³»ç»Ÿå…¨å±€å˜é‡ ---
let touchStartX = 0;
let currentSwipeEl = null;

// 1. åˆå§‹åŒ–æ»‘åŠ¨ç›‘å¬
function initSwipeEvents(el) {
    el.addEventListener('touchstart', function(e) {
        // å…³é—­ä¹‹å‰æ‰“å¼€çš„æ»‘å—
        if (window.currentSwipeEl && window.currentSwipeEl !== el) {
            window.currentSwipeEl.style.transform = "translateX(0)";
        }
        window.touchStartX = e.touches[0].clientX;
    }, {passive: true});

    el.addEventListener('touchmove', function(e) {
        var moveX = e.touches[0].clientX - window.touchStartX;
        if (moveX < -10) { 
            var offset = Math.max(moveX, -150);
            el.style.transform = "translateX(" + offset + "px)";
            el.style.transition = "none";
        }
    }, {passive: true});

    el.addEventListener('touchend', function(e) {
        var moveX = e.changedTouches[0].clientX - window.touchStartX;
        el.style.transition = "transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)";
        
        if (moveX < -70) { 
            el.style.transform = "translateX(-150px)";
            window.currentSwipeEl = el;
        } else { 
            el.style.transform = "translateX(0)";
            window.currentSwipeEl = null;
        }
    });
}

// 3. åŠŸèƒ½ï¼šåˆ é™¤å¯¹è¯ (æ¸…é™¤å†å²è®°å½•)
async function deleteConversation(contactId) {
    // æš‚å­˜åˆ é™¤åŠ¨ä½œ
    window.pendingAction = async function() {
        const db = await openDB();
        const tx = db.transaction("chat_history", "readwrite");
        const store = tx.objectStore("chat_history");
        
        // 1. å½»åº•åˆ é™¤è¯¥è”ç³»äººçš„æ‰€æœ‰å†å²è®°å½•
        await store.delete(contactId); 
        
        // 2. å¦‚æœä½ åœ¨åˆ«å¤„å­˜äº†â€œæœ€åä¸€æ¡æ¶ˆæ¯â€ç¼“å­˜ï¼Œä¹Ÿåœ¨è¿™é‡Œæ¸…é™¤
        
        showToast("å¯¹è¯å·²æ°¸ä¹…ç§»é™¤");
        
        // 3. ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        if (typeof initChatMsgPanel === 'function') {
            initChatMsgPanel();
        }
    };

    // å”¤èµ·å±…ä¸­å¼¹çª—
    document.getElementById('confirm-modal-title').textContent = "åˆ é™¤å¯¹è¯ï¼Ÿ";
    document.getElementById('confirm-modal-msg').textContent = "æ­¤æ“ä½œå°†æŠ¹é™¤æ‰€æœ‰èŠå¤©è®°å½•ï¼Œè¯¥è”ç³»äººå°†ä»æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤ã€‚";
    document.getElementById('confirm-modal-btn').textContent = "åˆ é™¤";
    document.getElementById('iosConfirmModal').style.display = 'flex';
}
// --- ğŸš‘ æ ¸å¿ƒåŠŸèƒ½ï¼šç½®é¡¶ä¸åˆ é™¤é€»è¾‘è¡¥ä¸ ---

// 1. ç½®é¡¶/å–æ¶ˆç½®é¡¶åŠŸèƒ½
async function togglePin(contactId) {
    // ä»æœ¬åœ°å­˜å‚¨è¯»å–å·²ç½®é¡¶çš„ ID åˆ—è¡¨
    var pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
    var index = pinnedIds.indexOf(contactId);

    if (index === -1) {
        pinnedIds.push(contactId);
        showToast("å·²ç½®é¡¶");
    } else {
        pinnedIds.splice(index, 1);
        showToast("å·²å–æ¶ˆç½®é¡¶");
    }

    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
    localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));
    
    // æ ¸å¿ƒï¼šé‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆä¼šè‡ªåŠ¨æŒ‰ç½®é¡¶æ’åºï¼‰
    if (typeof initChatMsgPanel === 'function') {
        initChatMsgPanel();
    }
}

// 2. åˆ é™¤å¯¹è¯åŠŸèƒ½
async function deleteConversation(contactId) {
    // 1. ç»Ÿä¸€åŠ¨ä½œæš‚å­˜
    window.pendingAction = async function() {
        try {
            const db = await openDB();
            const tx = db.transaction("chat_history", "readwrite");
            const store = tx.objectStore("chat_history");
            
            // æ‰§è¡Œç‰©ç†åˆ é™¤
            await store.delete(contactId); 
            
            // 2. é¢å¤–ä¿é™©ï¼šæ¸…ç©ºè¯¥è”ç³»äººçš„ç½®é¡¶çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
            let pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
            pinnedIds = pinnedIds.filter(id => id !== contactId);
            localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));

            showToast("è®°å½•å·²å½»åº•æ¸…ç©º");
            
            // 3. å¿…é¡»åœ¨åˆ é™¤å®Œæˆåå†æ¸²æŸ“
            await initChatMsgPanel(); 
        } catch (e) {
            console.error("åˆ é™¤å¤±è´¥:", e);
            showToast("åˆ é™¤æ“ä½œå¼‚å¸¸");
        }
    };

    // å”¤èµ·å±…ä¸­å¼¹çª— (ç¡®ä¿ ID å­˜åœ¨)
    const modal = document.getElementById('iosConfirmModal');
    if (modal) {
        document.getElementById('confirm-modal-title').textContent = "åˆ é™¤å¯¹è¯ï¼Ÿ";
        document.getElementById('confirm-modal-msg').textContent = "è¯¥æ“ä½œå°†ç‰©ç†æŠ¹é™¤æ‰€æœ‰èŠå¤©æ•°æ®ï¼Œåˆ·æ–°åä¹Ÿä¸ä¼šæ¢å¤ã€‚";
        document.getElementById('confirm-modal-btn').textContent = "åˆ é™¤";
        modal.style.display = 'flex';
    }
}
// --- ğŸ® Vibe Grid è§’è‰²é€‰æ‹©åŠŸèƒ½è¡¥å…¨ ---

// 1. æ‰“å¼€é€‰æ‹©å™¨å¹¶è§¦å‘æ¸²æŸ“
function openVibeCharPicker() {
    const modal = document.getElementById('modal-vibe-picker');
    if (modal) {
        modal.style.display = 'flex';
        renderVibeCharPicker(); // æ‰“å¼€æ—¶ç«‹å³åˆ·æ–°åˆ—è¡¨
    } else {
        console.error("æ‰¾ä¸åˆ° ID ä¸º modal-vibe-picker çš„å¼¹çª—");
    }
}

// 2. ä» IndexedDB æå–è§’è‰²å¹¶æ¸²æŸ“åˆ°æ¸¸æˆé€‰äººåˆ—è¡¨
async function renderVibeCharPicker() {
    const listContainer = document.getElementById('vibe-char-scroll-list');
    if (!listContainer) return;

    // ä»æ•°æ®åº“è¯»å–ä½ è§’è‰²ä¹¦é‡Œçš„æ‰€æœ‰äºº
    const charList = await loadFromDB('char_list') || [];
    listContainer.innerHTML = "";

    if (charList.length === 0) {
        listContainer.innerHTML = `
            <div style="grid-column: span 2; text-align:center; padding:40px; color:#999;">
                <p style="font-size:14px;">è§’è‰²ä¹¦ç©ºç©ºå¦‚ä¹Ÿ</p>
                <p style="font-size:12px; margin-top:5px;">è¯·å…ˆå»â€œè§’è‰²ä¹¦â€Appåˆ›å»ºè§’è‰²</p>
            </div>`;
        return;
    }

    charList.forEach(char => {
        const item = document.createElement('div');
        item.className = 'char-card'; // å¤ç”¨ä½ ä¹‹å‰çš„å¡ç‰‡æ ·å¼
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <img class="char-card-img" src="${char.avatar}" style="height:120px;">
            <div class="char-card-info">
                <div class="char-card-name" style="font-size:14px;">${char.name}</div>
            </div>
        `;
        // ç‚¹å‡»è§’è‰²åï¼Œç¡®è®¤é€‰æ‹©å¹¶å¼€å§‹æ¸¸æˆ
        item.onclick = () => {
            confirmVibeOpponent(char);
        };
        listContainer.appendChild(item);
    });
}

// 3. ç¡®è®¤é€‰æ‹©å¯¹æ‰‹ï¼Œè¿›å…¥æ¸¸æˆç•Œé¢
function confirmVibeOpponent(char) {
    // è®¾ç½®å…¨å±€å¯¹æ‰‹å˜é‡
    window.vibeOpponent = char;
    
    // éšè—é€‰æ‹©å™¨å’Œå¯åŠ¨é¡µ
    document.getElementById('modal-vibe-picker').style.display = 'none';
    document.getElementById('vibe-start-screen').style.display = 'none';
    
    // æ˜¾ç¤ºæ¸¸æˆä¸»ä½“
    const gameMain = document.getElementById('vibe-game-main');
    gameMain.style.display = 'flex';
    setTimeout(() => { gameMain.style.opacity = '1'; }, 50);
    
    // å¡«å……å¯¹æ‰‹ UI
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    document.getElementById('opp-last-word').style.opacity = "0";
    
    // æ ¸å¿ƒï¼šåˆå§‹åŒ–æ£‹ç›˜
    if (typeof initVibeGrid === 'function') {
        initVibeGrid();
        showToast(`å·²è¿æ¥åˆ° ${char.name} çš„æ„è¯†æµ`);
    }
}

// 1. ä¿®æ”¹ renderMessages å’Œ handleSendMessage é€»è¾‘
// åœ¨ç”Ÿæˆ bubble çš„ HTML æ—¶ï¼Œç»Ÿä¸€åŠ ä¸Š onclick="showBubbleMenu(this, event)"
// æ¯”å¦‚ï¼šinner += `<div class="bubble" onclick="showBubbleMenu(this, event)">...</div>`;

function showBubbleMenu(el, e) {
    if (e) e.stopPropagation();

    // --- ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ­£åœ¨å¤šé€‰ï¼Œä¸å‡†å¼¹å‡ºèœå•ï¼Œæ”¹ä¸ºé€‰æ‹©é€»è¾‘ ---
    const row = el.closest('.msg-row');
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected'); // ç›´æ¥åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        return; // ç«‹å³è¿”å›ï¼Œä¸æ‰§è¡Œä¸‹é¢çš„å¼¹å‡ºèœå•é€»è¾‘
    }
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected');
        refreshMultiSelectCount(); // ğŸ‘ˆ åˆ«å¿˜äº†è¿™é‡Œä¹Ÿè¦åŠ 
        return;
    }
    
    

    window.currentActiveBubble = el; 
    
    const menu = document.getElementById('bubble-menu');
    const overlay = document.getElementById('menu-overlay');
    if (!menu || !overlay) return;

    const isUser = el.closest('.msg-row').classList.contains('user');
    const recallBtn = document.getElementById('menu-recall');
    if (recallBtn) recallBtn.style.display = isUser ? 'flex' : 'none';

    const rect = el.getBoundingClientRect();
    menu.style.display = 'flex';
    overlay.style.display = 'block';
    
    let left = rect.left + (rect.width / 2) - 130;
    let top = rect.top - 140;

    if (left < 10) left = 10;
    if (left + 260 > window.innerWidth) left = window.innerWidth - 270;
    if (top < 80) top = rect.bottom + 15;

    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
}

function hideBubbleMenu() {
    const menu = document.getElementById('bubble-menu');
    const overlay = document.getElementById('menu-overlay');
    
    if (menu) menu.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    
    // æ¸…é™¤å…¨å±€å¼•ç”¨çš„å˜é‡
    window.currentActiveBubble = null;
    
    console.log("System: Context menu closed.");
}

// 2. åŠŸèƒ½æ‰§è¡Œä¸­å¿ƒ
function doAction(type) {
    var el = window.currentActiveBubble; 
    if (!el) return;
    
    // è·å–çº¯å‡€æ–‡å­—
    const textNode = el.querySelector('.msg-text-main') || el.querySelector('.msg-text-content') || el;
    const textToCopy = textNode.innerText;
    
    const isUser = el.closest('.msg-row').classList.contains('user');
    const senderName = isUser ? "You" : (window.currentChattingWith ? window.currentChattingWith.name : "Opponent");

    switch(type) {
        case 'copy':
            copyToClipboard(textToCopy);
            break;

        case 'quote':
            document.getElementById('quote-preview-user').textContent = senderName;
            document.getElementById('quote-preview-text').textContent = textToCopy;
            document.getElementById('quote-preview').style.display = 'flex';
            window.currentQuoteData = { user: senderName, text: textToCopy };
            document.getElementById('chat-input-main').focus();
            break;

        case 'multi':
            // ğŸš¨ æ ¸å¿ƒï¼šç‚¹å‡»èœå•ä¸­çš„â€œå¤šé€‰â€ä¼šè§¦å‘è¿™é‡Œ
            enterMultiSelect(); 
            break;

        case 'delete':
            el.closest('.msg-row').remove();
            showToast("å·²åˆ é™¤");
            break;
        
        case 'forward': 
            const text = el.querySelector('.msg-text-main, .msg-text-content, .bubble').innerText;
            openForwardPicker([{ text: text }]); 
            break;
        
        case 'recall':
            // 1. è·å–å½“å‰æ°”æ³¡çš„æ—¶é—´æˆ³
            const ts = el.getAttribute('data-ts'); 
            const contactId = window.currentChattingWith.id;

            if(!ts) { showToast("å®šä½å¤±è´¥"); return; }

            // 2. è°ƒç”¨ iOS ç¡®è®¤å¼¹çª—
            showIOSConfirm("æ’¤å›æ¶ˆæ¯", "ç¡®å®šè¦æ’¤å›å—ï¼Ÿ", "æ’¤å›", async () => {
                // 3. æ›´æ–°æ•°æ®åº“ä¸­çš„çŠ¶æ€
                await updateMessageRecallStatus(contactId, ts, true);
                
                // 4. ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šç«‹åˆ»é‡æ–°é©±åŠ¨æ¸²æŸ“å™¨ï¼Œåˆ·æ–°èŠå¤©ç•Œé¢
                await renderMessages(); 
                
                showToast("å·²æ’¤å›ä¸€æ¡æ¶ˆæ¯");
                
                // 5. åŒæ­¥æ›´æ–°æ¶ˆæ¯åˆ—è¡¨çš„é¢„è§ˆï¼ˆå¯é€‰ï¼‰
                if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
            });
            break;
    }
    hideBubbleMenu(); // æ‰§è¡Œå®Œä»»ä½•åŠ¨ä½œéƒ½è¦å…³æ‰èœå•
}

// --- 1. è¿›å…¥å¤šé€‰æ¨¡å¼ ---
function enterMultiSelect() {
    console.log("System: Entering Multi-select mode...");
    const rows = document.querySelectorAll('.msg-row');
    const footer = document.querySelector('.chat-room-footer');
    const multiBar = document.getElementById('multi-select-bar');

    if (!multiBar) return;

    rows.forEach(row => {
        row.classList.add('multi-selecting');
        
        // åŠ¨æ€æ’å…¥å‹¾é€‰æ¡†
        if (!row.querySelector('.msg-check-box')) {
            const check = document.createElement('div');
            check.className = 'msg-check-box';
            // ç‚¹å‡»åœ†åœˆç›´æ¥é€‰æ‹©
            check.onclick = (e) => {
                e.stopPropagation();
                row.classList.toggle('selected');
            };
            row.appendChild(check);
        }
        
        // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦å†ç»™ row ç»‘å®š onclick äº†
        // å› ä¸ºæ°”æ³¡è‡ªå¸¦çš„ showBubbleMenu å·²ç»è¢«æˆ‘ä»¬æ”¹æˆäº†â€œè½¬å‘å™¨â€
    });

    if (footer) footer.style.display = 'none'; 
    multiBar.style.display = 'flex'; 
}

// ä¿®æ”¹ä½ çš„ doAction å‡½æ•°
// åœ¨ doAction çš„ switch(type) é‡Œæ‰¾åˆ° 'multi':
// case 'multi': enterMultiSelect(); break;

// --- 2. é€€å‡ºå¤šé€‰æ¨¡å¼ ---
function exitMultiSelect() {
    console.log("System: Exiting Multi-select mode...");
    const rows = document.querySelectorAll('.msg-row');
    const footer = document.querySelector('.chat-room-footer');
    const multiBar = document.getElementById('multi-select-bar');

    rows.forEach(row => {
        // ğŸš¨ æ ¸å¿ƒï¼šç§»é™¤æ‰€æœ‰ç›¸å…³çš„ç±»å
        row.classList.remove('multi-selecting', 'selected');
        
        // å½»åº•æ¸…ç©ºå¤šé€‰æ¨¡å¼ä¸‹çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ¢å¤æ°”æ³¡åŸæœ¬çš„èœå•åŠŸèƒ½
        row.onclick = null; 
    });

    // æ¢å¤åº•æ çŠ¶æ€
    if (footer) footer.style.display = 'flex';
    if (multiBar) {
        multiBar.style.display = 'none';
        // é¡ºä¾¿é‡ç½®è®¡æ•°æ–‡å­—
        const countEl = document.getElementById('multi-select-count');
        if (countEl) countEl.textContent = "å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯";
    }
    
    showToast("å·²é€€å‡ºç¼–è¾‘");
}

// --- 3. æ‰¹é‡åŠŸèƒ½å®ç° ---

// --- A. æ‰¹é‡åˆ é™¤ (ä¸å†ä½¿ç”¨åŸç”Ÿ confirm) ---
async function batchDelete() {
    const selectedRows = document.querySelectorAll('.msg-row.selected');
    if (selectedRows.length === 0) return showToast("è¯·å…ˆå‹¾é€‰éœ€è¦åˆ é™¤çš„æ¶ˆæ¯");

    // è°ƒç”¨å’±ä»¬åˆšå†™çš„ç³»ç»Ÿçº§å¼¹çª—
    showIOSConfirm(
        "æ‰¹é‡åˆ é™¤", 
        `ç¡®å®šè¦ä»è®°å½•ä¸­æ°¸ä¹…ç§»é™¤è¿™ ${selectedRows.length} æ¡æ¶ˆæ¯å—ï¼Ÿ`, 
        "åˆ é™¤", 
        async function() {
            // è¿™é‡Œæ˜¯ç¡®è®¤åçš„æ‰§è¡Œä»£ç 
            selectedRows.forEach(row => row.remove());
            // ğŸ’¡ å¯ä»¥åœ¨è¿™é‡ŒåŠ å…¥åˆ é™¤ IndexedDB æ•°æ®çš„é€»è¾‘
            showToast("å·²æˆåŠŸåˆ é™¤é€‰å®šå†…å®¹");
            exitMultiSelect();
        }
    );
}

// --- B. æ‰¹é‡æˆªå›¾ (ä¸å†ä½¿ç”¨åŸç”Ÿ alert) ---
function batchScreenshot() {
    const selectedCount = document.querySelectorAll('.msg-row.selected').length;
    if (selectedCount === 0) return showToast("è¯·é€‰æ‹©éœ€è¦æˆªå›¾çš„æ¶ˆæ¯");

    showToast("æ­£åœ¨é€šè¿‡è”è§‰åè®®åˆæˆå›¾åƒ...");
    
    // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
    setTimeout(() => {
        showIOSAlert("æˆªå›¾æˆåŠŸ", `å·²æˆåŠŸå°† ${selectedCount} æ¡æ¶ˆæ¯åˆæˆé•¿å›¾å¹¶ä¿å­˜è‡³æ¨¡æ‹Ÿç›¸å†Œã€‚`);
        exitMultiSelect();
    }, 1200);
}

// --- C. æ‰¹é‡è½¬å‘ (é€»è¾‘ä¼˜åŒ–) ---
function batchForward() {
    const selectedRows = document.querySelectorAll('.msg-row.selected');
    if (selectedRows.length === 0) return showToast("è¯·é€‰æ‹©æ¶ˆæ¯");

    const messages = Array.from(selectedRows).map(row => {
        const textNode = row.querySelector('.msg-text-main') || row.querySelector('.msg-text-content') || row.querySelector('.bubble');
        return { text: textNode.innerText.trim() };
    });

    exitMultiSelect(); // å…ˆé€€å‡ºå¤šé€‰æ¨¡å¼
    openForwardPicker(messages); // å¼¹å‡ºè½¬å‘é¡µé¢
}
// å®æ—¶æ›´æ–°é€‰ä¸­æ•°é‡çš„æ˜¾ç¤º
function refreshMultiSelectCount() {
    const count = document.querySelectorAll('.msg-row.selected').length;
    const countEl = document.getElementById('multi-select-count');
    if (countEl) {
        countEl.textContent = count > 0 ? `å·²é€‰æ‹© ${count} æ¡æ¶ˆæ¯` : "é€‰æ‹©æ¶ˆæ¯";
    }
}

// ä¿®æ”¹è¿›å…¥å‡½æ•°ï¼Œç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
function enterMultiSelect() {
    const rows = document.querySelectorAll('.msg-row');
    const footer = document.querySelector('.chat-room-footer');
    const multiBar = document.getElementById('multi-select-bar');

    rows.forEach(row => {
        row.classList.add('multi-selecting');
        if (!row.querySelector('.msg-check-box')) {
            const check = document.createElement('div');
            check.className = 'msg-check-box';
            check.onclick = (e) => {
                e.stopPropagation();
                row.classList.toggle('selected');
                refreshMultiSelectCount(); // ğŸ‘ˆ æ¯æ¬¡ç‚¹å‡»æ›´æ–°è®¡æ•°
            };
            row.appendChild(check);
        }
    });

    if (footer) footer.style.display = 'none';
    if (multiBar) {
        multiBar.style.display = 'flex';
        refreshMultiSelectCount(); // ğŸ‘ˆ åˆå§‹åŒ–è®¡æ•°
    }
}
// ==========================================
// ğŸ“± iOS å…¨å±€é¡µé¢å¼¹çª—è°ƒåº¦ä¸­å¿ƒ (æ ¸å¿ƒå·¥å…·ç®±)
// ==========================================

/**
 * æ›¿ä»£ confirm() çš„ iOS é£æ ¼ç¡®è®¤æ¡†
 * @param {string} title æ ‡é¢˜
 * @param {string} msg æè¿°æ–‡å­—
 * @param {string} btnText ç¡®è®¤æŒ‰é’®çš„æ–‡å­—
 * @param {function} action ç‚¹å‡»ç¡®è®¤åè¦æ‰§è¡Œçš„å‡½æ•°
 */
function showIOSConfirm(title, msg, btnText, action) {
    console.log("System: Triggering IOS Confirm Modal...");
    
    const titleEl = document.getElementById('confirm-modal-title');
    const msgEl = document.getElementById('confirm-modal-msg');
    const btnEl = document.getElementById('confirm-modal-btn');
    const modal = document.getElementById('iosConfirmModal');

    if (!titleEl || !msgEl || !btnEl || !modal) {
        console.error("System Error: æ‰¾ä¸åˆ° iosConfirmModal ç›¸å…³çš„ HTML å…ƒç´ ï¼");
        return;
    }

    // 1. å¡«å……æ–‡å­—å†…å®¹
    titleEl.textContent = title;
    msgEl.textContent = msg;
    btnEl.textContent = btnText;

    // 2. å±é™©æ“ä½œï¼ˆå¦‚åˆ é™¤ï¼‰æŒ‰é’®å˜çº¢ï¼Œæ™®é€šæ“ä½œå˜è“
    btnEl.style.color = (btnText === "åˆ é™¤" || btnText === "æ’¤å›" || btnText === "æŠ¹é™¤") ? "#FF3B30" : "#007AFF";

    // 3. å°†ä»»åŠ¡å­˜å…¥å…¨å±€å¾…å¤„ç†åŠ¨ä½œä¸­
    window.pendingAction = action;

    // 4. æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
}

/**
 * æ›¿ä»£ alert() çš„ iOS é£æ ¼æˆåŠŸæç¤ºæ¡†
 * @param {string} title æ ‡é¢˜
 * @param {string} msg æè¿°æ–‡å­—
 */
function showIOSAlert(title, msg) {
    const titleEl = document.getElementById('alert-title');
    const msgEl = document.getElementById('alert-msg');
    const modal = document.getElementById('successAlert');

    if (titleEl && msgEl && modal) {
        titleEl.textContent = title;
        msgEl.textContent = msg;
        modal.style.display = 'flex';
    }
}
// --- 2. è§¦å‘è½¬å‘å…¥å£ (å•æ¡å’Œå¤šæ¡å…±ç”¨) ---
function openForwardPicker(messages) {
    // messages æ ¼å¼: [{ text: "å†…å®¹" }, ...]
    window.pendingForwardData = messages;
    
    const page = document.getElementById('page-forward-picker');
    page.style.transform = 'translateY(0)';
    
    switchForwardTab('friends'); // é»˜è®¤æ˜¾ç¤ºå¥½å‹
}

function closeForwardPicker() {
    document.getElementById('page-forward-picker').style.transform = 'translateY(100%)';
    window.pendingForwardData = [];
}

// --- 3. æ¸²æŸ“è½¬å‘åˆ—è¡¨ (å¤ç”¨åˆ—è¡¨é€»è¾‘) ---
async function switchForwardTab(mode) {
    window.forwardTabMode = mode;
    document.getElementById('fwd-tab-friends').classList.toggle('active', mode === 'friends');
    document.getElementById('fwd-tab-groups').classList.toggle('active', mode === 'groups');
    
    const container = document.getElementById('forward-list-content');
    const dbKey = (mode === 'friends') ? 'chat_friends' : 'chat_groups';
    const list = await loadFromDB(dbKey) || [];
    
    container.innerHTML = "";
    const groupWrapper = document.createElement('div');
    groupWrapper.className = 'chat-contact-group';
    groupWrapper.style.marginTop = "15px";

    list.forEach(target => {
        const row = document.createElement('div');
        row.className = 'contact-row';
        row.innerHTML = `
            <img class="contact-avatar" src="${target.avatar}" style="width:40px; height:40px; border-radius:${mode==='friends'?'50%':'8px'}">
            <div class="contact-info"><span class="contact-name" style="font-size:15px;">${target.name}</span></div>
            <div style="color:#007AFF; font-size:13px; font-weight:600;">å‘é€</div>
        `;
        row.onclick = () => confirmForwardTo(target);
        groupWrapper.appendChild(row);
    });
    container.appendChild(groupWrapper);
}

// --- 4. ç¡®è®¤è½¬å‘é€»è¾‘ (è°ƒç”¨ iOS å¼¹çª—) ---
function confirmForwardTo(target) {
    const count = window.pendingForwardData.length;
    showIOSConfirm(
        "ç¡®è®¤è½¬å‘", 
        `å°† ${count} æ¡æ¶ˆæ¯è½¬å‘ç»™ ${target.name}ï¼Ÿ`, 
        "å‘é€", 
        async function() {
            // æ‰§è¡ŒçœŸæ­£çš„è½¬å‘åŠ¨ä½œ
            for(let item of window.pendingForwardData) {
                const msgObj = {
                    role: "user", // è½¬å‘è¿‡å»çš„æ¶ˆæ¯é»˜è®¤ä½œä¸ºâ€œä½ â€å‘é€çš„
                    text: item.text,
                    timestamp: Date.now(),
                    isForwarded: true // ğŸš¨ æ ‡è®°ä¸ºè½¬å‘
                };
                await saveChatMessage(target.id, msgObj);
            }
            
            showToast("å·²æˆåŠŸåˆ†å‘çµé­‚ç¢ç‰‡");
            closeForwardPicker();
            
            // è‡ªåŠ¨è·³è½¬åˆ°è¯¥èŠå¤©å®¤ï¼ˆå¯é€‰ï¼‰
            setTimeout(() => openChatRoom(target), 500);
        }
    );
}
async function updateMessageRecallStatus(contactId, timestamp, isRecalled) {
    const db = await openDB();
    const tx = db.transaction("chat_history", "readwrite");
    const store = tx.objectStore("chat_history");
    const req = store.get(contactId);
    
    return new Promise((resolve) => {
        req.onsuccess = () => {
            if (!req.result) return resolve();
            let data = req.result.messages;
            // æ‰¾åˆ°å¯¹åº”æ—¶é—´æˆ³çš„æ¶ˆæ¯
            const idx = data.findIndex(m => m.timestamp == timestamp);
            if (idx !== -1) {
                data[idx].recalled = isRecalled;
                store.put({ contactId: contactId, messages: data });
            }
            resolve();
        };
    });
}
// ==========================================
// ğŸ‘ï¸ æ’¤å›å†…å®¹æŸ¥é˜…å¼•æ“ - æ”¾åœ¨æœ«å°¾ä¸“ç”¨ç‰ˆ
// ==========================================
function viewRecalledTrace(content) {
    console.log("System: Accessing recalled trace...");
    
    // 1. å°è¯•ä»å„ç§å¯èƒ½çš„ ID è·å–å¼¹çª—å…ƒç´ 
    const viewer = document.getElementById('modal-recalled-viewer');
    const textZone = document.getElementById('recalled-v-text');

    if (viewer && textZone) {
        // 2. å¡«å……å†…å®¹
        textZone.textContent = content;
        // 3. ç‰©ç†å¼ºåˆ¶æ˜¾ç¤º
        viewer.style.setProperty('display', 'flex', 'important');
        viewer.style.zIndex = "30000"; // ç¡®ä¿ç›–è¿‡æ‰€æœ‰é¡µé¢
    } else {
        // å…œåº•æ–¹æ¡ˆï¼šå¦‚æœæ‰¾ä¸åˆ°ä½ å†™çš„ HTML å¼¹çª—ï¼Œå°±ç”¨è¿™ä¸ªä¸´æ—¶å¼¹çª—ï¼Œé˜²æ­¢æ²¡ååº”
        alert("æŸ¥é˜…æ’¤å›å†…å®¹ï¼š\n\n" + content);
    }
}

// å¼ºåˆ¶å°†å…¶å…³è”åˆ° windowï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.viewRecalledTrace = viewRecalledTrace;
// ==========================================
// âš™ï¸ èŠå¤©è®¾ç½®é¡µé¢æ§åˆ¶å™¨
// ==========================================

// 1. æ‰“å¼€è®¾ç½®é¡µ
function openChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
    }
}

// 2. å…³é—­è®¾ç½®é¡µ
function closeChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(100%)';
    }
}

// 3. ä»è®¾ç½®é¡µè·³è½¬åˆ°â€œTaçš„èµ„æ–™â€
async function openChatProfileFromSettings() {
    console.log("System: å°è¯•ä»è®¾ç½®é¡µå¼€å¯é¢„è§ˆåç‰‡...");
    
    let contact = window.currentChattingWith;

    // ğŸ›¡ï¸ å®‰å…¨é”ï¼šå¦‚æœå˜é‡ä¸¢å¤±ï¼Œå°è¯•ä» URL æˆ–ä¸Šä¸‹æ–‡æ¢å¤
    if (!contact) {
        showToast("âš ï¸ æœªèƒ½è·å–è§’è‰²ä¸Šä¸‹æ–‡");
        return;
    }

    // æ ¸å¿ƒï¼šåœ¨å±•ç¤ºåç‰‡å‰ï¼Œå…ˆå»æ•°æ®åº“æä¸€ä¸‹æœ€æ–°çš„èµ„æ–™
    // é˜²æ­¢ä½ åœ¨èµ„æ–™é¡µæ”¹äº†åå­—ï¼Œåç‰‡ä¸Šè¿˜æ˜¯æ—§çš„
    const charList = await loadFromDB('char_list') || [];
    const latestInfo = charList.find(c => c.id === contact.id) || contact;

    console.log("System: è½½å…¥æœ€æ–°èµ„æ–™è¿›è¡Œé¢„è§ˆ:", latestInfo.name);
    
    // è°ƒç”¨ä¹‹å‰çš„é«˜çº§åç‰‡æ˜¾ç¤ºå‡½æ•°
    openChatProfile(latestInfo);
}

// 4. è§¦å‘â€œæ¸…ç©ºèŠå¤©è®°å½•â€ (å¸¦ç¡®è®¤)
function triggerClearHistory() {
    if(!window.currentChattingWith) return;
    
    // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„é€šç”¨ iOS ç¡®è®¤æ¡†
    showIOSConfirm(
        "æ¸…ç©ºè®°å½•",
        "ç¡®å®šè¦æ¸…ç©ºä¸è¯¥å¥½å‹çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
        "æ¸…ç©º",
        async function() {
            // å¤ç”¨ä¹‹å‰çš„åˆ é™¤é€»è¾‘ï¼Œä½†åªæ¸…ç©ºæ¶ˆæ¯ï¼Œä¸åˆ äºº
            const db = await openDB();
            const tx = db.transaction("chat_history", "readwrite");
            const store = tx.objectStore("chat_history");
            
            // å°†è¯¥è”ç³»äººçš„æ¶ˆæ¯é‡ç½®ä¸ºç©ºæ•°ç»„ï¼Œä¿ç•™è”ç³»äººå…³ç³»
            await store.put({ contactId: window.currentChattingWith.id, messages: [] });
            
            showToast("è®°å½•å·²æ¸…ç©º");
            // åˆ·æ–°èŠå¤©ç•Œé¢
            if(typeof renderMessages === 'function') renderMessages();
            // å…³é—­è®¾ç½®é¡µ
            closeChatSettings();
        }
    );
}

// 5. è§¦å‘â€œåˆ é™¤å¥½å‹â€ (å¸¦ç¡®è®¤)
function triggerDeleteFriend() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    // ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ iOS é£æ ¼ç¡®è®¤æ¡†
    showIOSConfirm(
        "åˆ‡æ–­ç¤¾äº¤çº½å¸¦ï¼Ÿ", 
        `è¿™å°†åˆ é™¤ä¸ ${contact.name} çš„æ‰€æœ‰èŠå¤©è®°å½•å’Œä¸ªæ€§åŒ–è®¾ç½®ï¼Œä½†ä¼šä¿ç•™å…¶åœ¨â€œè§’è‰²ä¹¦â€ä¸­çš„åŸå§‹æ¡£æ¡ˆã€‚`, 
        "å½»åº•åˆ é™¤", 
        () => {
            executeMasterSocialDelete(contact.id);
        }
    );
}
// --- âš™ï¸ èŠå¤©è®¾ç½®é¡µï¼šæŠ˜å é€»è¾‘ ---
function toggleSettingItem(headerEl) {
    // 1. æ‰¾åˆ°å¯¹åº”çš„çˆ¶å®¹å™¨
    const item = headerEl.parentElement;
    
    // 2. æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ‰“å¼€
    const isActive = item.classList.contains('active');
    
    // 3. (å¯é€‰) å¦‚æœä½ æƒ³å®ç°â€œæ‰‹é£ç´â€æ•ˆæœï¼ˆæ‰“å¼€ä¸€ä¸ªè‡ªåŠ¨å…³é—­å…¶ä»–çš„ï¼‰ï¼Œå°±æŠŠè¿™æ®µåŠ ä¸Šï¼š
    document.querySelectorAll('.ios-accordion-item').forEach(el => {
        el.classList.remove('active');
    });

    // 4. åˆ‡æ¢å½“å‰çŠ¶æ€
    if(isActive) {
        item.classList.remove('active');
    } else {
        item.classList.add('active');
    }
}

// ç¨å¾®ä¿®æ”¹æ‰“å¼€è®¾ç½®é¡µçš„é€»è¾‘ï¼Œé¡ºä¾¿å¡«ä¸€ä¸‹åº•éƒ¨çš„ ID
var originalOpenChatSettings = openChatSettings;
openChatSettings = function() {
    originalOpenChatSettings(); // è°ƒç”¨ä¹‹å‰çš„æ‰“å¼€åŠ¨ç”»
    // å¡«å……åº•éƒ¨çš„ ID
    if(window.currentChattingWith) {
        const uid = document.getElementById('setting-uid-display');
        if(uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
    }
}
// --- ğŸ§  èƒŒæ™¯ç³»ç»Ÿå…¨å±€ç¼“å­˜ ---

// 1. æ‰“å¼€ä¸‡èƒ½ä¸Šä¼ å™¨
function openUniversalBgModal(target) {
    currentUploaderTarget = target;
    const modal = document.getElementById('modal-universal-uploader');
    const title = document.getElementById('uploader-title');
    const tag = document.getElementById('uploader-target-tag');
    
    title.textContent = target === 'chat' ? "è®¾ç½®èŠå¤©èƒŒæ™¯" : "è®¾ç½®èœå•èƒŒæ™¯";
    tag.textContent = target === 'chat' ? "SUPPORT IMG/VID" : "IMAGE ONLY";
    document.getElementById('universal-url-in').value = "";
    
    modal.style.display = 'flex';
}

function closeUniversalUploader() {
    document.getElementById('modal-universal-uploader').style.display = 'none';
}

// 2. å¤„ç† URL ä¸Šä¼ 
function handleUniversalUrl() {
    const url = document.getElementById('universal-url-in').value.trim();
    if(!url) return;
    
    // ç®€å•çš„æ ¼å¼åˆ¤å®š
    const isVideo = url.match(/\.(mp4|webm|ogg)/i);
    if(currentUploaderTarget === 'settings' && isVideo) {
        showToast("èœå•èƒŒæ™¯æš‚ä¸æ”¯æŒè§†é¢‘");
        return;
    }
    
    applyTempBg(currentUploaderTarget, isVideo ? 'vid' : 'img', url);
    closeUniversalUploader();
}

// 3. å¤„ç†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
function handleUniversalFile(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const isVideo = file.type.startsWith('video/');
        
        if(currentUploaderTarget === 'settings' && isVideo) {
            showToast("èœå•èƒŒæ™¯æš‚ä¸æ”¯æŒè§†é¢‘");
            return;
        }

        const reader = new FileReader();
        showToast("æ­£åœ¨è¯»å–æ–‡ä»¶...");
        reader.onload = function(e) {
            applyTempBg(currentUploaderTarget, isVideo ? 'vid' : 'img', e.target.result);
            closeUniversalUploader();
        };
        reader.readAsDataURL(file);
    }
}

// 4. å®æ—¶æ›´æ–°é¢„è§ˆå›¾ï¼ˆæ¯”ä¾‹ 9:16ï¼‰
function applyTempBg(target, type, data) {
    tempBgData[target] = { type, data };
    const thumb = document.getElementById(`preview-thumb-${target}`);
    
    if (type === 'vid') {
        thumb.innerHTML = `<video src="${data}" autoplay loop muted></video>`;
    } else {
        thumb.innerHTML = `<img src="${data}">`;
    }
}

// 5. ã€æ ¸å¿ƒä¿å­˜ã€‘ï¼šå†™å…¥ IndexedDB å¹¶ç‰©ç†åº”ç”¨
async function saveChatBackgroundSettings() {
    showToast("æ­£åœ¨ä¿å­˜è®¾ç½®...");

    // A. ä¿å­˜èŠå¤©èƒŒæ™¯ (åªæœ‰åœ¨èŠå¤©å®¤å†…æ‰ç”Ÿæ•ˆ)
    const contact = window.currentChattingWith;
    if (contact && tempBgData.chat.data) {
        const contactId = contact.id;
        localStorage.setItem(`chat_bg_type_${contactId}`, tempBgData.chat.type);
        await saveToDB(`chat_bg_data_${contactId}`, tempBgData.chat.data);
        tempBgData.chat.data = null; 
    }

    // B. ä¿å­˜å…¨å±€è®¾ç½®èƒŒæ™¯ (è¿™ä¸ªä¸åº”è¯¥å— contact é™åˆ¶ï¼)
    if (tempBgData.settings.data) {
        await saveToDB('settings_bg_data', tempBgData.settings.data);
        tempBgData.settings.data = null;
    }

    // é‡æ–°åº”ç”¨
    await applyBackgroundsToUI();
    showToast("âœ… èƒŒæ™¯å·²åŒæ­¥");
    // ğŸš¨ é‡ç‚¹ï¼šé€»è¾‘è·‘å®Œåï¼Œå¼¹å‡ºé«˜çº§æˆåŠŸæç¤ºï¼
    triggerSuccessHud("è®¾ç½®å·²åŒæ­¥");
}

// å…¼å®¹ä½  HTML é‡Œçš„å‡½æ•°åè°ƒç”¨
window.saveBackgroundSettings = saveChatBackgroundSettings;

// 6. ã€æ ¸å¿ƒåº”ç”¨ã€‘ï¼šå°†æ•°æ®æ¸²æŸ“åˆ°é¡µé¢
// ==========================================
// ğŸ¨ èƒŒæ™¯åº”ç”¨å¼•æ“ï¼šæ™ºèƒ½åº•è‰²æ§åˆ¶ç‰ˆ
// ==========================================
async function applyBackgroundsToUI() {
    const chatRoom = document.getElementById('page-chat-room');
    const chatSettings = document.getElementById('page-chat-settings'); // åŠ ä¸Šè¿™ä¸€è¡Œ
    const contact = window.currentChattingWith;

    if (!chatRoom) return;

    // 1. ç¡®ä¿èƒŒæ™¯èˆ±å­˜åœ¨
    let bgLayer = document.getElementById('chat-room-full-bg');
    if (!bgLayer) {
        bgLayer = document.createElement('div');
        bgLayer.id = 'chat-room-full-bg';
        bgLayer.style = "position:absolute; inset:0; width:100%; height:100%; z-index:0; pointer-events:none; overflow:hidden; background-color:#F2F2F7;";
        chatRoom.prepend(bgLayer); 
    }

    // --- A. èŠå¤©å®¤èƒŒæ™¯é€»è¾‘ (ç‹¬ç«‹ ID) ---
    if (contact) {
        const contactId = contact.id;
        const chatType = localStorage.getItem(`chat_bg_type_${contactId}`) || 'img';
        const chatData = await loadFromDB(`chat_bg_data_${contactId}`);
        const chatThumb = document.getElementById('preview-thumb-chat');

        if (chatData) {
            bgLayer.style.backgroundColor = "transparent"; 
            if (chatType === 'vid') {
                bgLayer.innerHTML = `<video src="${chatData}" autoplay loop muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>`;
            } else {
                bgLayer.innerHTML = `<img src="${chatData}" style="width:100%;height:100%;object-fit:cover;">`;
            }

            if (chatThumb) {
                chatThumb.innerHTML = chatType === 'vid' 
                    ? `<video src="${chatData}" autoplay loop muted style="width:100%;height:100%;object-fit:cover;"></video>` 
                    : `<img src="${chatData}" style="width:100%;height:100%;object-fit:cover;">`;
            }
        } else {
            bgLayer.innerHTML = ""; 
            bgLayer.style.backgroundColor = "#F2F2F7";
            if (chatThumb) chatThumb.innerHTML = `<div class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>`;
        }
    }

    // --- ğŸš¨ B. è®¾ç½®èœå•èƒŒæ™¯é€»è¾‘ (å…¨å±€) --- è¿™ä¸€å—ä½ ä¹‹å‰æ¼æ‰äº†ï¼
    const settingsData = await loadFromDB('settings_bg_data');
    const settingsThumb = document.getElementById('preview-thumb-settings');

    if (settingsData && chatSettings) {
        // åº”ç”¨åˆ°çœŸæ­£çš„è®¾ç½®é¡µèƒŒæ™¯
        chatSettings.style.backgroundImage = `url(${settingsData})`;
        chatSettings.style.backgroundSize = "cover";
        chatSettings.style.backgroundPosition = "center";
        
        // å›å¡«è®¾ç½®é¡µé‡Œçš„å°é¢„è§ˆæ¡†
        if (settingsThumb) {
            settingsThumb.innerHTML = `<img src="${settingsData}" style="width:100%;height:100%;object-fit:cover;">`;
        }
    }
}

// 7. ã€åˆå§‹åŒ–ã€‘ï¼šåˆ·æ–°åæ¢å¤
// åœ¨ä½ åŸæœ¬çš„ window.onload æˆ– loadSavedData ç»“å°¾åŠ å…¥è¿™ä¸€è¡Œï¼š
// applyBackgroundsToUI();

// 8. é‡ç½®
async function resetChatBackgrounds() {
    if(!window.currentChattingWith) return;
    const contactId = window.currentChattingWith.id;

    showIOSConfirm("é‡ç½®èƒŒæ™¯", "ç¡®å®šè¦æ¸…é™¤è¯¥å¥½å‹çš„ä¸“å±èƒŒæ™¯å—ï¼Ÿ", "é‡ç½®", async () => {
        // 1. åˆ é™¤å½“å‰å¥½å‹çš„å­˜å‚¨
        localStorage.removeItem(`chat_bg_type_${contactId}`);
        const db = await openDB();
        const tx = db.transaction(storeName, "readwrite");
        await tx.objectStore(storeName).delete(`chat_bg_data_${contactId}`);
        
        // 2. åˆ·æ–°ç•Œé¢
        applyBackgroundsToUI();
        showToast("å·²æ¢å¤é»˜è®¤");
    });
}
// ä¿®æ”¹ä½ ä¹‹å‰çš„ openChatSettings å‡½æ•°
window.openChatSettings = function() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
        
        // ğŸš¨ æ ¸å¿ƒï¼šåœ¨æ‰“å¼€è®¾ç½®é¡µæ—¶ï¼Œç«‹åˆ»è¿è¡Œä¸€æ¬¡èƒŒæ™¯åº”ç”¨å‡½æ•°
        // è¿™æ ·é¢„è§ˆæ¡†å°±ä¼šç«‹åˆ»æ˜¾ç¤ºå½“å‰è¿™ä¸ªå¥½å‹çš„ä¸“å±èƒŒæ™¯å›¾
        applyBackgroundsToUI();

        // å¡«å……åº•éƒ¨çš„ ID
        if(window.currentChattingWith) {
            const uid = document.getElementById('setting-uid-display');
            if(uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
        }
    }
}
// --- ğŸ† è§¦å‘ iOS æˆåŠŸ HUD ---
function triggerSuccessHud(text = "å·²ä¿å­˜") {
    const hud = document.getElementById('save-success-hud');
    const hudText = hud.querySelector('.hud-text');
    
    if (!hud) return;

    hudText.textContent = text;
    hud.style.display = 'flex';
    
    // å¼ºåˆ¶é‡ç»˜è§¦å‘åŠ¨ç”»
    void hud.offsetWidth;
    
    hud.classList.add('show');

    // 1.5ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        hud.classList.remove('show');
        setTimeout(() => {
            hud.style.display = 'none';
        }, 300); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»ç»“æŸ
    }, 1500);
}
// --- ğŸ§  è§’è‰²èµ„æ–™ä¸´æ—¶æš‚å­˜ ---
var tempCharProfileData = { id: null, avatar: null };

// 1. è¿›å…¥ç¼–è¾‘é¡µé¢ï¼šåŠ è½½å½“å‰è§’è‰²çš„åŸå§‹æ•°æ®
// ==========================================
// ğŸ“ èµ„æ–™ç¼–è¾‘é¡µï¼šå¼ºåŠ›åŠ è½½å¼•æ“
// ==========================================
async function openCharProfileEditPage() {
    console.log("System: å‡†å¤‡è¯»å–è§’è‰²èµ„æ–™...");
    
    // 1. è·å–å½“å‰å¯¹è¯å¯¹è±¡
    const contact = window.currentChattingWith;
    
    // ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
    if (!contact || !contact.id) {
        console.error("Error: æ‰¾ä¸åˆ°å½“å‰è”ç³»äººä¸Šä¸‹æ–‡");
        showToast("âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¥½å‹");
        return;
    }

    // 2. é”å®šæš‚å­˜å˜é‡ï¼Œé˜²æ­¢ undefined æŠ¥é”™
    tempCharProfileData.id = contact.id;

    // 3. ä»æ•°æ®åº“æ‹‰å–æœ€å…¨çš„ä¿¡æ¯ï¼ˆåŒ…å«èƒŒæ™¯æ•…äº‹ descï¼‰
    const charList = await loadFromDB('char_list') || [];
    const charInfo = charList.find(c => c.id === contact.id) || contact;

    // 4. ç‰©ç†å¡«å€¼ï¼ˆå¢åŠ ç©ºå€¼åˆ¤å®šï¼Œé˜²æ­¢æ¸²æŸ“ä¸­æ–­ï¼‰
    const elAvatar = document.getElementById('edit-char-avatar-pre');
    const elName = document.getElementById('edit-char-name');
    const elDesc = document.getElementById('edit-char-desc');
    const elMetaId = document.getElementById('meta-char-id');

    if (elAvatar) elAvatar.src = charInfo.avatar || "";
    if (elName) elName.value = charInfo.name || "";
    if (elDesc) elDesc.value = charInfo.desc || "";
    if (elMetaId) elMetaId.textContent = contact.id.substring(0, 16).toUpperCase();

    // 5. ç‰©ç†æ¨å…¥é¡µé¢
    const subPage = document.getElementById('subpage-char-profile');
    if (subPage) {
        subPage.classList.add('active'); // åŠ ä¸Š active ç±»è§¦å‘æ»‘åŠ¨
        console.log("System: èµ„æ–™é¡µå·²æˆåŠŸæ¨å…¥");
    }
}

// 2. å¤´åƒé¢„è§ˆé€»è¾‘
function previewProfileAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            tempCharProfileData.avatar = e.target.result;
            document.getElementById('edit-char-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 3. ã€æ ¸å¿ƒåŒæ­¥å¼•æ“ã€‘ï¼šä¿å­˜å¹¶è¦†ç›–æ‰€æœ‰æ•°æ®åº“
async function saveCharProfileChanges() {
    const id = tempCharProfileData.id;
    const newName = document.getElementById('edit-char-name').value.trim();
    const newDesc = document.getElementById('edit-char-desc').value.trim();
    const newAvatar = tempCharProfileData.avatar;

    if (!newName) { showToast("åç§°ä¸èƒ½ä¸ºç©º"); return; }

    showToast("æ­£åœ¨åŒæ­¥å…¨åŸŸèµ„æ–™...");

    // --- A. åŒæ­¥åˆ°è§’è‰²ä¹¦ (char_list) ---
    let charList = await loadFromDB('char_list') || [];
    let charIdx = charList.findIndex(c => c.id === id);
    if (charIdx !== -1) {
        charList[charIdx].name = newName;
        charList[charIdx].avatar = newAvatar;
        charList[charIdx].desc = newDesc;
        await saveToDB('char_list', charList);
    }

    // --- B. åŒæ­¥åˆ°å¥½å‹åˆ—è¡¨ (chat_friends) ---
    let friendList = await loadFromDB('chat_friends') || [];
    let friendIdx = friendList.findIndex(f => f.id === id);
    if (friendIdx !== -1) {
        friendList[friendIdx].name = newName;
        friendList[friendIdx].avatar = newAvatar;
        await saveToDB('chat_friends', friendList);
    }

    // --- C. åŒæ­¥åˆ°å½“å‰æ­£åœ¨è¿›è¡Œçš„ä¸Šä¸‹æ–‡ ---
    window.currentChattingWith.name = newName;
    window.currentChattingWith.avatar = newAvatar;

    // --- D. åˆ·æ–°å½“å‰ UI ---
    // åˆ·æ–°èŠå¤©å®¤å¤´éƒ¨
    document.getElementById('room-contact-name').textContent = newName;
    document.getElementById('room-contact-avatar').src = newAvatar;
    
    // å¼ºåˆ¶é©±åŠ¨æ‰€æœ‰åˆ—è¡¨é‡ç»˜
    if (typeof renderChatList === 'function') renderChatList();
    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
    if (typeof renderCharList === 'function') renderCharList();

    // æˆåŠŸæç¤ºå¹¶é€€å‡º
    closeSubPage('subpage-char-profile');
    triggerSuccessHud("èµ„æ–™å·²å…¨åŸŸåŒæ­¥");
}
// A. æ‰“å¼€å¥½å‹ç¯ç¤¾äº¤å¡
function openSocialCard(char) {
    window.currentEditingCharId = char.id; // å…³é”®ï¼šè®°å½•å½“å‰æ­£åœ¨çœ‹è°
    
    document.getElementById('social-v-avatar').src = char.avatar;
    document.getElementById('social-v-name').textContent = char.name;
    
    // ä»ç¼“å­˜è¯»å–ç­¾å
    const savedMotto = localStorage.getItem('chat_motto_' + char.id) || "Hello! Let's chat.";
    document.getElementById('social-v-motto').textContent = savedMotto;
    
    document.getElementById('modal-social-card').style.display = 'flex';
}

// ä»å¡ç‰‡ç‚¹å‡»ç­¾åçš„å…¥å£
function openEditMottoFromCard() {
    const mottoEl = document.getElementById('social-v-motto');
    const input = document.getElementById('motto-input');
    const modal = document.getElementById('modal-motto-edit');
    
    if (input && mottoEl) {
        input.value = mottoEl.textContent;
        // ğŸš¨ é‡ç‚¹ï¼šåªç®¡æ˜¾ç¤ºè‡ªå·±ï¼Œä¸è¦å»ç¢°åº•ä¸‹çš„ modal-social-card
        modal.style.display = 'flex'; 
    }
}

// ä¿®æ”¹åçš„ä¿å­˜å‡½æ•°
function saveMotto() {
    const input = document.getElementById('motto-input');
    const val = input ? input.value.trim() : "";
    const charId = window.currentEditingCharId;

    if (val && charId) {
        localStorage.setItem('chat_motto_' + charId, val);
        
        // åŒæ­¥æ‰€æœ‰å¯èƒ½çš„ UI å…ƒç´ 
        const els = ['social-v-motto', 'profile-v-motto'];
        els.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = val;
        });

        triggerSuccessHud("ç­¾åå·²åŒæ­¥");
    }
    
    // ğŸš¨ é‡ç‚¹ï¼šåªå…³é—­ä¿®æ”¹æ¡†ï¼Œä¸è¦è¯¯å…³åº•ä¸‹çš„ç¤¾äº¤å¡ç‰‡
    document.getElementById('modal-motto-edit').style.display = 'none';
}

// B. æ‰“å¼€è®¾ç½®é¡µèµ„æ–™é¢„è§ˆå¡
async function openChatProfileFromSettings() {
    const contact = window.currentChattingWith;
    if(!contact) return;
    
    // è·å–æœ€æ–°æœ€å…¨çš„æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const fullChar = charList.find(c => c.id === contact.id) || contact;

    document.getElementById('aes-v-avatar').src = fullChar.avatar;
    document.getElementById('aes-v-name').textContent = fullChar.name;
    document.getElementById('aes-v-desc').textContent = fullChar.desc || "No description yet.";
    
    document.getElementById('modal-aes-preview').style.display = 'flex';
}
// 1. æ‰“å¼€ä¸–ç•Œç»‘å®šé¡µ
async function openWorldBindPage() {
    const contact = window.currentChattingWith;
    const worldList = await loadFromDB('world_list') || [];
    const charList = await loadFromDB('char_list') || [];
    const currentChar = charList.find(c => c.id === contact.id);
    
    // è®°ä½å½“å‰å·²ç»‘å®šçš„
    const boundIds = currentChar.boundWorldIds || [];
    const container = document.getElementById('world-bind-list');
    container.innerHTML = "";

    worldList.forEach(w => {
        const isChecked = boundIds.includes(w.id);
        const item = document.createElement('div');
        item.className = 'ios-list-item';
        item.innerHTML = `
            <div class="item-content">
                <span class="item-label">${w.name}</span>
                <input type="checkbox" class="world-checkbox" data-id="${w.id}" ${isChecked ? 'checked' : ''} style="width:22px; height:22px;">
            </div>
        `;
        container.appendChild(item);
    });
    openSubPage('subpage-world-bind');
}

// 2. ä¿å­˜ç»‘å®šå…³ç³»
async function saveWorldBinding() {
    const contact = window.currentChattingWith;
    const checks = document.querySelectorAll('.world-checkbox:checked');
    const selectedIds = Array.from(checks).map(c => c.dataset.id);

    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].boundWorldIds = selectedIds;
        await saveToDB('char_list', charList);
        document.getElementById('val-bound-count').textContent = selectedIds.length + " ä¸ªåè®®";
        triggerSuccessHud("åè®®å·²ç»‘å®š");
        closeSubPage('subpage-world-bind');
    }
}

// 3. è§£æå…³ç³»ç½‘ (åˆ›æ–°ç‚¹ï¼šAI è‡ªåŠ¨åˆ›é€  NPC)
// --- ğŸŒŒ æ ¸å¿ƒï¼šå¢é‡ç”Ÿæˆå¼•æ“ ---
async function generateRelationsWithAI(isAppend = false) {
    const contact = window.currentChattingWith;
    const loader = document.getElementById('quantum-loader');
    const statusText = document.getElementById('q-status');

    loader.style.display = 'flex';
    
    // 1. æå–â€œå·²æœ‰äººç‰©åå•â€ï¼šè¿™æ˜¯é˜²æ­¢ AI ç”Ÿæˆé‡å¤è§’è‰²çš„å…³é”®
    const charList = await loadFromDB('char_list') || [];
    const charIdx = charList.findIndex(c => c.id === contact.id);
    const currentChar = charList[charIdx];
    const existingNPCs = currentChar.relationNetwork || [];
    const existingNames = existingNPCs.map(n => n.name).join('ã€'); // ğŸ‘ˆ ä¼ ç»™ AI çš„â€œé»‘åå•â€

    // 2. æå–ä¸–ç•Œè§‚è§„åˆ™
    const allWorlds = await loadFromDB('world_list') || [];
    const boundIds = currentChar.boundWorldIds || [];
    const worldContext = allWorlds.filter(w => boundIds.includes(w.id)).map(w => w.content).join("\n");

    statusText.textContent = isAppend ? "æ­£åœ¨æ‹“å®½ç¤¾äº¤è±¡é™..." : "æ­£åœ¨æ„å»ºåˆä»£ç½‘ç»œ...";

    // 3. æ„å»º Promptï¼šæ˜ç¡®è¦æ±‚åŒºåˆ† level
    const prompt = `ä½ æ˜¯ä¸€å°é‡å­ç¤¾äº¤ç½‘ç»œæ¨¡æ‹Ÿå™¨ã€‚åŸºäºè§’è‰²[${currentChar.name}]å’Œä¸–ç•ŒèƒŒæ™¯[${worldContext}]ã€‚
    ${isAppend ? `ç›®å‰å·²æœ‰è§’è‰²: ${existingNames}ã€‚è¯·ã€ç»å¯¹é¿å¼€ã€‘è¿™äº›äººåï¼Œæ–°å¢ 2-3 ä¸ªæ€§æ ¼è¿¥å¼‚çš„äººç‰©ã€‚` : `è¯·åˆ›é€  3-5 ä¸ªæ ¸å¿ƒäººç‰©ã€‚`}
    
    è¦æ±‚ï¼š
    - "level" å­—æ®µ: å¿…é¡»æ ‡æ³¨ä¸º "core" (ç¾ç»Šææ·±) æˆ– "associate" (æ™®é€šå¾€æ¥)ã€‚
    - "art_tag": æè¿°å…¶åšæ¶‚é£å¤–è²Œå…³é”®è¯ã€‚
    
    æ ¼å¼: [{"name":"","role":"","bio":"","level":"core/associate","art_tag":""}]`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const newNpcs = JSON.parse(data.choices[0].message.content.match(/\[.*\]/s)[0]);

        // 4. æ³¨å…¥å¤´åƒå’Œ ID
        newNpcs.forEach((n, index) => {
            n.id = "npc_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            n.avatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${n.art_tag + n.name}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        });

        // 5. å¢é‡ä¿å­˜ï¼šæŠŠæ–°ç”Ÿæˆçš„æ‹¼æ¥åˆ°æ—§çš„åé¢
        const updatedNetwork = isAppend ? [...existingNPCs, ...newNpcs] : newNpcs;
        currentChar.relationNetwork = updatedNetwork;
        await saveToDB('char_list', charList);

        // 6. UI åˆ·æ–°
        renderNPCGrid(updatedNetwork);
        document.getElementById('relation-empty-state').style.display = 'none';
        document.getElementById('relation-footer').style.display = 'flex'; // ğŸ‘ˆ ç¡®ä¿æ‰©å±•æŒ‰é’®å¯è§
        
        loader.style.display = 'none';
        triggerSuccessHud(isAppend ? "çº½å¸¦å·²æ‹“å®½" : "å…³ç³»ç½‘å·²å°±ç»ª");

    } catch(e) {
        loader.style.display = 'none';
        showToast("é‡å­çº ç¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
}

// --- ğŸ“– å‰§æƒ…å›æº¯ï¼šç”Ÿæˆä¸“å±å¾€äº‹ ---
// ==========================================
// ğŸ“œ å¾€äº‹è§£å¯†ç³»ç»Ÿï¼šå…¨æ–°æ¨ç¿»ç‰ˆ
// ==========================================

async function traceNPCStory() {
    const npc = window.currentViewingNPC; // å½“å‰ç‚¹çš„é‚£ä¸ªNPC
    const mainChar = window.currentChattingWith; // ç©å®¶å½“å‰æ­£åœ¨ç©çš„ä¸»è§’
    const btn = document.querySelector('#modal-npc-detail .npc-btn-main:first-child');

    if (!npc || !mainChar) {
        showToast("âš ï¸ æ— æ³•è¯†åˆ«è§’è‰²é“¾è·¯");
        return;
    }

    // --- 1. æ£€æŸ¥æ˜¯å¦å·²ç»è§£å¯†è¿‡ (æŒä¹…åŒ–è¯»å–) ---
    if (npc.detailedPast) {
        console.log("System: æ¡£æ¡ˆå·²å­˜åœ¨ï¼Œæ­£åœ¨ç›´æ¥æ‰“å¼€...");
        document.getElementById('modal-npc-detail').style.display = 'none'; // å…³æ‰è¯¦æƒ…å¡
        openPastDecoderUI(npc, npc.detailedPast, false);
        return;
    }

    // --- 2. å¼€å¯è§£å¯†åŠ¨ç”» ---
    if (btn.classList.contains('decoding')) return;
    btn.classList.add('decoding');
    btn.textContent = "DECODING...";

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        // å¢åŠ ä¸€ç‚¹ä»ªå¼æ„Ÿçš„ç­‰å¾…
        await new Promise(r => setTimeout(r, 1500));

        const prompt = `ä½ æ­£åœ¨å›æº¯[${mainChar.name}]ä¸[${npc.name}]çš„å…±åŒå¾€äº‹ã€‚
        NPCèƒŒæ™¯: ${npc.bio}ï¼Œä¸¤äººçš„å…³ç³»æ˜¯: ${npc.role}ã€‚
        è¯·åˆ›ä½œä¸€æ®µçº¦ 200-300 å­—çš„éšç§˜å¾€äº‹ï¼Œè¦æ±‚æ–‡é£é«˜çº§ã€å¯Œæœ‰ç”µå½±æ„Ÿã€‚
        ç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        const story = data.choices[0].message.content.trim();

        // --- 3. æ ¸å¿ƒï¼šä¿å­˜åˆ°æ•°æ®åº“ï¼Œé˜²æ­¢åˆ·æ–°æ¶ˆå¤± ---
        let charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === mainChar.id);
        if (charIdx !== -1) {
            const nIdx = charList[charIdx].relationNetwork.findIndex(n => n.id === npc.id);
            if (nIdx !== -1) {
                // å°†å¾€äº‹å­˜å…¥æ•°æ®åº“
                charList[charIdx].relationNetwork[nIdx].detailedPast = story;
                await saveToDB('char_list', charList);
                // ä¹Ÿè¦æ›´æ–°å½“å‰å†…å­˜é‡Œçš„ NPC å¯¹è±¡
                window.currentViewingNPC.detailedPast = story;
            }
        }

        // --- 4. æš´åŠ›åˆ‡æ¢ç•Œé¢ ---
        btn.classList.remove('decoding');
        document.getElementById('modal-npc-detail').style.display = 'none'; // å½»åº•å…³é—­æ—§å¡ç‰‡
        
        setTimeout(() => {
            openPastDecoderUI(npc, story, true); // å”¤èµ·æ–°å¡ç‰‡å¹¶å¼€å¯æ‰“å­—æœº
        }, 150);

    } catch (e) {
        console.error("è§£å¯†å¤±è´¥:", e);
        btn.classList.remove('decoding');
        btn.textContent = "è§£å¯†å¤±è´¥ï¼Œé‡è¯•";
        showToast("é‡å­ä¿¡å·è¿æ¥å¤±è´¥");
    }
}

// è¾…åŠ©ï¼šæ‰“å¼€è§£å¯†å±•ç¤ºå±‚
function openPastDecoderUI(npc, content, isNew) {
    const modal = document.getElementById('modal-past-decoder');
    const textField = document.getElementById('past-text-body');
    
    // å¡«å……åŸºæœ¬ä¿¡æ¯
    document.getElementById('past-name-txt').textContent = npc.name;
    document.getElementById('past-avatar-img').src = npc.avatar;
    document.getElementById('past-hero-blur').style.backgroundImage = `url(${npc.avatar})`;

    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
    
    textField.textContent = "";
    if (isNew) {
        // æ‰“å­—æœºæ•ˆæœ
        let i = 0;
        function typing() {
            if (i < content.length) {
                textField.textContent += content.charAt(i);
                i++;
                // æ»šåŠ¨æ¡è‡ªåŠ¨è·Ÿéš
                const scroller = modal.querySelector('.aes-scroll-area');
                scroller.scrollTop = scroller.scrollHeight;
                setTimeout(typing, 25);
            }
        }
        typing();
    } else {
        textField.textContent = content;
    }
}

// è¾…åŠ©ï¼šå…³é—­å‡½æ•°
function closePastDecoder() {
    document.getElementById('modal-past-decoder').style.display = 'none';
}

// --- ğŸ¨ æ¸²æŸ“ï¼šåŠ¨æ€åŒºåˆ†å…³ç³»æƒé‡ ---
function renderNPCGrid(npcs) {
    const grid = document.getElementById('npc-grid');
    if (!grid) return;
    grid.innerHTML = "";
    
    npcs.forEach((npc, i) => {
        const card = document.createElement('div');
        const isCore = npc.level === 'core';
        card.className = `char-card npc-arrival npc-${npc.level || 'associate'}`;
        card.style.animationDelay = (i * 0.1) + "s";
        card.innerHTML = `
            <img class="char-card-img" src="${npc.avatar}">
            ${isCore ? '<div class="core-bond-badge" style="position:absolute; top:10px; left:10px; background:#007AFF; color:white; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:900;">CORE</div>' : ''}
            <div class="char-card-info">
                <div class="char-card-name">${npc.name}</div>
                <div class="char-card-desc" style="color:${isCore ? '#007AFF' : '#8e8e93'}; font-weight:700;">${npc.role}</div>
            </div>`;
        
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»å¡ç‰‡æ—¶ï¼ŒæŠŠæ•°æ®å¡ç»™å…¨å±€å˜é‡ï¼Œå¦åˆ™æŒ‰é’®æ‰¾ä¸åˆ°ç›®æ ‡
        card.onclick = () => {
            console.log("System: Selecting NPC ->", npc.name);
            window.currentViewingNPC = npc; 
            openNPCDetail(npc);
        };
        grid.appendChild(card);
    });
}

// --- ğŸ­ æ‰“å¼€ NPC èµ„æ–™å¡ ---
// --- ğŸ­ æ‰“å¼€ NPC èµ„æ–™å¡ (çº¯å‡€ç‰ˆï¼Œè§£å†³ style æŠ¥é”™) ---
function openNPCDetail(npc) {
    console.log("System: Opening Dossier for ->", npc.name);
    window.currentViewingNPC = npc; 

    // 1. å¡«å……åŸºç¡€ä¿¡æ¯
    const avatar = document.getElementById('npc-v-avatar');
    const banner = document.getElementById('npc-v-banner');
    const name = document.getElementById('npc-v-name');
    const role = document.getElementById('npc-v-role');
    const bio = document.getElementById('npc-v-bio');

    if(avatar) avatar.src = npc.avatar;
    if(banner) banner.src = npc.avatar; 
    if(name) name.textContent = npc.name;
    if(role) role.textContent = npc.role.toUpperCase();
    if(bio) bio.textContent = npc.bio;
    
    // 2. çŠ¶æ€é‡ç½®ï¼šç¡®ä¿æŒ‰é’®æ–‡å­—å›å½’åˆå§‹çŠ¶æ€
    const btn = document.querySelector('#modal-npc-detail .npc-btn-main:first-child');
    if (btn) {
        btn.classList.remove('scanning'); // ç§»é™¤æ‰«æåŠ¨ç”»ç±»
        btn.textContent = "æŸ¥çœ‹å¾€äº‹";      // æ¢å¤åŸæœ¬æ–‡å­—
    }

    // 3. æ˜¾ç¤ºå¼¹çª—
    const modal = document.getElementById('modal-npc-detail');
    if(modal) modal.style.display = 'flex';
}
// --- ğŸš€ æ‰“å¼€å…³ç³»ç½‘å­é¡µé¢ ---
async function openRelationsPage() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    // 1. ä»æ•°æ®åº“è¯»å–å½“å‰è§’è‰²çš„æœ€æ–°æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const currentChar = charList.find(c => c.id === contact.id);
    
    const emptyState = document.getElementById('relation-empty-state');
    const npcGrid = document.getElementById('npc-grid');

    // 2. æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰äº†ç”Ÿæˆå¥½çš„å…³ç³»ç½‘
    const network = currentChar.relationNetwork || [];
    
    if (network.length > 0) {
        // å¦‚æœæœ‰æ•°æ®ï¼Œéšè—ç©ºçŠ¶æ€ï¼Œæ¸²æŸ“ç½‘æ ¼
        if (emptyState) emptyState.style.display = 'none';
        renderNPCGrid(network); // è°ƒç”¨ä½ ä¹‹å‰å†™çš„æ¸²æŸ“å‡½æ•°
    } else {
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºâ€œé‡å­è§£æâ€æŒ‰é’®
        if (emptyState) emptyState.style.display = 'block';
        if (npcGrid) npcGrid.innerHTML = "";
    }

    // 3. æ»‘å…¥é¡µé¢
    openSubPage('subpage-relations');
}
// --- ğŸš‘ ä¿®æ­£ ID å†²çªè¡¥ä¸ ---
async function saveWorldBinding() {
    const contact = window.currentChattingWith;
    const checks = document.querySelectorAll('.world-checkbox:checked');
    const selectedIds = Array.from(checks).map(c => c.dataset.id);

    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].boundWorldIds = selectedIds;
        await saveToDB('char_list', charList);

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œè¦æŠŠ 'val-bound-count' æ”¹ä¸º 'val-bound-status'
        const statusEl = document.getElementById('val-bound-status');
        if (statusEl) {
            statusEl.textContent = selectedIds.length > 0 ? selectedIds.length + " ä¸ªåè®®" : "å»ç»‘å®š";
        }

        triggerSuccessHud("åè®®å·²ç»‘å®š");
        closeSubPage('subpage-world-bind');
    }
}
// ==========================================
// ğŸ“¡ æ·±åº¦ç¤¾äº¤é€»è¾‘ï¼šå¸¦â€œä»ªå¼æ„Ÿâ€å»¶è¿Ÿçš„ AI å®¡æ ¸
// ==========================================
async function handleNPCFriendRequest() {
    const btn = document.getElementById('npc-add-btn');
    const text = document.getElementById('npc-add-text');
    
    // 1. æ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨
    const sourceNpc = window.currentViewingNPC;
    const mainChar = window.currentChattingWith;

    console.log("System: Requesting more relations for", sourceNpc ? sourceNpc.name : "NULL");

    if (!btn || btn.classList.contains('sending')) return;
    
    if (!sourceNpc) {
        showToast("âš ï¸ æœªè¯†åˆ«åˆ°ç›®æ ‡ NPC");
        return;
    }

    // --- å¯åŠ¨åŠ¨æ•ˆ ---
    btn.classList.add('sending');
    text.textContent = "SIGNALING...";

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        if (!apiKey) throw new Error("Missing API Key");

        // æ¨¡æ‹Ÿæ‰«ææ„Ÿ
        await new Promise(r => setTimeout(r, 1000));
        text.textContent = "DECODING...";

        // 2. å‡†å¤‡ä¸Šä¸‹æ–‡
        const charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === mainChar.id);
        const currentCharData = charList[charIdx];
        const existingNetwork = currentCharData.relationNetwork || [];
        const existingNames = existingNetwork.map(n => n.name).join('ã€');

        const prompt = `ä½ æ˜¯ä¸€å°é‡å­å…³ç³»æ¨¡æ‹Ÿå™¨ã€‚
        ç›®å‰ä¸»è§’[${mainChar.name}]é€šè¿‡äººç‰©[${sourceNpc.name}](${sourceNpc.role})åœ¨æ·±å…¥ç¤¾äº¤åœˆã€‚
        è¯·åŸºäº[${sourceNpc.name}]çš„èƒŒæ™¯[${sourceNpc.bio}]ï¼Œå†æ‰©å…… 2 ä¸ªä¸ä»–æœ‰å¯†åˆ‡å¾€æ¥çš„æ–°è§’è‰²ã€‚
        ã€è¦æ±‚ã€‘ç»å¯¹é¿å¼€å·²æœ‰äººç‰©ï¼š${existingNames}ã€‚
        ã€è¾“å‡ºã€‘ä¸¥æ ¼JSONæ•°ç»„æ ¼å¼: [{"name":"","role":"ä¸${sourceNpc.name}çš„å…³ç³»","bio":"","level":"associate","art_tag":""}]`;

        // 3. AI è°ƒç”¨
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        const content = data.choices[0].message.content;
        const newNpcs = JSON.parse(content.match(/\[.*\]/s)[0]);

        // 4. å¤„ç†æ–°äºº
        newNpcs.forEach(n => {
            n.id = "npc_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            n.avatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${encodeURIComponent(n.name)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        });

        // 5. å¢é‡ä¿å­˜
        const updatedNetwork = [...existingNetwork, ...newNpcs];
        charList[charIdx].relationNetwork = updatedNetwork;
        await saveToDB('char_list', charList);

        // 6. è§†è§‰åé¦ˆ
        text.textContent = "SYNCED";
        btn.classList.remove('sending');
        btn.classList.add('sent');
        btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" style="margin-right:5px;"><polyline points="20 6 9 17 4 12"></polyline></svg><span>å‘ç°æ–°è„‰ç»œ</span>`;

        showToast(`å·²è§£æå‡º ${newNpcs.length} ä¸ªæ–°äººç‰©`);

        // 7. åˆ·æ–°å¹¶é€€å‡º
        setTimeout(() => {
            document.getElementById('modal-npc-detail').style.display = 'none';
            btn.classList.remove('sent');
            btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg><span id="npc-add-text">Add Friend</span>`;
            
            if (typeof renderNPCGrid === 'function') renderNPCGrid(updatedNetwork);
        }, 1500);

    } catch (e) {
        console.error("Critical Error:", e);
        btn.classList.remove('sending');
        text.textContent = "SIGNAL LOST";
        showToast(e.message === "Missing API Key" ? "API Key æœªé…ç½®" : "è§£æå¤±è´¥");
    }
}
// ==========================================
// ğŸ§¹ å…¨åŸŸè®°å¿†æŠ¹é™¤ï¼šå½»åº•æ¸…ç†ç¤¾äº¤ã€è®¾ç½®ã€ç»‘å®šåŠå…³ç³»ç½‘
// ==========================================
async function executeMasterSocialDelete(contactId) {
    if (!contactId) return;

    showToast("æ­£åœ¨æ‰§è¡Œé«˜ç»´è®°å¿†éš”ç¦»...");

    try {
        const db = await openDB();
        
        // --- 1. ç‰©ç†åˆ é™¤èŠå¤©è®°å½• (DB: chat_history) ---
        const txChat = db.transaction("chat_history", "readwrite");
        await txChat.objectStore("chat_history").delete(contactId);
        console.log("âœ… èŠå¤©è®°å½•å·²é”€æ¯");

        // --- 2. ç‰©ç†åˆ é™¤ä¸“å±èƒŒæ™¯æ•°æ® (DB: wallpapers) ---
        const txWall = db.transaction("wallpapers", "readwrite");
        await txWall.objectStore("wallpapers").delete(`chat_bg_data_${contactId}`);
        console.log("âœ… ä¸“å±èƒŒæ™¯äºŒè¿›åˆ¶æ•°æ®å·²æŠ¹é™¤");

        // --- 3. ä»å¥½å‹åˆ—è¡¨ç§»é™¤ (DB: chat_friends) ---
        let friendList = await loadFromDB('chat_friends') || [];
        friendList = friendList.filter(f => f.id !== contactId);
        await saveToDB('chat_friends', friendList);
        console.log("âœ… å¥½å‹åå•å·²æ¸…ç†");

        // --- 4. ã€æ ¸å¿ƒä¿®å¤ã€‘æŠ¹é™¤è§’è‰²æ¡£æ¡ˆå†…çš„ç»‘å®šä¸å…³ç³»ç½‘ (DB: char_list) ---
        let charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === contactId);
        if (charIdx !== -1) {
            // ä¿ç•™æ ¸å¿ƒæ¡£æ¡ˆï¼ˆåã€å¤´ã€æ„Ÿï¼‰ï¼Œä½†æ¸…ç©ºæ‰€æœ‰è¡ç”Ÿæ•°æ®
            charList[charIdx].boundWorldIds = [];    // æ¸…ç©ºä¸–ç•Œä¹¦ç»‘å®š
            charList[charIdx].relationNetwork = [];  // æ¸…ç©ºå…³ç³»ç½‘ NPC
            await saveToDB('char_list', charList);
            console.log("âœ… ä¸–ç•Œåè®®ä¸å…³ç³»ç½‘å·²é‡ç½®");
        }

        // --- 5. æ¸…ç† LocalStorage ä¸­çš„çç¢é…ç½® ---
        localStorage.removeItem(`chat_motto_${contactId}`);
        localStorage.removeItem(`chat_bg_type_${contactId}`);
        
        // ç§»é™¤ç½®é¡¶
        let pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
        pinnedIds = pinnedIds.filter(id => id !== contactId);
        localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));
        console.log("âœ… æœ¬åœ°åå¥½è®¾ç½®å·²æ¸…ç©º");

        // --- 6. UI çŠ¶æ€é‡ç½®ä¸åˆ·æ–° ---
        // å¼ºè¡Œå…³é—­å½“å‰å¯èƒ½æ‰“å¼€çš„æ‰€æœ‰ç›¸å…³é¡µé¢
        closeChatSettings();
        closeChatRoom();
        if(document.getElementById('subpage-relations')) closeSubPage('subpage-relations');
        if(document.getElementById('subpage-world-bind')) closeSubPage('subpage-world-bind');

        // åˆ·æ–°æ‰€æœ‰ç›¸å…³çš„åˆ—è¡¨
        if (typeof renderChatList === 'function') renderChatList();
        if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
        if (typeof renderCharList === 'function') renderCharList(); // åˆ·æ–°è§’è‰²ä¹¦å°å¡ç‰‡
        
        triggerSuccessHud("è¯¥äººæ ¼å·²å›å½’åˆå§‹æ€");

    } catch (e) {
        console.error("âŒ å…¨åŸŸæ¸…ç†å¤±è´¥:", e);
        showToast("éƒ¨åˆ†é‡å­æ•°æ®æ®‹ç•™ï¼Œè¯·é‡è¯•");
    }
}
// ==========================================
// ğŸš€ æœ¬æˆ‘æ¡£æ¡ˆï¼šå¼ºåŠ›ä¿®å¤é©±åŠ¨ï¼ˆåæ¥å±…ä¸Šç‰ˆï¼‰
// ==========================================

window.openUserProfileEdit = function() {
    console.log("System: æ­£åœ¨æ‰§è¡Œæœ€é«˜æƒé™æ¨å…¥åè®®...");

    // 1. å¼ºåŠ›åˆå§‹åŒ–æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±æŠ¥é”™
    if (!window.userPersona) {
        const saved = localStorage.getItem('user_persona_data');
        window.userPersona = saved ? JSON.parse(saved) : {
            name: "æŒ‡æŒ¥å®˜",
            avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=user_default",
            bio: ""
        };
    }

    const data = window.userPersona;

    // 2. ç‰©ç†å¡«å€¼ï¼šç›´æ¥æ ¹æ® ID å¼ºè¡ŒçŒå…¥
    const avt = document.getElementById('user-avatar-pre');
    const nameInput = document.getElementById('user-name-in');
    const bioInput = document.getElementById('user-bio-in');
    
    if (avt) avt.src = data.avatar;
    if (nameInput) nameInput.value = data.name || "";
    if (bioInput) bioInput.value = data.bio || "";

    // 3. ç‰©ç†æ¨å…¥ï¼šä¸é  openSubPageï¼Œç›´æ¥æš´åŠ›å¼€å¯
    const pages = document.querySelectorAll('#subpage-user-profile');
    pages.forEach(p => {
        p.style.display = 'flex'; // å…ˆå˜ç°èº«
        setTimeout(() => {
            p.classList.add('active'); // åæ»‘å…¥
        }, 10);
    });

    console.log("System: æ¨å…¥æŒ‡ä»¤å·²ä¸‹è¾¾ï¼Œé¡µé¢åº”å·²æ»‘å…¥ã€‚");
};

// é¡ºä¾¿ä¿®å¤é¢„è§ˆå¡ç‰‡
window.openUserCardPreview = function() {
    const data = window.userPersona || JSON.parse(localStorage.getItem('user_persona_data'));
    if(!data) { showToast("æ¡£æ¡ˆå°šæœªå»ºç«‹"); return; }

    document.getElementById('user-card-avatar').src = data.avatar;
    document.getElementById('user-card-name').textContent = data.name;
    document.getElementById('user-card-bio').textContent = data.bio || "å°šæœªå½•å…¥ç³»ç»Ÿæ¡£æ¡ˆ...";

    const modal = document.getElementById('modal-user-card');
    if(modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '30000'; // ç½®é¡¶
    }
};
// ==========================================
// ğŸ‘¤ æœ¬æˆ‘æ¡£æ¡ˆï¼šç›´ç™½å‡½æ•°ä¿®å¤ç‰ˆ
// ==========================================

// 1. æ‰“å¼€ç¼–è¾‘èµ„æ–™é¡µ
function openUserProfileEdit() {
    console.log("æ­£åœ¨æ‰“å¼€ç¼–è¾‘é¡µ...");
    
    // ææ•°æ®
    var saved = localStorage.getItem('user_persona_data');
    var data = saved ? JSON.parse(saved) : { name: "æŒ‡æŒ¥å®˜", avatar: "", bio: "" };
    window.userPersona = data;

    // ç»™è¾“å…¥æ¡†å¡å€¼
    if (document.getElementById('user-avatar-pre')) document.getElementById('user-avatar-pre').src = data.avatar;
    if (document.getElementById('user-name-in')) document.getElementById('user-name-in').value = data.name;
    if (document.getElementById('user-bio-in')) document.getElementById('user-bio-in').value = data.bio;

    // å¼ºè¡Œè®©é¡µé¢ç°èº«å¹¶æ»‘å‡ºæ¥
    var page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';           // ç¡®ä¿å®ƒä¸æ˜¯ none
        page.style.zIndex = '999999';          // ç¡®ä¿å®ƒåœ¨æœ€ä¸Šé¢
        setTimeout(function() {
            page.classList.add('active');      // è§¦å‘æ»‘å…¥åŠ¨ç”»
        }, 10);
    }
}

// 2. é¢„è§ˆèµ„æ–™å¡
function openUserCardPreview() {
    console.log("æ­£åœ¨é¢„è§ˆèµ„æ–™å¡...");
    var saved = localStorage.getItem('user_persona_data');
    var data = saved ? JSON.parse(saved) : { name: "æœªçŸ¥", avatar: "", bio: "" };

    if (document.getElementById('user-card-avatar')) document.getElementById('user-card-avatar').src = data.avatar;
    if (document.getElementById('user-card-name')) document.getElementById('user-card-name').textContent = data.name;
    if (document.getElementById('user-card-bio')) document.getElementById('user-card-bio').textContent = data.bio || "å°šæœªå®šä¹‰äººæ ¼...";

    var modal = document.getElementById('modal-user-card');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '999999';
    }
}

// 3. ä¿å­˜èµ„æ–™
function saveUserProfile() {
    var name = document.getElementById('user-name-in').value.trim();
    var bio = document.getElementById('user-bio-in').value.trim();
    var avatar = document.getElementById('user-avatar-pre').src;

    if (!name) { alert("æ˜µç§°ä¸èƒ½ä¸ºç©ºå¥¥"); return; }

    var newData = { name: name, bio: bio, avatar: avatar };
    localStorage.setItem('user_persona_data', JSON.stringify(newData));
    window.userPersona = newData;

    // å…³æ‰é¡µé¢
    var page = document.getElementById('subpage-user-profile');
    if (page) page.classList.remove('active');
    
    // å¼¹å‡ºæˆåŠŸæç¤º
    if (window.triggerSuccessHud) window.triggerSuccessHud("èº«ä»½å¥‘çº¦å·²æ›´æ–°");
    else alert("èº«ä»½å¥‘çº¦å·²æ›´æ–°");
}

// 4. å¤´åƒé¢„è§ˆ
function previewUserAvatar(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('user-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

console.log("âœ… ç›´ç™½ä¿®å¤ç‰ˆå‡½æ•°å·²å…¨éƒ¨æŒ‚è½½ï¼Œç°åœ¨å»ç‚¹ç‚¹çœ‹ï¼Ÿ");
// ==========================================
// ğŸ­ èº«ä»½éš”ç¦»å¼•æ“ï¼šä¸ºæ¯ä¸ªè§’è‰²åˆ†é…ç‹¬ç«‹çš„â€œæˆ‘â€
// ==========================================

// 1. è·å–å½“å‰è§’è‰²çš„ä¸“å±èº«ä»½å‘ä½ Key
function getPersonaStorageKey() {
    // ä¼˜å…ˆç»‘å®šå½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰² ID
    var contact = window.currentChattingWith;
    if (contact && contact.id) {
        return 'user_persona_for_' + contact.id;
    }
    // å¦‚æœæ˜¯ä»å…¨å±€è®¾ç½®è¿›å…¥ä¸”æ²¡é€‰å®šè§’è‰²ï¼Œè¿”å›ä¸€ä¸ªé€šç”¨ Key
    return 'user_persona_data_global';
}

// 2. è¦†ç›–æ‰“å¼€ç¼–è¾‘é¡µé€»è¾‘ï¼šç²¾å‡†æå–è¯¥è§’è‰²çš„â€œæˆ‘â€
function openUserProfileEdit() {
    var key = getPersonaStorageKey();
    console.log("System: æ­£åœ¨è°ƒå–å‘ä½ -> " + key);

    var saved = localStorage.getItem(key);
    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæ²¡å¡«è¿‡ï¼Œä¿æŒç©ºç™½ï¼Œä¸å¡«å…¥é»˜è®¤å€¼
    var data = saved ? JSON.parse(saved) : { name: "", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=placeholder", bio: "" };
    
    window.userPersona = data;

    // ç‰©ç†å¡«å€¼
    if (document.getElementById('user-avatar-pre')) document.getElementById('user-avatar-pre').src = data.avatar;
    if (document.getElementById('user-name-in')) document.getElementById('user-name-in').value = data.name;
    if (document.getElementById('user-bio-in')) document.getElementById('user-bio-in').value = data.bio;

    // å¼ºè¡Œæ˜¾å½¢å¹¶æ»‘å‡º
    var page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';
        page.style.zIndex = '999999';
        setTimeout(function() { page.classList.add('active'); }, 10);
    }
}

// 3. è¦†ç›–é¢„è§ˆèµ„æ–™å¡ï¼šå±•ç¤ºå½“å‰è§’è‰²çš„â€œæˆ‘â€
function openUserCardPreview() {
    var key = getPersonaStorageKey();
    var saved = localStorage.getItem(key);
    var data = saved ? JSON.parse(saved) : { name: "å°šæœªå®šä¹‰", avatar: "", bio: "åœ¨è¿™æ®µå› æœä¸­ï¼Œä½ å°šæœªå®šä¹‰è‡ªå·±çš„å­˜åœ¨ã€‚" };

    if (document.getElementById('user-card-avatar')) document.getElementById('user-card-avatar').src = data.avatar;
    if (document.getElementById('user-card-name')) document.getElementById('user-card-name').textContent = data.name;
    if (document.getElementById('user-card-bio')) document.getElementById('user-card-bio').textContent = data.bio;

    var modal = document.getElementById('modal-user-card');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '999999';
    }
}

// 4. è¦†ç›–ä¿å­˜é€»è¾‘ï¼šå°†èº«ä»½ä¿å­˜åˆ°å¯¹åº”çš„è§’è‰²å‘ä½
function saveUserProfile() {
    var name = document.getElementById('user-name-in').value.trim();
    var bio = document.getElementById('user-bio-in').value.trim();
    var avatar = document.getElementById('user-avatar-pre').src;

    if (!name) { alert("èµ·ä¸ªåå­—å§å®è´ï¼Œå“ªæ€•æ˜¯ä»£å·å¥¥"); return; }

    var newData = { name: name, bio: bio, avatar: avatar };
    var key = getPersonaStorageKey(); // å…³é”®ï¼šæ‹¿åˆ°å½“å‰è§’è‰²çš„ä¸“å± Key
    
    localStorage.setItem(key, JSON.stringify(newData));
    window.userPersona = newData;

    // ç‰©ç†å…³é—­
    var page = document.getElementById('subpage-user-profile');
    if (page) page.classList.remove('active');
    
    if (window.triggerSuccessHud) window.triggerSuccessHud("èº«ä»½å·²ç»‘å®šè‡³è¯¥è§’è‰²");
}

console.log("âœ… èº«ä»½éš”ç¦»åè®®å·²æ¿€æ´»ï¼šç°åœ¨æ¯ä¸ªè§’è‰²éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„â€˜æˆ‘â€™äº†ï¼");
// ==========================================
// ğŸ¨ æç®€é£æ ¼ï¼šæ–‡å­—å¤´åƒç”Ÿæˆå™¨
// ==========================================
// è¿™ä¸ªå‡½æ•°è´Ÿè´£ç°åœºæ‰‹æ“ä¸€ä¸ªå¸¦æ–‡å­—çš„ SVG å¤´åƒç»™ä½ 
function generateTextAvatarUrl(text, backgroundColor) {
    var txt = text ? text.charAt(0).toUpperCase() : "?"; // å–é¦–å­—æ¯ï¼Œæ²¡æœ‰å°±æ˜¾ç¤ºé—®å·
    var bg = backgroundColor || "#888888"; // é»˜è®¤é«˜çº§ç°åº•è‰²
    
    // ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„æ–¹å½¢SVGï¼Œä¸­é—´æ”¾ä¸ªç™½è‰²çš„å­—
    var svgRaw = '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">' +
              '<rect width="120" height="120" fill="' + bg + '"/>' +
              '<text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-weight="bold" font-size="65" fill="#ffffff">' + txt + '</text>' +
              '</svg>';
    
    // è½¬æ¢æˆæµè§ˆå™¨èƒ½è¯†åˆ«çš„æ•°æ®é“¾æ¥
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgRaw);
}


// ==========================================
// ğŸ­ èº«ä»½éš”ç¦»å¼•æ“ï¼šå¤šé‡é©¬ç”²æ ¸å¿ƒ
// ==========================================

// 1. è·å–å½“å‰è§’è‰²çš„ä¸“å±èº«ä»½å‘ä½ Key
function getPersonaStorageKey() {
    var contact = window.currentChattingWith;
    if (contact && contact.id) {
        return 'user_persona_for_' + contact.id;
    }
    return 'user_persona_data_global';
}

// 2. è¦†ç›–æ‰“å¼€ç¼–è¾‘é¡µé€»è¾‘ï¼šç²¾å‡†æå–ï¼Œé»˜è®¤æ˜¾ç¤ºæ–‡å­—å¤´åƒ
function openUserProfileEdit() {
    var key = getPersonaStorageKey();
    console.log("System: æ­£åœ¨è°ƒå–å‘ä½ -> " + key);

    var saved = localStorage.getItem(key);
    
    // ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ²¡å­˜è¿‡ï¼Œä½¿ç”¨ç°åœºç”Ÿæˆçš„â€œ?â€æ–‡å­—å¤´åƒ
    var defaultAvatar = generateTextAvatarUrl("?", "#A0A0A0"); // ç”Ÿæˆä¸€ä¸ªç°åº•é—®å·å¤´åƒ
    
    var data = saved ? JSON.parse(saved) : { name: "", avatar: defaultAvatar, bio: "" };
    
    window.userPersona = data;

    // ç‰©ç†å¡«å€¼
    var avtPre = document.getElementById('user-avatar-pre');
    if (avtPre) avtPre.src = data.avatar;
    
    if (document.getElementById('user-name-in')) document.getElementById('user-name-in').value = data.name;
    if (document.getElementById('user-bio-in')) document.getElementById('user-bio-in').value = data.bio;

    // å¼ºè¡Œæ˜¾å½¢å¹¶æ»‘å‡º
    var page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';
        page.style.zIndex = '999999';
        setTimeout(function() { page.classList.add('active'); }, 10);
    }
}

// 3. è¦†ç›–é¢„è§ˆèµ„æ–™å¡
function openUserCardPreview() {
    var key = getPersonaStorageKey();
    var saved = localStorage.getItem(key);
    
    // å¦‚æœæ²¡å®šä¹‰è¿‡ï¼Œé¢„è§ˆå¡ä¹Ÿæ˜¾ç¤ºé—®å·å¤´åƒ
    var defaultAvatar = generateTextAvatarUrl("?", "#A0A0A0");
    var data = saved ? JSON.parse(saved) : { name: "å°šæœªå®šä¹‰", avatar: defaultAvatar, bio: "åœ¨è¿™æ®µå› æœä¸­ï¼Œä½ å°šæœªå®šä¹‰è‡ªå·±çš„å­˜åœ¨ã€‚" };

    if (document.getElementById('user-card-avatar')) document.getElementById('user-card-avatar').src = data.avatar;
    if (document.getElementById('user-card-name')) document.getElementById('user-card-name').textContent = data.name;
    if (document.getElementById('user-card-bio')) document.getElementById('user-card-bio').textContent = data.bio;

    var modal = document.getElementById('modal-user-card');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '999999';
    }
}

// 4. è¦†ç›–ä¿å­˜é€»è¾‘
function saveUserProfile() {
    var name = document.getElementById('user-name-in').value.trim();
    var bio = document.getElementById('user-bio-in').value.trim();
    // æ³¨æ„ï¼šè¿™é‡Œç›´æ¥å–å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡srcï¼Œå¦‚æœä½ ä¸Šä¼ äº†æ–°å›¾ï¼Œå°±ä¼šä¿å­˜æ–°å›¾
    var avatar = document.getElementById('user-avatar-pre').src; 

    if (!name) { alert("èµ·ä¸ªåå­—å§å®è´ï¼Œå“ªæ€•æ˜¯ä»£å·å¥¥"); return; }
    
    // ğŸ’¡ å°å½©è›‹ï¼šå¦‚æœä½ æ²¡ä¸Šä¼ å›¾ç‰‡ï¼Œä¿å­˜æ—¶è‡ªåŠ¨ç”¨åå­—çš„é¦–å­—æ¯ç”Ÿæˆä¸€ä¸ªæ–°å¤´åƒ
    // å¦‚æœå½“å‰ç”¨çš„æ˜¯é»˜è®¤é—®å·å¤´åƒï¼Œä¸”ä½ å¡«äº†åå­—ï¼Œå°±ç”¨åå­—é¦–å­—æ¯é‡æ–°ç”Ÿæˆä¸€ä¸ª
    if (avatar.includes("%3F") && name) { // %3F æ˜¯ URL ç¼–ç åçš„é—®å·
         avatar = generateTextAvatarUrl(name, "#555555"); // ç”¨æ·±ç°è‰²åº• + é¦–å­—æ¯
    }

    var newData = { name: name, bio: bio, avatar: avatar };
    var key = getPersonaStorageKey();
    
    localStorage.setItem(key, JSON.stringify(newData));
    window.userPersona = newData;

    var page = document.getElementById('subpage-user-profile');
    if (page) page.classList.remove('active');
    
    if (window.triggerSuccessHud) window.triggerSuccessHud("èº«ä»½å·²ç»‘å®š");
}

// 5. å¤´åƒé¢„è§ˆï¼ˆä½ ä¹‹å‰çš„ä»£ç é‡Œå¥½åƒä¸¢äº†è¿™ä¸ªï¼Œæˆ‘ç»™ä½ è¡¥ä¸Šï¼‰
function previewUserAvatar(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('user-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

console.log("âœ… æ–‡å­—å¤´åƒå¼•æ“ & èº«ä»½éš”ç¦»åè®®å·²å…¨é¢æ¿€æ´»ï¼");
// ==========================================
// ğŸŒŒ ä¸“å±å›å¿†ï¼šå…¨èƒ½é©±åŠ¨ç³»ç»Ÿ (ä¿®å¤ ReferenceError)
// ==========================================

// 1. ã€å…¥å£ã€‘æ‰“å¼€åˆ—è¡¨å¹¶è§¦å‘æ¸²æŸ“
function openExclusiveMemories() {
    console.log("System: æ­£åœ¨è°ƒå–æ—¶ç©ºæ¡£æ¡ˆ...");
    var contact = window.currentChattingWith;
    if (!contact) {
        showToast("âš ï¸ ä¸¢å¤±è§’è‰²é“¾è·¯");
        return;
    }

    var subPage = document.getElementById('subpage-memory-list');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        subPage.style.zIndex = "15000";
        // æ¸²æŸ“åˆ—è¡¨
        renderMemoryList(contact.id);
    }
}

// 3. ã€å”¤èµ·ã€‘è¯¦æƒ…è§†ç•Œ
function openCinemaMemory(m) {
    if (!m) return;
    var modal = document.getElementById('modal-memory-cinema');
    if (!modal) return;

    // å®‰å…¨è®¾ç½®æ ‡é¢˜ï¼šå°è¯•åŒ¹é…ä½ å¯èƒ½å†™çš„ä¸¤ç§ ID
    var titleEl = document.getElementById('cinema-title-ui') || document.getElementById('cinema-title');
    if (titleEl) titleEl.textContent = m.title || "æ— åè®°å¿†";

    // å®‰å…¨è®¾ç½®æ­£æ–‡ï¼šå°è¯•åŒ¹é…ä½ å¯èƒ½å†™çš„ä¸¤ç§ ID
    var textEl = document.getElementById('cinema-text-content') || document.getElementById('cinema-text');
    if (textEl) {
        textEl.style.whiteSpace = "pre-wrap";
        textEl.textContent = m.content || "";
    }

    // å®‰å…¨è®¾ç½®å›¾ç‰‡
    var imgEl = document.getElementById('cinema-img');
    if (imgEl) imgEl.src = m.img || "";

    // å¼ºè¡Œæ˜¾ç¤º
    modal.style.display = 'flex';
    modal.style.zIndex = "1000000";
}

// 4. ã€æ ¸å¿ƒç”Ÿæˆã€‘ç»†è…»æ–‡é£ + 1000å­— + ç»ä¸é‡æ ·
// ==========================================
// ğŸŒŒ ä¸“å±å›å¿†ï¼šé‡å­å™äº‹è¶…çº§å¼•æ“ (ç‰©ç†é¿é”™ç‰ˆ)
// ==========================================

// ğŸš¨ è¿™ä¸€è¡Œæ”¾åœ¨å‡½æ•°å¤–é¢ï¼Œç”¨æ¥é˜²æ­¢ç”µè„‘å¡é¡¿ï¼ˆé˜²æŠ–é”ï¼‰
var isProcessingMemory = false;

async function triggerGenerateMemory() {
    if (window.isProcessingMemory) return;
    window.isProcessingMemory = true;

    var contact = window.currentChattingWith;
    if (!contact) {
        alert("âš ï¸ é“¾è·¯ä¸¢å¤±ï¼Œè¯·é‡æ–°è¿›å…¥èŠå¤©å®¤");
        window.isProcessingMemory = false;
        return;
    }

    var loader = document.getElementById('quantum-loader-overlay') || document.getElementById('quantum-loader');
    if (loader) loader.style.display = 'flex';

    try {
        var apiKey = localStorage.getItem('gpt_key');
        var apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        if (!apiKey) throw new Error("API Key æœªé…ç½®");

        // --- 1. å‡†å¤‡åŸºç¡€æ•°æ® ---
        var charList = await loadFromDB('char_list') || [];
        var fullChar = charList.find(c => c.id === contact.id) || contact;
        var myKey = 'user_persona_for_' + contact.id;
        var myData = JSON.parse(localStorage.getItem(myKey)) || {name:"æˆ‘", bio:""};

        // è·å–å·²æœ‰æ ‡é¢˜ç”¨äºé¿é›·
        var memories = await loadFromDB('memories_' + contact.id) || [];
        var existingTitles = memories.map(m => m.title).join('ã€');

        // ğŸš¨ ã€æ ¸å¿ƒä¿®å¤ã€‘å®šä¹‰æ„Ÿå®˜æ± ï¼Œç¡®ä¿ randomSense å­˜åœ¨
        var sensoryPool = [
            "æš´é›¨æ´—åˆ·è¿‡çš„é“è½¨ä¸é”ˆè¿¹", "æ—§ä¹¦æ¶æ­»è§’çš„ç°å°˜åœ¨è·³èˆ",
            "éš”ç€æ¯›ç»ç’ƒçœ‹åˆ°çš„æ¨¡ç³Šéœ“è™¹", "æ·±å¤œç«™å°æœ€åä¸€å¼ æŠ¥çº¸è¢«å¹èµ°",
            "æŒ‡å°–æŒ‰åœ¨å†°å†·é’¢ç´é”®ä¸Šçš„é¢¤åŠ¨", "è€å®…å‚¨ç‰©é—´é‡Œæ·¤ç§¯çš„å°˜åŸƒå‘³"
        ];
        var randomSense = sensoryPool[Math.floor(Math.random() * sensoryPool.length)];

        // ğŸ§  ã€é«˜çº§ Promptã€‘å¼ºåˆ¶è¦æ±‚å·®å¼‚åŒ–
        var prompt = `ä½ æ˜¯æ–‡å­¦å™äº‹å·¨åŒ ã€‚ä¸º[${fullChar.name}]ä¸[${myData.name}]ç¼–ç»‡ä¸€æ®µä¸“å±å›å¿†ã€‚
        ã€æ„è±¡é”šç‚¹ã€‘: "${randomSense}"
        ã€é¿é›·åå•ã€‘: ç›®å‰å·²ç»å­˜åœ¨çš„æ ‡é¢˜æœ‰ [${existingTitles || "æ— "}]ã€‚

        ã€ç¦ä»¤ã€‘:
        1. ä¸¥ç¦ä½¿ç”¨ # å·ã€* å·ã€- å·ç­‰ä»»ä½• Markdown æ ‡è®°ç¬¦å·ã€‚
        2. ä¸¥ç¦æ ‡é¢˜å‡ºç°â€œæ„Ÿå®˜ç¢ç‰‡â€æˆ–æ•°å­—ã€‚æ ‡é¢˜å¿…é¡»æå…·æ–‡å­¦ç¾æ„Ÿï¼ˆå¦‚ï¼šä½™çƒ¬ã€é›ªèŒ§ã€éœ“è™¹è€³é¸£ï¼‰ã€‚
        
        ã€å†™ä½œæŒ‡ä»¤ã€‘:
        1. è§†è§’ä¸ºç¬¬ä¸€äººç§°ï¼Œå­—æ•°800-1200å­—ã€‚
        2. æ–‡é£æåº¦ç»†è…»ã€å†·å†½ã€å……æ»¡ç”µå½±æ„Ÿã€‚
        3. ã€é‡ç‚¹ã€‘: è¯·åœ¨æ–‡ä¸­ä½¿ç”¨ä»¥ä¸‹ç¬¦å·è¿›è¡Œæ’ç‰ˆæ ‡æ³¨ï¼š
           - ä½¿ç”¨ ã€ ã€‘ åŒ…è£¹æ ¸å¿ƒçš„å…³é”®è¯æˆ–å…³é”®ç¬é—´ï¼ˆå°†æ˜¾ç¤ºä¸ºé»‘åº•ç™½å­—ï¼‰ã€‚
           - ä½¿ç”¨ ã€Œ ã€ åŒ…è£¹ç»†è…»çš„æ„Ÿå®˜ç»†èŠ‚æˆ–å¿ƒç†æå†™ï¼ˆå°†æ˜¾ç¤ºä¸ºä¸‹åˆ’çº¿åŠ ç²—ï¼‰ã€‚
        4. æ¯ä¸€æ®µè¯ä¸è¦å¤ªé•¿ï¼Œæ³¨æ„ç•™ç™½å’Œå‘¼å¸æ„Ÿã€‚
        
        æ ¼å¼ï¼š
        ã€æ ‡é¢˜ã€‘æ­¤å¤„å†™æ ‡é¢˜ï¼Œæ¯ä¸€æ¬¡ä¸èƒ½é‡å¤
        ã€æ­£æ–‡ã€‘æ­¤å¤„å†™æ­£æ–‡`;

        var res = await fetch(apiUrl + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.95,
                presence_penalty: 1.0 
            })
        });

        var data = await res.json();
        if (data.error) throw new Error(data.error.message);
        var raw = data.choices[0].message.content;

        // --- 3. è§£ææ ‡é¢˜ä¸æ­£æ–‡ ---
        var titleMatch = raw.match(/ã€æ ‡é¢˜ã€‘\s*[:ï¼š]?\s*(.*?)(?:\n|ã€æ­£æ–‡ã€‘|$)/);
        var title = (titleMatch && titleMatch[1]) ? titleMatch[1].trim() : "ç¢ç‰‡ " + Date.now();
        var content = raw.replace(/ã€æ ‡é¢˜ã€‘.*(\n|$)/, "").replace(/ã€æ­£æ–‡ã€‘\s*[:ï¼š]?\s*/, "").trim();

        // --- 4. ç‰©ç†ä¿å­˜æ•°æ® (å¼ºåˆ¶åŒæ­¥å¤´åƒ) ---
        var newMem = { 
            id: Date.now(), 
            title: title, 
            content: content, 
            img: fullChar.avatar // ğŸš¨ ç‰©ç†é”å®šï¼Œç›´æ¥ç”¨å¤´åƒ
        };

        memories.unshift(newMem);
        await saveToDB('memories_' + contact.id, memories);

        // --- 5. åŒæ­¥æ¸²æŸ“ UI ---
        await renderMemoryList(contact.id); 
        if (loader) loader.style.display = 'none';
        window.openCinemaMemory(newMem);

    } catch (e) {
        if (loader) loader.style.display = 'none';
        console.error("ç”Ÿæˆå¤±è´¥:", e);
        alert("é‡å­çº ç¼ å¤±è´¥: " + e.message);
    } finally {
        window.isProcessingMemory = false;
    }
}
window.triggerGenerateMemory = triggerGenerateMemory;
// --- ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è®°å¿†ç¢ç‰‡é€»è¾‘ (åŒæ­¥ä¿®å¤ç‰ˆ) ---
async function clearAllMemories() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    showIOSConfirm(
        "æŠ¹é™¤è®°å¿†", 
        "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ‰€æœ‰å›å¿†ç¢ç‰‡å—ï¼Ÿ", 
        "æŠ¹é™¤", 
        async function() {
            const dbKey = 'memories_' + contact.id;
            // 1. ç‰©ç†æ¸…ç©º
            await saveToDB(dbKey, []); 
            // 2. ğŸš¨ é‡ç‚¹ï¼šawait åˆ—è¡¨åˆ·æ–°
            await renderMemoryList(contact.id); 
            
            showToast("è®°å¿†å·²å½’äºè™šæ— ");
            if (window.triggerSuccessHud) triggerSuccessHud("æ¸…ç†å®Œæˆ");
        }
    );
}
// æŒ‚è½½å…¨å±€
window.clearAllMemories = clearAllMemories;

// ä¸ºäº†ç¡®ä¿ HTML é‡Œçš„ onclick="clearAllMemories()" èƒ½ç™¾åˆ†ä¹‹ç™¾æ‰¾åˆ°å®ƒ
// æˆ‘ä»¬ä¾ç„¶åœ¨å…¨å±€æ‰‹åŠ¨æŒ‚è½½ä¸€æ¬¡ï¼Œåšä¸ªåŒé‡ä¿é™©
window.clearAllMemories = clearAllMemories;
// --- ğŸï¸ æ¸²æŸ“åˆ—è¡¨å¡ç‰‡æ ¸å¿ƒ (å…·åç‰ˆ) ---
// --- ğŸï¸ æ¸²æŸ“åˆ—è¡¨å¡ç‰‡æ ¸å¿ƒ (æ”¯æŒå·¦æ»‘åˆ é™¤ç‰ˆ) ---
async function renderMemoryList(contactId) {
    console.log("System: æ­£åœ¨é‡ç»˜è®°å¿†åˆ—è¡¨å¹¶æ³¨å…¥æ»‘åŠ¨åè®®...", contactId);
    var container = document.getElementById('memory-list-container');
    if (!container) return;

    var memories = await loadFromDB('memories_' + contactId) || [];
    container.innerHTML = "";

    if (memories.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:100px 20px; color:#bbb; font-size:14px;">æ­¤é—´å°šæ— æ„Ÿå®˜ç¢ç‰‡...</div>';
        return;
    }

    memories.forEach(function(m, index) {
        // åˆ›å»ºæ»‘åŠ¨å¤–å£³
        var wrapper = document.createElement('div');
        wrapper.className = 'memory-swipe-wrapper';
        
        var displayNum = (memories.length - index).toString().padStart(2, '0');
        
        // ğŸš¨ æ ¸å¿ƒç»“æ„ï¼šæŒ‰é’®åœ¨ä¸‹ï¼Œå¡ç‰‡åœ¨ä¸Š
        wrapper.innerHTML = `
            <div class="memory-swipe-actions" onclick="deleteSingleMemory('${contactId}', ${m.id})">
                åˆ é™¤
            </div>
            <div class="memory-swipe-content memory-item-card">
                <div class="card-num">${displayNum}</div>
                <div style="position:relative; z-index:2;">
                    <span class="memory-tag" style="font-size:10px; font-weight:900; color:#007AFF; letter-spacing:2px;">FRAGMENT</span>
                    <div style="font-size:20px; font-weight:800; margin:10px 0; color:#1d1d1f;">${m.title}</div>
                    <p style="font-size:12px; color:#8e8e93; line-height:1.6;">${m.content.replace(/<[^>]+>/g, '').substring(0, 50)}...</p>
                </div>
            </div>
        `;
        
        // 1. è·å–å¡ç‰‡å†…å®¹å±‚ï¼Œå‡†å¤‡ç»‘å®šæ»‘åŠ¨äº‹ä»¶
        var contentEl = wrapper.querySelector('.memory-swipe-content');
        
        // 2. ç»‘å®šç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… (æ³¨æ„è¿™é‡Œç‚¹çš„æ˜¯ contentEl)
        contentEl.onclick = function() {
            // å¦‚æœå¡ç‰‡æ²¡è¢«æ»‘å¼€ï¼Œæ‰æ‰§è¡Œæ‰“å¼€é€»è¾‘
            if(contentEl.style.transform === "translateX(0px)" || !contentEl.style.transform) {
                window.openCinemaMemory(m);
            } else {
                // å¦‚æœæ»‘å¼€äº†ï¼Œç‚¹ä¸€ä¸‹å°±æ”¶å›å»
                contentEl.style.transform = "translateX(0px)";
            }
        };

        // 3. å¤ç”¨ä½ å·²æœ‰çš„æ»‘åŠ¨ç›‘å¬å¼•æ“
        // ğŸš¨ æ³¨æ„ï¼šå› ä¸ºä½ çš„ initSwipeEvents é‡Œçš„é˜ˆå€¼æ˜¯ -150ï¼Œæˆ‘ä»¬è¦å¾®è°ƒä¸€ä¸‹è¿™ä¸ªå…·ä½“çš„å¡ç‰‡
        initSwipeEvents(contentEl); 
        
        container.appendChild(wrapper);
    });
}
window.renderMemoryList = renderMemoryList;
// --- ğŸ—‘ï¸ ç²¾å‡†æŠ¹é™¤å•æ¡è®°å¿†ç¢ç‰‡ ---
async function deleteSingleMemory(contactId, memoryId) {
    // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»
    if(event) event.stopPropagation();

    showIOSConfirm(
        "æŠ¹é™¤ç‰‡æ®µ", 
        "ç¡®å®šè¦å°†è¿™æ®µç‰¹å®šçš„æ„Ÿå®˜ç¢ç‰‡æ°¸ä¹…ç‰©ç†éš”ç¦»å—ï¼Ÿ", 
        "æŠ¹é™¤", 
        async function() {
            // 1. è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰è®°å¿†
            var memories = await loadFromDB('memories_' + contactId) || [];
            
            // 2. è¿‡æ»¤æ‰è¦åˆ é™¤çš„é‚£ä¸€æ¡ (æ ¹æ® ID åŒ¹é…)
            var updatedMemories = memories.filter(function(m) {
                return m.id !== memoryId;
            });
            
            // 3. å­˜å›æ•°æ®åº“
            await saveToDB('memories_' + contactId, updatedMemories);
            
            // 4. ç«‹å³åŒæ­¥é‡ç»˜åˆ—è¡¨
            await renderMemoryList(contactId);
            
            showToast("ç¢ç‰‡å·²é”€æ¯");
            if (window.triggerSuccessHud) triggerSuccessHud("æ¸…ç†å®Œæˆ");
        }
    );
}
window.deleteSingleMemory = deleteSingleMemory;
// ==========================================
// ğŸ§  è®°å¿†æ€»ç»“ç®¡ç†åè®® (å…·åå‡½æ•°ç‰ˆ)
// ==========================================

// 1. ã€å…¥å£ã€‘æ‰“å¼€è®°å¿†æ€»ç»“é¡µé¢
async function openMemorySummary() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const subPage = document.getElementById('subpage-memory-summary');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        
        // 1. åŠ è½½æ»‘å—ä½ç½®
        const savedRounds = localStorage.getItem('summary_rounds_' + contact.id) || "10";
        const slider = document.getElementById('summary-rounds-slider');
        if (slider) {
            slider.value = savedRounds;
            window.updateSummarySlider(savedRounds);
        }

        // ğŸš¨ 2. æ ¸å¿ƒä¿®å¤ï¼šæ‰“å¼€é¡µé¢æ—¶å¼ºåˆ¶æ¸²æŸ“æ‰€æœ‰å·²æœ‰çš„æ€»ç»“å¡ç‰‡
        await window.renderSummaryCards(contact.id);
    }
}
window.openMemorySummary = openMemorySummary;

// 2. ã€åé¦ˆã€‘æ»‘åŠ¨æ¡å®æ—¶æ›´æ–°
function updateSummarySlider(val) {
    const display = document.getElementById('summary-rounds-val');
    const slider = document.getElementById('summary-rounds-slider');
    if (display) display.textContent = val;
    
    // æ›´æ–°æ»‘åŠ¨æ¡çš„é»‘è‰²è¿›åº¦æ¡é•¿åº¦
    if (slider) {
        const percent = ((val - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.setProperty('--percent', percent + '%');
    }
}
window.updateSummarySlider = updateSummarySlider;

// 3. ã€ä¿å­˜ã€‘æŒä¹…åŒ–è®¾ç½®
async function saveSummarySettings() {
    const contact = window.currentChattingWith;
    const val = document.getElementById('summary-rounds-slider').value;
    
    if (contact) {
        // å°†è®¾ç½®ç»‘å®šåˆ°å…·ä½“è§’è‰²
        localStorage.setItem('summary_rounds_' + contact.id, val);
        showToast("æ€»ç»“åè®®å·²ç”Ÿæ•ˆ");
        if (window.triggerSuccessHud) triggerSuccessHud("åè®®æ›´æ–°");
        closeSubPage('subpage-memory-summary');
    }
}
window.saveSummarySettings = saveSummarySettings;

// 4. ã€æ‰‹åŠ¨ã€‘è§¦å‘å³æ—¶æ€»ç»“é€»è¾‘ (é¢„ç•™ç»™ AI è°ƒç”¨çš„æ¥å£)
async function manualTriggerSummary() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    showToast("æ­£åœ¨æå–é‡å­è®°å¿†...");
    
    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        // 1. æŠ“å–æœ€è¿‘çš„èŠå¤©è®°å½•
        const history = await getChatHistory(contact.id);
        if (history.length < 5) {
            showToast("å¯¹è¯å¤ªçŸ­ï¼Œä¸è¶³ä»¥å½¢æˆè®°å¿†");
            return;
        }

        const chatContext = history.slice(-30).map(m => `${m.role}: ${m.text}`).join('\n');

        // 2. å‘ AI å‘èµ·æ€»ç»“è¯·æ±‚
        const prompt = `ä½ æ˜¯ä¸€ä¸ªè®°å¿†æå–å™¨ã€‚è¯·åˆ†æä»¥ä¸‹å¯¹è¯ï¼Œæå–å‡º [${contact.name}] ä¸ç”¨æˆ·ä¹‹é—´æœ€é‡è¦çš„å…³ç³»è¿›å±•ã€çº¦å®šçš„äº‹å®æˆ–æ·±åˆ»çš„æƒ…ç»ªè½¬æŠ˜ç‚¹ã€‚
        ã€è¦æ±‚ã€‘ï¼š
        1. è¯­æ°”ç®€ç»ƒï¼Œåƒç§äººç¬”è®°ã€‚
        2. å­—æ•°æ§åˆ¶åœ¨ 100 å­—ä»¥å†…ã€‚
        3. ä¸¥ç¦åºŸè¯ï¼Œç›´æ¥è¾“å‡ºæ€»ç»“å†…å®¹ã€‚
        
        å¯¹è¯å†…å®¹ï¼š
        ${chatContext}`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7
            })
        });

        const data = await res.json();
        const summaryText = data.choices[0].message.content.trim();

        // 3. ç‰©ç†ä¿å­˜
        let summaries = await loadFromDB('summaries_' + contact.id) || [];
        summaries.unshift({ timestamp: Date.now(), text: summaryText });
        await saveToDB('summaries_' + contact.id, summaries);

        // 4. åˆ·æ–° UI
        await renderSummaryCards(contact.id);
        triggerSuccessHud("æ ¸å¿ƒè®°å¿†å·²åç¼©");

    } catch (e) {
        showToast("æ€»ç»“å¤±è´¥");
        console.error(e);
    }
}
window.manualTriggerSummary = manualTriggerSummary;

async function renderSummaryCards(contactId) {
    const container = document.getElementById('summary-cards-container');
    if (!container) return;

    // ä»æ•°æ®åº“è¯»å–æ€»ç»“åˆ—è¡¨
    const summaries = await loadFromDB('summaries_' + contactId) || [];
    container.innerHTML = "";

    if (summaries.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc; font-size:12px; border:1px dashed #ddd; border-radius:15px;">å°šæ— æ ¸å¿ƒè®°å¿†è¢«æ•è·</div>';
        return;
    }

    summaries.forEach((s, index) => {
        const card = document.createElement('div');
        card.className = 'summary-card';
        card.innerHTML = `
            <span class="summary-date">${new Date(s.timestamp).toLocaleString()}</span>
            <div class="summary-content">${s.text}</div>
            <div class="btn-delete-summary" onclick="deleteSummary('${contactId}', ${s.timestamp})">æŠ¹é™¤</div>
        `;
        container.appendChild(card);
    });
}
window.renderSummaryCards = renderSummaryCards;

// ==========================================
// ğŸš€ å›¾æ ‡å·¥åŠï¼šæ ‡å‡† Function é£æ ¼å¼•æ“
// ==========================================

// 1. å…¨å±€æ•°æ®
var currentIconTarget = null;
var tempIconData = null;
var iconDb = null;

// ==========================================
// ğŸš€ ç»ˆæç‰©ç†è¦†ç›–å¼•æ“ï¼šè§£å†³åˆ·æ–°â€œé—ªå›â€åŸæ ·é—®é¢˜
// ==========================================

var iconDb = null;

// 1. åˆå§‹åŒ–æ•°æ®åº“ï¼šå¼€å¯å³æ¸²æŸ“
function initDatabase() {
    var request = indexedDB.open("IconSystemDB", 1);
    
    request.onupgradeneeded = function(e) {
        var db = e.target.result;
        if (!db.objectStoreNames.contains("icons")) {
            db.createObjectStore("icons", { keyPath: "name" });
        }
    };

    request.onsuccess = function(e) {
        iconDb = e.target.result;
        console.log("System: æ•°æ®åº“é“¾æ¥æˆåŠŸï¼Œæ‰§è¡Œåˆå§‹åŒ–å¼ºåˆ¶æ¸²æŸ“");
        
        // ğŸš¨ æ ¸å¿ƒï¼šæ•°æ®åº“é“¾æ¥æˆåŠŸç¬é—´ï¼Œæ‰§è¡Œç‰©ç†è¦†ç›–
        applyAllCustomIcons();
    };
}

// 2. ç‰©ç†çº§æ¸²æŸ“å¼•æ“ï¼šå¼ºåˆ¶æ“¦é™¤é»˜è®¤æ ·å¼
function applyAllCustomIcons() {
    if (!iconDb) return;

    var transaction = iconDb.transaction("icons", "readonly");
    var store = transaction.objectStore("icons");
    var request = store.getAll();

    request.onsuccess = function(e) {
        var savedData = e.target.result;
        if (!savedData || savedData.length === 0) return;

        var iconMap = {};
        savedData.forEach(function(item) { iconMap[item.name] = item.data; });

        // 3. æ‰«ææ‰€æœ‰æ½œåœ¨ç›®æ ‡ (æ¡Œé¢ App ä¸ Dock æ )
        var allTargets = document.querySelectorAll('.app-cell, .dock-app');
        
        allTargets.forEach(function(app) {
            // èº«ä»½è¯†åˆ«ä¼˜å…ˆçº§
            var name = app.getAttribute('data-app');
            if (!name) {
                var nameEl = app.querySelector('.app-name');
                name = nameEl ? nameEl.textContent.trim() : "";
            }
            if (!name) {
                var act = app.getAttribute('onclick') || "";
                if (act.includes('charApp')) name = "RoleBook";
                if (act.includes('worldApp')) name = "WorldBook";
                if (act.includes('beautifyApp')) name = "Beautify";
                if (act.includes('iconApp')) name = "Icons";
            }

            // 4. å‘½ä¸­çš„å›¾æ ‡æ‰§è¡Œã€ç‰©ç†ç ´åæ€§ã€‘æ›¿æ¢
            if (name && iconMap[name]) {
                var box = app.querySelector('.icon-shape') || 
                          app.querySelector('.glass-icon-bg') || 
                          app;

                // ğŸš¨ å¼ºåˆ¶é‡ç½®æ ·å¼ï¼šç‰©ç†ç§»é™¤èƒŒæ™¯æ¸å˜ï¼Œæ³¨å…¥ !important æ ·å¼
                box.style.cssText = "background: transparent !important; box-shadow: none !important; border: none !important; overflow: hidden !important;";
                
                // æ³¨å…¥å›¾ç‰‡ï¼šå¢åŠ  onload ç›‘å¬ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œåå†éšè— SVG
                box.innerHTML = '<img src="' + iconMap[name] + '" style="width:100%; height:100%; object-fit:cover; border-radius:inherit; display:block;">';
                
                console.log("Fixed: ç‰©ç†è¦†ç›–æˆåŠŸ -> " + name);
            }
        });
    };
}

// 5. å¯åŠ¨å…¥å£ï¼šå¤šæ—¶æœºç‰©ç†è§¦å‘
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDatabase);
} else {
    initDatabase();
}

// é’ˆå¯¹æ‰‹æœºç«¯æ»‘åŠ¨è¿”å›ã€å”¤é†’æ—¶çš„ç¼“å­˜é—®é¢˜ï¼Œæ‰§è¡Œå¼ºåˆ¶åˆ·æ–°æ¸²æŸ“
window.addEventListener('pageshow', function() {
    if (iconDb) applyAllCustomIcons();
});

// ğŸš¨ ç»ˆæç»æ‹›ï¼šå¦‚æœä½ çš„é¡µé¢æœ‰å¤æ‚çš„åŠ¨æ€åŠ è½½ï¼Œå¼€å¯è¿™ä¸ªè§‚å¯Ÿå™¨
var observer = new MutationObserver(function() {
    if (iconDb) applyAllCustomIcons();
});
observer.observe(document.body, { childList: true, subtree: true });

// 3. å”¤èµ·é€‰æ‹©å™¨
function openIconTargetPicker() {
    var list = document.getElementById('icon-target-list');
    var subPage = document.getElementById('subpage-icon-picker');
    if (!list || !subPage) return;

    // ğŸš¨ ç‰©ç†è¡¥å…¨ï¼šç¡®ä¿æ‰€æœ‰ App éƒ½åœ¨åå•é‡Œ
    var apps = [
        "Wallpaper", "Settings", "Chat", "Photos", 
        "Music", "Themes", "Phone", "Messages", 
        "Beautify", "Icons", "Diary", "Wallet", 
        "Notes", "Shopping", "Forum", "Novels", "Live",
        "RoleBook", "WorldBook" // ğŸ‘ˆ è¡¥ä¸Šäº†ï¼
    ];
    
    list.innerHTML = apps.map(function(name) {
        return '<div class="ios-list-item" onclick="confirmIconTarget(\'' + name + '\')">' +
               '<div class="item-content"><span class="item-label">' + name + '</span></div></div>';
    }).join('');
    
    subPage.classList.add('active');
}

// 4. ç¡®è®¤é€‰æ‹© (é‡ç‚¹ä¿®å¤ï¼šç¡®ä¿å®ƒæ˜¯å…¨å±€ function)
function confirmIconTarget(name) {
    currentIconTarget = name;
    var display = document.getElementById('val-icon-target');
    if (display) display.textContent = name;
    
    var subPage = document.getElementById('subpage-icon-picker');
    if (subPage) subPage.classList.remove('active');
}

// 5. å¤„ç†æ–‡ä»¶é¢„è§ˆ (è§£å†³ handleIconFile æŠ¥é”™)
function handleIconFile(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            tempIconData = e.target.result;
            var img = document.getElementById('icon-pre-img');
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById('icon-pre-placeholder').style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 6. ä¿å­˜å¹¶åŒæ­¥ (IndexedDB æ¨¡å¼ï¼Œä¸é™å¤§å°)
function saveIconCustomization() {
    // 1. ç‰©ç†æ£€æŸ¥ï¼šå¦‚æœå…¨å±€å˜é‡ä¸¢äº†ï¼Œç›´æ¥ä» UI æ ‡ç­¾é‡Œç°æŠ“
    if (!window.currentIconTarget) {
        var label = document.getElementById('val-icon-target');
        if (label && label.textContent !== "è¯·é€‰æ‹©...") {
            window.currentIconTarget = label.textContent.trim();
        }
    }

    // 2. é¢„è§ˆå›¾è¡¥å¿ï¼šå¦‚æœå›¾ç‰‡å˜é‡ä¸¢äº†ï¼Œç›´æ¥ä» img æ ‡ç­¾é‡Œç°æŠ“
    if (!window.tempIconData) {
        var img = document.getElementById('icon-pre-img');
        if (img && img.src && img.style.display !== 'none') {
            window.tempIconData = img.src;
        }
    }

    // 3. æ•°æ®åº“çŠ¶æ€æ£€æŸ¥
    if (!iconDb) {
        console.warn("System: æ•°æ®åº“æœªå°±ç»ªï¼Œå°è¯•é‡è¿...");
        initDatabase(); 
        alert("ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–å­˜å‚¨ç©ºé—´ï¼Œè¯·å†ç‚¹ä¸€æ¬¡ä¿å­˜");
        return;
    }

    // 4. ç²¾å‡†æŠ¥é”™æç¤º (å‘Šè¯‰ä½ åˆ°åº•æ˜¯å“ªé‡Œæ²¡å¼„å¥½)
    if (!window.currentIconTarget || !window.tempIconData) {
        var errorMsg = "ä¿å­˜å¤±è´¥åŸå› ï¼š\n";
        errorMsg += (!window.currentIconTarget ? "- ç›®æ ‡ App åå­—æ²¡æ‹¿åˆ°\n" : "");
        errorMsg += (!window.tempIconData ? "- å›¾æ ‡å›¾ç‰‡æ•°æ®ä¸¢å¤±\n" : "");
        alert(errorMsg + "\nè¯·é‡æ–°é€‰æ‹©æˆ–ä¸Šä¼ è¯•è¯•");
        return;
    }

    // 5. æ‰§è¡Œä¿å­˜æµç¨‹
    try {
        var tx = iconDb.transaction("icons", "readwrite");
        var store = tx.objectStore("icons");
        store.put({ name: window.currentIconTarget, data: window.tempIconData });
        
        tx.oncomplete = function() {
            applyAllCustomIcons(); // ç«‹å³åˆ·æ–°å…¨ç«™å›¾æ ‡
            if (window.triggerSuccessHud) triggerSuccessHud("å…¨åŸŸå›¾æ ‡å·²åŒæ­¥");
            setTimeout(function() { closeApp('iconApp'); }, 800);
        };
        
        tx.onerror = function(e) {
            console.error("Database Error:", e);
            alert("æ•°æ®åº“å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°");
        };
    } catch (err) {
        console.error("Save Logic Crash:", err);
        alert("ä¿å­˜é€»è¾‘å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢");
    }
}

// ç‰©ç†å¯åŠ¨
initDatabase();
// æŠŠè¿™ä¸ªæ”¾è¿›ä½ çš„ JS é€»è¾‘é‡Œ
function triggerFileSelect() {
    var input = document.getElementById('icon-file-input');
    if (input) {
        input.click();
    } else {
        console.error("System: æ²¡æ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ï¼Œè¯·æ£€æŸ¥ HTML ID æ˜¯å¦å¯¹é½");
    }
}
</script>
</body>
</html>
