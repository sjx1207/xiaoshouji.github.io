<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iOS Pro Ultimate Persistent</title>
    <style>
        :root {
            /* èƒŒæ™¯ï¼šæ›´æ¸…é€çš„æå…‰è“ */
            --bg-gradient: linear-gradient(160deg, #a1fdd4 0%, #c2fbe5 100%);
            --glass: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.5);
            --blur: saturate(180%) blur(40px);
            --text-main: #1d1d1f;
            --text-sub: #555;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            width: 100%; height: 100vh; overflow: hidden; 
            background: var(--bg-gradient); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
            display: flex; flex-direction: column;
        }

        /* 1. çŠ¶æ€æ  (å±‚çº§è°ƒåˆ°æœ€é«˜ï¼Œä¿è¯ App æ‰“å¼€æ—¶å®ƒè¿˜åœ¨æœ€ä¸Šé¢) */
        .status-bar {
            height: 48px; padding: 0 24px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--text-main); font-weight: 600; font-size: 15px; 
            z-index: 9999; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šå±‚çº§æœ€é«˜ */
            position: relative; /* ç¡®ä¿ z-index ç”Ÿæ•ˆ */
        }
        .status-right { display: flex; align-items: center; gap: 6px; }
        .bat-text { font-size: 13px; font-weight: 700; margin-right: 4px; }
        .battery-box { width: 25px; height: 12px; border: 1.5px solid var(--text-main); border-radius: 3px; padding: 1px; position: relative; opacity: 0.8; }
        .bat-fill { height: 100%; background: var(--text-main); border-radius: 1px; width: 60%; }
        .bat-tip { position: absolute; right: -3px; top: 2.5px; width: 2px; height: 3px; background: var(--text-main); border-radius: 0 2px 2px 0; }

        /* 2. æ ¸å¿ƒå¸ƒå±€ */
        .main-container {
            flex: 1; 
            padding: 10px 22px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 2.3fr 1fr 0.7fr 1.1fr 1.1fr; 
            gap: 16px;
            align-items: center;
        }

        /* é€šç”¨å¡ç‰‡ */
        .widget {
            background: var(--glass);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        /* å¢åŠ ç»ç’ƒé«˜å…‰ï¼Œæ˜¾å¾—æ›´é«˜çº§ */
        .widget::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .w-2x2 { grid-column: span 2; }
        .w-4x1 { grid-column: span 4; }

        /* å¤©æ°”ç»„ä»¶ */
        .weather-content { display: flex; flex-direction: column; height: 100%; justify-content: space-between; position: relative; z-index: 2; }
        .w-date-block { display: flex; flex-direction: column; }
        .w-day { font-size: 11px; font-weight: 800; color: #ff3b30; text-transform: uppercase; margin-bottom: 2px; }
        .w-date { font-size: 13px; font-weight: 600; color: #555; text-transform: uppercase; }
        .w-icon-area { width: 60px; height: 60px; margin: 5px 0 0 -5px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .w-temp { font-size: 42px; font-weight: 800; color: #1d1d1f; line-height: 1; letter-spacing: -2px; }
        .w-city { font-size: 13px; font-weight: 600; color: #666; margin-top: 4px; display: flex; align-items: center; gap:4px; }

        /* å›¾ç‰‡ç»„ä»¶ */
        .pic-container { height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }
        .pic-text { font-size: 14px; font-weight: 700; font-style: italic; color: #222; margin-bottom: 10px; line-height: 1.3; }
        .pic-wrapper { flex: 1; width: 100%; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.05); position: relative; }
        .pic-img { width: 100%; height: 100%; object-fit: cover; }

        /* éŸ³ä¹ç»„ä»¶ */
        .music-row { display: flex; align-items: center; justify-content: space-between; height: 100%; position: relative; z-index: 2; }
        .album-cover { width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .track-info { display: flex; flex-direction: column; margin-left: 14px; margin-right: auto; justify-content: center; }
        .track-title { font-size: 15px; font-weight: 700; color: #1d1d1f; }
        .track-artist { font-size: 12px; color: #666; margin-top: 3px; }
        .ctrl-btns { display: flex; gap: 16px; align-items: center; flex-shrink: 0; opacity: 0.8; }

        /* === ä¿®å¤é‡ç‚¹ï¼šè¿›åº¦æ¡ === */
        .prog-stack { display: flex; flex-direction: column; justify-content: center; height: 100%; gap: 10px; position: relative; z-index: 2; }
        .prog-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: #444; text-transform: uppercase; }
        
        /* è½¨é“ï¼šæ·±è‰²åŠé€æ˜ï¼Œç¡®ä¿å¯¹æ¯”åº¦ */
        .prog-bg { 
            width: 100%; height: 14px; 
            background: rgba(0,0,0,0.15); 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        /* å¡«å……ï¼šçº¯ç™½ + å‘å…‰ */
        .prog-fg { 
            height: 100%; 
            background: #057b46; 
            width: 0%; 
            transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); 
            box-shadow: 0 0 15px rgba(255,255,255,0.8); /* å…³é”®ï¼šç™½è‰²å‘å…‰ */
            border-radius: 20px;
        }

        /* App å›¾æ ‡ - ä¼˜åŒ–è´¨æ„Ÿï¼Œå»é™¤å»‰ä»·å‘å…‰ */
        .app-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 8px; }
        .icon-shape { 
            width: 60px; height: 60px; border-radius: 16px; 
            background: rgba(255,255,255,0.85); 
            /* æ›´åƒå®ä½“ç»ç’ƒçš„é˜´å½± */
            box-shadow: 0 4px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,1);
            display: flex; align-items: center; justify-content: center; color: #333;
            backdrop-filter: blur(10px);
        }
        .app-name { font-size: 11px; font-weight: 600; color: #1d1d1f; text-shadow: 0 1px 1px rgba(255,255,255,0.5); }
        .svg-icon { width: 30px; height: 30px; fill: currentColor; }

        /* === ä¿®å¤é‡ç‚¹ï¼šDock & å°ç™½æ¡ === */
        .dock-container { 
            flex-shrink: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-end; 
            padding-bottom: 30px; /* ç»™å°ç™½æ¡ç•™ä½ç½® */
            position: relative; z-index: 50;
        }
        .dock-bar { 
            width: 90%; max-width: 380px; height: 85px; 
            background: rgba(255,255,255,0.4); 
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 42px; 
            display: flex; align-items: center; justify-content: space-evenly; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }
        .dock-app { width: 58px; height: 58px; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* å¼ºåˆ¶æ˜¾å½¢çš„å°ç™½æ¡ */
        .home-indicator { 
            position: absolute; 
            bottom: 8px; /* è·ç¦»åº•éƒ¨ 8px */
            left: 50%; transform: translateX(-50%);
            width: 135px; height: 5px; 
            background: #ffffff; /* çº¯ç™½ */
            border-radius: 10px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            z-index: 9999; /* æœ€é¡¶å±‚ */
            display: block !important;
        }

        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: flex-end; }
        .modal-content { width: 100%; background: #fff; border-radius: 36px 36px 0 0; padding: 25px; padding-bottom: 50px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from {transform:translateY(100%)} to {transform:translateY(0)} }
        .modal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-h1 { font-size: 18px; font-weight: 700; }
        .modal-done { color: #007AFF; font-weight: 700; cursor: pointer; }
        /* --- iOS åˆ†æ®µæ§åˆ¶å™¨æ ·å¼ --- */
.segment-control {
    display: flex;
    background: #eeeeef;
    padding: 3px;
    border-radius: 12px;
    margin-bottom: 15px;
}

.segment-btn {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #636366;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.segment-btn.active {
    background: #ffffff;
    color: #000000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.12);
}

/* --- è§†å›¾åˆ‡æ¢é€»è¾‘ --- */
.city-view {
    display: none; /* é»˜è®¤éšè— */
    animation: fadeIn 0.3s ease;
}

.city-view.active {
    display: block; /* æ¿€æ´»æ—¶æ˜¾ç¤º */
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
        .city-tag { padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; }
        .upload-tools { display: flex; gap: 10px; margin-top: 10px; }
        .tool-btn { flex: 1; padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; color: #007AFF; font-weight: 600; cursor: pointer; }


    /* --- App Window (å…¨å±åº”ç”¨æ¨¡å¼) --- */
.ios-app-window {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #F2F2F7; 
    z-index: 5000; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šæ¯”çŠ¶æ€æ ä½ï¼Œæ¯”æ¡Œé¢é«˜ */
    display: flex; flex-direction: column;
    transform: translateX(100%); 
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    padding-top: 48px; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šç»™çŠ¶æ€æ ç•™å‡ºä½ç½® */
}
.ios-app-window.active { transform: translateX(0); }

/* App Header */
.app-header {
    height: 60px; padding: 0 24px; 
    display: flex; align-items: center; justify-content: space-between;
    background: transparent; /* é€æ˜èƒŒæ™¯ï¼Œæ›´ç°ä»£ */
    flex-shrink: 0;
}
.header-title-big { 
    font-size: 32px; font-weight: 800; color: #000; letter-spacing: -0.5px; 
}
.header-close-btn {
    width: 36px; height: 36px; background: #e5e5ea; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #8e8e93; cursor: pointer;
    font-weight: 700; font-size: 14px;
}
.header-left { display: flex; align-items: center; color: #007AFF; font-size: 16px; cursor: pointer; }
.header-title { font-weight: 600; font-size: 16px; color: #000; }
.header-right { width: 60px; } /* å ä½ */

/* App Body */
.app-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
.app-title-large { font-size: 28px; font-weight: 800; color: #000; align-self: flex-start; margin-bottom: 10px; }

/* é¢„è§ˆæ¡† (æ‰‹æœºæ¯”ä¾‹) */
.preview-stage {
    width: 200px; height: 400px; 
    background: #fff; border-radius: 24px;
    /* é‡ç‚¹ï¼šå±…ä¸­å¸ƒå±€ï¼Œé˜²æ­¢å†…å®¹ä¹±è·‘ */
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    border: 8px solid #fff;
    margin-bottom: 30px;
    overflow: hidden;
    position: relative;
    flex-shrink: 0;
}
.phone-frame { width: 100%; height: 100%; position: relative; }
/* å…³é”®ï¼šé»˜è®¤å…¨éƒ¨éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
.phone-frame img, .phone-frame video { 
    width: 100%; height: 100%; object-fit: cover; display: none; 
}
.preview-placeholder {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: #999; font-weight: 600; font-size: 14px; width: 100%; text-align: center;
}

/* æŒ‰é’®ç»„ */
.action-area { width: 100%; display: flex; flex-direction: column; gap: 12px; }
.ios-btn {
    width: 100%; padding: 16px; border-radius: 14px; border: none;
    font-size: 16px; font-weight: 700; cursor: pointer;
    transition: transform 0.1s;
}
.ios-btn:active { transform: scale(0.98); }
.ios-btn.primary { background: #007AFF; color: #fff; }
.ios-btn.secondary { background: #fff; color: #007AFF; }

/* Toast æç¤º */
.ios-toast {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    background: rgba(25,25,25,0.8); backdrop-filter: blur(10px);
    color: #fff; padding: 20px 40px; border-radius: 20px;
    font-weight: 600; opacity: 0; pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 1000;
}
.ios-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

/* 4. å£çº¸å†å²è®°å½• (æ–°å¢æ ·å¼) */
.history-section { padding: 0 20px 40px 20px; width: 100%; }
.history-title { font-size: 18px; font-weight: 700; color: #000; margin: 30px 0 15px 0; }
.history-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
}
.history-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 9/16; background: #eee; cursor: pointer; }
.history-item.active { border-color: #007AFF; }
.history-item img { width: 100%; height: 100%; object-fit: cover; }
.vid-badge {
    position: absolute; top: 6px; right: 6px;
    background: rgba(0,0,0,0.6); color: #fff;
    font-size: 9px; font-weight: 800; padding: 2px 6px;
    border-radius: 4px; backdrop-filter: blur(4px);
    border: 0.5px solid rgba(255,255,255,0.3);
}
.history-del {
    position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
    background: rgba(255, 59, 48, 0.9); border-radius: 50%; color: #fff;
    display: flex; align-items: center; justify-content: center; font-size: 12px;
}
/* --- 3. iOS é£æ ¼æˆåŠŸå¼¹çª— (Alert) --- */
.ios-alert-mask {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
    z-index: 10000; /* æœ€é«˜å±‚çº§ */
    display: none; align-items: center; justify-content: center;
    animation: fadeIn 0.2s;
}
.ios-alert-box {
    width: 270px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
    border-radius: 14px; text-align: center; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: scale(1.1); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
.alert-title { font-size: 17px; font-weight: 700; margin: 20px 0 5px 0; color: #000; }
.alert-msg { font-size: 13px; color: #000; padding: 0 15px 20px 15px; line-height: 1.4; }
.alert-btn { 
    border-top: 0.5px solid rgba(60,60,67,0.29); 
    padding: 12px; color: #007AFF; font-size: 17px; font-weight: 600; cursor: pointer;
}
.alert-btn:active { background: rgba(0,0,0,0.05); }

@keyframes popIn { to { transform: scale(1); } }
/* --- è§’è‰²ä¹¦ä¸“ç”¨æ ·å¼ --- */

/* 1. è§’è‰²åˆ—è¡¨ç½‘æ ¼ */
.char-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
.char-card {
    background: #fff; border-radius: 16px; overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
    transition: transform 0.2s; cursor: pointer;
}
.char-card:active { transform: scale(0.96); }
.char-card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
.char-card-info { padding: 12px; }
.char-card-name { font-weight: 700; font-size: 15px; color: #000; margin-bottom: 4px; }
.char-card-desc { font-size: 11px; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* 2. è¯¦æƒ…é¡µè§†å›¾ (è¦†ç›–åœ¨åˆ—è¡¨ä¸Š) */
.char-detail-view {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 10; display: none; flex-direction: column; overflow-y: auto;
    animation: slideInRight 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes slideInRight { from {transform: translateX(100%);} to {transform: translateX(0);} }

/* é¡¶éƒ¨èƒŒæ™¯å›¾ */
.char-hero-bg {
    width: 100%; height: 240px; background-color: #ddd; background-size: cover; background-position: center;
    position: relative; flex-shrink: 0; cursor: pointer;
}
.bg-hint {
    position: absolute; bottom: 10px; right: 10px; 
    background: rgba(0,0,0,0.5); color: #fff; font-size: 10px; 
    padding: 4px 8px; border-radius: 12px; backdrop-filter: blur(4px);
}

/* å†…å®¹å®¹å™¨ (å¤„ç†å¤´åƒé‡å ) */
.char-content {
    background: #fff; flex: 1; border-radius: 24px 24px 0 0;
    margin-top: -30px; /* å…³é”®ï¼šè´Ÿè¾¹è·å®ç°é‡å  */
    position: relative; padding: 0 20px 40px 20px;
}

/* è¯¦æƒ…å¤´åƒ */
.char-avatar-container {
    width: 110px; height: 110px; /*ç¨å¾®æ”¹å¤§ä¸€ç‚¹ç‚¹æ›´éœ¸æ°”*/
    border-radius: 50%; 
    border: 4px solid #fff; 
    background: #fff;
    position: absolute; 
    top: -55px; /* ä¸Šæµ®è·ç¦» */
    
    /* ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šæ°´å¹³å±…ä¸­ä¸‡èƒ½å…¬å¼ */
    left: 50%;
    transform: translateX(-50%); 
    
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
    overflow: hidden;
    z-index: 5;
}
#detail-avatar { width: 100%; height: 100%; object-fit: cover; }

/* è¯¦æƒ…ä¿¡æ¯ */
.char-info-block { 
    margin-top: 65px; /* ç•™å‡ºå¤´åƒçš„ä½ç½® */
    display: flex; 
    flex-direction: column; 
    align-items: center; /* è®©åå­—ã€ç®€ä»‹ã€æŒ‰é’®å…¨éƒ¨å±…ä¸­ */
    text-align: center;  /* è®©æ–‡å­—å±…ä¸­å¯¹é½ */
}

.char-name { 
    font-size: 28px; 
    font-weight: 800; 
    color: #000; 
    margin-bottom: 12px; 
    letter-spacing: -0.5px;
}

.char-desc-preview {
    font-size: 15px; 
    line-height: 1.6; 
    color: #555; 
    background: #f2f2f7; 
    padding: 16px 20px; 
    border-radius: 18px;
    cursor: pointer;
    text-align: left; /* ç®€ä»‹å†…å®¹è¿˜æ˜¯é å·¦è¯»èµ·æ¥æ¯”è¾ƒèˆ’æœï¼Œæˆ–è€…æ”¹æˆ center ä¹Ÿå¯ä»¥ */
    width: 100%;      /* æ’‘æ»¡å®½åº¦ */
    max-width: 320px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå®½éš¾çœ‹ */
}

/* æŒ‰é’®ç»„å±…ä¸­ */
.char-actions { 
    display: flex; 
    gap: 12px; 
    margin-top: 30px; 
    width: 100%;
    justify-content: center; /* æŒ‰é’®æ°´å¹³å±…ä¸­ */
}

/* æ‚¬æµ®è¿”å›æŒ‰é’® */
.floating-back {
    position: absolute; top: 50px; left: 20px; width: 40px; height: 40px;
    background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; z-index: 20;
    color: #000;
}

/* 3. ä¸Šä¼ ç›¸å…³ */
.char-upload-circle {
    width: 80px; height: 80px; border-radius: 50%; background: #f2f2f7;
    display: flex; align-items: center; justify-content: center;
    color: #007AFF; font-weight: 600; cursor: pointer; overflow: hidden; position: relative;
}
#edit-avatar-preview { width: 100%; height: 100%; object-fit: cover; }

/* é€šç”¨è¾“å…¥æ¡† */
.ios-input {
    width: 100%; padding: 12px; background: #f2f2f7; border: none; border-radius: 10px;
    font-size: 16px; margin-bottom: 12px; font-family: inherit;
}

/* --- 4. åŸåˆ›é«˜çº§æ‚å¿—é£å¡ç‰‡ (Aesthetic Style) --- */
.aesthetic-card {
    width: 88%; max-width: 360px; height: 80vh;
    background: #fff; 
    border-radius: 32px; 
    position: relative; overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.5) inset;
    display: flex; flex-direction: column;
    animation: floatUp 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}

/* 1. é¡¶éƒ¨æ°›å›´åŒº */
.aes-hero {
    height: 180px; width: 100%; position: relative; flex-shrink: 0;
    overflow: hidden;
}
.aes-blur-bg {
    width: 120%; height: 120%; position: absolute; top: -10%; left: -10%;
    background-size: cover; background-position: center;
    filter: blur(40px) saturate(150%); opacity: 0.8;
}
.aes-noise {
    /* æ·»åŠ ä¸€ç‚¹æ‚è‰²é¢—ç²’æ„Ÿï¼Œå¢åŠ é«˜çº§çº¸è´¨æ„Ÿ */
    position: absolute; inset: 0; opacity: 0.08;
    background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIj48ZmlsdGVyIGlkPSJnoiPjGZlV1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=');
}
.aes-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,1) 100%);
}

/* 2. æ‚¬æµ®å†…å®¹åŒº */
.aes-float-content {
    margin-top: -60px; padding: 0 24px; position: relative; z-index: 2;
    display: flex; flex-direction: column; align-items: center; text-align: center;
}
.aes-avatar-box {
    width: 100px; height: 100px; border-radius: 28px; /* æ›´åŠ ç°ä»£çš„åœ†è§’çŸ©å½¢ */
    padding: 4px; background: #fff;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    transform: rotate(-3deg); /* å¾®å¾®å€¾æ–œï¼Œå¢åŠ è®¾è®¡æ„Ÿ */
    transition: transform 0.3s ease;
}
.aesthetic-card:hover .aes-avatar-box { transform: rotate(0deg) scale(1.05); }

.aes-avatar-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 24px; }

.aes-title-group { margin-top: 15px; margin-bottom: 20px; }
.aes-name { 
    font-family: -apple-system, serif; /* å°è¯•è¡¬çº¿ä½“å¢åŠ é«˜çº§æ„Ÿ */
    font-size: 24px; font-weight: 800; color: #111; letter-spacing: -0.5px; 
}
.aes-tag {
    display: inline-block; margin-top: 6px;
    font-size: 9px; font-weight: 700; letter-spacing: 2px; color: #999;
    border: 1px solid #eee; padding: 4px 10px; border-radius: 20px;
    text-transform: uppercase;
}

/* 3. æ–‡æœ¬æ»šåŠ¨åŒº */
.aes-scroll-area {
    flex: 1; overflow-y: auto; padding: 0 28px 20px 28px;
    -webkit-overflow-scrolling: touch;
    mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
}
.aes-scroll-area::-webkit-scrollbar { display: none; }

.aes-text-body {
    font-size: 15px; line-height: 1.8; color: #444; text-align: justify;
    font-weight: 400; white-space: pre-wrap;
}
.aes-divider { text-align: center; margin-top: 30px; color: #ddd; font-size: 12px; }

/* 4. åº•éƒ¨æ§åˆ¶æ  */
.aes-control-bar {
    padding: 20px 30px 30px 30px; display: flex; gap: 15px;
    background: #fff; z-index: 5;
}
.aes-btn {
    flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px; border-radius: 16px; font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
}
.aes-btn.edit { background: #f5f5f7; color: #333; }
.aes-btn.edit:active { background: #e5e5ea; transform: scale(0.98); }

.aes-btn.delete { background: #fff0f0; color: #ff3b30; }
.aes-btn.delete:active { background: #ffe5e5; transform: scale(0.98); }

@keyframes floatUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
/* --- æ–°å¢ï¼šé¡¶éƒ¨æ‚¬æµ®æŒ‰é’®æ ·å¼ --- */
.aes-top-bar {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 20px; display: flex; justify-content: space-between;
    z-index: 10; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç©ºç™½åŒºåŸŸ */
}

.aes-icon-circle {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,0.2); 
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer; pointer-events: auto; /* æ¢å¤æŒ‰é’®ç‚¹å‡» */
    transition: transform 0.2s, background 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.aes-icon-circle:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
.aes-icon-circle.close { background: rgba(0,0,0,0.15); } /* å…³é—­æŒ‰é’®ç¨å¾®æ·±ä¸€ç‚¹ */
/* --- è™šçº¿æ·»åŠ å¡ç‰‡æ ·å¼ --- */
.char-card.add-new {
    background: rgba(0,0,0,0.02);
    border: 2px dashed #ccc;
    box-shadow: none;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: #999;
    min-height: 200px; /* Ensure same height as others */
}
.char-card.add-new:active { background: rgba(0,0,0,0.05); border-color: #bbb; }

.add-icon-big {
    width: 40px; height: 40px; margin-bottom: 8px; opacity: 0.5;
}
.add-text { font-size: 14px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div id="clock">12:00</div>
        <div class="status-right">
            <svg width="18" height="12" viewBox="0 0 18 12" fill="currentColor"><path d="M1 9h2v2H1zm4-3h2v5H5zm4-3h2v8H9zm4-3h2v11h-2z"/></svg>
            <div style="display:flex; align-items:center;">
                <span class="bat-text" id="bat-num">--%</span>
                <div class="battery-box"><div class="bat-fill" id="bat-bar"></div><div class="bat-tip"></div></div>
            </div>
        </div>
    </div>

    <div class="main-container">
        
        <div class="widget w-2x2" onclick="showM('weatherM')">
            <div class="weather-content">
                <div class="w-date-block">
                    <span class="w-day" id="ui-day">MONDAY</span>
                    <span class="w-date" id="ui-date">JANUARY 1</span>
                </div>
                <div class="w-data-stack">
                    <div class="w-icon-area" id="ui-icon"></div>
                    <div class="w-temp" id="ui-temp">--Â°</div>
                    <div class="w-city">
                        <svg style="width:12px;height:12px;fill:#007AFF" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
                        <span id="ui-city">Updating...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="widget w-2x2" onclick="showM('photoM')">
            <div class="pic-container">
                <div class="pic-text" id="ui-quote">"Thinking Different."</div>
                <div class="pic-wrapper">
                    <img id="ui-img" class="pic-img" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23f0f0f0'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-weight='bold' font-family='sans-serif'>Tap to Upload</text></svg>">
                </div>
            </div>
        </div>

        <div class="widget w-4x1">
            <div class="music-row">
                <div style="display:flex; align-items:center;">
                    <div class="album-cover"></div>
                    <div class="track-info">
                        <span class="track-title">Luxury Vibe</span>
                        <span class="track-artist">Lossless Audio</span>
                    </div>
                </div>
                <div class="ctrl-btns">
                    <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    <svg style="width:32px;height:32px;fill:#333" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </div>
            </div>
        </div>

        <div class="widget w-4x1">
            <div class="prog-stack">
                <div class="prog-header"><span>Daily Progress</span><span id="prog-txt">0.0%</span></div>
                <div class="prog-bg"><div class="prog-fg" id="prog-bar"></div></div>
            </div>
        </div>

        <div class="app-cell" onclick="openApp('wallApp')">
            <div class="icon-shape" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
                    <polyline points="21 15 16 10 5 21" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
            </div>
            <span class="app-name">Wallpaper</span>
        </div>
        <div class="app-cell"><div class="icon-shape" style="color:#FF9500"><svg class="svg-icon" viewBox="0 0 24 24"><rect x="2" y="6" width="14" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><polygon points="23 7 16 12 23 17" fill="currentColor"/></svg></div><span class="app-name">Video</span></div>
        <div class="app-cell"><div class="icon-shape" style="color:#FF2D55"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M20.8 4.6a5.5 5.5 0 0 0-7.7 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z" fill="currentColor"/></svg></div><span class="app-name">Health</span></div>
        <div class="app-cell"><div class="icon-shape" style="color:#5856D6"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="none" stroke="currentColor" stroke-width="2"/><polyline points="14 2 14 8 20 8" fill="none" stroke="currentColor" stroke-width="2"/></svg></div><span class="app-name">Files</span></div>
        <div class="app-cell"><div class="icon-shape" style="color:#333"><svg class="svg-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><polyline points="12 6 12 12 16 14" fill="none" stroke="currentColor" stroke-width="2"/></svg></div><span class="app-name">Clock</span></div>
        <div class="app-cell"><div class="icon-shape" style="color:#333"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" fill="none" stroke="currentColor" stroke-width="2"/><polyline points="22,6 12,13 2,6" fill="none" stroke="currentColor" stroke-width="2"/></svg></div><span class="app-name">Mail</span></div>
        <div class="app-cell"><div class="icon-shape" style="color:#333"><svg class="svg-icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="none" stroke="currentColor" stroke-width="2"/></svg></div><span class="app-name">Star</span></div>
        <div class="app-cell"><div class="icon-shape" style="color:#333"><svg class="svg-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" fill="none" stroke="currentColor" stroke-width="2"/></svg></div><span class="app-name">Set</span></div>

    </div>

    <div class="dock-container">
        <div class="dock-bar">
            <div class="dock-app" onclick="openApp('charApp')" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </div>
            <div class="dock-app" style="background:linear-gradient(135deg,#e14fad,#f9d423)"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="currentColor"/></svg></div>
            <div class="dock-app" style="background:linear-gradient(135deg,#43e97b,#38f9d7)"><svg class="svg-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" fill="currentColor"/></svg></div>
            <div class="dock-app" style="background:linear-gradient(135deg,#4facfe,#00f2fe)"><svg class="svg-icon" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" fill="none" stroke="currentColor" stroke-width="2"/><polyline points="22,6 12,13 2,6" fill="none" stroke="currentColor" stroke-width="2"/></svg></div>
        </div>
        <div class="home-indicator"></div>
    </div>

    <div class="modal-overlay" id="weatherM" onclick="hideM('weatherM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top">
                <span class="modal-h1">Select City</span>
                <span class="modal-done" onclick="hideM('weatherM')">Done</span>
            </div>

            <div class="segment-control">
                <div class="segment-btn active" id="tab-cn" onclick="switchTab('cn')">China</div>
                <div class="segment-btn" id="tab-global" onclick="switchTab('global')">Global</div>
            </div>
            
            <div style="max-height: 55vh; overflow-y: auto; padding-right: 2px;">
                
                <div id="view-cn" class="city-view active">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">MAINLAND & HK/TW</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(39.9042, 116.4074, 'Beijing')">åŒ—äº¬</div>
                        <div class="city-tag" onclick="fetchW(31.2304, 121.4737, 'Shanghai')">ä¸Šæµ·</div>
                        <div class="city-tag" onclick="fetchW(23.1291, 113.2644, 'Guangzhou')">å¹¿å·</div>
                        <div class="city-tag" onclick="fetchW(22.5431, 114.0579, 'Shenzhen')">æ·±åœ³</div>
                        <div class="city-tag" onclick="fetchW(30.5728, 104.0668, 'Chengdu')">æˆéƒ½</div>
                        <div class="city-tag" onclick="fetchW(30.2741, 120.1551, 'Hangzhou')">æ­å·</div>
                        <div class="city-tag" onclick="fetchW(29.5630, 106.5516, 'Chongqing')">é‡åº†</div>
                        <div class="city-tag" onclick="fetchW(34.3416, 108.9398, 'Xi\'an')">è¥¿å®‰</div>
                        <div class="city-tag" onclick="fetchW(30.5928, 114.3055, 'Wuhan')">æ­¦æ±‰</div>
                        <div class="city-tag" onclick="fetchW(32.0603, 118.7969, 'Nanjing')">å—äº¬</div>
                        <div class="city-tag" onclick="fetchW(22.3193, 114.1694, 'Hong Kong')">é¦™æ¸¯</div>
                        <div class="city-tag" onclick="fetchW(25.0330, 121.5654, 'Taipei')">å°åŒ—</div>
                    </div>
                </div>

                <div id="view-global" class="city-view">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">ASIA & PACIFIC</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(35.6762, 139.6503, 'Tokyo')">Tokyo</div>
                        <div class="city-tag" onclick="fetchW(37.5665, 126.9780, 'Seoul')">Seoul</div>
                        <div class="city-tag" onclick="fetchW(1.3521, 103.8198, 'Singapore')">Singapore</div>
                        <div class="city-tag" onclick="fetchW(13.7563, 100.5018, 'Bangkok')">Bangkok</div>
                        <div class="city-tag" onclick="fetchW(-33.8688, 151.2093, 'Sydney')">Sydney</div>
                        <div class="city-tag" onclick="fetchW(25.2048, 55.2708, 'Dubai')">Dubai</div>
                    </div>

                    <div style="font-size:12px; color:#999; margin: 15px 0 8px 0; font-weight:700;">AMERICAS & EUROPE</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(40.7128, -74.0060, 'New York')">New York</div>
                        <div class="city-tag" onclick="fetchW(34.0522, -118.2437, 'Los Angeles')">L.A.</div>
                        <div class="city-tag" onclick="fetchW(43.6532, -79.3832, 'Toronto')">Toronto</div>
                        <div class="city-tag" onclick="fetchW(51.5074, -0.1278, 'London')">London</div>
                        <div class="city-tag" onclick="fetchW(48.8566, 2.3522, 'Paris')">Paris</div>
                        <div class="city-tag" onclick="fetchW(52.5200, 13.4050, 'Berlin')">Berlin</div>
                        <div class="city-tag" onclick="fetchW(55.7558, 37.6173, 'Moscow')">Moscow</div>
                        <div class="city-tag" onclick="fetchW(41.9028, 12.4964, 'Rome')">Rome</div>
                        <div class="city-tag" onclick="fetchW(40.4168, -3.7038, 'Madrid')">Madrid</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal-overlay" id="photoM" onclick="hideM('photoM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top"><span class="modal-h1">Customize</span><span class="modal-done" onclick="hideM('photoM')">Save</span></div>
            <input type="text" id="q-in" placeholder="Type your quote..." style="width:100%; padding:16px; background:#f2f2f7; border:none; border-radius:14px; font-size:16px;">
            <div class="upload-tools">
                <input type="file" id="f-in" style="display:none" accept="image/*" onchange="loadF(this)">
                <div class="tool-btn" onclick="document.getElementById('f-in').click()">Photo Library</div>
                <div class="tool-btn" onclick="loadU()">Paste URL</div>
            </div>
        </div>
    </div>

<video id="bg-video" autoplay loop muted playsinline style="position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; display:none;"></video>

<div id="wallApp" class="ios-app-window">
    <div class="app-header">
        <div class="header-title-big">Wallpaper</div>
        <div class="header-close-btn" onclick="closeApp('wallApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body">
        
        <div class="preview-stage" style="margin-top: 10px;">
            <div class="phone-frame">
                <img id="preview-img" src="" style="display:none;">
                <video id="preview-vid" autoplay loop muted playsinline style="display:none;"></video>
                <div class="preview-placeholder" id="preview-hint">Preview</div>
            </div>
        </div>

        <div class="segment-control" style="width: 100%; max-width: 300px;">
            <div class="segment-btn active" id="seg-img" onclick="switchWallTab('img')">Image</div>
            <div class="segment-btn" id="seg-vid" onclick="switchWallTab('vid')">Video</div>
        </div>

        <div class="action-area" id="panel-img" style="max-width: 300px;">
            <input type="file" id="upload-img" accept="image/*" style="display:none" onchange="handleWallFile(this, 'img')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-img').click()">+ New Image</button>
            <button class="ios-btn primary" onclick="setWallpaper('img')">Set Current</button>
        </div>

        <div class="action-area" id="panel-vid" style="display:none; max-width: 300px;">
            <input type="file" id="upload-vid" accept="video/*" style="display:none" onchange="handleWallFile(this, 'vid')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-vid').click()">+ New Video</button>
            <button class="ios-btn primary" onclick="setWallpaper('vid')">Set Current</button>
        </div>

        <div class="history-section">
            <div class="history-title">My Collection</div>
            <div class="history-grid" id="wall-history-grid">
                </div>
            <div style="text-align:center; color:#999; font-size:12px; margin-top:15px;">
                Tap to apply. Latest 6 items saved.
            </div>
        </div>

    </div>
</div>

<div id="toast" class="ios-toast">Settings Saved</div>

<div id="successAlert" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Success</div>
        <div class="alert-msg" id="alert-msg">Wallpaper Updated Successfully</div>
        <div class="alert-btn" onclick="closeAlert()">OK</div>
    </div>
</div>

<div id="charApp" class="ios-app-window">
    <div id="char-list-view" style="height:100%; display:flex; flex-direction:column;">
        <div class="app-header">
            <div class="header-title-big" style="flex:1; text-align: left; padding-left: -5px;">Character</div>
            
            <div class="header-close-btn" onclick="closeApp('charApp')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
        
        <div class="app-body">
            <div id="char-grid" class="char-grid">
                </div>
            </div>
    </div>

    <div id="char-detail-view" class="char-detail-view">
        <div class="char-hero-bg" id="detail-bg" onclick="openBgModal()">
            <div class="bg-hint">Tap to Change Cover</div>
        </div>
        
        <div class="char-content">
            <div class="char-avatar-container">
                <img id="detail-avatar" src="">
            </div>
            
            <div class="char-info-block">
                <div class="char-name" id="detail-name">Character Name</div>
                
                <div class="char-desc-preview" onclick="openFullDesc()">
                    <span id="detail-desc">Description goes here...</span>
                    <span style="color:#007AFF; font-weight:600; font-size:12px;"> more</span>
                </div>

                <div class="char-actions">
                    <button class="ios-btn secondary" onclick="editCurrentChar()">Edit Profile</button>
                    <button class="ios-btn" style="background:#FF3B30; color:white;" onclick="openDelConfirm()">Delete Character</button>
                </div>
            </div>
        </div>

        <div class="floating-back" onclick="closeDetailView()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </div>
    </div>
</div>

<div id="charEditModal" class="ios-alert-mask" style="align-items:flex-end;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-top">
            <span class="modal-h1" id="modal-title">New Character</span>
            <span class="modal-done" onclick="saveCharacter()">Save</span>
        </div>
        
        <div style="display:flex; justify-content:center; margin-bottom:20px;">
            <div class="char-upload-circle" onclick="document.getElementById('char-avatar-in').click()">
                <img id="edit-avatar-preview" src="" style="display:none;">
                <span id="edit-avatar-hint">+ Avatar</span>
            </div>
            <input type="file" id="char-avatar-in" accept="image/*" style="display:none" onchange="previewCharAvatar(this)">
        </div>

        <input type="text" id="char-name-in" class="ios-input" placeholder="Nickname">
        <textarea id="char-desc-in" class="ios-input" style="height:120px; resize:none; padding-top:12px;" placeholder="Character Description / Setting..."></textarea>
        
        <div class="tool-btn" onclick="closeCharModal()" style="margin-top:10px; color:#FF3B30;">Cancel</div>
    </div>
</div>

<div id="bgChangeModal" class="ios-alert-mask">
    <div class="ios-alert-box" style="padding:20px; text-align:left;">
        <div class="alert-title" style="margin-top:0; margin-bottom:15px; text-align:center;">Change Cover</div>
        
        <div class="segment-control">
            <div class="segment-btn active" id="bg-seg-file" onclick="switchBgMode('file')">File</div>
            <div class="segment-btn" id="bg-seg-url" onclick="switchBgMode('url')">URL</div>
        </div>

        <div id="bg-panel-file">
            <input type="file" id="bg-file-in" style="display:none" accept="image/*" onchange="handleBgFile(this)">
            <button class="ios-btn secondary" onclick="document.getElementById('bg-file-in').click()">Choose Image</button>
        </div>
        <div id="bg-panel-url" style="display:none;">
            <input type="text" id="bg-url-in" class="ios-input" placeholder="https://..." style="margin-bottom:10px;">
            <button class="ios-btn secondary" onclick="handleBgUrl()">Use URL</button>
        </div>

        <div class="alert-btn" style="border:none; margin-top:10px; color:#FF3B30;" onclick="document.getElementById('bgChangeModal').style.display='none'">Cancel</div>
    </div>
</div>

<div id="fullDescModal" class="ios-alert-mask" onclick="closeInsModal()" style="backdrop-filter: blur(15px); background: rgba(0,0,0,0.2);">
    
    <div class="aesthetic-card" onclick="event.stopPropagation()">
        
        <div class="aes-top-bar">
            <div class="aes-icon-circle close" onclick="closeInsModal()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="aes-hero">
            <div class="aes-blur-bg" id="aes-bg-layer"></div>
            <div class="aes-noise"></div>
            <div class="aes-overlay"></div>
        </div>

        <div class="aes-float-content">
            <div class="aes-avatar-box">
                <img id="aes-avatar-img" src="">
            </div>
            <div class="aes-title-group">
                <div class="aes-name" id="aes-name-txt">Character Name</div>
                <div class="aes-tag">ORIGINAL CHARACTER</div>
            </div>
        </div>

        <div class="aes-scroll-area">
            <div class="aes-text-body" id="aes-full-desc">
                </div>
            <div class="aes-divider">âœ¦</div>
        </div>

        </div>
</div>

<div id="delConfirmModal" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Delete Character?</div>
        <div class="alert-msg">This action cannot be undone.</div>
        <div class="alert-btn" style="color:#FF3B30;" onclick="confirmDelete()">Delete</div>
        <div class="alert-btn" onclick="document.getElementById('delConfirmModal').style.display='none'">Cancel</div>
    </div>
</div>

<script>
    let tempImg = null;       
    let tempVid = null;       
    let tempVidThumb = null;

    let editingCharId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘/æŸ¥çœ‹çš„è§’è‰²ID
    let tempCharAvatar = null; // æš‚å­˜å¤´åƒ
    
// === 0. æ•°æ®åº“å·¥å…· (è§£å†³è§†é¢‘æ— æ³•ä¿å­˜çš„é—®é¢˜) ===
const dbName = "WallDB";
const storeName = "wallpapers";

function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(dbName, 1);
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: "id" });
            }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

async function saveToDB(key, data) {
    const db = await openDB();
    const tx = db.transaction(storeName, "readwrite");
    tx.objectStore(storeName).put({ id: key, data: data });
}

async function loadFromDB(key) {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction(storeName, "readonly");
        const req = tx.objectStore(storeName).get(key);
        req.onsuccess = () => resolve(req.result ? req.result.data : null);
    });
}
    // === ä¿®å¤é‡ç‚¹3ï¼šæ•°æ®æŒä¹…åŒ– (åˆ·æ–°ä¸ä¸¢å¤±) ===
    async function loadSavedData() {
        // 1. åŠ è½½æ¡Œé¢å°ç»„ä»¶æ•°æ® (å›¾ç‰‡ã€é‡‘å¥ã€åŸå¸‚) - ä» localStorage
        const sImg = localStorage.getItem('ios_img');
        const sQuote = localStorage.getItem('ios_quote');
        const sCity = localStorage.getItem('ios_city');

        if(sImg) document.getElementById('ui-img').src = sImg;
        if(sQuote) document.getElementById('ui-quote').textContent = `"${sQuote}"`;
        
        if(sCity) {
            const c = JSON.parse(sCity);
            fetchW(c.lat, c.lon, c.name);
        } else {
            fetchW(40.7829, -73.9654, 'New York');
        }

        // 2. åŠ è½½å£çº¸æ•°æ® - ä» IndexedDB (å¤§æ–‡ä»¶å­˜å‚¨)
        const wType = localStorage.getItem('user_wall_type');
        const wData = await loadFromDB('current_wall_data');
        
        if(wType && wData) {
            const bgVid = document.getElementById('bg-video');

            if(wType === 'img') {
                // åº”ç”¨å›¾ç‰‡å£çº¸
                document.body.style.background = `url(${wData}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                // ç¡®ä¿è§†é¢‘å±‚éšè—
                if(bgVid) { 
                    bgVid.style.display = 'none'; 
                    bgVid.src = ""; 
                }
            } else if(wType === 'vid') {
                // åº”ç”¨è§†é¢‘å£çº¸
                if(bgVid) {
                    bgVid.src = wData;
                    bgVid.style.display = 'block';
                    bgVid.play().catch(e => console.log("Auto-play blocked"));
                }
            }
        }
        
        // 3. åŠ è½½å£çº¸å†å²è®°å½•åˆ—è¡¨
        renderHistory();
        await initCharApp();
    }

    function tick() {
        const d = new Date();
        document.getElementById('clock').textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
        const months = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
        document.getElementById('ui-day').textContent = days[d.getDay()];
        document.getElementById('ui-date').textContent = `${months[d.getMonth()]} ${d.getDate()}`;
        
        // è¿›åº¦æ¡è®¡ç®—
        const totalSec = d.getHours() * 3600 + d.getMinutes() * 60 + d.getSeconds();
        const percent = (totalSec / 86400) * 100;
        document.getElementById('prog-bar').style.width = percent + '%';
        document.getElementById('prog-txt').textContent = percent.toFixed(1) + '%';
    }

    async function initBat() {
        const batNum = document.getElementById('bat-num');
        const batBar = document.getElementById('bat-bar');

        // 1. ã€å¼ºåˆ¶å…œåº•ã€‘ï¼šå…ˆæŠŠæ•°å­—å¡«ä¸Šå»ï¼Œä¿è¯ç»å¯¹æœ‰æ˜¾ç¤ºï¼
        batNum.textContent = '100%'; 
        batBar.style.width = '100%';
        batBar.style.background = '#1d1d1f'; // é»˜è®¤é»‘è‰²

        // 2. å°è¯•è·å–çœŸå®ç”µé‡ (ä»…å®‰å“/PCæœ‰æ•ˆ)
        if ('getBattery' in navigator) {
            try {
                const bat = await navigator.getBattery();
                
                const update = () => {
                    const level = Math.round(bat.level * 100);
                    batNum.textContent = level + '%';
                    batBar.style.width = level + '%';
                    
                    if(bat.charging) {
                        batBar.style.background = '#34C759'; // å……ç”µç»¿
                    } else if(level <= 20) {
                        batBar.style.background = '#FF3B30'; // ä½ç”µé‡çº¢
                    } else {
                        batBar.style.background = '#1d1d1f'; // æ­£å¸¸é»‘
                    }
                };
                
                update();
                bat.addEventListener('levelchange', update);
                bat.addEventListener('chargingchange', update);
            } catch (e) {
                // å¦‚æœæŠ¥é”™ï¼Œæ²¡å…³ç³»ï¼Œåæ­£ç¬¬1æ­¥å·²ç»å¡«äº† 100%
                console.log("ç”µé‡APIå—é™ï¼Œä¿æŒå…œåº•æ˜¾ç¤º");
            }
        }
    }

    const ICONS = {
        sun: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSun" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient></defs><circle cx="32" cy="32" r="18" fill="url(#gSun)"/><circle cx="32" cy="32" r="24" fill="none" stroke="#FFD700" stroke-width="2" opacity="0.4"/></svg>`,
        moon: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gMoon" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#E0E0E0"/><stop offset="100%" stop-color="#BDBDBD"/></linearGradient></defs><path d="M48 32c0 11-9 20-20 20-2.5 0-4.8-.5-7-1.3 2.5-1.5 5.5-2.7 8-5.7 6-7 4-18-2-22-2.3-1.5-5-2.2-7.7-2.3C22.6 14.5 27 12 32 12c11 0 16 9 16 20z" fill="url(#gMoon)"/></svg>`,
        partly: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSunS" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient><linearGradient id="gCloud" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#d9d9d9"/></linearGradient></defs><circle cx="24" cy="24" r="14" fill="url(#gSunS)"/><path d="M48 48H30c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5-3.5 15.8-12 15.8z" fill="url(#gCloud)" filter="drop-shadow(0 2px 3px rgba(0,0,0,0.2))"/></svg>`,
        cloud: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gCloudF" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#c0c0c0"/></linearGradient></defs><path d="M46 44H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gCloudF)" filter="drop-shadow(0 4px 6px rgba(0,0,0,0.1))"/></svg>`,
        rain: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gRain" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#cfd9df"/><stop offset="100%" stop-color="#a1c4fd"/></linearGradient></defs><path d="M46 40H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gRain)"/><path d="M22 46l-3 9M32 46l-3 9M42 46l-3 9" stroke="#4facfe" stroke-width="3" stroke-linecap="round"/></svg>`
    };
    
    async function fetchW(lat,lon,name) {
        document.getElementById('ui-city').textContent = name;
        hideM('weatherM');
        localStorage.setItem('ios_city', JSON.stringify({lat, lon, name})); // ä¿å­˜åŸå¸‚

        try {
            const tStamp = new Date().getTime();
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day&timezone=auto&_t=${tStamp}`);
            const data = await res.json();
            const current = data.current;
            const c = current.weather_code;
            const t = Math.round(current.temperature_2m);
            const isDay = current.is_day === 1;
            
            let icon = ICONS.sun;
            if (c === 0) icon = isDay ? ICONS.sun : ICONS.moon;
            else if (c >= 1 && c <= 2) icon = ICONS.partly;
            else if (c === 3 || (c >= 45 && c <= 48)) icon = ICONS.cloud;
            else icon = ICONS.rain;
            
            document.getElementById('ui-temp').textContent = t+'Â°';
            document.getElementById('ui-icon').innerHTML = icon;
        } catch(e) { document.getElementById('ui-city').textContent = "Offline"; }
    }

    function showM(id) { document.getElementById(id).style.display='flex'; }
    function hideM(id) { 
        document.getElementById(id).style.display='none'; 
        if(id==='photoM') {
            const v = document.getElementById('q-in').value;
            if(v) {
                document.getElementById('ui-quote').textContent = `"${v}"`;
                localStorage.setItem('ios_quote', v); // ä¿å­˜æ–‡å­—
            }
        }
    }
    
    function loadF(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const imgData = e.target.result;
                document.getElementById('ui-img').src = imgData;
                try {
                    localStorage.setItem('ios_img', imgData); // ä¿å­˜å›¾ç‰‡
                } catch(err) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œå»ºè®®ç”¨URL"); }
            };
            r.readAsDataURL(input.files[0]);
        }
    }
    
    function loadU() {
        const u = prompt("Paste Image URL:");
        if(u) {
            document.getElementById('ui-img').src = u;
            localStorage.setItem('ios_img', u); // ä¿å­˜å›¾ç‰‡URL
        }
    }

    // å¯åŠ¨
    setInterval(tick,1000); 
    loadSavedData(); // åŠ è½½æ‰€æœ‰ä¿å­˜çš„æ•°æ®
    initBat();

    // åˆ‡æ¢æ ‡ç­¾é¡µåŠŸèƒ½
function switchTab(tab) {
    // 1. å¤„ç†æŒ‰é’®æ ·å¼
    document.getElementById('tab-cn').classList.remove('active');
    document.getElementById('tab-global').classList.remove('active');
    document.getElementById('tab-' + tab).classList.add('active');

    // 2. å¤„ç†å†…å®¹æ˜¾ç¤º
    document.getElementById('view-cn').classList.remove('active');
    document.getElementById('view-global').classList.remove('active');
    document.getElementById('view-' + tab).classList.add('active');
}

// === å£çº¸ App å¢å¼ºç‰ˆé€»è¾‘ ===
    
    // åˆå§‹åŒ–æ—¶åŠ è½½å†å²
    setTimeout(renderHistory, 500);

    function openApp(id) { 
        document.getElementById(id).classList.add('active'); 
        renderHistory(); // æ¯æ¬¡æ‰“å¼€åˆ·æ–°å†å²
    }
    function closeApp(id) { document.getElementById(id).classList.remove('active'); }

    // 1. åˆ‡æ¢ Tab (ä¿®å¤é¢„è§ˆå›¾ä¹±è·‘çš„é—®é¢˜)
    function switchWallTab(type) {
        // æŒ‰é’®æ ·å¼åˆ‡æ¢
        document.getElementById('seg-img').classList.toggle('active', type==='img');
        document.getElementById('seg-vid').classList.toggle('active', type==='vid');
        
        // æ“ä½œé¢æ¿åˆ‡æ¢
        document.getElementById('panel-img').style.display = type==='img' ? 'flex' : 'none';
        document.getElementById('panel-vid').style.display = type==='vid' ? 'flex' : 'none';
        
        // é¢„è§ˆé€»è¾‘é‡å†™ï¼šåªæœ‰å½“æœ‰å†…å®¹æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼Œå¦åˆ™æ˜¾ç¤ºå ä½ç¬¦
        const imgEl = document.getElementById('preview-img');
        const vidEl = document.getElementById('preview-vid');
        const hintEl = document.getElementById('preview-hint');

        if(type === 'img') {
            vidEl.style.display = 'none'; // è—è§†é¢‘
            // å¦‚æœæœ‰æš‚å­˜å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼›å¦åˆ™æ˜¾ç¤ºæ–‡å­—
            if(tempImg) {
                imgEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Image";
            }
        } else {
            imgEl.style.display = 'none'; // è—å›¾ç‰‡
            // å¦‚æœæœ‰æš‚å­˜è§†é¢‘ï¼Œæ˜¾ç¤ºè§†é¢‘
            if(tempVid) {
                vidEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                vidEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Video";
            }
        }
    }

    // === ã€ä¿®æ”¹è¿™é‡Œã€‘ä¿å­˜é€»è¾‘æ”¹ç”¨ IndexedDB ===
    // 1. ä¿å­˜"å½“å‰å£çº¸"çŠ¶æ€
    localStorage.setItem('user_wall_type', type); // ç±»å‹å­˜ localStorage
    saveToDB('current_wall_data', data); // å¤§æ–‡ä»¶å­˜ DB

    // 2. ä¿å­˜å†å²è®°å½•
    saveToHistory(type, data);
    
    showNativeAlert("Wallpaper Set & Saved!");

    // 2. æ–‡ä»¶å¤„ç† (å…¼å®¹æ€§å¢å¼º)
    function handleWallFile(input, type) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            
            // è§†é¢‘å¤§å°é™åˆ¶ (é¿å…å¡æ­»)
            if(type === 'vid' && file.size > 20 * 1024 * 1024) { 
                showNativeAlert("Video too large! Max 20MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const res = e.target.result;
                if(type === 'img') {
                    tempImg = res;
                    document.getElementById('preview-img').src = res;
                } else {
                    tempVid = res;
                    document.getElementById('preview-vid').src = res;
                }
                // åŠ è½½å®Œç«‹åˆ»åˆ·æ–°é¢„è§ˆåŒºåŸŸ
                switchWallTab(type);
            };
            reader.readAsDataURL(file);
        }
    }

    // 3. è®¾ç½®å£çº¸ (è°ƒç”¨æ–°å¼¹çª— + å¼ºåˆ¶ä¿å­˜)
    // æ‰¾åˆ° setWallpaper å‡½æ•°ï¼Œå®Œå…¨æ›¿æ¢æˆè¿™ä¸ªï¼š
    function setWallpaper(cType) {
        const bgVid = document.getElementById('bg-video');
        // è¿™é‡Œçš„ cType å°±æ˜¯ä½ ä¼ å…¥çš„ 'img' æˆ– 'vid'
        const data = (cType === 'img') ? tempImg : tempVid;

        if(!data) { 
            showNativeAlert("Please select a file first.");
            return; 
        }

        if(cType === 'img') {
            document.body.style.background = `url(${data}) no-repeat center center fixed`;
            document.body.style.backgroundSize = "cover";
            if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
            
            localStorage.setItem('user_wall_type', 'img');
            saveToDB('current_wall_data', data);
            
            // ä¿å­˜å†å² (å›¾ç‰‡è‡ªå·±å°±æ˜¯ç¼©ç•¥å›¾)
            saveToHistory('img', data, data); 

        } else {
            if(bgVid) {
                bgVid.src = data;
                bgVid.style.display = 'block';
                bgVid.play();
            }
            
            localStorage.setItem('user_wall_type', 'vid');
            saveToDB('current_wall_data', data);
            
            // ğŸ‘‡ å…³é”®ä¿®å¤ï¼šè¿™é‡Œä½¿ç”¨å…¨å±€å˜é‡ tempVidThumb
            saveToHistory('vid', data, tempVidThumb || null); 
        }
        
        showNativeAlert("Wallpaper Set Successfully!");
    }

    // 5. å¼¹çª—æ§åˆ¶å‡½æ•°
    function showNativeAlert(msg) {
        document.getElementById('alert-msg').textContent = msg;
        document.getElementById('successAlert').style.display = 'flex';
    }
    function closeAlert() {
        document.getElementById('successAlert').style.display = 'none';
    }

    // åˆå§‹åŒ–åŠ è½½å†å²
    setTimeout(renderHistory, 500);
    // ==========================================
    // ç¼ºå¤±çš„å·¥å…·å‡½æ•° (è¯·è¡¥åœ¨æœ€ä¸‹é¢)
    // ==========================================

    // 1. å¼¹çª—æç¤ºå·¥å…· (è§£å†³ showToast is not defined)
    function showToast(msg) {
        const t = document.getElementById('toast');
        if(t) {
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        } else {
            alert(msg); // å¦‚æœæ‰¾ä¸åˆ°toastå…ƒç´ ï¼Œç”¨åŸç”Ÿå¼¹çª—å…œåº•
        }
    }

    // 2. ä¿å­˜å†å²è®°å½•é€»è¾‘
    async function saveToHistory(type, data) {
        // å…ˆè¯»æ—§å†å²
        let history = await loadFromDB('history_list') || [];
        
        // æŸ¥é‡ï¼šå¦‚æœå·²ç»æœ‰äº†ï¼Œåˆ æ‰æ—§çš„
        history = history.filter(item => item.data !== data);
        
        // æ’å…¥æ–°çš„åˆ°æœ€å‰é¢
        history.unshift({ type: type, data: data });
        
        // é™åˆ¶ 6 ä¸ª
        if(history.length > 6) history.pop();
        
        // å­˜å…¥æ•°æ®åº“
        await saveToDB('history_list', history);
        
        // åˆ·æ–°æ˜¾ç¤º
        renderHistory();
    }

    // 3. æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
    // === æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨ (ä¿®å¤ type is not defined æŠ¥é”™) ===
    async function renderHistory() {
        const grid = document.getElementById('wall-history-grid');
        if(!grid) return;
        
        let history = await loadFromDB('history_list') || [];
        grid.innerHTML = ""; 

        history.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            
            let badge = '';
            let content = '';
            
            if(item.type === 'vid') {
                badge = `<div class="vid-badge">LIVE</div>`;
                // ä¼˜å…ˆä½¿ç”¨ç¼©ç•¥å›¾ï¼Œæ²¡æœ‰åˆ™ç”¨è§†é¢‘å…œåº•
                if(item.thumb && item.thumb.startsWith('data:image')) {
                     content = `<img src="${item.thumb}" style="opacity:0.8;">`;
                } else {
                     content = `<video src="${item.data}" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; pointer-events:none;"></video>`;
                }
            } else {
                content = `<img src="${item.data}">`;
            }

            div.innerHTML = `${content}${badge}`;

            // --- ç‚¹å‡»å†å²è®°å½•åº”ç”¨å£çº¸ ---
            div.onclick = () => {
                // 1. æ¢å¤é¢„è§ˆå›¾
                if(item.type === 'img') {
                    tempImg = item.data;
                    document.getElementById('preview-img').src = item.data;
                } else {
                    tempVid = item.data;
                    document.getElementById('preview-vid').src = item.data;
                }
                
                // 2. åˆ‡æ¢ Tab
                switchWallTab(item.type);
                
                // 3. åº”ç”¨å£çº¸ (æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œå…¨éƒ¨æ”¹ç”¨ item.type å’Œ item.data)
                const bgVid = document.getElementById('bg-video');
                if(item.type === 'img') {
                    document.body.style.background = `url(${item.data}) no-repeat center center fixed`;
                    document.body.style.backgroundSize = "cover";
                    if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
                    
                    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ é‡ç‚¹ä¿®æ”¹äº†è¿™é‡Œ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                    localStorage.setItem('user_wall_type', item.type); 
                    saveToDB('current_wall_data', item.data);
                } else {
                    if(bgVid) {
                        bgVid.src = item.data;
                        bgVid.style.display = 'block';
                        bgVid.play();
                    }
                    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ é‡ç‚¹ä¿®æ”¹äº†è¿™é‡Œ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                    localStorage.setItem('user_wall_type', item.type);
                    saveToDB('current_wall_data', item.data);
                }
                showToast("Restored!");
            };

            grid.appendChild(div);
        });
    }

    // 4. åˆå§‹åŒ–åŠ è½½ä¸€æ¬¡å†å²
    setTimeout(renderHistory, 1000);

    // ==========================================
    // 8. è§’è‰²ä¹¦ App é€»è¾‘ (Character Book)
    // ==========================================

    // 1. åˆå§‹åŒ–
    async function initCharApp() {
        await renderCharList();
    }
    // åœ¨ loadSavedData çš„æœ€åè°ƒç”¨å®ƒ (æ‰‹åŠ¨åŠ ä¸€è¡Œ initCharApp();)

    // 2. è§’è‰²å¢åˆ æ”¹æŸ¥ (åŸºäº IndexedDB)
    async function getCharList() {
        return await loadFromDB('char_list') || [];
    }
    async function saveCharList(list) {
        await saveToDB('char_list', list);
    }

    // 3. æ¸²æŸ“åˆ—è¡¨
    async function renderCharList() {
        const grid = document.getElementById('char-grid');
        if(!grid) return;
        
        const list = await getCharList();
        grid.innerHTML = "";
        
        // 1. å…ˆåˆ›å»ºä¸€ä¸ª "Add New" å¡ç‰‡
        const addCard = document.createElement('div');
        addCard.className = 'char-card add-new';
        addCard.onclick = openCharModal; // ç‚¹å‡»è§¦å‘æ–°å»ºå¼¹çª—
        addCard.innerHTML = `
            <svg class="add-icon-big" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <div class="add-text">New Character</div>
        `;
        grid.appendChild(addCard);

        // 2. å†æ¸²æŸ“ç°æœ‰çš„è§’è‰²å¡ç‰‡
        list.forEach(char => {
            const card = document.createElement('div');
            card.className = 'char-card';
            card.innerHTML = `
                <img class="char-card-img" src="${char.avatar || ''}">
                <div class="char-card-info">
                    <div class="char-card-name">${char.name}</div>
                    <div class="char-card-desc">${char.desc}</div>
                </div>
            `;
            card.onclick = () => openCharDetail(char.id);
            grid.appendChild(card);
        });
        
        // (Deleted empty hint logic since we always have the add button)
    }

    // 4. æ‰“å¼€/å…³é—­ App
    function openCharModal() {
        editingCharId = null; // æ–°å»ºæ¨¡å¼
        document.getElementById('modal-title').textContent = "New Character";
        document.getElementById('char-name-in').value = "";
        document.getElementById('char-desc-in').value = "";
        document.getElementById('edit-avatar-preview').style.display = 'none';
        document.getElementById('edit-avatar-hint').style.display = 'block';
        tempCharAvatar = null;
        document.getElementById('charEditModal').style.display = 'flex';
    }
    function closeCharModal() { document.getElementById('charEditModal').style.display = 'none'; }

    // 5. ä¿å­˜è§’è‰² (æ–°å»ºæˆ–ä¿®æ”¹)
    async function saveCharacter() {
        const name = document.getElementById('char-name-in').value;
        const desc = document.getElementById('char-desc-in').value;
        
        if(!name) { showToast("Name is required"); return; }
        
        let list = await getCharList();
        
        if(editingCharId) {
            // ä¿®æ”¹æ¨¡å¼
            const index = list.findIndex(c => c.id === editingCharId);
            if(index !== -1) {
                list[index].name = name;
                list[index].desc = desc;
                if(tempCharAvatar) list[index].avatar = tempCharAvatar;
                // æ›´æ–°è¯¦æƒ…é¡µè§†å›¾
                openCharDetail(editingCharId, list[index]); 
            }
        } else {
            // æ–°å»ºæ¨¡å¼
            if(!tempCharAvatar) { showToast("Avatar is required"); return; }
            const newChar = {
                id: Date.now().toString(),
                name: name,
                desc: desc,
                avatar: tempCharAvatar,
                bg: '' // é»˜è®¤æ— èƒŒæ™¯
            };
            list.unshift(newChar);
        }
        
        await saveCharList(list);
        renderCharList();
        closeCharModal();
        showToast("Saved!");
    }

    // 6. å¤´åƒé¢„è§ˆ
    function previewCharAvatar(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                tempCharAvatar = e.target.result;
                document.getElementById('edit-avatar-preview').src = tempCharAvatar;
                document.getElementById('edit-avatar-preview').style.display = 'block';
                document.getElementById('edit-avatar-hint').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 7. è¯¦æƒ…é¡µé€»è¾‘
    async function openCharDetail(id, charObj = null) {
        let char = charObj;
        if(!char) {
            const list = await getCharList();
            char = list.find(c => c.id === id);
        }
        if(!char) return;

        editingCharId = char.id; // æ ‡è®°å½“å‰æŸ¥çœ‹çš„è§’è‰²
        
        // 1. å¡«å……è¯¦æƒ…é¡µæ•°æ® (è¿™äº› ID è¿˜åœ¨ï¼Œæ‰€ä»¥æ²¡é—®é¢˜)
        const nameEl = document.getElementById('detail-name');
        const descEl = document.getElementById('detail-desc');
        const avtEl = document.getElementById('detail-avatar');
        const bgEl = document.getElementById('detail-bg');

        if(nameEl) nameEl.textContent = char.name;
        // é¢„è§ˆåªæ˜¾ç¤ºå‰50ä¸ªå­—
        if(descEl) descEl.textContent = char.desc.substring(0, 50) + (char.desc.length > 50 ? "..." : "");
        if(avtEl) avtEl.src = char.avatar;
        
        // 2. èƒŒæ™¯å¤„ç†
        if(bgEl) {
            if(char.bg) {
                bgEl.style.backgroundImage = `url(${char.bg})`;
            } else {
                bgEl.style.backgroundColor = '#ddd';
                bgEl.style.backgroundImage = 'none';
            }
        }

        // âŒ åˆ é™¤äº†è¿™é‡ŒåŸæœ¬å¼•ç”¨ 'ins-avatar-img' çš„ä»£ç ï¼Œå› ä¸ºé‚£ä¸ªå…ƒç´ å·²ç»ä¸å­˜åœ¨äº†
        // ç°åœ¨çš„å¼¹çª—æ•°æ®å¡«å……ä¼šåœ¨ç‚¹å‡» "More" (openFullDesc) æ—¶æ‰è¿›è¡Œ

        // 3. æ˜¾ç¤ºè¯¦æƒ…é¡µ
        document.getElementById('char-detail-view').style.display = 'flex';
    }

    function closeDetailView() {
        document.getElementById('char-detail-view').style.display = 'none';
    }

    // 8. è¯¦æƒ…é¡µäº¤äº’ï¼šæ›´æ¢èƒŒæ™¯
    function openBgModal() { document.getElementById('bgChangeModal').style.display = 'flex'; }
    
    function switchBgMode(mode) {
        document.getElementById('bg-seg-file').classList.toggle('active', mode==='file');
        document.getElementById('bg-seg-url').classList.toggle('active', mode==='url');
        document.getElementById('bg-panel-file').style.display = mode==='file'?'block':'none';
        document.getElementById('bg-panel-url').style.display = mode==='url'?'block':'none';
    }

    async function handleBgFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = async e => {
                await updateCharBg(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    async function handleBgUrl() {
        const url = document.getElementById('bg-url-in').value;
        if(url) await updateCharBg(url);
    }

    async function updateCharBg(bgData) {
        let list = await getCharList();
        const index = list.findIndex(c => c.id === editingCharId);
        if(index !== -1) {
            list[index].bg = bgData;
            await saveCharList(list);
            // åˆ·æ–°ç•Œé¢
            document.getElementById('detail-bg').style.backgroundImage = `url(${bgData})`;
            document.getElementById('bgChangeModal').style.display = 'none';
            showToast("Background Updated");
        }
    }

    // === 9. è¯¦æƒ…é¡µäº¤äº’ï¼šé«˜çº§æ‚å¿—é£å±•ç¤º ===
    function openFullDesc() {
        const modal = document.getElementById('fullDescModal');
        
        // 1. è·å–åŸºç¡€æ•°æ®
        const avatarSrc = document.getElementById('detail-avatar').src;
        const nameTxt = document.getElementById('detail-name').textContent;
        
        // 2. å¡«å…… UI
        document.getElementById('aes-avatar-img').src = avatarSrc;
        document.getElementById('aes-name-txt').textContent = nameTxt;
        
        // 3. åŠ¨æ€å…‰å½±ï¼šè®¾ç½®é¡¶éƒ¨æ¨¡ç³ŠèƒŒæ™¯
        document.getElementById('aes-bg-layer').style.backgroundImage = `url(${avatarSrc})`;
        
        // 4. å¼‚æ­¥è·å–å®Œæ•´æ–‡æœ¬
        (async () => {
            const list = await getCharList();
            const fullChar = list.find(c => c.id === editingCharId);
            if(fullChar) {
                document.getElementById('aes-full-desc').textContent = fullChar.desc || "No description provided.";
            }
        })();
        
        // 5. æ˜¾ç¤º
        modal.style.display = 'flex';
    }

    function closeInsModal() {
        document.getElementById('fullDescModal').style.display = 'none';
    }

    // === æ–°å¢ï¼šç›´æ¥ä»å¼¹çª—é‡Œæ“ä½œç¼–è¾‘å’Œåˆ é™¤ ===
    
    function editCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€ç¼–è¾‘ï¼Œä½“éªŒæ›´å¥½
        setTimeout(() => {
            editCurrentChar(); // è°ƒç”¨å·²æœ‰çš„ç¼–è¾‘å‡½æ•°
        }, 200);
    }

    function deleteCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€åˆ é™¤ç¡®è®¤
        setTimeout(() => {
            openDelConfirm(); // è°ƒç”¨å·²æœ‰çš„åˆ é™¤ç¡®è®¤å‡½æ•°
        }, 200);
    }

    // 10. è¯¦æƒ…é¡µäº¤äº’ï¼šç¼–è¾‘ä¸åˆ é™¤
    async function editCurrentChar() {
        const list = await getCharList();
        const char = list.find(c => c.id === editingCharId);
        if(char) {
            document.getElementById('modal-title').textContent = "Edit Profile";
            document.getElementById('char-name-in').value = char.name;
            document.getElementById('char-desc-in').value = char.desc;
            tempCharAvatar = char.avatar;
            document.getElementById('edit-avatar-preview').src = char.avatar;
            document.getElementById('edit-avatar-preview').style.display = 'block';
            document.getElementById('edit-avatar-hint').style.display = 'none';
            document.getElementById('charEditModal').style.display = 'flex';
        }
    }

    function openDelConfirm() { document.getElementById('delConfirmModal').style.display = 'flex'; }
    
    async function confirmDelete() {
        let list = await getCharList();
        list = list.filter(c => c.id !== editingCharId);
        await saveCharList(list);
        
        document.getElementById('delConfirmModal').style.display = 'none';
        closeDetailView();
        renderCharList();
        showToast("Character Deleted");
    }
</script>
</body>
</html>
