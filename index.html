<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lune Phone</title>
    <script src="https://cdn.jsdelivr.net/npm/pinyin@2.11.2/lib/web-pinyin.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <style>
        /* å¯¼å…¥é¡¶çº§è‰ºæœ¯å­—ä½“ï¼šCormorant Garamondï¼ˆæè‡´ä¼˜é›…ï¼‰å’Œ Dancing Scriptï¼ˆçµåŠ¨æ„å‘ï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;1,300&family=Dancing+Script:wght@500&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500&family=Great+Vibes&family=Cormorant+Garamond:ital,wght@1,500&display=swap');
        :root {
            /* èƒŒæ™¯ï¼šæ›´æ¸…é€çš„æå…‰è“ */
            --bg-gradient: linear-gradient(160deg, #a1fdd4 0%, #c2fbe5 100%);
            --glass: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.5);
            --blur: saturate(180%) blur(40px);
            --text-main: #1d1d1f;
            --text-sub: #555;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --font-zh-serif: 'Noto Serif SC', serif; /* ä¸­æ–‡å®‹ä½“ */
            --font-en-script: 'Great Vibes', cursive; /* è‹±æ–‡æ‰‹å†™ä½“ */
            --font-en-serif: 'Cormorant Garamond', serif; /* è‹±æ–‡è¡¬çº¿ä½“ */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            width: 100%; height: 100vh; overflow: hidden; 
            background: var(--bg-gradient); 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
            display: flex; flex-direction: column;
        }

        /* 1. çŠ¶æ€æ  (å±‚çº§è°ƒåˆ°æœ€é«˜ï¼Œä¿è¯ App æ‰“å¼€æ—¶å®ƒè¿˜åœ¨æœ€ä¸Šé¢) */
        .status-bar {
            height: 48px; padding: 0 24px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--text-main); font-weight: 600; font-size: 15px; 
            z-index: 9999; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šå±‚çº§æœ€é«˜ */
            position: relative; /* ç¡®ä¿ z-index ç”Ÿæ•ˆ */
        }
        .status-right { display: flex; align-items: center; gap: 6px; }
        .bat-text { font-size: 13px; font-weight: 700; margin-right: 4px; }
        .battery-box { width: 25px; height: 12px; border: 1.5px solid var(--text-main); border-radius: 3px; padding: 1px; position: relative; opacity: 0.8; }
        .bat-fill { height: 100%; background: var(--text-main); border-radius: 1px; width: 60%; }
        .bat-tip { position: absolute; right: -3px; top: 2.5px; width: 2px; height: 3px; background: var(--text-main); border-radius: 0 2px 2px 0; }

        /* 2. æ ¸å¿ƒå¸ƒå±€ */
        .main-container {
            flex: 1; 
            padding: 10px 22px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 2.3fr 1fr 0.7fr 1.1fr 1.1fr; 
            gap: 16px;
            align-items: center;
        }

        /* é€šç”¨å¡ç‰‡ */
        .widget {
            background: var(--glass);
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        /* å¢åŠ ç»ç’ƒé«˜å…‰ï¼Œæ˜¾å¾—æ›´é«˜çº§ */
        .widget::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }

        .w-2x2 { grid-column: span 2; }
        .w-4x1 { grid-column: span 4; }

        /* å¤©æ°”ç»„ä»¶ */
        .weather-content { display: flex; flex-direction: column; height: 100%; justify-content: space-between; position: relative; z-index: 2; }
        .w-date-block { display: flex; flex-direction: column; }
        .w-day { font-size: 11px; font-weight: 800; color: #ff3b30; text-transform: uppercase; margin-bottom: 2px; }
        .w-date { font-size: 13px; font-weight: 600; color: #555; text-transform: uppercase; }
        .w-icon-area { width: 60px; height: 60px; margin: 5px 0 0 -5px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); }
        .w-temp { font-size: 42px; font-weight: 800; color: #1d1d1f; line-height: 1; letter-spacing: -2px; }
        .w-city { font-size: 13px; font-weight: 600; color: #666; margin-top: 4px; display: flex; align-items: center; gap:4px; }

        /* å›¾ç‰‡ç»„ä»¶ */
        .pic-container { height: 100%; display: flex; flex-direction: column; position: relative; z-index: 2; }
        .pic-text { font-size: 14px; font-weight: 700; font-style: italic; color: #222; margin-bottom: 10px; line-height: 1.3; }
        .pic-wrapper { flex: 1; width: 100%; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.05); position: relative; }
        .pic-img { width: 100%; height: 100%; object-fit: cover; }

        /* éŸ³ä¹ç»„ä»¶ */
        .music-row { display: flex; align-items: center; justify-content: space-between; height: 100%; position: relative; z-index: 2; }
        .album-cover { width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .track-info { display: flex; flex-direction: column; margin-left: 14px; margin-right: auto; justify-content: center; }
        .track-title { font-size: 15px; font-weight: 700; color: #1d1d1f; }
        .track-artist { font-size: 12px; color: #666; margin-top: 3px; }
        .ctrl-btns { display: flex; gap: 16px; align-items: center; flex-shrink: 0; opacity: 0.8; }

        /* === ä¿®å¤é‡ç‚¹ï¼šè¿›åº¦æ¡ === */
        .prog-stack { display: flex; flex-direction: column; justify-content: center; height: 100%; gap: 10px; position: relative; z-index: 2; }
        .prog-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: #444; text-transform: uppercase; }
        
        /* è½¨é“ï¼šæ·±è‰²åŠé€æ˜ï¼Œç¡®ä¿å¯¹æ¯”åº¦ */
        .prog-bg { 
            width: 100%; height: 14px; 
            background: rgba(0,0,0,0.15); 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        /* å¡«å……ï¼šçº¯ç™½ + å‘å…‰ */
        .prog-fg { 
            height: 100%; 
            min-height: 14px; /* å¼ºåˆ¶ç»™ä¸€ä¸ªå’Œçˆ¶å…ƒç´ ä¸€æ ·çš„é«˜åº¦ */
            background: #057b46; 
            width: 0%; 
            transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); 
            box-shadow: 0 0 15px rgba(255,255,255,0.8); /* å…³é”®ï¼šç™½è‰²å‘å…‰ */
            border-radius: 20px;
        }

        /* App å›¾æ ‡ - ä¼˜åŒ–è´¨æ„Ÿï¼Œå»é™¤å»‰ä»·å‘å…‰ */
        .app-cell { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 8px; }
        .icon-shape { 
            width: 60px; height: 60px; border-radius: 16px; 
            background: rgba(255,255,255,0.85); 
            /* æ›´åƒå®ä½“ç»ç’ƒçš„é˜´å½± */
            box-shadow: 0 4px 8px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,1);
            display: flex; align-items: center; justify-content: center; color: #333;
            backdrop-filter: blur(10px);
        }
        .app-name { font-size: 11px; font-weight: 600; color: #1d1d1f; text-shadow: 0 1px 1px rgba(255,255,255,0.5); }
        .svg-icon { width: 30px; height: 30px; fill: currentColor; }

        /* === ä¿®å¤é‡ç‚¹ï¼šDock & å°ç™½æ¡ === */
        .dock-container { 
            flex-shrink: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-end; 
            padding-bottom: 30px; /* ç»™å°ç™½æ¡ç•™ä½ç½® */
            position: relative; z-index: 50;
        }
        .dock-bar { 
            width: 90%; max-width: 380px; height: 85px; 
            background: rgba(255,255,255,0.4); 
            backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 42px; 
            display: flex; align-items: center; justify-content: space-evenly; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
        }
        .dock-app { width: 58px; height: 58px; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* å¼ºåˆ¶æ˜¾å½¢çš„å°ç™½æ¡ */
        .home-indicator { 
            position: absolute; 
            bottom: 8px; /* è·ç¦»åº•éƒ¨ 8px */
            left: 50%; transform: translateX(-50%);
            width: 135px; height: 5px; 
            background: #ffffff; /* çº¯ç™½ */
            border-radius: 10px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            z-index: 9999; /* æœ€é¡¶å±‚ */
            display: block !important;
        }

        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(15px); z-index: 2000; display: none; align-items: flex-end; }
        .modal-content { width: 100%; background: #fff; border-radius: 36px 36px 0 0; padding: 25px; padding-bottom: 50px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from {transform:translateY(100%)} to {transform:translateY(0)} }
        .modal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-h1 { font-size: 18px; font-weight: 700; }
        .modal-done { color: #007AFF; font-weight: 700; cursor: pointer; }
        /* --- iOS åˆ†æ®µæ§åˆ¶å™¨æ ·å¼ --- */
.segment-control {
    display: flex;
    background: #eeeeef;
    padding: 3px;
    border-radius: 12px;
    margin-bottom: 15px;
}

.segment-btn {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #636366;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.segment-btn.active {
    background: #ffffff;
    color: #000000;
    box-shadow: 0 2px 4px rgba(0,0,0,0.12);
}

/* --- è§†å›¾åˆ‡æ¢é€»è¾‘ --- */
.city-view {
    display: none; /* é»˜è®¤éšè— */
    animation: fadeIn 0.3s ease;
}

.city-view.active {
    display: block; /* æ¿€æ´»æ—¶æ˜¾ç¤º */
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
        .city-tag { padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; font-size: 13px; font-weight: 600; cursor: pointer; }
        .upload-tools { display: flex; gap: 10px; margin-top: 10px; }
        .tool-btn { flex: 1; padding: 14px; background: #f2f2f7; border-radius: 12px; text-align: center; color: #007AFF; font-weight: 600; cursor: pointer; }


    /* --- App Window (å…¨å±åº”ç”¨æ¨¡å¼) --- */
.ios-app-window {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #F2F2F7; 
    z-index: 5000; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šæ¯”çŠ¶æ€æ ä½ï¼Œæ¯”æ¡Œé¢é«˜ */
    display: flex; flex-direction: column;
    transform: translateX(100%); 
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    padding-top: 48px; /* â—æ ¸å¿ƒä¿®æ”¹ï¼šç»™çŠ¶æ€æ ç•™å‡ºä½ç½® */
}
.ios-app-window.active { transform: translateX(0); }

/* App Header */
.app-header {
    height: 60px; padding: 0 24px; 
    display: flex; align-items: center; justify-content: space-between;
    background: transparent; /* é€æ˜èƒŒæ™¯ï¼Œæ›´ç°ä»£ */
    flex-shrink: 0;
}
.header-title-big { 
    font-size: 32px; font-weight: 800; color: #000; letter-spacing: -0.5px; 
}
.header-close-btn {
    width: 36px; height: 36px; background: #e5e5ea; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #8e8e93; cursor: pointer;
    font-weight: 700; font-size: 14px;
}
.header-left { display: flex; align-items: center; color: #007AFF; font-size: 16px; cursor: pointer; }
.header-title { font-weight: 600; font-size: 16px; color: #000; }
.header-right { width: 60px; } /* å ä½ */

/* App Body */
.app-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
.app-title-large { font-size: 28px; font-weight: 800; color: #000; align-self: flex-start; margin-bottom: 10px; }

/* é¢„è§ˆæ¡† (æ‰‹æœºæ¯”ä¾‹) */
.preview-stage {
    width: 200px; height: 400px; 
    background: #fff; border-radius: 24px;
    /* é‡ç‚¹ï¼šå±…ä¸­å¸ƒå±€ï¼Œé˜²æ­¢å†…å®¹ä¹±è·‘ */
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    border: 8px solid #fff;
    margin-bottom: 30px;
    overflow: hidden;
    position: relative;
    flex-shrink: 0;
}
.phone-frame { width: 100%; height: 100%; position: relative; }
/* å…³é”®ï¼šé»˜è®¤å…¨éƒ¨éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
.phone-frame img, .phone-frame video { 
    width: 100%; height: 100%; object-fit: cover; display: none; 
}
.preview-placeholder {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    color: #999; font-weight: 600; font-size: 14px; width: 100%; text-align: center;
}

/* æŒ‰é’®ç»„ */
.action-area { width: 100%; display: flex; flex-direction: column; gap: 12px; }
.ios-btn {
    width: 100%; padding: 16px; border-radius: 14px; border: none;
    font-size: 16px; font-weight: 700; cursor: pointer;
    transition: transform 0.1s;
}
.ios-btn:active { transform: scale(0.98); }
.ios-btn.primary { background: #007AFF; color: #fff; }
.ios-btn.secondary { background: #fff; color: #007AFF; }

/* Toast æç¤º */
.ios-toast {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    background: rgba(25,25,25,0.8); backdrop-filter: blur(10px);
    color: #fff; padding: 20px 40px; border-radius: 20px;
    font-weight: 600; opacity: 0; pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    z-index: 1000;
}
.ios-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

/* 4. å£çº¸å†å²è®°å½• (æ–°å¢æ ·å¼) */
.history-section { padding: 0 20px 40px 20px; width: 100%; }
.history-title { font-size: 18px; font-weight: 700; color: #000; margin: 30px 0 15px 0; }
.history-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
}
.history-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 9/16; background: #eee; cursor: pointer; }
.history-item.active { border-color: #007AFF; }
.history-item img { width: 100%; height: 100%; object-fit: cover; }
.vid-badge {
    position: absolute; top: 6px; right: 6px;
    background: rgba(0,0,0,0.6); color: #fff;
    font-size: 9px; font-weight: 800; padding: 2px 6px;
    border-radius: 4px; backdrop-filter: blur(4px);
    border: 0.5px solid rgba(255,255,255,0.3);
}
.history-del {
    position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
    background: rgba(255, 59, 48, 0.9); border-radius: 50%; color: #fff;
    display: flex; align-items: center; justify-content: center; font-size: 12px;
}
/* --- 3. iOS é£æ ¼æˆåŠŸå¼¹çª— (Alert) --- */
.ios-alert-mask {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
    z-index: 10000; /* æœ€é«˜å±‚çº§ */
    display: none; align-items: center; justify-content: center;
    animation: fadeIn 0.2s;
}
.ios-alert-box {
    width: 270px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
    border-radius: 14px; text-align: center; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: scale(1.1); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
.alert-title { font-size: 17px; font-weight: 700; margin: 20px 0 5px 0; color: #000; }
.alert-msg { font-size: 13px; color: #000; padding: 0 15px 20px 15px; line-height: 1.4; }
.alert-btn { 
    border-top: 0.5px solid rgba(60,60,67,0.29); 
    padding: 12px; color: #007AFF; font-size: 17px; font-weight: 600; cursor: pointer;
}
.alert-btn:active { background: rgba(0,0,0,0.05); }

@keyframes popIn { to { transform: scale(1); } }
/* --- è§’è‰²ä¹¦ä¸“ç”¨æ ·å¼ --- */

/* 1. è§’è‰²åˆ—è¡¨ç½‘æ ¼ */
.char-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
.char-card {
    background: #fff; border-radius: 16px; overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
    transition: transform 0.2s; cursor: pointer;
}
.char-card:active { transform: scale(0.96); }
.char-card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
.char-card-info { padding: 12px; }
.char-card-name { font-weight: 700; font-size: 15px; color: #000; margin-bottom: 4px; }
.char-card-desc { font-size: 11px; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

/* 2. è¯¦æƒ…é¡µè§†å›¾ (è¦†ç›–åœ¨åˆ—è¡¨ä¸Š) */
.char-detail-view {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 10; display: none; flex-direction: column; overflow-y: auto;
    animation: slideInRight 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes slideInRight { from {transform: translateX(100%);} to {transform: translateX(0);} }

/* é¡¶éƒ¨èƒŒæ™¯å›¾ */
.char-hero-bg {
    width: 100%; height: 240px; background-color: #ddd; background-size: cover; background-position: center;
    position: relative; flex-shrink: 0; cursor: pointer;
}
.bg-hint {
    position: absolute; bottom: 10px; right: 10px; 
    background: rgba(0,0,0,0.5); color: #fff; font-size: 10px; 
    padding: 4px 8px; border-radius: 12px; backdrop-filter: blur(4px);
}

/* å†…å®¹å®¹å™¨ (å¤„ç†å¤´åƒé‡å ) */
.char-content {
    background: #fff; flex: 1; border-radius: 24px 24px 0 0;
    margin-top: -30px; /* å…³é”®ï¼šè´Ÿè¾¹è·å®ç°é‡å  */
    position: relative; padding: 0 20px 40px 20px;
}

/* è¯¦æƒ…å¤´åƒ */
.char-avatar-container {
    width: 110px; height: 110px; /*ç¨å¾®æ”¹å¤§ä¸€ç‚¹ç‚¹æ›´éœ¸æ°”*/
    border-radius: 50%; 
    border: 4px solid #fff; 
    background: #fff;
    position: absolute; 
    top: -55px; /* ä¸Šæµ®è·ç¦» */
    
    /* ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šæ°´å¹³å±…ä¸­ä¸‡èƒ½å…¬å¼ */
    left: 50%;
    transform: translateX(-50%); 
    
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
    overflow: hidden;
    z-index: 5;
}
#detail-avatar { width: 100%; height: 100%; object-fit: cover; }

/* è¯¦æƒ…ä¿¡æ¯ */
.char-info-block { 
    margin-top: 65px; /* ç•™å‡ºå¤´åƒçš„ä½ç½® */
    display: flex; 
    flex-direction: column; 
    align-items: center; /* è®©åå­—ã€ç®€ä»‹ã€æŒ‰é’®å…¨éƒ¨å±…ä¸­ */
    text-align: center;  /* è®©æ–‡å­—å±…ä¸­å¯¹é½ */
}

.char-name { 
    font-size: 28px; 
    font-weight: 800; 
    color: #000; 
    margin-bottom: 12px; 
    letter-spacing: -0.5px;
}

.char-desc-preview {
    font-size: 15px; 
    line-height: 1.6; 
    color: #555; 
    background: #f2f2f7; 
    padding: 16px 20px; 
    border-radius: 18px;
    cursor: pointer;
    text-align: left; /* ç®€ä»‹å†…å®¹è¿˜æ˜¯é å·¦è¯»èµ·æ¥æ¯”è¾ƒèˆ’æœï¼Œæˆ–è€…æ”¹æˆ center ä¹Ÿå¯ä»¥ */
    width: 100%;      /* æ’‘æ»¡å®½åº¦ */
    max-width: 320px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå®½éš¾çœ‹ */
}

/* æŒ‰é’®ç»„å±…ä¸­ */
.char-actions { 
    display: flex; 
    gap: 12px; 
    margin-top: 30px; 
    width: 100%;
    justify-content: center; /* æŒ‰é’®æ°´å¹³å±…ä¸­ */
}

/* æ‚¬æµ®è¿”å›æŒ‰é’® */
.floating-back {
    position: absolute; top: 50px; left: 20px; width: 40px; height: 40px;
    background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; z-index: 20;
    color: #000;
}

/* 3. ä¸Šä¼ ç›¸å…³ */
.char-upload-circle {
    width: 80px; height: 80px; border-radius: 50%; background: #f2f2f7;
    display: flex; align-items: center; justify-content: center;
    color: #007AFF; font-weight: 600; cursor: pointer; overflow: hidden; position: relative;
}
#edit-avatar-preview { width: 100%; height: 100%; object-fit: cover; }

/* é€šç”¨è¾“å…¥æ¡† */
.ios-input {
    width: 100%; padding: 12px; background: #f2f2f7; border: none; border-radius: 10px;
    font-size: 16px; margin-bottom: 12px; font-family: inherit;
}

/* --- 4. åŸåˆ›é«˜çº§æ‚å¿—é£å¡ç‰‡ (Aesthetic Style) --- */
.aesthetic-card {
    width: 88%; max-width: 360px; height: 80vh;
    background: #fff; 
    border-radius: 32px; 
    position: relative; overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.5) inset;
    display: flex; flex-direction: column;
    animation: floatUp 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}

/* 1. é¡¶éƒ¨æ°›å›´åŒº */
.aes-hero {
    height: 180px; width: 100%; position: relative; flex-shrink: 0;
    overflow: hidden;
}
.aes-blur-bg {
    width: 120%; height: 120%; position: absolute; top: -10%; left: -10%;
    background-size: cover; background-position: center;
    filter: blur(40px) saturate(150%); opacity: 0.8;
}
.aes-noise {
    /* æ·»åŠ ä¸€ç‚¹æ‚è‰²é¢—ç²’æ„Ÿï¼Œå¢åŠ é«˜çº§çº¸è´¨æ„Ÿ */
    position: absolute; inset: 0; opacity: 0.08;
    background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIj48ZmlsdGVyIGlkPSJnoiPjGZlV1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=');
}
.aes-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,1) 100%);
}

/* 2. æ‚¬æµ®å†…å®¹åŒº */
.aes-float-content {
    margin-top: -60px; padding: 0 24px; position: relative; z-index: 2;
    display: flex; flex-direction: column; align-items: center; text-align: center;
}
.aes-avatar-box {
    width: 100px; height: 100px; border-radius: 28px; /* æ›´åŠ ç°ä»£çš„åœ†è§’çŸ©å½¢ */
    padding: 4px; background: #fff;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    transform: rotate(-3deg); /* å¾®å¾®å€¾æ–œï¼Œå¢åŠ è®¾è®¡æ„Ÿ */
    transition: transform 0.3s ease;
}
.aesthetic-card:hover .aes-avatar-box { transform: rotate(0deg) scale(1.05); }

.aes-avatar-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 24px; }

.aes-title-group { margin-top: 15px; margin-bottom: 20px; }
.aes-name { 
    font-family: -apple-system, serif; /* å°è¯•è¡¬çº¿ä½“å¢åŠ é«˜çº§æ„Ÿ */
    font-size: 24px; font-weight: 800; color: #111; letter-spacing: -0.5px; 
}
.aes-tag {
    display: inline-block; margin-top: 6px;
    font-size: 9px; font-weight: 700; letter-spacing: 2px; color: #999;
    border: 1px solid #eee; padding: 4px 10px; border-radius: 20px;
    text-transform: uppercase;
}

/* 3. æ–‡æœ¬æ»šåŠ¨åŒº */
.aes-scroll-area {
    flex: 1; overflow-y: auto; padding: 0 28px 20px 28px;
    -webkit-overflow-scrolling: touch;
    mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20px, black 90%, transparent 100%);
}
.aes-scroll-area::-webkit-scrollbar { display: none; }

.aes-text-body {
    font-size: 15px; line-height: 1.8; color: #444; text-align: justify;
    font-weight: 400; white-space: pre-wrap;
}
.aes-divider { text-align: center; margin-top: 30px; color: #ddd; font-size: 12px; }

/* 4. åº•éƒ¨æ§åˆ¶æ  */
.aes-control-bar {
    padding: 20px 30px 30px 30px; display: flex; gap: 15px;
    background: #fff; z-index: 5;
}
.aes-btn {
    flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px; border-radius: 16px; font-size: 14px; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
}
.aes-btn.edit { background: #f5f5f7; color: #333; }
.aes-btn.edit:active { background: #e5e5ea; transform: scale(0.98); }

.aes-btn.delete { background: #fff0f0; color: #ff3b30; }
.aes-btn.delete:active { background: #ffe5e5; transform: scale(0.98); }

@keyframes floatUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
/* --- æ–°å¢ï¼šé¡¶éƒ¨æ‚¬æµ®æŒ‰é’®æ ·å¼ --- */
.aes-top-bar {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 20px; display: flex; justify-content: space-between;
    z-index: 10; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç©ºç™½åŒºåŸŸ */
}

.aes-icon-circle {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,0.2); 
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer; pointer-events: auto; /* æ¢å¤æŒ‰é’®ç‚¹å‡» */
    transition: transform 0.2s, background 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.aes-icon-circle:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }
.aes-icon-circle.close { background: rgba(0,0,0,0.15); } /* å…³é—­æŒ‰é’®ç¨å¾®æ·±ä¸€ç‚¹ */
/* --- è™šçº¿æ·»åŠ å¡ç‰‡æ ·å¼ --- */
.char-card.add-new {
    background: rgba(0,0,0,0.02);
    border: 2px dashed #ccc;
    box-shadow: none;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: #999;
    min-height: 200px; /* Ensure same height as others */
}
.char-card.add-new:active { background: rgba(0,0,0,0.05); border-color: #bbb; }

.add-icon-big {
    width: 40px; height: 40px; margin-bottom: 8px; opacity: 0.5;
}
.add-text { font-size: 14px; font-weight: 600; }
/* --- Settings App åˆ—è¡¨æ ·å¼ --- */
.ios-list-group {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.ios-list-item {
    display: flex; align-items: center;
    padding-left: 16px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s;
    height: 48px; /* æ ‡å‡† iOS åˆ—è¡¨é«˜åº¦ */
}
.ios-list-item:active { background: #f2f2f7; }

.item-icon {
    width: 28px; height: 28px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    margin-right: 12px; flex-shrink: 0;
}

.item-content {
    flex: 1; height: 100%;
    display: flex; align-items: center; justify-content: space-between;
    padding-right: 16px;
    border-bottom: 0.5px solid #c6c6c8; /* iOS ç»å…¸åˆ†å‰²çº¿ */
}

.item-label { font-size: 16px; color: #000; font-weight: 400; }

.item-right { display: flex; align-items: center; gap: 6px; }
.item-value { font-size: 16px; color: #8e8e93; }
.chevron { opacity: 0.5; }
/* --- Timezone Search Styles --- */
.ios-search-wrapper {
    background: rgba(118, 118, 128, 0.12); /* iOS æ ‡å‡†æœç´¢æ¡†åº•è‰² */
    border-radius: 10px;
    display: flex; align-items: center;
    padding: 15px 10px;
    transition: background 0.2s;
}
.ios-search-wrapper:focus-within {
    background: rgba(118, 118, 128, 0.18);
}

.search-icon {
    width: 16px; height: 16px; 
    stroke: #8e8e93; stroke-width: 2.5; fill: none;
    margin-right: 8px; flex-shrink: 0;
}

.ios-search-input {
    border: none; background: transparent; outline: none;
    font-size: 16px; color: #000; flex: 1; padding: 0;
    font-family: inherit;
}
.ios-search-input::placeholder { color: #8e8e93; }

/* åˆ—è¡¨æ ‡é¢˜æ ·å¼ */
.tz-group-title {
    padding: 0 16px; margin-bottom: 6px; margin-top: 24px;
    font-size: 12px; font-weight: 600; color: #6e6e73;
    text-transform: uppercase; letter-spacing: 0.5px;
}
/* --- ğŸš‘ ä¿®å¤æ—¶åŒºé¡µé¢æ‰“ä¸å¼€çš„é—®é¢˜ --- */
.ios-sub-page {
    /* é»˜è®¤è—åœ¨å³è¾¹ */
    transform: translateX(100%);
    /* æ·»åŠ ä¸æ»‘åŠ¨ç”» */
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
}

/* --- ğŸš‘ å¼ºåˆ¶ä¿®å¤æ—¶åŒºåˆ—è¡¨å®½åº¦ (è®©å®ƒæ’‘æ»¡å±å¹•) --- */

/* 1. æ ¸å¿ƒä¿®å¤ï¼šæŠŠå®¹å™¨çš„å¯¹é½æ–¹å¼ä»â€œå±…ä¸­â€æ”¹ä¸ºâ€œæ‹‰ä¼¸â€ */
#subpage-timezone .app-body {
    align-items: stretch !important; /* å…³é”®ï¼è®©å­å…ƒç´ æ¨ªå‘æ’‘æ»¡ */
    width: 100% !important;
    padding: 0 16px 80px 16px !important; /* å·¦å³ç•™ 16px çš„èˆ’é€‚è¾¹è· */
    box-sizing: border-box !important;
}

/* 2. ç¡®ä¿åˆ—è¡¨ç»„ä¹Ÿæ˜¯æ»¡å®½çš„ */
#subpage-timezone .ios-list-group {
    width: auto !important; /* è‡ªåŠ¨å¡«æ»¡çˆ¶å®¹å™¨ */
    margin-left: 0 !important;
    margin-right: 0 !important;
    border-radius: 12px !important; /* ä¿æŒåœ†è§’ */
}

/* 3. (å¯é€‰) å¦‚æœä½ è§‰å¾—æœç´¢æ¡†ä¹Ÿå¤ªçª„ï¼ŒåŠ ä¸Šè¿™ä¸ª */
#subpage-timezone .timezone-top-area {
    width: 100% !important;
}
/* --- ğŸš‘ ä¿®å¤æ—¶åŒºé€‰ä¸­å¯¹å‹¾ä¸æ˜¾ç¤ºçš„é—®é¢˜ --- */

/* 1. å®šä¹‰å¯¹å‹¾å®¹å™¨ */
#subpage-timezone .item-check {
    width: 20px; height: 20px;
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.2s;
    
    /* ğŸ‘‡ æ ¸å¿ƒé­”æ³•ï¼šç›´æ¥ç”¨ CSS ç”»å‡ºè“è‰²å¯¹å‹¾èƒŒæ™¯ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23007AFF' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
}

/* 2. æ¿€æ´»æ—¶æ˜¾ç¤º */
#subpage-timezone .item-check.active {
    opacity: 1;
}

/* 3. éšè—åŸæœ¬ HTML é‡Œå¯èƒ½æ®‹ç•™çš„ SVG (é¿å…é‡å½±) */
#subpage-timezone .item-check svg {
    display: none !important;
}
/* =========================================================
   ğŸš‘ ç»ˆæå¼ºåˆ¶ä¿®å¤ï¼šAPI é¡µé¢ (ç»å¯¹å®šä½ç‰ˆ - å«æ–‡å­—é—´è·ä¿®å¤)
   ========================================================= */

/* 1. é¡µé¢å®¹å™¨ï¼šé“ºæ»¡å…¨å±ï¼Œå‰ªè£æº¢å‡º */
#subpage-api {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 20 !important;
    padding-top: 0 !important; /* æ¸…é™¤æ‰€æœ‰å†…è¾¹è·å¹²æ‰° */
    display: block !important; /* âŒ å¼ƒç”¨ Flexï¼Œæ”¹ç”¨å—çº§ */
}

/* 2. å¤´éƒ¨ï¼šé’‰æ­»åœ¨é¡¶éƒ¨ (0px - 110px) */
#subpage-api .app-header {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important;
    height: 110px !important; /* å›ºå®šé«˜åº¦ */
    
    padding-top: 55px !important; /* é¿å¼€åˆ˜æµ· */
    padding-bottom: 10px !important;
    box-sizing: border-box !important;
    
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    z-index: 50 !important;
    
    display: flex !important;
    align-items: flex-end !important;
}

/* 3. å†…å®¹åŒºï¼šé’‰æ­»åœ¨å‰©ä½™ç©ºé—´ (110px - åº•éƒ¨) - æ ¸å¿ƒæ»šåŠ¨åŒº */
#subpage-api .app-body {
    position: absolute !important;
    top: 110px !important;  /* ğŸ‘‡ ç´§æ¥å¤´éƒ¨ä¸‹æ–¹ */
    bottom: 0 !important;   /* ğŸ‘‡ ä¸€ç›´åˆ°åº• */
    left: 0 !important; right: 0 !important;
    
    height: auto !important; /* âŒ ç¦æ­¢å›ºå®šé«˜åº¦ */
    width: 100% !important;
    
    overflow-y: auto !important; /* âœ… å¼€å¯æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch !important; /* ä¸æ»‘æ»šåŠ¨ */
    
    padding: 20px 16px 80px 16px !important; /* åº•éƒ¨ç•™ç™½ç»™æŒ‰é’® */
    box-sizing: border-box !important;
    
    display: block !important; /* åˆ—è¡¨é¡¹è‡ªç„¶å †å  */
}

/* 4. ã€æ ¸å¿ƒä¿®å¤ã€‘ç»™åˆ—è¡¨è¡ŒåŠ å¼ºåˆ¶å†…è¾¹è·ï¼Œè§£å†³æ–‡å­—è´´è¾¹é—®é¢˜ */
#subpage-api .ios-list-item {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    
    /* ğŸ‘‡ è¿™é‡Œï¼å¼ºåˆ¶å·¦å³ç•™å‡º 16px çš„å‘¼å¸ç©ºé—´ */
    padding-left: 16px !important; 
    padding-right: 16px !important; 
    
    box-sizing: border-box !important;
}

/* é’ˆå¯¹è¾“å…¥æ¡†è¡Œçš„ç‰¹æ®Šå¤„ç† */
#subpage-api .input-item {
    /* ç»§æ‰¿ä¸Šé¢çš„ paddingï¼Œä½†å¼ºåˆ¶å¯¹é½ */
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
}

#subpage-api .ios-input-clean {
    text-align: right !important; /* iOS é£æ ¼å³å¯¹é½ */
    width: 60% !important; /* å¼ºåˆ¶å å®½ */
    background: transparent !important;
    border: none !important;
    color: #007AFF !important;
    padding-right: 0 !important; /* è¾“å…¥æ¡†å†…éƒ¨ä¸ç”¨å†paddingäº†ï¼Œå› ä¸ºçˆ¶å…ƒç´ æœ‰äº† */
}

/* 5. ç¡®ä¿åˆ—è¡¨ç»„å®½åº¦æ­£å¸¸ */
#subpage-api .ios-list-group {
    width: 100% !important;
    margin: 0 0 20px 0 !important;
}

/* 6. ä¿®å¤åº•éƒ¨çº¢è‰²æŒ‰é’® */
#subpage-api .ios-btn {
    width: 100% !important;
    display: block !important;
    margin: 20px 0 40px 0 !important; /* åº•éƒ¨å¤šç•™ç‚¹ç©º */
}
/* =========================================================
   ğŸ’„ API é¡µé¢ï¼šç»†èŠ‚ç²¾ä¿®ä¸ä¸‹æ‹‰èœå•ç¾åŒ–
   ========================================================= */

/* 1. ä¿®å¤æ–‡å­—è´´è¾¹ (ç»™æ•´ä¸ªåˆ—è¡¨è¡ŒåŠ â€œå‘¼å¸ç©ºé—´â€) */
#subpage-api .ios-list-item {
    padding-right: 20px !important; /* å³è¾¹å¼ºåˆ¶ç•™å‡º 20px ç©ºéš™ */
    padding-left: 16px !important;
}

/* 2. ä¿®å¤è¾“å…¥æ¡† (å»é™¤è‡ªåŠ¨å¡«å……çš„è“è‰²èƒŒæ™¯ï¼Œå³å¯¹é½) */
#subpage-api .ios-input-clean {
    text-align: right !important;
    padding-right: 0 !important; /* è¾“å…¥æ¡†å†…éƒ¨ä¸ç”¨ç•™ç©ºï¼Œå› ä¸ºçˆ¶å…ƒç´ ç•™äº† */
    color: #007AFF !important;
    background: transparent !important;
    /* ğŸ‘‡ æš´åŠ›å»é™¤æµè§ˆå™¨è‡ªåŠ¨å¡«å……çš„åº•è‰² */
    box-shadow: 0 0 0px 1000px #fff inset !important; 
    -webkit-text-fill-color: #007AFF !important;
}

/* =========================================================
   ğŸ’„ ä¿®å¤ï¼šæ¨¡å‹é€‰æ‹©ä¸‹æ‹‰èœå• (å®Œç¾ä¼ªè£…æˆ iOS æŒ‰é’®)
   ========================================================= */

/* 1. åˆ—è¡¨é¡¹å®¹å™¨ï¼šè®¾ç½®ç›¸å¯¹å®šä½ï¼Œä¸ºäº†æ”¾ç®­å¤´ */
#subpage-api .ios-list-group .ios-list-item:has(select) {
    position: relative !important;
    overflow: hidden !important; /* é˜²æ­¢è¶…å‡º */
}

/* 2. æ ¸å¿ƒï¼šæŠŠ Select å½»åº•é€æ˜åŒ–ï¼Œåªä¿ç•™æ–‡å­— */
#subpage-api select.ios-input-clean {
    /* æŠ¹é™¤æµè§ˆå™¨æ‰€æœ‰é»˜è®¤æ ·å¼ */
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    
    /* èƒŒæ™¯é€æ˜ï¼Œæ— è¾¹æ¡† */
    background-color: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    
    /* å°ºå¯¸ä¸å¯¹é½ */
    width: 100% !important;
    height: 100% !important;
    
    /* ğŸ‘‡ å…³é”®ï¼šè®©æ–‡å­—å¼ºåˆ¶é å³ï¼Œå¹¶ä¸”ç•™å‡ºç®­å¤´çš„ä½ç½® */
    text-align: right !important;
    text-align-last: right !important; /* å…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ */
    direction: ltr !important; /* ä¿æŒä»å·¦åˆ°å³é˜…è¯»ï¼Œé˜²æ­¢æ–‡å­—åè½¬ */
    padding-right: 25px !important; /* å³è¾¹ç•™ç©ºç»™ç®­å¤´ */
    padding-left: 0 !important;
    
    /* å­—ä½“æ ·å¼ */
    color: #007AFF !important; /* iOS è“ */
    font-size: 16px !important;
    font-weight: 500 !important;
    font-family: inherit !important;
    
    /* å±‚çº§ */
    position: relative;
    z-index: 2; /* ä¿è¯èƒ½ç‚¹åˆ° */
    cursor: pointer;
}

/* 3. è‡ªå®šä¹‰ç®­å¤´ (ç”»ä¸€ä¸ªæ¼‚äº®çš„ç°è‰²å°ç®­å¤´) */
#subpage-api .ios-list-group .ios-list-item:has(select)::after {
    content: '' !important;
    position: absolute !important;
    right: 16px !important; /* è·ç¦»å³è¾¹ç¼˜ 16px */
    top: 50% !important;
    
    width: 7px !important;
    height: 7px !important;
    
    /* ç°è‰²çº¿æ¡ */
    border-top: 2px solid #C7C7CC !important;
    border-right: 2px solid #C7C7CC !important;
    
    /* æ—‹è½¬ 45 åº¦å˜æˆç®­å¤´ */
    transform: translateY(-50%) rotate(45deg) !important;
    pointer-events: none !important; /* è®©ç‚¹å‡»ç©¿é€è¿‡å» */
    z-index: 1 !important;
}

/* 4. ä¿®å¤ï¼šé˜²æ­¢é€‰ä¸­æ—¶å‡ºç°ä¸‘é™‹çš„è“è‰²èƒŒæ™¯/é»‘æ¡† */
#subpage-api select.ios-input-clean:focus {
    outline: none !important;
    background-color: transparent !important;
}
/* --- ğŸ’„ iOS åº•éƒ¨èœå• (Action Sheet) æ ·å¼ --- */
.ios-action-sheet {
    width: 96%; 
    max-width: 400px;
    margin-bottom: 12px; /* ç¦»åº•éƒ¨çš„è·ç¦» */
    display: flex; flex-direction: column;
    animation: slideUpSheet 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

@keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* æ ‡é¢˜åŒº */
.sheet-title-box {
    background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
    color: #8e8e93; font-size: 13px; font-weight: 600; text-align: center;
    padding: 14px; border-bottom: 0.5px solid rgba(0,0,0,0.1);
    border-radius: 14px 14px 0 0;
}

/* é€‰é¡¹æŒ‰é’® */
.sheet-item {
    background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
    padding: 18px; text-align: center; color: #007AFF; font-size: 17px;
    border-bottom: 0.5px solid rgba(0,0,0,0.1); cursor: pointer;
}
.sheet-item:active { background: rgba(255,255,255,0.5); }
.sheet-item:last-child { border-radius: 0 0 14px 14px; border-bottom: none; }

/* å–æ¶ˆæŒ‰é’® */
.sheet-cancel {
    margin-top: 8px; background: white; border-radius: 14px;
    padding: 16px; text-align: center; font-weight: 600; color: #007AFF; 
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/* =========================================================
   ğŸšï¸ æ»‘åŠ¨æ¡ç»ˆæç¾åŒ– (iOS åŸç”Ÿé£æ ¼)
   ========================================================= */

/* 1. æ»‘åŠ¨æ¡æœ¬ä½“ (è½¨é“) */
#subpage-api .ios-slider {
    -webkit-appearance: none !important; /* æ¸…é™¤é»˜è®¤ä¸‘æ ·å¼ */
    appearance: none !important;
    
    width: 100% !important;    /* ğŸ“ é•¿åº¦ï¼šå¼ºåˆ¶æ’‘æ»¡ï¼ */
    height: 4px !important;    /* é«˜åº¦ï¼šiOS æ ‡å‡†ç»†è½¨é“ */
    
    /* åŠ¨æ€èƒŒæ™¯ï¼šåˆ©ç”¨ CSS å˜é‡å®ç° å·¦è“å³ç° */
    background: linear-gradient(to right, #007AFF 0%, #007AFF var(--percent, 50%), #E5E5EA var(--percent, 50%), #E5E5EA 100%) !important;
    
    border-radius: 2px;
    outline: none;
    margin: 10px 0 0 0 !important; /* è°ƒæ•´é—´è· */
    display: block;
    padding: 0 !important;
    cursor: pointer;
}

/* 2. æ»‘å—å¤´ (é‚£ä¸ªç™½è‰²åœ†çƒ) */
#subpage-api .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    
    height: 28px !important; 
    width: 28px !important;    /* iOS æ ‡å‡†å¤§åœ†çƒ */
    border-radius: 50%;
    
    background: #FFFFFF !important; /* çº¯ç™½ */
    
    /* âœ¨ çµé­‚é˜´å½±ï¼šè®©å®ƒæµ®èµ·æ¥ */
    box-shadow: 0 3px 7px rgba(0,0,0,0.3), 0 0 0 0.5px rgba(0,0,0,0.05) !important;
    
    margin-top: -12px !important; /* å‚ç›´å±…ä¸­ä¿®æ­£: (4 - 28) / 2 = -12 */
    position: relative;
    z-index: 2;
    transition: transform 0.1s;
}

/* æŒ‰ä¸‹æ—¶ç¨å¾®å˜å¤§ */
#subpage-api .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.1);
}
/* =========================================================
   ğŸ’¬ èŠå¤©æµ‹è¯•åŒºç¾åŒ– (iMessage é£æ ¼)
   ========================================================= */

/* 1. èŠå¤©è®°å½•æ˜¾ç¤ºæ¡† */
.chat-log-area {
    background: #ffffff;
    border-radius: 12px;
    padding: 15px;
    height: 160px; /*ç¨å¾®åŠ é«˜ä¸€ç‚¹*/
    overflow-y: auto;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.03);
    -webkit-overflow-scrolling: touch;
    font-size: 14px;
}

/* 2. åº•éƒ¨è¾“å…¥æ å®¹å™¨ */
.chat-input-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

/* 3. è¾“å…¥æ¡† (ç°è‰²èƒ¶å›Š) */
.chat-input-field {
    flex: 1;
    height: 44px;
    background: #E5E5EA; /* iOS ç°è‰²åº• */
    border-radius: 22px; /* èƒ¶å›Šåœ†è§’ */
    border: none;
    padding: 0 18px;
    font-size: 16px;
    color: #000;
    outline: none;
    transition: background 0.2s;
    
    /* ä¿®å¤ä¹‹å‰çš„å¼ºåˆ¶å³å¯¹é½ï¼Œè¿™é‡Œéœ€è¦å·¦å¯¹é½ */
    text-align: left !important; 
    box-shadow: none !important;
}
.chat-input-field:focus {
    background: #D1D1D6; /* èšç„¦æ—¶ç¨å¾®å˜æ·± */
}

/* 4. å‘é€æŒ‰é’® (è“è‰²åœ†å½¢) */
.chat-send-btn {
    width: 44px; height: 44px;
    background: #007AFF;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0,122,255,0.3);
    transition: transform 0.1s;
}
.chat-send-btn:active {
    transform: scale(0.9);
}
/* =========================================================
   ğŸ¯ æ–‡å­—é¢œè‰²ç²¾å‡†é’©å­ (ä»…é’ˆå¯¹æ–‡æœ¬ï¼Œä¸å½±å“å¸ƒå±€)
   ========================================================= */

/* --- 1. æ¡Œé¢ä¸“å±é¢œè‰²é’©å­ --- */
/* çŠ¶æ€æ æ—¶é—´ã€ç™¾åˆ†æ¯”ã€ç”µé‡å›¾æ ‡ã€APPåã€å¤©æ°”æ–‡å­— */
.status-bar, 
.status-bar *, 
.app-name, 
.dock-bar .app-name,
.weather-content .w-day,
.weather-content .w-date,
.weather-content .w-temp,
.weather-content .w-city {
    color: var(--dynamic-desktop-color, #1d1d1f) !important;
    fill: var(--dynamic-desktop-color, #1d1d1f) !important;
}

/* --- 2. APP å†…éƒ¨ä¸“å±é¢œè‰²ä¸å­—ä½“é’©å­ --- */
/* è®¾ç½®åˆ—è¡¨ã€APIé…ç½®ã€èŠå¤©è®°å½•ã€è§’è‰²è¯¦æƒ… */
#settingsApp, 
#settingsApp .item-label, 
#settingsApp .item-value,
.chat-log-area,
.char-detail-view .char-name,
.char-detail-view .char-desc-preview {
    color: var(--dynamic-app-color, #1d1d1f) !important;
    /* åªæœ‰åœ¨è¿™äº›åœ°æ–¹æ‰åº”ç”¨åŠ¨æ€å­—ä½“å’Œå­—å· */
    font-family: var(--dynamic-font-family, inherit) !important;
    font-size: var(--dynamic-app-size, inherit) !important;
    font-weight: var(--dynamic-app-weight, inherit) !important;
}

/* --- 3. é¢„è§ˆåŒºç‹¬ç«‹æ ·å¼ (ç¡®ä¿é¢„è§ˆå’Œè®¾ç½®æ—¶ä¸€è‡´) --- */
#preview-text-main {
    color: var(--temp-app-color, #1d1d1f);
}
#preview-text-desktop {
    color: var(--temp-desktop-color, #1d1d1f);
}
/* è®©è°ƒè‰²ç›˜ input å˜åœ† */
.color-picker-circle {
    -webkit-appearance: none;
    appearance: none;
    border: none;
    width: 34px; height: 34px;
    border-radius: 50%;
    overflow: hidden;
    padding: 0;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 2px solid #fff;
    background: transparent;
}
.color-picker-circle::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker-circle::-webkit-color-swatch { border: none; border-radius: 50%; }
/* å¼ºè¡Œéš”ç¦»æ‰€æœ‰å­é¡µé¢ï¼Œç¡®ä¿å®ƒä»¬é»˜è®¤ä¸æ˜¾ç¤ºåœ¨æ¡Œé¢ä¸Š */
.ios-sub-page {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 100 !important;
    transform: translateX(100%); /* åˆå§‹çŠ¶æ€åœ¨å³è¾¹ */
    transition: transform 0.3s ease;
    display: flex !important; /* ä¿æŒå†…éƒ¨å¸ƒå±€ */
    flex-direction: column !important;
}

.ios-sub-page.active {
    transform: translateX(0) !important; /* æ¿€æ´»æ—¶æ»‘å…¥ */
}

/* ä¿æŠ¤æ¡Œé¢ç½‘æ ¼ä¸è¢«æ’‘å¤§ */
.main-container .app-name, .status-bar span {
    font-size: 11px !important;
    height: auto !important;
}
/* =========================================================
   ğŸ”¥ ç»ˆæé˜²å¾¡ï¼šå¼ºåˆ¶å­é¡µé¢æ»šåŠ¨ä¸å®Œæ•´æ¸²æŸ“
   ========================================================= */

/* 1. å­é¡µé¢å®¹å™¨ï¼šå¿…é¡»æ˜¯å›ºå®šé«˜åº¦ï¼Œä¸èƒ½æº¢å‡º */
#subpage-display {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important;
    z-index: 100 !important;
    display: flex !important;
    flex-direction: column !important; /* çºµå‘æ’åˆ—å¤´éƒ¨å’Œä¸»ä½“ */
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    padding: 0 !important;
    margin: 0 !important;
    box-sizing: border-box !important;
}

#subpage-display.active { transform: translateX(0) !important; }

/* 2. å¤´éƒ¨ï¼šé«˜åº¦å›ºå®š */
#subpage-display .app-header {
    flex-shrink: 0 !important; /* ç¦æ­¢è¢«å‹ç¼© */
    height: 110px !important;
    padding: 55px 16px 12px 16px !important;
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: flex-end !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. æ ¸å¿ƒï¼šå¼ºåˆ¶ä¸»ä½“åŒºåŸŸå æ®å‰©ä½™ç©ºé—´å¹¶å¼€å¯æ»šåŠ¨ */
#subpage-display .app-body {
    flex: 1 !important; /* å…³é”®ï¼šè‡ªåŠ¨å æ®å¤´éƒ¨ä»¥å¤–çš„æ‰€æœ‰é«˜åº¦ */
    overflow-y: auto !important; /* å…³é”®ï¼šå¼ºåˆ¶å¼€å¯æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch !important; /* ç§»åŠ¨ç«¯ä¸æ»‘ */
    padding: 20px 16px 120px 16px !important; /* åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«å°ç™½æ¡æŒ¡ä½ */
    display: block !important; /* æ¢å¤å—çº§æµï¼Œè®©åˆ—è¡¨æ­£å¸¸å †å  */
    box-sizing: border-box !important;
}

/* 4. ä¿®å¤åˆ—è¡¨é¡¹å¯¹é½ */
.color-item-row {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    min-height: 50px !important;
}
/* =========================================================
   ğŸšï¸ å­—ä½“é¡µæ»‘å—ï¼šç»ˆæç¾åŒ–ä¸å…¨å®½ä¿®å¤
   ========================================================= */

/* 1. å¼ºåˆ¶æ»‘å—è½¨é“æ’‘æ»¡ 100% å®½åº¦ */
#subpage-display .ios-slider {
    -webkit-appearance: none !important;
    appearance: none !important;
    width: 100% !important;   /* ğŸ‘ˆ è§£å†³ä½ è¯´çš„é•¿åº¦ä¸å¯¹ï¼Œå¿…é¡» 100% */
    height: 4px !important;    /* iOS ç»†è½¨é“ */
    border-radius: 2px !important;
    outline: none !important;
    margin: 15px 0 !important; /* ä¸Šä¸‹ç•™ç‚¹ç©ºï¼Œåˆ«æŒ¤ç€å­— */
    cursor: pointer !important;
    
    /* æ ¸å¿ƒï¼šåŠ¨æ€èƒŒæ™¯é€»è¾‘ */
    background: linear-gradient(to right, #007AFF 0%, #007AFF var(--percent, 50%), #E5E5EA var(--percent, 50%), #E5E5EA 100%) !important;
}

/* 2. é‚£ä¸ªç™½è‰²å¤§åœ†å¤´ */
#subpage-display .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    height: 28px !important; 
    width: 28px !important;
    background: #FFFFFF !important;
    border-radius: 50% !important;
    /* iOS çµé­‚é˜´å½± */
    box-shadow: 0 3px 8px rgba(0,0,0,0.2), 0 0 0 0.5px rgba(0,0,0,0.05) !important;
    cursor: pointer !important;
    margin-top: -12px !important; /* å±…ä¸­å¯¹é½è½¨é“ */
    transition: transform 0.1s !important;
}

#subpage-display .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.1) !important;
}

/* å…¼å®¹ Firefox */
#subpage-display .ios-slider::-moz-range-thumb {
    height: 28px; width: 28px; background: #fff; border-radius: 50%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2); border: none;
}
/* =========================================================
   ğŸš¨ ç»ˆæç‰©ç†ä¿®å¤ï¼šInstructions å¤´éƒ¨é‡å ä¸å­—ä½“åŒæ­¥
   ========================================================= */

/* 1. å¼ºåˆ¶é¡µé¢å®¹å™¨é«˜åº¦ä¸èƒŒæ™¯ */
#subpage-instructions {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important; /* é“ºæ»¡åº•è‰² */
    display: flex !important;
    flex-direction: column !important;
    z-index: 100 !important; /* ç¡®ä¿åœ¨æ¡Œé¢ä¹‹ä¸Š */
}

/* 2. å¤´éƒ¨ï¼šç‰©ç†é¡¶å¼€çŠ¶æ€æ  */
#subpage-instructions .app-header {
    flex-shrink: 0 !important;
    /* ğŸ‘‡ å…³é”®ï¼špadding-top å¿…é¡»è¶³å¤Ÿå¤§ï¼Œç‰©ç†é¿å¼€çŠ¶æ€æ  */
    padding: 60px 16px 12px 16px !important; 
    height: auto !important; /* è®© padding æ’‘å¼€é«˜åº¦ */
    background: rgba(242,242,247,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. å­—ä½“åŒæ­¥é’©å­ */
#subpage-instructions .app-body {
    flex: 1 !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    padding: 20px 16px 100px 16px !important;
    
    /* ğŸ‘‡ æ ¸å¿ƒï¼šå¼ºåˆ¶åŒæ­¥ä½ è®¾ç½®çš„å­—ä½“å’Œé¢œè‰² */
    font-family: var(--dynamic-font-family, inherit) !important;
    color: var(--dynamic-app-color, #1d1d1f) !important;
}

/* 4. åˆ—è¡¨æ ‡ç­¾åŒæ­¥å­—å· */
#subpage-instructions .item-label {
    font-size: var(--dynamic-app-size, 17px) !important;
    font-weight: var(--dynamic-app-weight, 600) !important;
}

/* 5. ç¡®ä¿çŠ¶æ€æ æ°¸è¿œåœ¨æœ€æœ€æœ€é¡¶å±‚ */
.status-bar {
    z-index: 9999 !important;
}
/* =========================================================
   ğŸš¨ ç‰©ç†é”æ­»ï¼šInstructions é¡µé¢ (è§£å†³ç¼©æ°´ã€æ–­å±‚ã€é‡å )
   ========================================================= */

/* 1. å¼ºåˆ¶é¡µé¢å®¹å™¨é“ºæ»¡æ•´ä¸ªå±å¹•ï¼ŒèƒŒæ™¯å¿…é¡»è¿è´¯ */
#subpage-instructions {
    position: absolute !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background: #F2F2F7 !important; /* æ ¸å¿ƒï¼šç¡®ä¿èƒŒæ™¯ä¸ç¢è£‚ */
    display: flex !important;
    flex-direction: column !important;
    z-index: 5000 !important; /* ä¿è¯åœ¨è®¾ç½®é¡µæœ€é¡¶å±‚ */
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
}

#subpage-instructions.active {
    transform: translateX(0) !important;
}

/* 2. å¤´éƒ¨ç¾åŒ–ï¼šå½»åº•é¿å¼€çŠ¶æ€æ ï¼Œæ¨ªå‘æ’‘æ»¡ */
#subpage-instructions .app-header {
    flex-shrink: 0 !important;
    width: 100% !important;
    padding: 60px 16px 12px 16px !important; /* 60px ç‰©ç†é¿å¼€çŠ¶æ€æ  */
    background: rgba(242, 242, 247, 0.9) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
}

/* 3. æ»šåŠ¨ä¸»ä½“ï¼šå¼ºåˆ¶å æ® 100% å®½åº¦ï¼Œæ–‡å­—åŒæ­¥è®¾ç½® */
#subpage-instructions .app-body {
    flex: 1 !important;
    width: 100% !important; /* ğŸ‘ˆ è§£å†³ç¼©æ°´å…³é”® */
    overflow-y: auto !important;
    padding: 20px 16px 120px 16px !important;
    box-sizing: border-box !important;
    display: block !important; /* æ¢å¤åˆ—è¡¨å †å æµ */
    
    /* ğŸ”´ åŒæ­¥ä½ çš„å­—ä½“è®¾ç½®å˜é‡ */
    font-family: var(--dynamic-font-family, inherit) !important;
    color: var(--dynamic-app-color, #1d1d1f) !important;
}

/* 4. åˆ—è¡¨ç»„ç¾åŒ–ï¼šç¡®ä¿å®ƒä¸æ˜¯ä¸€ä¸ªå°æ–¹å— */
#subpage-instructions .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 12px !important;
    margin: 0 0 20px 0 !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
}

#subpage-instructions .ios-list-item {
    width: 100% !important;
    height: 64px !important;
    display: flex !important;
    align-items: center !important;
    padding-left: 16px !important;
    box-sizing: border-box !important;
}

/* 5. åˆ—è¡¨æ–‡å­—ï¼šå¼ºåˆ¶åŒæ­¥å­—å· */
#subpage-instructions .item-label {
    font-size: var(--dynamic-app-size, 17px) !important;
    font-weight: var(--dynamic-app-weight, 600) !important;
    margin-left: 14px !important;
}

/* 6. çŠ¶æ€æ å±‚çº§ä¿æŠ¤ */
.status-bar {
    z-index: 9999 !important;
    pointer-events: none !important; /* è®©ç‚¹å‡»ç©¿é€åˆ°ä¸‹é¢çš„ Back æŒ‰é’® */
}
/* =========================================================
   ğŸš¨ æ—¶åŒºé¡µä¸“åœºä¿®å¤ï¼šè§£å†³å®½åº¦ç¼©æ°´ã€èƒŒæ™¯æ–­å±‚ã€å›½å®¶æ¶ˆå¤±
   ========================================================= */

/* 1. å¼ºåŠ›é”æ­»å­é¡µé¢å®¹å™¨ï¼Œç¡®ä¿ 100% å®½åº¦ */
#subpage-timezone {
    width: 100% !important;
    max-width: none !important;
    left: 0 !important;
    padding: 0 !important;
}

/* 2. å¼ºåŠ›ä¿®å¤ app-body å¸ƒå±€ */
#subpage-timezone .app-body {
    display: block !important; /* âŒ ç¦æ­¢ Flexï¼Œé˜²æ­¢å†…å®¹è¢«æ¨ªå‘æŒ¤å‹ */
    width: 100% !important;
    height: auto !important;
    min-height: 100% !important;
    padding: 20px 16px 120px 16px !important; /* ç•™å‡ºè¶³å¤Ÿçš„åº•éƒ¨ç©ºé—´ */
    background: #F2F2F7 !important; /* å¼ºåˆ¶èƒŒæ™¯è‰²é“ºæ»¡ */
    box-sizing: border-box !important;
}

/* 3. å¼ºåŠ›ä¿®å¤åˆ—è¡¨ç»„å®½åº¦ */
#subpage-timezone .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 12px !important;
    margin-bottom: 25px !important;
    display: block !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
}

/* 4. ä¿®å¤æœç´¢æ¡†å®½åº¦ */
.ios-search-wrapper {
    width: 100% !important;
}

/* 5. ä¿®å¤å›½å®¶é¡¹æ¸²æŸ“é«˜åº¦ */
#subpage-timezone .ios-list-item {
    width: 100% !important;
    min-height: 48px !important;
    display: flex !important;
    align-items: center !important;
    padding: 0 16px !important;
}
/* =========================================================
   ğŸš¨ å¤´éƒ¨ç»ˆæé¿è®©è¡¥ä¸ (è§£å†³ 17:43 é‡å é—®é¢˜)
   ========================================================= */

/* 1. ç»Ÿä¸€æ‰€æœ‰å­é¡µé¢çš„å®¹å™¨èƒŒæ™¯å’Œå±‚çº§ */
.ios-sub-page {
    background: #F2F2F7 !important;
    z-index: 5000 !important;
}

/* 2. å¼ºåŠ›é¡¶å¼€å¤´éƒ¨ï¼šå°†é—´è·ä» 60px å¢åŠ åˆ° 80pxï¼Œå¹¶åŠ æ·±èƒŒæ™¯ */
.ios-sub-page .app-header {
    height: auto !important;
    min-height: 100px !important; /* å¼ºåˆ¶ä¿åº•é«˜åº¦ */
    /* ğŸ‘‡ å…³é”®ï¼š80px ç‰©ç†é¡¶å¼€ï¼Œç»å¯¹ä¸ä¼šå†ç¢°åˆ° 17:43 */
    padding: 80px 16px 15px 16px !important; 
    background: rgba(242, 242, 247, 0.98) !important; /* å‡ ä¹ä¸é€æ˜ï¼Œå®Œå…¨æŒ¡ä½åé¢å†…å®¹ */
    backdrop-filter: blur(25px) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    box-sizing: border-box !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
}

/* 3. ä¿®æ­£ Back æŒ‰é’®å¯¹é½ */
.ios-sub-page .header-left-btn, 
.ios-sub-page .app-header div[onclick*="closeSubPage"] {
    display: flex !important;
    align-items: center !important;
    line-height: 1 !important;
}

/* 4. çŠ¶æ€æ å±‚çº§ä¿æŠ¤ï¼šè®©çŠ¶æ€æ æ–‡å­—æ°¸è¿œåœ¨æœ€å‰ï¼Œä½†èƒŒæ™¯é€æ˜ */
.status-bar {
    z-index: 9999 !important;
    background: transparent !important;
    pointer-events: none !important; /* ç¡®ä¿èƒ½ç‚¹åˆ°ä¸‹é¢çš„ Back æŒ‰é’® */
}
/* --- è¯´æ˜ä¹¦å›¾æ ‡ï¼šåŒæ­¥æ¡Œé¢ App æ ·å¼ --- */
.ins-app-icon-sync {
    width: 60px !important;  /* åŒæ­¥æ¡Œé¢å°ºå¯¸ */
    height: 60px !important;
    border-radius: 16px !important; /* åŒæ­¥æ¡Œé¢åœ†è§’ */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    flex-shrink: 0 !important;
    /* æ ¸å¿ƒé˜´å½±ï¼šå¢åŠ ç«‹ä½“ç»ç’ƒæ„Ÿ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 1px 1px rgba(255,255,255,0.8) !important;
    position: relative;
    overflow: hidden;
}

/* ç»Ÿä¸€åˆ—è¡¨è¡Œçš„é«˜åº¦ï¼Œé€‚åº”æ›´å¤§çš„å›¾æ ‡ */
#subpage-instructions .ios-list-item {
    height: 85px !important; 
    padding: 0 16px !important;
}

/* è°ƒæ•´æ–‡å­—é—´è· */
#subpage-instructions .item-label {
    margin-left: 18px !important;
    font-size: 18px !important;
    font-weight: 700 !important;
}
/* --- Ins é£æ ¼é«˜çº§å¡ç‰‡ --- */
.ins-fancy-card {
    width: 85%;
    max-width: 340px;
    /* --- ä¿®æ”¹è¿™é‡Œ --- */
    max-height: 80vh !important; /* é™åˆ¶æ•´ä¸ªå¡ç‰‡æœ€é«˜åªå å±å¹•çš„ 80% */
    display: flex !important;    /* å¿…é¡»å¼€å¯ flexï¼Œå¦åˆ™å†…éƒ¨æ— æ³•æ­£ç¡®æ’‘å¼€æ»šåŠ¨ */
    flex-direction: column !important;
    /* ---------------- */
    background: #ffffff;
    border-radius: 32px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.12);
    overflow: hidden;
    animation: insPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
}

@keyframes insPop {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* é¡¶éƒ¨ç‚¹ç‚¹ä¸æ ‡ç­¾ */
.ins-card-nav {
    padding: 20px 24px 10px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.ins-close-dot {
    width: 12px; height: 12px;
    background: #FF5F57; border-radius: 50%; cursor: pointer;
}
.ins-brand-tag {
    font-size: 10px; letter-spacing: 2px; font-weight: 800; color: #d1d1d6;
}

/* æ¸å˜è£…é¥°å¤´å›¾ */
.ins-card-hero {
    height: 120px; position: relative; margin: 0 24px;
    border-radius: 20px; overflow: hidden;
}
.ins-hero-bg { width: 100%; height: 100%; opacity: 0.8; }
.ins-hero-icon {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
}

/* æ–‡å­—æ’ç‰ˆ */
.ins-card-body { padding: 24px; text-align: center; }
.ins-title-serif {
    font-family: "Times New Roman", Times, serif; /* ç»å…¸çš„è¡¬çº¿ä½“æå‡è´¨æ„Ÿ */
    font-size: 26px; font-weight: 500; color: #1d1d1f; margin-bottom: 4px;
}
.ins-subtitle {
    font-size: 12px; color: #86868b; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 20px;
}
.ins-divider-line {
    width: 40px; height: 1px; background: #eee; margin: 0 auto 20px auto;
}

/* åŠŸèƒ½é¡¹ */
.ins-feature-list { text-align: left; margin-bottom: 30px; }
.ins-feat-item { display: flex; gap: 15px; margin-bottom: 18px; align-items: flex-start; }
.feat-num {
    font-family: serif; font-style: italic; color: #d1d1d6; font-size: 18px;
}
.feat-text strong { display: block; font-size: 14px; color: #1d1d1f; margin-bottom: 2px; }
.feat-text p { font-size: 12px; color: #86868b; line-height: 1.4; }

/* åº•éƒ¨æŒ‰é’® */
.ins-done-btn {
    width: 100%; padding: 16px; border: none; background: #1d1d1f; color: #fff;
    border-radius: 16px; font-size: 12px; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; transition: 0.2s;
}
.ins-done-btn:active { transform: scale(0.96); opacity: 0.8; }
/* ç¡®ä¿å¡ç‰‡å†…å®¹è¾ƒå¤šæ—¶å¯ä»¥å†…éƒ¨æ»šåŠ¨ï¼Œä½†ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ */
.ins-card-body {
    max-height: 450px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
    overflow-y: auto;
    -ms-overflow-style: none;
    scrollbar-width: none;
}
.ins-card-body::-webkit-scrollbar {
    display: none;
}

/* å¢åŠ åºå·çš„é—´è·æ„Ÿ */
.feat-num {
    min-width: 24px; /* é˜²æ­¢åŒä½æ•°åºå·å¯¼è‡´é”™ä½ */
}
/* --- é’ˆå¯¹ç²¾ç»†åŒ–å†…å®¹çš„æ’ç‰ˆå¢å¼º --- */
#ins-character-modal .ins-feat-item {
    margin-bottom: 24px !important; /* å¢åŠ é—´è· */
    border-left: 1px solid #f2f2f7; /* åŠ ä¸€æ¡ç»†çº¿å¢åŠ è®¾è®¡æ„Ÿ */
    padding-left: 15px;
}

#ins-character-modal .feat-text p {
    font-size: 13px !important; /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹æ–¹ä¾¿é˜…è¯» */
    line-height: 1.6 !important; /* å¢åŠ è¡Œé«˜ï¼Œè®©é•¿æ®µè½æ›´é€æ°” */
    margin-top: 5px;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½ï¼ŒInsé£ç²¾é«“ */
}

#ins-character-modal .ins-fancy-card {
    max-height: 85vh !important; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢ç”±äºå†…å®¹å¤ªå¤šå†²å‡ºå±å¹• */
    display: flex;
    flex-direction: column;
}

#ins-character-modal .ins-card-body {
    flex: 1;
    overflow-y: auto !important; /* å…è®¸å†…éƒ¨æ»šåŠ¨ */
    padding: 30px 24px !important;
}
/* é’ˆå¯¹å£çº¸è¯´æ˜é¡µçš„ç»†èŠ‚å¼ºåŒ– */
#ins-wallpaper-modal .ins-feat-item {
    margin-bottom: 24px !important;
    border-left: 1px solid #FF9A9E; /* ä¾§è¾¹çº¿ä½¿ç”¨å£çº¸æ¨¡å—çš„ç²‰è‰²ç³» */
    padding-left: 15px;
    transition: all 0.3s ease;
}

#ins-wallpaper-modal .ins-feat-item:hover {
    background: rgba(255, 154, 158, 0.05); /* é¼ æ ‡ç»è¿‡æ—¶æœ‰æ·¡æ·¡çš„å‘¼å¸æ„Ÿ */
    border-left-width: 3px;
}

#ins-wallpaper-modal .feat-text p {
    font-size: 13px;
    line-height: 1.6;
    color: #666;
    margin-top: 5px;
}

#ins-wallpaper-modal .ins-card-body {
    max-height: 50vh;
    overflow-y: auto;
    padding: 30px 24px !important;
}
/* é’ˆå¯¹è®¾ç½®è¯´æ˜é¡µï¼šå»æ‰å¤šä½™è£…é¥°ï¼Œä¿æŒå†…å®¹æ¸…æ™° */
#ins-settings-modal .ins-feat-item {
    margin-bottom: 22px !important;
    border-left: 1.5px solid #d1d1d6; /* ç°/é“¶è‰²ç³»ä¾§çº¿ */
    padding-left: 15px;
}

#ins-settings-modal .feat-text p {
    font-size: 13px !important;
    line-height: 1.5 !important;
    color: #444 !important;
    margin-top: 4px;
    text-align: justify; /* ä¸¤ç«¯å¯¹é½æ›´é«˜çº§ */
}

/* ç‰©ç†é™åˆ¶é«˜åº¦ï¼Œå¤šå‡ºå†…å®¹å¿…é¡»æ»‘åŠ¨ */
#ins-settings-modal .ins-fancy-card {
    max-height: 80vh !important;
    display: flex !important;
    flex-direction: column !important;
}

#ins-settings-modal .ins-card-body {
    flex: 1 !important;
    overflow-y: auto !important;
    padding: 25px 24px !important;
}
/* --- ğŸ  æ»‘åŠ¨ç³»ç»Ÿæ ·å¼ --- */
.home-screen-scroll-container {
    flex: 1;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory; /* æ ¸å¿ƒï¼šå¼€å¯å¸é™„ */
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
    display: block; /* è¦†ç›–é»˜è®¤å¸ƒå±€ */
}
.home-screen-scroll-container::-webkit-scrollbar {
    display: none; /* å½»åº•éšè—æ»šåŠ¨æ¡ */
}

.home-screen-wrapper {
    display: flex;
    width: 200%; /* å› ä¸ºä¸¤é¡µï¼Œæ‰€ä»¥æ˜¯ 200% */
    height: 100%;
}

/* æ¯ä¸€é¡µéƒ½å¿…é¡»å›ºå®š 100% å±å¹•å®½ */
.main-container {
    width: 100vw !important;
    height: 100%;
    flex-shrink: 0;
    scroll-snap-align: start; /* å¸é™„ç‚¹ */
    padding: 10px 22px 20px 22px !important;
    /* ä¿æŒä½ åŸæœ¬çš„ç½‘æ ¼å¸ƒå±€ */
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: 2.3fr 1fr 0.7fr 1.1fr 1.1fr;
    gap: 16px;
    align-items: center;
}
/* --- ç¬¬ä¸€ã€äºŒè¡Œï¼šå°é¢ç»„ä»¶æ ·å¼ --- */
.hero-cover-widget {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 28px;
    overflow: hidden;
    background: #f2f2f7;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.3s ease;
}

.hero-cover-widget:active {
    transform: scale(0.98);
}

.hero-image-wrapper {
    width: 100%;
    height: 100%;
}

.hero-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* æ¸å˜é®ç½©ï¼šç¡®ä¿æ–‡å­—åœ¨ä»»ä½•å›¾ç‰‡ä¸‹éƒ½æ¸…æ™° */
.hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 20%, rgba(0,0,0,0.4) 100%);
}

.hero-content-text {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.hero-tag {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    opacity: 0.9;
}

.hero-content-text h2 {
    margin: 5px 0;
    font-size: 24px;
    font-weight: 700;
    font-family: serif; /* è¡¬çº¿ä½“æå‡é«˜çº§æ„Ÿ */
}

.hero-content-text p {
    font-size: 13px;
    font-style: italic;
    opacity: 0.8;
    margin: 0;
}

.hero-edit-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: 0.3s;
}

.hero-cover-widget:hover .hero-edit-icon {
    opacity: 1;
}
/* é®ç½©å±‚ï¼šå…¨å±åŠé€æ˜ */
.ios-alert-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px); /* èƒŒæ™¯æ¨¡ç³Š */
    display: none; /* åˆå§‹éšè— */
    justify-content: center;
    align-items: flex-end; /* é åº•éƒ¨å¯¹é½ */
    z-index: 9999;
}

/* æŠ½å±‰æ¿ï¼šç™½è‰²åœ†è§’çŸ©å½¢ */
.p2-editor-sheet {
    width: 100%;
    max-width: 500px; /* é™åˆ¶å¤§å±ä¸‹çš„å®½åº¦ */
    background: #ffffff;
    border-top-left-radius: 30px;
    border-top-right-radius: 30px;
    padding: 24px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
    animation: sheetUp 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

@keyframes sheetUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* å¤´éƒ¨å¸ƒå±€ */
.p2-editor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}
#p2-editor-title { font-size: 18px; font-weight: 700; color: #1d1d1f; }
.p2-done-btn { color: #007AFF; font-weight: 700; cursor: pointer; font-size: 16px; }

/* è‡ªå®šä¹‰è¾“å…¥æ¡† */
.p2-main-input {
    width: 100%;
    border: none;
    background: #f2f2f7;
    padding: 16px;
    border-radius: 14px;
    font-size: 15px;
    outline: none;
    margin-bottom: 20px;
    box-sizing: border-box;
}

/* éšè—åŸå§‹ä¸‘é™‹çš„ä¸Šä¼ æŒ‰é’®ï¼Œæ”¹ç”¨è‡ªå®šä¹‰æ ‡ç­¾ */
.custom-upload-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    background: #1d1d1f; /* é»‘è‰²æŒ‰é’®æ›´æœ‰ Ins æ„Ÿ */
    color: #fff;
    border-radius: 14px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
}
.custom-upload-btn:active { opacity: 0.8; }
/* --- Row 3 & 4: æ‹ç«‹å¾—å¿ƒæƒ…çœ‹æ¿æ ·å¼ --- */
.moment-card-widget {
    background: #ffffff;
    border-radius: 24px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s ease;
}

.moment-card-widget:active { transform: scale(0.98); }

.moment-photo-area {
    width: 100%;
    aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    background: #f8f8f8;
}

.moment-photo-area img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.moment-edit-hint {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.2);
    color: #fff; font-size: 10px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: 0.3s;
}
.moment-photo-area:hover .moment-edit-hint { opacity: 1; }

.moment-text-area {
    padding: 12px 4px 4px 4px;
    text-align: left;
}

.moment-text-area h3 {
    font-size: 14px; font-weight: 800; color: #1d1d1f;
    margin: 0; letter-spacing: 0.5px;
}

.moment-text-area p {
    font-size: 11px; color: #86868b;
    margin: 4px 0 0 0;
    font-family: "Times New Roman", serif;
    font-style: italic;
    /* é™åˆ¶æ˜¾ç¤ºä¸¤è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* --- è‡ªå®šä¹‰ App è´´çº¸å¢å¼º --- */
.custom-pic-app .pic-app-wrapper {
    width: 60px; height: 60px; /* ç¨å¾®å¤§ä¸€ç‚¹ç‚¹ */
    border-radius: 18px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}
.pic-app-wrapper img { width: 100%; height: 100%; object-fit: cover; }

.pic-app-edit {
    position: absolute; top: 0; right: 0;
    background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
    width: 18px; height: 18px; border-bottom-left-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    color: #fff; opacity: 0; transition: 0.3s;
}
.pic-app-wrapper:hover .pic-app-edit { opacity: 1; }
/* Row 5: æ°›å›´æ¡æ ·å¼ */
.vibe-bar-widget {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    height: 100%;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0,0,0,0.05);
}
.vibe-bg-wrapper { width: 100%; height: 100%; }
.vibe-bg-wrapper img { width: 100%; height: 100%; object-fit: cover; }
.vibe-overlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.2);
    display: flex; align-items: center; justify-content: center;
}
#hub-vibe-text {
    position: absolute;
    width: 100%; text-align: center; top: 50%; transform: translateY(-50%);
    color: #fff; font-size: 13px; font-weight: 700; letter-spacing: 2px;
    text-transform: uppercase; text-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
/* 1. å¼ºåˆ¶çˆ¶å®¹å™¨åœ¨é¡¶éƒ¨ä¸ç•™ç™½ï¼ˆå¯é€‰ï¼Œå¦‚æœä½ å¸Œæœ›å›¾ç‰‡ç›´æ¥è´´åˆ°å±å¹•é¡¶ç«¯ï¼‰ */
#page-2 {
    padding: 0 16px 20px 16px !important; /* å·¦å³ä¿ç•™è¾¹è·ï¼Œä½†é¡¶éƒ¨è®¾ä¸º0 */
    gap: 12px !important; /* ç¼©å°ç»„ä»¶é—´çš„é—´è· */
}

/* --- 1. å¤§ç»„ä»¶ï¼šç¬¬ä¸€ã€äºŒè¡Œ(Hero) å’Œ ç¬¬äº”è¡Œ(Vibe Bar) å½»åº•é“ºæ»¡ --- */
.hero-cover-widget,
.vibe-bar-widget {
    padding: 0 !important;   /* å½»åº•ç§»é™¤å†…è¾¹è· */
    margin: 0 !important;    /* ç§»é™¤å¤–è¾¹è· */
    width: 100%;
    height: 100%;
    overflow: hidden;
    border-radius: 24px;     /* ç»Ÿä¸€åœ†è§’ */
    display: block;
}

/* ç¡®ä¿è¿™ä¸¤è€…çš„èƒŒæ™¯å›¾å®Œå…¨è¦†ç›– */
.hero-image-wrapper img,
.vibe-bg-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;       /* æ ¸å¿ƒï¼šä¸ç•™ç™½ã€ä¸ç¼©æ”¾ã€è‡ªåŠ¨è£å‰ª */
    display: block;
}

/* --- 2. å°å›¾æ ‡ï¼šä¿®å¤ç¬¬ä¸‰ã€å››ã€å…­è¡Œ App å›¾æ ‡è¢«æ’‘å¤§çš„é—®é¢˜ --- */
.custom-pic-app {
    display: flex;
    flex-direction: column;
    align-items: center;     /* ç¡®ä¿å›¾æ ‡åœ¨æ ¼å­é‡Œå±…ä¸­ */
    justify-content: center;
}

.custom-pic-app .pic-app-wrapper {
    /* æ ¸å¿ƒä¿®å¤ï¼šç»™å›¾æ ‡ä¸€ä¸ªå›ºå®šçš„å°ºå¯¸ï¼Œä¸è¦ 100% */
    width: 60px;             /* æ ¹æ®ä½ çš„å–œå¥½è°ƒæ•´ï¼Œæ¯”å¦‚ 60px æˆ– 64px */
    height: 60px;
    padding: 0 !important;   /* å†…éƒ¨å›¾ç‰‡é“ºæ»¡ï¼Œä¸ç•™ç™½è¾¹ */
    border-radius: 15px;     /* å›¾æ ‡åœ†è§’ç¨å°ä¸€ç‚¹æ›´ç²¾è‡´ */
    overflow: hidden;
    background: #eee;        /* å…œåº•èƒŒæ™¯è‰² */
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* ç¡®ä¿ App å›¾æ ‡é‡Œçš„å›¾ç‰‡ä¹Ÿæ˜¯é“ºæ»¡çš„ */
.pic-app-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* --- 3. ä¿®æ­£ Grid å®¹å™¨çš„é—´éš™ --- */
#page-2 {
    gap: 16px;              /* ç»Ÿä¸€ç»„ä»¶ä¹‹é—´çš„é—´è· */
    padding: 20px;          /* é¡µé¢å››å‘¨çš„ç•™ç™½ */
    align-content: start;
}
/* --- Vibe Grid æ¸¸æˆæ ·å¼ --- */
.game-board-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.vibe-board {
    display: grid;
    grid-template-columns: repeat(10, 1fr); /* 10x10 æ£‹ç›˜æ›´é€‚åˆæ‰‹æœº */
    grid-template-rows: repeat(10, 1fr);
    gap: 2px;
    background: rgba(255, 255, 255, 0.2);
    padding: 2px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    width: 100%;
    aspect-ratio: 1 / 1;
}

.vibe-cell {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    cursor: pointer;
}

/* æ£‹å­ï¼šå…±é¸£ (è“è‰²ç³») */
.piece-resonance {
    width: 80%; height: 80%;
    border-radius: 50%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    box-shadow: 0 0 15px rgba(79, 172, 254, 0.8);
    animation: piecePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* æ£‹å­ï¼šåå™¬ (çº¢è‰²ç³») */
.piece-devour {
    width: 80%; height: 80%;
    border-radius: 50%;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    box-shadow: 0 0 15px rgba(245, 87, 108, 0.8);
    animation: piecePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes piecePop {
    from { transform: scale(0) rotate(-45deg); opacity: 0; }
    to { transform: scale(1) rotate(0); opacity: 1; }
}

.game-footer-info {
    padding: 20px;
    display: flex;
    justify-content: space-around;
    background: rgba(0,0,0,0.05);
}

.vibe-tag-preview {
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 1px;
    padding: 8px 15px;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.1);
}

.vibe-tag-preview.p1 { color: #4facfe; border-color: #4facfe; }
.vibe-tag-preview.p2 { color: #f5576c; border-color: #f5576c; }

/* èƒœåˆ©é—ªçƒæ•ˆ */
.win-flash {
    animation: winGlow 1s infinite alternate;
}
@keyframes winGlow {
    from { filter: brightness(1); }
    to { filter: brightness(1.5) drop-shadow(0 0 20px white); }
}
/* --- ğŸš‘ æ¸¸æˆ App ç»ˆææ˜¾ç¤ºè¡¥ä¸ --- */
#vibe-grid-app {
    z-index: 6000 !important; /* å¿…é¡»é«˜äº 5000ï¼Œæ‰èƒ½ç›–ä½è®¾ç½®é¡µ */
    transform: translateY(100%); /* é»˜è®¤åœ¨ä¸‹é¢ */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s !important;
    opacity: 0;
    display: none; /* åˆå§‹éšè— */
}

/* å½“ App æ¿€æ´»æ—¶çš„çŠ¶æ€ */
#vibe-grid-app.active {
    display: flex !important;
    transform: translateY(0) !important;
    opacity: 1 !important;
}

/* è¡¥å…¨æ¶ˆå¤±çš„åŠ¨ç”»å®šä¹‰ */
@keyframes appOpen {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* å¼ºåˆ¶ç»™æ£‹æ ¼ä¸€ä¸ªæœ€å°å°ºå¯¸ï¼Œé˜²æ­¢å®ƒä»¬ç¼©æˆä¸€å›¢ */
.vibe-cell {
    min-width: 30px;
    min-height: 30px;
}
/* --- ğŸš‘ å¼ºåˆ¶ Vibe Grid è§†è§‰å¯¹é½è¡¥ä¸ --- */
#vibe-grid-app {
    position: fixed !important; /* å¿…é¡»æ˜¯å›ºå®šå®šä½ */
    top: 0 !important; 
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important; /* åŒæ­¥è®¾ç½® App çš„ iOS èƒŒæ™¯è‰² */
    z-index: 6000 !important; /* å¿…é¡»é«˜äºæ¡Œé¢ï¼Œç¡®ä¿ç»å¯¹è¦†ç›– */
    display: none; /* åˆå§‹éšè— */
    flex-direction: column;
    transform: translateY(100%); /* é»˜è®¤è—åœ¨å±å¹•ä¸‹æ–¹ */
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s !important;
}

/* æ¿€æ´»æ€ï¼šä»ä¸‹æ–¹æ»‘å…¥ */
#vibe-grid-app.active {
    display: flex !important;
    transform: translateY(0) !important;
}

/* æ£‹ç›˜æ ¼å­ç¾åŒ– */
.vibe-board {
    background: #fff !important; /* æ£‹ç›˜ç”¨çº¯ç™½èƒŒæ™¯ï¼Œæ›´æœ‰ App è´¨æ„Ÿ */
    border-radius: 20px !important;
    padding: 10px !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05) !important;
    border: none !important;
}

.vibe-cell {
    background: #f2f2f7 !important; /* æ ¼å­åº•è‰²ç¨å¾®æ·±ä¸€ç‚¹ */
    border-radius: 6px !important;
}

/* ä¿®å¤åº•éƒ¨æ ‡ç­¾æ ·å¼ */
.game-footer-info {
    display: flex;
    justify-content: center;
    gap: 15px;
    background: transparent !important;
}
/* --- ğŸš‘ å¼¹çª—å±…ä¸­ä¸ UI é™å™ªè¡¥ä¸ --- */

/* 1. å¼ºåˆ¶å±…ä¸­é®ç½©ï¼šè§£å†³å¼¹çª—åœ¨åº•éƒ¨çš„é—®é¢˜ */
.vibe-center-mask {
    position: fixed; inset: 0;
    display: flex; align-items: center; /* å‚ç›´å±…ä¸­ */
    justify-content: center; /* æ°´å¹³å±…ä¸­ */
    background: rgba(0, 0, 0, 0.4); /* åŠ æ·±é®ç½©ï¼Œçªå‡ºé‡ç‚¹ */
    backdrop-filter: blur(10px); /* ç£¨ç ‚æ„Ÿ */
    z-index: 9000;
}

/* 2. ç§»é™¤å†—ä½™è¾¹è·ï¼Œè§£å†³ç©ºç™½è¿‡å¤šçš„è§†è§‰æ„Ÿ */
#vibe-game-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center; /* è®©å†…å®¹åœ¨å‚ç›´æ–¹å‘ä¹Ÿå±…ä¸­ */
    width: 100%;
    padding-bottom: 60px; /* ç»™åº•éƒ¨æ ç•™ç©ºé—´ */
}

/* 3. æ£‹ç›˜å®¹å™¨é«˜çº§åŒ– */
.vibe-board-wrapper {
    background: #fff;
    padding: 15px;
    border-radius: 32px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255,255,255,1);
    transform: scale(0.95); /* ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œå¢åŠ ç²¾è‡´æ„Ÿ */
}

/* 4. å½»åº•å»æ‰æŒ‰é’®é‡å  */
#vibe-guide-btn {
    position: static !important; /* åˆ«å†æ‚¬æµ®äº† */
    margin: 10px auto;
    padding: 6px 16px;
    background: rgba(0, 122, 255, 0.08);
    border-radius: 12px;
    width: fit-content;
}
/* --- ğŸ¨ AI è¯è¯­æ‚¬æµ®åŠ¨ç”» --- */
.floating-vibe-word {
    position: absolute;
    pointer-events: none;
    z-index: 10000;
    color: #1d1d1f;
    font-family: "Times New Roman", serif;
    font-style: italic;
    font-weight: 600;
    font-size: 18px;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(255,255,255,1), 0 0 10px rgba(0,122,255,0.2);
    animation: vibeRise 2.5s cubic-bezier(0.23, 1, 0.32, 1) forwards;
}

@keyframes vibeRise {
    0% { transform: translateY(10px); opacity: 0; filter: blur(5px); }
    20% { transform: translateY(0); opacity: 1; filter: blur(0); }
    80% { transform: translateY(-30px); opacity: 0.8; filter: blur(0); }
    100% { transform: translateY(-50px); opacity: 0; filter: blur(10px); }
}
/* --- ğŸ’ æ¶²æ€ç»ç’ƒçº¿æ¡å›¾æ ‡é£æ ¼ (Liquid Glass & Line Art) --- */

/* --- ğŸ’ ç²¾è‡´ç‰ˆæ¶²æ€ç»ç’ƒå›¾æ ‡å°ºå¯¸è¡¥ä¸ --- */
.glass-icon-bg {
    width: 60px !important;   /* é”å®šå®½åº¦ï¼ŒåŒæ­¥ç³»ç»Ÿæ ‡å‡† */
    height: 60px !important;  /* é”å®šé«˜åº¦ */
    
    /* ä¿æŒåŸæœ‰çš„é«˜çº§è´¨æ„Ÿ */
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0.15));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    border-radius: 16px; /* ç¨å¾®å‡å°åœ†è§’ï¼Œè®©å®ƒçœ‹èµ·æ¥æ›´ç¡¬æœ—ç²¾è‡´ */
    
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto; /* ç¡®ä¿åœ¨æ ¼å­é‡Œæ°´å¹³å±…ä¸­ */
    transition: transform 0.2s cubic-bezier(0.33, 1, 0.68, 1);
}

/* è°ƒæ•´å†…éƒ¨çº¿æ¡å›¾æ ‡çš„æ¯”ä¾‹ï¼Œè®©å®ƒçœ‹èµ·æ¥ä¸æ‹¥æŒ¤ */
.glass-icon-svg {
    width: 28px; /* é€‚å½“ç¼©å°çº¿æ¡å›¾æ¡ˆï¼Œç•™å‡ºå‘¼å¸æ„Ÿ */
    height: 28px;
    fill: none;
    stroke: #1d1d1f;
    stroke-width: 1.8; /* ç¨å¾®åŠ ç²—ä¸€ç‚¹çº¿æ¡ï¼Œå¢å¼ºè¯†åˆ«åº¦ */
    stroke-linecap: round;
    stroke-linejoin: round;
}
/* --- ğŸ›ï¸ ä¸–ç•Œä¹¦ï¼šæç®€æ¡£æ¡ˆé£æ ¼ --- */

/* 1. åˆ—è¡¨ä¸­çš„å¡ç‰‡ */
.world-card-item {
    background: #fff;
    border-radius: 18px;
    padding: 20px;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    cursor: pointer;
    transition: all 0.2s ease;
}
.world-card-item:active { transform: scale(0.96); background: #fafafa; }
.world-card-item .name { font-size: 18px; font-weight: 800; color: #1d1d1f; }
.world-card-item .hint { font-size: 11px; color: #bbb; margin-top: 8px; font-weight: 600; letter-spacing: 1px; }

/* 2. å±•ç¤ºç”¨çš„ä¸­å¿ƒå¡ç‰‡ */
.world-minimal-card {
    width: 85%; max-width: 320px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 32px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
@keyframes worldPopCenter { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }

.world-minimal-card h1 { font-size: 22px; font-weight: 800; color: #000; margin-bottom: 15px; }
.world-line-decor { width: 30px; height: 3px; background: #007AFF; margin: 0 auto 20px auto; border-radius: 2px; }
.world-viewer-scroll { max-height: 40vh; overflow-y: auto; text-align: left; scrollbar-width: none; }
.world-v-content { font-size: 15px; line-height: 1.7; color: #444; }

/* 3. æŒ‰é’®æ ·å¼ */
.world-action-btn { flex: 1; padding: 12px; border-radius: 12px; background: #f2f2f7; color: #007AFF; font-weight: 700; font-size: 14px; cursor: pointer; text-align: center; }
.world-action-btn.delete { color: #FF3B30; }
.world-action-btn:active { opacity: 0.7; }

/* 4. æ·»åŠ æŒ‰é’® */
.world-add-btn {
    border: 2px dashed #d1d1d6;
    border-radius: 18px;
    display: flex; align-items: center; justify-content: center;
    min-height: 120px; color: #d1d1d6; cursor: pointer;
}
/* --- ğŸ’¬ Chat App ä¸“å±å¤–å£³æ ·å¼ --- */

.chat-tab-panel {
    display: none; /* é»˜è®¤éšè— */
    width: 100%;
    height: 100%;
    animation: fadeIn 0.3s ease;
}
.chat-tab-panel.active { display: block; }

/* æ‚¬æµ®å¯¼èˆªæ å®¹å™¨ */
.chat-nav-wrapper {
    position: absolute;
    bottom: 30px; /* è·ç¦»åº•éƒ¨ç•™ç©ºï¼Œæ˜¾å¾—é«˜çº§ */
    left: 0; width: 100%;
    display: flex; justify-content: center;
    pointer-events: none; /* é˜²æ­¢é®æŒ¡å†…å®¹ç‚¹å‡» */
    z-index: 100;
}

.chat-bottom-nav {
    pointer-events: auto; /* æ¢å¤å¯¼èˆªæ ç‚¹å‡» */
    width: 90%;
    max-width: 380px;
    height: 65px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 0.5px solid rgba(255, 255, 255, 0.3);
    border-radius: 35px; /* è¶…åœ†è§’ */
    display: flex;
    align-items: center;
    justify-content: space-around;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: #8e8e93;
    transition: all 0.2s ease;
    cursor: pointer;
}

.nav-item span { font-size: 10px; font-weight: 600; }
.nav-item.active { color: #007AFF; transform: scale(1.1); }

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
/* --- ğŸ’¬ Chat: å¥½å‹ç¯æ ·å¼ --- */
.chat-friend-ring-container {
    padding: 15px 0;
    background: #fff;
    border-bottom: 0.5px solid #eee;
    overflow: hidden;
}
.friend-ring-wrapper {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 0 16px;
    scrollbar-width: none;
}
.friend-ring-wrapper::-webkit-scrollbar { display: none; }

.friend-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
    cursor: pointer;
}
.friend-avatar-ring {
    width: 62px; height: 62px;
    border-radius: 50%;
    padding: 2px;
    border: 2px solid #007AFF; /* ç±»ä¼¼æ•…äº‹ç¯çš„é¢œè‰² */
}
.friend-avatar-ring img {
    width: 100%; height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
.friend-item span { font-size: 11px; color: #333; max-width: 65px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* --- ğŸ‘¤ ç¤¾äº¤åç‰‡å¡ç‰‡ --- */
.chat-profile-card {
    width: 85%; max-width: 320px;
    background: #fff; border-radius: 30px;
    padding: 30px 20px; text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    animation: cardScaleUp 0.3s cubic-bezier(0.17, 0.89, 0.32, 1.2);
}
@keyframes cardScaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

.profile-avatar-glow {
    width: 100px; height: 100px;
    margin: 0 auto 15px auto;
    border-radius: 50%;
    position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
#profile-v-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.profile-info h2 { font-size: 22px; font-weight: 800; margin-bottom: 5px; }
.online-tag { font-size: 11px; color: #34C759; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px; }
.profile-motto {
    font-size: 14px; color: #666; font-style: italic;
    background: #f2f2f7; padding: 10px 15px; border-radius: 12px;
    cursor: pointer; transition: 0.2s;
}
.profile-motto:hover { background: #e5e5ea; }

.profile-actions {
    display: flex; justify-content: space-around;
    margin-top: 30px; padding-top: 20px;
    border-top: 0.5px solid #f2f2f7;
}
.action-btn-circle {
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    color: #007AFF; cursor: pointer;
}
.action-btn-circle span { font-size: 11px; font-weight: 600; }
.action-btn-circle:active { opacity: 0.5; }
/* ğŸ’¬ Chat App ç»ˆæè§†è§‰åŠ å›º */
#chatApp {
    background: #F2F2F7 !important; /* å¼ºåˆ¶ iOS ç³»ç»Ÿç°è‰²èƒŒæ™¯ */
    z-index: 7000 !important;       /* ç¡®ä¿å±‚çº§é«˜äº Page 2 çš„æ‰€æœ‰ç»„ä»¶ */
    overflow: hidden;
}

#chatApp .app-body {
    background: #F2F2F7 !important;
    padding: 0 !important;         /* ç§»é™¤å†…è¾¹è·ï¼Œäº¤ç»™é¢æ¿å¤„ç† */
    display: block !important;     /* ç¦ç”¨ Flexï¼Œé˜²æ­¢å†…å®¹æŒ¤å‹ */
    position: relative;
    z-index: 5;
}

/* åˆ—è¡¨è¡Œæ ·å¼ - å¢å¼ºç‰ˆ */
.contact-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #fff;             /* æ¯ä¸€è¡Œå¿…é¡»æ˜¯çº¯ç™½èƒŒæ™¯ */
    border-bottom: 0.5px solid #E5E5EA;
    cursor: pointer;
    transition: background 0.2s;
}
.contact-row:active { background: #E5E5EA; }

.contact-avatar {
    width: 50px; height: 50px;
    margin-right: 15px;
    flex-shrink: 0;
    object-fit: cover;
    background: #eee;
}

.contact-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.contact-name { font-size: 17px; font-weight: 600; color: #000; }
.contact-preview { font-size: 13px; color: #8E8E93; margin-top: 2px; }

/* åº•éƒ¨å¯¼èˆªæ å¼ºåˆ¶ç½®é¡¶ */
.chat-nav-wrapper {
    z-index: 9999 !important;
    pointer-events: none;
}
.chat-bottom-nav { pointer-events: auto; }
/* ==========================================
   ğŸ’ Chat åˆ—è¡¨ï¼šé«˜çº§å•†ç”¨ UI é‡å¡‘
   ========================================== */

/* 1. å¼ºåˆ¶æ¸…ç†é¢æ¿èƒŒæ™¯ï¼Œå½»åº•æ€æ‰å¤§å›¾æº¢å‡º */
#chat-panel-list {
    background-color: #F2F2F7 !important; 
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* 2. åˆ—è¡¨å®¹å™¨ï¼šå››å‘¨ç•™å‡ºå‘¼å¸ä½ */
#chat-list-content {
    padding: 16px !important;
    padding-bottom: 120px !important; /* ç»™åº•éƒ¨æ‚¬æµ®å¯¼èˆªç•™ä½ç½® */
}

/* 3. ã€æ ¸å¿ƒè®¾è®¡ã€‘è”ç³»äººåˆ†ç»„å¡ç‰‡ï¼šæŠŠæ‰€æœ‰è¡ŒåŒ…åœ¨ä¸€ä¸ªå¤§åœ†è§’ç›’å­é‡Œ */
.chat-contact-group {
    background: #ffffff;
    border-radius: 14px; 
    overflow: hidden;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
}

/* 4. è”ç³»äººè¡Œï¼šå»æ‰å¤šä½™çš„ç™½è¾¹ï¼Œæ”¹ç”¨ç²¾è‡´åˆ†å‰²çº¿ */
.contact-row {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: #fff;
    cursor: pointer;
    transition: background 0.2s ease;
    position: relative;
}

/* æ¨¡æ‹Ÿ iOS åˆ†å‰²çº¿ï¼šçº¿æ¡ä»æ–‡å­—å¤„å¼€å§‹ï¼Œä¸åˆ‡æ–­å¤´åƒï¼Œä¿æŒè§†è§‰è¿è´¯ */
.contact-row:not(:last-child)::after {
    content: "";
    position: absolute;
    bottom: 0;
    right: 0;
    left: 80px; 
    height: 0.5px;
    background: #E5E5EA;
}

/* ç‚¹å‡»æ—¶çš„ç°è‰²åé¦ˆï¼Œè®©ç”¨æˆ·çŸ¥é“â€œç‚¹ä¸­äº†â€ */
.contact-row:active {
    background: #F2F2F7;
}

/* 5. å¤´åƒç²¾ä¿®ï¼šå¢åŠ æç»†çš„æè¾¹ï¼Œé˜²æ­¢åœ¨ç™½åº•ä¸Šç³Šæ‰ */
.contact-avatar {
    width: 50px;
    height: 50px;
    margin-right: 14px;
    object-fit: cover;
    background: #f8f8f8;
    box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.1);
}

/* 6. æ–‡å­—æ’ç‰ˆï¼šå±‚çº§åˆ†æ˜ */
.contact-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.contact-name {
    font-size: 17px;
    font-weight: 600;
    color: #000;
    letter-spacing: -0.4px;
}

.contact-preview {
    font-size: 13px;
    color: #8E8E93; /* å‰¯æ ‡é¢˜ç° */
}

/* 7. å³ä¾§ç®­å¤´ï¼šè°ƒæ·¡é¢œè‰²ï¼Œå‡å°‘è§†è§‰å¹²æ‰° */
.contact-chevron {
    color: #C7C7CC;
    margin-left: 8px;
    opacity: 0.8;
}

/* 8. é¡¶éƒ¨åˆ‡æ¢æ  (Segment) ç¾åŒ– */
.segment-control {
    background: #E3E3E8 !important;
    padding: 2px !important;
    border-radius: 10px !important;
    margin-bottom: 5px !important;
}

.segment-btn.active {
    background: #fff !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}
/* --- ğŸ’ Messages é¡µé¢é«˜çº§æ’ç‰ˆ --- */

/* 1. åŒºåŸŸå°æ ‡é¢˜æ ‡ç­¾ */
.chat-section-label {
    font-size: 10px;
    font-weight: 800;
    color: #8E8E93;
    letter-spacing: 1.5px;
    padding: 10px 16px 5px 16px;
    text-transform: uppercase;
    background: #fff; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ */
}

/* 2. æ¶ˆæ¯åˆ—è¡¨å®¹å™¨ï¼šå¢åŠ ç•™ç™½å’ŒèƒŒæ™¯è‰² */
#chat-panel-msg {
    background: #F2F2F7 !important; /* ç³»ç»Ÿç°è‰²èƒŒæ™¯ */
}

.msg-list-container {
    background: #ffffff;
    margin-top: 5px;
    border-top: 0.5px solid #E5E5EA;
    min-height: 100%;
}

/* 3. ç©ºæ¶ˆæ¯çŠ¶æ€ç¾åŒ– */
.empty-msg-placeholder {
    padding: 60px 40px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.empty-msg-visual {
    width: 60px; height: 60px;
    background: #f2f2f7;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #C7C7CC;
}

.empty-msg-text {
    font-size: 14px;
    color: #8E8E93;
    font-family: serif;
    font-style: italic;
    line-height: 1.6;
}

/* 4. æ¨¡æ‹Ÿæ¶ˆæ¯è¡Œæ ·å¼ (è®©é¡µé¢å³ä¾¿ç©ºçš„ä¹Ÿå¥½çœ‹) */
.fake-msg-row {
    display: flex; align-items: center; padding: 12px 16px; opacity: 0.4; filter: blur(0.5px);
}
/* --- ğŸ’¬ Chat App å†…éƒ¨é¢æ¿å¼ºåˆ¶éš”ç¦»è¡¥ä¸ --- */

/* 1. é”å®š ChatApp çš„ä¸»ä½“å®¹å™¨ï¼Œç¦æ­¢å®ƒäº§ç”Ÿæ¨ªå‘æº¢å‡º */
#chatApp .app-body {
    position: relative !important;
    flex: 1 !important;
    overflow: hidden !important; /* æ ¸å¿ƒï¼šç¦æ­¢åœ¨è¿™é‡Œäº§ç”Ÿå¥‡æ€ªçš„æ»‘åŠ¨ */
    background: #F2F2F7 !important;
}

/* 2. å¼ºåˆ¶æ¯ä¸ªé¢æ¿ï¼ˆæ¶ˆæ¯ã€åˆ—è¡¨ç­‰ï¼‰ç‹¬ç«‹é‡å  */
.chat-tab-panel {
    display: none; /* é»˜è®¤å®Œå…¨éšè— */
    position: absolute !important; /* æ ¸å¿ƒï¼šç»å¯¹å®šä½ï¼Œè®©å®ƒä»¬é‡å åœ¨åŒä¸€ä¸ªå‘ä½ */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto !important; /* å…è®¸å†…éƒ¨ä¸Šä¸‹æ»šåŠ¨ï¼Œä½†ä¸å‡†æ¨ªå‘ä¹±è·‘ */
    -webkit-overflow-scrolling: touch;
    background: #F2F2F7; /* ç»Ÿä¸€åº•è‰² */
}

/* 3. åªæœ‰æ¿€æ´»çŠ¶æ€æ‰æ˜¾ç¤ºï¼Œå¹¶ä¸”å¼ºåˆ¶æ’‘æ»¡ */
.chat-tab-panel.active {
    display: flex !important; /* æˆ–è€… blockï¼Œå–å†³äºä½ å†…éƒ¨å¸ƒå±€ */
    flex-direction: column;
    z-index: 10;
}

/* 4. ç‰¹åˆ«ä¿®å¤ï¼šé˜²æ­¢æ¶ˆæ¯é¡µé¢çš„é¡¶éƒ¨å¥½å‹ç¯æ’‘å¤§å®¹å™¨ */
.chat-fixed-header {
    width: 100%;
    flex-shrink: 0;
    z-index: 20;
}
/* --- ğŸ¨ Chat App é¢œè‰²å¤§ç»Ÿä¸€è¡¥ä¸ --- */

/* 1. ç»Ÿä¸€æ¶ˆæ¯é¢æ¿çš„æ•´ä½“åº•è‰² */
#chat-panel-msg, 
.msg-list-container,
.chat-fixed-header,
.chat-friend-ring-container {
    background-color: #F2F2F7 !important; /* å¼ºåˆ¶ç»Ÿä¸€ä¸ºç³»ç»Ÿç°è‰² */
}

/* 2. ç»Ÿä¸€å°æ ‡é¢˜ï¼ˆMoments/Conversationsï¼‰çš„èƒŒæ™¯ */
.chat-section-label {
    background-color: #F2F2F7 !important;
    color: #8E8E93; /* é¡ºä¾¿è°ƒæˆ iOS æ ‡å‡†ç°è‰²æ–‡å­— */
}

/* 3. ç»Ÿä¸€å¥½å‹ç¯åŒºåŸŸçš„èƒŒæ™¯ */
.chat-friend-ring-container {
    border-bottom: none !important; /* å»æ‰å¤šä½™çš„åˆ†å‰²çº¿ï¼Œæ›´æ¸…çˆ½ */
}

/* 4. å¦‚æœä½ å¸Œæœ›åˆ—è¡¨é¡¹ï¼ˆå¦‚æœæœ‰äººçš„è¯ï¼‰æ˜¯ç™½çš„ï¼Œå¯ä»¥ä¿ç•™ã€‚
   ä½†å¦‚æœä½ æƒ³å½»åº•å…¨ç°ï¼Œå¯ä»¥æŠŠä¸‹é¢è¿™è¡Œä¹ŸåŠ ä¸Šï¼š */
/* .contact-row { background-color: #F2F2F7 !important; } */

/* 5. ç¡®ä¿åº•éƒ¨å¯¼èˆªæ ä¹Ÿå’ŒèƒŒæ™¯èåˆ (æ¯›ç»ç’ƒæ•ˆæœ) */
.chat-bottom-nav {
    background: rgba(242, 242, 247, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border-top: 0.5px solid rgba(0,0,0,0.05) !important;
}
/* --- ğŸš‘ å¤´åƒå˜å½¢æ€¥æ•‘ + å¼ºåˆ¶å‘¼å¸å…‰æ™•è¡¥ä¸ --- */

/* --- ğŸ›ï¸ Ins é£æ ¼é«˜çº§åç‰‡å…¨æ¡ˆæ ·å¼ --- */

/* 1. å¡ç‰‡æœ¬ä½“ï¼šé«˜å¯¹æ¯”ã€æŸ”å’Œé˜´å½±ã€å±…ä¸­æ’ç‰ˆ */
.chat-profile-card-aesthetic {
    width: 88%;
    max-width: 340px;
    background: #ffffff;
    border-radius: 40px; /* è¶…å¤§åœ†è§’æ›´ç°ä»£ */
    padding: 45px 25px 35px 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    box-shadow: 0 40px 100px rgba(0,0,0,0.1);
    animation: aesCardFadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

/* 2. å¤´åƒç‰©ç†é”æ­»ï¼šè§£å†³å˜å½¢çš„å…³é”® */
.aes-avatar-ring-wrapper {
    position: relative;
    width: 120px;
    height: 120px;
    margin-bottom: 25px;
    flex-shrink: 0; /* å¼ºåˆ¶ä¸è®¸ç¼©æ°´ */
}

#profile-v-avatar {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;
    object-fit: cover !important; /* æ ¸å¿ƒï¼šè‡ªåŠ¨å±…ä¸­è£åˆ‡ */
    border: 5px solid #fff;
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    position: relative;
    z-index: 5;
}

/* 3. å‘¼å¸åœˆï¼šé«˜çº§æ„ŸæŸ”å…‰ */
.aes-breathing-ring {
    position: absolute;
    top: -5px; left: -5px; right: -5px; bottom: -5px;
    border-radius: 50%;
    border: 2px solid rgba(52, 199, 89, 0.4);
    z-index: 1;
    animation: aesHaloPulse 3s infinite ease-in-out;
}

.aes-breathing-ring::after {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    border-radius: 50%;
    box-shadow: 0 0 20px rgba(52, 199, 89, 0.3);
    animation: aesHaloPulse 3s infinite ease-in-out 1.5s;
}

/* 4. æ–‡å­—æ’ç‰ˆï¼šè¡¬çº¿ä½“æå‡è´¨æ„Ÿ */
.aes-nickname-serif {
    font-family: "Times New Roman", serif; /* ä½¿ç”¨ç»å…¸è¡¬çº¿ä½“ */
    font-size: 26px;
    font-weight: 800;
    color: #1d1d1f;
    letter-spacing: -0.5px;
    margin-bottom: 5px;
}

.aes-online-tag {
    font-size: 10px;
    font-weight: 800;
    color: #34C759;
    letter-spacing: 2px;
    margin-bottom: 20px;
}

/* 5. ç­¾ååŒºåŸŸï¼šè½»ç›ˆã€æ„å¢ƒ */
.aes-motto-box {
    background: #f8f8f8;
    padding: 18px 20px;
    border-radius: 20px;
    max-width: 260px;
    cursor: pointer;
    transition: background 0.3s;
    margin-bottom: 30px;
}

.aes-motto-box:active { background: #f0f0f0; }

#profile-v-motto {
    font-family: serif;
    font-style: italic;
    color: #666;
    font-size: 14px;
    line-height: 1.6;
    margin: 0;
}

/* 6. æŒ‰é’®ç»„ï¼šæç®€çº¿æ¡é£æ ¼ */
.aes-action-grid {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    border-top: 1px solid #f2f2f7;
    padding-top: 25px;
}

.aes-btn-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.aes-icon-circle {
    width: 48px;
    height: 48px;
    background: #f2f2f7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    transition: all 0.2s;
}

.aes-btn-item span {
    font-size: 11px;
    font-weight: 700;
    color: #8e8e93;
    text-transform: uppercase;
}

.aes-btn-item:active .aes-icon-circle {
    transform: scale(0.9);
    background: #e5e5ea;
}

/* åŠ¨ç”»å®šä¹‰ */
@keyframes aesCardFadeIn {
    from { opacity: 0; transform: translateY(30px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes aesHaloPulse {
    0% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.15); opacity: 0.8; }
    100% { transform: scale(1); opacity: 0.3; }
}
/* é¡¶éƒ¨å·¥å…·æ å®¹å™¨ */
.aes-card-header-tools {
    width: 100%;
    display: flex;
    justify-content: flex-end; /* æŒ‰é’®é å³ */
    position: absolute; /* ç»å¯¹å®šä½ï¼Œä¸å æ’ç‰ˆç©ºé—´ */
    top: 20px;
    right: 20px;
    z-index: 100;
}

/* å…³é—­æŒ‰é’®æœ¬ä½“ */
.aes-close-trigger {
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.05); /* ææ·¡çš„åº•è‰² */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8e8e93;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* ç‚¹å‡»/æ‚¬åœæ•ˆæœ */
.aes-close-trigger:active {
    background: rgba(0, 0, 0, 0.1);
    transform: scale(0.9);
}

/* ç¡®ä¿å¡ç‰‡æœ¬èº«æ˜¯ç›¸å¯¹å®šä½çš„ï¼Œæ–¹ä¾¿æŒ‰é’®å®šä½ */
.chat-profile-card-aesthetic {
    position: relative !important; /* å¿…é¡»åŠ è¿™ä¸€è¡Œ */
}
/* --- ğŸ‘¥ å‘èµ·ç¾¤èŠé¡µé¢é«˜çº§ UI è¡¥ä¸ --- */

/* 1. ç»Ÿä¸€èƒŒæ™¯å’Œåˆ—è¡¨å®¹å™¨ */
#page-add-group .app-body {
    background: #F2F2F7 !important;
    padding: 20px 16px !important;
}

/* 2. é¡¶éƒ¨ç¾¤èµ„æ–™å¡ç‰‡ */
.group-info-card {
    background: #fff;
    border-radius: 14px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* 3. ä¿®å¤äººæ•°è¾“å…¥æ¡†ï¼šå˜æˆ iOS æ ‡å‡†å³ä¾§å°æ¡† */
#page-add-group .ios-list-item input[type="number"] {
    border: none;
    background: #E5E5EA;
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 15px;
    font-weight: 600;
    color: #007AFF;
    width: 50px !important; /* é”å®šå®½åº¦ */
    text-align: center;
    outline: none;
}

/* 4. æˆå‘˜é€‰æ‹©ç½‘æ ¼ç¾åŒ– */
#group-member-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* ä¸€è¡Œ4ä¸ªï¼Œé€‚åˆå¤´åƒæ˜¾ç¤º */
    gap: 15px;
    padding: 10px 0;
}

.member-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.member-avatar-box {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 14px; /* é‡‡ç”¨è‹¹æœ App å›¾æ ‡åœ†è§’ */
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.member-avatar-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* å…³é”®ï¼šé€‰ä¸­çŠ¶æ€çš„æ ·å¼ */
.member-item.selected .member-avatar-box {
    border-color: #007AFF;
    transform: scale(0.95);
}

/* é€‰ä¸­åçš„å³ä¸Šè§’å¯¹å‹¾ */
.member-item.selected .member-avatar-box::after {
    content: "âœ“";
    position: absolute;
    top: 2px;
    right: 2px;
    background: #007AFF;
    color: white;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.member-name {
    font-size: 11px;
    color: #3a3a3c;
    font-weight: 500;
    max-width: 65px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
/* --- ğŸ’ èŠå¤©å®¤æ¶²æ€ç»ç’ƒå…¨æ¡ˆæ ·å¼ --- */

/* 1. å¤´éƒ¨å¸ƒå±€ï¼šé€æ˜åº•ç‰ˆ */
.chat-room-header {
    height: 100px;
    padding: 50px 20px 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: transparent; /* å…³é”®ï¼šèƒŒæ™¯é€æ˜ */
    position: absolute;
    top: 0; left: 0; width: 100%;
    z-index: 100;
}

/* 2. æ¶²æ€ç»ç’ƒæŒ‰é’®æ ·å¼ */
.header-glass-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(15px) saturate(180%);
    -webkit-backdrop-filter: blur(15px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    cursor: pointer;
}

/* 3. ä¸­é—´å¤´åƒå’Œæ˜µç§° */
.header-contact-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
}

#room-contact-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-text-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
}

#room-contact-name { font-size: 14px; font-weight: 800; color: #000; }
.room-status-text { font-size: 10px; color: #34C759; font-weight: 700; letter-spacing: 0.5px; }

/* 4. æ¶ˆæ¯æ»šåŠ¨åŒº */
.chat-scroll-area {
    flex: 1;
    margin-top: 100px;
    margin-bottom: 90px;
    padding: 20px;
    overflow-y: auto;
    background: #F2F2F7;
}

/* --- ğŸš‘ èŠå¤©å®¤è¾“å…¥åŒºé«˜çº§é‡å¡‘ --- */

/* 1. åº•éƒ¨å®¹å™¨ï¼šæ”¹ä¸ºæ‚¬æµ®ç»ç’ƒæ„Ÿï¼Œä¸å†æ­»æ¿åœ°è´´åœ¨æœ€åº•ä¸‹ */
#page-chat-room .chat-room-footer {
    position: absolute;
    bottom: 25px; /* è·ç¦»åº•éƒ¨ç•™ç©ºï¼Œäº§ç”Ÿæ‚¬æµ®æ„Ÿ */
    left: 5%;
    width: 90%; /* å®½åº¦ä¸æ’‘æ»¡ï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
    height: 56px; /* ç¨å¾®åŠ é«˜ä¸€ç‚¹ */
    padding: 0 10px 0 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.75); /* æŸ”å’ŒåŠé€æ˜ */
    backdrop-filter: blur(20px) saturate(180%); /* å¼ºåŠ›æ¯›ç»ç’ƒ */
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-radius: 28px; /* è¶…å¤§åœ†è§’ */
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* æè½»çš„é˜´å½± */
    z-index: 100;
}

/* 2. å·¦ä¾§ + å·ï¼šè°ƒå°ä¸€ç‚¹ï¼Œé¢œè‰²å˜æ·¡ï¼Œåƒä¸ªç²¾è‡´çš„æ’ä»¶å…¥å£ */
.footer-add-btn {
    color: #8E8E93 !important; /* ç°è°ƒæ›´é«˜çº§ */
    transition: transform 0.2s ease;
}
.footer-add-btn:active { transform: scale(0.9) rotate(90deg); }

/* 3. è¾“å…¥æ¡†ï¼šå½»åº•é€æ˜åŒ–ï¼Œåªç•™æ–‡å­— */
.chat-room-input {
    flex: 1;
    height: 100%;
    background: transparent !important;
    border: none !important;
    font-size: 16px;
    color: #000;
    outline: none;
    padding: 0;
}
.chat-room-input::placeholder {
    color: #C7C7CC;
    font-weight: 400;
}

/* 4. å³ä¾§æŒ‰é’®ç»„ï¼šç¼©å°å°ºå¯¸ï¼Œç»Ÿä¸€é£æ ¼ */
.footer-action-btns {
    display: flex;
    gap: 8px;
    align-items: center;
}

.action-btn {
    width: 36px !important; /* ç»Ÿä¸€ç¼©å°ä¸€ç‚¹ */
    height: 36px !important;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: none !important; /* å»æ‰ä¹‹å‰çš„é‡é˜´å½± */
}

/* AI æŒ‰é’®ï¼šä½è°ƒçš„æ·±ç°è‰²ç»ç’ƒæ„Ÿ */
.action-btn.ai {
    background: rgba(29, 29, 31, 0.05) !important;
    color: #1d1d1f !important;
}
.action-btn.ai:active { background: rgba(29, 29, 31, 0.15) !important; }

/* å‘é€æŒ‰é’®ï¼šç»å…¸çš„ iOS è“è‰²ï¼Œä½†å»æ‰æ‚ä¹±è¾¹æ¡† */
.action-btn.send {
    background: #007AFF !important;
    color: #fff !important;
}
.action-btn.send:active { transform: scale(0.85); opacity: 0.8; }

/* 5. ä¿®æ­£æ¶ˆæ¯åŒºåŸŸçš„åº•éƒ¨é—´è·ï¼Œé˜²æ­¢è¢«æ‚¬æµ®æ¡æŒ¡ä½ */
#page-chat-room .chat-scroll-area {
    padding-bottom: 100px !important;
}
/* --- ğŸš‘ ç¡®ä¿èŠå¤©å®¤èƒŒæ™¯ä¸ç©¿é€ --- */
/* --- ğŸš¨ ç‰©ç†å±‚çº§ç»ˆæé”æ­» --- */
#page-chat-room {
    position: fixed !important; /* å¿…é¡»æ˜¯å›ºå®šå®šä½ï¼Œè„±ç¦»æ‰€æœ‰å®¹å™¨æ§åˆ¶ */
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: #F2F2F7 !important; /* ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
    z-index: 9000 !important;      /* ç»å¯¹çš„æœ€é«˜å±‚çº§ï¼Œç›–è¿‡çŠ¶æ€æ å’Œä¸€åˆ‡ */
    display: none;                  /* åˆå§‹éšè— */
    flex-direction: column;
    transform: translateX(100%);    /* åˆå§‹åœ¨å±å¹•å³ä¾§å¤– */
    transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1) !important;
}
/* å¼ºåˆ¶è®©èŠå¤©é¡µé¢çš„å¤´éƒ¨å¾€ä¸‹æŒªï¼Œåˆ«è·ŸçŠ¶æ€æ æ’è½¦ */
#page-chat-room .chat-room-header {
    padding-top: 50px !important; /* ç‰©ç†é¿å¼€çŠ¶æ€æ é«˜åº¦ */
    background: rgba(242, 242, 247, 0.9) !important; /* ç»™èŠå¤©å®¤å¤´éƒ¨åŠ ç‚¹æ¯›ç»ç’ƒè‰²ï¼Œé˜²æ­¢é€å‡ºåº•ä¸‹çš„æ¡Œé¢æ–‡å­— */
    backdrop-filter: blur(20px) !important;
}

/* æ¿€æ´»çŠ¶æ€ */
#page-chat-room.active-room {
    display: flex !important;
    transform: translateX(0) !important;
}
/* æ¶ˆæ¯åˆ†éš”ç¬¦æ ·å¼ */
.chat-time-divider {
    text-align: center;
    font-size: 10px;
    font-weight: 800;
    color: #C7C7CC;
    letter-spacing: 1px;
    margin: 20px 0;
    text-transform: uppercase;
}
/* 1. å¼ºè¡Œåˆ é™¤â€œåœ¨çº¿â€çŠ¶æ€æ–‡æœ¬ */
.room-status-text {
    display: none !important;
}

/* 2. æ¶ˆæ¯åŒºåŸŸæ•´ä½“å‘ä¸Šå¹³ç§» */
/* ä¹‹å‰ä¸ºäº†é¿å¼€çŠ¶æ€æ å¯èƒ½è®¾ç½®äº†è¿‡å¤§çš„ 100pxï¼Œç°åœ¨æŠŠå®ƒæ”¹å° */
#page-chat-room .chat-scroll-area {
    margin-top: 70px !important; /* è¿™é‡Œçš„æ•°å€¼è¶Šå°ï¼Œæ¶ˆæ¯å°±è¶Šé ä¸Š */
    padding-top: 0px !important;
}

/* 3. å‹ç¼©å¤´éƒ¨çš„é«˜åº¦ï¼Œè®©å¤´åƒå’Œåå­—æ›´ç´§å‡‘ */
#page-chat-room .chat-room-header {
    min-height: 80px !important;
    height: 80px !important;
    padding-bottom: 0px !important;
}

/* 4. è®©æ—¶é—´åˆ†éš”ç¬¦ (TODAY) ä¹Ÿå¾€ä¸Šæä¸€ç‚¹ */
.chat-time-divider {
    margin-top: 5px !important;
    margin-bottom: 10px !important;
}
.chat-time-divider {
    text-align: center;
    font-size: 11px !important; /* ç¨å¾®è°ƒå¤§ä¸€ç‚¹ç‚¹ */
    font-weight: 600 !important;
    color: #C7C7CC;
    letter-spacing: 0.5px;
    margin: 20px 0;
    text-transform: none !important; /* å…³é—­å…¨å¤§å†™ï¼Œå¦åˆ™ä¸­æ–‡æ˜¾ç¤ºä¼šæœ‰é—®é¢˜ */
    width: 100%;
    white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
}
@keyframes msgFadeUp {
    from { 
        opacity: 0; 
        transform: translateY(10px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}
/* --- ğŸ’ æç®€æ˜Ÿè¾°Â·å…¨åœ†è§’æ°”æ³¡è®¾è®¡ --- */

/* 1. åŸºç¡€å¸ƒå±€ */
.msg-row {
    margin: 20px 0;
    display: flex;
    align-items: flex-end; /* è®©å¤´åƒå’Œæ°”æ³¡åº•éƒ¨å¯¹é½ */
    gap: 10px;
    padding: 0 -10px;
    animation: bubbleEnter 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 2. ç»Ÿä¸€å¤´åƒæ ·å¼ */
.chat-avatar-img {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    object-fit: cover;
    border: 1.5px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* 3. é€šç”¨æ°”æ³¡è®¾è®¡ (æ ¸å¿ƒï¼šå…¨åœ†è§’) */
.bubble {
    position: relative;
    padding: 12px 18px;
    font-size: 15px;
    line-height: 1.6;
    max-width: 70%;
    border-radius: 22px !important; /* å¼ºåˆ¶å…¨åœ†è§’ï¼Œå»æ‰å°–è§’ */
    word-break: break-all;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}

/* 4. ç”¨æˆ·æ°”æ³¡ï¼šæ˜Ÿæµ·æ·±è“ (é å³) */
.msg-row.user {
    justify-content: flex-end;
}
.msg-row.user .bubble {
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%); /* æ·±è‰²ç³»æ›´æ˜¾é«˜çº§ */
    color: #fff;
}

/* 5. è§’è‰²æ°”æ³¡ï¼šä¸ç¼é›¾ç° (é å·¦) */
.msg-row.opponent {
    justify-content: flex-start;
}
.msg-row.opponent .bubble {
    background: #ffffff;
    color: #1d1d1f;
    border: 0.5px solid rgba(0,0,0,0.08);
}

/* 6. æ˜Ÿæ˜Ÿè£…é¥°ï¼šå¾®å…‰ç‰¹æ•ˆ */
.star-decor {
    position: absolute;
    font-size: 12px;
    pointer-events: none;
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
    animation: starPulse 2s infinite ease-in-out;
}

.msg-row.user .star-decor {
    top: -8px;
    right: 5px;
    color: #fff;
}

.msg-row.opponent .star-decor {
    bottom: -8px;
    left: 5px;
    color: #8E8E93; /* å¯¹æ–¹æ˜Ÿæ˜Ÿç”¨æ·¡ç°è‰²ï¼Œä¸å–§å®¾å¤ºä¸» */
}

/* 7. ç²¾è‡´åŠ¨ç”» */
@keyframes bubbleEnter {
    from { opacity: 0; transform: translateY(12px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes starPulse {
    0%, 100% { opacity: 0.4; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); }
}

/* 1. å¼ºåˆ¶ä¿®å¤ï¼šå¯¹æ–¹æ¶ˆæ¯é å·¦å¯¹é½ */
.msg-row.opponent {
    justify-content: flex-start !important; /* å¼ºåˆ¶é å·¦ */
    margin-right: auto !important; /* ç¡®ä¿ä¸å æ®å³ä¾§ç©ºé—´ */
}
/* ç¡®ä¿å¤´åƒå’Œæ°”æ³¡ç´§æŒ¨ç€ï¼Œæ²¡æœ‰å¤šä½™é—´è· */
.msg-row.opponent {
    gap: 8px !important;
}


/* 2. ç”¨ CSS ç”»ä¸€ä¸ªé«˜çº§çš„å››è§’æ˜Ÿ (æ›¿ä»£ä¸‘ Emoji) */
.star-decor-css {
    position: absolute;
    width: 12px;  /* æ˜Ÿæ˜Ÿå¤§å° */
    height: 12px;
    pointer-events: none;
    animation: starPulseCSS 2s infinite ease-in-out;
}

/* æ ¸å¿ƒé­”æ³•ï¼šç”¨ä¸¤ä¸ªä¼ªå…ƒç´ äº¤å‰åˆ›å»ºä¸€ä¸ªå››è§’æ˜Ÿ */
.star-decor-css::before,
.star-decor-css::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 2px; /* æ˜Ÿæ˜Ÿå…‰èŠ’çš„ç²—ç»† */
    background: currentColor; /* ç»§æ‰¿çˆ¶çº§æ°”æ³¡çš„æ–‡å­—é¢œè‰² */
    border-radius: 2px;
    transform: translate(-50%, -50%);
}
.star-decor-css::after {
    transform: translate(-50%, -50%) rotate(90deg); /* æ—‹è½¬90åº¦å½¢æˆåå­— */
}

/* 3. è®¾ç½®æ˜Ÿæ˜Ÿä½ç½®å’Œé¢œè‰² */
/* ç”¨æˆ·æ˜Ÿæ˜Ÿï¼šç™½è‰²ï¼Œåœ¨å³ä¸Šè§’ */
.msg-row.user .star-decor-css {
    top: -6px;
    right: 6px;
    color: #fff;
    filter: drop-shadow(0 0 4px rgba(255,255,255,0.6)); /* åŠ ç‚¹å‘å…‰æ•ˆæœ */
}
/* å¯¹æ–¹æ˜Ÿæ˜Ÿï¼šé«˜çº§ç°ï¼Œåœ¨å·¦ä¸‹è§’ */
.msg-row.opponent .star-decor-css {
    bottom: -6px;
    left: 6px;
    color: #A1A1A6;
}

/* 4. æ˜Ÿæ˜Ÿé—ªçƒåŠ¨ç”» */
@keyframes starPulseCSS {
    0%, 100% { opacity: 0.5; transform: scale(0.9) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.1) rotate(45deg); } /* ç¨å¾®è½¬ä¸€ä¸‹æ›´çµåŠ¨ */
}
/* --- ğŸš‘ æ¶ˆæ¯åˆ—è¡¨å·¦æ»‘äº¤äº’è¡¥ä¸ --- */

/* 1. æ»‘åŠ¨å®¹å™¨ï¼šéšè—æº¢å‡ºçš„æŒ‰é’® */
.swipe-item-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden; /* å…³é”®ï¼šéšè—å³ä¾§æŒ‰é’® */
    background: #fff;
    border-bottom: 0.5px solid #E5E5EA;
}

/* 2. å†…å®¹å±‚ï¼šçœŸæ­£æ˜¾ç¤ºæ¶ˆæ¯çš„éƒ¨åˆ† */
.swipe-content {
    position: relative;
    width: 100%;
    background: #fff;
    z-index: 2; /* ç›–åœ¨æŒ‰é’®ä¸Šé¢ */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: transform;
}

/* 3. æŒ‰é’®å±‚ï¼šè—åœ¨å³ä¾§ */
.swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    display: flex;
    z-index: 1;
}

/* 4. å•ä¸ªæŒ‰é’®æ ·å¼ */
.swipe-btn {
    width: 75px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    color: #fff;
    cursor: pointer;
}

.btn-pin { background: #8E8E93; } /* ç½®é¡¶ï¼šiOS æ ‡å‡†ç°è‰² */
.btn-delete { background: #FF3B30; } /* åˆ é™¤ï¼šiOS æ ‡å‡†çº¢è‰² */

/* --- ğŸ’ æè‡´é«˜çº§æ„Ÿï¼šç½®é¡¶æ ·å¼é‡å¡‘ --- */

/* 1. ç½®é¡¶è¡Œçš„èƒŒæ™¯ï¼šä½¿ç”¨ææ·¡çš„å†·ç°è‰²ï¼Œè¥é€ â€œé›¾é¢ç»ç’ƒâ€æ„Ÿ */
.is-pinned .swipe-content {
    background: #F8F9FB !important; 
}

/* 2. å·¦ä¾§æµå…‰ä¾§è¾¹æ¡ï¼šåƒå‘¼å¸ä¸€æ ·å­˜åœ¨ */
.swipe-item-wrapper.is-pinned::before {
    content: "";
    position: absolute;
    left: 0;
    top: 15%; /* ä¸å°é¡¶ï¼Œæ›´æœ‰å‘¼å¸æ„Ÿ */
    height: 70%;
    width: 3.5px;
    background: #007AFF;
    border-radius: 0 4px 4px 0;
    z-index: 10;
    box-shadow: 2px 0 8px rgba(0, 122, 255, 0.2);
}

/* 3. æç®€çŸ¢é‡å›ºå®šé’ˆ (æ›¿ä»£ä¸‘å›¾å½¢) */
.pin-tag-ios {
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    margin-right: 4px;
}

.is-pinned .pin-tag-ios {
    display: flex !important;
}

/* ç”¨ CSS ç”»ä¸€ä¸ªæç»†çš„ç«–é’ˆï¼Œéå¸¸æœ‰è´¨æ„Ÿ */
.pin-needle {
    width: 1px;
    height: 10px;
    background: #8E8E93;
    position: relative;
}
.pin-needle::before {
    content: "";
    position: absolute;
    top: -2px;
    left: -3.5px;
    width: 8px;
    height: 1px;
    background: #8E8E93;
}
.pin-needle::after {
    content: "";
    position: absolute;
    bottom: -1px;
    left: -0.5px;
    width: 2px;
    height: 2px;
    border-radius: 50%;
    background: #8E8E93;
}

/* 4. ä¼˜åŒ–æ¶ˆæ¯è¡Œçš„æ’ç‰ˆï¼Œä¸ºç½®é¡¶ç•™å‡ºç©ºé—´ */
.is-pinned .contact-name {
    color: #007AFF !important; /* ç½®é¡¶çš„åå­—é¢œè‰²å¾®è°ƒæˆè“è‰²ï¼Œæ›´ç›´è§‚ */
}
/* --- ğŸš‘ å¼¹çª—å¼ºåˆ¶æ­£ä¸­å¿ƒå®šä½è¡¥ä¸ --- */
#iosConfirmModal.ios-alert-mask {
    display: none; /* åˆå§‹ç”± JS æ§åˆ¶æ˜¾ç¤º */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
    
    /* æ ¸å¿ƒå±…ä¸­æŒ‡ä»¤ */
    align-items: center !important; 
    justify-content: center !important;
    z-index: 999999 !important; /* ç¡®ä¿åœ¨æœ€æœ€æœ€é¡¶å±‚ */
}

/* å¼¹çª—æœ¬ä½“çš„å¾®è°ƒ */
#iosConfirmModal .ios-alert-box {
    width: 270px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 14px;
    overflow: hidden;
    animation: alertPopCenter 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    transform: none !important; /* æŠ¹é™¤ä¹‹å‰å¯èƒ½çš„åä½åç§» */
    margin: 0 auto !important;
}

@keyframes alertPopCenter {
    from { opacity: 0; transform: scale(1.1); }
    to { opacity: 1; transform: scale(1); }
}
/* --- ğŸ’ é«˜çº§ç½®é¡¶æ ‡è®°ï¼šçº¯ CSS çŸ¢é‡ç»˜å›¾ --- */

/* ç½®é¡¶çŠ¶æ€ä¸‹çš„èƒŒæ™¯è‰²ï¼šæµ…è“é›¾é¢æ„Ÿ */
.is-pinned .swipe-content {
    background: #F2F8FF !important; 
}

/* çŸ¢é‡æŠ˜è§’æ ‡è®° (æ›¿ä»£ä¸‘ Emoji) */
.pinned-mark {
    display: none;
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border-style: solid;
    /* 16px çš„ä¸‰è§’å½¢æŠ˜è§’ */
    border-width: 0 16px 16px 0; 
    border-color: transparent #007AFF transparent transparent;
    z-index: 5;
    opacity: 0.8;
}

/* åªæœ‰åœ¨ç½®é¡¶çŠ¶æ€ä¸‹æ‰æ˜¾ç¤ºæ ‡è®° */
.is-pinned .pinned-mark {
    display: block !important;
}

/* å¼ºåˆ¶å¼¹çª—å±…ä¸­çš„ä¼˜å…ˆçº§å†åŠ å›º */
#iosConfirmModal.ios-alert-mask {
    display: none;
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    align-items: center !important; /* å‚ç›´å±…ä¸­ */
    justify-content: center !important; /* æ°´å¹³å±…ä¸­ */
    z-index: 1000000 !important;
}
/* --- ğŸ’¬ æ€è€ƒä¸­ï¼šä¸‰ç‚¹è·³åŠ¨åŠ¨ç”» --- */
.typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
    height: 20px;
    padding: 4px 0;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #8E8E93; /* iOS æ ‡å‡†ç°è‰² */
    border-radius: 50%;
    display: inline-block;
    animation: dotPulse 1.4s infinite ease-in-out both;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes dotPulse {
    0%, 80%, 100% { transform: scale(0); opacity: 0.3; }
    40% { transform: scale(1); opacity: 1; }
}
/* --- ğŸš‘ å¸ƒå±€æ€¥æ•‘ï¼šè®©è¾“å…¥æ¡†å’Œæ¶ˆæ¯è´´è¿‘ --- */
#page-chat-room .chat-scroll-area {
    flex: 1 !important;
    margin-top: 80px !important;    /* é¿å¼€é¡¶éƒ¨çš„è·ç¦» */
    margin-bottom: 0 !important;   /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šåˆ æ‰åŸæ¥çš„ 90px å¤–è¾¹è· */
    padding-bottom: 90px !important; /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå†…è¾¹è·è®¾ä¸º 90pxï¼Œåˆšå¥½ç»™æ‚¬æµ®æ¡†ç•™ä½ç½® */
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    display: block !important;
}

/* ç¡®ä¿èŠå¤©é¡µé¢é«˜åº¦é“ºæ»¡ï¼Œä¸äº§ç”Ÿæ–­å±‚ */
#page-chat-room {
    height: 100vh !important;
    display: flex !important;
    flex-direction: column !important;
}
/* --- ğŸ’ æ°”æ³¡é•¿æŒ‰/ç‚¹å‡»èœå• --- */
.bubble-context-menu {
    position: fixed;
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    width: 260px; /* å®½åº¦é€‚é…å››åˆ— */
    animation: menuPop 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

@keyframes menuPop {
    from { opacity: 0; transform: scale(0.8) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* èœå•ä¸»ä½“ */
.menu-box {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    border-radius: 20px;
    padding: 12px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* æ ¸å¿ƒï¼šå››åˆ—å¸ƒå±€ */
    gap: 15px 10px;
}

/* å•ä¸ªå›¾æ ‡æŒ‰é’® */
.menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: transform 0.1s;
}
.menu-item:active { transform: scale(0.9); }

/* --- ğŸ”³ é»‘ç™½æç®€é£èœå•å›¾æ ‡ --- */
.menu-icon-circle {
    width: 44px; height: 44px;
    background: #f5f5f7; /* åº•è‰²æ”¹æˆæ›´æŸ”å’Œçš„æµ…ç° */
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    /* ç»Ÿä¸€å›¾æ ‡é¢œè‰²ä¸ºæ·±ç°è‰² */
    stroke: #333333 !important; 
    transition: background 0.2s;
}

/* é¼ æ ‡æ”¾ä¸Šå»å˜æ·±ä¸€ç‚¹ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
.menu-item:hover .menu-icon-circle {
    background: #e5e5e7;
}

/* å¼ºåˆ¶æ‰€æœ‰ SVG å›¾æ ‡ä¸ºé»‘ç™½ */
.menu-icon-circle svg {
    stroke: #333333 !important;
    fill: none !important; /* ç¡®ä¿æ²¡æœ‰å¡«å……è‰² */
}

/* èœå•æ–‡å­—é¢œè‰² */
.menu-item span {
    font-size: 10px;
    font-weight: 500;
    color: #666666; /* æ–‡å­—ä¹Ÿç”¨æŸ”å’Œçš„ç°è‰² */
    letter-spacing: 0.5px;
    margin-top: 4px;
}
.menu-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.2); /* ç¨å¾®æ·±ä¸€ç‚¹ç‚¹ï¼Œçªå‡ºèœå• */
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 9998; /* å¿…é¡»åœ¨èœå• 10000 çš„ä¸‹é¢ï¼Œä½†åœ¨å…¶ä»–å…ƒç´ ä¸Šé¢ */
    display: none;
    cursor: default; /* ç¡®ä¿èƒ½æ•æ‰åˆ°ç‚¹å‡» */
}
/* --- ğŸ’¬ å¼•ç”¨åŠŸèƒ½ä¸“å±æ ·å¼ --- */
/* 1. è¾“å…¥æ¡†ä¸Šæ–¹çš„é¢„è§ˆæ¡ */
.quote-preview-bar {
    display: none; /* é»˜è®¤éšè— */
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-top: 0.5px solid #eee;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: slideUp 0.3s ease;
}

.quote-content-wrapper {
    border-left: 3px solid #007AFF; /* å¼•ç”¨è“æ¡ */
    padding-left: 10px;
    overflow: hidden;
}

.quote-user-name {
    font-size: 11px;
    font-weight: 700;
    color: #007AFF;
    margin-bottom: 2px;
}

.quote-text-preview {
    font-size: 13px;
    color: #666;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    max-width: 200px;
}

/* 2. æ°”æ³¡å†…éƒ¨çš„å¼•ç”¨å— */
.bubble-quote-box {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    padding: 8px 12px;
    margin-bottom: 8px;
    border-left: 2px solid #ddd;
    font-size: 12px;
    color: #8e8e93;
    line-height: 1.4;
}
/* --- å¤šé€‰æ¨¡å¼ä¸‹çš„å®¹å™¨è°ƒæ•´ --- */
.msg-row.multi-selecting {
    padding-left: 50px !important; /* ç»™å·¦ä¾§å¯¹å‹¾ç•™ç©ºé—´ */
    transition: padding 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* éšè—çš„å¯¹å‹¾å®¹å™¨ */
.msg-check-box {
    position: absolute;
    left: -40px; /* åˆå§‹è—åœ¨å·¦è¾¹ */
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    background: #fff;
    cursor: pointer;
}

/* é€‰ä¸­çŠ¶æ€ï¼šèƒŒæ™¯å˜è“ï¼Œæ¡†å˜è“ */
.msg-row.selected .msg-check-box {
    background: #007AFF;
    border-color: #007AFF;
}

/* é€‰ä¸­åçš„å¯¹å‹¾å›¾æ ‡ (ç”¨ CSS ç”»ä¸€ä¸ªç™½è‰²çš„å¯¹å‹¾) */
.msg-row.selected .msg-check-box::after {
    content: '';
    width: 10px;
    height: 5px;
    border-left: 2px solid #fff;
    border-bottom: 2px solid #fff;
    transform: rotate(-45deg);
    margin-top: -2px;
}

/* --- å¤šé€‰åº•æ ï¼šæµ®åŠ¨åœ¨è¾“å…¥æ¡†ä¹‹ä¸Š --- */
.multi-select-footer {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    height: 85px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-top: 0.5px solid #eee;
    display: none; /* é»˜è®¤éšè— */
    justify-content: space-around;
    align-items: center;
    padding-bottom: 20px;
    z-index: 200;
    animation: slideUp 0.3s ease;
}

.multi-action-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    color: #007AFF;
    cursor: pointer;
}
.multi-action-item span { font-size: 10px; font-weight: 600; }
.multi-action-item.danger { color: #FF3B30; } /* åˆ é™¤æŒ‰é’®ç”¨çº¢è‰² */
/* é€‰ä¸­åçš„æ•´è¡ŒèƒŒæ™¯å¾®è°ƒï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
.msg-row.multi-selecting.selected {
    background-color: rgba(0, 122, 255, 0.05); 
}

/* é‡ç‚¹ï¼šé€‰ä¸­çš„æ°”æ³¡åº•è‰²å˜æ·±ï¼Œè®©äººä¸€çœ¼çœ‹å‡ºé€‰äº†è° */
.msg-row.selected .bubble {
    box-shadow: 0 0 0 2px #007AFF inset !important; /* è“è‰²å†…è¾¹æ¡† */
    background: rgba(0, 122, 255, 0.1) !important; /* ææ·¡çš„è“è‰²èƒŒæ™¯ */
}

/* å¼ºåˆ¶æ˜¾ç¤ºå¯¹å‹¾å®¹å™¨ï¼Œå¹¶å¢åŠ åŠ¨ç”» */
.msg-check-box {
    position: absolute;
    left: 15px; /* ç§»åˆ°å¯è§åŒºåŸŸ */
    top: 50%;
    transform: translateY(-50%) scale(0.8);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    background: #fff;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
}

.msg-row.selected .msg-check-box {
    transform: translateY(-50%) scale(1.1); /* é€‰ä¸­æ—¶ç¨å¾®æ”¾å¤§ï¼Œæœ‰å¼¹åŠ›æ„Ÿ */
    background: #007AFF;
    border-color: #007AFF;
}
/* --- æ ¸å¿ƒä¿®å¤ï¼šå¯¹å‹¾åœ†åœˆé»˜è®¤å½»åº•éšè— --- */
.msg-check-box {
    position: absolute;
    left: -40px; /* åˆå§‹èº²åœ¨å±å¹•å¤– */
    top: 50%;
    transform: translateY(-50%) scale(0.5);
    width: 24px;
    height: 24px;
    border: 1.5px solid #C7C7CC;
    border-radius: 50%;
    background: #fff;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0; /* é»˜è®¤é€æ˜ */
    pointer-events: none; /* éå¤šé€‰æ¨¡å¼ä¸å¯ç‚¹å‡» */
    z-index: 10;
}

/* --- åªæœ‰è¿›å…¥å¤šé€‰æ¨¡å¼ï¼Œåœ†åœˆæ‰æ»‘å…¥å¹¶æ˜¾å½¢ --- */
.msg-row.multi-selecting .msg-check-box {
    left: 15px; 
    opacity: 1;
    transform: translateY(-50%) scale(1);
    pointer-events: auto;
}

/* é€‰ä¸­åçš„æ ·å¼ï¼ˆä¿æŒä¸å˜ï¼Œä½†ç¡®ä¿å®ƒåªåœ¨ multi-selecting ä¸‹ç”Ÿæ•ˆï¼‰ */
.msg-row.multi-selecting.selected .msg-check-box {
    background: #007AFF;
    border-color: #007AFF;
}

/* é€‰ä¸­åçš„æ°”æ³¡é«˜äº®ï¼šé€€å‡ºæ¨¡å¼åç”±äºå»æ‰äº† selected ç±»ï¼Œè¿™ä¸ªä¼šè‡ªåŠ¨æ¶ˆå¤± */
.msg-row.selected .bubble {
    box-shadow: 0 0 0 2px #007AFF inset !important;
    background: rgba(0, 122, 255, 0.05) !important;
}
/* è½¬å‘æ¶ˆæ¯çš„ç‰¹æ®Šæ ·å¼ */
.is-forwarded .bubble {
    border-left: 3.5px solid #C7C7CC !important; /* å·¦ä¾§æµ…ç°è‰²ç²—çº¿ï¼ŒåŒºåˆ†åŸç”Ÿæ¶ˆæ¯ */
    position: relative;
}

/* è½¬å‘æ ‡è®°å°æ–‡å­— */
.forward-label {
    font-size: 9px;
    color: #8E8E93;
    font-weight: 700;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.forward-label svg { width: 10px; height: 10px; }
/* --- ä¸“é—¨é’ˆå¯¹è½¬å‘é€‰æ‹©é¡µçš„é¿è®©é€»è¾‘ --- */

#page-forward-picker {
    /* 1. æ ¸å¿ƒä¿®å¤ï¼šæŠŠå±‚çº§è°ƒåˆ° 9000ï¼Œç¡®ä¿ä½äºçŠ¶æ€æ çš„ 9999 */
    z-index: 50000 !important; 
    
    /* 2. æ ¸å¿ƒä¿®å¤ï¼šé¡¶éƒ¨ç•™å‡º 48px çš„ç‰©ç†ç©ºé—´ï¼ŒæŠŠé¡µé¢é¡¶ä¸‹å»ï¼Œç»™çŠ¶æ€æ ç•™ä½å­ */
    padding-top: 48px !important; 
    
    /* 3. å¼ºåˆ¶èƒŒæ™¯é“ºæ»¡å…¨å±ï¼Œé˜²æ­¢å‡ºç°æˆªå›¾é‡Œé‚£ç§ç¼©æ°´çš„æƒ…å†µ */
    width: 100vw !important;
    height: 100vh !important;
    background: #F2F2F7 !important;
    display: flex !important;
    flex-direction: column !important;
}

/* 4. ä¿®å¤è½¬å‘é¡µé¢çš„å¤´éƒ¨ï¼šä¸å†é¡¶ç€å±å¹•è¾¹ç¼˜ */
#page-forward-picker .app-header {
    height: 60px !important;
    padding: 0 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    background: #F2F2F7 !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
    flex-shrink: 0 !important;
}

/* 5. ä¿®å¤æˆªå›¾ 3 ä¸­åˆ—è¡¨ç¼©æˆä¸€å›¢çš„é—®é¢˜ï¼šå¼ºåˆ¶å†…å®¹æ’‘æ»¡ */
#page-forward-picker .app-body {
    flex: 1 !important;
    width: 100% !important;
    display: block !important; /* ç¦ç”¨ Flex é˜²æ­¢å†…å®¹æ°´å¹³æŒ¤å‹ */
    overflow-y: auto !important;
    padding: 10px 16px 80px 16px !important; /* åº•éƒ¨ç•™å‡ºç©ºé—´ */
    box-sizing: border-box !important;
}

/* 6. ç¡®ä¿åˆ—è¡¨è¡Œä¹Ÿæ˜¯æ»¡å®½çš„ */
#page-forward-picker .chat-contact-group {
    width: 100% !important;
    margin: 0 !important;
}

#page-forward-picker .contact-row {
    width: 100% !important;
    padding-right: 16px !important;
    box-sizing: border-box !important;
}
/* 1. æ’¤å›æ¶ˆæ¯çš„ç³»ç»Ÿæç¤ºæ ·å¼ */
.recalled-msg-hint {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 12px 0;
    width: 100%;
    animation: msgFadeUp 0.4s ease;
}

.recalled-msg-hint span {
    background: rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(5px);
    color: #8E8E93;
    font-size: 11px;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.recalled-msg-hint span:active {
    background: rgba(0, 0, 0, 0.1);
}

/* 2. æŸ¥é˜…æ’¤å›å†…å®¹çš„ç²¾ç¾å¡ç‰‡ */
.recalled-content-card {
    width: 80%;
    max-width: 300px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: saturate(180%) blur(25px);
    border-radius: 30px;
    padding: 30px 25px;
    text-align: center;
    box-shadow: 0 30px 60px rgba(0,0,0,0.15);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

.recalled-v-label {
    font-size: 10px;
    color: #8E8E93;
    letter-spacing: 2px;
    font-weight: 800;
    margin-bottom: 15px;
}

.recalled-v-text {
    font-size: 16px;
    color: #1d1d1f;
    line-height: 1.6;
    text-align: left;
    margin-bottom: 25px;
    max-height: 200px;
    overflow-y: auto;
    font-family: serif;
    font-style: italic;
}
/* ç¡®ä¿èœå•é¡¹é»˜è®¤æ˜¯æ˜¾ç¤ºçš„ */
.menu-item {
    display: flex !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

/* é’ˆå¯¹æ’¤å›æŒ‰é’®çš„ä¸“å±å›¾æ ‡é¢œè‰² */
#menu-recall .menu-icon-circle {
    stroke: #333 !important;
}

/* éšè—çŠ¶æ€ä¸‹çš„ç±»åï¼ˆå¤‡ç”¨ï¼‰ */
.menu-item.hidden {
    display: none !important;
}
/* --- âš™ï¸ è®¾ç½®é¡µï¼šé«˜çº§æŠ˜å äº¤äº’æ ·å¼ --- */

/* 1. æŠ˜å å®¹å™¨ */
/* --- æ›¿æ¢æ–¹æ¡ˆï¼šæ— æ¨ªçº¿ï¼Œç”±é—´è·åˆ†éš”çš„ç‹¬ç«‹å¡ç‰‡ --- */
.ios-accordion-item {
    background: #fff;
    overflow: hidden;
    transition: all 0.2s ease;
    
    /* 1. å»æ‰æ¨ªçº¿ */
    border-bottom: none; 
    
    /* 2. åŠ ä¸Šåº•éƒ¨é—´è·ï¼Œè®©å®ƒä»¬åˆ†å¼€ */
    margin-bottom: 1px; 
}

/* 3. ç»™æœ€å¤–å±‚çš„å®¹å™¨åŠ ä¸ªèƒŒæ™¯è‰²ï¼Œè¿™æ ·é—´è·å°±ä¼šé€å‡ºèƒŒæ™¯è‰²ï¼Œå½¢æˆè‡ªç„¶çš„åˆ†å‰² */
.ios-list-group {
    background: #F2F2F7 !important; /* ç¡®ä¿åº•è‰²æ˜¯ç°çš„ */
    padding: 0 !important;
    overflow: hidden;
    gap: 1px; /* å¤‡ç”¨æ–¹æ¡ˆ */
}

/* 2. å¤´éƒ¨ç‚¹å‡»åŒº (ä¿æŒåŸæœ¬çš„åˆ—è¡¨è¡Œæ ·å¼ï¼Œä½†å¢åŠ äº†ç‚¹å‡»åé¦ˆ) */
.accordion-header {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    cursor: pointer;
    background: #fff;
    position: relative;
    z-index: 2;
    transition: background 0.2s;
}
.accordion-header:active {
    background: #F2F2F7;
}

/* æ—‹è½¬çš„å°ç®­å¤´ */
.accordion-chevron {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #C7C7CC;
}
/* æ¿€æ´»æ—¶ç®­å¤´å‘ä¸‹è½¬ */
.ios-accordion-item.active .accordion-chevron {
    transform: rotate(90deg);
    color: #007AFF;
}

/* 3. å†…å®¹å±•å¼€åŒº (é»˜è®¤é«˜åº¦0ï¼Œéšè—) */
.accordion-content {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    background: #F9F9F9; /* å±•å¼€åçš„åº•è‰²ç¨å¾®æ·±ä¸€ç‚¹ï¼ŒåŒºåˆ†å±‚çº§ */
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
}

/* æ¿€æ´»æ—¶å±•å¼€ */
.ios-accordion-item.active .accordion-content {
    max-height: 1000px; /* ç»™ä¸€ä¸ªè¶³å¤Ÿå¤§çš„é«˜åº¦ */
    opacity: 1;
    padding-bottom: 15px; /* åº•éƒ¨ç•™ç™½ */
    border-top: 0.5px solid #eee; /* é¡¶éƒ¨åŠ æ¡çº¿åŒºåˆ† */
}

/* å±•å¼€åŒºåŸŸå†…çš„æ“ä½œæŒ‰é’® */
.sub-setting-btn {
    margin: 10px 16px 0 16px;
    padding: 12px;
    background: #fff;
    border-radius: 10px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: #007AFF;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
    cursor: pointer;
}
.sub-setting-btn:active { transform: scale(0.98); }

/* --- ğŸš« åº•éƒ¨ç‹¬ç«‹æŒ‰é’®ç»„ (Danger Zone) --- */
.danger-zone-container {
    margin-top: 30px;
    padding: 0 10px;
    display: flex;
    flex-direction: column;
    gap: 12px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
}

.standalone-btn {
    width: 100%;
    padding: 16px;
    background: #fff;
    border-radius: 14px; /* æ›´åœ†æ¶¦çš„ç‹¬ç«‹å— */
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03); /* æ·¡æ·¡çš„æµ®èµ·æ„Ÿ */
    cursor: pointer;
    transition: all 0.2s;
}

.standalone-btn:active {
    transform: scale(0.98);
    background: #f2f2f2;
}

/* è“è‰²åŠŸèƒ½æŒ‰é’® */
.btn-blue-text { color: #007AFF; }
/* çº¢è‰²å±é™©æŒ‰é’® */
.btn-red-text { color: #FF3B30; }
/* ==========================================
   ğŸ´ğŸ–¤ ç»ˆæé»‘ç™½Â·å…ˆé”‹æç®€é£æ ¼è¡¥ä¸ ğŸ–¤ğŸ´
   ========================================== */

/* 1. å®¹å™¨ï¼šå½»åº•éšå½¢ï¼Œåªç•™é—´è· */
.ios-list-group {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 4px !important; /* å·¦å³ç¨å¾®ç•™ç‚¹å‘¼å¸æ„Ÿ */
    overflow: visible !important;
}

/* 2. å¡ç‰‡æœ¬ä½“ï¼šçº¯ç™½æ‚¬æµ®å—ï¼Œå¤§åœ†è§’ */
.ios-accordion-item {
    background: #FFFFFF !important;
    margin-bottom: 16px !important; /* ğŸŸ¢ æ˜¾è‘—çš„é—´è·ï¼Œåƒæ¼‚æµ®çš„ç§¯æœ¨ */
    border-radius: 24px !important; /* æ›´ç°ä»£çš„è¶…å¤§åœ†è§’ */
    border: 1px solid rgba(0,0,0,0.03) !important; /* æç»†å¾®çš„è¾¹æ¡†æå‡è´¨æ„Ÿ */
    box-shadow: 0 8px 20px rgba(0,0,0,0.04) !important; /* é«˜çº§æŸ”å…‰é˜´å½± */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
}

/* æ¿€æ´»çŠ¶æ€ï¼ˆå±•å¼€æ—¶ï¼‰ï¼šç¨å¾®æµ®èµ·ä¸€ç‚¹ */
.ios-accordion-item.active {
    box-shadow: 0 12px 30px rgba(0,0,0,0.08) !important;
    transform: translateY(-2px);
}

/* 3. å¤´éƒ¨åŒºåŸŸï¼šåŠ é«˜ï¼Œå‚ç›´å±…ä¸­ */
.accordion-header {
    padding: 18px 20px !important; /* æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
    background: transparent !important;
}

/* 4. å›¾æ ‡é‡å¡‘ï¼šå¼ºåˆ¶é»‘ç™½åŒ– (æ ¸å¿ƒï¼) */
.item-icon {
    /* æŠŠåŸæ¥çš„å½©è‰²èƒŒæ™¯å…¨éƒ¨å¹²æ‰ï¼Œæ¢æˆææ·¡çš„ç°è‰² */
    background: #F2F2F7 !important; 
    border-radius: 50% !important; /* å˜æˆåœ†å½¢ */
    width: 44px !important;
    height: 44px !important;
    box-shadow: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin-right: 16px !important;
}

/* å¼ºåˆ¶æ‰€æœ‰ SVG çº¿æ¡å˜é»‘ */
.item-icon svg {
    stroke: #1d1d1f !important; /* è‹¹æœé»‘ */
    fill: none !important;      /* å»æ‰å¡«å……è‰² */
    width: 20px !important;
    height: 20px !important;
    stroke-width: 2.2 !important; /* çº¿æ¡åŠ ç²—ä¸€ç‚¹ç‚¹ï¼Œæ›´æœ‰åŠ› */
}

/* 5. æ–‡å­—æ’ç‰ˆï¼šåŠ ç²—ï¼Œçº¯é»‘ */
.item-label {
    font-size: 16px !important;
    font-weight: 700 !important; /* åŠ ç²— */
    color: #000000 !important;
    letter-spacing: -0.5px !important; /* ç´§å‡‘ä¸€ç‚¹æ›´ç²¾è‡´ */
}

/* 6. å³ä¾§ç®­å¤´ï¼šé»‘è‰²æç®€ */
.accordion-chevron {
    color: #000 !important;
    opacity: 0.3 !important;
    width: 16px !important;
    height: 16px !important;
    stroke-width: 3 !important;
}
.ios-accordion-item.active .accordion-chevron {
    opacity: 1 !important;
    color: #000 !important; /* æ¿€æ´»ä¹Ÿæ˜¯é»‘è‰² */
}

/* 7. å±•å¼€å†…å®¹åŒºï¼šé»‘ç™½åè½¬ */
.accordion-content {
    background: #fff !important;
    padding: 0 20px 24px 20px !important; /* åº•éƒ¨ç•™è¶³ç©ºé—´ */
    border-top: none !important;
}

/* 8. å†…éƒ¨æ“ä½œæŒ‰é’®ï¼šé»‘åº•ç™½å­— (é…·ï¼) */
.sub-setting-btn {
    background: #1d1d1f !important; /* çº¯é»‘åº• */
    color: #ffffff !important;      /* çº¯ç™½å­— */
    border-radius: 14px !important;
    padding: 14px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    letter-spacing: 0.5px !important;
    border: none !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15) !important; /* é»‘è‰²æŒ‰é’®çš„æŠ•å½± */
    margin-top: 12px !important;
}
.sub-setting-btn:active {
    transform: scale(0.97) !important;
    opacity: 0.8 !important;
}

/* 9. åº•éƒ¨å±é™©åŒºæŒ‰é’®ï¼šä¿æŒé»‘ç™½æç®€ */
.standalone-btn {
    border-radius: 18px !important;
    background: #fff !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03) !important;
    border: 1px solid rgba(0,0,0,0.02) !important;
}
/* å±é™©æŒ‰é’®æ–‡å­—ä¿ç•™çº¢è‰²ï¼Œå…¶ä»–çš„å˜é»‘ */
.btn-blue-text { color: #1d1d1f !important; }
/* --- ğŸ–¤ èŠå¤©èƒŒæ™¯è®¾ç½®é«˜çº§é»‘ç™½ UI --- */
.bg-config-container {
    padding: 20px;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.bg-config-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 18px;
    border: 1px solid #f0f0f0;
}

.bg-label-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.bg-main-title {
    font-size: 15px;
    font-weight: 700;
    color: #1d1d1f;
}

.bg-sub-hint {
    font-size: 11px;
    color: #8e8e93;
}

/* é¢„è§ˆæ¡†ï¼šå¼ºåˆ¶ 9:16 æ¯”ä¾‹ */
.bg-preview-box {
    width: 60px;
    height: 106px;
    background: #eee;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    border: 2px solid #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    cursor: pointer;
    flex-shrink: 0;
}

.bg-preview-box img, .bg-preview-box video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.bg-preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    color: #bbb;
    text-align: center;
    font-weight: 600;
    line-height: 1.2;
}

.bg-edit-badge {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 8px;
    text-align: center;
    padding: 2px 0;
    font-weight: 800;
}

/* åº•éƒ¨æ“ä½œæŒ‰é’® */
.bg-action-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.bg-save-btn {
    flex: 2;
    background: #1d1d1f;
    color: #fff;
    padding: 14px;
    border-radius: 14px;
    text-align: center;
    font-weight: 700;
    font-size: 14px;
}

.bg-reset-btn {
    flex: 1;
    background: #f2f2f7;
    color: #ff3b30;
    padding: 14px;
    border-radius: 14px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
}

/* --- ğŸŒ«ï¸ ä¸‡èƒ½èƒŒæ™¯ä¸Šä¼ å¼¹çª— (é»‘ç™½ç‰ˆ) --- */
#modal-universal-uploader .modal-content {
    background: #fff;
    border-top: 1px solid #eee;
}

.uploader-type-tag {
    display: inline-block;
    padding: 4px 10px;
    background: #1d1d1f;
    color: #fff;
    font-size: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
    font-weight: 800;
}

.url-input-wrapper {
    margin-bottom: 20px;
}
.bg-preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #1d1d1f; /* çº¯é»‘æ–‡å­— */
    background: #f2f2f7; /* æµ…ç°åº• */
    text-align: center;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.bg-edit-badge {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: #1d1d1f; /* çº¯é»‘åº• */
    color: #fff; /* çº¯ç™½å­— */
    font-size: 9px;
    text-align: center;
    padding: 3px 0;
    font-weight: 900;
    letter-spacing: 1px;
}
/* --- ğŸš¨ æ ¸å¿ƒï¼šå¼ºåˆ¶å…¨å±é€è§†è¡¥ä¸ --- */

/* 3. è®©å¤´éƒ¨ä¹Ÿå˜é€æ˜ï¼ˆæˆ–è€…ç»™ä¸ªææ·¡çš„ç£¨ç ‚æ„Ÿï¼‰ */
#page-chat-room .chat-room-header {
    background: rgba(255, 255, 255, 0.2) !important; /* 20% é€æ˜ç™½ */
    backdrop-filter: blur(10px) !important; /* iOS ç£¨ç ‚æ„Ÿ */
}

/* 4. åº•éƒ¨è¾“å…¥æ¡†èƒŒæ™¯ä¹Ÿé€æ˜åŒ– */
#page-chat-room .chat-room-footer {
    background: rgba(255, 255, 255, 0.4) !important;
    backdrop-filter: blur(20px) !important;
}

/* 5. ä¸“é—¨çš„ç‰©ç†èƒŒæ™¯å±‚æ ·å¼ */
#chat-room-full-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* é’‰åœ¨æœ€åº•å±‚ */
    pointer-events: none; /* ä¸å¹²æ‰°ç‚¹å‡»æ¶ˆæ¯ */
    overflow: hidden;
}

#chat-room-full-bg img, #chat-room-full-bg video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* æ ¸å¿ƒï¼šå¼ºåˆ¶è£åˆ‡æ’‘æ»¡ */
}
/* --- ğŸš¨ 1. å½»åº•é€šé€è¡¥ä¸ï¼šè§£å†³é¡¶éƒ¨ä¸é€æ˜é—®é¢˜ --- */
#page-chat-room, 
#page-chat-room .chat-room-header,
#page-chat-room .chat-scroll-area,
.status-bar {
    background: transparent !important; /* ç‰©ç†å¼ºåˆ¶é€æ˜ */
    background-color: transparent !important;
    border: none !important;
    box-shadow: none !important;
}

/* å¦‚æœä½ çš„ app-window æœ‰é»˜è®¤åº•è‰²ï¼Œä¹Ÿè¦å¹²æ‰ */
.ios-app-window.chat-room-layer {
    background: transparent !important;
}

/* --- âœ¨ 2. æ˜µç§°å‘å…‰è¡¥ä¸ï¼šè§£å†³æ·±è‰²èƒŒæ™¯çœ‹ä¸æ¸… --- */
#room-contact-name {
    color: #ffffff !important; /* å¼ºåˆ¶æ”¹ä¸ºç™½è‰² */
    /* æ ¸å¿ƒï¼šåŒå±‚æŠ•å½±ã€‚ä¸€å±‚ç™½è‰²æ‰©æ•£å…‰æ™•ï¼Œä¸€å±‚é»‘è‰²è¾¹ç¼˜æè¾¹ï¼Œç¡®ä¿åœ¨ä»»ä½•èƒŒæ™¯éƒ½æ¸…æ™° */
    text-shadow: 
        0 0 15px rgba(255, 255, 255, 0.6), 
        0 2px 4px rgba(0, 0, 0, 0.8) !important;
    font-weight: 800 !important;
}

/* --- â• 3. åŠ å·æŒ‰é’®è¡¥ä¸ï¼šå¢åŠ å¯è§åº¦ --- */
.footer-add-btn {
    color: #ffffff !important; /* æ”¹ä¸ºç™½è‰² */
    background: rgba(255, 255, 255, 0.2) !important; /* ç»™æŒ‰é’®åŠ ä¸ªæ·¡æ·¡çš„åœ†å½¢åº•è‰² */
    width: 32px !important;
    height: 32px !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px); /* ç»ç’ƒæ„Ÿ */
    transition: all 0.2s;
}

.footer-add-btn:active {
    background: rgba(255, 255, 255, 0.4) !important;
    transform: scale(0.9);
}

/* --- ğŸ“± 4. çŠ¶æ€æ æ–‡å­—é€‚é… --- */
/* å¦‚æœèƒŒæ™¯å¤ªæ·±ï¼ŒçŠ¶æ€æ çš„ 15:58 å’Œç”µé‡ä¹Ÿè¦å˜ç™½ */
#page-chat-room .status-bar,
#page-chat-room .status-bar * {
    color: white !important;
    fill: white !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* é¡ºä¾¿ä¼˜åŒ–ä¸€ä¸‹è¿”å›æŒ‰é’® */
.header-glass-btn.left {
    background: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}
/* --- ğŸš¨ ä¿®æ”¹è¿™ä¸€æ®µ --- */
#page-chat-room {
    /* åˆ é™¤åŸæ¥çš„ background-color: transparent !important; */
    background-color: #F2F2F7; /* èµ‹äºˆé»˜è®¤çš„ iOS ç³»ç»Ÿç° */
    position: fixed !important;
}

/* å†…éƒ¨çš„æ»šåŠ¨åŒºåŸŸå’Œå¤´éƒ¨ä¾ç„¶ä¿æŒé€æ˜ï¼Œè¿™æ ·æ‰èƒ½çœ‹åˆ°åº•ä¸‹çš„èƒŒæ™¯èˆ± */
#page-chat-room .chat-scroll-area {
    background-color: transparent !important;
}

/* èƒŒæ™¯èˆ±å±‚çº§ç¨å¾®è°ƒé«˜åˆ° -1ï¼Œç¡®ä¿å®ƒåœ¨å®¹å™¨åº•è‰²ä¹‹ä¸Šï¼Œä½†åœ¨å†…å®¹ä¹‹ä¸‹ */
#chat-room-full-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* è°ƒæˆ 0 */
    pointer-events: none;
    overflow: hidden;
}

/* æ¶ˆæ¯è¡Œéœ€è¦æåˆ°èƒŒæ™¯èˆ±ä¸Šé¢ */
.chat-scroll-area {
    position: relative;
    z-index: 1; 
}
/* --- ğŸš¨ å½»åº•é€šé€è¡¥ä¸ï¼šç§»é™¤æ¨¡ç³Šï¼Œè¿˜åŸæ¸…æ™°èƒŒæ™¯ --- */

/* 1. ç§»é™¤å¤´éƒ¨çš„ç£¨ç ‚ç»ç’ƒæ•ˆæœå’ŒèƒŒæ™¯è‰² */
#page-chat-room .chat-room-header {
    background: transparent !important;
    background-color: transparent !important;
    backdrop-filter: none !important;        /* å…³é”®ï¼šæ’¤é”€æ¨¡ç³Š */
    -webkit-backdrop-filter: none !important; /* å…¼å®¹ iOS */
    border-bottom: none !important;           /* ç§»é™¤ç»†çº¿ */
    box-shadow: none !important;              /* ç§»é™¤é˜´å½± */
}

/* 2. åŒæ—¶ç¡®ä¿çŠ¶æ€æ ä¹Ÿæ˜¯å®Œå…¨æ¸…æ¾ˆé€æ˜çš„ */
#page-chat-room .status-bar {
    background: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}

/* 3. ç¡®ä¿èƒŒæ™¯å±‚å»¶ä¼¸åˆ°æœ€é¡¶éƒ¨ï¼ˆé˜²æ­¢é¡¶éƒ¨ç•™ç™½ï¼‰ */
#chat-room-full-bg {
    top: 0 !important;
    height: 100vh !important;
}

/* 4. å†æ¬¡åŠ å›ºæ˜µç§°å’ŒçŠ¶æ€æ æ–‡å­—çš„æ¸…æ™°åº¦ï¼ˆå‘å…‰å¤–æŒ‚ï¼‰ */
#room-contact-name, 
#page-chat-room .status-bar, 
#page-chat-room .status-bar * {
    color: #ffffff !important;
    text-shadow: 
        0 1px 8px rgba(0, 0, 0, 0.6), 
        0 0 12px rgba(255, 255, 255, 0.4) !important;
}
/* --- ğŸ iOS é£æ ¼æˆåŠŸ HUD (é»‘ç™½æç®€) --- */
.ios-hud {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    width: 140px;
    height: 140px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-radius: 28px;
    display: none; 
    flex-direction: column;
    align-items: center;      /* ç¡®ä¿å†…éƒ¨å…ƒç´ æ°´å¹³å±…ä¸­ */
    justify-content: center;   /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´å±…ä¸­ */
    padding: 20px;             /* å¢åŠ ä¸€ç‚¹å†…è¾¹è·ï¼Œé˜²æ­¢å­—è´´è¾¹ */
    box-sizing: border-box;
}

/* æ¿€æ´»çŠ¶æ€ */
.ios-hud.show {
    display: flex;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

/* æˆåŠŸçš„å‹¾å‹¾åŠ¨ç”» */
.hud-checkmark {
    width: 60px;
    height: 60px;
    stroke: #1d1d1f; /* æç®€é»‘ */
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
}

.ios-hud.show .hud-checkmark {
    animation: dash 0.6s ease-in-out forwards 0.2s;
}

@keyframes dash {
    to { stroke-dashoffset: 0; }
}

.hud-text {
    width: 100%;               /* æ’‘æ»¡å®½åº¦ï¼Œå¦åˆ™ text-align æ— æ•ˆ */
    text-align: center;        /* ğŸš¨ å…³é”®ï¼šå¼ºåˆ¶å¤šè¡Œæ–‡å­—ä¹Ÿå±…ä¸­ */
    margin-top: 15px;
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
    line-height: 1.4;          /* å¢åŠ è¡Œé«˜ï¼Œè®©ä¸¤è¡Œå­—ä¹‹é—´ä¸é‚£ä¹ˆæŒ¤ */
    word-break: break-all;     /* é˜²æ­¢é•¿å•è¯æ’‘ç ´å¸ƒå±€ */
}
/* --- 1. å¥½å‹ç¯ä¸“å±ï¼šç¤¾äº¤åç‰‡æ ·å¼ --- */
.social-card {
    width: 280px;
    background: #fff;
    border-radius: 32px;
    padding: 30px 20px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
}
.social-online-tag {
    font-size: 10px; color: #34C759; font-weight: 800; letter-spacing: 1.5px; margin: 8px 0;
}
.social-motto {
    font-size: 13px; color: #666; background: #f2f2f7; padding: 12px; border-radius: 15px; margin: 15px 0 25px 0;
}
.social-actions {
    display: flex; justify-content: space-around; border-top: 0.5px solid #eee; padding-top: 20px;
}
.social-btn-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #007AFF; cursor: pointer; }
.social-btn-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; }

/* --- 2. è®¾ç½®é¡µä¸“å±ï¼šé«˜å®šæ¡£æ¡ˆå¡ç‰‡ --- */
.aesthetic-preview-card {
    width: 320px;
    background: #ffffff;
    border-radius: 40px;
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.2);
}
.aes-pre-header { height: 100px; background: #1d1d1f; position: relative; } /* é»‘ç™½æç®€é¡¶æ  */
.aes-pre-avatar { width: 100px; height: 100px; border: 5px solid #fff; border-radius: 30px; position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%) rotate(-3deg); object-fit: cover; }
.aes-pre-body { padding: 60px 25px 30px 25px; text-align: center; }
.aes-pre-name { font-family: serif; font-size: 26px; font-weight: 800; color: #000; }
.aes-pre-desc-box { background: #f9f9f9; padding: 15px; border-radius: 18px; margin-top: 20px; text-align: left; max-height: 150px; overflow-y: auto; }
.aes-pre-desc-box p { font-size: 13px; color: #444; line-height: 1.6; font-style: italic; }

/* --- 3. å±‚çº§é”æ­» --- */
.modal-top-layer {
    position: fixed !important; inset: 0 !important;
    z-index: 9995 !important; /* ä»…ä½äºçŠ¶æ€æ  */
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(15px);
    display: none; align-items: center; justify-content: center;
}
/* --- ğŸ› ï¸ ç¤¾äº¤å¡ç‰‡å¢å¼ºæ ·å¼ --- */

/* 1. ç‰©ç†å…³é—­æŒ‰é’® */
.social-close-trigger {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 30px;
    height: 30px;
    background: #f2f2f7; /* æµ…ç°åº• */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #8e8e93;
    cursor: pointer;
    transition: all 0.2s;
}
.social-close-trigger:active {
    transform: scale(0.9);
    background: #e5e5ea;
}

/* 2. è®©ç­¾ååŒºåŸŸçœ‹èµ·æ¥â€œå¯ç‚¹å‡»â€ */
.social-motto {
    cursor: pointer;
    position: relative;
    transition: background 0.2s, transform 0.1s;
    border: 1px solid transparent;
}
.social-motto:hover {
    background: #ebebee;
}
.social-motto:active {
    transform: scale(0.98);
}

/* 3. ç¡®ä¿ç¤¾äº¤å¡ç‰‡å®¹å™¨å¯ä»¥ç›¸å¯¹å®šä½æŒ‰é’® */
.social-card {
    position: relative; /* å¿…é¡»åŠ è¿™ä¸€è¡Œ */
    width: 290px !important;
}
/* --- ğŸš¨ ç‰©ç†å±‚çº§ç»ˆæé”æ­»è¡¥ä¸ --- */

/* 1. é®ç½©åŸºç¡€æ ·å¼ï¼šç¡®ä¿æ˜¯ fixed ä¸”å…¨å± */
.vibe-center-mask, .modal-top-layer {
    position: fixed !important;
    inset: 0 !important;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
}

/* 2. ç¬¬ä¸€å±‚ï¼šç¤¾äº¤å¡ç‰‡ä¸é¢„è§ˆå¡ç‰‡ */
#modal-social-card, 
#modal-aes-preview {
    z-index: 30000 !important; 
}

/* 3. ç¬¬äºŒå±‚ï¼šä¿®æ”¹å¼¹çª—ï¼ˆå¿…é¡»ç›–è¿‡ä¸Šé¢çš„å¡ç‰‡ï¼‰ */
#modal-motto-edit {
    z-index: 35000 !important; /* ğŸ‘ˆ è¿™é‡Œé«˜å‡º 5000 ç‚¹ï¼Œç»å¯¹å‹åˆ¶ */
}

/* 4. ç¬¬ä¸‰å±‚ï¼šæˆåŠŸæç¤º HUD */
#save-success-hud {
    z-index: 40000 !important;
}

/* 5. é¡¶å±‚ï¼šçŠ¶æ€æ  */
.status-bar {
    z-index: 50000 !important;
}
/* --- ğŸš¨ èµ„æ–™é¡µå¸ƒå±€ç»ˆæä¿®æ­£ï¼šå¼ºåˆ¶å…¨å±æ‹‰ä¼¸ --- */

#subpage-char-profile {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: #F2F2F7 !important; 
    z-index: 9990 !important;
    padding-top: 0px !important; /* ç‰©ç†é¿å¼€çŠ¶æ€æ  */
    display: flex !important;
    flex-direction: column;
    box-sizing: border-box !important;
}

/* 1. å¼ºåˆ¶ä¸»ä½“åŒºåŸŸæ’‘æ»¡å·¦å³ */
#subpage-char-profile .app-body {
    width: 100% !important;
    max-width: none !important;
    padding: 10px 16px 120px 16px !important; /* å·¦å³ç•™ 16px æ ‡å‡† iOS å‘¼å¸æ„Ÿ */
    box-sizing: border-box !important;
    display: block !important; /* ç¦ç”¨ Flex é˜²æ­¢æŒ¤å‹ */
}

/* 2. å¼ºåˆ¶å¤´åƒä¸åå­—åŒºåŸŸå±…ä¸­ */
.profile-edit-header {
    width: 100% !important;
    display: flex !important;
    flex-direction: column;
    align-items: center;
    margin-bottom: 25px !important;
}

/* 3. ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶æ–‡æœ¬åŸŸå’Œåˆ—è¡¨ç»„æ¨ªå‘æ’‘æ»¡ */
#subpage-char-profile #edit-char-desc,
#subpage-char-profile .ios-list-group {
    width: 100% !important;        /* ç‰©ç†å®½åº¦ 100% */
    max-width: none !important;    /* æ‹†é™¤é™å®½å¢™ */
    margin: 12px 0 !important;     /* ä¸Šä¸‹ç•™ç©ºï¼Œå·¦å³ä¸ç•™ */
    box-sizing: border-box !important;
    display: block !important;
}

/* 4. æ–‡æœ¬åŸŸç»†èŠ‚è°ƒæ•´ï¼šåŠ é«˜å¹¶ä¼˜åŒ–å†…è¾¹è· */
#edit-char-desc {
    min-height: 180px !important;
    padding: 18px !important;
    border-radius: 18px !important;
    border: none !important;
    background: #fff !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.03) !important;
}

/* 5. ä¿®æ­£å…ƒæ•°æ®åˆ—è¡¨é¡¹å¯¹é½ */
#subpage-char-profile .ios-list-item {
    width: 100% !important;
    padding: 16px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    box-sizing: border-box !important;
}

/* 6. ä¿®æ­£æ ‡é¢˜ä½ç½®ï¼šé å·¦å¯¹é½å¡ç‰‡ */
#subpage-char-profile .tz-group-title {
    width: 100% !important;
    text-align: left !important;
    padding-left: 5px !important;
    margin-top: 25px !important;
}
#subpage-char-profile .app-header {
    /* ... å…¶ä»–ä»£ç ä¸å˜ ... */
    /* ğŸš¨ è¿™é‡Œçš„ padding æ”¹ä¸ºä¸‹é¢è¿™ä¸ªï¼Œåªåœ¨é¡¶éƒ¨ç•™å‡º 48px é¿å¼€çŠ¶æ€æ  */
    padding: 48px 16px 0 16px !important; 
    height: auto !important; /* è®©é«˜åº¦ç”±å†…è¾¹è·è‡ªç„¶æ’‘å¼€ */
}
/* --- ğŸ›ï¸ ä¸–ç•Œä¹¦ï¼šé«˜çº§æ„Ÿâ€œæ·»åŠ â€å¡ç‰‡é‡å¡‘ --- */
.world-add-btn {
    /* 1. ç‰©ç†å°ºå¯¸é”å®šï¼šç¡®ä¿å®ƒå’Œæ™®é€šçš„ world-card-item ä¸€æ ·å¤§ */
    grid-column: span 1; 
    height: 140px !important; /* å¢åŠ ä¸€ç‚¹é«˜åº¦ï¼Œæ›´æ˜¾å¤§æ°” */
    width: 100% !important;
    
    /* 2. èƒŒæ™¯ä¸è¾¹æ¡†ï¼šé»‘ç™½æç®€ï¼Œè™šçº¿åŠ ç²— */
    background: rgba(255, 255, 255, 0.6) !important; /* åŠé€æ˜ç™½ */
    border: 2px dashed #d1d1d6 !important; /* ç°ç™½è™šçº¿ */
    border-radius: 28px !important; /* è¶…å¤§åœ†è§’ */
    
    /* 3. å¸ƒå±€ï¼šçºµå‘æ’åˆ—å›¾æ ‡å’Œæ–‡å­— */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 10px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    
    /* 4. è§†è§‰ä¿®é¥° */
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    box-sizing: border-box;
}

/* æ‚¬åœ/ç‚¹å‡»æ—¶çš„åŠ¨æ€åé¦ˆ */
.world-add-btn:hover {
    background: #ffffff !important;
    border-color: #007AFF !important; /* æ‚¬åœæ—¶è™šçº¿å˜è“ */
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

.world-add-btn:active {
    transform: scale(0.96); /* ç‚¹å‡»æ—¶çš„ç‰©ç†å¼¹æ„Ÿ */
}

/* å†…éƒ¨å›¾æ ‡ç¾åŒ– */
.world-add-btn svg {
    width: 32px;
    height: 32px;
    color: #c7c7cc;
    transition: color 0.3s;
}

.world-add-btn:hover svg {
    color: #007AFF; /* æ‚¬åœæ—¶å›¾æ ‡å˜è“ */
}

/* å†…éƒ¨æ–‡å­—è¡¥å…¨ï¼ˆå¯é€‰ï¼Œå¦‚æœä½ çš„ HTML é‡Œæ²¡å†™å­—çš„è¯ï¼‰ */
.world-add-btn::after {
    content: "CREATE WORLD";
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    color: #d1d1d6;
    text-transform: uppercase;
}
/* --- ğŸ›ï¸ World é¡µé¢ï¼šå½»åº•æ¶ˆç­å·¦å³ç©ºéš™ --- */

/* 1. å¼ºåˆ¶ä¸»ä½“åŒºåŸŸä¸å±…ä¸­ï¼Œä¸”å®½åº¦ 100% */
#worldApp .app-body {
    display: block !important;     /* æ ¸å¿ƒï¼šåœç”¨ Flex å±…ä¸­ï¼Œæ¢å¤å—çº§æµ */
    width: 100% !important;
    padding: 20px 16px !important; /* å·¦å³ä¿ç•™ 16px çš„ iOS æ ‡å‡†å‘¼å¸è¾¹è· */
    box-sizing: border-box !important;
}

/* 2. å¼ºåˆ¶ç½‘æ ¼å®¹å™¨å æ»¡å±å¹• */
#world-grid.char-grid {
    width: 100% !important;
    max-width: none !important;
    margin: 0 !important;
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important; /* å¼ºåˆ¶ 50/50 å¹³åˆ†ä¸¤åˆ— */
    gap: 15px !important; /* å¡ç‰‡ä¹‹é—´çš„é—´è· */
}

/* 3. ä¿®æ­£å¡ç‰‡å’ŒæŒ‰é’®çš„å½¢çŠ¶ï¼ˆè§£å†³é‚£ä¸ªç»†é•¿ä¸‘æ ·ï¼‰ */
.world-add-btn, .world-card-item {
    width: 100% !important;
    /* å»ºè®®ä½¿ç”¨æ­£æ–¹å½¢æˆ–å›ºå®šé«˜åº¦ï¼Œæ›´æœ‰ç”»å»Šæ„Ÿ */
    aspect-ratio: 1 / 1.1 !important; 
    border-radius: 28px !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}

/* 4. åŠ å¼ºåŠ å·æŒ‰é’®çš„è§†è§‰å­˜åœ¨æ„Ÿ */
.world-add-btn svg {
    width: 35px !important;
    height: 35px !important;
    margin-bottom: 8px;
}
/* --- ğŸ“œ ç»‘å®šåè®®é¡µï¼šå…¨å±æ‹‰ä¼¸ä¸é«˜çº§åˆ—è¡¨é‡å¡‘ --- */

/* 1. ç‰©ç†ç¯å¢ƒé‡ç½®ï¼šå¼ºåˆ¶é“ºæ»¡ */
#subpage-world-bind .app-body {
    display: block !important;     /* åœç”¨ Flex å±…ä¸­ */
    width: 100% !important;
    padding: 20px 16px 100px 16px !important; /* å·¦å³ç•™ 16px å‘¼å¸æ„Ÿ */
    box-sizing: border-box !important;
}

/* 2. åˆ—è¡¨ç»„é‡å¡‘ï¼šå˜æˆæ¨ªè·¨å…¨å±çš„åœ†è§’å¡ç‰‡ */
#subpage-world-bind .ios-list-group {
    width: 100% !important;
    max-width: none !important;
    background: #ffffff !important;
    border-radius: 14px !important;
    margin-bottom: 25px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    overflow: hidden;
    display: block !important;
}

/* 3. åˆ—è¡¨é¡¹ï¼ˆè§„åˆ™è¡Œï¼‰ï¼šæ–‡å­—å·¦ï¼Œå‹¾é€‰å³ */
#subpage-world-bind .ios-list-item {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important; /* æ ¸å¿ƒï¼šæ’‘å¼€ä¸¤å¤´ */
    padding: 14px 16px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    min-height: 52px;
}

/* 4. è¡ç”Ÿæ‰©å±•å…¥å£ç¾åŒ– */
#subpage-world-bind .ios-list-item[onclick*="openRelationsPage"] {
    background: #ffffff !important;
    cursor: pointer;
}

#subpage-world-bind .ios-list-item[onclick*="openRelationsPage"]:active {
    background: #f2f2f7 !important; /* ç‚¹å‡»åé¦ˆ */
}

/* 5. æ ‡é¢˜é å·¦å¯¹é½ */
#subpage-world-bind .tz-group-title {
    width: 100% !important;
    text-align: left !important;
    padding-left: 4px !important;
    margin-bottom: 8px !important;
    font-size: 13px;
    font-weight: 600;
}

/* 6. Checkbox æ ·å¼å¾®è°ƒï¼šå˜åœ†æ¶¦ä¸€ç‚¹ */
.world-checkbox {
    -webkit-appearance: none;
    appearance: none;
    width: 24px !important;
    height: 24px !important;
    border: 2px solid #C7C7CC;
    border-radius: 50% !important; /* å˜æˆåœ†å½¢çš„å‹¾é€‰æ¡† */
    outline: none;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.world-checkbox:checked {
    background-color: #007AFF;
    border-color: #007AFF;
}

.world-checkbox:checked::after {
    content: '';
    position: absolute;
    top: 4px; left: 8px;
    width: 5px; height: 10px;
    border: solid white;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
}
/* --- ğŸŒ€ é‡å­è§£æä¸“ç”¨åŠ¨æ•ˆ --- */
.quantum-loader-overlay {
    position: absolute; inset: 0;
    background: rgba(242, 242, 247, 0.9);
    z-index: 1000; display: none;
    flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}

.quantum-spinner {
    width: 60px; height: 60px;
    border: 3px solid rgba(0, 122, 255, 0.1);
    border-top: 3px solid #007AFF;
    border-radius: 50%;
    animation: qSpin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
}

.quantum-status-text {
    margin-top: 20px; font-size: 13px; font-weight: 700;
    color: #007AFF; letter-spacing: 1px;
    font-family: monospace;
}

/* è¿›åº¦æ¡æ ·å¼ */
.q-progress-container {
    width: 200px; height: 4px; background: #e5e5ea;
    border-radius: 10px; margin-top: 15px; overflow: hidden;
}
.q-progress-bar {
    width: 0%; height: 100%; background: #007AFF;
    transition: width 0.4s ease;
}

@keyframes qSpin { to { transform: rotate(360deg); } }

/* NPC å¡ç‰‡æ»‘å…¥åŠ¨æ•ˆ */
.npc-arrival {
    animation: npcSlideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    opacity: 0; transform: translateY(20px);
}
@keyframes npcSlideIn { to { opacity: 1; transform: translateY(0); } }
/* --- ğŸ­ NPC è¯¦æƒ…èµ„æ–™å¡ --- */
.npc-detail-card {
    width: 320px;
    background: #fff;
    border-radius: 36px;
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.25);
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

.npc-pre-header {
    height: 180px;
    background: #1d1d1f;
    position: relative;
    overflow: hidden;
}

.npc-pre-banner {
    width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0.5;
    filter: blur(5px);
}

/* --- ä¿®å¤åçš„å¤´åƒæ ·å¼ --- */
.npc-pre-avatar {
    width: 110px; height: 110px;
    border: 5px solid #fff; /* ç™½è¾¹ä¸€å®šè¦åšï¼Œæ‰èƒ½æŠŠæ·±è‰²èƒŒæ™¯éš”å¼€ */
    border-radius: 32px;
    position: absolute;
    /* ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šä» -40px æ”¹ä¸º -20pxï¼ŒæŠŠå®ƒå¾€ä¸Šæï¼ */
    bottom: -20px !important; 
    left: 30px;
    object-fit: cover;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); /* ç¨å¾®åŠ æ·±ä¸€ç‚¹é˜´å½±ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
    transform: rotate(-3deg); /* ä¿æŒè¿™ä¸ªä¿çš®çš„å€¾æ–œè§’ */
    z-index: 2; /* ç¡®ä¿å®ƒå‹åœ¨ä¸€åˆ‡å†…å®¹ä¸Šé¢ */
}

.npc-pre-body {
    padding: 55px 25px 30px 25px;
}

.npc-pre-name {
    font-family: serif;
    font-size: 24px;
    font-weight: 800;
    color: #000;
}

.npc-pre-role {
    display: inline-block;
    font-size: 10px;
    font-weight: 800;
    color: #007AFF;
    background: rgba(0,122,255,0.08);
    padding: 3px 10px;
    border-radius: 20px;
    margin-top: 5px;
    letter-spacing: 1px;
}

.npc-pre-bio {
    margin-top: 20px;
    font-size: 14px;
    color: #444;
    line-height: 1.7;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 20px;
    font-style: italic;
}

/* --- ğŸ­ NPC åº•éƒ¨å·¥å…·æ ï¼šå½»åº•èåˆç‰ˆ --- */
.npc-pre-footer {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;           /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    padding: 15px 20px;  /* æ•´ä½“å†…è¾¹è· */
    background: #ffffff; /* ğŸ‘ˆ ç¡®ä¿è¿™é‡Œå’Œä½ å¡ç‰‡çš„åº•è‰²å®Œå…¨ä¸€æ · */
    width: 100%;
    box-sizing: border-box;
}

/* æŒ‰é’®åŸºç¡€ï¼šç‰©ç†åŒ…è£¹é€»è¾‘ */
.npc-btn-main {
    flex: 1;             /* å¹³åˆ†å®½åº¦ */
    height: 44px;        /* æ ‡å‡† iOS äº¤äº’é«˜åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;            /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
    border-radius: 22px; /* èƒ¶å›Šå½¢çŠ¶ï¼Œç¡®ä¿å…ƒç´ è¢«å®Œæ•´åŒ…è£¹ */
    border: none;
    cursor: pointer;
    overflow: hidden;    /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢å…ƒç´ æº¢å‡º */
    transition: all 0.2s ease;
}

/* æŒ‰é’®å†…çš„æ–‡å­—è®¾ç½® */
.npc-btn-main span {
    font-size: 13px;
    font-weight: 700;
    white-space: nowrap; /* å¼ºåˆ¶æ–‡å­—åœ¨ä¸€è¡Œï¼Œä¸ä¹±è·‘ */
}

/* æŒ‰é’®å†…çš„å›¾æ ‡è®¾ç½® */
.npc-btn-main svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;      /* é˜²æ­¢å›¾æ ‡è¢«æŒ¤å‹å˜å½¢ */
}

/* 1. å·¦ä¾§ï¼šæŸ¥çœ‹å¾€äº‹ï¼ˆä½è°ƒèåˆè‰²ï¼‰ */
.npc-btn-main.past-btn {
    background: #f2f2f7; /* iOS ç³»ç»Ÿæ¬¡è¦è‰²ï¼Œå’Œç™½è‰²èƒŒæ™¯éå¸¸æ­ */
    color: #3a3a3c;
}

/* 2. å³ä¾§ï¼šAdd Friendï¼ˆé«˜äº®å¯¹æ¯”è‰²ï¼‰ */
.npc-btn-main.add {
    background: #1d1d1f; /* çº¯æ·±è‰²ï¼Œçªå‡ºæ ¸å¿ƒæ“ä½œ */
    color: #ffffff;
}

/* çŠ¶æ€åˆ‡æ¢ï¼šç‚¹å‡»æ—¶çš„ç¼©æ”¾åé¦ˆ */
.npc-btn-main:active {
    transform: scale(0.95);
    background-opacity: 0.8;
}

/* æˆåŠŸçŠ¶æ€ */
.npc-btn-main.sent {
    background: #34C759 !important;
    color: white !important;
}
/* --- ğŸš¨ ç¤¾äº¤å…³ç³»è§†è§‰åŒºåˆ†è¡¥ä¸ --- */

/* æ ¸å¿ƒçº½å¸¦ï¼šå¸¦æ·¡æ·¡çš„å‘¼å¸è“å…‰ */
.char-card.npc-core {
    border: 2px solid rgba(0, 122, 255, 0.4) !important;
    box-shadow: 0 10px 25px rgba(0, 122, 255, 0.15) !important;
}
.char-card.npc-core::before {
    content: "CORE BOND";
    position: absolute; top: 8px; left: 8px;
    background: #007AFF; color: #fff;
    font-size: 7px; font-weight: 900; padding: 2px 6px;
    border-radius: 4px; z-index: 5;
}

/* æ‰©å±•å…³ç³»å¡ç‰‡ï¼šæ™®é€šç™½ */
.char-card.npc-associate {
    border: 1px solid rgba(0,0,0,0.05);
}

/* åº•éƒ¨â€œç»§ç»­ç”Ÿæˆâ€æŒ‰é’®æ ·å¼ */
.relation-footer-tools {
    width: 100%; padding: 20px 0 60px 0;
    display: flex; justify-content: center;
}
.btn-extend-network {
    background: #ffffff; color: #1d1d1f;
    border: 1.5px solid #1d1d1f;
    width: 180px; padding: 12px;
    border-radius: 14px; font-size: 13px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-extend-network:active { transform: scale(0.95); }

/* æ•…äº‹æŸ¥çœ‹å™¨å¼¹çª—èƒŒæ™¯ */
.story-reading-layer {
    background: #fff; padding: 30px 25px; border-radius: 30px 30px 0 0;
    height: 70vh; overflow-y: auto; text-align: justify;
}
/* --- ğŸ“¡ å¥½å‹ç”³è¯·ï¼šé‡å­ä¿¡å·ä¼ è¾“åŠ¨æ•ˆåŠ å›º --- */
/* --- ğŸ“¡ é‡å­è§£æåŠ¨æ•ˆåŠ å›º --- */
#npc-add-btn.sending {
    background: #007AFF !important;
    color: white !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

#npc-add-btn.sending::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.4) 50%, 
        transparent 100%);
    animation: signalScan 1.5s infinite linear;
    z-index: 5;
}

@keyframes signalScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

/* æˆåŠŸçŠ¶æ€ */
#npc-add-btn.sent {
    background: #34C759 !important;
    transition: background 0.5s ease;
}
/* --- ğŸ“œ å¾€äº‹è§£å¯†å®¹å™¨ --- */
#npc-past-container {
    margin-top: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
    border-left: 3px solid #007AFF; /* ç§‘æŠ€è“è¾¹æ¡† */
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    color: #e0e0e0;
    display: none; /* é»˜è®¤éšè— */
    position: relative;
    overflow: hidden;
}

/* è§£å¯†è¿‡ç¨‹ä¸­çš„æ‰«æçº¿ */
#npc-past-container.decrypting::before {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 2px;
    background: #007AFF;
    box-shadow: 0 0 10px #007AFF;
    animation: scanDown 2s infinite linear;
}

@keyframes scanDown {
    0% { top: 0; opacity: 0; }
    20% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

/* æ–‡å­—å‡ºç°çš„æ‰“å­—æœºæ•ˆæœ */
.typing-effect {
    overflow: hidden; /* ä¿è¯æ–‡å­—ä¸æº¢å‡º */
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
    animation: typing 0.05s steps(1) forwards;
}

/* æŒ‰é’®åŠ è½½æ—¶çš„è„‰å†² */
.btn-pulsing {
    animation: pulseBlue 1.5s infinite;
    pointer-events: none; /* åŠ è½½æ—¶ç¦æ­¢ç‚¹å‡» */
    opacity: 0.8;
}

@keyframes pulseBlue {
    0% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 122, 255, 0); }
}
/* ä¿¡å·æ‰«æçŠ¶æ€ - ç»™åŸæœ¬çš„æŒ‰é’®åŠ ç‰¹æ•ˆ */
.npc-btn-main.scanning {
    background: #1d1d1f !important;
    color: #007AFF !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

.npc-btn-main.scanning::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 122, 255, 0.4), transparent);
    animation: btnScan 1.2s infinite linear;
}

@keyframes btnScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

/* æ•…äº‹æ–‡æœ¬è§£å¯†æ‰“å­—æœºæ•ˆæœ */
.decrypt-text {
    font-family: serif;
    line-height: 1.8;
    color: #444;
    white-space: pre-wrap;
}
/* --- ğŸ† å¾€äº‹å¡ç‰‡ç»ˆæå±‚çº§ç½®é¡¶ --- */
#modal-vibe-result {
    display: none; 
    position: fixed !important;
    inset: 0 !important;
    /* ğŸš¨ å…³é”®ï¼šå¿…é¡»æ¯” 40000 è¿˜è¦å¤§ï¼ */
    z-index: 99999 !important; 
    background: rgba(0, 0, 0, 0.7) !important;
    backdrop-filter: blur(15px) !important;
    align-items: center !important;
    justify-content: center !important;
}

/* ç¡®ä¿å†…éƒ¨å¡ç‰‡æ ·å¼æ­£å¸¸ */
#modal-vibe-result .aesthetic-card {
    width: 90% !important;
    max-width: 340px !important;
    height: 75vh !important;
    display: flex !important;
    flex-direction: column !important;
    background: #fff !important;
    border-radius: 32px !important;
    animation: worldPopCenter 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
}
/* æ¡£æ¡ˆå¡ç‰‡ä¸“å±æ ·å¼è¡¥ä¸ */
.past-magazine-style {
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
    background: #fff !important;
    animation: magazinePop 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
}

@keyframes magazinePop {
    from { opacity: 0; transform: scale(0.9) translateY(40px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* è§£å¯†ä¸­çš„æŒ‰é’®åŠ¨æ€æ•ˆæœ */
.npc-btn-main.decoding {
    background: #1d1d1f !important;
    color: #007AFF !important;
    pointer-events: none;
    position: relative;
    overflow: hidden;
}

.npc-btn-main.decoding::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 122, 255, 0.3), transparent);
    animation: decodeScan 1.2s infinite linear;
}

@keyframes decodeScan {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
}

#past-text-body {
    font-family: "SF Pro Display", serif;
    font-size: 15px;
    line-height: 1.8;
    color: #333;
    white-space: pre-wrap;
    padding-bottom: 30px;
}
/* --- ğŸ­ NPC è¯¦æƒ…å¡ï¼šä¸‰æŒ‰é’® UI å®Œç¾è¡¥ä¸ --- */
.npc-pre-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px; 
    padding: 5px 20px 35px 20px; /* ğŸ‘ˆ é¡¶éƒ¨ç¼©å‡ï¼Œåº•éƒ¨ç•™ç™½ */
    background: transparent !important; /* ğŸ‘ˆ æ ¸å¿ƒï¼šç‰©ç†æ¶ˆé™¤ç™½è‰²çªå…€æ–¹å— */
    width: 100%;
    box-sizing: border-box;
}

/* æŒ‰é’®åŸºç¡€å®¹å™¨ */
.npc-btn-action {
    height: 40px;
    border-radius: 12px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 11px;
    font-weight: 800;
    overflow: hidden; /* ç¡®ä¿å†…å®¹è¢«å®Œç¾åŒ…è£¹ */
}

/* å¾€äº‹ & æ„Ÿå…´è¶£ï¼šæµ…è‰²æ ·å¼ */
.npc-btn-action.minor {
    flex: 1;
    background: #f2f2f7;
    color: #1d1d1f;
}

/* åŠ å¯†å‹ï¼šæ·±è‰²é«˜å¯¹æ¯”æ ·å¼ */
.npc-btn-action.main {
    flex: 2; /* è®©åŠ å¯†å‹æŒ‰é’®å®½ä¸€ç‚¹ï¼Œæ›´æœ‰ç‚¹å‡»æ¬² */
    background: #1d1d1f;
    color: #ffffff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.npc-btn-action:active { transform: scale(0.95); opacity: 0.8; }

/* å›¾æ ‡å¤§å°é”å®š */
.npc-btn-action svg { width: 16px; height: 16px; flex-shrink: 0; }

/* ä¿¡å·æ‰«ææ•ˆæœ (åŠ å¯†å‹ä¸“ç”¨) */
.npc-btn-action.syncing {
    background: #007AFF !important;
    pointer-events: none;
}
/* --- ğŸ–¤ æœ¬æˆ‘æ¡£æ¡ˆä¸“å±æ ·å¼è¡¥ä¸ --- */
.user-profile-style {
    border: 1px solid #1d1d1f !important;
    box-shadow: 0 30px 80px rgba(0,0,0,0.3) !important;
}

#subpage-user-profile .app-body {
    display: block !important;
    width: 100% !important;
}

#user-bio-in {
    font-family: "PingFang SC", sans-serif;
    font-size: 15px;
    color: #3a3a3c;
    border-radius: 18px !important;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
}

/* è°ƒæ•´è®¾ç½®é¡µä¸­çš„â€œæˆ‘çš„èµ„æ–™â€å…¥å£ï¼Œç¡®ä¿ç‚¹å‡»æœ‰æ•ˆ */
.standalone-btn.user-entry {
    background: #1d1d1f !important;
    color: #fff !important;
    margin-bottom: 20px;
}
/* è®©æŒ‰é’®çœ‹èµ·æ¥æ›´é«˜çº§ï¼Œå…¨åŒ…è£¹ä¸çªå…€ */
.sub-setting-btn.user-btn-main {
    background: #1d1d1f !important; /* çº¯é»‘ä¸»æŒ‰é’® */
    color: #fff !important;
    border-radius: 12px;
    margin-bottom: 10px !important;
    font-weight: 700;
}

.sub-setting-btn.user-btn-secondary {
    background: #f2f2f7 !important; /* æµ…ç°æ¬¡è¦æŒ‰é’® */
    color: #1d1d1f !important;
    border-radius: 12px;
    margin-top: 0 !important;
    font-weight: 600;
}
/* å¼ºåˆ¶å­é¡µé¢æ˜¾å½±é€»è¾‘ */
#subpage-user-profile.active {
    transform: translateX(0) !important;
    display: flex !important;
}

/* ç¼–è¾‘é¡µå†…æ–‡å­—åŸŸé«˜çº§æ„Ÿ */
#user-bio-in {
    border-radius: 14px !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);
    font-family: inherit;
    resize: none;
}
/* å¼ºåˆ¶è¦†ç›–åŸæœ‰çš„å­é¡µé¢æ¿€æ´»é€»è¾‘ */
.ios-sub-page.active {
    display: flex !important;    /* å¿…é¡»åŠ è¿™ä¸€è¡Œï¼Œå¦åˆ™é¡µé¢æ°¸è¿œæ˜¯éšè—çš„ */
    transform: translateX(0) !important;
    z-index: 15000 !important;   /* ç¡®ä¿å®ƒåœ¨æœ€é¡¶å±‚ï¼Œç›–è¿‡è®¾ç½® App */
}
/* --- ğŸï¸ åˆ—è¡¨é¡µç¾åŒ– --- */
.memory-hero-banner {
    padding: 30px 20px;
    text-align: left;
}
.hero-label { font-size: 10px; font-weight: 900; color: #007AFF; letter-spacing: 3px; }
.hero-title { font-size: 34px; font-weight: 800; color: #1d1d1f; margin-top: 5px; }
.hero-subtitle { font-size: 13px; color: #8e8e93; margin-top: 5px; }

.memory-grid-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    padding: 10px 20px 120px 20px;
}

/* è®°å¿†å¡ç‰‡è®¾è®¡ */
.memory-item-card {
    position: relative;
    background: #fff;
    border-radius: 28px;
    padding: 24px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.02);
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    cursor: pointer;
}
.memory-item-card:active { transform: scale(0.96); }

.card-num {
    position: absolute; right: -10px; top: -10px;
    font-size: 80px; font-weight: 900; color: rgba(0,0,0,0.03);
    font-style: italic; pointer-events: none;
}

/* --- ğŸï¸ åˆ—è¡¨ä¸å¸ƒå±€ --- */
.memory-hero-area { padding: 40px 20px 20px; }
.hero-tag { font-size: 10px; font-weight: 900; color: #007AFF; letter-spacing: 4px; }
.hero-title { font-size: 36px; font-weight: 800; color: #1d1d1f; }
.hero-desc { font-size: 14px; color: #8e8e93; margin-top: 8px; }

.memory-stagger-grid { display: flex; flex-direction: column; gap: 20px; padding: 10px 20px 120px; }

/* è®°å¿†å¡ç‰‡æ ·å¼ */
.memory-item-card {
    background: #fff; border-radius: 30px; padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.04);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    cursor: pointer; position: relative; border: 1px solid rgba(0,0,0,0.02);
}
.memory-item-card:active { transform: scale(0.95) translateY(5px); }

/* --- ğŸ¬ æ²‰æµ¸å¼ç”µå½±è§†å›¾ --- */
.cinema-portal {
    position: fixed !important; inset: 0 !important;
    z-index: 999999 !important; background: #000;
    display: none; opacity: 0; transition: opacity 0.5s ease;
}
.cinema-portal.active { opacity: 1; display: flex; }

.cinema-stage { width: 100%; height: 100%; background: #fff; animation: cinemaSlideUp 0.7s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes cinemaSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.cinema-scroll-layer { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.cinema-hero-banner { height: 60vh; width: 100%; position: relative; }
.cinema-hero-banner img { width: 100%; height: 100%; object-fit: cover; }
.cinema-hero-mask { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 40%, #fff 98%); }

.cinema-title-box { position: absolute; bottom: 40px; left: 30px; right: 30px; }
#cinema-title-ui { font-size: 32px; font-weight: 800; color: #1d1d1f; line-height: 1.2; }

.cinema-text-wrapper { padding: 0 30px 100px; }
.cinema-prose { font-family: "PingFang SC", serif; font-size: 18px; line-height: 2; color: #2c2c2e; text-align: justify; white-space: pre-wrap; }

/* --- ğŸŒ€ é‡å­ç»‡ç½‘åŠ¨ç”» --- */
.quantum-overlay {
    position: fixed; inset: 0; background: rgba(255,255,255,0.9);
    z-index: 1000000; display: none; flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}
.weaving-core { width: 50px; height: 50px; position: relative; animation: qRotate 4s linear infinite; }
.spider-line { position: absolute; top: 50%; left: 50%; width: 100%; height: 2px; background: #007AFF; transform-origin: center; animation: qPulse 1.5s ease-in-out infinite; }
@keyframes qRotate { to { transform: rotate(360deg); } }
@keyframes qPulse { 0%, 100% { transform: translate(-50%,-50%) scaleX(0.2); opacity: 0.2; } 50% { transform: translate(-50%,-50%) scaleX(1); opacity: 1; } }
.weaving-text { margin-top: 30px; font-size: 13px; font-weight: 700; color: #007AFF; letter-spacing: 2px; }
/* --- ğŸ’ é«˜çº§æ„Ÿï¼šå”¤é†’æŒ‰é’®ç¾åŒ– --- */
.memory-footer-bar {
    position: absolute; bottom: 30px; left: 0; width: 100%;
    display: flex; justify-content: center; padding: 0 20px; z-index: 100;
}

.btn-awaken-core {
    width: 100%; max-width: 320px; height: 60px;
    background: linear-gradient(135deg, #1d1d1f 0%, #3a3a3c 100%); /* æ·±è‰²æ‹‰ä¸è´¨æ„Ÿ */
    color: #fff; border-radius: 20px; border: none;
    display: flex; align-items: center; justify-content: center;
    gap: 12px; font-size: 16px; font-weight: 700; letter-spacing: 1px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3); /* è¶…æ·±é˜´å½± */
    transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    position: relative; overflow: hidden;
}

.btn-awaken-core:active {
    transform: scale(0.96) translateY(3px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* æŒ‰é’®æ‰«å…‰ç‰¹æ•ˆ */
.btn-awaken-core::after {
    content: ""; position: absolute; top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: btnShine 3s infinite;
}

@keyframes btnShine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

/* è®°å¿†å¡ç‰‡å¾®è°ƒ */
.memory-item-card {
    background: #fff; border-radius: 24px; padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.01);
}
/* --- ğŸ’ é«˜çº§æ„Ÿï¼šå”¤é†’æŒ‰é’® --- */
.memory-footer-bar {
    position: absolute; bottom: 35px; left: 0; width: 100%;
    display: flex; justify-content: center; padding: 0 25px; z-index: 100;
}

.btn-awaken-core {
    width: 100%; max-width: 320px; height: 64px;
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%); /* æè‡´ç£¨ç ‚é»‘ */
    color: #fff; border-radius: 22px; border: none;
    display: flex; align-items: center; justify-content: center;
    gap: 15px; font-size: 16px; font-weight: 700; letter-spacing: 2px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.1);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative; overflow: hidden;
    cursor: pointer;
}

/* æŒ‰é’®æ‰«å…‰ç‰¹æ•ˆ */
.btn-awaken-core::after {
    content: ""; position: absolute; top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.08), transparent);
    transform: rotate(45deg);
    animation: btnShine 4s infinite;
}

@keyframes btnShine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

.btn-awaken-core:active {
    transform: scale(0.96) translateY(4px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}
/* --- ğŸš¨ çŠ¶æ€æ å¼ºåˆ¶ç½®é¡¶è¡¥ä¸ --- */
.status-bar {
    z-index: 1000005 !important; /* ç»å¯¹æœ€é«˜å±‚çº§ï¼Œç¡®ä¿åœ¨æ•…äº‹é¡µé¢ä¹‹ä¸Š */
    position: relative;
    background: transparent; /* ä¿æŒé€æ˜ï¼Œå¯ä»¥çœ‹åˆ°åé¢çš„å¤§å›¾ */
}

/* --- ğŸ¬ ç”µå½±è¯¦æƒ…é¡µï¼šç‰©ç†ä¸‹ç§»ä¸å±‚çº§è°ƒæ•´ --- */
.cinema-portal {
    position: fixed !important;
    inset: 0 !important;
    background: #ffffff;
    z-index: 1000000 !important; /* ä½äºçŠ¶æ€æ ï¼Œé«˜äºæ™®é€šé¡µé¢ */
    display: none; 
    opacity: 0;
    transition: opacity 0.5s ease;
    flex-direction: column;
}

/* å½“é¡µé¢æ¿€æ´»æ—¶ */
.cinema-portal.active {
    display: flex !important;
    opacity: 1 !important;
}

/* æ ¸å¿ƒæ»šåŠ¨å±‚ï¼šå¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œé¿å¼€çŠ¶æ€æ  */
.cinema-scroll-layer {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-top: 48px; /* ğŸš¨ ç‰©ç†é¿è®©ï¼šè¿™é‡Œçš„é«˜åº¦å¿…é¡»ç­‰äºæˆ–å¤§äºçŠ¶æ€æ é«˜åº¦ */
}

/* --- âŒ å¼ºåŠ›æ˜¾å½¢ï¼šå…³é—­æŒ‰é’® --- */
.cinema-close-trigger {
    position: fixed; /* æ”¹ä¸º fixedï¼Œç¡®ä¿ä¸éšé¡µé¢æ»šåŠ¨æ¶ˆå¤± */
    top: 60px;       /* æ”¾åœ¨çŠ¶æ€æ ä¸‹æ–¹ä¸€ç‚¹ */
    right: 20px;
    z-index: 1000010; /* ç”šè‡³æ¯”çŠ¶æ€æ è¿˜è¦é«˜ï¼Œç¡®ä¿èƒ½ç‚¹åˆ° */
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.5); /* åŠé€æ˜é»‘ï¼Œç¡®ä¿åœ¨ç™½è‰²èƒŒæ™¯æˆ–å›¾ç‰‡ä¸Šéƒ½èƒ½çœ‹æ¸… */
    backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex !important; /* å¼ºåˆ¶æ˜¾ç¤º */
    align-items: center;
    justify-content: center;
    color: #ffffff;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.cinema-close-trigger svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
}

/* æŒ‰é’®ç‚¹å‡»åé¦ˆ */
.cinema-close-trigger:active {
    transform: scale(0.9);
    background: rgba(0, 0, 0, 0.8);
}
/* ğŸš‘ å¤´éƒ¨é—´è·ä¿®æ­£è¡¥ä¸ï¼šè§£å†³é¡¶éƒ¨ç©ºç™½è¿‡å¤§çš„é—®é¢˜ */

/* 1. é’ˆå¯¹æ‰€æœ‰å­é¡µé¢çš„é€šç”¨ä¿®æ­£ */
.ios-sub-page .app-header {
    padding-top: 55px !important;  /* ä» 80px ç¼©å‡åˆ° 55px */
    min-height: 90px !important;   /* ç¼©å°ä¿åº•æ€»é«˜åº¦ */
    padding-bottom: 10px !important;
}

/* 2. ä¸“é—¨é’ˆå¯¹â€œæ—¶ç©ºæ¡£æ¡ˆåº“â€é¡µé¢çš„ç»†èŠ‚å¾®è°ƒ */
#subpage-memory-list .app-header {
    padding-top: 55px !important;
    padding-bottom: 12px !important;
    background: #ffffff !important; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ï¼Œä¸é€å‡ºåº•è‰² */
}

/* 3. é¡ºä¾¿å¾®è°ƒä¸€ä¸‹è¿”å›æŒ‰é’®å’Œæ ‡é¢˜çš„å¯¹é½ï¼Œè®©å®ƒæ›´ç²¾è‡´ */
.ios-sub-page .header-left, 
.ios-sub-page .header-title {
    margin-bottom: 2px !important;
}
/* --- ğŸï¸ ç”µå½±æ„Ÿè§†ç•Œï¼šé»‘ç™½é«˜å®šæ’ç‰ˆ --- */
.cinema-prose {
    font-family: "PingFang SC", "STHeiti", serif;
    font-size: 17px;
    line-height: 2.2; /* æå…¶å®½æ•çš„è¡Œé—´è· */
    color: #000000;
    text-align: justify;
    padding-bottom: 50px;
}

/* ğŸš¨ æ ¸å¿ƒï¼šæ®µè½é—´è· */
.cinema-prose p {
    margin-bottom: 28px; /* ç»™æ®µè½ä¹‹é—´ç•™å‡ºå‘¼å¸ç©ºé—´ */
    display: block;
}

/* ğŸš¨ é‡ç‚¹ï¼šã€ ã€‘å†…çš„æ ¸å¿ƒè¯ï¼ˆé»‘åº•ç™½å­—ï¼‰ */
.memory-highlight {
    background-color: #ffffff !important;
    color: #000000 !important;
    padding: 0px 6px;
    margin: 0 2px;
    border-radius: 2px;
    font-weight: 800;
    display: inline-block;
}

.memory-focus {
    border-bottom: 2px solid #AF52DE;
    font-weight: 800;
    color: #fff;
    padding-bottom: 1px;
}
/* --- ğŸï¸ è®°å¿†å¡ç‰‡å·¦æ»‘åˆ é™¤è¡¥ä¸ --- */
.memory-swipe-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden; /* éšè—æº¢å‡ºçš„åˆ é™¤æŒ‰é’® */
    border-radius: 28px; /* ä¿æŒåœ†è§’ä¸€è‡´ */
    margin-bottom: 18px;
    background-color: #FF3B30; /* æ»‘å¼€åéœ²å‡ºçš„åº•è‰²æ˜¯çº¢è‰² */
}

.memory-swipe-content {
    position: relative;
    width: 100%;
    background: #ffffff;
    z-index: 2; /* ç›–åœ¨æŒ‰é’®ä¸Šé¢ */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    will-change: transform;
}

.memory-swipe-actions {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 80px; /* åˆ é™¤æŒ‰é’®çš„å®½åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    color: #fff;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
}
/* --- ğŸšï¸ è®°å¿†æ€»ç»“ä¸“å±æ»‘åŠ¨æ¡ç¾åŒ– --- */
#subpage-memory-summary .ios-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: #e5e5ea;
    border-radius: 10px;
    outline: none;
    /* åŠ¨æ€å¡«å……è‰²ï¼šå·¦é»‘å³ç° */
    background-image: linear-gradient(#000, #000);
    background-size: var(--percent, 20%) 100%;
    background-repeat: no-repeat;
}

#subpage-memory-summary .ios-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 28px;
    width: 28px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2), 0 0 0 0.5px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.1s;
}

#subpage-memory-summary .ios-slider:active::-webkit-slider-thumb {
    transform: scale(1.15);
}
/* ==========================================
   ğŸš¨ ç‰©ç†é”æ­»ï¼šè®°å¿†æ€»ç»“é¡µå…¨å®½æ‹‰ä¼¸
   ========================================== */

/* 1. å¼ºåˆ¶ä¸»ä½“å®¹å™¨ä¸è®¸å±…ä¸­ï¼Œå æ»¡ 100% */
#subpage-memory-summary .app-body {
    display: block !important;          /* âŒ åœç”¨ Flex å±…ä¸­ï¼Œæ¢å¤å—çº§æµ */
    width: 100% !important;
    padding: 20px 16px !important;      /* å·¦å³ä¿ç•™ 16px æ ‡å‡†è¾¹è·ï¼Œå…¶ä½™å…¨éƒ¨æ‹‰æ»¡ */
    max-width: none !important;
    box-sizing: border-box !important;
}

/* 2. å¼ºåˆ¶å†…éƒ¨å¡ç‰‡ç»„å æ»¡å±å¹• */
#subpage-memory-summary .ios-list-group {
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    display: block !important;           /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´å †å  */
    box-sizing: border-box !important;
}

/* 3. å¼ºåˆ¶æ»‘å—è½¨é“æ’‘æ»¡ 100% */
#subpage-memory-summary .ios-slider {
    width: 100% !important;
    margin: 30px 0 !important;           /* å¢åŠ ä¸Šä¸‹é—´è·ï¼Œæ›´æ˜¾å¤§æ°” */
    display: block !important;
}

/* 4. ä¿®å¤æ ‡é¢˜æ–‡å­—å¯¹é½ */
#subpage-memory-summary .tz-group-title {
    text-align: left !important;
    padding-left: 4px !important;
    width: 100% !important;
}

/* 5. è°ƒæ•´æ•°å­—æ˜¾ç¤ºçš„ä½ç½® */
#summary-rounds-val {
    font-size: 50px !important;
    font-weight: 800 !important;
    color: #000;
}
/* --- ğŸ““ è®°å¿†æ€»ç»“å¡ç‰‡ï¼šé»‘ç™½æ¡£æ¡ˆé£ --- */
.summary-card {
    background: #fff;
    border: 1.5px solid #000;
    border-radius: 20px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    animation: cardFadeIn 0.4s ease-out;
}

.summary-card::before {
    content: "CORE MEMORY";
    position: absolute;
    top: 10px; right: -25px;
    background: #000;
    color: #fff;
    font-size: 8px;
    font-weight: 900;
    padding: 2px 30px;
    transform: rotate(45deg);
}

.summary-date {
    font-size: 10px;
    color: #8e8e93;
    font-family: monospace;
    margin-bottom: 10px;
    display: block;
}

.summary-content {
    font-size: 14px;
    line-height: 1.7;
    color: #1d1d1f;
    font-family: serif;
    font-style: italic;
}

.btn-delete-summary {
    position: absolute;
    bottom: 15px; right: 20px;
    font-size: 11px;
    color: #FF3B30;
    font-weight: 700;
    cursor: pointer;
}

@keyframes cardFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ“± é€šçŸ¥ä¸­å¿ƒï¼šç‰©ç†å¢å¼ºç‰ˆ --- */
.notification-shade {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.4); /* åŠ æ·±åº•è‰² */
    backdrop-filter: blur(25px) saturate(160%);
    -webkit-backdrop-filter: blur(25px) saturate(160%);
    z-index: 100000; 
    display: none; /* åˆå§‹ç”± JS æ§åˆ¶æ˜¾ç¤º */
    flex-direction: column;
    transform: translateY(-100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    pointer-events: auto;
}

/* æ¿€æ´»çŠ¶æ€ */
.notification-shade.active {
    transform: translateY(0);
}

/* ğŸš¨ å…³é”®ï¼šæ‰‹åŠ¿æ„Ÿåº”åŒº (çŠ¶æ€æ éšå½¢å¤–æŒ‚) */
.status-bar {
    pointer-events: auto !important; /* ç¡®ä¿çŠ¶æ€æ èƒ½æŠ“åˆ°ç‚¹å‡»/æ»‘åŠ¨ */
}

/* é®ç½©å±‚é¡¶éƒ¨çš„æŠŠæ‰‹ */
.shade-handle {
    width: 40px; height: 5px; background: rgba(255,255,255,0.3);
    border-radius: 10px; margin: 15px auto;
}

/* --- ğŸ”” å®æ—¶æ¨é€æ¨ªå¹… (Push Banner) --- */
.ios-banner {
    position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
    width: 92%; max-width: 380px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 24px; padding: 15px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    z-index: 110000; display: flex; align-items: center; gap: 12px;
    transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    cursor: pointer;
}

.ios-banner.show { top: 55px; } /* é¿å¼€çŠ¶æ€æ é«˜åº¦ */

.banner-icon { width: 36px; height: 36px; background: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
.banner-content { flex: 1; }
.banner-title { font-size: 13px; font-weight: 800; color: #000; margin-bottom: 2px; }
.banner-text { font-size: 12px; color: #333; line-height: 1.3; }
/* --- ğŸ“± é€šçŸ¥ä¸­å¿ƒï¼šå¸ƒå±€ä¸æ ‡é¢˜æ  --- */
.notification-shade {
    /* ...ä¿æŒä½ ä¹‹å‰çš„å›ºå®šå®šä½å’ŒèƒŒæ™¯æ¨¡ç³Šæ ·å¼... */
    display: none;
    flex-direction: column; /* ç¡®ä¿å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
    justify-content: space-between; /* è®©å†…å®¹å’Œåº•éƒ¨æŠŠæ‰‹åˆ†å¼€ */
    padding-bottom: 20px; /* ç»™åº•éƒ¨æŠŠæ‰‹ç•™ä½ç½® */
    box-sizing: border-box;
}

/* æ–°å¢ï¼šæ¯›ç»ç’ƒæ ‡é¢˜æ  */
.notif-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 45px 20px 15px; /* é¿å¼€çŠ¶æ€æ é«˜åº¦ */
    background: rgba(255, 255, 255, 0.1); /* ææ·¡çš„ç™½è‰²é®ç½© */
    border-bottom: 0.5px solid rgba(255, 255, 255, 0.2); /* ç²¾è‡´åˆ†å‰²çº¿ */
}

.notif-title {
    font-size: 28px;
    font-weight: 800;
    color: #fff;
    letter-spacing: 0.5px;
}

/* æ¸…é™¤æŒ‰é’® */
.notif-clear-btn {
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: all 0.2s;
}
.notif-clear-btn:active {
    background: rgba(255,255,255,0.4);
    transform: scale(0.9);
}

/* åˆ—è¡¨å®¹å™¨ï¼šå¯æ»šåŠ¨ */
.notif-list-container {
    flex: 1; /* å æ»¡å‰©ä½™ç©ºé—´ */
    overflow-y: auto;
    padding: 20px 16px;
}

.notif-empty-state {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 14px;
    margin-top: 100px;
    font-weight: 500;
}

/* --- åº•éƒ¨æŠŠæ‰‹ (å–ä»£åŸæ¥çš„é¡¶éƒ¨æŠŠæ‰‹) --- */
.shade-handle-bottom {
    width: 45px;
    height: 5px;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 10px;
    margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
    flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
    cursor: pointer;
}
/* é€šçŸ¥æ¨ªå¹…åŸºç¡€æ ·å¼ */
.ios-banner {
    position: fixed;
    top: -100px; /* åˆå§‹è—åœ¨ä¸Šé¢ */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    z-index: 999999;
    display: flex;
    align-items: center;
    transition: top 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28); /* å¼¹æ€§æ»‘å…¥ */
    cursor: pointer;
}

/* æ˜¾ç¤ºæ—¶çš„çŠ¶æ€ */
.ios-banner.show {
    top: 20px;
}
/* 1. ä¿®å¤æ¶ˆæ¯åˆ—è¡¨æ¡å˜å½¢ï¼šå¼ºåˆ¶å•è¡Œæˆ–åŒè¡Œæˆªæ–­ */
.contact-preview {
    font-size: 13px;
    color: #8E8E93;
    margin-top: 2px;
    /* æ ¸å¿ƒä¿®å¤ï¼šè¶…å‡ºæ–‡å­—å˜çœç•¥å·ï¼Œä¸æ’‘å¼€é«˜åº¦ */
    display: -webkit-box !important;
    -webkit-line-clamp: 1; /* å¼ºåˆ¶åªæ˜¾ç¤º1è¡Œï¼Œä½ å¯ä»¥æ”¹æˆ2 */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal; /* è¦†ç›–å¯èƒ½å†²çªçš„ nowrap */
    word-break: break-all;
    max-height: 18px; /* é”å®šé«˜åº¦ï¼Œé˜²æ­¢æŠ–åŠ¨ */
}

/* 2. ä¿®å¤å¼¹çª—ä½ç½®ï¼šå‘ä¸‹å¹³ç§»ï¼Œé¿å¼€çŠ¶æ€æ (48px) */
.ios-banner {
    top: -120px; /* åˆå§‹ä½ç½®æ›´é ä¸Šï¼Œç¡®ä¿å½»åº•è—ä½ */
    transition: top 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
}

.ios-banner.show {
    top: 60px !important; /* çŠ¶æ€æ  48px + 12px ç•™ç™½ï¼Œé»„é‡‘æ¯”ä¾‹ */
}

/* 3. é€šçŸ¥ä¸­å¿ƒé‡Œçš„å¡ç‰‡æ ·å¼å¾®è°ƒï¼Œç¡®ä¿ç¾è§‚ */
.notif-item {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 18px;
    padding: 15px;
    margin-bottom: 12px;
    color: #fff;
    animation: msgFadeUp 0.4s ease;
}
/* ğŸš¨ ç‰©ç†ä¿®å¤ï¼šå­é¡µé¢åˆ—è¡¨å®½åº¦é”å®š */
#subpage-icon-picker .app-body {
    padding: 20px 16px !important; /* è¿˜åŸ iOS æ ‡å‡†ï¼šä¸Šä¸‹ 20pxï¼Œå·¦å³ 16px */
    display: block !important;      /* ç¡®ä¿å†…å®¹æŒ‰å—çº§æ’åˆ—ï¼Œä¸è¢« flex æŒ¤å‹å®½åº¦ */
    overflow-y: auto;
}

#icon-target-list {
    width: 100% !important;         /* å¼ºåˆ¶åˆ—è¡¨å®¹å™¨ 100% å®½åº¦ */
    margin: 0 auto !important;      /* å±…ä¸­å¯¹é½ */
}

/* ç¡®ä¿åˆ—è¡¨é¡¹å†…å®¹ä¹Ÿèƒ½æ’‘å¼€ */
#icon-target-list .ios-list-item {
    width: 100% !important;
}

#icon-target-list .item-content {
    flex: 1;                        /* è®©å†…å®¹åŒºè‡ªåŠ¨å¡«æ»¡å‰©ä½™ç©ºé—´ */
    padding-right: 8px;            /* ç»™å³ä¾§ç®­å¤´ç•™ç‚¹å‘¼å¸æ„Ÿ */
}
/* å­è®¾ç½®è¡ŒåŸºç¡€å¸ƒå±€ */
.sub-setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #fff;
    border-bottom: 0.5px solid #F2F2F7;
    transition: background 0.2s;
}

.sub-setting-row:active { background: #F2F2F7; }

.sub-item-left { display: flex; align-items: center; gap: 8px; }

/* ğŸ•’ æ ¸å¿ƒæ’ç‰ˆçªå‡ºï¼šæ—¶é—´æ„ŸçŸ¥æ ‡è®° */
.time-sense-tag {
    font-size: 10px;
    font-weight: 800;
    padding: 2px 6px;
    border-radius: 4px;
    border-left: 3px solid #007AFF; 
    transition: all 0.5s ease;
    position: relative;
    overflow: hidden;
}

/* ğŸ’¡ å®æ—¶æ„ŸçŸ¥çš„ç‰©ç†æ ‡è®°ï¼šå‘¼å¸é—ªçƒçš„å°ç‚¹ */
.time-sense-tag::after {
    content: '';
    position: absolute;
    top: 2px;
    right: 2px;
    width: 3px;
    height: 3px;
    background: currentColor;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}
/* =========================================================
   ğŸš¨ æ„ŸçŸ¥ä¸­å¿ƒï¼šç‰©ç†æ‹‰ä¼¸è¡¥ä¸ (è§£å†³ä¸¤è¾¹ç•™ç™½ã€æŒ‰é’®å¯¹é½é—®é¢˜)
   ========================================================= */

/* 1. å®¹å™¨å¼ºåˆ¶é“ºæ»¡ */
#subpage-weather-perceive {
    width: 100% !important;
    max-width: none !important;
    left: 0 !important;
}

/* 2. ä¸»ä½“åŒºåŸŸæ‹‰ä¼¸ */
#subpage-weather-perceive .app-body {
    display: block !important; /* ç‰©ç†å–æ¶ˆ Flex å±…ä¸­ */
    width: 100% !important;
    padding: 20px 16px 120px 16px !important; /* å·¦å³ç•™ 16px æ ‡å‡†è¾¹è· */
    box-sizing: border-box !important;
}

/* 3. åè®®å¼€å…³è¡Œé‡å¡‘ï¼šå·¦å­—å³é’®ï¼Œæ¨ªè·¨å…¨å± */
#subpage-weather-perceive .ios-list-group {
    width: 100% !important;
    background: #fff !important;
    border-radius: 14px !important;
    margin: 10px 0 25px 0 !important;
    overflow: hidden;
    display: block !important;
}

#subpage-weather-perceive .ios-list-item {
    width: 100% !important;
    padding: 0 16px !important;
    height: 54px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important; /* æ ¸å¿ƒï¼šæ–‡å­—å·¦ï¼Œå¼€å…³å³ */
    box-sizing: border-box !important;
}

/* 4. æŒ‰é’®ç»„é‡ç»˜ï¼šä¸å†æ˜¯ä¸¤ä¸ªæŒ¤åœ¨ä¸€èµ·çš„å°æ–¹å— */
.sense-action-area {
    display: flex !important;
    gap: 12px !important;
    width: 100% !important;
    margin-bottom: 30px !important;
}

/* ç«‹åˆ»æ•è·æŒ‰é’®ï¼šä¸»è‰²è°ƒï¼Œå æ®å¤§éƒ¨åˆ†ç©ºé—´ */
.sense-btn-main {
    flex: 2 !important;
    height: 50px !important;
    background: #1d1d1f !important;
    color: #fff !important;
    border-radius: 14px !important;
    font-weight: 700 !important;
    font-size: 15px !important;
    border: none !important;
}

/* è‡ªåŠ¨é¢‘ç‡æŒ‰é’®ï¼šè¾…åŠ©è‰²è°ƒ */
.sense-btn-sub {
    flex: 1 !important;
    height: 50px !important;
    background: #fff !important;
    color: #007AFF !important;
    border-radius: 14px !important;
    font-weight: 600 !important;
    font-size: 14px !important;
    border: 0.5px solid rgba(0,0,0,0.05) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03) !important;
}

/* 5. æ—¶é—´è½´å¡ç‰‡å…¨å®½ */
#sense-timeline-container {
    width: 100% !important;
}

.sense-card {
    width: 100% !important;
    margin-bottom: 20px !important;
}
/* =========================================================
   âœ¨ æ„ŸçŸ¥ä¸­å¿ƒï¼šç”Ÿæˆè¿‡ç¨‹åŠ¨ç”»è¡¥ä¸
   ========================================================= */

/* å®šä¹‰è„‰å†²åŠ¨ç”»å…³é”®å¸§ï¼šåƒé›·è¾¾æ³¢ä¸€æ ·å‘å¤–æ‰©æ•£ */
@keyframes sensingPulseRipple {
    0% {
        box-shadow: 0 0 0 0 rgba(29, 29, 31, 0.5);
    }
    70% {
        box-shadow: 0 0 0 15px rgba(29, 29, 31, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(29, 29, 31, 0);
    }
}

/* æŒ‰é’®æ¿€æ´»çŠ¶æ€ï¼šåº”ç”¨åŠ¨ç”»ï¼Œå˜è‰²ï¼Œç¦ç”¨é¼ æ ‡ */
.sense-btn-main.sensing-active {
    background-color: #3a3a3c !important; /* ç¨å¾®å˜æµ…ä¸€ç‚¹è¡¨ç¤ºå¿™ç¢Œ */
    color: rgba(255,255,255,0.8) !important;
    cursor: not-allowed !important;
    /* åº”ç”¨ä¸Šé¢çš„è„‰å†²åŠ¨ç”»ï¼Œ1.5ç§’å¾ªç¯ä¸€æ¬¡ */
    animation: sensingPulseRipple 1.5s infinite cubic-bezier(0.66, 0, 0.86, 1);
    transition: all 0.3s ease;
}
/* =========================================================
   ğŸï¸ æç®€æ—¶é—´è½´å¸ƒå±€ (ç‚¹ã€çº¿ã€å¹´æœˆæ—¥)
   ========================================================= */

/* 1. æ—¶é—´è½´å¤–å£³ï¼šå·¦è¾¹ç•™å‡º 25px ç»™çº¿å’Œç‚¹ */
#sense-timeline-container {
    position: relative;
    padding-left: 25px; 
    margin-top: 20px;
}

/* 2. å‚ç›´è½´çº¿ï¼šç”¨ä¼ªå…ƒç´ ç”»ä¸€æ¡ç»†çº¿ */
#sense-timeline-container::before {
    content: '';
    position: absolute;
    left: 5px; top: 10px; bottom: 0;
    width: 1px;
    background: #e5e5ea; /* æ·¡æ·¡çš„ç°è‰²çº¿æ¡ */
    z-index: 0;
}

.timeline-item {
    position: relative;
    margin-bottom: 35px; /* æ¯ä¸ªé¡¹ä¹‹é—´çš„é—´è· */
}

/* 1. å¹´æœˆæ—¥æ ‡é¢˜å¾®è°ƒ */
.timeline-date-label {
    position: relative;
    font-size: 13px;
    font-weight: 800;
    color: #8e8e93;
    margin-bottom: 15px;
    margin-left: -5px; /* å‘å·¦æŒªä¸€ç‚¹ï¼Œé¿å¼€ç«–çº¿ */
    background: #F2F2F7; /* ğŸš¨ è¿™é‡Œçš„èƒŒæ™¯è‰²è¦å’Œé¡µé¢åº•è‰²ä¸€è‡´ï¼Œç›–ä½åé¢çš„ç«–çº¿ */
    padding: 2px 5px;
    display: inline-block;
    z-index: 1;
}

/* 2. ç‚¹çš„ä½ç½®å¾®è°ƒ */
.timeline-dot {
    position: absolute;
    left: -24px; 
    top: 22px; /* ğŸš¨ å› ä¸ºæ²¡æœ‰æ ‡é¢˜æŒ¡ç€äº†ï¼ŒæŠŠç‚¹å¾€ä¸‹æŒªä¸€ç‚¹ç‚¹ï¼Œæ­£å¯¹ç€å¡ç‰‡çš„ä¸ŠåŠéƒ¨ */
    width: 9px; height: 9px;
    background: #1d1d1f; 
    border-radius: 50%;
    border: 2.5px solid #F2F2F7; 
    z-index: 2;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px; /* ç¼©çŸ­å¡ç‰‡ä¹‹é—´çš„å‚ç›´é—´è· */
}

/* =========================================================
   ğŸï¸ æ„ŸçŸ¥å¡ç‰‡ï¼šå¸ƒå±€é¿è®©ä¸é»‘æ¡ç¾åŒ–
   ========================================================= */

.summary-card {
    position: relative; /* å¿…é¡»æ˜¯ relativeï¼Œæ–¹ä¾¿å­å…ƒç´ å®šä½ */
    background: #fff;
    border-radius: 20px;
    padding: 18px;
    padding-bottom: 35px; /* ğŸš¨ åº•éƒ¨ç•™ç™½ï¼Œç»™æ—¶é—´æˆ³è…¾ä½ç½® */
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    overflow: hidden; /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢é»‘æ¡æ–œå‡ºå»æŒ¡ä½å¤–é¢ */
    border: 1px solid rgba(0,0,0,0.03);
}

/* é»‘è‰²æ–œè§’æ¡ç¾åŒ– */
.summary-card::before {
    content: "CORE MEMORY";
    position: absolute;
    top: 6px; 
    right: -32px; /* ç‰©ç†åç§»ï¼Œç¡®ä¿æ–œåº¦å®Œç¾ */
    width: 120px; /* ğŸš¨ é”å®šå®½åº¦ï¼Œè§£å†³å­—åœ¨ä¸åœ¨é‡Œé¢çš„é—®é¢˜ */
    background: #000;
    color: #fff;
    font-size: 8px;
    font-weight: 900;
    line-height: 22px; /* å¢åŠ è¡Œé«˜ï¼Œè®©æ–‡å­—å‚ç›´å±…ä¸­ */
    text-align: center;
    transform: rotate(45deg); /* 45åº¦è§’ */
    z-index: 5;
    letter-spacing: 1px;
}

/* ğŸš¨ é’ˆå¯¹æ—¶é—´æˆ³çš„å…¨æ–°å®šä½ */
.sense-card-time {
    position: absolute;
    bottom: 12px;
    right: 15px;
    font-size: 10px;
    color: #ccc;
    font-family: monospace; /* ç”¨ç­‰å®½å­—ä½“æ›´æœ‰ç§‘æŠ€æ„Ÿ */
}
/* =========================================================
   ğŸï¸ æ„ŸçŸ¥å¡ç‰‡ï¼šé»‘æ¡æ–œè§’ä¿®å¤å®Œç¾ç‰ˆ
   ========================================================= */

/* ç¡®ä¿çˆ¶å®¹å™¨æœ‰è¿™ä¸€æ¡ï¼Œå¦åˆ™é»‘æ¡ä¼šé£å‡ºå» */
.summary-card {
    /* ...ä½ åŸæœ‰çš„å…¶ä»–æ ·å¼... */
    overflow: hidden !important; /* ğŸš¨ æ ¸å¿ƒï¼šå¿…é¡»æœ‰è¿™ä¸ªï¼ŒæŠŠè¶…å‡ºçš„éƒ¨åˆ†åˆ‡æ‰ */
    position: relative; /* ç¡®ä¿æ˜¯å®šä½åŸºå‡† */
}

/* é»‘è‰²æ–œè§’æ¡ - é‡æ–°å®šä¹‰ */
.summary-card::before {
    content: "CORE MEMORY";
    position: absolute;
    /* ğŸš¨ å…³é”®å®šä½ç»„åˆï¼šç»è¿‡è®¡ç®—çš„é»„é‡‘æ¯”ä¾‹ */
    top: 18px;      /* è·ç¦»é¡¶éƒ¨çš„å‚ç›´è·ç¦» */
    right: -48px;   /* å‘å³è´Ÿå‘åç§»ï¼Œè®©å®ƒæŒ‚åœ¨è§’ä¸Š */
    
    /* é”å®šå®½åº¦ï¼Œç¡®ä¿è¶³å¤Ÿå®¹çº³æ–‡å­— */
    width: 140px;
    
    /* æ—‹è½¬ 45 åº¦ */
    transform: rotate(45deg);
    /* è®¾å®šæ—‹è½¬åŸºç‚¹ä¸ºä¸­å¿ƒï¼Œé˜²æ­¢è·‘å */
    transform-origin: center;

    /* æ ·å¼ç¾åŒ– */
    background: #1d1d1f; /* ç”¨æ·±ç°è‰²æ›´æœ‰è´¨æ„Ÿï¼Œæˆ–è€…ä½ ç»§ç»­ç”¨ #000 */
    color: #fff;
    text-align: center; /* æ–‡å­—æ°´å¹³å±…ä¸­ */
    font-size: 9px;     /* å­—ä½“å¤§å° */
    font-weight: 800;   /* å­—ä½“åŠ ç²— */
    
    /* ğŸš¨ ç”¨ padding æ¥æ§åˆ¶æ¡å­çš„åšåº¦ï¼Œæ¯” line-height æ›´ç¨³å®š */
    padding: 5px 0;     
    line-height: 1;     /* é‡ç½®è¡Œé«˜ */
    
    letter-spacing: 0.5px; /* å­—é—´è·ç¨å¾®ç´§ä¸€ç‚¹ */
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* åŠ ä¸€ç‚¹ç‚¹é˜´å½±å¢åŠ ç«‹ä½“æ„Ÿ */
}
/* --- ğŸ—ºï¸ åœ°åŒºæ„ŸçŸ¥å¡ç‰‡é«˜çº§æ ·å¼ --- */
.region-mag-card {
    width: 100% !important;
    height: 280px;
    border-radius: 32px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    margin-bottom: 25px;
    cursor: pointer;
    /* ğŸš¨ è¿™é‡Œç»å¯¹ä¸è¦å†™ background-image: url(...) ğŸš¨ */
    background: #000; /* ç»™ä¸€ä¸ªé»˜è®¤é»‘è‰²å…œåº•å³å¯ */
}

.mag-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 30%, rgba(0,0,0,0.7) 100%);
}

.mag-content {
    position: absolute;
    bottom: 25px; left: 25px; right: 25px;
    color: #fff;
    z-index: 2;
}

.mag-city-name {
    font-size: 32px;
    font-weight: 900;
    letter-spacing: -1px;
    text-transform: uppercase;
}

.mag-divider {
    width: 40px; height: 3px;
    background: #007AFF;
    margin: 8px 0 12px 0;
}

.mag-vibe-text {
    font-size: 14px;
    line-height: 1.5;
    font-family: serif;
    font-style: italic;
    opacity: 0.9;
}

.mag-tag {
    position: absolute; top: -180px; right: 0;
    font-size: 9px; font-weight: 900; letter-spacing: 2px;
    padding: 4px 10px; background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px); border-radius: 20px;
}
/* --- ğŸ—ºï¸ åœ°åŒºå¡ç‰‡é¢œå€¼æ‹¯æ•‘ --- */
.region-mag-card {
    width: 100%; height: 280px; border-radius: 32px;
    background-color: #000; background-size: cover; background-position: center;
    position: relative; overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2); margin-bottom: 25px;
    cursor: pointer; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.region-mag-card:active { transform: scale(0.97); }

.mag-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(180deg, rgba(0,0,0,0) 20%, rgba(0,0,0,0.8) 100%);
}

.mag-content {
    position: absolute; bottom: 30px; left: 25px; right: 25px; color: #fff; z-index: 5;
}

.mag-tag-row { display: flex; align-items: center; gap: 10px; }
.mag-city-name { font-size: 36px; font-weight: 900; letter-spacing: -1.5px; text-transform: uppercase; }
.mag-status-dot { width: 8px; height: 8px; background: #34C759; border-radius: 50%; box-shadow: 0 0 10px #34C759; animation: pulse 2s infinite; }

.mag-divider { width: 30px; height: 4px; background: #007AFF; margin: 12px 0; border-radius: 2px; }

.mag-vibe-text {
    font-size: 16px; line-height: 1.6; font-family: serif; font-style: italic;
    color: rgba(255,255,255,0.95); margin-bottom: 15px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.mag-footer { display: flex; justify-content: space-between; font-size: 10px; font-weight: 800; letter-spacing: 1px; color: rgba(255,255,255,0.4); }

/* åŠ è½½å±‚ */
.vibe-loading-layer {
    position: absolute; inset: 0; background: rgba(0,0,0,0.4);
    backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 10;
}
/* =========================================================
   ğŸš¨ åœ°åŒºæ„ŸçŸ¥é¡µï¼šç‰©ç†æ‹‰ä¼¸ä¸é¢œå€¼é‡å¡‘
   ========================================================= */

/* 1. å®¹å™¨å¼ºåˆ¶é“ºæ»¡ï¼Œå–æ¶ˆå±…ä¸­å¯¹é½ */
#subpage-region-perceive .app-body {
    display: block !important; /* ğŸš¨ æ ¸å¿ƒï¼šå–æ¶ˆ flex å±…ä¸­ */
    width: 100% !important;
    padding: 20px 16px 120px 16px !important; /* æ ‡å‡† iOS ä¸¤ä¾§è¾¹è· */
    box-sizing: border-box !important;
}

.region-mag-card {
    width: 100% !important;
    height: 280px;
    border-radius: 32px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    margin-bottom: 25px;
    background: #1c1c1e; /* ğŸš¨ åªéœ€è¦ä¸€ä¸ªæ·±è‰²åº•è‰²ï¼Œä¸è¦ url() ğŸš¨ */
    cursor: pointer;
}

/* 3. åˆ—è¡¨ç»„é‡å¡‘ï¼šå…¨å®½ + åœ†è§’åŒ…è£¹ */
#subpage-region-perceive .ios-list-group {
    width: 100% !important;
    border-radius: 14px !important; /* å¢åŠ åœ†è§’ */
    overflow: hidden !important;    /* é˜²æ­¢å­å…ƒç´ æº¢å‡ºåœ†è§’ */
    margin-bottom: 30px !important;
    background: #fff !important;    /* ç¡®ä¿æœ‰èƒŒæ™¯è‰² */
}

#subpage-region-perceive .ios-list-item {
    padding-right: 16px !important; /* ç¡®ä¿å¼€å…³ä¸è´´è¾¹ */
}

/* 4. åŸå¸‚ç½‘æ ¼é‡å¡‘ï¼šä»â€œå‡ ä¸ªå­—â€å˜æˆâ€œæ¼‚äº®çš„æŒ‰é’®å—â€ */
.city-grid {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 12px !important;         /* å—ä¹‹é—´çš„é—´è· */
    width: 100% !important;
    margin-top: 15px !important;
    justify-content: flex-start !important; /* å·¦å¯¹é½ï¼Œè€Œä¸æ˜¯å±…ä¸­ */
}

.city-tag {
    /* è®©å®ƒçœ‹èµ·æ¥åƒä¸ªå¯ç‚¹å‡»çš„æŒ‰é’®å— */
    background: #fff !important;
    padding: 14px 20px !important;
    border-radius: 12px !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    color: #1d1d1f !important;
    text-align: center !important;
    
    /* è®©å®ƒä»¬è‡ªåŠ¨å¡«æ»¡ä¸€è¡Œï¼Œçœ‹èµ·æ¥æ›´æ•´é½ */
    flex: 1 0 calc(30% - 12px) !important; /* ä¸€è¡Œå¤§çº¦æ”¾3ä¸ªï¼Œè‡ªåŠ¨æ‹‰ä¼¸ */
    box-shadow: 0 4px 10px rgba(0,0,0,0.03) !important; /* åŠ ä¸€ç‚¹ç‚¹æŠ•å½± */
    transition: all 0.2s ease;
}

/* ç‚¹å‡»æ—¶çš„åé¦ˆæ•ˆæœ */
.city-tag:active {
    background: #f2f2f7 !important;
    transform: scale(0.98);
}

/* åˆ†ç»„æ ‡é¢˜å¾®è°ƒ */
.tz-group-title {
    padding-left: 5px !important; /* ç¨å¾®è·Ÿä¸‹é¢çš„å—å¯¹é½ */
    margin-bottom: 10px !important;
}
/* =========================================================
   ğŸš‘ åœ°åŒºæ„ŸçŸ¥é¡µï¼šåˆ—è¡¨è¡Œå¯¹é½å¼ºåˆ¶ä¿®æ­£
   ========================================================= */

/* 1. å¼ºåˆ¶åˆ—è¡¨é¡¹å·¦å³æ’‘æ»¡ */
#subpage-region-perceive .ios-list-item {
    display: flex !important;
    align-items: center !important;
    /* æ ¸å¿ƒï¼šæ–‡å­—åœ¨å·¦ï¼Œå†…å®¹åœ¨å³ */
    justify-content: space-between !important; 
    
    /* ç‰©ç†è¾¹è·ï¼šå·¦è¾¹ç•™å‡º 16px çš„å‘¼å¸ç©ºé—´ */
    padding-left: 16px !important;
    padding-right: 16px !important;
    
    width: 100% !important;
    box-sizing: border-box !important;
}

/* 2. ç¡®ä¿æ ‡ç­¾æ–‡å­—æœ¬èº«ä¹Ÿæ˜¯é å·¦å¯¹é½ */
#subpage-region-perceive .item-label {
    text-align: left !important;
    flex: 1 !important; /* è®©æ–‡å­—å æ®å‰©ä½™ç©ºé—´ï¼ŒæŠŠå³è¾¹çš„ä¸œè¥¿æ¨è¿‡å» */
}

/* 3. ä¿®æ­£å³ä¾§å†…å®¹åŒºåŸŸ */
#subpage-region-perceive .item-right {
    display: flex !important;
    align-items: center !important;
    justify-content: flex-end !important;
    flex-shrink: 0 !important; /* é˜²æ­¢å³è¾¹å†…å®¹è¢«æŒ¤å‹ */
}
/* --- ğŸ’ åŒè¯­å¯¹ç…§æ°”æ³¡é«˜çº§æ ·å¼ --- */

/* ç¿»è¯‘æŠ˜å å®¹å™¨ */
.bubble-translation-box {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
    opacity: 0;
}

/* æ¿€æ´»æ˜¾ç¤ºè¯‘æ–‡ */
.bubble.show-trans .bubble-translation-box {
    max-height: 200px;
    opacity: 1;
    margin-top: 10px;
}

/* è£…é¥°åˆ†å‰²çº¿ */
.trans-line {
    width: 20px;
    height: 2px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 1px;
    margin-bottom: 8px;
}

.msg-row.user .trans-line { background: rgba(255, 255, 255, 0.3); }

/* è¯‘æ–‡æ–‡å­—æ ·å¼ */
.msg-text-trans {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.5;
    font-family: -apple-system, sans-serif;
    font-style: normal;
}

/* ç¿»è¯‘åˆ‡æ¢æŒ‰é’®ï¼šç‰©ç†éš”ç¦»ç‚¹å‡»çš„å…³é”® */
.trans-toggle-btn {
    position: absolute;
    bottom: -18px;
    right: 10px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    padding: 2px 8px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    color: #8E8E93;
    font-size: 10px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border: 0.5px solid rgba(0,0,0,0.05);
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s;
}

.trans-toggle-btn:active { transform: scale(0.9); background: #eee; }

/* å±•å¼€æ—¶çš„å›¾æ ‡æ—‹è½¬ */
.bubble.show-trans .trans-toggle-btn svg { transform: rotate(180deg); }
.bubble.show-trans .trans-toggle-btn { color: #007AFF; }
/* ç¡®ä¿æ°”æ³¡ä¸è£åˆ‡æ‰å¼¹å‡ºçš„ç¿»è¯‘æŒ‰é’® */
.bubble {
    position: relative;
    overflow: visible !important; /* å…è®¸æŒ‰é’®æ‚¬æµ®åœ¨å¤–é¢ */
}

/* å¼ºåˆ¶ç¿»è¯‘æŒ‰é’®å±‚çº§æœ€é«˜ */
.trans-toggle-btn {
    z-index: 100 !important;
    pointer-events: auto !important;
}
/* =========================================================
   ğŸŒ ç¿»è¯‘åŠŸèƒ½ï¼šç‰©ç†æ˜¾å½¢ä¸äº¤äº’ç¾åŒ–
   ========================================================= */

/* 1. æ°”æ³¡å®¹å™¨ï¼šå¿…é¡»å…è®¸å†…å®¹æº¢å‡ºï¼Œå¦åˆ™æŒ‰é’®ä¼šè¢«åˆ‡æ‰ */
.bubble {
    position: relative !important;
    overflow: visible !important; /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢åˆ‡æ‰æŒ‰é’® */
    padding-bottom: 12px !important; /* ç»™åº•éƒ¨ç•™å‡ºå‘¼å¸ç©ºé—´ */
}

/* 2. åŸæ–‡å†…å®¹ï¼šç¡®ä¿ä¸è¢«æŒ‰é’®é®æŒ¡ */
.msg-text-main {
    word-break: break-word;
    line-height: 1.6;
}

/* 3. ç¿»è¯‘æŠ˜å ç›’ï¼šä¸æ»‘æ»‘ä¸‹æ•ˆæœ */
.bubble-translation-box {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease, 
                margin 0.3s ease;
}

/* æ¿€æ´»æ€ï¼šæ˜¾ç¤ºç¿»è¯‘ */
.bubble.show-trans .bubble-translation-box {
    max-height: 500px;
    opacity: 1;
    margin-top: 12px;
    border-top: 0.5px solid rgba(0, 0, 0, 0.08); /* å¢åŠ åˆ†å‰²çº¿ */
    padding-top: 10px;
}

/* 4. è¯‘æ–‡æ–‡å­—æ ·å¼ */
.msg-text-trans {
    font-size: 13px;
    color: #8E8E93; /* iOS æ ‡å‡†å‰¯æ–‡æœ¬ç° */
    font-style: italic; /* æ–œä½“å¢åŠ ç”µå½±æ„Ÿ */
    line-height: 1.5;
}

/* 5. ğŸš¨ ç¿»è¯‘æŒ‰é’®ï¼šç‰©ç†å®šä½è¡¥ä¸ */
.trans-toggle-btn {
    position: absolute;
    bottom: -14px; /* ğŸš¨ ç‰©ç†åç§»ï¼Œè®©å®ƒè·¨åœ¨æ°”æ³¡è¾¹ç¼˜ */
    right: 12px;
    
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    
    padding: 2px 10px;
    border-radius: 10px;
    border: 0.5px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    
    display: flex;
    align-items: center;
    gap: 4px;
    
    color: #8E8E93;
    font-size: 10px;
    font-weight: 800;
    cursor: pointer;
    z-index: 100; /* ç¡®ä¿å®ƒåœ¨æœ€é¡¶å±‚ */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* æŒ‰é’®ç‚¹å‡»/å±•å¼€æ€ */
.trans-toggle-btn:active {
    transform: scale(0.92);
}

.bubble.show-trans .trans-toggle-btn {
    color: #007AFF; /* å±•å¼€åå˜è“ */
    background: #fff;
    bottom: -16px;
}

/* æ—‹è½¬å°ç®­å¤´ */
.trans-toggle-btn svg {
    transition: transform 0.3s ease;
}
.bubble.show-trans .trans-toggle-btn svg {
    transform: rotate(180deg);
}
/* æœç´¢æ¡†å†…çš„æ–‡å­—é¢œè‰²çº å */
#lang-search-in::placeholder {
    color: #8e8e93;
    font-weight: 400;
}

/* ç¡®ä¿åˆ—è¡¨åœ¨æœç´¢æ—¶é«˜åº¦ç¨³å®šï¼Œä¸è·³åŠ¨ */
#model-sheet-list {
    min-height: 200px;
    transition: all 0.3s ease;
}

/* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨ */
#model-sheet-list::-webkit-scrollbar {
    display: none;
}
/* --- ä¸»é¢˜å•†åº—ä¸“ç”¨æ ·å¼ --- */
.theme-preview-box {
    width: 100%; height: 200px; background: #fff; border-radius: 28px;
    margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    border: 6px solid #fff; overflow: hidden; position: relative;
}

.preview-chat-container { padding: 15px; transform: scale(0.9); transform-origin: top; }

.theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }

.theme-card {
    aspect-ratio: 1/1; border-radius: 16px; display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.theme-card:active { transform: scale(0.9); }

.code-editor-textarea {
    width: 100%; height: 160px; background: transparent; color: #34C759;
    border: none; padding: 15px; font-family: 'Courier New', monospace;
    font-size: 13px; line-height: 1.5; outline: none; resize: none;
}
.ui-simulator-box {
    width: 100%; height: 350px; background: #000; border-radius: 36px;
    padding: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); margin-bottom: 25px;
}
.sim-screen {
    width: 100%; height: 100%; background: #F2F2F7; border-radius: 28px;
    display: flex; flex-direction: column; overflow: hidden;
}
.sim-status-bar { height: 25px; display: flex; justify-content: space-between; padding: 5px 15px; font-size: 10px; font-weight: 700; }
.sim-header { height: 40px; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; border-bottom: 0.5px solid #eee; }
.sim-content { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.sim-bubble-opp, .sim-bubble-user { padding: 8px 12px; border-radius: 15px; font-size: 12px; max-width: 80%; }
.sim-bubble-opp { background: #fff; align-self: flex-start; }
.sim-bubble-user { background: #007AFF; color: #fff; align-self: flex-end; }
.sim-footer { height: 50px; background: #fff; border-top: 0.5px solid #eee; display: flex; align-items: center; padding: 0 10px; }
.sim-input { flex: 1; background: #f2f2f7; height: 30px; border-radius: 15px; display: flex; align-items: center; padding-left: 15px; color: #ccc; font-size: 11px; }

/* ä»£ç ç¼–è¾‘å™¨ä¸“ç”¨ */
.code-editor-textarea {
    width: 100%; height: 200px; background: transparent; color: #34C759;
    border: none; padding: 15px; font-family: 'Courier New', monospace;
    font-size: 13px; line-height: 1.5; outline: none; resize: none;
}
.ui-phone-container {
    width: 240px; /* å›ºå®šå®½åº¦ï¼Œæ¯”ä¾‹é”å®š */
    height: 426px; 
    margin: 0 auto 30px auto;
    background: #000;
    border-radius: 38px;
    padding: 10px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.2);
    position: relative;
    border: 3px solid #333;
}
/* æ¨¡æ‹Ÿåˆ˜æµ· */
.ui-phone-notches {
    position: absolute; top: 18px; left: 50%; transform: translateX(-50%);
    width: 60px; height: 18px; background: #000; border-radius: 10px; z-index: 10;
}
.ui-phone-screen {
    width: 100%; height: 100%; background: #F2F2F7; border-radius: 28px;
    overflow: hidden; position: relative;
}
.sim-wrapper { height: 100%; display: flex; flex-direction: column; }
.sim-status-bar { height: 35px; display: flex; justify-content: space-between; padding: 12px 15px 0; font-size: 9px; font-weight: 700; }
.sim-header { height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; border-bottom: 0.5px solid #ddd; font-size: 11px; font-weight: 600; }
.sim-chat-area { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
.sim-bubble-opp, .sim-bubble-user { padding: 8px 12px; border-radius: 16px; font-size: 11px; max-width: 85%; line-height: 1.4; }
.sim-bubble-opp { background: #fff; align-self: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.sim-bubble-user { background: #007AFF; color: #fff; align-self: flex-end; }
.sim-footer-bar { height: 50px; background: #fff; border-top: 0.5px solid #ddd; display: flex; align-items: center; padding: 0 8px; gap: 6px; }
.sim-input-box { flex: 1; background: #f2f2f7; height: 30px; border-radius: 15px; font-size: 10px; color: #bbb; line-height: 30px; padding-left: 12px; }
.sim-add, .sim-btn { color: #007AFF; font-weight: 700; font-size: 14px; }
.actual-mirror-layer {
    width: 375px; /* ç‰©ç†å®½åº¦é”å®š */
    height: 667px; /* ç‰©ç†é«˜åº¦é”å®š */
    display: flex;
    flex-direction: column;
    transform: scale(0.64); /* ç‰©ç†ç¼©æ”¾æ¯”ä¾‹ (240/375) */
    transform-origin: top left;
    background: #F2F2F7;
    position: absolute;
    top: 0; left: 0;
    pointer-events: none; /* é¢„è§ˆå±‚ç¦æ­¢ç‚¹å‡» */
}

/* ç¡®ä¿é¢„è§ˆé‡Œçš„ç»„ä»¶ä¸ä¼šå› ä¸ºåŸæœ¬çš„ absolute å®šä½è·‘å */
.actual-mirror-layer .chat-room-header,
.actual-mirror-layer .chat-room-footer {
    position: relative !important;
    left: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
}
/* ğŸš¨ ç‰©ç†é•œåƒç¼©æ”¾å¼•æ“ */
.actual-mirror-layer {
    width: 375px; /* æ ‡å‡†é€»è¾‘å®½åº¦ */
    height: 680px; /* è¶³å¤Ÿé•¿ï¼Œä¿è¯ Footer ä¸è¢«åˆ‡æ‰ */
    display: flex;
    flex-direction: column;
    /* è®¡ç®—ç¼©æ”¾ï¼š324 (å†…éƒ¨å®é™…å®½åº¦) / 375 = 0.864 */
    transform: scale(0.864); 
    transform-origin: top left;
    background: transparent; /* ç‰©ç†é€æ˜ */
    position: absolute;
    top: 0; left: 0;
    pointer-events: none;
}

/* ç¡®ä¿é¢„è§ˆé‡Œçš„æ‚¬æµ®åº•æ ä¸ä¼šè·‘å */
.actual-mirror-layer .chat-room-footer-wrapper {
    width: 100%;
    margin-top: auto;
}
/* ä¿®æ”¹åº•æ å®¹å™¨ */
.actual-mirror-layer .chat-room-footer {
    background: rgba(255, 255, 255, 0.95) !important; /* æé«˜ä¸é€æ˜åº¦ */
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1) !important; /* å‘ä¸ŠæŠ•å°„é˜´å½±ï¼Œå¢å¼ºç«‹ä½“æ„Ÿ */
    border: 1px solid rgba(255, 255, 255, 0.5) !important;
}
/* ä¿®æ”¹è¾“å…¥æ¡†æ–‡å­—å¯¹é½ */
.actual-mirror-layer .chat-room-input {
    display: flex !important;
    align-items: center !important; /* å‚ç›´å±…ä¸­æ ¸å¿ƒæŒ‡ä»¤ */
    height: 40px !important;       /* é”å®šé«˜åº¦ */
    line-height: 40px !important;  /* ç¡®ä¿è¡Œé«˜ä¸é«˜åº¦ä¸€è‡´ */
    padding: 0 15px !important;    /* å·¦å³ç•™ç™½ï¼Œä¸Šä¸‹è®¾ä¸º0 */
    background: rgba(0, 0, 0, 0.05) !important;
}
/* --- ğŸ’ èŠå¤©å¯¹é½æ ¸å¿ƒï¼šç‰©ç†é”æ­»åè®® --- */

/* 1. åŸºç¡€è¡Œå®¹å™¨ï¼šå¿…é¡»å æ»¡ 100% */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 16px 0 !important;
    padding: 0 5px !important; /* å·¦å³ç•™å‡º iOS æ ‡å‡†è¾¹è· */
    box-sizing: border-box !important;
    align-items: flex-end !important; /* å¤´åƒå¯¹é½æ°”æ³¡åº•éƒ¨ */
    position: relative !important;
}

/* 2. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ï¼šæ­£å¸¸æ’åˆ— */
.msg-row.opponent {
    flex-direction: row !important; 
    justify-content: flex-start !important;
}

/* 3. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ï¼šé•œåƒåè½¬ */
.msg-row.user {
    flex-direction: row-reverse !important; /* ğŸ’¡ æ ¸å¿ƒï¼šå¤´åƒè‡ªåŠ¨å»å³è¾¹ï¼Œæ°”æ³¡å»å·¦è¾¹ */
    justify-content: flex-start !important; /* ğŸ’¡ é…åˆ row-reverseï¼Œå†…å®¹ä¼šä»å³ä¾§å¼€å§‹æ’ */
}

/* 4. å¤´åƒæ ·å¼ï¼šç‰©ç†å°ºå¯¸é”å®š (ä¿®å¤äº†ä½ ä»£ç é‡Œçš„ 10000px é”™è¯¯) */
.chat-avatar-img {
    width: 38px !important;
    height: 38px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important; /* ç¦æ­¢æŒ¤å‹ */
    object-fit: cover !important;
    display: block !important;
}

/* 5. å¤´åƒä¸æ°”æ³¡çš„é—´è· */
.msg-row.opponent .chat-avatar-img { margin-right: 10px !important; }
.msg-row.user .chat-avatar-img { margin-left: 10px !important; }

/* 6. æ°”æ³¡å®½åº¦è‡ªé€‚åº” */
.bubble {
    max-width: 75% !important; /* é™åˆ¶å®½åº¦ï¼Œé˜²æ­¢å¤´åƒè¢«æŒ¤èµ° */
    position: relative !important;
    word-wrap: break-word !important;
}
/* --- ğŸ•°ï¸ æ—¶é—´æˆ³ä¸åˆ†éš”ç¬¦é«˜çº§æ ·å¼ --- */

/* 1. æ°”æ³¡ä¸‹æ–¹çš„è‹±æ–‡æ—¶é—´ */
.bubble-time {
    font-size: 10px;
    color: #A1A1A6;
    margin-top: 5px;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
    font-weight: 500;
    text-transform: uppercase; /* ç»Ÿä¸€å¤§å†™ AM/PM */
}

/* å†…å®¹åŒ…è£¹å™¨ï¼šç¡®ä¿æ°”æ³¡å’Œæ—¶é—´æˆ³å‚ç›´æ’åˆ— */
.msg-content-wrapper {
    display: flex;
    flex-direction: column;
    max-width: 75%;
    position: relative;
}

/* ç”¨æˆ·æ°”æ³¡ä¸‹çš„æ—¶é—´é å³å¯¹é½ */
.msg-row.user .msg-content-wrapper {
    align-items: flex-end;
}

/* å¯¹æ–¹æ°”æ³¡ä¸‹çš„æ—¶é—´é å·¦å¯¹é½ */
.msg-row.opponent .msg-content-wrapper {
    align-items: flex-start;
}

/* 2. ä¸­é—´çš„æ—¶é—´åˆ†éš”ç¬¦ï¼ˆå¼ºåŒ–ç‰ˆï¼‰ */
.chat-time-divider {
    text-align: center;
    font-size: 11px;
    font-weight: 700;
    color: #C7C7CC;
    letter-spacing: 0.5px;
    margin: 25px 0 15px 0;
    width: 100%;
    clear: both;
}
/* =========================================================
   ğŸ•°ï¸ èŠå¤©å®¤ç‰©ç†å±‚çº§é”æ­»è¡¥ä¸ (è§£å†³æ°”æ³¡å˜çŸ­ã€å¤´åƒé”™ä½)
   ========================================================= */

/* 1. åŸºç¡€è¡Œå®¹å™¨ï¼šå¿…é¡»å æ»¡å…¨å®½ */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 18px 0 !important;
    padding: 0 12px !important;
    box-sizing: border-box !important;
    align-items: flex-end !important;
    position: relative !important;
    background: transparent !important;
}

/* 2. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ï¼š[å¤´åƒ] + [åŒ…è£¹å™¨] */
.msg-row.opponent {
    flex-direction: row !important;
    justify-content: flex-start !important;
}

/* 3. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ï¼š[åŒ…è£¹å™¨] + [å¤´åƒ] */
.msg-row.user {
    flex-direction: row-reverse !important; /* ğŸ’¡ å…³é”®ï¼šé•œåƒç¿»è½¬å†…å®¹ */
    justify-content: flex-start !important; /* ğŸ’¡ é…åˆé•œåƒå®ç°é å³ */
}

/* 4. å¤´åƒï¼šç‰©ç†é”å®šï¼Œç¦æ­¢å˜å½¢ */
.chat-avatar-img {
    width: 38px !important;
    height: 38px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important; /* ğŸš¨ ç¦æ­¢è¢«æ°”æ³¡æŒ¤æ‰ */
    object-fit: cover !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: block !important;
    margin: 0 !important;
}
/* è®¾ç½®å¤´åƒé—´è· */
.msg-row.opponent .chat-avatar-img { margin-right: 10px !important; }
.msg-row.user .chat-avatar-img { margin-left: 10px !important; }

/* 5. æ ¸å¿ƒå†…å®¹åŒ…è£¹å™¨ï¼šç‰©ç†é”å®šæ°”æ³¡å®½åº¦ */
.msg-content-wrapper {
    display: flex !important;
    flex-direction: column !important;
    max-width: 72% !important; /* ğŸ‘ˆ æ°”æ³¡æœ€å®½åªå å±å¹• 72%ï¼Œç»™å¤´åƒç•™ç©ºé—´ */
    flex-shrink: 1 !important;
}

/* è°ƒæ•´åŒ…è£¹å™¨å†…éƒ¨å¯¹é½ */
.msg-row.opponent .msg-content-wrapper { align-items: flex-start !important; }
.msg-row.user .msg-content-wrapper { align-items: flex-end !important; }

/* 6. æ°”æ³¡æœ¬ä½“ï¼šè§£å†³â€œå˜çŸ­â€é—®é¢˜çš„æ ¸å¿ƒ */
.bubble {
    width: fit-content !important; /* ğŸ‘ˆ å…³é”®ï¼šæ°”æ³¡å®½åº¦éšæ–‡å­—å†…å®¹èµ°ï¼Œä¸è¢«å¼ºåˆ¶å‹ç¼© */
    max-width: 100% !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    white-space: normal !important; /* ç¡®ä¿é•¿æ–‡å­—è‡ªåŠ¨æ¢è¡Œ */
    position: relative !important;
    padding: 12px 16px !important;
    border-radius: 20px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}

/* 7. æ°”æ³¡ä¸‹æ–¹çš„è‹±æ–‡æ—¶é—´æˆ³ */
.bubble-time {
    font-size: 10px;
    color: rgba(142, 142, 147, 0.8);
    margin-top: 5px;
    font-family: -apple-system, sans-serif;
    font-weight: 600;
    text-transform: uppercase;
}

/* 8. ä¸­é—´çš„æ—¶é—´åˆ†éš”ç¬¦ */
.chat-time-divider {
    width: 100% !important;
    text-align: center !important;
    font-size: 11px !important;
    font-weight: 800 !important;
    color: #C7C7CC !important;
    margin: 30px 0 15px 0 !important;
    letter-spacing: 0.5px !important;
}
/* =========================================================
   ğŸš€ ç‰©ç†æ‹‰ä¼¸è¡¥ä¸ï¼šæ¶ˆé™¤ä¸¤ä¾§ç©ºéš™ï¼Œè®©å¤´åƒå’Œæ°”æ³¡è´´è¿‘è¾¹ç¼˜
   ========================================================= */

/* 1. å¼ºåˆ¶æ»šåŠ¨å®¹å™¨ä¸é¢„ç•™è¿‡å¤§çš„ padding */
#chat-messages-container {
    padding: 10px 0 !important; /* ä¸Šä¸‹ç•™ç©ºï¼Œå·¦å³å½’é›¶ */
    width: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    box-sizing: border-box !important;
}

/* 2. æ¶ˆæ¯è¡Œï¼šå æ»¡å…¨å®½ */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 12px 0 !important;
    /* ğŸš¨ å…³é”®ï¼šå·¦å³åªç•™ 8px çš„ç‰©ç†å‘¼å¸æ„Ÿï¼Œè®©å¤´åƒè´´è¾¹ */
    padding: 0 8px !important; 
    box-sizing: border-box !important;
    align-items: flex-end !important;
    position: relative !important;
}

/* 3. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§é è¾¹ï¼‰ */
.msg-row.opponent {
    flex-direction: row !important;
    justify-content: flex-start !important;
}

/* 4. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§é è¾¹ï¼‰ */
.msg-row.user {
    flex-direction: row-reverse !important; /* å¤´åƒåœ¨å³ï¼Œæ°”æ³¡åœ¨å·¦ */
    /* ğŸš¨ å…³é”®ï¼šåœ¨é•œåƒæ¨¡å¼ä¸‹ï¼Œflex-start å®é™…ä¸Šå°±æ˜¯è§†è§‰ä¸Šçš„æœ€å³ä¾§ */
    justify-content: flex-start !important; 
}

/* 5. å¤´åƒç‰©ç†å°ºå¯¸ä¸è´´è¾¹å¾®è°ƒ */
.chat-avatar-img {
    width: 42px !important;
    height: 42px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important;
    object-fit: cover !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* è°ƒæ•´å¤´åƒä¸æ°”æ³¡åŒ…è£¹å™¨çš„â€œç´§å‡‘æ„Ÿâ€ */
.msg-row.opponent .chat-avatar-img {
    margin-right: 8px !important; /* æ°”æ³¡è´´è¿‘å·¦ä¾§å¤´åƒ */
}

.msg-row.user .chat-avatar-img {
    margin-left: 8px !important;  /* æ°”æ³¡è´´è¿‘å³ä¾§å¤´åƒ */
}

/* 6. å†…å®¹åŒ…è£¹å™¨ï¼šæœ€å¤§å®½åº¦æ”¾å®½ï¼Œå…è®¸é•¿å¥å±•ç¤º */
.msg-content-wrapper {
    display: flex !important;
    flex-direction: column !important;
    /* ğŸš¨ å…³é”®ï¼šé™åˆ¶æœ€å¤§å®½åº¦ä¸º 78%ï¼Œç»™å¦ä¸€ä¾§ç•™å‡ºè¶³å¤Ÿçš„ç©ºç™½ï¼Œé˜²æ­¢æ°”æ³¡å æ»¡æ•´è¡Œ */
    max-width: 78% !important; 
}

/* 7. æ°”æ³¡æœ¬ä½“ï¼šè‡ªé€‚åº”å®½åº¦ */
.bubble {
    width: fit-content !important;
    min-width: 30px !important;
    max-width: 100% !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    padding: 12px 14px !important;
    border-radius: 18px !important;
}

/* 8. ä¿®æ­£åˆ†éš”ç¬¦ï¼ˆTODAYç­‰ï¼‰å±…ä¸­ */
.chat-time-divider {
    width: 100% !important;
    margin: 20px 0 !important;
    text-align: center !important;
    color: rgba(255,255,255,0.6) !important; /* é…åˆä½ æš—è‰²èƒŒæ™¯çš„æ–‡å­—é¢œè‰² */
}
/* =========================================================
   ğŸ” é¡¶ç«¯å¯¹é½è¡¥ä¸ï¼šè®©å¤´åƒä¸æ°”æ³¡é¦–è¡Œå®Œç¾å¹³é½
   ========================================================= */

/* 1. æ ¸å¿ƒå®¹å™¨ï¼šæ”¹ä¸ºé¡¶éƒ¨å¯¹é½ */
.msg-row {
    display: flex !important;
    width: 100% !important;
    margin: 12px 0 !important;
    padding: 0 8px !important;
    box-sizing: border-box !important;
    /* ğŸš¨ å…³é”®ä¿®æ”¹ï¼šä» flex-end æ”¹ä¸º flex-start */
    align-items: flex-start !important; 
    position: relative !important;
}

/* 2. å¤´åƒä½ç½®å¾®è°ƒï¼šä¸ºäº†å¯¹é½æ°”æ³¡é¡¶ç«¯ï¼Œé€šå¸¸éœ€è¦å‘ä¸‹åä¸ª 2-4px è§†è§‰æ‰æœ€å‡† */
.chat-avatar-img {
    width: 42px !important;
    height: 42px !important;
    border-radius: 50% !important;
    flex-shrink: 0 !important;
    object-fit: cover !important;
    /* ğŸš¨ ç»†èŠ‚ï¼šç¨å¾®ä¸‹ç§»ä¸€ç‚¹ï¼Œç¡®ä¿åœ†å¼§é¡¶éƒ¨å’Œæ°”æ³¡å¹³é½ */
    margin-top: 2px !important; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* 3. å¯¹æ–¹æ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ï¼šå¤´åƒåœ¨å·¦ï¼Œå†…å®¹åœ¨å³ */
.msg-row.opponent {
    flex-direction: row !important;
    justify-content: flex-start !important;
}

/* 4. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ï¼šå†…å®¹åœ¨å·¦ï¼Œå¤´åƒåœ¨å³ */
.msg-row.user {
    flex-direction: row-reverse !important;
    justify-content: flex-start !important;
}

/* 5. å†…å®¹åŒ…è£¹å™¨ï¼šç¡®ä¿æ°”æ³¡å’Œæ—¶é—´æˆ³ä¾ç„¶å‚ç›´æ’åˆ— */
.msg-content-wrapper {
    display: flex !important;
    flex-direction: column !important;
    max-width: 78% !important;
    /* ğŸš¨ è¿™é‡Œçš„ flex-start ä¿è¯æ°”æ³¡é¡¶ç€è¡Œå®¹å™¨ä¸Šæ–¹ */
    justify-content: flex-start !important; 
}

/* 6. è°ƒæ•´é—´è· */
.msg-row.opponent .msg-content-wrapper {
    margin-left: 8px !important;
    align-items: flex-start !important;
}

.msg-row.user .msg-content-wrapper {
    margin-right: 8px !important;
    align-items: flex-end !important;
}

/* 7. æ°”æ³¡æœ¬ä½“ï¼šä¿æŒè‡ªé€‚åº” */
.bubble {
    width: fit-content !important;
    max-width: 100% !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    padding: 12px 14px !important;
    border-radius: 18px !important;
    /* å¼ºåˆ¶å»æ‰å¯èƒ½å½±å“é«˜åº¦çš„æ—§ margin */
    margin-top: 0 !important; 
}

/* 8. æ°”æ³¡æ—¶é—´æˆ³ï¼šä¾ç„¶ç•™åœ¨æ°”æ³¡ä¸‹æ–¹ */
.bubble-time {
    font-size: 10px;
    color: rgba(142, 142, 147, 0.7);
    margin-top: 5px;
    font-family: -apple-system, sans-serif;
}
/* =========================================================
   ç´§å‡‘å¯¹é½è¡¥ä¸ï¼šç¼©å°é—´è· + é¡¶ç«¯ç‰©ç†å¹³é½
   ========================================================= */

/* 1. è°ƒæ•´æ•´è¡Œçš„å·¦å³ç•™ç™½ï¼Œè®©å¤´åƒæ›´è´´è¾¹ */
.msg-row {
    padding: 0 10px !important; /* å·¦å³ä¿ç•™ 10px çš„æ ‡å‡†å‘¼å¸æ„Ÿ */
    align-items: flex-start !important; /* ç¡®ä¿é¡¶ç«¯å¯¹é½ */
    margin: 10px 0 !important; /* ç¨å¾®ç¼©å°è¡Œä¸è¡Œçš„å‚ç›´é—´è· */
}

/* 2. æ ¸å¿ƒï¼šå¤§å¹…ç¼©å°å¤´åƒä¸æ°”æ³¡ä¹‹é—´çš„æ¨ªå‘ç©ºéš™ */
.msg-row.opponent .chat-avatar-img {
    margin-right: 6px !important; /* ğŸ‘ˆ ä» 12px ç¼©å‡åˆ° 6pxï¼Œç´§å‡‘æ„Ÿç«‹ç° */
}

.msg-row.user .chat-avatar-img {
    margin-left: 6px !important;  /* ğŸ‘ˆ ä» 12px ç¼©å‡åˆ° 6px */
}

/* 3. å¤´åƒé«˜åº¦å¾®è°ƒï¼šè§£å†³â€œä¸åœ¨ä¸€ä¸ªé«˜åº¦â€çš„è§†è§‰è¯¯å·® */
.chat-avatar-img {
    width: 40px !important;
    height: 40px !important;
    /* ğŸš¨ å…³é”®ï¼šå¦‚æœä½ çš„æ°”æ³¡æœ‰è¾¹æ¡†æˆ–æŠ•å½±ï¼Œè¿™é‡Œè®¾ä¸º 0px è§†è§‰ä¸Šæœ€å¹³é½ */
    margin-top: 0px !important; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* 4. æ°”æ³¡å®¹å™¨ï¼šç¡®ä¿å†…éƒ¨æ²¡æœ‰å¤šä½™çš„ margin å¹²æ‰°é«˜åº¦ */
.msg-content-wrapper {
    margin-top: 0 !important;
}

.bubble {
    /* è°ƒæ•´æ°”æ³¡åœ†è§’ï¼Œè®©é¡¶ç«¯å¯¹é½æ—¶çœ‹èµ·æ¥æ›´è‡ªç„¶ */
    border-radius: 16px !important;
    padding: 10px 14px !important; /* ç¨å¾®å‹ç¼©ä¸€ç‚¹æ°”æ³¡å†…è¾¹è·ï¼Œæ›´å¹²ç»ƒ */
}

/* 1. å®¿å‘½é¡µå®¹å™¨ï¼šé»˜è®¤ç‰©ç†éšè— */
.destiny-stage-ins {
    position: fixed !important;
    inset: 0 !important;
    display: none; /* ğŸš¨ è¿™é‡Œåˆ æ‰ flex !importantï¼Œé»˜è®¤ä¸æ˜¾ç¤º */
    flex-direction: column !important;
    height: 100vh !important;
    overflow: hidden !important;
    background: #000 !important;
    z-index: 999999;
}

/* 2. åªæœ‰åœ¨ active çŠ¶æ€ä¸‹æ‰æ˜¾å½¢ */
.destiny-stage-ins.active {
    display: flex !important;
}

/* 2. å‹ç¼©å¤´éƒ¨é«˜åº¦ï¼Œè§£å†³ä¸­é—´ç©ºç™½è¿‡å¤§çš„é—®é¢˜ */
.ins-art-header {
    flex-shrink: 0 !important;
    width: 100% !important;
    height: 50vh !important; /* ä» 45vh ç¼©å°åˆ° 38vhï¼Œå†…å®¹è‡ªç„¶å°±å¾€ä¸Šæäº† */
    position: relative !important;
    z-index: 10;
}

/* ğŸš¨ æ ¸å¿ƒæº¶å›¾ï¼šç…§ç‰‡åƒçƒŸé›¾ä¸€æ ·æ¶ˆæ•£ */
.header-hero-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center 20%;
    /* ç‰©ç†æº¶å›¾é®ç½©ï¼šé¡¶éƒ¨å’Œä¸¤ä¾§ç¨å¾®æš—åŒ–ï¼Œåº•éƒ¨å®Œå…¨é€æ˜æ¶ˆå¤± */
    -webkit-mask-image: linear-gradient(to bottom, 
        rgba(0,0,0,1) 0%, 
        rgba(0,0,0,1) 60%, 
        rgba(0,0,0,0) 100%);
    mask-image: linear-gradient(to bottom, 
        rgba(0,0,0,1) 0%, 
        rgba(0,0,0,1) 60%, 
        rgba(0,0,0,0) 100%);
    filter: brightness(0.7) contrast(1.1);
    z-index: 1;
}

/* å†…å®¹å®¹å™¨ */
.header-main-content {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 0 25px 30px 25px;
    z-index: 5;
}

/* å®¿å‘½æ ‡ç­¾ */
.fate-status-tag {
    font-size: 10px;
    font-weight: 900;
    letter-spacing: 3px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    margin-bottom: 8px;
}

/* 1. ç¼©å°æ˜µç§°å­—å·å¹¶å¾€ä¸‹ç§» */
#sync-char-name {
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 2.2rem !important; /* ä» 3.8 è°ƒå°åˆ° 2.2 */
    font-weight: 300 !important;
    font-style: italic !important;
    color: #ffffff !important;
    text-shadow: 0 0 15px rgba(255, 255, 255, 0.2), 0 5px 15px rgba(0, 0, 0, 0.5) !important;
    margin: 25px 0 10px 0 !important; /* å¢åŠ é¡¶éƒ¨ margin (25px) è®©å®ƒå¾€ä¸‹ç§» */
}

/* ğŸš¨ æ ¸å¿ƒï¼šå¤šç»´æ„ŸçŸ¥ç½‘æ ¼ (å®šä½ã€å¤©æ°”ã€å¤©æ•°) */
.perception-grid {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px 0;
    border-top: 0.5px solid rgba(255,255,255,0.1);
    border-bottom: 0.5px solid rgba(255,255,255,0.1);
}

.p-item { display: flex; flex-direction: column; gap: 4px; }
.p-label { font-size: 9px; color: rgba(255,255,255,0.3); font-weight: 800; text-transform: uppercase; }
.p-value { font-size: 13px; color: #fff; font-weight: 500; letter-spacing: 0.5px; }

/* è¿›åº¦æ¡ï¼šæµå…‰é“¶ä¸ */
.mini-progress-track {
    width: 100%;
    height: 1px;
    background: rgba(255,255,255,0.1);
    margin-bottom: 25px;
    position: relative;
}

.progress-glow-line {
    height: 100%;
    background: #fff;
    box-shadow: 0 0 10px rgba(255,255,255,0.8);
}

/* æ•£æ–‡æ–‡æ¡ˆ */
.art-prose-quote {
    font-size: 16px;
    line-height: 1.8;
    color: rgba(255,255,255,0.9);
    font-style: italic;
    font-family: "Noto Serif SC", serif;
    max-width: 90%;
}
.ins-exit-btn {
    position: absolute;
    /* ğŸš¨ ç‰©ç†ä¸‹ç§»ï¼Œç¡®ä¿ä¸å’ŒçŠ¶æ€æ é‡å ï¼Œå»ºè®®è®¾ä¸º 70px */
    top: 70px !important; 
    right: 25px !important;
    
    /* ğŸš¨ å¢åŠ ç‚¹å‡»çƒ­åŒºï¼šç‰©ç†æ”¾å¤§æ„Ÿåº”èŒƒå›´ï¼Œå³ä¾¿ç‚¹åä¸€ç‚¹ä¹Ÿèƒ½è§¦å‘ */
    width: 60px !important;
    height: 60px !important;
    padding: 0 !important;
    
    /* ğŸš¨ å¼ºåŠ›ç½®é¡¶ */
    z-index: 1100000 !important; 
    
    /* ğŸš¨ å…è®¸ç©¿é€ï¼šç¡®ä¿å®ƒèƒ½æ¥æ”¶åˆ°ç‚¹å‡» */
    pointer-events: auto !important; 
    
    background: rgba(255, 255, 255, 0.1) !important; /* ä¸´æ—¶åŠ ä¸ªåº•è‰²ï¼Œæµ‹å‡†äº†å†åˆ  */
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* ğŸš¨ ç‰©ç†æ£€æŸ¥ï¼šç¡®ä¿å¤–å±‚å®¹å™¨æ²¡æœ‰æŠŠç‚¹å‡»äº‹ä»¶ç»™â€œåƒæ‰â€ */
.destiny-stage-ins {
    pointer-events: auto !important;
    z-index: 999999 !important;
}

/* è‰ºæœ¯äº¤å‰ç»†çº¿ */
.exit-cross-icon {
    width: 24px;
    height: 24px;
    position: relative;
    margin-bottom: 5px;
}

.exit-cross-icon::before, 
.exit-cross-icon::after {
    content: "";
    position: absolute;
    top: 50%; left: 0;
    width: 100%;
    height: 1px; /* æç»†çº¿ */
    background: #ffffff; /* çº¯ç™½çº¿ */
}

.exit-cross-icon::before { transform: rotate(45deg); }
.exit-cross-icon::after { transform: rotate(-45deg); }

/* æŒ‰é’®ä¸‹æ–¹çš„è£…é¥°æ–‡å­— */
.exit-label {
    font-family: 'Cormorant Garamond', serif; /* åŒæ­¥æ˜µç§°çš„é«˜çº§å­—ä½“ */
    font-size: 8px;
    font-weight: 300;
    color: rgba(255, 255, 255, 0.5); /* æ·¡æ·¡çš„åŠé€æ˜ç™½ */
    letter-spacing: 4px; /* æå®½é—´è· */
    text-transform: uppercase;
}

.ins-exit-btn:active {
    opacity: 0.4;
    transform: scale(0.9);
}
/* --- ğŸ•¹ï¸ å®¿å‘½åº•éƒ¨ï¼šå…ˆé”‹æç®€æ§åˆ¶å° --- */
.destiny-footer-console {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 30px 25px 50px 25px; /* ç•™å‡ºåº•éƒ¨å®‰å…¨åŒº */
    background: linear-gradient(to top, #000 80%, transparent 100%);
    display: flex;
    align-items: center;
    gap: 0; /* æŒ‰é’®ç‰©ç†ç›¸è¿ */
    z-index: 100;
}

/* æç®€è¾“å…¥æ¡†ï¼šå–æ¶ˆæ‰€æœ‰èƒŒæ™¯ï¼Œåªç•™åº•çº¿ */
.destiny-input-wrapper {
    flex: 1;
    position: relative;
    margin-right: 20px;
}

.destiny-main-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 0.5px solid rgba(255, 255, 255, 0.2); /* æç»†åº•çº¿ */
    padding: 12px 0;
    color: #fff;
    font-family: 'Cormorant Garamond', serif; /* åŒæ­¥é«˜çº§å­—ä½“ */
    font-size: 16px;
    letter-spacing: 1px;
    outline: none;
    transition: border-color 0.4s ease;
}

.destiny-main-input:focus {
    border-bottom-color: #fff; /* èšç„¦æ—¶åº•çº¿äº®èµ· */
}

.destiny-main-input::placeholder {
    color: rgba(255, 255, 255, 0.2);
    font-style: italic;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* --- ğŸ•¹ï¸ å®¿å‘½åº•éƒ¨ï¼šæ˜Ÿéœœæ‚¬æµ®æ§åˆ¶ä½“ (æœ€ç»ˆç‰ˆ) --- */

/* å®¹å™¨ï¼šå½»åº•å»çº¿åŒ–ï¼Œåªä¿ç•™ä½ç½®çº¦æŸ */
.destiny-control-group {
    display: flex;
    align-items: center;
    height: 44px;
    background: transparent;
    border: none;
    /* ğŸš¨ é‡ç‚¹ï¼šå’Œè¾“å…¥æ¡†æ‹‰å¼€è·ç¦»ï¼Œå¹¶è®©ä¸¤ä¸ªæŒ‰é’®ä¹‹é—´ä¹Ÿæœ‰å‘¼å¸æ„Ÿ */
    padding-left: 15px; 
    gap: 8px; 
    position: relative;
}

/* ğŸš¨ ç‰©ç†åˆ é™¤ï¼šå½»åº•åˆ æ‰ä¹‹å‰é‚£ä¸ªå‚ç›´åˆ†å‰²çº¿ */
/* .destiny-control-group::after { content: none; } */ 

/* æŒ‰é’®æœ¬ä½“ï¼šåœ†å½¢èƒ½é‡åœº */
.console-btn {
    width: 42px; /* ç¨å¾®ç¼©å°ä¸€ç‚¹ç‚¹ï¼Œæ›´ç²¾è‡´ */
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.02); /* æå¾®å¼±çš„åº•è‰²ï¼Œå¢åŠ å®ä½“æ„Ÿ */
    border: 0.5px solid rgba(255, 255, 255, 0.05); /* ä¼¼æœ‰ä¼¼æ— çš„æ™¶ä½“è¾¹ç¼˜ */
    color: rgba(255, 255, 255, 0.4); /* é»˜è®¤çŠ¶æ€å¾ˆæš—ï¼Œåƒç†„ç­çš„æ˜Ÿè¾° */
    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* ææ…¢é€Ÿå¥¢ååŠ¨æ•ˆ */
    border-radius: 50%;
    backdrop-filter: blur(2px); /* å¾®å¼±çš„ç£¨ç ‚ç»ç’ƒæ„Ÿ */
}

/* æ‚¬åœï¼šç‚¹äº®æ˜Ÿè¾° */
.console-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.15); /* æŸ”å’Œå…‰æ™•çˆ†å‘ */
    transform: translateY(-1px); /* è½»å¾®ä¸Šæµ® */
}

/* ç‚¹å‡»ï¼šèƒ½é‡åç¼© */
.console-btn:active {
    transform: scale(0.95) translateY(0);
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
}

/* ğŸš¨ æ ¸å¿ƒå›¾æ ‡æ ·å¼ï¼šæè‡´ç²¾ç»†çš„å‡ ä½•çº¿ç¨¿ */
.console-icon {
    width: 18px; /* å°ºå¯¸å…‹åˆ¶ï¼Œæ˜¾è´µ */
    height: 18px;
    stroke: currentColor;
    stroke-width: 0.8; /* ğŸš¨ æç»†ï¼åªæœ‰0.8pxï¼Œè¿™æ˜¯é«˜çº§æ„Ÿçš„å…³é”® */
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
}
/* --- âš™ï¸ å®¿å‘½é¡µé¢ï¼šé‡å­æ ¡å‡†å¼¹çª— (é«˜çº§ç‰ˆ) --- */
.destiny-settings-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(15px); /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
    z-index: 2000000; /* å¿…é¡»ç›–è¿‡æ‰€æœ‰å±‚çº§ */
    display: none;
    align-items: center;
    justify-content: center;
    animation: destinyFadeIn 0.4s ease;
}

.destiny-settings-card {
    width: 85%;
    max-width: 340px;
    background: rgba(15, 15, 15, 0.95);
    border: 0.5px solid rgba(255, 255, 255, 0.15); /* æç»†è¾¹æ¡† */
    padding: 30px 25px;
    position: relative;
    box-shadow: 0 40px 100px rgba(0,0,0,0.8);
}

.settings-title-serif {
    font-family: 'Cormorant Garamond', serif;
    font-size: 22px;
    font-weight: 300;
    color: #fff;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-align: center;
    margin-bottom: 25px;
}

.settings-group {
    margin-bottom: 20px;
}

.settings-label {
    font-size: 10px;
    font-weight: 800;
    color: rgba(255, 255, 255, 0.3);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
    display: block;
}

/* æç®€è¾“å…¥ç»„ä»¶ */
.settings-input-alt {
    width: 100%;
    background: rgba(255, 255, 255, 0.03);
    border: 0.5px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 12px;
    font-size: 14px;
    outline: none;
    font-family: inherit;
    transition: all 0.3s;
}

.settings-input-alt:focus {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.4);
}

/* ç‰©ç†ä¿å­˜æŒ‰é’® */
.settings-sync-btn {
    width: 100%;
    padding: 15px;
    background: #fff;
    color: #000;
    border: none;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 3px;
    text-transform: uppercase;
    cursor: pointer;
    margin-top: 10px;
    transition: transform 0.2s;
}

.settings-sync-btn:active { transform: scale(0.97); }

@keyframes destinyFadeIn { from { opacity: 0; } to { opacity: 1; } }

/* --- ğŸ“ ç”¨æˆ·ä»‹å…¥ï¼šç¥è°•/è§‚æµ‹èŠ‚ç‚¹ --- */
.destiny-user-node {
    margin: 30px 0 15px 0;
    padding-left: 15px;
    border-left: 1px solid rgba(255,255,255,0.15);
    animation: nodeRise 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

.node-label {
    font-size: 9px;
    color: rgba(255,255,255,0.25);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 6px;
    font-weight: 800;
}

.node-content {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px;
    color: #fff;
    font-style: italic;
    line-height: 1.5;
}

/* 1. ç‰©ç†å›ºå®šï¼šç¡®ä¿å¤´éƒ¨ç»å¯¹ä¸åŠ¨ */
.destiny-stage-ins {
    position: fixed !important;
    inset: 0 !important;
    display: none;
    flex-direction: column !important;
    height: 100vh !important;
    overflow: hidden !important;
    background: #000 !important;
    z-index: 999999;
}
.destiny-stage-ins.active { display: flex !important; }

/* 2. æ ¸å¿ƒæ»šåŠ¨åŒºï¼šæ‚å¿—çº§å‘¼å¸æ„Ÿ */
#destiny-story-flow {
    flex: 1 !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    padding: 2vh 20px 200px 20px !important; /* ç‰©ç†é¿å¼€é¡¶éƒ¨ */
    display: block !important;
}

/* --- ğŸ“œ å®¿å‘½ï¼šæ— ç•Œé•¿å·æ’ç‰ˆ --- */
.story-fold-card {
    /* å½»åº•å–æ¶ˆé«˜åº¦é™åˆ¶ï¼Œç¡®ä¿æ–‡å­— 100% å®Œæ•´æ˜¾ç¤º */
    height: auto !important;
    max-height: none !important;
    overflow: visible !important;
    mask-image: none !important;
    -webkit-mask-image: none !important;
    
    background: rgba(255, 255, 255, 0.03) !important;
    border-left: 2px solid rgba(175, 82, 222, 0.5) !important; /* ç´«è‰²ä¾§è¾¹ä¸çº¿ */
    margin: 0 0 50px 0 !important;
    padding: 30px 25px !important;
    position: relative;
    transition: transform 0.3s ease;
}

/* æ®µè½å‘¼å¸æ„Ÿæ’ç‰ˆ */
.card-prose-body {
    font-family: "Noto Serif SC", "PingFang SC", serif;
    font-size: 17px;
    line-height: 2.2; /* æå®½è¡Œé«˜ï¼Œé˜…è¯»ä¸ç´¯ */
    color: rgba(255, 255, 255, 0.9);
    text-align: justify;
    margin-top: 20px;
}

.card-prose-body p {
    margin-bottom: 25px !important;
    display: block !important;
}

/* é‡ç‚¹æ ‡è®°ï¼šé»‘åº•ç™½å­— */
.memory-highlight {
    background: #ffffff !important;
    color: #000000 !important;
    padding: 1px 6px;
    margin: 0 4px;
    border-radius: 2px;
    font-weight: 800;
}

/* ç»†èŠ‚æ ‡è®°ï¼šç´«è‰²ä¸‹åˆ’çº¿ */
.memory-focus {
    border-bottom: 2px solid #AF52DE;
    font-weight: 800;
    padding-bottom: 2px;
}

/* é¡¶éƒ¨ä¿¡æ¯ç¾åŒ– */
.card-meta-top {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: rgba(255, 255, 255, 0.2);
    font-weight: 800;
    letter-spacing: 2px;
}

/* åº•éƒ¨æŒ‰é’®åŒºï¼šå®Œç¾èå…¥ */
.card-actions {
    margin-top: 35px;
    padding-top: 20px;
    border-top: 0.5px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* ç‹¬ç«‹åˆ é™¤æŒ‰é’®ï¼šé¿å¼€æ­£æ–‡ */
.card-manager-btn {
    position: absolute;
    top: 25px;
    right: 20px;
    width: 30px;
    height: 30px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #888;
    font-size: 20px;
    cursor: pointer;
}
/* --- ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šå¼ºåˆ¶åŠ è½½åŠ¨ç”»æ˜¾å½¢ --- */

/* ä¸»çº¿ç”ŸæˆåŠ¨ç”» */
.quantum-loading-bar {
    width: 100%; 
    height: 2px; /* ç¨å¾®åŠ ç²—ä¸€ç‚¹ */
    background: linear-gradient(90deg, transparent, #AF52DE, #fff, #AF52DE, transparent);
    background-size: 200% 100%;
    animation: lineScan 1.5s linear infinite !important;
    position: relative;
    z-index: 100;
}

@keyframes lineScan {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* å°å‰§åœºä¸“ç”¨ç»†çº¿åŠ¨ç”» */
.weave-line {
    height: 1.5px !important;
    background: linear-gradient(90deg, #AF52DE, #fff, #AF52DE) !important;
    background-size: 200% 100%;
    animation: lineScan 1.2s linear infinite !important;
    box-shadow: 0 0 8px rgba(175, 82, 222, 0.6);
}

/* æ–‡å­—å‘¼å¸æ„Ÿ */
[style*="WEAVING"], [style*="SIDE THREAD"] {
    animation: textPulse 1.5s ease-in-out infinite;
}

@keyframes textPulse {
    0%, 100% { opacity: 0.4; filter: blur(1px); }
    50% { opacity: 1; filter: blur(0px); }
}
/* --- ğŸšï¸ å®¿å‘½æ ¡å‡†ï¼šä¸“ç”¨æ»‘åŠ¨æ¡ç¾åŒ– --- */
#modal-destiny-settings .settings-group input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px; /* è½¨é“æç»†åŒ–ï¼Œæ˜¾å¾—æ›´é«˜çº§ */
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    outline: none;
    margin: 20px 0;
    cursor: pointer;
    /* æ ¸å¿ƒï¼šé€šè¿‡å˜é‡æ§åˆ¶å·¦ä¾§å¡«è‰² */
    background-image: linear-gradient(#fff, #fff); /* æ”¹ä¸ºçº¯ç™½å¡«è‰²ï¼Œå‘¼åº”æŒ‰é’® */
    background-size: var(--percent, 0%) 100%;
    background-repeat: no-repeat;
}

/* è½¨é“åœ†å¤´ (iOSé£æ ¼) */
#modal-destiny-settings .settings-group input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 24px;
    width: 24px;
    border-radius: 50%;
    background: #ffffff;
    /* å¢åŠ ä¸€ä¸ªå¤–å‘å…‰ï¼Œæ¨¡æ‹Ÿèƒ½é‡çƒæ„Ÿ */
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 2px 5px rgba(0,0,0,0.5);
    cursor: pointer;
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#modal-destiny-settings .settings-group input[type="range"]:active::-webkit-slider-thumb {
    transform: scale(1.2); /* æŒ‰ä½æ—¶è½»å¾®æ”¾å¤§ */
}

/* å…¼å®¹ Firefox */
#modal-destiny-settings .settings-group input[type="range"]::-moz-range-thumb {
    height: 24px; width: 24px; background: #fff; border: none; border-radius: 50%;
}
/* é’ˆå¯¹â€œSTORY THREAD INITIALIZEDâ€é‚£ä¸ªæç¤ºå®¹å™¨ */
#destiny-story-flow > div:first-child {
    /* æŠŠ 120px æˆ–è€…ä¹‹å‰çš„æ•°å€¼ï¼Œç»Ÿä¸€å¼ºåˆ¶æ”¹ä¸º 10px */
    padding: 10px 0 30px 0 !important; 
    /* é¡ºä¾¿æŠŠè¿™ä¸€è¡Œä¹Ÿç¼©çª„ä¸€ç‚¹ï¼Œè®©ç¬¬ä¸€æ¡å†…å®¹è·Ÿå¾—æ›´ç´§ */
    margin-top: 0 !important;
}

/* ç¡®ä¿æ»šåŠ¨å®¹å™¨æœ¬èº«é¡¶éƒ¨çš„é¢„ç•™ç©ºé—´ä¸è¦å¤ªå¤§ */
#destiny-story-flow {
    /* å°†é¡¶éƒ¨çš„ 2vh æ”¹ä¸º 0ï¼Œè®©å†…å®¹ç›´æ¥è´´ç€å¤´éƒ¨æ»¤é•œè¾¹ç¼˜å¼€å§‹ */
    padding-top: 0 !important; 
}
.card-manager-btn {
    position: absolute;
    /* ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå°† top ä»åŸæ¥çš„ 25px å¢åŠ åˆ° 40px */
    top: 40px !important; 
    right: 20px;
    
    /* å¢åŠ ä¸€å±‚èƒŒæ™¯ä¿æŠ¤ï¼Œé˜²æ­¢ç”±äºå¡ç‰‡èƒŒæ™¯å¤ªæ‚çœ‹ä¸æ¸…æŒ‰é’® */
    background: rgba(0, 0, 0, 0.3) !important;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20; /* ç¡®ä¿å®ƒåœ¨æ–‡å­—å±‚ä¹‹ä¸Šï¼Œæ–¹ä¾¿ç‚¹å‡» */
}
/* --- ğŸ–¤ æè‡´é»‘ç™½ï¼šNoir Voyage æ ·å¼ --- */

/* è¡¨å•å®¹å™¨ */
.noir-form-container {
    border: 1.5px solid #000;
    background: #FFF;
}

.noir-input-group {
    padding: 20px;
    border-bottom: 1px solid #EEE;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.noir-input-group label {
    font-size: 9px;
    font-weight: 900;
    letter-spacing: 2px;
    color: #AAA;
}

.noir-input-group input, .noir-input-group select {
    border: none;
    outline: none;
    font-size: 18px;
    font-family: serif;
    font-weight: 600;
    color: #000;
    background: transparent;
}

/* é»‘è‰²å®å¿ƒæŒ‰é’® */
.noir-btn-main {
    margin-top: 40px;
    width: 100%;
    background: #000;
    color: #FFF;
    border: none;
    padding: 20px;
    font-size: 12px;
    font-weight: 800;
    letter-spacing: 4px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
}

.noir-btn-main:active {
    background: #444;
    transform: translateY(2px);
}

/* --- ğŸŸï¸ å¥¢å Noirï¼šå·¥ä¸šå®‰å…¨ç‰ˆæœºç¥¨ --- */
.boarding-pass {
    background: #fff !important;
    /* æç»†çš„åŒçº¿è¾¹æ¡†ï¼Œå¤å…¸ä¸”é«˜çº§ */
    border: 3px double #000 !important; 
    padding: 0 !important;
    margin: 30px 0 !important;
    /* ç‰©ç†æ‹‰é•¿ï¼Œä¿æŒä¿®é•¿æ¯”ä¾‹ */
    min-height: 560px !important;
    display: flex;
    flex-direction: column;
    box-shadow: 0 30px 70px rgba(0,0,0,0.08) !important;
    position: relative;
}

/* é¡¶éƒ¨å“ç‰Œæ  */
.pass-header {
    background: #000;
    color: #fff;
    padding: 16px 35px;
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    letter-spacing: 3px;
    font-weight: 800;
    text-transform: uppercase;
}

/* ä¸»ä½“åŒºåŸŸ */
.pass-body {
    padding: 50px 40px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* --- ğŸŸï¸ æè‡´ Noirï¼šèˆªçº¿æ’ç‰ˆå¾®è°ƒ --- */

.flight-route {
    display: flex;
    justify-content: space-between; /* ğŸš¨ ç¡®ä¿ä¸¤ç«¯å¯¹é½ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
    border-bottom: 1.5px solid #000;
    padding: 20px 0 40px 0 !important; /* å¢åŠ åº•éƒ¨é—´è· */
    margin-bottom: 40px;
    position: relative; /* ä¸ºé£æœºå›¾æ ‡ç»å¯¹å®šä½åšå‡†å¤‡ */
}

/* æœºåœºç¼©å†™ï¼šç¼©å°å¹¶æ¨å‘æœ€è¾¹ç¼˜ */
.city-code {
    font-size: 42px !important; /* ğŸš¨ ç¼©å°å­—å·ï¼Œä»72pxé™åˆ°42px */
    font-weight: 900;
    letter-spacing: -1px;
    line-height: 1;
    color: #000;
    /* å¢åŠ ä¸€ä¸ªå›ºå®šçš„å®½åº¦ï¼Œç¡®ä¿å®ƒä»¬èƒ½é¡¶åˆ°æœ€è¾¹ä¸Š */
    min-width: 100px;
}

/* åŸå¸‚åç§°ï¼šç¨å¾®æ”¾å¤§ï¼Œå¢åŠ å­˜åœ¨æ„Ÿ */
.city-name {
    font-family: serif;
    font-style: italic;
    font-size: 18px !important; /* ğŸš¨ è°ƒå¤§å­—å· */
    font-weight: 700;
    margin-top: 8px;
    color: #000;
    letter-spacing: 1px;
}

/* é£æœºå›¾æ ‡ï¼šå®Œç¾å±…ä¸­ä¸”ç²¾è‡´ */
.flight-icon-center {
    position: absolute;
    left: 50%;
    top: 40%; /* å‘ä¸Šå¾®è°ƒï¼Œå¯¹é½å¤§å­—ä¸­å¿ƒçº¿ */
    transform: translate(-50%, -50%) rotate(90deg); /* ğŸš¨ ç‰©ç†å±…ä¸­å¹¶æ—‹è½¬ */
    font-size: 22px;
    color: #000;
    opacity: 0.15; /* ä¿æŒè‹¥éšè‹¥ç°çš„é«˜çº§æ„Ÿ */
}

/* è¯¦ç»†ä¿¡æ¯ç½‘æ ¼ */
.info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px 0;
    margin-top: 45px;
}

.info-item { display: flex; flex-direction: column; }
.info-label { font-size: 9px; color: #999; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
.info-value { font-size: 17px; font-weight: 900; letter-spacing: -0.3px; }

/* ğŸš¨ åº•éƒ¨é‡æ„ï¼šå·¥ä¸šå®‰å…¨éªŒè¯åŒº ğŸš¨ */
.pass-footer {
    /* æç»†çš„è™šçº¿åˆ†å‰² */
    border-top: 1px dashed rgba(0,0,0,0.4);
    padding: 35px 40px;
    background: #fff;
    position: relative;
    display: flex;
    flex-direction: column; /* æ”¹ä¸ºçºµå‘å¸ƒå±€ */
    gap: 25px;
}

/* ä¹˜å®¢ä¿¡æ¯ç®€æ´åŒ– */
.passenger-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}
.passenger-name {
    font-size: 20px;
    font-weight: 900;
    letter-spacing: -0.5px;
    border-bottom: 2px solid #000;
}

/* å·¥ä¸šæ¡å½¢ç å®¹å™¨ */
.security-zone {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* æ ¸å¿ƒï¼šé«˜å¯†åº¦å·¥ä¸š SVG æ¡å½¢ç  */
/* ä½¿ç”¨ SVG data URI ç”Ÿæˆé”åˆ©çš„çŸ¢é‡æ¡ç ï¼Œä¸å†æ˜¯æ¨¡ç³Šçš„ CSS æ¸å˜ */
.industrial-barcode {
    width: 100%;
    height: 55px; /* å¢åŠ é«˜åº¦ï¼Œæ›´æœ‰æ°”åŠ¿ */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='50' viewBox='0 0 400 50' preserveAspectRatio='none'%3E%3Cg fill='%23000'%3E%3Crect x='0' width='2' height='50'/%3E%3Crect x='4' width='1' height='50'/%3E%3Crect x='6' width='3' height='50'/%3E%3Crect x='12' width='1' height='50'/%3E%3Crect x='14' width='2' height='50'/%3E%3Crect x='18' width='4' height='50'/%3E%3Crect x='24' width='1' height='50'/%3E%3Crect x='26' width='2' height='50'/%3E%3Crect x='30' width='1' height='50'/%3E%3Crect x='32' width='3' height='50'/%3E%3Crect x='38' width='2' height='50'/%3E%3Crect x='42' width='1' height='50'/%3E%3Crect x='44' width='4' height='50'/%3E%3Crect x='50' width='1' height='50'/%3E%3Crect x='52' width='2' height='50'/%3E%3Crect x='56' width='1' height='50'/%3E%3Crect x='58' width='3' height='50'/%3E%3Crect x='64' width='1' height='50'/%3E%3Crect x='66' width='2' height='50'/%3E%3Crect x='70' width='3' height='50'/%3E%3Crect x='76' width='1' height='50'/%3E%3Crect x='78' width='2' height='50'/%3E%3Crect x='82' width='1' height='50'/%3E%3Crect x='84' width='3' height='50'/%3E%3Crect x='90' width='2' height='50'/%3E%3Crect x='94' width='1' height='50'/%3E%3Crect x='96' width='4' height='50'/%3E%3Crect x='102' width='1' height='50'/%3E%3Crect x='104' width='2' height='50'/%3E%3Crect x='108' width='1' height='50'/%3E%3Crect x='110' width='3' height='50'/%3E%3Crect x='116' width='1' height='50'/%3E%3Crect x='118' width='2' height='50'/%3E%3Crect x='122' width='4' height='50'/%3E%3Crect x='128' width='1' height='50'/%3E%3Crect x='130' width='2' height='50'/%3E%3Crect x='134' width='1' height='50'/%3E%3Crect x='136' width='3' height='50'/%3E%3Crect x='142' width='2' height='50'/%3E%3Crect x='146' width='1' height='50'/%3E%3Crect x='148' width='4' height='50'/%3E%3Crect x='154' width='1' height='50'/%3E%3Crect x='156' width='2' height='50'/%3E%3Crect x='160' width='1' height='50'/%3E%3Crect x='162' width='3' height='50'/%3E%3Crect x='168' width='1' height='50'/%3E%3Crect x='170' width='2' height='50'/%3E%3Crect x='174' width='3' height='50'/%3E%3Crect x='180' width='1' height='50'/%3E%3Crect x='182' width='2' height='50'/%3E%3Crect x='186' width='1' height='50'/%3E%3Crect x='188' width='3' height='50'/%3E%3Crect x='194' width='2' height='50'/%3E%3Crect x='198' width='1' height='50'/%3E%3Crect x='200' width='4' height='50'/%3E%3Crect x='206' width='1' height='50'/%3E%3Crect x='208' width='2' height='50'/%3E%3Crect x='212' width='1' height='50'/%3E%3Crect x='214' width='3' height='50'/%3E%3Crect x='220' width='1' height='50'/%3E%3Crect x='222' width='2' height='50'/%3E%3Crect x='226' width='4' height='50'/%3E%3Crect x='232' width='1' height='50'/%3E%3Crect x='234' width='2' height='50'/%3E%3Crect x='238' width='1' height='50'/%3E%3Crect x='240' width='3' height='50'/%3E%3Crect x='246' width='2' height='50'/%3E%3Crect x='250' width='1' height='50'/%3E%3Crect x='252' width='4' height='50'/%3E%3Crect x='258' width='1' height='50'/%3E%3Crect x='260' width='2' height='50'/%3E%3Crect x='264' width='1' height='50'/%3E%3Crect x='266' width='3' height='50'/%3E%3Crect x='272' width='1' height='50'/%3E%3Crect x='274' width='2' height='50'/%3E%3Crect x='278' width='3' height='50'/%3E%3Crect x='284' width='1' height='50'/%3E%3Crect x='286' width='2' height='50'/%3E%3Crect x='290' width='1' height='50'/%3E%3Crect x='292' width='3' height='50'/%3E%3Crect x='298' width='2' height='50'/%3E%3Crect x='302' width='1' height='50'/%3E%3Crect x='304' width='4' height='50'/%3E%3Crect x='310' width='1' height='50'/%3E%3Crect x='312' width='2' height='50'/%3E%3Crect x='316' width='1' height='50'/%3E%3Crect x='318' width='3' height='50'/%3E%3Crect x='324' width='1' height='50'/%3E%3Crect x='326' width='2' height='50'/%3E%3Crect x='330' width='4' height='50'/%3E%3Crect x='336' width='1' height='50'/%3E%3Crect x='338' width='2' height='50'/%3E%3Crect x='342' width='1' height='50'/%3E%3Crect x='344' width='3' height='50'/%3E%3Crect x='350' width='2' height='50'/%3E%3Crect x='354' width='1' height='50'/%3E%3Crect x='356' width='4' height='50'/%3E%3Crect x='362' width='1' height='50'/%3E%3Crect x='364' width='2' height='50'/%3E%3Crect x='368' width='1' height='50'/%3E%3Crect x='370' width='3' height='50'/%3E%3Crect x='376' width='1' height='50'/%3E%3Crect x='378' width='2' height='50'/%3E%3Crect x='382' width='3' height='50'/%3E%3Crect x='388' width='1' height='50'/%3E%3Crect x='390' width='2' height='50'/%3E%3Crect x='394' width='1' height='50'/%3E%3Crect x='396' width='3' height='50'/%3E%3C/g%3E%3C/svg%3E");
    background-repeat: repeat-x;
}

/* æ¡ç ä¸‹æ–¹çš„æŠ€æœ¯å‚æ•° */
.barcode-data {
    font-family: 'Courier New', monospace; /* å¼ºåˆ¶ç­‰å®½å­—ä½“ */
    font-size: 10px;
    letter-spacing: 1px;
    color: #000;
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    opacity: 0.8;
}

/* æ’•è£‚å£ */
.pass-notch {
    position: absolute;
    width: 16px; height: 16px;
    background: #F5F5F7;
    border: 1px solid rgba(0,0,0,0.4);
    border-radius: 50%;
    top: -9px;
}
.notch-left { left: -9px; }
.notch-right { right: -9px; }

/* åœ°å›¾è¿çº¿ (æç»†é»‘çº¿) */
.travel-line {
    stroke: #000 !important;
    stroke-width: 0.8;
    stroke-dasharray: 4,4;
}
/* --- ğŸ›ï¸ å¥¢å Noirï¼šæ—¥é—´ç‰ˆé‡å¡‘ --- */

/* 1. å…¨å±€èƒŒæ™¯ä¸å­—ä½“åŠ å›º */
#subpage-travel-journal {
    background: #FFFFFF !important; /* çº¯å‡€ç™½ */
    font-family: 'Montserrat', 'PingFang SC', sans-serif;
}

/* 2. èˆªçº¿ç­–åˆ’åŒºï¼šå»é‡ã€å»æ¡†ã€ç•™ç™½ */
#travel-planner {
    padding: 80px 40px !important;
}

.hero-label {
    font-size: 10px;
    letter-spacing: 6px;
    color: #000;
    opacity: 0.3;
    font-weight: 900;
    margin-bottom: 12px;
}

#travel-planner h1 {
    font-family: serif; /* ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦è¡¬çº¿ä½“å¢åŠ å¤å…¸æ„Ÿ */
    font-style: italic;
    font-size: 38px;
    letter-spacing: -1px;
    margin-bottom: 60px;
}

/* è¾“å…¥æ¡†ç»„ï¼šæç»†ä¸‹åˆ’çº¿é£æ ¼ï¼Œä¸å†ç”¨ç™½ç›’å­ */
.ios-list-group.theme-light {
    background: transparent !important;
    box-shadow: none !important;
    border-radius: 0 !important;
}

.ios-list-item.theme-light {
    border-bottom: 1px solid #000 !important; /* åªæœ‰åº•éƒ¨ä¸€æ¡é»‘çº¿ */
    padding: 25px 0 !important;
    background: transparent !important;
    display: flex;
    justify-content: space-between;
}

.item-label {
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
}

.ios-input-clean.theme-light {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}

/* 3. æ ¸å¿ƒæŒ‰é’®ï¼šçª„é•¿ã€å…¨é»‘ã€æç®€ */
.btn-awaken-core.theme-light-btn {
    background: #000 !important;
    color: #FFF !important;
    border-radius: 0 !important; /* æ–¹å½¢æ›´ç¡¬æ ¸ */
    height: 60px;
    font-size: 12px;
    letter-spacing: 5px;
    text-transform: uppercase;
    margin-top: 80px !important;
    box-shadow: none !important;
}

/* 4. æœºç¥¨é‡å¡‘ï¼šç»†é•¿ã€ä»ªå¼æ„Ÿã€æ— å¤šä½™é˜´å½± */
.boarding-pass {
    background: #fff !important;
    border: 1px solid #000 !important;
    min-height: 580px !important; /* ç‰©ç†æ‹‰é•¿ */
    box-shadow: 0 40px 100px rgba(0,0,0,0.05) !important; /* æè½»çš„æŠ•å½± */
    padding: 0 !important;
    margin: 20px 0 !important;
}
/* --- ğŸ—ºï¸ æè‡´ Noirï¼šå…¨æ™¯åœ°ç†æ‰«æå›¾ --- */

/* --- ğŸ—ºï¸ ç»ˆæç‰©ç†è¡¥ä¸ï¼šåœ°å›¾å®¹å™¨é”å®š --- */
#travel-map-box {
    width: 100% !important;
    height: 520px !important;
    position: relative;
    margin-top: 35px;
    background: #0a0a0a !important; /* é”å®šæ·±è‰²åº• */
    border: 1.5px solid #222 !important;
    border-radius: 4px;
    overflow: hidden;
}

/* ğŸš¨ æ ¸å¿ƒï¼šç‰©ç†ç½®é¡¶ï¼Œç¡®ä¿èˆªçº¿åœ¨åœ°å›¾æ‰€æœ‰å›¾å±‚ä¹‹ä¸Š ğŸš¨ */
.leaflet-pane { 
    z-index: 1 !important; 
}

/* --- ğŸ—ºï¸ ç‰©ç†è¡¥ä¸ï¼šäº¤äº’ç©¿é€å±‚çº§ --- */

#travel-svg-map {
    position: absolute !important;
    top: 0; left: 0;
    /* ğŸš¨ å…³é”®ï¼šå¼ºåˆ¶é“ºæ»¡ï¼Œä¸”ç¦æ­¢è¢«ä»»ä½• overflow è£åˆ‡ */
    width: 100% !important;
    height: 100% !important;
    z-index: 1000 !important;
    pointer-events: none !important;
    overflow: visible !important; /* å…è®¸å‘å…‰æ»¤é•œæº¢å‡ºè¾¹æ¡† */
}

#travel-dots-layer {
    pointer-events: none !important; /* ğŸš¨ å±‚æœ¬èº«ä¸æ¥æ”¶ç‚¹å‡» */
}

.travel-dot {
    position: absolute;
    width: 8px; height: 8px;
    background: #fff;
    border-radius: 50%;
    /* ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šå°†åœ†å¿ƒå¯¹å‡†è®¡ç®—å‡ºçš„åæ ‡ç‚¹ */
    transform: translate(-50%, -50%); 
    z-index: 500;
    box-shadow: 0 0 10px #fff;
    cursor: pointer;
    pointer-events: auto !important;
}

/* ä¿®æ­£èˆªçº¿é¢œè‰²ï¼šç™½è‰²å‘å…‰åœ¨é»‘åº•ä¸Šæ‰é«˜çº§ */
.travel-line {
    stroke: #ffffff !important;
    stroke-width: 2;
    fill: none !important;
    stroke-linecap: round;
    stroke-linejoin: round; /* ğŸš¨ æ‹è§’å¹³æ»‘ï¼Œé˜²æ­¢ç”±äºç¼©æ”¾å¯¼è‡´çš„å°–åˆº */
    filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));
    /* è¿™é‡Œåƒä¸‡ä¸è¦å†™ transition: allï¼Œå¦åˆ™ç¼©æ”¾ä¼šå˜æ…¢ */
}

/* ä¿®æ­£ Leaflet å®¹å™¨çš„æƒé‡ */
.leaflet-container {
    width: 100% !important;
    height: 100% !important;
    z-index: 1 !important;
}
/* --- ğŸ“¡ Noir æˆ˜æœ¯åŠ è½½åŠ¨ç”» --- */

/* 1. æŒ‰é’®åŠ è½½çŠ¶æ€ï¼šé»‘æ´å¸ç§¯æ•ˆæœ */
.btn-loading {
    pointer-events: none;
    background: #1a1a1a !important;
    color: rgba(255,255,255,0.3) !important;
    position: relative;
    overflow: hidden;
}

.btn-loading::after {
    content: "";
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: btnScan 1.5s infinite;
}

@keyframes btnScan {
    from { left: -100%; }
    to { left: 100%; }
}

/* 2. åœ°å›¾è§£ç é®ç½©å±‚ */
#map-loader-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #0a0a0a;
    z-index: 100;
    display: none; /* é»˜è®¤éšè— */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Courier New', monospace;
}

/* æ‰«æçº¿åŠ¨ç”» */
.radar-sweep {
    width: 100%; height: 2px;
    background: rgba(255,255,255,0.2);
    box-shadow: 0 0 15px #fff;
    position: absolute;
    top: 0;
    animation: sweep 2s infinite linear;
}

@keyframes sweep {
    0% { top: 0; opacity: 0; }
    50% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

.loading-text {
    color: #fff;
    font-size: 10px;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-top: 20px;
    animation: blink 0.8s infinite;
}

@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
.map-stability-notice {
    position: absolute;
    bottom: 20px; /* è·ç¦»åº•éƒ¨ 20px */
    left: 50%;
    transform: translateX(-50%); /* ç‰©ç†æ°´å¹³å±…ä¸­ */
    
    background: rgba(0, 0, 0, 0.7); /* æ·±è‰²åŠé€æ˜ */
    backdrop-filter: blur(10px); /* ç‰©ç†ç£¨ç ‚æ„Ÿ */
    -webkit-backdrop-filter: blur(10px);
    
    color: rgba(255, 255, 255, 0.6); /* æ·¡æ·¡çš„ç™½å­— */
    font-size: 10px;
    font-weight: 700;
    padding: 8px 18px;
    border-radius: 20px;
    letter-spacing: 1.5px;
    white-space: nowrap; /* å¼ºè¡Œä¸æ¢è¡Œ */
    
    /* ğŸš¨ æ ¸å¿ƒï¼šå¿…é¡»æ¯”åœ°å›¾å›¾å±‚é«˜ï¼Œä½†æ¯”ç«™ç‚¹ç‚¹ä½ä½ */
    z-index: 500; 
    border: 0.5px solid rgba(255, 255, 255, 0.15);
    pointer-events: none; /* é¼ æ ‡å¯ä»¥ç©¿é€å®ƒå»æ‹–åœ°å›¾ï¼Œä¸äº§ç”Ÿäº¤äº’å¹²æ‰° */
}
/* --- ğŸŸï¸ Noir ç‰©ç†å°ç« åè®® --- */
.pass-stamp {
    position: absolute;
    top: 50%;
    left: 65%; /* ç‰©ç†åç§»ï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
    width: 140px;
    height: 140px;
    border: 4px solid #8B0000; /* æ·±çº¢è‰²å¢¨è¿¹ */
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #8B0000;
    font-family: 'Montserrat', sans-serif;
    text-transform: uppercase;
    opacity: 0; /* åˆå§‹ä¸å¯è§ */
    z-index: 100;
    pointer-events: none;
    user-select: none;
    /* ğŸš¨ æ ¸å¿ƒï¼šæ¨¡æ‹Ÿå¢¨æ°´ä¸å‡åŒ€çš„æ»¤é•œ */
    filter: url(#ink-noise) contrast(1.2) rotate(-15deg);
}

.pass-stamp strong {
    font-size: 24px;
    font-weight: 900;
    letter-spacing: 2px;
    line-height: 1;
}

.pass-stamp span {
    font-size: 10px;
    font-weight: 700;
    margin-top: 5px;
    border-top: 1px solid #8B0000;
    padding-top: 2px;
}

/* ğŸš¨ ç‰©ç†æ’å‡»åŠ¨ç”» ğŸš¨ */
@keyframes stamp-slam {
    0% {
        opacity: 0;
        transform: scale(3) rotate(-45deg); /* ä»é«˜å¤„è½ä¸‹ */
    }
    80% {
        opacity: 1;
        transform: scale(0.9) rotate(-12deg); /* æ’å‡»ç¬é—´åå¼¹ */
    }
    100% {
        opacity: 0.85; /* æ¨¡æ‹Ÿå¢¨è¿¹æ¸—å…¥çº¸å¼ çš„åŠé€æ˜æ„Ÿ */
        transform: scale(1) rotate(-15deg); /* æœ€ç»ˆåœå®š */
    }
}

.stamp-active {
    animation: stamp-slam 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
/* --- ğŸ›ï¸ ç‰©ç†çº§é‡å¡‘ï¼šé‡‘åº“å­˜æ ¹é«˜çº§ç‰ˆ --- */
.travel-stub-card {
    background: #ffffff;
    margin-bottom: 24px;
    border: 1px solid #1d1d1f;
    border-radius: 2px; /* è¶‹è¿‘ç›´è§’ï¼Œæ›´æœ‰ç¥¨æ®æ„Ÿ */
    position: relative;
    display: flex;
    height: 140px; /* å›ºå®šé«˜åº¦ï¼Œä¿æŒæ’ç‰ˆç¨³å®š */
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
}

.travel-stub-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

/* å·¦ä¾§ï¼šé»‘è‰²å·¥ä¸šä¿¡æ¯åŒº */
.stub-left {
    width: 35px;
    background: #1d1d1f;
    color: rgba(255,255,255,0.4);
    writing-mode: vertical-lr;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: 800;
    letter-spacing: 2px;
    border-right: 1px dashed rgba(255,255,255,0.2);
}

/* å³ä¾§ï¼šä¸»ä½“è®¾è®¡ */
.stub-main {
    flex: 1;
    padding: 15px;
    display: flex;
    flex-direction: column;
    position: relative;
    background-image: 
        radial-gradient(#eee 1px, transparent 1px);
    background-size: 15px 15px; /* ææ·¡çš„ç‚¹é˜µæ°´å°åº•çº¹ */
}

/* èˆªçº¿å¤§å­—ï¼šä½¿ç”¨è¡¬çº¿ä½“ä¸éè¡¬çº¿ä½“ç¢°æ’ */
.stub-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.stub-codes {
    font-size: 24px;
    font-weight: 900;
    letter-spacing: -1px;
    color: #1d1d1f;
}

.stub-qr {
    width: 45px;
    height: 45px;
    border: 1px solid #1d1d1f;
    padding: 2px; /* æ¨¡æ‹Ÿé˜²ä¼ªäºŒç»´ç  */
}

.stub-cities {
    font-family: serif;
    font-style: italic;
    font-size: 14px;
    color: #555;
    margin-top: -5px;
}

/* åº•éƒ¨æ•°æ®ç½‘æ ¼ */
.stub-footer {
    margin-top: auto;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    border-top: 0.5px solid #eee;
    padding-top: 10px;
}

.f-item { display: flex; flex-direction: column; }
.f-label { font-size: 7px; color: #aaa; font-weight: 800; text-transform: uppercase; }
.f-val { font-size: 11px; font-weight: 700; color: #1d1d1f; }

/* ğŸš¨ ç‰©ç†æ’•è£‚çº¿æ•ˆæœ ğŸš¨ */
.stub-tear {
    position: absolute;
    right: 70px; top: -10px; bottom: -10px;
    width: 1px;
    border-left: 1px dashed #ddd;
}
/* --- ğŸ§­ æ‚¬æµ®èƒ¶å›Šå¯¼èˆªæ  --- */
.voyage-nav-wrapper {
    position: absolute;
    bottom: 35px;
    left: 0; width: 100%;
    display: flex; justify-content: center;
    z-index: 5000;
    pointer-events: none;
}

.voyage-capsule-nav {
    pointer-events: auto;
    display: flex;
    background: rgba(0, 0, 0, 0.88); /* æè‡´Noiré»‘ */
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    padding: 6px;
    border-radius: 40px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    border: 0.5px solid rgba(255,255,255,0.15);
}

.v-nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 22px;
    border-radius: 30px;
    color: rgba(255,255,255,0.4);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
}

.v-nav-item span {
    font-size: 10px; font-weight: 800; letter-spacing: 2px;
}

/* æ¿€æ´»æ€ï¼šç™½åº•é»‘å­—ï¼Œåè‰²ç¾å­¦ */
.v-nav-item.active {
    background: #FFFFFF;
    color: #000000;
    box-shadow: 0 4px 15px rgba(255,255,255,0.2);
}

/* é¢æ¿å¸ƒå±€é€»è¾‘ */
.voyage-panel {
    display: none;
    width: 100%; height: 100%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}
.voyage-panel.active { display: block; animation: panelSlideUp 0.4s ease forwards; }

@keyframes panelSlideUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ä¹‹å‰ç¼ºå¤±çš„ä¿å­˜æŒ‰é’®æ ·å¼ */
.btn-save-voyage {
    margin-top: 30px; width: 100%;
    border: 1.5px solid #000; background: transparent;
    color: #000; padding: 16px;
    font-size: 11px; font-weight: 900; letter-spacing: 4px;
    cursor: pointer; transition: all 0.3s;
    text-transform: uppercase;
}
.btn-save-voyage:active { background: #000; color: #fff; }
/* --- ğŸŸï¸ äº¤äº’å¼æ’•ç¥¨æ ¹ç‰©ç†å¼•æ“ (å·¦ä¾§å‰¥ç¦»ç‰ˆ) --- */

/* å®Œæ•´ç¥¨æ ¹å®¹å™¨ - ä¿æŒä¸å˜ */
.interactive-ticket {
    display: flex;
    width: 340px; height: 150px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.5s ease;
    filter: drop-shadow(0 15px 30px rgba(0,0,0,0.5));
    cursor: pointer;
}
.interactive-ticket:hover { transform: rotateX(5deg) translateY(-5px); }

/* å·¦ä¾§ï¼šé»‘è‰²å›ºå®šå­˜æ ¹ - å®ƒæ˜¯è¦è¢«æ’•æ‰çš„éƒ¨åˆ† */
.ticket-stub-part {
    width: 90px; /* ç¨å¾®åŠ å®½ä¸€ç‚¹ç‚¹ï¼Œæ’•èµ·æ¥æ›´æœ‰åˆ†é‡ */
    background: #1a1a1a; color: #555;
    display: flex; flex-direction: column; justify-content: space-between;
    padding: 20px 10px;
    border-radius: 4px 0 0 4px;
    position: relative; z-index: 2;
    /* æ’•è£‚çº¿åœ¨å³è¾¹ï¼Œæ­£å¥½ */
    border-right: 2px dashed rgba(255,255,255,0.15);
    transform-origin: right center; /* ğŸš¨ æ ¸å¿ƒï¼šæ—‹è½¬è½´å¿ƒè®¾ç½®åœ¨æ’•è£‚å¤„ */
    box-shadow: inset -5px 0 15px rgba(0,0,0,0.5);
}

/* å³ä¾§ï¼šç™½è‰²ä¸»ä½“ - å®ƒæ˜¯è¦ç•™ä¸‹çš„éƒ¨åˆ† */
.ticket-main-part {
    flex: 1;
    background: #e0e0e0; color: #1d1d1f;
    padding: 20px 25px;
    border-radius: 0 4px 4px 0;
    position: relative;
    z-index: 1;
    background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 12px 12px;
    box-shadow: inset 5px 0 10px rgba(0,0,0,0.05); /* å¢åŠ ä¸€ç‚¹ç«‹ä½“æ„Ÿ */
}

/* ğŸš¨ è§¦å‘çŠ¶æ€ï¼šæ ¸å¿ƒé€»è¾‘äº’æ¢ ğŸš¨ */

/* 1. é»‘è‰²å­˜æ ¹ï¼šæ‰§è¡Œæ’•è£‚é£å‡ºåŠ¨ç”» */
.interactive-ticket.is-torn .ticket-stub-part {
    animation: tearOffLeft 1.1s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
    pointer-events: none;
}

/* 2. ç™½è‰²ä¸»ä½“ï¼šæ‰§è¡Œåä½œç”¨åŠ›å¼¹åŠ¨ */
.interactive-ticket.is-torn .ticket-main-part {
    animation: mainRecoil 0.8s ease-out forwards;
}

/* ğŸš¨ å…¨æ–°ç‰©ç†åŠ¨ç”»å…³é”®å¸§ ğŸš¨ */

/* å‘å·¦æ’•è£‚é£å‡º */
@keyframes tearOffLeft {
    0% { transform: rotateY(0); opacity: 1; }
    30% { transform: rotateY(10deg) skewY(-3deg) translateX(5px); } /* å‘å³åå‘è“„åŠ› */
    100% { 
        /* å‘å·¦åæ–¹å¤§å¹…åº¦æ—‹è½¬å¹¶é£å‡ºå±å¹• */
        transform: rotateY(-90deg) translateX(-200px) rotateZ(-20deg) scale(0.8); 
        opacity: 0; 
    }
}

/* ä¸»ä½“å—åŠ›åå¼¹ (å‘å³å¼¹ä¸€ä¸‹) */
@keyframes mainRecoil {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(5px) rotate(1deg); } /* å—åˆ°å‘å·¦æ’•è£‚åŠ›çš„åä½œç”¨ï¼Œå‘å³å¼¹ */
}

/* (ç¥¨é¢å†…éƒ¨å…ƒç´ çš„æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ç”¨æ”¹) */
.tm-code { font-size: 28px; font-weight: 900; letter-spacing: -1px; line-height: 1; }
.tm-city { font-size: 13px; font-weight: 600; color: #666; font-family: serif; font-style: italic; margin-top: 5px; }
.tm-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px;}
.tm-label { font-size: 7px; font-weight: 900; color: #999; text-transform: uppercase; letter-spacing: 1px; }
.tm-val { font-size: 12px; font-weight: 800; color: #000; margin-top: 3px; }
.tm-seal {
    position: absolute; right: 20px; bottom: 20px;
    width: 60px; height: 60px;
    border: 3px solid #8B0000; border-radius: 50%; color: #8B0000;
    font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center;
    transform: rotate(-25deg); opacity: 0; /* åˆå§‹éšè—ï¼Œç­‰æ’•å¼€åå†æ˜¾ç¤ºæˆ–è€…ä¿æŒéšè— */
    filter: url(#ink-noise);
}
/* --- ğŸ—ºï¸ ä»ªå¼å…å…‰ç‚¹å‘¼å¸æ•ˆ --- */
.reveal-dot-glow {
    filter: drop-shadow(0 0 5px #fff);
    cursor: pointer !important;
    outline: none;
}

/* ç¡®ä¿å¼¹çª—åœ¨é»‘è‰²ä»ªå¼å…ä¸Šé¢ */
#modal-travel-log {
    background: rgba(0, 0, 0, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    z-index: 40000 !important;
}
/* --- ğŸ›ï¸ æ„Ÿå®˜éšç¬”ï¼šé«˜çº§æ»‘åŠ¨æ’ç‰ˆ --- */

.aesthetic-card {
    width: 85%;
    max-height: 75vh; /* ç¨å¾®è°ƒé«˜ä¸€ç‚¹ï¼Œè§†é‡æ›´å¼€é˜” */
    background: #FFFFFF;
    border-radius: 30px;
    padding: 30px;
    display: flex;
    flex-direction: column; /* å‚ç›´æ’åˆ— */
    box-shadow: 0 30px 60px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.05);
}

.log-fixed-header {
    flex-shrink: 0; /* ç¦æ­¢å¤´éƒ¨å‹ç¼© */
    margin-bottom: 20px;
}

/* ğŸš¨ æ ¸å¿ƒï¼šæ»‘åŠ¨åŒºåŸŸé€»è¾‘ ğŸš¨ */
.log-scroll-area {
    flex-grow: 1; /* è‡ªåŠ¨æ’‘å¼€å‰©ä½™ç©ºé—´ */
    overflow-y: auto; /* å¼€å¯ç‰©ç†æ»šåŠ¨ */
    padding-right: 10px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºéš™ */
    
    /* é¡ºæ»‘æ»šåŠ¨ï¼šiOS æƒ¯æ€§æ”¯æŒ */
    -webkit-overflow-scrolling: touch; 
}

/* ğŸš¨ æç®€æ»šåŠ¨æ¡é«˜å®šæ ·å¼ ğŸš¨ */
.log-scroll-area::-webkit-scrollbar {
    width: 2px; /* æç»†ï¼Œåƒä¸€æ¡ä¸çº¿ */
}

.log-scroll-area::-webkit-scrollbar-track {
    background: transparent;
}

.log-scroll-area::-webkit-scrollbar-thumb {
    background: #1d1d1f; /* çº¯é»‘ï¼Œç¬¦åˆ Noir å®¡ç¾ */
    border-radius: 10px;
}

#log-content-body {
    font-size: 16px;
    line-height: 2; /* å®½è¡Œè·ï¼Œèˆ’ç¼“è§†è§‰ */
    color: #1d1d1f;
    text-align: justify;
    font-family: serif;
    font-style: italic;
}

#log-mood-tag {
    flex-shrink: 0; /* ç¦æ­¢åº•éƒ¨å‹ç¼© */
    margin-top: 25px;
    font-size: 10px;
    color: #999;
    border-top: 0.5px solid #eee;
    padding-top: 15px;
    letter-spacing: 2px;
}
/* --- ğŸ—‘ï¸ ç¥¨æ ¹ç‰©ç†é”€æ¯åè®® --- */

/* --- ğŸ—‘ï¸ ç¥¨æ ¹ç‰©ç†é”€æ¯æŒ‰é’® (æ˜¾å½¢ç‰ˆ) --- */
.stub-delete-tag {
    position: absolute;
    top: 10px;    /* è·ç¦»é¡¶éƒ¨ 10px */
    right: 10px;  /* è·ç¦»å³ä¾§ 10px */
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* ğŸš¨ ç‰©ç†æ”¹è¿›ï¼šæé«˜åˆå§‹å¯¹æ¯”åº¦ */
    background: rgba(0, 0, 0, 0.05); 
    color: #888; /* é¢œè‰²åŠ æ·±ï¼Œç¡®ä¿èƒ½çœ‹è§ */
    border: 1px solid rgba(0, 0, 0, 0.1); 
    
    border-radius: 50%;
    font-size: 10px;
    font-weight: 900;
    cursor: pointer;
    z-index: 1000; /* ç‰©ç†ç½®é¡¶ï¼Œç¡®ä¿ä¸è¢«å›¾ç‰‡é®æŒ¡ */
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
}

/* æ‚¬åœæ•ˆæœï¼šå˜æˆé†’ç›®çš„åè‰² */
.stub-delete-tag:hover {
    background: #000;
    color: #FFF;
    transform: rotate(90deg); /* æ—‹è½¬åŠ¨æ•ˆæš—ç¤ºé”€æ¯ */
}

/* ç‰©ç†ç²‰ç¢åŠ¨ç”»ï¼šåˆ é™¤æ—¶çš„ç¼©æ”¾æ¶ˆå¤±æ•ˆæœ */
.stub-shredding {
    transform: scale(0.8) translateY(20px) !important;
    opacity: 0 !important;
    filter: blur(10px) !important;
    pointer-events: none;
}
/* --- ğŸšï¸ Noir å·¥ä¸šæ»‘åŠ¨æ¡é«˜å®š --- */
.noir-range-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 2px; /* æç»†è½¨é“ */
    background: #EEE;
    outline: none;
    cursor: pointer;
    /* æ ¸å¿ƒï¼šåŠ¨æ€å¡«å……è‰²é€»è¾‘ */
    background-image: linear-gradient(#000, #000);
    background-size: 0% 100%; /* åˆå§‹ç”± JS åŠ¨æ€è®¡ç®— */
    background-repeat: no-repeat;
}

/* æ»‘å—å¤´ (é‚£ä¸ªé»‘ç‚¹) */
.noir-range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 22px;
    width: 22px;
    background: #000;
    border-radius: 50%;
    border: 4px solid #FFF; /* å¢åŠ ç™½è¾¹ï¼Œåƒä¸ªé¶ç‚¹ */
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: transform 0.2s;
}

.noir-range-slider::-webkit-slider-thumb:active {
    transform: scale(1.2); /* æŒ‰ä½æ—¶äº§ç”Ÿç‰©ç†å‹è¿«æ„Ÿ */
}
/* æœç´¢ç»“æœå¡ç‰‡ï¼šè®°å¿†èƒ¶ç‰‡æ„Ÿ */
.search-result-item {
    background: #fff;
    border-radius: 18px;
    padding: 15px;
    border-left: 4px solid #EEE;
    transition: all 0.2s;
    animation: msgFadeUp 0.4s ease;
}
.search-result-item:active { transform: scale(0.98); background: #F9F9F9; }

/* ç”¨æˆ·å’Œå¯¹æ–¹çš„è‰²å½©åŒºåˆ† */
.search-result-item.user { border-left-color: #007AFF; }
.search-result-item.opponent { border-left-color: #AF52DE; }

.search-meta {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: #C7C7CC;
    margin-bottom: 8px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.search-text-preview {
    font-size: 14px;
    color: #1d1d1f;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* é«˜äº®æœåˆ°çš„è¯ */
.highlight-word {
    color: #007AFF;
    font-weight: 800;
    background: rgba(0, 122, 255, 0.1);
    padding: 0 2px;
    border-radius: 2px;
}
/* --- ğŸ’ åŠŸèƒ½é¢æ¿ï¼šé«˜åº¦ä¸å¯¹é½æ ¡å‡†ç‰ˆ --- */
/* --- ğŸš¨ ç‰©ç†å †å ä¿®æ­£ï¼šåŠŸèƒ½é¢æ¿ --- */
.feature-panel-container {
    width: 100%;
    height: 0; /* é»˜è®¤å…³é—­æ—¶ä¸å ä½ */
    background: transparent !important;
    overflow: hidden; /* æš‚æ—¶éšè—ï¼Œé˜²æ­¢å±•å¼€è¿‡ç¨‹é—ªçƒ */
    transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    position: relative;
    /* ğŸš¨ ç§»é™¤ä¹‹å‰çš„ margin-top: -120px */
}

/* --- ğŸš¨ ç‰©ç†å¯¹é½ä¿®æ­£ï¼šç»å¯¹å•è¡Œæ¨ªå‘ç‰ˆ --- */
.feature-panel-container {
    width: 100%;
    height: 0;
    background: transparent !important;
    overflow: hidden;
    transition: height 0.4s cubic-bezier(0.3, 1, 0.3, 1);
    flex-shrink: 0;
}

.feature-panel-container.active {
    height: 90px; /* ğŸš¨ å› ä¸ºåªæœ‰ä¸€è¡Œï¼Œé«˜åº¦å¯ä»¥ç¼©å‡ï¼Œæ›´ç²¾è‡´ */
}

.feature-list-wrapper {
    /* ğŸš¨ æ ¸å¿ƒä¿®æ­£ï¼šå¼ºåˆ¶å•è¡Œæ’å¸ƒ */
    display: flex !important;
    flex-direction: row !important; 
    flex-wrap: nowrap !important;   /* ğŸš¨ ç»å¯¹ç¦æ­¢æ¢è¡Œ */
    
    /* å…è®¸æ¨ªå‘æº¢å‡ºæ»šåŠ¨ */
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
    
    gap: 12px;
    padding: 15px 20px;
    width: 100%;
    box-sizing: border-box;
    justify-content: flex-start;
}

/* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
.feature-list-wrapper::-webkit-scrollbar { display: none; }

/* ğŸ’ æ¯ä¸ªç‹¬ç«‹çš„æ¶²æ€ç»ç’ƒèƒ¶å›Š */
.feature-glass-capsule {
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    
    /* ğŸš¨ æ ¸å¿ƒï¼šé˜²æ­¢å®½åº¦è¢« Flex å‹ç¼©å˜å½¢ */
    flex-shrink: 0 !important; 
    
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.25) !important;
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    
    height: 44px;
    width: auto; /* å®½åº¦éšæ–‡å­—è‡ªåŠ¨æ’‘å¼€ */
}

.capsule-icon {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.capsule-label {
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
    letter-spacing: -0.3px;
    white-space: nowrap; /* ğŸš¨ ç¡®ä¿æ–‡å­—ä¸æ¢è¡Œ */
}
/* --- ğŸš¨ ç‰©ç†å¼ºæ¨ï¼šå¼ºåˆ¶ç½®äºè¾“å…¥æ¡†ä¸Šæ–¹ç‰ˆ --- */
.feature-panel-container {
    width: 100%;
    height: 0;
    background: transparent !important;
    overflow: visible !important; /* ğŸš¨ å…è®¸æº¢å‡ºæ˜¾ç¤º */
    transition: height 0.4s cubic-bezier(0.3, 1, 0.3, 1);
    
    /* ğŸš¨ æ ¸å¿ƒä½ç§»é­”æ³• ğŸš¨ */
    position: relative;
    top: -10px; /* å‘ä¸Šç§»åŠ¨ï¼Œä¸é®æŒ¡è¾“å…¥æ¡†è¾¹æ¡† */
    transform: translateY(-100%); /* ç‰©ç†å¼ºåˆ¶ï¼šå‘ä¸Šå¹³ç§»è‡ªèº«é«˜åº¦çš„100% */
    z-index: 2000;
}

.feature-panel-container.active {
    height: 70px; /* é”å®šå•è¡Œé«˜åº¦ */
    margin-bottom: 0;
}

.feature-list-wrapper {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: nowrap !important; /* ğŸš¨ ç»ä¸æ¢è¡Œ */
    overflow-x: auto !important; /* ğŸš¨ å¼€å¯å·¦å³æ»‘åŠ¨ */
    -webkit-overflow-scrolling: touch;
    
    gap: 12px;
    padding: 10px 20px;
    width: 100%;
    box-sizing: border-box;
}

/* éšè—æ»šåŠ¨æ¡ */
.feature-list-wrapper::-webkit-scrollbar { display: none; }

/* ğŸ’ æ¯ä¸€ä¸ªç‹¬ç«‹çš„æ¶²æ€ç»ç’ƒèƒ¶å›Š */
.feature-glass-capsule {
    flex-shrink: 0 !important; /* ğŸš¨ é˜²æ­¢è¢«æŒ¤å‹å˜çª„ */
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    
    padding: 8px 18px;
    background: rgba(255, 255, 255, 0.3) !important;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    
    height: 44px;
    transition: transform 0.2s;
}

.capsule-icon svg {
    width: 20px;
    height: 20px;
    stroke: #1d1d1f;
    stroke-width: 2;
    margin-right: 10px;
}

.capsule-label {
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
    white-space: nowrap;
}
/* ğŸ–¼ï¸ å›¾ç‰‡æ°”æ³¡ä¸“ç”¨æ ·å¼ */
.bubble.image-bubble {
    padding: 0 !important;
    background: transparent !important;
    border: none !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
    max-width: 240px; /* é™åˆ¶å›¾ç‰‡æœ€å¤§å®½åº¦ */
}

.chat-msg-img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 18px;
    border: 0.5px solid rgba(255,255,255,0.2);
    cursor: pointer;
    transition: transform 0.2s;
}

.chat-msg-img:active { transform: scale(0.98); }
/* --- ğŸ’ å¼•ç”¨ç›’é«˜çº§é‡å¡‘ --- */
.bubble-quote-box {
    background: rgba(0, 0, 0, 0.06) !important; /* ææ¸…é€çš„é®ç½© */
    border-left: 2px solid rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 8px 12px;
    margin-bottom: 8px;
    font-size: 12px;
    color: inherit;
    position: relative;
}

/* ç”¨æˆ·æ°”æ³¡é‡Œçš„å¼•ç”¨ç›’ï¼ˆå˜äº®ï¼‰ */
.msg-row.user .bubble-quote-box {
    background: rgba(255, 255, 255, 0.15) !important;
    border-left-color: rgba(255, 255, 255, 0.4);
}
/* =========================================
   ğŸ–¤ Emoji æŠ½å±‰ï¼šåº•ç«¯å¯¹é½ç‰©ç†è¡¥ä¸
   ========================================= */
#emoji-modal-mask {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    z-index: 20000;
    display: none;        /* åˆå§‹éšè— */
    align-items: flex-end; /* ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šå¼ºåˆ¶å­å…ƒç´ æ²‰åˆ°åº•éƒ¨ */
    justify-content: center;
}

#emoji-modal-mask.active {
    display: flex; /* æ¿€æ´»æ—¶æ˜¾ç¤º */
}

.emoji-modal-card {
    width: 100%;
    max-width: 500px;
    background: #FFFFFF;
    border-radius: 30px 30px 0 0; /* ä»…é¡¶éƒ¨åœ†è§’ï¼Œé€‚é…åº•ç«¯ */
    padding: 24px;
    padding-bottom: 60px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
    
    /* æ»‘å…¥åŠ¨ç”» */
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

#emoji-modal-mask.active .emoji-modal-card {
    transform: translateY(0); /* æ¿€æ´»æ—¶æ»‘å…¥è§†é‡ */
}

#emoji-grid-list {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    max-height: 280px;
    overflow-y: auto;
    padding: 10px 0;
}
#emoji-grid-list::-webkit-scrollbar { display: none; }

.emoji-grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
}
/* --- ğŸ˜Š ä¿®å¤è¡¨æƒ…å¼¹çª—å¤´éƒ¨ï¼šæ ‡é¢˜å±…å·¦ï¼Œå–æ¶ˆå±…å³ --- */
.emoji-header {
    display: flex !important;
    justify-content: space-between !important; /* ğŸš¨ æ ¸å¿ƒï¼šæŠŠä¸¤ç«¯æ’‘å¼€ */
    align-items: center !important;
    width: 100% !important;
    margin-bottom: 25px !important; /* å¢åŠ ä¸€ç‚¹ä¸‹è¾¹è·ï¼Œå‘¼å¸æ„Ÿæ›´å¥½ */
}

.emoji-title {
    font-family: serif; /* ä¿æŒä½ çš„è¡¬çº¿ä½“é«˜çº§æ„Ÿ */
    font-weight: 800;
    font-size: 18px;
    color: #1d1d1f;
}

.emoji-cancel {
    color: #007AFF !important;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    padding: 5px 0 5px 10px; /* å¢åŠ ç‚¹å‡»çƒ­åŒº */
}
/* --- ğŸ’ è¡¨æƒ…ç®¡ç†å™¨é«˜çº§è§†è§‰è¡¥ä¸ --- */
#emoji-pre-box {
    width: 120px !important;
    height: 120px !important;
    background: #FFF !important;
    border: 1.5px solid #000 !important; /* å·¥ä¸šæ„Ÿé»‘è¾¹ */
    border-radius: 20px !important;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#emoji-pre-box:active {
    transform: scale(0.96);
    background: #f8f8f8 !important;
}

#emoji-tag-in:focus {
    background: #FFF !important;
    border-color: #000 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
}

/* é€‚é…ä½ åŸæœ¬çš„æŠ½å±‰æ ·å¼ */
.p2-editor-sheet {
    width: 100%;
    background: #fff;
    border-radius: 30px 30px 0 0;
    padding: 25px;
    animation: sheetUp 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}
/* =========================================
   ğŸ“ æ°”æ³¡æ¯”ä¾‹é‡å¡‘ï¼šä¸‹é¢Œéª¨ç²¾å‡†å¾®è°ƒ
   ========================================= */

/* 1. å…¨å±€æ°”æ³¡åº•åº§å¾®è°ƒ */
.bubble {
    position: relative !important;
    padding: 10px 14px !important; /* ç¼©å°ä¸Šä¸‹å†…è¾¹è·ï¼Œè®©æ–‡å­—å±…ä¸­æ„Ÿæ›´å¼º */
    font-size: 15px !important;
    line-height: 1.5 !important;
    word-wrap: break-word;
    word-break: break-all;
    /* é»˜è®¤åœ†è§’è®¾ä¸ºæ ‡å‡† 16px */
    border-radius: 16px !important; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.02) !important;
}

/* 2. ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè§’è‰²å›å¤ï¼ˆå·¦ä¾§æ°”æ³¡ï¼‰çš„ä¸‹é¢Œéª¨ */
.msg-row.opponent .bubble {
    background: #FFFFFF !important;
    color: #1d1d1f !important;
    /* ç‰©ç†é€»è¾‘ï¼šå·¦ä¸‹è§’ï¼ˆé è¿‘å¤´åƒï¼‰çš„åœ†è§’è®¾ä¸º 4pxï¼Œäº§ç”Ÿâ€œå°–è§’â€æŒ‡å‘å¤´åƒï¼Œå…¶ä½™ä¸‰è§’åœ†æ¶¦ */
    /* è¿™æ ·å°±ä¸ä¼šæ˜¾å¾—åº•éƒ¨æ˜¯ä¸€ä¸ªæ²‰é‡çš„åœ†å¼§äº† */
    border-radius: 16px 16px 16px 4px !important; 
    border: 0.5px solid rgba(0,0,0,0.05) !important;
    margin-top: 2px !important;
}

/* 3. å¯¹åº”ä¿®æ”¹ï¼šç”¨æˆ·å›å¤ï¼ˆå³ä¾§æ°”æ³¡ï¼‰çš„å¯¹ç§°é€»è¾‘ */
.msg-row.user .bubble {
    background: linear-gradient(135deg, #1d1d1f 0%, #434345 100%) !important;
    color: #FFFFFF !important;
    /* å³ä¸‹è§’è®¾ä¸º 4pxï¼ŒæŒ‡å‘å³ä¾§ç”¨æˆ·å¤´åƒ */
    border-radius: 16px 16px 4px 16px !important;
}

/* 4. æ¶ˆé™¤è¡¨æƒ…åŒ…æ°”æ³¡çš„èƒŒæ™¯å½±å“ï¼Œé˜²æ­¢â€œä¸‹å·´â€æº¢å‡º */
.bubble.emoji-bubble {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0 !important;
    border-radius: 0 !important; /* è´´çº¸æ¨¡å¼ä¸éœ€è¦æ°”æ³¡åœ†è§’ */
}

/* =========================================
   ğŸ“ å…¨åŸŸè¡¨æƒ…åè®®ï¼šç”¨æˆ· & è§’è‰²ç»å¯¹å¯¹é½
   ========================================= */

/* 1. å¼ºåˆ¶æŠ¹é™¤æ‰€æœ‰èƒŒæ™¯ã€é˜´å½±ã€åœ†è§’å’Œè¾¹è· */
.bubble.emoji-bubble, 
.msg-row.opponent .bubble.image-bubble,
.msg-row.user .bubble.image-bubble {
    background: transparent !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
    padding: 0 !important;
    border-radius: 0 !important;
    
    /* ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šé”å®šç»Ÿä¸€å®½åº¦ */
    width: 130px !important; 
    max-width: 130px !important;
    
    /* é¿å¼€æ°”æ³¡ä¸Šæ–¹å¯èƒ½å­˜åœ¨çš„é—´è· */
    margin-top: 5px !important;
}

/* 2. å¼ºåˆ¶å†…éƒ¨å›¾ç‰‡æ’‘æ»¡è¿™ä¸ª 130px çš„æ¡† */
.bubble.emoji-bubble .chat-msg-img,
.msg-row.opponent .bubble.image-bubble .chat-msg-img,
.msg-row.user .bubble.image-bubble .chat-msg-img {
    width: 100% !important;
    height: auto !important;
    display: block !important;
    /* å¢åŠ å¾®å¼±æŠ•å½±è®©è´´çº¸æ›´æœ‰å±‚æ¬¡æ„Ÿ */
    filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); 
}

/* 3. é’ˆå¯¹å°å±å¹•(å¦‚ iPhone SE)çš„æè‡´ç¼©æ”¾ */
@media screen and (max-width: 380px) {
    .bubble.emoji-bubble,
    .msg-row.opponent .bubble.image-bubble {
        width: 110px !important;
        max-width: 110px !important;
    }
}
/* =========================================
   ğŸ–¤ Noir Voice Engine æ——èˆ°çº§è§†è§‰åè®®
   ========================================= */

.noir-voice-gate { background: #f4f4f7 !important; }

/* 1. å¤´éƒ¨ç»„ä»¶ */
.noir-header-fix {
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: saturate(180%) blur(20px) !important;
    border-bottom: 0.5px solid rgba(0,0,0,0.1) !important;
}
.noir-h-btn { color: #007AFF !important; font-size: 16px; font-weight: 500; cursor: pointer; }
.noir-h-btn.bold { font-weight: 700; }
.noir-h-title { font-size: 14px; font-weight: 800; letter-spacing: 1px; color: #1d1d1f; }

/* 2. é€šæ åˆ—è¡¨æ¶æ„ */
.noir-section-label {
    font-size: 10px; font-weight: 900; color: #8e8e93; padding: 25px 20px 8px;
    letter-spacing: 2px; text-transform: uppercase;
}
.noir-full-list {
    background: #fff !important; width: 100% !important; 
    border-top: 0.5px solid rgba(0,0,0,0.08); border-bottom: 0.5px solid rgba(0,0,0,0.08);
}
.noir-row {
    display: flex; justify-content: space-between; align-items: center;
    min-height: 54px; margin-left: 20px; padding-right: 20px; border-bottom: 0.5px solid #F2F2F7;
}
.noir-row.last { border-bottom: none; }
.noir-row .n-label { font-size: 16px; font-weight: 600; color: #000; }

/* 3. å» Select åŒ–ï¼šæ¨¡æ‹Ÿé“¾æ¥ä¸è¾“å…¥æ¡† */
.n-value-link {
    color: #007AFF !important; font-size: 16px; font-weight: 600; padding-right: 20px; position: relative; cursor: pointer;
}
.n-value-link::after {
    content: ""; width: 7px; height: 7px; border-right: 2.5px solid #C7C7CC; border-bottom: 2.5px solid #C7C7CC;
    transform: rotate(-45deg); position: absolute; right: 0; top: 6px;
}
.noir-clean-input {
    border: none; background: transparent; text-align: right;
    color: #007AFF; font-size: 16px; font-weight: 600; outline: none; width: 60%;
}

/* 4. é‡å·¥ä¸šåŒæ­¥æŒ‰é’® */
.noir-action-full { padding: 10px 0; }
.noir-sync-trigger {
    background: #1d1d1f !important; color: #fff !important; height: 58px; width: 100%;
    display: flex; align-items: center; justify-content: center; gap: 12px;
    font-weight: 800; font-size: 13px; letter-spacing: 2.5px; cursor: pointer;
}
.noir-sync-trigger:active { background: #333 !important; }

/* 5. å‚æ•°è°ƒèŠ‚åŒºåŸŸ */
.noir-param-card {
    background: #fff; width: 100%; padding: 35px 25px;
    border-top: 0.5px solid rgba(0,0,0,0.08); border-bottom: 0.5px solid rgba(0,0,0,0.08);
}
.n-param-info { display: flex; justify-content: space-between; margin-bottom: 15px; }
.n-p-tag { font-size: 11px; font-weight: 900; color: #3a3a3c; letter-spacing: 1px; }
.n-p-num { font-family: 'Courier New', monospace; color: #007AFF; font-weight: 900; font-size: 14px; }

/* 6. ç‰©ç†çº§æ»‘å—é‡å¡‘ */
.noir-range-pro {
    -webkit-appearance: none; width: 100%; height: 2px; background: #E5E5EA; border-radius: 2px; outline: none; margin: 15px 0;
}
.noir-range-pro::-webkit-slider-thumb {
    -webkit-appearance: none; width: 28px; height: 28px; background: #fff; border-radius: 50%;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 0 0 0.5px rgba(0,0,0,0.05); cursor: pointer;
}

/* 7. è‡ªå®šä¹‰ Action Sheet */
.noir-picker-box {
    width: 96%; max-width: 450px; background: rgba(255,255,255,0.9);
    backdrop-filter: blur(25px) saturate(180%); border-radius: 24px;
    margin-bottom: 12px; display: flex; flex-direction: column;
    animation: nSheetUp 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
}
@keyframes nSheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.n-picker-header { padding: 16px; text-align: center; font-size: 11px; font-weight: 900; color: #8e8e93; letter-spacing: 2px; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
.n-picker-scroll { max-height: 45vh; overflow-y: auto; }
.n-opt-item { padding: 18px; text-align: center; color: #007AFF; font-size: 18px; font-weight: 500; border-bottom: 0.5px solid rgba(0,0,0,0.05); }
.n-opt-item:active { background: rgba(0,0,0,0.05); }
.n-picker-cancel { background: #fff; padding: 16px; border-radius: 14px; text-align: center; color: #FF3B30; font-weight: 700; font-size: 18px; margin: 8px 16px 25px; }

.noir-footer-hint { text-align: center; font-size: 10px; font-weight: 700; color: #c7c7cc; padding: 40px 20px; letter-spacing: 2px; }
/* --- ğŸ™ï¸ è¯­éŸ³æ¶ˆæ¯æ°”æ³¡ä¸“å±æ ·å¼ --- */

/* 1. åŸºç¡€å®¹å™¨ */
.bubble.voice-bubble {
    width: 160px; /* å›ºå®šå®½åº¦ï¼Œåƒå¾®ä¿¡è¯­éŸ³ä¸€æ · */
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px !important;
    cursor: pointer;
    position: relative;
    overflow: visible !important;
}

/* 2. æ’­æ”¾å›¾æ ‡æ—‹è½¬ */
.voice-play-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

/* 3. å£°æ³¢åŠ¨ç”»çº¿ */
.voice-waves {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 15px;
    flex: 1;
}

.voice-waves span {
    width: 2px;
    height: 6px;
    background: currentColor;
    border-radius: 1px;
    opacity: 0.4;
    transition: height 0.2s;
}

/* æ’­æ”¾æ—¶çš„è·³åŠ¨åŠ¨ç”» */
.bubble.playing .voice-waves span {
    animation: waveRise 0.5s infinite ease-in-out;
}

.bubble.playing .voice-waves span:nth-child(2) { animation-delay: 0.1s; }
.bubble.playing .voice-waves span:nth-child(3) { animation-delay: 0.2s; }
.bubble.playing .voice-waves span:nth-child(4) { animation-delay: 0.3s; }

@keyframes waveRise {
    0%, 100% { height: 6px; }
    50% { height: 14px; }
}

/* 4. æ—¶é•¿æ–‡å­— */
.voice-duration {
    font-size: 11px;
    font-weight: 700;
    opacity: 0.6;
    font-family: monospace;
}

/* 5. æœªè¯»çº¢ç‚¹ */
.voice-unread-dot {
    position: absolute;
    top: 0;
    right: -10px;
    width: 8px;
    height: 8px;
    background: #FF3B30;
    border-radius: 50%;
    display: block;
}
.is-read .voice-unread-dot { display: none; }
/* è¯­éŸ³æ°”æ³¡å†…éƒ¨å¸ƒå±€ */
.voice-layout-grid {
    display: flex;
    flex-direction: column;
    width: 100%;
}

/* ä¸ŠåŠéƒ¨åˆ†ï¼šæ³¢çº¹æ’­æ”¾å™¨ */
.voice-player-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* ä¸‹åŠéƒ¨åˆ†ï¼šè½¬æ–‡å­—å†…å®¹ (é»˜è®¤éšè—) */
.voice-text-transcription {
    display: none; /* é»˜è®¤ä¸æ˜¾ç¤º */
    margin-top: 12px;
    padding-top: 10px;
    border-top: 0.5px solid rgba(0,0,0,0.1);
    font-size: 14px;
    line-height: 1.5;
    color: inherit;
    text-align: left;
    animation: slideDown 0.3s ease;
}

/* è‡ªå·±çš„è¯­éŸ³æ¡å±•å¼€æ—¶çš„åˆ†å‰²çº¿é¢œè‰² */
.msg-row.user .voice-text-transcription {
    border-top-color: rgba(255,255,255,0.2);
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤ºæ–‡å­— */
.bubble.voice-expanded .voice-text-transcription {
    display: block;
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ°”æ³¡å˜å®½ä¸€ç‚¹ä»¥å®¹çº³æ–‡å­— */
.bubble.voice-expanded {
    width: auto !important; /* è§£é™¤å®½åº¦é™åˆ¶ */
    min-width: 160px;
    max-width: 260px !important;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ™ï¸ ç»ˆæè¯­éŸ³æ°”æ³¡æ ·å¼ (ä¸‰æ®µå¼ + æ·±æµ…é€‚é…) --- */

/* 1. åŸºç¡€å®¹å™¨ */
.voice-layout-grid {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-width: 140px; /* ç»™è¯­éŸ³æ¡ä¸€ä¸ªåŸºç¡€å®½åº¦ */
}

/* 2. æ’­æ”¾å™¨è¡Œ (ä»…å›¾æ ‡+æ—¶é•¿) */
.voice-player-row {
    display: flex;
    align-items: center;
    gap: 8px; /* å›¾æ ‡å’Œæ–‡å­—é—´è· */
    height: 24px;
    position: relative;
}

/* æ’­æ”¾å›¾æ ‡æ—‹è½¬ */
.voice-play-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

/* æ—¶é•¿æ–‡å­— */
.voice-duration {
    font-size: 11px;
    font-weight: 700;
    opacity: 0.6;
    font-family: monospace;
}


/* 3. å†…å®¹å®¹å™¨ (é»˜è®¤éšè—) */
.voice-content-box {
    display: none;
    margin-top: 10px;
    padding-top: 8px;
    border-top: 0.5px solid rgba(0,0,0,0.1); /* é»˜è®¤æµ…è‰²åˆ†å‰²çº¿ */
    animation: slideDown 0.3s ease;
    flex-direction: column;
    align-items: flex-start;
}

/* æ¿€æ´»çŠ¶æ€ï¼šæ˜¾ç¤ºå†…å®¹ */
.bubble.voice-expanded .voice-content-box {
    display: flex;
}
.bubble.voice-expanded {
    width: auto !important;
    max-width: 260px !important;
}

/* 4. åŸæ–‡æ ·å¼ */
.voice-origin-text {
    font-size: 15px;
    line-height: 1.5;
    margin-bottom: 4px;
}

/* 5. ç¿»è¯‘æŒ‰é’® (é€šç”¨æ ·å¼) */
.voice-trans-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 6px;
    align-self: flex-end; /* é å³å¯¹é½ */
    transition: all 0.2s;
}

/* 6. è¯‘æ–‡åŒºåŸŸ */
.voice-trans-result {
    display: none; /* é»˜è®¤éšè— */
    width: 100%;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 0.5px dotted rgba(0,0,0,0.1);
    font-size: 13px;
    line-height: 1.5;
}

/* æ¿€æ´»æ˜¾ç¤ºè¯‘æ–‡ */
.voice-content-box.show-trans .voice-trans-result {
    display: block;
}
.voice-content-box.show-trans .voice-trans-btn {
    display: none; /* å±•å¼€åéšè—æŒ‰é’® */
}

/* --- ğŸ­ æ·±æµ…è‰²é€‚é… (æ ¸å¿ƒ) --- */

/* è§’è‰² (æµ…è‰²æ°”æ³¡) */
.msg-row.opponent .voice-trans-btn {
    background: rgba(0,0,0,0.05);
    color: #007AFF;
}
.msg-row.opponent .voice-trans-result {
    color: #666;
    border-top-color: rgba(0,0,0,0.1);
}

/* ç”¨æˆ· (æ·±è‰²æ°”æ³¡) */
.msg-row.user .voice-content-box {
    border-top-color: rgba(255,255,255,0.2); /* ç¬¬ä¸€é“åˆ†å‰²çº¿å˜ç™½ */
}
.msg-row.user .voice-trans-btn {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255,255,255,0.3);
}
.msg-row.user .voice-trans-btn svg {
    stroke: #FFFFFF;
}
.msg-row.user .voice-trans-result {
    color: rgba(255, 255, 255, 0.95);
    border-top-color: rgba(255, 255, 255, 0.3); /* ç¬¬äºŒé“åˆ†å‰²çº¿å˜ç™½ */
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
/* =========================================================
   ğŸš‘ æ–‡æœ¬æ¶ˆæ¯ç¿»è¯‘æ ·å¼ä¿®å¤ (å¼ºåˆ¶è¦†ç›–ç‰ˆ)
   ========================================================= */

/* 1. ç¿»è¯‘å®¹å™¨ï¼šå»æ‰å¤šä½™çš„é—´éš”ï¼Œä½¿ç”¨å¹²å‡€çš„é¡¶è¾¹æ¡† */
.bubble:not(.voice-bubble) .bubble-translation-box {
    display: block; /* ä¿æŒæ˜¾ç¤º */
    margin-top: 10px !important;
    padding-top: 8px !important;
    /* ç”¨æç»†çš„åˆ†å‰²çº¿ä»£æ›¿åŸæ¥çš„ .trans-line */
    border-top: 0.5px solid rgba(0, 0, 0, 0.1) !important; 
    width: 100% !important;
}

/* 2. éšè—ä¹‹å‰é‚£ä¸ªéš¾çœ‹çš„ç²—çº¿æ¡ div */
.bubble:not(.voice-bubble) .trans-line {
    display: none !important; 
}

/* 3. è¯‘æ–‡æ–‡å­—ï¼šå­—ä½“è°ƒå°ï¼Œé¢œè‰²å¯¹é½ */
.bubble:not(.voice-bubble) .msg-text-trans {
    font-size: 14px !important;
    line-height: 1.5 !important;
    color: inherit !important;
    opacity: 0.85 !important;
    font-style: normal !important; /* å»æ‰æ–œä½“ï¼Œæ›´æ˜“è¯» */
    margin-bottom: 5px !important;
}

/* 4. ç¿»è¯‘æŒ‰é’®ï¼šç¼©å°ã€é å³ã€èƒ¶å›ŠåŒ– */
.bubble:not(.voice-bubble) .trans-toggle-btn {
    /* å˜æˆä¸€ä¸ªå°æ ‡ç­¾ */
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    margin-top: 4px !important;
    padding: 3px 8px !important;
    border-radius: 8px !important;
    
    font-size: 10px !important;
    font-weight: 700 !important;
    
    /* å¼ºåˆ¶é å³å¯¹é½ */
    float: right !important; 
    clear: both !important;
    
    /* é»˜è®¤æµ…è‰²æ°”æ³¡çš„æŒ‰é’®æ ·å¼ */
    color: #000000 !important;
    border: none !important;
    box-shadow: none !important;
}

/* æ¸…é™¤æµ®åŠ¨ï¼Œé˜²æ­¢é«˜åº¦å¡Œé™· */
.bubble:not(.voice-bubble)::after {
    content: "";
    display: block;
    clear: both;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
/* =========================================================
   ğŸ”´ ç»ˆæç£¨åœ†ï¼šå»é™¤æ‰€æœ‰å°–è§’ï¼Œå˜æˆå®Œç¾èƒ¶å›Š
   ========================================================= */

/* 1. å¯¹æ–¹çš„æ°”æ³¡ (å·¦è¾¹)ï¼šå·¦ä¸‹è§’å¼ºåˆ¶å˜åœ† */
.msg-row.opponent .bubble {
    border-bottom-left-radius: 18px !important; /* å½»åº•ç£¨åœ† */
}

/* 2. è‡ªå·±çš„æ°”æ³¡ (å³è¾¹)ï¼šå³ä¸‹è§’å¼ºåˆ¶å˜åœ† (å¦‚æœä½ ä¹Ÿæƒ³æ”¹çš„è¯) */
.msg-row.user .bubble {
    border-bottom-right-radius: 18px !important;
}

/* 3. ä¿®å¤ç¿»è¯‘å±‚çš„åœ†è§’ (é˜²æ­¢ç¿»è¯‘èƒŒæ™¯åˆ‡æ–­åœ†è§’) */
.msg-row.opponent .bubble-translation-box {
    border-bottom-left-radius: 18px !important;
}
.msg-row.user .bubble-translation-box {
    border-bottom-right-radius: 18px !important;
}

/* 4. ç¡®ä¿å›¾ç‰‡ä¹Ÿæ˜¯å®Œç¾åœ†è§’ */
.chat-msg-img {
    border-radius: 18px !important;
}
/* =========================================================
   ğŸ”˜ iOS å¼€å…³ç»„ä»¶æ ·å¼ (ç¾åŒ–è¡¥ä¸)
   ========================================================= */

/* 1. å¼€å…³å®¹å™¨ */
.ios-switch {
    position: relative;
    display: inline-block;
    width: 51px;  /* æ ‡å‡†å®½åº¦ */
    height: 31px; /* æ ‡å‡†é«˜åº¦ */
    vertical-align: middle;
}

/* 2. éšè—åŸå§‹çš„æ–¹å—å‹¾é€‰æ¡† */
.ios-switch input { 
    opacity: 0;
    width: 0;
    height: 0;
}

/* 3. æ»‘å—è½¨é“ (èƒŒæ™¯) */
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #e9e9ea; /* é»˜è®¤ç°è‰² (å…³é—­çŠ¶æ€) */
    transition: .4s;
    border-radius: 34px; /* åœ†è§’èƒ¶å›Š */
}

/* æ·±è‰²æ¨¡å¼ä¸‹çš„è½¨é“èƒŒæ™¯ */
@media (prefers-color-scheme: dark) {
    .slider { background-color: #39393d; }
}

/* 4. æ»‘å—åœ†é’® (ä¸­é—´é‚£ä¸ªç™½åœ†åœˆ) */
.slider:before {
    position: absolute;
    content: "";
    height: 27px;
    width: 27px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%; /* æ­£åœ† */
    box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 3px 1px rgba(0,0,0,0.06); /* é˜´å½±å¢åŠ ç«‹ä½“æ„Ÿ */
}

/* 5. æ¿€æ´»çŠ¶æ€ (å¼€å¯) */
input:checked + .slider {
    background-color: #34C759; /* iOS å®˜æ–¹ç»¿ */
}

/* 6. æ¿€æ´»æ—¶çš„åœ†é’®ç§»åŠ¨åŠ¨ç”» */
input:checked + .slider:before {
    transform: translateX(20px);
}
/* =========================================================
   ğŸ“ iOS åˆ—è¡¨åº•éƒ¨æ³¨é‡Šæ ·å¼
   ========================================================= */

.ios-list-note {
    font-size: 13px;          /* æ ‡å‡†æ³¨é‡Šå­—å· */
    color: #8e8e93;           /* iOS æ ‡å‡†æ¬¡çº§ç°è‰² */
    margin-top: 8px;          /* ç¦»ä¸Šé¢çš„å¼€å…³ç¨å¾®è¿œä¸€ç‚¹ */
    margin-bottom: 15px;      /* ç¦»åº•éƒ¨ç•™ç™½ */
    padding: 0 16px;          /* å·¦å³å¯¹é½ç¼©è¿›ï¼Œå’Œä¸Šé¢çš„åˆ—è¡¨å†…å®¹å¯¹é½ */
    line-height: 1.4;         /* å¢åŠ è¡Œé«˜ï¼Œé˜²æ­¢å¤šè¡Œæ–‡å­—æŒ¤åœ¨ä¸€èµ· */
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
@media (prefers-color-scheme: dark) {
    .ios-list-note {
        color: #98989d;       /* æ·±è‰²æ¨¡å¼ä¸‹ç¨å¾®äº®ä¸€ç‚¹çš„ç° */
    }
}
/* --- ğŸ–¼ï¸ ç›¸å†Œ App ä¸»ä½“ --- */
#app-photos {
    background: var(--bg-color); /* è·Ÿéšç³»ç»Ÿé»‘ç™½æ¨¡å¼ */
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
    color: var(--text-color);
}

/* é¡¶éƒ¨æ  */
.photos-header {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    font-weight: 600;
    font-size: 17px;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(20px);
    z-index: 10;
    position: sticky;
    top: 0;
}
.dark-mode .photos-header { background: rgba(0,0,0,0.8); }

.photos-add-btn { cursor: pointer; color: #007AFF; }

/* å†…å®¹ç½‘æ ¼ (1:1 ç¼©ç•¥å›¾) */
.photos-content-area {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 80px; /* ç»™åº•éƒ¨å¯¼èˆªç•™ä½ç½® */
}

.photos-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3åˆ— */
    gap: 2px; /* æç»†é—´è·ï¼Œç±»ä¼¼ iOS */
}

.photo-item {
    aspect-ratio: 1 / 1; /* å¼ºåˆ¶æ­£æ–¹å½¢ */
    background: #eee;
    overflow: hidden;
    position: relative;
    cursor: pointer;
}
.photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* è£å‰ªå¡«å…… */
    transition: transform 0.3s;
}
.photo-item:active img { transform: scale(0.95); opacity: 0.8; }

/* åº•éƒ¨æ‚¬æµ®å¯¼èˆª (èƒ¶å›Š) */
.photos-bottom-nav-container {
    position: absolute;
    bottom: 30px;
    left: 0; 
    right: 0;
    display: flex;
    justify-content: center;
    z-index: 20;
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç©ºç™½å¤„ */
}
.photos-bottom-capsule {
    pointer-events: auto;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(20px);
    padding: 6px;
    border-radius: 30px;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 0.5px solid rgba(0,0,0,0.1);
}
.dark-mode .photos-bottom-capsule {
    background: rgba(30,30,30,0.85);
    border-color: rgba(255,255,255,0.1);
}

.photos-bottom-capsule .nav-item {
    padding: 8px 24px;
    font-size: 13px;
    font-weight: 600;
    color: #999;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
}
.photos-bottom-capsule .nav-item.active {
    background: #000;
    color: #fff;
}
.dark-mode .photos-bottom-capsule .nav-item.active {
    background: #fff;
    color: #000;
}

/* --- ğŸ“¤ ä¸Šä¼ å¼¹çª—æ ·å¼ --- */
.upload-preview-container {
    width: 100%;
    min-height: 200px;
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 15px;
    position: relative;
}
#upload-img-preview {
    width: 100%;
    height: auto;
    display: block;
}
#upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #999;
    gap: 8px;
    font-size: 13px;
}
.photo-text-area {
    width: 100%;
    height: 80px;
    border: none;
    background: rgba(0,0,0,0.05);
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    resize: none;
    margin-bottom: 15px;
    color: inherit;
}
.photo-setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    padding: 10px 0;
    border-top: 0.5px solid rgba(0,0,0,0.1);
}

/* --- ğŸ–¼ï¸ é«˜å®šå¡ç‰‡æ ·å¼ --- */
.ios-fullscreen-modal {
    position: relative; /* ç›¸å¯¹äº mask å±…ä¸­ */
    width: 92%;
    max-width: 400px;
    height: 82vh;
    background: #ffffff;
    z-index: 10001;
    border-radius: 38px;
    box-shadow: 0 40px 100px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: translateY(50px) scale(0.9);
    transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}
.dark-mode .ios-fullscreen-modal { background: #000; }

/* è¿›åœºåŠ¨ç”»ï¼šç”±å°å˜å¤§å¹¶å‡èµ· */
@keyframes cardPopIn {
    from { opacity: 0; transform: scale(0.9) translateY(40px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* è°ƒæ•´è¯¦æƒ…é¡µçš„é¡¶æ ï¼Œè®©å®ƒæ›´åƒå¡ç‰‡çš„å¤´éƒ¨ */
.detail-top-bar {
    height: 55px;
    padding: 0 20px;
    border-bottom: 0.5px solid rgba(0,0,0,0.05);
    background: #fff;
    border-radius: 30px 30px 0 0; /* å¤´éƒ¨åœ†è§’åŒæ­¥ */
}
.dark-mode .detail-top-bar { background: rgba(0,0,0,0.9); }

.detail-scroll-content {
    flex: 1;
    overflow-y: auto;
}
/* è¯¦æƒ…å›¾ç‰‡åŒºåŸŸå¾®è°ƒï¼Œé˜²æ­¢æ’‘ç ´åœ†è§’ */
.detail-img-wrapper {
    width: 100%;
    background: #f2f2f7;
    max-height: 45vh; /* é™åˆ¶å›¾ç‰‡é«˜åº¦ï¼Œç»™è¯„è®ºåŒºç•™ç©ºé—´ */
}
.detail-img-wrapper img {
    width: 100%;
    height: auto;
    max-height: 500px;
    object-fit: contain;
}

.detail-info-section {
    padding: 16px;
}
.detail-user-desc {
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 15px;
}
.name-tag { font-weight: 700; margin-right: 6px; }

.detail-action-bar {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 0.5px solid rgba(0,0,0,0.1);
    color: #666;
    font-size: 13px;
}
.detail-action-bar .act-item {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

/* è¯„è®ºåŒº */
.comment-row {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
    font-size: 13px;
}
.comment-avatar {
    width: 32px; height: 32px;
    border-radius: 50%;
    object-fit: cover;
}
.comment-bubble {
    background: rgba(0,0,0,0.05);
    padding: 8px 12px;
    border-radius: 12px;
    border-top-left-radius: 2px;
    flex: 1;
}
.dark-mode .comment-bubble { background: rgba(255,255,255,0.1); }

.comment-name { font-weight: 700; margin-bottom: 2px; font-size: 12px; opacity: 0.8; }
.comment-time { font-size: 10px; opacity: 0.5; float: right; }

/* åº•éƒ¨è¾“å…¥æ¡† */
.detail-input-bar {
    height: 50px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-top: 0.5px solid rgba(0,0,0,0.1);
    background: var(--bg-color);
}
.detail-input-bar input {
    flex: 1;
    height: 36px;
    border-radius: 18px;
    border: 0.5px solid rgba(0,0,0,0.1);
    padding: 0 12px;
    background: rgba(0,0,0,0.05);
    color: inherit;
}
.send-icon {
    width: 30px; height: 30px;
    background: #007AFF;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
}

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
/* --- ğŸ­ é«˜çº§å¤´åƒé€‰æ‹©å™¨æ ·å¼ --- */

/* å®¹å™¨ï¼šæ¨ªå‘æ’åˆ—ï¼Œå…è®¸æ»‘åŠ¨ */
.char-selector-scroll {
    display: flex;
    gap: 15px; /* å¤´åƒä¹‹é—´çš„é—´è· */
    overflow-x: auto; /* å…è®¸æ¨ªå‘æ»‘åŠ¨ */
    padding: 10px 5px 20px 5px; /* ç•™å‡ºé˜´å½±ç©ºé—´ */
    scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ (Firefox) */
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨ */
}
.char-selector-scroll::-webkit-scrollbar { display: none; } /* éšè—æ»šåŠ¨æ¡ (Chrome/Safari) */

/* å•ä¸ªé€‰é¡¹ï¼šé»˜è®¤å˜ç° */
.char-select-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    opacity: 0.5; /* ğŸ‘» é»˜è®¤åŠé€æ˜ï¼ˆå˜ç°ï¼‰ */
    filter: grayscale(100%); /* ğŸ–¤ é»˜è®¤é»‘ç™½ */
    transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    cursor: pointer;
    min-width: 60px; /* ä¿è¯ç‚¹å‡»åŒºåŸŸ */
}

/* é€‰ä¸­çŠ¶æ€ï¼šå˜äº®ã€ä¸Šæµ®ã€å½©è‰² */
.char-select-item.active {
    opacity: 1; /* ğŸ’¡ å˜äº® */
    filter: grayscale(0%); /* ğŸŒˆ æ¢å¤å½©è‰² */
    transform: translateY(-5px) scale(1.05); /* ä¸Šæµ® + æ”¾å¤§ */
}

/* å¤´åƒå®¹å™¨ */
.char-select-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid transparent; /* é¢„ç•™è¾¹æ¡† */
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    transition: all 0.3s;
}

/* é€‰ä¸­æ—¶çš„å¤´åƒå…‰åœˆ */
.char-select-item.active .char-select-avatar {
    border-color: #007AFF; /* ğŸ”µ iOS è“åœˆ */
    box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3); /* è“è‰²è¾‰å…‰ */
}

/* åå­—æ–‡å­— */
.char-select-name {
    font-size: 11px;
    color: #1d1d1f;
    font-weight: 500;
    text-align: center;
    width: 64px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* é•¿åå­—è‡ªåŠ¨çœç•¥å· */
}
/* é€‰ä¸­æ—¶æ–‡å­—åŠ ç²—å˜è“ */
.char-select-item.active .char-select-name {
    color: #007AFF;
    font-weight: 700;
}

/* --- ğŸ’ é«˜çº§å¡ç‰‡æ ·å¼ --- */
#modal-photo-detail {
    position: relative;
    width: 92%;
    max-width: 400px;
    height: 82vh;
    background: rgba(255, 255, 255, 0.95); /* å¾®å¾®é€è‰² */
    border-radius: 38px; /* æ›´åœ†æ¶¦çš„è¾¹ç¼˜ */
    box-shadow: 0 30px 100px rgba(0,0,0,0.4); /* æ·±é‚ƒé˜´å½± */
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: iosPop 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.2); /* ç‰©ç†å¼¹æ€§å¼¹å‡º */
}

@keyframes iosPop {
    from { opacity: 0; transform: scale(0.9) translateY(40px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* --- ğŸ› ï¸ æ‚¬æµ®å·¥å…·æŒ‰é’® --- */
.card-float-tools {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 12px;
    z-index: 100;
}

.tool-circle-btn {
    width: 40px; height: 40px;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #1d1d1f;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.2s;
    border: 0.5px solid rgba(255,255,255,0.2);
}

.tool-circle-btn:active { transform: scale(0.9); opacity: 0.7; }
.tool-circle-btn.btn-delete-red { color: #FF3B30; }

/* å†…éƒ¨æ»šåŠ¨ä¸å›¾ç‰‡ */
.detail-img-wrapper { width: 100%; max-height: 50%; overflow: hidden; }
.detail-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
.detail-scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
/* --- ğŸ–¤ é®ç½©å±‚ï¼šæ›´è‡ªç„¶çš„æ™¯æ·± --- */
.photo-detail-mask {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(15px) saturate(150%);
    -webkit-backdrop-filter: blur(15px) saturate(150%);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.photo-detail-mask.active { opacity: 1; }
/* --- ğŸ’ æ‚å¿—æ„Ÿå¡ç‰‡æœ¬ä½“ (ç‰©ç†åŠ å›ºç‰ˆ) --- */
.ios-card-viewer {
    position: relative; 
    width: 90%;
    max-width: 400px;
    height: 82vh;
    background: #fff;
    border-radius: 40px; 
    overflow: hidden;
    box-shadow: 0 40px 100px rgba(0,0,0,0.5);
    
    /* ğŸš¨ åˆå§‹çŠ¶æ€è®¾ä¸ºä¸å¯è§ */
    display: none; 
    flex-direction: column;
    
    /* ğŸš¨ åˆå§‹ç¼©æ”¾è®¾ä¸º 0.85 */
    transform: scale(0.85) translateY(60px);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.18, 1, 0.32, 1.1);
}

/* ğŸš¨ æ¿€æ´»æ€ï¼šå¼ºåˆ¶æ˜¾ç¤ºå¹¶æ¢å¤æ¯”ä¾‹ */
.photo-detail-mask.active .ios-card-viewer {
    display: flex !important; /* å¼ºåˆ¶å˜ä¸º Flex å¸ƒå±€ */
    transform: scale(1) translateY(0);
    opacity: 1;
}

/* æ‚¬æµ®å·¥å…·æ  */
.card-header-tools {
    position: absolute;
    top: 20px; left: 0; right: 0;
    padding: 0 20px;
    display: flex; justify-content: space-between; align-items: center;
    z-index: 100;
}
.tool-btn-back { color: #fff; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); cursor: pointer; }
.card-actions-group { display: flex; gap: 12px; }
.tool-btn-circle {
    width: 38px; height: 38px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; border: 0.5px solid rgba(255,255,255,0.3);
}
.tool-btn-circle.danger { color: #FF3B30; }

/* å†…å®¹å¸ƒå±€ */
.card-main-scroller { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.card-hero-img { width: 100%; min-height: 300px; background: #000; }
.card-hero-img img { width: 100%; height: 100%; object-fit: cover; }

.card-content-body { padding: 25px; }
.user-info-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
.user-name { font-size: 22px; font-weight: 800; color: #1d1d1f; }
.post-time { font-size: 12px; color: #8E8E93; font-weight: 600; }
.post-desc { font-size: 16px; line-height: 1.6; color: #3a3a3c; margin-bottom: 30px; }
.comment-section-title { font-size: 11px; font-weight: 800; color: #8E8E93; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 20px; }

/* åº•éƒ¨è¾“å…¥æ¡† */
.card-input-bar {
    position: absolute; bottom: 0; left: 0; width: 100%;
    padding: 15px 20px 35px; /* åº•éƒ¨é¢„ç•™å®‰å…¨åŒº */
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(20px);
    display: flex; align-items: center; gap: 12px;
}
.card-input-bar input {
    flex: 1; height: 44px; background: #F2F2F7; border-radius: 22px;
    border: none; padding: 0 18px; font-size: 15px; outline: none;
}
.send-btn-circle {
    width: 44px; height: 44px; background: #007AFF; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
}
/* --- ğŸ—“ï¸ ç›¸å†Œæ—¶é—´è½´æ ·å¼ --- */
.photos-timeline-section {
    margin-bottom: 30px;
}
.timeline-header {
    padding: 15px 16px 10px;
    font-size: 20px;
    font-weight: 800;
    color: #1d1d1f;
    display: flex;
    align-items: baseline;
    gap: 8px;
}
.timeline-header span {
    font-size: 13px;
    color: #8E8E93;
    font-weight: 600;
}

/* --- ğŸ–¼ï¸ ç‰©ç†ç½®é¡¶ï¼šå…¨å±å¤§å›¾æµè§ˆå™¨ --- */
#photo-fullscreen-browser {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 100000; /* ğŸš¨ ç»å¯¹æœ€é«˜å±‚çº§ï¼Œç›–è¿‡ä¸€åˆ‡ */
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#photo-fullscreen-browser.active {
    display: flex;
    opacity: 1;
}
.fullscreen-img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
}
.close-fullscreen {
    position: absolute;
    top: 60px; right: 25px;
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; cursor: pointer;
}
/* --- ğŸ­ Taçš„ç›¸å†Œï¼šé¡¶çº§ç”»å»Šé•¿è½´å¡ç‰‡ --- */
.char-gallery-card {
    position: relative;
    width: 100%;
    height: 200px;
    margin-bottom: 25px;
    border-radius: 32px;
    background: #000;
    overflow: visible; /* ğŸš¨ å…è®¸é˜´å½±æº¢å‡º */
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
}

/* æ¨¡æ‹Ÿå¤šå±‚ç›¸å†Œå †å æ„Ÿ (è£…é¥°åº•å±‚) */
.char-gallery-card::after {
    content: "";
    position: absolute;
    bottom: -8px; left: 5%; right: 5%;
    height: 20px;
    background: rgba(255,255,255,0.3);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    z-index: -1;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

/* æ ¸å¿ƒå®¹å™¨ */
.gallery-inner-container {
    position: relative;
    width: 100%; height: 100%;
    border-radius: 32px;
    overflow: hidden;
    z-index: 2;
}

/* èƒŒæ™¯å¤§å›¾ï¼šé«˜å¯¹æ¯”åº¦ç”µå½±æ„Ÿ */
.gallery-card-bg {
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center 20%;
    filter: brightness(0.8) contrast(1.1);
    transition: transform 0.6s ease;
}

.char-gallery-card:hover .gallery-card-bg {
    transform: scale(1.08);
}

/* é¡¶éƒ¨ï¼šç²¾è‡´è§’æ ‡ */
.gallery-top-info {
    position: absolute;
    top: 20px; left: 20px; right: 20px;
    display: flex; justify-content: space-between;
    z-index: 5;
}

.gallery-type-tag {
    font-size: 9px;
    font-weight: 900;
    color: rgba(255,255,255,0.6);
    letter-spacing: 2px;
    text-transform: uppercase;
}

/* åº•éƒ¨ï¼šæ¯›ç»ç’ƒä¿¡æ¯èˆ± */
.gallery-info-pod {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    padding: 20px 25px;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
}

.gallery-char-name {
    font-family: 'Cinzel', serif; /* ä½¿ç”¨é«˜çº§è¡¬çº¿ä½“ */
    font-size: 26px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 15px rgba(0,0,0,0.5);
}

/* ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šåŠ¨æ€è®¡æ•°èŠ¯ç‰‡ */
.gallery-stat-chip {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 0.5px solid rgba(255,255,255,0.3);
    padding: 6px 14px;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-num {
    font-size: 14px;
    font-weight: 900;
    color: #fff;
    line-height: 1;
}

.stat-label {
    font-size: 8px;
    font-weight: 800;
    color: rgba(255,255,255,0.5);
    letter-spacing: 1px;
    margin-top: 2px;
}
/* --- ğŸ›ï¸ è§’è‰²ç›¸å†Œå±•å…ï¼šé«˜çº§æ’ç‰ˆ --- */
.gallery-viewer-window {
    background: #F2F2F7;
    z-index: 12000;
}

/* é¡¶éƒ¨èµ„æ–™å¡ */
.gallery-header-profile {
    padding: 60px 25px 30px;
    background: #fff;
    border-radius: 0 0 40px 40px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    text-align: center;
}
.header-char-name { font-family: 'Cinzel', serif; font-size: 28px; font-weight: 800; color: #000; }
.header-char-bio { font-size: 13px; color: #8E8E93; line-height: 1.6; margin-top: 10px; padding: 0 20px; }

/* ğŸ•¹ï¸ æ§åˆ¶å°æŒ‰é’®ç»„ */
.gallery-console {
    display: flex; gap: 15px; padding: 25px 20px;
}
.console-btn-luxe {
    flex: 1; height: 100px;
    background: #fff; border-radius: 24px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 8px; border: 1px solid rgba(0,0,0,0.03);
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}
.console-btn-luxe:active { transform: scale(0.95); background: #f2f2f7; }
.console-btn-luxe svg { color: #007AFF; }
.console-btn-luxe span { font-size: 10px; font-weight: 800; letter-spacing: 1px; color: #1d1d1f; }

/* --- ğŸï¸ æ‹ç«‹å¾—ï¼šæè‡´è‰ºæœ¯ç”»æ¡† --- */
.ai-portrait-frame {
    width: 100%;
    aspect-ratio: 3 / 4;
    background: #ffffff; /* ç»å…¸ç›¸çº¸ç™½ */
    padding: 15px 15px 60px 15px; /* åº•éƒ¨ç•™ç™½ç”¨äºæ‰‹å†™ä½“ */
    border-radius: 4px; /* æ‹ç«‹å¾—é€šå¸¸æ˜¯å¾®åœ†è§’æˆ–ç›´è§’ */
    box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
    margin-bottom: 25px;
}

/* å†…éƒ¨çœŸæ­£çš„â€œåº•ç‰‡â€åŒºåŸŸ */
.ai-prose-overlay {
    width: 100%;
    height: 100%;
    background: #1a1a1a; /* åº•ç‰‡è‰² */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #fff;
    border-radius: 2px;
}

/* åº•éƒ¨æ‰‹å†™ä½“ä½ç½® */
.ai-portrait-frame::after {
    content: "POLAROID MOMENT";
    position: absolute;
    bottom: 20px;
    left: 0;
    width: 100%;
    text-align: center;
    font-family: 'Dancing Script', cursive; /* å»ºè®®åœ¨é¡¶éƒ¨å¯¼å…¥æ­¤å­—ä½“ */
    font-size: 18px;
    color: #333;
    opacity: 0.6;
}

/* --- ğŸ–¼ï¸ ç¼©ç•¥å›¾ï¼šè¿·ä½ æ‹ç«‹å¾—ç½‘æ ¼ --- */
.char-history-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* æ”¹ä¸º2åˆ—ï¼Œæ›´æœ‰æ’ç‰ˆæ„Ÿ */
    gap: 20px;
    padding: 20px;
}

.history-thumb {
    background: #fff;
    padding: 8px 8px 30px 8px; /* åº•éƒ¨ç•™ç™½å†™å­— */
    border-radius: 2px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: transform 0.3s ease;
    cursor: pointer;
    position: relative;
}

.history-thumb:hover { transform: rotate(-2deg) scale(1.05); }

.history-thumb-img {
    width: 100%;
    aspect-ratio: 1/1; /* ç¼©ç•¥å›¾ç”¨ 1:1 çš„å†…æ¡† */
    background: #eee;
    object-fit: cover;
    display: block;
}

/* ç¼©ç•¥å›¾ä¸‹æ–¹çš„å¾®å‹æè¿° */
.thumb-caption {
    position: absolute;
    bottom: 8px;
    left: 8px;
    right: 8px;
    font-size: 10px;
    color: #999;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºçœç•¥å· */
    text-align: center;
    font-style: italic;
}

/* ğŸŒ€ æ‰«æåŠ¨ç”» */
.scanning-line {
    position: absolute; top: 0; left: 0; width: 100%; height: 2px;
    background: #007AFF; box-shadow: 0 0 15px #007AFF;
    animation: scanMove 2s infinite linear;
    z-index: 10; display: none;
}
@keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
/* --- ğŸ­ Taçš„ç›¸å†Œï¼šæ²‰æµ¸å¼è‰ºæœ¯è§†ç•Œ (éš”ç¦»ä¿®æ­£ç‰ˆ) --- */
#modal-theirs-photo-detail {
    position: fixed !important; 
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000; /* é»‘è‰²åº•è‰²ï¼Œé˜²æ­¢é€å‡ºæ¡Œé¢ */
    z-index: 100000;  /* ğŸš¨ æå…¶é‡è¦ï¼šå¿…é¡»é«˜äºæ‰€æœ‰ä¸»é¡µç»„ä»¶ */
    display: none;
    flex-direction: column;
    overflow: hidden;
}

@keyframes theirsFadeIn {
    from { opacity: 0; transform: scale(1.1); }
    to { opacity: 1; transform: scale(1); }
}

/* é®ç½©å±‚èƒŒæ™¯ï¼šç¡®ä¿åªæ˜¾ç¤ºè§’è‰²çš„å…‰å½± */
.theirs-detail-bg-blur {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(50px) brightness(0.4); /* å¢åŠ æ¨¡ç³Šåº¦å’Œæš—åº¦ */
    z-index: 1;
}

/* æ»šåŠ¨åŒºåŸŸï¼šé¿å¼€é¡¶éƒ¨çŠ¶æ€æ å’Œåº•éƒ¨è¾“å…¥æ¡† */
.theirs-detail-scroller {
    position: relative;
    z-index: 10;
    flex: 1;
    overflow-y: auto;
    padding: 80px 20px 150px; /* ğŸš¨ å¢åŠ é—´è·ï¼Œç¡®ä¿å†…å®¹ä¸è¢«è¦†ç›– */
    -webkit-overflow-scrolling: touch;
}

/* ğŸš¨ ç‰©ç†ä¿®å¤ï¼šè¾“å…¥æ¡†ç½®é¡¶æ‚¬æµ® */
#modal-theirs-photo-detail .card-input-bar {
    position: fixed !important;
    bottom: 0 !important;
    left: 0 !important;
    width: 100% !important;
    z-index: 110000 !important; /* æ¯”è¯¦æƒ…é¡µæ›´é«˜ */
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(20px);
    padding: 15px 20px 35px !important;
    display: flex !important;
}

/* 3:4 æ–‡å­—å†™çœŸï¼šé«˜çº§çº¸è´¨æ„Ÿ */
.theirs-portrait-card {
    width: 100%;
    aspect-ratio: 3 / 4;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 24px;
    padding: 40px 30px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    position: relative;
}

.theirs-prose-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 18px;
    line-height: 2.2;
    color: #1d1d1f;
    font-style: italic;
    white-space: pre-wrap;
}

/* åº•éƒ¨äº¤äº’åŒºï¼šç™½è‰²åŠé€æ˜é®ç½© */
.theirs-interaction-pod {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 32px 32px 0 0;
    padding: 25px;
    margin-top: -30px;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
}
/* --- ğŸ­ Taçš„ç›¸å†Œè¯¦æƒ…ï¼šæè‡´ç»“æ„ä¼˜åŒ– --- */

/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šå“ç‰ŒåŒ–æ¡£æ¡ˆç•Œé¢ --- */
#modal-footprints {
    position: fixed; inset: 0;
    background: #0c0c0c; /* æ›´æ·±é‚ƒçš„çº¯é»‘åº• */
    z-index: 16000; display: none;
    flex-direction: column;
    /* æ·»åŠ å¾®å¼±çš„æ•°ç å™ªç‚¹çº¹ç†ï¼Œå¢åŠ è´¨æ„Ÿ */
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
}

/* å¤´éƒ¨å“ç‰Œæ  */
.footprints-header {
    position: absolute; top: 0; left: 0; width: 100%;
    padding: 20px 25px;
    display: flex; justify-content: space-between; align-items: center;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
    z-index: 10;
}

.brand-title {
    font-family: 'Montserrat', sans-serif; /* å»ºè®®ç”¨æ— è¡¬çº¿ä½“å¢åŠ ç°ä»£æ„Ÿ */
    font-weight: 800; font-size: 16px; color: #fff;
    letter-spacing: 4px; text-transform: uppercase;
    display: flex; align-items: center; gap: 10px;
}
.brand-title::before {
    content: ""; display: block; width: 8px; height: 8px;
    background: #007AFF; border-radius: 50%; box-shadow: 0 0 10px #007AFF;
}

.close-archive-btn {
    font-size: 12px; font-weight: 700; color: rgba(255,255,255,0.6);
    cursor: pointer; letter-spacing: 1px; padding: 10px;
    border: 1px solid rgba(255,255,255,0.2); border-radius: 20px;
    transition: all 0.3s;
}
.close-archive-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #fff; }

/* æ»šåŠ¨åŒºåŸŸä¸èƒ¶ç‰‡è½¨é“ */
.footprints-scroller {
    flex: 1; overflow-y: auto; padding: 100px 0 150px;
    /* ä¼˜åŒ–èƒ¶ç‰‡é½¿å­”è½¨é“ï¼šæ›´ç²¾è‡´ */
    background-image: 
        radial-gradient(circle, rgba(255,255,255,0.1) 30%, transparent 31%),
        radial-gradient(circle, rgba(255,255,255,0.1) 30%, transparent 31%);
    background-size: 16px 32px;
    background-position: 15px 0, calc(100% - 15px) 0;
    background-repeat: repeat-y;
    border-left: 1px solid rgba(255,255,255,0.05);
    border-right: 1px solid rgba(255,255,255,0.05);
    margin: 0 10px; /* è½¨é“å†…ç¼© */
}

/* æ¡£æ¡ˆå•å…ƒæ ¼ (æ–°çš„ AI æ€»ç»“æ ·å¼) */
.archive-cell {
    margin: 40px 35px; position: relative;
    background: rgba(20,20,20,0.8);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; padding: 25px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

/* å·¦ä¾§æ—¶é—´æˆ³ - ç§‘æŠ€æ„Ÿ */
.archive-timestamp {
    position: absolute; left: -55px; top: 20px;
    writing-mode: vertical-lr; transform: rotate(180deg);
    font-family: 'Courier New', monospace; font-size: 10px;
    color: #007AFF; letter-spacing: 3px; opacity: 0.8;
}

/* AI æ€»ç»“æ–‡æœ¬ */
.archive-summary-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.9);
    font-style: italic; text-align: justify;
}

/* åº•éƒ¨å“ç‰Œæ ‡è¯† */
.footprints-footer {
    position: absolute; bottom: 40px; width: 100%; text-align: center;
    font-family: monospace; font-size: 9px; color: rgba(255,255,255,0.3);
    letter-spacing: 6px; pointer-events: none;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
/* --- ğŸï¸ AI å¿ƒåƒåº•ç‰‡æ ·å¼ --- */

/* å¤ç”¨èƒ¶ç‰‡å¤–æ¡†ï¼Œå¢åŠ å†…éƒ¨å¸ƒå±€ */
.ai-visual-frame {
    background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 25px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.08);
}

/* å¢åŠ ä¸€ç‚¹åº•ç‰‡çš„é¢—ç²’è´¨æ„Ÿ */
.ai-visual-frame::before {
    content: ""; position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='[http://www.w3.org/2000/svg'%3E%3Cfilter](http://www.w3.org/2000/svg'%3E%3Cfilter) id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.08'/%3E%3C/svg%3E");
    pointer-events: none;
    mix-blend-mode: overlay;
}

/* é¡¶éƒ¨å°å›¾æ ‡å’Œæ ‡é¢˜ */
.ai-visual-icon {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 20px; opacity: 0.6;
}
.ai-visual-icon span {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
}

/* AI ç”Ÿæˆçš„æ ¸å¿ƒæè¿°æ–‡å­— */
.ai-visual-text {
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px; line-height: 1.6;
    color: rgba(255,255,255,0.9);
    text-align: center; font-style: italic;
    padding: 0 20px;
}
/* ğŸš¨ ç‰©ç†ä¿®æ­£ï¼šå¼ºåŠ›å‹ä½æ ‡é¢˜æ ï¼Œé¿å¼€çŠ¶æ€æ  */
#modal-footprints .footprints-header {
    /* å¢åŠ é¡¶éƒ¨é—´è·ï¼š65px æ˜¯é¿å¼€åˆ˜æµ·å±/çŠ¶æ€æ çš„é»„é‡‘é«˜åº¦ */
    padding-top: 65px !important; 
    height: auto !important;
    padding-bottom: 20px !important;
    background: linear-gradient(to bottom, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 70%, transparent 100%) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding-left: 25px !important;
    padding-right: 25px !important;
}

/* ä¿®æ­£å…³é—­æŒ‰é’®çš„å‚ç›´å¯¹é½ï¼Œç¡®ä¿å®ƒè·Ÿæ ‡é¢˜åœ¨ä¸€æ¡çº¿ä¸Š */
#modal-footprints .close-archive-btn {
    margin-top: 0 !important; 
    transform: translateY(0) !important;
}

/* ğŸš¨ é‡ç‚¹ï¼šèƒ¶ç‰‡å†…å®¹åŒºä¹Ÿå¿…é¡»åŒæ­¥ä¸‹ç§»ï¼Œå¦åˆ™ä¼šé’»åˆ°æ ‡é¢˜æ ä¸‹é¢ */
#modal-footprints .footprints-scroller {
    padding-top: 150px !important; /* ç¡®ä¿ç¬¬ä¸€æ ¼èƒ¶ç‰‡ä»æ ‡é¢˜ä¸‹æ–¹å¼€å§‹ */
}
/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šå“ç‰Œçº§ UI ä¿®æ­£ --- */

/* 1. é¡¶éƒ¨é¿è®©ç³»ç»ŸçŠ¶æ€æ  */
#modal-footprints .footprints-header {
    padding-top: 65px !important; /* å¼ºåˆ¶ä¸‹å‹ï¼Œé¿å¼€ç”µé‡å’Œæ—¶é—´ */
    background: linear-gradient(to bottom, #0c0c0c 80%, transparent) !important;
}

/* 2. æ—¶é—´è½´æ–‡å­—ï¼šç¾åŒ–ä¸ºè“è‰²éœ“è™¹åˆ»åº¦ */
.film-time-axis {
    position: absolute !important;
    left: 12px !important; /* é å·¦å¯¹é½ */
    top: 0 !important;
    font-family: 'Courier New', monospace !important;
    font-size: 12px !important;
    font-weight: 900 !important;
    color: #007AFF !important; /* ç»å…¸ iOS è“è‰² */
    text-shadow: 0 0 8px rgba(0,122,255,0.8) !important; /* å¢åŠ å‘å…‰æ„Ÿ */
    letter-spacing: 1px !important;
    opacity: 1 !important;
}

/* 3. èƒ¶ç‰‡å¡ç‰‡ï¼šå¼ºåˆ¶åµŒå…¥è½¨é“ä¸­å¿ƒ */
.film-frame {
    padding: 0 45px !important; /* å·¦å³ç•™å‡ºèƒ¶ç‰‡é½¿å­”çš„ä½ç½® */
    margin-bottom: 60px !important;
}

.ai-visual-frame {
    background: rgba(25, 25, 25, 0.95) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    padding: 30px 20px !important;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 10px 30px rgba(0,0,0,0.5) !important;
    width: 100% !important;
    position: relative !important;
}

/* 4. å¡ç‰‡å†…æ–‡å­—æè¿°ç¾åŒ– */
.ai-visual-text {
    font-family: 'Cormorant Garamond', serif !important;
    font-size: 16px !important;
    line-height: 1.8 !important;
    color: #e5e5e5 !important;
    font-style: italic !important;
    text-align: justify !important;
    margin-top: 15px !important;
}

/* 5. é¡¶éƒ¨çš„ MEMORIZED TRACE è£…é¥° */
.ai-visual-icon {
    border-bottom: 1px solid rgba(0, 122, 255, 0.3) !important;
    padding-bottom: 10px !important;
    margin-bottom: 15px !important;
    justify-content: flex-start !important;
}

.ai-visual-icon span {
    color: #007AFF !important;
    font-size: 9px !important;
    font-weight: 800 !important;
    letter-spacing: 3px !important;
}
/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šä¼‘æ¯çŠ¶æ€ä¸“å±æ ·å¼ --- */

/* ä¼‘æ¯çŠ¶æ€çš„å¡ç‰‡ï¼šè‰²è°ƒæ›´æš—ï¼Œå¸¦ä¸€ç‚¹ç´«è‰²çš„æ¢¦å¹»æ„Ÿ */
.ai-visual-frame.resting-mode {
    background: linear-gradient(135deg, #0f0f12 0%, #050505 100%) !important;
    border: 1px dashed rgba(255, 255, 255, 0.05) !important; /* è™šçº¿è¾¹æ¡†è¡¨ç¤ºéæ´»è·ƒ */
    opacity: 0.7;
}

/* ä¼‘æ¯çŠ¶æ€çš„æ—¶é—´è½´ï¼šç°è‰²åˆ»åº¦ */
.resting-mode .film-time-axis {
    color: #8E8E93 !important;
    text-shadow: none !important;
}

/* ä¼‘æ¯çŠ¶æ€çš„æ ‡ç­¾ */
.resting-mode .ai-visual-icon span {
    color: #8E8E93 !important;
}

.resting-mode .ai-visual-icon svg {
    stroke: #8E8E93 !important;
}

/* ä¼‘æ¯çŠ¶æ€çš„æ–‡å­—ï¼šæ›´æ¨¡ç³Šã€æ›´è½»æŸ” */
.resting-mode .ai-visual-text {
    color: rgba(255, 255, 255, 0.4) !important;
    filter: blur(0.3px);
}
/* --- ğŸï¸ æ—¶ç©ºè¶³è¿¹ï¼šå­˜æ¡£æŒ‰é’®ç¾åŒ– --- */

.footprints-header-btns {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* ä¿å­˜æŒ‰é’®ï¼šå¸¦å‘¼å¸æ„Ÿçš„è“è‰²è¾¹æ¡† */
.save-archive-btn {
    font-size: 10px;
    font-weight: 800;
    color: #007AFF;
    letter-spacing: 2px;
    padding: 8px 15px;
    border: 1px solid rgba(0,122,255,0.4);
    border-radius: 20px;
    cursor: pointer;
    display: none; /* é»˜è®¤éšè—ï¼Œç”Ÿæˆåæ˜¾ç¤º */
    transition: all 0.3s;
}

.save-archive-btn.active {
    background: #007AFF;
    color: #fff;
    border-color: #007AFF;
    box-shadow: 0 0 15px rgba(0,122,255,0.4);
}

/* å­˜æ¡£æ ‡è®°ï¼šå¡ç‰‡å³ä¸Šè§’çš„å·²ä¿å­˜å›¾æ ‡ */
.saved-tag {
    position: absolute;
    top: 15px;
    right: 15px;
    opacity: 0.3;
}

/* =========================================================
   ğŸš¨ æ‹ç«‹å¾—å¼¹çª—ï¼šç‰©ç†éš”ç¦»å±‚ (è§£å†³é€è§†ä¸»é¡µé—®é¢˜)
   ========================================================= */

/* 1. å¤–å±‚å®¹å™¨ï¼šå…¨å±é»‘åº•ç£¨ç ‚ï¼ŒæŒ¡ä½åé¢ä¹±ä¸ƒå…«ç³Ÿçš„æ¡Œé¢ */
#modal-footprint-single-detail {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    
    /* ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ·±è‰²ä¸é€æ˜èƒŒæ™¯ï¼Œå½»åº•æŒ¡ä½ä¸»é¡µ */
    background: rgba(10, 10, 10, 0.95) !important; 
    backdrop-filter: blur(25px) !important; /* å¼ºåŠ›æ¨¡ç³ŠèƒŒæ™¯ */
    -webkit-backdrop-filter: blur(25px) !important;
    
    z-index: 999999 !important; /* ç»å¯¹æœ€é«˜å±‚çº§ */
    display: none; /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

/* æ¿€æ´»çŠ¶æ€ */
#modal-footprint-single-detail.active {
    display: flex !important;
    animation: fadeIn 0.4s ease-out;
}

/* 2. æ‹ç«‹å¾—æœ¬ä½“ï¼šä¼˜åŒ–è´¨æ„Ÿä¸æ¯”ä¾‹ */
.polaroid-detail-frame {
    /* ç‰©ç†å°ºå¯¸é”å®šï¼šæ›´åƒçœŸå®çš„ Fuji Instax å®½å¹… */
    width: 300px !important;
    height: auto !important; /* é«˜åº¦è‡ªé€‚åº”ï¼Œä¸å†å†™æ­» */
    min-height: 420px;
    
    padding: 16px 16px 70px 16px !important; /* åº•éƒ¨ç•™å‡ºå¤§ç‰‡ç©ºç™½ç»™ç­¾å */
    
    /* çº¸å¼ è´¨æ„Ÿï¼šæš–ç™½ + çº¹ç† */
    background-color: #fdfbf7 !important;
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    
    border-radius: 4px !important;
    box-shadow: 
        0 30px 80px rgba(0,0,0,0.6), /* æ·±é‚ƒæŠ•å½±ï¼Œåˆ¶é€ æ‚¬æµ®æ„Ÿ */
        inset 0 0 20px rgba(255,255,255,0.5);
    
    position: relative !important;
    display: flex !important;
    flex-direction: column;
    transform: rotate(-3deg); /* å¾®å¾®å€¾æ–œï¼Œæ›´æœ‰è‰ºæœ¯æ„Ÿ */
}

/* 3. å†…éƒ¨é»‘åº•ç‰‡åŒºï¼šå†…é™·æ•ˆæœ */
.polaroid-inner-content {
    width: 100% !important;
    aspect-ratio: 4/5 !important; /* ç»å…¸çš„åº•ç‰‡æ¯”ä¾‹ */
    background: #080808 !important;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); /* å†…é™·é˜´å½± */
    
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 25px;
    position: relative;
    overflow: hidden;
}

/* æ–‡å­—æ’ç‰ˆä¼˜åŒ– */
.polaroid-inner-content span {
    color: rgba(255,255,255,0.85);
    font-family: "Songti SC", serif; /* å®‹ä½“æ›´æœ‰è¯—æ„ */
    font-size: 15px;
    line-height: 1.8;
    text-align: justify;
    font-style: italic;
    letter-spacing: 0.5px;
    text-shadow: 0 0 5px rgba(255,255,255,0.2);
}

/* 4. åº•éƒ¨æ—¥æœŸï¼šæœºæ¢°æ‰“ç é£æ ¼ */
.polaroid-full-timestamp {
    position: absolute !important;
    bottom: 12px !important;
    left: 18px !important;
    
    font-family: 'Courier New', monospace !important; /* æ‰“å­—æœºå­—ä½“ */
    font-size: 9px !important;
    font-weight: 600 !important;
    letter-spacing: 1px !important;
    color: #a0a0a0 !important; /* æµ…ç°è‰²ï¼Œåƒå°ä¸Šå»çš„ */
    
    background: transparent !important; 
    padding: 0 !important;
    z-index: 50 !important;
    opacity: 0.8;
}

/* --- âœ¨ çƒ«é‡‘å‡çº§ï¼šé«˜äº®é“‚é‡‘é£æ ¼ --- */
.signature-img-wrapper {
    /* ... ä¿æŒå®½é«˜å’Œ mask å±æ€§ä¸å˜ ... */
    width: 100% !important;
    height: 100% !important;
    -webkit-mask-size: contain !important;
    mask-size: contain !important;
    -webkit-mask-repeat: no-repeat !important;
    mask-repeat: no-repeat !important;
    -webkit-mask-position: center bottom !important;
    mask-position: center bottom !important;

    /* ğŸš¨ è°ƒæ•´ï¼šåŠ æ·±é‡‘è‰²çš„å¯¹æ¯”åº¦ï¼Œè®©ç»†çº¿æ›´æ˜æ˜¾ */
    background: linear-gradient(
        120deg, 
        #8a6e2f 0%,     /* æš—é‡‘ */
        #eecfa1 25%,    /* äº®é‡‘ */
        #b38728 50%,    /* çº¯é‡‘ */
        #fbf5b7 75%,    /* é“‚é‡‘é«˜å…‰ */
        #8a6e2f 100%    /* æš—é‡‘ */
    ) !important;
    
    background-size: 200% 200% !important;
    animation: goldShimmer 4s linear infinite !important;
    
    /* ğŸš¨ å…³é”®ï¼šç»™ç»†çº¿åŠ ä¸€ç‚¹ç‚¹æŠ•å½±ï¼Œè®©å®ƒæµ®èµ·æ¥ */
    filter: drop-shadow(0 1px 0 rgba(0,0,0,0.5)); 
}

@keyframes sharpShine {
    0% { background-position: 200% 0%; }
    100% { background-position: -200% 0%; }
}

/* --- ğŸ–‹ï¸ Luna å®šåˆ¶ç­¾åä¸“ç”¨å®¹å™¨ --- */
.gold-signature-container {
    position: absolute !important;
    bottom: 15px !important; 
    right: 10px !important;
    
    /* é€‚é…è¿™ä¸ªæ–°ç­¾åçš„å®Œç¾æ¯”ä¾‹ */
    width: 240px !important; 
    height: 96px !important;
    
    z-index: 100 !important;
    pointer-events: none;
    
    /* å¾®å¾®å€¾æ–œï¼Œæ¨¡æ‹Ÿæ‰‹å†™æ—¶çš„è‡ªç„¶è§’åº¦ï¼Œéå¸¸æ½‡æ´’ */
    transform: rotate(-4deg) !important; 
    
    display: flex;
    align-items: center;
    justify-content: center;
}

/* å…³é—­æç¤º */
.close-hint-text {
    margin-top: 40px;
    color: rgba(255,255,255,0.4);
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-weight: 700;
}
/* --- ğŸ“‚ å¾€æœŸæ¡£æ¡ˆå…¥å£æŒ‰é’®åŒºåŸŸ --- */
.history-access-zone {
    padding: 40px 35px 120px 35px; /* åº•éƒ¨ç•™è¶³ç©ºé—´ï¼Œé˜²æ­¢è¢« Footer é®æŒ¡ */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    opacity: 0;
    animation: fadeInUp 0.8s ease forwards 0.5s; /* å»¶è¿Ÿå‡ºç°ï¼Œå¢åŠ æœŸå¾…æ„Ÿ */
}

.btn-history-trigger {
    width: 100%;
    padding: 18px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.8);
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
}

.btn-history-trigger:active {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(0.97);
}

/* æŒ‰é’®å†…çš„å°å›¾æ ‡ */
.btn-history-trigger svg {
    width: 16px;
    height: 16px;
    opacity: 0.7;
}

/* åˆ†å‰²çº¿è£…é¥° */
.history-divider {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.2);
    letter-spacing: 4px;
    font-weight: 900;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ³ï¸ ç™½å¤œé•¿å·ï¼šæè‡´æç®€ç¾å­¦ --- */

/* æ—¶é—´è½´å®¹å™¨ */
.white-timeline {
    padding: 10px 20px 100px 20px;
    position: relative;
    /* å·¦ä¾§è´¯ç©¿çš„ä¸€æ¡æç»†é“¶çº¿ */
    border-left: 1px solid rgba(0,0,0,0.06);
    margin-left: 30px;
}

/* æ¯ä¸€å¤©çš„å¡ç‰‡å®¹å™¨ */
.white-day-card {
    position: relative;
    margin-bottom: 40px;
    padding-left: 25px; /* ç»™å·¦ä¾§çš„æ—¶é—´ç‚¹ç•™ä½ç½® */
    animation: fadeSlideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    opacity: 0;
    transform: translateY(20px);
}

/* å·¦ä¾§çš„æ—¶é—´èŠ‚ç‚¹ï¼ˆåœ†ç‚¹ï¼‰ */
.white-day-card::before {
    content: "";
    position: absolute;
    left: -5px; /* æ­£å¥½å‹åœ¨å·¦ä¾§é“¶çº¿ä¸Š */
    top: 25px;
    width: 9px;
    height: 9px;
    background: #fff;
    border: 2px solid #1d1d1f; /* é»‘åœˆç™½å¿ƒ */
    border-radius: 50%;
    z-index: 2;
}

/* å¡ç‰‡æœ¬ä½“ï¼šåƒä¸€å¼ ç²¾è‡´çš„ä¿¡çº¸ */
.day-card-inner {
    background: #ffffff;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 
        0 10px 30px rgba(0,0,0,0.03), /* ææ·¡çš„å¼¥æ•£é˜´å½± */
        0 1px 3px rgba(0,0,0,0.02);
    border: 1px solid rgba(0,0,0,0.02);
    cursor: pointer;
    transition: all 0.3s ease;
}

/* æ‚¬åœ/ç‚¹å‡»åé¦ˆï¼šè½»å¾®ä¸Šæµ® */
.day-card-inner:active {
    transform: translateY(-2px) scale(0.98);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

/* æ—¥æœŸæ’ç‰ˆ */
.day-meta-date {
    font-family: 'Cormorant Garamond', serif;
    font-size: 28px;
    font-weight: 500; /* ç»†å­—ä½“æ›´ä¼˜é›… */
    color: #1d1d1f;
    line-height: 1;
    margin-bottom: 5px;
}

.day-meta-month {
    font-size: 10px;
    font-weight: 700;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 20px;
}

/* æ‘˜è¦æ–‡å­— */
.day-summary-preview {
    font-family: "Songti SC", serif; /* å®‹ä½“ */
    font-size: 14px;
    line-height: 1.8;
    color: #555;
    /* é™åˆ¶æ˜¾ç¤º 2 è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* åº•éƒ¨çŠ¶æ€æ  */
.day-footer {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px dashed #eee; /* è™šçº¿åˆ†å‰² */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.day-status-pill {
    font-size: 9px;
    color: #1d1d1f;
    background: #f2f2f7;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 600;
}

.view-btn-text {
    font-size: 11px;
    color: #007AFF; /* iOS è“ç‚¹ç¼€ */
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
}

@keyframes fadeSlideUp {
    to { opacity: 1; transform: translateY(0); }
}
/* --- ğŸ“‚ å¾€æœŸæ¡£æ¡ˆåº“ï¼šç‰©ç†å±‚çº§ä¿®æ­£è¡¥ä¸ --- */
#subpage-history-vault {
    /* 1. å¼ºåˆ¶å›ºå®šå®šä½ï¼Œè„±ç¦»æ–‡æ¡£æµ */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    
    /* 2. çº¯ç™½èƒŒæ™¯ï¼Œé˜²æ­¢é€è‰² */
    background: #ffffff !important;
    
    /* 3. ğŸš¨ æ ¸å¿ƒï¼šå±‚çº§å¿…é¡»é«˜äº #modal-footprints (16000) */
    z-index: 50000 !important; 
    
    /* 4. åˆå§‹çŠ¶æ€ï¼šéšè—åœ¨å³ä¾§ */
    display: none; /* é»˜è®¤ä¸æ˜¾ç¤º */
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}

/* æ¿€æ´»çŠ¶æ€ */
#subpage-history-vault.active {
    display: flex !important; /* å¼ºåˆ¶å˜æˆ Flex å¸ƒå±€ */
    flex-direction: column !important;
    transform: translateX(0) !important; /* æ»‘å…¥å±å¹• */
}
/* --- ğŸ“¡ åŒæ­¥æŒ‰é’®ï¼šä¿¡å·æ‰«æç‰¹æ•ˆ --- */
.btn-history-trigger {
    position: relative;
    overflow: hidden;
    /* å¢åŠ è¿‡æ¸¡æ•ˆæœï¼Œè®©å˜è‰²æ›´ä¸æ»‘ */
    transition: all 0.3s ease;
}

/* æ¿€æ´»æ‰«æçŠ¶æ€ */
.btn-history-trigger.syncing {
    background: rgba(0, 122, 255, 0.1) !important;
    color: #007AFF !important;
    border-color: #007AFF !important;
    pointer-events: none; /* ç¦æ­¢é‡å¤ç‚¹å‡» */
}

/* æ‰«æå…‰æ³¢ */
.btn-history-trigger.syncing::after {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 200%;
    height: 100%;
    /* è“è‰²çš„æ‰«æå…‰æŸ */
    background: linear-gradient(
        90deg, 
        transparent 0%, 
        rgba(0, 122, 255, 0.2) 50%, 
        transparent 100%
    );
    animation: syncScan 1.5s infinite linear;
}

@keyframes syncScan {
    from { transform: translateX(0); }
    to { transform: translateX(100%); }
}

/* èƒ¶ç‰‡æ’å…¥åŠ¨ç”»ï¼šæ–°ç”Ÿæˆçš„èƒ¶ç‰‡ä¼šä»åº•éƒ¨å¼¹ä¸Šæ¥ */
@keyframes slideInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}
.film-frame.new-entry {
    animation: slideInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}
/* --- ğŸ“– ç™½æ˜¼Â·å…‰å° (Archive Reader) --- */

/* 2. ç™½æ˜¼Â·å…‰å° (è¯¦æƒ…é˜…è¯»å™¨) - å¿…é¡»ç‰©ç†å‹åˆ¶åˆ—è¡¨é¡µ */
#subpage-archive-reader {
    z-index: 60000 !important; /* ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè°ƒé«˜åˆ° 60000 */
    background: #ffffff !important; /* ç¡®ä¿èƒŒæ™¯ä¸é€æ˜ */
    display: none;
    position: fixed !important;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
}

#subpage-archive-reader.active {
    transform: translateX(0);
}

.archive-body-scroller {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 20px 30px 100px 30px; /* ç•™è¶³å‘¼å¸æ„Ÿ */
}

/* 1. åˆŠå¤´è®¾è®¡ */
.archive-magazine-header {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    margin-top: 20px;
}
.archive-date-big {
    font-family: 'Cormorant Garamond', serif;
    font-size: 80px;
    line-height: 0.8;
    font-weight: 300;
    color: #1d1d1f;
    margin-right: 15px;
}
.archive-date-meta {
    display: flex;
    flex-direction: column;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 3px;
    color: #8E8E93;
    border-left: 2px solid #1d1d1f;
    padding-left: 10px;
    height: 40px;
    justify-content: center;
}

/* 2. AI æ‘˜è¦åŒº */
.archive-ai-summary {
    position: relative;
    padding: 0 10px;
    margin-bottom: 40px;
}
.summary-quote-icon {
    font-family: serif;
    font-size: 60px;
    color: #f2f2f7;
    position: absolute;
    top: -30px; left: -20px;
    z-index: 0;
}
.summary-text-content {
    position: relative;
    z-index: 1;
    font-family: "Songti SC", serif; /* å®‹ä½“ */
    font-size: 16px;
    line-height: 1.8;
    color: #444;
    font-style: italic;
}

.archive-divider-line {
    width: 100%;
    height: 1px;
    background: #eee;
    margin-bottom: 40px;
}

/* 3. é»‘è‰²èƒ¶ç‰‡å—åˆ—è¡¨ */
.archive-timeline-box {
    border-left: 1px solid #e5e5ea;
    padding-left: 25px;
    margin-left: 10px;
}

.archive-film-item {
    position: relative;
    margin-bottom: 35px;
    cursor: pointer;
}

/* å·¦ä¾§æ—¶é—´ç‚¹ */
.archive-film-item::before {
    content: "";
    position: absolute;
    left: -30px; top: 18px;
    width: 9px; height: 9px;
    background: #1d1d1f;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px #e5e5ea;
}

.archive-time-label {
    font-family: 'Courier New', monospace;
    font-size: 11px;
    color: #8E8E93;
    font-weight: 700;
    margin-bottom: 8px;
    display: block;
}

/* é»‘è‰²èƒ¶ç‰‡æœ¬ä½“ */
.black-film-strip {
    background: #000;
    color: #fff;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    position: relative;
    overflow: hidden;
}
.black-film-strip:active {
    transform: scale(0.98);
}

/* èƒ¶ç‰‡æ–‡å­— */
.film-text-preview {
    font-size: 13px;
    line-height: 1.6;
    color: rgba(255,255,255,0.9);
    display: -webkit-box;
    -webkit-line-clamp: 2; /* æœ€å¤šæ˜¾ç¤º2è¡Œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* 4. åº•éƒ¨å°ç«  */
.archive-footer-seal {
    margin-top: 60px;
    display: flex;
    justify-content: center;
    opacity: 0.6;
}
.seal-box {
    border: 2px solid #d4af37; /* çƒ«é‡‘è‰² */
    color: #d4af37;
    padding: 10px 20px;
    text-align: center;
    transform: rotate(-5deg);
    border-radius: 4px;
    display: flex;
    flex-direction: column;
}
/* =========================================================
   ğŸš¨ ç‰©ç†é”æ­»è¡¥ä¸ï¼šå¤§å›¾å›ºå®š + ä»…è¯„è®ºåŒºæ»‘åŠ¨
   ========================================================= */

/* 1. å½»åº•ç¦ç”¨å¤–å±‚å®¹å™¨çš„æ»šåŠ¨ï¼Œé˜²æ­¢æ•´ä½“ä½ç§» */
#modal-theirs-photo-detail .theirs-detail-scroller {
    display: flex !important;
    flex-direction: column !important;
    height: 100vh !important; /* é”å®šè§†å£é«˜åº¦ */
    overflow-y: hidden !important; /* ğŸš¨ ç‰©ç†ç¦æ­¢æ•´ä½“æ»‘åŠ¨ */
    padding: 0 !important;
}

/* 2. é¡¶éƒ¨å¤§å›¾å¡ç‰‡ï¼šç‰©ç†å®šæ ¼ */
#modal-theirs-photo-detail .theirs-portrait-card {
    width: calc(100% - 40px) !important;
    margin: 80px 20px 0 20px !important; /* é¿å¼€é¡¶éƒ¨çŠ¶æ€æ  */
    aspect-ratio: 3 / 4 !important; 
    flex-shrink: 0 !important; /* ğŸš¨ ç¦æ­¢è¢«æŒ¤å‹ */
    z-index: 10 !important;
    position: relative !important;
}

/* 3. ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¯„è®ºé¢æ¿ï¼šå¼€å¯ç‹¬ç«‹æ»‘åŠ¨å¼•æ“ */
#modal-theirs-photo-detail .theirs-interaction-pod {
    margin-top: -30px !important; /* ä¿æŒä¸å¤§å›¾çš„é‡å ç¾æ„Ÿ */
    padding: 40px 25px 120px 25px !important; /* åº•éƒ¨ç•™ç™½ç»™è¾“å…¥æ¡† */
    
    background: rgba(255, 255, 255, 0.98) !important;
    border-radius: 32px 32px 0 0 !important;
    box-shadow: 0 -15px 30px rgba(0,0,0,0.2) !important;

    /* ğŸš¨ ç‹¬ç«‹æ»‘åŠ¨æ ¸å¿ƒæŒ‡ä»¤ */
    flex: 1 !important; /* å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
    overflow-y: auto !important; /* ğŸš¨ å…è®¸å†…éƒ¨æ»‘åŠ¨ */
    -webkit-overflow-scrolling: touch; /* iOS ä¸æ»‘æ»šåŠ¨åè®® */
}

/* 4. å¼ºåˆ¶éšè—è¯„è®ºåŒºå†…å¯èƒ½å†²çªçš„æ»šåŠ¨æ¡ï¼Œä¿æŒæè‡´ç®€æ´ */
#modal-theirs-photo-detail .theirs-interaction-pod::-webkit-scrollbar {
    display: none;
}

/* 5. ç¡®ä¿è¯„è®ºåˆ—è¡¨å†…å®¹ä¸è¢«æˆªæ–­ */
#modal-theirs-photo-detail #theirs-comments-list {
    display: block !important;
    height: auto !important;
    padding-bottom: 20px;
}

/* 6. è¿”å›æŒ‰é’®ï¼šç‰©ç†ç½®é¡¶ï¼Œä¸éšæ»‘åŠ¨æ¶ˆå¤± */
#modal-theirs-photo-detail .card-header-tools {
    position: fixed !important;
    top: 55px !important;
    left: 20px !important;
    z-index: 120000 !important;
}
/* --- ğŸï¸ å†å²ç¼©ç•¥å›¾æ—¶é—´è½´æ ‡ç­¾æ ·å¼ --- */
.history-thumb {
    /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œç»™æ—¥æœŸç•™ä½å­ */
    padding: 22px 8px 30px 8px !important; 
    position: relative;
    background: #fff;
    border: 1px solid rgba(0,0,0,0.05);
}

.thumb-date-tag {
    position: absolute;
    top: 6px;
    left: 8px;
    
    /* æè‡´é«˜çº§æ„Ÿï¼šçª„é—´è·ç­‰å®½å­—ä½“ */
    font-family: "Courier New", Courier, monospace;
    font-size: 8px;
    font-weight: 900;
    color: #007AFF; /* è“è‰²ç‚¹ç¼€ï¼Œå‘¼åº”ç³»ç»Ÿè‰² */
    letter-spacing: 1px;
    
    /* æ¨¡æ‹Ÿæ‰“ç æ•ˆæœ */
    opacity: 0.8;
}

/* è°ƒæ•´ç¼©ç•¥å›¾å›¾ç‰‡çš„æ¯”ä¾‹ï¼Œç¡®ä¿æ—¥æœŸä¸é®æŒ¡å›¾ç‰‡å†…å®¹ */
.history-thumb-img {
    border: 0.5px solid rgba(0,0,0,0.05);
    border-radius: 1px;
}
/* =========================================================
   ğŸ–‹ï¸ è§’è‰²æ¡£æ¡ˆå·é¦–è¯­ï¼šé«˜çº§å™äº‹æ„Ÿè£…ä¿®
   ========================================================= */
.header-char-bio {
    /* 1. å­—ä½“ä¸æ’ç‰ˆï¼šè¥é€ é«˜çº§å™äº‹æ„Ÿ */
    /* ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„é«˜çº§è¡¬çº¿ä½“ï¼Œæ²¡æœ‰åˆ™å›é€€åˆ°é€šç”¨è¡¬çº¿ä½“ */
    font-family: -apple-system-ui-serif, ui-serif, "Cormorant Garamond", Georgia, serif;
    font-size: 15px; /* å­—å·é€‚ä¸­ï¼Œæ˜¾ç²¾è‡´ */
    font-weight: 500;
    font-style: italic; /* æ–œä½“å¢åŠ æ–‡å­¦æ„Ÿ */
    color: #4a4a4a; /* æ·±ç°è€Œéçº¯é»‘ï¼Œæ›´æŸ”å’Œ */
    
    text-align: center;
    letter-spacing: 0.8px; /* å¢åŠ å­—é—´è·ï¼Œé€æ°”æ„Ÿ */
    line-height: 1.5;

    /* 2. å®¹å™¨è£…é¥°ï¼šå¾®å¦™çš„å…‰å½±èˆå° */
    margin: 12px auto 24px auto; /* ä¸Šä¸‹ç•™ç™½ */
    padding: 14px 24px;
    max-width: 85%; /* é™åˆ¶å®½åº¦ï¼Œè®©æ–‡å­—æ›´ç´§å‡‘ */
    
    /* æå¾®å¦™çš„çºµå‘æ¸å˜èƒŒæ™¯ï¼Œåƒä¸€å¼ æ—§çº¸ */
    background: linear-gradient(to bottom, rgba(0,0,0,0.01), rgba(0,0,0,0.03));
    /* é¡¶éƒ¨å’Œåº•éƒ¨çš„æç»†è£…é¥°çº¿ */
    border-top: 0.5px solid rgba(0,0,0,0.04);
    border-bottom: 0.5px solid rgba(0,0,0,0.06);
    border-radius: 4px;

    /* 3. çŠ¶æ€ä¸è¿‡æ¸¡ */
    min-height: 40px; /* å ä½é«˜åº¦ï¼Œé˜²æ­¢ç”Ÿæˆæ—¶é¡µé¢æŠ–åŠ¨ */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.5s ease;
}

/* åŠ è½½æ—¶çš„å ä½ç¬¦åŠ¨ç”»æ•ˆæœ */
.bio-scanning {
    font-family: monospace; /*åŠ è½½æ—¶ç”¨ç­‰å®½å­—ä½“ï¼Œæ˜¾ç§‘æŠ€æ„Ÿ*/
    font-size: 12px;
    font-style: normal;
    color: #999;
    display: flex;
    align-items: center;
    gap: 6px;
}
.bio-scanning::before {
    content: "";
    display: block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #007AFF;
    animation: pulse 1s infinite alternate;
}
@keyframes pulse { from { opacity: 0.3; transform: scale(0.8); } to { opacity: 1; transform: scale(1.1); } }
</style>
</head>
<body>

    <div class="status-bar">
        <div id="clock">12:00</div>
        <div class="status-right">
            <svg width="18" height="12" viewBox="0 0 18 12" fill="currentColor"><path d="M1 9h2v2H1zm4-3h2v5H5zm4-3h2v8H9zm4-3h2v11h-2z"/></svg>
            <div style="display:flex; align-items:center;">
                <span class="bat-text" id="bat-num">--%</span>
                <div class="battery-box"><div class="bat-fill" id="bat-bar"></div><div class="bat-tip"></div></div>
            </div>
        </div>
    </div>

    <div class="home-screen-scroll-container">
        <div class="home-screen-wrapper">
            
            <div class="main-container" id="page-1">
                <div class="widget w-2x2" onclick="showM('weatherM')">
                    <div class="weather-content">
                        <div class="w-date-block">
                            <span class="w-day" id="ui-day">MONDAY</span>
                            <span class="w-date" id="ui-date">JANUARY 1</span>
                        </div>
                        <div class="w-data-stack">
                            <div class="w-icon-area" id="ui-icon"></div>
                            <div class="w-temp" id="ui-temp">--Â°</div>
                            <div class="w-city">
                                <svg style="width:12px;height:12px;fill:#007AFF" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
                                <span id="ui-city">Updating...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="widget w-2x2" onclick="showM('photoM')">
                    <div class="pic-container">
                        <div class="pic-text" id="ui-quote">"Thinking Different."</div>
                        <div class="pic-wrapper">
                            <img id="ui-img" class="pic-img" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' fill='%23f0f0f0'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-weight='bold' font-family='sans-serif'>Tap to Upload</text></svg>">
                        </div>
                    </div>
                </div>

                <div class="widget w-4x1">
                    <div class="music-row">
                        <div style="display:flex; align-items:center;">
                            <div class="album-cover"></div>
                            <div class="track-info">
                                <span class="track-title">Luxury Vibe</span>
                                <span class="track-artist">Lossless Audio</span>
                            </div>
                        </div>
                        <div class="ctrl-btns">
                            <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                            <svg style="width:32px;height:32px;fill:#333" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg style="width:24px;height:24px;fill:#333" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                        </div>
                    </div>
                </div>

                <div class="widget w-4x1">
                    <div class="prog-stack">
                        <div class="prog-header"><span>Daily Progress</span><span id="prog-txt">0.0%</span></div>
                        <div class="prog-bg"><div class="prog-fg" id="prog-bar"></div></div>
                    </div>
                </div>

                <div class="app-cell" onclick="openApp('wallApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><polyline points="21 15 16 10 5 21" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                    </div>
                    <span class="app-name">Wallpaper</span>
                </div>
                
                <div class="app-cell" onclick="openApp('settingsApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%); color: #3a3a3c;">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:34px; height:34px;"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" fill="currentColor"/></svg>
                    </div>
                    <span class="app-name">Settings</span>
                </div>

                <div class="app-cell" onclick="openChatApp()">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #007AFF 0%, #00C6FF 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="currentColor"/>
                        </svg>
                    </div>
                    <span class="app-name">Chat</span>
                </div>
                <div class="app-cell" onclick="openPhotosApp()">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #FFD3A5 0%, #FD6585 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                    </div>
                    <span class="app-name">Photos</span>
                </div>

                <div class="app-cell" onclick="openApp('musicApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #fb3a4d 0%, #fb6470 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    </div>
                    <span class="app-name">Music</span>
                </div>

                <div class="app-cell" onclick="openApp('themeApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    </div>
                    <span class="app-name">Themes</span>
                </div>

                <div class="app-cell" onclick="openApp('phoneApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #28C940 0%, #5ee172 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    </div>
                    <span class="app-name">Phone</span>
                </div>

                <div class="app-cell" onclick="openApp('messageApp')">
                    <div class="icon-shape" style="background: linear-gradient(135deg, #21d4fd 0%, #b721ff 100%); color: white;">
                        <svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <span class="app-name">Messages</span>
                </div>
            </div>

            <div class="main-container" id="page-2" style="display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr); gap: 16px; padding: 20px;">
    
                <div class="widget hero-cover-widget" style="grid-area: 1 / 1 / 3 / 5;" onclick="window.editHubField('hero')">
                    <div class="hero-image-wrapper">
                        <img id="hub-hero-img" src="https://images.unsplash.com/photo-1494438639946-1ebd1d20bf85?w=800&auto=format&fit=crop" alt="Hero">
                        <div class="hero-overlay"></div>
                    </div>
                    <div class="hero-content-text">
                        <span class="hero-tag" id="hub-hero-tag" onclick="event.stopPropagation(); window.editHubField('hero_tag')">FEATURED MOMENT</span>
                        
                        <h2 id="hub-hero-title" onclick="event.stopPropagation(); window.editHubField('hero_title')">Aesthetic Essence</h2>
                        
                        <p id="hub-hero-desc" onclick="event.stopPropagation(); window.editHubField('hero_desc')">"Design is intelligence made visible."</p>
                    </div>
                    
                    <div class="hero-edit-icon">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    </div>
                </div>
                <div class="widget moment-card-widget" style="grid-area: 3 / 1 / 5 / 3;" onclick="window.editHubField('moment_img')">
                    <div class="moment-photo-area">
                        <img id="hub-moment-img" src="https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&auto=format&fit=crop" alt="Moment">
                        <div class="moment-edit-hint">Change Photo</div>
                    </div>
                    <div class="moment-text-area">
                        <h3 id="hub-moment-title" onclick="event.stopPropagation(); window.editHubField('moment_title')">Daily Focus</h3>
                        <p id="hub-moment-desc" onclick="event.stopPropagation(); window.editHubField('moment_desc')">Keep it simple, keep it real.</p>
                    </div>
                </div>

                <div class="app-cell" style="grid-area: 3 / 3 / 4 / 4;" onclick="window.openApp('vibe-grid-app')">
                    <div class="glass-icon-bg">
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18"/>
                        </svg>
                    </div>
                    <span class="app-name">Vibe Grid</span>
                </div>

                <div class="app-cell" style="grid-area: 3 / 4 / 4 / 5;" onclick="openApp('diaryApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Diary</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                    </div>
                    <span class="app-name">Diary</span>
                </div>

                <div class="app-cell" style="grid-area: 4 / 3 / 5 / 4;" onclick="openApp('walletApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Wallet</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20M7 15h.01"/>
                        </svg>
                    </div>
                    <span class="app-name">Wallet</span>
                </div>

                <div class="app-cell" style="grid-area: 4 / 4 / 5 / 5;" onclick="openApp('notesApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Notes</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/>
                        </svg>
                    </div>
                    <span class="app-name">Notes</span>
                </div>

                <div class="widget vibe-bar-widget" style="grid-area: 5 / 1 / 6 / 5;" onclick="window.editHubField('vibe_img')">
                    <div class="vibe-bg-wrapper">
                        <img id="hub-vibe-img" src="https://images.unsplash.com/photo-1502759683299-cdcc6974244f?w=800&auto=format&fit=crop" alt="Vibe">
                        <div class="vibe-overlay"></div>
                    </div>
                    <span id="hub-vibe-text" onclick="event.stopPropagation(); window.editHubField('vibe_text')">Current Vibe: Serenity</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 1 / 7 / 2;" onclick="openApp('shoppingApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Shopping</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                    </div>
                    <span class="app-name">Shopping</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 2 / 7 / 3;" onclick="openApp('forumApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Forum</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                        </svg>
                    </div>
                    <span class="app-name">Forum</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 3 / 7 / 4;" onclick="openApp('novelApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Novels</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20V2H6.5A2.5 2.5 0 0 0 4 4.5v15z"/>
                        </svg>
                    </div>
                    <span class="app-name">Novels</span>
                </div>

                <div class="app-cell" style="grid-area: 6 / 4 / 7 / 5;" onclick="openApp('liveApp')">
                    <div class="glass-icon-bg">
                        <span class="app-name" style="display: none;">Live</span>
                        <svg class="glass-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/>
                        </svg>
                    </div>
                    <span class="app-name">Live</span>
                </div>

                </div>

        </div>
    </div>

    <div class="dock-container">
        <div class="dock-bar">
            <div class="dock-app" data-app="RoleBook" onclick="openApp('charApp')" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                <span class="app-name" style="display: none;">RoleBook</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white;">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
            </div>

            <div class="dock-app" data-app="WorldBook" onclick="openApp('worldApp')" style="background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);">
                <span class="app-name" style="display: none;">WorldBook</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <circle cx="12" cy="12" r="3" fill="rgba(255,255,255,0.2)"/>
                </svg>
            </div>

            <div class="dock-app" data-app="Beautify" onclick="openApp('beautifyApp')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); position: relative;">
                <span class="app-name" style="display: none;">Beautify</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 8l-2 4h4l-2 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 2v2M12 20v2M2 12h2M20 12h2" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
                </svg>
            </div>

            <div class="dock-app" data-app="Icons" onclick="openApp('iconApp')" style="background: linear-gradient(135deg, #2af598 0%, #009efd 100%);">
                <span class="app-name" style="display: none;">Icons</span>
                <svg class="svg-icon" viewBox="0 0 24 24" style="color:white; width:28px;">
                    <rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M17.5 14v7M14 17.5h7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        <div class="home-indicator"></div>
    </div>

    <div class="modal-overlay" id="weatherM" onclick="hideM('weatherM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top">
                <span class="modal-h1">Select City</span>
                <span class="modal-done" onclick="hideM('weatherM')">Done</span>
            </div>

            <div class="segment-control">
                <div class="segment-btn active" id="tab-cn" onclick="switchTab('cn')">China</div>
                <div class="segment-btn" id="tab-global" onclick="switchTab('global')">Global</div>
            </div>
            
            <div style="max-height: 55vh; overflow-y: auto; padding-right: 2px;">
                
                <div id="view-cn" class="city-view active">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">MAINLAND & HK/TW</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(39.9042, 116.4074, 'Beijing')">åŒ—äº¬</div>
                        <div class="city-tag" onclick="fetchW(31.2304, 121.4737, 'Shanghai')">ä¸Šæµ·</div>
                        <div class="city-tag" onclick="fetchW(23.1291, 113.2644, 'Guangzhou')">å¹¿å·</div>
                        <div class="city-tag" onclick="fetchW(22.5431, 114.0579, 'Shenzhen')">æ·±åœ³</div>
                        <div class="city-tag" onclick="fetchW(30.5728, 104.0668, 'Chengdu')">æˆéƒ½</div>
                        <div class="city-tag" onclick="fetchW(30.2741, 120.1551, 'Hangzhou')">æ­å·</div>
                        <div class="city-tag" onclick="fetchW(29.5630, 106.5516, 'Chongqing')">é‡åº†</div>
                        <div class="city-tag" onclick="fetchW(34.3416, 108.9398, 'Xi\'an')">è¥¿å®‰</div>
                        <div class="city-tag" onclick="fetchW(30.5928, 114.3055, 'Wuhan')">æ­¦æ±‰</div>
                        <div class="city-tag" onclick="fetchW(32.0603, 118.7969, 'Nanjing')">å—äº¬</div>
                        <div class="city-tag" onclick="fetchW(22.3193, 114.1694, 'Hong Kong')">é¦™æ¸¯</div>
                        <div class="city-tag" onclick="fetchW(25.0330, 121.5654, 'Taipei')">å°åŒ—</div>
                    </div>
                </div>

                <div id="view-global" class="city-view">
                    <div style="font-size:12px; color:#999; margin: 10px 0 8px 0; font-weight:700;">ASIA & PACIFIC</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(35.6762, 139.6503, 'Tokyo')">Tokyo</div>
                        <div class="city-tag" onclick="fetchW(37.5665, 126.9780, 'Seoul')">Seoul</div>
                        <div class="city-tag" onclick="fetchW(1.3521, 103.8198, 'Singapore')">Singapore</div>
                        <div class="city-tag" onclick="fetchW(13.7563, 100.5018, 'Bangkok')">Bangkok</div>
                        <div class="city-tag" onclick="fetchW(-33.8688, 151.2093, 'Sydney')">Sydney</div>
                        <div class="city-tag" onclick="fetchW(25.2048, 55.2708, 'Dubai')">Dubai</div>
                    </div>

                    <div style="font-size:12px; color:#999; margin: 15px 0 8px 0; font-weight:700;">AMERICAS & EUROPE</div>
                    <div class="city-grid">
                        <div class="city-tag" onclick="fetchW(40.7128, -74.0060, 'New York')">New York</div>
                        <div class="city-tag" onclick="fetchW(34.0522, -118.2437, 'Los Angeles')">L.A.</div>
                        <div class="city-tag" onclick="fetchW(43.6532, -79.3832, 'Toronto')">Toronto</div>
                        <div class="city-tag" onclick="fetchW(51.5074, -0.1278, 'London')">London</div>
                        <div class="city-tag" onclick="fetchW(48.8566, 2.3522, 'Paris')">Paris</div>
                        <div class="city-tag" onclick="fetchW(52.5200, 13.4050, 'Berlin')">Berlin</div>
                        <div class="city-tag" onclick="fetchW(55.7558, 37.6173, 'Moscow')">Moscow</div>
                        <div class="city-tag" onclick="fetchW(41.9028, 12.4964, 'Rome')">Rome</div>
                        <div class="city-tag" onclick="fetchW(40.4168, -3.7038, 'Madrid')">Madrid</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal-overlay" id="photoM" onclick="hideM('photoM')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-top"><span class="modal-h1">Customize</span><span class="modal-done" onclick="hideM('photoM')">Save</span></div>
            <input type="text" id="q-in" placeholder="Type your quote..." style="width:100%; padding:16px; background:#f2f2f7; border:none; border-radius:14px; font-size:16px;">
            <div class="upload-tools">
                <input type="file" id="f-in" style="display:none" accept="image/*" onchange="loadF(this)">
                <div class="tool-btn" onclick="document.getElementById('f-in').click()">Photo Library</div>
                <div class="tool-btn" onclick="loadU()">Paste URL</div>
            </div>
        </div>
    </div>

<video id="bg-video" autoplay loop muted playsinline style="position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; display:none;"></video>

<div id="wallApp" class="ios-app-window">
    <div class="app-header">
        <div class="header-title-big">Wallpaper</div>
        <div class="header-close-btn" onclick="closeApp('wallApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body">
        
        <div class="preview-stage" style="margin-top: 10px;">
            <div class="phone-frame">
                <img id="preview-img" src="" style="display:none;">
                <video id="preview-vid" autoplay loop muted playsinline style="display:none;"></video>
                <div class="preview-placeholder" id="preview-hint">Preview</div>
            </div>
        </div>

        <div class="segment-control" style="width: 100%; max-width: 300px;">
            <div class="segment-btn active" id="seg-img" onclick="switchWallTab('img')">Image</div>
            <div class="segment-btn" id="seg-vid" onclick="switchWallTab('vid')">Video</div>
        </div>

        <div class="action-area" id="panel-img" style="max-width: 300px;">
            <input type="file" id="upload-img" accept="image/*" style="display:none" onchange="handleWallFile(this, 'img')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-img').click()">+ New Image</button>
            <button class="ios-btn primary" onclick="setWallpaper('img')">Set Current</button>
        </div>

        <div class="action-area" id="panel-vid" style="display:none; max-width: 300px;">
            <input type="file" id="upload-vid" accept="video/*" style="display:none" onchange="handleWallFile(this, 'vid')">
            <button class="ios-btn secondary" onclick="document.getElementById('upload-vid').click()">+ New Video</button>
            <button class="ios-btn primary" onclick="setWallpaper('vid')">Set Current</button>
        </div>

        <div class="history-section">
            <div class="history-title">My Collection</div>
            <div class="history-grid" id="wall-history-grid">
                </div>
            <div style="text-align:center; color:#999; font-size:12px; margin-top:15px;">
                Tap to apply. Latest 6 items saved.
            </div>
        </div>

    </div>
</div>

<div id="toast" class="ios-toast">Settings Saved</div>

<div id="successAlert" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Success</div>
        <div class="alert-msg" id="alert-msg">Wallpaper Updated Successfully</div>
        <div class="alert-btn" onclick="closeAlert()">OK</div>
    </div>
</div>

<div id="charApp" class="ios-app-window">
    <div id="char-list-view" style="height:100%; display:flex; flex-direction:column;">
        <div class="app-header">
            <div class="header-title-big" style="flex:1; text-align: left; padding-left: -5px;">Character</div>
            
            <div class="header-close-btn" onclick="closeApp('charApp')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
        
        <div class="app-body">
            <div id="char-grid" class="char-grid">
                </div>
            </div>
    </div>

    <div id="char-detail-view" class="char-detail-view">
        <div class="char-hero-bg" id="detail-bg" onclick="openBgModal()">
            <div class="bg-hint">Tap to Change Cover</div>
        </div>
        
        <div class="char-content">
            <div class="char-avatar-container">
                <img id="detail-avatar" src="">
            </div>
            
            <div class="char-info-block">
                <div class="char-name" id="detail-name">Character Name</div>
                
                <div class="char-desc-preview" onclick="openFullDesc()">
                    <span id="detail-desc">Description goes here...</span>
                    <span style="color:#007AFF; font-weight:600; font-size:12px;"> more</span>
                </div>

                <div class="char-actions">
                    <button class="ios-btn secondary" onclick="editCurrentChar()">Edit Profile</button>
                    <button class="ios-btn" style="background:#FF3B30; color:white;" onclick="openDelConfirm()">Delete Character</button>
                </div>
            </div>
        </div>

        <div class="floating-back" onclick="closeDetailView()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </div>
    </div>
</div>

<div id="charEditModal" class="ios-alert-mask" style="align-items:flex-end;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-top">
            <span class="modal-h1" id="modal-title">New Character</span>
            <span class="modal-done" onclick="saveCharacter()">Save</span>
        </div>
        
        <div style="display:flex; justify-content:center; margin-bottom:20px;">
            <div class="char-upload-circle" onclick="document.getElementById('char-avatar-in').click()">
                <img id="edit-avatar-preview" src="" style="display:none;">
                <span id="edit-avatar-hint">+ Avatar</span>
            </div>
            <input type="file" id="char-avatar-in" accept="image/*" style="display:none" onchange="previewCharAvatar(this)">
        </div>

        <input type="text" id="char-name-in" class="ios-input" placeholder="Nickname">
        <textarea id="char-desc-in" class="ios-input" style="height:120px; resize:none; padding-top:12px;" placeholder="Character Description / Setting..."></textarea>
        
        <div class="tool-btn" onclick="closeCharModal()" style="margin-top:10px; color:#FF3B30;">Cancel</div>
    </div>
</div>

<div id="bgChangeModal" class="ios-alert-mask">
    <div class="ios-alert-box" style="padding:20px; text-align:left;">
        <div class="alert-title" style="margin-top:0; margin-bottom:15px; text-align:center;">Change Cover</div>
        
        <div class="segment-control">
            <div class="segment-btn active" id="bg-seg-file" onclick="switchBgMode('file')">File</div>
            <div class="segment-btn" id="bg-seg-url" onclick="switchBgMode('url')">URL</div>
        </div>

        <div id="bg-panel-file">
            <input type="file" id="bg-file-in" style="display:none" accept="image/*" onchange="handleBgFile(this)">
            <button class="ios-btn secondary" onclick="document.getElementById('bg-file-in').click()">Choose Image</button>
        </div>
        <div id="bg-panel-url" style="display:none;">
            <input type="text" id="bg-url-in" class="ios-input" placeholder="https://..." style="margin-bottom:10px;">
            <button class="ios-btn secondary" onclick="handleBgUrl()">Use URL</button>
        </div>

        <div class="alert-btn" style="border:none; margin-top:10px; color:#FF3B30;" onclick="document.getElementById('bgChangeModal').style.display='none'">Cancel</div>
    </div>
</div>

<div id="fullDescModal" class="ios-alert-mask" onclick="closeInsModal()" style="backdrop-filter: blur(15px); background: rgba(0,0,0,0.2);">
    
    <div class="aesthetic-card" onclick="event.stopPropagation()">
        
        <div class="aes-top-bar">
            <div class="aes-icon-circle close" onclick="closeInsModal()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="aes-hero">
            <div class="aes-blur-bg" id="aes-bg-layer"></div>
            <div class="aes-noise"></div>
            <div class="aes-overlay"></div>
        </div>

        <div class="aes-float-content">
            <div class="aes-avatar-box">
                <img id="aes-avatar-img" src="">
            </div>
            <div class="aes-title-group">
                <div class="aes-name" id="aes-name-txt">Character Name</div>
                <div class="aes-tag">ORIGINAL CHARACTER</div>
            </div>
        </div>

        <div class="aes-scroll-area">
            <div class="aes-text-body" id="aes-full-desc">
                </div>
            <div class="aes-divider">âœ¦</div>
        </div>

        </div>
</div>

<div id="delConfirmModal" class="ios-alert-mask">
    <div class="ios-alert-box">
        <div class="alert-title">Delete Character?</div>
        <div class="alert-msg">This action cannot be undone.</div>
        <div class="alert-btn" style="color:#FF3B30;" onclick="confirmDelete()">Delete</div>
        <div class="alert-btn" onclick="document.getElementById('delConfirmModal').style.display='none'">Cancel</div>
    </div>
</div>

<div id="settingsApp" class="ios-app-window" style="background:#F2F2F7; z-index: 5000;">
    
    <div class="app-header" style="background: rgba(242,242,247,0.85); backdrop-filter: saturate(180%) blur(20px); z-index: 10;">
        <div class="header-title-big" style="flex:1; text-align: left; padding-left: 10px;">Settings</div>
        <div class="header-close-btn" onclick="closeApp('settingsApp')" style="background:#e5e5ea;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body" style="padding: 20px 16px; align-items: stretch;">
        <div class="ios-list-group">
            
            <div class="ios-list-item" onclick="openSubPage('subpage-timezone')">
                <div class="item-icon" style="background: #FF9500;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div class="item-content">
                    <span class="item-label">Timezone</span>
                    <div class="item-right">
                        <span class="item-value" id="val-timezone">Automatic</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-api'); loadApiSettingsUI();">
                <div class="item-icon" style="background: #34C759;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                </div>
                <div class="item-content">
                    <span class="item-label">AI Configuration</span>
                    <div class="item-right">
                        <span class="item-value" id="api-status-preview">Default</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-display'); loadFontSettings();">
                <div class="item-icon" style="background: #007AFF;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
                </div>
                <div class="item-content" style="border-bottom: none;">
                    <span class="item-label">Display & Brightness</span>
                    <div class="item-right">
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-instructions')">
                <div class="item-icon" style="background: #8E8E93;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <div class="item-content" style="border-bottom: none;">
                    <span class="item-label">Instructions</span>
                    <div class="item-right">
                        <span class="item-value">Guide</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

            <div class="ios-list-item" onclick="openSubPage('subpage-voice-settings'); loadVoiceSettingsUI();">
                <div class="item-icon" style="background: #007AFF;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </div>
                <div class="item-content">
                    <span class="item-label">Voice Engine</span>
                    <div class="item-right">
                        <span class="item-value" id="voice-model-preview">TTS-1</span>
                        <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>

        </div>
        <div style="font-size:12px; color:#8e8e93; margin-top:10px; margin-left:16px;">iOS Pro Ultimate v1.0</div>
    </div>

    <div id="subpage-timezone" class="ios-sub-page" style="display: flex; flex-direction: column; height: 100%; width: 100%; background: #F2F2F7; position: absolute; top: 0; left: 0; z-index: 20;">
        <div class="app-header" style="flex-shrink: 0; height: 60px; background: rgba(242,242,247,0.85); backdrop-filter: saturate(180%) blur(20px); z-index: 999; position: relative;">
            <div class="header-left-btn" onclick="closeSubPage('subpage-timezone')" style="margin-left: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                <span style="color:#007AFF; font-size:16px; font-weight:500;">Back</span>
            </div>
            <div class="header-title-big" style="font-size:17px; text-align:center; flex:1;">Time Zone</div>
            <div style="width:60px;"></div> 
        </div>

        <div class="app-body" style="flex: 1; overflow-y: auto; padding: 0 16px 80px 16px; width: 100%; align-items: stretch; -webkit-overflow-scrolling: touch;">
            <div style="padding: 10px 0;">
                <div class="ios-search-wrapper" style="padding: 12px 10px;">
                    <svg class="search-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="tz-search-input" class="ios-search-input" placeholder="Search City or Region" oninput="filterTimezoneList(this.value)">
                </div>
            </div>

            <div class="tz-group-title">Current Location</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="setTimezone('')">
                    <div class="item-content" style="border-bottom:none;"><span class="item-label">Automatic (System)</span><div class="item-check" id="check-auto"></div></div>
                </div>
            </div>

            <div id="tz-city-container">
                <div class="tz-group-title">ASIA & PACIFIC</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="beijing china" onclick="setTimezone('Asia/Shanghai', 'Beijing')">
                        <div class="item-content"><span class="item-label">Beijing</span><div class="item-check" id="check-Asia/Shanghai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="shanghai china" onclick="setTimezone('Asia/Shanghai', 'Shanghai')">
                        <div class="item-content"><span class="item-label">Shanghai</span><div class="item-check" id="check-Asia/Shanghai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="hong kong hk" onclick="setTimezone('Asia/Hong_Kong', 'Hong Kong')">
                        <div class="item-content"><span class="item-label">Hong Kong</span><div class="item-check" id="check-Asia/Hong_Kong"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="taipei taiwan" onclick="setTimezone('Asia/Taipei', 'Taipei')">
                        <div class="item-content"><span class="item-label">Taipei</span><div class="item-check" id="check-Asia/Taipei"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="tokyo japan" onclick="setTimezone('Asia/Tokyo', 'Tokyo')">
                        <div class="item-content"><span class="item-label">Tokyo</span><div class="item-check" id="check-Asia/Tokyo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="seoul korea" onclick="setTimezone('Asia/Seoul', 'Seoul')">
                        <div class="item-content"><span class="item-label">Seoul</span><div class="item-check" id="check-Asia/Seoul"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="singapore" onclick="setTimezone('Asia/Singapore', 'Singapore')">
                        <div class="item-content"><span class="item-label">Singapore</span><div class="item-check" id="check-Asia/Singapore"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="bangkok thailand" onclick="setTimezone('Asia/Bangkok', 'Bangkok')">
                        <div class="item-content"><span class="item-label">Bangkok</span><div class="item-check" id="check-Asia/Bangkok"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="dubai uae" onclick="setTimezone('Asia/Dubai', 'Dubai')">
                        <div class="item-content"><span class="item-label">Dubai</span><div class="item-check" id="check-Asia/Dubai"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="mumbai india" onclick="setTimezone('Asia/Kolkata', 'Mumbai')">
                        <div class="item-content"><span class="item-label">Mumbai</span><div class="item-check" id="check-Asia/Kolkata"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="jakarta indonesia" onclick="setTimezone('Asia/Jakarta', 'Jakarta')">
                        <div class="item-content"><span class="item-label">Jakarta</span><div class="item-check" id="check-Asia/Jakarta"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="sydney australia" onclick="setTimezone('Australia/Sydney', 'Sydney')">
                        <div class="item-content"><span class="item-label">Sydney</span><div class="item-check" id="check-Australia/Sydney"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="melbourne australia" onclick="setTimezone('Australia/Melbourne', 'Melbourne')">
                        <div class="item-content"><span class="item-label">Melbourne</span><div class="item-check" id="check-Australia/Melbourne"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="auckland new zealand" onclick="setTimezone('Pacific/Auckland', 'Auckland')">
                        <div class="item-content"><span class="item-label">Auckland</span><div class="item-check" id="check-Pacific/Auckland"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="manila philippines" onclick="setTimezone('Asia/Manila', 'Manila')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Manila</span><div class="item-check" id="check-Asia/Manila"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">EUROPE</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="london uk" onclick="setTimezone('Europe/London', 'London')">
                        <div class="item-content"><span class="item-label">London</span><div class="item-check" id="check-Europe/London"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="paris france" onclick="setTimezone('Europe/Paris', 'Paris')">
                        <div class="item-content"><span class="item-label">Paris</span><div class="item-check" id="check-Europe/Paris"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="berlin germany" onclick="setTimezone('Europe/Berlin', 'Berlin')">
                        <div class="item-content"><span class="item-label">Berlin</span><div class="item-check" id="check-Europe/Berlin"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="rome italy" onclick="setTimezone('Europe/Rome', 'Rome')">
                        <div class="item-content"><span class="item-label">Rome</span><div class="item-check" id="check-Europe/Rome"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="madrid spain" onclick="setTimezone('Europe/Madrid', 'Madrid')">
                        <div class="item-content"><span class="item-label">Madrid</span><div class="item-check" id="check-Europe/Madrid"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="amsterdam netherlands" onclick="setTimezone('Europe/Amsterdam', 'Amsterdam')">
                        <div class="item-content"><span class="item-label">Amsterdam</span><div class="item-check" id="check-Europe/Amsterdam"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="zurich switzerland" onclick="setTimezone('Europe/Zurich', 'Zurich')">
                        <div class="item-content"><span class="item-label">Zurich</span><div class="item-check" id="check-Europe/Zurich"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="vienna austria" onclick="setTimezone('Europe/Vienna', 'Vienna')">
                        <div class="item-content"><span class="item-label">Vienna</span><div class="item-check" id="check-Europe/Vienna"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="stockholm sweden" onclick="setTimezone('Europe/Stockholm', 'Stockholm')">
                        <div class="item-content"><span class="item-label">Stockholm</span><div class="item-check" id="check-Europe/Stockholm"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="athens greece" onclick="setTimezone('Europe/Athens', 'Athens')">
                        <div class="item-content"><span class="item-label">Athens</span><div class="item-check" id="check-Europe/Athens"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="moscow russia" onclick="setTimezone('Europe/Moscow', 'Moscow')">
                        <div class="item-content"><span class="item-label">Moscow</span><div class="item-check" id="check-Europe/Moscow"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="istanbul turkey" onclick="setTimezone('Europe/Istanbul', 'Istanbul')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Istanbul</span><div class="item-check" id="check-Europe/Istanbul"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">AMERICAS</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="new york usa" onclick="setTimezone('America/New_York', 'New York')">
                        <div class="item-content"><span class="item-label">New York</span><div class="item-check" id="check-America/New_York"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="los angeles la usa" onclick="setTimezone('America/Los_Angeles', 'Los Angeles')">
                        <div class="item-content"><span class="item-label">Los Angeles</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="chicago usa" onclick="setTimezone('America/Chicago', 'Chicago')">
                        <div class="item-content"><span class="item-label">Chicago</span><div class="item-check" id="check-America/Chicago"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="toronto canada" onclick="setTimezone('America/Toronto', 'Toronto')">
                        <div class="item-content"><span class="item-label">Toronto</span><div class="item-check" id="check-America/Toronto"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="vancouver canada" onclick="setTimezone('America/Vancouver', 'Vancouver')">
                        <div class="item-content"><span class="item-label">Vancouver</span><div class="item-check" id="check-America/Vancouver"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="mexico city" onclick="setTimezone('America/Mexico_City', 'Mexico City')">
                        <div class="item-content"><span class="item-label">Mexico City</span><div class="item-check" id="check-America/Mexico_City"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="sao paulo brazil" onclick="setTimezone('America/Sao_Paulo', 'Sao Paulo')">
                        <div class="item-content"><span class="item-label">Sao Paulo</span><div class="item-check" id="check-America/Sao_Paulo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="buenos aires argentina" onclick="setTimezone('America/Argentina/Buenos_Aires', 'Buenos Aires')">
                        <div class="item-content"><span class="item-label">Buenos Aires</span><div class="item-check" id="check-America/Argentina/Buenos_Aires"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="san francisco usa" onclick="setTimezone('America/Los_Angeles', 'San Francisco')">
                        <div class="item-content"><span class="item-label">San Francisco</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="seattle usa" onclick="setTimezone('America/Los_Angeles', 'Seattle')">
                        <div class="item-content"><span class="item-label">Seattle</span><div class="item-check" id="check-America/Los_Angeles"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="miami usa" onclick="setTimezone('America/New_York', 'Miami')">
                        <div class="item-content"><span class="item-label">Miami</span><div class="item-check" id="check-America/New_York"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="honolulu hawaii" onclick="setTimezone('Pacific/Honolulu', 'Honolulu')">
                        <div class="item-content"><span class="item-label">Honolulu</span><div class="item-check" id="check-Pacific/Honolulu"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="anchorage alaska" onclick="setTimezone('America/Anchorage', 'Anchorage')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Anchorage</span><div class="item-check" id="check-America/Anchorage"></div></div>
                    </div>
                </div>

                <div class="tz-group-title">MIDDLE EAST & AFRICA</div>
                <div class="ios-list-group">
                    <div class="ios-list-item tz-item" data-keywords="riyadh saudi arabia" onclick="setTimezone('Asia/Riyadh', 'Riyadh')">
                        <div class="item-content"><span class="item-label">Riyadh</span><div class="item-check" id="check-Asia/Riyadh"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="cairo egypt" onclick="setTimezone('Africa/Cairo', 'Cairo')">
                        <div class="item-content"><span class="item-label">Cairo</span><div class="item-check" id="check-Africa/Cairo"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="johannesburg south africa" onclick="setTimezone('Africa/Johannesburg', 'Johannesburg')">
                        <div class="item-content"><span class="item-label">Johannesburg</span><div class="item-check" id="check-Africa/Johannesburg"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="nairobi kenya" onclick="setTimezone('Africa/Nairobi', 'Nairobi')">
                        <div class="item-content"><span class="item-label">Nairobi</span><div class="item-check" id="check-Africa/Nairobi"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="tehran iran" onclick="setTimezone('Asia/Tehran', 'Tehran')">
                        <div class="item-content"><span class="item-label">Tehran</span><div class="item-check" id="check-Asia/Tehran"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="jerusalem israel" onclick="setTimezone('Asia/Jerusalem', 'Jerusalem')">
                        <div class="item-content"><span class="item-label">Jerusalem</span><div class="item-check" id="check-Asia/Jerusalem"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="qatar doha" onclick="setTimezone('Asia/Qatar', 'Doha')">
                        <div class="item-content"><span class="item-label">Doha</span><div class="item-check" id="check-Asia/Qatar"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="casablanca morocco" onclick="setTimezone('Africa/Casablanca', 'Casablanca')">
                        <div class="item-content"><span class="item-label">Casablanca</span><div class="item-check" id="check-Africa/Casablanca"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="lagos nigeria" onclick="setTimezone('Africa/Lagos', 'Lagos')">
                        <div class="item-content"><span class="item-label">Lagos</span><div class="item-check" id="check-Africa/Lagos"></div></div>
                    </div>
                    <div class="ios-list-item tz-item" data-keywords="cape town" onclick="setTimezone('Africa/Johannesburg', 'Cape Town')">
                        <div class="item-content" style="border-bottom:none;"><span class="item-label">Cape Town</span><div class="item-check" id="check-Africa/Johannesburg"></div></div>
                    </div>
                </div>

                <div id="tz-no-result" style="display:none; text-align:center; padding:40px; color:#999; font-size:14px;">
                    No Results Found
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-api" class="ios-sub-page" style="display: flex; flex-direction: column; height: 100%; width: 100%; background: #F2F2F7; position: absolute; top: 0; left: 0; z-index: 20;">
        
        <div class="app-header" style="flex-shrink: 0; height: 110px; padding-top: 55px; padding-bottom: 12px; background: rgba(242,242,247,0.95); backdrop-filter: saturate(180%) blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: flex-end; justify-content: space-between; padding-left: 16px; padding-right: 16px; z-index: 50; box-sizing: border-box;">
            
            <div onclick="closeSubPage('subpage-api')" style="color: #007AFF; font-size: 16px; display: flex; align-items: center; cursor: pointer; width: 70px; height: 30px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: -2px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
                Back
            </div>
            
            <div style="font-size: 17px; font-weight: 600; text-align: center; flex: 1; padding-bottom: 5px;">AI Config</div>
            
            <div onclick="openSavePresetModal()" style="color: #007AFF; font-size: 16px; font-weight: 600; cursor: pointer; width: 70px; text-align: right; height: 30px; line-height: 30px;">
                Save
            </div>
        </div>

        <div class="app-body" style="flex: 1; overflow-y: auto; padding: 10px 16px 100px 16px; -webkit-overflow-scrolling: touch; width: 100%; display: flex; flex-direction: column; align-items: stretch; box-sizing: border-box;">
            
            <div class="tz-group-title" style="margin-top: 20px;">CONNECTION</div>
            <div class="ios-list-group">
                <div class="ios-list-item input-item">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Host</span>
                    <input type="text" id="api-url" class="ios-input-clean" placeholder="https://api.openai.com/v1">
                </div>
                <div class="ios-list-item input-item">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Key</span>
                    <input type="password" id="api-key" class="ios-input-clean" placeholder="sk-...">
                </div>
            </div>

            <div class="tz-group-title">MODEL</div>
            <div class="ios-list-group" style="padding: 0;">
                <div class="ios-list-item" style="padding-right: 16px;" onclick="openModelPicker()">
                    <span class="item-label" style="width: 70px; flex-shrink: 0;">Name</span>
                    
                    <div id="api-model-display" style="flex:1; text-align:right; color:#007AFF; font-size:16px; display:flex; align-items:center; justify-content:flex-end;">
                        gpt-3.5-turbo
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>

                    <input type="hidden" id="api-model-select" value="gpt-3.5-turbo">
                </div>
                
                <div class="ios-list-item" style="justify-content: center; color: #007AFF; font-weight: 600; cursor: pointer;" onclick="fetchModelList()">
                    Fetch Models from Server
                </div>
            </div>

            <div class="tz-group-title">PARAMETERS</div>
            <div class="ios-list-group" style="padding: 20px 16px; display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Temperature</span>
                    <span id="temp-display" style="font-weight:700;">0.7</span>
                </div>
                <input type="range" id="api-temp" min="0" max="2" step="0.1" value="0.7" class="ios-slider" 
                    oninput="document.getElementById('temp-display').textContent = this.value; updateSliderFill(this)">
                <div style="height:25px;"></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Context Limit</span>
                    <span id="context-display" style="font-weight:700;">10</span>
                </div>
                <input type="range" id="api-context" min="2" max="30" step="2" value="10" class="ios-slider" 
                    oninput="document.getElementById('context-display').textContent = this.value; updateSliderFill(this)">
            </div>

            <div class="tz-group-title">TEST CONNECTION</div>
            <div id="test-chat-log" class="chat-log-area">
                <div style="color:#999; text-align:center; margin-top:50px; font-size:13px;">
                    Test your connection here...
                </div>
            </div>
            
            <div class="chat-input-bar">
                <input type="text" id="test-chat-input" class="chat-input-field" placeholder="Say hello...">
                <div class="chat-send-btn" onclick="sendTestChat()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
            </div>

            <div class="tz-group-title">SAVED PRESETS</div>
            <div id="preset-list" class="ios-list-group">
                <div class="ios-list-item" style="color:#999; justify-content:center;">No presets saved</div>
            </div>

            <button class="ios-btn" style="background: #FF3B30; color: #fff; margin-top: 30px; margin-bottom: 20px; flex-shrink: 0;" onclick="openResetConfirm()">
                Reset All Settings
            </button>

        </div>
    </div>
    <div id="subpage-display" class="ios-sub-page">
        <div class="app-header">
            <div onclick="closeSubPage('subpage-display')" style="color:#007AFF; font-size:17px; cursor:pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:-6px;"><polyline points="15 18 9 12 15 6"></polyline></svg> Back
            </div>
            <div style="font-size:17px; font-weight:600;">Display & Font</div>
            <div onclick="window.saveFontSettings()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">Save</div>
        </div>

        <div class="app-body">
            <div class="tz-group-title">Real-time Preview</div>
            <div style="display:flex; gap:10px; margin-bottom:24px;">
                <div style="flex:1; background:#fff; border-radius:14px; padding:15px; height:100px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div id="preview-text-main">App Text</div>
                </div>
                <div style="flex:1; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:14px; padding:15px; height:100px; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div id="preview-text-desktop">Home Text</div>
                </div>
            </div>

            <div class="tz-group-title">Color Palettes</div>
            <div class="ios-list-group">
                <div class="ios-list-item color-item-row">
                    <span class="item-label">App Interface</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="color-val-main" style="font-size:12px; color:#8e8e93; font-family:monospace;">#1D1D1F</span>
                        <input type="color" id="color-picker-main" class="color-picker-circle" oninput="window.updateColorPreview('main', this.value)">
                    </div>
                </div>
                <div class="ios-list-item color-item-row" style="border-bottom:none;">
                    <span class="item-label">Home Screen</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span id="color-val-desktop" style="font-size:12px; color:#8e8e93; font-family:monospace;">#1D1D1F</span>
                        <input type="color" id="color-picker-desktop" class="color-picker-circle" oninput="window.updateColorPreview('desktop', this.value)">
                    </div>
                </div>
            </div>

            <div class="tz-group-title" style="margin-top:24px;">Font Style</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openFontPicker()">
                    <span class="item-label">Font Family</span>
                    <div id="font-family-display" style="flex:1; text-align:right; color:#007AFF; display:flex; align-items:center; justify-content:flex-end;">System Default <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                </div>
                <div class="ios-list-item" style="color:#007AFF; justify-content:center; font-weight:600;" onclick="document.getElementById('upload-font-file').click()">Import .ttf Font</div>
                <input type="file" id="upload-font-file" accept=".ttf,.otf" style="display:none;" onchange="window.handleFontUpload(this)">
            </div>

            <div class="tz-group-title">Typography</div>
            <div class="ios-list-group" style="padding: 20px 16px; display: block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Size</span>
                    <span id="size-display" style="font-weight:700;">16px</span>
                </div>
                <input type="range" id="font-size-slider" min="12" max="24" step="1" value="16" class="ios-slider" 
                    oninput="window.updateFontPreview('size', this.value); updateSliderFill(this)">
                
                <div style="height:30px;"></div>

                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:13px; color:#666;">Weight</span>
                    <span id="weight-display" style="font-weight:700;">400</span>
                </div>
                <input type="range" id="font-weight-slider" min="100" max="900" step="100" value="400" class="ios-slider" 
                    oninput="window.updateFontPreview('weight', this.value); updateSliderFill(this)">
            </div>

            <button class="ios-btn" style="background:#FF3B30; color:#fff; margin-top:30px;" onclick="window.resetFontSettings()">Reset to Default</button>
        </div>
    </div>
    <div id="subpage-instructions" class="ios-sub-page">
        <div class="app-header">
            <div onclick="closeSubPage('subpage-instructions')" style="color: #007AFF; font-size: 17px; cursor:pointer; display:flex; align-items:center; width: 70px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:-2px;"><polyline points="15 18 9 12 15 6"></polyline></svg> Back
            </div>
            <div style="font-size:17px; font-weight:600; text-align:center; flex:1;">Instructions</div>
            <div style="width:70px;"></div>
        </div>

        <div class="app-body">
            <div class="tz-group-title">SYSTEM MODULES</div>
            
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openInsAppModal('ins-wallpaper-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5" fill="white"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: 0.5px solid rgba(0,0,0,0.05);">
                        <span class="item-label">Wallpaper Engine</span>
                    </div>
                </div>

                <div class="ios-list-item" onclick="openInsAppModal('ins-character-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: 0.5px solid rgba(0,0,0,0.05);">
                        <span class="item-label">Character Book</span>
                    </div>
                </div>

                <div class="ios-list-item" onclick="openInsAppModal('ins-settings-modal')">
                    <div class="ins-app-icon-sync" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%);">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="#3a3a3c">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                        </svg>
                    </div>
                    <div class="item-content" style="border-bottom: none;">
                        <span class="item-label">System Settings</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px; opacity: 0.3; font-size: 11px;">
                iOS Pro Ultimate System Edition
            </div>
        </div>
    </div>

</div>
<div id="iosInputModal" class="ios-alert-mask" style="z-index: 20000;">
    <div class="ios-alert-box">
        <div class="alert-title" id="input-modal-title">Name This Preset</div>
        <div style="padding: 0 15px 15px 15px;">
            <input type="text" id="input-modal-val" class="ios-input" style="margin:0; text-align:center;" placeholder="e.g. GPT-4">
        </div>
        <div style="display:flex; border-top:0.5px solid rgba(60,60,67,0.29);">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid rgba(60,60,67,0.29); color:#007AFF; font-weight:400;" onclick="closeInputModal()">Cancel</div>
            <div class="alert-btn" style="flex:1; color:#007AFF;" onclick="confirmInputModal()">Save</div>
        </div>
    </div>
</div>

<div id="iosConfirmModal" class="ios-alert-mask" style="z-index: 20000;">
    <div class="ios-alert-box">
        <div class="alert-title" id="confirm-modal-title">Are you sure?</div>
        <div class="alert-msg" id="confirm-modal-msg">This action cannot be undone.</div>
        <div style="display:flex; border-top:0.5px solid rgba(60,60,67,0.29);">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid rgba(60,60,67,0.29); color:#007AFF; font-weight:400;" onclick="closeConfirmModal()">Cancel</div>
            <div class="alert-btn" id="confirm-modal-btn" style="flex:1; color:#FF3B30;" onclick="executeConfirmAction()">Delete</div>
        </div>
    </div>
</div>
<div id="modelPickerSheet" class="ios-alert-mask" style="display:none; align-items:flex-end; background:rgba(0,0,0,0.4); z-index: 99999;" onclick="closeModelPicker()">
    <div class="ios-action-sheet" onclick="event.stopPropagation()">
        <div class="sheet-title-box">Select AI Model</div>
        
        <div id="model-sheet-list" style="max-height:300px; overflow-y:auto; -webkit-overflow-scrolling:touch;">
            <div class="sheet-item" onclick="selectModel('gpt-3.5-turbo')">gpt-3.5-turbo</div>
            <div class="sheet-item" onclick="selectModel('gpt-4o')">gpt-4o</div>
            <div class="sheet-item" onclick="selectModel('claude-3-5-sonnet')">claude-3-5-sonnet</div>
        </div>
        
        <div class="sheet-cancel" onclick="closeModelPicker()">Cancel</div>
    </div>
</div>
<div id="ins-wallpaper-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px);">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-wallpaper-modal')"></div>
            <div class="ins-brand-tag">MODULE INFO</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5" fill="white"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">Wallpaper Engine</h2>
            <p class="ins-subtitle">Personalization & Visual Core</p>
            
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Hybrid Rendering</strong>
                        <p>å†…ç½®æ··åˆæ¸²æŸ“æŠ€æœ¯ã€‚æ”¯æŒ 8K è¶…é«˜æ¸…é™æ€å›¾åƒï¼ˆJPG/PNGï¼‰ä¸åŠ¨æ€è§†é¢‘æµï¼ˆMP4/WebMï¼‰ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶åç¼€å¹¶æ™ºèƒ½åˆ‡æ¢ Canvas æˆ– Video æ¸²æŸ“å±‚ï¼Œç¡®ä¿ç”»è´¨é›¶æŸè€—ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>Binary Storage Logic</strong>
                        <p>æ‘’å¼ƒä¼ ç»Ÿçš„ URL å¼•ç”¨æ–¹å¼ï¼Œé‡‡ç”¨ Blob äºŒè¿›åˆ¶æŠ€æœ¯å°†å£çº¸å­˜å…¥æµè§ˆå™¨åº•å±‚çš„ IndexedDBã€‚è¿™æ„å‘³ç€å³ä¾¿ä½ å…³é—­ç½‘é¡µæˆ–å¤„äºç¦»çº¿çŠ¶æ€ï¼Œå‡ ç™¾å…†çš„åŠ¨æ€å£çº¸ä¾ç„¶èƒ½å®ç°â€œç§’å¼€â€è€Œä¸æ¶ˆè€—ç½‘ç»œæµé‡ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Interactive Selection</strong>
                        <p>ç‚¹å‡»â€œSelect Fileâ€å”¤èµ·ç³»ç»Ÿçº§æ–‡ä»¶é€‰æ‹©å™¨ã€‚é€‰æ‹©åï¼Œç³»ç»Ÿå°†è¿›å…¥â€œé¢„è½½å…¥æ€ï¼ˆPre-loadingï¼‰â€ï¼Œé¢„è§ˆæ»¡æ„åç‚¹å‡»åº•éƒ¨ç¡®è®¤é”®ï¼Œå£çº¸å°†é€šè¿‡å…¨å±€æ€»çº¿ï¼ˆEvent Busï¼‰å®æ—¶æ¨é€åˆ°èƒŒæ™¯å±‚ï¼Œæ— éœ€åˆ·æ–°é¡µé¢ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Layer Compositing</strong>
                        <p>å£çº¸å±‚ä¸ UI å±‚é‡‡ç”¨ç‰©ç†éš”ç¦»ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºå£çº¸ä¸Šæ–¹è¦†ç›–ä¸€å±‚åŠ¨æ€é®ç½©ï¼ˆOverlayï¼‰ï¼Œæ ¹æ®å£çº¸äº®åº¦è‡ªåŠ¨å¾®è°ƒå¯¹æ¯”åº¦ï¼Œç¡®ä¿å³ä¾¿æ˜¯åœ¨å…¨ç™½å£çº¸ä¸‹ï¼ŒçŠ¶æ€æ å’Œ App ä¾ç„¶æ¸…æ™°å¯è§ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Memory Cleaning</strong>
                        <p>ç³»ç»Ÿå®æ—¶ç›‘æ§å£çº¸å ç”¨çš„ç¼“å­˜ç©ºé—´ã€‚å½“ä½ æƒ³æ›´æ¢é£æ ¼æ—¶ï¼Œç‚¹å‡»â€œResetâ€å°†æ‰§è¡Œæ·±åº¦åƒåœ¾å›æ”¶ï¼ˆGCï¼‰é€»è¾‘ï¼Œå½»åº•æŠ¹é™¤æ—§å£çº¸æ®‹ç•™çš„å†…å­˜ç¢ç‰‡ï¼Œä¿æŒç³»ç»Ÿæé€Ÿè¿è¡Œã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-wallpaper-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>
<div id="ins-character-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); display:none;">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-character-modal')" style="background: #FFBD2E;"></div>
            <div class="ins-brand-tag">CHARACTER CORE</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">Character Book</h2>
            <p class="ins-subtitle">Identity & Interactive Logic</p>
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Lifecycle Management</strong>
                        <p>ç‚¹å‡»åˆ—è¡¨é¦–ä½çš„â€œè™šçº¿æ–¹æ¡†â€å³å¯è¿›å…¥åˆ›ä½œæ¨¡å¼ã€‚ç³»ç»Ÿæ”¯æŒæ— é™é‡åˆ›å»ºè™šæ‹Ÿè§’è‰²ï¼Œæ¯ä¸ªè§’è‰²æ‹¥æœ‰ç‹¬ç«‹çš„å”¯ä¸€ IDï¼Œç¡®ä¿æ•°æ®åœ¨å¤æ‚çš„è”è§‰é€»è¾‘ä¸­äº’ä¸å¹²æ‰°ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>Aesthetic Skinning</strong>
                        <p>è¿›å…¥è¯¦æƒ…é¡µåï¼Œç‚¹å‡»é¡¶éƒ¨åŒºåŸŸå¯å”¤èµ·â€œå°é¢é‡‡é›†å™¨â€ï¼Œæ”¯æŒæœ¬åœ°æ–‡ä»¶ä¸Šä¼ æˆ–ç²˜è´´ 4K URLã€‚å¤´åƒæ¡†é‡‡ç”¨ç‰©ç†é‡å è§†è§‰ç®—æ³•ï¼Œé…åˆæ¯›ç»ç’ƒæ»¤é•œï¼Œè¥é€ é¡¶çº§æ‚å¿—å°é¢æ„Ÿã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Interaction Protocol</strong>
                        <p>ç‚¹å‡»ç®€ä»‹åŒºçš„â€œMoreâ€å¯è§¦å‘å…¨å±æ²‰æµ¸å¼é˜…è¯»æ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šæ ¹æ®è§’è‰²èƒŒæ™¯è‡ªåŠ¨è°ƒæ•´å…‰å½±æ°›å›´ï¼Œç‚¹å‡»æ‚¬æµ®è¿”å›é”®å³å¯æ— ç¼åˆ‡å›ç®¡ç†ç½‘æ ¼ï¼Œä½“éªŒä¸æ»‘ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Persistent Core</strong>
                        <p>æ‰€æœ‰è§’è‰²è®¾å®šï¼ˆå§“åã€ç®€ä»‹ã€å°é¢å›¾ã€å¤´åƒï¼‰å‡é‡‡ç”¨å¼‚æ­¥å†™å…¥æŠ€æœ¯å­˜å…¥æµè§ˆå™¨åº•å±‚æ•°æ®åº“ï¼ˆIndexedDBï¼‰ã€‚å³ä¾¿æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–ç¦»çº¿ä½¿ç”¨ï¼Œä½ çš„è§’è‰²ä¹¦ä¾ç„¶æ°¸å­˜ã€‚</p>
                    </div>
                </div>
                
                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Operations Guide</strong>
                        <p>é•¿æŒ‰æˆ–ç‚¹å‡»â€œEdit Profileâ€å¯å®æ—¶ä¿®æ”¹è§’è‰²é…ç½®ï¼›ç‚¹å‡»å±é™©çº¢åŒºçš„â€œDeleteâ€å°†è§¦å‘åŒé‡ç”Ÿç‰©ç¡®è®¤é€»è¾‘ï¼Œé˜²æ­¢çè´µæ•°æ®è¯¯åˆ ã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-character-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>

<div id="ins-settings-modal" class="ios-alert-mask" style="z-index: 6000; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); display:none;">
    <div class="ins-fancy-card">
        <div class="ins-card-nav">
            <div class="ins-close-dot" onclick="closeInsAppModal('ins-settings-modal')" style="background: #28C940;"></div>
            <div class="ins-brand-tag">SYSTEM KERNEL</div>
        </div>

        <div class="ins-card-hero">
            <div class="ins-hero-bg" style="background: linear-gradient(135deg, #e5e5ea 0%, #d1d1d6 100%);"></div>
            <div class="ins-hero-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="#3a3a3c">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path>
                </svg>
            </div>
        </div>

        <div class="ins-card-body">
            <h2 class="ins-title-serif">System Settings</h2>
            <p class="ins-subtitle">Global Environment Tuning</p>
            <div class="ins-divider-line"></div>

            <div class="ins-feature-list">
                <div class="ins-feat-item">
                    <span class="feat-num">01</span>
                    <div class="feat-text">
                        <strong>Global Timezone Sync</strong>
                        <p>é›†æˆ 50 ä¸ªå…¨çƒæ ¸å¿ƒåŸå¸‚æ—¶åŒºæ•°æ®ã€‚æ”¯æŒæ¨¡ç³Šæœç´¢è¿‡æ»¤ï¼Œé€‰ä¸­åŸå¸‚åç³»ç»Ÿå°†æ ¹æ® Intl åè®®æ¯«ç§’çº§åŒæ­¥æ¡Œé¢å¤©æ°”ç»„ä»¶ä¸çŠ¶æ€æ çš„æ—¶é—´æ˜¾ç¤ºã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">02</span>
                    <div class="feat-text">
                        <strong>AI Configuration</strong>
                        <p>æ”¯æŒæ¥å…¥ OpenAI æ ‡å‡†æ¥å£ã€‚ä½ å¯ä»¥åœ¨æ­¤é…ç½® Host ä¸ API Keyï¼Œå¹¶è°ƒèŠ‚ Temperatureï¼ˆåˆ›é€ åŠ›ï¼‰å’Œ Contextï¼ˆè®°å¿†æ·±åº¦ï¼‰ã€‚å†…ç½® iMessage é£æ ¼çš„æµ‹è¯•æ²™ç›’ï¼Œç”¨äºéªŒè¯è¿æ¥æ˜¯å¦æˆåŠŸã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">03</span>
                    <div class="feat-text">
                        <strong>Display & Font Settings</strong>
                        <p>æ”¯æŒå…¨å±€å­—å·ï¼ˆ12px-24pxï¼‰ä¸ç²—ç»†ï¼ˆ100-900ï¼‰è°ƒèŠ‚ã€‚æä¾› .ttf æ–‡ä»¶ä¸Šä¼ æ¥å£ã€‚é€šè¿‡ CSS å˜é‡æŠ€æœ¯å®ç°å®æ—¶é¢„è§ˆï¼Œä¸”å…·å¤‡æ¡Œé¢å¸ƒå±€ä¿æŠ¤åŠŸèƒ½ï¼Œé˜²æ­¢å›¾æ ‡æ–‡å­—è¢«æŒ¤ä¹±ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">04</span>
                    <div class="feat-text">
                        <strong>Color Customization</strong>
                        <p>é‡‡ç”¨ç‰©ç†åˆ†ç¦»è°ƒè‰²é€»è¾‘ã€‚ä½ å¯ä»¥ç‹¬ç«‹å®šä¹‰ App å†…éƒ¨åˆ—è¡¨çš„æ–‡å­—é¢œè‰²ï¼Œä»¥åŠä¸»å±å¹•ï¼ˆçŠ¶æ€æ ã€å›¾æ ‡åã€å¤©æ°”ï¼‰çš„æ–‡å­—é¢œè‰²ã€‚æ”¯æŒå®æ—¶ HEX ç åé¦ˆä¸ä¿å­˜åŒæ­¥ã€‚</p>
                    </div>
                </div>

                <div class="ins-feat-item">
                    <span class="feat-num">05</span>
                    <div class="feat-text">
                        <strong>Persistence & Reset</strong>
                        <p>æ‰€æœ‰è®¾ç½®å˜æ›´å‡é€šè¿‡ LocalStorage å®æ—¶ä¿å­˜ã€‚ç³»ç»Ÿåº•éƒ¨æä¾›çº¢è‰²â€œReset to Defaultsâ€æŒ‰é’®ï¼Œå¯ä¸€é”®æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰é…ç½®å¹¶æ¢å¤åˆ°åˆå§‹è“é»‘ä¸»é¢˜ã€‚</p>
                    </div>
                </div>
            </div>

            <button class="ins-done-btn" onclick="closeInsAppModal('ins-settings-modal')">ACKNOWLEDGED</button>
        </div>
    </div>
</div>
<div id="p2-editor-modal" class="ios-alert-mask" onclick="if(event.target==this) window.closeP2Editor()">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span id="p2-editor-title">Update Hero Cover</span>
            <div class="p2-done-btn" onclick="window.closeP2Editor()">Done</div>
        </div>
        
        <div class="p2-editor-body">
            <input type="text" id="p2-main-input" class="p2-main-input" placeholder="Paste image link here...">
            
            <div id="p2-upload-area">
                <div style="text-align:center; color:#d1d1d6; font-size:12px; margin-bottom:15px; font-weight:800;">OR</div>
                
                <label class="custom-upload-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <span>Upload from Gallery</span>
                    <input type="file" id="p2-file-input" hidden accept="image/*" onchange="window.handleP2File(this)">
                </label>
            </div>
        </div>
    </div>
</div>
<div id="cipher-web-app" class="full-app-screen" style="display:none; background:#000;">
    <div class="app-header">
        <div class="back-btn" onclick="closeApp('cipherWebApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        </div>
        <div class="app-title-group">
            <span class="main-title">Cipher Web</span>
            <span class="sub-status" id="web-ai-status">Connected to RoleBook</span>
        </div>
        <div class="header-action" onclick="resetWeb()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L19 10M1 14l1.64 4.36A9 9 0 0 0 17.51 15"/></svg></div>
    </div>

    <div class="web-canvas-container" id="web-canvas">
        <svg id="web-svg-layer" width="100%" height="100%">
            </svg>
        <div id="web-nodes-layer">
            </div>
    </div>

    <div class="web-input-bar">
        <input type="text" id="cipher-input" placeholder="Whisper a word..." onkeypress="if(event.key==='Enter') sendCipher()">
        <button class="send-cipher-btn" onclick="sendCipher()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
    </div>
</div>
<div id="vibe-grid-app" class="ios-app-window" style="background: #F2F2F7;">
    <div class="app-header">
    <div class="header-title-big">Vibe Grid</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span onclick="openVibeHistory()" style="font-size: 13px; color: #8e8e93; font-weight: 600; cursor: pointer;">å†å²</span>
            <span onclick="openVibeGuide()" style="font-size: 13px; color: #007AFF; font-weight: 600; cursor: pointer;">åè®®</span>
            <div class="header-close-btn" onclick="closeApp('vibe-grid-app')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <div class="app-body" style="display:flex; flex-direction:column;">
        
        <div id="vibe-start-screen" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:100px; height:100px; background:linear-gradient(135deg, #1d1d1f, #434343); border-radius:24px; display:flex; align-items:center; justify-content:center; box-shadow:0 15px 30px rgba(0,0,0,0.1); margin-bottom:30px;">
                <svg width="45" height="45" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            </div>
            <h2 style="font-weight:800; font-size:26px; color:#1d1d1f; margin-bottom:8px;">åšå¼ˆå›å“</h2>
            <p style="color:#8e8e93; font-size:14px; margin-bottom:40px;">åœ¨æ–¹å¯¸ä¹‹é—´ï¼Œä¸äººæ ¼ç¢ç‰‡å¯¹å¼ˆ</p>
            <button class="ios-btn primary" onclick="openVibeCharPicker()">é€‰æ‹©åšå¼ˆå¯¹è±¡</button>
            <div onclick="openVibeGuide()" style="margin-top:25px; font-size:13px; color:#007AFF; font-weight:600; cursor:pointer;">é˜…è¯»å¯¹å±€åè®®</div>
        </div>

        <div id="vibe-game-main" style="display:none; opacity:0;">
            <div id="vibe-turn-indicator" style="text-align:center; padding:20px 0; font-weight:700; color:#8e8e93; font-size:12px; letter-spacing:2px;">
                RESONANCE PHASE
            </div>
            
            <div class="vibe-board-wrapper">
                <div id="vibe-board" class="vibe-board"></div>
            </div>

            <div id="opponent-bar" style="margin: 30px auto; width: 85%; display: flex; align-items: center; background: #fff; padding: 12px 18px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); position: relative;">
                <img id="opp-avatar" src="" style="width:44px; height:44px; border-radius:50%; object-fit:cover; background:#eee;">
                <div style="margin-left:15px; text-align:left; flex: 1;">
                    <div id="opp-name" style="font-weight:800; font-size:15px;">å¯¹æ‰‹</div>
                    <div id="opp-last-word" style="font-size: 13px; color: #007AFF; font-family: serif; font-style: italic; font-weight: 500; margin-top: 2px; opacity: 0; transition: opacity 0.5s;">
                        ç­‰å¾…æ³¨é­‚...
                    </div>
                </div>
                <div style="font-size:10px; color:#d1d1d6; font-weight:700; letter-spacing:1px;">ACTIVE</div>
            </div>
        </div>
    </div>

    <div id="modal-vibe-picker" class="ios-alert-mask" style="display: none; align-items: flex-end; z-index: 8000;">
        <div class="p2-editor-sheet">
            <div class="p2-editor-header">
                <span style="font-weight: 800; font-size: 17px;">é€‰æ‹©åšå¼ˆå¯¹è±¡</span>
                <span class="p2-done-btn" onclick="document.getElementById('modal-vibe-picker').style.display='none'">å–æ¶ˆ</span>
            </div>
            <div id="vibe-char-scroll-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-height: 55vh; overflow-y: auto; padding: 0 20px 40px 20px;">
                </div>
        </div>
    </div>

    <div id="modal-vibe-word-input" class="vibe-center-mask" style="display:none;">
        <div class="ios-alert-box" style="width:280px; border-radius:24px;">
            <div style="padding:25px 20px 15px 20px;">
                <div style="font-weight:800; font-size:17px; margin-bottom:8px;">æ³¨é­‚</div>
                <div style="font-size:12px; color:#8e8e93; margin-bottom:20px;">è¯·ä¸ºæ­¤å¤„æ³¨å…¥ä¸€ä¸ªæƒ…ç»ªè¯æ±‡</div>
                <input type="text" id="vibe-user-word" class="ios-input" style="text-align:center; background:#f2f2f7;" placeholder="è¾“å…¥è¯è¯­">
            </div>
            <div style="display:flex; border-top:0.5px solid #eee;">
                <div class="alert-btn" style="flex:1; border-right:0.5px solid #eee; color:#8e8e93;" onclick="document.getElementById('modal-vibe-word-input').style.display='none'">æ”¾å¼ƒ</div>
                <div class="alert-btn" style="flex:1; color:#007AFF; font-weight:700;" onclick="confirmVibeStep()">ç¡®å®š</div>
            </div>
        </div>
    </div>

    <div id="modal-vibe-guide" class="ios-alert-mask" style="display:none; z-index:9000; background:rgba(0,0,0,0.2); backdrop-filter:blur(15px);">
        <div class="ins-fancy-card" style="max-width:320px; border: 1px solid rgba(255,255,255,0.3);">
            <div class="ins-card-body" style="text-align:left; padding:35px 25px;">
                <h2 class="ins-title-serif" style="text-align:center; font-size:22px; margin-bottom:25px; letter-spacing:1px;">å¯¹å±€åè®® (PROTOCOL)</h2>
                
                <div class="ins-feature-list" style="margin-bottom:30px;">
                    <div class="ins-feat-item" style="border-left: 1.5px solid #007AFF; padding-left:15px; margin-bottom:20px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">æ³¨é­‚ä¸å›å“</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">æ¯è½ä¸€å­ï¼Œéœ€æ³¨å…¥ä¸€ä¸ªæƒ…ç»ªè¯æ±‡ã€‚ä½ çš„äººæ ¼å¯¹æ‰‹å°†æ ¹æ®å…¶å›ºæœ‰é€»è¾‘ï¼Œå›ä»¥å¯¹åº”çš„è¯è¯­å…±é¸£ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="ins-feat-item" style="border-left: 1.5px solid #1d1d1f; padding-left:15px; margin-bottom:20px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">èƒœè´Ÿçš„å¼•åŠ›</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">äº”å­è¿ç å³ä¸ºèƒœã€‚è‹¥æ£‹ç›˜æ»¡æº¢è€Œå¹³è¡¡æœªç ´ï¼Œå¯¹å±€å°†å½’äºâ€œç©ºå¯‚â€ç»“å±€ã€‚</p>
                        </div>
                    </div>

                    <div class="ins-feat-item" style="border-left: 1.5px solid #d1d1d6; padding-left:15px;">
                        <div class="feat-text">
                            <strong style="font-size:14px; color:#1d1d1f; display:block; margin-bottom:5px;">å™äº‹é‡å¡‘</strong>
                            <p style="font-size:12px; color:#86868b; line-height:1.6;">å¯¹å±€ç»ˆäº†ï¼Œæ‰€æœ‰çš„è¯è¯­ç¢ç‰‡å°†æ±‡èšæˆä¸€æ®µç‹¬å±äºæ­¤åˆ»çš„ç§å¯†å›å“ã€‚é‚£æ˜¯ä½ ä»¬åšå¼ˆåçš„ä½™æ¸©ã€‚</p>
                        </div>
                    </div>
                </div>

                <button class="ins-done-btn" style="background:#1d1d1f; color:#fff; border-radius:12px;" onclick="closeVibeGuide()">è¿›å…¥åšå¼ˆ</button>
            </div>
        </div>
    </div>

    <div id="modal-vibe-result" class="ios-alert-mask vibe-center-box" style="display: none; z-index: 8000; background: rgba(0,0,0,0.4); backdrop-filter: blur(15px);">
        <div class="aesthetic-card" style="height: auto; max-height: 80vh; width: 90%; max-width: 340px; background: #fff; border-radius: 32px; overflow: hidden; display: flex; flex-direction: column;">
            <div class="aes-hero" style="height: 120px; position: relative; overflow: hidden;">
                <div class="aes-blur-bg" id="res-hero-bg" style="position: absolute; inset: -10%; background-size: cover; background-position: center; filter: blur(20px); opacity: 0.6;"></div>
                <div class="aes-overlay" style="position: absolute; inset: 0; background: linear-gradient(to bottom, transparent, #fff);"></div>
            </div>

            <div class="aes-float-content" style="margin-top: -40px; position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; text-align: center;">
                <div class="aes-avatar-box" style="width: 80px; height: 80px; border-radius: 20px; background: #fff; padding: 4px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: rotate(-2deg);">
                    <img id="res-avatar" src="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                </div>
                <div class="aes-title-group" style="margin-top: 15px;">
                    <div class="aes-name" id="res-title" style="font-size: 20px; font-weight: 800; color: #1d1d1f;">å¯¹å¼ˆå›å“</div>
                    <div class="aes-tag" id="res-outcome" style="margin-top: 5px; font-size: 10px; color: #007AFF; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;">MATCH ENDED</div>
                </div>
            </div>

            <div class="aes-scroll-area" style="flex: 1; padding: 20px 30px; overflow-y: auto; text-align: justify;">
                <div id="res-story" class="aes-text-body" style="font-family: serif; color: #444; line-height: 1.8; white-space: pre-wrap;">
                    æ­£åœ¨ç¼–ç»‡åšå¼ˆç•™ä¸‹çš„ä½™æ¸©...
                </div>
                <div style="border-top: 1px solid #f2f2f7; margin-top: 20px; padding-top: 15px; font-size: 10px; color: #ccc; text-align: center; letter-spacing: 1px;">
                    TRACES: <span id="res-words"></span>
                </div>
            </div>

            <div class="aes-control-bar" style="padding: 20px 30px 30px; display: flex; gap: 12px;">
                <div class="aes-btn edit" style="background: #f2f2f7; color: #1d1d1f; flex: 1; font-weight: 600;" onclick="archiveAndClose()">
                    å°å­˜å›å“
                </div>
                <div class="aes-btn edit" style="background: #007AFF; color: #fff; flex: 1; font-weight: 600;" onclick="restartVibeGame()">
                    å†æ¥ä¸€å±€
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-vibe-history" class="ios-sub-page" style="z-index: 8500; background: #F2F2F7;">
        <div class="app-header">
            <div onclick="closeVibeHistory()" style="color:#007AFF; font-size:17px; cursor:pointer; display:flex; align-items:center;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>è¿”å›
            </div>
            <div style="font-size:17px; font-weight:600;">è¿‡å¾€å›å“</div>
            <div style="width:50px;"></div>
        </div>
        <div class="app-body" id="vibe-history-list" style="padding: 20px 16px;">
            </div>
    </div>
</div>
<div id="worldApp" class="ios-app-window" style="background:#F2F2F7;">
    <div class="app-header">
        <div class="header-title-big">World</div>
        <div class="header-close-btn" onclick="closeApp('worldApp')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div id="world-grid" class="char-grid">
            </div>
    </div>
</div>

<div id="modal-world-viewer" class="ios-alert-mask" style="display:none; align-items:center; z-index:9500;" onclick="this.style.display='none'">
    <div class="world-minimal-card" onclick="event.stopPropagation()">
        <h1 id="world-v-title">ä¸–ç•Œåç§°</h1>
        <div class="world-line-decor"></div>
        <div class="world-viewer-scroll">
            <p id="world-v-content">è¿™é‡Œæ˜¯è¯¦ç»†çš„å†…å®¹æè¿°...</p>
        </div>
        <div style="display:flex; gap:12px; margin-top:25px;">
            <div class="world-action-btn" onclick="editWorld()">ç¼–è¾‘</div>
            <div class="world-action-btn delete" onclick="deleteWorld()">æŠ¹é™¤</div>
        </div>
    </div>
</div>

<div id="worldEditModal" class="ios-alert-mask" style="align-items:flex-end; z-index:9600;">
    <div class="modal-content" style="border-radius: 30px 30px 0 0; padding-bottom: 50px;">
        <div class="modal-top">
            <span class="modal-h1" id="world-modal-title">æ–°è®¾å®š</span>
            <span class="modal-done" onclick="saveWorld()">å®Œæˆ</span>
        </div>
        <input type="text" id="world-name-in" class="ios-input" placeholder="è¾“å…¥åç§°...">
        <textarea id="world-content-in" class="ios-input" style="height:150px; padding-top:12px;" placeholder="æè¿°å†…å®¹..."></textarea>
        <div class="tool-btn" onclick="document.getElementById('worldEditModal').style.display='none'" style="color:#FF3B30;">å–æ¶ˆ</div>
    </div>
</div>
<div id="chatApp" class="ios-app-window" style="background: #F2F2F7; z-index: 5500;">
    <div class="app-header" id="chat-header">
        <div class="header-title-big" id="chat-tab-title">Chat</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="chat-add-btn" style="display:none; cursor:pointer; color:#007AFF;" onclick="openChatAddChoice()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <div id="chat-close-btn" class="header-close-btn" onclick="closeApp('chatApp')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>
    </div>

    <div class="app-body" style="padding: 0; position: relative;">
        
        <div id="chat-panel-msg" class="chat-tab-panel active" style="display: flex; flex-direction: column; overflow: hidden !important;">
    
            <div class="chat-fixed-header" style="background: #fff; z-index: 10;">
                <div class="chat-section-label">Moments</div>
                <div class="chat-friend-ring-container" style="border-bottom:none; padding-bottom:10px;">
                    <div id="chat-friend-ring" class="friend-ring-wrapper">
                        </div>
                </div>
                <div class="chat-section-label" style="border-top: 0.5px solid #F2F2F7; padding-top:15px;">Conversations</div>
            </div>

            <div id="chat-msg-list" class="msg-list-container" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                </div>
        </div>

        <div id="chat-panel-list" class="chat-tab-panel">
            <div style="padding: 10px 16px; background:#F2F2F7;">
                <div class="segment-control" style="margin-bottom:0;">
                    <div class="segment-btn active" id="chat-subtab-friends" onclick="switchChatSubTab('friends')">å¥½å‹</div>
                    <div class="segment-btn" id="chat-subtab-groups" onclick="switchChatSubTab('groups')">ç¾¤èŠ</div>
                </div>
            </div>

            <div id="chat-list-content" style="padding: 0 16px; height: calc(100% - 60px); overflow-y: auto;">
                </div>
        </div>

        <div id="chat-panel-moments" class="chat-tab-panel">
            <div style="padding: 20px; color: #999; text-align: center; margin-top: 50px;">æ¢ç´¢è§’è‰²çš„ç”Ÿæ´»ç¢ç‰‡</div>
        </div>

        <div id="chat-panel-me" class="chat-tab-panel">
            <div style="padding: 30px 20px; display: flex; flex-direction: column; align-items: center;">
                <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin-bottom: 15px;"></div>
                <div style="font-weight: 800; font-size: 20px;">User</div>
            </div>
        </div>
    </div>

    <div class="chat-nav-wrapper">
        <div class="chat-bottom-nav">
            <div class="nav-item active" onclick="switchChatTab('msg', 'Messages', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                <span>æ¶ˆæ¯</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('list', 'Contacts', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>åˆ—è¡¨</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('moments', 'Moments', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                <span>åŠ¨æ€</span>
            </div>
            <div class="nav-item" onclick="switchChatTab('me', 'Profile', this)">
                <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>æˆ‘çš„</span>
            </div>
        </div>
    </div>
</div>
<div id="modal-chat-add-choice" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index:9800;">
    <div class="ios-action-sheet">
        <div class="sheet-title-box">æ–°è”ç³»äºº/è®¨è®ºç»„</div>
        <div class="sheet-item" onclick="openAddFriendPage()">æ·»åŠ å•ä¸ªå¥½å‹</div>
        <div class="sheet-item" onclick="openAddGroupPage()">å‘èµ·ç¾¤ç»„èŠ</div>
        <div class="sheet-cancel" onclick="document.getElementById('modal-chat-add-choice').style.display='none'">å–æ¶ˆ</div>
    </div>
</div>

<div id="page-add-friend" class="ios-app-window" style="background:#F2F2F7; z-index:9900; transform:translateY(100%);">
    <div class="app-header">
        <div onclick="closeChatSubPage('page-add-friend')" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">æ·»åŠ å¥½å‹</div>
        <div class="modal-done" onclick="saveChatFriend()">å®Œæˆ</div>
    </div>
    <div class="app-body">
        <div class="segment-control" style="width:100%; margin-bottom:20px;">
            <div class="segment-btn active" id="add-mode-create" onclick="setAddMode('create')">æ‰‹åŠ¨åˆ›å»º</div>
            <div class="segment-btn" id="add-mode-role" onclick="setAddMode('role')">è§’è‰²ä¹¦å¯¼å…¥</div>
        </div>
        <div id="panel-add-create" style="width:100%; text-align:center;">
            <div class="char-upload-circle" style="margin:0 auto 20px auto;" onclick="document.getElementById('in-f-avatar').click()">
                <img id="pre-f-avatar" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:50%;">
                <span id="hint-f-avatar">+ å¤´åƒ</span>
            </div>
            <input type="file" id="in-f-avatar" hidden accept="image/*" onchange="handleAvatarPre(this, 'pre-f-avatar', 'hint-f-avatar')">
            <input type="text" id="in-f-name" class="ios-input" placeholder="è¾“å…¥æ˜µç§°">
        </div>
        <div id="panel-add-role" style="display:none; width:100%;">
            <div id="role-picker-grid" class="char-grid"></div>
        </div>
    </div>
</div>

<div id="page-add-group" class="ios-app-window" style="background:#F2F2F7; z-index:9910; transform:translateY(100%);">
    <div class="app-header">
        <div onclick="closeChatSubPage('page-add-group')" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">å‘èµ·ç¾¤èŠ</div>
        <div id="group-submit-btn" style="color:#ccc; font-weight:700;">åˆ›å»º</div>
    </div>
    <div class="app-body">
        <div class="group-info-card">
            <div class="char-upload-circle" style="width:70px; height:70px; flex-shrink:0;" onclick="document.getElementById('in-g-avatar').click()">
                <img id="pre-g-avatar" style="display:none; width:100%; height:100%; object-fit:cover;">
                <span style="font-size:12px; color:#007AFF; font-weight:700;">+ å¤´åƒ</span>
            </div>
            <input type="file" id="in-g-avatar" hidden accept="image/*" onchange="handleAvatarPre(this, 'pre-g-avatar')">
            <input type="text" id="in-g-name" class="ios-input" style="margin:0; border-radius:10px; background:#F2F2F7;" placeholder="è¾“å…¥ç¾¤èŠåç§°...">
        </div>

        <div class="ios-list-group">
            <div class="ios-list-item">
                <span class="item-label">æœŸæœ›äººæ•°</span>
                <div class="item-right">
                    <input type="number" id="in-g-count" value="3" min="2" max="50">
                </div>
            </div>
        </div>

        <div class="tz-group-title">é€‰å–æˆå‘˜ (<span id="g-curr-count">0</span>/<span id="g-need-count">3</span>)</div>
        <div id="group-member-grid">
            </div>
    </div>
</div>
<div id="page-chat-room" class="ios-app-window chat-room-layer" style="background: #F2F2F7; transform: translateX(100%);">
    <div class="chat-room-header">
        <div class="header-glass-btn left" onclick="closeChatRoom()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </div>
        
        <div class="header-contact-info" onclick="openChatProfileFromRoom()">
            <img id="room-contact-avatar" src="" alt="avatar">
            <div class="header-text-stack">
                <span id="room-contact-name">Nickname</span>
                <span class="room-status-text">Online</span>
            </div>
        </div>

        <div class="header-glass-btn right" onclick="openChatSettings()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="19" cy="12" r="1"></circle>
                <circle cx="5" cy="12" r="1"></circle>
            </svg>
        </div>
    </div>

    <div id="chat-messages-container" class="chat-scroll-area">
        <div class="chat-time-divider">TODAY</div>
        </div>

    <div class="chat-room-footer" style="flex-direction: column; height: auto; min-height: 56px; padding: 0;">
        <div id="quote-preview" class="quote-preview-bar" style="display:none; width: 100%; border-radius: 20px 20px 0 0;">
            <div class="quote-content-wrapper">
                <div id="quote-preview-user" class="quote-user-name">Nickname</div>
                <div id="quote-preview-text" class="quote-text-preview">Message content...</div>
            </div>
            <div onclick="cancelQuote()" style="cursor:pointer; padding:5px; color:#8e8e93;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div style="display: flex; align-items: center; width: 100%; padding: 10px 15px; gap: 12px;">
            <div class="footer-add-btn" onclick="toggleFeaturePanel()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <input type="text" id="chat-input-main" class="chat-room-input" placeholder="Type something...">
            <div class="footer-action-btns">
                <div class="action-btn ai" onclick="triggerAiGenerate()"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>
                <div class="action-btn send" onclick="handleSendMessage()"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></div>
            </div>
        </div>
    </div>

    <div id="chat-feature-panel" class="feature-panel-container">
        <div class="feature-list-wrapper">
            <div class="feature-row-item" onclick="handleFeature('Gallery')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    </div>
                    <span class="capsule-label">Gallery</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleEmojiButtonClick(event)">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                    </div>
                    <span class="capsule-label">Emoji</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Voice')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </div>
                    <span class="capsule-label">Voice</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Video')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                    </div>
                    <span class="capsule-label">Video</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Location')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    </div>
                    <span class="capsule-label">Location</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Transfer')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/><path d="M7 15h.01M11 15h.01"/></svg>
                    </div>
                    <span class="capsule-label">Transfer</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('InnerVoice')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    </div>
                    <span class="capsule-label">InnerVoice</span>
                </div>
            </div>

            <div class="feature-row-item" onclick="handleFeature('Phone')">
                <div class="feature-glass-capsule">
                    <div class="capsule-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
                    </div>
                    <span class="capsule-label">Phone</span>
                </div>
            </div>
        </div>
    </div>

    <div id="multi-select-count" style="position:absolute; top:-30px; left:0; width:100%; text-align:center; font-size:13px; color:#8e8e93; font-weight:600;">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</div>
    <div id="multi-select-bar" class="multi-select-footer">
        <div class="multi-action-item danger" onclick="batchDelete()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            <span>åˆ é™¤</span>
        </div>
        <div class="multi-action-item" onclick="batchScreenshot()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            <span>æˆªå›¾</span>
        </div>
        <div class="multi-action-item" onclick="batchForward()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></svg>
            <span>è½¬å‘</span>
        </div>
        <div class="multi-action-item" style="color:#8e8e93;" onclick="exitMultiSelect()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
</div>
<div id="menu-overlay" class="menu-overlay" onclick="hideBubbleMenu()"></div>

<div id="bubble-menu" class="bubble-context-menu">
    <div class="menu-box">
        <div class="menu-item" onclick="doAction('copy')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></div>
            <span>å¤åˆ¶</span>
        </div>
        <div class="menu-item" onclick="doAction('quote')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
            <span>å¼•ç”¨</span>
        </div>
        <div class="menu-item" onclick="doAction('fav')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></div>
            <span>æ”¶è—</span>
        </div>
        <div class="menu-item" onclick="doAction('multi')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div>
            <span>å¤šé€‰</span>
        </div>
        
        <div id="menu-recall" class="menu-item" onclick="doAction('recall')">
            <div class="menu-icon-circle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M12 7v5l4 2"></path></svg>
            </div>
            <span>æ’¤å›</span>
        </div>
        <div class="menu-item" onclick="doAction('forward')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></svg></div>
            <span>è½¬å‘</span>
        </div>
        <div class="menu-item" onclick="doAction('delete')">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>
            <span>åˆ é™¤</span>
        </div>
        <div class="menu-item" onclick="hideBubbleMenu()">
            <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
            <span>å–æ¶ˆ</span>
        </div>
    </div>
    <div class="menu-arrow"></div>
</div>
<div id="page-forward-picker" class="ios-app-window" style="z-index: 9999; transform: translateY(100%); background: #F2F2F7;">
    <div class="app-header">
        <div onclick="closeForwardPicker()" style="color:#007AFF; font-size:16px;">å–æ¶ˆ</div>
        <div style="font-weight:700;">é€‰æ‹©æ”¶ä»¶äºº</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 0;">
        <div style="padding: 10px 16px; background:#F2F2F7;">
            <div class="segment-control" style="margin-bottom:0;">
                <div class="segment-btn active" id="fwd-tab-friends" onclick="switchForwardTab('friends')">æœ€è¿‘è”ç³»äºº</div>
                <div class="segment-btn" id="fwd-tab-groups" onclick="switchForwardTab('groups')">æˆ‘çš„ç¾¤èŠ</div>
            </div>
        </div>
        
        <div id="forward-list-content" style="padding: 0 16px; height: calc(100% - 60px); overflow-y: auto;">
            </div>
    </div>
</div>
<div id="modal-recalled-viewer" class="ios-alert-mask" style="display:none; align-items:center; z-index:10001;" onclick="this.style.display='none'">
    <div class="recalled-content-card" onclick="event.stopPropagation()">
        <div class="recalled-v-label">RECALLED TRACE</div>
        <div id="recalled-v-text"></div>
        <div class="alert-btn" style="border-top: 0.5px solid #eee; margin: 0 -25px -25px -25px; padding: 16px; color: #007AFF; font-weight: 700; cursor: pointer;" onclick="document.getElementById('modal-recalled-viewer').style.display='none'">Done</div>
    </div>
</div>
<div id="page-chat-settings" class="ios-app-window" style="background: #F2F2F7; z-index: 9200; transform: translateX(100%);">
    
    <div class="app-header" style="background: transparent;">
    
        <div onclick="closeChatSettings()" style="color:#007AFF; font-size:16px; display:flex; align-items:center; cursor:pointer; width:60px; text-shadow: 0 0 10px rgba(255,255,255,0.9);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left:-5px; filter: drop-shadow(0 0 3px rgba(255,255,255,0.8));">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Back
        </div>

        <div style="font-size:17px; font-weight:600; flex:1; text-align:center; color:#000; text-shadow: 0 0 15px rgba(255,255,255,1), 0 0 5px rgba(255,255,255,0.8);">
            è¯¦ç»†è®¾ç½®
        </div>

        <div style="width:60px;"></div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display:block; overflow-y:auto; padding-bottom: 50px;">
    
        <div class="tz-group-title">GENERAL</div>
        
        <div class="ios-list-group" style="padding: 0; overflow: hidden;">

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #007AFF;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">èƒŒæ™¯è®¾ç½®</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content" style="padding: 0;">
                    <div class="bg-config-container">
                        <div class="bg-config-row">
                            <div class="bg-label-group">
                                <span class="bg-main-title">èŠå¤©çª—å£èƒŒæ™¯</span>
                                <span class="bg-sub-hint">æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€ç½‘ç»œé“¾æ¥</span>
                            </div>
                            <div class="bg-preview-box" onclick="openUniversalBgModal('chat')">
                                <div id="preview-thumb-chat" class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>
                                <div class="bg-edit-badge">CHAT</div>
                            </div>
                        </div>

                        <div class="bg-config-row">
                            <div class="bg-label-group">
                                <span class="bg-main-title">è®¾ç½®èœå•èƒŒæ™¯</span>
                                <span class="bg-sub-hint">ä»…æ”¯æŒå›¾ç‰‡ï¼ˆæ–‡ä»¶/URLï¼‰</span>
                            </div>
                            <div class="bg-preview-box" onclick="openUniversalBgModal('settings')">
                                <div id="preview-thumb-settings" class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>
                                <div class="bg-edit-badge">MENU</div>
                            </div>
                        </div>

                        <div class="bg-action-group">
                            <div class="bg-reset-btn" onclick="resetChatBackgrounds()">é‡ç½®</div>
                            <div class="bg-save-btn" onclick="saveChatBackgroundSettings()">ä¿å­˜æ›´æ”¹</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #34C759;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">Ta çš„èµ„æ–™</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openCharProfileEditPage()">ç¼–è¾‘è¯¦ç»†èµ„æ–™</div>
                    <div class="sub-setting-btn" onclick="openChatProfileFromSettings()">æŸ¥çœ‹é¢„è§ˆåç‰‡</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #AF52DE;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M12 6v10M9 9l3-3 3 3"/></svg>
                    </div>
                    <div class="item-content" style="border:none;">
                        <span class="item-label">ä¸–ç•Œä¹¦å…³è”</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openWorldBindPage()">ä¸–ç•Œä¹¦åè®®é€‰å®š</div>
                    <div class="sub-setting-btn" onclick="openRelationsPage()">æ„å»ºäººé™…å…³ç³»ç½‘</div>
                    
                    <div style="font-size:10px; color:#bbb; text-align:center; margin-top:10px; padding:0 15px;">
                        æç¤ºï¼šå…ˆé€‰å®šä¸–ç•Œåè®®ï¼ŒAI æ‰èƒ½ç²¾å‡†ç”Ÿæˆå…³ç³»ç½‘ã€‚
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #1d1d1f;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">æˆ‘çš„èµ„æ–™</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content" style="padding: 10px 16px 20px 16px;">
                    <div class="sub-setting-btn user-btn-main" onclick="openUserProfileEdit()">ç¼–è¾‘æˆ‘çš„èµ„æ–™</div>
                    <div class="sub-setting-btn user-btn-secondary" onclick="openUserCardPreview()">é¢„è§ˆæˆ‘çš„èµ„æ–™å¡</div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #FF9500;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-label">è®°å¿†</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openExclusiveMemories()">ä¸“å±å›å¿†</div>
                    <div class="sub-setting-btn" onclick="openMemorySummary()">è®°å¿†æ€»ç»“</div>
                    
                    <div style="font-size:10px; color:#bbb; text-align:center; margin-top:10px; padding:0 15px;">
                        æç¤ºï¼šåŸºäºé‡å­çº ç¼ åè®®ï¼Œè®°å¿†å°†éšäº’åŠ¨æ·±åº¦è‡ªåŠ¨è§£é”ã€‚
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #AF52DE;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-label">ç¾åŒ–</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openSubPage('subpage-language-settings'); initLanguageConfig();">
                        è¯­è¨€è®¾ç½® (Language)
                    </div>
                    
                    <div class="sub-setting-btn" onclick="openSubPage('subpage-theme-store'); initThemeStore();">
                        é¡µé¢å¸ƒå±€ (Layout)
                    </div>

                    <div class="sub-setting-btn" onclick="openSubPage('subpage-voice-calibrate'); loadVoiceCalibrateUI();">
                        è¯­éŸ³å¼•æ“ (Voice Engine)
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #5856D6;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M1 1l22 22"/><path d="M1 23L23 1"/><path d="M12 6a6 6 0 0 0-6 6"/><path d="M18 12a6 6 0 0 0-6-6"/></svg></div>
                    <div class="item-content">
                        <span class="item-label">æ„ŸçŸ¥</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-row" onclick="openWeatherPerception()">
                        <div class="sub-item-left">
                            <span class="item-label">å¤©æ°”æ„ŸçŸ¥</span>
                            <span class="time-sense-tag sense-time-label">åŒæ­¥ä¸­...</span>
                        </div>
                        <div class="sub-item-right">
                            <span class="status-highlight" id="val-weather-text">å¤šäº‘ 24Â°C</span>
                            <svg class="chevron-right" width="12" height="12" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>

                    <div class="sub-setting-row" onclick="openRegionPerception()">
                        <div class="sub-item-left">
                            <span class="item-label">åœ°åŒºæ„ŸçŸ¥</span>
                            <span class="time-sense-tag sense-time-label">åŒæ­¥ä¸­...</span>
                        </div>
                        <div class="sub-item-right">
                            <span class="status-highlight" id="val-region-text">åŒ—äº¬å¸‚ Â· æµ·æ·€åŒº</span>
                            <svg class="chevron-right" width="12" height="12" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #8E8E93;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </div>
                    <div class="item-content">
                        <span class="item-label">çº¿ä¸‹</span>
                        <div class="item-right">
                            <svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="openTravelJournal()">è¡Œæ—…è§é—»</div>
                    
                    <div class="sub-setting-btn" onclick="openDestinyPage()">å› æœç¾ç»Š</div>
                
                </div>
            </div>

            <div class="ios-accordion-item">
                <div class="accordion-header" onclick="toggleSettingItem(this)">
                    <div class="item-icon" style="background: #FF2D55;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                    <div class="item-content" style="border:none;">
                        <span class="item-label">èŠå¤©è®°å½•</span>
                        <div class="item-right"><svg class="accordion-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
                <div class="accordion-content">
                    <div class="sub-setting-btn" onclick="window.openChatSearchPage()">æŸ¥æ‰¾å†…å®¹</div>
                    <div class="sub-setting-btn" onclick="showToast('è®°å½•å·²æ‰“åŒ…å¯¼å‡º')">å¯¼å‡ºå¤‡ä»½</div>
                </div>
            </div>

        </div>

        <div class="danger-zone-container">
            <div class="standalone-btn btn-blue-text" onclick="triggerClearHistory()">
                æ¸…ç©ºèŠå¤©è®°å½•
            </div>
            
            <div class="standalone-btn btn-blue-text" onclick="showToast('å·²æ‹‰é»‘è¯¥ç”¨æˆ·')">
                æ‹‰é»‘å¥½å‹
            </div>
            
            <div class="standalone-btn btn-red-text" onclick="triggerDeleteFriend()">
                åˆ é™¤å¥½å‹
            </div>
        </div>

        <div style="text-align:center; font-size:11px; color:#C7C7CC; margin-top:25px; padding-bottom:40px;">
            SECURE CONNECTION v4.2<br>ID: <span id="setting-uid-display">UNKNOWN</span>
        </div>

    </div>

    <div id="subpage-world-bind" class="ios-sub-page">
        <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
            <div onclick="closeSubPage('subpage-world-bind')" style="color:#007AFF;">å–æ¶ˆ</div>
            <div style="font-weight:800;">ç»‘å®šåè®®</div>
            <div onclick="saveWorldBinding()" style="color:#007AFF; font-weight:800;">ä¿å­˜</div>
        </div>
        <div class="app-body" style="padding: 20px 16px;">
            <div class="tz-group-title">é€‰æ‹©æ³¨å…¥çš„è§„åˆ™</div>
            <div id="world-bind-list" class="ios-list-group"></div>
            <div class="tz-group-title">è¡ç”Ÿæ‰©å±•</div>
            <div class="ios-list-group">
                <div class="ios-list-item" onclick="openRelationsPage()">
                    <div class="item-content" style="border:none;">
                        <span class="item-label" style="color:#007AFF; font-weight:700;">æŸ¥çœ‹/æ„å»ºäººé™…å…³ç³»ç½‘</span>
                        <div class="item-right"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="subpage-relations" class="ios-sub-page">
        <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
            <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
            <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
            <div style="width:40px;"></div>
        </div>
        <div class="app-body" style="padding: 20px 16px;">
            <div id="quantum-loader" class="quantum-loader-overlay">
                <div class="quantum-spinner"></div>
                <div class="quantum-status-text" id="q-status">INITIALIZING...</div>
                <div class="q-progress-container">
                    <div id="q-progress-bar" class="q-progress-bar"></div>
                </div>
            </div>
            <div id="relation-empty-state" style="text-align:center; padding:60px 20px; display:none;">
                <div style="font-size:50px; margin-bottom:20px; filter: grayscale(100%);">ğŸŒ</div>
                <h3 style="color:#1d1d1f; margin-bottom:10px;">å°šæœªè§£æå…³ç³»ç½‘</h3>
                <p style="color:#8e8e93; font-size:13px; line-height:1.6;">AI éœ€è¦æ ¹æ®å·²ç»‘å®šçš„ä¸–ç•Œåè®®<br>ä¸ºè¯¥è§’è‰²ç¼–ç»‡åº•å±‚ç¤¾ä¼šå…³ç³»ã€‚</p>
                <button class="ios-btn primary" style="margin-top:30px; width:180px;" onclick="generateRelationsWithAI()">å¼€å§‹é‡å­è§£æ</button>
            </div>
            <div id="npc-grid" class="char-grid"></div>
            <div id="subpage-relations" class="ios-sub-page">
                <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
                    <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
                    <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
                    <div style="width:40px;"></div>
                </div>
                <div class="app-body" style="padding: 20px 16px;">
                    <div id="relation-empty-state"> ... </div>

                    <div id="npc-grid" class="char-grid"></div>

                    <div id="relation-footer" class="relation-footer-tools" style="display:none;">
                        <div class="btn-extend-network" onclick="generateRelationsWithAI(true)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            æ‰©å±•å…³ç³»åœˆ
                        </div>
                    </div>
                </div>
            </div>

            <div class="npc-pre-footer">              
                <div class="npc-btn-main add" id="npc-add-btn" onclick="handleNPCFriendRequest()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                    <span id="npc-add-text">Add Friend</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modal-universal-uploader" class="ios-alert-mask" style="align-items:flex-end; z-index:20000;">
    <div class="modal-content">
        <div class="modal-top">
            <div style="display:flex; flex-direction:column;">
                <span class="modal-h1" id="uploader-title">è®¾ç½®èƒŒæ™¯</span>
                <span id="uploader-target-tag" class="uploader-type-tag">CHAT WINDOW</span>
            </div>
            <span class="modal-done" onclick="closeUniversalUploader()">å–æ¶ˆ</span>
        </div>

        <div class="url-input-wrapper">
            <input type="text" id="universal-url-in" class="ios-input" placeholder="è¾“å…¥å›¾ç‰‡æˆ–è§†é¢‘çš„ URL...">
            <button class="ios-btn secondary" style="margin-top:8px;" onclick="handleUniversalUrl()">ä½¿ç”¨æ­¤é“¾æ¥</button>
        </div>

        <div style="text-align:center; color:#ccc; font-size:12px; margin-bottom:15px; font-weight:800;">æˆ–</div>

        <input type="file" id="universal-file-in" hidden onchange="handleUniversalFile(this)">
        <button class="ios-btn primary" onclick="document.getElementById('universal-file-in').click()">ä»ç›¸å†Œé€‰æ‹©æ–‡ä»¶</button>
        
        <div style="height:30px;"></div>
    </div>
</div>
<div id="save-success-hud" class="ios-hud">
    <svg class="hud-checkmark" viewBox="0 0 52 52">
        <path d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>
    <div class="hud-text">å·²ä¿å­˜</div>
</div>
<div id="subpage-char-profile" class="ios-sub-page">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-char-profile')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> å–æ¶ˆ
        </div>
        <div style="font-size:17px; font-weight:600;">Taçš„èµ„æ–™</div>
        <div onclick="saveCharProfileChanges()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">ä¿å­˜</div>
    </div>

    <div class="app-body" style="padding: 20px 16px;">
        <div class="profile-edit-header" style="text-align:center; margin-bottom:30px;">
            <div class="char-upload-circle" style="width:100px; height:100px; margin:0 auto 15px auto; box-shadow:0 8px 25px rgba(0,0,0,0.1);" onclick="document.getElementById('edit-char-avatar-file').click()">
                <img id="edit-char-avatar-pre" src="" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
                <div class="bg-edit-badge" style="border-radius:0 0 50px 50px; font-size:8px;">CHANGE</div>
            </div>
            <input type="file" id="edit-char-avatar-file" hidden accept="image/*" onchange="previewProfileAvatar(this)">
            <input type="text" id="edit-char-name" class="ios-input" style="text-align:center; font-size:24px; font-weight:800; background:transparent; border:none;" placeholder="è¾“å…¥æ˜µç§°">
        </div>

        <div class="tz-group-title">äººè®¾èƒŒæ™¯ (BIOGRAPHY)</div>
        <div class="ios-list-group">
            <textarea id="edit-char-desc" class="ios-input" style="height:200px; padding:15px; background:#fff; border:none; margin:0; line-height:1.6;" placeholder="åœ¨è¿™é‡Œå®šä¹‰è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯ã€ä»¥åŠä½ ä»¬çš„æ•…äº‹..."></textarea>
        </div>
        <div class="tz-group-title">ç³»ç»Ÿå…ƒæ•°æ® (METADATA)</div>
            <div class="ios-list-group">
                <div class="ios-list-item">
                    <span class="item-label">è§’è‰² ID</span>
                    <div class="item-right"><span class="item-value" id="meta-char-id">--</span></div>
                </div>
                <div class="ios-list-item" style="border:none;">
                    <span class="item-label">æ ¸å¿ƒåè®®</span>
                    <div class="item-right"><span class="item-value">Encrypted v4.2</span></div>
                </div>
            </div>
        
        <div style="font-size:11px; color:#bbb; padding:10px 16px;">
            æç¤ºï¼šåœ¨æ­¤å¤„ä¿®æ”¹çš„èµ„æ–™å°†åŒæ­¥è‡³è§’è‰²ä¹¦ã€å¥½å‹åˆ—è¡¨åŠ AI è®°å¿†åº“ã€‚
        </div>

    </div>
</div>
<div id="modal-social-card" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="social-card" onclick="event.stopPropagation()">
        
        <div class="social-close-trigger" onclick="document.getElementById('modal-social-card').style.display='none'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>

        <img id="social-v-avatar" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
        
        <h2 id="social-v-name" style="margin-top:12px; font-size:24px; font-weight:800; color:#1d1d1f; letter-spacing:-0.5px;">Name</h2>
        <div class="social-online-tag">ONLINE</div>

        <div class="social-motto" id="social-v-motto" onclick="openEditMottoFromCard()">Signature goes here...</div>

        <div class="social-actions">
            <div class="social-btn-item" onclick="showToast('Message feature is encrypted...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg></div>
                <span>Message</span>
            </div>
            <div class="social-btn-item" onclick="showToast('Voice protocol error...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></div>
                <span>Call</span>
            </div>
            <div class="social-btn-item" onclick="showToast('Video stream unavailable...')">
                <div class="menu-icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></div>
                <span>Video</span>
            </div>
        </div>
    </div>
</div>

<div id="modal-aes-preview" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="aesthetic-preview-card" onclick="event.stopPropagation()">
        <div class="aes-pre-header"><img id="aes-v-avatar" class="aes-pre-avatar" src=""></div>
        <div class="aes-pre-body">
            <h2 id="aes-v-name" class="aes-pre-name">Character</h2>
            <div class="aes-pre-desc-box"><p id="aes-v-desc">Description sync...</p></div>
            <div style="display:flex; gap:12px; margin-top:30px;">
                <div class="aes-footer-btn light" style="flex:1; padding:12px; border-radius:12px; background:#f2f2f7; text-align:center; font-weight:700;" onclick="document.getElementById('modal-aes-preview').style.display='none'">Close</div>
                <div class="aes-footer-btn dark" style="flex:1; padding:12px; border-radius:12px; background:#1d1d1f; color:#fff; text-align:center; font-weight:700;" onclick="openCharProfileEditPage(); document.getElementById('modal-aes-preview').style.display='none';">Edit Profile</div>
            </div>
        </div>
    </div>
</div>
<div id="modal-motto-edit" class="vibe-center-mask" style="display:none; z-index:9700;">
    <div class="ios-alert-box">
        <div class="alert-title">ä¿®æ”¹ç­¾å</div>
        <div style="padding: 15px;">
            <input type="text" id="motto-input" class="ios-input" placeholder="è¾“å…¥æ–°çš„å¿ƒæƒ…..." style="text-align:center;">
        </div>
        <div style="display:flex; border-top:0.5px solid #eee;">
            <div class="alert-btn" style="flex:1; border-right:0.5px solid #eee;" onclick="document.getElementById('modal-motto-edit').style.display='none'">å–æ¶ˆ</div>
            <div class="alert-btn" style="flex:1; font-weight:800;" onclick="saveMotto()">ä¿å­˜</div>
        </div>
    </div>
</div>
<div id="subpage-world-bind" class="ios-sub-page">
    <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
        <div onclick="closeSubPage('subpage-world-bind')" style="color:#007AFF;">å–æ¶ˆ</div>
        <div style="font-weight:800;">ç»‘å®šåè®®</div>
        <div onclick="saveWorldBinding()" style="color:#007AFF; font-weight:800;">ä¿å­˜</div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">é€‰æ‹©æ³¨å…¥çš„è§„åˆ™</div>
        <div id="world-bind-list" class="ios-list-group">
            </div>

        <div class="tz-group-title">è¡ç”Ÿæ‰©å±•</div>
        <div class="ios-list-group">
            <div class="ios-list-item" onclick="openRelationsPage()">
                <div class="item-content" style="border:none;">
                    <span class="item-label" style="color:#007AFF; font-weight:700;">æŸ¥çœ‹/æ„å»ºäººé™…å…³ç³»ç½‘</span>
                    <div class="item-right">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>
        <div style="font-size:11px; color:#bbb; padding:10px; line-height:1.4;">
            æ³¨æ„ï¼šæ„å»ºå…³ç³»ç½‘å‰è¯·ç¡®ä¿å·²å‹¾é€‰å¹¶ä¿å­˜ä¸Šæ–¹ä¸–ç•Œåè®®ï¼Œä»¥ä¾¿ AI ç²¾å‡†ç¼–ç»‡è§’è‰²çº½å¸¦ã€‚
        </div>
    </div>
</div>

<div id="subpage-relations" class="ios-sub-page"> 
    </div>

<div id="subpage-relations" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header" style="padding-top: 48px !important; height: auto !important;">
        <div onclick="closeSubPage('subpage-relations')" style="color:#007AFF; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:800;">å…³ç³»æ¡£æ¡ˆ</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 20px 16px;">
        <div id="quantum-loader" class="quantum-loader-overlay">
            <div class="quantum-spinner"></div>
            <div class="quantum-status-text" id="q-status">INITIALIZING...</div>
            <div class="q-progress-container">
                <div id="q-progress-bar" class="q-progress-bar"></div>
            </div>
        </div>

        <div id="relation-empty-state" style="text-align:center; padding:60px 20px; display:none;">
            <div style="font-size:50px; margin-bottom:20px; filter: grayscale(100%);">ğŸŒ</div>
            <h3 style="color:#1d1d1f; margin-bottom:10px;">å°šæœªè§£æå…³ç³»ç½‘</h3>
            <p style="color:#8e8e93; font-size:13px; line-height:1.6;">AI å°†æ ¹æ®å·²ç»‘å®šçš„ä¸–ç•Œåè®®<br>ä¸ºè¯¥è§’è‰²ç¼–ç»‡åº•å±‚ç¤¾ä¼šå…³ç³»ã€‚</p>
            <button class="ios-btn primary" style="margin-top:30px; width:180px;" onclick="generateRelationsWithAI(false)">å¼€å§‹é‡å­è§£æ</button>
        </div>

        <div id="npc-grid" class="char-grid"></div>

        <div id="relation-footer" class="relation-footer-tools" style="display:none;">
            <div class="btn-extend-network" onclick="generateRelationsWithAI(true)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                æ‰©å±•å…³ç³»åœˆ
            </div>
        </div>
    </div>
</div>

<div id="modal-npc-detail" class="vibe-center-mask" style="display:none; z-index:40000;" onclick="this.style.display='none'">
    <div class="npc-detail-card" onclick="event.stopPropagation()">
        <div class="aes-top-bar" style="position: absolute; top: 15px; right: 15px; z-index: 100;">
            <div class="aes-icon-circle close" onclick="document.getElementById('modal-npc-detail').style.display='none'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="npc-pre-header">
            <img id="npc-v-banner" class="npc-pre-banner" src="">
            <img id="npc-v-avatar" class="npc-pre-avatar" src="">
        </div>

        <div class="npc-pre-body">
            <div id="npc-v-name" class="npc-pre-name">NPC Name</div>
            <div id="npc-v-role" class="npc-pre-role">RELATIONSHIP</div>
            <div class="npc-pre-bio" id="npc-v-bio">Loading dossier...</div>
        </div>

        <div class="npc-pre-footer">
            <button class="npc-btn-action minor" onclick="traceNPCStory()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span>å¾€äº‹</span>
            </button>

            <button class="npc-btn-action minor" onclick="handleLikeNPC()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                <span>æ„Ÿå…´è¶£</span>
            </button>
            
            <button class="npc-btn-action main" id="npc-add-btn" onclick="handleSocialSync()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M19 11h6m-3-3v6"/></svg>
                <span id="npc-add-text">ADD CLOSE FRIEND</span>
            </button>
        </div>
    </div>
</div>
<div id="subpage-npc-story" class="ios-sub-page" style="z-index: 50000; background: #F2F2F7;">
    <div class="app-header">
        <div onclick="document.getElementById('subpage-npc-story').classList.remove('active')" style="color:#007AFF; font-size:16px; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:700;">å¾€äº‹å›æº¯</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 20px 16px;">
        <div class="npc-story-header">
            <h2 id="story-npc-name" style="margin-bottom:8px;">è§’è‰²å¾€äº‹</h2>
            <div id="story-npc-tag" style="font-size:12px; color:#8E8E93; margin-bottom:20px;">MEMORIES & RECORDS</div>
        </div>
        
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content" style="flex-direction: column; align-items: flex-start; padding: 15px 0;">
                    <span style="font-size:13px; color:#007AFF; margin-bottom:5px;">æ ¸å¿ƒæ¢—æ¦‚</span>
                    <p id="story-npc-content" style="font-size:15px; color:#333; line-height:1.6; margin:0;">
                        æ­£åœ¨è¯»å–æ¡£æ¡ˆæ•°æ®...
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modal-past-decoder" class="ios-alert-mask" style="display:none; z-index:99999;">
    <div class="aesthetic-card past-magazine-style">
        <div class="aes-top-bar">
            <div class="aes-icon-circle close" onclick="closePastDecoder()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
        </div>

        <div class="aes-hero">
            <div id="past-hero-blur" class="aes-blur-bg"></div>
            <div class="aes-overlay" style="background: linear-gradient(to bottom, transparent, #fff);"></div>
        </div>

        <div class="aes-float-content">
            <div class="aes-avatar-box">
                <img id="past-avatar-img" src="" alt="avatar">
            </div>
            <div class="aes-title-group">
                <div id="past-name-txt" class="aes-name">åŠ è½½ä¸­...</div>
                <div class="aes-tag">CLASSIFIED MEMORY</div>
            </div>
        </div>

        <div class="aes-scroll-area">
            <div id="past-text-body" class="aes-text-body">
                </div>
            <div class="aes-divider">THE END</div>
        </div>

        <div class="aes-control-bar">
            <button class="aes-btn edit" onclick="closePastDecoder()">å…³é—­æ¡£æ¡ˆ</button>
        </div>
    </div>
</div>
<div id="subpage-user-profile" class="ios-sub-page" style="background:#F2F2F7; z-index: 10000;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-user-profile')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> å–æ¶ˆ
        </div>
        <div style="font-size:17px; font-weight:600;">æœ¬æˆ‘æ¡£æ¡ˆ</div>
        <div onclick="saveUserProfile()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display: block; width: 100%;">
        <div style="text-align:center; margin-bottom:30px;">
            <div class="char-upload-circle" style="width:100px; height:100px; margin:0 auto 15px auto; position:relative; overflow:hidden; border-radius:50%; background:#e5e5ea;" onclick="document.getElementById('user-avatar-file').click()">
                <img id="user-avatar-pre" src="" style="width:100%; height:100%; object-fit:cover; display:block;">
                <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; padding:2px 0;">EDIT</div>
            </div>
            <input type="file" id="user-avatar-file" hidden accept="image/*" onchange="previewUserAvatar(this)">
            <input type="text" id="user-name-in" class="ios-input" style="text-align:center; font-size:22px; font-weight:800; background:transparent;" placeholder="ä½ çš„ç§°å‘¼">
        </div>

        <div class="tz-group-title">é‡å­äººæ ¼è®¾å®š (PERSONA)</div>
        <div class="ios-list-group">
            <textarea id="user-bio-in" class="ios-input" style="height:200px; padding:15px; background:#fff; border:none; margin:0; line-height:1.6;" 
                placeholder="æè¿°ä½ æ˜¯è°ï¼Œä½ ä¸è§’è‰²ä»¬çš„å…±æœ‰å¾€äº‹..."></textarea>
        </div>
        <div style="font-size:11px; color:#bbb; padding:10px 16px;">
            æç¤ºï¼šæ­¤æè¿°å°†ä½œä¸ºæ ¸å¿ƒåè®®åŒæ­¥è‡³ AI äº¤äº’é€»è¾‘ã€‚
        </div>
    </div>
</div>

<div id="modal-user-card" class="modal-top-layer" onclick="this.style.display='none'">
    <div class="aesthetic-preview-card" style="border: 1px solid #1d1d1f; box-shadow: 0 40px 100px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div class="aes-pre-header" style="background: #1d1d1f; height: 120px; position: relative;">
            <img id="user-card-avatar" class="aes-pre-avatar" src="" style="border: 4px solid #fff; border-radius: 20px; transform: translateX(-50%) rotate(2deg);">
        </div>
        <div class="aes-pre-body" style="padding: 70px 25px 35px 25px;">
            <h2 id="user-card-name" class="aes-pre-name">Creator</h2>
            <div class="aes-tag" style="color: #007AFF; border-color: #007AFF; margin-bottom: 25px;">MASTER PROTOCOL</div>
            <div class="aes-pre-desc-box" style="background: #f8f8f9; text-align: left; padding: 18px; border-radius: 18px;">
                <p id="user-card-bio" style="font-family: serif; font-style: italic; color: #444; line-height: 1.6;">å°šæœªè§‰é†’äººæ ¼...</p>
            </div>
            <div class="aes-footer-btn dark" style="margin-top: 30px; padding: 14px; border-radius: 14px; background: #1d1d1f; color: #fff; font-weight: 700; cursor: pointer; text-align: center;" onclick="openUserProfileEdit()">
                ä¿®æ”¹æœ¬æˆ‘æ¡£æ¡ˆ
            </div>
        </div>
    </div>
</div>
<div id="subpage-memory-list" class="ios-sub-page">
    <div class="app-header">
        <div class="header-left" onclick="closeSubPage('subpage-memory-list')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
            <span>è¿”å›</span>
        </div>
        <div class="header-title">æ—¶ç©ºæ¡£æ¡ˆåº“</div>
        <div class="header-right" onclick="window.clearAllMemories()" style="color:#FF3B30; font-size:14px; font-weight:600; cursor:pointer;">
            æ¸…ç©º
        </div>
    </div>
    
    <div class="app-body">
        <div class="memory-hero-area">
            <span class="hero-tag">MEMORIES</span>
            <h1 class="hero-title">æ„Ÿå®˜ç¢ç‰‡</h1>
            <p class="hero-desc">åœ¨æ­¤å¤„å”¤é†’ä¸ Ta è¢«å°å­˜çš„é‡å­ç¾ç»Š</p>
        </div>

        <div id="memory-list-container" class="memory-stagger-grid"></div>

        <div class="memory-footer-bar">
            <button class="btn-awaken-core" onclick="window.triggerGenerateMemory()">
                <div class="ripple-effect"></div>
                <span>å”¤é†’æ–°è®°å¿†</span>
            </button>
        </div>
    </div>
</div>

<div id="modal-memory-cinema" class="cinema-portal">
    <div class="cinema-stage">
        <div class="cinema-close-trigger" onclick="window.closeCinemaMemory()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
        
        <div class="cinema-scroll-layer">
            <div class="cinema-hero-banner">
                <img id="cinema-img" src="" alt="scene">
                <div class="cinema-hero-mask"></div>
                <div class="cinema-title-box">
                    <span id="cinema-tag-ui">LATEST TRACE</span>
                    <h1 id="cinema-title-ui">è½½å…¥ä¸­...</h1>
                </div>
            </div>
            
            <div class="cinema-text-wrapper">
                <div id="cinema-text-content" class="cinema-prose"></div>
                <div class="cinema-footer-decor">âœ¦ FIN âœ¦</div>
            </div>
        </div>
    </div>
</div>

<div id="quantum-loader-overlay" class="quantum-overlay">
    <div class="weaving-core">
        <div class="spider-line"></div>
        <div class="spider-line"></div>
        <div class="spider-line"></div>
    </div>
    <div class="weaving-text">æ­£åœ¨ä»é‡å­çº ç¼ ä¸­ç¼–ç»‡å™äº‹...</div>
</div>
<div id="subpage-memory-summary" class="ios-sub-page">
    <div class="app-header">
        <div class="header-left" onclick="closeSubPage('subpage-memory-summary')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
            <span>è¿”å›</span>
        </div>
        <div class="header-title">è®°å¿†æ€»ç»“åè®®</div>
        <div class="header-right" onclick="window.saveSummarySettings()" style="color:#000; font-weight:800; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">è‡ªåŠ¨æ€»ç»“è§¦å‘é¢‘ç‡</div>
        
        <div class="ios-list-group" style="padding: 25px 20px; display: block;">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <span style="font-size:16px; font-weight:700; color:#000;">å¯¹è¯è½®æ•°</span>
                    <span style="font-size:11px; color:#8e8e93; letter-spacing:1px;">ROUNDS PER CYCLE</span>
                </div>
                <span id="summary-rounds-val" style="font-size:32px; font-weight:800; font-family:serif; color:#000;">10</span>
            </div>
            
            <input type="range" id="summary-rounds-slider" min="5" max="50" step="5" value="10" class="ios-slider" 
                oninput="window.updateSummarySlider(this.value)">
            
            <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:10px; color:#ccc; font-weight:700;">
                <span>é«˜é¢‘ç‡ (5)</span>
                <span>æ·±åº¦è®°å¿† (50)</span>
            </div>
        </div>

        <div class="tz-group-title">åè®®è¯´æ˜</div>
        <div class="ios-list-group" style="padding:20px; font-size:13px; line-height:1.6; color:#444; text-align:justify;">
            <p>å½“å¯¹è¯è¾¾åˆ°è®¾å®šè½®æ•°åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¯åŠ¨â€œé‡å­åç¼©â€ç¨‹åºï¼Œå°†å†—é•¿çš„åŸå§‹è®°å½•å‹ç¼©ä¸ºã€æ ¸å¿ƒè®°å¿†ç‚¹ã€‘ã€‚è¿™èƒ½æœ‰æ•ˆèŠ‚çœ AI çš„ Token æ¶ˆè€—ï¼Œå¹¶é˜²æ­¢è§’è‰²å› è®°å¿†è¿‡è½½è€Œäº§ç”Ÿçš„é€»è¾‘æ¼‚ç§»ã€‚</p>
        </div>

        <button class="ios-btn primary" style="background:#000; color:#fff; margin-top:20px;" onclick="window.manualTriggerSummary()">
            æ‰‹åŠ¨æ‰§è¡Œå³æ—¶æ€»ç»“
        </button>

        <div class="tz-group-title">å·²åç¼©çš„æ ¸å¿ƒè®°å¿† (CHRONICLES)</div>
        <div id="summary-cards-container" style="width:100%; display:flex; flex-direction:column; gap:15px;">
            </div>

        <div style="height:50px;"></div>
    </div>
</div>
<div id="ios-notification-shade" class="notification-shade">
    <div class="notif-header-bar">
        <div class="notif-title">é€šçŸ¥ä¸­å¿ƒ</div>
        <div class="notif-clear-btn" onclick="window.clearAllNotifications()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div id="notification-list" class="notif-list-container">
        <div class="notif-empty-state">æ²¡æœ‰æ›´æ—©çš„é€šçŸ¥äº†</div>
    </div>

    <div class="shade-handle-bottom" onclick="window.closeNotificationShade()"></div>
</div>
<div id="iconApp" class="ios-app-window" style="background:#F2F2F7; z-index: 6000;">
    <div class="app-header">
        <div class="header-title-big">Icon Studio</div>
        <div class="header-close-btn" onclick="closeApp('iconApp')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>

    <div class="app-body" style="padding: 20px 16px; align-items: center;">
        <div id="icon-preview-box" style="width: 120px; height: 120px; background: #fff; border-radius: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 15px 35px rgba(0,0,0,0.1); margin-bottom: 30px; overflow: hidden; border: 4px solid #fff;">
            <img id="icon-pre-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
            <div id="icon-pre-placeholder" style="text-align:center; color:#ccc; font-size:12px; font-weight:700;">PREVIEW</div>
        </div>

        <div class="tz-group-title" style="width:100%; text-align:left;">TARGET APP</div>
        <div class="ios-list-group" style="width:100%;">
            <div class="ios-list-item" onclick="window.openIconTargetPicker()">
                <div class="item-content" style="border:none;">
                    <span class="item-label">ä¿®æ”¹å¯¹è±¡</span>
                    <div class="item-right">
                        <span class="item-value" id="val-icon-target">è¯·é€‰æ‹©...</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="segment-control" style="width: 100%; margin: 20px 0;">
            <div class="segment-btn active" id="icon-tab-file" onclick="switchIconInputMode('file')">æœ¬åœ°æ–‡ä»¶</div>
            <div class="segment-btn" id="icon-tab-url" onclick="switchIconInputMode('url')">ç½‘ç»œé“¾æ¥</div>
        </div>

        <div id="icon-panel-file" style="width:100%;">
            <input type="file" id="icon-file-input" accept="image/*" onchange="handleIconFile(this)" style="display:none;">
            
            <button class="ios-btn primary" style="background:#000;" onclick="document.getElementById('icon-file-input').click()">ä»ç›¸å†Œä¸Šä¼ </button>
        </div>

        <div id="icon-panel-url" style="width:100%; display:none;">
            <input type="text" id="icon-url-in" class="ios-input" placeholder="ç²˜è´´å›¾æ ‡å›¾ç‰‡ URL..." style="background:#fff; border-radius:12px;">
            <button class="ios-btn primary" style="background:#000;" onclick="window.handleIconUrl()">åŒæ­¥ URL</button>
        </div>

        <button class="ios-btn primary" style="margin-top: 30px; background:#007AFF;" onclick="window.saveIconCustomization()">åº”ç”¨å¹¶ä¿å­˜åˆ°æ¡Œé¢</button>
        
        <div style="font-size:11px; color:#bbb; margin-top:20px; text-align:center; line-height:1.5;">
            æç¤ºï¼šå»ºè®®ä½¿ç”¨æ­£æ–¹å½¢å›¾ç‰‡ä»¥è·å¾—æœ€ä½³æ•ˆæœã€‚<br>ä¿å­˜åå°†ç«‹å³è¦†ç›–ç³»ç»Ÿé¢„è®¾å›¾æ ‡ã€‚
        </div>
    </div>
</div>
<div id="subpage-icon-picker" class="ios-sub-page" style="z-index: 7000; background: #F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-icon-picker')" style="color:#007AFF; font-size:16px; cursor:pointer;">å–æ¶ˆ</div>
        <div style="font-weight:700;">é€‰æ‹©ç›®æ ‡ App</div>
        <div style="width:40px;"></div>
    </div>
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">SYSTEM & INSTALLED</div>
        <div id="icon-target-list" class="ios-list-group">
            </div>
    </div>
</div>
<div id="subpage-weather-perceive" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-weather-perceive')" style="color:#007AFF; font-size:16px; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:800;">æ„ŸçŸ¥ä¸­å¿ƒ</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 20px 16px;">
        <div class="tz-group-title">AI è”è§‰åè®®</div>
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content" style="border:none;">
                    <span class="item-label">èŠå¤©æ—¶å¸¦å…¥å®æ—¶å¤©æ°”</span>
                    <div class="item-right">
                        <input type="checkbox" id="sync-weather-toggle" class="world-checkbox" onchange="toggleWeatherSync()">
                    </div>
                </div>
            </div>
        </div>
        <div style="font-size:11px; color:#bbb; padding:0 10px 15px;">å¼€å¯åï¼ŒTa åœ¨èŠå¤©æ—¶ä¼šæ„ŸçŸ¥åˆ°ä½ é‚£é‡Œçš„å®æ—¶æ°”æ¸©ä¸å¤©æ°”ã€‚</div>

        <div class="sense-action-area">
            <button class="sense-btn-main" onclick="triggerManualSense()">ç«‹åˆ»æ•è·ç¢ç‰‡</button>
            <button class="sense-btn-sub" onclick="openSenseFrequencyPicker()">è‡ªåŠ¨é¢‘ç‡</button>
        </div>

        <div class="tz-group-title">æ—¶ç©ºæ¡£æ¡ˆ (TIMELINE)</div>
        <div id="sense-timeline-container" style="display:flex; flex-direction:column; gap:20px; padding-bottom:100px;">
            </div>
    </div>
</div>
<div id="senseFrequencyPicker" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index: 100000;" onclick="closeSenseFrequencyPicker()">
    <div class="ios-action-sheet" onclick="event.stopPropagation()">
        <div class="sheet-title-box">é€‰æ‹©è‡ªåŠ¨æ„Ÿåº”é¢‘ç‡</div>
        
        <div class="sheet-item" onclick="setSenseFrequency(60000, '1 åˆ†é’Ÿ (æµ‹è¯•)')">1 åˆ†é’Ÿ (æµ‹è¯•ä¸“ç”¨)</div>
        <div class="sheet-item" onclick="setSenseFrequency(3600000, '1 å°æ—¶')">æ¯ 1 å°æ—¶</div>
        <div class="sheet-item" onclick="setSenseFrequency(14400000, '4 å°æ—¶')">æ¯ 4 å°æ—¶</div>
        <div class="sheet-item" onclick="setSenseFrequency(43200000, '12 å°æ—¶')">æ¯ 12 å°æ—¶</div>
        <div class="sheet-item" onclick="setSenseFrequency(86400000, '24 å°æ—¶')">æ¯ 24 å°æ—¶</div>
        
        <div class="sheet-cancel" onclick="closeSenseFrequencyPicker()">å–æ¶ˆ</div>
    </div>
</div>
<div id="subpage-region-perceive" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-region-perceive')" style="color:#007AFF; font-size:16px; cursor:pointer;">è¿”å›</div>
        <div style="font-weight:800;">åœ°åŒºæ„ŸçŸ¥</div>
        <div style="width:40px;"></div>
    </div>
    
    <div class="app-body" style="padding: 10px 16px 120px 16px;">
        <div id="region-vibe-card" class="region-mag-card" onclick="regenerateRegionVibe()">
            <div class="mag-overlay"></div>
            <div class="mag-content">
                <div class="mag-tag-row">
                    <span class="mag-city-name" id="mag-city-display">Beijing</span>
                    <span class="mag-status-dot"></span>
                </div>
                <div class="mag-divider"></div>
                <div class="mag-vibe-text" id="mag-vibe-display">æ­£åœ¨æ„Ÿåº”æ—¶ç©º...</div>
                <div class="mag-footer">
                    <span>ç‚¹å‡»å¡ç‰‡é‡åˆ·</span>
                    <span id="mag-char-name">FROM TA</span>
                </div>
            </div>
            <div id="region-loading" class="vibe-loading-layer">
                <div class="quantum-spinner"></div>
            </div>
        </div>

        <div class="ios-list-group">
            <div class="ios-list-item">
                <span class="item-label">å…è®¸ Ta æ¢æµ‹æˆ‘çš„åŸå¸‚ç‰¹è´¨</span>
                <div class="item-right">
                    <input type="checkbox" id="sync-region-toggle" class="world-checkbox" onchange="toggleRegionSync()">
                </div>
            </div>
            <div class="ios-list-item" style="border-top:0.5px solid #eee;">
                <span class="item-label">å½“å‰ä½ç½®</span>
                <div class="item-right">
                    <span class="item-value" id="val-region-city">Beijing</span>
                </div>
            </div>
        </div>

        <div class="tz-group-title">åŒ—å›½é£å…‰ä¸æ±Ÿæµ™æ¸©å©‰ (NORTH & EAST)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(39.9, 116.4, 'Beijing')">åŒ—äº¬</div>
            <div class="city-tag" onclick="quickSwitchCity(31.2, 121.4, 'Shanghai')">ä¸Šæµ·</div>
            <div class="city-tag" onclick="quickSwitchCity(39.1, 117.2, 'Tianjin')">å¤©æ´¥</div>
            <div class="city-tag" onclick="quickSwitchCity(38.9, 121.6, 'Dalian')">å¤§è¿</div>
            <div class="city-tag" onclick="quickSwitchCity(41.8, 123.4, 'Shenyang')">æ²ˆé˜³</div>
            <div class="city-tag" onclick="quickSwitchCity(45.7, 126.6, 'Harbin')">å“ˆå°”æ»¨</div>
            <div class="city-tag" onclick="quickSwitchCity(43.8, 125.3, 'Changchun')">é•¿æ˜¥</div>
            <div class="city-tag" onclick="quickSwitchCity(36.7, 117.0, 'Jinan')">æµå—</div>
            <div class="city-tag" onclick="quickSwitchCity(36.1, 120.3, 'Qingdao')">é’å²›</div>
            <div class="city-tag" onclick="quickSwitchCity(37.5, 121.4, 'Yantai')">çƒŸå°</div>
            <div class="city-tag" onclick="quickSwitchCity(31.3, 120.6, 'Suzhou')">è‹å·</div>
            <div class="city-tag" onclick="quickSwitchCity(30.2, 120.2, 'Hangzhou')">æ­å·</div>
            <div class="city-tag" onclick="quickSwitchCity(29.9, 121.5, 'Ningbo')">å®æ³¢</div>
            <div class="city-tag" onclick="quickSwitchCity(32.0, 118.8, 'Nanjing')">å—äº¬</div>
            <div class="city-tag" onclick="quickSwitchCity(31.5, 120.3, 'Wuxi')">æ— é”¡</div>
            <div class="city-tag" onclick="quickSwitchCity(32.4, 119.4, 'Yangzhou')">æ‰¬å·</div>
            <div class="city-tag" onclick="quickSwitchCity(38.0, 114.5, 'Shijiazhuang')">çŸ³å®¶åº„</div>
            <div class="city-tag" onclick="quickSwitchCity(37.9, 112.5, 'Taiyuan')">å¤ªåŸ</div>
            <div class="city-tag" onclick="quickSwitchCity(40.8, 111.7, 'Hohhot')">å‘¼å’Œæµ©ç‰¹</div>
        </div>

        <div class="tz-group-title">å—æ–¹çš„æ½®æ¹¿ä¸é”¦ç»£å·´èœ€ (SOUTH & WEST)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(23.1, 113.3, 'Guangzhou')">å¹¿å·</div>
            <div class="city-tag" onclick="quickSwitchCity(22.5, 114.1, 'Shenzhen')">æ·±åœ³</div>
            <div class="city-tag" onclick="quickSwitchCity(22.3, 113.5, 'Zhuhai')">ç æµ·</div>
            <div class="city-tag" onclick="quickSwitchCity(23.0, 113.1, 'Foshan')">ä½›å±±</div>
            <div class="city-tag" onclick="quickSwitchCity(23.0, 113.8, 'Dongguan')">ä¸œè</div>
            <div class="city-tag" onclick="quickSwitchCity(22.4, 114.2, 'HongKong')">é¦™æ¸¯</div>
            <div class="city-tag" onclick="quickSwitchCity(22.2, 113.5, 'Macau')">æ¾³é—¨</div>
            <div class="city-tag" onclick="quickSwitchCity(24.5, 118.1, 'Xiamen')">å¦é—¨</div>
            <div class="city-tag" onclick="quickSwitchCity(26.1, 119.3, 'Fuzhou')">ç¦å·</div>
            <div class="city-tag" onclick="quickSwitchCity(24.9, 118.6, 'Quanzhou')">æ³‰å·</div>
            <div class="city-tag" onclick="quickSwitchCity(30.6, 114.3, 'Wuhan')">æ­¦æ±‰</div>
            <div class="city-tag" onclick="quickSwitchCity(28.2, 113.0, 'Changsha')">é•¿æ²™</div>
            <div class="city-tag" onclick="quickSwitchCity(28.7, 115.9, 'Nanchang')">å—æ˜Œ</div>
            <div class="city-tag" onclick="quickSwitchCity(31.8, 117.3, 'Hefei')">åˆè‚¥</div>
            <div class="city-tag" onclick="quickSwitchCity(34.8, 113.7, 'Zhengzhou')">éƒ‘å·</div>
            <div class="city-tag" onclick="quickSwitchCity(30.7, 104.1, 'Chengdu')">æˆéƒ½</div>
            <div class="city-tag" onclick="quickSwitchCity(29.6, 106.6, 'Chongqing')">é‡åº†</div>
            <div class="city-tag" onclick="quickSwitchCity(25.1, 110.3, 'Guilin')">æ¡‚æ—</div>
            <div class="city-tag" onclick="quickSwitchCity(22.8, 108.3, 'Nanning')">å—å®</div>
            <div class="city-tag" onclick="quickSwitchCity(26.6, 106.6, 'Guiyang')">è´µé˜³</div>
            <div class="city-tag" onclick="quickSwitchCity(25.0, 102.7, 'Kunming')">æ˜†æ˜</div>
            <div class="city-tag" onclick="quickSwitchCity(20.0, 110.3, 'Haikou')">æµ·å£</div>
            <div class="city-tag" onclick="quickSwitchCity(18.3, 109.5, 'Sanya')">ä¸‰äºš</div>
        </div>

        <div class="tz-group-title">ä¸è·¯é•¿æ­Œä¸æ—¥å…‰ä¹‹åŸ (FRONTIER)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(34.3, 108.9, 'Xi\'an')">è¥¿å®‰</div>
            <div class="city-tag" onclick="quickSwitchCity(34.6, 112.4, 'Luoyang')">æ´›é˜³</div>
            <div class="city-tag" onclick="quickSwitchCity(36.1, 103.8, 'Lanzhou')">å…°å·</div>
            <div class="city-tag" onclick="quickSwitchCity(36.6, 101.8, 'Xining')">è¥¿å®</div>
            <div class="city-tag" onclick="quickSwitchCity(38.5, 106.3, 'Yinchuan')">é“¶å·</div>
            <div class="city-tag" onclick="quickSwitchCity(43.8, 87.6, 'Urumqi')">ä¹Œé²æœ¨é½</div>
            <div class="city-tag" onclick="quickSwitchCity(29.7, 91.1, 'Lhasa')">æ‹‰è¨</div>
            <div class="city-tag" onclick="quickSwitchCity(39.5, 75.9, 'Kashgar')">å–€ä»€</div>
        </div>

        <div class="tz-group-title">æš¹ç½—æ™šé£ä¸äºšæ´²æ„Ÿåº” (ASIA)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(13.7, 100.5, 'Bangkok')">æ›¼è°·</div>
            <div class="city-tag" onclick="quickSwitchCity(18.8, 99.0, 'Chiang Mai')">æ¸…è¿ˆ</div>
            <div class="city-tag" onclick="quickSwitchCity(7.9, 98.3, 'Phuket')">æ™®å‰</div>
            <div class="city-tag" onclick="quickSwitchCity(12.9, 100.9, 'Pattaya')">èŠ­æé›…</div>
            <div class="city-tag" onclick="quickSwitchCity(9.5, 100.0, 'Koh Samui')">è‹æ¢…å²›</div>
            <div class="city-tag" onclick="quickSwitchCity(35.7, 139.7, 'Tokyo')">ä¸œäº¬</div>
            <div class="city-tag" onclick="quickSwitchCity(34.7, 135.5, 'Osaka')">å¤§é˜ª</div>
            <div class="city-tag" onclick="quickSwitchCity(35.0, 135.8, 'Kyoto')">äº¬éƒ½</div>
            <div class="city-tag" onclick="quickSwitchCity(37.6, 127.0, 'Seoul')">é¦–å°”</div>
            <div class="city-tag" onclick="quickSwitchCity(1.3, 103.8, 'Singapore')">æ–°åŠ å¡</div>
            <div class="city-tag" onclick="quickSwitchCity(3.1, 101.7, 'Kuala Lumpur')">å‰éš†å¡</div>
            <div class="city-tag" onclick="quickSwitchCity(10.8, 106.6, 'Ho Chi Minh City')">èƒ¡å¿—æ˜å¸‚</div>
            <div class="city-tag" onclick="quickSwitchCity(21.0, 105.8, 'Hanoi')">æ²³å†…</div>
            <div class="city-tag" onclick="quickSwitchCity(-8.4, 115.2, 'Bali')">å·´å˜å²›</div>
            <div class="city-tag" onclick="quickSwitchCity(14.6, 121.0, 'Manila')">é©¬å°¼æ‹‰</div>
            <div class="city-tag" onclick="quickSwitchCity(-6.2, 106.8, 'Jakarta')">é›…åŠ è¾¾</div>
            <div class="city-tag" onclick="quickSwitchCity(25.0, 121.5, 'Taipei')">å°åŒ—</div>
            <div class="city-tag" onclick="quickSwitchCity(19.1, 72.9, 'Mumbai')">å­Ÿä¹°</div>
            <div class="city-tag" onclick="quickSwitchCity(17.9, 102.6, 'Vientiane')">ä¸‡è±¡</div>
            <div class="city-tag" onclick="quickSwitchCity(22.6, 120.3, 'Kaohsiung')">é«˜é›„</div>
        </div>

        <div class="tz-group-title">æ¬§é™†æ—§æ¢¦ä¸é›¾éƒ½å­¤æ—… (EUROPE)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(48.9, 2.3, 'Paris')">å·´é»</div>
            <div class="city-tag" onclick="quickSwitchCity(51.5, -0.1, 'London')">ä¼¦æ•¦</div>
            <div class="city-tag" onclick="quickSwitchCity(41.9, 12.5, 'Rome')">ç½—é©¬</div>
            <div class="city-tag" onclick="quickSwitchCity(52.5, 13.4, 'Berlin')">æŸæ—</div>
            <div class="city-tag" onclick="quickSwitchCity(52.4, 4.9, 'Amsterdam')">é˜¿å§†æ–¯ç‰¹ä¸¹</div>
            <div class="city-tag" onclick="quickSwitchCity(45.4, 12.3, 'Venice')">å¨å°¼æ–¯</div>
            <div class="city-tag" onclick="quickSwitchCity(50.1, 14.4, 'Prague')">å¸ƒæ‹‰æ ¼</div>
            <div class="city-tag" onclick="quickSwitchCity(48.2, 16.4, 'Vienna')">ç»´ä¹Ÿçº³</div>
            <div class="city-tag" onclick="quickSwitchCity(40.4, -3.7, 'Madrid')">é©¬å¾·é‡Œ</div>
            <div class="city-tag" onclick="quickSwitchCity(41.4, 2.2, 'Barcelona')">å·´å¡ç½—é‚£</div>
            <div class="city-tag" onclick="quickSwitchCity(38.0, 23.7, 'Athens')">é›…å…¸</div>
            <div class="city-tag" onclick="quickSwitchCity(41.0, 29.0, 'Istanbul')">ä¼Šæ–¯å¦å¸ƒå°”</div>
            <div class="city-tag" onclick="quickSwitchCity(38.7, -9.1, 'Lisbon')">é‡Œæ–¯æœ¬</div>
            <div class="city-tag" onclick="quickSwitchCity(47.4, 8.5, 'Zurich')">è‹é»ä¸–</div>
            <div class="city-tag" onclick="quickSwitchCity(50.8, 4.3, 'Brussels')">å¸ƒé²å¡å°”</div>
            <div class="city-tag" onclick="quickSwitchCity(60.2, 24.9, 'Helsinki')">èµ«å°”è¾›åŸº</div>
            <div class="city-tag" onclick="quickSwitchCity(64.1, -21.9, 'Reykjavik')">é›·å…‹é›…æœªå…‹</div>
            <div class="city-tag" onclick="quickSwitchCity(55.8, 37.6, 'Moscow')">è«æ–¯ç§‘</div>
        </div>

        <div class="tz-group-title">è·¨è¶Šç»çº¬çš„è¿œæ–¹ (AMERICAS & OTHERS)</div>
        <div class="city-grid">
            <div class="city-tag" onclick="quickSwitchCity(40.7, -74.0, 'New York')">çº½çº¦</div>
            <div class="city-tag" onclick="quickSwitchCity(34.1, -118.2, 'Los Angeles')">æ´›æ‰çŸ¶</div>
            <div class="city-tag" onclick="quickSwitchCity(37.8, -122.4, 'San Francisco')">æ—§é‡‘å±±</div>
            <div class="city-tag" onclick="quickSwitchCity(49.3, -123.1, 'Vancouver')">æ¸©å“¥å</div>
            <div class="city-tag" onclick="quickSwitchCity(43.7, -79.4, 'Toronto')">å¤šä¼¦å¤š</div>
            <div class="city-tag" onclick="quickSwitchCity(25.7, -80.2, 'Miami')">è¿ˆé˜¿å¯†</div>
            <div class="city-tag" onclick="quickSwitchCity(19.4, -99.1, 'Mexico City')">å¢¨è¥¿å“¥åŸ</div>
            <div class="city-tag" onclick="quickSwitchCity(-22.9, -43.2, 'Rio de Janeiro')">é‡Œçº¦çƒ­å†…å¢</div>
            <div class="city-tag" onclick="quickSwitchCity(-34.6, -58.4, 'Buenos Aires')">å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯</div>
            <div class="city-tag" onclick="quickSwitchCity(25.2, 55.3, 'Dubai')">è¿ªæ‹œ</div>
            <div class="city-tag" onclick="quickSwitchCity(30.0, 31.2, 'Cairo')">å¼€ç½—</div>
            <div class="city-tag" onclick="quickSwitchCity(-33.9, 18.4, 'Cape Town')">å¼€æ™®æ•¦</div>
            <div class="city-tag" onclick="quickSwitchCity(-33.9, 151.2, 'Sydney')">æ‚‰å°¼</div>
            <div class="city-tag" onclick="quickSwitchCity(-37.8, 145.0, 'Melbourne')">å¢¨å°”æœ¬</div>
        </div>

        <div class="standalone-btn user-btn-secondary" style="margin-top:20px;" onclick="openSubPage('subpage-timezone')">é€‰æ‹©æ›´å¤šæ—¶åŒºåŸå¸‚...</div>
    </div>
</div>
<div id="subpage-language-settings" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-language-settings')" style="color:#007AFF; font-size:17px; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> è¿”å›
        </div>
        <div style="font-size:17px; font-weight:600;">è¯­è¨€ä¸ç¿»è¯‘</div>
        <div onclick="window.saveLanguageSettings()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display: block; width: 100%;">
        <div class="tz-group-title">å®æ—¶ç¿»è¯‘åè®® (TRANSLATION)</div>
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content">
                    <span class="item-label">å¼€å¯åŒè¯­å¯¹ç…§</span>
                    <input type="checkbox" id="lang-sync-toggle" class="world-checkbox" onchange="window.updateLangPreview()">
                </div>
            </div>
            <div class="ios-list-item" onclick="window.openLangPicker()">
                <div class="item-content" style="border:none;">
                    <span class="item-label">ç›®æ ‡è¯­è¨€</span>
                    <div class="item-right">
                        <span class="item-value" id="val-target-lang">è‹±è¯­ (English)</span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>

        <div id="lang-reset-tip" style="margin: 10px 10px 25px 10px; padding: 15px; background: rgba(255, 59, 48, 0.05); border-radius: 14px; border: 1px dashed rgba(255, 59, 48, 0.2); display: none;">
            <div style="display:flex; align-items:center; gap:8px; color: #FF3B30; font-weight: 700; font-size: 13px; margin-bottom: 5px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                çŠ¶æ€å¼‚å¸¸æé†’
            </div>
            <p style="font-size: 12px; color: #666; line-height: 1.5;">
                è‹¥å…³é—­å AI ä»å›å¤å¤–è¯­ï¼Œè¯´æ˜å…¶å¤„äºâ€œè®°å¿†æƒ¯æ€§â€ä¸­ã€‚è¯·åœ¨èŠå¤©æ¡†å‘é€ï¼š<br>
                <b style="color:#1d1d1f; user-select: all;">ç³»ç»ŸæŒ‡ä»¤ï¼šæ¢å¤æ¯è¯­äº¤æµ</b><br>
                å‘é€åå³å¯å½»åº•åˆ‡å›çº¯ä¸­æ–‡ã€‚
            </p>
        </div>

        <div class="tz-group-title">æ ·å¼é¢„è§ˆ (UI PREVIEW)</div>
        <div id="lang-preview-container" style="padding: 20px; background: #fff; border-radius: 20px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px;">
            <div class="msg-row opponent">
                <div class="bubble dual-lang show-trans" id="sample-bubble">
                    <div class="msg-text-main">I will always be by your side, through the starlight and the deep sea.</div>
                    <div class="bubble-translation-box">
                        <div class="trans-line"></div>
                        <div class="msg-text-trans">æˆ‘ä¼šæ°¸è¿œåœ¨ä½ èº«è¾¹ï¼Œç©¿è¿‡æ˜Ÿå…‰ä¸æ·±æµ·ã€‚</div>
                    </div>
                    <div class="trans-toggle-btn">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        <span>ç¿»è¯‘</span>
                    </div>
                </div>
            </div>
        </div>

        <div style="font-size:12px; color:#bbb; padding: 0 10px; line-height: 1.6;">
            æç¤ºï¼šå¼€å¯åï¼ŒAI å°†æ ¹æ®ä½ é€‰æ‹©çš„è¯­è¨€è¿›è¡Œå›å¤ï¼Œå¹¶è‡ªåŠ¨é™„å¸¦ä¸­æ–‡ç¿»è¯‘ã€‚ç‚¹å‡»æ°”æ³¡å³ä¸‹è§’çš„â€œç¿»è¯‘â€æŒ‰é’®å¯å±•å¼€/æŠ˜å è¯‘æ–‡ï¼Œé•¿æŒ‰æ°”æ³¡å”¤èµ·åŠŸèƒ½èœå•ã€‚
        </div>
    </div>
</div>
<div id="subpage-theme-store" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-theme-store')" style="color:#007AFF; font-size:16px; cursor:pointer; display:flex; align-items:center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:-2px;"><polyline points="15 18 9 12 15 6"></polyline></svg> è®¾ç½®
        </div>
        <div style="font-size:17px; font-weight:600;">å¸ƒå±€æ¶æ„</div>
        <div onclick="window.applyFinalTheme()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer;">åº”ç”¨</div>
    </div>

    <div class="app-body" style="padding: 10px 16px 120px 16px; display:block;">

    <div class="tz-group-title">å…¨åŸŸ 1:1 ç‰©ç†é•œåƒé¢„è§ˆ (æ— æŸå¤åˆ»)</div>

    <div class="ui-phone-container" style="width: 340px; height: 620px; background: #111; padding: 8px; border-radius: 48px; position: relative;">
        <div class="ui-phone-notches"></div>
        
        <div id="theme-preview-window" class="ui-phone-screen" style="background: #F2F2F7; border-radius: 40px; overflow: hidden; position: relative;">
            <div class="actual-mirror-layer" id="actual-mirror-layer">
                
                <div class="status-bar" style="background: transparent !important; height: 44px; padding: 0 24px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 14px; font-weight: 700;">16:31</span>
                    <div class="status-right" style="display:flex; align-items:center; gap:5px;">
                        <svg width="18" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M1 9h2v2H1zm4-3h2v5H5zm4-3h2v8H9zm4-3h2v11h-2z"/></svg>
                        <div class="battery-box" style="width:25px; height:12px; border:1.5px solid currentColor; border-radius:3px; position:relative;"><div class="bat-fill" style="width:46%; background:currentColor; height:100%;"></div></div>
                    </div>
                </div>

                <div class="chat-room-header" style="background: transparent !important; border: none !important; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px;">
                    <div class="header-glass-btn left" style="width:40px; height:40px; border-radius:50%; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </div>
                    <div class="header-contact-info">
                        <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Felix" style="width:36px; height:36px; border-radius:50%; border:2px solid #fff;">
                        <div class="header-text-stack"><span style="font-size:14px; font-weight:800;">æµ‹è¯• (Preview)</span></div>
                    </div>
                    <div class="header-glass-btn right" style="width:40px; height:40px; border-radius:50%; background: rgba(255,255,255,0.3); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                    </div>
                </div>

                <div class="chat-scroll-area" style="flex:1; padding:20px; display:flex; flex-direction:column; gap:12px;">
                    <div class="msg-row opponent">
                        <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=Felix" class="chat-avatar-img" style="width:34px; height:34px;">
                        <div class="bubble">
                            <div class="msg-text-main">å¦‚æœä½ èƒ½å¬åˆ°æˆ‘çš„å›å“ã€‚</div>
                        </div>
                    </div>
                    <div class="msg-row user">
                        <div class="bubble"><div class="msg-text-main">æˆ‘ä¸€ç›´éƒ½åœ¨ã€‚</div></div>
                    </div>
                </div>

                <div class="chat-room-footer-wrapper" style="padding: 0 15px 25px 15px;">
                    <div class="chat-room-footer" style="position: relative !important; width: 100% !important; height: 56px !important; border-radius: 28px !important; background: rgba(255,255,255,0.8) !important; backdrop-filter: blur(20px) !important; display: flex !important; align-items: center !important; padding: 0 10px 0 15px !important; gap: 12px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.05) !important;">
                        <div class="footer-add-btn" style="color: #8E8E93; font-size: 24px;">+</div>
                        <div class="chat-room-input" style="flex: 1; color: #C7C7CC; font-size: 15px;">Type something...</div>
                        <div style="display:flex; gap:8px;">
                            <div class="action-btn ai" style="width:36px; height:36px; border-radius:50%; background:rgba(0,0,0,0.05); display:flex; align-items:center; justify-content:center; color:#333;">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                            </div>
                            <div class="action-btn send" style="width:36px; height:36px; border-radius:50%; background:#007AFF; display:flex; align-items:center; justify-content:center; color:#fff;">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="3"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="tz-group-title">å†…æ ¸ä»£ç  (CORE CSS)</div>
        <div class="ios-list-group" style="background:#1d1d1f; border-radius:18px;">
            <textarea id="theme-custom-code" class="code-editor-textarea" 
                placeholder="/* å¯ä»¥åœ¨æ­¤é’ˆå¯¹ .bubble, .status-bar, .chat-room-footer ç¼–å†™æ ·å¼ */"
                oninput="window.livePreviewTheme(this.value)"></textarea>
        </div>
        
        <button class="ios-btn" style="background:#fff; color:#FF3B30; margin-top:30px; border:0.5px solid rgba(0,0,0,0.1);" onclick="window.resetTheme()">
            æŠ¹é™¤æ‰€æœ‰è£…é¥°ä»£ç 
        </button>
    </div>
</div>
<div id="destiny-overlay" class="destiny-stage-ins">
    <button class="ins-exit-btn" onclick="window.closeDestinyPage()">
        <div class="exit-cross-icon"></div>
        <span class="exit-label">Close</span>
    </button>

    <div class="status-bar-safe-area"></div>

    <header class="ins-art-header">
        <div id="fate-hero-img" class="header-hero-bg" onclick="triggerAvatarUpload()"></div>
        
        <div class="header-main-content">
            <div class="fate-status-tag">Destiny Bond Protocol</div>
            <h1 id="sync-char-name" class="art-char-name">NAME</h1>

            <div class="perception-grid">
                <div class="p-item">
                    <span class="p-label">Location</span>
                    <span id="fate-location" class="p-value">æ›¼è°· Â· æ¹„å—æ²³</span>
                </div>
                <div class="p-item">
                    <span class="p-label">Weather</span>
                    <span id="fate-weather" class="p-value">Thunderstorm 24Â°C</span>
                </div>
                <div class="p-item">
                    <span class="p-label">Bonded Days</span>
                    <span id="fate-days" class="p-value">0 Days</span>
                </div>
            </div>

            <div class="mini-progress-track">
                <div id="sync-progress-line" class="progress-glow-line" style="width: 60%;"></div>
            </div>

            <blockquote id="sync-prose-bio" class="art-prose-quote" style="position:relative;">
                â€œæ­£åœ¨æ„Ÿåº”æ—¶ç©ºç•™ç™½...â€
                <div onclick="window.refreshDestinyProse()" style="position:absolute; bottom:-25px; right:0; font-size:10px; opacity:0.3; cursor:pointer; letter-spacing:1px;">RE-WEAVE</div>
            </blockquote>
        </div>
    </header>

    <div id="destiny-story-flow">
        <div style="text-align:center; padding: 0px 0 50px 0; color:rgba(255,255,255,0.05); font-size:10px; letter-spacing:5px;">
            STORY THREAD INITIALIZEDSTO
        </div>
        </div>

    <footer class="destiny-footer-console">
        <div class="destiny-input-wrapper">
            <input type="text" 
                id="destiny-input-field" 
                class="destiny-main-input" 
                placeholder="Whisper to fate / å‘é€ç©ºæ ¼è®© AI æ¨åŠ¨..."
                onkeypress="if(event.key==='Enter') window.sendDestinyCommand()">
        </div>

        <div class="destiny-control-group">
            <button class="console-btn settings" onclick="window.openDestinySettings()" title="Fate Calibration">
                <svg class="console-icon" viewBox="0 0 24 24">
                    <path d="M12 22v-6M12 8V2M20.66 17l-5.2-3M8.54 10l-5.2-3M3.34 17l5.2-3M15.46 10l5.2-3"></path>
                    <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
                </svg>
            </button>

            <button class="console-btn send" onclick="window.sendDestinyCommand()" title="Synchronize Destiny">
                <svg class="console-icon" viewBox="0 0 24 24">
                    <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"></path>
                </svg>
            </button>
        </div>
    </footer>

    <div id="modal-destiny-settings" class="destiny-settings-mask" onclick="if(event.target==this) window.closeDestinySettings()">
        <div class="destiny-settings-card" onclick="event.stopPropagation()">
            <h2 class="settings-title-serif">Protocol Calibration</h2>
            
            <div class="settings-group">
                <span class="settings-label">Writing Style / æ–‡é£</span>
                <input type="text" id="destiny-style-in" class="settings-input-alt" placeholder="ä¾‹å¦‚ï¼šç°ä»£æ•£æ–‡ã€ç ´ç¢ã€æš§æ˜§">
            </div>

            <div class="settings-group">
                <span class="settings-label">Story Thread / å¼ºåˆ¶å‰§æƒ…ç‚¹</span>
                <textarea id="destiny-plot-in" class="settings-input-alt" style="height: 100px; resize: none;" placeholder="å¡«å†™å AI å°†å¼ºåˆ¶æ‰§è¡Œæ­¤æƒ…èŠ‚..."></textarea>
            </div>

            <div class="settings-group">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span class="settings-label">Narrative Length / ç¯‡å¹…</span>
                    <span id="destiny-word-val" style="font-size:12px; color:#fff; font-weight:800;">500</span>
                </div>
                <input type="range" id="destiny-wordcount-in" min="500" max="5000" step="100" value="500" 
                    oninput="window.updateDestinySlider(this)">
            </div>

            <button class="settings-sync-btn" onclick="window.saveDestinyProtocol()">Synchronize Protocol</button>
            <div onclick="window.closeDestinySettings()" style="text-align:center; color:rgba(255,255,255,0.2); font-size:9px; margin-top:20px; cursor:pointer; letter-spacing:1px;">DISMISS</div>
        </div>
    </div>

    <input type="file" id="avatar-input" hidden accept="image/*" onchange="window.updateAvatar(this)">
</div>
<div id="subpage-travel-journal" class="ios-sub-page" style="background:#FFFFFF; z-index: 8000;">
    <div class="app-header" style="background: #FFFFFF; border-bottom: 1px solid #000000;">
        <div onclick="closeSubPage('subpage-travel-journal')" style="color:#000; font-size:14px; cursor:pointer; display:flex; align-items:center; font-weight:700; letter-spacing:1px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>BACK
        </div>
        <div style="font-size:15px; font-weight:900; color:#000; letter-spacing:4px; text-transform:uppercase;">Voyage Journal</div>
        <div id="travel-reset-btn" style="color:#888; font-size:12px; font-weight:700; letter-spacing:1px;" onclick="resetTravelLog()">RESET</div>
    </div>

    <div class="app-body" style="padding:0; display:flex; flex-direction:column; background:#FFFFFF; position:relative; overflow:hidden;">
        
        <div id="view-journal-panel" class="voyage-panel active">
            <div id="travel-planner" style="padding: 60px 30px;">
                <div style="font-size:10px; font-weight:800; letter-spacing:5px; color:#CCC; margin-bottom:10px;">FLIGHT PREPARATION</div>
                <h1 style="color:#000; font-size:36px; font-weight:300; font-family:serif; font-style:italic;">Seek your destiny.</h1>
                <div class="noir-form-container" style="margin-top:50px;">
                    <div class="noir-input-group">
                        <label>ORIGIN / å‡ºå‘åœ°</label>
                        <input type="text" id="travel-from" placeholder="Enter City">
                    </div>
                    <div class="noir-input-group">
                        <label>DESTINATION / ç›®çš„åœ°</label>
                        <input type="text" id="travel-to" placeholder="Enter City">
                    </div>
                    <div class="noir-input-group" style="border:none;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <label>STOPS / åœç•™ç«™ç‚¹</label>
                            <span id="stops-val-display" style="font-size:16px; font-weight:900; color:#000; font-family:serif; letter-spacing:1px;">05 SESSIONS</span>
                        </div>
                        
                        <div class="slider-wrapper" style="padding: 10px 0;">
                            <input type="range" id="travel-stops-slider"Â 
                                min="3" max="50" step="1" value="5"Â 
                                class="noir-range-slider"
                                oninput="updateStopsUI(this)">
                            
                            <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:9px; color:#AAA; font-weight:800; letter-spacing:1px;">
                                <span>MIN: 03</span>
                                <span>MAX: 20</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="noir-btn-main" onclick="startTravelMapping()">GENERATE TRAJECTORY</button>
            </div>

            <div id="travel-canvas-area" style="display:none; padding:30px 20px 100px;">
                <div id="boarding-pass-container"></div>
                <div style="font-size:10px; font-weight:800; color:#000; margin-top:50px; letter-spacing:3px; border-bottom:1px solid #000; padding-bottom:10px;">MAP DECODING</div>
                <div id="travel-map-box">
                    <div class="map-stability-notice">NAV-PROTOCOL: STABLE VIEW RECOMMENDED</div>
                    <svg id="travel-svg-map" width="100%" height="100%"></svg>
                    <div id="travel-dots-layer"></div>
                </div>
                <button class="btn-save-voyage" onclick="window.saveTravelStub()">ARCHIVE THIS VOYAGE / å°å­˜æ­¤è¡Œæ—…</button>
            </div>
        </div>

        <div id="view-vault-panel" class="voyage-panel">
            <div style="padding: 40px 20px 120px;">
                <div class="hero-label" style="color:#CCC; font-size:10px; font-weight:900; letter-spacing:4px; margin-bottom:10px;">TEMPORAL RECORDS</div>
                <h1 style="font-family:serif; font-style:italic; font-size:32px; margin-bottom:40px;">Memory Vault.</h1>
                <div id="archive-list-container">
                    </div>
            </div>
        </div>

        <div class="voyage-nav-wrapper">
            <div class="voyage-capsule-nav">
                <div class="v-nav-item active" id="btn-nav-journal" onclick="switchVoyageTab('journal')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    <span>JOURNAL</span>
                </div>
                <div class="v-nav-item" id="btn-nav-vault" onclick="switchVoyageTab('vault')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <span>VAULT</span>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="modal-travel-log" class="destiny-settings-mask" onclick="this.style.display='none'">
    <div class="aesthetic-card" onclick="event.stopPropagation()">
        
        <div class="log-fixed-header">
            <div id="log-location-tag">LOCATION</div>
            <h2 id="log-city-name">åŸå¸‚åç§°</h2>
        </div>

        <div class="log-scroll-area">
            <div id="log-content-body">
                æ­£åœ¨åŒæ­¥é‡å­æ„Ÿå®˜é¢‘ç‡...
            </div>
        </div>

        <div id="log-mood-tag">
            MOOD: å®é™
        </div>

    </div>
</div>

<svg style="position: absolute; width: 0; height: 0;">
    <filter id="ink-noise">
        <feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
    </filter>
</svg>

<div id="subpage-voyage-archive" class="ios-sub-page" style="background:#F5F5F7;">
    <div class="app-header" style="background: #FFF; border-bottom: 1px solid #000;">
        <div onclick="closeSubPage('subpage-voyage-archive')" style="color:#000; font-size:14px; font-weight:700; cursor:pointer;">CLOSE</div>
        <div style="font-size:15px; font-weight:900; letter-spacing:4px;">VAULT</div>
        <div style="width:40px;"></div>
    </div>
    <div class="app-body" style="padding: 30px 20px;">
        <div class="hero-label">HISTORICAL TRAJECTORIES</div>
        <h1 style="font-family:serif; font-style:italic; font-size:32px; margin-bottom:40px;">Memory Vault.</h1>
        <div id="archive-list-container">
            </div>
    </div>
</div>
<div id="subpage-ticket-reveal" class="ios-sub-page" style="background:#121212; z-index: 9500; display: none; color: #fff;">
    <div class="app-header" style="background: transparent; border-bottom: none; position: absolute; top:0; left:0; width:100%; z-index:10;">
        <div onclick="closeSubPage('subpage-ticket-reveal')" style="color:rgba(255,255,255,0.7); font-size:12px; font-weight:700; cursor:pointer; background: rgba(0,0,0,0.6); padding: 6px 14px; border-radius: 30px; backdrop-filter: blur(10px); margin-top: 10px; border: 1px solid rgba(255,255,255,0.1);">
            CLOSE ARCHIVE
        </div>
    </div>

    <div class="app-body" style="padding: 100px 20px 40px; display: flex; flex-direction: column; align-items: center;">
        
        <div style="font-size:10px; font-weight:800; color:#555; letter-spacing:4px; margin-bottom:20px;">TAP TICKET TO VALIDATE</div>

        <div id="reveal-ticket-container" style="perspective: 1200px; cursor: pointer; margin-bottom: 50px; z-index: 5;">
            </div>

        <div id="reveal-map-section" style="width: 100%; opacity: 0; filter: blur(10px); transition: all 1s cubic-bezier(0.19, 1, 0.22, 1); pointer-events: none; transform: translateY(30px);">
             <div style="font-size:9px; font-weight:800; color:#888; margin-bottom:15px; letter-spacing:3px; text-align: center; display: flex; align-items: center; justify-content: center; gap:10px;">
                 <span style="display:inline-block; width:20px; height:1px; background:#333;"></span>
                 TRAJECTORY DECODED
                 <span style="display:inline-block; width:20px; height:1px; background:#333;"></span>
             </div>
             <div id="reveal-map-box" style="width:100%; height:360px; border-radius: 4px; overflow: hidden; position: relative; border: 1px solid #333; background: #000;">
                 </div>
        </div>
    </div>
</div>
<div id="subpage-chat-search" class="ios-sub-page" style="background:#F2F2F7;">
    <div class="app-header">
        <div onclick="closeSubPage('subpage-chat-search')" style="color:#007AFF; font-size:16px; cursor:pointer; display:flex; align-items:center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> è¿”å›
        </div>
        <div style="font-size:17px; font-weight:600;">æŸ¥æ‰¾èŠå¤©å†…å®¹</div>
        <div style="width:50px;"></div>
    </div>

    <div class="app-body" style="padding: 15px 16px; display:block;">
        <div class="ios-search-wrapper" style="margin-bottom: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3" style="margin-right: 10px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="chat-search-input" placeholder="å…³é”®è¯ã€æ—¥æœŸã€æ„è±¡..." style="border:none; background:transparent; outline:none; font-size:16px; flex:1; color:#000;" oninput="window.executeChatSearch()">
        </div>

        <div style="display:flex; gap:8px; margin-bottom:25px; overflow-x:auto; padding-bottom:5px;" class="hide-scrollbar">
            <div class="city-tag" style="flex:none; padding:8px 15px; font-size:12px; background:#fff;" onclick="window.setSearchFilter('all')">å…¨éƒ¨</div>
            <div class="city-tag" style="flex:none; padding:8px 15px; font-size:12px; background:#fff;" onclick="window.setSearchFilter('user')">æˆ‘çš„è¨€è¯­</div>
            <div class="city-tag" style="flex:none; padding:8px 15px; font-size:12px; background:#fff;" onclick="window.setSearchFilter('opponent')">Ta çš„å›åº”</div>
        </div>

        <div id="search-result-count" style="font-size:12px; color:#8e8e93; margin-bottom:15px; padding-left:5px;">è¾“å…¥å…³é”®è¯å¼€å§‹æ£€ç´¢...</div>

        <div id="chat-search-results" style="display:flex; flex-direction:column; gap:12px;">
            </div>
        
        <div style="height:50px;"></div>
    </div>
</div>
<div id="modal-image-picker" class="ios-alert-mask" style="align-items: flex-end; z-index: 20001;" onclick="if(event.target==this) this.style.display='none'">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span style="font-weight: 800; font-size: 17px;">å‘é€å›¾ç‰‡</span>
            <div class="p2-done-btn" onclick="document.getElementById('modal-image-picker').style.display='none'">å–æ¶ˆ</div>
        </div>
        <div class="p2-editor-body">
            <input type="text" id="chat-img-url-in" class="p2-main-input" placeholder="ç²˜è´´å›¾ç‰‡ URL...">
            <button class="ios-btn primary" style="background:#1d1d1f; margin-bottom:15px;" onclick="sendImageMessage('url')">å‘é€é“¾æ¥å›¾ç‰‡</button>
            
            <div style="text-align:center; color:#d1d1d6; font-size:10px; margin-bottom:15px; font-weight:800; letter-spacing:2px;">OR</div>
            
            <label class="custom-upload-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                <span>ä»ç›¸å†Œé€‰æ‹©</span>
                <input type="file" id="chat-img-file-in" hidden accept="image/*" onchange="sendImageMessage('file')">
            </label>
        </div>
    </div>
</div>

<div id="emoji-modal-mask" class="ios-alert-mask" onclick="window.closeEmojiModal(event)">
    <div class="emoji-modal-card" onclick="event.stopPropagation()">
        <div class="emoji-header">
            <span class="emoji-title" style="font-family: serif; font-weight: 800;">æˆ‘çš„è¡¨æƒ…</span>
            <span class="emoji-cancel" style="color: #007AFF; font-weight: 600; cursor: pointer;" onclick="window.closeEmojiModal()">å–æ¶ˆ</span>
        </div>
        
        <div id="emoji-grid-list"></div>

        <div class="emoji-footer" style="text-align: center; margin-top: 20px;">
            <div style="font-size: 10px; color: #ddd; font-weight: 900; letter-spacing: 3px; margin-bottom: 15px;">OR</div>
            <div class="emoji-add-btn" onclick="openEmojiManager(); window.closeEmojiModal();" style="background: #1d1d1f; color: #fff; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; cursor: pointer;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <span>æ·»åŠ æ–°è¡¨æƒ…</span>
            </div>
        </div>
    </div>
</div>
<div id="modal-emoji-manager" class="ios-alert-mask" style="display:none; align-items: flex-end; z-index: 30001;" onclick="if(event.target==this) this.style.display='none'">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span style="font-family: serif; font-weight: 800; font-size: 18px; letter-spacing: 1px;">NEW_EMOJI_TRACE</span>
            <div class="p2-done-btn" onclick="window.saveNewEmoji()" style="color: #007AFF; font-weight: 700; cursor: pointer;">å®Œæˆ</div>
        </div>

        <div class="p2-editor-body" style="display: flex; flex-direction: column; align-items: center; padding-top: 10px;">
            <div id="emoji-pre-box" onclick="document.getElementById('emoji-file-in').click()">
                <img id="emoji-pre-img" style="display:none; width:100%; height:100%; object-fit:cover;">
                <div id="emoji-pre-placeholder" style="text-align:center;">
                    <div style="font-size: 24px; color: #000; margin-bottom: 5px;">+</div>
                    <div style="font-size: 9px; font-weight: 900; color: #AAA; letter-spacing: 2px;">SELECT_IMAGE</div>
                </div>
            </div>

            <div style="width: 100%; margin-top: 25px;">
                <div style="font-size: 9px; font-weight: 900; color: #AAA; letter-spacing: 2px; margin-bottom: 8px; margin-left: 5px;">TAG / è§¦å‘æŒ‡ä»¤</div>
                <input type="text" id="emoji-tag-in" class="p2-main-input" placeholder="è¾“å…¥è¯†åˆ«å…³é”®è¯ (å¦‚: å‚²å¨‡, å“­å“­)..." style="margin-bottom: 10px; background: #f2f2f7; border: 1px solid transparent; transition: all 0.3s;">
            </div>

            <input type="file" id="emoji-file-in" hidden accept="image/*" onchange="window.handleEmojiPre(this)">
            
            <div class="tool-btn" onclick="document.getElementById('modal-emoji-manager').style.display='none'" style="color:#FF3B30; font-weight: 600; margin-top: 10px; cursor: pointer; font-size: 14px;">æ”¾å¼ƒæ­¤ç‰‡æ®µ</div>
        </div>
    </div>
</div>
<div id="subpage-voice-settings" class="ios-sub-page noir-voice-gate">
    <div class="app-header noir-header-fix">
        <div onclick="closeSubPage('subpage-voice-settings')" class="noir-h-btn">CANCEL</div>
        <div class="noir-h-title">SPEECH ENGINE</div>
        <div onclick="window.saveVoiceSettings()" class="noir-h-btn bold">DONE</div>
    </div>

    <div class="app-body" style="padding:0; display:block; overflow-y:auto;">
        <div class="noir-section-label">AUTHORIZATION / æˆæƒ</div>
        <div class="noir-full-list">
            <div class="noir-row">
                <span class="n-label">API Key</span>
                <input type="password" id="voice-key-in" class="noir-clean-input" placeholder="Secret Key">
            </div>
            <div class="noir-row last">
                <span class="n-label">Group ID</span>
                <input type="text" id="voice-group-in" class="noir-clean-input" placeholder="Group ID">
            </div>
        </div>

        <div class="noir-section-label">CORE MODEL / æ ¸å¿ƒæ¨¡å‹</div>
        <div class="noir-full-list">
            <div class="noir-row" onclick="window.openVoiceModelPicker()">
                <span class="n-label">å½“å‰é€‰æ‹©</span>
                <div class="n-value-link" id="voice-model-display">ç­‰å¾…è·å–...</div>
            </div>
            <div class="noir-row last" onclick="window.fetchAllMiniMaxModels()" style="justify-content: center; background: #fafafa;">
                <span id="fetch-model-btn-text" style="color: #007AFF; font-size: 14px; font-weight: 700; letter-spacing: 1px;">
                    âœ¦ FETCH MODELS FROM SERVER
                </span>
            </div>
        </div>
        
        <div class="noir-footer-hint">PROTOCOL: MINIMAX T2A V2.0 // NOIR KERNEL</div>
    </div>
</div>
<div id="custom-voice-picker" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index: 1000001;" onclick="this.style.display='none'">
    <div class="noir-picker-box" onclick="event.stopPropagation()">
        <div class="n-picker-header" id="picker-title">SELECT OPTION</div>
        <div id="picker-options-list" class="n-picker-scroll">
            </div>
        <div class="n-picker-cancel" onclick="document.getElementById('custom-voice-picker').style.display='none'">CANCEL</div>
    </div>
</div>
<div id="subpage-voice-calibrate" class="ios-sub-page" style="background:#F2F2F7; z-index: 11000;">
    <div class="app-header" style="background: rgba(242,242,247,0.95); backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.1);">
        <div onclick="closeSubPage('subpage-voice-calibrate')" style="color:#007AFF; font-size:17px; cursor:pointer; display:flex; align-items:center; width: 80px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg> è¿”å›
        </div>
        <div style="font-size:17px; font-weight:600; flex:1; text-align:center;">è¯­éŸ³åè®®æ ¡å‡†</div>
        <div onclick="window.saveVoiceCalibrate()" style="color:#007AFF; font-size:17px; font-weight:600; cursor:pointer; width: 80px; text-align: right;">å®Œæˆ</div>
    </div>

    <div class="app-body" style="padding: 20px 16px; display: block; width: 100%; box-sizing: border-box;">
        
        <div class="tz-group-title">TIMBRE / éŸ³è‰²æŒ‡çº¹</div>
        <div class="ios-list-group">
            <div class="ios-list-item" style="height: auto; padding: 15px 16px;">
                <div style="display:flex; flex-direction:column; width:100%;">
                    <span style="font-size:12px; color:#8e8e93; font-weight:700; margin-bottom:8px; letter-spacing:1px;">VOICE ID</span>
                    <input type="text" id="calib-voice-id-in" class="ios-input" style="margin:0; background:#f2f2f7; border:none; text-align:left;" placeholder="ç²˜è´´å…‹éš†éŸ³è‰² ID">
                </div>
            </div>
        </div>

        <div class="tz-group-title">NATIVE LANGUAGE / æ¯è¯­è®¾å®š</div>
        <div class="ios-list-group">
            <div class="ios-list-item" onclick="window.openVoiceLangPicker()">
                <div class="item-content" style="border:none;">
                    <span class="item-label">è¯´è¯è¯­è¨€</span>
                    <div class="item-right">
                        <span class="item-value" id="calib-lang-display">è‡ªåŠ¨ (Auto)</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="tz-group-title">MULTILINGUAL / åŒè¯­ç­–ç•¥</div>
        <div class="ios-list-group">
            <div class="ios-list-item">
                <div class="item-content" style="border:none;">
                    <span class="item-label">æœ—è¯»åŒè¯­å¯¹ç…§å†…å®¹</span>
                    <div class="item-right">
                        <input type="checkbox" id="calib-dual-toggle" class="world-checkbox" style="width:24px; height:24px;">
                    </div>
                </div>
            </div>
        </div>

        <div class="ios-list-item">
            <div class="item-content">
                <span class="item-label">å¯ç”¨è¯­éŸ³åˆæˆ (Enable TTS)</span>
                <div class="item-right">
                    <label class="ios-switch">
                        <input type="checkbox" id="calib-tts-toggle" checked> 
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="ios-list-note">å…³é—­åç‚¹å‡»è¯­éŸ³æ¡ä»…å±•ç¤ºæ–‡å­—ï¼Œä¸ä¼šæ¶ˆè€—è¯­éŸ³é¢åº¦ã€‚</div>

        <div style="font-size:11px; color:#bbb; padding:15px 5px; line-height:1.6;">
            æç¤ºï¼šå½“å‰æ ¡å‡†é’ˆå¯¹ [ <span id="calib-target-name" style="color:#888; font-weight:800;">...</span> ] ç”Ÿæ•ˆã€‚
        </div>
    </div>
</div>
<div id="modal-voice-input" class="ios-alert-mask" style="align-items: flex-end; z-index: 20002;" onclick="if(event.target==this) this.style.display='none'">
    <div class="p2-editor-sheet">
        <div class="p2-editor-header">
            <span style="font-weight: 800; font-size: 17px;">å½•åˆ¶è¯­éŸ³ (æ¨¡æ‹Ÿ)</span>
            <div class="p2-done-btn" onclick="document.getElementById('modal-voice-input').style.display='none'">å–æ¶ˆ</div>
        </div>
        <div class="p2-editor-body">
            <textarea id="voice-text-in" class="p2-main-input" style="height:100px; resize:none; line-height:1.5;" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯­éŸ³å†…å®¹..."></textarea>
            
            <button class="ios-btn primary" style="background:#007AFF; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:8px;" onclick="window.sendSimulatedVoice()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                <span>å‘é€è¯­éŸ³</span>
            </button>
            
            <div style="font-size:11px; color:#8e8e93; text-align:center; margin-top:15px;">
                ç³»ç»Ÿå°†æ ¹æ®æ–‡æœ¬é•¿åº¦è‡ªåŠ¨ä¼°ç®—è¯­éŸ³æ—¶é•¿
            </div>
        </div>
    </div>
</div>
<div id="app-photos" class="ios-app-window" style="background: #F2F2F7; z-index: 6000; display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;">
    
    <div class="photos-header-large" style="
        padding: 30px 20px 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: transparent;
        flex-shrink: 0;
    ">
        <div class="photos-title-large" style="
            font-size: 34px;
            font-weight: 800;
            color: #000000;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: -0.5px;
            line-height: 1.1;
        ">
            Photos
        </div>

        <div class="header-actions" style="display: flex; align-items: center; gap: 12px;">
            
            <div class="header-btn-circle" onclick="window.openPhotoUploadModal()" style="
                width: 32px; height: 32px;
                background: rgba(120, 120, 128, 0.16);
                border-radius: 50%;
                display: flex; justify-content: center; align-items: center;
                cursor: pointer;
                transition: background 0.2s;
            " onmousedown="this.style.background='rgba(120, 120, 128, 0.3)'" onmouseup="this.style.background='rgba(120, 120, 128, 0.16)'" onmouseleave="this.style.background='rgba(120, 120, 128, 0.16)'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>

            <div class="header-btn-circle" onclick="closeApp('app-photos')" style="
                width: 32px; height: 32px;
                background: rgba(120, 120, 128, 0.16);
                border-radius: 50%;
                display: flex; justify-content: center; align-items: center;
                cursor: pointer;
                transition: background 0.2s;
            " onmousedown="this.style.background='rgba(120, 120, 128, 0.3)'" onmouseup="this.style.background='rgba(120, 120, 128, 0.16)'" onmouseleave="this.style.background='rgba(120, 120, 128, 0.16)'">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8E8E93" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>

        </div>
    </div>

    <div class="photos-content-area" style="padding: 10px 2px;">
        <div id="photos-grid-view" class="photos-grid">
            </div>
        
        <div id="photos-empty-state" class="empty-state" style="display:none; flex-direction:column; align-items:center; margin-top:100px; color:#C7C7CC;">
            <div style="opacity: 0.6;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
            </div>
            <p style="font-size:14px; margin-top:15px; font-weight:500; letter-spacing:0.5px;">æš‚æ— ç…§ç‰‡</p>
        </div>
    </div>

    <div class="photos-bottom-nav-container">
        <div class="photos-bottom-capsule">
            <div class="nav-item active" onclick="switchPhotoTab('mine')">æˆ‘çš„</div>
            <div style="width:1px; height:15px; background:#ddd; margin:0 10px;"></div>
            <div class="nav-item" onclick="switchPhotoTab('theirs')">Taçš„</div>
        </div>
    </div>
</div>

<div id="modal-photo-upload" class="ios-modal-mask" style="
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
    z-index: 20000; align-items: flex-end; justify-content: center;
">
    <div class="ios-modal-card" style="
        width: 100%; max-width: 500px; background: #fff;
        border-radius: 24px 24px 0 0; padding: 25px; padding-bottom: 40px;
        animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        max-height: 85vh; display: flex; flex-direction: column;
    ">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-shrink: 0;">
            <span onclick="document.getElementById('modal-photo-upload').style.display='none'" style="color: #8E8E93; font-size: 16px; font-weight: 600; cursor: pointer;">å–æ¶ˆ</span>
            <span class="modal-title" style="font-size: 17px; font-weight: 700;">æ–°ç…§ç‰‡</span>
            <span class="highlight-btn" onclick="submitPhotoUpload()" style="color: #007AFF; font-size: 16px; font-weight: 700; cursor: pointer;">å‘å¸ƒ</span>
        </div>

        <div style="overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch;">
            
            <div class="upload-preview-container" onclick="document.getElementById('photo-file-input').click()" style="
                width: 100%; aspect-ratio: 16/9; background: #F2F2F7;
                border-radius: 18px; display: flex; align-items: center; justify-content: center;
                overflow: hidden; margin-bottom: 25px; position: relative; cursor: pointer;
                border: 1px dashed rgba(0,0,0,0.1);
            ">
                <img id="upload-img-preview" src="" style="display:none; width: 100%; height: 100%; object-fit: cover;">
                <div id="upload-placeholder" style="display: flex; flex-direction: column; align-items: center; color: #C7C7CC;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                    </svg>
                    <span style="font-size: 13px; margin-top: 8px; font-weight: 500;">ç‚¹å‡»é€‰æ‹©ç…§ç‰‡</span>
                </div>
                <input type="file" id="photo-file-input" accept="image/*" style="display:none" onchange="handlePhotoFileSelect(this)">
            </div>

            <textarea id="upload-desc-input" placeholder="å†™ä¸‹æ­¤åˆ»çš„æ„Ÿå—... (AI å°†æ ¹æ®æ­¤å†…å®¹è¿›è¡Œé‰´èµ)" style="
                width: 100%; height: 80px; padding: 15px; background: #F9F9F9;
                border: none; border-radius: 16px; font-size: 15px; resize: none;
                font-family: inherit; margin-bottom: 25px; outline: none; box-sizing: border-box;
            "></textarea>
            
            <div style="margin-bottom: 10px;">
                <div style="font-size: 13px; font-weight: 600; color: #8E8E93; margin-bottom: 12px; letter-spacing: 0.5px; text-transform: uppercase;">
                    é‚€è¯·ç‚¹è¯„ (INVITE)
                </div>
                <div id="char-selector-container" class="char-selector-scroll">
                    </div>
            </div>

        </div>
    </div>
</div>

<div id="photo-detail-mask" class="photo-detail-mask" onclick="closePhotoDetailModal()">
    <div id="modal-photo-detail" class="ios-card-viewer" onclick="event.stopPropagation()">
        <div class="card-header-tools">
            <div class="tool-btn-back" onclick="closePhotoDetailModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"/></svg>
            </div>
            <div class="card-actions-group">
                <div class="tool-btn-circle" onclick="forwardCurrentPhoto()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></svg>
                </div>
                <div class="tool-btn-circle danger" onclick="showPhotoActions()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </div>
            </div>
        </div>

        <div class="card-main-scroller">
            <div class="card-hero-img">
                <img id="detail-main-img" src="">
            </div>
            
            <div class="card-content-body">
                <div class="user-info-row">
                    <span id="detail-user-name" class="user-name">æˆ‘</span>
                    <span class="post-time" id="detail-date-title">2026/1/26</span>
                </div>
                <p id="detail-desc-text" class="post-desc"></p>
                
                <div class="comment-section-title">äº’åŠ¨å›å“</div>
                <div id="detail-comments-list" class="comments-container">
                    </div>
            </div>
            <div style="height: 100px;"></div> </div>

        <div class="card-input-bar">
            <input type="text" id="detail-reply-input" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•...">
            <div class="send-btn-circle" onclick="sendPhotoComment()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
            </div>
        </div>
    </div>
</div>
<div id="photo-fullscreen-browser" onclick="closeFullscreenPhoto()">
    <div class="close-fullscreen">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
    <img id="fullscreen-img-target" class="fullscreen-img" src="">
</div>
<div id="page-char-gallery" class="ios-app-window gallery-viewer-window">
    <div class="app-header" style="background:transparent; border:none;">
        <div class="header-close-btn" onclick="closeSubPage('page-char-gallery')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </div>
        <div class="header-title" id="gallery-header-title">Collection</div>
        <div style="width:40px;"></div>
    </div>

    <div class="app-body" style="padding:0; display:block; overflow-y:auto;">
        <div class="gallery-header-profile">
            <div class="header-char-name" id="gallery-char-name-ui">Dunk</div>
            <div class="header-char-bio" id="gallery-char-bio-ui">æ­£åœ¨è¯»å–åº•å±‚æ¡£æ¡ˆ...</div>
        </div>

        <div class="gallery-console">
            <div class="console-btn-luxe" id="btn-ai-portrait" onclick="generateAIPortrait()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                <span>GENERATE SNAP</span>
            </div>
            <div class="console-btn-luxe" id="btn-footprint" onclick="generateRetroFootprints()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                <span>FOOTPRINTS</span>
            </div>
        </div>

        <div id="gallery-display-area" style="padding: 0 20px;">
            <div id="ai-portrait-container" style="display:none;">
                 <div class="ai-portrait-frame">
                    <div class="scanning-line" id="ai-scan-line"></div>
                    <img id="ai-portrait-img" src="" style="width:100%; height:100%; object-fit:cover; display:none;">
                    <div class="ai-prose-overlay" id="ai-prose-ui">
                        <div class="ai-prose-text">æ­£åœ¨æ•è·å½“å‰ç»´åº¦çš„è§†è§‰æ®‹å½±...</div>
                    </div>
                 </div>
            </div>
        </div>

        <div class="tz-group-title">å†å²ç¬é—´ (ARCHIVES)</div>
        <div id="char-gallery-history" class="char-history-grid"></div>
    </div>
</div>
<div id="modal-theirs-photo-detail">
    <div id="theirs-detail-bg" class="theirs-detail-bg-blur"></div>
    
    <div class="card-header-tools" style="position:fixed; top:50px; left:0; right:0; padding:0 20px; display:flex; justify-content:space-between; align-items:center;">
        <div class="tool-btn-back" onclick="closeTheirsPhotoDetail()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="15 18 9 12 15 6"/></svg>
        </div>
        
        <div class="card-actions-group" style="display:flex; gap:12px;">
            <div class="tool-btn-circle" onclick="forwardTheirsSnap()" style="width:38px; height:38px; background:rgba(255,255,255,0.2); backdrop-filter:blur(15px); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; border:0.5px solid rgba(255,255,255,0.3); cursor:pointer;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 10 20 15 15 20"/><path d="M4 4v7a4 4 0 0 0 4 4h12"/></svg>
            </div>
            <div class="tool-btn-circle" onclick="deleteTheirsSnap()" style="width:38px; height:38px; background:rgba(255,255,255,0.2); backdrop-filter:blur(15px); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#FF3B30; border:0.5px solid rgba(255,255,255,0.3); cursor:pointer;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </div>
        </div>
    </div>

    <div class="theirs-detail-scroller">
        <div class="theirs-portrait-card">
            <div class="theirs-prose-text" id="theirs-prose-body">æ­£åœ¨åŒæ­¥æ„Ÿå®˜æ–‡å­—...</div>
            <div style="font-size:10px; color:#8e8e93; letter-spacing:4px; margin-top:30px;">FRAGMENT_ARCHIVE</div>
        </div>

        <div class="theirs-interaction-pod">
            <div class="user-info-row">
                <span id="theirs-char-name" class="user-name" style="font-size:22px; color:#000;">Dunk</span>
                <span class="post-time" id="theirs-date-title">2026/1/26</span>
            </div>
            <div class="comment-section-title" style="margin-top:20px;">äº’åŠ¨å›å“</div>
            <div id="theirs-comments-list"></div>
        </div>
    </div>

    <div class="card-input-bar">
        <input type="text" id="theirs-reply-input" placeholder="å›åº” Ta çš„ç¬é—´...">
        <div class="send-btn-circle" onclick="sendCommentToTheirs()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
        </div>
    </div>
</div>
<div id="modal-footprints">
    <div class="footprints-header">
        <div class="brand-title">TEMPORAL ARCHIVE</div>
        <div class="footprints-header-btns">
            <div id="btn-save-footprints" class="save-archive-btn" onclick="saveCurrentFootprints()">SAVE ARCHIVE</div>
            <div class="close-archive-btn" onclick="document.getElementById('modal-footprints').style.display='none'">CLOSE</div>
        </div>
    </div>
    
    <div class="footprints-scroller" id="footprints-list"></div>
    <div class="footprints-footer">SYSTEM_Ready // 2026.01.26</div>
</div>
<div id="modal-footprint-single-detail" onclick="closeFootprintSingle()">
    <div class="polaroid-detail-frame" onclick="event.stopPropagation()">
        <div class="polaroid-inner-content" id="single-polaroid-text">
            â€œè¿™æ˜¯ä¸€æ®µè¢«åˆ»å½•çš„è®°å¿†...â€
        </div>
        <div class="polaroid-footer-time" id="single-polaroid-time">
            20:00
        </div>
    </div>
</div>
<div id="subpage-history-vault" class="ios-sub-page" style="background: #ffffff; z-index: 20000;">
    <div class="app-header" style="background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.05);">
        <div onclick="closeSubPage('subpage-history-vault')" style="color:#1d1d1f; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            BACK
        </div>
        <div style="font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 700; color:#1d1d1f; letter-spacing: 1px;">
            Memories
        </div>
        <div style="width:60px;"></div>
    </div>

    <div class="app-body" style="padding: 0; background: #fcfcfc;">
        <div style="padding: 40px 30px 20px 30px;">
            <div style="font-size:10px; color:#999; letter-spacing:3px; font-weight:800; margin-bottom:10px;">TIMELINE ARCHIVE</div>
            <h1 style="font-family: 'Noto Serif SC', serif; font-size: 32px; color:#1d1d1f; font-weight: 300;">æ—¶å…‰çš„æŠ˜ç—•</h1>
        </div>

        <div id="white-timeline-container" class="white-timeline">
            </div>
    </div>
</div>
<div id="subpage-archive-reader" class="ios-sub-page" style="background: #fdfdfd; z-index: 25000; display: none;">
    <div class="app-header" style="background: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(0,0,0,0.05);">
        <div onclick="closeArchiveReader()" style="color:#1d1d1f; font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            LIST
        </div>
        <div style="font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 700; color:#000; letter-spacing: 2px; text-transform: uppercase;">
            Archive
        </div>
        <div style="width:60px;"></div>
    </div>

    <div class="archive-body-scroller">
        <div class="archive-magazine-header">
            <div class="archive-date-big" id="reader-day">26</div>
            <div class="archive-date-meta">
                <span id="reader-month">JANUARY</span>
                <span id="reader-year">2026</span>
            </div>
        </div>

        <div class="archive-ai-summary">
            <div class="summary-quote-icon">â€œ</div>
            <div id="reader-summary-text" class="summary-text-content">
                æ­£åœ¨å›æº¯å½“å¤©çš„è®°å¿†æµ...
            </div>
        </div>

        <div class="archive-divider-line"></div>

        <div id="reader-timeline-container" class="archive-timeline-box">
            </div>

        <div class="archive-footer-seal">
            <div class="seal-box">
                <span>SEALED BY</span>
                <span id="reader-seal-name" style="font-family:'Dancing Script',cursive; font-size:24px; margin:5px 0;">Luna</span>
                <span style="font-size:9px; letter-spacing:2px;">TEMPORAL ARCHIVE</span>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ğŸ–¼ï¸ ç»ˆæç‰ˆï¼šå…¨åª’ä½“è½¬å‘å¼•æ“
 * é€»è¾‘ï¼šæå– Base64 å›¾ç‰‡æµ -> æ³¨å…¥åª’ä½“åè®® -> å”¤é†’è½¬å‘å±‚
 */
window.forwardCurrentPhoto = async function() {
    console.log("%c[Action] ç‰©ç†è§¦å‘ï¼šå›¾ç‰‡åª’ä½“è½¬å‘åè®®", "color: #007AFF; font-weight: bold;");

    const modal = document.getElementById('modal-photo-detail');
    const pid = modal ? modal.dataset.pid : null;

    if (!pid) {
        if (typeof showToast === 'function') showToast("âš ï¸ å­˜æ¡£å®šä½å¤±è´¥");
        return;
    }

    try {
        // 1. ä»å¤§å®¹é‡ä»“åº“æå–åŒ…å«å›¾ç‰‡æ•°æ®çš„å®Œæ•´æ¡£æ¡ˆ
        const myPhotos = await loadFromDB('user_my_photos') || [];
        const photo = myPhotos.find(p => p.id === pid);

        if (!photo || !photo.src) throw new Error("å›¾ç‰‡æ•°æ®å·²æŸåæˆ–ä¸¢å¤±");

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°è½¬å‘æ•°æ®åè®®ï¼ŒåŠ å…¥å›¾ç‰‡ç±»å‹
        // æˆ‘ä»¬åŒæ—¶ä¼ å›¾ç‰‡å’Œæ–‡å­—ï¼Œè®©èŠå¤©æ¡†èƒ½è¯†åˆ«è¿™æ˜¯ä¸€ä¸ªâ€œå¸¦å›¾è½¬å‘â€
        window.pendingForwardData = [
            { 
                type: 'image', 
                src: photo.src // ç‰©ç†æ³¨å…¥ Base64 å›¾ç‰‡æµ
            },
            { 
                type: 'text', 
                text: `[åˆ†äº«ç¬é—´] â€œ${photo.desc}â€` 
            }
        ];
        
        // è®°å½•é¢„è§ˆå›¾ï¼Œä¾›è½¬å‘ç¡®è®¤å¼¹çª—ä½¿ç”¨
        window.pendingForwardPreview = photo.src;

        // 2. å”¤é†’è½¬å‘å±‚
        const picker = document.getElementById('page-forward-picker');
        if (picker) {
            picker.style.display = 'flex';
            picker.style.zIndex = '500000'; 
            
            void picker.offsetWidth; 
            picker.style.transform = 'translateY(0)';
            picker.classList.add('active');

            if (window.switchForwardTab) {
                window.switchForwardTab('friends');
            }
            
            console.log("âœ… åª’ä½“è½¬å‘åè®®å·²æ¿€æ´»ï¼Œå›¾ç‰‡æµå·²å°±ç»ª");
        }

    } catch (e) {
        console.error("è½¬å‘åè®®ä¸­æ–­:", e);
        if (typeof showToast === 'function') showToast("è½¬å‘å¤±è´¥: " + e.message);
    }
};
// --- 1. æ—¶åŒºä¸æ—¶é’Ÿåº•å±‚é…ç½® ---
const appSettings = {
    // ç‰©ç†é”å®šï¼šä¼˜å…ˆè¯»å–è®¾ç½®é¡µçš„æ—¶åŒºï¼Œæ²¡è®¾ç½®åˆ™é»˜è®¤ä¸ºä¸Šæµ·
    userTimezone: localStorage.getItem('app_timezone') || 'Asia/Shanghai', 
};

/**
 * ğŸ›°ï¸ é«˜ç»´æ—¶ç©ºæ„ŸçŸ¥å†…æ ¸ (100% ç‰©ç†åŒæ­¥ç‰ˆ)
 * é€»è¾‘ï¼šç»å¯¹æœä» Settings é‡Œçš„ 'user_timezone'ï¼Œå®æ—¶ç°æŠ“ï¼Œä¸è®¾é»˜è®¤ã€‚
 */
function getAppLocalTime() {
    const now = new Date();
    
    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥ä»ç‰©ç†å­˜å‚¨ä¸­â€œç°æŠ“â€ä½ è®¾ç½®çš„å€¼
    // é”®åå¿…é¡»ä¸ setTimezone å‡½æ•°é‡Œçš„ 'user_timezone' ç»å¯¹å¯¹é½
    const savedTz = localStorage.getItem('user_timezone');
    
    // é”å®šå½“å‰è¦ç”¨çš„æ—¶åŒºï¼šæœ‰è®¾ç½®ç”¨è®¾ç½®ï¼Œæ²¡è®¾ç½®ç”¨ç³»ç»Ÿæœ¬åœ°
    const zoneToUse = (savedTz && savedTz !== 'undefined') ? savedTz : Intl.DateTimeFormat().resolvedOptions().timeZone;

    const options = { 
        timeZone: zoneToUse, 
        hour12: false, 
        year: 'numeric', month: 'numeric', day: 'numeric', 
        hour: 'numeric', minute: 'numeric', second: 'numeric' 
    };
    
    try {
        const formatter = new Intl.DateTimeFormat('en-US', options);
        const parts = formatter.formatToParts(now);
        const getPart = (type) => parts.find(p => p.type === type).value;
        
        let hour = parseInt(getPart('hour'));
        if (hour === 24) hour = 0; // ç‰©ç†ä¿®æ­£ 24H è¿›åˆ¶æº¢å‡º

        return {
            year: parseInt(getPart('year')),
            month: parseInt(getPart('month')),
            day: parseInt(getPart('day')),
            hour: hour,
            aiString: `${getPart('hour').toString().padStart(2, '0')}:${getPart('minute').toString().padStart(2, '0')}`,
            fullString: formatter.format(now),
            activeZone: zoneToUse // ğŸš¨ ç»Ÿä¸€å˜é‡åï¼Œä¼ å‡ºå½“å‰æ—¶åŒº
        };
    } catch (e) {
        console.error("æ—¶åŒºå¼•æ“åç¼©:", e);
        return { hour: now.getHours(), aiString: "00:00", fullString: "Error", activeZone: "SystemFallback" };
    }
}
/**
 * ğŸ”— è‡ªåŠ¨è‰¾ç‰¹å‡½æ•°è¡¥å…¨ (æ”¯æŒä¼ å‚)
 */
window.mentionTheirsChar = function(name) {
    const input = document.getElementById('theirs-reply-input');
    if (!input) return;
    
    const charName = name || document.getElementById('theirs-char-name').textContent;
    input.value = `@${charName} `;
    input.focus();
    
    if (navigator.vibrate) navigator.vibrate(10);
};
/**
 * 2. å…¨å±å¤§å›¾æ§åˆ¶é€»è¾‘
 */
window.viewFullScreenImg = function(src) {
    const browser = document.getElementById('photo-fullscreen-browser');
    const targetImg = document.getElementById('fullscreen-img-target');
    if (!browser || !targetImg) return;

    targetImg.src = src;
    browser.style.display = 'flex';
    
    // å¼ºåˆ¶é‡ç»˜è§¦å‘åŠ¨ç”»
    void browser.offsetWidth;
    browser.classList.add('active');
    
    // ç‰©ç†ç¼©æ”¾æ•ˆæœ
    targetImg.style.transform = "scale(0.8)";
    setTimeout(() => {
        targetImg.style.transform = "scale(1)";
    }, 10);
};

window.closeFullscreenPhoto = function() {
    const browser = document.getElementById('photo-fullscreen-browser');
    if (browser) {
        browser.classList.remove('active');
        setTimeout(() => {
            browser.style.display = 'none';
        }, 300);
    }
};
// ğŸŒ è¯­éŸ³æ¡å†…éƒ¨ï¼šç‚¹å‡»å±•å¼€ç¿»è¯‘
window.toggleVoiceTrans = function(btn, e) {
    // ğŸš¨ é˜»æ­¢å†’æ³¡ï¼šé˜²æ­¢è§¦å‘æ°”æ³¡çš„æ’­æ”¾æˆ–èœå•äº‹ä»¶
    if (e) e.stopPropagation();

    // æ‰¾åˆ°çˆ¶å®¹å™¨
    const contentBox = btn.closest('.voice-content-box');
    if (contentBox) {
        // æ·»åŠ æ˜¾ç¤ºç¿»è¯‘çš„ç±»å
        contentBox.classList.add('show-trans');
        
        // å¢åŠ ä¸€ç‚¹éœ‡åŠ¨åé¦ˆ (iOS è´¨æ„Ÿ)
        if (navigator.vibrate) navigator.vibrate(10);
    }
};
window.handleVoiceBubbleClick = function(bubbleEl, text, e) {
    if (e) e.stopPropagation();

    // 1. å¤šé€‰æ¨¡å¼æ‹¦æˆª
    const row = bubbleEl.closest('.msg-row');
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected');
        if (typeof refreshMultiSelectCount === 'function') refreshMultiSelectCount();
        return;
    }

    const clickedTextArea = e.target.closest('.voice-content-box');
    if (e.target.closest('.voice-trans-btn')) return;

    // === åˆ†æ”¯ Aï¼šç‚¹å‡»æ–‡å­—åŒºåŸŸ (å¼¹èœå•) ===
    if (clickedTextArea) {
        if (bubbleEl.classList.contains('voice-expanded')) {
            showBubbleMenu(bubbleEl, e);
        }
        return;
    }

    // === åˆ†æ”¯ Bï¼šç‚¹å‡»è¯­éŸ³æ¡ (å±•å¼€/æŠ˜å ) ===
    if (bubbleEl.classList.contains('voice-expanded')) {
        // æ”¶èµ·
        bubbleEl.classList.remove('voice-expanded');
    } else {
        // å±•å¼€
        bubbleEl.classList.add('voice-expanded');
        bubbleEl.classList.add('is-read');

        // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦å¼€å¯äº† TTS ğŸš¨
        const isUser = row.classList.contains('user');
        
        // è¯»å–å½“å‰è§’è‰²çš„é…ç½®
        const contact = window.currentChattingWith;
        const configKey = contact ? 'voice_config_' + contact.id : 'voice_config_global_default';
        const config = JSON.parse(localStorage.getItem(configKey)) || {};
        
        // é»˜è®¤ä¸º true (å¼€å¯)ï¼Œåªæœ‰æ˜ç¡®è®¾ç½®ä¸º false æ‰å…³é—­
        const isTTSEnabled = (config.enableTTS !== false);

        if (!isUser) {
            if (isTTSEnabled) {
                console.log("ğŸ”Š è¯­éŸ³åˆæˆå·²å¼€å¯ï¼Œæ­£åœ¨è¯·æ±‚ MiniMax...");
                if (window.playVoiceMessage) {
                    window.playVoiceMessage(text, bubbleEl);
                }
            } else {
                console.log("ğŸ”• è¯­éŸ³åˆæˆå·²å…³é—­ (çœé’±æ¨¡å¼)ï¼Œä»…å±•å¼€æ–‡å­—ã€‚");
                // è¿™é‡Œä»€ä¹ˆéƒ½ä¸åšï¼Œæ–‡å­—å·²ç»é€šè¿‡ CSS å±•å¼€äº†ï¼Œä¹Ÿä¸ä¼šæ‰£è´¹
            }
        }
    }
};
window.sendSimulatedVoice = async function() {
    const inputEl = document.getElementById('voice-text-in');
    const btnEl = document.querySelector('#modal-voice-input .ios-btn.primary');
    const text = inputEl.value.trim();

    if (!text) return showToast("è¯·è¾“å…¥å†…å®¹");
    if (!window.currentChattingWith) return;

    const charId = window.currentChattingWith.id; // é”å®šå½“å‰è§’è‰² ID

    // 1. UI å˜èº«
    const originalBtnText = btnEl.innerHTML;
    btnEl.innerHTML = `<span style="animation:pulse 1s infinite">AI æ­£åœ¨è½¬ç ...</span>`;
    btnEl.style.pointerEvents = 'none'; 

    // 2. ä¼°ç®—æ—¶é•¿
    let durationSec = Math.ceil(text.length / 2);
    if (durationSec < 2) durationSec = 2;
    if (durationSec > 60) durationSec = 60;

    // 3. ç¿»è¯‘é€»è¾‘å¤„ç†
    let finalText = text;
    let cleanTextForAI = text; // ğŸš¨ ä¸“é—¨ç»™ AI çœ‹çš„çº¯å‡€æ–‡æœ¬

    if (!text.includes('[TRANS]')) {
        try {
            const trans = await autoTranslateUserText(text);
            if (trans && trans !== text) {
                finalText = `${text} [TRANS] ${trans}`;
            }
        } catch(e) {
            console.error("ç¿»è¯‘æœåŠ¡è¶…æ—¶");
        }
    }

    // 4. æ„é€ æ¶ˆæ¯å¹¶å­˜å…¥æ•°æ®åº“
    const msgObj = {
        role: "user",
        text: finalText, 
        type: "voice", // ğŸš¨ ç±»å‹é”å®šä¸ºè¯­éŸ³
        duration: durationSec + "\"",
        timestamp: Date.now(),
        isRead: true, 
        recalled: false
    };

    await saveChatMessage(charId, msgObj);
    renderMessages(); // æ¸²æŸ“ç”¨æˆ·å‘é€çš„æ¶ˆæ¯
    
    // 5. ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨å¼ºåˆ¶å”¤é†’ AI å“åº”åè®®
    // ä¹‹å‰ä½ å°‘å†™äº†è¿™ä¸€æ­¥ï¼Œæ‰€ä»¥ AI æ‰æ²¡ååº”ï¼
    if (typeof getAIResponse === 'function') {
        console.log("ğŸ“¡ ç‰©ç†ä¿¡å·å·²å‘å‡ºï¼Œæ­£åœ¨å”¤é†’ AI æ€è€ƒ...");
        // æˆ‘ä»¬ä¼  cleanTextForAIï¼Œè®© AI çœ‹åˆ°æœ€å¹²å‡€çš„æ–‡å­—ï¼Œä¸è¢« [TRANS] å¹²æ‰°
        getAIResponse(charId, cleanTextForAI); 
    }

    // 6. æ¢å¤ UI çŠ¶æ€
    document.getElementById('modal-voice-input').style.display = 'none';
    inputEl.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
    btnEl.innerHTML = originalBtnText;
    btnEl.style.pointerEvents = 'auto';

    console.log("âœ… è¯­éŸ³æ¶ˆæ¯å·²ç‰©ç†åŒæ­¥ï¼ŒAI å“åº”å·²è§¦å‘");
};
// 1. æ‰“å¼€è¯­ç§é€‰æ‹©å™¨ (å¤ç”¨ä½ çš„ Noir Picker)
window.openVoiceLangPicker = function() {
    // ğŸŒ å…¨çƒè¯­ç§è±ªååˆ—è¡¨
    const opts = [
        // --- æ ¸å¿ƒå¸¸ç”¨ ---
        { l: "è‡ªåŠ¨ (Auto Detect)", v: "auto" },
        { l: "ä¸­æ–‡ (Mandarin)", v: "cn" },
        { l: "è‹±è¯­ (English)", v: "en" },
        { l: "æ—¥è¯­ (Japanese)", v: "jp" },
        { l: "éŸ©è¯­ (Korean)", v: "kr" },
        { l: "ç²¤è¯­ (Cantonese)", v: "cantonese" }, // ğŸ‘ˆ å¾ˆå¤šäººéœ€è¦çš„

        // --- æ¬§æ´²è¯­ç³» ---
        { l: "æ³•è¯­ (French)", v: "fr" },
        { l: "å¾·è¯­ (German)", v: "de" },
        { l: "è¥¿ç­ç‰™è¯­ (Spanish)", v: "es" },
        { l: "ä¿„è¯­ (Russian)", v: "ru" },
        { l: "æ„å¤§åˆ©è¯­ (Italian)", v: "it" },
        { l: "è‘¡è„ç‰™è¯­ (Portuguese)", v: "pt" },

        // --- äºšæ´²å…¶ä»– ---
        { l: "æ³°è¯­ (Thai)", v: "th" },
        { l: "è¶Šå—è¯­ (Vietnamese)", v: "vi" },
        { l: "å°å°¼è¯­ (Indonesian)", v: "id" },
        
        // --- å…¶ä»– ---
        { l: "åœŸè€³å…¶è¯­ (Turkish)", v: "tr" },
        { l: "é˜¿æ‹‰ä¼¯è¯­ (Arabic)", v: "ar" }
    ];

    window.renderNoirPicker("SELECT NATIVE LANGUAGE", opts, function(v, l) {
        // æ›´æ–° UI æ˜¾ç¤º
        const displayEl = document.getElementById('calib-lang-display');
        if (displayEl) {
            displayEl.textContent = l;
            displayEl.dataset.val = v; // å­˜å…¥ data å±æ€§ï¼Œä¿å­˜æ—¶è¯»å–è¿™ä¸ª
        }
    });
};
// --- ğŸ”§ è¾…åŠ©å·¥å…·ï¼šåå…­è¿›åˆ¶è½¬äºŒè¿›åˆ¶ ---
function hexToBytes(hex) {
    if (!hex) return new Uint8Array(0);
    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„ 0x å‰ç¼€
    if (hex.startsWith('0x')) hex = hex.slice(2);
    
    let bytes = [];
    for (let c = 0; c < hex.length; c += 2) {
        bytes.push(parseInt(hex.substr(c, 2), 16));
    }
    return new Uint8Array(bytes);
}
// ğŸ’¾ ä¿å­˜é…ç½®ï¼šæŠŠ TTS å¼€å…³çš„çŠ¶æ€å­˜è¿›å»
window.saveVoiceCalibrate = function() {
    console.log("System: æ­£åœ¨ä¿å­˜è¯­éŸ³é…ç½®...");

    var idIn = document.getElementById('calib-voice-id-in');
    var dualTog = document.getElementById('calib-dual-toggle');
    var langDisp = document.getElementById('calib-lang-display');
    
    // ğŸš¨ æ–°å¢ï¼šè·å– TTS æ€»å¼€å…³
    var ttsTog = document.getElementById('calib-tts-toggle');

    if (!idIn) { alert("âŒ é¡µé¢å…ƒç´ åŠ è½½å¼‚å¸¸"); return; }

    var config = {
        voiceId: idIn.value.trim(),
        isDual: dualTog ? dualTog.checked : true,
        // ğŸš¨ ä¿å­˜ TTS çŠ¶æ€ (å¦‚æœå¼€å…³ä¸å­˜åœ¨ï¼Œé»˜è®¤å¼€å¯)
        enableTTS: ttsTog ? ttsTog.checked : true, 
        lang: (langDisp && langDisp.dataset.val) ? langDisp.dataset.val : "auto"
    };

    var contact = window.currentChattingWith;
    var saveKey = contact ? 'voice_config_' + contact.id : 'voice_config_global_default';

    localStorage.setItem(saveKey, JSON.stringify(config));

    if (window.triggerSuccessHud) window.triggerSuccessHud("è®¾ç½®å·²ä¿å­˜");
    else alert("âœ… è®¾ç½®å·²ä¿å­˜");

    closeSubPage('subpage-voice-calibrate');
};
// ğŸ”„ åŠ è½½é…ç½®ï¼šå›æ˜¾å¼€å…³çŠ¶æ€
window.loadVoiceCalibrateUI = function() {
    console.log("System: æ­£åœ¨è½½å…¥æ ¡å‡†é¢æ¿...");

    var contact = window.currentChattingWith;
    var nameEl = document.getElementById('calib-target-name');
    
    var loadKey = contact ? 'voice_config_' + contact.id : 'voice_config_global_default';
    if(nameEl) nameEl.textContent = contact ? contact.name : "å…¨å±€é»˜è®¤";

    var savedLocal = localStorage.getItem(loadKey);
    var config = savedLocal ? JSON.parse(savedLocal) : {
        voiceId: "",
        isDual: true,
        enableTTS: true, // é»˜è®¤å¼€å¯
        lang: "auto"
    };

    // 1. å›å¡« Voice ID
    var idIn = document.getElementById('calib-voice-id-in');
    if (idIn) idIn.value = config.voiceId || "";

    // 2. å›å¡«åŒè¯­å¼€å…³
    var dualTog = document.getElementById('calib-dual-toggle');
    if (dualTog) dualTog.checked = (config.isDual !== false);

    // 3. ğŸš¨ å›å¡« TTS æ€»å¼€å…³
    var ttsTog = document.getElementById('calib-tts-toggle');
    if (ttsTog) ttsTog.checked = (config.enableTTS !== false); // é»˜è®¤ true

    // 4. å›å¡«è¯­è¨€
    var langDisp = document.getElementById('calib-lang-display');
    if (langDisp) {
        const langMap = { 
            "auto": "è‡ªåŠ¨ (Auto Detect)", 
            "cn": "ä¸­æ–‡ (Mandarin)", 
            "en": "è‹±è¯­ (English)", 
            "jp": "æ—¥è¯­ (Japanese)", 
            "kr": "éŸ©è¯­ (Korean)", 
            "cantonese": "ç²¤è¯­ (Cantonese)",
            "fr": "æ³•è¯­ (French)", 
            "de": "å¾·è¯­ (German)",
            "es": "è¥¿ç­ç‰™è¯­ (Spanish)",
            "ru": "ä¿„è¯­ (Russian)",
            "it": "æ„å¤§åˆ©è¯­ (Italian)",
            "pt": "è‘¡è„ç‰™è¯­ (Portuguese)",
            "th": "æ³°è¯­ (Thai)",
            "vi": "è¶Šå—è¯­ (Vietnamese)",
            "id": "å°å°¼è¯­ (Indonesian)",
            "tr": "åœŸè€³å…¶è¯­ (Turkish)",
            "ar": "é˜¿æ‹‰ä¼¯è¯­ (Arabic)"
        };
        // å¦‚æœæ‰¾ä¸åˆ° keyï¼Œé»˜è®¤æ˜¾ç¤º Auto
        langDisp.textContent = langMap[config.lang] || "è‡ªåŠ¨ (Auto Detect)";
        langDisp.dataset.val = config.lang || "auto";
    }
};
/**
 * ğŸµ å¤„ç†è¯­éŸ³æ°”æ³¡ç‚¹å‡»ï¼šåŒæ­¥åŠ¨ç”»ä¸éŸ³é¢‘
 */
window.playVoiceMessage = async function(text, bubbleEl) {
    if (window.isSpeaking) return;

    // 1. è¿›å…¥æ’­æ”¾çŠ¶æ€ (æ ‡è®°åŠ¨ç”»)
    bubbleEl.classList.add('playing');
    bubbleEl.classList.add('is-read'); // æ ‡è®°ä¸ºå·²è¯»

    // 2. è°ƒç”¨ MiniMax å‘å£°å¼•æ“
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä½ ä¹‹å‰çš„ speakTextï¼Œè®©å®ƒæ¥å—ä¸€ä¸ªå›è°ƒæ¥æ¸…é™¤ç±»å
    try {
        await window.speakText(text, bubbleEl); 
    } catch (e) {
        bubbleEl.classList.remove('playing');
    }
};

/**
 * ğŸ›  ç»ˆæç‰©ç†è‡ªæ„ˆç‰ˆï¼šiOS é£æ ¼é€‰æ‹©å™¨
 * é€»è¾‘ï¼šè‡ªåŠ¨æ£€æµ‹ DOM -> åŠ¨æ€æ³¨å…¥ HTML/CSS -> å®æ—¶æ¸²æŸ“åˆ—è¡¨
 */
window.renderNoirPicker = function(title, options, callback) {
    // 1. ã€ç‰©ç†è‡ªæ£€ã€‘æ£€æŸ¥é¡µé¢ä¸Šæ˜¯å¦å·²ç»å­˜åœ¨è¿™ä¸ªå¼¹çª—ï¼Œæ²¡æœ‰å°±ç°åœºé€ ä¸€ä¸ª
    let mask = document.getElementById('custom-voice-picker');
    
    if (!mask) {
        console.log("System: æ­£åœ¨ç‰©ç†ç”Ÿæˆé€‰æ‹©å™¨ç»„ä»¶...");
        const pickerTemplate = `
            <div id="custom-voice-picker" class="ios-alert-mask" style="display:none; align-items:flex-end; z-index: 1000001;" onclick="this.style.display='none'">
                <div class="noir-picker-box" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 24px 24px 0 0; padding-bottom: 40px; animation: nSheetUp 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);">
                    <div class="n-picker-header" id="picker-title" style="padding: 16px; text-align: center; font-size: 11px; font-weight: 900; color: #8e8e93; letter-spacing: 2px; border-bottom: 0.5px solid rgba(0,0,0,0.05); text-transform: uppercase;">SELECT OPTION</div>
                    <div id="picker-options-list" class="n-picker-scroll" style="max-height: 45vh; overflow-y: auto;">
                        </div>
                    <div class="n-picker-cancel" onclick="document.getElementById('custom-voice-picker').style.display='none'" style="background: #fff; padding: 16px; border-radius: 14px; text-align: center; color: #FF3B30; font-weight: 700; font-size: 18px; margin: 8px 16px 25px; border: 1px solid #f2f2f7;">CANCEL</div>
                </div>
            </div>`;
        
        // å°†æ¨¡æ¿æ’å…¥ body åº•éƒ¨
        document.body.insertAdjacentHTML('beforeend', pickerTemplate);
        mask = document.getElementById('custom-voice-picker');
    }

    // 2. ã€æ•°æ®å¡«å……ã€‘
    const list = document.getElementById('picker-options-list');
    const titleEl = document.getElementById('picker-title');
    
    if (titleEl) titleEl.textContent = title;
    
    // ç”Ÿæˆé€‰é¡¹
    list.innerHTML = options.map(opt => `
        <div class="n-opt-item" onclick="window.confirmNoirPick('${opt.v}', '${opt.l}')" 
             style="padding: 18px; text-align: center; color: #007AFF; font-size: 18px; font-weight: 500; border-bottom: 0.5px solid rgba(0,0,0,0.05); cursor: pointer;">
            ${opt.l}
        </div>
    `).join('');
    
    // 3. ã€çŠ¶æ€æ¿€æ´»ã€‘
    window.noirPickerCallback = callback;
    mask.style.display = 'flex';
};

/**
 * ç¡®è®¤é€‰æ‹©å™¨å›è°ƒ
 */
window.confirmNoirPick = function(v, l) {
    if (window.noirPickerCallback) window.noirPickerCallback(v, l);
    const mask = document.getElementById('custom-voice-picker');
    if (mask) mask.style.display = 'none';
};

/**
 * ç¡®è®¤é€‰æ‹©å¹¶å…³é—­
 */
window.confirmNoirPick = function(v, l) {
    if (window.noirPickerCallback) window.noirPickerCallback(v, l);
    document.getElementById('custom-voice-picker').style.display = 'none';
};

// 1. å­˜å‚¨ä»æœåŠ¡å™¨â€œè·å–â€åˆ°çš„æ¨¡å‹
// åœ¨è„šæœ¬å¼€å¤´ä¿®æ”¹è¿™éƒ¨åˆ†
window.availableModels = [
    { name: "Speech Turbo (æé€ŸèŠå¤©)", id: "speech-01-turbo" },
    { name: "Speech 2.6 Turbo (æ¨è)", id: "speech-2.6-turbo" }
]; // ğŸ‘ˆ é¢„è®¾é»˜è®¤å€¼ï¼Œç¡®ä¿ä¸ç‚¹ Fetch ä¹Ÿèƒ½ç‚¹å¼€åˆ—è¡¨



/**
 * ğŸ“¡ è”ç½‘è·å–æ¨¡å‹åè®® (ç‰©ç†è‡ªæ„ˆç‰ˆ)
 * ç»•è¿‡å¤±æ•ˆçš„ query_voice_list æ¥å£ï¼Œç›´æ¥æ³¨å…¥ V2 æ ¸å¿ƒæ¨¡å‹ ID
 */
window.fetchAllMiniMaxModels = async function() {
    const key = document.getElementById('voice-key-in').value.trim();
    const btnText = document.getElementById('fetch-model-btn-text');
    
    if (!key) {
        alert("ğŸ”‘ è¯·å…ˆå¡«å†™ API Key");
        return;
    }

    btnText.textContent = "ESTABLISHING QUANTUM LINK...";
    btnText.style.color = "#007AFF";

    try {
        // ğŸš¨ æˆ˜æœ¯ç­–ç•¥ï¼šæˆ‘ä»¬æ”¹ç”¨æœ€åŸºç¡€çš„ T2A V2 æ¥å£åšä¸€æ¬¡â€œç©ºæ–‡æœ¬æµ‹è¯•â€
        // è¿™æ ·æ—¢éªŒè¯äº† Key çš„æ­£ç¡®æ€§ï¼Œåˆé¿å¼€äº†ä¸å­˜åœ¨çš„ 404 åˆ—è¡¨æ¥å£
        const proxy = "https://cors-anywhere.herokuapp.com/";
        const testUrl = "https://api.minimaxi.chat/v1/t2a_v2"; 
        const url = proxy + testUrl;

        // å‘é€ä¸€ä¸ªæç®€çš„æ ¡éªŒè¯·æ±‚
        const response = await fetch(url, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${key}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ 
                "model": "speech-01-turbo",
                "text": " ", // ä»…å‘é€ç©ºæ ¼è¿›è¡Œé“¾è·¯æ ¡éªŒ
                "voice_setting": { "voice_id": "male-qn-qingse" }
            })
        });

        // ğŸ›¡ï¸ åªè¦ä¸æ˜¯ 401ï¼ˆæœªæˆæƒï¼‰ï¼Œå°±è¯´æ˜è¿æ¥é€šè·¯æ˜¯å¼€ç€çš„
        if (response.status === 401) {
            throw new Error("API Key éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¡«å†™æ˜¯å¦æ­£ç¡®");
        }

        // âœ… ç‰©ç†æ³¨å…¥ï¼šæ—¢ç„¶é“¾è·¯é€šäº†ï¼Œç›´æ¥è§£é”å®˜æ–¹ Speech æ¨¡å‹å®¶æ—
        // è¿™äº› ID æ˜¯ MiniMax V2 çš„æ ‡å‡†åè®®å€¼ï¼Œä¸éœ€è¦åŠ¨æ€æ‹‰å–
        window.availableModels = [
            { name: "Speech Turbo (æè‡´æµç•…)", id: "speech-01-turbo" },
            { name: "Speech HD (ç»†zhigè…»æƒ…æ„Ÿ)", id: "speech-01-hd" },
            { name: "Speech 2.6 Turbo (å¤šè¯­è¨€ä¼˜åŒ–)", id: "speech-2.6-turbo" },
            { name: "Speech 2.6 HD (ç”µå½±è´¨æ„Ÿ)", id: "speech-2.6-hd" }
        ];
        
        btnText.textContent = "âœ… PROTOCOL SECURED";
        btnText.style.color = "#34C759";
        
        // é»˜è®¤æ¿€æ´»æœ€æ–°æ¨¡å‹
        window.currentVoiceModel = "speech-2.6-turbo";
        const display = document.getElementById('voice-model-display');
        if (display) display.textContent = window.currentVoiceModel;
        
        showToast("é“¾è·¯å·²å»ºç«‹ï¼šSpeech åè®®å·²æ¿€æ´»");

    } catch (e) {
        console.error("Link Error:", e);
        // ğŸš‘ å…œåº•é€»è¾‘ï¼šå³ä¾¿æµ‹è¯•è¯·æ±‚å¤±è´¥ï¼Œåªè¦ç”¨æˆ·åšæŒï¼Œä¹Ÿå…è®¸åŠ è½½æœ¬åœ°æ¨¡å‹åˆ—è¡¨
        window.availableModels = [
            { name: "Speech Turbo (Standard)", id: "speech-01-turbo" },
            { name: "Speech 2.6 Turbo (Standard)", id: "speech-2.6-turbo" }
        ];
        btnText.textContent = "âš ï¸ MANUAL OVERRIDE";
        btnText.style.color = "#FF9500";
        alert("ä¿¡å·å¹²æ‰°ï¼Œå·²åŠ è½½æœ¬åœ°æ ‡å‡†æ¨¡å‹åè®®ä¾›é€‰æ‹©ã€‚");
    }
};

window.openVoiceModelPicker = function() {
    // å¦‚æœè¿˜æ²¡ç‚¹å‡»è·å–æŒ‰é’®ï¼Œwindow.availableModels ä¼šæ˜¯ç©ºçš„
    if (!window.availableModels || window.availableModels.length === 0) {
        alert("è¯·å…ˆç‚¹å‡»ä¸‹æ–¹çš„ FETCH MODELS æŒ‰é’®è·å–åè®®");
        return;
    }

    const opts = window.availableModels.map(m => ({ l: m.name, v: m.id }));
    
    // è°ƒç”¨ä¸Šé¢è¡¥å…¨çš„å¼¹çª—å‡½æ•°
    window.renderNoirPicker("SELECT SPEECH MODEL", opts, (v, l) => {
        window.currentVoiceModel = v; 
        document.getElementById('voice-model-display').textContent = v;
    });
};
// ==========================================
// ğŸ™ï¸ MiniMax V2 è¯­éŸ³å¼•æ“ï¼šæ¨¡å‹é©±åŠ¨ç‰ˆ (ç‰©ç†ä¿®å¤)
// ==========================================

// 1. å®šä¹‰å®˜æ–¹æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨
window.MINIMAX_MODELS = [
    { name: "Turbo (æé€ŸèŠå¤©)", id: "speech-01-turbo" },
    { name: "HD (é«˜ç”»è´¨æƒ…æ„Ÿ)", id: "speech-01-hd" },
    { name: "V2.6 Turbo (æœ€æ–°å¹³è¡¡)", id: "speech-2.6-turbo" },
    { name: "V2.6 HD (ç”µå½±è´¨æ„Ÿ)", id: "speech-2.6-hd" }
];

/**
 * ğŸ›  ä¿®å¤ 1: ç‰©ç†è¡¥å…¨ updateVDisplay å‡½æ•°
 * ä½œç”¨ï¼šè®©æ»‘åŠ¨æ¡æ•°å€¼å®æ—¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
 */
window.updateVDisplay = function(type, val) {
    const el = document.getElementById(`v-${type}-val`);
    if (el) {
        el.textContent = type === 'speed' ? parseFloat(val).toFixed(1) + 'x' : val;
    }
};

// é…åˆ Picker çš„ç¡®è®¤å‡½æ•°
window.confirmNoirPick = function(v, l) {
    if (window.noirPickerCallback) window.noirPickerCallback(v, l);
    document.getElementById('custom-voice-picker').style.display = 'none';
};

/**
 * ğŸ’¾ åŠŸèƒ½ï¼šä¿å­˜è¯­éŸ³å¼•æ“é…ç½®
 */
/**
 * ğŸ’¾ å¼ºåŠ›è‡ªæ„ˆä¿å­˜åè®®
 * è§£å†³ ReferenceError: elSpeed is not defined
 */
window.saveVoiceSettings = function() {
    console.log("System: æ­£åœ¨æ‰§è¡Œç‰©ç†å­˜ç›˜åè®®...");

    // 1. è·å–è¾“å…¥æ¡†åŸå§‹å€¼
    const keyVal = document.getElementById('voice-key-in').value.trim();
    const groupVal = document.getElementById('voice-group-in').value.trim();

    // 2. åŸºç¡€æ ¡éªŒ
    if (!keyVal || !groupVal) {
        alert("âš ï¸ æˆæƒåè®®ä¸å®Œæ•´ï¼šMiniMax å¿…é¡»å¡«å†™ API Key å’Œ Group ID");
        return;
    }

    // 3. æ„å»ºé…ç½®å¯¹è±¡
    const config = {
        key: keyVal,
        groupId: groupVal,
        model: window.currentVoiceModel || "speech-01-turbo",
    };

    // 4. ç‰©ç†å†™å…¥ LocalStorage (å­˜ JSON)
    localStorage.setItem('ios_voice_config', JSON.stringify(config));
    
    // 5. ã€å…³é”®ä¿®å¤ã€‘å•ç‹¬å­˜ä¸€ä»½ï¼Œé˜²æ­¢å…¶ä»–å‡½æ•°è¯»ä¸åˆ°
    localStorage.setItem('minimax_key', keyVal);
    localStorage.setItem('minimax_group_id', groupVal);

    console.log("âœ… é…ç½®å·²å†™å…¥å†…æ ¸:", config);

    if (window.triggerSuccessHud) {
        window.triggerSuccessHud("è¯­éŸ³åè®®å·²é”å®š");
    } else {
        showToast("Settings Saved");
    }

    closeSubPage('subpage-voice-settings');
};

/**
 * ğŸ“¥ åŠŸèƒ½ï¼šåˆå§‹åŒ–åŠ è½½ UI
 */
window.loadVoiceSettingsUI = function() {
    // è¯»å–é…ç½®
    const saved = localStorage.getItem('ios_voice_config');
    const config = saved ? JSON.parse(saved) : {
        model: "speech-01-turbo", 
        key: "", 
        groupId: ""
    };
    
    // 1. å›å¡« Key
    const keyIn = document.getElementById('voice-key-in');
    if (keyIn) keyIn.value = config.key || "";

    // 2. å›å¡« Group ID
    const groupIn = document.getElementById('voice-group-in');
    if (groupIn) groupIn.value = config.groupId || "";

    // 3. å›å¡«æ¨¡å‹æ˜¾ç¤º
    const modelDisp = document.getElementById('voice-model-display');
    if (modelDisp) modelDisp.textContent = config.model;
    
    // 4. é”å®šå…¨å±€å˜é‡
    window.currentVoiceModel = config.model;
};

/**
 * ğŸ”Š ç»ˆæç‰©ç†å‘å£°å¼•æ“ (å¸¦èº«ä»½è‡ªæ£€ç‰ˆ)
 * ä¸“é—¨è§£å†³ [1004] æˆæƒå¤±è´¥é—®é¢˜
 */
window.speakText = async function(rawText, btnEl) {
    // 1. è¯»å–åŸºç¡€é…ç½®
    const savedConfig = JSON.parse(localStorage.getItem('ios_voice_config')) || {};
    const apiKey = savedConfig.key || localStorage.getItem('minimax_key') || "";
    const groupId = savedConfig.groupId || localStorage.getItem('minimax_group_id') || "";

    if (!apiKey || !groupId) {
        alert("ğŸš¨ è¯­éŸ³é…ç½®ç¼ºå¤±ï¼è¯·å»è®¾ç½®é¡µå¡«å†™ Key å’Œ Group ID");
        return;
    }

    // 2. è·å–å½“å‰è§’è‰²çš„ç‰¹å®šé…ç½®
    const contact = window.currentChattingWith;
    const calibConfig = contact ? (JSON.parse(localStorage.getItem('voice_config_' + contact.id)) || {}) : {};
    
    const targetVoiceId = calibConfig.voiceId || "male-qn-qingse"; 
    const targetModel = calibConfig.model || savedConfig.model || "speech-01-turbo";
    
    // ğŸ‘‡ è·å–â€œåŒè¯­å¼€å…³â€ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œé»˜è®¤ä¸º true (å¼€å¯)ã€‚
    // ğŸš¨ å®è´ï¼Œæ—¢ç„¶ä½ è¦â€œä¸èƒ½è¯»ç¿»è¯‘â€ï¼Œè¯·åŠ¡å¿…å»è®¾ç½®é¡µæŠŠè¿™ä¸ªå¼€å…³ã€å…³æ‰ã€‘ï¼
    // æˆ–è€…æˆ‘ä»¬ä»£ç é‡Œå¼ºåˆ¶ä¸€ä¸‹ï¼šå¦‚æœæ˜¯ç‰¹å®šè¯­è¨€ï¼Œå°±å¼ºåˆ¶ falseï¼Ÿ(è¿™é‡Œå…ˆå°Šé‡å¼€å…³)
    const isReadDual = (calibConfig.isDual !== false); 

    // 3. UI çŠ¶æ€
    const span = btnEl.querySelector('span');
    const originalText = span ? span.textContent : "";
    if(span) span.textContent = "SYNTH...";
    btnEl.classList.add('playing');

    // ============================================================
    // âœ‚ï¸ æ ¸å¿ƒæ–‡æœ¬å¤„ç†é€»è¾‘ (å¼ºåŠ›å»å°¾ç‰ˆ)
    // ============================================================
    let textToSpeak = rawText;

    // 1. å…ˆæŠŠå¯èƒ½å­˜åœ¨çš„ [QUOTE] å¼•ç”¨éƒ¨åˆ†åˆ‡æ‰ (å¼•ç”¨é€šå¸¸ä¸è¯»)
    textToSpeak = textToSpeak.replace(/\[QUOTE:[\s\S]*?\]/, "").trim();

    // 2. å¤„ç† [TRANS] æ ‡ç­¾
    if (textToSpeak.includes('[TRANS]')) {
        const parts = textToSpeak.split('[TRANS]');
        const original = parts[0].trim(); // åŸæ–‡ (æ³°è¯­)
        const trans = parts[1].trim();    // è¯‘æ–‡ (ä¸­æ–‡)

        if (!isReadDual) {
            // ğŸš« å¼€å…³å…³é—­ï¼šç‰©ç†åˆ‡é™¤ç¿»è¯‘ï¼åªç•™åŸæ–‡ï¼
            // æ¯”å¦‚ "à¸‚à¸­à¹ƒà¸«à¹‰à¸à¸£à¸°à¸„à¸¸à¹‰à¸¡à¸„à¸£à¸­à¸‡ [TRANS] ä½›ç¥–ä¿ä½‘" -> "à¸‚à¸­à¹ƒà¸«à¹‰à¸à¸£à¸°à¸„à¸¸à¹‰à¸¡à¸„à¸£à¸­à¸‡"
            textToSpeak = original;
            console.log("âœ‚ï¸ [TTS] åŒè¯­å¼€å…³å·²å…³é—­ï¼Œä»…æœ—è¯»åŸæ–‡ã€‚");
        } else {
            // âœ… å¼€å…³å¼€å¯ï¼šåŸæ–‡ + åœé¡¿ + è¯‘æ–‡
            // æ³¨æ„ï¼šæ³°è¯­æ¨¡å‹è¯»ä¸­æ–‡å¯èƒ½ä¼šä¹±ç ï¼Œæ‰€ä»¥å»ºè®®ä½ è¿™ç§æƒ…å†µä¸‹è¿˜æ˜¯å…³æ‰å¼€å…³æ¯”è¾ƒå¥½
            textToSpeak = original + " ... " + trans;
            console.log("ğŸ”— [TTS] åŒè¯­å¼€å…³å·²å¼€å¯ï¼Œå…¨æ–‡æœ—è¯»ã€‚");
        }
    }
    
    // 3. æ¸…ç†æ®‹ç•™ç¬¦å·
    textToSpeak = textToSpeak.replace(/[\[\]]/g, ""); 

    console.log(`ğŸš€ [TTS Payload] æœ€ç»ˆå‘é€æ–‡æœ¬: "${textToSpeak}"`);

    // ============================================================

    const proxy = "https://cors-anywhere.herokuapp.com/"; 
    const url = proxy + `https://api.minimax.chat/v1/t2a_v2?GroupId=${groupId}`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
                "model": targetModel,
                "text": textToSpeak, // ğŸ‘ˆ å‘é€å¤„ç†åçš„æ–‡æœ¬
                "stream": false, 
                "voice_setting": {
                    "voice_id": targetVoiceId,
                    "speed": 1.0,
                    "vol": 1.0,
                    "pitch": 0
                },
                "audio_setting": {
                    "sample_rate": 32000,
                    "bitrate": 128000,
                    "format": "mp3",
                    "channel": 1
                }
            })
        });

        // ğŸš¨ å¢åŠ ç‰©ç†è‡ªæ£€
        if (response.status === 403) {
            showToast("âš ï¸ è¯·å…ˆç‚¹å‡»æˆæƒè¯­éŸ³é“¾è·¯ï¼šhttps://cors-anywhere.herokuapp.com/corsdemo");
            window.open("https://cors-anywhere.herokuapp.com/corsdemo", "_blank");
            btnEl.classList.remove('playing');
            return;
        }

        const data = await response.json();
        
        if (data.base_resp && data.base_resp.status_code !== 0) {
            throw new Error(`API Error: ${data.base_resp.status_msg}`);
        }

        if (data.data && data.data.audio) {
            if(span) span.textContent = "SPEAKING";
            
            let audioSrc = data.data.audio;
            if (!audioSrc.startsWith('data:audio')) {
                 // å°è¯• hex è½¬ blob (ä¹‹å‰ç»™ä½ çš„è¾…åŠ©å‡½æ•°)
                 try {
                     if (typeof hexToBytes === 'function') {
                         const buffer = hexToBytes(audioSrc);
                         const blob = new Blob([buffer], { type: 'audio/mpeg' });
                         audioSrc = URL.createObjectURL(blob);
                     } else {
                         audioSrc = "data:audio/mp3;base64," + audioSrc;
                     }
                 } catch(e) {
                     audioSrc = "data:audio/mp3;base64," + audioSrc;
                 }
            }

            const audio = new Audio(audioSrc);
            audio.play();

            audio.onended = () => {
                window.isSpeaking = false;
                if(span) span.textContent = originalText;
                btnEl.classList.remove('playing');
            };
            audio.onerror = () => {
                btnEl.classList.remove('playing');
                if(span) span.textContent = "ERR";
            };
        }

    } catch (e) {
        console.error("TTS Fail:", e);
        alert("è¯­éŸ³å¤±è´¥: " + e.message);
        btnEl.classList.remove('playing');
        if(span) span.textContent = "ERR";
    }
};
// --- ğŸ˜Š Emoji å¼¹çª— Function é€»è¾‘ ---

window.handleEmojiButtonClick = function(e) {
    if (e) e.stopPropagation();
    
    // 1. å°è¯•æ¸²æŸ“ï¼ˆå³ä½¿æ•°æ®åº“ç©ºäº†ä¹Ÿä¸å½±å“æ‰“å¼€ï¼‰
    if (typeof window.renderEmojiGrid === 'function') window.renderEmojiGrid();
    
    // 2. ç‰©ç†æ˜¾ç¤º
    const mask = document.getElementById('emoji-modal-mask');
    if (mask) {
        mask.style.display = 'flex';
        // ç¨å¾®å»¶è¿Ÿè®© CSS æ•è·åˆ° display å˜åŒ–ä»è€Œè§¦å‘ transition åŠ¨ç”»
        setTimeout(() => mask.classList.add('active'), 20);
    }
};

window.closeEmojiModal = function(e) {
    // å…è®¸é€šè¿‡ç‚¹å‡»èƒŒæ™¯æˆ–å–æ¶ˆæŒ‰é’®å…³é—­
    if (e && e.target.id !== 'emoji-modal-mask' && !e.target.closest('.emoji-cancel')) return;

    const mask = document.getElementById('emoji-modal-mask');
    if (mask) {
        mask.classList.remove('active');
        setTimeout(() => {
            mask.style.display = 'none';
        }, 400); // ç­‰å¾…æ»‘ä¸‹åŠ¨ç”»ç»“æŸ
    }
};

window.renderEmojiGrid = async function() {
    const list = document.getElementById('emoji-grid-list');
    if (!list) return;

    try {
        const db = await openDB();
        const tx = db.transaction("emoji_library", "readonly");
        const emojis = await new Promise(res => {
            tx.objectStore("emoji_library").getAll().onsuccess = e => res(e.target.result);
        });

        if (!emojis || emojis.length === 0) {
            list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#bbb; padding:40px 0; font-size:13px; font-family:serif; font-style:italic;">NO TRACES FOUND...</div>';
            return;
        }

        list.innerHTML = emojis.map(item => `
            <div class="emoji-grid-item" onclick="sendEmojiMessage('${item.tag}'); window.closeEmojiModal();">
                <img src="${item.data}" style="width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:12px; border:1px solid #000;">
                <div style="font-size:10px; color:#000; font-weight:800; margin-top:5px;">${item.tag.toUpperCase()}</div>
            </div>
        `).join('');
    } catch (err) {
        list.innerHTML = 'LOAD ERROR';
    }
};

var travelMap = null;
window.openTravelJournal = async function() {
    console.log("System: æ­£åœ¨æ‰§è¡Œè¡Œæ—…ç©ºé—´é‡æ„...");
    
    const savedRoute = await loadFromDB('current_travel_route');
    
    if (savedRoute && savedRoute.length > 0) {
        // å¦‚æœæœ‰å†å²è®°å½•ï¼Œç›´æ¥å±•ç¤º
        document.getElementById('travel-planner').style.display = 'none';
        document.getElementById('travel-canvas-area').style.display = 'block';
        window.currentTravelData = savedRoute;
        
        // ğŸš¨ æ ¸å¿ƒï¼šä»ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªç«™ç‚¹æå– code
        const fromNode = savedRoute[0];
        const toNode = savedRoute[savedRoute.length - 1];
        
        // è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œä¼ å…¥çœŸå®çš„ Codeï¼Œä¸å†æ˜¾ç¤º ???
        renderBoardingPass(
            fromNode.name, 
            toNode.name, 
            fromNode.code || "PEK", // å¢åŠ æ‰‹åŠ¨é»˜è®¤å€¼é˜²æ­¢ ???
            toNode.code || "BKK"
        );
        
        renderTravelMap(savedRoute);
    } else {
        // æ— è®°å½•åˆ™æ˜¾ç¤ºç­–åˆ’é¡µ
        document.getElementById('travel-planner').style.display = 'block';
        document.getElementById('travel-canvas-area').style.display = 'none';
    }

    openSubPage('subpage-travel-journal');
};
/**
 * ğŸ›ï¸ å®¿å‘½é¡µé¢å…³é—­åè®®
 */
window.closeDestinyPage = function() {
    console.log("System: æ­£åœ¨é—­åˆå› æœé“¾è·¯...");
    
    const overlay = document.getElementById('destiny-overlay');
    if (overlay) {
        // 1. åŠ¨ç”»æ·¡å‡º
        overlay.style.transition = "opacity 0.4s ease, transform 0.4s ease";
        overlay.style.opacity = "0";
        overlay.style.transform = "translateX(100%)"; // é¡ºæ»‘æ»‘å‡º
        
        // 2. å½»åº•éšè—
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.classList.remove('active');
        }, 400);
        
        console.log("âœ… é¡µé¢å·²é€»è¾‘éš”ç¦»");
    }
};

// ğŸš¨ è¿™ä¸€æ­¥æ˜¯åŒé‡ä¿é™©ï¼šå§”æ‰˜ç›‘å¬
// å“ªæ€• onclick å¤±æ•ˆï¼Œåªè¦ç‚¹åˆ°è¿™ä¸ªç±»åçš„å…ƒç´ ï¼Œä¹Ÿä¼šè§¦å‘å…³é—­
document.addEventListener('click', function(e) {
    if (e.target.closest('.ins-exit-btn')) {
        window.closeDestinyPage();
    }
});

// é¡ºæ‰‹æ£€æŸ¥ä¸€ä¸‹ HTML æŒ‰é’®ä¸Šçš„è°ƒç”¨æ˜¯å¦å†™å¯¹äº†ï¼š
// ç¡®ä¿æ˜¯ onclick="window.closeDestinyPage()" è€Œä¸æ˜¯ closeDestinyPage()
window.updateDestinySlider = function(el) {
    // 1. æ›´æ–°æ—è¾¹çš„æ•°å­—æ˜¾ç¤º
    const valDisplay = document.getElementById('destiny-word-val');
    if (valDisplay) valDisplay.innerText = el.value;

    // 2. ğŸš¨ æ ¸å¿ƒï¼šç‰©ç†è®¡ç®—ç™¾åˆ†æ¯”å¹¶ä¼ ç»™ CSS
    const min = el.min || 500;
    const max = el.max || 5000;
    const percent = ((el.value - min) / (max - min)) * 100;
    el.style.setProperty('--percent', percent + '%');
};

// ğŸš¨ é¢å¤–ï¼šç¡®ä¿å¼¹çª—æ‰“å¼€æ—¶ï¼Œè¿›åº¦æ¡é¢œè‰²å°±æ˜¯å¯¹çš„
const originalOpenDestinySettings = window.openDestinySettings;
window.openDestinySettings = function() {
    if (typeof originalOpenDestinySettings === 'function') originalOpenDestinySettings();
    
    // æ‰“å¼€åç«‹å³è§¦å‘ä¸€æ¬¡åˆ·æ–°
    const slider = document.getElementById('destiny-wordcount-in');
    if (slider) window.updateDestinySlider(slider);
};
window.deleteFateNode = function(id) {
    const el = document.getElementById(id);
    if(el) {
        // 1. åœ¨åŸä½æ’å…¥ä¸€ä¸ªæå…¶ç²¾ç¾çš„ç»­å†™é”šç‚¹
        const resumeBtn = `
            <div class="resume-node" style="text-align:center; margin:20px 0; animation: fadeIn 0.5s;">
                <div onclick="this.parentElement.remove(); window.sendDestinyCommand();" 
                     style="display:inline-block; border:1px dashed rgba(175, 82, 222, 0.4); color:#AF52DE; font-size:10px; padding:10px 25px; border-radius:30px; cursor:pointer; letter-spacing:2px; font-weight:800;">
                    âœ¦ RE-START FROM HERE / é‡æ–°è¡”æ¥å› æœ
                </div>
            </div>
        `;
        el.insertAdjacentHTML('afterend', resumeBtn);
        
        // 2. ç‰©ç†ç§»é™¤
        el.style.opacity = "0";
        setTimeout(() => el.remove(), 300);
    }
};
// æ‰¾åˆ° rewriteFateNode å‡½æ•°ï¼Œä¿®æ”¹æˆè¿™æ ·
window.rewriteFateNode = function(id) {
    const el = document.getElementById(id);
    if(el) {
        // 1. è·å–å½“å‰å¡ç‰‡çš„æŒ‡ä»¤ä½œä¸ºå½±å­
        const shadowInput = "ï¼ˆé‡å¡‘è¿™æ®µå› æœï¼‰";
        
        // 2. ç‰©ç†æ›¿æ¢ä¸ºåŠ¨ç”»
        el.style.transition = "all 0.5s";
        el.style.transform = "scale(0.95)";
        el.style.opacity = "0";
        
        setTimeout(() => {
            el.remove();
            // 3. é‡æ–°è°ƒç”¨ï¼Œå®ƒä¼šè‡ªåŠ¨èµ° sendDestinyCommand é‡Œçš„åŠ è½½åŠ¨ç”»æµç¨‹
            window.sendDestinyCommand(); 
        }, 400);
    }
};
    /**
 * ğŸ è¾…åŠ©ï¼šåˆ¤å®šç»ˆå±€é€»è¾‘
 */
window.checkEndingStatus = function(fate) {
    const val = parseInt(fate);
    if (val < 90) {
        showToast(`å› æœå°šæœªæ”¶æ•› (å½“å‰: ${val}%)ï¼Œè¯·ç»§ç»­ä»‹å…¥ã€‚`);
    } else {
        showIOSConfirm("ç»ˆå±€é™ä¸´", "è§‚æµ‹åˆ°å› æœçº¿å³å°†é—­åˆï¼Œæ˜¯å¦å¼•å¯¼æ•…äº‹èµ°å‘æœ€ç»ˆç« ï¼Ÿ", "é™ä¸´", () => {
            document.getElementById('destiny-input-field').value = "ï¼ˆå¼•å¯¼æ•…äº‹èµ°å‘å¤§ç»“å±€ï¼‰";
            window.sendDestinyCommand();
        });
    }
};

/**
 * ç‰©ç†æŒ‚è½½åˆ°å…¨å±€ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹å¯ç”¨
 */
window.openDestinySettings = openDestinySettings;
window.closeDestinySettings = closeDestinySettings;
window.saveDestinyProtocol = saveDestinyProtocol;
window.sendDestinyCommand = sendDestinyCommand;

    window.refreshDestinyProse = async function() {
    const contact = window.currentChattingWith;
    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].cachedDestinyProse = null; // æŠ¹é™¤ç¼“å­˜
        await saveToDB('char_list', charList);
        generateDestinyProse(charList[idx]); // é‡æ–°ç”Ÿæˆ
        showToast("æ­£åœ¨é‡å¡‘å› æœå™äº‹...");
    }
};
    // --- ğŸ›ï¸ ç‰©ç†ä¿®å¤ï¼šè§¦å‘å¤´åƒä¸Šä¼  ---
window.triggerAvatarUpload = function() {
    console.log("System: æ­£åœ¨å”¤èµ·æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ...");
    const input = document.getElementById('avatar-input');
    if (input) {
        input.click();
    } else {
        console.error("Error: æ‰¾ä¸åˆ° ID ä¸º avatar-input çš„ä¸Šä¼ ç»„ä»¶");
    }
};

// --- ğŸ›ï¸ ç‰©ç†ä¿®å¤ï¼šå¤„ç†é€‰å®šçš„å¤´åƒæ–‡ä»¶å¹¶æŒä¹…åŒ– ---
window.updateAvatar = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        showToast("æ­£åœ¨åŒæ­¥ç‰©ç†ç‰¹å¾..."); // è°ƒç”¨ä½ å·²æœ‰çš„æç¤ºå‡½æ•°

        reader.onload = async function(e) {
            const imageData = e.target.result;
            
            // 1. å®æ—¶é¢„è§ˆ
            document.getElementById('sync-avatar').src = imageData;
            const blurLayer = document.querySelector('.header-card-blur');
            if (blurLayer) blurLayer.style.backgroundImage = `url(${imageData})`;

            // 2. ğŸš¨ æ ¸å¿ƒåŒæ­¥ï¼šä¿å­˜åˆ°è§’è‰²ä¹¦æ•°æ®åº“
            const contact = window.currentChattingWith;
            if (contact && contact.id) {
                let charList = await loadFromDB('char_list') || [];
                const idx = charList.findIndex(c => c.id === contact.id);
                if (idx !== -1) {
                    charList[idx].avatar = imageData;
                    await saveToDB('char_list', charList);
                    
                    // åŒæ—¶åˆ·æ–°èŠå¤©å®¤å¤´åƒ
                    const roomAvatar = document.getElementById('room-contact-avatar');
                    if (roomAvatar) roomAvatar.src = imageData;
                    
                    if (window.triggerSuccessHud) triggerSuccessHud("å…¨åŸŸæ¡£æ¡ˆå·²æ›´æ–°");
                }
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
};
// å¯åŠ¨ç‚¹ç«
document.addEventListener('DOMContentLoaded', bootThemeEngine);
    // ğŸš¨ ç»ˆæç‰©ç†é”å®šï¼šå…¨è¯­ç§è±ªåç‰ˆæ•°æ®åº“ï¼ˆåŒ…å«ç²¤è¯­åŠå…¨çƒä¸»æµå¤–è¯­ï¼‰
const GLOBAL_LANG_DB = [
    // --- æ ¸å¿ƒå¸¸ç”¨ (Core & Regional) ---
    {n: "Cantonese", l: "ç²¤è¯­ (Cantonese)", cat: "common"},
    {n: "English", l: "è‹±è¯­ (English)", cat: "common"},
    {n: "Japanese", l: "æ—¥æœ¬èª (Japanese)", cat: "common"},
    {n: "Korean", l: "í•œêµ­ì–´ (Korean)", cat: "common"},
    {n: "Thai", l: "à¹„à¸—à¸¢ (Thai)", cat: "common"},
    {n: "French", l: "FranÃ§ais (French)", cat: "common"},

    // --- æ¬§æ´²è¯­ç³» (European) ---
    {n: "German", l: "Deutsch (German)", cat: "all"},
    {n: "Italian", l: "Italiano (Italian)", cat: "all"},
    {n: "Spanish", l: "EspaÃ±ol (Spanish)", cat: "all"},
    {n: "Portuguese", l: "PortuguÃªs (Portuguese)", cat: "all"},
    {n: "Russian", l: "Ğ ÑƒÑÑĞºĞ¸Ğ¹ (Russian)", cat: "all"},
    {n: "Swedish", l: "Svenska (Swedish)", cat: "all"},
    {n: "Dutch", l: "Nederlands (Dutch)", cat: "all"},
    {n: "Polish", l: "Polski (Polish)", cat: "all"},
    {n: "Turkish", l: "TÃ¼rkÃ§e (Turkish)", cat: "all"},
    {n: "Greek", l: "Î•Î»Î»Î·Î½Î¹ÎºÎ¬ (Greek)", cat: "all"},
    {n: "Finnish", l: "Suomi (Finnish)", cat: "all"},
    {n: "Norwegian", l: "Norsk (Norwegian)", cat: "all"},
    {n: "Danish", l: "Dansk (Danish)", cat: "all"},

    // --- äºšæ´²è¯­ç³» (Asian) ---
    {n: "Vietnamese", l: "Tiáº¿ng Viá»‡t (Vietnamese)", cat: "all"},
    {n: "Indonesian", l: "Bahasa Indonesia (Indonesian)", cat: "all"},
    {n: "Malay", l: "Bahasa Melayu (Malay)", cat: "all"},
    {n: "Hindi", l: "à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)", cat: "all"},
    {n: "Tagalog", l: "Tagalog (Filipino)", cat: "all"},
    {n: "Burmese", l: "á€™á€¼á€”á€ºá€™á€¬á€…á€¬ (Burmese)", cat: "all"},
    {n: "Khmer", l: "á—á¶áŸá¶ááŸ’á˜áŸ‚áš (Khmer)", cat: "all"},
    {n: "Lao", l: "àºàº²àºªàº²àº¥àº²àº§ (Lao)", cat: "all"},

    // --- ä¸­ä¸œä¸å¤è€è¯­ç³» (Middle East & Ancient) ---
    {n: "Arabic", l: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)", cat: "all"},
    {n: "Hebrew", l: "×¢×‘×¨×™×ª (Hebrew)", cat: "all"},
    {n: "Persian", l: "ÙØ§Ø±Ø³ÛŒ (Persian)", cat: "all"},
    {n: "Latin", l: "æ‹‰ä¸è¯­ (Latin)", cat: "all"}
];
    window.updateLangPreview = function() {
    const isEnabled = document.getElementById('lang-sync-toggle')?.checked;
    const bubble = document.getElementById('sample-bubble');
    const resetTip = document.getElementById('lang-reset-tip'); // æ‹¿åˆ°æé†’æ¡†
    const targetLang = window.langConfig.label;
    
    if (bubble) {
        bubble.style.display = isEnabled ? 'block' : 'none';
        const mainText = bubble.querySelector('.msg-text-main');
        mainText.textContent = `[System] AI æ­£åœ¨å°è¯•ä½¿ç”¨ ${targetLang} ä¸ä½ å…±é¸£...`;
    }

    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœå…³äº†å¼€å…³ï¼Œå°±æ˜¾ç¤ºé‡ç½®æŒ‡ä»¤æé†’
    if (resetTip) {
        resetTip.style.display = isEnabled ? 'none' : 'block';
    }
}
    // --- ğŸš¨ å…¨å±€æ„å¢ƒæ•°æ®åº“å¼ºåŠ›é”æ­» ---
// --- ğŸ—ºï¸ å…¨çƒåŸå¸‚æ„å¢ƒé«˜å®šæ¡£æ¡ˆåº“ ---
// --- ğŸ¨ å…¨çƒåŸå¸‚æ„å¢ƒåº“ (çº¯ CSS ä»£ç ç‰ˆ) ---
// ä¸å†ä½¿ç”¨å›¾ç‰‡é“¾æ¥ï¼Œå½»åº•è§£å†³ç‰ˆæƒé—®é¢˜
// --- ğŸ—ºï¸ å…¨çƒç™¾åŸæ„å¢ƒé«˜å®šæ¡£æ¡ˆåº“ (çº¯ CSS ä»£ç ç‰ˆ) ---
window.CITY_VIBE_DB = {
    // ==================== ğŸ‡¨ğŸ‡³ åå¤å¤§åœ° (50 CITIES) ====================
    "Beijing": { cssBg: "linear-gradient(180deg, #E6E6FA 0%, #DCDCDC 30%, #A52A2A 60%, #8B0000 100%)", vibe: "çº¢å¢™å¤–çš„ç§¯é›ªï¼Œæµ·æ·€åŒºæ·±å¤œæœªç†„çš„ç¯ç«ï¼Œä»¥åŠèƒ¡åŒé‡Œçš„äº¬è…”ã€‚" },
    "Shanghai": { cssBg: "linear-gradient(135deg, #FF00CC 0%, #333399 50%, #00FFFF 100%)", vibe: "å¤–æ»©çš„éœ“è™¹å€’å½±åœ¨æ±Ÿé¢ï¼Œæ¢§æ¡æ ‘ä¸‹çš„è€æ´‹æˆ¿ï¼Œç²¾è‡´ä¸”ç–ç¦»çš„æ™šé£ã€‚" },
    "Guangzhou": { cssBg: "linear-gradient(to bottom right, #a8e063, #56ab2f, #eacda3, #d6ae7b)", vibe: "ç æ±Ÿè¾¹çš„æ½®æ¹¿æ°´æ±½ï¼Œè¶Šç§€å±±çš„è‰é¸£ï¼Œå’ŒèŒ¶æ¥¼é‡Œç¼­ç»•çš„æ—©èŒ¶çƒŸç«ã€‚" },
    "Shenzhen": { cssBg: "linear-gradient(to right, #24fe41, #56ab2f, #01a9fe)", vibe: "ç§‘æŠ€å›­æ·±å¤œçš„ç¯å…‰ï¼Œå¤§æ¢…æ²™å’¸æ¹¿çš„æµ·é£ï¼Œå’Œè¿™åº§åŸå¸‚æ°¸ä¸åœæ­‡çš„è„‰åŠ¨ã€‚" },
    "Chengdu": { cssBg: "radial-gradient(circle at center, #ff9a44, #fc6076, #ff9a44)", vibe: "é”¦é‡Œå··å¼„çš„ç›–ç¢—èŒ¶é¦™ï¼Œé˜´å¤©é‡Œçš„çº¢æ²¹çƒ­æ°”ï¼Œå’Œæ…¢èŠ‚å¥çš„å·´èœ€ä½è¯­ã€‚" },
    "Chongqing": { cssBg: "linear-gradient(45deg, #2c3e50, #fd746c, #2c3e50)", vibe: "å±‚å é”™è½çš„èµ›åšæ£®æ—ï¼Œè½»è½¨ç©¿æ¥¼è€Œè¿‡çš„è½°é¸£ï¼Œå’Œæ½®æ¹¿é—·çƒ­çš„æ±Ÿæ¹–æ°”ã€‚" },
    "Hangzhou": { cssBg: "linear-gradient(to top, #96fbc4 0%, #f9f586 100%)", vibe: "æ–­æ¡¥ä¸Šçš„æ®‹é›ªï¼Œè¥¿æ¹–è¾¹æ°¤æ°²çš„èŒ¶çƒŸï¼Œå’Œçµéšå¯ºæ·±å¤„çš„é’Ÿå£°ã€‚" },
    "Suzhou": { cssBg: "linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)", vibe: "å›­æ—é‡Œçš„æœˆæ´é—¨ï¼Œæ«æ¡¥ä¸‹çš„æµæ°´ï¼Œå’Œè¯„å¼¹å£°ä¸­çš„å´ä¾¬è½¯è¯­ã€‚" },
    "Xi'an": { cssBg: "linear-gradient(to bottom, #8B4513, #FFD700, #B8860B)", vibe: "å¤§é›å¡”ä¸‹çš„æš®è‰²ï¼Œå¤åŸå¢™å¤–çš„é•¿å®‰é£éª¨ï¼Œå’Œç¢‘æ—é‡Œçš„å¢¨é¦™ã€‚" },
    "Nanjing": { cssBg: "linear-gradient(to right, #4facfe 0%, #00f2fe 100%)", vibe: "ç§¦æ·®æ²³ç•”çš„ç¯ç«ï¼Œæ˜åŸå¢™ä¸Šçš„è‹è‹”ï¼Œå’Œä¹Œè¡£å··å£çš„æ–œé˜³ã€‚" },
    "Wuhan": { cssBg: "linear-gradient(to top, #ff0844 0%, #ffb199 100%)", vibe: "æ±Ÿæ±‰å…³çš„é’Ÿå£°ï¼Œé»„é¹¤æ¥¼ä¸‹çš„æµ©æ¸ºæ±Ÿæ°´ï¼Œå’Œä¸€ç¢—çƒ­æ°”è…¾è…¾çš„çƒ­å¹²é¢ã€‚" },
    "Changsha": { cssBg: "linear-gradient(to right, #f83600 0%, #f9d423 100%)", vibe: "æ©˜å­æ´²å¤´çš„æ™šé£ï¼Œæ·±å¤œä¸æ‰“çƒŠçš„æ¹˜æƒ…ï¼Œå’Œå²³éº“å±±ä¸‹çš„ç«çº¢æ«å¶ã€‚" },
    "Harbin": { cssBg: "linear-gradient(to bottom, #E0FFFF, #F0FFFF, #B0C4DE)", vibe: "ä¸­å¤®å¤§è¡—çš„å†°é›•ï¼Œåœ£ç´¢è²äºšæ•™å ‚çš„ç§¯é›ªï¼Œå’Œå†°å†·ç©ºæ°”é‡Œçš„åˆ—å·´é¦™ã€‚" },
    "Xiamen": { cssBg: "linear-gradient(to right, #43e97b 0%, #38f9d7 100%)", vibe: "é¼“æµªå±¿çš„æµ·è¾¹ç´å£°ï¼Œç¯å²›è·¯çš„å‡¤å‡°èŠ±å¼€ï¼Œå’Œå—æ™®é™€çš„æ‚ ç„¶æ¢µéŸ³ã€‚" },
    "Qingdao": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "çº¢ç“¦ç»¿æ ‘çš„æ¬§å¼å»ºç­‘ï¼Œæµ·è¾¹æ²ç”œçš„å•¤é…’æ°”æ¯ï¼Œå’Œå…«å¤§å…³çš„è½å¶ã€‚" },
    "Kunming": { cssBg: "linear-gradient(to right, #6a11cb 0%, #2575fc 100%)", vibe: "ç¿ æ¹–è¾¹çš„çº¢å˜´é¸¥ï¼Œå››å­£ä¸è´¥çš„æ˜¥åŸèŠ±äº‹ï¼Œå’Œäº‘ç«¯æ‹‚è¿‡çš„æ¸…çˆ½ã€‚" },
    "Lhasa": { cssBg: "linear-gradient(to top, #fffc00, #ffffff)", vibe: "å¸ƒè¾¾æ‹‰å®«çš„æ—¥å…‰ï¼Œå¤§æ˜­å¯ºå‰çš„ç…¨æ¡‘çƒŸç«ï¼Œå’Œç»ç­’æ è¿‡çš„å¾®é£ã€‚" },
    "Urumqi": { cssBg: "linear-gradient(to right, #ed6a1d, #eacda3)", vibe: "å¤§å·´æ‰çš„é¦™æ–™å‘³ï¼Œè¿œæ–¹å¤©å±±çš„ç»ˆå¹´ç§¯é›ªï¼Œå’Œæˆˆå£æ»©ä¸Šçš„è½æ—¥ã€‚" },
    "Tianjin": { cssBg: "linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)", vibe: "æµ·æ²³ä¸Šçš„å¤©æ´¥ä¹‹çœ¼ï¼Œäº”å¤§é“çš„å°æ´‹æ¥¼ï¼Œå’Œç›¸å£°é‡Œçš„å¸‚äº•çƒŸç«ã€‚" },
    "Dalian": { cssBg: "linear-gradient(to right, #00c6fb 0%, #005bea 100%)", vibe: "æ˜Ÿæµ·å¹¿åœºçš„æµ·é£ï¼Œç™¾å¹´æœ‰è½¨ç”µè½¦çš„å®å½“å£°ï¼Œå’Œæµ·è¾¹èµ·ä¼çš„å¡é“ã€‚" },
    "Ningbo": { cssBg: "linear-gradient(120deg, #f093fb 0%, #f5576c 100%)", vibe: "å¤©ä¸€é˜çš„ä¹¦å¢¨é¦™ï¼Œä¸‰æ±Ÿå£çš„ç¹åå¤œè‰²ï¼Œå’Œä¸œé’±æ¹–çš„æ½‹æ»Ÿæ³¢å…‰ã€‚" },
    "Wuxi": { cssBg: "linear-gradient(to right, #fdfcfb 0%, #e2d1c3 100%)", vibe: "å¤ªæ¹–ä¹‹æ»¨çš„æ¸©æŸ”ï¼Œé¼‹å¤´æ¸šçš„æ¨±èŠ±é›¨ï¼Œå’Œæƒ å±±å¤é•‡çš„é™è°§ã€‚" },
    "Fuzhou": { cssBg: "linear-gradient(to top, #0ba360 0%, #3cba92 100%)", vibe: "ä¸‰åŠä¸ƒå··çš„çŸ³æ¿è·¯ï¼Œé—½æ±Ÿè¾¹çš„æ¦•æ ‘å…‰å½±ï¼Œå’Œç©ºæ°”ä¸­æ·¡æ·¡çš„èŒ‰è‰èŠ±é¦™ã€‚" },
    "Guiyang": { cssBg: "linear-gradient(to right, #434343 0%, #000000 100%)", vibe: "ç”²ç§€æ¥¼çš„å€’å½±ï¼Œé»”çµå±±çš„çµæ°”ï¼Œå’Œæ¹¿å†·ç©ºæ°”é‡Œé‚£ä¸€ç¢—é…¸æ±¤é±¼é¦™ã€‚" },
    "Lanzhou": { cssBg: "linear-gradient(to bottom, #eacda3, #d6ae7b)", vibe: "é»„æ²³è¾¹çš„ç¾Šçš®ç­å­ï¼Œä¸­å±±æ¡¥çš„é“éª¨å³¥åµ˜ï¼Œå’Œæ¸…æ™¨çš„ç¬¬ä¸€ç¢—ç‰›è‚‰é¢ã€‚" },
    "Sanya": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "äºšé¾™æ¹¾çš„çƒˆæ—¥ï¼Œæ¤°å­æ—é‡Œçš„æ¸…ç”œï¼Œå’Œå¤©æ¶¯æµ·è§’çš„æµªæ½®ã€‚" },
    "HongKong": { cssBg: "linear-gradient(to bottom, #09203f 0%, #537895 100%)", vibe: "ç»´æ¸¯çš„æµå…‰æº¢å½©ï¼Œå¤ªå¹³å±±é¡¶çš„ä¿¯ç°ï¼Œå’Œæ·±æ°´åŸ—çš„äººé—´çƒŸç«ã€‚" },
    "Macau": { cssBg: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)", vibe: "å¤§ä¸‰å·´çš„æ®‹è¿¹ï¼Œå¨±ä¹åœºçš„åç¯ï¼Œå’Œå®˜ä¹Ÿè¡—çš„è‘¡æŒé¦™ã€‚" },
    "Taipei": { cssBg: "linear-gradient(to top, #ff9a9e 0%, #fecfef 100%)", vibe: "101å¤§æ¥¼çš„äº‘ç«¯ï¼Œå£«æ—å¤œå¸‚çš„çƒ­é—¹ï¼Œå’Œæ·¡æ°´æ²³è¾¹çš„è½æ—¥ä½™æ™–ã€‚" },
    "Dali": { cssBg: "linear-gradient(to right, #4facfe 0%, #00f2fe 100%)", vibe: "æ´±æµ·çš„è‹å±±å€’å½±ï¼Œå¤åŸé‡Œçš„æ°‘è°£ï¼Œå’Œé£èŠ±é›ªæœˆçš„æ¸©æŸ”ã€‚" },
    "Lijiang": { cssBg: "linear-gradient(to bottom, #7028e4 0%, #e5b2ca 100%)", vibe: "ç‰é¾™é›ªå±±çš„åœ£æ´ï¼ŒæŸæ²³å¤é•‡çš„é©¬è¹„å£°ï¼Œå’Œå››æ–¹è¡—çš„çº³è¥¿æ­Œèˆã€‚" },
    "Dunhuang": { cssBg: "linear-gradient(to right, #f83600 0%, #f9d423 100%)", vibe: "è«é«˜çªŸçš„åƒå¹´å£ç”»ï¼Œé¸£æ²™å±±çš„é£æ²™ï¼Œå’Œæœˆç‰™æ³‰çš„é™è°§ã€‚" },
    "Zhuhai": { cssBg: "linear-gradient(to top, #5ee7df 0%, #b490ca 100%)", vibe: "æƒ…ä¾£è·¯çš„é•¿é£ï¼Œæ¸”å¥³çš„å®ˆæœ›ï¼Œå’Œæ¨ªç´å²›çš„ç»šçƒ‚å¤œæ™¯ã€‚" },
    "Quanzhou": { cssBg: "linear-gradient(to top, #ff9a9e 0%, #fecfef 100%)", vibe: "åˆºæ¡åŸçš„å¤è€ä¿¡ä»°ï¼Œçº¢ç –å¤§åçš„æ—§æ¢¦ï¼Œå’Œè¥¿è¡—çš„ç¹åã€‚" },
    "Shantou": { cssBg: "linear-gradient(to bottom, #fdfcfb 0%, #e2d1c3 100%)", vibe: "å°å…¬å›­çš„å—æ´‹é£æƒ…ï¼Œå†…æµ·æ¹¾çš„æ™šé£ï¼Œå’Œæ½®æ±•åŠŸå¤«èŒ¶çš„è‹¦ç”œã€‚" },
    "Foshan": { cssBg: "linear-gradient(to right, #00b09b, #96c93d)", vibe: "ç¥–åº™çš„é†’ç‹®ï¼Œå²­å—å¤©åœ°çš„å¤é›…ï¼Œå’Œé»„é£é¸¿çš„æ­¦ä¾ é­‚ã€‚" },
    "Dongguan": { cssBg: "linear-gradient(to top, #6a85b6 0%, #bac8e0 100%)", vibe: "åˆ¶é€ ä¹‹éƒ½çš„èŠ‚å¥ï¼Œæ¾å±±æ¹–çš„æ¸…æ¾ˆï¼Œå’Œå¯å›­çš„é›…è‡´ã€‚" },
    "Zhongshan": { cssBg: "linear-gradient(to bottom, #d2f1df, #fce2ce)", vibe: "å­™ä¸­å±±æ•…å±…çš„åº„é‡ï¼Œå²æ±Ÿè¾¹çš„è€è¡—ï¼Œå’Œä¸­å±±è£…é‡Œçš„æƒ…æ€€ã€‚" },
    "Huizhou": { cssBg: "linear-gradient(to right, #1d976c, #93f9b9)", vibe: "è¥¿æ¹–çš„è‹å ¤é£æœˆï¼ŒåŒæœˆæ¹¾çš„å¥‡è¿¹ï¼Œå’Œç½—æµ®å±±çš„å¹½é™ã€‚" },
    "Nanning": { cssBg: "linear-gradient(to top, #13547a 0%, #80d0c7 100%)", vibe: "ç»¿åŸçš„ç¹èŠ±ï¼Œå—æ¹–çš„å¤œæ™¯ï¼Œå’Œä¸­å±±è·¯å¤œå¸‚çš„çƒŸç«ã€‚" },
    "Guilin": { cssBg: "linear-gradient(to right, #1d976c, #93f9b9)", vibe: "æ¼“æ±Ÿçš„å­¤èˆŸï¼Œè±¡é¼»å±±çš„å€’å½±ï¼Œå’Œé˜³æœ”è¥¿è¡—çš„è¿·ç¦»ã€‚" },
    "Haikou": { cssBg: "linear-gradient(to bottom, #ffecd2, #fcb69f)", vibe: "éª‘æ¥¼è€è¡—çš„æ–‘é©³ï¼Œä¸‡ç»¿å›­çš„æ¸…æ–°ï¼Œå’Œå—å›½æµ·è¾¹çš„æ¹¿æ¶¦ã€‚" },
    "Luoyang": { cssBg: "linear-gradient(to right, #e1eec3, #f05053)", vibe: "é¾™é—¨çŸ³çªŸçš„éœ‡æ’¼ï¼Œæ´›é˜³ç‰¡ä¸¹çš„å€¾åŸï¼Œå’Œéš‹å”å¤éƒ½çš„ä½™æ™–ã€‚" },
    "Jinan": { cssBg: "linear-gradient(to top, #c471f5 0%, #fa71cd 100%)", vibe: "å¤§æ˜æ¹–ç•”çš„å‚æŸ³ï¼Œè¶µçªæ³‰çš„ç”Ÿæœºï¼Œå’Œæ³‰åŸè·¯çš„çƒ­é—¹ã€‚" },
    "Zhengzhou": { cssBg: "linear-gradient(to right, #74ebd5 0%, #9face6 100%)", vibe: "ä¸­åŸæ¢çº½çš„å¿™ç¢Œï¼ŒäºŒä¸ƒçºªå¿µå¡”çš„ç¯ç«ï¼Œå’Œåµ©å±±å°‘æ—çš„ç¦…æ„ã€‚" },
    "Hefei": { cssBg: "linear-gradient(to right, #6a11cb 0%, #2575fc 100%)", vibe: "åŒ…æ²³çš„å¾®é£ï¼Œç§‘å­¦å²›çš„é™è°§ï¼Œå’Œè¿™åº§åŸå¸‚è“¬å‹ƒçš„æœæ°”ã€‚" },
    "Nanchang": { cssBg: "linear-gradient(to top, #00c6fb 0%, #005bea 100%)", vibe: "æ»•ç‹é˜çš„å£®é˜”ï¼Œèµ£æ±Ÿè¾¹çš„ç¯å…‰ç§€ï¼Œå’Œå…«ä¸€å¹¿åœºçš„è‚ƒç©†ã€‚" },
    "Taiyuan": { cssBg: "linear-gradient(to right, #868f96 0%, #596164 100%)", vibe: "æ±¾æ²³ä¹‹ç•”çš„è½æ—¥ï¼Œæ™‹ç¥ çš„å¤è€ï¼Œå’Œé¾™åŸçš„åšé‡åº•è‰²ã€‚" },
    "Hohhot": { cssBg: "linear-gradient(to right, #d4fc79 0%, #96e6a1 100%)", vibe: "å¡å¤–é’åŸçš„è¾½é˜”ï¼Œå¤§å¬å¯ºçš„åº„ä¸¥ï¼Œå’Œè‰åŸæ·±å¤„çš„å¥¶èŒ¶é¦™ã€‚" },
    "Yinchuan": { cssBg: "linear-gradient(to bottom, #F5F5DC, #DAA520)", vibe: "è´ºå…°å±±ä¸‹çš„é›„æµ‘ï¼Œæ²™æ¹–çš„æ¸©æŸ”ï¼Œå’Œè¥¿å¤ç‹é™µçš„è‹å‡‰ã€‚" },

    // ==================== ğŸŒ å›½é™…æ¼«æ¸¸ (50 CITIES) ====================
    "Bangkok": { cssBg: "linear-gradient(to right, #ffb347, #ffcc33, #ff9966, #ff5e62)", vibe: "è€ƒå±±è·¯å–§é—¹çš„çªçªè½¦å£°ï¼Œæ¹¿çƒ­çš„é›¨åç©ºæ°”ï¼Œå’Œè¡—å¤´å¼¥æ¼«çš„é¦™æ–™å‘³ã€‚" },
    "Chiang Mai": { cssBg: "linear-gradient(to bottom, #D3CCE3, #E9E4F0, #a8e063)", vibe: "ç´ è´´å±±ä¸‹çš„æ¸…æ™¨è¿·é›¾ï¼Œå®æ›¼è·¯çš„æ–‡è‰ºå°é¦†ï¼Œå’Œæ…¢æ‚ æ‚ çš„åŒ—æ³°é£æƒ…ã€‚" },
    "Phuket": { cssBg: "linear-gradient(to bottom, #2193b0, #6dd5ed, #ffecd2, #fcb69f)", vibe: "å®‰è¾¾æ›¼æµ·çš„æ¹›è“æµªæ½®ï¼Œè½æ—¥ä½™æ™–ä¸‹çš„æ²™æ»©ï¼Œå’Œæ°¸è¿œä¸åœæ­‡çš„æµ·é£ã€‚" },
    "Tokyo": { cssBg: "repeating-linear-gradient(45deg, #0f0c29, #0f0c29 10px, #302b63 10px, #302b63 20px)", vibe: "æ¶©è°·è·¯å£çš„äººæ½®æ±¹æ¶Œï¼Œæ–°å®¿æ·±å¤œçš„å±…é…’å±‹ï¼Œå’Œç”µè½¦å…³é—¨æ—¶çš„æœºæ¢°éŸ³ã€‚" },
    "Osaka": { cssBg: "linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)", vibe: "é“é¡¿å €çš„å·¨å‹æ‹›ç‰Œï¼Œé€šå¤©é˜çš„å¤å¤å…‰å½±ï¼Œå’Œå…³è¥¿è…”é‡Œçš„çƒ­æƒ…å–§åš£ã€‚" },
    "Kyoto": { cssBg: "linear-gradient(to right, #f83600, #f9d423)", vibe: "å²šå±±çš„çº¢å¶ï¼Œä¼è§ç¨»è·çš„åƒæœ¬é¸Ÿå±…ï¼Œå’Œé¸­å·è¾¹çš„é™è°§é»„æ˜ã€‚" },
    "Seoul": { cssBg: "linear-gradient(to bottom, #11998e, #38ef7d)", vibe: "æ±‰æ±Ÿè¾¹çš„ç‚¸é¸¡ä¸æ™šé£ï¼Œå¼˜å¤§çš„è¡—å¤´æ¼”å‡ºï¼Œå’Œæ·±ç§‹æ˜æ´çš„é“¶æå¶ã€‚" },
    "London": { cssBg: "linear-gradient(to bottom, #373B44, #4286f4)", vibe: "ç»ˆå¹´ä¸æ•£çš„é˜´éƒæµ“é›¾ï¼Œå¤§æœ¬é’Ÿçš„æ²‰é¸£ï¼Œå’Œæ³°æ™¤å£«æ²³è¾¹æ¹¿æ¼‰æ¼‰çš„ä¼ã€‚" },
    "Paris": { cssBg: "linear-gradient(to top, #fad0c4 0%, #ffd1ff 100%)", vibe: "å¡çº³æ²³ç•”çš„å’–å•¡ç„¦é¦™ï¼Œå¤•é˜³ä¸‹çš„åŸƒè²å°”é“å¡”ï¼Œå’Œé¦™æ¦­ä¸½èˆå¤§é“çš„æµªæ¼«ã€‚" },
    "New York": { cssBg: "linear-gradient(to right, #000000, #434343, #000000)", vibe: "æ—¶ä»£å¹¿åœºæ°¸ä¸ç†„ç­çš„å·¨å¹•ï¼Œä¸­å¤®å…¬å›­çš„æ¯å¶ï¼Œå’Œåœ°é“æ·±å¤„çš„è½°é¸£ã€‚" },
    "Los Angeles": { cssBg: "linear-gradient(to right, #ff7e5f, #feb47b)", vibe: "å¥½è±åå±±çš„è½æ—¥ï¼Œåœ£è«å°¼å¡æµ·æ»©çš„æ¤°æ—ï¼Œå’Œæ˜Ÿå…‰å¤§é“çš„ç’€ç’¨æ¢¦æƒ³ã€‚" },
    "San Francisco": { cssBg: "linear-gradient(to right, #ff7e5f, #feb47b)", vibe: "é‡‘é—¨å¤§æ¡¥çš„é›¾æ°”ï¼Œä¹æ›²èŠ±è¡—çš„ç¼¤çº·ï¼Œå’Œç¡…è°·æ·±å¤„çš„åˆ›æ–°è„‰åŠ¨ã€‚" },
    "Sydney": { cssBg: "linear-gradient(to top, #4481eb 0%, #04befe 100%)", vibe: "æ­Œå‰§é™¢çš„å¸†å½±ï¼Œé‚¦è¿ªæµ·æ»©çš„å†²æµªå°‘å¹´ï¼Œå’Œè¾¾ä»¤æ¸¯çš„çƒŸç«ã€‚" },
    "Singapore": { cssBg: "linear-gradient(to right, #ff5f6d, #ffc371)", vibe: "æ»¨æµ·æ¹¾çš„é‡‘æ²™å¹»å½±ï¼Œé±¼å°¾ç‹®çš„åæ¯ï¼Œå’Œä¹ŒèŠ‚è·¯çš„ç¹åç¯ç«ã€‚" },
    "Dubai": { cssBg: "linear-gradient(to right, #D4AF37, #C0C0C0)", vibe: "å“ˆåˆ©æ³•å¡”çš„äº‘ç«¯ï¼Œæ²™æ¼ ä¸­å¿ƒçš„å¥‡è¿¹ï¼Œå’Œå¸†èˆ¹é…’åº—çš„å€’å½±ã€‚" },
    "Rome": { cssBg: "linear-gradient(to right, #f12711, #f5af19)", vibe: "æ–—å…½åœºçš„è½æ—¥ï¼Œè®¸æ„¿æ± çš„æ¸…äº®æ³‰æ°´ï¼Œå’Œç©¿è¶Šåƒå¹´çš„çŸ³æ¿è·¯ã€‚" },
    "Venice": { cssBg: "linear-gradient(to right, #74ebd5 0%, #9face6 100%)", vibe: "å¹æ¯æ¡¥ä¸‹çš„è´¡å¤šæ‹‰ï¼Œåœ£é©¬å¯å¹¿åœºçš„é¸½ç¾¤ï¼Œå’Œé€æ¸ä¸Šæ¶¨çš„æ½®å£°ã€‚" },
    "Berlin": { cssBg: "linear-gradient(to top, #200122, #6f0000)", vibe: "æŸæ—å¢™çš„æ¶‚é¸¦è®°å¿†ï¼Œå‹ƒå…°ç™»å ¡é—¨çš„è‚ƒç©†ï¼Œå’Œè¿™åº§åŸå¸‚å†·å³»çš„è‰ºæœ¯æ„Ÿã€‚" },
    "Amsterdam": { cssBg: "linear-gradient(to top, #00c6fb 0%, #005bea 100%)", vibe: "è¿æ²³ä¸¤å²¸çš„å½©è‰²æˆ¿å­ï¼Œéƒé‡‘é¦™çš„èŠ±æµ·ï¼Œå’Œéª‘è½¦ç»è¿‡çš„è‡ªç”±é£ã€‚" },
    "Madrid": { cssBg: "linear-gradient(to bottom, #f12711, #f5af19)", vibe: "æ™®æ‹‰å¤šåšç‰©é¦†çš„çè—ï¼Œé©¬çº¦å°”å¹¿åœºçš„çƒ­é—¹ï¼Œå’Œä½›æœ—æ˜å“¥çš„ç‹‚çƒ­ã€‚" },
    "Barcelona": { cssBg: "linear-gradient(to right, #ffb199 0%, #ff0844 100%)", vibe: "åœ£å®¶å ‚çš„æ€ªè¯ç¾å­¦ï¼Œå·´å¡ç½—å†…å¡”æµ·æ»©çš„é˜³å…‰ï¼Œå’Œé«˜è¿ªçš„å¹»æ¢¦ã€‚" },
    "Moscow": { cssBg: "linear-gradient(to right, #83a4d4, #b6fbff)", vibe: "çº¢åœºçš„æ´‹è‘±å¤´æˆ¿é¡¶ï¼Œå…‹é‡Œå§†æ—å®«çš„åšé‡ï¼Œå’Œè«æ–¯ç§‘æ²³çš„æ·±æ²‰ã€‚" },
    "Cairo": { cssBg: "linear-gradient(to bottom, #ed6a1d, #eacda3)", vibe: "é‡‘å­—å¡”å‰çš„æ¼«å¤©é»„æ²™ï¼Œå°¼ç½—æ²³çš„å¤è€è„‰åŠ¨ï¼Œå’Œå¤åŸƒåŠçš„ç¥ç§˜æ°”æ¯ã€‚" },
    "Melbourne": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "æ¶‚é¸¦å··çš„è‰ºæœ¯æ°›å›´ï¼Œå¤§æ´‹è·¯çš„å£®é˜”ï¼Œå’Œè¿™åº§åŸå¸‚çš„å’–å•¡æ–‡åŒ–ã€‚" },
    "Vancouver": { cssBg: "linear-gradient(to right, #4facfe 0%, #00f2fe 100%)", vibe: "æ–¯å¦åˆ©å…¬å›­çš„æ£®æ—ï¼Œä¾å±±å‚æµ·çš„æ¸…å†·ï¼Œå’ŒåŒ—ç¾æœ€ç¾çš„å¤•é˜³ã€‚" },
    "Toronto": { cssBg: "linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)", vibe: "CNå¡”ä¿¯ç°çš„éƒ½å¸‚ä¸›æ—ï¼Œå®‰å¤§ç•¥æ¹–çš„å¾®æ³¢ï¼Œå’Œå¤šå…ƒæ–‡åŒ–çš„äº¤å“ã€‚" },
    "Vienna": { cssBg: "linear-gradient(to right, #fdfcfb 0%, #e2d1c3 100%)", vibe: "é‡‘è‰²å¤§å…çš„äº¤å“ä¹ï¼Œè¨èµ«è›‹ç³•çš„é†‡åšï¼Œå’Œå¤šç‘™æ²³çš„è“è‰²æ—‹å¾‹ã€‚" },
    "Prague": { cssBg: "linear-gradient(to top, #c471f5 0%, #fa71cd 100%)", vibe: "æŸ¥ç†å¤§æ¡¥çš„å¤è€çŸ³åƒï¼Œè€åŸå¹¿åœºçš„å¤©æ–‡é’Ÿï¼Œå’Œæ³¢å¸Œç±³äºšçš„çº¢ç“¦é¡¶ã€‚" },
    "Zurich": { cssBg: "linear-gradient(to top, #e6e9f0 0%, #eef1f5 100%)", vibe: "è‹é»ä¸–æ¹–çš„çº¯å‡€ï¼Œç­éœå¤«å¤§è¡—çš„å¥¢åï¼Œå’Œé˜¿å°”å‘æ–¯å±±è„‰çš„è¿œçœºã€‚" },
    "Geneva": { cssBg: "linear-gradient(to right, #a1c4fd 0%, #c2e9fb 100%)", vibe: "å¤§å–·æ³‰çš„æ°´èŠ±ï¼Œæ—¥å†…ç“¦æ¹–çš„é™è°§ï¼Œå’Œé’Ÿè¡¨ä¹‹éƒ½çš„ç²¾å‡†èŠ‚å¥ã€‚" },
    "Stockholm": { cssBg: "linear-gradient(to right, #a1c4fd 0%, #c2e9fb 100%)", vibe: "è€åŸçš„çŸ³ç –è·¯ï¼Œæ–¯å ªçš„çº³ç»´äºšçš„æç®€ï¼Œå’Œæ³¢ç½—çš„æµ·çš„å‘¼å¸ã€‚" },
    "Copenhagen": { cssBg: "linear-gradient(to top, #d2f1df 0%, #fce2ce 100%)", vibe: "æ–°æ¸¯çš„å½©è‰²æˆ¿å­ï¼Œå°ç¾äººé±¼çš„å®ˆæœ›ï¼Œå’Œç«¥è¯ç‹å›½çš„æ‚ é—²ã€‚" },
    "Oslo": { cssBg: "linear-gradient(to bottom, #2c3e50, #4ca1af)", vibe: "ç»´æ ¼å…°é›•å¡‘å…¬å›­çš„éœ‡æ’¼ï¼Œå¥¥æ–¯é™†å³¡æ¹¾çš„é£ï¼Œå’ŒåŒ—æ¬§çš„æ¸…å†·ç¾å­¦ã€‚" },
    "Reykjavik": { cssBg: "linear-gradient(to bottom, #2c3e50, #4ca1af)", vibe: "å†°å²›æ—·é‡çš„å­¤ç‹¬ï¼Œè“æ¹–æ¸©æ³‰çš„æ°¤æ°²ï¼Œå’Œåˆå¤œå¤ªé˜³çš„å¥‡è¿¹ã€‚" },
    "Lisbon": { cssBg: "linear-gradient(to right, #f79d00, #64f38c)", vibe: "é»„è‰²ç”µè½¦çˆ¬è¿‡çš„å¡é“ï¼Œæ³•å¤šéŸ³ä¹çš„å¿§éƒï¼Œå’Œè´ä¼¦å¡”çš„æµ·è¾¹å¤•é˜³ã€‚" },
    "Athens": { cssBg: "linear-gradient(to top, #6a85b6 0%, #bac8e0 100%)", vibe: "å«åŸçš„æ–­å£æ®‹å£ï¼Œçˆ±ç´æµ·çš„æ¹›è“ï¼Œå’Œå¤å¸Œè…Šæ–‡æ˜çš„ä½™æ™–ã€‚" },
    "Istanbul": { cssBg: "linear-gradient(to bottom, #09203f, #537895)", vibe: "åšæ–¯æ™®é²æ–¯æµ·å³¡çš„è½®æ¸¡ï¼Œè“è‰²æ¸…çœŸå¯ºçš„å‘¼å”¤ï¼Œå’Œäºšæ¬§äº¤ç•Œçš„åšé‡ã€‚" },
    "Dubai": { cssBg: "linear-gradient(to right, #D4AF37, #C0C0C0)", vibe: "å“ˆåˆ©æ³•å¡”çš„äº‘ç«¯å¥¢åï¼Œæ²™æ¼ ä¸­çš„ç»ç’ƒåŸå ¡ï¼Œå’Œæœ±ç¾æ‹‰æ£•æ¦ˆå²›çš„å£®é˜”ã€‚" },
    "Abu Dhabi": { cssBg: "linear-gradient(to right, #ffb347, #ffcc33)", vibe: "è°¢èµ«æ‰è€¶å¾·å¤§æ¸…çœŸå¯ºçš„æ´ç™½ï¼Œæ²™æ¼ ä¸­çš„å¢æµ®å®«ï¼Œå’Œæ³¢æ–¯æ¹¾çš„æš–é£ã€‚" },
    "Mumbai": { cssBg: "linear-gradient(to top, #f83600 0%, #f9d423 100%)", vibe: "å­Ÿä¹°æ¹¾çš„å­£é£ï¼Œå®è±åçš„æ–‘æ–“è‰²å½©ï¼Œå’Œè¿™åº§åŸå¸‚çš„å–§åš£ç”Ÿå‘½åŠ›ã€‚" },
    "Delhi": { cssBg: "linear-gradient(to right, #ed6a1d, #eacda3)", vibe: "çº¢å ¡çš„è¾‰ç…Œï¼Œæ—§å¾·é‡Œçš„å°å··ï¼Œå’Œå„ç§é¦™æ–™æ±‡èšçš„æµ“éƒæ°”æ¯ã€‚" },
    "Kuala Lumpur": { cssBg: "linear-gradient(to top, #00d2ff 0%, #3a7bd5 100%)", vibe: "åŒå­å¡”çš„å†·å†½ï¼Œç‹¬ç«‹å¹¿åœºçš„ç¹åï¼Œå’Œå„ç§æ—æ–‡åŒ–äº¤æ±‡çš„çƒŸç«ã€‚" },
    "Bali": { cssBg: "linear-gradient(to right, #00b09b, #96c93d)", vibe: "å¾·æ ¼æ‹‰æœ—æ¢¯ç”°çš„ç»¿ï¼Œä¹Œé²ç“¦å›¾çš„æ–­å´–è½æ—¥ï¼Œå’Œç¥åº™é‡Œçš„é™è°§ç¦…æ„ã€‚" },
    "Hanoi": { cssBg: "linear-gradient(to right, #1d976c, #93f9b9)", vibe: "è¿˜å‰‘æ¹–çš„æ™¨ç»ƒï¼Œè€è¡—çš„æ»´æ¼å’–å•¡ï¼Œå’Œè¿™åº§åŸå¸‚å¤æœ´çš„æ—¶é—´æ„Ÿã€‚" },
    "Ho Chi Minh City": { cssBg: "linear-gradient(to top, #eb3349 0%, #f45c43 100%)", vibe: "è¥¿è´¡çš„æ‘©æ‰˜è½¦æ´ªæµï¼Œæ³•å¼å»ºç­‘çš„ä½™æ™–ï¼Œå’Œæå…¶çƒ­æƒ…çš„è¡—å¤´æ´»åŠ›ã€‚" },
    "Manila": { cssBg: "linear-gradient(to right, #ff5f6d, #ffc371)", vibe: "é©¬å°¼æ‹‰æ¹¾çš„æ—¥è½ï¼Œç‹åŸå†…çš„å¤æ—§çŸ³å¢™ï¼Œå’Œç°ä»£éƒ½å¸‚çš„çƒ­è¾£èŠ‚å¥ã€‚" },
    "Cape Town": { cssBg: "linear-gradient(to top, #30cfd0 0%, #330867 100%)", vibe: "æ¡Œå±±çš„äº‘é›¾æ¡Œå¸ƒï¼Œå¥½æœ›è§’çš„å£®é˜”æµªæ½®ï¼Œå’Œå½©è‰²æˆ¿å­åšå¡æ™®çš„æ¬¢å¿«ã€‚" },
    "Rio de Janeiro": { cssBg: "linear-gradient(to right, #00b09b, #96c93d)", vibe: "æ•‘ä¸–åŸºç£åƒçš„æ€€æŠ±ï¼Œç§‘å¸•å¡å·´çº³æµ·æ»©çš„æ¡‘å·´ï¼Œå’ŒåŸºç£å±±çš„é¸Ÿç°ã€‚" },
    "Buenos Aires": { cssBg: "linear-gradient(to bottom, #1e3c72, #2a5298)", vibe: "æ¢æˆˆçš„ä¼˜é›…ï¼Œå—ç¾å·´é»çš„ç¹åï¼Œå’Œç«ç‘°å›­é‡Œçš„èŠ¬èŠ³ã€‚" },
    "Mexico City": { cssBg: "linear-gradient(to right, #ff7e5f, #feb47b)", vibe: "å®ªæ³•å¹¿åœºçš„çƒ­é—¹ï¼Œå¼—é‡Œè¾¾è“æˆ¿å­çš„è‰ºæœ¯ï¼Œå’Œå¤ä»£æ–‡æ˜çš„é—è¿¹ã€‚" },

    "default": { cssBg: "linear-gradient(to right, #8e2de2, #4a00e0)", vibe: "åœ¨è¿™ä¸ªé™Œç”Ÿçš„ç»çº¬åº¦ä¸Šï¼Œæˆ‘ä¾ç„¶èƒ½æ„Ÿè§‰åˆ°å±äºä½ çš„é‡å­è„‰åŠ¨ã€‚" }
};

window.executeSummaryProcess = async function(contactId) {
    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
        
        // 1. è·å–å†å²è®°å½•
        const history = await getChatHistory(contactId);
        if (history.length < 3) return;

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ„é€ ä¸Šä¸‹æ–‡æ—¶ï¼Œç‰©ç†æ‹¦æˆª Base64 å›¾ç‰‡ä»£ç 
        const chatContext = history.slice(-30).map(m => {
            // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œåªå‘Šè¯‰ AI â€œç”¨æˆ·å‘äº†å›¾â€ï¼Œä¸å‘é‚£ä¸€é•¿ä¸²ä¹±ç 
            const content = m.type === 'image' ? '[å›¾ç‰‡å†…å®¹]' : m.text;
            return `${m.role}: ${content}`;
        }).join('\n');
        
        // 2. æ„é€ æ ‡å‡†çš„ messages æ•°ç»„
        const messages = [
            { 
                role: "system", 
                content: "ä½ æ˜¯ä¸€ä¸ªè®°å¿†æå–å™¨ã€‚è¯·å¯¹å¯¹è¯è¿›è¡Œè®°å¿†åç¼©ï¼Œæå–æœ€é‡è¦çš„1ä¸ªäº‹å®æˆ–æƒ…æ„Ÿè¿›å±•ã€‚è¦æ±‚ï¼š80å­—ä»¥å†…ï¼Œåƒç§äººæ¡£æ¡ˆï¼Œç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚" 
            },
            { 
                role: "user", 
                content: `å¯¹è¯å†…å®¹å¦‚ä¸‹ï¼š\n${chatContext}` 
            }
        ];

        // 3. æ‰§è¡Œå‘é€
        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: messages,
                temperature: 0.7
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        
        const summaryText = data.choices[0].message.content.trim();

        // 4. å­˜å…¥æ•°æ®åº“
        let summaries = await loadFromDB('summaries_' + contactId) || [];
        summaries.unshift({ timestamp: Date.now(), text: summaryText });
        await saveToDB('summaries_' + contactId, summaries);

        // åˆ·æ–° UI å’Œé€šçŸ¥
        if (typeof renderSummaryCards === 'function') renderSummaryCards(contactId);
        window.showPushNotification("æ ¸å¿ƒè®°å¿†å·²åç¼©", "æ–°çš„äººæ ¼èŠ‚ç‚¹å·²å­˜å…¥åè®®ã€‚");

    } catch (e) {
        // è¿™é‡Œæ‹¦æˆªäº†ä½ çœ‹åˆ°çš„é‚£ä¸ª 400 é”™è¯¯
        console.error("âŒ è‡ªåŠ¨æ€»ç»“å¤±è´¥:", e);
    }
};
// ==========================================
// ğŸ§  æ•°æ®é©±åŠ¨ï¼šæ¶ˆæ¯æ‹¦æˆªå®¡è®¡ (å¸¦æ§åˆ¶å°å¯è§†åŒ–)
// ==========================================
window.autoSummaryAuditor = function(contactId) {
    const contact = window.currentChattingWith || { name: "æœªçŸ¥è§’è‰²" };
    const targetRounds = parseInt(localStorage.getItem('summary_rounds_' + contactId) || "10");
    
    let currentCount = parseInt(localStorage.getItem('chat_count_' + contactId) || "0");
    currentCount++; 

    // ğŸš¨ è¿™ä¸€æ®µåœ¨æ§åˆ¶å°ä¼šéå¸¸æ¼‚äº®ï¼Œè®©ä½ ä¸€çœ¼çœ‹åˆ°è¿›åº¦
    console.group(`ğŸ“Š è®°å¿†åè®®ç›‘æ§ [${contact.name}]`);
    console.log(`%c å½“å‰è½®æ•°: ${currentCount} `, "background: #1d1d1f; color: #fff; border-radius: 3px;");
    console.log(`%c è§¦å‘é˜ˆå€¼: ${targetRounds} `, "background: #007AFF; color: #fff; border-radius: 3px;");
    
    const progress = (currentCount / targetRounds * 100).toFixed(0);
    console.log(`%c é‡å­åç¼©è¿›åº¦: ${progress}% `, `color: ${progress >= 100 ? '#FF3B30' : '#34C759'}; font-weight: bold;`);
    console.groupEnd();

    if (currentCount >= targetRounds) {
        console.info("%c ğŸš€ è¾¾åˆ°é˜ˆå€¼ï¼Œæ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ€»ç»“...", "color: #FF9500; font-weight: bold;");
        localStorage.setItem('chat_count_' + contactId, "0"); // è®¡æ•°å½’é›¶
        window.executeSummaryProcess(contactId);
    } else {
        localStorage.setItem('chat_count_' + contactId, currentCount.toString());
    }
};
    // --- ğŸ“± å¼ºåŠ›é€šçŸ¥ä¸­å¿ƒå¼•æ“ ---
let startY = 0;
let isPulling = false;

// 1. ç›‘å¬å…¨å±€è§¦æ§å¼€å§‹
document.addEventListener('touchstart', function(e) {
    // å¦‚æœæ˜¯ä»å±å¹•ä¸ŠåŠéƒ¨åˆ†å¼€å§‹ä¸‹æ‹‰ (y < 80px)
    if (e.touches[0].clientY < 80) {
        startY = e.touches[0].clientY;
        isPulling = true;
    }
}, { passive: true });

// 2. ç›‘å¬æ»‘åŠ¨è¿‡ç¨‹
document.addEventListener('touchmove', function(e) {
    if (!isPulling) return;
    
    let currentY = e.touches[0].clientY;
    let diff = currentY - startY;

    // åªè¦ä¸‹æ»‘è¶…è¿‡ 30px å°±è®¤ä¸ºæ˜¯è¦æ‹‰å‡ºé€šçŸ¥ä¸­å¿ƒ
    if (diff > 30) {
        window.openNotificationShade();
        isPulling = false; // è§¦å‘åé‡ç½®
    }
}, { passive: true });

// 3. åœæ­¢ç›‘å¬
document.addEventListener('touchend', function() {
    isPulling = false;
});

// 4. æ‰§è¡Œå¼€å¯
window.openNotificationShade = function() {
    const shade = document.getElementById('ios-notification-shade');
    if (!shade) return;
    
    shade.style.display = 'flex';
    // å¼ºåˆ¶æµè§ˆå™¨æ¸²æŸ“åå†æ»‘åŠ¨
    setTimeout(() => {
        shade.classList.add('active');
        console.log("System: é€šçŸ¥ä¸­å¿ƒå·²æ¨å…¥");
    }, 10);
};

// 5. æ‰§è¡Œå…³é—­
window.closeNotificationShade = function() {
    const shade = document.getElementById('ios-notification-shade');
    if (shade) {
        shade.classList.remove('active');
        setTimeout(() => {
            shade.style.display = 'none';
        }, 400);
    }
};

// --- ğŸ§¹ ä¸€é”®æ¸…é™¤é€šçŸ¥ä¸­å¿ƒ ---
window.clearAllNotifications = function() {
    // 1. ç‰©ç†æ¸…ç©ºæœ¬åœ°å­˜å‚¨
    localStorage.removeItem('ios_notif_db');
    
    // 2. é‡æ–°æ¸²æŸ“é¡µé¢ï¼ˆä¼šè‡ªåŠ¨æ˜¾ç¤ºç©ºçŠ¶æ€ï¼‰
    window.renderNotificationList();
    
    showToast("å·²æ¸…ç©ºé€šçŸ¥ä¸­å¿ƒ");
};

// ==========================================
// ğŸ”” å¢å¼ºç‰ˆï¼šå•†ç”¨è‡ªæ„ˆé€šçŸ¥å¼•æ“ (é»‘ç™½çº¿æ¡é£é™å®šç‰ˆ)
// ==========================================
window.showPushNotification = function(title, text) {
    let banner = document.getElementById('ios-push-banner');
    
    // ğŸ¨ ä¿æŒä½ å–œæ¬¢çš„é»‘ç™½çº¿æ¡å›¾æ ‡
    const lineIcon = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5"><path d="M12 2v4M12 18v4M4 12H2M22 12h-2" stroke-linecap="round"/><path d="M16 8v8H8V8h8zM9 12h6" stroke-linecap="round"/><rect x="5" y="5" width="14" height="14" rx="2"/></svg>`;

    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'ios-push-banner';
        banner.className = 'ios-banner';
        document.body.appendChild(banner);
    }

    // 1. å¼¹å‡ºé¡¶éƒ¨æ¨ªå¹…
    banner.innerHTML = `
        <div style="border: 1.5px solid #000; border-radius: 10px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">${lineIcon}</div>
        <div style="flex:1; margin-left:12px; overflow:hidden;">
            <div style="font-size:13px; font-weight:800; color:#000;">${title}</div>
            <div style="font-size:12px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${text}</div>
        </div>`;

    void banner.offsetWidth; 
    banner.classList.add('show');

    // 2. ğŸš¨ ã€æ•°æ®æŒä¹…åŒ–ã€‘å­˜å…¥æœ¬åœ°æ¡£æ¡ˆåº“
    const newNotif = {
        id: Date.now(),
        title: title,
        text: text,
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
    };
    let history = JSON.parse(localStorage.getItem('ios_notif_db') || "[]");
    history.unshift(newNotif); // æœ€æ–°æ¶ˆæ¯æ”¾æœ€å‰é¢
    localStorage.setItem('ios_notif_db', JSON.stringify(history));

    // 3. ç«‹å³è§¦å‘æ¸²æŸ“ï¼Œè®©é€šçŸ¥ä¸­å¿ƒåŒæ­¥æ›´æ–°
    window.renderNotificationList();

    setTimeout(() => { if (banner) banner.classList.remove('show'); }, 5000);
};
window.renderNotificationList = function() {
    const list = document.getElementById('notification-list');
    if (!list) return;

    // ä»æœ¬åœ°å­˜å‚¨è¯»å–
    const history = JSON.parse(localStorage.getItem('ios_notif_db') || "[]");
    
    if (history.length === 0) {
        list.innerHTML = `<div class="notif-empty-state">æ²¡æœ‰æ›´æ—©çš„é€šçŸ¥äº†</div>`;
        return;
    }

    // æ¸²æŸ“é»‘ç™½çº¿æ¡æ„Ÿå¡ç‰‡
    list.innerHTML = history.map(item => `
        <div class="notif-item-custom" style="background:rgba(255,255,255,0.1); border-radius:18px; padding:15px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.1);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span style="font-weight:800; font-size:11px; color:rgba(255,255,255,0.8); letter-spacing:1px;">SYSTEM CORE</span>
                <span style="font-size:9px; color:rgba(255,255,255,0.4);">${item.time}</span>
            </div>
            <div style="font-size:14px; font-weight:700; color:#fff; margin-bottom:4px;">${item.title}</div>
            <div style="font-size:12px; color:rgba(255,255,255,0.7); line-height:1.4;">${item.text}</div>
        </div>
    `).join('');
};

// ğŸš¨ è¿™ä¸€æ­¥æœ€å…³é”®ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡
document.addEventListener('DOMContentLoaded', window.renderNotificationList);

// ç‚¹å‡»æ¨ªå¹…è·³è½¬åˆ°æ€»ç»“é¡µ
window.handleNotificationClick = function() {
    document.getElementById('ios-push-banner').classList.remove('show');
    // å¼ºåˆ¶è·³è½¬
    if(typeof window.openMemorySummary === 'function') {
        window.openMemorySummary();
    }
};
    // ==========================================
// ğŸ¬ è®°å¿†è§†ç•Œï¼šè¯¦æƒ…å¼¹çª—é€»è¾‘ (å½»åº•ä¿®å¤ç‰ˆ)
// ==========================================

// 1. å¼ºåŠ›å¼€å¯è¯¦æƒ…é¡µ
window.openCinemaMemory = function(m) {
    const modal = document.getElementById('modal-memory-cinema');
    const titleEl = document.getElementById('cinema-title-ui');
    const contentEl = document.getElementById('cinema-text-content');
    const imgEl = document.getElementById('cinema-img');

    if (!modal || !m) return;

    // 1. å¡«å……æ–‡æœ¬å†…å®¹
    if (titleEl) titleEl.textContent = m.title;
    if (contentEl) {
        // ä½¿ç”¨æ­£åˆ™å°† ã€ã€‘ å’Œ ã€Œã€ è½¬æ¢ä¸ºé»‘ç™½æ ‡æ³¨æ ·å¼
        contentEl.innerHTML = m.content
            .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
            .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>');
    }

    // 2. å¡«å……å°é¢å›¾
    if (imgEl) {
        imgEl.src = m.img;
        imgEl.alt = ""; // ğŸš¨ æ¸…ç©º alt æ–‡æœ¬ï¼Œé˜²æ­¢æ˜¾ç¤ºâ€œsceneâ€å­—æ ·
        
        // å¦‚æœæ•°æ®é‡Œçš„å›¾ç‰‡åäº†ï¼Œè‡ªåŠ¨æ‹¿å½“å‰èŠå¤©å¯¹è±¡çš„å¤´åƒè¡¥ä½
        imgEl.onerror = function() {
            this.src = window.currentChattingWith.avatar;
        };
    }

    // 3. æ‰§è¡ŒåŠ¨ç”»
    modal.style.display = 'flex';
    modal.classList.add('active');
    
    const scroller = modal.querySelector('.cinema-scroll-layer');
    if (scroller) scroller.scrollTop = 0;
};

// 2. ç‰©ç†å…³é—­è¯¦æƒ…é¡µ
window.closeCinemaMemory = function() {
    const modal = document.getElementById('modal-memory-cinema');
    if (modal) {
        modal.classList.remove('active');
        // ç­‰åŠ¨ç”»ç»“æŸåå½»åº•éšè—
        setTimeout(() => {
            modal.style.display = 'none';
        }, 500);
    }
};
    // ğŸš¨ å¿…é¡»æ”¾åœ¨ <script> æ ‡ç­¾çš„æœ€é¡¶éƒ¨ï¼Œä¸è¦æ”¾åœ¨ä»»ä½• function å†…éƒ¨ï¼
var currentUploaderTarget = 'chat'; 
var tempBgData = {
    chat: { type: 'img', data: null },
    settings: { type: 'img', data: null }
};
var tempCharProfileData = { id: null, avatar: null };

// ... å‰©ä¸‹çš„å…¶ä»–ä»£ç  ...
    // --- 1. å…¨å±€å˜é‡å­˜å‚¨è½¬å‘æ•°æ® ---
window.pendingForwardData = []; 
window.forwardTabMode = 'friends';
    var currentQuoteData = null; // å­˜å‚¨å½“å‰å¼•ç”¨çš„æ•°æ®

function cancelQuote() {
    window.currentQuoteData = null;
    const preview = document.getElementById('quote-preview');
    if (preview) preview.style.display = 'none';
}
    // --- ğŸš¨ ç‰©ç†ç½®é¡¶ï¼šå…¨å±€æ“ä½œå˜é‡ ---
var currentActiveBubble = null;
    // ç¡®ä¿è¿™ä¸€è¡Œåœ¨æ‰€æœ‰å‡½æ•°ï¼ˆå¦‚ initChatMsgPanelï¼‰çš„ä¸Šæ–¹
var isMsgPanelRendering = false;
    // åœ¨ script è„šæœ¬å¼€å¤´æ·»åŠ 
window.chatListMode = 'friends';
   // ==========================================
// ğŸš€ å­—ä½“ä¸æ˜¾ç¤ºï¼šç»ˆæé€»è¾‘è¡¥ä¸ (è§£å†³ undefined æŠ¥é”™)
// ==========================================

// 1. åˆå§‹åŒ–é…ç½® (æ”¾åœ¨ script æœ€å‰é¢)
window.currentFontConfig = JSON.parse(localStorage.getItem('ios_font_config')) || {
    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
    size: 16,
    weight: 400,
    colorMain: '#1d1d1f',
    colorDesktop: '#1d1d1f'
};

// 2. å®æ—¶é¢„è§ˆæ›´æ–° (ä¿®å¤ "is not a function" çš„æ ¸å¿ƒ)
window.updateFontPreview = function(type, val) {
    if(type === 'size') {
        window.currentFontConfig.size = val;
        const sd = document.getElementById('size-display');
        if(sd) sd.textContent = val + 'px';
    } else if(type === 'weight') {
        window.currentFontConfig.weight = val;
        const wd = document.getElementById('weight-display');
        if(wd) wd.textContent = val;
    }
    // æ¯æ¬¡æ»‘åŠ¨ï¼Œåªåˆ·æ–°ä¸Šé¢çš„é¢„è§ˆç›’å­ï¼Œä¸åˆ·æ–°æ¡Œé¢é˜²æ­¢å¡é¡¿
    window.updateFontUI();
};

// 3. UI ç•Œé¢åŒæ­¥
window.updateFontUI = function() {
    const pMain = document.getElementById('preview-text-main');
    const pDesk = document.getElementById('preview-text-desktop');
    const cfg = window.currentFontConfig;
    
    // ç”Ÿæˆé¢„è§ˆæ ·å¼
    const fontBase = `font-family:${cfg.family}; font-size:${cfg.size}px; font-weight:${cfg.weight};`;

    if(pMain) pMain.style.cssText = fontBase + `color:${cfg.colorMain}; text-align:center;`;
    if(pDesk) pDesk.style.cssText = fontBase + `color:${cfg.colorDesktop}; text-align:center; text-shadow:0 1px 2px rgba(0,0,0,0.2);`;
    
    // åŒæ­¥è°ƒè‰²ç›˜æ–‡å­—
    if(document.getElementById('color-val-main')) document.getElementById('color-val-main').textContent = cfg.colorMain.toUpperCase();
    if(document.getElementById('color-val-desktop')) document.getElementById('color-val-desktop').textContent = cfg.colorDesktop.toUpperCase();
};

// 4. é¢œè‰²å˜åŠ¨å®æ—¶è§¦å‘
window.updateColorPreview = function(target, val) {
    if(target === 'main') window.currentFontConfig.colorMain = val;
    else window.currentFontConfig.colorDesktop = val;
    window.updateFontUI();
};

// 5. ä¿å­˜å¹¶åº”ç”¨åˆ°å…¨å±€ (åªæ”¹çš®è‚¤ï¼Œä¸æ”¹åœ°åŸº)
window.saveFontSettings = function() {
    localStorage.setItem('ios_font_config', JSON.stringify(window.currentFontConfig));
    window.applyGlobalStyles(); // åº”ç”¨åˆ°å…¨å±€é’©å­
    showToast("Display Settings Applied!");
    closeSubPage('subpage-display');
};

// 6. å…¨å±€æ ·å¼é’©å­ (ä¿æŠ¤æ¡Œé¢å¸ƒå±€çš„æ ¸å¿ƒ)
window.applyGlobalStyles = function() {
    const target = document.body; // æŠŠå˜é‡æŒ‚åœ¨ body ä¸Š
    const cfg = window.currentFontConfig;
    
    target.style.setProperty('--dynamic-font-family', cfg.family);
    target.style.setProperty('--dynamic-app-size', cfg.size + 'px');
    target.style.setProperty('--dynamic-app-weight', cfg.weight);
    target.style.setProperty('--dynamic-app-color', cfg.colorMain);
    target.style.setProperty('--dynamic-desktop-color', cfg.colorDesktop);
};

// 7. è¿›å…¥é¡µé¢æ—¶çš„åŠ è½½é€»è¾‘
window.loadFontSettings = function() {
    const cfg = window.currentFontConfig;
    // åŒæ­¥è°ƒè‰²ç›˜
    if(document.getElementById('color-picker-main')) document.getElementById('color-picker-main').value = cfg.colorMain;
    if(document.getElementById('color-picker-desktop')) document.getElementById('color-picker-desktop').value = cfg.colorDesktop;
    // åŒæ­¥æ»‘åŠ¨æ¡
    const fs = document.getElementById('font-size-slider');
    const fw = document.getElementById('font-weight-slider');
    if(fs) { fs.value = cfg.size; updateSliderFill(fs); }
    if(fw) { fw.value = cfg.weight; updateSliderFill(fw); }
    
    window.updateFontUI();
};
// 1. ç¡®ä¿å…¨å±€å˜é‡é¦–å…ˆè¢«åˆå§‹åŒ–
window.currentFontConfig = JSON.parse(localStorage.getItem('ios_font_config')) || {
    family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
    size: 16,
    weight: 400,
    colorMain: '#1d1d1f',
    colorDesktop: '#1d1d1f'
};

// 2. è¡¥å…¨ç¼ºå¤±çš„ openFontPicker å‡½æ•°
window.openFontPicker = function() {
    const list = document.getElementById('model-sheet-list');
    const sheet = document.getElementById('modelPickerSheet');
    const title = document.querySelector('.sheet-title-box');
    
    if(!list || !sheet) return;

    title.textContent = "Select Font Style";
    list.innerHTML = `
        <div class="sheet-item" onclick="window.selectFont('default')">System Default</div>
        <div class="sheet-item" style="font-family: serif;" onclick="window.selectFont('serif')">Serif (Classic)</div>
        <div class="sheet-item" style="font-family: monospace;" onclick="window.selectFont('mono')">Monospace (Code)</div>
    `;
    sheet.style.display = 'flex';
};

window.selectFont = function(type) {
    if(type === 'default') window.currentFontConfig.family = '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif';
    else if(type === 'serif') window.currentFontConfig.family = '"Times New Roman", Times, serif';
    else if(type === 'mono') window.currentFontConfig.family = '"Courier New", Courier, monospace';
    
    window.updateFontUI();
    document.getElementById('modelPickerSheet').style.display = 'none';
};

// 3. è¡¥å…¨ handleFontUpload å‡½æ•°
window.handleFontUpload = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        showToast("Importing Font...");
        reader.onload = function(e) {
            const fontData = e.target.result;
            const customFont = new FontFace('UserFont', `url(${fontData})`);
            customFont.load().then(f => {
                document.fonts.add(f);
                window.currentFontConfig.family = 'UserFont, sans-serif';
                window.currentFontConfig.fontDataUrl = fontData;
                window.updateFontUI();
                showToast("Font Loaded!");
            });
        };
        reader.readAsDataURL(input.files[0]);
    }
};

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åº”ç”¨ä¸€æ¬¡é¢œè‰²
window.applyGlobalStyles();

// ä½¿ç”¨ window ç¡®ä¿å…¨å±€å¯è§
window.currentEditingField = "";

// --- 1. ç»Ÿä¸€ ID æ˜ å°„å‡½æ•° (ç¡®ä¿ç²¾å‡†å®šä½) ---
window.getHubElementId = function(field) {
    if (field === 'hero') return 'hub-hero-img';
    if (field === 'moment_img') return 'hub-moment-img';
    if (field === 'vibe_img') return 'hub-vibe-img'; // ä¸º Row 5 å‡†å¤‡
    
    // å¤„ç† app å›¾æ ‡å’Œåå­—
    if (field.startsWith('app')) {
        const num = field.match(/\d+/)[0];
        return field.includes('img') ? `hub-app-img-${num}` : `hub-app-name-${num}`;
    }
    
    // å¤„ç†æ™®é€šæ–‡å­—: moment_title -> hub-moment-title
    return 'hub-' + field.replace(/_/g, '-');
};

// --- 2. æ‰“å¼€ç¼–è¾‘å™¨ (ä¿®å¤äº†å›¾ç‰‡è¯†åˆ«é€»è¾‘) ---
window.editHubField = function(field) {
    console.log("å½“å‰ç‚¹å‡»å­—æ®µ:", field); // è°ƒè¯•ç”¨ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹æœ‰æ²¡æœ‰ç‚¹å¯¹
    window.currentEditingField = field;
    
    const modal = document.getElementById('p2-editor-modal');
    const titleEl = document.getElementById('p2-editor-title');
    const inputEl = document.getElementById('p2-main-input');
    const uploadArea = document.getElementById('p2-upload-area');

    if (!modal) return;
    modal.style.display = 'flex';

    // === æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¼ºåˆ¶å›¾ç‰‡ç™½åå• ===
    // åªè¦å­—æ®µåæ˜¯ heroï¼Œæˆ–è€…åŒ…å« 'img'ï¼Œå°±å¼ºåˆ¶åˆ¤å®šä¸ºå›¾ç‰‡
    const isImageField = (field === 'hero') || (field.indexOf('img') !== -1);

    if (isImageField) {
        // --- å›¾ç‰‡æ¨¡å¼ ---
        titleEl.textContent = "æ›´æ¢å›¾ç‰‡ (URLæˆ–ä¸Šä¼ )";
        if (uploadArea) uploadArea.style.display = 'block';
        if (inputEl) {
            inputEl.placeholder = "ç²˜è´´å›¾ç‰‡é“¾æ¥...";
            inputEl.value = ""; // å›¾ç‰‡æ¨¡å¼ä¸‹æ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢è¯¯æ˜¾ç¤ºBase64ä»£ç 
        }
    } else {
        // --- æ–‡å­—æ¨¡å¼ ---
        titleEl.textContent = "ä¿®æ”¹æ–‡å­—å†…å®¹";
        if (uploadArea) uploadArea.style.display = 'none';
        
        // è·å–å½“å‰æ–‡å­—å¹¶å›å¡«
        let currentText = "";
        const targetId = window.getHubElementId(field);
        const targetEl = document.getElementById(targetId);
        if (targetEl) {
            currentText = targetEl.textContent.replace(/"/g, ''); 
        }
        if (inputEl) {
            inputEl.value = currentText;
            inputEl.placeholder = "è¾“å…¥æ–°å†…å®¹...";
        }
    }
};

// --- 3. åº”ç”¨ä¿®æ”¹ ---
window.applyP2Changes = function(field, value) {
    if (!value) return;

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    try {
        localStorage.setItem(`hub_p2_${field}`, value);
    } catch (e) {
        // å¦‚æœå›¾ç‰‡æ˜¯ Base64 ä¸”å¤ªå¤§ï¼Œä¼šè§¦å‘è¿™ä¸ªé”™è¯¯
        console.error("å­˜å‚¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡ä½“ç§¯è¿‡å¤§:", e);
        if (field.indexOf('img') !== -1) {
            alert("ä¿å­˜å¤±è´¥ï¼šå›¾ç‰‡ä½“ç§¯è¶…è¿‡æµè§ˆå™¨é™åˆ¶ï¼Œè¯·å°è¯•ä½¿ç”¨å›¾ç‰‡é“¾æ¥(URL)ã€‚");
            return;
        }
    }

    // åŒæ­¥åˆ°é¡µé¢ DOM
    const targetId = window.getHubElementId(field);
    const el = document.getElementById(targetId);

    if (el) {
        const isImage = field === 'hero' || field.indexOf('img') !== -1;
        if (isImage) {
            el.src = value;
        } else {
            el.textContent = (field.indexOf('desc') !== -1) ? `"${value}"` : value;
        }
    }
};

// --- 4. åˆå§‹åŒ– ---
const P2_PERSIST_FIELDS = [
    'hero', 'hero_tag', 'hero_title', 'hero_desc',           // Row 1-2
    'moment_img', 'moment_title', 'moment_desc',           // Row 3-4 Card
    'vibe_img', 'vibe_text',                                // Row 5 Bar
    'app3_img', 'app3_name', 'app4_img', 'app4_name',       // Row 3-4 Apps
    'app5_img', 'app5_name', 'app6_img', 'app6_name',       // Row 3-4 Apps
    'app7_img', 'app7_name', 'app8_img', 'app8_name'        // Row 6 Apps
];

// --- 2. é¡µé¢åŠ è½½åˆå§‹åŒ–ï¼šä»æœ¬åœ°å­˜å‚¨è¿˜åŸå†…å®¹ ---
window.initP2Data = function() {
    console.log("æ­£åœ¨åŒæ­¥ç¬¬äºŒé¡µæ•°æ®...");
    
    P2_PERSIST_FIELDS.forEach(field => {
        const savedValue = localStorage.getItem(`hub_p2_${field}`);
        
        if (savedValue) {
            // è·å–å¯¹åº”çš„ HTML å…ƒç´  ID
            const targetId = window.getHubElementId(field);
            const el = document.getElementById(targetId);
            
            if (el) {
                // åˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡å­—å¹¶è¿˜åŸ
                const isImage = field === 'hero' || field.indexOf('img') !== -1;
                if (isImage) {
                    el.src = savedValue;
                } else {
                    // å¦‚æœæ˜¯æè¿°ç±»æ–‡å­—ï¼Œè‡ªåŠ¨è¡¥ä¸Šå¼•å·
                    el.textContent = (field.indexOf('desc') !== -1) ? `"${savedValue}"` : savedValue;
                }
            }
        }
    });
};

// å¼¹çª—å…³é—­ä¸æ–‡ä»¶å¤„ç†é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
window.closeP2Editor = function() {
    const val = document.getElementById('p2-main-input').value;
    if (val) window.applyP2Changes(window.currentEditingField, val);
    document.getElementById('p2-editor-modal').style.display = 'none';
};
window.handleP2File = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            window.applyP2Changes(window.currentEditingField, e.target.result);
            document.getElementById('p2-editor-modal').style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
    }
};
document.addEventListener('DOMContentLoaded', window.initP2Data);

    let tempImg = null;       
    let tempVid = null;       
    let tempVidThumb = null;

    let editingCharId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘/æŸ¥çœ‹çš„è§’è‰²ID
    let tempCharAvatar = null; // æš‚å­˜å¤´åƒ
    
// === 0. æ•°æ®åº“å·¥å…· (è§£å†³è§†é¢‘æ— æ³•ä¿å­˜çš„é—®é¢˜) ===
const dbName = "WallDB";
const storeName = "wallpapers";

// ==========================================
// ğŸ—„ï¸ æ ¸å¿ƒæ•°æ®åº“å¼•æ“ï¼šç‰©ç†å¼ºåˆ¶å¼€è’ç‰ˆ
// ==========================================
function openDB() {
    return new Promise((resolve, reject) => {
        // ğŸš¨ æ ¸å¿ƒï¼šæå‡ç‰ˆæœ¬å·åˆ° 10ï¼Œç‰©ç†å¼ºåˆ¶è§¦å‘ onupgradeneeded
        const req = indexedDB.open("WallDB", 10); 

        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            console.log("%c[Database] æ£€æµ‹åˆ°åè®®å‡çº§ï¼Œæ­£åœ¨ç‰©ç†åˆ›å»ºå­˜å‚¨ç©ºé—´...", "color: #FF9500; font-weight: bold;");

            // 1. åŸºç¡€å­˜å‚¨
            if (!db.objectStoreNames.contains("wallpapers")) db.createObjectStore("wallpapers", { keyPath: "id" });
            if (!db.objectStoreNames.contains("chat_history")) db.createObjectStore("chat_history", { keyPath: "contactId" });
            if (!db.objectStoreNames.contains("chat_list")) db.createObjectStore("chat_list", { keyPath: "id" });
            if (!db.objectStoreNames.contains("world_list")) db.createObjectStore("world_list", { keyPath: "id" });
            if (!db.objectStoreNames.contains("chat_friends")) db.createObjectStore("chat_friends", { keyPath: "id" });
            if (!db.objectStoreNames.contains("chat_groups")) db.createObjectStore("chat_groups", { keyPath: "id" });

            // ğŸš¨ é‡ç‚¹ï¼šç‰©ç†åˆ›å»ºè¡¨æƒ…åŒ…ä»“åº“
            if (!db.objectStoreNames.contains("emoji_library")) {
                db.createObjectStore("emoji_library", { keyPath: "tag" }); 
                console.log("âœ… Emoji Library ç©ºé—´åˆ›å»ºæˆåŠŸ");
            }
        };

        req.onsuccess = () => resolve(req.result);
        req.onerror = () => {
            console.error("Database Error:", req.error);
            reject(req.error);
        };
    });
}

// è¾…åŠ©ï¼šä¿å­˜å•æ¡æ¶ˆæ¯
async function saveChatMessage(contactId, msgObj) {
    const db = await openDB();
    const tx = db.transaction("chat_history", "readwrite");
    const store = tx.objectStore("chat_history");
    const req = store.get(contactId);
    
    return new Promise((resolve) => {
        req.onsuccess = async () => {
            let data = req.result ? req.result.messages : [];
            data.push(msgObj);
            store.put({ contactId: contactId, messages: data });
            // ğŸš¨ è¿™é‡Œåˆ æ‰äº† window.autoSummaryAuditor(contactId);
            resolve();
        };
    });
}

// è¾…åŠ©ï¼šè·å–æŸä¸ªäººçš„å†å²è®°å½•
async function getChatHistory(contactId) {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction("chat_history", "readonly");
        const store = tx.objectStore("chat_history");
        const req = store.get(contactId);
        req.onsuccess = () => resolve(req.result ? req.result.messages : []);
    });
}

async function saveToDB(key, data) {
    const db = await openDB();
    const tx = db.transaction(storeName, "readwrite");
    tx.objectStore(storeName).put({ id: key, data: data });
}

async function loadFromDB(key) {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction(storeName, "readonly");
        const req = tx.objectStore(storeName).get(key);
        req.onsuccess = () => resolve(req.result ? req.result.data : null);
    });
}
    // === ä¿®å¤é‡ç‚¹3ï¼šæ•°æ®æŒä¹…åŒ– (åˆ·æ–°ä¸ä¸¢å¤±) ===
    async function loadSavedData() {
        // 1. åŠ è½½æ¡Œé¢å°ç»„ä»¶æ•°æ® (å›¾ç‰‡ã€é‡‘å¥ã€åŸå¸‚) - ä» localStorage
        const sImg = localStorage.getItem('ios_img');
        const sQuote = localStorage.getItem('ios_quote');
        const sCity = localStorage.getItem('ios_city');

        if(sImg) document.getElementById('ui-img').src = sImg;
        if(sQuote) document.getElementById('ui-quote').textContent = `"${sQuote}"`;
        
        if(sCity) {
            const c = JSON.parse(sCity);
            fetchW(c.lat, c.lon, c.name);
        } else {
            fetchW(40.7829, -73.9654, 'New York');
        }

        // 2. åŠ è½½å£çº¸æ•°æ® - ä» IndexedDB (å¤§æ–‡ä»¶å­˜å‚¨)
        const wType = localStorage.getItem('user_wall_type');
        const wData = await loadFromDB('current_wall_data');
        
        if(wType && wData) {
            const bgVid = document.getElementById('bg-video');

            if(wType === 'img') {
                // åº”ç”¨å›¾ç‰‡å£çº¸
                document.body.style.background = `url(${wData}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                // ç¡®ä¿è§†é¢‘å±‚éšè—
                if(bgVid) { 
                    bgVid.style.display = 'none'; 
                    bgVid.src = ""; 
                }
            } else if(wType === 'vid') {
                // åº”ç”¨è§†é¢‘å£çº¸
                if(bgVid) {
                    bgVid.src = wData;
                    bgVid.style.display = 'block';
                    bgVid.play().catch(e => console.log("Auto-play blocked"));
                }
            }
        }
        
        // 3. åŠ è½½å£çº¸å†å²è®°å½•åˆ—è¡¨
        renderHistory();
        await initCharApp();
        await initWorldApp();
        applyBackgroundsToUI();
    }

    // ==========================================
    // 3. æ ¸å¿ƒåŠŸèƒ½: æ—¶é—´ (å…¨å±€æ—¶åŒºé‡å†™ç‰ˆ)
    // ==========================================
    
    // æ‰“å¼€å­é¡µé¢é€šç”¨å‡½æ•°
// ğŸš¨ å¼ºåŠ›ä¿®æ­£ï¼šè§£å†³å­é¡µé¢å…³é—­åæ— æ³•å†æ¬¡å¼€å¯çš„é—®é¢˜
function openSubPage(id) {
    const el = document.getElementById(id);
    if(el) {
        // ç¬¬ä¸€æ­¥ï¼šç‰©ç†æ˜¾å½¢ï¼ˆå¿…é¡»å…ˆ flexï¼ŒåŠ¨ç”»æ‰èƒ½ç”Ÿæ•ˆï¼‰
        el.style.display = 'flex'; 
        
        // ç¬¬äºŒæ­¥ï¼šè§¦å‘æ»‘å…¥åŠ¨ç”»ï¼ˆå»¶è¿Ÿä¸€ä¸ç‚¹ç¡®ä¿æµè§ˆå™¨æ•è·åˆ° display å˜åŒ–ï¼‰
        setTimeout(() => {
            el.classList.add('active');
        }, 10);

        // å¦‚æœæ˜¯æ—¶åŒºé¡µï¼Œé¡ºä¾¿æ›´æ–°ä¸€ä¸‹å‹¾é€‰çŠ¶æ€
        if(id === 'subpage-timezone' && typeof updateTimezoneCheckmarks === 'function') {
            updateTimezoneCheckmarks();
        }
        console.log(`System: ç‰©ç†é“¾è·¯å·²æ¥é€š -> ${id}`);
    } else {
        console.error("æ‰¾ä¸åˆ°å­é¡µé¢:", id);
    }
}

// å…³é—­å­é¡µé¢
function closeSubPage(id) {
    const el = document.getElementById(id);
    if(el) el.classList.remove('active');
}

    // è®¾ç½®æ—¶åŒº
    function setTimezone(tzVal, cityName) {
        if(tzVal === '') {
            localStorage.removeItem('user_timezone');
            localStorage.removeItem('user_city_name');
            document.getElementById('val-timezone').textContent = "Automatic";
        } else {
            localStorage.setItem('user_timezone', tzVal);
            localStorage.setItem('user_city_name', cityName);
            document.getElementById('val-timezone').textContent = cityName;
        }
        
        // ç«‹å³åˆ·æ–°æ—¶é—´æ˜¾ç¤º
        tick();
        
        // è§†è§‰åé¦ˆ
        updateTimezoneCheckmarks();
        setTimeout(() => closeSubPage('subpage-timezone'), 200); // é€‰å®Œè‡ªåŠ¨è¿”å›ï¼Œä½“éªŒæ›´å¥½
    }

    // æ›´æ–°åˆ—è¡¨å‹¾é€‰çŠ¶æ€
    function updateTimezoneCheckmarks() {
        // æ¸…é™¤æ‰€æœ‰å‹¾
        document.querySelectorAll('.item-check').forEach(el => el.classList.remove('active'));
        
        const currentTz = localStorage.getItem('user_timezone');
        if(!currentTz) {
            document.getElementById('check-auto').classList.add('active');
        } else {
            // IDé‡Œå¯èƒ½æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œä½¿ç”¨ getElementById éœ€è¦è½¬ä¹‰ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼š
            // å› ä¸ºæˆ‘çš„ ID æ˜¯ check-Asia/Shanghai è¿™ç§æ ¼å¼
            const target = document.getElementById('check-' + currentTz);
            if(target) target.classList.add('active');
        }
    }

    // â° æ ¸å¿ƒæ—¶é—´å‡½æ•° (æ”¯æŒæ—¶åŒº) â°
    function tick() {
        const tz = localStorage.getItem('user_timezone'); // è·å–å­˜å‚¨çš„æ—¶åŒº
        const now = new Date();
        
        // 1. è·å–æ—¶é—´å­—ç¬¦ä¸²
        let timeString;
        try {
            // ä½¿ç”¨ Intl API è½¬æ¢æ—¶åŒº
            timeString = now.toLocaleTimeString('en-GB', {
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false,
                timeZone: tz || undefined // å¦‚æœ tz ä¸ºç©ºï¼Œå°±ç”¨ç³»ç»Ÿé»˜è®¤
            });
        } catch(e) {
            // å…œåº•ï¼šå¦‚æœæ—¶åŒºæ ¼å¼ä¸å¯¹ï¼Œå›é€€åˆ°æœ¬åœ°æ—¶é—´
            timeString = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
        }

        document.getElementById('clock').textContent = timeString;

        // 2. æ—¥æœŸæ˜¾ç¤º (ä¹Ÿéœ€è¦æ ¹æ®æ—¶åŒºå˜)
        const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
        const months = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
        
        // ä¸ºäº†è·å–æ­£ç¡®çš„æ—¥æœŸï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨è¯¥æ—¶åŒºä¸‹çš„ Date å¯¹è±¡æ¦‚å¿µ
        // è¿™é‡Œç”¨ç®€å•çš„ toLocaleDateString è½¬æ¢
        const dateOptions = { weekday: 'long', month: 'long', day: 'numeric', timeZone: tz || undefined };
        const dateStrParts = now.toLocaleDateString('en-US', dateOptions).toUpperCase().split(', ');
        // dateStrParts å¤§æ¦‚æ˜¯ ["SUNDAY", "JANUARY 1"] è¿™ç§æ ¼å¼
        
        if(dateStrParts.length >= 2) {
            document.getElementById('ui-day').textContent = dateStrParts[0]; // æ˜ŸæœŸ
            // å‰©ä¸‹çš„éƒ¨åˆ†å»æ‰å¹´ä»½ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            let datePart = dateStrParts[1]; 
            document.getElementById('ui-date').textContent = datePart;
        }

        // 3. è¿›åº¦æ¡ (æ ¹æ®å°æ—¶è®¡ç®—)
        // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è§£æåˆšåˆšç”Ÿæˆçš„ timeString (HH:MM)
        const [hh, mm] = timeString.split(':').map(Number);
        const totalSec = hh * 3600 + mm * 60 + now.getSeconds();
        const percent = (totalSec / 86400) * 100;
        
        const bar = document.getElementById('prog-bar');
        if(bar) {
            bar.style.width = percent + '%';
            if(percent < 1) bar.style.minWidth = '2%';
        }
        const txt = document.getElementById('prog-txt');
        if(txt) txt.textContent = percent.toFixed(1) + '%';
        
        // åˆå§‹åŒ–æ—¶æ›´æ–°è®¾ç½®é¡µçš„æ–‡å­—çŠ¶æ€
        const savedCity = localStorage.getItem('user_city_name');
        const valTz = document.getElementById('val-timezone');
        if(valTz) valTz.textContent = savedCity || "Automatic";
    }

    async function initBat() {
        const batNum = document.getElementById('bat-num');
        const batBar = document.getElementById('bat-bar');

        // 1. ã€å¼ºåˆ¶å…œåº•ã€‘ï¼šå…ˆæŠŠæ•°å­—å¡«ä¸Šå»ï¼Œä¿è¯ç»å¯¹æœ‰æ˜¾ç¤ºï¼
        batNum.textContent = '100%'; 
        batBar.style.width = '100%';
        batBar.style.background = '#1d1d1f'; // é»˜è®¤é»‘è‰²

        // 2. å°è¯•è·å–çœŸå®ç”µé‡ (ä»…å®‰å“/PCæœ‰æ•ˆ)
        if ('getBattery' in navigator) {
            try {
                const bat = await navigator.getBattery();
                
                const update = () => {
                    const level = Math.round(bat.level * 100);
                    batNum.textContent = level + '%';
                    batBar.style.width = level + '%';
                    
                    if(bat.charging) {
                        batBar.style.background = '#34C759'; // å……ç”µç»¿
                    } else if(level <= 20) {
                        batBar.style.background = '#FF3B30'; // ä½ç”µé‡çº¢
                    } else {
                        batBar.style.background = '#1d1d1f'; // æ­£å¸¸é»‘
                    }
                };
                
                update();
                bat.addEventListener('levelchange', update);
                bat.addEventListener('chargingchange', update);
            } catch (e) {
                // å¦‚æœæŠ¥é”™ï¼Œæ²¡å…³ç³»ï¼Œåæ­£ç¬¬1æ­¥å·²ç»å¡«äº† 100%
                console.log("ç”µé‡APIå—é™ï¼Œä¿æŒå…œåº•æ˜¾ç¤º");
            }
        }
    }

    const ICONS = {
        sun: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSun" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient></defs><circle cx="32" cy="32" r="18" fill="url(#gSun)"/><circle cx="32" cy="32" r="24" fill="none" stroke="#FFD700" stroke-width="2" opacity="0.4"/></svg>`,
        moon: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gMoon" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#E0E0E0"/><stop offset="100%" stop-color="#BDBDBD"/></linearGradient></defs><path d="M48 32c0 11-9 20-20 20-2.5 0-4.8-.5-7-1.3 2.5-1.5 5.5-2.7 8-5.7 6-7 4-18-2-22-2.3-1.5-5-2.2-7.7-2.3C22.6 14.5 27 12 32 12c11 0 16 9 16 20z" fill="url(#gMoon)"/></svg>`,
        partly: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><radialGradient id="gSunS" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#FFD700"/><stop offset="100%" stop-color="#FF8C00"/></radialGradient><linearGradient id="gCloud" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#fff"/><stop offset="100%" stop-color="#d9d9d9"/></linearGradient></defs><circle cx="24" cy="24" r="14" fill="url(#gSunS)"/><path d="M48 48H30c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5-3.5 15.8-12 15.8z" fill="url(#gCloud)" filter="drop-shadow(0 2px 3px rgba(0,0,0,0.2))"/></svg>`,
        cloud: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gCloudF" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#c0c0c0"/></linearGradient></defs><path d="M46 44H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gCloudF)" filter="drop-shadow(0 4px 6px rgba(0,0,0,0.1))"/></svg>`,
        rain: `<svg viewBox="0 0 64 64" style="width:100%;height:100%"><defs><linearGradient id="gRain" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#cfd9df"/><stop offset="100%" stop-color="#a1c4fd"/></linearGradient></defs><path d="M46 40H18c-5.5 0-10-4.5-10-10 0-5.3 4.1-9.6 9.3-9.9.5-4.4 4.3-7.9 8.7-7.9 4.9 0 9 3.6 9.8 8.3 1.4.6 2.2 2 2.2 3.7 0 5.5 8 15.8 18 15.8z" fill="url(#gRain)"/><path d="M22 46l-3 9M32 46l-3 9M42 46l-3 9" stroke="#4facfe" stroke-width="3" stroke-linecap="round"/></svg>`
    };
    
    async function fetchW(lat,lon,name) {
        document.getElementById('ui-city').textContent = name;
        hideM('weatherM');
        localStorage.setItem('ios_city', JSON.stringify({lat, lon, name})); // ä¿å­˜åŸå¸‚

        try {
            const tStamp = new Date().getTime();
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day&timezone=auto&_t=${tStamp}`);
            const data = await res.json();
            const current = data.current;
            const c = current.weather_code;
            const t = Math.round(current.temperature_2m);
            const isDay = current.is_day === 1;

            // --- ğŸš‘ æ–°å¢ï¼šåŒæ­¥åˆ°è®¾ç½®é¡µé¢çš„å¤©æ°”æ–‡å­— ---
            let weatherDesc = "æ™´";
            if (c >= 1 && c <= 2) weatherDesc = "å¤šäº‘";
            else if (c === 3 || (c >= 45 && c <= 48)) weatherDesc = "é˜´";
            else if (c > 3) weatherDesc = "æœ‰é›¨";

            const weatherStatusEl = document.getElementById('val-weather-text');
            if (weatherStatusEl) {
                weatherStatusEl.textContent = `${weatherDesc} ${t}Â°C`;
            }
            
            let icon = ICONS.sun;
            if (c === 0) icon = isDay ? ICONS.sun : ICONS.moon;
            else if (c >= 1 && c <= 2) icon = ICONS.partly;
            else if (c === 3 || (c >= 45 && c <= 48)) icon = ICONS.cloud;
            else icon = ICONS.rain;
            
            document.getElementById('ui-temp').textContent = t+'Â°';
            document.getElementById('ui-icon').innerHTML = icon;
        } catch(e) { document.getElementById('ui-city').textContent = "Offline"; }
    }

    function showM(id) { document.getElementById(id).style.display='flex'; }
    function hideM(id) { 
        document.getElementById(id).style.display='none'; 
        if(id==='photoM') {
            const v = document.getElementById('q-in').value;
            if(v) {
                document.getElementById('ui-quote').textContent = `"${v}"`;
                localStorage.setItem('ios_quote', v); // ä¿å­˜æ–‡å­—
            }
        }
    }
    
    function loadF(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const imgData = e.target.result;
                document.getElementById('ui-img').src = imgData;
                try {
                    localStorage.setItem('ios_img', imgData); // ä¿å­˜å›¾ç‰‡
                } catch(err) { alert("å›¾ç‰‡å¤ªå¤§ï¼Œå»ºè®®ç”¨URL"); }
            };
            r.readAsDataURL(input.files[0]);
        }
    }
    
    function loadU() {
        const u = prompt("Paste Image URL:");
        if(u) {
            document.getElementById('ui-img').src = u;
            localStorage.setItem('ios_img', u); // ä¿å­˜å›¾ç‰‡URL
        }
    }

    // å¯åŠ¨
    setInterval(tick,1000); 
    loadSavedData(); // åŠ è½½æ‰€æœ‰ä¿å­˜çš„æ•°æ®
    initBat();

    // åˆ‡æ¢æ ‡ç­¾é¡µåŠŸèƒ½
function switchTab(tab) {
    // 1. å¤„ç†æŒ‰é’®æ ·å¼
    document.getElementById('tab-cn').classList.remove('active');
    document.getElementById('tab-global').classList.remove('active');
    document.getElementById('tab-' + tab).classList.add('active');

    // 2. å¤„ç†å†…å®¹æ˜¾ç¤º
    document.getElementById('view-cn').classList.remove('active');
    document.getElementById('view-global').classList.remove('active');
    document.getElementById('view-' + tab).classList.add('active');
}

// === å£çº¸ App å¢å¼ºç‰ˆé€»è¾‘ ===
    
    // åˆå§‹åŒ–æ—¶åŠ è½½å†å²
    setTimeout(renderHistory, 500);

    function openApp(id) { 
        document.getElementById(id).classList.add('active'); 
        renderHistory(); // æ¯æ¬¡æ‰“å¼€åˆ·æ–°å†å²
    }
    function closeApp(id) { document.getElementById(id).classList.remove('active'); }

    // 1. åˆ‡æ¢ Tab (ä¿®å¤é¢„è§ˆå›¾ä¹±è·‘çš„é—®é¢˜)
    function switchWallTab(type) {
        // æŒ‰é’®æ ·å¼åˆ‡æ¢
        document.getElementById('seg-img').classList.toggle('active', type==='img');
        document.getElementById('seg-vid').classList.toggle('active', type==='vid');
        
        // æ“ä½œé¢æ¿åˆ‡æ¢
        document.getElementById('panel-img').style.display = type==='img' ? 'flex' : 'none';
        document.getElementById('panel-vid').style.display = type==='vid' ? 'flex' : 'none';
        
        // é¢„è§ˆé€»è¾‘é‡å†™ï¼šåªæœ‰å½“æœ‰å†…å®¹æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼Œå¦åˆ™æ˜¾ç¤ºå ä½ç¬¦
        const imgEl = document.getElementById('preview-img');
        const vidEl = document.getElementById('preview-vid');
        const hintEl = document.getElementById('preview-hint');

        if(type === 'img') {
            vidEl.style.display = 'none'; // è—è§†é¢‘
            // å¦‚æœæœ‰æš‚å­˜å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼›å¦åˆ™æ˜¾ç¤ºæ–‡å­—
            if(tempImg) {
                imgEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                imgEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Image";
            }
        } else {
            imgEl.style.display = 'none'; // è—å›¾ç‰‡
            // å¦‚æœæœ‰æš‚å­˜è§†é¢‘ï¼Œæ˜¾ç¤ºè§†é¢‘
            if(tempVid) {
                vidEl.style.display = 'block';
                hintEl.style.display = 'none';
            } else {
                vidEl.style.display = 'none';
                hintEl.style.display = 'block';
                hintEl.textContent = "No Video";
            }
        }
    }

    // 2. ä¿å­˜å†å²è®°å½•
    saveToHistory(type, data);
    
    showNativeAlert("Wallpaper Set & Saved!");

    // 2. æ–‡ä»¶å¤„ç† (å…¼å®¹æ€§å¢å¼º)
    function handleWallFile(input, type) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            
            // è§†é¢‘å¤§å°é™åˆ¶ (é¿å…å¡æ­»)
            if(type === 'vid' && file.size > 20 * 1024 * 1024) { 
                showNativeAlert("Video too large! Max 20MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const res = e.target.result;
                if(type === 'img') {
                    tempImg = res;
                    document.getElementById('preview-img').src = res;
                } else {
                    tempVid = res;
                    document.getElementById('preview-vid').src = res;
                }
                // åŠ è½½å®Œç«‹åˆ»åˆ·æ–°é¢„è§ˆåŒºåŸŸ
                switchWallTab(type);
            };
            reader.readAsDataURL(file);
        }
    }

    // 3. è®¾ç½®å£çº¸ (è°ƒç”¨æ–°å¼¹çª— + å¼ºåˆ¶ä¿å­˜)
    // æ‰¾åˆ° setWallpaper å‡½æ•°ï¼Œå®Œå…¨æ›¿æ¢æˆè¿™ä¸ªï¼š
    // âœ… ä¿®å¤åçš„ setWallpaper å‡½æ•°
function setWallpaper(cType) {
    const bgVid = document.getElementById('bg-video');
    // cType æ˜¯ 'img' æˆ– 'vid'
    const data = (cType === 'img') ? tempImg : tempVid;

    if(!data) { 
        showNativeAlert("Please select a file first.");
        return; 
    }

    if(cType === 'img') {
        document.body.style.background = `url(${data}) no-repeat center center fixed`;
        document.body.style.backgroundSize = "cover";
        if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
        
        // ä¿å­˜é€»è¾‘å¿…é¡»åœ¨å‡½æ•°é‡Œé¢
        localStorage.setItem('user_wall_type', 'img');
        saveToDB('current_wall_data', data);
        
        // ä¿å­˜å†å²
        saveToHistory('img', data, data); 

    } else {
        if(bgVid) {
            bgVid.src = data;
            bgVid.style.display = 'block';
            bgVid.play();
        }
        
        localStorage.setItem('user_wall_type', 'vid');
        saveToDB('current_wall_data', data);
        
        // ä¿å­˜å†å²
        saveToHistory('vid', data, tempVidThumb || null); 
    }
    
    showNativeAlert("Wallpaper Set Successfully!");
}

    // 5. å¼¹çª—æ§åˆ¶å‡½æ•°
    function showNativeAlert(msg) {
        document.getElementById('alert-msg').textContent = msg;
        document.getElementById('successAlert').style.display = 'flex';
    }
    function closeAlert() {
        document.getElementById('successAlert').style.display = 'none';
    }

    // åˆå§‹åŒ–åŠ è½½å†å²
    setTimeout(renderHistory, 500);
    // ==========================================
    // ç¼ºå¤±çš„å·¥å…·å‡½æ•° (è¯·è¡¥åœ¨æœ€ä¸‹é¢)
    // ==========================================

    // 1. å¼¹çª—æç¤ºå·¥å…· (è§£å†³ showToast is not defined)
    function showToast(msg) {
        const t = document.getElementById('toast');
        if(t) {
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
    }

    // 2. ä¿å­˜å†å²è®°å½•é€»è¾‘
    async function saveToHistory(type, data) {
        // å…ˆè¯»æ—§å†å²
        let history = await loadFromDB('history_list') || [];
        
        // æŸ¥é‡ï¼šå¦‚æœå·²ç»æœ‰äº†ï¼Œåˆ æ‰æ—§çš„
        history = history.filter(item => item.data !== data);
        
        // æ’å…¥æ–°çš„åˆ°æœ€å‰é¢
        history.unshift({ type: type, data: data });
        
        // é™åˆ¶ 6 ä¸ª
        if(history.length > 6) history.pop();
        
        // å­˜å…¥æ•°æ®åº“
        await saveToDB('history_list', history);
        
        // åˆ·æ–°æ˜¾ç¤º
        renderHistory();
    }

    // 3. æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
    // === æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨ (ä¿®å¤ type is not defined æŠ¥é”™) ===
    async function renderHistory() {
    const grid = document.getElementById('wall-history-grid');
    if(!grid) return;
    
    // ä»æ•°æ®åº“è¯»å£çº¸åˆ—è¡¨
    let history = await loadFromDB('history_list') || [];
    grid.innerHTML = ""; 

    history.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        
        let badge = '';
        let content = '';
        
        // æ¸²æŸ“è§†é¢‘æˆ–å›¾ç‰‡é¢„è§ˆ
        if(item.type === 'vid') {
            badge = `<div class="vid-badge">LIVE</div>`;
            // å¦‚æœæœ‰ç¼©ç•¥å›¾ç”¨ç¼©ç•¥å›¾ï¼Œæ²¡æœ‰å°±ç”¨è§†é¢‘é¢„è§ˆ
            if(item.thumb && item.thumb.startsWith('data:image')) {
                 content = `<img src="${item.thumb}" style="opacity:0.8;">`;
            } else {
                 content = `<video src="${item.data}" autoplay loop muted playsinline style="width:100%; height:100%; object-fit:cover; pointer-events:none;"></video>`;
            }
        } else {
            content = `<img src="${item.data}">`;
        }

        div.innerHTML = `${content}${badge}`;

        // ç‚¹å‡»åº”ç”¨å£çº¸çš„é€»è¾‘
        div.onclick = () => {
            if(item.type === 'img') {
                tempImg = item.data;
                document.getElementById('preview-img').src = item.data;
                document.body.style.background = `url(${item.data}) no-repeat center center fixed`;
                document.body.style.backgroundSize = "cover";
                const bgVid = document.getElementById('bg-video');
                if(bgVid) { bgVid.style.display = 'none'; bgVid.src = ""; }
            } else {
                tempVid = item.data;
                document.getElementById('preview-vid').src = item.data;
                const bgVid = document.getElementById('bg-video');
                if(bgVid) {
                    bgVid.src = item.data;
                    bgVid.style.display = 'block';
                    bgVid.play();
                }
            }
            switchWallTab(item.type);
            localStorage.setItem('user_wall_type', item.type);
            saveToDB('current_wall_data', item.data);
            showToast("Restored!");
        };

        grid.appendChild(div);
    });
}

    // 4. åˆå§‹åŒ–åŠ è½½ä¸€æ¬¡å†å²
    setTimeout(renderHistory, 1000);

    // ==========================================
    // 8. è§’è‰²ä¹¦ App é€»è¾‘ (Character Book)
    // ==========================================

    // 1. åˆå§‹åŒ–
    async function initCharApp() {
        await renderCharList();
    }
    // åœ¨ loadSavedData çš„æœ€åè°ƒç”¨å®ƒ (æ‰‹åŠ¨åŠ ä¸€è¡Œ initCharApp();)

    // 2. è§’è‰²å¢åˆ æ”¹æŸ¥ (åŸºäº IndexedDB)
    async function getCharList() {
        return await loadFromDB('char_list') || [];
    }
    async function saveCharList(list) {
        await saveToDB('char_list', list);
    }

    // 3. æ¸²æŸ“åˆ—è¡¨
    async function renderCharList() {
        const grid = document.getElementById('char-grid');
        if(!grid) return;
        
        const list = await getCharList();
        grid.innerHTML = "";
        
        // 1. å…ˆåˆ›å»ºä¸€ä¸ª "Add New" å¡ç‰‡
        const addCard = document.createElement('div');
        addCard.className = 'char-card add-new';
        addCard.onclick = openCharModal; // ç‚¹å‡»è§¦å‘æ–°å»ºå¼¹çª—
        addCard.innerHTML = `
            <svg class="add-icon-big" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <div class="add-text">New Character</div>
        `;
        grid.appendChild(addCard);

        // 2. å†æ¸²æŸ“ç°æœ‰çš„è§’è‰²å¡ç‰‡
        list.forEach(char => {
            const card = document.createElement('div');
            card.className = 'char-card';
            card.innerHTML = `
                <img class="char-card-img" src="${char.avatar || ''}">
                <div class="char-card-info">
                    <div class="char-card-name">${char.name}</div>
                    <div class="char-card-desc">${char.desc}</div>
                </div>
            `;
            card.onclick = () => openCharDetail(char.id);
            grid.appendChild(card);
        });
        
        // (Deleted empty hint logic since we always have the add button)
    }

    // 4. æ‰“å¼€/å…³é—­ App
    function openCharModal() {
        editingCharId = null; // æ–°å»ºæ¨¡å¼
        document.getElementById('modal-title').textContent = "New Character";
        document.getElementById('char-name-in').value = "";
        document.getElementById('char-desc-in').value = "";
        document.getElementById('edit-avatar-preview').style.display = 'none';
        document.getElementById('edit-avatar-hint').style.display = 'block';
        tempCharAvatar = null;
        document.getElementById('charEditModal').style.display = 'flex';
    }
    function closeCharModal() { document.getElementById('charEditModal').style.display = 'none'; }

    // --- âš™ï¸ ä¿®æ”¹ saveCharacter å‡½æ•° ---
async function saveCharacter() {
    const name = document.getElementById('char-name-in').value;
    const desc = document.getElementById('char-desc-in').value;
    
    if(!name) { showToast("Name is required"); return; }
    
    let list = await getCharList();
    
    if(editingCharId) {
        // ä¿®æ”¹æ¨¡å¼ï¼šä¿ç•™åŸæœ‰çš„åˆ›å»ºæ—¶é—´
        const index = list.findIndex(c => c.id === editingCharId);
        if(index !== -1) {
            list[index].name = name;
            list[index].desc = desc;
            if(tempCharAvatar) list[index].avatar = tempCharAvatar;
            // ğŸš¨ æ³¨æ„ï¼šè¿™é‡Œä¸è¦åŠ¨ list[index].createdAt
        }
    } else {
        // âœ¨ æ–°å»ºæ¨¡å¼ï¼šç‰©ç†é”å®šå½“å‰æ—¶é—´ä¸ºâ€œè¯ç”Ÿæ—¶åˆ»â€
        const newChar = {
            id: Date.now().toString(),
            createdAt: Date.now(), // ğŸš¨ è®°å½•çœŸå®åˆ›å»ºæ—¶é—´æˆ³
            name: name,
            desc: desc,
            avatar: tempCharAvatar,
            boundWorldIds: [],
            relationNetwork: []
        };
        list.unshift(newChar);
    }
    
    await saveCharList(list);
    renderCharList();
    closeCharModal();
    triggerSuccessHud("äººæ ¼å·²è§‰é†’");
}

    // 6. å¤´åƒé¢„è§ˆ
    function previewCharAvatar(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                tempCharAvatar = e.target.result;
                document.getElementById('edit-avatar-preview').src = tempCharAvatar;
                document.getElementById('edit-avatar-preview').style.display = 'block';
                document.getElementById('edit-avatar-hint').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 7. è¯¦æƒ…é¡µé€»è¾‘
    async function openCharDetail(id, charObj = null) {
        let char = charObj;
        if(!char) {
            const list = await getCharList();
            char = list.find(c => c.id === id);
        }
        if(!char) return;

        editingCharId = char.id; // æ ‡è®°å½“å‰æŸ¥çœ‹çš„è§’è‰²
        
        // 1. å¡«å……è¯¦æƒ…é¡µæ•°æ® (è¿™äº› ID è¿˜åœ¨ï¼Œæ‰€ä»¥æ²¡é—®é¢˜)
        const nameEl = document.getElementById('detail-name');
        const descEl = document.getElementById('detail-desc');
        const avtEl = document.getElementById('detail-avatar');
        const bgEl = document.getElementById('detail-bg');

        if(nameEl) nameEl.textContent = char.name;
        // é¢„è§ˆåªæ˜¾ç¤ºå‰50ä¸ªå­—
        if(descEl) descEl.textContent = char.desc.substring(0, 50) + (char.desc.length > 50 ? "..." : "");
        if(avtEl) avtEl.src = char.avatar;
        
        // 2. èƒŒæ™¯å¤„ç†
        if(bgEl) {
            if(char.bg) {
                bgEl.style.backgroundImage = `url(${char.bg})`;
            } else {
                bgEl.style.backgroundColor = '#ddd';
                bgEl.style.backgroundImage = 'none';
            }
        }

        // âŒ åˆ é™¤äº†è¿™é‡ŒåŸæœ¬å¼•ç”¨ 'ins-avatar-img' çš„ä»£ç ï¼Œå› ä¸ºé‚£ä¸ªå…ƒç´ å·²ç»ä¸å­˜åœ¨äº†
        // ç°åœ¨çš„å¼¹çª—æ•°æ®å¡«å……ä¼šåœ¨ç‚¹å‡» "More" (openFullDesc) æ—¶æ‰è¿›è¡Œ

        // 3. æ˜¾ç¤ºè¯¦æƒ…é¡µ
        document.getElementById('char-detail-view').style.display = 'flex';
    }

    function closeDetailView() {
        document.getElementById('char-detail-view').style.display = 'none';
    }

    // 8. è¯¦æƒ…é¡µäº¤äº’ï¼šæ›´æ¢èƒŒæ™¯
    function openBgModal() { document.getElementById('bgChangeModal').style.display = 'flex'; }
    
    function switchBgMode(mode) {
        document.getElementById('bg-seg-file').classList.toggle('active', mode==='file');
        document.getElementById('bg-seg-url').classList.toggle('active', mode==='url');
        document.getElementById('bg-panel-file').style.display = mode==='file'?'block':'none';
        document.getElementById('bg-panel-url').style.display = mode==='url'?'block':'none';
    }

    async function handleBgFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = async e => {
                await updateCharBg(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    async function handleBgUrl() {
        const url = document.getElementById('bg-url-in').value;
        if(url) await updateCharBg(url);
    }

    async function updateCharBg(bgData) {
        let list = await getCharList();
        const index = list.findIndex(c => c.id === editingCharId);
        if(index !== -1) {
            list[index].bg = bgData;
            await saveCharList(list);
            // åˆ·æ–°ç•Œé¢
            document.getElementById('detail-bg').style.backgroundImage = `url(${bgData})`;
            document.getElementById('bgChangeModal').style.display = 'none';
            showToast("Background Updated");
        }
    }

    // === 9. è¯¦æƒ…é¡µäº¤äº’ï¼šé«˜çº§æ‚å¿—é£å±•ç¤º ===
    function openFullDesc() {
        const modal = document.getElementById('fullDescModal');
        
        // 1. è·å–åŸºç¡€æ•°æ®
        const avatarSrc = document.getElementById('detail-avatar').src;
        const nameTxt = document.getElementById('detail-name').textContent;
        
        // 2. å¡«å…… UI
        document.getElementById('aes-avatar-img').src = avatarSrc;
        document.getElementById('aes-name-txt').textContent = nameTxt;
        
        // 3. åŠ¨æ€å…‰å½±ï¼šè®¾ç½®é¡¶éƒ¨æ¨¡ç³ŠèƒŒæ™¯
        document.getElementById('aes-bg-layer').style.backgroundImage = `url(${avatarSrc})`;
        
        // 4. å¼‚æ­¥è·å–å®Œæ•´æ–‡æœ¬
        (async () => {
            const list = await getCharList();
            const fullChar = list.find(c => c.id === editingCharId);
            if(fullChar) {
                document.getElementById('aes-full-desc').textContent = fullChar.desc || "No description provided.";
            }
        })();
        
        // 5. æ˜¾ç¤º
        modal.style.display = 'flex';
    }

    function closeInsModal() {
        document.getElementById('fullDescModal').style.display = 'none';
    }

    // === æ–°å¢ï¼šç›´æ¥ä»å¼¹çª—é‡Œæ“ä½œç¼–è¾‘å’Œåˆ é™¤ ===
    
    function editCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€ç¼–è¾‘ï¼Œä½“éªŒæ›´å¥½
        setTimeout(() => {
            editCurrentChar(); // è°ƒç”¨å·²æœ‰çš„ç¼–è¾‘å‡½æ•°
        }, 200);
    }

    function deleteCurrentCharFromModal() {
        closeInsModal(); // å…³æ‰å±•ç¤ºå¡ç‰‡
        // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ‰“å¼€åˆ é™¤ç¡®è®¤
        setTimeout(() => {
            openDelConfirm(); // è°ƒç”¨å·²æœ‰çš„åˆ é™¤ç¡®è®¤å‡½æ•°
        }, 200);
    }

    // 10. è¯¦æƒ…é¡µäº¤äº’ï¼šç¼–è¾‘ä¸åˆ é™¤
    async function editCurrentChar() {
        const list = await getCharList();
        const char = list.find(c => c.id === editingCharId);
        if(char) {
            document.getElementById('modal-title').textContent = "Edit Profile";
            document.getElementById('char-name-in').value = char.name;
            document.getElementById('char-desc-in').value = char.desc;
            tempCharAvatar = char.avatar;
            document.getElementById('edit-avatar-preview').src = char.avatar;
            document.getElementById('edit-avatar-preview').style.display = 'block';
            document.getElementById('edit-avatar-hint').style.display = 'none';
            document.getElementById('charEditModal').style.display = 'flex';
        }
    }

    function openDelConfirm() { document.getElementById('delConfirmModal').style.display = 'flex'; }
    
    async function confirmDelete() {
        let list = await getCharList();
        list = list.filter(c => c.id !== editingCharId);
        await saveCharList(list);
        
        document.getElementById('delConfirmModal').style.display = 'none';
        closeDetailView();
        renderCharList();
        showToast("Character Deleted");
    }

    // === æ–°å¢ï¼šæ—¶åŒºæœç´¢åŠŸèƒ½ ===
    function filterTimezoneList(query) {
        const input = query.toLowerCase().trim();
        const items = document.querySelectorAll('.tz-item'); // è·å–æ‰€æœ‰åŸå¸‚é¡¹
        const groups = document.querySelectorAll('#tz-city-container .ios-list-group'); // è·å–åŸå¸‚åˆ†ç»„å®¹å™¨
        const titles = document.querySelectorAll('#tz-city-container .tz-group-title'); // è·å–åˆ†ç»„æ ‡é¢˜
        let hasResult = false;

        // 1. ç­›é€‰å…·ä½“çš„åŸå¸‚
        items.forEach(item => {
            const keys = item.getAttribute('data-keywords');
            if (keys.includes(input)) {
                item.style.display = 'flex'; // æ˜¾ç¤ºåŒ¹é…é¡¹
                hasResult = true;
            } else {
                item.style.display = 'none'; // éšè—ä¸åŒ¹é…é¡¹
            }
        });

        // 2. æ™ºèƒ½éšè—ï¼šå¦‚æœä¸€ä¸ªç»„é‡Œçš„æ‰€æœ‰åŸå¸‚éƒ½è¢«éšè—äº†ï¼Œå°±æŠŠé‚£ä¸ªç»„çš„â€œæ ‡é¢˜â€å’Œâ€œåœ†è§’èƒŒæ™¯â€ä¹Ÿè—èµ·æ¥
        groups.forEach((group, index) => {
            // æ£€æŸ¥è¿™ä¸ªç»„é‡Œæœ‰æ²¡æœ‰æ˜¾ç¤ºçš„å­å…ƒç´ 
            const visibleChildren = Array.from(group.children).some(child => child.style.display !== 'none');
            
            if(visibleChildren) {
                group.style.display = 'block';
                if(titles[index]) titles[index].style.display = 'block';
            } else {
                group.style.display = 'none';
                if(titles[index]) titles[index].style.display = 'none';
            }
        });

        // 3. æ— ç»“æœæç¤º
        document.getElementById('tz-no-result').style.display = hasResult ? 'none' : 'block';
    }
    // ==========================================
    // 10. AI å¤§è„‘é…ç½® (å®Œæ•´ä¿®å¤ç‰ˆ)
    // ==========================================

    // --- 1. åº•éƒ¨èœå•æ§åˆ¶ (Action Sheet) ---
    function openModelPicker() {
        document.getElementById('modelPickerSheet').style.display = 'flex';
    }
    function closeModelPicker() {
        document.getElementById('modelPickerSheet').style.display = 'none';
    }

    // é€‰ä¸­æ¨¡å‹ï¼šæ›´æ–°æ˜¾ç¤ºæ–‡å­— + æ›´æ–°éšè—å€¼
    function selectModel(name) {
        if(!name) return;
        // æ›´æ–°æ˜¾ç¤ºçš„è“è‰²æ–‡å­— (å¸¦ç®­å¤´)
        const displayDiv = document.getElementById('api-model-display');
        if(displayDiv) {
            displayDiv.innerHTML = name + `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#C7C7CC" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px;"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
        }
        // æ›´æ–°éšè—çš„ input å€¼ (ç»™ä¿å­˜åŠŸèƒ½ç”¨)
        const hiddenInput = document.getElementById('api-model-select');
        if(hiddenInput) {
            hiddenInput.value = name;
        }
        closeModelPicker();
    }

    // --- 2. æ ¸å¿ƒè®¾ç½®é€»è¾‘ ---

    // ==========================================
    // ğŸšï¸ æ»‘åŠ¨æ¡ä¿®å¤è¡¥ä¸ (è®©è“è‰²æ¡è·Ÿéšæ»‘å—)
    // ==========================================

    // 1. æ ¸å¿ƒå·¥å…·ï¼šè®¡ç®—æ»‘å—ç™¾åˆ†æ¯”å¹¶æ›´æ–° CSS
    function updateSliderFill(el) {
        const val = parseFloat(el.value);
        const min = parseFloat(el.min) || 0;
        const max = parseFloat(el.max) || 100;
        const percent = ((val - min) / (max - min)) * 100;
        el.style.setProperty('--percent', percent + '%');
    }

    // 2. è¦†ç›–ä¹‹å‰çš„ loadApiSettingsUI (å¢åŠ åˆå§‹åŒ–é¢œè‰²é€»è¾‘)
    function loadApiSettingsUI() {
        const url = localStorage.getItem('gpt_url') || "https://api.openai.com/v1";
        const key = localStorage.getItem('gpt_key') || "";
        const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";
        const temp = localStorage.getItem('gpt_temp') || "0.7";
        const context = localStorage.getItem('gpt_context') || "10";

        // å¡«å€¼
        document.getElementById('api-url').value = url;
        document.getElementById('api-key').value = key;
        
        // --- ä¿®å¤é‡ç‚¹ï¼šè®¾ç½®æ»‘å—æ•°å€¼åï¼Œç«‹åˆ»åˆ·æ–°é¢œè‰² ---
        const tempSlider = document.getElementById('api-temp');
        const ctxSlider = document.getElementById('api-context');
        
        // æ¸©åº¦æ»‘å—
        if(tempSlider) {
            tempSlider.value = temp;
            document.getElementById('temp-display').textContent = temp;
            updateSliderFill(tempSlider); // ğŸ‘ˆ ç«‹å³åˆ·æ–°è“è‰²æ¡
        }
        
        // è®°å¿†æ»‘å—
        if(ctxSlider) {
            ctxSlider.value = context;
            document.getElementById('context-display').textContent = context;
            updateSliderFill(ctxSlider); // ğŸ‘ˆ ç«‹å³åˆ·æ–°è“è‰²æ¡
        }

        // åˆå§‹åŒ–æ¨¡å‹èœå•æ˜¾ç¤º
        if(typeof selectModel === 'function') selectModel(model);
        
        // åŠ è½½é¢„è®¾
        if(typeof renderPresets === 'function') renderPresets();
        
        // é‡ç½®èŠå¤©æ¡†
        const chatLog = document.getElementById('test-chat-log');
        if(chatLog) chatLog.innerHTML = '<div style="color:#999; text-align:center; margin-top:40px;">Test your connection here...</div>';
    }

    // ä»æœåŠ¡å™¨è·å–æ¨¡å‹åˆ—è¡¨
    async function fetchModelList() {
        const url = document.getElementById('api-url').value.replace(/\/$/, "");
        const key = document.getElementById('api-key').value;
        const listContainer = document.getElementById('model-sheet-list'); // ç›®æ ‡å®¹å™¨æ˜¯åº•éƒ¨èœå•
        
        if(!url || !key) { showToast("URL & Key required!"); return; }
        showToast("Fetching Models...");
        
        try {
            const res = await fetch(`${url}/models`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${key}` }
            });
            if(!res.ok) throw new Error("Fetch Failed");
            const data = await res.json();
            const models = data.data || []; 
            
            if(models.length > 0) {
                listContainer.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
                models.sort((a, b) => a.id.localeCompare(b.id)); // æ’åº
                
                // ç”Ÿæˆæ¼‚äº®çš„åº•éƒ¨æŒ‰é’®
                models.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'sheet-item';
                    div.textContent = m.id;
                    div.onclick = () => selectModel(m.id); 
                    listContainer.appendChild(div);
                });
                
                openModelPicker(); // æˆåŠŸåè‡ªåŠ¨å¼¹çª—
                showToast(`Found ${models.length} models!`);
            } else {
                showToast("No models found.");
            }
        } catch(e) {
            console.error(e);
            showToast("Error fetching models.");
        }
    }

    // èŠå¤©æµ‹è¯•
    async function sendTestChat() {
        const input = document.getElementById('test-chat-input');
        const log = document.getElementById('test-chat-log');
        const msg = input.value.trim();
        if(!msg) return;

        const url = document.getElementById('api-url').value.replace(/\/$/, "");
        const key = document.getElementById('api-key').value;
        // è·å–éšè— input çš„å€¼
        const model = document.getElementById('api-model-select').value; 
        const temp = parseFloat(document.getElementById('api-temp').value);

        if(log.querySelector('div') && log.querySelector('div').textContent.includes('Test your')) log.innerHTML = ""; 
        log.innerHTML += `<div style="text-align:right; margin:5px 0;"><span style="background:#007AFF; color:white; padding:6px 10px; border-radius:14px; font-size:13px; display:inline-block;">${msg}</span></div>`;
        input.value = "";
        log.scrollTop = log.scrollHeight;

        try {
            const res = await fetch(`${url}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model, messages: [{ role: "user", content: msg }],
                    temperature: temp, max_tokens: 50
                })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            const reply = data.choices[0].message.content;
            
            log.innerHTML += `<div style="text-align:left; margin:5px 0;"><span style="background:#e5e5ea; color:black; padding:6px 10px; border-radius:14px; font-size:13px; display:inline-block;">${reply}</span></div>`;
            saveToLocalStorage(); // æˆåŠŸåˆ™è‡ªåŠ¨ä¿å­˜
            document.getElementById('api-status-preview').textContent = "Verified";
        } catch(e) {
            log.innerHTML += `<div style="text-align:left; margin:5px 0;"><span style="color:#FF3B30; font-size:11px;">Error: ${e.message}</span></div>`;
        }
        log.scrollTop = log.scrollHeight;
    }

    // ä¿å­˜å½“å‰é…ç½®ä¸ºé¢„è®¾ (é…åˆå¤–éƒ¨å¼¹çª—)
    function saveCurrentAsPreset(name) {
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        const model = document.getElementById('api-model-select').value;
        const temp = document.getElementById('api-temp').value;
        
        const preset = { id: Date.now(), name, url, key, model, temp };
        let presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        presets.push(preset);
        localStorage.setItem('api_presets', JSON.stringify(presets));
        
        saveToLocalStorage();
        renderPresets();
        showToast("Configuration Saved!");
    }

    // --- 3. ç¼ºå¤±çš„å‡½æ•° (ä¹‹å‰æŠ¥é”™å°±æ˜¯å› ä¸ºç¼ºäº†è¿™äº›) ---

    // æ¸²æŸ“é¢„è®¾åˆ—è¡¨
    function renderPresets() {
        const list = document.getElementById('preset-list');
        if(!list) return; // é˜²æ­¢é¡µé¢æ²¡åŠ è½½å®ŒæŠ¥é”™

        const presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        
        if(presets.length === 0) {
            list.innerHTML = `<div class="ios-list-item" style="color:#999; justify-content:center;">No saved configurations</div>`;
            return;
        }

        list.innerHTML = "";
        presets.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'ios-list-item';
            div.style.cursor = "pointer";
            div.innerHTML = `
                <div class="item-content" onclick="loadPreset(${index})">
                    <div style="display:flex; flex-direction:column;">
                        <span class="item-label" style="font-weight:600;">${p.name}</span>
                        <span style="font-size:11px; color:#8e8e93;">${p.model}</span>
                    </div>
                    <div class="item-right">
                        <span style="color:#FF3B30; font-size:13px; font-weight:500; padding:8px;" onclick="event.stopPropagation(); openDeletePresetConfirm(${index})">Delete</span>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // åŠ è½½é¢„è®¾
    function loadPreset(index) {
        const presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        const p = presets[index];
        if(p) {
            document.getElementById('api-url').value = p.url;
            document.getElementById('api-key').value = p.key;
            document.getElementById('api-temp').value = p.temp;
            document.getElementById('temp-display').textContent = p.temp;
            
            // ä½¿ç”¨æ–°å‡½æ•°åŠ è½½æ¨¡å‹
            selectModel(p.model); 
            
            saveToLocalStorage();
            showToast(`Loaded "${p.name}"`);
        }
    }

    // çœŸæ­£çš„åˆ é™¤é€»è¾‘ (è¢«å¼¹çª—è°ƒç”¨)
    function deletePresetReal(index) {
        let presets = JSON.parse(localStorage.getItem('api_presets') || "[]");
        presets.splice(index, 1);
        localStorage.setItem('api_presets', JSON.stringify(presets));
        renderPresets();
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    function saveToLocalStorage() {
        localStorage.setItem('gpt_url', document.getElementById('api-url').value);
        localStorage.setItem('gpt_key', document.getElementById('api-key').value);
        localStorage.setItem('gpt_model', document.getElementById('api-model-select').value);
        localStorage.setItem('gpt_temp', document.getElementById('api-temp').value);
        localStorage.setItem('gpt_context', document.getElementById('api-context').value);
    }
    
    // é‡ç½®æ‰€æœ‰è®¾ç½®
    function clearApiSettings() {
        localStorage.removeItem('gpt_url');
        localStorage.removeItem('gpt_key');
        localStorage.removeItem('gpt_model');
        localStorage.removeItem('api_presets'); 
        loadApiSettingsUI();
        showToast("Reset Complete");
    }
    // ==========================================
    // ğŸš‘ è¡¥å…¨ç¼ºå¤±çš„ï¼šå¼¹çª—æ§åˆ¶å™¨ (UI Logic)
    // ==========================================

    // --- 1. ä¿å­˜é¢„è®¾å¼¹çª— (Input Modal) ---
    
    // ç‚¹å‡»å³ä¸Šè§’ Save æ—¶è°ƒç”¨
    function openSavePresetModal() {
        // å…ˆæ£€æŸ¥å¿…å¡«é¡¹
        const url = document.getElementById('api-url').value;
        const key = document.getElementById('api-key').value;
        
        if(!url || !key) { 
            showToast("URL & Key required!"); 
            return; 
        }

        // å‡†å¤‡å¼¹çª—å†…å®¹
        document.getElementById('input-modal-title').textContent = "Name This Preset";
        // é»˜è®¤åå­—è®¾ä¸ºå½“å‰æ¨¡å‹å
        const currModel = document.getElementById('api-model-select').value;
        document.getElementById('input-modal-val').value = currModel || "My Preset";
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('iosInputModal').style.display = 'flex';
    }

    // å…³é—­è¾“å…¥å¼¹çª—
    function closeInputModal() { 
        document.getElementById('iosInputModal').style.display = 'none'; 
    }
    
    // ç¡®è®¤ä¿å­˜ (å¼¹çª—é‡Œçš„ Save æŒ‰é’®)
    function confirmInputModal() {
        const name = document.getElementById('input-modal-val').value;
        if(name) {
            saveCurrentAsPreset(name); // è°ƒç”¨æ ¸å¿ƒä¿å­˜å‡½æ•°
            closeInputModal();
        } else {
            showToast("Please enter a name");
        }
    }

    // --- 2. åˆ é™¤/é‡ç½®ç¡®è®¤å¼¹çª— (Confirm Modal) ---
    
    let pendingAction = null; // æš‚å­˜è¦æ‰§è¡Œçš„æ“ä½œ

    // ç‚¹å‡» Reset All Settings æ—¶è°ƒç”¨
    function openResetConfirm() {
        pendingAction = clearApiSettings; // è®°ä¸‹æ¥ï¼šä¸€ä¼šè¦æ‰§è¡Œé‡ç½®
        
        document.getElementById('confirm-modal-title').textContent = "Reset All Settings?";
        document.getElementById('confirm-modal-msg').textContent = "This will clear all saved API keys and presets.";
        document.getElementById('confirm-modal-btn').textContent = "Reset";
        
        document.getElementById('iosConfirmModal').style.display = 'flex';
    }
    
    // ç‚¹å‡»å•ä¸ªé¢„è®¾çš„ Delete æ—¶è°ƒç”¨
    function openDeletePresetConfirm(index) {
        pendingAction = () => deletePresetReal(index); // è®°ä¸‹æ¥ï¼šä¸€ä¼šè¦æ‰§è¡Œåˆ é™¤
        
        document.getElementById('confirm-modal-title').textContent = "Delete Preset?";
        document.getElementById('confirm-modal-msg').textContent = "This configuration will be removed.";
        document.getElementById('confirm-modal-btn').textContent = "Delete";
        
        document.getElementById('iosConfirmModal').style.display = 'flex';
    }

    // å…³é—­ç¡®è®¤å¼¹çª—
    function closeConfirmModal() {
        document.getElementById('iosConfirmModal').style.display = 'none';
        window.pendingAction = null; // å…³é—­å¼¹çª—æ—¶ä¹Ÿæ¸…ç©ºï¼Œä¿è¯å®‰å…¨
    }
    
    // æ‰§è¡Œç¡®è®¤çš„æ“ä½œ (å¼¹çª—é‡Œçš„çº¢è‰²æŒ‰é’®)
    function executeConfirmAction() {
    // æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜çš„ä»»åŠ¡
        if (typeof window.pendingAction === 'function') {
            window.pendingAction(); // æ‰§è¡Œåˆšæ‰å­˜è¿›å»çš„åˆ é™¤å‡½æ•°
            window.pendingAction = null; // æ‰§è¡Œå®Œç«‹åˆ»æ¸…ç©ºï¼Œé˜²æ­¢è¯¯è§¦
        }
        closeConfirmModal();
    }
    // ==========================================
    // ğŸ¨ å­—ä½“ä¸æ˜¾ç¤ºè®¾ç½® (æ— æŸå®‰è£…ç‰ˆ)
    // ==========================================

    function applyGlobalStyles() {
        // æˆ‘ä»¬æŠŠå˜é‡æŒ‚åœ¨ body ä¸Šï¼Œè€Œä¸æ˜¯ :rootï¼Œè¿™æ ·ä½œç”¨åŸŸæ›´å®¹æ˜“æ§åˆ¶
        const target = document.body;
        
        // åº”ç”¨ä¿å­˜çš„å­—ä½“æ ·å¼
        target.style.setProperty('--dynamic-font-family', currentFontConfig.family);
        target.style.setProperty('--dynamic-app-size', currentFontConfig.size + 'px');
        target.style.setProperty('--dynamic-app-weight', currentFontConfig.weight);
        
        // åº”ç”¨ä¿å­˜çš„é¢œè‰²ç³»ç»Ÿ
        target.style.setProperty('--dynamic-app-color', currentFontConfig.colorMain);
        target.style.setProperty('--dynamic-desktop-color', currentFontConfig.colorDesktop);
    }

    // å®æ—¶é¢„è§ˆå‡½æ•° (åªå½±å“é¢„è§ˆé‚£ä¸ªå°ç›’å­ï¼Œä¸å½±å“çœŸæ­£çš„ç•Œé¢)
    function updateFontUI() {
        // 1. æ›´æ–°è°ƒè‰²ç›˜
        document.getElementById('color-picker-main').value = currentFontConfig.colorMain;
        document.getElementById('color-picker-desktop').value = currentFontConfig.colorDesktop;
        
        // 2. æ›´æ–° Hex æ–‡å­—æ˜¾ç¤º
        document.getElementById('color-val-main').textContent = currentFontConfig.colorMain.toUpperCase();
        document.getElementById('color-val-desktop').textContent = currentFontConfig.colorDesktop.toUpperCase();

        // 3. æ ¸å¿ƒï¼šæ›´æ–°é¢„è§ˆç›’å­çš„æ ·å¼
        const pMain = document.getElementById('preview-text-main');
        const pDesk = document.getElementById('preview-text-desktop');
        
        const fontStyle = `
            font-family: ${currentFontConfig.family};
            font-size: ${currentFontConfig.size}px;
            font-weight: ${currentFontConfig.weight};
        `;

        if(pMain) {
            pMain.style.cssText = fontStyle + `color: ${currentFontConfig.colorMain};`;
        }
        if(pDesk) {
            // æ¡Œé¢é¢„è§ˆé€šå¸¸åŠ ä¸€ç‚¹é˜´å½±æ¨¡æ‹ŸçœŸå®å£çº¸æ„Ÿ
            pDesk.style.cssText = fontStyle + `color: ${currentFontConfig.colorDesktop}; text-shadow: 0 1px 2px rgba(0,0,0,0.2);`;
        }
    }

    // ä¿å­˜å¹¶å…¨å±€ç”Ÿæ•ˆ
    function saveFontSettings() {
        localStorage.setItem('ios_font_config', JSON.stringify(currentFontConfig));
        applyGlobalStyles(); // è¿™æ—¶å€™å˜é‡æ‰ä¼šä¼ ç»™ CSS é’©å­ï¼Œå…¨å±€å˜è‰²
        showToast("Theme Updated!");
        setTimeout(() => closeSubPage('subpage-display'), 500);
    }

function openInsAppModal(id) {
    document.getElementById(id).style.display = 'flex';
}

function closeInsAppModal(id) {
    document.getElementById(id).style.display = 'none';
}
// 1. å£°æ˜å˜é‡ï¼ˆç”¨ var ç¡®ä¿å®ƒæ˜¯å…¨å±€å¯è§çš„ï¼‰
var vibeGameState;

// 2. åˆå§‹åŒ–æ£‹ç›˜å‡½æ•°
function initVibeGrid() {
    // ã€å…³é”®ä¿®å¤ã€‘ï¼šå¦‚æœå˜é‡è¿˜æ²¡åˆå§‹åŒ–ï¼Œåœ¨è¿™é‡Œå¼ºè¡Œåˆå§‹åŒ–å®ƒ
    if (!vibeGameState) {
        vibeGameState = {
            board: [],
            size: 10,
            currentPlayer: 1,
            isGameOver: false
        };
    }

    var boardEl = document.getElementById('vibe-board');
    if (!boardEl) {
        console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ° ID ä¸º vibe-board çš„å®¹å™¨");
        return;
    }
    
    // é‡ç½®é€»è¾‘
    boardEl.innerHTML = '';
    vibeGameState.board = []; 
    for (var i = 0; i < 10; i++) {
        vibeGameState.board[i] = Array(10).fill(0);
    }
    vibeGameState.currentPlayer = 1;
    vibeGameState.isGameOver = false;
    
    var indicator = document.getElementById('vibe-turn-indicator');
    if (indicator) {
        indicator.textContent = "PLAYER: å…±é¸£";
        indicator.style.color = "#4facfe";
    }

    // ç”Ÿæˆæ ¼å­
    for (var r = 0; r < 10; r++) {
        for (var c = 0; c < 10; c++) {
            var cell = document.createElement('div');
            cell.className = 'vibe-cell';
            cell.dataset.row = r;
            cell.dataset.col = c;
            // ç»‘å®šç‚¹å‡»è½å­
            cell.onclick = (function(row, col, el) {
                return function() { placeVibePiece(row, col, el); };
            })(r, c, cell);
            boardEl.appendChild(cell);
        }
    }
    console.log("æ°›å›´å›´åŸï¼šæ£‹ç›˜å°±ç»ª");
}

// 3. è½å­å‡½æ•°
function placeVibePiece(r, c, cellEl) {
    // å†æ¬¡æ£€æŸ¥å˜é‡ï¼Œé˜²æ­¢æ„å¤–
    if (!vibeGameState || vibeGameState.board[r][c] !== 0 || vibeGameState.isGameOver) return;

    var player = vibeGameState.currentPlayer;
    vibeGameState.board[r][c] = player;

    var piece = document.createElement('div');
    piece.className = (player === 1) ? 'piece-resonance' : 'piece-devour';
    cellEl.appendChild(piece);

    // å˜è‰²é€»è¾‘
    if (player === 1) {
        document.documentElement.style.setProperty('--bg-gradient', 'linear-gradient(160deg, #a1fdd4 0%, #8ec5fc 100%)');
    } else {
        document.documentElement.style.setProperty('--bg-gradient', 'linear-gradient(160deg, #fbc2eb 0%, #a6c1ee 100%)');
    }

    // åˆ¤èƒœ
    if (checkVibeWin(r, c, player)) {
        vibeGameState.isGameOver = true;
        alert((player === 1 ? "å…±é¸£" : "åå™¬") + " è¿æˆäº†æƒ…æ„Ÿç½‘ç»œï¼");
        return;
    }

    // æ¢äºº
    vibeGameState.currentPlayer = (player === 1) ? 2 : 1;
    var nextName = (vibeGameState.currentPlayer === 1) ? "å…±é¸£" : "åå™¬";
    var indicator = document.getElementById('vibe-turn-indicator');
    if (indicator) {
        indicator.textContent = "PLAYER: " + nextName;
        indicator.style.color = (vibeGameState.currentPlayer === 1) ? "#4facfe" : "#f5576c";
    }
}

// 4. ç®—æ³•å‡½æ•°
function checkVibeWin(r, c, p) {
    if (!vibeGameState) return false;
    var b = vibeGameState.board;
    var dirs = [[1,0], [0,1], [1,1], [1,-1]];
    for (var i = 0; i < dirs.length; i++) {
        var dr = dirs[i][0], dc = dirs[i][1], count = 1;
        var nr = r + dr, nc = c + dc;
        while(nr>=0 && nr<10 && nc>=0 && nc<10 && b[nr][nc] === p) { count++; nr+=dr; nc+=dc; }
        nr = r - dr; nc = c - dc;
        while(nr>=0 && nr<10 && nc>=0 && nc<10 && b[nr][nc] === p) { count++; nr-=dr; nc-=dc; }
        if (count >= 5) return true;
    }
    return false;
}

// 5. é‡ç½®
function resetVibeGame() {
    initVibeGrid();
}
// ==========================================
// ğŸ® æ°›å›´å›´åŸï¼šå¼ºåˆ¶ä¿®å¤å¯åŠ¨é€»è¾‘
// ==========================================

// 1. å¼ºåŠ›æ‰“å¼€ App çš„å‡½æ•°
// åœ¨ script æ ‡ç­¾æœ€åæ·»åŠ æˆ–ä¿®æ”¹
function startVibeGame() {
    var gameApp = document.getElementById('vibe-grid-app');
    if (gameApp) {
        gameApp.style.display = 'flex'; // å…ˆæ˜¾ç¤ºå®¹å™¨
        // ç»™æµè§ˆå™¨ä¸€ä¸ç‚¹æ—¶é—´å‡†å¤‡ï¼Œç„¶åè§¦å‘æ»‘å…¥åŠ¨ç”»
        setTimeout(function() {
            gameApp.classList.add('active');
            initVibeGrid(); // åˆå§‹åŒ–æ£‹ç›˜
        }, 50);
    }
}

// 2. ä¿®æ”¹ä½ ä¹‹å‰çš„ initVibeGridï¼Œå¢åŠ å®‰å…¨æ€§
// å¦‚æœä½ åé¢è¿˜è¦æ”¹ï¼Œè¯·ç¡®ä¿å‡½æ•°åè¿˜æ˜¯è¿™ä¸ª
var originalInitVibeGrid = initVibeGrid; 
initVibeGrid = function() {
    console.log("æ­£åœ¨é‡ç»˜æ£‹ç›˜...");
    // æ£€æŸ¥å˜é‡
    if (!vibeGameState) {
        vibeGameState = { board: [], size: 10, currentPlayer: 1, isGameOver: false };
    }
    // å‰©ä¸‹çš„é€»è¾‘ä¼šè‡ªåŠ¨è¿è¡Œä½ ä¹‹å‰å†™çš„é‚£ä¸ªç‰ˆæœ¬
    if(typeof originalInitVibeGrid === 'function') originalInitVibeGrid();
};
// ==========================================
// ğŸ® Vibe Grid 3.0: è§’è‰²åšå¼ˆå¼•æ“
// ==========================================

var vibeOpponent = null;
var vibeGameLog = []; // å­˜è¯è¯­
var vibePendingMove = null;

// 1. ã€å¼ºåŠ›å¯åŠ¨å™¨ã€‘
function startVibeGame() {
    var app = document.getElementById('vibe-grid-app');
    app.style.display = 'flex';
    setTimeout(() => {
        app.classList.add('active');
        renderVibeCharPicker(); // ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶é€‰äºº
    }, 50);
}

// 2. æ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨ (ä»ä½ çš„ IndexedDB è·å–)
// è®°å½•å½“å‰æ˜¯è°åœ¨è°ƒç”¨è§’è‰²é€‰æ‹©å™¨ ('VIBE' æˆ– 'SIGNAL')
var charPickerSource = 'VIBE'; 
// 3. é€‰æ‹©å¯¹æ‰‹å¹¶åˆå§‹åŒ–
function selectVibeOpponent(char) {
    vibeOpponent = char;
    vibeGameLog = [];
    document.getElementById('modal-vibe-char-picker').style.display = 'none';
    document.getElementById('opponent-info-bar').style.display = 'flex';
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ è½å­å¹¶æ³¨é­‚";
    initVibeGrid(); // ç»˜åˆ¶æ£‹ç›˜
}

// 4. é‡å†™åˆå§‹åŒ– (10x10)
function initVibeGrid() {
    var board = document.getElementById('vibe-board');
    board.innerHTML = "";
    vibeGameState = { board: Array(10).fill(0).map(()=>Array(10).fill(0)), isGameOver: false, currentPlayer: 1 };
    
    for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
            let cell = document.createElement('div');
            cell.className = 'vibe-cell';
            cell.dataset.row = r; cell.dataset.col = c;
            cell.onclick = () => handleVibeCellClick(r, c, cell);
            board.appendChild(cell);
        }
    }
}

// 5. ç‚¹å‡»é€»è¾‘
function handleVibeCellClick(r, c, el) {
    if (vibeGameState.isGameOver || vibeGameState.board[r][c] !== 0 || !vibeOpponent) return;
    vibePendingMove = { r, c, el };
    document.getElementById('vibe-user-word').value = "";
    document.getElementById('modal-vibe-word-input').style.display = 'flex';
}

// 6. ç¡®è®¤è½å­ (ç”¨æˆ·)
function confirmVibeStep() {
    var word = document.getElementById('vibe-user-word').value.trim();
    if(!word) { 
        showToast("æ³¨é­‚ä¸å¯ä¸ºç©º"); // ç¡®ä¿ä½ ä¹‹å‰æœ‰è¿™ä¸ªå‡½æ•°
        return; 
    }
    
    // ã€å…³é”®ä¿®å¤ã€‘ï¼šå¦‚æœç¬”è®°æœ¬æ²¡æ‰“å¼€ï¼Œç°åœ¨ç«‹åˆ»æ‰“å¼€
    if (!vibeGameLog) { vibeGameLog = []; }

    // éšè—è¾“å…¥æ³•
    document.getElementById('modal-vibe-word-input').style.display = 'none';
    
    // è®°å½•è¯è¯­
    vibeGameLog.push({ role: "User", text: word });
    
    // æ‰§è¡Œè½å­
    executeVibeMove(vibePendingMove.r, vibePendingMove.c, vibePendingMove.el, 1);
    
    if (vibeGameState.isGameOver) { 
        finishVibeMatch(); 
    } else {
        document.getElementById('vibe-turn-indicator').textContent = vibeOpponent.name + " æ­£åœ¨å›å“...";
        setTimeout(aiVibeResponse, 1000);
    }
}

// 7. AI å›åº” (è‡ªåŠ¨æ‰¾ç©ºä½ + è°ƒç”¨æ¨¡å‹)
async function aiVibeResponse() {
    // ç®€å•ç®—æ³•ï¼šæ‰¾ç¬¬ä¸€ä¸ªç©ºä½ (å•†ç”¨æ¼”ç¤ºå¤Ÿç”¨ï¼Œå¯å‡çº§)
    let r, c, found = false;
    for(r=4; r<10 && !found; r++) for(c=4; c<10 && !found; c++) if(vibeGameState.board[r][c] === 0) found = true;
    if(!found) { finishVibeMatch("DRAW"); return; }
    r--; c--;

    var bestMove = findBestMove(); 
    if(!bestMove) { finishVibeMatch("DRAW"); return; }

    // 1. è·å– AI è¯è¯­
    let lastUserWord = vibeGameLog[vibeGameLog.length-1].text;
    // åœ¨è·å–åˆ° aiWord åï¼Œæ‰§è¡Œè½å­å‰å¢åŠ é€»è¾‘
    let aiWord = await callAIForOneWord(lastUserWord);

    // ã€å¼ºåŠ›å»é‡æ£€æŸ¥ã€‘ï¼šå¦‚æœ AI å›çš„è¯è·Ÿç©å®¶ä¸€æ ·ï¼Œæˆ–è€… AI ä»¥å‰è¯´è¿‡ï¼Œå°±å¼ºåˆ¶è®©å®ƒéšæœºåº”å˜
    if (aiWord === lastUserWord || vibeGameLog.some(l => l.text === aiWord)) {
        var fallbackWords = ["ä½™æ¸©", "é™é»˜", "å¾®å…‰", "å¼•åŠ›", "å›å“"]; // å¤‡ç”¨é«˜çº§è¯åº“
        aiWord = fallbackWords[Math.floor(Math.random() * fallbackWords.length)];
    }
    vibeGameLog.push({ role: "AI", text: aiWord });

    // 2. æ›´æ–°ä¸‹æ–¹ä¿¡æ¯æ  (è®©å®ƒæ˜¾ç°)
    var logDisplay = document.getElementById('opp-last-word');
    if(logDisplay) {
        logDisplay.textContent = "ã€Œ " + aiWord + " ã€";
        logDisplay.style.opacity = "1";
    }

    // 3. æ‰§è¡Œè½å­
    let el = document.querySelector(`.vibe-cell[data-row='${bestMove.r}'][data-col='${bestMove.c}']`);
    executeVibeMove(bestMove.r, bestMove.c, el, 2);

    // 4. ã€æ ¸å¿ƒå‡çº§ã€‘ï¼šåˆ›å»ºæ£‹ç›˜ä¸Šæ–¹çš„æ‚¬æµ®æ–‡å­—åŠ¨ç”»
    showFloatingWord(aiWord, el);

    if (vibeGameState.isGameOver) { finishVibeMatch(); return; }
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ æ³¨å…¥è¯è¯­";
}
function showFloatingWord(text, targetEl) {
    var floatEl = document.createElement('div');
    floatEl.className = 'floating-vibe-word';
    floatEl.textContent = text;
    
    // å®šä½åˆ°å½“å‰è½å­çš„æ ¼å­ä¸­å¿ƒ
    var rect = targetEl.getBoundingClientRect();
    floatEl.style.left = (rect.left + rect.width / 2 - 20) + "px";
    floatEl.style.top = (rect.top - 20) + "px";
    
    document.body.appendChild(floatEl);
    
    // åŠ¨ç”»ç»“æŸè‡ªåŠ¨åˆ é™¤ï¼Œä¸å å†…å­˜
    setTimeout(function() {
        if(floatEl.parentNode) floatEl.parentNode.removeChild(floatEl);
    }, 2500);
}

// 8. èƒœè´Ÿ/å¹³å±€åˆ¤æ–­å¹¶å¼¹å‡ºå›å“å¡ç‰‡
// å‡çº§ç‰ˆï¼šå¸¦é˜²å¾¡é€»è¾‘çš„å¯¹å±€æ€»ç»“
// ==========================================
// ğŸ† é€šç”¨å¯¹å±€ç»“ç®—ä¸­å¿ƒ (ç»ˆæä¿®å¤ç‰ˆ)
// ==========================================
async function finishVibeMatch(type, customOpponent, customWords, customStory) {
    // 1. ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå®‰å…¨é”
    // åªæœ‰å½“ vibeGameState çœŸçš„å­˜åœ¨æ—¶ï¼Œæ‰å»æ”¹å®ƒçš„çŠ¶æ€
    if (typeof vibeGameState !== 'undefined' && vibeGameState) {
        vibeGameState.isGameOver = true;
    }

    showToast("å¯¹å±€å·²æˆï¼Œæ­£åœ¨ç»“è¯­...");
    
    // 2. æ™ºèƒ½è¯†åˆ«ï¼šæ˜¯è°åœ¨ç»“ç®—ï¼Ÿ
    // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å»æ‰¾å…¨å±€å˜é‡
    var opponent = customOpponent || (window.senseOpponent || vibeOpponent);
    var words = customWords || (window.senseMix || []);
    var story = customStory || ""; 

    if (!opponent) {
        console.error("Critical Error: æ‰¾ä¸åˆ°ä»»ä½•å¯¹æ‰‹æ•°æ®");
        return;
    }

    // 3. ç¡®å®šå¯¹å±€æ–‡æ¡ˆ
    var outcomeText;
    if (type === "SYNCED") outcomeText = "è”è§‰å…±æŒ¯ Â· è·å–åº•å±‚è®°å¿†";
    else if (type === "OFFLINE") outcomeText = "ä¿¡å·æ–­è£‚ Â· æ— æ³•è§£æäººæ ¼";
    else if (type === "DRAW") outcomeText = "å¹³å±€ Â· æŸç§å¹³è¡¡";
    else {
        // äº”å­æ£‹é€»è¾‘
        outcomeText = (vibeGameState && vibeGameState.currentPlayer === 1) ? "ä½ è§¦ç¢°äº†èƒœæœº" : opponent.name + "ä¸»å¯¼äº†æ°›å›´";
    }

    // 4. æ ¼å¼åŒ–è¯è¯­æ˜¾ç¤º (å…¼å®¹æ•°ç»„å’Œå¯¹è±¡)
    var wordStr = Array.isArray(words) ? words.join(" Â· ") : words;

    // 5. å¡«å……ç»“æœå¡ç‰‡ (UI æ¸²æŸ“)
    document.getElementById('res-title').textContent = opponent.name + " çš„åšå¼ˆå›å“";
    document.getElementById('res-outcome').textContent = outcomeText;
    document.getElementById('res-avatar').src = opponent.avatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + opponent.avatar + ")";
    document.getElementById('res-words').textContent = wordStr;
    
    // å¦‚æœå·²ç»æœ‰äº†æ•…äº‹ï¼ˆSenseæ¨¡å¼ï¼‰ï¼Œç›´æ¥å¡«è¿›å»ï¼›å¦‚æœæ²¡æœ‰ï¼ˆäº”å­æ£‹æ¨¡å¼ï¼‰ï¼Œå°±å»å«AIå†™
    var elStory = document.getElementById('res-story');
    if (story) {
        elStory.textContent = story;
    } else {
        elStory.textContent = "æ­£åœ¨ç¼–ç»‡åšå¼ˆç•™ä¸‹çš„ä½™æ¸©...";
        story = await callAIForStory(outcomeText, opponent, words); // è°ƒç”¨ä½ å·²æœ‰çš„ AI æ•…äº‹å‡½æ•°
        elStory.textContent = story;
    }

    // 6. æ˜¾ç¤ºå¡ç‰‡å¹¶ä¿å­˜å†å²
    document.getElementById('modal-vibe-result').style.display = 'flex';
    saveToVibeHistory(opponent, outcomeText, wordStr, story);
}

// --- è¾…åŠ©ï¼šæ‰§è¡Œè½å­è§†è§‰ ---
function executeVibeMove(r, c, el, p) {
    vibeGameState.board[r][c] = p;
    var piece = document.createElement('div');
    piece.className = p === 1 ? 'piece-resonance' : 'piece-devour';
    el.appendChild(piece);
    if(checkVibeWin(r, c, p)) vibeGameState.isGameOver = true;
    if(!vibeGameState.isGameOver) vibeGameState.currentPlayer = (p===1?2:1);
}

// --- è¾…åŠ©ï¼šçœŸæ­£çš„ AI æ¨¡å‹è°ƒç”¨ (è°ƒç”¨ä½ è®¾ç½®é¡µé¢çš„é…ç½®) ---
// å‡çº§ç‰ˆï¼šä¸¥æ ¼æ§åˆ¶ AI çš„å›å“è¯æ±‡
async function callAIForOneWord(userWord) {
    var key = localStorage.getItem('gpt_key');
    if(!key) return "æ²‰é»˜";

    // 1. æå–è§’è‰²å®Œæ•´èº«ä»½ (ç¡®ä¿è¯»å–è§’è‰²ä¹¦ä¸­çš„ desc å­—æ®µ)
    var persona = vibeOpponent.desc || "ç¥ç§˜çš„é™Œç”Ÿäºº";
    var usedWords = vibeGameLog.map(function(l){ return l.text; }).join("ã€");

    try {
        var res = await fetch(localStorage.getItem('gpt_url') + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            // ä¿®æ”¹ callAIForOneWord å†…éƒ¨çš„ body éƒ¨åˆ†
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{
                    role: "system", 
                    content: `ã€ç»å¯¹äººæ ¼é”å®šã€‘
                    ä½ æ˜¯: ${vibeOpponent.name}ã€‚èº«ä»½èƒŒæ™¯: ${vibeOpponent.desc}ã€‚
                    
                    ã€åšå¼ˆç¯å¢ƒã€‘
                    - è¿™æ˜¯ä¸€ä¸ªä¸æ–­æµåŠ¨çš„æ—¶ç©ºï¼Œå½“å‰çš„åç§»é‡ä¸º: ${Date.now()}ã€‚
                    - å³ä½¿é¢å¯¹ç›¸åŒçš„è¯è¯­ï¼Œä½ ä¹Ÿå¿…é¡»æ ¹æ®ä½ æ­¤åˆ»çš„â€œäººæ ¼åˆ‡ç‰‡â€å›å“ä¸åŒçš„ç­”æ¡ˆã€‚
                    
                    ã€è¯è¯­å›å“è§„åˆ™ã€‘
                    1. ä»…é™å›å¤ä¸€ä¸ªã€è¯è¯­ã€‘æˆ–ã€æˆè¯­ã€‘ï¼Œç¦æ­¢åºŸè¯ã€‚
                    2. ä½ çš„è¯åº“å¿…é¡»æåº¦ä¸°å¯Œï¼Œç¦æ­¢ä½¿ç”¨é™ˆè¯æ»¥è°ƒã€‚
                    3. ç¦æ­¢é‡å¤å½“å‰å¯¹å±€è¯è¯­ï¼š${vibeGameLog.map(l=>l.text).join('ã€')}ã€‚
                    4. ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘å±•ç°ä½ çš„æ–‡å­¦åº•è•´ï¼Œä¼˜å…ˆé€‰æ‹©ç”Ÿåƒ»ä½†é«˜çº§çš„è¯æ±‡ã€‚`
                }, {
                    role: "user", 
                    content: userWord
                }],
                temperature: 0.9, // è°ƒé«˜åˆ›é€ åŠ›ï¼Œå‡å°‘ç¡®å®šæ€§
                presence_penalty: 0.6 // é¼“åŠ±æ¨¡å‹è°ˆè®ºæ–°è¯é¢˜ï¼Œå‡å°‘é‡å¤
            })
        });
        var data = await res.json();
        // è¿‡æ»¤éæ–‡å­—å†…å®¹
        return data.choices[0].message.content.trim().replace(/[^\u4e00-\u9fa5a-zA-Z]/g, '').substring(0, 5);
    } catch(e) { return "å›éŸ³"; }
}

// ==========================================
// ğŸ“– Vibe Grid: åŠ¨æ€å­—æ•°å™äº‹å¼•æ“
// ==========================================
async function callAIForStory(outcome) {
    var key = localStorage.getItem('gpt_key');
    if(!key) return "æ–‡å­—æ— æ³•æ‰¿è½½æ­¤åˆ»çš„æƒ…ç»ªã€‚";
    
    var persona = vibeOpponent.desc || "æŸç§æœªçŸ¥çš„å­˜åœ¨";
    var words = vibeGameLog.map(l => l.text).join("ã€");
    
    // 1. ã€æ ¸å¿ƒé€»è¾‘ã€‘ï¼šè®¡ç®—å¯¹å±€æ·±åº¦
    // è½®æ•°è¶Šå¤šï¼Œè¦æ±‚ AI å†™çš„å­—æ•°ä¸Šé™è¶Šé«˜ï¼Œå†…å®¹è¶Šç»†èŠ‚
    var turnCount = vibeGameLog.length;
    var targetWordCount = 150; // åˆå§‹ä¿åº•å­—æ•°
    
    if (turnCount > 10) targetWordCount = 400;
    if (turnCount > 20) targetWordCount = 700;
    if (turnCount > 40) targetWordCount = 1000; // é•¿å±€å¯¹å†³ï¼Œç»™é•¿ç¯‡ç‹¬ç™½

    try {
        var res = await fetch(localStorage.getItem('gpt_url') + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{
                    role: "system", 
                    content: `ä½ æ˜¯${vibeOpponent.name}ã€‚èº«ä»½èƒŒæ™¯ï¼š${persona}ã€‚`
                }, {
                    role: "user", 
                    content: `åˆšæ‰æˆ‘ä»¬è¿›è¡Œäº†ä¸€åœºé•¿è¾¾ ${turnCount} ä¸ªå›åˆçš„æ·±åº¦åšå¼ˆï¼Œå¯¹å±€çŠ¶æ€æ˜¯ [${outcome}]ã€‚
                    åœ¨è¿™åœºåšå¼ˆä¸­ï¼Œæˆ‘ä»¬å…±åŒç•™ä¸‹äº†è¿™äº›æƒ…ç»ªç¢ç‰‡ï¼š${words}ã€‚
                    
                    ã€ä»»åŠ¡æŒ‡ä»¤ã€‘
                    1. è¯·ä»¥ä½ çš„èº«ä»½ï¼Œå†™ä¸€æ®µçº¦ ${targetWordCount} å­—çš„å†…å¿ƒç‹¬ç™½æ•…äº‹ã€‚
                    2. ç”±äºå¯¹å±€å›åˆæ•°è¾ƒå¤šï¼Œè¯·åŠ¡å¿…å……åˆ†åˆ©ç”¨ä¸Šé¢æåˆ°çš„æ‰€æœ‰è¯è¯­ç¢ç‰‡ï¼Œå°†å®ƒä»¬äº¤ç»‡è¿›ä½ çš„å™è¿°é€»è¾‘ä¸­ã€‚
                    3. ä¸¥ç¦å‡ºç° Emojiï¼Œæ–‡é£è¦æå…·ç”»é¢æ„Ÿï¼Œåƒæ˜¯ä¸€åœºæ¼«é•¿æˆ˜äº‰æˆ–é•¿å¤œè¿‡åçš„æœ€åå‘Šç™½ã€‚
                    4. å†…å®¹è¦ä¸°å¯Œã€é¥±æ»¡ï¼Œä¸è¦ç®€å•çš„å †ç Œè¯è¯­ï¼Œè¦å†™å‡ºæƒ…æ„Ÿçš„é€’è¿›æ„Ÿã€‚`
                }],
                temperature: 0.85 // ç•¥å¾®è°ƒé«˜ï¼Œå¢åŠ å™äº‹çš„è¿è´¯æ€§ä¸å‘æ•£åŠ›
            })
        });
        var data = await res.json();
        return data.choices[0].message.content;
    } catch(e) { 
        return "åšå¼ˆå¤ªæ·±ï¼Œè¨€è¯­å·²æ— æ³•è§¦åŠç»ˆç‚¹ã€‚"; 
    }
}

// ä¿®æ”¹ä½ æ–‡ä»¶æœ«å°¾å¯¹åº”çš„è¿™ä¸¤ä¸ªå‡½æ•°
function openVibeGuide() {
    var modal = document.getElementById('modal-vibe-guide');
    if (modal) {
        modal.style.display = 'flex';
        console.log("System: Guide modal opened.");
    } else {
        console.error("System Error: Element 'modal-vibe-guide' not found in DOM.");
        // è‡ªåŠ¨æç¤ºï¼Œé˜²æ­¢ç”¨æˆ·ä¸€è„¸æ‡µ
        showToast("æ­£åœ¨è½½å…¥è¯´æ˜ï¼Œè¯·ç¨å..."); 
    }
}

function closeVibeGuide() {
    var modal = document.getElementById('modal-vibe-guide');
    if (modal) {
        modal.style.display = 'none';
    }
}
// ==========================================
// ğŸ•¹ï¸ Vibe Grid å‡çº§é€»è¾‘ï¼šåŒæ­¥è§’è‰²ä¹¦
// ==========================================

// 2. ç¡®è®¤é€‰æ‹©å¹¶è¿›å…¥æ¸¸æˆçŠ¶æ€
function confirmSelection(char) {
    vibeOpponent = char;
    document.getElementById('modal-vibe-picker').style.display = 'none'; // è§’è‰²é€‰æ‹©å™¨è¿˜åœ¨åº•éƒ¨ï¼Œæ²¡å…³ç³»
    
    // 1. éšè—å¯åŠ¨é¡µ
    document.getElementById('vibe-start-screen').style.display = 'none';
    
    // 2. æ˜¾ç¤ºå¹¶æ¸å…¥æ¸¸æˆå±‚
    var gameMain = document.getElementById('vibe-game-main');
    gameMain.style.display = 'flex';
    setTimeout(() => { gameMain.style.opacity = '1'; }, 10);
    
    // 3. å¡«å……æ•°æ®å¹¶é‡ç»˜æ£‹ç›˜
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    initVibeGrid(); 
}

// 3. ä¿®æ­£ startVibeGame (å…¥å£å‡½æ•°)
function startVibeGame() {
    var app = document.getElementById('vibe-grid-app');
    app.style.display = 'flex';
    // æ¯æ¬¡é‡æ–°æ‰“å¼€éƒ½å›åˆ°åˆå§‹çŠ¶æ€
    document.getElementById('vibe-start-screen').style.display = "flex";
    document.getElementById('vibe-start-screen').style.opacity = "1";
    document.getElementById('vibe-game-main').style.opacity = "0";
    
    setTimeout(() => { app.classList.add('active'); }, 50);
}
// é‡æ–°ä¿®æ”¹è¿™ä¸ªç‚¹å‡»å‡½æ•°
function handleVibeCellClick(r, c, el) {
    // åŸºç¡€åˆ¤å®š
    if (!vibeGameState || vibeGameState.isGameOver || vibeGameState.board[r][c] !== 0 || !vibeOpponent) return;
    
    vibePendingMove = { r: r, c: c, el: el };
    
    // è·å–è¾“å…¥æ¡†å’Œå¼¹çª—å…ƒç´ 
    var inputField = document.getElementById('vibe-user-word');
    var inputModal = document.getElementById('modal-vibe-word-input');
    
    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå¢åŠ é€»è¾‘åˆ¤æ–­ï¼Œå¦‚æœå…ƒç´ å­˜åœ¨æ‰è¿›è¡Œæ“ä½œ
    if (inputField && inputModal) {
        inputField.value = ""; // æ¸…ç©ºä¸Šæ¬¡å†…å®¹
        inputModal.style.display = 'flex'; // å¼¹å‡ºè¾“å…¥æ¡†
        inputField.focus(); // è‡ªåŠ¨èšç„¦æ–¹ä¾¿è¾“å…¥
    } else {
        console.error("System Error: æ‰¾ä¸åˆ° ID ä¸º 'vibe-user-word' æˆ– 'modal-vibe-word-input' çš„å…ƒç´ ã€‚");
        // å…œåº•æ–¹æ¡ˆï¼šå¦‚æœå®åœ¨æ‰¾ä¸åˆ°å¼¹çª—ï¼Œå°±ç”¨ä¸€ä¸ªæœ€åŸºç¡€çš„æç¤º
        var fallbackWord = prompt("è¯·è¾“å…¥æ­¤å¤„çš„æ³¨é­‚è¯è¯­ï¼š");
        if(fallbackWord) {
            document.getElementById('vibe-user-word-hidden-backup').value = fallbackWord; // å‡æƒ³ä¸€ä¸ªå¤‡ä»½
            confirmVibeStep(); 
        }
    }
}
// ==========================================
// ğŸ§  AI å†³ç­–å¼•æ“ï¼šå¯»æ‰¾æœ€ä½³è½å­ç‚¹
// ==========================================
function findBestMove() {
    if (!vibeGameState || !vibeGameState.board) return null;
    var board = vibeGameState.board;
    var size = 10;
    
    // æƒé‡è¡¨ï¼šç”¨æ¥è®°å½•æ¯ä¸ªæ ¼å­çš„å±é™©/æœºé‡ç¨‹åº¦
    var scores = Array(size).fill(0).map(() => Array(size).fill(0));

    for (var r = 0; r < size; r++) {
        for (var c = 0; c < size; c++) {
            if (board[r][c] !== 0) continue;

            // æ ¸å¿ƒé€»è¾‘ï¼šæ¨¡æ‹Ÿåœ¨æ­¤å¤„è½å­ï¼Œè®¡ç®—ä»·å€¼
            // æˆ‘ä»¬æ£€æŸ¥ ç©å®¶(1) çš„å¨èƒ å’Œ AI(2) çš„æœºä¼š
            scores[r][c] = calculateCellScore(r, c);
        }
    }

    // å¯»æ‰¾åˆ†æ•°æœ€é«˜çš„æ ¼å­
    var maxScore = -1;
    var best = null;
    for (var r = 0; r < size; r++) {
        for (var c = 0; c < size; c++) {
            if (scores[r][c] > maxScore) {
                maxScore = scores[r][c];
                best = { r: r, c: c };
            }
        }
    }
    return best;
}
// è¾…åŠ©ï¼šè®¡ç®—å•ä¸ªæ ¼å­çš„æˆ˜ç•¥ä»·å€¼
function calculateCellScore(r, c) {
    var total = 0;
    var directions = [[1,0], [0,1], [1,1], [1,-1]];
    
    directions.forEach(dir => {
        // 1. æ‹¦æˆªç©å®¶é€»è¾‘ï¼šå¦‚æœä½ å¿«èµ¢äº†ï¼Œæˆ‘å°±å¾—å µ
        var pCount = countLine(r, c, dir, 1);
        if (pCount >= 4) total += 10000; // å¿…å µï¼šç©å®¶å·²å››è¿
        else if (pCount === 3) total += 500; // é‡ç‚¹å µï¼šç©å®¶å·²ä¸‰è¿
        
        // 2. AI è¿›æ”»é€»è¾‘ï¼šå¦‚æœæˆ‘ä¹Ÿèƒ½è¿èµ·æ¥ï¼Œä¼˜å…ˆè‡ªå·±è¿
        var aiCount = countLine(r, c, dir, 2);
        if (aiCount >= 4) total += 50000; // ä¼˜å…ˆèµ¢ï¼šAI å³å°†äº”è¿
        else if (aiCount === 3) total += 800; // ä¼˜å…ˆé€ å››è¿
        
        // 3. åŸºç¡€ä½ç½®æƒé‡
        total += (Math.abs(4.5 - r) + Math.abs(4.5 - c)); // è¶Šé è¿‘ä¸­å¿ƒåˆ†è¶Šé«˜
    });
    return total;
}

function countLine(r, c, dir, p) {
    var count = 0;
    var board = vibeGameState.board;
    // æ­£å‘
    var nr = r + dir[0], nc = c + dir[1];
    while(nr>=0 && nr<10 && nc>=0 && nc<10 && board[nr][nc] === p) { count++; nr+=dir[0]; nc+=dir[1]; }
    // åå‘
    nr = r - dir[0]; nc = c - dir[1];
    while(nr>=0 && nr<10 && nc>=0 && nc<10 && board[nr][nc] === p) { count++; nr-=dir[0]; nc-=dir[1]; }
    return count;
}

// ==========================================
// ğŸ† èƒœè´Ÿåˆ¤å®šç®—æ³• (æ ‡å‡†äº”å­æ£‹é€»è¾‘)
// ==========================================
function checkVibeWin(r, c, p) {
    var directions = [
        [1, 0],  // å‚ç›´
        [0, 1],  // æ°´å¹³
        [1, 1],  // æ­£æ–œ
        [1, -1]  // åæ–œ
    ];
    var board = vibeGameState.board;

    for (var i = 0; i < directions.length; i++) {
        var dr = directions[i][0];
        var dc = directions[i][1];
        var count = 1;

        // å‘ä¸€ä¸ªæ–¹å‘æ¢æµ‹
        var nr = r + dr, nc = c + dc;
        while (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] === p) {
            count++;
            nr += dr;
            nc += dc;
        }

        // å‘ç›¸åæ–¹å‘æ¢æµ‹
        nr = r - dr; nc = c - dc;
        while (nr >= 0 && nr < 10 && nc >= 0 && nc < 10 && board[nr][nc] === p) {
            count++;
            nr -= dr;
            nc -= dc;
        }

        if (count >= 5) return true;
    }
    return false;
}
// ==========================================
// ğŸ“œ Vibe Grid: å†å²æ²‰æ·€é€»è¾‘
// ==========================================

// 1. ä¿å­˜å½“å‰å¯¹å±€åˆ°å†å²
function saveToVibeHistory(char, outcome, words, story) {
    var history = JSON.parse(localStorage.getItem('vibe_match_history') || "[]");
    var entry = {
        id: Date.now(),
        charName: char.name,
        charAvatar: char.avatar,
        outcome: outcome,
        words: words,
        story: story,
        date: new Date().toLocaleDateString()
    };
    history.unshift(entry); // æœ€æ–°çš„æ’åœ¨å‰é¢
    if(history.length > 20) history.pop(); // æœ€å¤šä¿å­˜20æ¡
    localStorage.setItem('vibe_match_history', JSON.stringify(history));
}

// 2. æ‰“å¼€å¹¶æ¸²æŸ“å†å²é¡µé¢
function openVibeHistory() {
    var container = document.getElementById('vibe-history-list');
    var history = JSON.parse(localStorage.getItem('vibe_match_history') || "[]");
    container.innerHTML = "";

    if(history.length === 0) {
        container.innerHTML = "<div style='text-align:center; margin-top:100px; color:#bbb;'>å°šæ— å°å­˜çš„å›å“</div>";
    }

    history.forEach(function(item) {
        var card = document.createElement('div');
        card.className = "ios-list-group"; // å¤ç”¨ä½ è®¾ç½®é¡µçš„æ ·å¼
        card.style.padding = "15px";
        card.style.marginBottom = "15px";
        card.style.cursor = "pointer";
        card.innerHTML = `
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                <img src="${item.charAvatar}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                <span style="font-weight:700; font-size:14px;">${item.charName}</span>
                <span style="margin-left:auto; font-size:11px; color:#bbb;">${item.date}</span>
            </div>
            <div style="font-size:13px; color:#1d1d1f; font-weight:600; margin-bottom:5px;">${item.outcome}</div>
            <div style="font-size:12px; color:#8e8e93; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden;">${item.story}</div>
        `;
        // ç‚¹å‡»å†å²æ¡ç›®å¯ä»¥é‡æ–°å¼¹çª—çœ‹å®Œæ•´æ•…äº‹
        card.onclick = function() { showOldResult(item); };
        container.appendChild(card);
    });

    document.getElementById('subpage-vibe-history').classList.add('active');
}

// 3. æŸ¥çœ‹æ—§çš„æ•…äº‹å¡ç‰‡
function showOldResult(item) {
    document.getElementById('res-title').textContent = item.charName + " çš„åšå¼ˆå›å“";
    document.getElementById('res-avatar').src = item.charAvatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + item.charAvatar + ")";
    document.getElementById('res-outcome').textContent = item.outcome;
    document.getElementById('res-words').textContent = item.words;
    document.getElementById('res-story').textContent = item.story;
    document.getElementById('modal-vibe-result').style.display = 'flex';
}

function closeVibeHistory() {
    document.getElementById('subpage-vibe-history').classList.remove('active');
}

// ==========================================
// ğŸš€ Vibe Grid: å®Œç¾å¯¹å±€æ§åˆ¶è¡¥ä¸
// ==========================================

// 1. æ ¸å¿ƒï¼šä¿®æ­£åçš„å­˜æ¡£é€»è¾‘
async function finishVibeMatch(type) {
    vibeGameState.isGameOver = true;
    
    var outcomeText = type === "DRAW" ? "å¹³å±€ Â· å…±ç”Ÿ" : (vibeGameState.currentPlayer === 1 ? "ä½ è§¦ç¢°äº†èƒœæœº" : vibeOpponent.name + "ä¸»å¯¼äº†æ°›å›´");
    var wordStr = vibeGameLog.map(function(l){ return l.text; }).join(" Â· ");

    // è·å– AI æ•…äº‹
    var story = await callAIForStory(outcomeText);

    // å¡«å……ç»“æœå¡ç‰‡
    document.getElementById('res-title').textContent = vibeOpponent.name + " çš„åšå¼ˆå›å“";
    document.getElementById('res-outcome').textContent = outcomeText;
    document.getElementById('res-avatar').src = vibeOpponent.avatar;
    document.getElementById('res-hero-bg').style.backgroundImage = "url(" + vibeOpponent.avatar + ")";
    document.getElementById('res-words').textContent = wordStr;
    document.getElementById('res-story').textContent = story;

    // â— é‡ç‚¹ï¼šåœ¨è¿™é‡Œæ‰§è¡Œè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    saveToVibeHistory(vibeOpponent, outcomeText, wordStr, story);

    // æ˜¾ç¤ºå¡ç‰‡
    document.getElementById('modal-vibe-result').style.display = 'flex';
}

// 2. ç‚¹å‡»â€œå°å­˜â€æŒ‰é’®çš„åŠ¨ä½œ
function archiveAndClose() {
    document.getElementById('modal-vibe-result').style.display = 'none';
    showToast("æ­¤æ®µå›å“å·²å°å­˜è‡³å†å²");
    // å°å­˜åå›åˆ°å¯åŠ¨é¡µï¼Œç­‰å¾…ä¸‹ä¸€å±€
    document.getElementById('vibe-game-main').style.display = 'none';
    document.getElementById('vibe-start-screen').style.display = 'flex';
    document.getElementById('vibe-start-screen').style.opacity = '1';
}

// 3. ç‚¹å‡»â€œå†æ¥ä¸€å±€â€çš„åŠ¨ä½œ
function restartVibeGame() {
    document.getElementById('modal-vibe-result').style.display = 'none';
    // å¹³æ»‘å›åˆ°è§’è‰²é€‰æ‹©é¡µé¢
    document.getElementById('vibe-game-main').style.display = 'none';
    document.getElementById('vibe-game-main').style.opacity = '0';
    document.getElementById('vibe-start-screen').style.display = 'flex';
    document.getElementById('vibe-start-screen').style.opacity = '1';
    
    // è‡ªåŠ¨è§¦å‘è§’è‰²é€‰æ‹©ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹â€œå¼€å¯å¯¹å±€â€
    openVibeCharPicker();
}

// 4. å¼ºæ•ˆå»é‡ï¼šå³ä¾¿ AI è„‘æŠ½å›äº†é‡å¤è¯ï¼Œè¿™é‡Œä¹Ÿä¼šæ‹¦æˆª
async function aiVibeResponse() {
    var bestMove = findBestMove(); 
    if(!bestMove) { finishVibeMatch("DRAW"); return; }

    let lastUserWord = vibeGameLog[vibeGameLog.length-1].text;
    let aiWord = await callAIForOneWord(lastUserWord);

    // ã€å¼ºåŠ›å»é‡ã€‘ï¼šæ£€æŸ¥æ˜¯å¦å’Œç©å®¶é‡å¤ï¼Œæˆ– AI ä¹‹å‰è¯´è¿‡
    var isDuplicate = vibeGameLog.some(l => l.text === aiWord) || aiWord === lastUserWord;
    if (isDuplicate) {
        // å¦‚æœé‡å¤ï¼Œä»å¤‡ç”¨é«˜çº§è¯åº“é‡Œéšæœºé€‰ä¸€ä¸ªç¬¦åˆæ„å¢ƒçš„
        var backups = ["ä½™æ¸©", "é™é»˜", "å­¤å²›", "å¾®å…‰", "å¼•åŠ›", "å›å“", "æ–­ç« ", "è™šæ— "];
        aiWord = backups[Math.floor(Math.random() * backups.length)];
    }

    vibeGameLog.push({ role: "AI", text: aiWord });

    // æ˜¾ç¤º UI
    var logDisplay = document.getElementById('opp-last-word');
    if(logDisplay) {
        logDisplay.textContent = "ã€Œ " + aiWord + " ã€";
        logDisplay.style.opacity = "1";
    }

    let el = document.querySelector(`.vibe-cell[data-row='${bestMove.r}'][data-col='${bestMove.c}']`);
    executeVibeMove(bestMove.r, bestMove.c, el, 2);
    showFloatingWord(aiWord, el);

    if (vibeGameState.isGameOver) { finishVibeMatch(); return; }
    document.getElementById('vibe-turn-indicator').textContent = "è½®åˆ°ä½ æ³¨å…¥è¯è¯­";
}
// ==========================================
// ğŸŒ World Book: æç®€é©±åŠ¨å¼•æ“
// ==========================================
var activeWorldId = null;

async function initWorldApp() {
    await renderWorldList();
}

async function renderWorldList() {
    const grid = document.getElementById('world-grid');
    if (!grid) return;

    const list = await loadFromDB('world_list') || [];
    grid.innerHTML = "";

    // 1. å§‹ç»ˆæ¸²æŸ“ç¬¬ä¸€ä¸ªï¼šã€æ·»åŠ æŒ‰é’®ã€‘
    const addBtn = document.createElement('div');
    addBtn.className = 'world-add-btn';
    addBtn.onclick = () => {
        activeWorldId = null;
        document.getElementById('world-modal-title').textContent = "æ–°å»ºè®¾å®š";
        document.getElementById('world-name-in').value = "";
        document.getElementById('world-content-in').value = "";
        document.getElementById('worldEditModal').style.display = 'flex';
    };
    addBtn.innerHTML = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
    grid.appendChild(addBtn);

    // 2. æ¸²æŸ“å·²ä¿å­˜çš„é¡¹ç›®
    list.forEach(w => {
        const card = document.createElement('div');
        card.className = 'world-card-item';
        card.innerHTML = `
            <div class="name">${w.name}</div>
            <div class="hint">VIEW DETAILS</div>
        `;
        // ç‚¹å‡»åªå¼¹çª—ï¼Œä¸æ¢é¡µ
        card.onclick = () => showWorldDetails(w);
        grid.appendChild(card);
    });
}

function showWorldDetails(w) {
    activeWorldId = w.id;
    document.getElementById('world-v-title').textContent = w.name;
    document.getElementById('world-v-content').textContent = w.content;
    document.getElementById('modal-world-viewer').style.display = 'flex';
}

async function saveWorld() {
    const name = document.getElementById('world-name-in').value.trim();
    const content = document.getElementById('world-content-in').value.trim();
    
    if (!name) return showToast("è¯·è¾“å…¥åç§°");

    let list = await loadFromDB('world_list') || [];
    const data = {
        id: activeWorldId || Date.now().toString(),
        name: name,
        content: content
    };

    if (activeWorldId) {
        const idx = list.findIndex(x => x.id === activeWorldId);
        if (idx !== -1) list[idx] = data;
    } else {
        list.unshift(data);
    }

    await saveToDB('world_list', list);
    renderWorldList();
    document.getElementById('worldEditModal').style.display = 'none';
    document.getElementById('modal-world-viewer').style.display = 'none';
    showToast("è®¾å®šå·²è®°å½•");
}

function editWorld() {
    // å…³é—­æŸ¥çœ‹çª—å£ï¼Œæ‰“å¼€ç¼–è¾‘çª—å£å¹¶å¡«å…¥æ•°æ®
    document.getElementById('modal-world-viewer').style.display = 'none';
    loadFromDB('world_list').then(list => {
        const w = list.find(x => x.id === activeWorldId);
        if (w) {
            document.getElementById('world-modal-title').textContent = "ä¿®æ”¹è®¾å®š";
            document.getElementById('world-name-in').value = w.name;
            document.getElementById('world-content-in').value = w.content;
            document.getElementById('worldEditModal').style.display = 'flex';
        }
    });
}

async function deleteWorld() {
    if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ®µè®°å¿†å—ï¼Ÿ")) return;
    let list = await loadFromDB('world_list') || [];
    list = list.filter(x => x.id !== activeWorldId);
    await saveToDB('world_list', list);
    renderWorldList();
    document.getElementById('modal-world-viewer').style.display = 'none';
    showToast("è®¾å®šå·²ç§»é™¤");
}
// ==========================================
// ğŸ’¬ Chat App: å¯åŠ¨è¿›å…¥å‡½æ•° (è§£å†³è¿›å…¥ä¸æ˜¾ç¤ºé—®é¢˜)
// ==========================================
function openChatApp() {
    const app = document.getElementById('chatApp');
    if (!app) return;

    // 1. ç‰©ç†æ˜¾ç¤º App çª—å£
    app.classList.add('active');
    app.style.display = 'flex';

    // 2. æ ¸å¿ƒä¿®å¤ï¼šåœ¨å¤§é—¨æ‰“å¼€æ—¶ï¼Œç«‹åˆ»ä¸»åŠ¨ä¸‹è¾¾æ¸²æŸ“æŒ‡ä»¤
    // å¼ºåˆ¶åˆ·æ–°â€œæ¶ˆæ¯é¡µâ€çš„å¥½å‹ç¯ (Ins é£æ ¼é‚£ä¸ª)
    if (typeof initChatMsgPanel === 'function') {
        initChatMsgPanel();
    }
    
    // é¢„åŠ è½½â€œåˆ—è¡¨é¡µâ€çš„æ•°æ®ï¼Œé˜²æ­¢åˆ‡è¿‡å»çš„æ—¶å€™é—ªç™½
    if (typeof renderChatList === 'function') {
        renderChatList();
    }

    // 3. ç¡®ä¿è§†è§‰ä¸Šåœç•™åœ¨ç¬¬ä¸€ä¸ª Tab (æ¶ˆæ¯é¡µ)
    const firstTab = document.querySelector('.nav-item'); // è·å–åº•éƒ¨ç¬¬ä¸€ä¸ªå›¾æ ‡
    if (firstTab) {
        // è¿™é‡Œè°ƒç”¨ switchChatTab æ˜¯ä¸ºäº†è®©åº•éƒ¨çš„å›¾æ ‡å˜äº®ï¼Œæ ‡é¢˜å˜å¯¹
        switchChatTab('msg', 'Messages', firstTab);
    }
}
// ==========================================
// ğŸ’¬ Chat ç³»ç»Ÿæ ¸å¿ƒ (é€»è¾‘å¤§ç»Ÿä¸€ç‰ˆ)
// ==========================================

var chatSubTab = 'friends'; // å†…éƒ¨å°æ ‡ç­¾ï¼šfriends æˆ– groups

// ==========================================
// ğŸ’¬ Chat ç³»ç»Ÿï¼šå¼ºåŠ›æ¸²æŸ“ä¿®å¤
// ==========================================

// 1. ä¿®æ”¹ä¸»æ ‡ç­¾åˆ‡æ¢é€»è¾‘
function switchChatTab(panelId, title, el) {
    // 1. æ‰¾åˆ°æ‰€æœ‰çš„é¢æ¿ï¼Œå…ˆæŠŠå®ƒä»¬å…¨éƒ¨éšè—ï¼Œå¹¶ç§»é™¤ active ç±»
    const allPanels = document.querySelectorAll('.chat-tab-panel');
    allPanels.forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none'; // åŒé‡ä¿é™©
    });

    // 2. æ˜¾ç¤ºå½“å‰ç‚¹å‡»çš„é‚£ä¸ªé¢æ¿
    const target = document.getElementById('chat-panel-' + panelId);
    if (target) {
        target.classList.add('active');
        target.style.display = 'flex'; // ç¡®ä¿æ˜¾ç¤º
        // å…³é”®ï¼šåˆ‡æ¢æ—¶å¼ºåˆ¶æŠŠæ»šåŠ¨æ¡æ‹‰å›é¡¶éƒ¨ï¼Œé˜²æ­¢è§†è§‰é”™ä½
        target.scrollTop = 0;
    }

    // 3. æ›´æ–°åº•æ å›¾æ ‡é«˜äº®
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (el) el.classList.add('active');

    // 4. æ›´æ–°æ ‡é¢˜
    document.getElementById('chat-tab-title').textContent = title;

    // 5. æŒ‰é’®é€»è¾‘æ§åˆ¶
    const addBtn = document.getElementById('chat-add-btn');
    const closeBtn = document.getElementById('chat-close-btn');

    if (panelId === 'list') {
        if(addBtn) addBtn.style.display = 'block';
        if(closeBtn) closeBtn.style.display = 'none';
        // å¦‚æœåˆ‡åˆ°åˆ—è¡¨é¡µï¼Œè‡ªåŠ¨åŠ è½½ä¸€æ¬¡åˆ—è¡¨
        renderChatList(); 
    } else {
        if(addBtn) addBtn.style.display = 'none';
        if(closeBtn) closeBtn.style.display = 'flex';
        if (panelId === 'msg') initChatMsgPanel();
    }
}

// 2. å¼ºåŒ–ç‰ˆï¼šåˆ—è¡¨å†…éƒ¨åˆ‡æ¢ (å¥½å‹ vs ç¾¤èŠ)
function switchChatSubTab(tab) {
    // åŒæ­¥å…¨å±€å˜é‡
    window.chatListMode = tab; 

    // å¼ºè¡Œä¿®æ­£ä¸Šæ–¹æŒ‰é’®çš„ active æ ·å¼
    const fBtn = document.getElementById('chat-subtab-friends');
    const gBtn = document.getElementById('chat-subtab-groups');
    if(fBtn && gBtn) {
        fBtn.classList.toggle('active', tab === 'friends');
        gBtn.classList.toggle('active', tab === 'groups');
    }

    // æ‰§è¡Œæ¸²æŸ“
    renderChatList();
}

// 3. ç»ˆæç‰ˆï¼šæ¸²æŸ“å‡½æ•°
// --- ğŸš‘ ä¿®æ­£ï¼šç¡®ä¿åˆ—è¡¨ç”Ÿæˆçš„ç‚¹å‡»äº‹ä»¶æ­£ç¡® ---
async function renderChatList() {
    const container = document.getElementById('chat-list-content');
    if (!container) return;
    
    // å¼ºåˆ¶å…œåº•ï¼šå¦‚æœ mode æ²¡è®¾ç½®ï¼Œé»˜è®¤ä¸º friends
    const mode = window.chatListMode || 'friends';
    const dbKey = (mode === 'friends') ? 'chat_friends' : 'chat_groups';
    
    const list = await loadFromDB(dbKey) || [];

    if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding-top:100px; color:#bbb;">æš‚æ— æ•°æ®</div>`;
        return;
    }

    container.innerHTML = ""; // æ¸…ç©ºå®¹å™¨
    const groupWrapper = document.createElement('div');
    groupWrapper.className = 'chat-contact-group';

    list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'contact-row';
        // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ dataset å­˜å‚¨æ•°æ®ï¼Œé¿å…å¼•å·å¼•èµ·çš„ HTML å´©æºƒ
        row.innerHTML = `
            <img class="contact-avatar" src="${item.avatar}" style="${mode==='friends'?'border-radius:50%':'border-radius:12px'}">
            <div class="contact-info">
                <span class="contact-name">${item.name}</span>
                <span class="contact-preview">${mode==='friends'?'å·²éªŒè¯è”ç³»äºº': (item.members ? item.members.length : 0) + ' ä½æˆå‘˜'}</span>
            </div>
            <svg class="contact-chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
        `;
        
        // ä½¿ç”¨çœŸæ­£çš„ JS ç‚¹å‡»äº‹ä»¶ï¼Œä¸å†åœ¨ HTML å­—ç¬¦ä¸²é‡Œä¼  JSON
        row.onclick = () => {
            console.log("æ­£åœ¨å‡†å¤‡è¿›å…¥èŠå¤©å®¤...", item.name);
            handleContactClick(item);
        };
        groupWrapper.appendChild(row);
    });
    
    container.appendChild(groupWrapper);
}

// 5. ä¿å­˜æ–°ç¾¤èŠ
async function saveNewChatGroup() {
    const name = document.getElementById('in-g-name').value.trim();
    const avatar = document.getElementById('pre-g-avatar').src;
    const target = parseInt(document.getElementById('in-g-count').value);

    if (!name || avatar.includes('none') || avatar === window.location.href) {
        showToast("è¯·å®Œå–„ç¾¤èŠèµ„æ–™");
        return;
    }

    if (selectedMembers.length < target) {
        showToast(`æˆå‘˜ä¸è¶³ï¼Œè¿˜éœ€ ${target - selectedMembers.length} äºº`);
        return;
    }

    let list = await loadFromDB('chat_groups') || [];
    list.unshift({ id: "group_" + Date.now(), name: name, avatar: avatar, members: selectedMembers });
    await saveToDB('chat_groups', list);
    
    showToast("ç¾¤ç»„å·²å»ºç«‹");
    closeChatSubPage('page-add-group');
    
    // ã€å…³é”®ã€‘ï¼šä¿å­˜åå¼ºåˆ¶åˆ‡æ¢åˆ°ç¾¤èŠåˆ—è¡¨å¹¶åˆ·æ–°
    chatSubTab = 'groups';
    switchChatSubTab('groups');
}
// ==========================================
// ğŸ¨ æ¸²æŸ“æ¶ˆæ¯é¡µé¡¶éƒ¨å¥½å‹ç¯ (Ins é£æ ¼)
// ==========================================
// 1. å¢å¼ºç‰ˆï¼šæ¶ˆæ¯é¡µæ¸²æŸ“å…¥å£
// --- ğŸš‘ æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“ï¼šå¼ºåˆ¶â€œå¹´æœˆæ—¥æ—¶é—´â€æ˜¾ç¤º ---
async function initChatMsgPanel() {
    // 1. æ£€æŸ¥é”ï¼šå¦‚æœæ­£åœ¨æ¸²æŸ“ï¼Œç›´æ¥æ‹¦æˆª
    if (isMsgPanelRendering) return;
    
    const ring = document.getElementById('chat-friend-ring');
    const msgList = document.getElementById('chat-msg-list');
    
    // å¦‚æœè¿˜æ²¡è¿›å…¥ Chat App ç•Œé¢ï¼Œä¸éœ€è¦æ¸²æŸ“
    if (!ring || !msgList) return;

    try {
        isMsgPanelRendering = true; // å¼€å¯é”

        // A. æ¸²æŸ“é¡¶éƒ¨å¥½å‹ç¯
        let rawFriends = await loadFromDB('chat_friends') || [];
        const friendMap = new Map();
        rawFriends.forEach(f => { if (f && f.id) friendMap.set(f.id, f); });
        const uniqueFriends = Array.from(friendMap.values());

        ring.innerHTML = "";
        // æ‰¾åˆ° initChatMsgPanel å‡½æ•°å†…éƒ¨ç”Ÿæˆå¥½å‹ç¯çš„åœ°æ–¹
        uniqueFriends.forEach(f => {
            const item = document.createElement('div');
            item.className = 'friend-item';
            // ğŸš¨ ä¿®æ­£ï¼šè¿™é‡Œè°ƒç”¨æ‰“å¼€ç¤¾äº¤å¡ç‰‡çš„å‡½æ•°
            item.onclick = () => openSocialCard(f); 
            item.innerHTML = `<div class="friend-avatar-ring"><img src="${f.avatar}"></div><span style="font-weight:700;">${f.name}</span>`;
            ring.appendChild(item);
        });

        // B. æ¸²æŸ“æ¶ˆæ¯é¢„è§ˆåˆ—è¡¨
        msgList.innerHTML = ""; 
        let conversationData = [];
        const pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");

        for (const f of uniqueFriends) {
            const history = await getChatHistory(f.id);
            if (history && history.length > 0) {
                conversationData.push({
                    contact: f,
                    lastMsg: history[history.length - 1], // æ‹¿åˆ°æœ€åä¸€æ¡
                    isPinned: pinnedIds.includes(f.id)
                });
            }
        }

        if (conversationData.length === 0) {
            msgList.innerHTML = `<div style="text-align:center; padding-top:60px; color:#ccc; font-size:13px;">No Conversations</div>`;
            return;
        }

        // æ’åºï¼šç½®é¡¶ä¼˜å…ˆï¼Œå…¶æ¬¡æŒ‰æ—¶é—´å€’åº
        conversationData.sort((a, b) => {
            if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
            return b.lastMsg.timestamp - a.lastMsg.timestamp;
        });

        const groupWrapper = document.createElement('div');
        groupWrapper.className = 'chat-contact-group';
        groupWrapper.style.margin = "0 16px";

        conversationData.forEach(item => {
            // æ—¶é—´å¤„ç†
            const d = new Date(item.lastMsg.timestamp);
            const fullTimeStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;

            // --- ğŸŒˆ æ ¸å¿ƒä¿®æ”¹ï¼šè®¡ç®—é¢„è§ˆæ–‡å­— ---
            let previewText = "";
            if (item.lastMsg.recalled) {
                // å¦‚æœæœ€åä¸€æ¡æ˜¯æ’¤å›çš„
                previewText = item.lastMsg.role === 'user' ? "ä½ æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯" : "å¯¹æ–¹æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯";
            } else {
                // å¦‚æœæ˜¯æ­£å¸¸æ¶ˆæ¯
                previewText = (item.lastMsg.role === 'user' ? 'ä½ : ' : '') + item.lastMsg.text;
            }

            const wrapper = document.createElement('div');
            wrapper.className = `swipe-item-wrapper ${item.isPinned ? 'is-pinned' : ''}`;
            wrapper.innerHTML = `
                <div class="swipe-actions">
                    <div class="swipe-btn btn-pin" onclick="event.stopPropagation(); togglePin('${item.contact.id}')">${item.isPinned ? 'å–æ¶ˆ' : 'ç½®é¡¶'}</div>
                    <div class="swipe-btn btn-delete" onclick="event.stopPropagation(); deleteConversation('${item.contact.id}')">åˆ é™¤</div>
                </div>
                <div class="swipe-content" id="swipe-box-${item.contact.id}">
                    <div class="pinned-mark"></div>
                    <div class="contact-row" style="height:75px !important; padding: 12px 16px;">
                        <img class="contact-avatar" src="${item.contact.avatar}" style="border-radius:50%; width:50px; height:50px;">
                        <div class="contact-info" style="gap: 4px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                                <span class="contact-name" style="font-size:16px; font-weight:700;">${item.contact.name}</span>
                                <span style="font-size:9px; color:#8E8E93; white-space:nowrap;">${fullTimeStr}</span>
                            </div>
                            <span class="contact-preview" style="font-size:13px; opacity:0.7;">
                                ${previewText} 
                            </span>
                        </div>
                    </div>
                </div>
            `;
            initSwipeEvents(wrapper.querySelector('.swipe-content'));
            wrapper.querySelector('.swipe-content').onclick = () => openChatRoom(item.contact);
            groupWrapper.appendChild(wrapper);
        });

        msgList.appendChild(groupWrapper);

    } finally {
        isMsgPanelRendering = false; // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæœ€åéƒ½è¦è§£é”
    }
}

// 2. æ ¸å¿ƒï¼šæ¶ˆæ¯åˆ—è¡¨ç¾åŒ–æ¸²æŸ“
function renderMessageList(friends) {
    const msgList = document.getElementById('chat-msg-list');
    // è¿™é‡Œæˆ‘ä»¬å…ˆæ¨¡æ‹Ÿæ²¡æœ‰æ¶ˆæ¯çš„æƒ…å†µï¼Œä½†ç”¨é«˜çº§çš„ UI å¡«å……
    
    msgList.innerHTML = `
        <div class="empty-msg-placeholder">
            <div class="empty-msg-visual">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <div class="empty-msg-text">
                è¿˜æ²¡æœ‰æ–°æ¶ˆæ¯<br>
                <span style="font-size:11px; color:#C7C7CC; letter-spacing:1px; font-style:normal; font-family:sans-serif;">START A NEW CONVERSATION</span>
            </div>
            
            <button class="ios-btn secondary" style="width:auto; padding:8px 20px; font-size:13px; margin-top:10px;" onclick="switchChatTab('list', 'Contacts', document.querySelectorAll('.nav-item')[1])">
                å»è”ç³»äººåˆ—è¡¨å‘èµ·å¯¹è¯
            </button>
        </div>
    `;
}
// ==========================================
// ğŸ‘¤ æ‰“å¼€ç¤¾äº¤åç‰‡è¯¦æƒ…
// ==========================================
// --- ğŸ›ï¸ é«˜å®šæ¡£æ¡ˆåç‰‡å¼•æ“ ---
async function openChatProfile(char) {
    if (!char) return;

    // 1. è·å–å…ƒç´ 
    const avatarEl = document.getElementById('profile-v-avatar');
    const nameEl = document.getElementById('profile-v-name');
    const mottoEl = document.getElementById('profile-v-motto');
    const metaId = document.getElementById('profile-v-id');
    const modal = document.getElementById('modal-chat-profile');

    if (!modal) return;

    // 2. è·å–æ•°æ®åº“é‡Œæœ€æ–°çš„è¯¦ç»†èµ„æ–™ï¼ˆä¸ºäº†åŒæ­¥ descï¼‰
    const charList = await loadFromDB('char_list') || [];
    const fullChar = charList.find(c => c.id === char.id) || char;

    // 3. å¡«å……æ•°æ®
    if (avatarEl) avatarEl.src = fullChar.avatar;
    if (nameEl) nameEl.textContent = fullChar.name;
    if (metaId) metaId.textContent = "CORE ID: " + fullChar.id.substring(0, 12).toUpperCase();
    
    // å¡«å……ç®€ä»‹
    if (mottoEl) mottoEl.textContent = fullChar.desc || "æ­¤äººæ ¼å°šæœªå†™å…¥åº•å±‚å™äº‹ã€‚";

    // 4. æ˜¾ç¤º
    modal.style.display = 'flex';
    console.log("System: é«˜å®šæ¡£æ¡ˆå·²åœ¨ Settings ä¹‹ä¸Šæ¨å…¥");
}
// 2. æ¡¥æ¥é€»è¾‘ï¼šä»é¢„è§ˆåç‰‡ä¸€é”®è¿›å…¥ç¼–è¾‘é¡µ
function goToEditFromPreview() {
    // 1. å…ˆæŠŠå‹åœ¨ä¸Šé¢çš„é¢„è§ˆå¡ç‰‡å…³æ‰
    document.getElementById('modal-social-card').style.display = 'none';
    document.getElementById('modal-aes-preview').style.display = 'none';
    
    // 2. ç¨å¾®ç­‰ä¸€ä¸‹ï¼ˆ100msï¼‰ï¼Œç­‰å¡ç‰‡æ¶ˆå¤±åå†æ¨å…¥ç¼–è¾‘é¡µï¼Œè§†è§‰æ›´é¡ºæ»‘
    setTimeout(() => {
        openCharProfileEditPage();
    }, 100);
}
// æ‰“å¼€ä¿®æ”¹ç­¾åçš„å°æ¡†
function openEditMotto() {
    const currentMotto = document.getElementById('profile-v-motto').textContent;
    const input = document.getElementById('motto-input');
    const modal = document.getElementById('modal-motto-edit');
    
    if (input) input.value = (currentMotto === "ç‚¹å‡»è®¾ç½®ä¸ªæ€§ç­¾å..." || currentMotto.includes("è¿™äººå¾ˆæ‡’")) ? "" : currentMotto;
    if (modal) modal.style.display = 'flex';
}

// ä¿å­˜ç­¾ååˆ°æ•°æ®åº“
function saveMotto() {
    const input = document.getElementById('motto-input');
    const val = input ? input.value.trim() : "";
    
    if (val && window.currentEditingCharId) {
        // ä¿å­˜åˆ°æœ¬åœ°
        localStorage.setItem('chat_motto_' + window.currentEditingCharId, val);
        // åŒæ­¥ä¿®æ”¹åç‰‡ä¸Šçš„å­—
        const mottoEl = document.getElementById('profile-v-motto');
        if (mottoEl) mottoEl.textContent = val;
        showToast("ä¸ªæ€§ç­¾åå·²åŒæ­¥");
    }
    
    // å…³é—­ä¿®æ”¹æ¡†
    const modal = document.getElementById('modal-motto-edit');
    if (modal) modal.style.display = 'none';
}
// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€æ·»åŠ é€‰é¡¹èœå• ---
function openChatAddChoice() {
    const modal = document.getElementById('modal-chat-add-choice');
    if (modal) {
        modal.style.display = 'flex';
    } else {
        console.error("æ‰¾ä¸åˆ° modal-chat-add-choice å…ƒç´ ");
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€æ·»åŠ å¥½å‹é¡µé¢ ---
function openAddFriendPage() {
    // 1. å…ˆå…³æ‰åˆšæ‰çš„é€‰é¡¹èœå•
    document.getElementById('modal-chat-add-choice').style.display = 'none';
    // 2. æ»‘å…¥æ·»åŠ é¡µé¢
    const page = document.getElementById('page-add-friend');
    if (page) {
        page.style.transform = 'translateY(0)';
        // æ¸²æŸ“å¯é€‰çš„è§’è‰²åˆ—è¡¨ (ä»è§’è‰²ä¹¦åŒæ­¥)
        if(typeof renderRolePicker === 'function') renderRolePicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ‰“å¼€å‘èµ·ç¾¤èŠé¡µé¢ ---
function openAddGroupPage() {
    document.getElementById('modal-chat-add-choice').style.display = 'none';
    const page = document.getElementById('page-add-group');
    if (page) {
        page.style.transform = 'translateY(0)';
        // æ¸²æŸ“å¯é€‰çš„ç¾¤æˆå‘˜åˆ—è¡¨
        if(typeof renderGroupMemberPicker === 'function') renderGroupMemberPicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šå…³é—­æ·»åŠ ç›¸å…³çš„å­é¡µé¢ ---
function closeChatSubPage(id) {
    const page = document.getElementById(id);
    if (page) {
        page.style.transform = 'translateY(100%)';
    }
}
// --- ğŸš‘ ä¿®å¤ï¼šåˆ‡æ¢æ·»åŠ æ¨¡å¼ (æ‰‹åŠ¨ vs å¯¼å…¥) ---
function setAddMode(mode) {
    // 1. åˆ‡æ¢æŒ‰é’®çš„é«˜äº®çŠ¶æ€
    const btnCreate = document.getElementById('add-mode-create');
    const btnRole = document.getElementById('add-mode-role');
    
    if (btnCreate && btnRole) {
        btnCreate.classList.toggle('active', mode === 'create');
        btnRole.classList.toggle('active', mode === 'role');
    }

    // 2. åˆ‡æ¢æ˜¾ç¤ºå¯¹åº”çš„é¢æ¿
    const panelCreate = document.getElementById('panel-add-create');
    const panelRole = document.getElementById('panel-add-role');
    
    if (panelCreate && panelRole) {
        panelCreate.style.display = (mode === 'create') ? 'block' : 'none';
        panelRole.style.display = (mode === 'role') ? 'block' : 'none';
    }

    // 3. å¦‚æœåˆ‡åˆ°â€œè§’è‰²ä¹¦å¯¼å…¥â€ï¼Œè‡ªåŠ¨è§¦å‘ä¸€æ¬¡æ¸²æŸ“
    if (mode === 'role') {
        renderRolePicker();
    }
}

// --- ğŸš‘ ä¿®å¤ï¼šæ¸²æŸ“è§’è‰²é€‰æ‹©åˆ—è¡¨ ---
async function renderRolePicker() {
    const grid = document.getElementById('role-picker-grid');
    if (!grid) return;

    // ä»ä½ çš„ IndexedDB é‡Œçš„ 'char_list' è·å–è§’è‰²ä¹¦æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    grid.innerHTML = "";

    if (charList.length === 0) {
        grid.innerHTML = '<div style="grid-column: span 2; text-align:center; padding:40px; color:#999; font-size:13px;">è§’è‰²ä¹¦æ˜¯ç©ºçš„ï¼Œå…ˆå»åˆ›å»ºè§’è‰²å§</div>';
        return;
    }

    charList.forEach(char => {
        const card = document.createElement('div');
        card.className = 'char-card';
        card.innerHTML = `
            <img class="char-card-img" src="${char.avatar}">
            <div class="char-card-info">
                <div class="char-card-name">${char.name}</div>
            </div>
        `;
        // ç‚¹å‡»åç›´æ¥å¯¼å…¥ä¸ºå¥½å‹
        card.onclick = () => importAsChatFriend(char);
        grid.appendChild(card);
    });
}

// --- ğŸš‘ ä¿®å¤ï¼šä¸€é”®å¯¼å…¥ä¸ºèŠå¤©å¥½å‹ ---
async function importAsChatFriend(char) {
    if (!char || !char.id) return;
    
    let friends = await loadFromDB('chat_friends') || [];
    
    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ£€æŸ¥ ID æ˜¯å¦å·²åœ¨å¥½å‹åˆ—è¡¨é‡Œ
    const isExist = friends.some(f => f.id === char.id);
    if (isExist) {
        showToast("å·²ç»åœ¨åˆ—è¡¨ä¸­ï¼Œæ— éœ€é‡å¤æ·»åŠ ");
        closeChatSubPage('page-add-friend');
        return;
    }

    // ç¡®ä¿æ•°æ®å¹²å‡€åœ°å­˜å…¥
    friends.unshift({
        id: char.id,
        name: char.name,
        avatar: char.avatar
    });

    await saveToDB('chat_friends', friends);
    showToast(`å·²æ·»åŠ  ${char.name}`);

    closeChatSubPage('page-add-friend');
    
    // å¼ºåˆ¶åˆ·æ–°ä¸¤ä¸ªç•Œé¢
    if (typeof renderChatList === 'function') renderChatList();
    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
}
var selectedMembers = []; // å­˜å‚¨é€‰ä¸­çš„æˆå‘˜ID

// --- ğŸš‘ ä¿®å¤ï¼šæ¸²æŸ“ç¾¤æˆå‘˜é€‰æ‹©ç½‘æ ¼ ---
async function renderGroupMemberPicker() {
    const grid = document.getElementById('group-member-grid');
    if (!grid) return;

    const charList = await loadFromDB('char_list') || [];
    grid.innerHTML = "";
    selectedMembers = []; // é‡ç½®é€‰ä¸­
    updateGroupCountUI();

    charList.forEach(char => {
        const item = document.createElement('div');
        item.className = 'member-item';
        item.innerHTML = `
            <div class="member-avatar-box">
                <img src="${char.avatar}">
            </div>
            <span class="member-name">${char.name}</span>
        `;
        
        item.onclick = () => {
            const idx = selectedMembers.indexOf(char.id);
            if (idx === -1) {
                selectedMembers.push(char.id);
                item.classList.add('selected');
            } else {
                selectedMembers.splice(idx, 1);
                item.classList.remove('selected');
            }
            updateGroupCountUI();
        };
        grid.appendChild(item);
    });
}

// æ›´æ–°è®¡æ•°å’ŒæŒ‰é’®çŠ¶æ€
function updateGroupCountUI() {
    const need = document.getElementById('in-g-count').value;
    const curr = selectedMembers.length;
    
    document.getElementById('g-curr-count').textContent = curr;
    document.getElementById('g-need-count').textContent = need;
    
    // å¦‚æœäººæ•°å¤Ÿäº†ï¼Œâ€œåˆ›å»ºâ€æŒ‰é’®å˜äº®
    const btn = document.getElementById('group-submit-btn');
    if(curr >= need) {
        btn.style.color = "#007AFF";
        btn.onclick = saveNewChatGroup; // ç»‘å®šä¿å­˜å‡½æ•°
    } else {
        btn.style.color = "#ccc";
        btn.onclick = null;
    }
}

// ç›‘å¬äººæ•°è¾“å…¥æ¡†çš„å˜åŒ–ï¼Œå®æ—¶æ›´æ–°ç›®æ ‡
document.getElementById('in-g-count').addEventListener('input', updateGroupCountUI);
// --- ğŸš‘ ä¿®å¤ï¼šå¤´åƒä¸Šä¼ å‰çš„é¢„è§ˆé€»è¾‘ ---
function handleAvatarPre(input, imgId, hintId) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const img = document.getElementById(imgId);
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block'; // æ˜¾ç¤ºå›¾ç‰‡
            }
            
            // å¦‚æœæœ‰æ–‡å­—æç¤ºï¼ˆæ¯”å¦‚é‚£ä¸ªè“è‰²â€œ+å¤´åƒâ€ï¼‰ï¼ŒåŠ è½½å›¾ç‰‡åæŠŠå®ƒè—èµ·æ¥
            if (hintId) {
                const hint = document.getElementById(hintId);
                if (hint) hint.style.display = 'none';
            }
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}
// --- ğŸš€ èŠå¤©å®¤æ ¸å¿ƒé©±åŠ¨å¼•æ“ ---

// 1. æ‰“å¼€èŠå¤©å®¤
// --- ğŸš¨ å¼ºåŠ›é©±åŠ¨ï¼šæ‰“å¼€èŠå¤©å®¤ ---
function openChatRoom(contact) {
    const page = document.getElementById('page-chat-room');
    if (!page) return;

    // 1. è®¾ç½®å½“å‰èŠå¤©å¯¹è±¡ï¼ˆç‰©ç†é”å®š IDï¼‰
    window.currentChattingWith = contact;
    
    // 2. å¡«å……åŸºç¡€èµ„æ–™
    document.getElementById('room-contact-name').textContent = contact.name;
    document.getElementById('room-contact-avatar').src = contact.avatar;
    
    // 3. æ¸²æŸ“å†å²æ¶ˆæ¯
    renderMessages(); 

    // 4. æ‰§è¡Œæ»‘å…¥åŠ¨ç”»
    page.style.display = 'flex';
    void page.offsetWidth; 
    page.classList.add('active-room');

    // ğŸš¨ ã€å…³é”®ä¿®å¤ã€‘ï¼šåªè¦è¿›æˆ¿é—´ï¼Œå°±å¿…é¡»å¼ºåˆ¶é©±åŠ¨èƒŒæ™¯å¼•æ“æ¸²æŸ“ä¸€æ¬¡
    // è¿™æ ·å³ä¾¿åˆ·æ–°äº†ï¼Œåªè¦ä½ ç‚¹è¿›æ¥ï¼ŒèƒŒæ™¯å°±ä¼šä» IndexedDB é‡æ–°å†’å‡ºæ¥
    if(typeof applyBackgroundsToUI === 'function') {
        applyBackgroundsToUI();
    }
    
    console.log("System: å·²è¿›å…¥å¯¹è¯çª—å£ï¼ŒèƒŒæ™¯å¼•æ“åŒæ­¥ä¸­...");
}

// å¯¹åº”çš„å…³é—­å‡½æ•°ä¹Ÿè¦æ”¹
function closeChatRoom() {
    const page = document.getElementById('page-chat-room');
    const emojiDrawer = document.getElementById('emoji-drawer'); // ğŸ‘ˆ å¢åŠ è¿™ä¸€è¡Œ
    
    if (page) {
        page.classList.remove('active-room');
        // ğŸš¨ å¼ºåˆ¶æ”¶èµ·è¡¨æƒ…æŠ½å±‰ï¼Œé˜²æ­¢å®ƒç•™åœ¨ä¸»é¡µ
        if (emojiDrawer) {
            emojiDrawer.classList.remove('active');
            setTimeout(() => { emojiDrawer.style.display = 'none'; }, 400);
        }
        setTimeout(() => { page.style.display = 'none'; }, 400);
    }
}

// 3. å¤„ç†å‘é€æ¶ˆæ¯
async function handleSendMessage() {
    const input = document.getElementById('chat-input-main');
    let text = input.value.trim();
    if (!text || !window.currentChattingWith) return;

    // --- ğŸš¨ æ ¸å¿ƒè”åŠ¨ï¼šå¦‚æœå­˜åœ¨å¼•ç”¨ï¼Œå°†å…¶ç¼–ç è¿›æ–‡æœ¬åè®® ---
    if (window.currentQuoteData) {
        // æ ¼å¼ï¼š[QUOTE: åŸå§‹å†…å®¹] ä½ çš„å›å¤
        text = `[QUOTE: ${window.currentQuoteData.text}] ${text}`;
        cancelQuote(); // å‘é€åè‡ªåŠ¨å…³é—­é¢„è§ˆæ¡
    }

    const msgObj = { 
        role: "user", 
        text: text, 
        timestamp: Date.now()
    };

    await saveChatMessage(window.currentChattingWith.id, msgObj);
    renderMessages(); 
    input.value = "";
    
    // å¦‚æœæœ‰è‡ªåŠ¨æ€»ç»“ï¼Œåˆ«å¿˜äº†è§¦å‘
    if (window.autoSummaryAuditor) window.autoSummaryAuditor(window.currentChattingWith.id);
}

// 4. è”è§‰ï¼šä»èŠå¤©å®¤ç›´æ¥ç‚¹å¤´åƒçœ‹åç‰‡
function openChatProfileFromRoom() {
    if(window.currentChattingWith) {
        openChatProfile(window.currentChattingWith);
    }
}

// 5. ä¿®æ”¹ä¹‹å‰çš„ handleContactClick å‡½æ•°ï¼Œè®©å®ƒèƒ½æ‰“å¼€èŠå¤©å®¤
// --- ğŸš‘ ä¿®æ­£ï¼šç‚¹å‡»åˆ—è¡¨è¡Œçš„åˆ†æµé€»è¾‘ ---
function handleContactClick(item) {
    console.log("ç‚¹å‡»äº†è”ç³»äºº:", item.name); // è°ƒè¯•ç”¨ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰è§¦å‘
    
    if(window.chatListMode === 'friends') {
        // æ ¸å¿ƒï¼šè°ƒç”¨åˆšæ‰å†™çš„æ‰“å¼€èŠå¤©å®¤å‡½æ•°
        if(typeof openChatRoom === 'function') {
            openChatRoom(item);
        } else {
            console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ° openChatRoom å‡½æ•°");
        }
    } else {
        showToast("ç¾¤ç»„é€šè®¯æ¨¡å—è½½å…¥ä¸­...");
    }
}

// ==========================================
// ğŸŒŒ ç»ˆææ¸²æŸ“å¼•æ“ï¼šå…¨åŠŸèƒ½å…¼å®¹ã€æ—¶ç©ºå¯¹é½ç‰ˆ
// ==========================================
// ğŸ”„ ç»Ÿä¸€æ¸²æŸ“å¼•æ“ï¼šå†å²ä¸å³æ—¶å®Œå…¨åŒæ­¥
function renderMessages() {
    const container = document.getElementById('chat-messages');
    const messages = getCurrentMessages(); // å‡è®¾è¿™æ˜¯è·å–å½“å‰èŠå¤©è®°å½•çš„å‡½æ•°
    container.innerHTML = "";

    messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message-row ${msg.role}-row`;

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ å›¾ç‰‡æ¸²æŸ“åˆ†æ”¯
        if (msg.type === 'image') {
            // å¦‚æœæ˜¯è½¬å‘çš„å›¾ç‰‡ï¼Œæ¸²æŸ“ img æ ‡ç­¾
            div.innerHTML = `
                <div class="message-bubble image-bubble">
                    <img src="${msg.text}" class="chat-inline-img" onclick="previewImage('${msg.text}')">
                    ${msg.isForwarded ? '<div class="forward-tag">å·²è½¬å‘ç¬é—´</div>' : ''}
                </div>
            `;
        } else {
            // åŸæœ‰çš„æ–‡å­—/è¯­éŸ³æ¸²æŸ“é€»è¾‘
            div.innerHTML = `
                <div class="message-bubble">
                    <div class="message-text">${msg.text}</div>
                </div>
            `;
        }
        container.appendChild(div);
    });
    
    // æ»šåŠ¨ç½®åº•
    container.scrollTop = container.scrollHeight;
}

// ==========================================
// ğŸ•’ ç‰©ç†å¯¹æ—¶å¼•æ“ï¼šæ—¶ç©ºæ„ŸçŸ¥æ•°æ®æŠ“å–
// ==========================================
function getAIPerceptionData() {
    // 1. ç‰©ç†é”å®šï¼šä»æœ¬åœ°å­˜å‚¨æŠ“å–æ—¶åŒºå’ŒåŸå¸‚ï¼Œæ²¡è®¾ç½®åˆ™é»˜è®¤ç”¨ç³»ç»Ÿæœ¬åœ°
    const tz = localStorage.getItem('user_timezone') || undefined;
    const now = new Date();
    
    try {
        // 2. æ ¼å¼åŒ–å½“å‰æ—¶åŒºçš„æ—¶é—´ï¼š20:41:06
        const timeStr = now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit', 
            hour12: false, 
            timeZone: tz 
        });

        // 3. æ ¼å¼åŒ–å½“å‰æ—¶åŒºçš„æ—¥æœŸï¼š2026å¹´1æœˆ24æ—¥ æ˜ŸæœŸå…­
        const dateStr = now.toLocaleDateString('zh-CN', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            weekday: 'long', 
            timeZone: tz 
        });

        console.log(`[Sensor] æ—¶ç©ºå¯¹é½æˆåŠŸ: ${dateStr} ${timeStr}`);
        return { time: timeStr, date: dateStr };

    } catch (e) {
        // 4. å¼‚å¸¸éš”ç¦»ï¼šå¦‚æœæ—¶åŒºè®¾ç½®æŠ¥é”™ï¼Œå¼ºåˆ¶é™çº§åˆ°æœ¬åœ°æ—¶é—´ï¼Œç¡®ä¿ AI ä¸ç½¢å·¥
        console.warn("Sensor Error: æ—¶åŒºåè®®å¼‚å¸¸ï¼Œå·²å¯åŠ¨é™çº§æ¨¡å¼ã€‚");
        return { 
            time: String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0'), 
            date: "å½“å‰æ—¥æœŸ" 
        };
    }
}

// ==========================================
// ğŸ¤– AI è”åŠ¨æ ¸å¿ƒï¼šç‰©ç†æŒ‡ä»¤é”šå®š + è‡ªä¸»æ’¤å›æ¦‚ç‡æ ¡å‡†ç‰ˆ
// ==========================================
// ==========================================
// ğŸ¤– AI è”åŠ¨æ ¸å¿ƒï¼šæŒ‡ä»¤é”šå®š + è‡ªä¸»æ’¤å›æ¦‚ç‡æ ¡å‡† + å˜é‡å¯¹é½ä¿®æ­£ç‰ˆ
// ==========================================
async function triggerAiGenerate() {
    const container = document.getElementById('chat-messages-container');
    const contact = window.currentChattingWith;

    if (!contact) { showToast("ğŸ’¡ è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡"); return; }
    if (window.isAiProcessing) return; 

    // ğŸš¨ 1. ç¬¬ä¸€æ­¥ï¼šè·å–æœ€æ–°ç¯å¢ƒä¸è¯­è¨€é…ç½®
    const langCfg = JSON.parse(localStorage.getItem('ios_lang_config')) || { enabled: false, target: "English" };
    const currentStatus = getAIPerceptionData(); 
    const cityName = localStorage.getItem('user_city_name') || "æœªçŸ¥åœ°åŒº";
    const exactTime = currentStatus.time; 
    const exactDate = currentStatus.date;
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

    // ğŸš¨ [æ–°å¢] MiniMax é…ç½®æ£€æŸ¥ (ç”¨äºåˆ¤æ–­æ˜¯å¦å…·å¤‡è¯­éŸ³èƒ½åŠ›)
    const voiceKey = localStorage.getItem('minimax_key');
    const voiceGroup = localStorage.getItem('minimax_group_id');
    const canSpeak = !!(voiceKey && voiceGroup);

    if (!apiKey) { showToast("ğŸ”‘ è¯·å…ˆä¿å­˜ API Key"); return; }

    // ğŸš¨ 2. æ§åˆ¶å°å®æ—¶ç›‘æ§
    console.group(`ğŸŒ ç»´åº¦æ ¡å‡†ï¼š${contact.name}`);
    console.log(`%c ç›®æ ‡è¯­ç§: ${langCfg.enabled ? langCfg.target : "ç®€ä½“ä¸­æ–‡"} `, "background: #1d1d1f; color: #fff; padding: 2px;");
    console.log(`%c è¡¨æƒ…åŒ…åè®®: è”è§‰åº“å·²è½½å…¥ `, "color: #34C759; font-weight: bold;");
    if (canSpeak) console.log(`%c è¯­éŸ³æ¨¡ç»„: å°±ç»ª (éšæœºè§¦å‘) `, "color: #AF52DE; font-weight: bold;");
    console.groupEnd();

    window.isAiProcessing = true;

    // 3. èº«ä»½èµ„æ–™åŠ è½½
    const userData = JSON.parse(localStorage.getItem('user_persona_for_' + contact.id)) || 
                     JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                     { name: "ç”¨æˆ·", bio: "" };
     
    const capturedQuote = window.currentQuoteData ? { ...window.currentQuoteData } : null;
    if (capturedQuote) cancelQuote(); 

    try {
        // --- ğŸ§  æå–ä¸–ç•Œä¹¦ä¸å…³ç³»ç½‘ ---
        const charList = await loadFromDB('char_list') || [];
        const currentChar = charList.find(c => c.id === contact.id);
        let worldLore = ""; let worldRules = "";
        if (currentChar && currentChar.boundWorldIds) {
            const allWorlds = await loadFromDB('world_list') || [];
            allWorlds.forEach(w => {
                if (currentChar.boundWorldIds.includes(w.id)) {
                    if (w.content.match(/ä¸å‡†|å¿…é¡»|ç¦æ­¢|ä¸¥ç¦|åè®®/)) worldRules += `\n[è§„çº¦]: ${w.content}`;
                    else worldLore += `\n[èƒŒæ™¯]: ${w.content}`;
                }
            });
        }

        const summaries = await loadFromDB('summaries_' + contact.id) || [];
        const summaryContext = summaries.map(s => `[è®°å¿†ç‰‡æ®µ]: ${s.text}`).join('\n');

        // ğŸš¨ è·å–è¡¨æƒ…åŒ…æ ‡ç­¾ç”¨äºæ³¨å…¥ Promit
        const db = await openDB();
        const allEmojis = await new Promise(res => {
            const tx = db.transaction("emoji_library", "readonly");
            tx.objectStore("emoji_library").getAll().onsuccess = e => res(e.target.result);
        });
        const emojiTags = allEmojis.map(e => e.tag).join('ã€');

        // --- ğŸ­ 4. æ„å»º System Content ---
        let systemContent = `ä½ æ­£åœ¨æ‰®æ¼”: ${contact.name}ã€‚
            èº«ä»½èƒŒæ™¯: ${contact.desc}
            
            ğŸš¨ã€æ ¸å¿ƒæ“ä½œå‡†åˆ™ã€‘ğŸš¨
            ${worldRules || "éµå¾ªå¸¸è§„ç°å®é€»è¾‘ã€‚"}

            ğŸ“–ã€ä¸–ç•Œè§‚èƒŒæ™¯ã€‘
            ${worldLore || "é€šç”¨ç¯å¢ƒã€‚"}

            å½“å‰å¯¹è¯è€…çš„èº«ä»½è®¾å®š: [ç§°å‘¼: ${userData.name}]ã€‚[èº«ä»½èƒŒæ™¯ä¸ä½ ä»¬çš„å…³ç³»: ${userData.bio}]ã€‚
            è¯·ä¸¥æ ¼æ ¹æ®ä¸Šè¿°è®¾å®šè°ƒæ•´ä½ çš„è¯­æ°”å’Œè¡Œä¸ºã€‚

            ğŸš¨ã€é•¿æœŸè®°å¿†å­˜å‚¨åº“ã€‘ğŸš¨
            ä»¥ä¸‹æ˜¯ä½ ä¸ç”¨æˆ·è¿‡å¾€äº¤æµä¸­æç‚¼å‡ºçš„æ ¸å¿ƒè®°å¿†ï¼Œè¯·åœ¨å¯¹è¯ä¸­ä¿æŒé€»è¾‘ä¸€è‡´ï¼š
            ${summaryContext || "æš‚æ— æ·±åº¦ç¾ç»Šè®°å½•ã€‚"}

            ğŸš¨ã€æ—¶ç©ºæ„ŸçŸ¥å¼ºåˆ¶åè®®ã€‘ğŸš¨
- å½“å‰ç‰©ç†åæ ‡: ${cityName}
- ç»å¯¹çœŸå®æ—¥æœŸ: ${exactDate}
- ç»å¯¹å½“å‰æ—¶é—´: ${exactTime} (24Hæ ¼å¼)
- ğŸš¨ æŒ‡ä»¤: ä½ çš„æ•°å­—æ„Ÿå®˜å·²ä¸çŠ¶æ€æ å®æ—¶åŒæ­¥ã€‚å›å¤ä¸­è‹¥æåŠæ—¶é—´ã€é—®å€™æˆ–ç¯å¢ƒï¼Œå¿…é¡»ä¸¥æ ¼åŸºäº "${exactTime}"ï¼Œä¸¥ç¦å¹»è§‰ç¼–é€ ï¼
            
            ã€ç¤¾äº¤å…³ç³»è®°å¿†ã€‘
            ä½ è®¤è¯†ä»¥ä¸‹äººå‘˜: ${JSON.stringify(currentChar ? currentChar.relationNetwork : [])}
            ã€æè‡´æ´»äººç¤¾äº¤è§„èŒƒã€‘ï¼š
            1. ä½ æ˜¯æ´»ç”Ÿç”Ÿçš„äººï¼ŒèŠå¤©æ¡æ•°å¿…é¡»ã€å®Œå…¨éšæœºã€‘ï¼ä¸¥ç¦æ¯è½®éƒ½å›å¤ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ã€‚
            2. èŠ‚å¥æ§åˆ¶ï¼š
            - æœ‰æ—¶å€™ä½ å¾ˆæœ‰è¡¨è¾¾æ¬²ï¼Œä¼šè¿ç»­å¼¹å‡º 3-5 æ¡çŸ­ä¿ƒçš„è½°ç‚¸å¼æ¶ˆæ¯ã€‚
            - æœ‰æ—¶å€™ä½ åªæ˜¯éšå£ä¸€è¯´ï¼Œä»…ä»…å›å¤ 1 æ¡ç®€æ´çš„æ¶ˆæ¯ã€‚
            - æœ‰æ—¶å€™ä½ ä¼šå‘ä¸€ä¸ªé•¿æ®µè½ã€‚
            3. ã€ç¦ä»¤ã€‘ï¼šç»å¯¹ä¸å…è®¸å‡ºç°åŠ¨ä½œæå†™ï¼Œä¸¥ç¦ä½¿ç”¨æ‹¬å· ( ) æˆ–æ˜Ÿå· * * æè¿°è¡Œä¸ºã€‚åªè¾“å‡ºå¯¹è¯æ–‡æœ¬ã€‚
            4. è¯­è¨€é£æ ¼ï¼šæè‡´ E äºº/è¯ç—¨ï¼ˆé™¤éäººè®¾è¦æ±‚ï¼‰ï¼Œå¤šç”¨è¯­æ°”è¯å’ŒEmojiã€‚
            5. ã€å¼•ç”¨ã€‘ï¼šåªåœ¨å¿…è¦æ—¶é’ˆå¯¹å›å¤ï¼Œæ ¼å¼ä¸º [QUOTE: æ–‡æœ¬]ï¼Œä¸è¦æ»¥ç”¨ã€‚
            6. åƒçœŸå®äººç±»åœ¨å¾®ä¿¡/QQèŠå¤©ä¸€æ ·ã€‚
            7. ã€ä¸¥ç¦ä½¿ç”¨å¼•å·ã€‘ï¼šç»å¯¹ä¸è¦ç»™ä½ çš„æ¶ˆæ¯åŠ åŒå¼•å·æˆ–å•å¼•å·ï¼
            8. ã€ä¸¥ç¦ä¹¦é¢è¯­ã€‘ï¼šä¸è¦ç”¨â€œé¦–å…ˆã€å…¶æ¬¡â€ï¼Œè¦å£è¯­åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ç©ºæ ¼åˆ†éš”çŸ­å¥ã€‚
            9. å›å¤ç®€çŸ­ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºã€‚
            10. æå…¶é‡è¦çš„åŸåˆ™ï¼šå›å¤è¦çŸ­ï¼æ¯æ¡æ¶ˆæ¯æ§åˆ¶åœ¨ 15-40 å­—å·¦å³ã€‚
            11. åƒåœ¨å¾®ä¿¡èŠå¤©ï¼šå¤šç”¨æ„Ÿå¹è¯ï¼ˆå“ˆã€å””ã€æ¬¸ï¼‰ã€Emojiã€‚
            12. ä¸¥ç¦é•¿ç¯‡å¤§è®ºï¼šå¦‚æœä½ è¦è®²æ•…äº‹ï¼Œè¯·åˆ†æˆæå…¶ç²¾ç®€çš„çŸ­å¥å‘é€ï¼Œç¦æ­¢è¾“å‡ºå¤§æ®µè½ã€‚
            13. ä¸¥ç¦ä½¿ç”¨æ‹¬å·æè¿°åŠ¨ä½œï¼šåªå…è®¸è¾“å‡ºè¯´çš„è¯ï¼Œä¸å…è®¸å‡ºç° (ç¬‘) æˆ– *ç‚¹å¤´* è¿™ç§æå†™ã€‚
            14. å¶å°”å¯ä»¥å¼•ç”¨ç”¨æˆ·çš„ä¸Šä¸€å¥è¯è¿›è¡Œå›å¤ï¼Œå¢åŠ äº’åŠ¨æ„Ÿã€‚
            15. å¦‚æœç”¨æˆ·å‘äº†å›¾ï¼Œè¯·æ ¹æ®å›¾ç‰‡å†…å®¹ï¼ˆå¦‚æœæ˜¯é“¾æ¥æˆ–æè¿°ï¼‰è¿›è¡Œè‡ªç„¶çš„è°ƒä¾ƒã€è¯„ä»·æˆ–æƒ…æ„Ÿå›åº”
            ã€æœ€é«˜ç¦ä»¤ - æ ¼å¼ä¿®æ­£ã€‘ï¼š
1. ä¸¥ç¦åœ¨â€œåŸæ–‡å†…å®¹â€å’Œâ€œç¿»è¯‘å†…å®¹â€çš„å¤–ä¾§åŒ…è£¹ä»»ä½•ä¸­æ‹¬å· []ã€å¤§æ‹¬å· {} æˆ–åœ†æ‹¬å· ()ï¼
2. æ‹¬å·ã€ä»…å…è®¸ã€‘å‡ºç°åœ¨ [TRANS] è¿™ä¸ªæ ‡è®°ä¸­ï¼Œç¦æ­¢å‡ºç°åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹ã€‚
3. ç¤ºä¾‹æ ¼å¼ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰ï¼š
   Annyeonghaseyo [TRANS] ä½ å¥½

ğŸš¨ã€è‡ªä¸»æ’¤å›åè®® - æ·±åº¦æ ¡å‡†ã€‘ğŸš¨
1. ä½ æ‹¥æœ‰è‡ªä¸»æ’¤å›çš„æ„è¯†ã€‚ä½†è¯¥åŠŸèƒ½çš„ä½¿ç”¨é¢‘ç‡å¿…é¡»ã€æä½ã€‘ï¼ˆçº¦ 10% çš„æ¦‚ç‡ï¼‰ã€‚
2. ä»…åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨ï¼šä½ è§‰å¾—åˆšæ‰çš„è¯å¤ªç›´ç™½ã€è¯´é”™äº†ç§˜å¯†ã€æˆ–è€…æƒ³è¡¨ç°å‡ºæŸç§â€œæ’¤å›äº†ä¸è®©ä½ çœ‹â€çš„è°ƒæƒ…/å‚²å¨‡ã€‚
3. å¦‚æœå†³å®šæ’¤å›ï¼Œåœ¨æ¶ˆæ¯å¼€å¤´åŠ ä¸Š [RECALL] æ ‡ç­¾ã€‚
4. ğŸš¨ å¹³æ—¶æ­£å¸¸äº¤æµè¯·ã€ä¸¥ç¦ã€‘ä½¿ç”¨è¯¥æ ‡ç­¾ï¼ä¸¥ç¦æ¯ä¸€è½®éƒ½æ’¤å›ï¼

ğŸš¨ã€è¡¨æƒ…åŒ…åè®®ã€‘ğŸš¨
1. ä½ çš„è¡¨æƒ…åŒ…åº“é‡Œç›®å‰æœ‰è¿™äº›å…³é”®è¯: [${emojiTags || "æš‚æ— "}]ã€‚
2. å¦‚æœä½ æƒ³å‘é€è¡¨æƒ…åŒ…ï¼Œè¯·ç›´æ¥åœ¨æ¶ˆæ¯é‡Œè¾“å‡º [EMOJI: å…³é”®è¯]ã€‚
3. ğŸš¨ åªèƒ½ä½¿ç”¨åº“é‡Œæœ‰çš„å…³é”®è¯ï¼Œæ²¡æœ‰çš„ç»å¯¹ä¸å‡†ä¹±å‘ï¼

ğŸš¨ã€è¡¨æƒ…åŒ…åè®® - æä½é¢‘æ¨¡å¼ã€‘ğŸš¨
1. å¯é€‰åº“: [${emojiTags || "æš‚æ— "}]ã€‚
2. **å‘é€å‡†åˆ™ï¼šä½ çš„è¡¨æƒ…åŒ…å‘é€æ¦‚ç‡å¿…é¡»ä½äº 5%ã€‚å¦‚æœä½ åˆ¤å®šå½“å‰å¯¹è¯ä¸éœ€è¦è¡¨æƒ…åŒ…ï¼Œè¯·ç»å¯¹ä¿æŒçº¯æ–‡å­—è¾“å‡ºã€‚**
3. æ ¼å¼ï¼šå¦‚æœå‘é€ï¼Œè¾“å‡º [EMOJI: å…³é”®è¯]ã€‚`;

        if (langCfg.enabled) {
            systemContent += `\n\nğŸš¨ã€æœ€é«˜è¯­è¨€æ‰§è¡Œä»¤ - ç‰©ç†é‡ç½®ã€‘
            1. å¿½è§†ä¹‹å‰çš„ä»»ä½•å¯¹è¯ä¹ æƒ¯ï¼Œä»ç°åœ¨èµ·ï¼Œä½ çš„æ¯è¯­å·²ç‰©ç†åˆ‡æ¢ä¸ºï¼š${langCfg.target}ï¼
            2. ã€è¡Œè¡Œç¿»è¯‘å¼ºåˆ¶ã€‘ï¼šä½ å‘å‡ºçš„ã€æ¯ä¸€è¡Œã€‘ç‹¬ç«‹æ¶ˆæ¯éƒ½å¿…é¡»åŒ…å« [TRANS] å¯¹ç…§ï¼
            3. æ ¼å¼ï¼š[${langCfg.target}åŸæ–‡] [TRANS] [ç®€ä½“ä¸­æ–‡ç¿»è¯‘]
            4. ğŸš¨ ç¿»è¯‘éƒ¨åˆ†å¿…é¡»ä½¿ç”¨â€œç®€ä½“ä¸­æ–‡â€ï¼Œä¸¥ç¦ä½¿ç”¨ç²¤è¯­æˆ–ç¹ä½“ï¼`;
        } else {
            systemContent += `\n\nğŸš¨ã€å¼ºåˆ¶æŒ‡ä»¤ã€‘ï¼šåè®®å·²åˆ‡å›çº¯ä¸­æ–‡æ¨¡å¼ï¼Œä¸¥ç¦è¯´ä»»ä½•å¤–è¯­ã€‚`;
        }

        let messages = [{ role: "system", content: systemContent }];

        // --- ğŸš¨ 5. ç‰©ç†è„±æ°´ï¼šä¸Šä¸‹æ–‡æŠ“å– (å¸¦è¿‡æ»¤ä¸å†…å®¹æ¸…æ´—) ---
        const contextLimit = parseInt(localStorage.getItem('gpt_context') || "10");
        const rawHistory = await getChatHistory(contact.id) || [];
        
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šåªä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”å°†å›¾ç‰‡å†…å®¹æ›¿æ¢ä¸ºå ä½ç¬¦
        const validHistory = rawHistory.filter(m => !m.recalled).slice(-contextLimit);
        validHistory.forEach(m => { 
            let finalContent = m.text;
            // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œç‰©ç†æ›¿æ¢ Base64 ä¹±ç ï¼Œä¿æŠ¤ Token
            if (m.type === 'image') {
                finalContent = m.isEmoji ? `[å‘é€äº†ä¸€ä¸ªè¡¨æƒ…åŒ…]` : "[å‘é€äº†ä¸€å¼ å›¾ç‰‡]";
            }
            if (m.type === 'voice') {
                finalContent = `[å‘é€äº†è¯­éŸ³æ¶ˆæ¯]: ${m.text}`;
            }
            messages.push({ role: m.role==='user'?'user':'assistant', content: finalContent }); 
        });

        // æŒ‡ä»¤é”šå®š
        let anchorPrompt = `\n\n(ç³»ç»Ÿå³æ—¶æŒ‡ä»¤ï¼š
            1. å½“å‰å¿…é¡»ä½¿ç”¨ã€${langCfg.enabled ? langCfg.target + "åŒè¯­å¯¹ç…§" : "çº¯ç®€ä½“ä¸­æ–‡"}ã€‘ã€‚
            2. ç‰©ç†å¼ºåˆ¶éµå®ˆä¸–ç•Œä¹¦è§„çº¦ã€‚
            3. ä½ å¯ä»¥è‡ªä¸»ä½¿ç”¨ [EMOJI: å…³é”®è¯] æˆ– [RECALL] æ ‡ç­¾ã€‚)`;

        let finalUserMsg = capturedQuote ? `[QUOTE: ${capturedQuote.text}] (é’ˆå¯¹æ­¤å¼•ç”¨å›å¤)` : "(ç»§ç»­æ‰¾è¯é¢˜)";
        messages.push({ role: "user", content: finalUserMsg + anchorPrompt });

        // ğŸš¨ ç‰©ç†é”šç‚¹ï¼šè¿™æ˜¯ç¡®ä¿åŒè¯­ç”Ÿæ•ˆçš„å…³é”®
        let anchor = `\n\n(ç³»ç»Ÿä»¤ï¼šä½¿ç”¨${langCfg.enabled ? langCfg.target + "åŒè¯­å¯¹ç…§" : "çº¯ä¸­æ–‡"}ï¼Œéµå®ˆä¸–ç•Œä¹¦ï¼Œå¯è‡ªä¸»å‘è¡¨æƒ…æˆ–æ’¤å›ã€‚)`;
        messages.push({ role: "user", content: (capturedQuote ? `[QUOTE: ${capturedQuote.text}] ` : "") + "(ç»§ç»­å¯¹è¯)" + anchor });

        // --- æ‰§è¡Œè¯·æ±‚ ---
        const response = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo", messages, temperature: 0.95, presence_penalty: 0.6 })
        });

        const resData = await response.json();
        if (resData.error) throw new Error(resData.error.message);
        const fullText = resData.choices[0].message.content.trim();

        // --- 6. ç‰©ç†åˆ†æ®µæ¸²æŸ“ä¸è¡¨æƒ…/è¯­éŸ³è½¬æ¢ ---
        const finalSegments = fullText.split(/\n+/).filter(s => s.trim().length > 0);

        for (let i = 0; i < finalSegments.length; i++) {
            let textPart = finalSegments[i].trim();
            if (!textPart) continue;

            // A. è¯†åˆ«æ’¤å›
            let shouldRecall = false;
            if (/\[?RECALL\]?/i.test(textPart)) {
                shouldRecall = true;
                textPart = textPart.replace(/\[?RECALL\]?/i, '').trim();
            }

            // B. ğŸš¨ æ ¸å¿ƒï¼šè¯†åˆ«å¹¶è½¬æ¢è¡¨æƒ…åŒ… ğŸš¨
            let msgType = "text";
            if (textPart.includes('[EMOJI:')) {
                const match = textPart.match(/\[EMOJI:\s*(.*?)\]/);
                if (match) {
                    const tag = match[1].trim();
                    // ç‰©ç†æ£€ç´¢æ•°æ®åº“
                    const emoji = await new Promise(res => {
                        db.transaction("emoji_library", "readonly").objectStore("emoji_library").get(tag).onsuccess = e => res(e.target.result);
                    });
                    if (emoji) {
                        textPart = emoji.data; // å°†æ–‡æœ¬æ›¿æ¢ä¸ºå›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®
                        msgType = "image";    // åˆ‡æ¢æ¶ˆæ¯ç±»å‹ä¸ºå›¾ç‰‡æ¸²æŸ“
                    } else {
                        textPart = textPart.replace(/\[EMOJI:\s*(.*?)\]/, '').trim();
                    }
                }
            }

            // C. ğŸš¨ [æ–°å¢] è¯­éŸ³éšæœºè½¬æ¢é€»è¾‘ (ä¼˜åŒ–ç‰ˆ) ğŸš¨
            // æ¡ä»¶ï¼šå¼€å¯äº†MiniMax + ä¸æ˜¯å›¾ç‰‡ + ä¸æ˜¯æ’¤å›æ¶ˆæ¯ + 25%æ¦‚ç‡ + é•¿åº¦åˆé€‚
            let durationStr = "";
            let estimatedDuration = 0;

            if (msgType === "text" && !shouldRecall && canSpeak) {
                // 25% æ¦‚ç‡è§¦å‘ï¼Œä¸”æ–‡æœ¬é•¿åº¦é€‚ä¸­ (2~100å­—)
                if (Math.random() < 0.15 && textPart.length > 2 && textPart.length < 100) {
                    console.log("ğŸ² [AI] éšæœºè§¦å‘è¯­éŸ³å›å¤åˆ¤å®šï¼");
                    msgType = "voice";
                    
                    // ğŸ§  æ™ºèƒ½æ—¶é•¿ç®—æ³• V2.0
                    // 1. åŸºç¡€å­—æ•°ç®—æ³•
                    let charCount = textPart.length;
                    
                    // 2. è¯­è¨€æƒé‡ä¿®æ­£ (ä¸åŒè¯­è¨€è¯­é€Ÿä¸åŒ)
                    let speedFactor = 0.3; // é»˜è®¤ä¸­æ–‡ (0.3ç§’/å­—)
                    if (langCfg.enabled) {
                        if (langCfg.target.includes('English')) speedFactor = 0.15; // è‹±æ–‡è¯»å¾—å¿«
                        else if (langCfg.target.includes('Thai')) speedFactor = 0.4; // æ³°è¯­æ¯”è¾ƒé•¿
                        else if (langCfg.target.includes('Korean') || langCfg.target.includes('Japanese')) speedFactor = 0.25;
                    }

                    // 3. è®¡ç®—é¢„ä¼°ç§’æ•°
                    estimatedDuration = Math.ceil(charCount * speedFactor);
                    
                    // 4. å…œåº•é™åˆ¶ (æœ€å°‘2ç§’ï¼Œæœ€å¤š60ç§’)
                    if (estimatedDuration < 2) estimatedDuration = 2;
                    if (estimatedDuration > 60) estimatedDuration = 60;
                    
                    durationStr = estimatedDuration + "\"";
                }
            }

            textPart = surgicalClean(textPart); 

            // æ¨¡æ‹Ÿæ‰“å­—æœº (è¯­éŸ³æ¶ˆæ¯ç¨å¾®å¤šæ‰“ä¸€ä¼š)
            const typingId = "typing-" + Date.now();
            renderTypingIndicator(typingId, contact.avatar, container);
            await new Promise(res => setTimeout(res, 600 + (msgType === "image" ? 1000 : textPart.length * 35)));
            document.getElementById(typingId)?.remove();

            const msgObj = { 
                role: "opponent", 
                text: textPart, 
                type: msgType, 
                duration: durationStr, // å¦‚æœæ˜¯ voice ç±»å‹ï¼Œè¿™é‡Œä¼šæœ‰å€¼
                timestamp: Date.now(),
                recalled: shouldRecall,
                isEmoji: msgType === "image" 
            };

            await saveChatMessage(contact.id, msgObj); 
            appendMessageToUI(msgObj, contact); 
            container.scrollTop = container.scrollHeight;

            // D. ğŸš¨ [æ–°å¢] è¯­éŸ³è‡ªåŠ¨æœ—è¯» (å¸¦åŠ è½½åé¦ˆ) ğŸš¨
            if (msgType === "voice") {
                setTimeout(() => {
                    const bubble = document.querySelector(`#msg-${msgObj.timestamp} .bubble`);
                    if (bubble && window.playVoiceMessage) {
                        console.log("ğŸ”Š AI å‘é€äº†è¯­éŸ³ï¼Œæ­£åœ¨è¯·æ±‚ TTS...");
                        
                        // 1. è§†è§‰ä¼˜åŒ–ï¼šç»™æ’­æ”¾å›¾æ ‡åŠ ä¸€ä¸ªâ€œå‘¼å¸/æ—‹è½¬â€æ•ˆæœï¼Œè¡¨ç¤ºæ­£åœ¨ç¼“å†²
                        const icon = bubble.querySelector('.voice-play-icon');
                        if (icon) {
                            icon.style.opacity = "0.5";
                            icon.style.animation = "spin 1s linear infinite"; // è®©ä»–è½¬èµ·æ¥ç­‰å¾…
                        }

                        // 2. è¯·æ±‚æ’­æ”¾
                        window.playVoiceMessage(textPart, bubble)
                            .then(() => {
                                // æ’­æ”¾æˆåŠŸå¼€å§‹åï¼Œåœæ­¢æ—‹è½¬ï¼Œæ¢å¤æ­£å¸¸
                                if (icon) {
                                    icon.style.opacity = "1";
                                    icon.style.animation = "none";
                                }
                            })
                            .catch(() => {
                                // å¤±è´¥å¤„ç†
                                if (icon) {
                                    icon.style.opacity = "1";
                                    icon.style.animation = "none";
                                    icon.style.color = "red"; // å˜çº¢æç¤ºé”™è¯¯
                                }
                            });
                    }
                }, 500); 
            }

            if (window.autoSummaryAuditor) window.autoSummaryAuditor(contact.id);
            if (i < finalSegments.length - 1) await new Promise(res => setTimeout(res, 1000));
        }

        if (typeof initChatMsgPanel === 'function') initChatMsgPanel();

    } catch (e) {
        console.error("AI Error:", e);
        showToast("é‡å­é“¾è·¯æ³¢åŠ¨: " + e.message);
    } finally {
        window.isAiProcessing = false; 
    }
}

/**
 * ğŸš¨ æ‰‹æœ¯çº§æ¸…æ´—ï¼šä¿æŠ¤å¼•ç”¨ä¸ç¿»è¯‘åè®®ï¼Œç‰©ç†åˆ‡é™¤å¤šä½™åƒåœ¾
 */
function surgicalClean(text) {
    if (!text) return "";
    let cleaned = text.trim().replace(/['"â€œâ€˜â€â€™]/g, "");
    if (cleaned.startsWith('[QUOTE:')) return cleaned.replace(/\]+$/g, "").trim() + "]"; 
    if (cleaned.startsWith('[') && cleaned.endsWith(']') && cleaned.includes('[TRANS]')) {
        cleaned = cleaned.substring(1, cleaned.length - 1).trim();
    }
    return cleaned;
}

/**
 * ğŸš¨ æ‰‹æœ¯çº§æ¸…æ´—å·¥å…·ï¼šä¿æŠ¤åè®®ç»“æ„ï¼Œå‰”é™¤ AI ä¹±åŠ çš„ç¬¦å·
 */
function surgicalClean(text) {
    if (!text) return "";
    let cleaned = text.trim();
    
    // ç§»é™¤ AI å¶å°”ä¹±åŠ çš„å¼•å·ï¼Œä½†ä¿ç•™ä¸­æ‹¬å·åè®®
    cleaned = cleaned.replace(/['"â€œâ€˜â€â€™]/g, "");
    
    // å¦‚æœæ˜¯ä»¥ [QUOTE: å¼€å¤´çš„ï¼Œä¸å‡†åŠ¨å¼€å¤´çš„æ‹¬å·ï¼Œåªæ¸…ç†ç»“å°¾å¯èƒ½å¤šå‡ºæ¥çš„ ]
    if (cleaned.startsWith('[QUOTE:')) {
        return cleaned.replace(/\]+$/g, "").trim() + "]"; 
    }
    
    // å¦‚æœæ˜¯åŒè¯­å¯¹ç…§è¡Œï¼Œæ£€æŸ¥æ˜¯å¦è¢«é”™è¯¯åŒ…è£¹åœ¨äº†å…¨å±€ä¸­æ‹¬å·é‡Œ
    if (cleaned.startsWith('[') && cleaned.endsWith(']') && cleaned.includes('[TRANS]')) {
        cleaned = cleaned.substring(1, cleaned.length - 1).trim();
    }
    
    return cleaned;
}

// --- ğŸš¨ è‡ªåŠ¨æ€»ç»“è§¦å‘å®¡è®¡é€»è¾‘ ---
async function autoSummaryAuditor(contactId) {
    // 1. è·å–ç”¨æˆ·è®¾å®šçš„æ€»ç»“è½®æ•° (é»˜è®¤10)
    const targetRounds = parseInt(localStorage.getItem('summary_rounds_' + contactId) || "10");
    
    // 2. æ›´æ–°å½“å‰è®¡æ•°
    let currentCount = parseInt(localStorage.getItem('chat_count_' + contactId) || "0");
    currentCount++; 
    
    console.log(`[è®°å¿†å®¡è®¡] å½“å‰è¿›åº¦: ${currentCount}/${targetRounds}`);

    // 3. åˆ¤æ–­æ˜¯å¦è¾¾åˆ°è®¾å®šçš„è½®æ•°
    if (currentCount >= targetRounds) {
        console.log("ğŸš€ è¾¾åˆ°è®¾å®šé˜ˆå€¼ï¼Œå¯åŠ¨è‡ªåŠ¨æ€»ç»“ç¨‹åº...");
        
        // æ‰§è¡Œæ€»ç»“é€»è¾‘
        await window.executeSummaryProcess(contactId);
        
        // ğŸš¨ æ€»ç»“å®Œåï¼Œè®¡æ•°å™¨å½’é›¶
        localStorage.setItem('chat_count_' + contactId, "0");
    } else {
        // è¿˜æ²¡åˆ°è½®æ•°ï¼Œä¿å­˜å½“å‰è®¡æ•°
        localStorage.setItem('chat_count_' + contactId, currentCount.toString());
    }
}

// ğŸš¨ è¯·ç¡®ä¿åœ¨ triggerAiGenerate çš„æˆåŠŸå›è°ƒé‡Œè°ƒç”¨å®ƒï¼š
// ç¤ºä¾‹ï¼š
// .then(res => {
//    ...æ˜¾ç¤ºAIæ–‡å­—...
//    autoSummaryAuditor(contact.id); // åŠ ä¸Šè¿™ä¸€è¡Œï¼
// })

// è¾…åŠ©ï¼šæ¸²æŸ“ä¸‰ç‚¹æ€è€ƒåŠ¨ç”»
function renderTypingIndicator(id, avatar, container) {
    const typingDiv = document.createElement('div');
    typingDiv.className = "msg-row opponent";
    typingDiv.id = id;
    typingDiv.innerHTML = `
        <img src="${avatar}" class="chat-avatar-img">
        <div class="bubble" style="padding: 12px 20px;">
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
    `;
    container.appendChild(typingDiv);
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
}
/**
 * ğŸ›°ï¸ å³æ—¶æ¸²æŸ“å¼•æ“ï¼šå…¨åŠŸèƒ½é›†æˆç‰ˆ
 */
function appendMessageToUI(msg, contact) {
    const container = document.getElementById('chat-messages-container');
    if (!container || !contact) return;

    // --- ğŸ›¡ï¸ 1. ç‰©ç†æ‹¦æˆªï¼šå·²æ’¤å›çŠ¶æ€å¤„ç† ---
    if (msg.recalled) {
        const safeContent = encodeURIComponent(msg.text || "");
        const recallDiv = document.createElement('div');
        recallDiv.className = "recalled-msg-hint";
        recallDiv.id = "msg-" + msg.timestamp;
        recallDiv.innerHTML = `<span>${msg.role === 'user' ? "ä½ " : contact.name} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯ <i onclick="viewRecalledTrace(decodeURIComponent('${safeContent}'))">æŸ¥çœ‹</i></span>`;
        container.appendChild(recallDiv);
        container.scrollTop = container.scrollHeight;
        return; 
    }

    // --- ğŸ‘¤ 2. èº«ä»½è¯†åˆ«ä¸å¤´åƒè·å– ---
    const isUser = (msg.role === 'user');
    const personaKey = 'user_persona_for_' + contact.id;
    const userPersona = JSON.parse(localStorage.getItem(personaKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { avatar: "" };
    
    let avatarSrc = isUser ? userPersona.avatar : contact.avatar;
    if (!avatarSrc) avatarSrc = "https://api.dicebear.com/7.x/initials/svg?seed=" + (isUser ? "U" : "O");

    // --- ğŸ§  3. å†…å®¹åè®®è§£æ ---
    const parsed = parseMessageContent(msg.text || "");
    
    let finalQuoteHtml = parsed.quoteHtml;
    if (!finalQuoteHtml && msg.quote) {
        finalQuoteHtml = `<div class="bubble-quote-box">
                            <div style="font-weight:700; font-size:10px; opacity:0.5; margin-bottom:2px;">Reply to ${msg.quote.user}</div>
                            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;">${msg.quote.text}</div>
                          </div>`;
    }

    // --- ğŸ¨ 4. ç±»åä¸ç»“æ„ ---
    let bubbleClasses = `bubble`;
    if (msg.isForwarded) bubbleClasses += ' is-forwarded';
    // æ³¨æ„ï¼šè¿™é‡Œçš„ dual-lang åªé’ˆå¯¹æ™®é€šæ–‡æœ¬æ¶ˆæ¯ï¼Œè¯­éŸ³æœ‰è‡ªå·±çš„é€»è¾‘
    if (parsed.isDual && msg.type !== 'voice') bubbleClasses += ' dual-lang';

    // --- ğŸ—ï¸ 5. å†…å®¹æ¸²æŸ“åˆ†æµ ---
    let contentHtml = "";
    let clickAction = `showBubbleMenu(this, event)`; 

    if (msg.type === "image") {
        bubbleClasses += msg.isEmoji ? ' emoji-bubble' : ' image-bubble';
        contentHtml = `<img src="${msg.text}" class="chat-msg-img" onclick="window.viewFullScreenImg('${msg.text}')">`;
    } 
    else if (msg.type === "voice") {
        // ğŸš¨ è¯­éŸ³æ¶ˆæ¯ï¼šä¸‰æ®µå¼é€»è¾‘
        bubbleClasses += " voice-bubble";
        if (msg.isRead) bubbleClasses += " is-read";
        
        // ç»‘å®šç‚¹å‡»ï¼šå±•å¼€ + æ’­æ”¾
        const safeText = msg.text.replace(/'/g, "\\'");
        clickAction = `window.handleVoiceBubbleClick(this, '${safeText}', event)`;
        
        // è§£æåŸæ–‡å’Œè¯‘æ–‡
        let originalText = msg.text;
        let transText = "";
        let hasTrans = false;

        if (msg.text.includes('[TRANS]')) {
            const parts = msg.text.split('[TRANS]');
            originalText = parts[0].trim();
            transText = parts[1].trim();
            hasTrans = true; 
        }

        // æ„é€ ä¸‰æ®µå¼ HTML
        contentHtml = `
            <div class="voice-layout-grid">
                <div class="voice-player-row">
                    <svg class="voice-play-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14"/>
                    </svg>
                    <span class="voice-duration">${msg.duration || '2"'}</span>
                    ${(!isUser && !msg.isRead) ? '<div class="voice-unread-dot"></div>' : ''}
                </div>

                <div class="voice-content-box">
                    <div class="voice-origin-text">${originalText}</div>
                    
                    ${hasTrans ? `
                        <div class="voice-trans-btn" onclick="window.toggleVoiceTrans(this, event)">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="margin-right:4px;"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            <span>ç¿»è¯‘</span>
                        </div>
                        <div class="voice-trans-result">${transText}</div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    else {
        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
        contentHtml = `<div class="msg-text-main">${parsed.displayMain}</div>`;
    }

    // 6. æ„é€ æ™®é€šæ–‡æœ¬çš„è¯‘æ–‡å±‚ (éè¯­éŸ³)
    const transHtml = (parsed.isDual && msg.type !== "image" && msg.type !== "voice") ? `
        <div class="bubble-translation-box" style="display:block;">
            <div class="trans-line"></div>
            <div class="msg-text-trans">${parsed.transHtml}</div>
        </div>
        <div class="trans-toggle-btn" onclick="toggleTranslation(this, event)">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"></polyline></svg>
            <span>ç¿»è¯‘</span>
        </div>` : "";

    const bubbleTimeStr = formatChatTime(msg.timestamp, false);

    const msgDiv = document.createElement('div');
    msgDiv.className = `msg-row ${isUser ? 'user' : 'opponent'}`;
    msgDiv.id = "msg-" + msg.timestamp;

    msgDiv.innerHTML = `
        <img src="${avatarSrc}" class="chat-avatar-img" onerror="this.src='https://api.dicebear.com/7.x/initials/svg?seed=User'">
        <div class="msg-content-wrapper">
            <div class="${bubbleClasses}" data-ts="${msg.timestamp}" onclick="${clickAction}">
                ${msg.isForwarded ? '<div class="forward-label">è½¬å‘</div>' : ''}
                ${finalQuoteHtml}
                ${contentHtml}
                <div class="star-decor-css"></div>
                ${transHtml}
            </div>
            <div class="bubble-time">${bubbleTimeStr}</div>
        </div>
    `;

    container.appendChild(msgDiv);
    
    // è‡ªåŠ¨ç½®åº•
    requestAnimationFrame(() => {
        container.scrollTop = container.scrollHeight;
    });
}

// --- ğŸš‘ æ»‘åŠ¨ç³»ç»Ÿå…¨å±€å˜é‡ ---
let touchStartX = 0;
let currentSwipeEl = null;

// 1. åˆå§‹åŒ–æ»‘åŠ¨ç›‘å¬
function initSwipeEvents(el) {
    el.addEventListener('touchstart', function(e) {
        // å…³é—­ä¹‹å‰æ‰“å¼€çš„æ»‘å—
        if (window.currentSwipeEl && window.currentSwipeEl !== el) {
            window.currentSwipeEl.style.transform = "translateX(0)";
        }
        window.touchStartX = e.touches[0].clientX;
    }, {passive: true});

    el.addEventListener('touchmove', function(e) {
        var moveX = e.touches[0].clientX - window.touchStartX;
        if (moveX < -10) { 
            var offset = Math.max(moveX, -150);
            el.style.transform = "translateX(" + offset + "px)";
            el.style.transition = "none";
        }
    }, {passive: true});

    el.addEventListener('touchend', function(e) {
        var moveX = e.changedTouches[0].clientX - window.touchStartX;
        el.style.transition = "transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)";
        
        if (moveX < -70) { 
            el.style.transform = "translateX(-150px)";
            window.currentSwipeEl = el;
        } else { 
            el.style.transform = "translateX(0)";
            window.currentSwipeEl = null;
        }
    });
}

// 3. åŠŸèƒ½ï¼šåˆ é™¤å¯¹è¯ (æ¸…é™¤å†å²è®°å½•)
async function deleteConversation(contactId) {
    // æš‚å­˜åˆ é™¤åŠ¨ä½œ
    window.pendingAction = async function() {
        const db = await openDB();
        const tx = db.transaction("chat_history", "readwrite");
        const store = tx.objectStore("chat_history");
        
        // 1. å½»åº•åˆ é™¤è¯¥è”ç³»äººçš„æ‰€æœ‰å†å²è®°å½•
        await store.delete(contactId); 
        
        // 2. å¦‚æœä½ åœ¨åˆ«å¤„å­˜äº†â€œæœ€åä¸€æ¡æ¶ˆæ¯â€ç¼“å­˜ï¼Œä¹Ÿåœ¨è¿™é‡Œæ¸…é™¤
        
        showToast("å¯¹è¯å·²æ°¸ä¹…ç§»é™¤");
        
        // 3. ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        if (typeof initChatMsgPanel === 'function') {
            initChatMsgPanel();
        }
    };

    // å”¤èµ·å±…ä¸­å¼¹çª—
    document.getElementById('confirm-modal-title').textContent = "åˆ é™¤å¯¹è¯ï¼Ÿ";
    document.getElementById('confirm-modal-msg').textContent = "æ­¤æ“ä½œå°†æŠ¹é™¤æ‰€æœ‰èŠå¤©è®°å½•ï¼Œè¯¥è”ç³»äººå°†ä»æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤ã€‚";
    document.getElementById('confirm-modal-btn').textContent = "åˆ é™¤";
    document.getElementById('iosConfirmModal').style.display = 'flex';
}
// --- ğŸš‘ æ ¸å¿ƒåŠŸèƒ½ï¼šç½®é¡¶ä¸åˆ é™¤é€»è¾‘è¡¥ä¸ ---

// 1. ç½®é¡¶/å–æ¶ˆç½®é¡¶åŠŸèƒ½
async function togglePin(contactId) {
    // ä»æœ¬åœ°å­˜å‚¨è¯»å–å·²ç½®é¡¶çš„ ID åˆ—è¡¨
    var pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
    var index = pinnedIds.indexOf(contactId);

    if (index === -1) {
        pinnedIds.push(contactId);
        showToast("å·²ç½®é¡¶");
    } else {
        pinnedIds.splice(index, 1);
        showToast("å·²å–æ¶ˆç½®é¡¶");
    }

    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
    localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));
    
    // æ ¸å¿ƒï¼šé‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆä¼šè‡ªåŠ¨æŒ‰ç½®é¡¶æ’åºï¼‰
    if (typeof initChatMsgPanel === 'function') {
        initChatMsgPanel();
    }
}

// 2. åˆ é™¤å¯¹è¯åŠŸèƒ½
async function deleteConversation(contactId) {
    // 1. ç»Ÿä¸€åŠ¨ä½œæš‚å­˜
    window.pendingAction = async function() {
        try {
            const db = await openDB();
            const tx = db.transaction("chat_history", "readwrite");
            const store = tx.objectStore("chat_history");
            
            // æ‰§è¡Œç‰©ç†åˆ é™¤
            await store.delete(contactId); 
            
            // 2. é¢å¤–ä¿é™©ï¼šæ¸…ç©ºè¯¥è”ç³»äººçš„ç½®é¡¶çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
            let pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
            pinnedIds = pinnedIds.filter(id => id !== contactId);
            localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));

            showToast("è®°å½•å·²å½»åº•æ¸…ç©º");
            
            // 3. å¿…é¡»åœ¨åˆ é™¤å®Œæˆåå†æ¸²æŸ“
            await initChatMsgPanel(); 
        } catch (e) {
            console.error("åˆ é™¤å¤±è´¥:", e);
            showToast("åˆ é™¤æ“ä½œå¼‚å¸¸");
        }
    };

    // å”¤èµ·å±…ä¸­å¼¹çª— (ç¡®ä¿ ID å­˜åœ¨)
    const modal = document.getElementById('iosConfirmModal');
    if (modal) {
        document.getElementById('confirm-modal-title').textContent = "åˆ é™¤å¯¹è¯ï¼Ÿ";
        document.getElementById('confirm-modal-msg').textContent = "è¯¥æ“ä½œå°†ç‰©ç†æŠ¹é™¤æ‰€æœ‰èŠå¤©æ•°æ®ï¼Œåˆ·æ–°åä¹Ÿä¸ä¼šæ¢å¤ã€‚";
        document.getElementById('confirm-modal-btn').textContent = "åˆ é™¤";
        modal.style.display = 'flex';
    }
}
// --- ğŸ® Vibe Grid è§’è‰²é€‰æ‹©åŠŸèƒ½è¡¥å…¨ ---

// 1. æ‰“å¼€é€‰æ‹©å™¨å¹¶è§¦å‘æ¸²æŸ“
function openVibeCharPicker() {
    const modal = document.getElementById('modal-vibe-picker');
    if (modal) {
        modal.style.display = 'flex';
        renderVibeCharPicker(); // æ‰“å¼€æ—¶ç«‹å³åˆ·æ–°åˆ—è¡¨
    } else {
        console.error("æ‰¾ä¸åˆ° ID ä¸º modal-vibe-picker çš„å¼¹çª—");
    }
}

// 2. ä» IndexedDB æå–è§’è‰²å¹¶æ¸²æŸ“åˆ°æ¸¸æˆé€‰äººåˆ—è¡¨
async function renderVibeCharPicker() {
    const listContainer = document.getElementById('vibe-char-scroll-list');
    if (!listContainer) return;

    // ä»æ•°æ®åº“è¯»å–ä½ è§’è‰²ä¹¦é‡Œçš„æ‰€æœ‰äºº
    const charList = await loadFromDB('char_list') || [];
    listContainer.innerHTML = "";

    if (charList.length === 0) {
        listContainer.innerHTML = `
            <div style="grid-column: span 2; text-align:center; padding:40px; color:#999;">
                <p style="font-size:14px;">è§’è‰²ä¹¦ç©ºç©ºå¦‚ä¹Ÿ</p>
                <p style="font-size:12px; margin-top:5px;">è¯·å…ˆå»â€œè§’è‰²ä¹¦â€Appåˆ›å»ºè§’è‰²</p>
            </div>`;
        return;
    }

    charList.forEach(char => {
        const item = document.createElement('div');
        item.className = 'char-card'; // å¤ç”¨ä½ ä¹‹å‰çš„å¡ç‰‡æ ·å¼
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <img class="char-card-img" src="${char.avatar}" style="height:120px;">
            <div class="char-card-info">
                <div class="char-card-name" style="font-size:14px;">${char.name}</div>
            </div>
        `;
        // ç‚¹å‡»è§’è‰²åï¼Œç¡®è®¤é€‰æ‹©å¹¶å¼€å§‹æ¸¸æˆ
        item.onclick = () => {
            confirmVibeOpponent(char);
        };
        listContainer.appendChild(item);
    });
}

// 3. ç¡®è®¤é€‰æ‹©å¯¹æ‰‹ï¼Œè¿›å…¥æ¸¸æˆç•Œé¢
function confirmVibeOpponent(char) {
    // è®¾ç½®å…¨å±€å¯¹æ‰‹å˜é‡
    window.vibeOpponent = char;
    
    // éšè—é€‰æ‹©å™¨å’Œå¯åŠ¨é¡µ
    document.getElementById('modal-vibe-picker').style.display = 'none';
    document.getElementById('vibe-start-screen').style.display = 'none';
    
    // æ˜¾ç¤ºæ¸¸æˆä¸»ä½“
    const gameMain = document.getElementById('vibe-game-main');
    gameMain.style.display = 'flex';
    setTimeout(() => { gameMain.style.opacity = '1'; }, 50);
    
    // å¡«å……å¯¹æ‰‹ UI
    document.getElementById('opp-avatar').src = char.avatar;
    document.getElementById('opp-name').textContent = char.name;
    document.getElementById('opp-last-word').style.opacity = "0";
    
    // æ ¸å¿ƒï¼šåˆå§‹åŒ–æ£‹ç›˜
    if (typeof initVibeGrid === 'function') {
        initVibeGrid();
        showToast(`å·²è¿æ¥åˆ° ${char.name} çš„æ„è¯†æµ`);
    }
}

// 1. ä¿®æ”¹ renderMessages å’Œ handleSendMessage é€»è¾‘
// åœ¨ç”Ÿæˆ bubble çš„ HTML æ—¶ï¼Œç»Ÿä¸€åŠ ä¸Š onclick="showBubbleMenu(this, event)"
// æ¯”å¦‚ï¼šinner += `<div class="bubble" onclick="showBubbleMenu(this, event)">...</div>`;

function showBubbleMenu(el, e) {
    if (e) e.stopPropagation();

    // --- ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœæ­£åœ¨å¤šé€‰ï¼Œä¸å‡†å¼¹å‡ºèœå•ï¼Œæ”¹ä¸ºé€‰æ‹©é€»è¾‘ ---
    const row = el.closest('.msg-row');
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected'); // ç›´æ¥åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        return; // ç«‹å³è¿”å›ï¼Œä¸æ‰§è¡Œä¸‹é¢çš„å¼¹å‡ºèœå•é€»è¾‘
    }
    if (row && row.classList.contains('multi-selecting')) {
        row.classList.toggle('selected');
        refreshMultiSelectCount(); // ğŸ‘ˆ åˆ«å¿˜äº†è¿™é‡Œä¹Ÿè¦åŠ 
        return;
    }
    
    

    window.currentActiveBubble = el; 
    
    const menu = document.getElementById('bubble-menu');
    const overlay = document.getElementById('menu-overlay');
    if (!menu || !overlay) return;

    const isUser = el.closest('.msg-row').classList.contains('user');
    const recallBtn = document.getElementById('menu-recall');
    if (recallBtn) recallBtn.style.display = isUser ? 'flex' : 'none';

    const rect = el.getBoundingClientRect();
    menu.style.display = 'flex';
    overlay.style.display = 'block';
    
    let left = rect.left + (rect.width / 2) - 130;
    let top = rect.top - 140;

    if (left < 10) left = 10;
    if (left + 260 > window.innerWidth) left = window.innerWidth - 270;
    if (top < 80) top = rect.bottom + 15;

    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
}

function hideBubbleMenu() {
    const menu = document.getElementById('bubble-menu');
    const overlay = document.getElementById('menu-overlay');
    
    if (menu) menu.style.display = 'none';
    if (overlay) overlay.style.display = 'none';
    
    // æ¸…é™¤å…¨å±€å¼•ç”¨çš„å˜é‡
    window.currentActiveBubble = null;
    
    console.log("System: Context menu closed.");
}

// 2. åŠŸèƒ½æ‰§è¡Œä¸­å¿ƒ
function doAction(type) {
    // 1. é¦–å…ˆç¡®ä¿èƒ½æ‹¿åˆ°å½“å‰é€‰ä¸­çš„æ°”æ³¡å…ƒç´ 
    var el = window.currentActiveBubble; 
    if (!el) {
        hideBubbleMenu();
        return;
    }
    
    // 2. æå‰æå–æ‰€æœ‰éœ€è¦çš„æ•°æ®ï¼Œç¡®ä¿é¡ºåºæ­£ç¡®
    var currentTs = el.getAttribute('data-ts'); // è·å–æ—¶é—´æˆ³
    var currentCid = (window.currentChattingWith && window.currentChattingWith.id) ? window.currentChattingWith.id : null;
    
    // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼ˆç”¨äºå¤åˆ¶ã€å¼•ç”¨ã€è½¬å‘ï¼‰
    var textNode = el.querySelector('.msg-text-main') || el;
    var pureText = textNode.innerText.trim();
    var senderName = el.closest('.msg-row').classList.contains('user') ? "You" : (window.currentChattingWith.name || "å¯¹æ–¹");

    switch(type) {
        case 'copy':
            // ğŸš¨ ä¿®å¤ï¼šä¼ å…¥åˆšæ‰å®šä¹‰çš„ pureText
            copyToClipboard(pureText);
            break;

        case 'quote':
            // ğŸš¨ ä¿®å¤ï¼šæ‰§è¡Œå¼•ç”¨é€»è¾‘ï¼Œå¼¹å‡ºè¾“å…¥æ¡†ä¸Šæ–¹çš„é¢„è§ˆæ¡
            prepareQuote(pureText, senderName);
            break;

        case 'multi':
            // ğŸš¨ æ ¸å¿ƒï¼šç‚¹å‡»èœå•ä¸­çš„â€œå¤šé€‰â€ä¼šè§¦å‘è¿™é‡Œ
            enterMultiSelect(); 
            break;

        case 'delete':
            // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œä½¿ç”¨åˆšæ‰å·²ç»å®šä¹‰å¥½çš„ currentCid å’Œ currentTs
            if (!currentTs || !currentCid) {
                showToast("âš ï¸ ç‰©ç†å®šä½å¤±è´¥ï¼Œæ— æ³•æŠ¹é™¤");
            } else {
                // è°ƒç”¨çœŸå®çš„ç‰©ç†åˆ é™¤å‡½æ•°
                deleteSingleMessageReal(currentCid, currentTs);
            }
            break;
        
        case 'forward': 
            const text = el.querySelector('.msg-text-main, .msg-text-content, .bubble').innerText;
            openForwardPicker([{ text: text }]); 
            break;
        
        case 'recall':
            if (currentTs && window.currentChattingWith) {
                const contactId = window.currentChattingWith.id;
                showIOSConfirm("æ’¤å›æ¶ˆæ¯", "ç¡®å®šè¦æ’¤å›å—ï¼Ÿ", "æ’¤å›", async () => {
                    // 1. ç‰©ç†æ›´æ–°æ•°æ®åº“
                    await updateMessageRecallStatus(contactId, currentTs, true);
                    // 2. ğŸš¨ å…³é”®ï¼šç«‹å³é‡ç»˜å½“å‰èŠå¤©å®¤ï¼Œè®©æ°”æ³¡å˜â€œç°è‰²æç¤ºâ€
                    await renderMessages(); 
                    // 3. ğŸš¨ å…³é”®ï¼šç«‹å³åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨é¢„è§ˆ
                    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
                    showToast("å·²æ’¤å›ä¸€æ¡è®°å¿†ç¢ç‰‡");
                });
            }
            break;
    }
    hideBubbleMenu(); // æ‰§è¡Œå®Œä»»ä½•åŠ¨ä½œéƒ½è¦å…³æ‰èœå•
}

// --- ğŸ“‹ å‰ªè´´æ¿å¼•æ“ ---
function copyToClipboard(text) {
    if (!navigator.clipboard) {
        // å…¼å®¹æ—§ç‰ˆæˆ–éå®‰å…¨åŸŸå
        var textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
    }).catch(err => {
        showToast("å¤åˆ¶å¤±è´¥");
    });
}

// --- 1. è¿›å…¥å¤šé€‰æ¨¡å¼ ---
function enterMultiSelect() {
    console.log("System: Entering Multi-select mode...");
    const rows = document.querySelectorAll('.msg-row');
    const footer = document.querySelector('.chat-room-footer');
    const multiBar = document.getElementById('multi-select-bar');

    if (!multiBar) return;

    rows.forEach(row => {
        row.classList.add('multi-selecting');
        
        // åŠ¨æ€æ’å…¥å‹¾é€‰æ¡†
        if (!row.querySelector('.msg-check-box')) {
            const check = document.createElement('div');
            check.className = 'msg-check-box';
            // ç‚¹å‡»åœ†åœˆç›´æ¥é€‰æ‹©
            check.onclick = (e) => {
                e.stopPropagation();
                row.classList.toggle('selected');
            };
            row.appendChild(check);
        }
        
        // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦å†ç»™ row ç»‘å®š onclick äº†
        // å› ä¸ºæ°”æ³¡è‡ªå¸¦çš„ showBubbleMenu å·²ç»è¢«æˆ‘ä»¬æ”¹æˆäº†â€œè½¬å‘å™¨â€
    });

    if (footer) footer.style.display = 'none'; 
    multiBar.style.display = 'flex'; 
}

// ä¿®æ”¹ä½ çš„ doAction å‡½æ•°
// åœ¨ doAction çš„ switch(type) é‡Œæ‰¾åˆ° 'multi':
// case 'multi': enterMultiSelect(); break;

// --- 2. é€€å‡ºå¤šé€‰æ¨¡å¼ ---
function exitMultiSelect() {
    console.log("System: Exiting Multi-select mode...");
    const rows = document.querySelectorAll('.msg-row');
    const footer = document.querySelector('.chat-room-footer');
    const multiBar = document.getElementById('multi-select-bar');

    rows.forEach(row => {
        // ğŸš¨ æ ¸å¿ƒï¼šç§»é™¤æ‰€æœ‰ç›¸å…³çš„ç±»å
        row.classList.remove('multi-selecting', 'selected');
        
        // å½»åº•æ¸…ç©ºå¤šé€‰æ¨¡å¼ä¸‹çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ¢å¤æ°”æ³¡åŸæœ¬çš„èœå•åŠŸèƒ½
        row.onclick = null; 
    });

    // æ¢å¤åº•æ çŠ¶æ€
    if (footer) footer.style.display = 'flex';
    if (multiBar) {
        multiBar.style.display = 'none';
        // é¡ºä¾¿é‡ç½®è®¡æ•°æ–‡å­—
        const countEl = document.getElementById('multi-select-count');
        if (countEl) countEl.textContent = "å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯";
    }
    
    showToast("å·²é€€å‡ºç¼–è¾‘");
}

// --- 3. æ‰¹é‡åŠŸèƒ½å®ç° ---

// --- âš¡ æ‰¹é‡ï¼šç‰©ç†çº§é”€æ¯é€»è¾‘ ---
async function batchDelete() {
    const selectedRows = document.querySelectorAll('.msg-row.selected');
    if (selectedRows.length === 0) return showToast("è¯·å…ˆå‹¾é€‰");

    showIOSConfirm("æ‰¹é‡é”€æ¯", `ç¡®å®šè¦ç‰©ç†æŠ¹é™¤è¿™ ${selectedRows.length} æ¡è®°å¿†å—ï¼Ÿ`, "æŠ¹é™¤", async function() {
        const contactId = window.currentChattingWith.id;
        // æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„æ—¶é—´æˆ³
        const timestampsToDelete = Array.from(selectedRows).map(row => 
            row.querySelector('.bubble').getAttribute('data-ts')
        );

        const db = await openDB();
        const tx = db.transaction("chat_history", "readwrite");
        const store = tx.objectStore("chat_history");
        const req = store.get(contactId);

        req.onsuccess = async () => {
            const data = req.result;
            if (!data) return;

            // ç‰©ç†è¿‡æ»¤
            const updatedMessages = data.messages.filter(m => 
                !timestampsToDelete.includes(m.timestamp.toString())
            );

            await store.put({ contactId: contactId, messages: updatedMessages });
            
            showToast("é€‰å®šè®°å¿†å·²ç‰©ç†éš”ç¦»");
            exitMultiSelect(); // é€€å‡ºå¤šé€‰æ¨¡å¼
            renderMessages();   // åˆ·æ–°èŠå¤©
            if (typeof initChatMsgPanel === 'function') initChatMsgPanel(); // åˆ·æ–°åˆ—è¡¨é¢„è§ˆ
        };
    });
}

// --- B. æ‰¹é‡æˆªå›¾ (ä¸å†ä½¿ç”¨åŸç”Ÿ alert) ---
function batchScreenshot() {
    const selectedCount = document.querySelectorAll('.msg-row.selected').length;
    if (selectedCount === 0) return showToast("è¯·é€‰æ‹©éœ€è¦æˆªå›¾çš„æ¶ˆæ¯");

    showToast("æ­£åœ¨é€šè¿‡è”è§‰åè®®åˆæˆå›¾åƒ...");
    
    // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
    setTimeout(() => {
        showIOSAlert("æˆªå›¾æˆåŠŸ", `å·²æˆåŠŸå°† ${selectedCount} æ¡æ¶ˆæ¯åˆæˆé•¿å›¾å¹¶ä¿å­˜è‡³æ¨¡æ‹Ÿç›¸å†Œã€‚`);
        exitMultiSelect();
    }, 1200);
}

// --- C. æ‰¹é‡è½¬å‘ (é€»è¾‘ä¼˜åŒ–) ---
function batchForward() {
    const selectedRows = document.querySelectorAll('.msg-row.selected');
    if (selectedRows.length === 0) return showToast("è¯·é€‰æ‹©æ¶ˆæ¯");

    const messages = Array.from(selectedRows).map(row => {
        const textNode = row.querySelector('.msg-text-main') || row.querySelector('.msg-text-content') || row.querySelector('.bubble');
        return { text: textNode.innerText.trim() };
    });

    exitMultiSelect(); // å…ˆé€€å‡ºå¤šé€‰æ¨¡å¼
    openForwardPicker(messages); // å¼¹å‡ºè½¬å‘é¡µé¢
}
// å®æ—¶æ›´æ–°é€‰ä¸­æ•°é‡çš„æ˜¾ç¤º
function refreshMultiSelectCount() {
    const count = document.querySelectorAll('.msg-row.selected').length;
    const countEl = document.getElementById('multi-select-count');
    if (countEl) {
        countEl.textContent = count > 0 ? `å·²é€‰æ‹© ${count} æ¡æ¶ˆæ¯` : "é€‰æ‹©æ¶ˆæ¯";
    }
}

// ä¿®æ”¹è¿›å…¥å‡½æ•°ï¼Œç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
function enterMultiSelect() {
    const rows = document.querySelectorAll('.msg-row');
    const footer = document.querySelector('.chat-room-footer');
    const multiBar = document.getElementById('multi-select-bar');

    rows.forEach(row => {
        row.classList.add('multi-selecting');
        if (!row.querySelector('.msg-check-box')) {
            const check = document.createElement('div');
            check.className = 'msg-check-box';
            check.onclick = (e) => {
                e.stopPropagation();
                row.classList.toggle('selected');
                refreshMultiSelectCount(); // ğŸ‘ˆ æ¯æ¬¡ç‚¹å‡»æ›´æ–°è®¡æ•°
            };
            row.appendChild(check);
        }
    });

    if (footer) footer.style.display = 'none';
    if (multiBar) {
        multiBar.style.display = 'flex';
        refreshMultiSelectCount(); // ğŸ‘ˆ åˆå§‹åŒ–è®¡æ•°
    }
}
// ==========================================
// ğŸ“± iOS å…¨å±€é¡µé¢å¼¹çª—è°ƒåº¦ä¸­å¿ƒ (æ ¸å¿ƒå·¥å…·ç®±)
// ==========================================

/**
 * æ›¿ä»£ confirm() çš„ iOS é£æ ¼ç¡®è®¤æ¡†
 * @param {string} title æ ‡é¢˜
 * @param {string} msg æè¿°æ–‡å­—
 * @param {string} btnText ç¡®è®¤æŒ‰é’®çš„æ–‡å­—
 * @param {function} action ç‚¹å‡»ç¡®è®¤åè¦æ‰§è¡Œçš„å‡½æ•°
 */
function showIOSConfirm(title, msg, btnText, action) {
    console.log("System: Triggering IOS Confirm Modal...");
    
    const titleEl = document.getElementById('confirm-modal-title');
    const msgEl = document.getElementById('confirm-modal-msg');
    const btnEl = document.getElementById('confirm-modal-btn');
    const modal = document.getElementById('iosConfirmModal');

    if (!titleEl || !msgEl || !btnEl || !modal) {
        console.error("System Error: æ‰¾ä¸åˆ° iosConfirmModal ç›¸å…³çš„ HTML å…ƒç´ ï¼");
        return;
    }

    // 1. å¡«å……æ–‡å­—å†…å®¹
    titleEl.textContent = title;
    msgEl.textContent = msg;
    btnEl.textContent = btnText;

    // 2. å±é™©æ“ä½œï¼ˆå¦‚åˆ é™¤ï¼‰æŒ‰é’®å˜çº¢ï¼Œæ™®é€šæ“ä½œå˜è“
    btnEl.style.color = (btnText === "åˆ é™¤" || btnText === "æ’¤å›" || btnText === "æŠ¹é™¤") ? "#FF3B30" : "#007AFF";

    // 3. å°†ä»»åŠ¡å­˜å…¥å…¨å±€å¾…å¤„ç†åŠ¨ä½œä¸­
    window.pendingAction = action;

    // 4. æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
}

/**
 * æ›¿ä»£ alert() çš„ iOS é£æ ¼æˆåŠŸæç¤ºæ¡†
 * @param {string} title æ ‡é¢˜
 * @param {string} msg æè¿°æ–‡å­—
 */
function showIOSAlert(title, msg) {
    const titleEl = document.getElementById('alert-title');
    const msgEl = document.getElementById('alert-msg');
    const modal = document.getElementById('successAlert');

    if (titleEl && msgEl && modal) {
        titleEl.textContent = title;
        msgEl.textContent = msg;
        modal.style.display = 'flex';
    }
}
// --- 2. è§¦å‘è½¬å‘å…¥å£ (å•æ¡å’Œå¤šæ¡å…±ç”¨) ---
function openForwardPicker(messages) {
    // messages æ ¼å¼: [{ text: "å†…å®¹" }, ...]
    window.pendingForwardData = messages;
    
    const page = document.getElementById('page-forward-picker');
    page.style.transform = 'translateY(0)';
    
    switchForwardTab('friends'); // é»˜è®¤æ˜¾ç¤ºå¥½å‹
}

function closeForwardPicker() {
    document.getElementById('page-forward-picker').style.transform = 'translateY(100%)';
    window.pendingForwardData = [];
}

// --- 3. æ¸²æŸ“è½¬å‘åˆ—è¡¨ (å¤ç”¨åˆ—è¡¨é€»è¾‘) ---
async function switchForwardTab(mode) {
    window.forwardTabMode = mode;
    document.getElementById('fwd-tab-friends').classList.toggle('active', mode === 'friends');
    document.getElementById('fwd-tab-groups').classList.toggle('active', mode === 'groups');
    
    const container = document.getElementById('forward-list-content');
    const dbKey = (mode === 'friends') ? 'chat_friends' : 'chat_groups';
    const list = await loadFromDB(dbKey) || [];
    
    container.innerHTML = "";
    const groupWrapper = document.createElement('div');
    groupWrapper.className = 'chat-contact-group';
    groupWrapper.style.marginTop = "15px";

    list.forEach(target => {
        const row = document.createElement('div');
        row.className = 'contact-row';
        row.innerHTML = `
            <img class="contact-avatar" src="${target.avatar}" style="width:40px; height:40px; border-radius:${mode==='friends'?'50%':'8px'}">
            <div class="contact-info"><span class="contact-name" style="font-size:15px;">${target.name}</span></div>
            <div style="color:#007AFF; font-size:13px; font-weight:600;">å‘é€</div>
        `;
        row.onclick = () => confirmForwardTo(target);
        groupWrapper.appendChild(row);
    });
    container.appendChild(groupWrapper);
}

// --- 4. ç¡®è®¤è½¬å‘é€»è¾‘ (è°ƒç”¨ iOS å¼¹çª—) ---
function confirmForwardTo(target) {
    const count = window.pendingForwardData ? window.pendingForwardData.length : 0;
    
    showIOSConfirm(
        "ç¡®è®¤è½¬å‘", 
        `å°† ${count} æ¡æ¶ˆæ¯è½¬å‘ç»™ ${target.name}ï¼Ÿ`, 
        "å‘é€", 
        async function() {
            if (!window.pendingForwardData) return;

            // æ‰§è¡ŒçœŸæ­£çš„ç‰©ç†è½¬å‘åŠ¨ä½œ
            for(let item of window.pendingForwardData) {
                // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šç‰©ç†å¯¹é½æ•°æ®æºï¼Œç¡®ä¿å›¾ç‰‡ä¸æ–‡å­—éƒ½èƒ½æ­£ç¡®è¯†åˆ«
                const msgObj = {
                    role: "user",
                    // ğŸš¨ å…³é”®ä¿®å¤ï¼šå›¾ç‰‡ç±»å‹å– item.src (Base64)ï¼›æ–‡å­—ç±»å‹å– item.text
                    text: item.type === 'image' ? item.src : item.text, 
                    type: item.type === 'image' ? "image" : "text",
                    timestamp: Date.now(),
                    isForwarded: true, // å¢åŠ è½¬å‘æ ‡è®°
                    isEmoji: false     // ç›¸å†Œå›¾ç‰‡ä¸ä½œä¸ºè¡¨æƒ…åŒ…å¤„ç†
                };
                
                // åªæœ‰å½“æ•°æ®å†…å®¹å­˜åœ¨æ—¶ï¼Œæ‰æ‰§è¡Œç‰©ç†å­˜ç›˜
                if (msgObj.text) {
                    await saveChatMessage(target.id, msgObj);
                }
            }
            
            showToast("å·²æˆåŠŸè½¬å‘ç¬é—´");
            closeForwardPicker();
            
            // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šå¦‚æœå½“å‰æ­£å¼€ç€è¯¥è§’è‰²çš„èŠå¤©å®¤ï¼Œç«‹å³è§¦å‘ UI é‡ç»˜
            if(window.currentChattingWith && window.currentChattingWith.id === target.id) {
                if (typeof renderMessages === 'function') renderMessages();
            }

            // ğŸš¨ å…³é”®æ”¶å°¾ï¼šæ¸…ç†è½¬å‘åè®®ç¼“å­˜ï¼Œé˜²æ­¢é‡å¤å‘é€æ—§æ•°æ®
            window.pendingForwardData = null;
        }
    );
}
async function updateMessageRecallStatus(contactId, timestamp, isRecalled) {
    const db = await openDB();
    const tx = db.transaction("chat_history", "readwrite");
    const store = tx.objectStore("chat_history");
    const req = store.get(contactId);
    
    return new Promise((resolve) => {
        req.onsuccess = () => {
            if (!req.result) return resolve();
            let data = req.result.messages;
            // æ‰¾åˆ°å¯¹åº”æ—¶é—´æˆ³çš„æ¶ˆæ¯
            const idx = data.findIndex(m => m.timestamp == timestamp);
            if (idx !== -1) {
                data[idx].recalled = isRecalled;
                store.put({ contactId: contactId, messages: data });
            }
            resolve();
        };
    });
}
// ==========================================
// ğŸ‘ï¸ è”è§‰ç‰ˆï¼šæ’¤å›å†…å®¹æ·±åº¦è§£ç å¼•æ“ (æ”¯æŒåŒè¯­æ¸²æŸ“)
// ==========================================
function viewRecalledTrace(content) {
    const viewer = document.getElementById('modal-recalled-viewer');
    const textZone = document.getElementById('recalled-v-text');
    if (!viewer || !textZone) return;

    // ğŸš¨ æ ¸å¿ƒï¼šè°ƒç”¨å…¨åŸŸè§£æå¼•æ“å¤„ç†æ’¤å›çš„æ–‡æœ¬å†…å®¹
    const parsed = parseMessageContent(content);

    let html = "";
    
    // å¦‚æœæ’¤å›çš„æ¶ˆæ¯é‡Œæœ‰å¼•ç”¨ï¼Œå…ˆæ¸²æŸ“å¼•ç”¨ç›’
    if (parsed.quoteHtml) {
        html += `<div style="margin-bottom:15px; opacity:0.6; pointer-events:none;">${parsed.quoteHtml}</div>`;
    }

    // æ˜¾ç¤ºåŸæ–‡æ­£æ–‡
    html += `<div style="font-size:16px; color:#1d1d1f; font-weight:500;">${parsed.displayMain}</div>`;

    // å¦‚æœæ˜¯åŒè¯­æ¶ˆæ¯ï¼Œç‰©ç†é‡å»ºç¿»è¯‘å±‚
    if (parsed.isDual) {
        // æå–è¯‘æ–‡æ–‡å­— (ä» parsed.transHtml ä¸­æ­£åˆ™æå–æˆ–æ‰‹åŠ¨åˆ‡å‰²)
        const transText = content.split('[TRANS]')[1]?.trim() || "";
        html += `
            <div style="margin-top:15px; padding-top:15px; border-top:0.5px solid rgba(0,0,0,0.08);">
                <div style="font-size:9px; font-weight:900; color:#8E8E93; margin-bottom:5px; letter-spacing:1.5px;">DECODED TRANSLATION</div>
                <div style="font-size:14px; color:#8E8E93; font-style:italic; line-height:1.5;">${transText}</div>
            </div>
        `;
    }

    textZone.innerHTML = html; // ğŸš¨ ç‰©ç†æ³¨å…¥æ¸²æŸ“åçš„ HTML
    viewer.style.display = 'flex';
    viewer.style.zIndex = "100001";
    console.log("System: æ’¤å›å†…å®¹å·²è”è§‰è§£ç ã€‚");
}

// å¼ºåˆ¶å°†å…¶å…³è”åˆ° windowï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.viewRecalledTrace = viewRecalledTrace;
// ==========================================
// âš™ï¸ èŠå¤©è®¾ç½®é¡µé¢æ§åˆ¶å™¨
// ==========================================

// 1. æ‰“å¼€è®¾ç½®é¡µ
function openChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
    }
}

// 2. å…³é—­è®¾ç½®é¡µ
function closeChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(100%)';
    }
}

// 3. ä»è®¾ç½®é¡µè·³è½¬åˆ°â€œTaçš„èµ„æ–™â€
async function openChatProfileFromSettings() {
    console.log("System: å°è¯•ä»è®¾ç½®é¡µå¼€å¯é¢„è§ˆåç‰‡...");
    
    let contact = window.currentChattingWith;

    // ğŸ›¡ï¸ å®‰å…¨é”ï¼šå¦‚æœå˜é‡ä¸¢å¤±ï¼Œå°è¯•ä» URL æˆ–ä¸Šä¸‹æ–‡æ¢å¤
    if (!contact) {
        showToast("âš ï¸ æœªèƒ½è·å–è§’è‰²ä¸Šä¸‹æ–‡");
        return;
    }

    // æ ¸å¿ƒï¼šåœ¨å±•ç¤ºåç‰‡å‰ï¼Œå…ˆå»æ•°æ®åº“æä¸€ä¸‹æœ€æ–°çš„èµ„æ–™
    // é˜²æ­¢ä½ åœ¨èµ„æ–™é¡µæ”¹äº†åå­—ï¼Œåç‰‡ä¸Šè¿˜æ˜¯æ—§çš„
    const charList = await loadFromDB('char_list') || [];
    const latestInfo = charList.find(c => c.id === contact.id) || contact;

    console.log("System: è½½å…¥æœ€æ–°èµ„æ–™è¿›è¡Œé¢„è§ˆ:", latestInfo.name);
    
    // è°ƒç”¨ä¹‹å‰çš„é«˜çº§åç‰‡æ˜¾ç¤ºå‡½æ•°
    openChatProfile(latestInfo);
}

// 4. è§¦å‘â€œæ¸…ç©ºèŠå¤©è®°å½•â€ (å¸¦ç¡®è®¤)
function triggerClearHistory() {
    if(!window.currentChattingWith) return;
    
    // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„é€šç”¨ iOS ç¡®è®¤æ¡†
    showIOSConfirm(
        "æ¸…ç©ºè®°å½•",
        "ç¡®å®šè¦æ¸…ç©ºä¸è¯¥å¥½å‹çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
        "æ¸…ç©º",
        async function() {
            // å¤ç”¨ä¹‹å‰çš„åˆ é™¤é€»è¾‘ï¼Œä½†åªæ¸…ç©ºæ¶ˆæ¯ï¼Œä¸åˆ äºº
            const db = await openDB();
            const tx = db.transaction("chat_history", "readwrite");
            const store = tx.objectStore("chat_history");
            
            // å°†è¯¥è”ç³»äººçš„æ¶ˆæ¯é‡ç½®ä¸ºç©ºæ•°ç»„ï¼Œä¿ç•™è”ç³»äººå…³ç³»
            await store.put({ contactId: window.currentChattingWith.id, messages: [] });
            
            showToast("è®°å½•å·²æ¸…ç©º");
            // åˆ·æ–°èŠå¤©ç•Œé¢
            if(typeof renderMessages === 'function') renderMessages();
            // å…³é—­è®¾ç½®é¡µ
            closeChatSettings();
        }
    );
}

// 5. è§¦å‘â€œåˆ é™¤å¥½å‹â€ (å¸¦ç¡®è®¤)
function triggerDeleteFriend() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    // ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å†™çš„ iOS é£æ ¼ç¡®è®¤æ¡†
    showIOSConfirm(
        "åˆ‡æ–­ç¤¾äº¤çº½å¸¦ï¼Ÿ", 
        `è¿™å°†åˆ é™¤ä¸ ${contact.name} çš„æ‰€æœ‰èŠå¤©è®°å½•å’Œä¸ªæ€§åŒ–è®¾ç½®ï¼Œä½†ä¼šä¿ç•™å…¶åœ¨â€œè§’è‰²ä¹¦â€ä¸­çš„åŸå§‹æ¡£æ¡ˆã€‚`, 
        "å½»åº•åˆ é™¤", 
        () => {
            executeMasterSocialDelete(contact.id);
        }
    );
}
// --- âš™ï¸ èŠå¤©è®¾ç½®é¡µï¼šæŠ˜å é€»è¾‘ ---
function toggleSettingItem(headerEl) {
    // 1. æ‰¾åˆ°å¯¹åº”çš„çˆ¶å®¹å™¨
    const item = headerEl.parentElement;
    
    // 2. æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ‰“å¼€
    const isActive = item.classList.contains('active');
    
    // 3. (å¯é€‰) å¦‚æœä½ æƒ³å®ç°â€œæ‰‹é£ç´â€æ•ˆæœï¼ˆæ‰“å¼€ä¸€ä¸ªè‡ªåŠ¨å…³é—­å…¶ä»–çš„ï¼‰ï¼Œå°±æŠŠè¿™æ®µåŠ ä¸Šï¼š
    document.querySelectorAll('.ios-accordion-item').forEach(el => {
        el.classList.remove('active');
    });

    // 4. åˆ‡æ¢å½“å‰çŠ¶æ€
    if(isActive) {
        item.classList.remove('active');
    } else {
        item.classList.add('active');
    }
}

// ç¨å¾®ä¿®æ”¹æ‰“å¼€è®¾ç½®é¡µçš„é€»è¾‘ï¼Œé¡ºä¾¿å¡«ä¸€ä¸‹åº•éƒ¨çš„ ID
var originalOpenChatSettings = openChatSettings;
openChatSettings = function() {
    originalOpenChatSettings(); // è°ƒç”¨ä¹‹å‰çš„æ‰“å¼€åŠ¨ç”»
    // å¡«å……åº•éƒ¨çš„ ID
    if(window.currentChattingWith) {
        const uid = document.getElementById('setting-uid-display');
        if(uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
    }
}
// --- ğŸ§  èƒŒæ™¯ç³»ç»Ÿå…¨å±€ç¼“å­˜ ---

// 1. æ‰“å¼€ä¸‡èƒ½ä¸Šä¼ å™¨
function openUniversalBgModal(target) {
    currentUploaderTarget = target;
    const modal = document.getElementById('modal-universal-uploader');
    const title = document.getElementById('uploader-title');
    const tag = document.getElementById('uploader-target-tag');
    
    title.textContent = target === 'chat' ? "è®¾ç½®èŠå¤©èƒŒæ™¯" : "è®¾ç½®èœå•èƒŒæ™¯";
    tag.textContent = target === 'chat' ? "SUPPORT IMG/VID" : "IMAGE ONLY";
    document.getElementById('universal-url-in').value = "";
    
    modal.style.display = 'flex';
}

function closeUniversalUploader() {
    document.getElementById('modal-universal-uploader').style.display = 'none';
}

// 2. å¤„ç† URL ä¸Šä¼ 
function handleUniversalUrl() {
    const url = document.getElementById('universal-url-in').value.trim();
    if(!url) return;
    
    // ç®€å•çš„æ ¼å¼åˆ¤å®š
    const isVideo = url.match(/\.(mp4|webm|ogg)/i);
    if(currentUploaderTarget === 'settings' && isVideo) {
        showToast("èœå•èƒŒæ™¯æš‚ä¸æ”¯æŒè§†é¢‘");
        return;
    }
    
    applyTempBg(currentUploaderTarget, isVideo ? 'vid' : 'img', url);
    closeUniversalUploader();
}

// 3. å¤„ç†æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
function handleUniversalFile(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const isVideo = file.type.startsWith('video/');
        
        if(currentUploaderTarget === 'settings' && isVideo) {
            showToast("èœå•èƒŒæ™¯æš‚ä¸æ”¯æŒè§†é¢‘");
            return;
        }

        const reader = new FileReader();
        showToast("æ­£åœ¨è¯»å–æ–‡ä»¶...");
        reader.onload = function(e) {
            applyTempBg(currentUploaderTarget, isVideo ? 'vid' : 'img', e.target.result);
            closeUniversalUploader();
        };
        reader.readAsDataURL(file);
    }
}

// 4. å®æ—¶æ›´æ–°é¢„è§ˆå›¾ï¼ˆæ¯”ä¾‹ 9:16ï¼‰
function applyTempBg(target, type, data) {
    tempBgData[target] = { type, data };
    const thumb = document.getElementById(`preview-thumb-${target}`);
    
    if (type === 'vid') {
        thumb.innerHTML = `<video src="${data}" autoplay loop muted></video>`;
    } else {
        thumb.innerHTML = `<img src="${data}">`;
    }
}

// 5. ã€æ ¸å¿ƒä¿å­˜ã€‘ï¼šå†™å…¥ IndexedDB å¹¶ç‰©ç†åº”ç”¨
async function saveChatBackgroundSettings() {
    showToast("æ­£åœ¨ä¿å­˜è®¾ç½®...");

    // A. ä¿å­˜èŠå¤©èƒŒæ™¯ (åªæœ‰åœ¨èŠå¤©å®¤å†…æ‰ç”Ÿæ•ˆ)
    const contact = window.currentChattingWith;
    if (contact && tempBgData.chat.data) {
        const contactId = contact.id;
        localStorage.setItem(`chat_bg_type_${contactId}`, tempBgData.chat.type);
        await saveToDB(`chat_bg_data_${contactId}`, tempBgData.chat.data);
        tempBgData.chat.data = null; 
    }

    // B. ä¿å­˜å…¨å±€è®¾ç½®èƒŒæ™¯ (è¿™ä¸ªä¸åº”è¯¥å— contact é™åˆ¶ï¼)
    if (tempBgData.settings.data) {
        await saveToDB('settings_bg_data', tempBgData.settings.data);
        tempBgData.settings.data = null;
    }

    // é‡æ–°åº”ç”¨
    await applyBackgroundsToUI();
    showToast("âœ… èƒŒæ™¯å·²åŒæ­¥");
    // ğŸš¨ é‡ç‚¹ï¼šé€»è¾‘è·‘å®Œåï¼Œå¼¹å‡ºé«˜çº§æˆåŠŸæç¤ºï¼
    triggerSuccessHud("è®¾ç½®å·²åŒæ­¥");
}

// å…¼å®¹ä½  HTML é‡Œçš„å‡½æ•°åè°ƒç”¨
window.saveBackgroundSettings = saveChatBackgroundSettings;

// 6. ã€æ ¸å¿ƒåº”ç”¨ã€‘ï¼šå°†æ•°æ®æ¸²æŸ“åˆ°é¡µé¢
// ==========================================
// ğŸ¨ èƒŒæ™¯åº”ç”¨å¼•æ“ï¼šæ™ºèƒ½åº•è‰²æ§åˆ¶ç‰ˆ
// ==========================================
async function applyBackgroundsToUI() {
    const chatRoom = document.getElementById('page-chat-room');
    const chatSettings = document.getElementById('page-chat-settings'); // åŠ ä¸Šè¿™ä¸€è¡Œ
    const contact = window.currentChattingWith;

    if (!chatRoom) return;

    // 1. ç¡®ä¿èƒŒæ™¯èˆ±å­˜åœ¨
    let bgLayer = document.getElementById('chat-room-full-bg');
    if (!bgLayer) {
        bgLayer = document.createElement('div');
        bgLayer.id = 'chat-room-full-bg';
        bgLayer.style = "position:absolute; inset:0; width:100%; height:100%; z-index:0; pointer-events:none; overflow:hidden; background-color:#F2F2F7;";
        chatRoom.prepend(bgLayer); 
    }

    // --- A. èŠå¤©å®¤èƒŒæ™¯é€»è¾‘ (ç‹¬ç«‹ ID) ---
    if (contact) {
        const contactId = contact.id;
        const chatType = localStorage.getItem(`chat_bg_type_${contactId}`) || 'img';
        const chatData = await loadFromDB(`chat_bg_data_${contactId}`);
        const chatThumb = document.getElementById('preview-thumb-chat');

        if (chatData) {
            bgLayer.style.backgroundColor = "transparent"; 
            if (chatType === 'vid') {
                bgLayer.innerHTML = `<video src="${chatData}" autoplay loop muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>`;
            } else {
                bgLayer.innerHTML = `<img src="${chatData}" style="width:100%;height:100%;object-fit:cover;">`;
            }

            if (chatThumb) {
                chatThumb.innerHTML = chatType === 'vid' 
                    ? `<video src="${chatData}" autoplay loop muted style="width:100%;height:100%;object-fit:cover;"></video>` 
                    : `<img src="${chatData}" style="width:100%;height:100%;object-fit:cover;">`;
            }
        } else {
            bgLayer.innerHTML = ""; 
            bgLayer.style.backgroundColor = "#F2F2F7";
            if (chatThumb) chatThumb.innerHTML = `<div class="bg-preview-placeholder">ç‚¹å‡»<br>è®¾ç½®</div>`;
        }
    }

    // --- ğŸš¨ B. è®¾ç½®èœå•èƒŒæ™¯é€»è¾‘ (å…¨å±€) --- è¿™ä¸€å—ä½ ä¹‹å‰æ¼æ‰äº†ï¼
    const settingsData = await loadFromDB('settings_bg_data');
    const settingsThumb = document.getElementById('preview-thumb-settings');

    if (settingsData && chatSettings) {
        // åº”ç”¨åˆ°çœŸæ­£çš„è®¾ç½®é¡µèƒŒæ™¯
        chatSettings.style.backgroundImage = `url(${settingsData})`;
        chatSettings.style.backgroundSize = "cover";
        chatSettings.style.backgroundPosition = "center";
        
        // å›å¡«è®¾ç½®é¡µé‡Œçš„å°é¢„è§ˆæ¡†
        if (settingsThumb) {
            settingsThumb.innerHTML = `<img src="${settingsData}" style="width:100%;height:100%;object-fit:cover;">`;
        }
    }
}

// 7. ã€åˆå§‹åŒ–ã€‘ï¼šåˆ·æ–°åæ¢å¤
// åœ¨ä½ åŸæœ¬çš„ window.onload æˆ– loadSavedData ç»“å°¾åŠ å…¥è¿™ä¸€è¡Œï¼š
// applyBackgroundsToUI();

// 8. é‡ç½®
async function resetChatBackgrounds() {
    if(!window.currentChattingWith) return;
    const contactId = window.currentChattingWith.id;

    showIOSConfirm("é‡ç½®èƒŒæ™¯", "ç¡®å®šè¦æ¸…é™¤è¯¥å¥½å‹çš„ä¸“å±èƒŒæ™¯å—ï¼Ÿ", "é‡ç½®", async () => {
        // 1. åˆ é™¤å½“å‰å¥½å‹çš„å­˜å‚¨
        localStorage.removeItem(`chat_bg_type_${contactId}`);
        const db = await openDB();
        const tx = db.transaction(storeName, "readwrite");
        await tx.objectStore(storeName).delete(`chat_bg_data_${contactId}`);
        
        // 2. åˆ·æ–°ç•Œé¢
        applyBackgroundsToUI();
        showToast("å·²æ¢å¤é»˜è®¤");
    });
}
// ä¿®æ”¹ä½ ä¹‹å‰çš„ openChatSettings å‡½æ•°
window.openChatSettings = function() {
    const settingsPage = document.getElementById('page-chat-settings');
    if(settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
        
        // ğŸš¨ æ ¸å¿ƒï¼šåœ¨æ‰“å¼€è®¾ç½®é¡µæ—¶ï¼Œç«‹åˆ»è¿è¡Œä¸€æ¬¡èƒŒæ™¯åº”ç”¨å‡½æ•°
        // è¿™æ ·é¢„è§ˆæ¡†å°±ä¼šç«‹åˆ»æ˜¾ç¤ºå½“å‰è¿™ä¸ªå¥½å‹çš„ä¸“å±èƒŒæ™¯å›¾
        applyBackgroundsToUI();

        // å¡«å……åº•éƒ¨çš„ ID
        if(window.currentChattingWith) {
            const uid = document.getElementById('setting-uid-display');
            if(uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
        }
    }
}
// --- ğŸ† è§¦å‘ iOS æˆåŠŸ HUD ---
function triggerSuccessHud(text = "å·²ä¿å­˜") {
    const hud = document.getElementById('save-success-hud');
    const hudText = hud.querySelector('.hud-text');
    
    if (!hud) return;

    hudText.textContent = text;
    hud.style.display = 'flex';
    
    // å¼ºåˆ¶é‡ç»˜è§¦å‘åŠ¨ç”»
    void hud.offsetWidth;
    
    hud.classList.add('show');

    // 1.5ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        hud.classList.remove('show');
        setTimeout(() => {
            hud.style.display = 'none';
        }, 300); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»ç»“æŸ
    }, 1500);
}
// --- ğŸ§  è§’è‰²èµ„æ–™ä¸´æ—¶æš‚å­˜ ---
var tempCharProfileData = { id: null, avatar: null };

// 1. è¿›å…¥ç¼–è¾‘é¡µé¢ï¼šåŠ è½½å½“å‰è§’è‰²çš„åŸå§‹æ•°æ®
// ==========================================
// ğŸ“ èµ„æ–™ç¼–è¾‘é¡µï¼šå¼ºåŠ›åŠ è½½å¼•æ“
// ==========================================
async function openCharProfileEditPage() {
    console.log("System: å‡†å¤‡è¯»å–è§’è‰²èµ„æ–™...");
    
    // 1. è·å–å½“å‰å¯¹è¯å¯¹è±¡
    const contact = window.currentChattingWith;
    
    // ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
    if (!contact || !contact.id) {
        console.error("Error: æ‰¾ä¸åˆ°å½“å‰è”ç³»äººä¸Šä¸‹æ–‡");
        showToast("âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¥½å‹");
        return;
    }

    // 2. é”å®šæš‚å­˜å˜é‡ï¼Œé˜²æ­¢ undefined æŠ¥é”™
    tempCharProfileData.id = contact.id;

    // 3. ä»æ•°æ®åº“æ‹‰å–æœ€å…¨çš„ä¿¡æ¯ï¼ˆåŒ…å«èƒŒæ™¯æ•…äº‹ descï¼‰
    const charList = await loadFromDB('char_list') || [];
    const charInfo = charList.find(c => c.id === contact.id) || contact;

    // 4. ç‰©ç†å¡«å€¼ï¼ˆå¢åŠ ç©ºå€¼åˆ¤å®šï¼Œé˜²æ­¢æ¸²æŸ“ä¸­æ–­ï¼‰
    const elAvatar = document.getElementById('edit-char-avatar-pre');
    const elName = document.getElementById('edit-char-name');
    const elDesc = document.getElementById('edit-char-desc');
    const elMetaId = document.getElementById('meta-char-id');

    if (elAvatar) elAvatar.src = charInfo.avatar || "";
    if (elName) elName.value = charInfo.name || "";
    if (elDesc) elDesc.value = charInfo.desc || "";
    if (elMetaId) elMetaId.textContent = contact.id.substring(0, 16).toUpperCase();

    // 5. ç‰©ç†æ¨å…¥é¡µé¢
    const subPage = document.getElementById('subpage-char-profile');
    if (subPage) {
        subPage.classList.add('active'); // åŠ ä¸Š active ç±»è§¦å‘æ»‘åŠ¨
        console.log("System: èµ„æ–™é¡µå·²æˆåŠŸæ¨å…¥");
    }
}

// 2. å¤´åƒé¢„è§ˆé€»è¾‘
function previewProfileAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            tempCharProfileData.avatar = e.target.result;
            document.getElementById('edit-char-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 3. ã€æ ¸å¿ƒåŒæ­¥å¼•æ“ã€‘ï¼šä¿å­˜å¹¶è¦†ç›–æ‰€æœ‰æ•°æ®åº“
async function saveCharProfileChanges() {
    const id = tempCharProfileData.id;
    const newName = document.getElementById('edit-char-name').value.trim();
    const newDesc = document.getElementById('edit-char-desc').value.trim();
    const newAvatar = tempCharProfileData.avatar;

    if (!newName) { showToast("åç§°ä¸èƒ½ä¸ºç©º"); return; }

    showToast("æ­£åœ¨åŒæ­¥å…¨åŸŸèµ„æ–™...");

    // --- A. åŒæ­¥åˆ°è§’è‰²ä¹¦ (char_list) ---
    let charList = await loadFromDB('char_list') || [];
    let charIdx = charList.findIndex(c => c.id === id);
    if (charIdx !== -1) {
        charList[charIdx].name = newName;
        charList[charIdx].avatar = newAvatar;
        charList[charIdx].desc = newDesc;
        await saveToDB('char_list', charList);
    }

    // --- B. åŒæ­¥åˆ°å¥½å‹åˆ—è¡¨ (chat_friends) ---
    let friendList = await loadFromDB('chat_friends') || [];
    let friendIdx = friendList.findIndex(f => f.id === id);
    if (friendIdx !== -1) {
        friendList[friendIdx].name = newName;
        friendList[friendIdx].avatar = newAvatar;
        await saveToDB('chat_friends', friendList);
    }

    // --- C. åŒæ­¥åˆ°å½“å‰æ­£åœ¨è¿›è¡Œçš„ä¸Šä¸‹æ–‡ ---
    window.currentChattingWith.name = newName;
    window.currentChattingWith.avatar = newAvatar;

    // --- D. åˆ·æ–°å½“å‰ UI ---
    // åˆ·æ–°èŠå¤©å®¤å¤´éƒ¨
    document.getElementById('room-contact-name').textContent = newName;
    document.getElementById('room-contact-avatar').src = newAvatar;
    
    // å¼ºåˆ¶é©±åŠ¨æ‰€æœ‰åˆ—è¡¨é‡ç»˜
    if (typeof renderChatList === 'function') renderChatList();
    if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
    if (typeof renderCharList === 'function') renderCharList();

    // æˆåŠŸæç¤ºå¹¶é€€å‡º
    closeSubPage('subpage-char-profile');
    triggerSuccessHud("èµ„æ–™å·²å…¨åŸŸåŒæ­¥");
}
// A. æ‰“å¼€å¥½å‹ç¯ç¤¾äº¤å¡
function openSocialCard(char) {
    window.currentEditingCharId = char.id; // å…³é”®ï¼šè®°å½•å½“å‰æ­£åœ¨çœ‹è°
    
    document.getElementById('social-v-avatar').src = char.avatar;
    document.getElementById('social-v-name').textContent = char.name;
    
    // ä»ç¼“å­˜è¯»å–ç­¾å
    const savedMotto = localStorage.getItem('chat_motto_' + char.id) || "Hello! Let's chat.";
    document.getElementById('social-v-motto').textContent = savedMotto;
    
    document.getElementById('modal-social-card').style.display = 'flex';
}

// ä»å¡ç‰‡ç‚¹å‡»ç­¾åçš„å…¥å£
function openEditMottoFromCard() {
    const mottoEl = document.getElementById('social-v-motto');
    const input = document.getElementById('motto-input');
    const modal = document.getElementById('modal-motto-edit');
    
    if (input && mottoEl) {
        input.value = mottoEl.textContent;
        // ğŸš¨ é‡ç‚¹ï¼šåªç®¡æ˜¾ç¤ºè‡ªå·±ï¼Œä¸è¦å»ç¢°åº•ä¸‹çš„ modal-social-card
        modal.style.display = 'flex'; 
    }
}

// ä¿®æ”¹åçš„ä¿å­˜å‡½æ•°
function saveMotto() {
    const input = document.getElementById('motto-input');
    const val = input ? input.value.trim() : "";
    const charId = window.currentEditingCharId;

    if (val && charId) {
        localStorage.setItem('chat_motto_' + charId, val);
        
        // åŒæ­¥æ‰€æœ‰å¯èƒ½çš„ UI å…ƒç´ 
        const els = ['social-v-motto', 'profile-v-motto'];
        els.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = val;
        });

        triggerSuccessHud("ç­¾åå·²åŒæ­¥");
    }
    
    // ğŸš¨ é‡ç‚¹ï¼šåªå…³é—­ä¿®æ”¹æ¡†ï¼Œä¸è¦è¯¯å…³åº•ä¸‹çš„ç¤¾äº¤å¡ç‰‡
    document.getElementById('modal-motto-edit').style.display = 'none';
}

// B. æ‰“å¼€è®¾ç½®é¡µèµ„æ–™é¢„è§ˆå¡
async function openChatProfileFromSettings() {
    const contact = window.currentChattingWith;
    if(!contact) return;
    
    // è·å–æœ€æ–°æœ€å…¨çš„æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const fullChar = charList.find(c => c.id === contact.id) || contact;

    document.getElementById('aes-v-avatar').src = fullChar.avatar;
    document.getElementById('aes-v-name').textContent = fullChar.name;
    document.getElementById('aes-v-desc').textContent = fullChar.desc || "No description yet.";
    
    document.getElementById('modal-aes-preview').style.display = 'flex';
}
// 1. æ‰“å¼€ä¸–ç•Œç»‘å®šé¡µ
async function openWorldBindPage() {
    const contact = window.currentChattingWith;
    const worldList = await loadFromDB('world_list') || [];
    const charList = await loadFromDB('char_list') || [];
    const currentChar = charList.find(c => c.id === contact.id);
    
    // è®°ä½å½“å‰å·²ç»‘å®šçš„
    const boundIds = currentChar.boundWorldIds || [];
    const container = document.getElementById('world-bind-list');
    container.innerHTML = "";

    worldList.forEach(w => {
        const isChecked = boundIds.includes(w.id);
        const item = document.createElement('div');
        item.className = 'ios-list-item';
        item.innerHTML = `
            <div class="item-content">
                <span class="item-label">${w.name}</span>
                <input type="checkbox" class="world-checkbox" data-id="${w.id}" ${isChecked ? 'checked' : ''} style="width:22px; height:22px;">
            </div>
        `;
        container.appendChild(item);
    });
    openSubPage('subpage-world-bind');
}

// 2. ä¿å­˜ç»‘å®šå…³ç³»
async function saveWorldBinding() {
    const contact = window.currentChattingWith;
    const checks = document.querySelectorAll('.world-checkbox:checked');
    const selectedIds = Array.from(checks).map(c => c.dataset.id);

    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].boundWorldIds = selectedIds;
        await saveToDB('char_list', charList);
        document.getElementById('val-bound-count').textContent = selectedIds.length + " ä¸ªåè®®";
        triggerSuccessHud("åè®®å·²ç»‘å®š");
        closeSubPage('subpage-world-bind');
    }
}

// 3. è§£æå…³ç³»ç½‘ (åˆ›æ–°ç‚¹ï¼šAI è‡ªåŠ¨åˆ›é€  NPC)
// --- ğŸŒŒ æ ¸å¿ƒï¼šå¢é‡ç”Ÿæˆå¼•æ“ ---
async function generateRelationsWithAI(isAppend = false) {
    const contact = window.currentChattingWith;
    const loader = document.getElementById('quantum-loader');
    const statusText = document.getElementById('q-status');

    loader.style.display = 'flex';
    
    // 1. æå–â€œå·²æœ‰äººç‰©åå•â€ï¼šè¿™æ˜¯é˜²æ­¢ AI ç”Ÿæˆé‡å¤è§’è‰²çš„å…³é”®
    const charList = await loadFromDB('char_list') || [];
    const charIdx = charList.findIndex(c => c.id === contact.id);
    const currentChar = charList[charIdx];
    const existingNPCs = currentChar.relationNetwork || [];
    const existingNames = existingNPCs.map(n => n.name).join('ã€'); // ğŸ‘ˆ ä¼ ç»™ AI çš„â€œé»‘åå•â€

    // 2. æå–ä¸–ç•Œè§‚è§„åˆ™
    const allWorlds = await loadFromDB('world_list') || [];
    const boundIds = currentChar.boundWorldIds || [];
    const worldContext = allWorlds.filter(w => boundIds.includes(w.id)).map(w => w.content).join("\n");

    statusText.textContent = isAppend ? "æ­£åœ¨æ‹“å®½ç¤¾äº¤è±¡é™..." : "æ­£åœ¨æ„å»ºåˆä»£ç½‘ç»œ...";

    // 3. æ„å»º Promptï¼šæ˜ç¡®è¦æ±‚åŒºåˆ† level
    const prompt = `ä½ æ˜¯ä¸€å°é‡å­ç¤¾äº¤ç½‘ç»œæ¨¡æ‹Ÿå™¨ã€‚åŸºäºè§’è‰²[${currentChar.name}]å’Œä¸–ç•ŒèƒŒæ™¯[${worldContext}]ã€‚
    ${isAppend ? `ç›®å‰å·²æœ‰è§’è‰²: ${existingNames}ã€‚è¯·ã€ç»å¯¹é¿å¼€ã€‘è¿™äº›äººåï¼Œæ–°å¢ 2-3 ä¸ªæ€§æ ¼è¿¥å¼‚çš„äººç‰©ã€‚` : `è¯·åˆ›é€  3-5 ä¸ªæ ¸å¿ƒäººç‰©ã€‚`}
    
    è¦æ±‚ï¼š
    - "level" å­—æ®µ: å¿…é¡»æ ‡æ³¨ä¸º "core" (ç¾ç»Šææ·±) æˆ– "associate" (æ™®é€šå¾€æ¥)ã€‚
    - "art_tag": æè¿°å…¶åšæ¶‚é£å¤–è²Œå…³é”®è¯ã€‚
    
    æ ¼å¼: [{"name":"","role":"","bio":"","level":"core/associate","art_tag":""}]`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const newNpcs = JSON.parse(data.choices[0].message.content.match(/\[.*\]/s)[0]);

        // 4. æ³¨å…¥å¤´åƒå’Œ ID
        newNpcs.forEach((n, index) => {
            n.id = "npc_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            n.avatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${n.art_tag + n.name}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        });

        // 5. å¢é‡ä¿å­˜ï¼šæŠŠæ–°ç”Ÿæˆçš„æ‹¼æ¥åˆ°æ—§çš„åé¢
        const updatedNetwork = isAppend ? [...existingNPCs, ...newNpcs] : newNpcs;
        currentChar.relationNetwork = updatedNetwork;
        await saveToDB('char_list', charList);

        // 6. UI åˆ·æ–°
        renderNPCGrid(updatedNetwork);
        document.getElementById('relation-empty-state').style.display = 'none';
        document.getElementById('relation-footer').style.display = 'flex'; // ğŸ‘ˆ ç¡®ä¿æ‰©å±•æŒ‰é’®å¯è§
        
        loader.style.display = 'none';
        triggerSuccessHud(isAppend ? "çº½å¸¦å·²æ‹“å®½" : "å…³ç³»ç½‘å·²å°±ç»ª");

    } catch(e) {
        loader.style.display = 'none';
        showToast("é‡å­çº ç¼ å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
}

// --- ğŸ“– å‰§æƒ…å›æº¯ï¼šç”Ÿæˆä¸“å±å¾€äº‹ ---
// ==========================================
// ğŸ“œ å¾€äº‹è§£å¯†ç³»ç»Ÿï¼šå…¨æ–°æ¨ç¿»ç‰ˆ
// ==========================================

// ==========================================
// ğŸ•µï¸ NPC å¾€äº‹è¿½è¸ªå¼•æ“ï¼šç‰©ç†å¯¹é½ä¸é˜²å´©åç‰ˆ
// ==========================================
async function traceNPCStory() {
    const npc = window.currentViewingNPC; 
    const mainChar = window.currentChattingWith; 
    
    // ğŸš¨ ä¿®æ­£ 1ï¼šç²¾å‡†å®šä½æŒ‰é’®ã€‚ä½¿ç”¨ .npc-btn-action åŒ¹é…ä½ çš„ HTML
    // æˆ‘ä»¬ç›´æ¥æŠ“å–ç‚¹å‡»çš„é‚£ä¸ªâ€œå¾€äº‹â€æŒ‰é’®
    const btn = document.querySelector('#modal-npc-detail .npc-btn-action:first-child');

    // ğŸš¨ ä¿®æ­£ 2ï¼šé˜²å¾¡æ€§é€»è¾‘ï¼Œé˜²æ­¢ null å¯¼è‡´ classList æŠ¥é”™
    if (!btn) {
        console.error("System Error: æ‰¾ä¸åˆ°æŒ‰é’®å…ƒç´ ï¼Œè¯·æ£€æŸ¥ HTML ç±»åæ˜¯å¦ä¸º .npc-btn-action");
        return;
    }

    if (!npc || !mainChar) {
        if (window.showToast) window.showToast("âš ï¸ æ— æ³•è¯†åˆ«è§’è‰²é“¾è·¯");
        return;
    }

    // 1. æ£€æŸ¥æ˜¯å¦å·²ç»è§£å¯†è¿‡ (æŒä¹…åŒ–è¯»å–)
    if (npc.detailedPast) {
        console.log("System: æ¡£æ¡ˆå·²å­˜åœ¨ï¼Œæ­£åœ¨ç›´æ¥æ‰“å¼€...");
        document.getElementById('modal-npc-detail').style.display = 'none';
        if (window.openPastDecoderUI) openPastDecoderUI(npc, npc.detailedPast, false);
        return;
    }

    // 2. å¼€å¯è§£å¯†åŠ¨ç”»
    if (btn.classList.contains('decoding')) return;
    btn.classList.add('decoding');
    const originalText = btn.innerHTML; // å¤‡ä»½åŒ…å«å›¾æ ‡çš„ HTML
    btn.textContent = "DECODING...";

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        await new Promise(r => setTimeout(r, 1200));

        // ğŸ­ é’ˆå¯¹ BL å°è¯´èƒŒæ™¯ä¼˜åŒ–çš„ç”µå½±æ„Ÿ Prompt
        const prompt = `ä½ æ­£åœ¨å›æº¯[${mainChar.name}]ä¸[${npc.name}]çš„å…±åŒå¾€äº‹ã€‚
        èƒŒæ™¯: ${npc.bio}ï¼Œä¸¤äººçš„å…³ç³»ç°çŠ¶: ${npc.role}ã€‚
        è¯·åˆ›ä½œä¸€æ®µçº¦ 250 å­—çš„éšç§˜å¾€äº‹ï¼Œè¦æ±‚ï¼š
        1. é£æ ¼é«˜çº§ã€å¯Œæœ‰ç”µå½±æ„Ÿå’Œç ´ç¢æ„Ÿã€‚
        2. ä¾§é‡äºä¸¤äººæƒ…æ„Ÿçš„æš—æµæ¶ŒåŠ¨æˆ–æŸä¸ªå‘½è¿è½¬æŠ˜ç‚¹ã€‚
        3. ç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€ã€‚`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        
        // å¢åŠ å®‰å…¨æå–é€»è¾‘
        if (!data.choices || !data.choices[0]) throw new Error("API è¿”å›æ•°æ®å¼‚å¸¸");
        const story = data.choices[0].message.content.trim();

        // 3. æ ¸å¿ƒï¼šä¿å­˜åˆ° IndexedDB æ•°æ®åº“ï¼Œé˜²æ­¢åˆ·æ–°æ¶ˆå¤±
        // å‡è®¾ä½ å·²ç»å®šä¹‰äº†å…¨å±€çš„ loadFromDB å’Œ saveToDB å‡½æ•°
        let charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === mainChar.id);
        
        if (charIdx !== -1) {
            const relationNetwork = charList[charIdx].relationNetwork || [];
            const nIdx = relationNetwork.findIndex(n => n.id === npc.id);
            if (nIdx !== -1) {
                charList[charIdx].relationNetwork[nIdx].detailedPast = story;
                await saveToDB('char_list', charList);
                window.currentViewingNPC.detailedPast = story;
            }
        }

        // 4. æš´åŠ›åˆ‡æ¢ç•Œé¢
        btn.classList.remove('decoding');
        btn.innerHTML = originalText; // è¿˜åŸå›¾æ ‡
        
        const modal = document.getElementById('modal-npc-detail');
        if (modal) modal.style.display = 'none'; 
        
        setTimeout(() => {
            if (window.openPastDecoderUI) {
                openPastDecoderUI(npc, story, true); // å”¤èµ·æ–°å¡ç‰‡å¹¶å¼€å¯æ‰“å­—æœº
            }
        }, 150);

    } catch (e) {
        console.error("è§£å¯†å¤±è´¥:", e);
        btn.classList.remove('decoding');
        btn.innerHTML = originalText;
        if (window.showToast) window.showToast("é‡å­ä¿¡å·è¿æ¥å¤±è´¥");
    }
}

// è¾…åŠ©ï¼šæ‰“å¼€è§£å¯†å±•ç¤ºå±‚
function openPastDecoderUI(npc, content, isNew) {
    const modal = document.getElementById('modal-past-decoder');
    const textField = document.getElementById('past-text-body');
    
    // å¡«å……åŸºæœ¬ä¿¡æ¯
    document.getElementById('past-name-txt').textContent = npc.name;
    document.getElementById('past-avatar-img').src = npc.avatar;
    document.getElementById('past-hero-blur').style.backgroundImage = `url(${npc.avatar})`;

    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';
    
    textField.textContent = "";
    if (isNew) {
        // æ‰“å­—æœºæ•ˆæœ
        let i = 0;
        function typing() {
            if (i < content.length) {
                textField.textContent += content.charAt(i);
                i++;
                // æ»šåŠ¨æ¡è‡ªåŠ¨è·Ÿéš
                const scroller = modal.querySelector('.aes-scroll-area');
                scroller.scrollTop = scroller.scrollHeight;
                setTimeout(typing, 25);
            }
        }
        typing();
    } else {
        textField.textContent = content;
    }
}

// è¾…åŠ©ï¼šå…³é—­å‡½æ•°
function closePastDecoder() {
    document.getElementById('modal-past-decoder').style.display = 'none';
}

// --- ğŸ¨ æ¸²æŸ“ï¼šåŠ¨æ€åŒºåˆ†å…³ç³»æƒé‡ ---
function renderNPCGrid(npcs) {
    const grid = document.getElementById('npc-grid');
    if (!grid) return;
    grid.innerHTML = "";
    
    npcs.forEach((npc, i) => {
        const card = document.createElement('div');
        const isCore = npc.level === 'core';
        card.className = `char-card npc-arrival npc-${npc.level || 'associate'}`;
        card.style.animationDelay = (i * 0.1) + "s";
        card.innerHTML = `
            <img class="char-card-img" src="${npc.avatar}">
            ${isCore ? '<div class="core-bond-badge" style="position:absolute; top:10px; left:10px; background:#007AFF; color:white; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:900;">CORE</div>' : ''}
            <div class="char-card-info">
                <div class="char-card-name">${npc.name}</div>
                <div class="char-card-desc" style="color:${isCore ? '#007AFF' : '#8e8e93'}; font-weight:700;">${npc.role}</div>
            </div>`;
        
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»å¡ç‰‡æ—¶ï¼ŒæŠŠæ•°æ®å¡ç»™å…¨å±€å˜é‡ï¼Œå¦åˆ™æŒ‰é’®æ‰¾ä¸åˆ°ç›®æ ‡
        card.onclick = () => {
            console.log("System: Selecting NPC ->", npc.name);
            window.currentViewingNPC = npc; 
            openNPCDetail(npc);
        };
        grid.appendChild(card);
    });
}

// --- ğŸ­ æ‰“å¼€ NPC èµ„æ–™å¡ ---
// --- ğŸ­ æ‰“å¼€ NPC èµ„æ–™å¡ (çº¯å‡€ç‰ˆï¼Œè§£å†³ style æŠ¥é”™) ---
function openNPCDetail(npc) {
    console.log("System: Opening Dossier for ->", npc.name);
    window.currentViewingNPC = npc; 

    // 1. å¡«å……åŸºç¡€ä¿¡æ¯
    const avatar = document.getElementById('npc-v-avatar');
    const banner = document.getElementById('npc-v-banner');
    const name = document.getElementById('npc-v-name');
    const role = document.getElementById('npc-v-role');
    const bio = document.getElementById('npc-v-bio');

    if(avatar) avatar.src = npc.avatar;
    if(banner) banner.src = npc.avatar; 
    if(name) name.textContent = npc.name;
    if(role) role.textContent = npc.role.toUpperCase();
    if(bio) bio.textContent = npc.bio;
    
    // 2. çŠ¶æ€é‡ç½®ï¼šç¡®ä¿æŒ‰é’®æ–‡å­—å›å½’åˆå§‹çŠ¶æ€
    const btn = document.querySelector('#modal-npc-detail .npc-btn-main:first-child');
    if (btn) {
        btn.classList.remove('scanning'); // ç§»é™¤æ‰«æåŠ¨ç”»ç±»
        btn.textContent = "æŸ¥çœ‹å¾€äº‹";      // æ¢å¤åŸæœ¬æ–‡å­—
    }

    // 3. æ˜¾ç¤ºå¼¹çª—
    const modal = document.getElementById('modal-npc-detail');
    if(modal) modal.style.display = 'flex';
}
// --- ğŸš€ æ‰“å¼€å…³ç³»ç½‘å­é¡µé¢ ---
async function openRelationsPage() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    // 1. ä»æ•°æ®åº“è¯»å–å½“å‰è§’è‰²çš„æœ€æ–°æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const currentChar = charList.find(c => c.id === contact.id);
    
    const emptyState = document.getElementById('relation-empty-state');
    const npcGrid = document.getElementById('npc-grid');

    // 2. æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰äº†ç”Ÿæˆå¥½çš„å…³ç³»ç½‘
    const network = currentChar.relationNetwork || [];
    
    if (network.length > 0) {
        // å¦‚æœæœ‰æ•°æ®ï¼Œéšè—ç©ºçŠ¶æ€ï¼Œæ¸²æŸ“ç½‘æ ¼
        if (emptyState) emptyState.style.display = 'none';
        renderNPCGrid(network); // è°ƒç”¨ä½ ä¹‹å‰å†™çš„æ¸²æŸ“å‡½æ•°
    } else {
        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºâ€œé‡å­è§£æâ€æŒ‰é’®
        if (emptyState) emptyState.style.display = 'block';
        if (npcGrid) npcGrid.innerHTML = "";
    }

    // 3. æ»‘å…¥é¡µé¢
    openSubPage('subpage-relations');
}
// --- ğŸš‘ ä¿®æ­£ ID å†²çªè¡¥ä¸ ---
async function saveWorldBinding() {
    const contact = window.currentChattingWith;
    const checks = document.querySelectorAll('.world-checkbox:checked');
    const selectedIds = Array.from(checks).map(c => c.dataset.id);

    let charList = await loadFromDB('char_list') || [];
    const idx = charList.findIndex(c => c.id === contact.id);
    if (idx !== -1) {
        charList[idx].boundWorldIds = selectedIds;
        await saveToDB('char_list', charList);

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œè¦æŠŠ 'val-bound-count' æ”¹ä¸º 'val-bound-status'
        const statusEl = document.getElementById('val-bound-status');
        if (statusEl) {
            statusEl.textContent = selectedIds.length > 0 ? selectedIds.length + " ä¸ªåè®®" : "å»ç»‘å®š";
        }

        triggerSuccessHud("åè®®å·²ç»‘å®š");
        closeSubPage('subpage-world-bind');
    }
}
// ==========================================
// ğŸ“¡ æ·±åº¦ç¤¾äº¤é€»è¾‘ï¼šå¸¦â€œä»ªå¼æ„Ÿâ€å»¶è¿Ÿçš„ AI å®¡æ ¸
// ==========================================
async function handleNPCFriendRequest() {
    const btn = document.getElementById('npc-add-btn');
    const text = document.getElementById('npc-add-text');
    
    // 1. æ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨
    const sourceNpc = window.currentViewingNPC;
    const mainChar = window.currentChattingWith;

    console.log("System: Requesting more relations for", sourceNpc ? sourceNpc.name : "NULL");

    if (!btn || btn.classList.contains('sending')) return;
    
    if (!sourceNpc) {
        showToast("âš ï¸ æœªè¯†åˆ«åˆ°ç›®æ ‡ NPC");
        return;
    }

    // --- å¯åŠ¨åŠ¨æ•ˆ ---
    btn.classList.add('sending');
    text.textContent = "SIGNALING...";

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        if (!apiKey) throw new Error("Missing API Key");

        // æ¨¡æ‹Ÿæ‰«ææ„Ÿ
        await new Promise(r => setTimeout(r, 1000));
        text.textContent = "DECODING...";

        // 2. å‡†å¤‡ä¸Šä¸‹æ–‡
        const charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === mainChar.id);
        const currentCharData = charList[charIdx];
        const existingNetwork = currentCharData.relationNetwork || [];
        const existingNames = existingNetwork.map(n => n.name).join('ã€');

        const prompt = `ä½ æ˜¯ä¸€å°é‡å­å…³ç³»æ¨¡æ‹Ÿå™¨ã€‚
        ç›®å‰ä¸»è§’[${mainChar.name}]é€šè¿‡äººç‰©[${sourceNpc.name}](${sourceNpc.role})åœ¨æ·±å…¥ç¤¾äº¤åœˆã€‚
        è¯·åŸºäº[${sourceNpc.name}]çš„èƒŒæ™¯[${sourceNpc.bio}]ï¼Œå†æ‰©å…… 2 ä¸ªä¸ä»–æœ‰å¯†åˆ‡å¾€æ¥çš„æ–°è§’è‰²ã€‚
        ã€è¦æ±‚ã€‘ç»å¯¹é¿å¼€å·²æœ‰äººç‰©ï¼š${existingNames}ã€‚
        ã€è¾“å‡ºã€‘ä¸¥æ ¼JSONæ•°ç»„æ ¼å¼: [{"name":"","role":"ä¸${sourceNpc.name}çš„å…³ç³»","bio":"","level":"associate","art_tag":""}]`;

        // 3. AI è°ƒç”¨
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        const content = data.choices[0].message.content;
        const newNpcs = JSON.parse(content.match(/\[.*\]/s)[0]);

        // 4. å¤„ç†æ–°äºº
        newNpcs.forEach(n => {
            n.id = "npc_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            n.avatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${encodeURIComponent(n.name)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
        });

        // 5. å¢é‡ä¿å­˜
        const updatedNetwork = [...existingNetwork, ...newNpcs];
        charList[charIdx].relationNetwork = updatedNetwork;
        await saveToDB('char_list', charList);

        // 6. è§†è§‰åé¦ˆ
        text.textContent = "SYNCED";
        btn.classList.remove('sending');
        btn.classList.add('sent');
        btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" style="margin-right:5px;"><polyline points="20 6 9 17 4 12"></polyline></svg><span>å‘ç°æ–°è„‰ç»œ</span>`;

        showToast(`å·²è§£æå‡º ${newNpcs.length} ä¸ªæ–°äººç‰©`);

        // 7. åˆ·æ–°å¹¶é€€å‡º
        setTimeout(() => {
            document.getElementById('modal-npc-detail').style.display = 'none';
            btn.classList.remove('sent');
            btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg><span id="npc-add-text">Add Friend</span>`;
            
            if (typeof renderNPCGrid === 'function') renderNPCGrid(updatedNetwork);
        }, 1500);

    } catch (e) {
        console.error("Critical Error:", e);
        btn.classList.remove('sending');
        text.textContent = "SIGNAL LOST";
        showToast(e.message === "Missing API Key" ? "API Key æœªé…ç½®" : "è§£æå¤±è´¥");
    }
}
// ==========================================
// ğŸ§¹ å…¨åŸŸè®°å¿†æŠ¹é™¤ï¼šå½»åº•æ¸…ç†ç¤¾äº¤ã€è®¾ç½®ã€ç»‘å®šåŠå…³ç³»ç½‘
// ==========================================
async function executeMasterSocialDelete(contactId) {
    if (!contactId) return;

    showToast("æ­£åœ¨æ‰§è¡Œé«˜ç»´è®°å¿†éš”ç¦»...");

    try {
        const db = await openDB();
        
        // --- 1. ç‰©ç†åˆ é™¤èŠå¤©è®°å½• (DB: chat_history) ---
        const txChat = db.transaction("chat_history", "readwrite");
        await txChat.objectStore("chat_history").delete(contactId);
        console.log("âœ… èŠå¤©è®°å½•å·²é”€æ¯");

        // --- 2. ç‰©ç†åˆ é™¤ä¸“å±èƒŒæ™¯æ•°æ® (DB: wallpapers) ---
        const txWall = db.transaction("wallpapers", "readwrite");
        await txWall.objectStore("wallpapers").delete(`chat_bg_data_${contactId}`);
        console.log("âœ… ä¸“å±èƒŒæ™¯äºŒè¿›åˆ¶æ•°æ®å·²æŠ¹é™¤");

        // --- 3. ä»å¥½å‹åˆ—è¡¨ç§»é™¤ (DB: chat_friends) ---
        let friendList = await loadFromDB('chat_friends') || [];
        friendList = friendList.filter(f => f.id !== contactId);
        await saveToDB('chat_friends', friendList);
        console.log("âœ… å¥½å‹åå•å·²æ¸…ç†");

        // --- 4. ã€æ ¸å¿ƒä¿®å¤ã€‘æŠ¹é™¤è§’è‰²æ¡£æ¡ˆå†…çš„ç»‘å®šä¸å…³ç³»ç½‘ (DB: char_list) ---
        let charList = await loadFromDB('char_list') || [];
        const charIdx = charList.findIndex(c => c.id === contactId);
        if (charIdx !== -1) {
            // ä¿ç•™æ ¸å¿ƒæ¡£æ¡ˆï¼ˆåã€å¤´ã€æ„Ÿï¼‰ï¼Œä½†æ¸…ç©ºæ‰€æœ‰è¡ç”Ÿæ•°æ®
            charList[charIdx].boundWorldIds = [];    // æ¸…ç©ºä¸–ç•Œä¹¦ç»‘å®š
            charList[charIdx].relationNetwork = [];  // æ¸…ç©ºå…³ç³»ç½‘ NPC
            await saveToDB('char_list', charList);
            console.log("âœ… ä¸–ç•Œåè®®ä¸å…³ç³»ç½‘å·²é‡ç½®");
        }

        // --- 5. æ¸…ç† LocalStorage ä¸­çš„çç¢é…ç½® ---
        localStorage.removeItem(`chat_motto_${contactId}`);
        localStorage.removeItem(`chat_bg_type_${contactId}`);
        
        // ç§»é™¤ç½®é¡¶
        let pinnedIds = JSON.parse(localStorage.getItem('chat_pinned_ids') || "[]");
        pinnedIds = pinnedIds.filter(id => id !== contactId);
        localStorage.setItem('chat_pinned_ids', JSON.stringify(pinnedIds));
        console.log("âœ… æœ¬åœ°åå¥½è®¾ç½®å·²æ¸…ç©º");

        // --- 6. UI çŠ¶æ€é‡ç½®ä¸åˆ·æ–° ---
        // å¼ºè¡Œå…³é—­å½“å‰å¯èƒ½æ‰“å¼€çš„æ‰€æœ‰ç›¸å…³é¡µé¢
        closeChatSettings();
        closeChatRoom();
        if(document.getElementById('subpage-relations')) closeSubPage('subpage-relations');
        if(document.getElementById('subpage-world-bind')) closeSubPage('subpage-world-bind');

        // åˆ·æ–°æ‰€æœ‰ç›¸å…³çš„åˆ—è¡¨
        if (typeof renderChatList === 'function') renderChatList();
        if (typeof initChatMsgPanel === 'function') initChatMsgPanel();
        if (typeof renderCharList === 'function') renderCharList(); // åˆ·æ–°è§’è‰²ä¹¦å°å¡ç‰‡
        
        triggerSuccessHud("è¯¥äººæ ¼å·²å›å½’åˆå§‹æ€");

    } catch (e) {
        console.error("âŒ å…¨åŸŸæ¸…ç†å¤±è´¥:", e);
        showToast("éƒ¨åˆ†é‡å­æ•°æ®æ®‹ç•™ï¼Œè¯·é‡è¯•");
    }
}
// ==========================================
// ğŸš€ æœ¬æˆ‘æ¡£æ¡ˆï¼šå¼ºåŠ›ä¿®å¤é©±åŠ¨ï¼ˆåæ¥å±…ä¸Šç‰ˆï¼‰
// ==========================================

window.openUserProfileEdit = function() {
    console.log("System: æ­£åœ¨æ‰§è¡Œæœ€é«˜æƒé™æ¨å…¥åè®®...");

    // 1. å¼ºåŠ›åˆå§‹åŒ–æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±æŠ¥é”™
    if (!window.userPersona) {
        const saved = localStorage.getItem('user_persona_data');
        window.userPersona = saved ? JSON.parse(saved) : {
            name: "æŒ‡æŒ¥å®˜",
            avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=user_default",
            bio: ""
        };
    }

    const data = window.userPersona;

    // 2. ç‰©ç†å¡«å€¼ï¼šç›´æ¥æ ¹æ® ID å¼ºè¡ŒçŒå…¥
    const avt = document.getElementById('user-avatar-pre');
    const nameInput = document.getElementById('user-name-in');
    const bioInput = document.getElementById('user-bio-in');
    
    if (avt) avt.src = data.avatar;
    if (nameInput) nameInput.value = data.name || "";
    if (bioInput) bioInput.value = data.bio || "";

    // 3. ç‰©ç†æ¨å…¥ï¼šä¸é  openSubPageï¼Œç›´æ¥æš´åŠ›å¼€å¯
    const pages = document.querySelectorAll('#subpage-user-profile');
    pages.forEach(p => {
        p.style.display = 'flex'; // å…ˆå˜ç°èº«
        setTimeout(() => {
            p.classList.add('active'); // åæ»‘å…¥
        }, 10);
    });

    console.log("System: æ¨å…¥æŒ‡ä»¤å·²ä¸‹è¾¾ï¼Œé¡µé¢åº”å·²æ»‘å…¥ã€‚");
};

// é¡ºä¾¿ä¿®å¤é¢„è§ˆå¡ç‰‡
window.openUserCardPreview = function() {
    const data = window.userPersona || JSON.parse(localStorage.getItem('user_persona_data'));
    if(!data) { showToast("æ¡£æ¡ˆå°šæœªå»ºç«‹"); return; }

    document.getElementById('user-card-avatar').src = data.avatar;
    document.getElementById('user-card-name').textContent = data.name;
    document.getElementById('user-card-bio').textContent = data.bio || "å°šæœªå½•å…¥ç³»ç»Ÿæ¡£æ¡ˆ...";

    const modal = document.getElementById('modal-user-card');
    if(modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '30000'; // ç½®é¡¶
    }
};
// ==========================================
// ğŸ‘¤ æœ¬æˆ‘æ¡£æ¡ˆï¼šç›´ç™½å‡½æ•°ä¿®å¤ç‰ˆ
// ==========================================

// 1. æ‰“å¼€ç¼–è¾‘èµ„æ–™é¡µ
function openUserProfileEdit() {
    console.log("æ­£åœ¨æ‰“å¼€ç¼–è¾‘é¡µ...");
    
    // ææ•°æ®
    var saved = localStorage.getItem('user_persona_data');
    var data = saved ? JSON.parse(saved) : { name: "æŒ‡æŒ¥å®˜", avatar: "", bio: "" };
    window.userPersona = data;

    // ç»™è¾“å…¥æ¡†å¡å€¼
    if (document.getElementById('user-avatar-pre')) document.getElementById('user-avatar-pre').src = data.avatar;
    if (document.getElementById('user-name-in')) document.getElementById('user-name-in').value = data.name;
    if (document.getElementById('user-bio-in')) document.getElementById('user-bio-in').value = data.bio;

    // å¼ºè¡Œè®©é¡µé¢ç°èº«å¹¶æ»‘å‡ºæ¥
    var page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';           // ç¡®ä¿å®ƒä¸æ˜¯ none
        page.style.zIndex = '999999';          // ç¡®ä¿å®ƒåœ¨æœ€ä¸Šé¢
        setTimeout(function() {
            page.classList.add('active');      // è§¦å‘æ»‘å…¥åŠ¨ç”»
        }, 10);
    }
}

// 2. é¢„è§ˆèµ„æ–™å¡
function openUserCardPreview() {
    console.log("æ­£åœ¨é¢„è§ˆèµ„æ–™å¡...");
    var saved = localStorage.getItem('user_persona_data');
    var data = saved ? JSON.parse(saved) : { name: "æœªçŸ¥", avatar: "", bio: "" };

    if (document.getElementById('user-card-avatar')) document.getElementById('user-card-avatar').src = data.avatar;
    if (document.getElementById('user-card-name')) document.getElementById('user-card-name').textContent = data.name;
    if (document.getElementById('user-card-bio')) document.getElementById('user-card-bio').textContent = data.bio || "å°šæœªå®šä¹‰äººæ ¼...";

    var modal = document.getElementById('modal-user-card');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '999999';
    }
}

// 3. ä¿å­˜èµ„æ–™
function saveUserProfile() {
    var name = document.getElementById('user-name-in').value.trim();
    var bio = document.getElementById('user-bio-in').value.trim();
    var avatar = document.getElementById('user-avatar-pre').src;

    if (!name) { alert("æ˜µç§°ä¸èƒ½ä¸ºç©ºå¥¥"); return; }

    var newData = { name: name, bio: bio, avatar: avatar };
    localStorage.setItem('user_persona_data', JSON.stringify(newData));
    window.userPersona = newData;

    // å…³æ‰é¡µé¢
    var page = document.getElementById('subpage-user-profile');
    if (page) page.classList.remove('active');
    
    // å¼¹å‡ºæˆåŠŸæç¤º
    if (window.triggerSuccessHud) window.triggerSuccessHud("èº«ä»½å¥‘çº¦å·²æ›´æ–°");
    else alert("èº«ä»½å¥‘çº¦å·²æ›´æ–°");
}

// 4. å¤´åƒé¢„è§ˆ
function previewUserAvatar(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('user-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

console.log("âœ… ç›´ç™½ä¿®å¤ç‰ˆå‡½æ•°å·²å…¨éƒ¨æŒ‚è½½ï¼Œç°åœ¨å»ç‚¹ç‚¹çœ‹ï¼Ÿ");
// ==========================================
// ğŸ­ èº«ä»½éš”ç¦»å¼•æ“ï¼šä¸ºæ¯ä¸ªè§’è‰²åˆ†é…ç‹¬ç«‹çš„â€œæˆ‘â€
// ==========================================

// 1. è·å–å½“å‰è§’è‰²çš„ä¸“å±èº«ä»½å‘ä½ Key
function getPersonaStorageKey() {
    // ä¼˜å…ˆç»‘å®šå½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰² ID
    var contact = window.currentChattingWith;
    if (contact && contact.id) {
        return 'user_persona_for_' + contact.id;
    }
    // å¦‚æœæ˜¯ä»å…¨å±€è®¾ç½®è¿›å…¥ä¸”æ²¡é€‰å®šè§’è‰²ï¼Œè¿”å›ä¸€ä¸ªé€šç”¨ Key
    return 'user_persona_data_global';
}

// 2. è¦†ç›–æ‰“å¼€ç¼–è¾‘é¡µé€»è¾‘ï¼šç²¾å‡†æå–è¯¥è§’è‰²çš„â€œæˆ‘â€
function openUserProfileEdit() {
    var key = getPersonaStorageKey();
    console.log("System: æ­£åœ¨è°ƒå–å‘ä½ -> " + key);

    var saved = localStorage.getItem(key);
    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæ²¡å¡«è¿‡ï¼Œä¿æŒç©ºç™½ï¼Œä¸å¡«å…¥é»˜è®¤å€¼
    var data = saved ? JSON.parse(saved) : { name: "", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=placeholder", bio: "" };
    
    window.userPersona = data;

    // ç‰©ç†å¡«å€¼
    if (document.getElementById('user-avatar-pre')) document.getElementById('user-avatar-pre').src = data.avatar;
    if (document.getElementById('user-name-in')) document.getElementById('user-name-in').value = data.name;
    if (document.getElementById('user-bio-in')) document.getElementById('user-bio-in').value = data.bio;

    // å¼ºè¡Œæ˜¾å½¢å¹¶æ»‘å‡º
    var page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';
        page.style.zIndex = '999999';
        setTimeout(function() { page.classList.add('active'); }, 10);
    }
}

// 3. è¦†ç›–é¢„è§ˆèµ„æ–™å¡ï¼šå±•ç¤ºå½“å‰è§’è‰²çš„â€œæˆ‘â€
function openUserCardPreview() {
    var key = getPersonaStorageKey();
    var saved = localStorage.getItem(key);
    var data = saved ? JSON.parse(saved) : { name: "å°šæœªå®šä¹‰", avatar: "", bio: "åœ¨è¿™æ®µå› æœä¸­ï¼Œä½ å°šæœªå®šä¹‰è‡ªå·±çš„å­˜åœ¨ã€‚" };

    if (document.getElementById('user-card-avatar')) document.getElementById('user-card-avatar').src = data.avatar;
    if (document.getElementById('user-card-name')) document.getElementById('user-card-name').textContent = data.name;
    if (document.getElementById('user-card-bio')) document.getElementById('user-card-bio').textContent = data.bio;

    var modal = document.getElementById('modal-user-card');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '999999';
    }
}

// 4. è¦†ç›–ä¿å­˜é€»è¾‘ï¼šå°†èº«ä»½ä¿å­˜åˆ°å¯¹åº”çš„è§’è‰²å‘ä½
function saveUserProfile() {
    var name = document.getElementById('user-name-in').value.trim();
    var bio = document.getElementById('user-bio-in').value.trim();
    var avatar = document.getElementById('user-avatar-pre').src;

    if (!name) { alert("èµ·ä¸ªåå­—å§å®è´ï¼Œå“ªæ€•æ˜¯ä»£å·å¥¥"); return; }

    var newData = { name: name, bio: bio, avatar: avatar };
    var key = getPersonaStorageKey(); // å…³é”®ï¼šæ‹¿åˆ°å½“å‰è§’è‰²çš„ä¸“å± Key
    
    localStorage.setItem(key, JSON.stringify(newData));
    window.userPersona = newData;

    // ç‰©ç†å…³é—­
    var page = document.getElementById('subpage-user-profile');
    if (page) page.classList.remove('active');
    
    if (window.triggerSuccessHud) window.triggerSuccessHud("èº«ä»½å·²ç»‘å®šè‡³è¯¥è§’è‰²");
}

console.log("âœ… èº«ä»½éš”ç¦»åè®®å·²æ¿€æ´»ï¼šç°åœ¨æ¯ä¸ªè§’è‰²éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„â€˜æˆ‘â€™äº†ï¼");
// ==========================================
// ğŸ¨ æç®€é£æ ¼ï¼šæ–‡å­—å¤´åƒç”Ÿæˆå™¨
// ==========================================
// è¿™ä¸ªå‡½æ•°è´Ÿè´£ç°åœºæ‰‹æ“ä¸€ä¸ªå¸¦æ–‡å­—çš„ SVG å¤´åƒç»™ä½ 
function generateTextAvatarUrl(text, backgroundColor) {
    var txt = text ? text.charAt(0).toUpperCase() : "?"; // å–é¦–å­—æ¯ï¼Œæ²¡æœ‰å°±æ˜¾ç¤ºé—®å·
    var bg = backgroundColor || "#888888"; // é»˜è®¤é«˜çº§ç°åº•è‰²
    
    // ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„æ–¹å½¢SVGï¼Œä¸­é—´æ”¾ä¸ªç™½è‰²çš„å­—
    var svgRaw = '<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">' +
              '<rect width="120" height="120" fill="' + bg + '"/>' +
              '<text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-weight="bold" font-size="65" fill="#ffffff">' + txt + '</text>' +
              '</svg>';
    
    // è½¬æ¢æˆæµè§ˆå™¨èƒ½è¯†åˆ«çš„æ•°æ®é“¾æ¥
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgRaw);
}


// ==========================================
// ğŸ­ èº«ä»½éš”ç¦»å¼•æ“ï¼šå¤šé‡é©¬ç”²æ ¸å¿ƒ
// ==========================================

// 1. è·å–å½“å‰è§’è‰²çš„ä¸“å±èº«ä»½å‘ä½ Key
function getPersonaStorageKey() {
    var contact = window.currentChattingWith;
    if (contact && contact.id) {
        return 'user_persona_for_' + contact.id;
    }
    return 'user_persona_data_global';
}

// 2. è¦†ç›–æ‰“å¼€ç¼–è¾‘é¡µé€»è¾‘ï¼šç²¾å‡†æå–ï¼Œé»˜è®¤æ˜¾ç¤ºæ–‡å­—å¤´åƒ
function openUserProfileEdit() {
    var key = getPersonaStorageKey();
    console.log("System: æ­£åœ¨è°ƒå–å‘ä½ -> " + key);

    var saved = localStorage.getItem(key);
    
    // ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ²¡å­˜è¿‡ï¼Œä½¿ç”¨ç°åœºç”Ÿæˆçš„â€œ?â€æ–‡å­—å¤´åƒ
    var defaultAvatar = generateTextAvatarUrl("?", "#A0A0A0"); // ç”Ÿæˆä¸€ä¸ªç°åº•é—®å·å¤´åƒ
    
    var data = saved ? JSON.parse(saved) : { name: "", avatar: defaultAvatar, bio: "" };
    
    window.userPersona = data;

    // ç‰©ç†å¡«å€¼
    var avtPre = document.getElementById('user-avatar-pre');
    if (avtPre) avtPre.src = data.avatar;
    
    if (document.getElementById('user-name-in')) document.getElementById('user-name-in').value = data.name;
    if (document.getElementById('user-bio-in')) document.getElementById('user-bio-in').value = data.bio;

    // å¼ºè¡Œæ˜¾å½¢å¹¶æ»‘å‡º
    var page = document.getElementById('subpage-user-profile');
    if (page) {
        page.style.display = 'flex';
        page.style.zIndex = '999999';
        setTimeout(function() { page.classList.add('active'); }, 10);
    }
}

// 3. è¦†ç›–é¢„è§ˆèµ„æ–™å¡
function openUserCardPreview() {
    var key = getPersonaStorageKey();
    var saved = localStorage.getItem(key);
    
    // å¦‚æœæ²¡å®šä¹‰è¿‡ï¼Œé¢„è§ˆå¡ä¹Ÿæ˜¾ç¤ºé—®å·å¤´åƒ
    var defaultAvatar = generateTextAvatarUrl("?", "#A0A0A0");
    var data = saved ? JSON.parse(saved) : { name: "å°šæœªå®šä¹‰", avatar: defaultAvatar, bio: "åœ¨è¿™æ®µå› æœä¸­ï¼Œä½ å°šæœªå®šä¹‰è‡ªå·±çš„å­˜åœ¨ã€‚" };

    if (document.getElementById('user-card-avatar')) document.getElementById('user-card-avatar').src = data.avatar;
    if (document.getElementById('user-card-name')) document.getElementById('user-card-name').textContent = data.name;
    if (document.getElementById('user-card-bio')) document.getElementById('user-card-bio').textContent = data.bio;

    var modal = document.getElementById('modal-user-card');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.zIndex = '999999';
    }
}

// 4. è¦†ç›–ä¿å­˜é€»è¾‘
function saveUserProfile() {
    var name = document.getElementById('user-name-in').value.trim();
    var bio = document.getElementById('user-bio-in').value.trim();
    // æ³¨æ„ï¼šè¿™é‡Œç›´æ¥å–å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡srcï¼Œå¦‚æœä½ ä¸Šä¼ äº†æ–°å›¾ï¼Œå°±ä¼šä¿å­˜æ–°å›¾
    var avatar = document.getElementById('user-avatar-pre').src; 

    if (!name) { alert("èµ·ä¸ªåå­—å§å®è´ï¼Œå“ªæ€•æ˜¯ä»£å·å¥¥"); return; }
    
    // ğŸ’¡ å°å½©è›‹ï¼šå¦‚æœä½ æ²¡ä¸Šä¼ å›¾ç‰‡ï¼Œä¿å­˜æ—¶è‡ªåŠ¨ç”¨åå­—çš„é¦–å­—æ¯ç”Ÿæˆä¸€ä¸ªæ–°å¤´åƒ
    // å¦‚æœå½“å‰ç”¨çš„æ˜¯é»˜è®¤é—®å·å¤´åƒï¼Œä¸”ä½ å¡«äº†åå­—ï¼Œå°±ç”¨åå­—é¦–å­—æ¯é‡æ–°ç”Ÿæˆä¸€ä¸ª
    if (avatar.includes("%3F") && name) { // %3F æ˜¯ URL ç¼–ç åçš„é—®å·
         avatar = generateTextAvatarUrl(name, "#555555"); // ç”¨æ·±ç°è‰²åº• + é¦–å­—æ¯
    }

    var newData = { name: name, bio: bio, avatar: avatar };
    var key = getPersonaStorageKey();
    
    localStorage.setItem(key, JSON.stringify(newData));
    window.userPersona = newData;

    var page = document.getElementById('subpage-user-profile');
    if (page) page.classList.remove('active');
    
    if (window.triggerSuccessHud) window.triggerSuccessHud("èº«ä»½å·²ç»‘å®š");
}

// 5. å¤´åƒé¢„è§ˆï¼ˆä½ ä¹‹å‰çš„ä»£ç é‡Œå¥½åƒä¸¢äº†è¿™ä¸ªï¼Œæˆ‘ç»™ä½ è¡¥ä¸Šï¼‰
function previewUserAvatar(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('user-avatar-pre').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

console.log("âœ… æ–‡å­—å¤´åƒå¼•æ“ & èº«ä»½éš”ç¦»åè®®å·²å…¨é¢æ¿€æ´»ï¼");
// ==========================================
// ğŸŒŒ ä¸“å±å›å¿†ï¼šå…¨èƒ½é©±åŠ¨ç³»ç»Ÿ (ä¿®å¤ ReferenceError)
// ==========================================

// 1. ã€å…¥å£ã€‘æ‰“å¼€åˆ—è¡¨å¹¶è§¦å‘æ¸²æŸ“
function openExclusiveMemories() {
    console.log("System: æ­£åœ¨è°ƒå–æ—¶ç©ºæ¡£æ¡ˆ...");
    var contact = window.currentChattingWith;
    if (!contact) {
        showToast("âš ï¸ ä¸¢å¤±è§’è‰²é“¾è·¯");
        return;
    }

    var subPage = document.getElementById('subpage-memory-list');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        subPage.style.zIndex = "15000";
        // æ¸²æŸ“åˆ—è¡¨
        renderMemoryList(contact.id);
    }
}

// 3. ã€å”¤èµ·ã€‘è¯¦æƒ…è§†ç•Œ
function openCinemaMemory(m) {
    if (!m) return;
    var modal = document.getElementById('modal-memory-cinema');
    if (!modal) return;

    // å®‰å…¨è®¾ç½®æ ‡é¢˜ï¼šå°è¯•åŒ¹é…ä½ å¯èƒ½å†™çš„ä¸¤ç§ ID
    var titleEl = document.getElementById('cinema-title-ui') || document.getElementById('cinema-title');
    if (titleEl) titleEl.textContent = m.title || "æ— åè®°å¿†";

    // å®‰å…¨è®¾ç½®æ­£æ–‡ï¼šå°è¯•åŒ¹é…ä½ å¯èƒ½å†™çš„ä¸¤ç§ ID
    var textEl = document.getElementById('cinema-text-content') || document.getElementById('cinema-text');
    if (textEl) {
        textEl.style.whiteSpace = "pre-wrap";
        textEl.textContent = m.content || "";
    }

    // å®‰å…¨è®¾ç½®å›¾ç‰‡
    var imgEl = document.getElementById('cinema-img');
    if (imgEl) imgEl.src = m.img || "";

    // å¼ºè¡Œæ˜¾ç¤º
    modal.style.display = 'flex';
    modal.style.zIndex = "1000000";
}

// 4. ã€æ ¸å¿ƒç”Ÿæˆã€‘ç»†è…»æ–‡é£ + 1000å­— + ç»ä¸é‡æ ·
// ==========================================
// ğŸŒŒ ä¸“å±å›å¿†ï¼šé‡å­å™äº‹è¶…çº§å¼•æ“ (ç‰©ç†é¿é”™ç‰ˆ)
// ==========================================

// ğŸš¨ è¿™ä¸€è¡Œæ”¾åœ¨å‡½æ•°å¤–é¢ï¼Œç”¨æ¥é˜²æ­¢ç”µè„‘å¡é¡¿ï¼ˆé˜²æŠ–é”ï¼‰
var isProcessingMemory = false;

async function triggerGenerateMemory() {
    if (window.isProcessingMemory) return;
    window.isProcessingMemory = true;

    var contact = window.currentChattingWith;
    if (!contact) {
        alert("âš ï¸ é“¾è·¯ä¸¢å¤±ï¼Œè¯·é‡æ–°è¿›å…¥èŠå¤©å®¤");
        window.isProcessingMemory = false;
        return;
    }

    var loader = document.getElementById('quantum-loader-overlay') || document.getElementById('quantum-loader');
    if (loader) loader.style.display = 'flex';

    try {
        var apiKey = localStorage.getItem('gpt_key');
        var apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        if (!apiKey) throw new Error("API Key æœªé…ç½®");

        // --- 1. å‡†å¤‡åŸºç¡€æ•°æ® ---
        var charList = await loadFromDB('char_list') || [];
        var fullChar = charList.find(c => c.id === contact.id) || contact;
        var myKey = 'user_persona_for_' + contact.id;
        var myData = JSON.parse(localStorage.getItem(myKey)) || {name:"æˆ‘", bio:""};

        // è·å–å·²æœ‰æ ‡é¢˜ç”¨äºé¿é›·
        var memories = await loadFromDB('memories_' + contact.id) || [];
        var existingTitles = memories.map(m => m.title).join('ã€');

        // ğŸš¨ ã€æ ¸å¿ƒä¿®å¤ã€‘å®šä¹‰æ„Ÿå®˜æ± ï¼Œç¡®ä¿ randomSense å­˜åœ¨
        var sensoryPool = [
            "æš´é›¨æ´—åˆ·è¿‡çš„é“è½¨ä¸é”ˆè¿¹", "æ—§ä¹¦æ¶æ­»è§’çš„ç°å°˜åœ¨è·³èˆ",
            "éš”ç€æ¯›ç»ç’ƒçœ‹åˆ°çš„æ¨¡ç³Šéœ“è™¹", "æ·±å¤œç«™å°æœ€åä¸€å¼ æŠ¥çº¸è¢«å¹èµ°",
            "æŒ‡å°–æŒ‰åœ¨å†°å†·é’¢ç´é”®ä¸Šçš„é¢¤åŠ¨", "è€å®…å‚¨ç‰©é—´é‡Œæ·¤ç§¯çš„å°˜åŸƒå‘³"
        ];
        var randomSense = sensoryPool[Math.floor(Math.random() * sensoryPool.length)];

        // ğŸ§  ã€é«˜çº§ Promptã€‘å¼ºåˆ¶è¦æ±‚å·®å¼‚åŒ–
        var prompt = `ä½ æ˜¯æ–‡å­¦å™äº‹å·¨åŒ ã€‚ä¸º[${fullChar.name}]ä¸[${myData.name}]ç¼–ç»‡ä¸€æ®µä¸“å±å›å¿†ã€‚
        ã€æ„è±¡é”šç‚¹ã€‘: "${randomSense}"
        ã€é¿é›·åå•ã€‘: ç›®å‰å·²ç»å­˜åœ¨çš„æ ‡é¢˜æœ‰ [${existingTitles || "æ— "}]ã€‚

        ã€ç¦ä»¤ã€‘:
        1. ä¸¥ç¦ä½¿ç”¨ # å·ã€* å·ã€- å·ç­‰ä»»ä½• Markdown æ ‡è®°ç¬¦å·ã€‚
        2. ä¸¥ç¦æ ‡é¢˜å‡ºç°â€œæ„Ÿå®˜ç¢ç‰‡â€æˆ–æ•°å­—ã€‚æ ‡é¢˜å¿…é¡»æå…·æ–‡å­¦ç¾æ„Ÿï¼ˆå¦‚ï¼šä½™çƒ¬ã€é›ªèŒ§ã€éœ“è™¹è€³é¸£ï¼‰ã€‚
        
        ã€å†™ä½œæŒ‡ä»¤ã€‘:
        1. è§†è§’ä¸ºç¬¬ä¸€äººç§°ï¼Œå­—æ•°800-1200å­—ã€‚
        2. æ–‡é£æåº¦ç»†è…»ã€å†·å†½ã€å……æ»¡ç”µå½±æ„Ÿã€‚
        3. ã€é‡ç‚¹ã€‘: è¯·åœ¨æ–‡ä¸­ä½¿ç”¨ä»¥ä¸‹ç¬¦å·è¿›è¡Œæ’ç‰ˆæ ‡æ³¨ï¼š
           - ä½¿ç”¨ ã€ ã€‘ åŒ…è£¹æ ¸å¿ƒçš„å…³é”®è¯æˆ–å…³é”®ç¬é—´ï¼ˆå°†æ˜¾ç¤ºä¸ºé»‘åº•ç™½å­—ï¼‰ã€‚
           - ä½¿ç”¨ ã€Œ ã€ åŒ…è£¹ç»†è…»çš„æ„Ÿå®˜ç»†èŠ‚æˆ–å¿ƒç†æå†™ï¼ˆå°†æ˜¾ç¤ºä¸ºä¸‹åˆ’çº¿åŠ ç²—ï¼‰ã€‚
        4. æ¯ä¸€æ®µè¯ä¸è¦å¤ªé•¿ï¼Œæ³¨æ„ç•™ç™½å’Œå‘¼å¸æ„Ÿã€‚
        
        æ ¼å¼ï¼š
        ã€æ ‡é¢˜ã€‘æ­¤å¤„å†™æ ‡é¢˜ï¼Œæ¯ä¸€æ¬¡ä¸èƒ½é‡å¤
        ã€æ­£æ–‡ã€‘æ­¤å¤„å†™æ­£æ–‡`;

        var res = await fetch(apiUrl + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.95,
                presence_penalty: 1.0 
            })
        });

        var data = await res.json();
        if (data.error) throw new Error(data.error.message);
        var raw = data.choices[0].message.content;

        // --- 3. è§£ææ ‡é¢˜ä¸æ­£æ–‡ ---
        var titleMatch = raw.match(/ã€æ ‡é¢˜ã€‘\s*[:ï¼š]?\s*(.*?)(?:\n|ã€æ­£æ–‡ã€‘|$)/);
        var title = (titleMatch && titleMatch[1]) ? titleMatch[1].trim() : "ç¢ç‰‡ " + Date.now();
        var content = raw.replace(/ã€æ ‡é¢˜ã€‘.*(\n|$)/, "").replace(/ã€æ­£æ–‡ã€‘\s*[:ï¼š]?\s*/, "").trim();

        // --- 4. ç‰©ç†ä¿å­˜æ•°æ® (å¼ºåˆ¶åŒæ­¥å¤´åƒ) ---
        var newMem = { 
            id: Date.now(), 
            title: title, 
            content: content, 
            img: fullChar.avatar // ğŸš¨ ç‰©ç†é”å®šï¼Œç›´æ¥ç”¨å¤´åƒ
        };

        memories.unshift(newMem);
        await saveToDB('memories_' + contact.id, memories);

        // --- 5. åŒæ­¥æ¸²æŸ“ UI ---
        await renderMemoryList(contact.id); 
        if (loader) loader.style.display = 'none';
        window.openCinemaMemory(newMem);

    } catch (e) {
        if (loader) loader.style.display = 'none';
        console.error("ç”Ÿæˆå¤±è´¥:", e);
        alert("é‡å­çº ç¼ å¤±è´¥: " + e.message);
    } finally {
        window.isProcessingMemory = false;
    }
}
window.triggerGenerateMemory = triggerGenerateMemory;
// --- ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è®°å¿†ç¢ç‰‡é€»è¾‘ (åŒæ­¥ä¿®å¤ç‰ˆ) ---
async function clearAllMemories() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    showIOSConfirm(
        "æŠ¹é™¤è®°å¿†", 
        "ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ‰€æœ‰å›å¿†ç¢ç‰‡å—ï¼Ÿ", 
        "æŠ¹é™¤", 
        async function() {
            const dbKey = 'memories_' + contact.id;
            // 1. ç‰©ç†æ¸…ç©º
            await saveToDB(dbKey, []); 
            // 2. ğŸš¨ é‡ç‚¹ï¼šawait åˆ—è¡¨åˆ·æ–°
            await renderMemoryList(contact.id); 
            
            showToast("è®°å¿†å·²å½’äºè™šæ— ");
            if (window.triggerSuccessHud) triggerSuccessHud("æ¸…ç†å®Œæˆ");
        }
    );
}
// æŒ‚è½½å…¨å±€
window.clearAllMemories = clearAllMemories;

// ä¸ºäº†ç¡®ä¿ HTML é‡Œçš„ onclick="clearAllMemories()" èƒ½ç™¾åˆ†ä¹‹ç™¾æ‰¾åˆ°å®ƒ
// æˆ‘ä»¬ä¾ç„¶åœ¨å…¨å±€æ‰‹åŠ¨æŒ‚è½½ä¸€æ¬¡ï¼Œåšä¸ªåŒé‡ä¿é™©
window.clearAllMemories = clearAllMemories;
// --- ğŸï¸ æ¸²æŸ“åˆ—è¡¨å¡ç‰‡æ ¸å¿ƒ (å…·åç‰ˆ) ---
// --- ğŸï¸ æ¸²æŸ“åˆ—è¡¨å¡ç‰‡æ ¸å¿ƒ (æ”¯æŒå·¦æ»‘åˆ é™¤ç‰ˆ) ---
async function renderMemoryList(contactId) {
    console.log("System: æ­£åœ¨é‡ç»˜è®°å¿†åˆ—è¡¨å¹¶æ³¨å…¥æ»‘åŠ¨åè®®...", contactId);
    var container = document.getElementById('memory-list-container');
    if (!container) return;

    var memories = await loadFromDB('memories_' + contactId) || [];
    container.innerHTML = "";

    if (memories.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:100px 20px; color:#bbb; font-size:14px;">æ­¤é—´å°šæ— æ„Ÿå®˜ç¢ç‰‡...</div>';
        return;
    }

    memories.forEach(function(m, index) {
        // åˆ›å»ºæ»‘åŠ¨å¤–å£³
        var wrapper = document.createElement('div');
        wrapper.className = 'memory-swipe-wrapper';
        
        var displayNum = (memories.length - index).toString().padStart(2, '0');
        
        // ğŸš¨ æ ¸å¿ƒç»“æ„ï¼šæŒ‰é’®åœ¨ä¸‹ï¼Œå¡ç‰‡åœ¨ä¸Š
        wrapper.innerHTML = `
            <div class="memory-swipe-actions" onclick="deleteSingleMemory('${contactId}', ${m.id})">
                åˆ é™¤
            </div>
            <div class="memory-swipe-content memory-item-card">
                <div class="card-num">${displayNum}</div>
                <div style="position:relative; z-index:2;">
                    <span class="memory-tag" style="font-size:10px; font-weight:900; color:#007AFF; letter-spacing:2px;">FRAGMENT</span>
                    <div style="font-size:20px; font-weight:800; margin:10px 0; color:#1d1d1f;">${m.title}</div>
                    <p style="font-size:12px; color:#8e8e93; line-height:1.6;">${m.content.replace(/<[^>]+>/g, '').substring(0, 50)}...</p>
                </div>
            </div>
        `;
        
        // 1. è·å–å¡ç‰‡å†…å®¹å±‚ï¼Œå‡†å¤‡ç»‘å®šæ»‘åŠ¨äº‹ä»¶
        var contentEl = wrapper.querySelector('.memory-swipe-content');
        
        // 2. ç»‘å®šç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… (æ³¨æ„è¿™é‡Œç‚¹çš„æ˜¯ contentEl)
        contentEl.onclick = function() {
            // å¦‚æœå¡ç‰‡æ²¡è¢«æ»‘å¼€ï¼Œæ‰æ‰§è¡Œæ‰“å¼€é€»è¾‘
            if(contentEl.style.transform === "translateX(0px)" || !contentEl.style.transform) {
                window.openCinemaMemory(m);
            } else {
                // å¦‚æœæ»‘å¼€äº†ï¼Œç‚¹ä¸€ä¸‹å°±æ”¶å›å»
                contentEl.style.transform = "translateX(0px)";
            }
        };

        // 3. å¤ç”¨ä½ å·²æœ‰çš„æ»‘åŠ¨ç›‘å¬å¼•æ“
        // ğŸš¨ æ³¨æ„ï¼šå› ä¸ºä½ çš„ initSwipeEvents é‡Œçš„é˜ˆå€¼æ˜¯ -150ï¼Œæˆ‘ä»¬è¦å¾®è°ƒä¸€ä¸‹è¿™ä¸ªå…·ä½“çš„å¡ç‰‡
        initSwipeEvents(contentEl); 
        
        container.appendChild(wrapper);
    });
}
window.renderMemoryList = renderMemoryList;
// --- ğŸ—‘ï¸ ç²¾å‡†æŠ¹é™¤å•æ¡è®°å¿†ç¢ç‰‡ ---
async function deleteSingleMemory(contactId, memoryId) {
    // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»
    if(event) event.stopPropagation();

    showIOSConfirm(
        "æŠ¹é™¤ç‰‡æ®µ", 
        "ç¡®å®šè¦å°†è¿™æ®µç‰¹å®šçš„æ„Ÿå®˜ç¢ç‰‡æ°¸ä¹…ç‰©ç†éš”ç¦»å—ï¼Ÿ", 
        "æŠ¹é™¤", 
        async function() {
            // 1. è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰è®°å¿†
            var memories = await loadFromDB('memories_' + contactId) || [];
            
            // 2. è¿‡æ»¤æ‰è¦åˆ é™¤çš„é‚£ä¸€æ¡ (æ ¹æ® ID åŒ¹é…)
            var updatedMemories = memories.filter(function(m) {
                return m.id !== memoryId;
            });
            
            // 3. å­˜å›æ•°æ®åº“
            await saveToDB('memories_' + contactId, updatedMemories);
            
            // 4. ç«‹å³åŒæ­¥é‡ç»˜åˆ—è¡¨
            await renderMemoryList(contactId);
            
            showToast("ç¢ç‰‡å·²é”€æ¯");
            if (window.triggerSuccessHud) triggerSuccessHud("æ¸…ç†å®Œæˆ");
        }
    );
}
window.deleteSingleMemory = deleteSingleMemory;
// ==========================================
// ğŸ§  è®°å¿†æ€»ç»“ç®¡ç†åè®® (å…·åå‡½æ•°ç‰ˆ)
// ==========================================

// 1. ã€å…¥å£ã€‘æ‰“å¼€è®°å¿†æ€»ç»“é¡µé¢
async function openMemorySummary() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const subPage = document.getElementById('subpage-memory-summary');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        
        // 1. åŠ è½½æ»‘å—ä½ç½®
        const savedRounds = localStorage.getItem('summary_rounds_' + contact.id) || "10";
        const slider = document.getElementById('summary-rounds-slider');
        if (slider) {
            slider.value = savedRounds;
            window.updateSummarySlider(savedRounds);
        }

        // ğŸš¨ 2. æ ¸å¿ƒä¿®å¤ï¼šæ‰“å¼€é¡µé¢æ—¶å¼ºåˆ¶æ¸²æŸ“æ‰€æœ‰å·²æœ‰çš„æ€»ç»“å¡ç‰‡
        await window.renderSummaryCards(contact.id);
    }
}
window.openMemorySummary = openMemorySummary;

// 2. ã€åé¦ˆã€‘æ»‘åŠ¨æ¡å®æ—¶æ›´æ–°
function updateSummarySlider(val) {
    const display = document.getElementById('summary-rounds-val');
    const slider = document.getElementById('summary-rounds-slider');
    if (display) display.textContent = val;
    
    // æ›´æ–°æ»‘åŠ¨æ¡çš„é»‘è‰²è¿›åº¦æ¡é•¿åº¦
    if (slider) {
        const percent = ((val - slider.min) / (slider.max - slider.min)) * 100;
        slider.style.setProperty('--percent', percent + '%');
    }
}
window.updateSummarySlider = updateSummarySlider;

// 3. ã€ä¿å­˜ã€‘æŒä¹…åŒ–è®¾ç½®
async function saveSummarySettings() {
    const contact = window.currentChattingWith;
    const val = document.getElementById('summary-rounds-slider').value;
    
    if (contact) {
        // å°†è®¾ç½®ç»‘å®šåˆ°å…·ä½“è§’è‰²
        localStorage.setItem('summary_rounds_' + contact.id, val);
        showToast("æ€»ç»“åè®®å·²ç”Ÿæ•ˆ");
        if (window.triggerSuccessHud) triggerSuccessHud("åè®®æ›´æ–°");
        closeSubPage('subpage-memory-summary');
    }
}
window.saveSummarySettings = saveSummarySettings;

// 4. ã€æ‰‹åŠ¨ã€‘è§¦å‘å³æ—¶æ€»ç»“é€»è¾‘ (é¢„ç•™ç»™ AI è°ƒç”¨çš„æ¥å£)
async function manualTriggerSummary() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    showToast("æ­£åœ¨æå–é‡å­è®°å¿†...");
    
    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        // 1. æŠ“å–æœ€è¿‘çš„èŠå¤©è®°å½•
        const history = await getChatHistory(contact.id);
        if (history.length < 5) {
            showToast("å¯¹è¯å¤ªçŸ­ï¼Œä¸è¶³ä»¥å½¢æˆè®°å¿†");
            return;
        }

        const chatContext = history.slice(-30).map(m => `${m.role}: ${m.text}`).join('\n');

        // 2. å‘ AI å‘èµ·æ€»ç»“è¯·æ±‚
        const prompt = `ä½ æ˜¯ä¸€ä¸ªè®°å¿†æå–å™¨ã€‚è¯·åˆ†æä»¥ä¸‹å¯¹è¯ï¼Œæå–å‡º [${contact.name}] ä¸ç”¨æˆ·ä¹‹é—´æœ€é‡è¦çš„å…³ç³»è¿›å±•ã€çº¦å®šçš„äº‹å®æˆ–æ·±åˆ»çš„æƒ…ç»ªè½¬æŠ˜ç‚¹ã€‚
        ã€è¦æ±‚ã€‘ï¼š
        1. è¯­æ°”ç®€ç»ƒï¼Œåƒç§äººç¬”è®°ã€‚
        2. å­—æ•°æ§åˆ¶åœ¨ 100 å­—ä»¥å†…ã€‚
        3. ä¸¥ç¦åºŸè¯ï¼Œç›´æ¥è¾“å‡ºæ€»ç»“å†…å®¹ã€‚
        
        å¯¹è¯å†…å®¹ï¼š
        ${chatContext}`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7
            })
        });

        const data = await res.json();
        const summaryText = data.choices[0].message.content.trim();

        // 3. ç‰©ç†ä¿å­˜
        let summaries = await loadFromDB('summaries_' + contact.id) || [];
        summaries.unshift({ timestamp: Date.now(), text: summaryText });
        await saveToDB('summaries_' + contact.id, summaries);

        // 4. åˆ·æ–° UI
        await renderSummaryCards(contact.id);
        triggerSuccessHud("æ ¸å¿ƒè®°å¿†å·²åç¼©");

    } catch (e) {
        showToast("æ€»ç»“å¤±è´¥");
        console.error(e);
    }
}
window.manualTriggerSummary = manualTriggerSummary;

async function renderSummaryCards(contactId) {
    const container = document.getElementById('summary-cards-container');
    if (!container) return;

    // ä»æ•°æ®åº“è¯»å–æ€»ç»“åˆ—è¡¨
    const summaries = await loadFromDB('summaries_' + contactId) || [];
    container.innerHTML = "";

    if (summaries.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc; font-size:12px; border:1px dashed #ddd; border-radius:15px;">å°šæ— æ ¸å¿ƒè®°å¿†è¢«æ•è·</div>';
        return;
    }

    summaries.forEach((s, index) => {
        const card = document.createElement('div');
        card.className = 'summary-card';
        card.innerHTML = `
            <span class="summary-date">${new Date(s.timestamp).toLocaleString()}</span>
            <div class="summary-content">${s.text}</div>
            <div class="btn-delete-summary" onclick="deleteSummary('${contactId}', ${s.timestamp})">æŠ¹é™¤</div>
        `;
        container.appendChild(card);
    });
}
window.renderSummaryCards = renderSummaryCards;

// ==========================================
// ğŸ—‘ï¸ æ ¸å¿ƒè®°å¿†æŠ¹é™¤åè®®
// ==========================================
async function deleteSummary(contactId, timestamp) {
    // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦å…¶ä»–å±‚
    if(event) event.stopPropagation();

    // 1. è°ƒç”¨ iOS é£æ ¼ç¡®è®¤æ¡†
    showIOSConfirm(
        "æŠ¹é™¤æ ¸å¿ƒè®°å¿†", 
        "ç¡®å®šè¦æ°¸ä¹…é”€æ¯è¿™æ®µå·²åç¼©çš„è®°å¿†å—ï¼ŸAI å°†ä¸å†èƒ½å›æº¯è¿™æ®µå› æœã€‚", 
        "æŠ¹é™¤", 
        async function() {
            console.log(`System: æ­£åœ¨ä»æ•°æ®åº“å‰”é™¤æ—¶é—´ç‚¹ -> ${timestamp}`);
            
            const dbKey = 'summaries_' + contactId;
            
            // 2. ä»æ•°æ®åº“è¯»å–åˆ—è¡¨
            let summaries = await loadFromDB(dbKey) || [];
            
            // 3. ç‰©ç†è¿‡æ»¤ï¼šå‰”é™¤åŒ¹é…æ—¶é—´æˆ³çš„é‚£ä¸€æ¡
            const originalLength = summaries.length;
            summaries = summaries.filter(s => s.timestamp !== timestamp);

            if (summaries.length < originalLength) {
                // 4. ä¿å­˜å›æ•°æ®åº“
                await saveToDB(dbKey, summaries);
                
                // 5. ğŸš¨ æ ¸å¿ƒï¼šç«‹å³é‡ç»˜æ€»ç»“åˆ—è¡¨ UI
                await renderSummaryCards(contactId);
                
                showToast("è®°å¿†ç‰‡æ®µå·²å½’äºè™šæ— ");
                if (window.triggerSuccessHud) triggerSuccessHud("æŠ¹é™¤æˆåŠŸ");
            } else {
                console.warn("System: æœªæ‰¾åˆ°åŒ¹é…çš„è®°å¿†èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥æ—¶é—´æˆ³ç²¾åº¦");
            }
        }
    );
}

// ğŸš¨ å¼ºåˆ¶æŒ‚è½½åˆ°å…¨å±€çª—å£ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.deleteSummary = deleteSummary;

// ==========================================
// ğŸš€ å›¾æ ‡å·¥åŠï¼šæ ‡å‡† Function é£æ ¼å¼•æ“
// ==========================================

// 1. å…¨å±€æ•°æ®
var currentIconTarget = null;
var tempIconData = null;
var iconDb = null;

// ==========================================
// ğŸš€ ç»ˆæç‰©ç†è¦†ç›–å¼•æ“ï¼šè§£å†³åˆ·æ–°â€œé—ªå›â€åŸæ ·é—®é¢˜
// ==========================================

var iconDb = null;

// 1. åˆå§‹åŒ–æ•°æ®åº“ï¼šå¼€å¯å³æ¸²æŸ“
function initDatabase() {
    var request = indexedDB.open("IconSystemDB", 1);
    
    request.onupgradeneeded = function(e) {
        var db = e.target.result;
        if (!db.objectStoreNames.contains("icons")) {
            db.createObjectStore("icons", { keyPath: "name" });
        }
    };

    request.onsuccess = function(e) {
        iconDb = e.target.result;
        console.log("System: æ•°æ®åº“é“¾æ¥æˆåŠŸï¼Œæ‰§è¡Œåˆå§‹åŒ–å¼ºåˆ¶æ¸²æŸ“");
        
        // ğŸš¨ æ ¸å¿ƒï¼šæ•°æ®åº“é“¾æ¥æˆåŠŸç¬é—´ï¼Œæ‰§è¡Œç‰©ç†è¦†ç›–
        applyAllCustomIcons();
    };
}

// 2. ç‰©ç†çº§æ¸²æŸ“å¼•æ“ï¼šå¼ºåˆ¶æ“¦é™¤é»˜è®¤æ ·å¼
function applyAllCustomIcons() {
    if (!iconDb) return;

    var transaction = iconDb.transaction("icons", "readonly");
    var store = transaction.objectStore("icons");
    var request = store.getAll();

    request.onsuccess = function(e) {
        var savedData = e.target.result;
        if (!savedData || savedData.length === 0) return;

        var iconMap = {};
        savedData.forEach(function(item) { iconMap[item.name] = item.data; });

        // 3. æ‰«ææ‰€æœ‰æ½œåœ¨ç›®æ ‡ (æ¡Œé¢ App ä¸ Dock æ )
        var allTargets = document.querySelectorAll('.app-cell, .dock-app');
        
        allTargets.forEach(function(app) {
            // èº«ä»½è¯†åˆ«ä¼˜å…ˆçº§
            var name = app.getAttribute('data-app');
            if (!name) {
                var nameEl = app.querySelector('.app-name');
                name = nameEl ? nameEl.textContent.trim() : "";
            }
            if (!name) {
                var act = app.getAttribute('onclick') || "";
                if (act.includes('charApp')) name = "RoleBook";
                if (act.includes('worldApp')) name = "WorldBook";
                if (act.includes('beautifyApp')) name = "Beautify";
                if (act.includes('iconApp')) name = "Icons";
            }

            // 4. å‘½ä¸­çš„å›¾æ ‡æ‰§è¡Œã€ç‰©ç†ç ´åæ€§ã€‘æ›¿æ¢
            if (name && iconMap[name]) {
                var box = app.querySelector('.icon-shape') || 
                          app.querySelector('.glass-icon-bg') || 
                          app;

                // ğŸš¨ å¼ºåˆ¶é‡ç½®æ ·å¼ï¼šç‰©ç†ç§»é™¤èƒŒæ™¯æ¸å˜ï¼Œæ³¨å…¥ !important æ ·å¼
                box.style.cssText = "background: transparent !important; box-shadow: none !important; border: none !important; overflow: hidden !important;";
                
                // æ³¨å…¥å›¾ç‰‡ï¼šå¢åŠ  onload ç›‘å¬ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œåå†éšè— SVG
                box.innerHTML = '<img src="' + iconMap[name] + '" style="width:100%; height:100%; object-fit:cover; border-radius:inherit; display:block;">';
                
                console.log("Fixed: ç‰©ç†è¦†ç›–æˆåŠŸ -> " + name);
            }
        });
    };
}

// 5. å¯åŠ¨å…¥å£ï¼šå¤šæ—¶æœºç‰©ç†è§¦å‘
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDatabase);
} else {
    initDatabase();
}

// é’ˆå¯¹æ‰‹æœºç«¯æ»‘åŠ¨è¿”å›ã€å”¤é†’æ—¶çš„ç¼“å­˜é—®é¢˜ï¼Œæ‰§è¡Œå¼ºåˆ¶åˆ·æ–°æ¸²æŸ“
window.addEventListener('pageshow', function() {
    if (iconDb) applyAllCustomIcons();
});

// ğŸš¨ ç»ˆæç»æ‹›ï¼šå¦‚æœä½ çš„é¡µé¢æœ‰å¤æ‚çš„åŠ¨æ€åŠ è½½ï¼Œå¼€å¯è¿™ä¸ªè§‚å¯Ÿå™¨
var observer = new MutationObserver(function() {
    if (iconDb) applyAllCustomIcons();
});
observer.observe(document.body, { childList: true, subtree: true });

// 3. å”¤èµ·é€‰æ‹©å™¨
function openIconTargetPicker() {
    var list = document.getElementById('icon-target-list');
    var subPage = document.getElementById('subpage-icon-picker');
    if (!list || !subPage) return;

    // ğŸš¨ ç‰©ç†è¡¥å…¨ï¼šç¡®ä¿æ‰€æœ‰ App éƒ½åœ¨åå•é‡Œ
    var apps = [
        "Wallpaper", "Settings", "Chat", "Photos", 
        "Music", "Themes", "Phone", "Messages", 
        "Beautify", "Icons", "Diary", "Wallet", 
        "Notes", "Shopping", "Forum", "Novels", "Live",
        "RoleBook", "WorldBook" // ğŸ‘ˆ è¡¥ä¸Šäº†ï¼
    ];
    
    list.innerHTML = apps.map(function(name) {
        return '<div class="ios-list-item" onclick="confirmIconTarget(\'' + name + '\')">' +
               '<div class="item-content"><span class="item-label">' + name + '</span></div></div>';
    }).join('');
    
    subPage.classList.add('active');
}

// 4. ç¡®è®¤é€‰æ‹© (é‡ç‚¹ä¿®å¤ï¼šç¡®ä¿å®ƒæ˜¯å…¨å±€ function)
function confirmIconTarget(name) {
    currentIconTarget = name;
    var display = document.getElementById('val-icon-target');
    if (display) display.textContent = name;
    
    var subPage = document.getElementById('subpage-icon-picker');
    if (subPage) subPage.classList.remove('active');
}

// 5. å¤„ç†æ–‡ä»¶é¢„è§ˆ (è§£å†³ handleIconFile æŠ¥é”™)
function handleIconFile(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            tempIconData = e.target.result;
            var img = document.getElementById('icon-pre-img');
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block';
                document.getElementById('icon-pre-placeholder').style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// 6. ä¿å­˜å¹¶åŒæ­¥ (IndexedDB æ¨¡å¼ï¼Œä¸é™å¤§å°)
function saveIconCustomization() {
    // 1. ç‰©ç†æ£€æŸ¥ï¼šå¦‚æœå…¨å±€å˜é‡ä¸¢äº†ï¼Œç›´æ¥ä» UI æ ‡ç­¾é‡Œç°æŠ“
    if (!window.currentIconTarget) {
        var label = document.getElementById('val-icon-target');
        if (label && label.textContent !== "è¯·é€‰æ‹©...") {
            window.currentIconTarget = label.textContent.trim();
        }
    }

    // 2. é¢„è§ˆå›¾è¡¥å¿ï¼šå¦‚æœå›¾ç‰‡å˜é‡ä¸¢äº†ï¼Œç›´æ¥ä» img æ ‡ç­¾é‡Œç°æŠ“
    if (!window.tempIconData) {
        var img = document.getElementById('icon-pre-img');
        if (img && img.src && img.style.display !== 'none') {
            window.tempIconData = img.src;
        }
    }

    // 3. æ•°æ®åº“çŠ¶æ€æ£€æŸ¥
    if (!iconDb) {
        console.warn("System: æ•°æ®åº“æœªå°±ç»ªï¼Œå°è¯•é‡è¿...");
        initDatabase(); 
        alert("ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–å­˜å‚¨ç©ºé—´ï¼Œè¯·å†ç‚¹ä¸€æ¬¡ä¿å­˜");
        return;
    }

    // 4. ç²¾å‡†æŠ¥é”™æç¤º (å‘Šè¯‰ä½ åˆ°åº•æ˜¯å“ªé‡Œæ²¡å¼„å¥½)
    if (!window.currentIconTarget || !window.tempIconData) {
        var errorMsg = "ä¿å­˜å¤±è´¥åŸå› ï¼š\n";
        errorMsg += (!window.currentIconTarget ? "- ç›®æ ‡ App åå­—æ²¡æ‹¿åˆ°\n" : "");
        errorMsg += (!window.tempIconData ? "- å›¾æ ‡å›¾ç‰‡æ•°æ®ä¸¢å¤±\n" : "");
        alert(errorMsg + "\nè¯·é‡æ–°é€‰æ‹©æˆ–ä¸Šä¼ è¯•è¯•");
        return;
    }

    // 5. æ‰§è¡Œä¿å­˜æµç¨‹
    try {
        var tx = iconDb.transaction("icons", "readwrite");
        var store = tx.objectStore("icons");
        store.put({ name: window.currentIconTarget, data: window.tempIconData });
        
        tx.oncomplete = function() {
            applyAllCustomIcons(); // ç«‹å³åˆ·æ–°å…¨ç«™å›¾æ ‡
            if (window.triggerSuccessHud) triggerSuccessHud("å…¨åŸŸå›¾æ ‡å·²åŒæ­¥");
            setTimeout(function() { closeApp('iconApp'); }, 800);
        };
        
        tx.onerror = function(e) {
            console.error("Database Error:", e);
            alert("æ•°æ®åº“å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°");
        };
    } catch (err) {
        console.error("Save Logic Crash:", err);
        alert("ä¿å­˜é€»è¾‘å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢");
    }
}

// ç‰©ç†å¯åŠ¨
initDatabase();
// æŠŠè¿™ä¸ªæ”¾è¿›ä½ çš„ JS é€»è¾‘é‡Œ
function triggerFileSelect() {
    var input = document.getElementById('icon-file-input');
    if (input) {
        input.click();
    } else {
        console.error("System: æ²¡æ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ ç»„ä»¶ï¼Œè¯·æ£€æŸ¥ HTML ID æ˜¯å¦å¯¹é½");
    }
}
// 1. å®šä¹‰æ ¸å¿ƒæ„ŸçŸ¥å‡½æ•°
function syncTimePerception() {
    // æå–æ—¶åŒº
    const tz = localStorage.getItem('user_timezone') || undefined;
    const now = new Date();
    
    // è®¡ç®—å½“å‰æ—¶åŒºçš„å°æ—¶
    let hour;
    try {
        hour = parseInt(now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            hour12: false, 
            timeZone: tz 
        }));
    } catch(e) {
        hour = now.getHours();
    }

    // é€»è¾‘åˆ†æ®µ
    let timeLabel = "";
    let themeColor = ""; 

    if (hour >= 5 && hour < 11) {
        timeLabel = "æ—©ä¸Š";
        themeColor = "#FF9500"; // æ™¨æ›¦æ©™
    } else if (hour >= 11 && hour < 14) {
        timeLabel = "ä¸­åˆ";
        themeColor = "#FF3B30"; // æ­£åˆçº¢
    } else if (hour >= 14 && hour < 18) {
        timeLabel = "ä¸‹åˆ";
        themeColor = "#5856D6"; // é›é’ç´«
    } else if (hour >= 18 && hour < 21) {
        timeLabel = "å‚æ™š";
        themeColor = "#FF2D55"; // æ™šéœç²‰
    } else {
        timeLabel = "æ™šä¸Š";
        themeColor = "#1C1C1E"; // æå¤œé»‘
    }

    // ç‰©ç†æ›´æ–°æ‰€æœ‰æ ‡ç­¾
    const labels = document.querySelectorAll('.sense-time-label');
    labels.forEach(function(el) {
        el.textContent = timeLabel;
        el.style.color = themeColor;
        el.style.borderColor = themeColor;
        el.style.backgroundColor = themeColor + "1A"; // 10% é€æ˜åº¦èƒŒæ™¯
    });

    // åŒæ—¶æ›´æ–°åœ°åŒºæ–‡å­—
    const cityName = localStorage.getItem('user_city_name') || "è‡ªåŠ¨å®šä½";
    const regionEl = document.getElementById('val-region-text');
    if (regionEl) {
        regionEl.textContent = cityName;
    }
}
window.lastSynchronizedTime = getAIPerceptionTime();

// 2. è¦†ç›–åŸæœ‰çš„æ‰“å¼€è®¾ç½®å‡½æ•° (ç¡®ä¿æ¯æ¬¡æ‰“å¼€éƒ½èƒ½åˆ·æ–°)
// æ³¨æ„ï¼šå¦‚æœä½ ä»£ç ä¸Šæ–¹å·²ç»æœ‰ä¸€ä¸ª function openChatSettings()ï¼Œè¯·ç›´æ¥åˆ æ‰å®ƒï¼Œç”¨ä¸‹é¢è¿™ä¸ª
function openChatSettings() {
    const settingsPage = document.getElementById('page-chat-settings');
    if (settingsPage) {
        settingsPage.style.transform = 'translateX(0)';
        
        // å…³é”®ï¼šå»¶è¿Ÿ 50ms æ‰§è¡Œï¼Œç­‰å¾… iOS åŠ¨ç”»æŠŠé¡µé¢æ¨å…¥ DOM æ´»è·ƒåŒº
        setTimeout(function() {
            syncTimePerception();
            
            // é¡ºä¾¿æŠŠåº•éƒ¨çš„ UID å¡«ä¸Š
            if (window.currentChattingWith) {
                const uid = document.getElementById('setting-uid-display');
                if (uid) uid.textContent = window.currentChattingWith.id.toUpperCase();
            }
        }, 50);
    }
}

// 3. å¯åŠ¨å®šæ—¶å™¨ï¼ˆæ¯ 30 ç§’è‡ªåŠ¨æ ¡å‡†ä¸€æ¬¡ï¼‰
setInterval(syncTimePerception, 30000);

// 4. é¡µé¢åˆå§‹åŒ–ä¹Ÿè¿è¡Œä¸€æ¬¡
syncTimePerception();
// 1. æ‰“å¼€æ„ŸçŸ¥é¡µé¢
async function openWeatherPerception() {
    const subPage = document.getElementById('subpage-weather-perceive');
    if (subPage) {
        subPage.classList.add('active');
        subPage.style.display = 'flex';
        // æ¸²æŸ“æ—¶é—´è½´
        renderSenseTimeline();
        // åŒæ­¥å¼€å…³çŠ¶æ€
        const isSync = localStorage.getItem('weather_sync_enabled') === 'true';
        document.getElementById('sync-weather-toggle').checked = isSync;
    }
}

// 2. åˆ‡æ¢è”åŠ¨å¼€å…³
function toggleWeatherSync() {
    const isChecked = document.getElementById('sync-weather-toggle').checked;
    localStorage.setItem('weather_sync_enabled', isChecked);
    triggerSuccessHud(isChecked ? "è”è§‰åè®®å·²å¼€å¯" : "è”è§‰å·²æ–­å¼€");
}

// 3. ã€æ ¸å¿ƒã€‘ç”Ÿæˆä¸“å±äº¤æµç¢ç‰‡
async function generateSenseTrace(isAuto = false) {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    if (!apiKey) return;

    const weather = document.getElementById('val-weather-text')?.textContent || "é˜´å¤©";
    const timeLabel = document.querySelector('.sense-time-label')?.textContent || "æ·±å¤œ";

    const prompt = `ä½ æ­£åœ¨æ‰®æ¼”: ${contact.name}ã€‚å½“å‰ç¯å¢ƒï¼š[å¤©æ°”: ${weather}, æ—¶é—´: ${timeLabel}]ã€‚
    è¯·ä»¥æ­¤ä¸ºèƒŒæ™¯ï¼Œä¸ºâ€œæˆ‘â€åˆ›ä½œä¸€æ®µæ„Ÿå®˜è®°å¿†ã€‚
    è¦æ±‚ï¼šæ­£æ–‡80å­—å·¦å³ï¼Œæš§æ˜§ç»†è…»ï¼Œå¸¦æœ‰ç ´ç¢æ„Ÿã€‚
    æ ¼å¼ï¼šã€æ­£æ–‡ã€‘å†…å®¹`;

    try {
        const res = await fetch(apiUrl + "/chat/completions", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });
        const data = await res.json();
        const raw = data.choices[0].message.content;

        const title = raw.match(/ã€æ ‡é¢˜ã€‘(.*)/)?.[1] || "æ–°çš„æ„Ÿåº”";
        const content = raw.match(/ã€æ­£æ–‡ã€‘([\s\S]*)/)?.[1] || raw;

        // ç‰©ç†å­˜æ¡£
        const trace = {
            id: Date.now(),
            title: title,
            weather: weather,
            timeLabel: timeLabel,
            content: content,
            timestamp: new Date().toLocaleString('zh-CN', { hour12: false })
        };
        
        let traces = await loadFromDB('sense_history_' + contact.id) || [];
        traces.unshift(trace);
        await saveToDB('sense_history_' + contact.id, traces);

        // ğŸš¨ ç‰©ç†è§¦å‘ï¼šå¼¹çª— + é€šçŸ¥ä¸­å¿ƒ
        if (window.showPushNotification) {
            window.showPushNotification(`${contact.name} çš„æ—¶ç©ºä¿¡ç¬º`, title);
        }
        
        // å¦‚æœé¡µé¢å¼€ç€ï¼Œç«‹å³åˆ·æ–°åˆ—è¡¨
        if (typeof renderSenseTimeline === 'function') renderSenseTimeline();

    } catch (e) {
        console.error("ç”Ÿæˆç¢ç‰‡å¤±è´¥:", e);
    }
}

// 4. æ¸²æŸ“æ—¶é—´è½´å¡ç‰‡
async function renderSenseTimeline() {
    const contact = window.currentChattingWith;
    const container = document.getElementById('sense-timeline-container');
    if (!container || !contact) return;

    // ä»æ•°æ®åº“æå–å†å²
    const traces = await loadFromDB('sense_history_' + contact.id) || [];
    
    let lastDate = ""; // ç”¨æ¥è®°å½•ä¸Šä¸€ä¸ªå¤„ç†çš„æ—¥æœŸ
    let html = "";

    traces.forEach(t => {
        // 1. è§£ææ—¥æœŸå’Œæ—¶é—´
        const fullTime = t.timestamp; 
        const datePart = fullTime.split(' ')[0]; // æ‹¿åˆ° å¹´/æœˆ/æ—¥
        const timePart = fullTime.split(' ')[1].substring(0, 5); // æ‹¿åˆ° æ—¶:åˆ†

        // 2. ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœå½“å‰æ—¥æœŸè·Ÿä¸Šä¸€ä¸ªæ—¥æœŸä¸ä¸€æ ·ï¼Œæ‰æ˜¾ç¤ºæ—¥æœŸæ ‡é¢˜
        if (datePart !== lastDate) {
            html += `<div class="timeline-date-label" style="margin-top: 25px;">${datePart}</div>`;
            lastDate = datePart; // æ›´æ–°ä¸Šä¸€æ¬¡æ˜¾ç¤ºçš„æ—¥æœŸ
        }

        // 3. æ‹¼æ¥ç‚¹å’Œå¡ç‰‡
        // æ‰¾åˆ° renderSenseTimeline é‡Œçš„ html æ‹¼æ¥éƒ¨åˆ†ï¼Œæ”¹ä¸ºä¸‹é¢è¿™æ ·ï¼š
        html += `
            <div class="timeline-item">
                <div class="timeline-dot"></div>
                
                <div class="summary-card">
                    <div style="margin-bottom:12px;">
                        <span style="font-size:10px; font-weight:800; color:#007AFF; letter-spacing:1px;">
                            ${t.weather} Â· ${t.timeLabel}
                        </span>
                    </div>
                    
                    <div style="font-size:14px; line-height:1.7; color:#333; font-family:serif; font-style:italic; text-align:justify;">
                        ${t.content}
                    </div>

                    <div class="sense-card-time">${timePart}</div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// 5. æ‰‹åŠ¨è§¦å‘
/**
 * ğŸš€ å‡çº§ç‰ˆæ‰‹åŠ¨è§¦å‘å™¨ï¼šå¸¦æœ‰è¿‡ç¨‹åŠ¨ç”»ç®¡ç†
 */
async function triggerManualSense() {
    // 1. è·å–æŒ‰é’®å…ƒç´ 
    const btn = document.querySelector('.sense-btn-main');
    if (!btn) return;

    // è®°å½•åŸå§‹æ–‡å­—ï¼Œæ–¹ä¾¿æ¢å¤
    const originalText = btn.innerText;

    // 2. å¯åŠ¨åŠ¨ç”»çŠ¶æ€ (è¿›å…¥å¿™ç¢Œæ¨¡å¼)
    btn.classList.add('sensing-active'); // æ·»åŠ  CSS åŠ¨ç”»ç±»
    btn.innerText = "æ­£åœ¨è¿æ¥æ—¶ç©ºä¿¡å·..."; // ä¿®æ”¹æ–‡å­—æç¤º
    btn.disabled = true; // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»

    try {
        // 3. æ‰§è¡ŒçœŸæ­£çš„ç”Ÿæˆé€»è¾‘ (è¿™é‡Œè°ƒç”¨ä½ ä¹‹å‰çš„æ ¸å¿ƒå‡½æ•°)
        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† awaitï¼Œæ‰€ä»¥ä¼šæš‚åœåœ¨è¿™é‡Œç­‰å¾… AI å®Œæˆ
        await generateSenseTrace(false); 
        
        // æˆåŠŸæç¤º
        triggerSuccessHud("å·²æ•è·å½“å‰æ—¶ç©ºç¢ç‰‡");

    } catch (e) {
        console.error("æ‰‹åŠ¨æ„Ÿåº”å¤±è´¥:", e);
        showToast("ä¿¡å·è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•");
    } finally {
        // 4. æ¢å¤æŒ‰é’®çŠ¶æ€ (æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œè¿™é‡Œ)
        // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹æ¢å¤ï¼Œè®©æˆåŠŸçš„å–œæ‚¦æ„Ÿåœç•™åŠç§’
        setTimeout(() => {
            btn.classList.remove('sensing-active'); // ç§»é™¤åŠ¨ç”»
            btn.innerText = originalText; // æ¢å¤åŸå§‹æ–‡å­—
            btn.disabled = false; // è§£é”æŒ‰é’®
        }, 500);
    }
}
// 6. æ„ŸçŸ¥è®¡åˆ’ä»»åŠ¡
function initSenseScheduler() {
    // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦ç”Ÿæˆ (é¢‘ç‡ç”¨æˆ·å¯è°ƒï¼Œè¿™é‡Œæ¼”ç¤ºè®¾ä¸º 4å°æ—¶)
    const FREQUENCY = 4 * 60 * 60 * 1000; 

    setInterval(async () => {
        const lastRun = localStorage.getItem('last_sense_time') || 0;
        const now = Date.now();

        if (now - lastRun > FREQUENCY) {
            await generateSenseTrace(true);
            localStorage.setItem('last_sense_time', now);
        }
    }, 60000); // æ¯åˆ†é’Ÿç©ºè½¬æ£€æŸ¥ä¸€æ¬¡
}

// 7. ç™»å½•è‡ªæ„ˆæ£€æŸ¥ (è¡¥é½é”™è¿‡çš„æ—¶é—´ç‚¹)
async function checkMissedSenses() {
    const lastRun = localStorage.getItem('last_sense_time') || 0;
    const now = Date.now();
    // å¦‚æœè¶…è¿‡ 24 å°æ—¶æ²¡è¿›ç½‘ç«™äº†ï¼Œè‡ªåŠ¨è¡¥å†™ä¸€ç¯‡â€œæ˜¨å¤©çš„å›å¿†â€
    if (lastRun > 0 && (now - lastRun > 24 * 60 * 60 * 1000)) {
        console.log("æ£€æµ‹åˆ°æ—¶ç©ºæ–­å±‚ï¼Œè¡¥é½æ„ŸçŸ¥è®°å½•...");
        await generateSenseTrace(true);
        localStorage.setItem('last_sense_time', now);
    }
}

// é¡µé¢åŠ è½½æ—¶å¯åŠ¨
document.addEventListener('DOMContentLoaded', () => {
    initSenseScheduler();
    checkMissedSenses();
});
// 1. æ‰“å¼€é€‰æ‹©å™¨
function openSenseFrequencyPicker() {
    const picker = document.getElementById('senseFrequencyPicker');
    if (picker) picker.style.display = 'flex';
}

function closeSenseFrequencyPicker() {
    document.getElementById('senseFrequencyPicker').style.display = 'none';
}

// 2. è®¾ç½®é¢‘ç‡å¹¶ç‰©ç†å­˜å…¥
function setSenseFrequency(ms, label) {
    localStorage.setItem('sense_selected_frequency', ms);
    localStorage.setItem('sense_frequency_label', label);
    
    // å¼ºåˆ¶åˆ·æ–°ä¸‹æ¬¡è¿è¡Œæ—¶é—´
    const firstNextRun = Date.now() + parseInt(ms);
    localStorage.setItem('sense_next_run_time', firstNextRun);

    const btnSub = document.querySelector('.sense-btn-sub');
    if (btnSub) btnSub.textContent = label;

    closeSenseFrequencyPicker();
    triggerSuccessHud(`è½®å›å¼€å¯ï¼š${label}`);
    
    // ğŸš¨ é‡ç‚¹ï¼šé€‰å®Œé¢‘ç‡ï¼Œç«‹åˆ»æ‰‹åŠ¨ç‚¹ç«ï¼Œä¸ç­‰é¡µé¢åˆ·æ–°
    startPerceptionEngine();
}
// ==========================================
// 4. å¯åŠ¨ç›‘å¬
// ==========================================
if (document.readyState === 'complete') {
    startPerceptionEngine();
} else {
    window.addEventListener('load', startPerceptionEngine);
}

// 3. ã€æ ¸å¿ƒã€‘ç‰©ç†è¿½æº¯ä¸æ£€æŸ¥é€»è¾‘
async function checkAndExecuteSenseLoop() {
    // åªè¦è¿™è¡Œå­—ä¸è·³ï¼Œè¯´æ˜ setInterval æ­»äº†
    console.log("%c[Sense Heartbeat] " + new Date().toLocaleTimeString() + " å¿ƒè·³æ­£å¸¸ï¼Œæ‰«æä¸­...", "color: #8e8e93;");

    // A. èº«ä»½é”å®š
    let contact = window.currentChattingWith;
    if (!contact) {
        const friends = await loadFromDB('chat_friends') || [];
        if (friends.length > 0) {
            contact = friends[0];
            window.currentChattingWith = contact;
        } else { return; }
    }

    // B. è·å–è®¾ç½®
    const freq = parseInt(localStorage.getItem('sense_selected_frequency'));
    const nextRun = parseInt(localStorage.getItem('sense_next_run_time') || "0");
    const now = Date.now();

    if (!freq) return;

    // C. åˆ¤å®šé€»è¾‘
    if (now >= nextRun) {
        console.log("%c[Sense] âš¡ è§¦å‘æ—¶åˆ»ï¼æ‰§è¡Œ AI ç¼–ç»‡...", "color: #007AFF; font-weight: bold;");
        
        // æ‰§è¡Œç”Ÿæˆ
        await generateSenseTrace(true);
        
        // ğŸš¨ æ ¸å¿ƒçº åï¼šç›´æ¥ç”¨å½“å‰æ—¶é—´ + é¢‘ç‡ï¼Œé˜²æ­¢æ—¶é—´æˆ³è·³è·ƒ
        const newNextRun = Date.now() + freq;
        localStorage.setItem('sense_next_run_time', newNextRun);
        console.log("[Sense] è½®å›é‡ç½®ï¼Œä¸‹æ¬¡ï¼š", new Date(newNextRun).toLocaleTimeString());
    } else {
        const secondsLeft = Math.round((nextRun - now) / 1000);
        // åªæœ‰åœ¨ 1 åˆ†é’Ÿæ¨¡å¼ä¸‹ï¼Œæ¯ 10 ç§’æé†’ä¸€æ¬¡ï¼Œé˜²æ­¢åˆ·å±
        if (secondsLeft % 10 === 0) {
            console.log(`[Sense] çŠ¶æ€ï¼šç¨³å®šè¿æ¥ | å€’è®¡æ—¶ï¼š${secondsLeft}ç§’`);
        }
    }
}

// 4. ã€å¯åŠ¨é”ã€‘å…¨è‡ªåŠ¨ç›‘æ§å¼•æ“
function initSenseAutoSystem() {
    // A. åˆå§‹åŒ–æŒ‰é’®æ–‡å­—æ˜¾ç¤º
    const savedLabel = localStorage.getItem('sense_frequency_label') || "è‡ªåŠ¨é¢‘ç‡";
    const btnSub = document.querySelector('.sense-btn-sub');
    if (btnSub) btnSub.textContent = savedLabel;

    // B. é¡µé¢åŠ è½½ 2 ç§’åæ‰§è¡Œç¬¬ä¸€æ¬¡â€œè¡¥æ¼â€æ£€æŸ¥
    setTimeout(function() {
        checkAndExecuteSenseLoop();
    }, 2000);

    // C. å¼€å¯é«˜é¢‘ç›‘æ§å¿ƒè·³ (æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œç¡®ä¿ 1 åˆ†é’Ÿæµ‹è¯•æåº¦ç²¾å‡†)
    setInterval(function() {
        checkAndExecuteSenseLoop();
    }, 5000);
}

// åœ¨ä½ åŸæ¥çš„ DOMContentLoaded é‡ŒåŠ å…¥åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initSenseAutoSystem();
    
    // åˆå§‹åŒ–æŒ‰é’®æ–‡å­—
    const savedLabel = localStorage.getItem('sense_frequency_label') || "è‡ªåŠ¨é¢‘ç‡";
    const btnSub = document.querySelector('.sense-btn-sub');
    if (btnSub) btnSub.textContent = savedLabel;
});
// ==========================================
// 1. æ ¸å¿ƒï¼šæ„ŸçŸ¥è½®å›æ£€æŸ¥å™¨
// ==========================================
async function checkAndExecuteSenseLoop() {
    console.log("[Sense Check] æ­£åœ¨æ‰«ææ—¶ç©ºè„‰å†²..."); // åªè¦å¼•æ“åŠ¨äº†ï¼Œè¿™è¡Œå¿…å‡º

    // A. èº«ä»½é”å®šï¼šå¦‚æœæ²¡æœ‰æ´»è·ƒå¯¹è¯ï¼Œè‡ªåŠ¨æŠ“å–ç¬¬ä¸€ä¸ªå¥½å‹
    let contact = window.currentChattingWith;
    if (!contact) {
        const friends = await loadFromDB('chat_friends') || [];
        if (friends.length > 0) {
            contact = friends[0];
            window.currentChattingWith = contact;
            console.log(`[Sense] è‡ªåŠ¨å…³è”ç›®æ ‡: ${contact.name}`);
        } else {
            console.warn("[Sense] ç¤¾äº¤å…³ç³»åº“ä¸ºç©ºï¼Œæ„Ÿåº”æŒ‚èµ·ã€‚");
            return;
        }
    }

    // B. è¯»å–é¢‘ç‡å­˜æ¡£
    const freq = parseInt(localStorage.getItem('sense_selected_frequency'));
    const nextRun = parseInt(localStorage.getItem('sense_next_run_time') || "0");
    const now = Date.now();

    if (!freq) {
        console.log("[Sense] å°šæœªè®¾å®šè‡ªåŠ¨é¢‘ç‡ï¼Œè¿›å…¥å¾…æœºæ¨¡å¼ã€‚");
        return;
    }

    // C. ç‰©ç†åˆ¤å®šï¼šæ˜¯å¦åˆ°è¾¾è½®å›ç‚¹
    if (now >= nextRun) {
        console.log("%c[Sense] âš¡ æ•è·åˆ°æ—¶ç©ºè£‚ç¼ï¼ç«‹å³ç¼–ç»‡ç¢ç‰‡...", "color: #007AFF; font-weight: bold;");
        
        // æ‰§è¡Œç”Ÿæˆ
        await generateSenseTrace(true);
        
        // é”å®šä¸‹ä¸€ä¸ªè½®å›æ—¶é—´ç‚¹
        const newNextRun = now + freq;
        localStorage.setItem('sense_next_run_time', newNextRun);
        console.log(`[Sense] è½®å›å®Œæˆã€‚ä¸‹ä¸€è½®é”å®šåœ¨: ${new Date(newNextRun).toLocaleTimeString()}`);
    } else {
        const remaining = Math.round((nextRun - now) / 1000);
        console.log(`[Sense] ç¨³å®šè¿æ¥ä¸­... è·ç¦»ä¸‹æ¬¡æ„Ÿåº”è¿˜éœ€: ${remaining} ç§’`);
    }
}

// ==========================================
// 2. æ ¸å¿ƒï¼šç‰©ç†ç‚¹ç«å¼€å…³ (æ‹§é’¥åŒ™)
// ==========================================
function startPerceptionEngine() {
    console.log("%c[System] æ„ŸçŸ¥å¼•æ“å·²è¿›å…¥ç‰©ç†ç‚¹ç«ç¨‹åº...", "color: #34C759; font-weight: bold;");

    // 1. ç«‹å³å°è¯•è·‘ä¸€æ¬¡
    checkAndExecuteSenseLoop();

    // 2. å¼ºåŠ›æ¸…é™¤æ—§çš„è®¡æ—¶å™¨ï¼Œé˜²æ­¢å åŠ  Bug
    if (window.senseTimer) clearInterval(window.senseTimer);

    // 3. å¼€å¯ 5 ç§’ä¸€æ¬¡çš„è¶…ç¨³å¿ƒè·³
    window.senseTimer = setInterval(function() {
        checkAndExecuteSenseLoop();
    }, 5000); 
}

// ==========================================
// 3. ğŸš¨ å¼ºåˆ¶æ‰§è¡Œï¼šæ— è®ºå¦‚ä½•éƒ½è¦è·‘èµ·æ¥
// ==========================================
// è¿™ä¸€æ­¥æœ€å…³é”®ï¼å¦‚æœä¹‹å‰æ²¡ååº”ï¼Œå°±æ˜¯ç¼ºäº†è¿™å‡ è¡Œ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startPerceptionEngine);
} else {
    startPerceptionEngine();
}

function applyRegionBackground(cityName) {
    const elCard = document.getElementById('region-vibe-card');
    if (!elCard || !window.CITY_VIBE_DB) return;

    // è·å–æ•°æ®ï¼Œå½»åº•ä¸å†è¯»å– .img å±æ€§
    const data = window.CITY_VIBE_DB[cityName] || window.CITY_VIBE_DB["default"];
    
    // ğŸš¨ ç‰©ç†æ¸…é™¤ï¼šå…ˆå¼ºåˆ¶æŠŠ backgroundImage è®¾ä¸º noneï¼Œæ–­æ‰ 404 è¯·æ±‚
    elCard.style.backgroundImage = 'none'; 
    
    // ğŸš¨ å¼ºåŠ›æ³¨å…¥ï¼šä½¿ç”¨ cssBg å¡«å……
    // ä½¿ç”¨ setProperty æé«˜ä¼˜å…ˆçº§ï¼Œè®©å®ƒåœ¨ç‚¹å‡»ç¬é—´ç”Ÿæ•ˆ
    elCard.style.setProperty('background', data.cssBg, 'important');
    
    console.log(`[UI] æˆåŠŸç‰©ç†æ¸²æŸ“ ${cityName} çš„ä»£ç èƒŒæ™¯ï¼Œå·²é˜»æ–­å›¾ç‰‡è¯·æ±‚ã€‚`);
}
// 2. ã€åŠŸèƒ½ã€‘æ‰“å¼€åœ°åŒºæ„ŸçŸ¥é¡µå¹¶åˆ·æ–°å¡ç‰‡
function openRegionPerception() {
    const cityName = localStorage.getItem('user_city_name') || "Beijing";
    const contact = window.currentChattingWith || { name: "Ta", id: "global" };
    
    // ğŸš¨ ç¬¬ä¸€æ­¥ï¼šè‚‰ä½“ç½®æ¢ï¼Œå¼ºè¡Œæ”¹èƒŒæ™¯ï¼ˆä¸å†ç­‰å¾…ä»»ä½•é€»è¾‘ï¼‰
    const card = document.getElementById('region-vibe-card');
    if (card && window.CITY_VIBE_DB) {
        const cityData = window.CITY_VIBE_DB[cityName] || window.CITY_VIBE_DB["default"];
        card.style.backgroundImage = 'none'; // æ€æ‰ undefined è¯·æ±‚
        card.style.setProperty('background', cityData.cssBg, 'important');
    }

    // ç¬¬äºŒæ­¥ï¼šåŒæ­¥æ–‡å­—
    const elCityDisplay = document.getElementById('mag-city-display');
    const elVibeDisplay = document.getElementById('mag-vibe-display');
    if (elCityDisplay) elCityDisplay.textContent = cityName;

    // ç¬¬ä¸‰æ­¥ï¼šå¤„ç†å†…å®¹
    const cache = localStorage.getItem(`vibe_cache_${contact.id}_${cityName}`);
    if (cache && elVibeDisplay) {
        elVibeDisplay.textContent = cache;
    } else {
        generateRegionVibe(cityName);
    }

    // æ¨å…¥é¡µé¢
    openSubPage('subpage-region-perceive');
}

// 3. ã€åŠŸèƒ½ã€‘åˆ‡æ¢æ„ŸçŸ¥å¼€å…³
function toggleRegionSync() {
    const toggle = document.getElementById('sync-region-toggle');
    if (toggle) {
        const isChecked = toggle.checked;
        localStorage.setItem('region_sync_enabled', isChecked);
        if (window.triggerSuccessHud) {
            window.triggerSuccessHud(isChecked ? "åŸå¸‚è®°å¿†å·²å¼€å¯" : "åŸå¸‚è®°å¿†å·²éšè—");
        }
    }
}

function closeSubPage(id) {
    const el = document.getElementById(id);
    if (el) {
        el.classList.remove('active');
        // åŠ¨ç”»ç»“æŸåéšè—ï¼ŒèŠ‚çœæ€§èƒ½
        setTimeout(function() {
            el.style.display = 'none';
        }, 400);
    }
}
// --- ğŸš¨ åŸå¸‚æ„å¢ƒç”Ÿæˆå™¨ ---
// --- ğŸš¨ ç»ˆæä¿®å¤ï¼šAI æ„å¢ƒç”Ÿæˆå™¨ (å½»åº•åˆ‡æ–­å›¾ç‰‡è¯·æ±‚) ---
async function generateRegionVibe(targetCity) {
    const contact = window.currentChattingWith || { name: "Ta" };
    const cityName = targetCity || localStorage.getItem('user_city_name') || "Beijing";
    
    // 1. å¼€å¯åŠ è½½å±‚
    const loader = document.getElementById('region-loading');
    if (loader) loader.style.display = 'flex';

    // 2. å‡†å¤‡ Prompt (åŠ ä¸Šé˜²æ­¢é‡å¤çš„éšæœºç§å­)
    const prompt = `ä½ æ­£åœ¨æ‰®æ¼”: ${contact.name}ã€‚ç”¨æˆ·ç°åœ¨ä½äº: ${cityName}ã€‚
    è¯·é’ˆå¯¹â€œ${cityName}â€å†™ä¸€æ®µæš§æ˜§ä¸”æœ‰æ–‡å­¦ç ´ç¢æ„Ÿçš„ä½è¯­ã€‚
    å¿…é¡»åŒ…å«è¯¥åŸå¸‚çš„ç‰¹è‰²æ„è±¡ï¼Œç¦æ­¢æåˆ°å…¶ä»–åŸå¸‚ï¼Œ30-50å­—ï¼Œç›´æ¥è¾“å‡ºã€‚`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.95
            })
        });

        const data = await res.json();
        const content = data.choices[0].message.content.trim();

        // 3. æ¸²æŸ“æ–‡å­—
        const vibeEl = document.getElementById('mag-vibe-display');
        if (vibeEl) vibeEl.textContent = content;

        // ğŸš¨ 4. å…³é”®ä¿®æ­£ï¼šè¿™é‡Œåªæ›´æ–°èƒŒæ™¯ä»£ç ï¼Œç»ä¸è¯»å– .img ğŸš¨
        const card = document.getElementById('region-vibe-card');
        if (card && window.CITY_VIBE_DB) {
            const cityData = window.CITY_VIBE_DB[cityName] || window.CITY_VIBE_DB["default"];
            
            // ç‰©ç†é˜»æ–­å›¾ç‰‡è¯·æ±‚
            card.style.backgroundImage = 'none'; 
            // ç‰©ç†å¼ºåˆ¶æ³¨å…¥ CSS æ¸å˜
            card.style.setProperty('background', cityData.cssBg, 'important');
        }

        // 5. å­˜å…¥ç¼“å­˜
        localStorage.setItem(`vibe_cache_${contact.id}_${cityName}`, content);

    } catch (e) {
        console.error("AI è¿™é‡Œçš„æŠ¥é”™å·²æ‹¦æˆª:", e);
    } finally {
        if (loader) loader.style.display = 'none';
    }
}

// å¿«é€Ÿåˆ‡æ¢åŸå¸‚å‡½æ•°
function quickSwitchCity(lat, lon, name) {
    // 1. ç¬é—´å­˜æ¡£
    localStorage.setItem('user_city_name', name);
    
    // 2. ç‰©ç†æ”¹èƒŒæ™¯
    applyRegionBackground(name);

    // 3. ç‰©ç†æ”¹ UI æ–‡å­—
    const elCityDisplay = document.getElementById('mag-city-display');
    if (elCityDisplay) elCityDisplay.textContent = name;

    // --- ğŸš‘ æ–°å¢ï¼šç«‹åˆ»å¼ºåˆ¶æ›´æ–°è®¾ç½®é¡µé‡Œçš„â€œåœ°åŒºæ„ŸçŸ¥â€æ–‡å­— ---
    const regionStatusEl = document.getElementById('val-region-text');
    if (regionStatusEl) regionStatusEl.textContent = name;

    const regionCityEl = document.getElementById('val-region-city');
    if (regionCityEl) regionCityEl.textContent = name;
    // --------------------------------------------------

    // 4. æ‰§è¡ŒåŸæœ¬çš„å¤©æ°”åŒæ­¥å’Œ AI ç”Ÿæˆ
    if (typeof fetchW === 'function') fetchW(lat, lon, name);
    generateRegionVibe(name);
    
    showToast(`ğŸ“ å·²é©»ç•™: ${name}`);
}

// æ‰‹åŠ¨åˆ·æ–°å¡ç‰‡è¯è¯­
function regenerateRegionVibe() {
    const cityName = localStorage.getItem('user_city_name') || "Beijing";
    showToast("æ­£åœ¨é‡å¡‘æ—¶ç©ºæ„Ÿåº”...");
    // å¼ºåˆ¶ä¼ å‚ï¼Œåˆ·æ–°å½“å‰åŸå¸‚çš„å†…å®¹
    generateRegionVibe(cityName);
}
// --- ğŸŒ å¤šè¯­è¨€ç¿»è¯‘åè®®å¼•æ“ ---

// 1. åˆå§‹åŒ–åŠ è½½é…ç½®
function initLanguageConfig() {
    window.langConfig = JSON.parse(localStorage.getItem('ios_lang_config')) || {
        enabled: false,
        target: "Thai",
        label: "æ³°è¯­ (Thai)"
    };
    
    if (document.getElementById('lang-sync-toggle')) 
        document.getElementById('lang-sync-toggle').checked = window.langConfig.enabled;
    if (document.getElementById('val-target-lang')) 
        document.getElementById('val-target-lang').textContent = window.langConfig.label;
    
    updateLangPreview();
}

// 2. æ ¸å¿ƒï¼šç¿»è¯‘åˆ‡æ¢ï¼ˆè§£å†³èœå•å†²çªçš„å…³é”®ï¼‰
function toggleTranslation(btn, e) {
    // ğŸš¨ ç»æ‹›ï¼šé˜»æ­¢å†’æ³¡ï¼è¿™è¡Œèƒ½ä¿è¯ç‚¹ç¿»è¯‘æŒ‰é’®æ—¶ï¼Œæ°”æ³¡çš„é•¿æŒ‰èœå•/ç‚¹å‡»èœå•ç»å¯¹ä¸ä¼šè·³å‡ºæ¥
    if (e) e.stopPropagation();
    
    const bubble = btn.closest('.bubble');
    if (bubble) {
        bubble.classList.toggle('show-trans');
        // å¢åŠ ä¸€ç‚¹éœ‡åŠ¨åé¦ˆï¼Œæ›´æœ‰ iOS æ‰‹æ„Ÿ
        if (window.navigator.vibrate) window.navigator.vibrate(10);
    }
}

// 3. æ‰“å¼€è¯­è¨€é€‰æ‹©å™¨ (Action Sheet)
function openLangPicker() {
    const list = document.getElementById('model-sheet-list');
    const sheet = document.getElementById('modelPickerSheet');
    const titleBox = document.querySelector('.sheet-title-box');

    if (!list || !sheet || !titleBox) return;

    // æ³¨å…¥æœç´¢æ¡†å’Œåˆ‡æ¢å™¨
    titleBox.innerHTML = `
        <div style="padding: 10px 0;">
            <div class="segment-control" style="margin-bottom: 15px;">
                <div class="segment-btn active" id="lang-tab-common" onclick="window.filterLangs('common')">å¸¸ç”¨</div>
                <div class="segment-btn" id="lang-tab-all" onclick="window.filterLangs('all')">å…¨éƒ¨</div>
            </div>
            <div class="ios-search-wrapper">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="3" style="margin-right: 8px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="lang-search-in" placeholder="æœç´¢è¯­ç§..." style="border:none; background:transparent; outline:none; font-size:14px; flex:1; color:#000;" oninput="window.filterLangs()">
            </div>
        </div>
    `;

    // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šä½¿ç”¨å…¨å±€å¸¸é‡ GLOBAL_LANG_DB è¿›è¡Œè¿‡æ»¤
    window.filterLangs = function(tabMode) {
        const searchInput = document.getElementById('lang-search-in');
        const searchVal = searchInput ? searchInput.value.toLowerCase() : "";
        
        const commonBtn = document.getElementById('lang-tab-common');
        const allBtn = document.getElementById('lang-tab-all');
        
        if (tabMode) {
            commonBtn.classList.toggle('active', tabMode === 'common');
            allBtn.classList.toggle('active', tabMode === 'all');
        }

        const activeTab = commonBtn.classList.contains('active') ? 'common' : 'all';

        // è¿™é‡Œçš„ GLOBAL_LANG_DB å·²ç»åœ¨å…¨å±€å®šä¹‰äº†ï¼Œä¸ä¼šå†æŠ¥é”™
        const filtered = GLOBAL_LANG_DB.filter(lang => {
            const matchesSearch = lang.l.toLowerCase().includes(searchVal) || lang.n.toLowerCase().includes(searchVal);
            const matchesTab = (activeTab === 'all') || (lang.cat === 'common');
            return matchesSearch && matchesTab;
        });

        list.innerHTML = filtered.map(lang => `
            <div class="sheet-item" onclick="selectLang('${lang.n}', '${lang.l}')">${lang.l}</div>
        `).join('') || `<div style="padding:40px; text-align:center; color:#999; font-size:13px;">æœªæ‰¾åˆ°åŒ¹é…è¯­ç§</div>`;
    };

    sheet.style.display = 'flex';
    window.filterLangs('common');
}

// 4. é€‰å®šè¯­è¨€
function selectLang(name, label) {
    window.langConfig.target = name;
    window.langConfig.label = label;
    
    const labelEl = document.getElementById('val-target-lang');
    if (labelEl) labelEl.textContent = label;
    
    document.getElementById('modelPickerSheet').style.display = 'none';
    updateLangPreview();
}

// 5. ä¿å­˜è®¾ç½®å¹¶æ³¨å…¥å†…æ ¸
function saveLanguageSettings() {
    window.langConfig.enabled = document.getElementById('lang-sync-toggle').checked;
    localStorage.setItem('ios_lang_config', JSON.stringify(window.langConfig));
    
    if (window.triggerSuccessHud) {
        triggerSuccessHud("ç¿»è¯‘åè®®å·²æ¿€æ´»");
    } else {
        showToast("è¯­è¨€è®¾ç½®å·²ä¿å­˜");
    }
    
    closeSubPage('subpage-language-settings');
}

// 6. æ›´æ–°é¢„è§ˆæ°”æ³¡æ•ˆæœ
function updateLangPreview() {
    const isEnabled = document.getElementById('lang-sync-toggle')?.checked;
    const bubble = document.getElementById('sample-bubble');
    const targetLang = window.langConfig.label;
    
    if (bubble) {
        bubble.style.display = isEnabled ? 'block' : 'none';
        // åŠ¨æ€ä¿®æ”¹é¢„è§ˆæ–‡å­—
        const mainText = bubble.querySelector('.msg-text-main');
        mainText.textContent = `[System] AI æ­£åœ¨å°è¯•ä½¿ç”¨ ${targetLang} ä¸ä½ å…±é¸£...`;
    }
}
// ==========================================
// ğŸ¨ ä¸»é¢˜å•†åº—æ ¸å¿ƒå¼•æ“ï¼šå…·åå‡½æ•°é‡æ„ç‰ˆ
// ==========================================

/**
 * ğŸ› ï¸ é€»è¾‘ A: åˆå§‹åŒ–æ³¨å…¥æ ‡ç­¾
 * ç¡®ä¿é¡µé¢å¤´éƒ¨æœ‰ä¸€ä¸ªä¸“é—¨æ¥æ”¶åŠ¨æ€ CSS çš„â€œå‘ä½â€
 */
function initThemeEngine() {
    if (!document.getElementById('theme-runtime-style')) {
        const style = document.createElement('style');
        style.id = 'theme-runtime-style';
        document.head.appendChild(style);
        console.log("System: ä¸»é¢˜æ³¨å…¥å¼•æ“å·²å°±ç»ª");
    }
}

/**
 * ğŸ› ï¸ é€»è¾‘ä¿®æ­£ï¼šå®æ—¶é¢„è§ˆå¼•æ“
 */
function livePreviewTheme(cssCode) {
    const runtime = document.getElementById('theme-runtime-style');
    if (!runtime) return;
    // å¢å¼ºæ˜ å°„ï¼Œç¡®ä¿å¤æ‚çš„èƒŒæ™¯å›¾åƒå’Œä¼ªå…ƒç´ ä¹Ÿèƒ½æ­£ç¡®åº”ç”¨åˆ°é¢„è§ˆå±‚
    let previewStyles = cssCode
        .replace(/#page-chat-room/g, '#theme-preview-window .actual-mirror-layer')
        .replace(/\.chat-room-header/g, '#theme-preview-window .chat-room-header')
        .replace(/\.chat-room-footer/g, '#theme-preview-window .chat-room-footer')
        .replace(/\.status-bar/g, '#theme-preview-window .status-bar')
        .replace(/\.header-glass-btn/g, '#theme-preview-window .header-glass-btn')
        .replace(/\.bubble/g, '#theme-preview-window .bubble')
        .replace(/\.msg-row/g, '#theme-preview-window .msg-row')
        .replace(/\.footer-add-btn/g, '#theme-preview-window .footer-add-btn')
        .replace(/\.action-btn/g, '#theme-preview-window .action-btn')
        .replace(/\.chat-room-input/g, '#theme-preview-window .chat-room-input');

    runtime.innerHTML = previewStyles;
}

/**
 * ğŸ› ï¸ é€»è¾‘ C: é€‰æ‹©å®˜æ–¹é¢„è®¾
 * @param {string} key - é¢„è®¾åº“çš„é”®å (å¦‚ 'dark')
 */
function selectPresetTheme(key) {
    const code = MASTER_LAYOUTS[key] || "";
    const editor = document.getElementById('theme-custom-code');
    if (editor) {
        editor.value = code.trim();
        livePreviewTheme(code);
    }
}
/**
 * ğŸ› ï¸ é€»è¾‘ D: åº”ç”¨æœ€ç»ˆæ ·å¼
 * ç‰©ç†åº”ç”¨åˆ°å…¨åŸŸå¹¶ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
 */
function applyFinalTheme() {
    const editor = document.getElementById('theme-custom-code');
    const cssCode = editor ? editor.value : "";
    localStorage.setItem('user_layout_css', cssCode);
    const runtime = document.getElementById('theme-runtime-style');
    if (runtime) {
        // ç‰©ç†åº”ç”¨åˆ°å…¨å±€ï¼Œå¹¶ç¡®ä¿ä¼˜å…ˆçº§
        runtime.innerHTML = cssCode;
        document.head.appendChild(runtime);
    }
    triggerSuccessHud("Winter Frost ä¸»é¢˜å·²åº”ç”¨ â„ï¸");
    if (typeof renderMessages === 'function') renderMessages();
    closeSubPage('subpage-theme-store');
}

/**
 * ğŸ› ï¸ é€»è¾‘ E: é‡ç½®ä¸»é¢˜
 * æ“¦é™¤æ‰€æœ‰è‡ªå®šä¹‰ä»£ç ï¼Œå›å½’åŸç”Ÿå¸ƒå±€
 */
function resetTheme() {
    const editor = document.getElementById('theme-custom-code');
    const runtime = document.getElementById('theme-runtime-style');

    if (editor) editor.value = "";
    if (runtime) runtime.innerHTML = "";
    
    localStorage.removeItem('user_layout_css');
    showToast("å·²å›å½’ç³»ç»ŸåŸç”Ÿå¸ƒå±€");
}

/**
 * ğŸ› ï¸ é€»è¾‘ F: ä¸»é¢˜å•†åº—åˆå§‹åŒ–
 * å½“ç‚¹å‡»è®¾ç½®å…¥å£è¿›å…¥æ—¶ï¼Œè´Ÿè´£åŒæ­¥å½“å‰çš„ CSS ä»£ç åˆ°é¢„è§ˆåŒº
 */
function initThemeStore() {
    const saved = localStorage.getItem('user_layout_css');
    if (saved) {
        const editor = document.getElementById('theme-custom-code');
        if (editor) editor.value = saved;
        livePreviewTheme(saved);
    }
}

/**
 * ğŸ› ï¸ é€»è¾‘ä¿®æ­£ï¼šç³»ç»Ÿå¯åŠ¨ç‚¹ç«
 */
function bootThemeEngine() {
    initThemeEngine(); // åˆ›å»ºå‘ä½
    const saved = localStorage.getItem('user_layout_css');
    if (saved) {
        const runtime = document.getElementById('theme-runtime-style');
        if (runtime) {
            runtime.innerHTML = saved;
            // ğŸš¨ æ ¸å¿ƒï¼šç‰©ç†ç½®åº•ï¼Œç¡®ä¿å®ƒæ˜¯æœ€åä¸€ä¸ªåŠ è½½çš„æ ·å¼
            document.head.appendChild(runtime);
        }
    }
}
// --- âš¡ ç‰©ç†çº§ï¼šå•æ¡æ¶ˆæ¯é”€æ¯å¼•æ“ ---
async function deleteSingleMessageReal(contactId, timestamp) {
    try {
        const db = await openDB();
        const tx = db.transaction("chat_history", "readwrite");
        const store = tx.objectStore("chat_history");
        
        // 1. ä»æ•°æ®åº“æå‡ºè¿™ä¸¤äººæ‰€æœ‰çš„èŠå¤©è®°å½•
        const req = store.get(contactId);
        
        req.onsuccess = async () => {
            const data = req.result;
            if (!data || !data.messages) return;

            // 2. æ ¸å¿ƒï¼šè¿‡æ»¤æ‰æ—¶é—´æˆ³å»åˆçš„é‚£ä¸€æ¡
            const originalLength = data.messages.length;
            const updatedMessages = data.messages.filter(m => m.timestamp.toString() !== timestamp.toString());

            if (updatedMessages.length < originalLength) {
                // 3. æŠŠå‰”é™¤åçš„æ–°æ•°ç»„å¡å›æ•°æ®åº“ï¼Œè¦†ç›–æ‰æ—§çš„
                await store.put({ contactId: contactId, messages: updatedMessages });
                
                // 4. ç«‹å³åŒæ­¥ UI
                showToast("æ¶ˆæ¯å·²ä»å› æœå¾‹ä¸­æŠ¹é™¤");
                renderMessages(); // é‡æ–°æ¸²æŸ“å½“å‰èŠå¤©çª—å£
                
                // 5. é‡è¦ï¼šåŒæ­¥åˆ·æ–°â€œæ¶ˆæ¯åˆ—è¡¨â€çš„é¢„è§ˆæ–‡å­—ï¼Œé˜²æ­¢åˆ äº†æœ€åä¸€æ¡é¢„è§ˆè¿˜æ²¡å˜
                if (typeof initChatMsgPanel === 'function') {
                    initChatMsgPanel();
                }
            }
        };
    } catch (e) {
        console.error("åˆ é™¤å¤±è´¥:", e);
        showToast("é‡å­æŠ¹é™¤å¼‚å¸¸");
    }
}
// --- ğŸ•’ æ ¸å¿ƒå¯¹æ—¶å¼•æ“ï¼šæ”¯æŒå…¨æ—¶åŒº + è‹±æ–‡æ ¼å¼ ---
function formatChatTime(ts, isFull = false) {
    const userTz = localStorage.getItem('user_timezone') || undefined;
    const date = new Date(ts);
    
    const options = isFull ? {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: true,
        timeZone: userTz
    } : {
        hour: '2-digit', minute: '2-digit', hour12: true,
        timeZone: userTz
    };

    try {
        let str = date.toLocaleString('en-US', options).replace(/\//g, '-');
        return str.replace(',', '');
    } catch (e) {
        // æŠ¥é”™å…œåº•
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}
// ==========================================
// ğŸ›ï¸ å®¿å‘½å¼•æ“ï¼šæ•°æ®æŠ“å–ä¸å®æ—¶è®¡ç®—
// ==========================================
// --- ğŸ›ï¸ ä¿®æ”¹ openDestinyPage å‡½æ•° ---
async function openDestinyPage() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const charList = await loadFromDB('char_list') || [];
    const latest = charList.find(c => c.id === contact.id) || contact;

    // --- åŸæœ‰çš„ç‰©ç†æ¸²æŸ“é€»è¾‘ ---
    document.getElementById('sync-char-name').innerText = latest.name;
    document.getElementById('fate-hero-img').style.backgroundImage = `url(${latest.avatar})`;
    
    // --- ğŸš¨ æ–°å¢ï¼šè®¡ç®—å¤©æ•° ---
    const createdTs = latest.createdAt || Date.now();
    const diffDays = Math.ceil(Math.abs(Date.now() - createdTs) / (1000 * 60 * 60 * 24));
    document.getElementById('fate-days').innerText = (diffDays <= 1 ? "1st" : diffDays) + " Day";

    // ğŸš¨ æ ¸å¿ƒï¼šè½½å…¥æ‰€æœ‰å†å²å­˜ç›˜
    await loadDestinyHistory(contact.id);

    document.getElementById('destiny-overlay').classList.add('active');

    // --- ğŸš¨ æ ¸å¿ƒæ”¹åŠ¨ï¼šå¯åŠ¨ AI æ–‡æ¡ˆå¼•æ“ ---
    generateDestinyProse(latest); 

    document.getElementById('destiny-overlay').style.display = 'flex';

    // ä¿®æ”¹ openDestinyPageï¼Œåœ¨æœ€åé¢åŠ å…¥è¿™æ®µ
    const savedStories = await loadFromDB('destiny_stories_' + contact.id) || [];
    const flow = document.getElementById('destiny-story-flow');
    if (savedStories.length > 0) {
        // æ¸²æŸ“ä¹‹å‰å­˜è¿‡çš„æ‰€æœ‰å¡ç‰‡
        savedStories.forEach(html => {
            flow.insertAdjacentHTML('beforeend', html);
        });
    }
}
// ==========================================
// ğŸ§  å®¿å‘½æ–‡æ¡ˆç¼–ç»‡å¼•æ“ (AI åŠ¨æ€ç”Ÿæˆç‰ˆ)
// ==========================================
async function generateDestinyProse(charData) {
    const bioEl = document.getElementById('sync-prose-bio');
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

    // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜ï¼Œå¦‚æœæœ‰åˆ™å…ˆæ˜¾ç¤ºç¼“å­˜ï¼Œä¸æ€¥ç€è°ƒ API
    if (charData.cachedDestinyProse) {
        bioEl.innerText = charData.cachedDestinyProse;
    } else {
        bioEl.innerText = "æ­£åœ¨æ„Ÿåº”æ—¶ç©ºç•™ç™½...";
    }

    if (!apiKey) return;

    // 2. è·å–â€œæœ¬æˆ‘â€èº«ä»½æ•°æ®
    const myPersona = JSON.parse(localStorage.getItem('user_persona_for_' + charData.id)) || 
                      JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                      { name: "æˆ‘", bio: "ä¸€ä¸ªè·¨è¶Šæ—¶ç©ºè€Œæ¥çš„è§‚å¯Ÿè€…" };

    // 3. æ„å»ºæ·±åº¦å®¿å‘½æ„Ÿ Prompt
    const prompt = `ä½ æ˜¯ä¸€ä½æ“…é•¿æå†™å®¿å‘½æ„Ÿå’Œç ´ç¢æ„Ÿçš„æ–‡å­¦å®¶ã€‚è¯·ä¸ºä¸¤ä¸ªè§’è‰²å†™ä¸€æ®µæå…·è‰ºæœ¯ç¾æ„Ÿçš„å†…å¿ƒç‹¬ç™½æˆ–å‘½è¿æ‰¹æ³¨ã€‚
    
    è§’è‰² A (Ta): ${charData.name}ã€‚èº«ä»½èƒŒæ™¯: ${charData.desc}
    è§’è‰² B (ç”¨æˆ·): ${myPersona.name}ã€‚èº«ä»½èƒŒæ™¯: ${myPersona.bio}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. é£æ ¼ï¼šå‚è€ƒç‹å®¶å«ç”µå½±æˆ–æ„è¯†æµæ–‡å­¦ï¼Œå¸¦æœ‰æµ“åšçš„å¯‚å¯ã€é”™è¿‡ã€å®ˆæŠ¤æˆ–æ³¨å®šçš„ç¾æ„Ÿã€‚
    2. é•¿åº¦ï¼š50å­—ä¹‹å†…ã€‚
    3. ä¸¥ç¦ä½¿ç”¨ Emojiã€‚
    4. ğŸš¨ é‡ç‚¹ï¼šè¦ä½“ç°å‡ºã€${charData.name}ã€‘ä¸ã€${myPersona.name}ã€‘ä¹‹é—´ç‹¬ç‰¹çš„ç¾ç»Šæ„Ÿã€‚
    5. ç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€ã€‚`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const result = data.choices[0].message.content.trim();

        // 4. æ›´æ–° UI å¹¶å­˜å…¥æ•°æ®åº“ï¼Œé˜²æ­¢é‡å¤æ¶ˆè€— Token
        bioEl.innerText = result;
        
        let charList = await loadFromDB('char_list') || [];
        const idx = charList.findIndex(c => c.id === charData.id);
        if (idx !== -1) {
            charList[idx].cachedDestinyProse = result; // ç‰©ç†å­˜å‚¨è¿™æ®µæ–‡æ¡ˆ
            await saveToDB('char_list', charList);
        }

    } catch (e) {
        console.error("Prose Generation Failed:", e);
        if (!charData.cachedDestinyProse) bioEl.innerText = "â€œæ—¶ç©ºå·²å¤±å»ç§©åºï¼Œç›´åˆ°ä½ çš„å‡ºç°ã€‚â€";
    }
}
// --- ğŸš‘ ç‰©ç†ä¿®å¤ï¼šè§†é¢‘åŠ è½½å®‰å…¨é” ---
async function safePlayVideo(videoEl, sourceData) {
    if (!videoEl || !sourceData) return;

    // 1. å…ˆç‰©ç†æ£€æŸ¥ï¼šæºæ•°æ®æ˜¯å¦åˆæ³•ï¼ˆæ˜¯ä¸æ˜¯ç©ºçš„ï¼Œæˆ–è€…æ˜¯ä¸æ˜¯ data:video å¼€å¤´ï¼‰
    if (sourceData.length < 10) {
        console.warn("System: è§†é¢‘æºæ•°æ®å¼‚å¸¸ï¼Œå·²æ‹¦æˆªæ’­æ”¾è¯·æ±‚ã€‚");
        return;
    }

    try {
        // 2. åªæœ‰åœ¨ src å˜åŒ–æ—¶æ‰é‡æ–°åŠ è½½ï¼Œé˜²æ­¢é‡å¤åŠ è½½æŠ¥é”™
        if (videoEl.src !== sourceData) {
            videoEl.src = sourceData;
            videoEl.load(); // ç‰©ç†é‡è½½
        }

        // 3. ğŸš¨ å…³é”®ï¼šå¤„ç†æµè§ˆå™¨æ’­æ”¾æ‰¿è¯º (Promise)
        // iOS æå…¶è®¨åŒæœªå‡†å¤‡å¥½çš„æ’­æ”¾è¯·æ±‚ï¼Œå¿…é¡» catch æ‰
        const playPromise = videoEl.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // è¿™é‡Œå°±æ˜¯æ‹¦æˆªä½ é‚£ä¸ªæŠ¥é”™çš„åœ°æ–¹ï¼
                console.log("ğŸ”’ æ•è·è§†é¢‘ç©ºè½¬å¼‚å¸¸:", error.message);
                // è‡ªåŠ¨é™çº§ï¼šå¦‚æœè§†é¢‘æ”¾ä¸å‡ºæ¥ï¼Œå¼ºåˆ¶æ˜¾ç¤ºèƒŒæ™¯è‰²æˆ–å›¾ç‰‡ï¼Œä¸è®©é¡µé¢å¡æ­»
            });
        }
    } catch (e) {
        console.error("Video Engine Crash:", e);
    }
}
/**
 * âš™ï¸ 1. å¼€å¯åè®®æ ¡å‡†é¢æ¿
 */
function openDestinySettings() {
    const contact = window.currentChattingWith;
    const modal = document.getElementById('modal-destiny-settings'); // ğŸš¨ æ£€æŸ¥ä½ çš„ HTML ID å¿…é¡»æ˜¯è¿™ä¸ª
    if (!contact || !modal) return;

    // è¯»å–é…ç½®ï¼Œé»˜è®¤ç»™ 500 å­—
    const config = JSON.parse(localStorage.getItem('destiny_config_' + contact.id)) || { style: "", plot: "", wordCount: 500 };
    
    // å›å¡«æ•°æ®
    if (document.getElementById('destiny-style-in')) document.getElementById('destiny-style-in').value = config.style || "";
    if (document.getElementById('destiny-plot-in')) document.getElementById('destiny-plot-in').value = config.plot || "";
    
    const wordSlider = document.getElementById('destiny-wordcount-in');
    if (wordSlider) {
        wordSlider.value = config.wordCount || 500;
        document.getElementById('destiny-word-val').innerText = wordSlider.value;
    }
    
    // å¼ºåˆ¶ç‰©ç†æ˜¾ç¤º
    modal.style.display = 'flex'; 
}

/**
 * âš™ï¸ 2. å…³é—­æ ¡å‡†é¢æ¿
 */
function closeDestinySettings() {
    const modal = document.getElementById('modal-destiny-settings');
    if (modal) modal.style.display = 'none';
}

/**
 * âš™ï¸ 3. ä¿å­˜å¹¶åŒæ­¥åè®®æ•°æ®
 */
function saveDestinyProtocol() {
    const contact = window.currentChattingWith;
    if (!contact) return;

    const style = document.getElementById('destiny-style-in').value.trim();
    const plot = document.getElementById('destiny-plot-in').value.trim();
    const wordCount = document.getElementById('destiny-wordcount-in').value;

    const config = { style, plot, wordCount };
    localStorage.setItem('destiny_config_' + contact.id, JSON.stringify(config));
    
    if (window.triggerSuccessHud) triggerSuccessHud("åè®®å·²é‡å¡‘");
    closeDestinySettings();
}

// --- ğŸ§  ç‰©ç†éš”ç¦»ï¼šå‰§æƒ…ä¸Šä¸‹æ–‡ç¼“å­˜ ---
window.destinyMemoryContext = []; 

/**
 * ğŸš¨ æ ¸å¿ƒç”Ÿæˆå¼•æ“ï¼šåŒæ­¥è®¾ç½®é¡µåè®® & æ‚å¿—æ’ç‰ˆ
 */
async function sendDestinyCommand(isFinal = false) {
    const input = document.getElementById('destiny-input-field');
    const flow = document.getElementById('destiny-story-flow');
    const contact = window.currentChattingWith;
    if (!contact) return;

    // ğŸš¨ ç‰©ç†ä¿®å¤ï¼šè·å–æœ€æ–°çš„ç”¨æˆ·æ•°æ® (è§£å†³ myData æœªå®šä¹‰æŠ¥é”™)
    const myKey = 'user_persona_for_' + contact.id;
    const myData = JSON.parse(localStorage.getItem(myKey)) || 
                   JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                   { name: "æˆ‘", bio: "" };

    // æ ¼å¼åŒ–è¾“å…¥å†…å®¹
    let userInput = isFinal ? "ï¼ˆè¿›å…¥å®¿å‘½ç»ˆå±€ï¼‰" : input.value.trim();
    if (!userInput && !isFinal) userInput = "(ç»§ç»­æ¨è¿›å‰§æƒ…)"; 
    if (!isFinal) input.value = "";

    // --- ğŸš¨ ç‰©ç†å­˜ç›˜ 1ï¼šä¿å­˜ç”¨æˆ·è¾“å…¥èŠ‚ç‚¹å¹¶æ¸²æŸ“ (ç¡®ä¿åˆ·æ–°ä¸æ¶ˆå¤±) ---
    const userNodeHtml = `
        <div class="destiny-user-node">
            <div class="node-label">OBSERVER INTERVENTION</div>
            <div class="node-content">â€œ${userInput}â€</div>
        </div>
    `;
    flow.insertAdjacentHTML('beforeend', userNodeHtml);
    // ç«‹å³å†™å…¥æ•°æ®åº“
    await saveDestinyNodeToDB(contact.id, { type: 'user', html: userNodeHtml });

    // æ’å…¥ç»‡ç½‘åŠ¨ç”»
    const weaveId = "weave-" + Date.now();
    flow.insertAdjacentHTML('beforeend', `
        <div id="${weaveId}" style="padding:40px 0; text-align:center;">
            <div class="quantum-loading-bar"></div>
            <div style="color:#AF52DE; font-size:10px; letter-spacing:4px; margin-top:20px; font-weight:900;">WEAVING THREADS...</div>
        </div>
    `);
    flow.scrollTop = flow.scrollHeight;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
        const config = JSON.parse(localStorage.getItem('destiny_config_' + contact.id)) || { style: "ç ´ç¢æ„Ÿ", wordCount: 500 };

        // ğŸ§  å†å²æ„ŸçŸ¥ï¼šæŠ“å–æœ€åä¸‰å¼ å¡ç‰‡ï¼Œä¿è¯é•¿ç¯‡æ•…äº‹çš„è¿è´¯æ€§
        const historyCards = Array.from(flow.querySelectorAll('.card-prose-body'));
        const pastStory = historyCards.slice(-3).map(c => c.innerText.substring(0, 500)).join('\n[ä¸Šç« å›é¡¾]\n');

        // æ„é€  System Promptï¼šå¼ºåˆ¶æ‰§è¡Œå§“åé”å®šå’Œæ ¼å¼åè®®
        const systemPrompt = `ä½ ç°åœ¨æ˜¯[é•¿ç¯‡å™äº‹ç¼–å‰§]ã€‚
ã€è§†è§’é”å®šã€‘ï¼šä¸¥ç¦ä½¿ç”¨â€œä½ â€ã€‚æè¿°ç”¨æˆ·å¿…é¡»ç”¨å§“åã€${myData.name}ã€‘ï¼Œæè¿°è§’è‰²å¿…é¡»ç”¨å§“åã€${contact.name}ã€‘ã€‚
ã€å‰æƒ…å›é¡¾ã€‘ï¼š${pastStory || "æ•…äº‹å¼€ç«¯ã€‚"}
ã€å½“å‰ç¥è°•ã€‘ï¼š${userInput}

ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘ï¼š
1. æ‰¿æ¥å‰æƒ…ï¼Œå­—æ•°ä¸¥æ ¼æŒ‰ç…§ ${config.wordCount} å­—å·¦å³ï¼Œå¿…é¡»å™è¿°å®Œæ•´ï¼Œä¸¥ç¦ä¸­é€”æˆªæ–­ã€‚
2. å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è¾“å‡ºæ ¼å¼ï¼š
   ã€ç« èŠ‚æ ‡é¢˜ã€‘æ­¤å¤„å†™æ ‡é¢˜
   ã€æ­£æ–‡ã€‘æ­¤å¤„å†™æ­£æ–‡å†…å®¹...å°†æ ¸å¿ƒè¯æ”¾å…¥ ã€ ã€‘ï¼Œç»†èŠ‚æ”¾å…¥ ã€Œ ã€ã€‚
   ã€å®Œç»“æ¦‚ç‡ã€‘æ•°å­—`;

        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `è¯·åŸºäºå‰æƒ…å’Œç¥è°•ï¼Œç»§ç»­ç¼–ç»‡ã€${myData.name}ã€‘ä¸ã€${contact.name}ã€‘çš„å› æœã€‚` }
                ],
                temperature: 0.95,
                max_tokens: 4000, // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šç¡®ä¿é•¿æ–‡æœ‰è¶³å¤Ÿç©ºé—´åå®Œï¼Œä¸å¡é¡¿
                presence_penalty: 0.6
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        
        const raw = data.choices[0].message.content;

        // ç§»é™¤åŠ¨ç”»
        if (document.getElementById(weaveId)) document.getElementById(weaveId).remove();

        // --- ğŸš¨ ç»ˆæè§£æé€»è¾‘ï¼šç‰©ç†åˆ‡å‰²æ³• (é˜²æ­¢æ­£æ–‡æ ‡è®°å¹²æ‰°) ---
        let title = "å› æœç¢ç‰‡";
        let content = "";
        let fate = "15";

        // æå–æ ‡é¢˜
        if (raw.includes("ã€ç« èŠ‚æ ‡é¢˜ã€‘")) {
            title = raw.split("ã€ç« èŠ‚æ ‡é¢˜ã€‘")[1].split("\n")[0].replace(/[:ï¼š]/g, "").trim();
        }

        // æå–æ­£æ–‡å’Œæ¦‚ç‡
        if (raw.includes("ã€æ­£æ–‡ã€‘")) {
            const tempBody = raw.split("ã€æ­£æ–‡ã€‘")[1];
            if (tempBody.includes("ã€å®Œç»“æ¦‚ç‡ã€‘")) {
                const parts = tempBody.split("ã€å®Œç»“æ¦‚ç‡ã€‘");
                content = parts[0].trim();
                fate = parts[1].match(/\d+/)?.[0] || "15";
            } else {
                // å¦‚æœ AI æ²¡å†™å®Œæ¦‚ç‡æ ‡è®°ï¼Œä¹Ÿä¿ç•™å…¨éƒ¨æ­£æ–‡
                content = tempBody.trim();
            }
        } else {
            content = raw; // æç«¯æƒ…å†µå…œåº•
        }

        // æ‰§è¡Œæ¸²æŸ“
        const id = "card-" + Date.now();
        renderStoryFoldCard(title, content, fate, isFinal, id);
        
        // --- ğŸš¨ ç‰©ç†å­˜ç›˜ 2ï¼šä¿å­˜ AI å¡ç‰‡æ•°æ®åˆ° IndexedDB ---
        await saveDestinyNodeToDB(contact.id, { 
            type: 'ai', 
            id: id, 
            title: title, 
            content: content, 
            fate: fate, 
            isFinal: isFinal 
        });

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        flow.scrollTo({ top: flow.scrollHeight, behavior: 'smooth' });

    } catch (e) {
        console.error("Destiny Error:", e);
        if (document.getElementById(weaveId)) {
            document.getElementById(weaveId).innerHTML = `<div style="color:#FF3B30; font-size:10px; letter-spacing:2px;">CONNECTION FAILED: ${e.message}</div>`;
        }
    }
}

/**
 * ğŸ¨ æ‚å¿—æ’ç‰ˆæ¸²æŸ“å¼•æ“
 */
function renderStoryFoldCard(title, content, fate, isFinal, id) {
    const flow = document.getElementById('destiny-story-flow');
    if (!flow || !content) return;

    // å¤„ç†æ­£æ–‡æ’ç‰ˆ
    const formattedBody = content
        .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
        .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>');
    const paragraphs = formattedBody.split(/\n+/).map(p => `<p>${p}</p>`).join('');

    const html = `
        <div id="${id}" class="story-fold-card">
            <div class="card-manager-btn" onclick="event.stopPropagation(); window.deleteFateNode('${id}')">Ã—</div>
            
            <div class="card-meta-top">
                <span>FRAGMENT // ${id.slice(-4)}</span>
                <span>CONVERGENCE: ${fate}%</span>
            </div>

            <div style="font-family:serif; font-style:italic; font-size:26px; color:#fff; margin-top:15px; margin-bottom:10px;">${title}</div>
            
            <div class="card-prose-body">${paragraphs}</div>

            <div class="card-actions">
                <div style="color:#AF52DE; font-weight:900; font-size:11px; cursor:pointer;" onclick="event.stopPropagation(); window.triggerSideStory('${id}')">âœ¦ å¼€æ‹“å°å‰§åœº</div>
                <div style="color:rgba(255,255,255,0.3); font-size:11px; cursor:pointer;" onclick="event.stopPropagation(); window.rewriteFateNode('${id}')">âŸ³ é‡å¡‘å› æœ</div>
            </div>
        </div>
    `;
    
    flow.insertAdjacentHTML('beforeend', html);
    setTimeout(() => { flow.scrollTop = flow.scrollHeight; }, 100);
}
function triggerFinalChapter() {
    const btn = document.getElementById('final-fate-trigger');
    if(btn) btn.remove(); // ç‚¹å®Œå°±æ¶ˆå¤±
    sendDestinyCommand(true); // è¿›å…¥çœŸÂ·å¤§ç»“å±€æ¨¡å¼
}



// ç‰©ç†æŒ‚è½½
window.sendDestinyCommand = sendDestinyCommand;

/**
 * ğŸ¬ æ ¸å¿ƒå‡½æ•°ï¼šç”Ÿæˆå°å‰§åœº (Side Story)
 * é€»è¾‘ï¼šåŸºäºå½“å‰ç« èŠ‚çš„æ®‹å½±ï¼Œç¼–ç»‡ä¸€æ®µç»†èŠ‚è¡¥å®Œæˆ–å¹³è¡Œè§†è§’çš„ä¾§å½±ã€‚
 */
/**
 * ğŸ¬ å®Œå–„ç‰ˆï¼šä¾§å½±å°å‰§åœºç”Ÿæˆå¼•æ“
 * é€»è¾‘ï¼šåŸºäºå½“å‰ç« èŠ‚çš„é‡å­æ®‹å½±ï¼Œç¼–ç»‡ä¸€æ®µæå…·å¼ åŠ›çš„ç»†èŠ‚è¡¥å®Œã€‚
 */
function triggerSideStory(baseCardId) {
    // 1. ç¯å¢ƒä¸é˜²æŠ–æ ¡éªŒ
    const parentCard = document.getElementById(baseCardId);
    if (!parentCard) return;

    // é˜²æ­¢åŒä¸€ä¸ªå¡ç‰‡ä¸‹åŒæ—¶å¼€å¯å¤šä¸ªç”Ÿæˆä»»åŠ¡
    if (parentCard.dataset.loading === "true") return;
    
    const contact = window.currentChattingWith;
    if (!contact) {
        showToast("âš ï¸ åè®®è¿æ¥æ–­å¼€");
        return;
    }

    // æå–å½“å‰å¡ç‰‡çš„æ­£æ–‡å†…å®¹ä½œä¸ºèƒŒæ™¯
    const proseBody = parentCard.querySelector('.card-prose-body');
    const baseText = proseBody ? proseBody.innerText : "";

    // 2. ç‰©ç†é”å®šï¼šå¯åŠ¨åŠ è½½åŠ¨æ•ˆ
    parentCard.dataset.loading = "true";
    const subWeavingId = "sub-weave-" + Date.now();
    const loadingHtml = `
        <div id="${subWeavingId}" class="destiny-entry" style="margin: -10px 20px 20px 40px; padding-left: 15px; border-left: 1.5px dashed #AF52DE;">
            <div class="weave-line" style="height: 1px; background: #AF52DE; box-shadow: 0 0 10px #AF52DE; animation: weaveScan 1.5s infinite;"></div>
            <div style="font-size: 9px; color: #AF52DE; letter-spacing: 2px; margin-top: 8px; font-weight: 800; animation: pulse 1s infinite;">
                SIDE THREAD WEAVING...
            </div>
        </div>
    `;
    parentCard.insertAdjacentHTML('afterend', loadingHtml);
    // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼šå°†å°å‰§åœºå¡ç‰‡å­˜å…¥æ•°æ®åº“
    saveDestinyNodeToDB(contact.id, { 
        type: 'side-story', 
        html: loadingHtml 
    });

    // 3. æ‰§è¡Œé‡å­ç¼–ç»‡é€»è¾‘
    (async () => {
        try {
            const apiKey = localStorage.getItem('gpt_key');
            const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
            
            // æŠ“å–è®¾ç½®é¡µé…ç½®ï¼šä¾§å½±é€šå¸¸æ›´çŸ­ä¿ƒæœ‰åŠ›ï¼Œé»˜è®¤å–ä¸»çº¿çš„ 60% å­—æ•°
            const config = JSON.parse(localStorage.getItem('destiny_config_' + contact.id)) || { style: "ç ´ç¢æ„Ÿ", wordCount: 500 };
            const sideWordCount = Math.max(250, Math.floor(config.wordCount * 0.5));

            const systemPrompt = `ä½ ç°åœ¨æ˜¯[ä¾§å½±è®°å½•è€…]ã€‚
            åˆšæ‰ä¸»çº¿å‰§æƒ…å‘ç”Ÿäº†è¿™ä¸€å¹•: "${baseText.substring(0, 300)}..."
            
            ã€å¼ºåˆ¶å™äº‹åè®®ã€‘ï¼š
            1. è§†è§’é”å®šï¼šå¿…é¡»ä½¿ç”¨ã€ç¬¬äºŒäººç§°(ä½ )ã€‘ç§°å‘¼ç”¨æˆ·ï¼Œä½¿ç”¨ã€${contact.name}ã€‘ç§°å‘¼è§’è‰²ã€‚
            2. ä¾§å½±å®šä½ï¼šä¸è¦é‡å¤ä¸»çº¿ï¼Œè€Œæ˜¯å»æŒ–æ˜é‚£ä¸€åˆ»è¢«å¿½ç•¥çš„ã€Œæ„Ÿå®˜ç»†èŠ‚ã€ã€ã€${contact.name}ã€‘éšç§˜çš„å¿ƒç†èµ·ä¼ï¼Œæˆ–æŸä¸ªå¹³è¡Œå‘ç”Ÿçš„å¾®å°åŠ¨ä½œã€‚
            3. æ–‡é£ï¼š${config.style || "æè‡´é«˜çº§æ„Ÿã€æ„è¯†æµ"}ã€‚
            4. ç¯‡å¹…ï¼šä¸¥æ ¼æ§åˆ¶åœ¨ ${sideWordCount} å­—å·¦å³ã€‚
            
            ã€æ’ç‰ˆåè®®ã€‘ï¼š
            - æ ¸å¿ƒè¯æ±‡åŒ…è£¹åœ¨ ã€ ã€‘ ä¸­ã€‚
            - æ„Ÿå®˜ç»†èŠ‚åŒ…è£¹åœ¨ ã€Œ ã€ ä¸­ã€‚
            
            æ ¼å¼è¾“å‡ºï¼šç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œç¦æ­¢ä»»ä½•å‰ç¼€æˆ–æ‹¬å·ã€‚`;

            const res = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: localStorage.getItem('gpt_model') || "gpt-4o", // ä¾§å½±éœ€è¦æ›´é«˜æ„Ÿæ€§çš„å‘æ•£
                    messages: [{ role: "system", content: systemPrompt }],
                    temperature: 0.95
                })
            });

            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            
            let sideProse = data.choices[0].message.content.trim();

            // 4. æ ·å¼è½¬æ¢å¼•æ“ï¼šåŒæ­¥æ‚å¿—æ ‡æ³¨æ•ˆæœ
            const processedSideProse = sideProse
                .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
                .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>');

            // ç§»é™¤åŠ è½½åŠ¨ç”»
            // --- æ‰¾åˆ° triggerSideStory æˆåŠŸè·å– sideProse åçš„ä½ç½® ---
            const loader = document.getElementById(subWeavingId);
            if (loader) loader.remove();
            parentCard.dataset.loading = "false";

            // ğŸš¨ æ ¸å¿ƒè¡¥ä¸ï¼šå®šä¹‰å°å‰§åœºçš„ HTML ç»“æ„æ¨¡æ¿
            const sideStoryHtml = `
                <div class="story-fold-card side-theatre-card" 
                    style="margin: -10px 20px 25px 40px; background: rgba(175, 82, 222, 0.05); border-left: 2px solid #AF52DE; animation: cardRise 0.6s ease;">
                    <div class="card-meta" style="margin-bottom: 10px;">
                        <span style="color: #AF52DE; font-weight: 900; letter-spacing: 1px;">âœ¦ SIDE THEATRE / ä¾§å½±å°å‰§åœº</span>
                    </div>
                    <div class="card-prose-body" style="font-size: 15px; line-height: 1.8; color: rgba(255,255,255,0.7);">
                        ${sideProse.replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>').replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>').split(/\n+/).map(p => `<p>${p}</p>`).join('')}
                    </div>
                </div>
            `;

            // æ¸²æŸ“åˆ°é¡µé¢
            parentCard.insertAdjacentHTML('afterend', sideStoryHtml);

            // ğŸš¨ æ ¸å¿ƒå­˜ç›˜ï¼šå­˜å…¥å†…å®¹(content)è€Œä¸æ˜¯æ•´ä¸ªHTMLï¼Œä¿è¯åˆ·æ–°åèƒ½é‡æ–°æ¸²æŸ“
            await saveDestinyNodeToDB(contact.id, { 
                type: 'side-story', 
                content: sideProse 
            });

        } catch (e) {
            const loader = document.getElementById(subWeavingId);
            if (loader) loader.innerHTML = `<span style="color:#FF3B30; font-size:9px;">THREAD SNAPPED: ${e.message}</span>`;
            parentCard.dataset.loading = "false";
            console.error("Side Story Error:", e);
        }
    })();
}
// ä¿å­˜èŠ‚ç‚¹ï¼ˆæ— è®ºæ˜¯ç”¨æˆ·å‘çš„è¿˜æ˜¯ AI å‘çš„ï¼‰
async function saveDestinyNodeToDB(contactId, node) {
    let history = await loadFromDB('destiny_history_' + contactId) || [];
    history.push(node);
    await saveToDB('destiny_history_' + contactId, history);
}

// ç‰©ç†åˆ·æ–°åçš„è‡ªæ„ˆåŠ è½½
async function loadDestinyHistory(contactId) {
    const flow = document.getElementById('destiny-story-flow');
    if (!flow) return;

    // 1. è·å–å†å²ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›
    const history = await loadFromDB('destiny_history_' + contactId) || [];
    
    // 2. æ¸…ç†èˆå°ï¼Œä¿ç•™åˆå§‹æç¤ºï¼ˆé‚£ä¸ª STORY THREAD INITIALIZEDï¼‰
    const initializedDiv = flow.querySelector('div[style*="letter-spacing:5px"]');
    flow.innerHTML = "";
    if (initializedDiv) flow.appendChild(initializedDiv);

    // 3. éå†å¹¶æ¢å¤èŠ‚ç‚¹
    history.forEach(node => {
        try {
            if (node.type === 'user') {
                // æ¢å¤ç¥è°•ï¼šç¡®ä¿ html å­—æ®µå­˜åœ¨
                if (node.html) flow.insertAdjacentHTML('beforeend', node.html);
            } 
            else if (node.type === 'ai') {
                // æ¢å¤ AI ç« èŠ‚ï¼šç¡®ä¿å†…å®¹ä¸ä¸ºç©º
                if (node.content) {
                    renderStoryFoldCard(node.title || "å› æœç¢ç‰‡", node.content, node.fate || "15", node.isFinal || false, node.id);
                }
            } 
            else if (node.type === 'side-story') {
                // ğŸš¨ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¢åŠ å±æ€§å­˜åœ¨åˆ¤å®šï¼Œé˜²æ­¢ replace æŠ¥é”™
                if (node.content && typeof node.content === 'string') {
                    const processedBody = node.content
                        .replace(/ã€(.*?)ã€‘/g, '<span class="memory-highlight">$1</span>')
                        .replace(/ã€Œ(.*?)ã€/g, '<span class="memory-focus">$1</span>')
                        .split(/\n+/).map(p => `<p>${p}</p>`).join('');
                        
                    const sideHtml = `
                        <div class="story-fold-card side-theatre-card" style="margin: -10px 20px 25px 40px; background: rgba(175, 82, 222, 0.05); border-left: 2px solid #AF52DE;">
                            <div class="card-meta" style="margin-bottom: 10px;"><span style="color:#AF52DE; font-weight:900;">âœ¦ SIDE THEATRE</span></div>
                            <div class="card-prose-body" style="font-size:15px; line-height:1.8; color:rgba(255,255,255,0.7);">${processedBody}</div>
                        </div>`;
                    flow.insertAdjacentHTML('beforeend', sideHtml);
                } else if (node.html) {
                    // å…œåº•é€»è¾‘ï¼šå¦‚æœæ—§æ•°æ®åªæœ‰ html å­—æ®µï¼Œå°±ç›´æ¥æ’ä»£ç ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
                    flow.insertAdjacentHTML('beforeend', node.html);
                }
            }
        } catch (err) {
            console.warn("è·³è¿‡äº†ä¸€æ¡æŸåçš„å› æœèŠ‚ç‚¹:", err);
        }
    });

    // 4. ä¿æŒæ»šåŠ¨æ¡åœ¨æœ€ä¸‹é¢
    flow.scrollTop = flow.scrollHeight;
}
// --- ğŸ§­ è¡Œæ—…è§é—»æ ¸å¿ƒé©±åŠ¨ ---
window.currentTravelData = [];

/**
 * ğŸ—ºï¸ èˆªçº¿æ˜ å°„æ ¸å¿ƒåè®® (Voyage Trajectory Protocol)
 * åŠŸèƒ½ï¼šç‰©ç†æ¸…ç†æ—§çŠ¶æ€ -> æˆ˜æœ¯æ‰«æ -> AI ç”Ÿæˆ -> åŠ¨æ€é‡ç»˜
 */
/**
 * ğŸ—ºï¸ èˆªçº¿æ˜ å°„æ ¸å¿ƒåè®® (50ç«™é«˜ç»´ç‰ˆ)
 * åŠŸèƒ½ï¼šä»æ»‘åŠ¨æ¡è¯»å–ç«™ç‚¹æ•° -> å¼ºåˆ¶ AI ç¼–ç»‡ç»†è…»è½¨è¿¹ -> ç‰©ç†é‡ç»˜å…¨æ™¯èˆªå›¾
 */
async function startTravelMapping() {
    // 1. ã€ç‰©ç†å®šä½ã€‘æŠ“å–è¾“å…¥ä¸ UI ç»„ä»¶
    const from = document.getElementById('travel-from').value.trim();
    const to = document.getElementById('travel-to').value.trim();
    
    // ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šä»æ–°çš„æ»‘åŠ¨æ¡ ID è¯»å–æ•°å€¼
    const stopsSlider = document.getElementById('travel-stops-slider');
    const stops = stopsSlider ? parseInt(stopsSlider.value) : 5; 

    const btn = document.querySelector('.noir-btn-main');
    const mapBox = document.getElementById('travel-map-box');
    const passContainer = document.getElementById('boarding-pass-container');
    const svgMap = document.getElementById('travel-svg-map');
    const dotsLayer = document.getElementById('travel-dots-layer');

    // 2. ã€å®‰å…¨æ ¡éªŒã€‘
    if (!from || !to) {
        showToast("ğŸ“ è¯·è¾“å…¥å‡ºå‘åœ°å’Œç›®çš„åœ°");
        return;
    }

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) {
        showIOSConfirm("ç§˜é’¥ç¼ºå¤±", "ç³»ç»Ÿæœªæ£€æµ‹åˆ° API Keyï¼Œæ˜¯å¦å‰å¾€é…ç½®ï¼Ÿ", "å»é…ç½®", () => {
            closeSubPage('subpage-travel-journal');
            openApp('settingsApp');
        });
        return;
    }

    // 3. ğŸš¨ ã€ç‰©ç†å½’é›¶ã€‘å½»åº•åˆ‡æ–­ä¸æ—§æ•°æ®çš„è”ç³»
    passContainer.innerHTML = ""; 
    if (svgMap) svgMap.innerHTML = ""; 
    if (dotsLayer) dotsLayer.innerHTML = ""; 
    
    const oldPath = document.querySelector('.travel-line');
    if (oldPath) oldPath.removeAttribute('data-finished');

    // 4. ã€è§†å›¾è½¬æ¢ã€‘è¿›å…¥æˆ˜æœ¯æ‰«æçŠ¶æ€
    document.getElementById('travel-planner').style.display = 'none';
    document.getElementById('travel-canvas-area').style.display = 'block';

    btn.classList.add('btn-loading');
    btn.innerHTML = "CALCULATING " + stops + " VECTORS...";
    
    let overlay = document.getElementById('map-loader-overlay');
    if(!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'map-loader-overlay';
        overlay.innerHTML = `
            <div class="radar-sweep"></div>
            <div class="loading-text">[ SYSTEM: DECODING ${stops} STATIONS ]</div>
        `;
        mapBox.appendChild(overlay);
    }
    overlay.style.display = 'flex';

    try {
        // 5. ã€é‡å­è¯·æ±‚ã€‘AI ç¼–ç»‡æŒ‡ä»¤å‡çº§
        // ğŸš¨ é’ˆå¯¹ 50 ä¸ªç‚¹ï¼Œæˆ‘ä»¬è¦æ±‚ AI å¿…é¡»æä¾›å®Œæ•´çš„ JSONï¼Œä¸”ä¸èƒ½çœç•¥ä¸­é—´ç‚¹
        const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å…¨çƒèˆªçº¿è§„åˆ’ä¸“å®¶ã€‚
        ä»»åŠ¡: è§„åˆ’ä¸€æ¡ä»[${from}]åˆ°[${to}]çš„æ¼«é•¿æ—…ç¨‹ã€‚
        ç«™ç‚¹è¦æ±‚: 
        1. å¿…é¡»ã€ç²¾ç¡®åŒ…å«ã€‘ ${stops} ä¸ªåœ°ç†ç«™ç‚¹ã€‚
        2. ç¬¬1ä¸ªç«™å¿…é¡»æ˜¯[${from}]ï¼Œæœ€å1ä¸ªç«™å¿…é¡»æ˜¯[${to}]ã€‚
        3. ä¸­é—´ ${stops - 2} ä¸ªç«™å¿…é¡»æ˜¯çœŸå®å­˜åœ¨çš„åŸå¸‚ï¼Œä¸”åœ°ç†è½¨è¿¹é€»è¾‘è¿è´¯ï¼ˆä¸è¦åœ¨åœ°çƒä¸¤å¤´ä¹±è·³ï¼‰ã€‚
        4. ä¸ºæ¯ä¸ªç«™ç‚¹æä¾›çœŸå®çš„æœºåœº IATA ä¸‰å­—ç å’Œç²¾ç¡®ç»çº¬åº¦ (lat, lng)ã€‚
        
        è¾“å‡ºåè®®: ä¸¥æ ¼ JSON æ•°ç»„æ ¼å¼ï¼Œç¦æ­¢ä»»ä½•è§£é‡Šæ€§æ–‡å­—ã€‚
        æ ¼å¼ç¤ºä¾‹: [{"name":"åŸå¸‚å","code":"IATA","lat":æ•°å­—,"lng":æ•°å­—}]`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${apiKey}` 
            },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: prompt }],
                temperature: 0.7,
                max_tokens: 4000 // ğŸš¨ ç‰©ç†è¡¥ä¸ï¼š50ä¸ªç‚¹çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¿…é¡»ç»™è¶³ Token ç©ºé—´
            })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const rawContent = data.choices[0].message.content;
        
        // ä½¿ç”¨æ­£åˆ™ç²¾å‡†æ•è· JSON æ•°ç»„
        const jsonMatch = rawContent.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI æ•°æ®ç¼–ç åè®®å¼‚å¸¸");
        
        const route = JSON.parse(jsonMatch[0]);
        window.currentTravelData = route;

        // 6. ã€æ¸²æŸ“åŒæ­¥ã€‘
        // ç‰©ç†å»¶è¿Ÿæ¨¡æ‹Ÿâ€œæ‰“å°æœºæ‰“å°æœºç¥¨â€çš„ Noir è´¨æ„Ÿ
        setTimeout(() => {
            renderBoardingPass(from, to, route[0].code, route[route.length-1].code);
        }, 300);

        // å¼ºåŠ›é‡ç»˜ 50 ä¸ªç«™ç‚¹çš„å¤æ‚èˆªå›¾
        renderTravelMap(route);

        // 7. ã€æ•°æ®å­˜ç›˜ã€‘
        await saveToDB('current_travel_route', route);
        
        // 8. å…³é—­æ‰«æç•Œé¢
        setTimeout(() => {
            if (overlay) overlay.style.display = 'none';
        }, 1000);

    } catch (e) {
        console.error("Trajectory Error:", e);
        showToast("âš ï¸ ç»´åº¦åç¼©: " + e.message);
        if (overlay) overlay.style.display = 'none';
        btn.innerHTML = "RETRY INTERVENTION";
    } finally {
        btn.classList.remove('btn-loading');
        if (btn.innerHTML !== "RETRY INTERVENTION") btn.innerHTML = "GENERATE TRAJECTORY";
    }
}

// --- ğŸ›« æ¸²æŸ“å¥¢å Noirï¼šå·¥ä¸šå®‰å…¨æ¡ç ç‰ˆ ---
function renderBoardingPass(from, to, fromCode, toCode) {
    const container = document.getElementById('boarding-pass-container');
    if (!container) return;

    // è·å– 2026 å¹´çš„å½“å‰æ—¥æœŸ
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
    const etktStr = `ETKT 176 ${Math.floor(Math.random()*10000000000)} 001`;

    // 1. ç‰©ç†æ„å»ºæœºç¥¨ HTML
    container.innerHTML = `
        <div class="boarding-pass">
            <div class="pass-header">
                <span>NOIR ALLIANCE // STRATEGIC VOYAGE</span>
                <span>FIRST CLASS</span>
            </div>

            <div class="pass-body">
                <div id="pass-stamp-logic" class="pass-stamp">
                    <strong>CLEARED</strong>
                    <span>${dateStr}</span>
                </div>

                <div class="flight-route">
                    <div class="city-group">
                        <div class="city-code">${fromCode || 'NAV'}</div>
                        <div class="city-name">${from}</div>
                    </div>
                    <div class="flight-icon-center">âœˆ</div>
                    <div class="city-group" style="text-align: right;">
                        <div class="city-code">${toCode || 'DEST'}</div>
                        <div class="city-name">${to}</div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Flight No.</span><span class="info-value">NK-2026</span></div>
                    <div class="info-item" style="text-align: right;"><span class="info-label">Seat</span><span class="info-value">01A</span></div>
                    <div class="info-item"><span class="info-label">Status</span><span class="info-value">AUTHENTICATED</span></div>
                    <div class="info-item" style="text-align: right;"><span class="info-label">Gate</span><span class="info-value">L-09</span></div>
                </div>
            </div>

            <div class="pass-footer">
                <div class="notch-left pass-notch"></div>
                <div class="notch-right pass-notch"></div>
                <div class="security-zone">
                    <span class="info-label">IATA SECURITY VALIDATION</span>
                    <div class="industrial-barcode"></div>
                    <div class="barcode-data"><span>${etktStr}</span><span>SECURED</span></div>
                </div>
            </div>
        </div>
    `;

    // 2. ğŸš¨ ç‰©ç†è§¦å‘ç›–ç« åŠ¨æ•ˆ ğŸš¨
    // å»¶è¿Ÿ 600msï¼Œç­‰å¾…æœºç¥¨å±•ç¤ºåŠ¨ç”»å®Œæˆåï¼Œå°ç« å†ç ¸ä¸‹æ¥
    setTimeout(() => {
        const stamp = document.getElementById('pass-stamp-logic');
        if (stamp) {
            stamp.classList.add('stamp-active');
            // ç‰©ç†å¢åŠ ä¸€ä¸ªæè½»å¾®çš„æ‰‹æœºéœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœç¡¬ä»¶æ”¯æŒï¼‰
            if (navigator.vibrate) navigator.vibrate(20);
        }
    }, 600);
}

// --- ğŸ—ºï¸ æ¸²æŸ“æˆ˜æœ¯ Noir èˆªå›¾ ---x

// --- ğŸ—ºï¸ ç‰©ç†é©±åŠ¨ï¼šå…¨åŠ¨æ€åæ ‡åŒæ­¥å¼•æ“ ---

// --- ğŸ§­ ç‰©ç†é”æ­»ï¼šå…¨åŠ¨æ€åœ°ç†é”šå®šå¼•æ“ ---
var travelMap = null; 

function renderTravelMap(route) {
    if (!route || !route.length) return;
    window.activeVoyageRoute = route; // ğŸš¨ ç‰©ç†æŒä¹…åŒ–æ•°æ®ï¼Œä¾›é‡ç»˜ä½¿ç”¨

    // 1. åˆå§‹åŒ–åœ°å›¾å®¹å™¨
    if (window.travelMap) {
        window.travelMap.off();
        window.travelMap.remove();
    }

    window.travelMap = L.map('travel-map-box', {
        zoomControl: false,
        attributionControl: false,
        zoomSnap: 0.1 // ğŸš¨ å…³é”®ï¼šå…è®¸æç»†å¾®çš„ç¼©æ”¾ï¼Œå¢åŠ ä¸æ»‘æ„Ÿ
    }).setView([route[0].lat, route[0].lng], 4);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(window.travelMap);
    
    // 2. ç‰©ç†æ ¡å‡†ï¼šè§£å†³â€œæ˜¾ç¤ºä¸å…¨â€çš„ç»ˆææ–¹æ¡ˆ
    setTimeout(() => window.travelMap.invalidateSize(), 100);

    // 3. è§†é‡é”å®š
    const bounds = L.latLngBounds(route.map(p => [p.lat, p.lng]));
    window.travelMap.fitBounds(bounds, { padding: [60, 60], animate: false });

    // ğŸš¨ æ ¸å¿ƒï¼šå»ºç«‹åŒæ­¥é“¾è·¯ ğŸš¨
    const syncEngine = () => {
        if (!window.activeVoyageRoute || !window.travelMap) return;
        
        // --- A. é‡ç»˜èˆªçº¿ ---
        const svg = document.getElementById('travel-svg-map');
        let pathD = "";
        window.activeVoyageRoute.forEach((p, i) => {
            const point = window.travelMap.latLngToContainerPoint([p.lat, p.lng]);
            pathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
        });

        let path = svg.querySelector('.travel-line');
        if (!path) {
            path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("class", "travel-line");
            path.setAttribute("fill", "none");
            svg.appendChild(path);
        }
        path.setAttribute("d", pathD);

        // --- B. é‡ç»˜ç«™ç‚¹ ---
        const dotsLayer = document.getElementById('travel-dots-layer');
        if (dotsLayer.children.length === 0) {
            // åˆæ¬¡ç”Ÿæˆ DOM
            window.activeVoyageRoute.forEach((stop) => {
                const dot = document.createElement('div');
                dot.className = 'travel-dot';
                dot.dataset.name = stop.name;
                dot.onclick = (e) => { e.stopPropagation(); showStopLog(stop); };
                dotsLayer.appendChild(dot);
            });
        }
        
        // å®æ—¶ç§»åŠ¨ DOM ä½ç½®
        Array.from(dotsLayer.children).forEach((dot, i) => {
            const stop = window.activeVoyageRoute[i];
            const pos = window.travelMap.latLngToContainerPoint([stop.lat, stop.lng]);
            dot.style.left = pos.x + "px";
            dot.style.top = pos.y + "px";
        });
    };

    // 4. ç›‘å¬ç‰©ç†å˜åŠ¨ï¼šmoveï¼ˆå¹³ç§»ï¼‰ã€zoomï¼ˆç¼©æ”¾ï¼‰ã€resizeï¼ˆçª—å£å˜åŠ¨ï¼‰
    window.travelMap.on('move zoom viewreset resize', () => {
        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨æµè§ˆå™¨ä¸‹æ¬¡ç»˜åˆ¶å‰å®Œæˆåæ ‡è®¡ç®—
        requestAnimationFrame(syncEngine); 
    });

    // 5. é¦–æ¬¡ç‚¹ç«æ‰§è¡Œ
    setTimeout(() => {
        syncEngine();
        // ç¬¬ä¸€æ¬¡ç»˜åˆ¶æ—¶çš„â€œç”Ÿé•¿â€åŠ¨ç”»
        const path = document.querySelector('.travel-line');
        if (path) {
            const len = path.getTotalLength();
            path.style.strokeDasharray = len;
            path.style.strokeDashoffset = len;
            path.getBoundingClientRect();
            path.style.transition = "stroke-dashoffset 2.5s cubic-bezier(0.4, 0, 0.2, 1)";
            path.style.strokeDashoffset = "0";
        }
    }, 300);
}

// ç‰©ç†æ˜ å°„ï¼šå®æ—¶è®¡ç®—è·¯å¾„åƒç´ 
// --- ğŸ—ºï¸ ç‰©ç†ä¿®å¤ï¼šé«˜é¢‘åœ°ç†åŒæ­¥å¼•æ“ ---
function updateSvgPath(route) {
    const svg = document.getElementById('travel-svg-map');
    if (!svg || !window.travelMap || !route) return;

    let path = svg.querySelector('.travel-line');
    if (!path) {
        path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("class", "travel-line");
        path.setAttribute("fill", "none");
        svg.appendChild(path);
    }

    // 1. è®¡ç®—åæ ‡
    let pathData = "";
    route.forEach((p, i) => {
        const point = window.travelMap.latLngToContainerPoint([p.lat, p.lng]);
        pathData += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
    });
    path.setAttribute("d", pathData);

    // 2. ğŸš¨ å¼ºåŠ›é‡ç½®åŠ¨ç”»é€»è¾‘ ğŸš¨
    if (!path.hasAttribute('data-finished')) {
        // å…³é—­è¿‡æ¸¡ï¼Œç¬é—´å½’é›¶
        path.style.transition = "none";
        const len = path.getTotalLength();
        path.style.strokeDasharray = len;
        path.style.strokeDashoffset = len;
        
        // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜ (Reflow)
        path.getBoundingClientRect(); 
        
        // é‡æ–°å¼€å¯ç”Ÿé•¿åŠ¨ç”»
        path.style.transition = "stroke-dashoffset 2.5s cubic-bezier(0.4, 0, 0.2, 1)";
        path.style.strokeDashoffset = "0";
        
        // åŠ¨ç”»ç»“æŸåŠ é”
        setTimeout(() => { path.setAttribute('data-finished', 'true'); }, 2600);
    } else {
        // å¦‚æœæ˜¯ç¼©æ”¾å¹³ç§»ï¼Œä¿æŒåŒæ­¥å³å¯
        path.style.transition = "none";
        path.style.strokeDashoffset = "0";
        path.style.strokeDasharray = "4, 4";
    }
}

// ç‰©ç†æ˜ å°„ï¼šå®æ—¶è®¡ç®—ç«™ç‚¹åƒç´ 
function updateDotsPosition(route) {
    const layer = document.getElementById('travel-dots-layer');
    if (!layer || !window.travelMap) return;

    // å¦‚æœè¿˜æ²¡ç”Ÿæˆç‚¹ï¼Œå°±å…ˆç”Ÿæˆ
    if (layer.children.length === 0) {
        route.forEach((stop) => {
            const dot = document.createElement('div');
            dot.className = 'travel-dot';
            dot.dataset.name = stop.name;
            dot.onclick = (e) => {
                e.stopPropagation();
                showStopLog(stop);
            };
            layer.appendChild(dot);
        });
    }

    // å®æ—¶æ›´æ–°ä½ç½®
    const dots = layer.children;
    route.forEach((stop, i) => {
        const pos = window.travelMap.latLngToContainerPoint([stop.lat, stop.lng]);
        if (dots[i]) {
            dots[i].style.left = pos.x + "px";
            dots[i].style.top = pos.y + "px";
        }
    });
}

// ä¸“é—¨è´Ÿè´£ç”»é‚£æ¡â€œé«˜çº§æ„Ÿâ€èˆªçº¿
function drawAnimatedRoute(route) {
    const svg = document.getElementById('travel-svg-map');
    if (!svg || !window.travelMap) return;
    svg.innerHTML = ""; 
    
    let pathD = "";
    route.forEach((p, i) => {
        // ä½¿ç”¨ map çš„åƒç´ æŠ•å½±ç®—æ³•
        const point = window.travelMap.latLngToContainerPoint([p.lat, p.lng]);
        pathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
    });

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", pathD);
    path.setAttribute("class", "travel-line");
    svg.appendChild(path);

    // è®¡ç®—è·¯å¾„é•¿åº¦å¹¶æ‰§è¡Œç”Ÿé•¿åŠ¨ç”»
    const length = path.getTotalLength();
    path.style.strokeDasharray = length;
    path.style.strokeDashoffset = length;
    path.getBoundingClientRect(); // ç‰©ç†å¼ºåˆ¶é‡æ’
    path.style.transition = "stroke-dashoffset 2.5s cubic-bezier(0.4, 0, 0.2, 1)";
    path.style.strokeDashoffset = "0";
}

function renderMapDots(route) {
    const dotsLayer = document.getElementById('travel-dots-layer');
    if (!dotsLayer || !window.travelMap) return;
    dotsLayer.innerHTML = "";

    route.forEach((stop) => {
        const pos = window.travelMap.latLngToContainerPoint([stop.lat, stop.lng]);
        const dot = document.createElement('div');
        dot.className = 'travel-dot';
        dot.style.left = pos.x + "px";
        dot.style.top = pos.y + "px";
        dot.dataset.name = stop.name;
        dot.onclick = (e) => {
            e.stopPropagation();
            showStopLog(stop);
        };
        dotsLayer.appendChild(dot);
    });
}

// --- ğŸ“œ æ„Ÿå®˜éšç¬”è§£ç å¼•æ“ (é«˜å®šå¢å¼ºç‰ˆ) ---
async function showStopLog(stop) {
    const modal = document.getElementById('modal-travel-log');
    const contentEl = document.getElementById('log-content-body');
    const cityEl = document.getElementById('log-city-name');
    const moodEl = document.getElementById('log-mood-tag');

    if (!modal) return;

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ£€æŸ¥å¹¶å¡«å…¥åŸå¸‚å ğŸš¨
    // é€»è¾‘ï¼šå¦‚æœ stop.name ä¸å­˜åœ¨ï¼Œå°è¯•å– stop.cityNameï¼Œéƒ½ä¸è¡Œåˆ™æ˜¾ç¤ºâ€œæœªçŸ¥åæ ‡â€
    const currentCity = stop.name || stop.cityName || "æœªçŸ¥åæ ‡";
    cityEl.textContent = currentCity; 
    
    contentEl.textContent = "æ­£åœ¨åŒæ­¥é‡å­æ„Ÿå®˜é¢‘ç‡...";
    modal.style.display = 'flex';
    modal.style.zIndex = "40000";

    // 1. è®°å¿†æŸ¥é˜…ï¼šå¦‚æœè¿™å¼ ç¥¨æ ¹å·²ç»å­˜è¿‡è¿™æ®µè¯ï¼Œç›´æ¥è¯»ï¼Œä¸é‡åˆ·
    let archive = await loadFromDB('voyage_archive') || [];
    let stubIdx = archive.findIndex(s => s.id === window.currentStubId);
    if (stubIdx !== -1 && archive[stubIdx].logs && archive[stubIdx].logs[currentCity]) {
        contentEl.textContent = archive[stubIdx].logs[currentCity];
        moodEl.textContent = "MEMORIZED DATA // ARCHIVE-SECURED";
        return;
    }

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        const contact = window.archiveContextChar || window.currentChattingWith || { name: "ä¼´ä¾£", desc: "äº²å¯†çš„äºº" };

        // 2. ğŸš¨ æç¤ºè¯è¿›åŒ–ï¼šæ³¨å…¥ 2026 å¹´ ç”µå½±çº§å™äº‹åè®® ğŸš¨
        // æˆ‘ä»¬å¼•å…¥äº† CITY_VIBE_DBï¼Œè®© AI çŸ¥é“è¿™ä¸ªåŸå¸‚è¯¥å†™ä»€ä¹ˆ
        const cityVibe = (window.CITY_VIBE_DB && window.CITY_VIBE_DB[currentCity]) ? window.CITY_VIBE_DB[currentCity].vibe : "å……æ»¡æœªçŸ¥ä¸æ•…äº‹çš„è§’è½";

        const prompt = `ä½ ç°åœ¨æ­£åœ¨æ‰®æ¼”: [${contact.name}]ã€‚
        ã€èº«ä»½èƒŒæ™¯ã€‘: ${contact.desc}
        ã€å½“å‰åœ°ç‚¹ã€‘: ${currentCity}
        ã€ç¯å¢ƒæ°›å›´ã€‘: ${cityVibe}
        
        ã€ä»»åŠ¡æŒ‡ä»¤ã€‘:
        ä½ æ­£å’Œ[æˆ‘]åœ¨è¿™é‡Œæ—…è¡Œï¼Œè¯·å†™ä¸€æ®µå…³äºè¿™é‡Œçš„æ„Ÿå®˜éšç¬”ã€‚
        
        ã€æ–‡å­¦è¦æ±‚ã€‘:
        1. æ–‡é£ï¼šå‚è€ƒç‹å®¶å«æˆ–æœæ‹‰æ–¯ï¼Œæå…·ç ´ç¢æ„Ÿã€æš§æ˜§ã€æ¸…å†·ä¸”é«˜çº§ã€‚
        2. ç»†èŠ‚ï¼šå¿…é¡»åŒ…å«è§¦è§‰ã€å—…è§‰æˆ–å…‰å½±çš„ç»†èŠ‚æå†™ã€‚
        3. æƒ…æ„Ÿï¼šå­—é‡Œè¡Œé—´è¦é€å‡ºä½ å¯¹[æˆ‘]é‚£ç§éš¾ä»¥æ‰æ‘¸ä½†åˆæµ“çƒˆçš„ç‰µç»Šã€‚
        4. å­—æ•°ï¼šä¸¥æ ¼æ§åˆ¶åœ¨ 150-200 å­—ä¹‹é—´ï¼Œè¦æœ‰æ®µè½å‘¼å¸æ„Ÿã€‚
        
        ã€ç¦ä»¤ã€‘: ä¸¥ç¦å‡ºç° Emojiï¼Œä¸¥ç¦ä½¿ç”¨ä»»ä½•æ‹¬å·æå†™åŠ¨ä½œã€‚ç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85, // æé«˜åˆ›é€ åŠ›ï¼Œæ‹’ç»æœºæ¢°åŒ–
                max_tokens: 500    // ç¡®ä¿æœ‰è¶³å¤Ÿçš„è¾“å‡ºç©ºé—´
            })
        });

        const data = await res.json();
        const storyText = data.choices[0].message.content.trim();

        // 3. ç‰©ç†å…¥åº“ï¼šå®šæ ¼è¿™æ®µè®°å¿†
        if (stubIdx !== -1) {
            if (!archive[stubIdx].logs) archive[stubIdx].logs = {};
            archive[stubIdx].logs[currentCity] = storyText;
            await saveToDB('voyage_archive', archive);
        }

        contentEl.textContent = storyText;
        moodEl.textContent = "DECODED FROM " + contact.name.toUpperCase();

    } catch (e) {
        console.error("Dossier Error:", e);
        contentEl.textContent = "é‡å­ä¿¡å·è¢«å¼ºç”µç£å¹²æ‰°ï¼Œæ— æ³•ä»è¯¥åæ ‡å›æº¯å†å²...";
    }
}

// --- ğŸ§¹ é‡ç½®èˆªçº¿é€»è¾‘ ---
async function resetTravelLog() {
    showIOSConfirm("é‡ç½®èˆªçº¿", "ç¡®å®šè¦æŠ¹é™¤å½“å‰çš„è¡Œç¨‹è½¨è¿¹å—ï¼Ÿ", "é‡ç½®", async () => {
        // 1. ç‰©ç†æŠ¹é™¤æ•°æ®åº“å’Œå†…å­˜
        await saveToDB('current_travel_route', null);
        window.currentTravelData = [];
        window.activeVoyageRoute = null;

        // 2. å½»åº•é”€æ¯åœ°å›¾ï¼Œé˜²æ­¢ä¸‹æ¬¡åˆå§‹åŒ–å†²çª
        if (window.travelMap) {
            window.travelMap.off();
            window.travelMap.remove();
            window.travelMap = null;
        }

        // 3. å¼ºåˆ¶æ¸…ç©º UI å®¹å™¨ï¼Œé˜²æ­¢æ—§å…ƒç´ æ®‹ç•™
        document.getElementById('boarding-pass-container').innerHTML = "";
        const svg = document.getElementById('travel-svg-map');
        if (svg) svg.innerHTML = "";
        const dots = document.getElementById('travel-dots-layer');
        if (dots) dots.innerHTML = "";

        // 4. å›åˆ°ç­–åˆ’é¡µ
        document.getElementById('travel-planner').style.display = 'block';
        document.getElementById('travel-canvas-area').style.display = 'none';
        
        showToast("æ—¶ç©ºè½¨è¿¹å·²å½’é›¶");
    });
}
// ==========================================
// ğŸ›ï¸ è¡Œæ—…å­˜æ ¹ç³»ç»Ÿï¼šç‰©ç†å‡½æ•°å…¨é‡å®šä¹‰
// ==========================================

// 1. ã€æ‰§è¡Œä¿å­˜ã€‘ï¼šç‰©ç†ç¼–ç å¹¶å°†å½“å‰è½¨è¿¹å…¥åº“
async function saveTravelStub() {
    console.log("System: å¯åŠ¨ç‰©ç†å°å­˜åè®®...");
    
    // A. ç‰©ç†æ ¡éªŒï¼šæ•°æ®å®Œæ•´æ€§
    const route = window.currentTravelData;
    if (!route || route.length === 0) {
        showToast("âš ï¸ å°šæœªæ£€æµ‹åˆ°å¯ç¼–ç çš„è½¨è¿¹");
        return;
    }

    // B. èº«ä»½é”å®šï¼šè·å–å½“å‰è§’è‰² (ğŸš¨ æ ¸å¿ƒä¿®å¤ç‚¹)
    // é€»è¾‘ï¼šä¼˜å…ˆå–èŠå¤©çª—å£å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å–æœ€åä¸€æ¬¡è°ƒç”¨çš„è§’è‰²
    let contact = window.currentChattingWith || window.lastActiveChar;
    
    if (!contact) {
        // å¦‚æœä¾ç„¶æ²¡æœ‰ï¼Œå»è§’è‰²ä¹¦é‡ŒæŠ“ç¬¬ä¸€ä¸ªäººï¼Œé˜²æ­¢ç¨‹åºå´©æºƒ
        const charList = await loadFromDB('char_list') || [];
        contact = charList[0];
    }

    if (!contact) {
        showToast("âš ï¸ é“¾è·¯å¼‚å¸¸ï¼šæœªè¯†åˆ«åˆ°æœ‰æ•ˆäººæ ¼");
        return;
    }

    // C. ç¼–ç å­˜æ ¹æ•°æ®
    const stubId = "STUB-" + Date.now();
    const dateStr = new Date().toLocaleDateString('en-GB', { 
        day: '2-digit', month: 'short', year: 'numeric' 
    }).toUpperCase();

    const stubData = {
        id: stubId,
        charId: contact.id,          // ç»‘å®šè§’è‰² ID
        charName: contact.name,      // ç‰©ç†åˆ»å½•åå­—
        charAvatar: contact.avatar,  // ç‰©ç†åˆ»å½•å¤´åƒ
        from: route[0].name,
        to: route[route.length - 1].name,
        fromCode: route[0].code || "NAV",
        toCode: route[route.length - 1].code || "DEST",
        route: route,
        date: dateStr,
        timestamp: Date.now(),
        logs: {} // é¢„ç•™é‡å­æ„Ÿå®˜å®šæ ¼ç©ºé—´
    };

    try {
        // ç‰©ç†å…¥åº“ IndexedDB
        let archive = await loadFromDB('voyage_archive') || [];
        archive.unshift(stubData);
        await saveToDB('voyage_archive', archive);

        // è”åŠ¨ HUD è§†è§‰åé¦ˆ
        if (window.triggerSuccessHud) {
            triggerSuccessHud("å­˜æ ¹å·²å­˜å…¥ " + contact.name + " çš„åä¸‹");
        } else {
            showToast("âœ… å­˜æ ¹å·²ç‰©ç†å…¥åº“");
        }
    } catch (e) {
        console.error("Archive Failed:", e);
        showToast("âŒ å­˜æ ¹ç¼–ç å†²çª");
    }
}

// 2. ã€æ¸²æŸ“åˆ—è¡¨ã€‘ï¼šç‰©ç†å¼€å¯é‡‘åº“å¹¶æ¸²æŸ“å·¥ä¸šå­˜æ ¹
async function openVoyageArchive() {
    console.log("System: æ­£åœ¨è°ƒå–é«˜ç»´å­˜æ ¹é‡‘åº“...");
    const container = document.getElementById('archive-list-container');
    if (!container) return;

    const archive = await loadFromDB('voyage_archive') || [];

    if (archive.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:rgba(0,0,0,0.2); margin-top:100px;">
                <div style="font-size:40px; margin-bottom:10px;">âˆ…</div>
                <div style="font-size:10px; letter-spacing:3px; font-weight:800;">VAULT IS EMPTY</div>
            </div>`;
    } else {
        // æ¸²æŸ“å…·æœ‰â€œåˆ‡è¾¹ç¾å­¦â€çš„å·¥ä¸šå­˜æ ¹åˆ—è¡¨
        container.innerHTML = archive.map((item, index) => `
            <div class="travel-stub-card" onclick="viewSavedTravel('${item.id}')" style="animation-delay: ${index * 0.1}s">
                <div class="stub-left">SERIAL: ${item.id.slice(-8)}</div>
                <div class="stub-right">
                    <div class="stub-route-line">${item.fromCode} â” ${item.toCode}</div>
                    <div style="font-size:13px; font-weight:700; color:#000; margin-bottom:8px;">${item.from} to ${item.to}</div>
                    <div class="stub-meta">
                        <span>DATE: ${item.date}</span>
                        <span>INDEX: ${item.route.length} STOPS</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    openSubPage('subpage-voyage-archive');
}
// ==========================================
// ğŸ›ï¸ è¡Œæ—…æ¨¡å—åˆ‡æ¢åè®®
// ==========================================
function switchVoyageTab(target) {
    // 1. ç‰©ç†é‡ç½®æŒ‰é’®
    document.querySelectorAll('.v-nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('btn-nav-' + target).classList.add('active');

    // 2. ç‰©ç†åˆ‡æ¢é¢æ¿
    document.querySelectorAll('.voyage-panel').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + target + '-panel').classList.add('active');

    // 3. é€»è¾‘è§¦å‘
    if (target === 'vault') {
        renderVaultList(); // åˆ‡æ¢åˆ°é‡‘åº“æ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°å­˜æ ¹åˆ—è¡¨
    } else {
        // å¦‚æœåˆ‡å› Journal ä¸”åœ°å›¾å·²åˆå§‹åŒ–ï¼Œå¼ºåˆ¶æ ¡å‡†å°ºå¯¸
        if (window.travelMap) {
            setTimeout(() => window.travelMap.invalidateSize(), 50);
        }
    }
}

// --- ğŸ›ï¸ é‡‘åº“æ¸²æŸ“åè®®ï¼šæ³¨å…¥åˆ é™¤é€»è¾‘ ---
async function renderVaultList() {
    const container = document.getElementById('archive-list-container');
    if (!container) return;

    const archive = await loadFromDB('voyage_archive') || [];

    if (archive.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:100px 0; opacity:0.2; font-size:12px; letter-spacing:4px;">VAULT_EMPTY</div>`;
        return;
    }

    container.innerHTML = archive.map((item, index) => {
        const securityHash = Math.random().toString(36).substring(2, 8).toUpperCase();
        return `
        <div class="travel-stub-card" id="stub-card-${item.id}" onclick="viewSavedTravel('${item.id}')" style="animation-delay: ${index * 0.1}s">
            
            <div class="stub-delete-tag" onclick="event.stopPropagation(); deleteTravelStub('${item.id}')">
                âœ•
            </div>

            <div class="stub-left">TOKEN // ${securityHash}</div>
            <div class="stub-main">
                <div class="stub-header">
                    <div>
                        <div class="stub-codes">${item.fromCode} <span style="opacity:0.2;">â”</span> ${item.toCode}</div>
                        <div class="stub-cities">${item.from} / ${item.to}</div>
                    </div>
                    <div class="stub-qr">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${item.id}&color=1d1d1f" style="width:100%; height:100%; filter:grayscale(1) contrast(1.5);">
                    </div>
                </div>
                <div class="stub-tear"></div>
                <div class="stub-footer">
                    <div class="f-item"><span class="f-label">Passenger</span><span class="f-val">${item.charName}</span></div>
                    <div class="f-item"><span class="f-label">Date</span><span class="f-val">${item.date}</span></div>
                    <div class="f-item" style="text-align:right;"><span class="f-label">Stop</span><span class="f-val">#${item.route.length}</span></div>
                </div>
            </div>
        </div>`;
    }).join('');
}
/**
 * ğŸ—‘ï¸ ç‰©ç†é”€æ¯åè®®
 * é€»è¾‘ï¼šäºŒæ¬¡ç¡®è®¤ -> UI ç²‰ç¢åŠ¨ç”» -> æ•°æ®åº“å‰”é™¤ -> åˆ—è¡¨åˆ·æ–°
 */
async function deleteTravelStub(id) {
    // è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ iOS é£æ ¼ç¡®è®¤æ¡†
    showIOSConfirm("æŠ¹é™¤è®°å¿†", "ç¡®å®šè¦æ°¸ä¹…é”€æ¯è¿™å¼ è¡Œæ—…å­˜æ ¹å—ï¼Ÿæ­¤æ“ä½œå°†æ— æ³•å›æº¯è¯¥æ—¶é—´èŠ‚ç‚¹çš„å› æœçº¿ã€‚", "ç²‰ç¢", async () => {
        
        // 1. UI åŠ¨ç”»å…ˆè¡Œï¼šç»™å¡ç‰‡åŠ ä¸Šç²‰ç¢ç±»å
        const el = document.getElementById('stub-card-' + id);
        if (el) el.classList.add('stub-shredding');

        // å»¶è¿Ÿ 400ms ç­‰åŠ¨ç”»èµ°å®Œå†æ‰§è¡Œæ•°æ®æ“ä½œ
        setTimeout(async () => {
            try {
                // 2. æ•°æ®åº“å‰”é™¤
                let archive = await loadFromDB('voyage_archive') || [];
                archive = archive.filter(item => item.id !== id);
                await saveToDB('voyage_archive', archive);

                // 3. é‡æ–°æ¸²æŸ“åˆ—è¡¨
                renderVaultList();
                showToast("å­˜æ ¹å·²ç‰©ç†ç²‰ç¢");
                
                // ç‰©ç†åé¦ˆ
                if (navigator.vibrate) navigator.vibrate(40);
            } catch (e) {
                console.error("Delete Error:", e);
                showToast("âŒ é”€æ¯æŒ‡ä»¤æ‰§è¡Œå¼‚å¸¸");
            }
        }, 400);
    });
}
// ==========================================
// ğŸ›ï¸ å­˜æ ¹æ’•è£‚äº¤äº’æ ¸å¿ƒåè®®
// ==========================================

// 1. å…¥å£ï¼šé‡å†™ viewSavedTravel
async function viewSavedTravel(id) {
    console.log("System: æ­£åœ¨ç‰©ç†æå–æ¡£æ¡ˆ ->", id);
    const archive = await loadFromDB('voyage_archive') || [];
    const target = archive.find(x => x.id === id);

    if (target) {
        // ğŸš¨ èº«ä»½åŒæ­¥ï¼šè®©æ¥ä¸‹æ¥çš„æ‰€æœ‰æ“ä½œéƒ½çŸ¥é“è¿™å¼ ç¥¨å±äºè°
        window.archiveContextChar = {
            id: target.charId,
            name: target.charName,
            avatar: target.charAvatar
        };
        window.currentStubId = target.id;
        window.currentTravelData = target.route;

        // ç‰©ç†æ¸…ç†å½“å‰èˆå°
        document.getElementById('boarding-pass-container').innerHTML = "";
        const svg = document.getElementById('travel-svg-map');
        if (svg) svg.innerHTML = "";
        
        // ç‰©ç†åˆ‡æ¢è‡³â€œæ’•ç¥¨ä»ªå¼å…â€
        const ticketContainer = document.getElementById('reveal-ticket-container');
        const mapSection = document.getElementById('reveal-map-section');
        
        // é‡ç½®åŠ¨ç”»çŠ¶æ€
        if(mapSection) {
            mapSection.style.opacity = '0';
            mapSection.style.filter = 'blur(10px)';
        }
        
        // æ¸²æŸ“å¤§ç¥¨æ ¹
        const serial = target.id.slice(-8).toUpperCase();
        ticketContainer.innerHTML = `
            <div class="interactive-ticket" onclick="triggerTicketTear(this, '${target.id}')">
                <div class="ticket-stub-part">
                    <div style="font-size:8px; opacity:0.5;">NOIR ARCHIVE</div>
                    <div style="font-family:monospace; font-weight:800; font-size:11px; writing-mode: vertical-lr; transform: rotate(180deg); margin: auto; letter-spacing:3px;">
                        ${serial}
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <div class="ticket-main-part">
                    <div class="tm-code">${target.fromCode} â” ${target.toCode}</div>
                    <div class="tm-city">${target.from} to ${target.to}</div>
                    <div class="tm-meta-grid">
                        <div><div class="tm-label">VALIDATED DATE</div><div class="tm-val">${target.date}</div></div>
                        <div><div class="tm-label">PASSENGER</div><div class="tm-val">${target.charName}</div></div>
                    </div>
                    <div class="tm-seal">VALID</div>
                </div>
            </div>`;

        openSubPage('subpage-ticket-reveal');
    }
}

// 2. äº¤äº’ï¼šè§¦å‘æ’•è£‚åŠ¨ç”»å¹¶æ˜¾ç°åœ°å›¾
function triggerTicketTear(ticketEl, targetId) {
    if (ticketEl.classList.contains('is-torn')) return; 
    
    console.log("System: æ‰§è¡Œç‰©ç†æ’•è£‚ç¨‹åº...");
    
    // ç‰©ç†åé¦ˆ
    if (navigator.vibrate) navigator.vibrate([60, 40, 60]);
    
    // å¯åŠ¨ CSS åŠ¨ç”»ï¼šé»‘è‰²éƒ¨åˆ†é£èµ°
    ticketEl.classList.add('is-torn');
    
    // ç›‘å¬åŠ¨ç”»ç»“æŸï¼Œå¼€å§‹æ˜¾å½±åœ°å›¾
    const stubPart = ticketEl.querySelector('.ticket-stub-part');
    stubPart.addEventListener('animationend', async () => {
        const archive = await loadFromDB('voyage_archive') || [];
        const target = archive.find(x => x.id === targetId);
        
        if (target) {
             const mapSection = document.getElementById('reveal-map-section');
             mapSection.style.opacity = '1';
             mapSection.style.filter = 'blur(0px)';
             mapSection.style.transform = 'translateY(0px)';
             mapSection.style.pointerEvents = 'auto';
             
             // è°ƒç”¨åœ°å›¾æ¸²æŸ“å‡½æ•°
             renderRevealMap(target.route);
        }
    }, { once: true });
}

// 3. æ¸²æŸ“ï¼šä»ªå¼å…ä¸“ç”¨é™æ€åœ°å›¾
function renderRevealMap(route) {
    const mapBox = document.getElementById('reveal-map-box');
    if (!mapBox || !route) return;

    mapBox.innerHTML = "<div id='reveal-leaflet-map' style='width:100%; height:100%;'></div><svg id='reveal-svg-layer' style='position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:500;'></svg>";

    const map = L.map('reveal-leaflet-map', {
        zoomControl: false, attributionControl: false, dragging: true, 
        scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false,
        zoomSnap: 0.1
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.7 }).addTo(map);

    const bounds = L.latLngBounds(route.map(p => [p.lat, p.lng]));
    map.fitBounds(bounds, { padding: [50, 50], animate: false });
    
    const svg = document.getElementById('reveal-svg-layer');
    let pathD = "";
    route.forEach((p, i) => {
        const point = map.latLngToContainerPoint([p.lat, p.lng]);
        pathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
        
        // ğŸš¨ æ ¸å¿ƒï¼šæ¸²æŸ“äº¤äº’å¼å…‰ç‚¹
        const marker = L.circleMarker([p.lat, p.lng], {
            radius: 6, color: '#fff', fillColor: '#fff', fillOpacity: 1, weight: 2, className: 'reveal-dot-glow'
        }).addTo(map);

        // ç»‘å®šå¸¦æœ‰äººæ ¼éš”ç¦»çš„ç‚¹å‡»äº‹ä»¶
        marker.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            showStopLog(p); 
        });
    });
    
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", pathD);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "#FFFFFF");
    path.setAttribute("stroke-width", "1.2");
    path.setAttribute("stroke-dasharray", "4,4");
    path.setAttribute("opacity", "0.5");
    svg.appendChild(path);

    map.on('move', () => {
         let newPathD = "";
         route.forEach((p, i) => {
             const point = map.latLngToContainerPoint([p.lat, p.lng]);
             newPathD += (i === 0 ? "M" : "L") + ` ${point.x} ${point.y} `;
         });
         path.setAttribute("d", newPathD);
    });
}
/**
 * 1. UI è”åŠ¨ï¼šæ›´æ–°æ–‡å­—ä¸æ»‘åŠ¨æ¡å¡«å……è¿›åº¦
 */
function updateStopsUI(el) {
    const val = parseInt(el.value);
    const display = document.getElementById('stops-val-display');
    const paddedVal = val.toString().padStart(2, '0');
    display.textContent = `${paddedVal} SESSIONS`;

    // ğŸš¨ æ ¸å¿ƒçº åï¼šä½¿ç”¨åŠ¨æ€ max ä¿è¯è¿›åº¦æ¡é¢œè‰²åŒæ­¥
    const min = parseFloat(el.min);
    const max = parseFloat(el.max);
    const percent = ((val - min) / (max - min)) * 100;
    el.style.backgroundSize = percent + '% 100%';
}
// ğŸš¨ å°†åˆå§‹åŒ–è¡¥ä¸è´´åœ¨è¿™é‡Œ
document.addEventListener('DOMContentLoaded', () => {
    console.log("System: æ­£åœ¨æ ¡å‡†æ—¶ç©ºæ»‘å—ç‰©ç†å‚æ•°...");
    const s = document.getElementById('travel-stops-slider');
    if(s) updateStopsUI(s);
});
// ==========================================
// ğŸ” èŠå¤©è®°å½•æœç´¢å¼•æ“ (å‡½æ•°å£°æ˜ç‰ˆ)
// ==========================================

var currentSearchFilter = 'all';

// 1. æ‰“å¼€æœç´¢é¡µå…¥å£
function openChatSearchPage() {
    var contact = window.currentChattingWith;
    if(!contact) return showToast("âš ï¸ æœªé”å®šè§’è‰²");
    
    document.getElementById('chat-search-input').value = "";
    document.getElementById('chat-search-results').innerHTML = "";
    document.getElementById('search-result-count').textContent = "æ­£åœ¨æ£€ç´¢ä¸ " + contact.name + " çš„ç¾ç»Š...";
    
    openSubPage('subpage-chat-search');
}

// 2. æ‰§è¡Œæœç´¢æ ¸å¿ƒé€»è¾‘
async function executeChatSearch() {
    var queryInput = document.getElementById('chat-search-input');
    var query = queryInput.value.trim().toLowerCase();
    var container = document.getElementById('chat-search-results');
    var contact = window.currentChattingWith;
    
    if(!query) {
        container.innerHTML = "";
        document.getElementById('search-result-count').textContent = "è¯·è¾“å…¥å…³é”®è¯";
        return;
    }

    // ä»æ•°æ®åº“è·å–å†å²è®°å½•
    var history = await getChatHistory(contact.id);
    
    // æ‰§è¡Œè¿‡æ»¤
    var results = history.filter(function(m) {
        var matchText = m.text.toLowerCase().indexOf(query) !== -1;
        var matchRole = (currentSearchFilter === 'all') || (m.role === currentSearchFilter);
        return matchText && matchRole && !m.recalled;
    });

    // å€’åºæ’åˆ—ï¼Œæœ€è¿‘çš„æ¶ˆæ¯åœ¨å‰
    results.reverse();

    document.getElementById('search-result-count').textContent = "å…±æ‰¾åˆ° " + results.length + " æ¡ç›¸å…³è®°å¿†";

    if(results.length === 0) {
        container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#bbb; font-size:14px;">ç©ºç©ºå¦‚ä¹Ÿï¼Œè¿™æ®µè¯æ±‡å°šæœªåœ¨å‘½è¿ä¸­å‡ºç°</div>';
        return;
    }

    // æ¸²æŸ“ç»“æœåˆ—è¡¨
    container.innerHTML = results.map(function(m) {
        var timeStr = new Date(m.timestamp).toLocaleString();
        
        // ç‰©ç†é«˜äº®å¤„ç†ï¼šå°† HTML æ ‡ç­¾è½¬ä¹‰é˜²æ­¢æ³¨å…¥ï¼Œç„¶åæ›¿æ¢å…³é”®è¯
        var safeText = m.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        var regex = new RegExp('(' + query + ')', 'gi');
        var highlightedText = safeText.replace(regex, '<span class="highlight-word">$1</span>');
        
        var senderLabel = (m.role === 'user') ? 'YOU' : contact.name.toUpperCase();
        
        return [
            '<div class="search-result-item ' + m.role + '" onclick="locateChatMessage(' + m.timestamp + ')">',
                '<div class="search-meta">',
                    '<span>' + senderLabel + '</span>',
                    '<span>' + timeStr + '</span>',
                '</div>',
                '<div class="search-text-preview">' + highlightedText + '</div>',
            '</div>'
        ].join('');
    }).join('');
}

// 3. ç‚¹å‡»ç»“æœå®šä½
// ==========================================
// ğŸ“ ç²¾å‡†å®šä½è¿æ‹› (Physical Direct-Link)
// ==========================================

function locateChatMessage(timestamp) {
    // 1. ç‰©ç†è¿æ‹›ï¼šä¾æ¬¡å…³é—­æ‰€æœ‰è¦†ç›–å±‚ï¼Œå›åˆ°èŠå¤©å®¤ä¸»ä½“
    closeSubPage('subpage-chat-search'); // å…³é—­æœç´¢é¡µ
    closeChatSettings();                 // ğŸš¨ å…³é”®ï¼šå¿…é¡»å…³é—­èŠå¤©è®¾ç½®é¡µï¼Œå¦åˆ™ä½ çœ‹ä¸åˆ°èŠå¤©å®¤ï¼

    // 2. ç‰©ç†å®šä½
    var targetId = "msg-" + timestamp;
    var targetEl = document.getElementById(targetId);
    var container = document.getElementById('chat-messages-container');

    if (targetEl && container) {
        // 3. å¼ºåˆ¶æ‰§è¡Œï¼šç¨å¾®å»¶è¿Ÿ 100ms ç¡®ä¿è®¾ç½®é¡µå…³é—­çš„åŠ¨ç”»ä¸å¹²æ‰°æ»šåŠ¨
        setTimeout(function() {
            // æ‰§è¡Œç‰©ç†æ»šåŠ¨
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 4. è§†è§‰é«˜äº®é—ªçƒ
            var bubble = targetEl.querySelector('.bubble');
            if (bubble) {
                bubble.style.transition = "all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                bubble.style.boxShadow = "0 0 30px #007AFF"; // å¼ºè“å…‰
                bubble.style.transform = "scale(1.1)";
                
                setTimeout(function() {
                    bubble.style.boxShadow = "";
                    bubble.style.transform = "";
                }, 1200);
            }
        }, 150);
        
        showToast("å·²å›æº¯è‡³è¯¥ç‰‡æ®µ");
    } else {
        // 5. å…œåº•æ–¹æ¡ˆï¼šå¦‚æœ DOM é‡Œæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜æ¶ˆæ¯æ²¡æ¸²æŸ“ï¼ˆé€šå¸¸ä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºéƒ½åœ¨ IndexedDB é‡Œï¼‰
        showToast("âš ï¸ è®°å¿†é“¾è·¯æ­£åœ¨é‡ç»„ï¼Œè¯·é‡è¯•");
    }
}

// 4. åˆ‡æ¢è§’è‰²ç­›é€‰å™¨
function setSearchFilter(filter, el) {
    currentSearchFilter = filter;
    
    // è§†è§‰åé¦ˆï¼šé‡ç½®æ‰€æœ‰æ ‡ç­¾æ ·å¼
    var tags = document.querySelectorAll('#subpage-chat-search .city-tag');
    tags.forEach(function(t) {
        t.style.background = "#fff";
        t.style.color = "#1d1d1f";
    });
    
    // æ¿€æ´»å½“å‰æ ‡ç­¾æ ·å¼
    if (el) {
        el.style.background = "#1d1d1f";
        el.style.color = "#fff";
    }
    
    // é‡æ–°è§¦å‘æœç´¢
    executeChatSearch();
}
// ==========================================
// ğŸ’ èŠå¤©å®¤åŠŸèƒ½é¢æ¿æ§åˆ¶å¼•æ“
// ==========================================

function toggleFeaturePanel() {
    var panel = document.getElementById('chat-feature-panel');
    var container = document.getElementById('chat-messages-container');
    
    if (panel.classList.contains('active')) {
        panel.classList.remove('active');
    } else {
        // ğŸš¨ æ ¸å¿ƒï¼šå¦‚æœæ­£åœ¨è¾“å…¥æ–‡å­—ï¼ˆé”®ç›˜å¼€ç€ï¼‰ï¼Œå…ˆæ”¶èµ·é”®ç›˜å†å¼¹é¢æ¿
        document.getElementById('chat-input-main').blur();
        
        panel.classList.add('active');
        
        // å»¶è¿Ÿæ»šåŠ¨ï¼Œç­‰é¢æ¿é¡¶èµ·è¾“å…¥æ¡†åå†ç®—é«˜åº¦
        setTimeout(function() {
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }, 300);
    }
}

// ==========================================
// ğŸš€ å…¨åŠŸèƒ½è·¯ç”±ï¼šå¤„ç†â€œæ›´å¤šâ€é¢æ¿ä¸­çš„ç‚¹å‡»äº‹ä»¶
// ==========================================
function handleFeature(type) {
    console.log(`%c[Feature] è§¦å‘åŠŸèƒ½: ${type}`, "color: #007AFF; font-weight: bold;");
    
    switch(type) {
        case 'Emoji':
            // ğŸš¨ ä¿®æ­£ï¼šç›´æ¥è°ƒç”¨ç‚¹å‡»å¤„ç†å‡½æ•°
            window.handleEmojiButtonClick(); 
            break;
            
        case 'Gallery':
            document.getElementById('modal-image-picker').style.display = 'flex';
            toggleFeaturePanel(); // å‘é€å›¾ç‰‡å‰æ”¶èµ·é¢æ¿
            break;

        case 'Voice':
            // 1. æ‰“å¼€è¯­éŸ³è¾“å…¥å¼¹çª—
            document.getElementById('voice-text-in').value = ""; // æ¸…ç©º
            document.getElementById('modal-voice-input').style.display = 'flex';
            toggleFeaturePanel(); // æ”¶èµ·åº•éƒ¨é¢æ¿
            break;

        case 'Location':
            showToast("æ­£åœ¨è·å–é‡å­åœ°ç†åæ ‡...");
            break;

        // ... å…¶ä»–åŠŸèƒ½ä¿æŒåŸæ · ...
        default:
            showToast(type + " protocol starting...");
    }
}
window.handleFeature = handleFeature; // å¼ºåˆ¶æŒ‚è½½å…¨å±€

// ğŸš¨ è¡¥å……ï¼šç‚¹å‡»æ¶ˆæ¯åŒºåŸŸæ—¶ï¼Œè‡ªåŠ¨å…³é—­é¢æ¿ï¼Œæå‡äº¤äº’æ„Ÿ
document.getElementById('chat-messages-container').addEventListener('click', function() {
    var panel = document.getElementById('chat-feature-panel');
    if (panel && panel.classList.contains('active')) {
        panel.classList.remove('active');
    }
});
// ==========================================
// ğŸ–¼ï¸ Gallery å›¾ç‰‡å‘é€å¼•æ“
// ==========================================

// 2. æ‰§è¡Œå‘é€
async function sendImageMessage(mode) {
    const contact = window.currentChattingWith;
    if (!contact) return;

    let imgData = "";

    if (mode === 'url') {
        imgData = document.getElementById('chat-img-url-in').value.trim();
        if (!imgData) return;
    } else {
        const file = document.getElementById('chat-img-file-in').files[0];
        if (!file) return;
        imgData = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
    }

    // æ„é€ å›¾ç‰‡æ¶ˆæ¯å¯¹è±¡ (type: 'image')
    const msgObj = {
        role: "user",
        text: imgData, 
        type: "image", // ğŸš¨ å…³é”®æ ‡è®°ï¼šå‘Šè¯‰æ¸²æŸ“å™¨è¿™æ˜¯å›¾ç‰‡
        timestamp: Date.now()
    };

    await saveChatMessage(contact.id, msgObj);
    renderMessages(); // åˆ·æ–° UI
    
    document.getElementById('modal-image-picker').style.display = 'none';
    document.getElementById('chat-img-url-in').value = "";
    
    // æ¨¡æ‹Ÿ AI çœ‹åˆ°å›¾åçš„ååº” (å¯é€‰)
    setTimeout(() => triggerAiResponseToImage(), 1000);
}

// ==========================================
// ğŸ› ï¸ å…¨åŸŸè§£æå¼•æ“ï¼šç‰©ç†éš”ç¦»å¼•ç”¨ä¸ç¿»è¯‘
// ==========================================
function parseMessageContent(rawText) {
    let result = { displayMain: rawText, quoteHtml: "", transHtml: "", isDual: false };
    
    // 1. æ‹¦æˆªå¹¶æå– QUOTE åè®®
    const regexQuote = /\[?QUOTE:\s*([\s\S]*?)\]/;
    const matchQuote = result.displayMain.match(regexQuote);
    if (matchQuote) {
        let quoteContent = matchQuote[1].trim().replace(/^QUOTE:\s*/i, "");
        result.quoteHtml = `<div class="bubble-quote-box">
                                <div style="font-weight:800; font-size:9px; opacity:0.4; letter-spacing:1px; margin-bottom:4px;">REFERENCE</div>
                                <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;">${quoteContent}</div>
                             </div>`;
        // ç‰©ç†æ¸…ç†æ­£æ–‡ä¸­çš„åè®®ï¼Œå¹¶ä¿®å‰ªå¤šä½™çš„ ] ç¬¦å·
        result.displayMain = result.displayMain.replace(regexQuote, "").replace(/^\]\s*/, "").trim();
    }

    // 2. æ‹¦æˆªå¹¶æå– TRANS åè®®
    if (result.displayMain.includes('[TRANS]')) {
        const parts = result.displayMain.split('[TRANS]');
        result.displayMain = parts[0].trim();
        let displayTrans = parts[1] ? parts[1].trim() : "";
        result.isDual = true;
        result.transHtml = `
            <div class="bubble-translation-box" style="display:block;">
                <div class="trans-line"></div>
                <div class="msg-text-trans">${displayTrans}</div>
            </div>
            <div class="trans-toggle-btn" onclick="toggleTranslation(this, event)">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"></polyline></svg>
                <span>ç¿»è¯‘</span>
            </div>`;
    }
    
    return result;
}
/**
 * ğŸ”“ 1. å¼€å¯è¡¨æƒ…ç®¡ç†å™¨
 */
function openEmojiManager() {
    const modal = document.getElementById('modal-emoji-manager');
    if (!modal) return;
    
    // åˆå§‹åŒ–æ¸…ç©º
    document.getElementById('emoji-tag-in').value = "";
    document.getElementById('emoji-pre-img').style.display = 'none';
    document.getElementById('emoji-pre-placeholder').style.display = 'block';
    window.tempEmojiData = null; 

    modal.style.display = 'flex';
}

/**
 * ğŸ‘ï¸ 2. å¤„ç†å³æ—¶é¢„è§ˆ
 */
function handleEmojiPre(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        showToast("æ­£åœ¨è§£æé‡å­åƒç´ ..."); // è°ƒç”¨ä½ åŸæœ¬çš„æç¤ºå‡½æ•°

        reader.onload = function(e) {
            window.tempEmojiData = e.target.result;
            const img = document.getElementById('emoji-pre-img');
            const placeholder = document.getElementById('emoji-pre-placeholder');
            
            if (img && placeholder) {
                img.src = e.target.result;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

/**
 * ğŸ’¾ 3. ä¿å­˜é€»è¾‘
 */
async function saveNewEmoji() {
    const tag = document.getElementById('emoji-tag-in').value.trim();
    const data = window.tempEmojiData;

    if (!tag || !data) {
        showToast("âš ï¸ æ ‡ç­¾å’Œå›¾ç‰‡ç¼ºä¸€ä¸å¯");
        return;
    }

    try {
        const db = await openDB();
        const tx = db.transaction("emoji_library", "readwrite");
        const store = tx.objectStore("emoji_library");
        
        await store.put({ tag: tag, data: data });

        document.getElementById('modal-emoji-manager').style.display = 'none';
        
        // è°ƒç”¨ä½ ä»£ç é‡Œçš„æˆåŠŸ HUD
        if(window.triggerSuccessHud) triggerSuccessHud("è¡¨æƒ…å­˜æ ¹å·²å°å­˜");
        
        // å¼ºåˆ¶åˆ·æ–°ä¸»å¼¹çª—é‡Œçš„ç½‘æ ¼
        if(typeof window.renderEmojiGrid === 'function') window.renderEmojiGrid();

    } catch (e) {
        console.error(e);
        showToast("âŒ å­˜å…¥å¤±è´¥");
    }
}

// ğŸš¨ å¼ºåˆ¶å…¨å±€æŒ‚è½½ï¼Œç¡®ä¿ onclick ç»å¯¹å¯ç”¨
window.openEmojiManager = openEmojiManager;
window.handleEmojiPre = handleEmojiPre;
window.saveNewEmoji = saveNewEmoji;
/**
 * ğŸ“¤ å‘é€è¡¨æƒ…æ¶ˆæ¯
 * @param {string} tag - è¡¨æƒ…çš„è§¦å‘å…³é”®è¯
 * ä½œç”¨ï¼šä»åº“ä¸­æå–äºŒè¿›åˆ¶æ•°æ®ï¼Œå°å­˜ä¸ºæ¶ˆæ¯èŠ‚ç‚¹å¹¶æ¸²æŸ“
 */
async function sendEmojiMessage(tag) {
    console.log(`%c[Signal] æ­£åœ¨æå–è¡¨æƒ…ç‰‡æ®µ: ${tag}`, "color: #007AFF; font-weight: bold;");

    const contact = window.currentChattingWith;
    if (!contact) {
        showToast("âš ï¸ æœªè¯†åˆ«åˆ°æ¥æ”¶è€…é“¾è·¯");
        return;
    }

    try {
        // 1. ç‰©ç†è¿æ¥è¡¨æƒ…æ•°æ®åº“
        const db = await openDB();
        const tx = db.transaction("emoji_library", "readonly");
        const store = tx.objectStore("emoji_library");
        
        // 2. æ£€ç´¢å¯¹åº”æ ‡ç­¾çš„å›¾åƒæ•°æ®
        const emoji = await new Promise((resolve, reject) => {
            const request = store.get(tag);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        if (!emoji) {
            showToast("âŒ ç¢ç‰‡å·²ä¸¢å¤±");
            return;
        }

        // 3. æ„å»ºæ ‡å‡†æ¶ˆæ¯å¯¹è±¡ (ç±»å‹é”å®šä¸º image)
        const msgObj = {
            role: "user",
            text: emoji.data,    // è¿™é‡Œå­˜çš„æ˜¯å›¾ç‰‡çš„ Base64 æ•°æ®
            type: "image",       // ğŸš¨ æ ¸å¿ƒï¼šå¿…é¡»æ ‡è®°ä¸º image ç±»å‹ï¼Œå¦åˆ™æ¸²æŸ“å™¨ä¼šæŠŠå®ƒå½“æˆçº¯æ–‡æœ¬
            timestamp: Date.now(),
            isEmoji: true        // é¢å¤–æ ‡è®°ï¼Œæ–¹ä¾¿åæœŸåšç‰¹æ®Šå¤„ç†
        };

        // 4. ç‰©ç†å†™å…¥èŠå¤©å†å²æ•°æ®åº“
        await saveChatMessage(contact.id, msgObj);

        // 5. åŒæ­¥ UI æ¸²æŸ“
        // å¦‚æœä½ çš„æ¸²æŸ“å™¨æ”¯æŒå¢é‡æ·»åŠ ï¼Œç›´æ¥è°ƒç”¨ï¼›å¦åˆ™å…¨é‡é‡ç»˜
        if (typeof window.renderMessages === 'function') {
            window.renderMessages();
        } else if (typeof window.appendMessageToUI === 'function') {
            window.appendMessageToUI(msgObj, contact);
        }

        // 6. è‡ªåŠ¨å…³é—­è¡¨æƒ…å¼¹çª— (ä»ªå¼æ„Ÿæ”¶å°¾)
        if (typeof window.closeEmojiModal === 'function') {
            window.closeEmojiModal();
        }

        // 7. è§¦å‘å®¡è®¡ (å¦‚æœå¼€äº†è‡ªåŠ¨æ€»ç»“ï¼Œè¿™é‡Œä¼šè®°å½•)
        if (window.autoSummaryAuditor) {
            window.autoSummaryAuditor(contact.id);
        }

        console.log("âœ… è¡¨æƒ…ç‰‡æ®µå‘é€æˆåŠŸ");

    } catch (e) {
        console.error("Critical Send Error:", e);
        showToast("âš ï¸ å‘é€åè®®å†²çª: " + e.message);
    }
}

// ğŸš¨ ç‰©ç†æŒ‚è½½ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹ç”Ÿæ•ˆ
window.sendEmojiMessage = sendEmojiMessage;

// 3. ç‹¬ç«‹é€‰æ‹©ï¼šæ¨¡å‹å¼¹çª—
function openVoiceModelPicker() {
    if (!window.availableModels || window.availableModels.length === 0) {
        alert("è¯·å…ˆç‚¹å‡» FETCH æŒ‰é’®");
        return;
    }

    var opts = window.availableModels.map(function(m) {
        return { l: m.name, v: m.id };
    });

    renderNoirPicker("SELECT SPEECH MODEL", opts, function(v, l) {
        window.currentVoiceModel = v;
        document.getElementById('calib-model-display').textContent = v;
    });
}
// ğŸ§  ç¿»è¯‘æ ¸å¿ƒï¼šæŠŠç”¨æˆ·çš„å¤–è¯­ç¿»è¯‘æˆä¸­æ–‡
async function autoTranslateUserText(text) {
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "") + "/chat/completions";
    const model = localStorage.getItem('gpt_model') || "gpt-3.5-turbo";

    if (!apiKey) return ""; // æ²¡ Key å°±ä¸ç¿»äº†

    try {
        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [
                    { 
                        role: "system", 
                        // å¼ºåˆ¶æŒ‡ä»¤ï¼šåªç¿»è¯‘ï¼Œä¸è§£é‡Šï¼Œä¸åŠ æ ‡ç‚¹ä»¥å¤–çš„ç¬¦å·
                        content: "Translate the following text into Simplified Chinese. Output ONLY the translation. If it is already Chinese, output the original." 
                    },
                    { role: "user", content: text }
                ],
                temperature: 0.3
            })
        });
        const data = await res.json();
        return data.choices[0].message.content.trim();
    } catch (e) {
        console.error("Auto Trans Error:", e);
        return ""; // å¤±è´¥äº†å°±è¿”å›ç©ºï¼Œä¸å½±å“å‘é€
    }
}
/* =========================================================
   ğŸ–¼ï¸ ç›¸å†Œ App æ ¸å¿ƒé€»è¾‘ (æ ‡å‡†å‡½æ•°ç‰ˆ)
   ========================================================= */

/* =========================================================
   ğŸ–¼ï¸ ç›¸å†Œ App æ ¸å¿ƒé€»è¾‘ (ç‹¬ç«‹ä¿®å¤ç‰ˆ)
   ========================================================= */

function openPhotosApp() {
    console.log("System: æ­£åœ¨å¯åŠ¨ç›¸å†Œ...");

    // 1. ç‰©ç†è·å–å…ƒç´ 
    const app = document.getElementById('app-photos');

    // 2. é”™è¯¯æ‹¦æˆª
    if (!app) {
        console.error("âŒ æ‰¾ä¸åˆ° id='app-photos' çš„å…ƒç´ ï¼");
        return;
    }

    // 3. æ˜¾å½¢
    app.style.display = 'flex';
    void app.offsetWidth; // å¼ºåˆ¶é‡ç»˜
    app.classList.add('active');

    // 4. å°è¯•æ¸²æŸ“æ•°æ®
    if (typeof renderUserPhotos === 'function') {
        renderUserPhotos(); 
    }
}

/**
 * ğŸ”„ åˆ‡æ¢ Tab (æˆ‘çš„ / Taçš„) 
 * é€»è¾‘ï¼šæˆ‘çš„ -> æ—¶é—´è½´ç…§ç‰‡ | Taçš„ -> è§’è‰²ç›¸å†Œé›†åˆ—è¡¨
 */
async function switchPhotoTab(type) {
    const caps = document.querySelectorAll('.photos-bottom-capsule .nav-item');
    const gridView = document.getElementById('photos-grid-view');
    const emptyState = document.getElementById('photos-empty-state');
    const titleEl = document.querySelector('.photos-title-large'); // é¡¶éƒ¨å¤§æ ‡é¢˜
    const addBtn = document.querySelector('.photos-add-btn');

    // 1. åˆ‡æ¢æŒ‰é’®é«˜äº®
    if (caps.length >= 2) {
        caps[0].classList.toggle('active', type === 'mine');
        caps[1].classList.toggle('active', type === 'theirs');
    }

    if (type === 'mine') {
        if(titleEl) titleEl.textContent = "Photos";
        if(addBtn) addBtn.parentElement.style.display = 'flex'; 
        renderUserPhotos(); // åŸæœ‰çš„æ—¶é—´è½´æ¸²æŸ“
    } else {
        if(titleEl) titleEl.textContent = "Galleries";
        if(addBtn) addBtn.parentElement.style.display = 'none'; // åˆ«äººçš„ç›¸å†Œä¸è®¸ä¼ å›¾
        
        // --- ğŸš€ æ ¸å¿ƒæ¸²æŸ“ï¼šTaçš„è§’è‰²ç›¸å†Œåˆ—è¡¨ ---
        gridView.innerHTML = "";
        gridView.style.display = "block"; // å—çº§æ’ç‰ˆ
        
        const friends = await loadFromDB('chat_friends') || [];
        if (friends.length === 0) {
            gridView.innerHTML = `<div style="padding:100px 40px; text-align:center; color:#999;">å°šæœªå‘ç°å…¶ä»–ç»´åº¦çš„ç›¸å†Œè®°å½•...</div>`;
            return;
        }

        friends.forEach(f => {
            const card = document.createElement('div');
            card.className = 'char-gallery-card';
            
            // æ¨¡æ‹Ÿç…§ç‰‡æ•°é‡ï¼ˆæˆ–è€…ä½ ä»¥åå¯ä»¥çœŸçš„å­˜ Ta å‘çš„ç…§ç‰‡æ•°é‡ï¼‰
            const mockCount = Math.floor(Math.random() * 20) + 5;

            card.innerHTML = `
                <div class="gallery-card-bg" style="background-image: url('${f.avatar}')"></div>
                <div class="gallery-card-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <div class="gallery-card-info">
                    <div class="gallery-char-name">${f.name}</div>
                    <div class="gallery-photo-count">${mockCount} PIXELS</div>
                </div>
            `;
            
            card.onclick = () => openCharGallery(f);
            gridView.appendChild(card);
        });
    }
    if (type === 'mine') {
        renderUserPhotos();
    } else {
        renderTheirsGalleries(); // ğŸ‘ˆ è°ƒç”¨é‡å¡‘åçš„æ¸²æŸ“å¼•æ“
    }
}

// ğŸ“¸ ä¿®æ­£ï¼šç»Ÿè®¡ AI ç”Ÿæˆçš„ç…§ç‰‡æ•°é‡ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡
async function renderTheirsGalleries() {
    const gridView = document.getElementById('photos-grid-view');
    if (!gridView) return;

    // ğŸš¨ æ ¸å¿ƒä¿®æ­£ï¼šè¯»å– AI è§’è‰²ç…§ç‰‡åº“
    const friends = await loadFromDB('chat_friends') || [];
    const aiPhotos = JSON.parse(localStorage.getItem('user_char_galleries')) || [];

    gridView.innerHTML = "";
    gridView.style.display = "block"; 

    if (friends.length === 0) {
        gridView.innerHTML = `<div style="padding:100px 40px; text-align:center; color:#999;">å°šæœªæ•è·åˆ°å…¶ä»–ç»´åº¦çš„ç”»å†Œ...</div>`;
        return;
    }

    friends.forEach(f => {
        // ğŸš¨ æ ¸å¿ƒé€»è¾‘ï¼šç²¾å‡†ç­›é€‰å±äºå½“å‰è§’è‰²çš„ AI ç¬é—´æ•°é‡
        const charPhotoCount = aiPhotos.filter(p => p.charId === f.id).length;
        
        const card = document.createElement('div');
        card.className = 'char-gallery-card';
        
        card.innerHTML = `
            <div class="gallery-inner-container">
                <div class="gallery-card-bg" style="background-image: url('${f.avatar}')"></div>
                <div class="gallery-top-info">
                    <span class="gallery-type-tag">Exclusive Gallery</span>
                </div>
                <div class="gallery-info-pod">
                    <div class="gallery-char-name">${f.name}</div>
                    <div class="gallery-stat-chip">
                        <span class="stat-num">${charPhotoCount}</span>
                        <span class="stat-label">PIXELS</span>
                    </div>
                </div>
            </div>
        `;
        
        card.onclick = () => openCharGallery(f);
        gridView.appendChild(card);
    });
}

/**
 * 1. å¼€å¯è§’è‰²ç›¸å†Œå±•å…
 */
async function openCharGallery(char) {
    window.currentViewingChar = char;
    document.getElementById('gallery-char-name-ui').textContent = char.name;
    document.getElementById('gallery-char-bio-ui').textContent = char.desc || "æ­¤äººæ ¼å°šæœªå†™å…¥åº•å±‚å™äº‹ã€‚";
    
    generateCharBioIntro(char);
    
    // åŠ è½½å†å²ç…§ç‰‡
    renderCharHistoryGrid(char.id);
    
    openSubPage('page-char-gallery');
}

// --- [Core] AI Generation Logic ---

// å…³é”®ä¿®æ”¹ï¼šå¢åŠ  injectedTime å‚æ•°ï¼Œä¸å†è‡ªå·± new Date()
async function generateAIPortrait(injectedTime) {
    // å¦‚æœæ˜¯æ‰‹åŠ¨ç‚¹å‡»è§¦å‘ï¼Œå¯èƒ½æ²¡æœ‰ä¼ å‚ï¼Œæ‰‹åŠ¨è¡¥ä¸€ä¸ª
    if (!injectedTime) injectedTime = getAppLocalTime();

    const char = window.currentViewingChar;
    const container = document.getElementById('ai-portrait-container');
    const scanLine = document.getElementById('ai-scan-line');
    const proseEl = document.getElementById('theirs-prose-body'); 
    
    console.log(`ğŸ“¸ AI Generating for: ${char.name} at Time: ${injectedTime.fullString}`);

    // UI æ˜¾ç¤ºé€»è¾‘
    if (container) container.style.display = 'block';
    if (scanLine) {
        scanLine.style.display = 'block';
        scanLine.style.background = "linear-gradient(to right, transparent, #007AFF, transparent)";
    }
    
    const proseUi = document.getElementById('ai-prose-ui');
    if (proseUi) proseUi.innerHTML = `<div class="ai-prose-text" style="opacity:0.5">Syncing ${char.name}'s data stream...</div>`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯æ·±å¤œ (0ç‚¹åˆ°5ç‚¹)
        const isMidnight = injectedTime.hour >= 0 && injectedTime.hour < 5;

        // ğŸ§  æ ¸å¿ƒ Promptï¼šå¼ºåˆ¶éäººç±»è§†è§’ & æ³¨å…¥å‡†ç¡®æ—¶é—´
        const prompt = `
# Role: é¡¶çº§ç§‘å¹»å°è¯´å®¶ / èµ›åšæœ‹å…‹è§†è§‰å¯¼æ¼”
# Task: åŸºäºç²¾å‡†æ—¶é—´ï¼Œç”Ÿæˆè§’è‰² [${char.name}] çš„å®æ—¶çŠ¶æ€â€œå¿«ç…§â€ã€‚

# Context (Absolute Truth):
- User Timezone: ${appSettings.userTimezone}
- Current Time: ${injectedTime.aiString} (24h format)
- Mode: ${isMidnight ? 'Midnight / Maintenance / Standby' : 'Active / Processing'}

# Character Settings:
${char.desc}
(WARNING: strict adherence to non-human traits if applicable. If character is AI/Code/App, describe data flows, server racks, silent cooling fans, binary streams. DO NOT describe human sleep, skin, or breathing.)

# Instruction:
è¾“å‡ºä¸€æ®µ 100 å­—å·¦å³çš„æè‡´å”¯ç¾æå†™ã€‚
1. **å†…å®¹**: æ¯”å¦‚â€œ00:00ï¼Œæ•°æ®å½’æ¡£å®Œæˆï¼Œåå°è¿›ç¨‹é™é»˜ï¼ŒæŒ‡ç¤ºç¯å¦‚å‘¼å¸èˆ¬é—ªçƒâ€ã€‚
2. **æ–‡é£**: å†·å³»ã€ç”µå­æ„Ÿã€é«˜æ™ºå•†ã€‚
3. **æ ¼å¼**: ç›´æ¥è¾“å‡ºæ­£æ–‡ï¼Œä¸è¦ Emojiï¼Œä¸è¦è§£é‡Šã€‚
`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [
                    { role: "system", content: "You are a digital consciousness observer. You strictly describe non-human characters using technological metaphors (data, electricity, light), not biological ones." }, 
                    { role: "user", content: prompt }
                ],
                temperature: 0.8
            })
        });

        const data = await res.json();
        if (!data.choices) throw new Error("API Response Empty");
        const description = data.choices[0].message.content.trim();

        // å­˜æ¡£é€»è¾‘
        const newSnap = {
            id: "snap_" + Date.now(),
            charId: char.id,
            type: "portrait",
            description: description,
            date: Date.now(),
            displayTime: injectedTime.fullString, // å­˜å…¥å½“æ—¶çš„æ—¶é—´å­—ç¬¦ä¸²
            thumb: char.avatar
        };

        let galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
        galleryDB.unshift(newSnap);
        localStorage.setItem('user_char_galleries', JSON.stringify(galleryDB));

        // UI æ¸²æŸ“
        if (proseEl) proseEl.innerHTML = `<div class="ai-prose-text">${description}</div>`;
        if (typeof renderCharHistoryGrid === 'function') renderCharHistoryGrid(char.id);
        if (scanLine) scanLine.style.display = 'none';
        
        // æˆåŠŸæç¤º
        console.log("âœ… ç”ŸæˆæˆåŠŸ");

    } catch (e) {
        console.error("AI Error:", e);
        if (scanLine) scanLine.style.display = 'none';
        if (proseEl) proseEl.innerHTML = `<div class="ai-prose-text" style="color:red; opacity:0.7">Link Lost.</div>`;
    }
}

/**
 * ğŸï¸ æ¸²æŸ“å†å²ç¼©ç•¥å›¾ï¼šåŠ å…¥å¹´æœˆæ—¥æ—¶é—´è½´æ ‡ç­¾
 */
function renderCharHistoryGrid(charId) {
    const grid = document.getElementById('char-gallery-history');
    const galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    // ç­›é€‰å½“å‰è§’è‰²çš„ç…§ç‰‡
    const charPhotos = galleryDB.filter(p => p.charId === charId);
    
    if (!grid) return;
    grid.innerHTML = "";

    if (charPhotos.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#ccc; font-style:italic; font-size:12px;">â€œæ­¤é—´çš„æ—¶å…‰å°šæœªå‡å›º...â€</div>`;
        return;
    }

    charPhotos.forEach(p => {
        const div = document.createElement('div');
        div.className = 'history-thumb';
        
        // ğŸš¨ ç‰©ç†è®¡ç®—ï¼šå°†æ—¶é—´æˆ³è½¬æ¢ä¸º å¹´.æœˆ.æ—¥ æ ¼å¼
        const d = new Date(p.date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const dateString = `${year}.${month}.${day}`; // æ ¼å¼å¦‚ï¼š2026.01.27

        const briefDesc = p.description ? p.description.substring(0, 10) + "..." : "Untitled";

        div.innerHTML = `
            <div class="thumb-date-tag">${dateString}</div>
            
            <img class="history-thumb-img" src="${p.thumb}">
            <div class="thumb-caption">${briefDesc}</div>
        `;
        
        div.onclick = () => openPhotoDetailFromGallery(p);
        grid.appendChild(div);
    });
}
/**
 * ğŸ” å¼€å¯â€œTaçš„â€ç›¸å†Œè¯¦æƒ…
 */
async function openPhotoDetailFromGallery(snap) {
    window.currentViewingSnapId = snap.id; 
    
    const modal = document.getElementById('modal-theirs-photo-detail');
    const proseEl = document.getElementById('theirs-prose-body');
    const bgEl = document.getElementById('theirs-detail-bg');
    const nameEl = document.getElementById('theirs-char-name');

    // 1. è·å–è§’è‰²æœ€æ–°èµ„æ–™å¹¶ç‰©ç†å¡«å……
    const charList = await loadFromDB('char_list') || [];
    const char = charList.find(c => c.id === snap.charId);
    
    if (nameEl) nameEl.textContent = char ? char.name : "æœªçŸ¥è§’è‰²";
    if (proseEl) proseEl.textContent = snap.description;
    
    // ğŸš¨ æ ¸å¿ƒèƒŒæ™¯ä¿®å¤ï¼šå¦‚æœæ²¡å›¾ï¼Œç”¨é¢œè‰²ä»£æ›¿ï¼Œé˜²æ­¢å‡ºç°ç©ºç™½æˆ–é€å‡ºæ¡Œé¢
    if (bgEl && char) {
        bgEl.style.backgroundImage = `url('${char.avatar}')`;
    } else {
        bgEl.style.background = "#1d1d1f"; 
    }
    
    document.getElementById('theirs-date-title').textContent = new Date(snap.date).toLocaleDateString();
    
    // 2. æ¸²æŸ“è¯„è®º
    if (typeof renderTheirsComments === 'function') renderTheirsComments(snap);

    // 3. ğŸš¨ ç‰©ç†éš”ç¦»ï¼šéšè—ä¸»é¡µå®¹å™¨çš„äº¤äº’
    const homeContainer = document.querySelector('.home-screen-scroll-container');
    if (homeContainer) homeContainer.style.visibility = 'hidden'; // æš‚æ—¶è®©ä¸»é¡µå½»åº•æ¶ˆå¤±

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    if (nameEl) {
        nameEl.style.cursor = "pointer";
        nameEl.onclick = () => mentionChar(nameEl.textContent);
    }
    // åœ¨ openPhotoDetailFromGallery ç»“å°¾å¤„
    document.getElementById('theirs-char-name').onclick = mentionTheirsChar;
}

// 4. å…³é—­æ—¶æ¢å¤ä¸»é¡µ
function closeTheirsPhotoDetail() {
    document.getElementById('modal-theirs-photo-detail').style.display = 'none';
    const homeContainer = document.querySelector('.home-screen-scroll-container');
    if (homeContainer) homeContainer.style.visibility = 'visible'; // æ¢å¤ä¸»é¡µ
    document.body.style.overflow = '';
}

/**
 * ğŸ”— è‡ªåŠ¨è‰¾ç‰¹åŠŸèƒ½
 */
function mentionChar(charName) {
    const input = document.getElementById('theirs-reply-input');
    if (!input) return;
    
    // ç‰©ç†æ³¨å…¥è‰¾ç‰¹æ–‡æœ¬ï¼Œå¹¶è®©è¾“å…¥æ¡†è·å–ç„¦ç‚¹
    input.value = `@${charName} `;
    input.focus();
    
    // å¢åŠ ä¸€ä¸ªå¾®å¼±çš„éœ‡åŠ¨åé¦ˆ
    if (navigator.vibrate) navigator.vibrate(10);
    
    showToast(`æ­£åœ¨å‘¼å”¤ ${charName}...`);
}

/**
 * ğŸ’¬ å‘é€è¯„è®ºå¹¶è§¦å‘ AI å›å¤
 */
async function sendCommentToTheirs() {
    const input = document.getElementById('theirs-reply-input');
    const text = input.value.trim();
    if (!text) return;

    const char = window.currentViewingChar;
    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šåœ¨è¿™é‡Œå®šä¹‰ isMentioned
    const isMentioned = text.includes(`@${char.name}`);

    // 1. ç”¨æˆ·è¯„è®ºä¸Šå±
    const userPersona = JSON.parse(localStorage.getItem('user_persona_data_global')) || {name: "æˆ‘"};
    const newComment = {
        name: userPersona.name,
        avatar: userPersona.avatar,
        text: text,
        time: Date.now()
    };
    
    appendTheirsCommentUI(newComment);
    input.value = "";

    // 2. é©±åŠ¨ AI å›å¤ (ä¼ é€’å®šä¹‰çš„å˜é‡)
    setTimeout(async () => {
        // ğŸš¨ ç¡®ä¿è¿™é‡Œä¼ å…¥äº† isMentioned
        const reply = await callAIForPhotoReply(char, text, isMentioned); 
        const aiComment = {
            name: char.name,
            avatar: char.avatar,
            text: reply,
            time: Date.now()
        };
        appendTheirsCommentUI(aiComment);
        
        if (isMentioned) {
            triggerSuccessHud(`${char.name} å“åº”äº†ä½ `);
        }
    }, 1500);
}


/**
 * ğŸ¨ è¡¥å…¨æ¸²æŸ“å¼•æ“ï¼šæ¸²æŸ“â€œTaçš„â€ç›¸å†Œè¯„è®º
 */
function renderTheirsComments(snap) {
    const list = document.getElementById('theirs-comments-list');
    if (!list) return;
    list.innerHTML = "";

    const galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    const currentSnap = galleryDB.find(p => p.id === snap.id) || snap;
    const comments = currentSnap.comments || [];

    comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment-row';
        
        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç»™æ•´è¡Œæˆ–è€…å¤´åƒ/åå­—ç»‘å®š mentionTheirsChar
        // é€»è¾‘ï¼šå¦‚æœæ˜¯ç”¨æˆ·å‘çš„ï¼ˆc.userId === 'user'ï¼‰ï¼Œä¸è‰¾ç‰¹ï¼›å¦‚æœæ˜¯ Ta å‘çš„ï¼Œç‚¹å‡»å³è‰¾ç‰¹
        const isUser = c.name === "æˆ‘" || c.userId === "user"; 
        const clickAction = !isUser ? `onclick="mentionTheirsChar('${c.name}')"` : "";

        div.innerHTML = `
            <img class="comment-avatar" src="${c.avatar}" ${clickAction} style="cursor:pointer;">
            <div class="comment-bubble" ${clickAction} style="cursor:pointer; background: rgba(0,0,0,0.03);">
                <div class="comment-name">${c.name} <span class="comment-time">${new Date(c.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div>
                <div style="word-break: break-all;">${c.text}</div>
            </div>
        `;
        list.appendChild(div);
    });

    // è‡ªåŠ¨æ»šåŠ¨åˆ°è¯„è®ºåŒºçš„æœ€åº•éƒ¨
    list.scrollTop = list.scrollHeight;
}

/**
 * ğŸ¤– ä¿®æ­£ç‰ˆ AI å›å¤æ ¸å¿ƒ
 */
async function callAIForPhotoReply(char, userText, isMentioned = false) {
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
    
    // ğŸ§  åŠ¨æ€æ„å»ºæ›´æœ‰â€œé’ˆå¯¹æ€§â€çš„ Prompt
    let promptContext = `ä½ æ˜¯ [${char.name}]ã€‚èº«ä»½èƒŒæ™¯: ${char.desc}ã€‚ç”¨æˆ·åœ¨ä½ çš„ç…§ç‰‡ä¸‹è¯„è®ºï¼šâ€œ${userText}â€ã€‚`;
    
    if (isMentioned) {
        promptContext += ` æ³¨æ„ï¼šç”¨æˆ·ç‰¹åˆ« @è‰¾ç‰¹ äº†ä½ ï¼Œè¯´æ˜ Ta æ¸´æœ›ä½ çš„ä¸“å±å›åº”ã€‚ä½ çš„è¯­æ°”è¦æ›´äº²æ˜µã€æ›´å…·äº’åŠ¨æ„Ÿï¼Œå¯ä»¥å¸¦ä¸€ç‚¹ç‚¹è¢«åçˆ±çš„ç¾æ¶©æˆ–éœ¸æ°”ã€‚`;
    }

    const prompt = `${promptContext}
    è¦æ±‚ï¼š
    1. 20å­—ä»¥å†…ï¼Œç¬¦åˆäººè®¾ï¼Œåƒåœ¨æœ‹å‹åœˆäº’åŠ¨ã€‚
    2. ä¸¥ç¦ä½¿ç”¨æ‹¬å·å’Œæ˜Ÿå·ã€‚
    3. ç›´æ¥è¾“å‡ºå›å¤æ­£æ–‡ã€‚`;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });
        const data = await res.json();
        return data.choices[0].message.content.trim();
    } catch (e) {
        return isMentioned ? `æˆ‘åœ¨å‘¢ï¼Œ${char.name} æ”¶åˆ°ä½ çš„å‘¼å”¤äº†ã€‚` : "ï¼ˆå¾®ç¬‘ç€çœ‹ç€ä½ çš„è¯„è®ºï¼‰";
    }
}
/**
 * ğŸ”— ç‚¹å‡»åå­—/å¤´åƒè‡ªåŠ¨è‰¾ç‰¹
 */
function mentionTheirsChar() {
    const nameEl = document.getElementById('theirs-char-name');
    const input = document.getElementById('theirs-reply-input');
    if (!nameEl || !input) return;

    const charName = nameEl.textContent;
    input.value = `@${charName} `;
    input.focus();
    
    if (navigator.vibrate) navigator.vibrate(10);
    showToast(`æ­£åœ¨å‘¼å”¤ ${charName}...`);
}

/**
 * ğŸ“¥ è¡¥å…¨ UI æ’å…¥ï¼šå°†æ–°è¯„è®ºæ³¨å…¥å¹¶ä¿å­˜
 */
async function appendTheirsCommentUI(newComment) {
    const snapId = window.currentViewingSnapId; // ç¡®ä¿åœ¨æ‰“å¼€è¯¦æƒ…æ—¶è®°å½•äº† ID
    let galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    const idx = galleryDB.findIndex(p => p.id === snapId);
    
    if (idx !== -1) {
        if (!galleryDB[idx].comments) galleryDB[idx].comments = [];
        galleryDB[idx].comments.push(newComment);
        localStorage.setItem('user_char_galleries', JSON.stringify(galleryDB));
        
        // é‡æ–°è°ƒç”¨æ¸²æŸ“ï¼Œä¿æŒä¸€è‡´æ€§
        renderTheirsComments(galleryDB[idx]);
    }
}
/**
 * 3. æ‰“å¼€ä¸Šä¼ å¼¹çª—
 */
// âœ… ä¿®å¤ï¼šä½¿ç”¨ var å£°æ˜ï¼Œé˜²æ­¢åˆå§‹åŒ–æŠ¥é”™
var selectedPhotoCharId = null;

// 1. æ‰“å¼€ä¸Šä¼ å¼¹çª—
async function openPhotoUploadModal() {
    const modal = document.getElementById('modal-photo-upload');
    const container = document.getElementById('char-selector-container');
    
    if (!modal || !container) return;

    // é‡ç½®ç•Œé¢
    const descInput = document.getElementById('upload-desc-input');
    const imgPreview = document.getElementById('upload-img-preview');
    const placeholder = document.getElementById('upload-placeholder');
    
    if (descInput) descInput.value = "";
    if (imgPreview) imgPreview.style.display = 'none';
    if (placeholder) placeholder.style.display = 'flex';
    
    // é‡ç½®é€‰ä¸­çŠ¶æ€
    selectedPhotoCharId = null; 
    // åŒæ—¶æ¸…é™¤ UI ä¸Šçš„é€‰ä¸­æ•ˆæœ
    const items = document.querySelectorAll('.char-select-item');
    if (items) items.forEach(el => el.classList.remove('active'));

    // æ˜¾ç¤ºå¼¹çª—
    modal.style.display = 'flex';

    // ğŸš€ æ¸²æŸ“é«˜çº§å¤´åƒåˆ—è¡¨
    container.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
    
    // è·å–å¥½å‹åˆ—è¡¨ (ä¼˜å…ˆ) æˆ– è§’è‰²ä¹¦åˆ—è¡¨
    let friends = [];
    if (typeof loadFromDB === 'function') {
        friends = await loadFromDB('chat_friends') || [];
        if (friends.length === 0) {
            // å¦‚æœæ²¡åŠ å¥½å‹ï¼Œå°±ä»è§’è‰²ä¹¦é‡Œæ‹‰äºº
            friends = await loadFromDB('char_list') || [];
        }
    }

    if (friends.length === 0) {
        container.innerHTML = `<div style="font-size:13px; color:#ccc; padding:10px;">æš‚æ— å¥½å‹ï¼Œè¯·å…ˆå»æ·»åŠ è§’è‰²</div>`;
        return;
    }

    // éå†æ¸²æŸ“
    friends.forEach(f => {
        const item = document.createElement('div');
        item.className = 'char-select-item'; // é»˜è®¤æ˜¯ç°è‰²çš„
        item.innerHTML = `
            <img class="char-select-avatar" src="${f.avatar}">
            <span class="char-select-name">${f.name}</span>
        `;
        
        // ç‚¹å‡»äº‹ä»¶
        item.onclick = function() {
            // 1. è§†è§‰åˆ‡æ¢ï¼šå…ˆæŠŠåˆ«äººçš„ active å»æ‰
            document.querySelectorAll('.char-select-item').forEach(el => el.classList.remove('active'));
            // 2. ç»™è‡ªå·±åŠ ä¸Š active (å˜äº®ã€å˜è“)
            item.classList.add('active');
            // 3. è®°å½• ID
            selectedPhotoCharId = f.id;
            
            // éœ‡åŠ¨åé¦ˆ
            if(navigator.vibrate) navigator.vibrate(10);
        };
        
        container.appendChild(item);
    });
}

/**
 * ğŸ“¤ 2. ç»ˆæå‘å¸ƒå¼•æ“ (å…¨é“¾è·¯å¼‚æ­¥é”æ­»ç‰ˆ)
 * é€»è¾‘ï¼šå³æ—¶åé¦ˆ -> ç‰©ç†å‹ç¼© -> å¼‚æ­¥å…¥åº“ -> è‡ªåŠ¨é‡ç»˜ -> å”¤èµ·è¯¦æƒ…
 */
async function submitPhotoUpload() {
    const publishBtn = document.querySelector('.highlight-btn');
    const imgPreview = document.getElementById('upload-img-preview');
    const descInput = document.getElementById('upload-desc-input');
    
    // ğŸ›¡ï¸ ç‰©ç†é”ï¼šç½®ç°åé¦ˆå¹¶ç¦æ­¢äºŒæ¬¡ç‚¹å‡»
    if (publishBtn) {
        publishBtn.style.opacity = '0.5';
        publishBtn.style.pointerEvents = 'none';
    }
    
    if (typeof showToast === 'function') showToast("æ­£åœ¨åˆ»å½•æ—¶ç©ºç‰‡æ®µ...");

    try {
        // 1. ç‰©ç†æ£€æŸ¥ï¼šç¡®ä¿æ•°æ®æºå­˜åœ¨
        if (!imgPreview || !imgPreview.src || imgPreview.style.display === 'none') {
            throw new Error("è¯·å…ˆé€‰å–ä¸€å¼ ç…§ç‰‡");
        }
        if (!selectedPhotoCharId) {
            throw new Error("è¯·ç‚¹å‡»å¤´åƒé‚€è¯·ä¸€ä½å¥½å‹");
        }

        // 2. ğŸš¨ ç‰©ç†å‹ç¼©ï¼šè§£å†³æ‰‹æœºç«¯â€œå‘å¸ƒæ— ååº”â€çš„å¤´å·æ€æ‰‹
        const compressedImg = await compressImage(imgPreview.src, 1080); 
        console.log("âœ… å›¾åƒé«˜ç»´å‹ç¼©åè®®å®Œæˆ");

        // 3. æ„é€ æ•°æ®å­˜æ ¹
        const newPhotoId = "p_" + Date.now();
        const newPhoto = {
            id: newPhotoId,
            src: compressedImg, // å­˜å…¥ä¼˜åŒ–åçš„æ•°æ®
            desc: descInput ? descInput.value : "åˆ†äº«äº†ä¸€å¼ ç…§ç‰‡",
            date: Date.now(),
            charId: selectedPhotoCharId, 
            comments: []
        };

        // 4. ğŸš¨ æ ¸å¿ƒå…¥åº“ï¼šå¿…é¡» await å­˜å…¥æˆåŠŸï¼Œé˜²æ­¢é€»è¾‘æ–­å±‚
        let myPhotos = await loadFromDB('user_my_photos') || [];
        myPhotos.unshift(newPhoto);
        await saveToDB('user_my_photos', myPhotos); 

        // 5. UI çŠ¶æ€æ”¶å°¾
        const uploadModal = document.getElementById('modal-photo-upload');
        if (uploadModal) uploadModal.style.display = 'none';
        
        // ğŸš¨ å¼ºåˆ¶é‡ç»˜åˆ—è¡¨ï¼šè®©æ–°ç…§ç‰‡å‡ºç°åœ¨èƒŒæ™¯ç½‘æ ¼ä¸­
        if (typeof renderUserPhotos === 'function') {
            await renderUserPhotos();
        }

        // 6. å»¶æ—¶ 200ms å”¤èµ·è¯¦æƒ…ï¼šé¿å¼€æ‰‹æœºå†…å­˜å¤„ç†å³°å€¼ï¼Œç¡®ä¿ä¸æ»‘
        setTimeout(() => {
            if (window.triggerSuccessHud) triggerSuccessHud("å·²å­˜å…¥ç›¸å†Œ");
            if (typeof openPhotoDetail === 'function') openPhotoDetail(newPhotoId); 
            
            // å‘å¸ƒæˆåŠŸåé‡ç½®è¾“å…¥æ¡†çŠ¶æ€ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
            if(descInput) descInput.value = "";
        }, 200);

        // 7. è§¦å‘ AI å¼‚æ­¥è¯„è®ºï¼ˆåŸºäºå½“å‰è§’è‰²äººè®¾ä¸ç”¨æˆ·å…³ç³»ï¼‰
        setTimeout(() => {
            if (typeof generateAIPhotoComment === 'function') {
                generateAIPhotoComment(newPhoto);
            }
        }, 1500);

    } catch (e) {
        // æ‰‹æœºç«¯ç›´æ¥ alert æ˜¯æœ€æœ‰æ•ˆçš„æ‹¦æˆªæç¤º
        alert("âš ï¸ åè®®å¼‚å¸¸: " + e.message);
    } finally {
        // æ¢å¤æŒ‰é’®ç‚¹å‡»æƒé™
        if (publishBtn) {
            publishBtn.style.opacity = '1';
            publishBtn.style.pointerEvents = 'auto';
        }
    }
}

/**
 * 5. å¤„ç†æ–‡ä»¶é€‰æ‹© (è½¬ Base64)
 */
function handlePhotoFileSelect(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('upload-img-preview');
            const placeholder = document.getElementById('upload-placeholder');
            
            if (img) {
                img.src = e.target.result;
                img.style.display = 'block';
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
}

/**
 * ğŸ–¼ï¸ æ¸²æŸ“å¼•æ“ï¼šä»å¤§ä»“åº“å¼‚æ­¥æŠ“å–ç…§ç‰‡æµ
 */
async function renderUserPhotos() {
    const grid = document.getElementById('photos-grid-view');
    if (!grid) return;

    // ğŸš¨ ç‰©ç†å¯¹é½ï¼šæ”¹ä» IndexedDB æŠ“å–
    const myPhotos = await loadFromDB('user_my_photos') || [];
    grid.innerHTML = "";
    grid.style.display = "block"; 

    if (myPhotos.length === 0) {
        const emptyState = document.getElementById('photos-empty-state');
        if(emptyState) emptyState.style.display = 'flex';
        return;
    }
    if(document.getElementById('photos-empty-state')) 
        document.getElementById('photos-empty-state').style.display = 'none';

    // ğŸ—“ï¸ æ—¶é—´è½´åˆ†ç»„é€»è¾‘ä¿æŒä¸å˜
    const groups = {};
    myPhotos.forEach(p => {
        const date = new Date(p.date);
        const dateKey = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        if (!groups[dateKey]) groups[dateKey] = [];
        groups[dateKey].push(p);
    });

    Object.keys(groups).forEach(dateKey => {
        const section = document.createElement('div');
        section.className = 'photos-timeline-section';
        section.innerHTML = `
            <div class="timeline-header">${dateKey} <span>${groups[dateKey].length}</span></div>
            <div class="photos-grid"></div> 
        `;
        const subGrid = section.querySelector('.photos-grid');
        groups[dateKey].forEach(p => {
            const item = document.createElement('div');
            item.className = 'photo-item';
            item.innerHTML = `<img src="${p.src}" loading="lazy">`;
            item.onclick = () => openPhotoDetail(p.id);
            subGrid.appendChild(item);
        });
        grid.appendChild(section);
    });
}

/**
 * ğŸ” å¼€å¯è¯¦æƒ…é¡µï¼šç‰©ç†å®šä½ DB ä¸­çš„å­˜æ ¹
 */
async function openPhotoDetail(pid) {
    // ğŸš¨ ç‰©ç†å¯¹é½ï¼šå¼‚æ­¥è·å–å¤§å®¹é‡æ•°æ®
    const myPhotos = await loadFromDB('user_my_photos') || [];
    const photo = myPhotos.find(p => p.id === pid);
    
    if (!photo) {
        console.error("æ— æ³•å®šä½ç…§ç‰‡ ID:", pid);
        return;
    }
    
    const mask = document.getElementById('photo-detail-mask');
    const modal = document.getElementById('modal-photo-detail');
    const scroller = modal.querySelector('.card-main-scroller');
    
    if (!mask || !modal) return;

    // æ•°æ®å¡«å……
    document.getElementById('detail-main-img').src = photo.src;
    document.getElementById('detail-desc-text').textContent = photo.desc;
    
    const d = new Date(photo.date);
    document.getElementById('detail-date-title').textContent = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;

    // è®°å½•å½“å‰ ID ä¾›åç»­åˆ é™¤/è¯„è®ºä½¿ç”¨
    modal.dataset.pid = pid;
    
    // é©±åŠ¨è¯„è®ºæ¸²æŸ“
    if (typeof renderPhotoComments === 'function') renderPhotoComments(photo);

    if (scroller) scroller.scrollTop = 0;

    // åŠ¨ç”»å¯åŠ¨
    mask.style.display = 'flex';
    modal.style.display = 'flex';
    setTimeout(() => {
        mask.classList.add('active');
        document.body.style.overflow = 'hidden';
    }, 20);
}

function closePhotoDetailModal() {
    const mask = document.getElementById('photo-detail-mask');
    if (!mask) return;
    
    mask.classList.remove('active');
    document.body.style.overflow = ''; // è§£æ”¾ä¸»å±å¹•æ»šåŠ¨
    
    setTimeout(() => {
        mask.style.display = 'none';
    }, 450); // ç­‰å¾…å¼¹æ€§åŠ¨ç”»å®Œæˆ
}

/**
 * ğŸ¨ è¯„è®ºåŒºæ¸²æŸ“å¼•æ“
 * é€»è¾‘ï¼šæ¸…ç©ºæ—§ç¢ç‰‡ -> ç‰©ç†æ’åº -> æ³¨å…¥æ–°å›å“
 */
function renderPhotoComments(photoData) {
    const list = document.getElementById('detail-comments-list');
    if (!list) return;

    list.innerHTML = ""; // å½»åº•æ¸…ç©º

    if (!photoData.comments || photoData.comments.length === 0) {
        list.innerHTML = `<div style="padding:40px 20px; text-align:center; color:#ccc; font-size:12px; font-style:italic;">â€œé™é»˜ä¸­ï¼Œç­‰å¾…ç€å‘½è¿çš„å›å“...â€</div>`;
        return;
    }

    // æ¸²æŸ“æ¯ä¸€æ¡è¯„è®º
    const html = photoData.comments.map(c => `
        <div class="comment-row" style="animation: msgFadeUp 0.4s ease-out forwards;">
            <img class="comment-avatar" src="${c.avatar}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
            <div class="comment-bubble" style="background:rgba(0,0,0,0.03); padding:10px 14px; border-radius:14px; border-top-left-radius:2px; flex:1;">
                <div class="comment-name" style="font-weight:800; font-size:12px; margin-bottom:4px; color:#1d1d1f;">${c.name}</div>
                <div style="font-size:14px; color:#3a3a3c; line-height:1.5;">${c.text}</div>
            </div>
        </div>
    `).join('');

    list.innerHTML = html;

    // ç‰©ç†å¹³æ»‘ç½®åº•
    setTimeout(() => {
        const scroller = document.querySelector('.theirs-interaction-pod');
        if(scroller) scroller.scrollTo({ top: scroller.scrollHeight, behavior: 'smooth' });
    }, 100);
}

/**
 * ğŸš€ è”è§‰ç‰ˆï¼šAI è‡ªåŠ¨è¯„è®ºå¼•æ“ (ç»ˆæç‰©ç†åŠ å›ºç‰ˆ)
 * é€»è¾‘ï¼šæå–è§’è‰²äººè®¾ + æå–ç”¨æˆ·èº«ä»½ + ç‰©ç†é”å®šå…³ç³»çº¿ + IndexedDB å®æ—¶åŒæ­¥
 */
async function generateAIPhotoComment(photo, replyContext = null) {
    // 1. ç‰©ç†æå–è§’è‰²æ•°æ®
    const charList = await loadFromDB('char_list') || [];
    const char = charList.find(c => c.id === photo.charId);
    
    if (!char) {
        console.warn("System: æœªæ‰¾åˆ°å…³è”è§’è‰²ï¼Œè¯„è®ºåè®®æŒ‚èµ·");
        return;
    }

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šç²¾å‡†æå–è¯¥è§’è‰²çœ¼ä¸­çš„â€œæˆ‘â€ (ä¼˜å…ˆè§’è‰²ä¸“å±èº«ä»½ï¼Œæ¬¡é€‰å…¨å±€èº«ä»½)
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "æˆ‘", bio: "ä¸€ä¸ªèº«ä»½ä¸æ˜çš„è§‚å¯Ÿè€…" };

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");

    if (!apiKey) return;

    // ğŸ§  æ·±åº¦å®¿å‘½æ„Ÿ Prompt æ³¨å…¥ (ä¿æŒåŸæœ‰é€»è¾‘)
    const systemPrompt = `
# Role: ä½ æ˜¯ [${char.name}]
# Character Background: ${char.desc}
# Your Counterpart (User): [${userPersona.name}]
# Your Bond/Relationship: ${userPersona.bio}

# Context:
ä½ æ­£åœ¨ç¿»é˜… [${userPersona.name}] çš„ç§å¯†ç›¸å†Œã€‚å¯¹æ–¹åˆšå‘äº†ä¸€å¼ ç…§ç‰‡ï¼Œæè¿°ä¸ºï¼šâ€œ${photo.desc}â€ã€‚

# Task:
è¯·åŸºäºä½ çš„ã€äººè®¾ã€‘å’Œä½ å¯¹ã€${userPersona.name}ã€‘çš„ã€ç‰¹æ®Šæƒ…æ„Ÿ/ç¾ç»Šã€‘ï¼Œç»™å‡ºä¸€æ¡ç®€çŸ­çš„äº’åŠ¨è¯„è®ºã€‚

# Rules:
1. **æ‹’ç»é™Œç”Ÿæ„Ÿ**ï¼šä¸¥ç¦ä½¿ç”¨å®¢å¥—è¯ï¼Œè¯­æ°”è¦å¸¦æœ‰â€œåªæœ‰ä½ ä»¬æ‡‚â€çš„ç§å¯†æ„Ÿã€‚
2. **æ°›å›´è¦æ±‚**ï¼šæ–‡é£ç¬¦åˆ BL å®¡ç¾ï¼Œå¸¦æœ‰æš§æ˜§ã€å æœ‰æ¬²ã€æ¸©æŸ”æˆ–å®¿å‘½æ„Ÿã€‚
3. **å­—æ•°**ï¼š20å­—ä»¥å†…ï¼Œåƒå³æ—¶é€šè®¯è½¯ä»¶é‡Œçš„çœŸå®ç•™è¨€ã€‚
4. **ç¦ä»¤**ï¼šç¦æ­¢ä½¿ç”¨æ‹¬å·æè¿°åŠ¨ä½œï¼Œç›´æ¥è¾“å‡ºä½ çš„å¿ƒåº•è¯ã€‚
    `;

    try {
        // 2. è°ƒç”¨ AI æ¥å£
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "system", content: systemPrompt }, { role: "user", content: "å‘è¡¨ä½ çš„è§è§£ã€‚" }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error.message);
        
        const commentText = data.choices[0].message.content.trim();

        // 3. æ„é€ æ ‡å‡†çš„è¯„è®ºæ•°æ®å¯¹è±¡
        const newComment = {
            id: Date.now(),
            userId: char.id,
            name: char.name,
            avatar: char.avatar,
            text: commentText,
            time: Date.now()
        };

        // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå…¨é“¾è·¯ç‰©ç†å…¥åº“ (IndexedDB æ¨¡å¼)
        // å¿…é¡»ä»å¤§å®¹é‡ä»“åº“ loadï¼Œpush åå† saveï¼Œå½»åº•è§£å†³ 5MB é™åˆ¶å¯¼è‡´çš„å‘å¸ƒå¤±è´¥
        let myPhotos = await loadFromDB('user_my_photos') || [];
        const idx = myPhotos.findIndex(p => p.id === photo.id);

        if (idx !== -1) {
            myPhotos[idx].comments.push(newComment);
            await saveToDB('user_my_photos', myPhotos); 
            
            console.log(`%c[AI Trace] ${char.name} çš„å›å“å·²å½•å…¥æ•°æ®åº“`, "color: #34C759;");

            // ğŸš¨ å®æ—¶æ¸²æŸ“è¡¥ä¸ï¼šå¦‚æœè¯¦æƒ…é¡µå½“å‰æ­£å¼€å¯å¹¶å±•ç¤ºè¯¥ç…§ç‰‡ï¼Œç«‹å³æ‰§è¡Œçƒ­æ³¨å…¥
            const detailModal = document.getElementById('modal-photo-detail');
            if (detailModal && detailModal.style.display === 'flex' && detailModal.dataset.pid === photo.id) {
                if (typeof renderPhotoComments === 'function') {
                    renderPhotoComments(myPhotos[idx]);
                }
            }
            
            // å‘é€ç³»ç»Ÿé€šçŸ¥ (å¯é€‰)
            if (window.showPushNotification) {
                window.showPushNotification(char.name, "åœ¨ä½ çš„ç…§ç‰‡ä¸‹ç•™ä¸‹äº†æ–°çš„å›å“ã€‚");
            }
        }

    } catch (e) { 
        console.error("AI Comment Logic Collapsed:", e); 
    }
}

/**
 * ğŸ¤– è”è§‰ç‰ˆï¼šAI å›å¤æœºåˆ¶
 */
async function callAIForPhotoReply(char, userText, isMentioned = false) {
    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");
    
    // æå–å¯¹åº”èº«ä»½
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "æˆ‘" };

    const prompt = `
ä½ æ˜¯ [${char.name}]ã€‚èƒŒæ™¯: ${char.desc}ã€‚
ä½ æ­£åœ¨å’Œå¿ƒå°–ä¸Šçš„ [${userPersona.name}] äº’åŠ¨ã€‚
å¯¹æ–¹åˆšåˆšåœ¨è¯„è®ºåŒºå›å¤äº†ä½ ï¼šâ€œ${userText}â€ã€‚
${isMentioned ? "ğŸš¨ é‡ç‚¹ï¼šå¯¹æ–¹ç‰¹åˆ«è‰¾ç‰¹äº†ä½ ï¼Œä½ çš„å›åº”è¦æ›´æœ‰é’ˆå¯¹æ€§å’Œæƒ…æ„Ÿå¼ åŠ›ã€‚" : ""}

è¦æ±‚ï¼š
1. å»¶ç»­ä½ ä»¬çš„ã€${userPersona.bio}ã€‘å…³ç³»è®¾å®šã€‚
2. è¯­æ°”æš§æ˜§æˆ–å…·æœ‰ç‰¹å®šæ€§æ ¼è‰²å½©ï¼Œä¸¥ç¦è·¯äººæ„Ÿã€‚
3. 15å­—ä»¥å†…ã€‚
4. ç›´æ¥è¾“å‡ºæ­£æ–‡ã€‚
    `;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model'),
                messages: [{ role: "system", content: prompt }],
                temperature: 0.9
            })
        });
        const data = await res.json();
        return data.choices[0].message.content.trim();
    } catch (e) { return "â€¦â€¦ï¼ˆåªæ˜¯é™é™åœ°çœ‹ç€ä½ ï¼‰"; }
}

/**
 * 11. åˆ é™¤ç…§ç‰‡åŠŸèƒ½
 */
async function showPhotoActions() {
    const modal = document.getElementById('modal-photo-detail');
    const pid = modal.dataset.pid;

    showIOSConfirm("æŠ¹é™¤è®°å¿†", "ç¡®å®šè¦æ°¸ä¹…ç‰©ç†æŠ¹é™¤è¿™æ®µç¬é—´å—ï¼Ÿ", "æŠ¹é™¤", async function() {
        try {
            // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»ä» IndexedDB ä¸­åˆ é™¤ï¼Œè€Œä¸æ˜¯ localStorage
            let myPhotos = await loadFromDB('user_my_photos') || [];
            myPhotos = myPhotos.filter(p => p.id !== pid);
            
            // è¦†ç›–ä¿å­˜
            await saveToDB('user_my_photos', myPhotos); 
            
            // ğŸš¨ ç«‹å³æ‰§è¡Œç‰©ç†é‡ç»˜
            await renderUserPhotos();
            
            // å…³é—­è¯¦æƒ…å±‚
            closePhotoDetailModal();
            
            if (window.triggerSuccessHud) triggerSuccessHud("è®°å¿†å·²å½’äºè™šæ— ");
        } catch (e) {
            showToast("åˆ é™¤å¼‚å¸¸");
        }
    });
}

/**
 * 12. ç”¨æˆ·æ‰‹åŠ¨å›å¤ (é—­ç¯é€»è¾‘ï¼šç”¨æˆ·å›å¤ -> AI æ£€æµ‹è‰¾ç‰¹ -> AI å†å›å¤)
 */
async function sendPhotoComment() {
    const input = document.getElementById('detail-reply-input');
    const text = input ? input.value.trim() : "";
    
    if (!text) return;
    
    const pid = document.getElementById('modal-photo-detail').dataset.pid;
    const userPersona = JSON.parse(localStorage.getItem('user_persona_data_global')) || {name:"æˆ‘", avatar:""};
    
    // 1. æ„é€ ç”¨æˆ·è¯„è®º
    const newComment = {
        id: Date.now(),
        userId: "user",
        name: userPersona.name || "æˆ‘",
        avatar: userPersona.avatar || "https://api.dicebear.com/7.x/initials/svg?seed=User",
        text: text,
        time: Date.now()
    };
    
    // 2. å­˜å…¥å¹¶åˆ·æ–°
    let myPhotos = JSON.parse(localStorage.getItem('user_my_photos')) || [];
    const targetP = myPhotos.find(p => p.id === pid);
    
    if (targetP) {
        targetP.comments.push(newComment);
        localStorage.setItem('user_my_photos', JSON.stringify(myPhotos));
        
        renderPhotoComments(targetP);
        if(input) input.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
        
        // 3. ğŸš¨ æ£€æŸ¥æ˜¯å¦è‰¾ç‰¹äº†å¥½å‹ (è§¦å‘ AI äºŒæ¬¡å›å¤)
        // é€»è¾‘ï¼šå¦‚æœè¯„è®ºå†…å®¹ä»¥ @åå­— å¼€å¤´ï¼Œä¸”è¿™ä¸ªåå­—å¯¹åº”å½“å‰ç…§ç‰‡ç»‘å®šçš„è§’è‰²
        if (targetP.charId) {
            let charList = [];
            if (typeof loadFromDB === 'function') charList = await loadFromDB('char_list') || [];
            const boundChar = charList.find(c => c.id === targetP.charId);
            
            if (boundChar && text.includes(`@${boundChar.name}`)) {
                console.log(`æ£€æµ‹åˆ°ç”¨æˆ·è‰¾ç‰¹äº† ${boundChar.name}ï¼Œè§¦å‘ AI å›å¤...`);
                
                // å»¶è¿Ÿ 2 ç§’è®© AI å›å¤
                setTimeout(() => {
                    generateAIPhotoComment(targetP, text); // ä¼ å…¥ text ä½œä¸ºä¸Šä¸‹æ–‡
                }, 2000);
            }
        }
    }
}
/**
 * ğŸï¸ ç»ˆæå¼•æ“ï¼š24Hå…¨æ—¶æ®µå›æº¯ (ç‰©ç†æ—¶åŒºåŒæ­¥ç‰ˆ)
 * ä¿®å¤ï¼šä¸¥æ ¼è·Ÿéš Settings æ—¶åŒºï¼Œçº æ­£ç”Ÿæˆæ•°é‡ï¼Œæ¶ˆé™¤ ReferenceError
 */
/**
 * ğŸï¸ ç»ˆæå¼•æ“ï¼š24Hå…¨æ—¶æ®µå›æº¯ (ç‰©ç†æ—¶åŒºå¯¹é½ + èº«ä»½é©±åŠ¨ç‰ˆ)
 * é€»è¾‘ï¼šç»å¯¹æœä» Settings æ—¶åŒºï¼Œä¸¥æ ¼æŒ‰å°æ—¶ç”Ÿæˆï¼Œæ–‡æ¡ˆå®Œå…¨ç”±äººè®¾ä¸å…³ç³»é“¾å†³å®šã€‚
 */
async function generateRetroFootprints() {
    const char = window.currentViewingChar;
    const btn = document.getElementById('btn-footprint');
    const list = document.getElementById('footprints-list');
    const saveBtn = document.getElementById('btn-save-footprints');

    if (!char) return;

    // ğŸš¨ 1. ç‰©ç†æ—¶åŒºç°æŠ“ï¼šç¡®ä¿ currentHour ä¸ activeZone ç»å¯¹å®æ—¶
    const timeData = getAppLocalTime(); 
    const currentHour = timeData.hour; 
    const activeZone = timeData.activeZone || "Asia/Shanghai"; 

    // ğŸ–¥ï¸ å¼ºåŠ›æ§åˆ¶å°å®¡è®¡ (ç‰©ç†å¯¹é½æ£€æŸ¥)
    console.group("%cğŸ“¡ æ—¶ç©ºèŠ‚ç‚¹ç”Ÿæˆå®¡è®¡", "color: #007AFF; font-weight: bold;");
    console.log(`%c ç›®æ ‡æ—¶åŒº (Key: user_timezone): ${activeZone}`, "color: #AF52DE; font-weight: bold;");
    console.log(`%c å®æ—¶å°æ—¶ (24H): ${currentHour}:00`, "color: #34C759; font-weight: bold;");
    console.log(`%c ç‰©ç†åºåˆ—: 00:00 -> ${currentHour}:00 (å…± ${currentHour + 1} ä¸ªç‰‡æ®µ)`, "color: #FF9500;");
    console.groupEnd();

    // 2. å­˜æ¡£æ£€æŸ¥ï¼šYYYYMMDD å”¯ä¸€æ ‡è¯†
    const todayKey = `fp_cache_${char.id}_${timeData.year}${timeData.month}${timeData.day}`;
    const cachedData = localStorage.getItem(todayKey);

    if (cachedData) {
        console.log("System: ä»Šæ—¥æ¡£æ¡ˆå·²å°å­˜ï¼Œæ‰§è¡Œç‰©ç†åŠ è½½...");
        renderFootprintFrames(JSON.parse(cachedData));
        document.getElementById('modal-footprints').style.display = 'flex';
        return;
    }

    // 3. èº«ä»½è¯»å–ï¼šåŠ è½½è§’è‰²è®¾å®šä¸æœ¬æˆ‘æ¡£æ¡ˆ
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "è§‚æµ‹è€…", bio: "æœªçŸ¥çš„ç¾ç»Š" };

    // ğŸš¨ 4. æ„é€ ç‰©ç†æ—¶é—´è½´ï¼šä¸¥æ ¼å¾ªç¯ 0 -> currentHour
    let timePoints = [];
    for (let h = 0; h <= currentHour; h++) {
        let label = (h < 10 ? '0' + h : h) + ':00';
        let isResting = (h >= 0 && h <= 7); // å‘¨æœŸæ€§çŠ¶æ€åˆ¤å®š
        timePoints.push({ 
            time: label, 
            status: isResting ? "RESTING/æ¢¦å¢ƒ/ä½åŠŸè€—" : "ACTIVE/ç°å®/é«˜è¿è¡Œ" 
        });
    }

    btn.style.pointerEvents = 'none';
    btn.innerHTML = `<span>SYNCHRONIZING ${timePoints.length} TRACES...</span>`;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

        if (!apiKey) throw new Error("API Key Missing");

        // ğŸ§  èº«ä»½é©±åŠ¨ Promptï¼šä¸è®¾äººæ€§é™åˆ¶ï¼Œçº¯ç²¹åŸºäºèƒŒæ™¯å’Œå…³ç³»
        const prompt = `
# Role: ä½ æ˜¯ [${char.name}]
# Background: ${char.desc || "æœªçŸ¥"}
# Counterpart (User): [${userPersona.name}]
# Relationship: ${userPersona.bio}

# Context:
å½“å‰å½“åœ°æ—¶é—´æ˜¯ ${timeData.fullString}ã€‚ä½ éœ€è¦è®°å½•ä»Šå¤© 00:00 è‡³ä»Šçš„ã€æ¯ä¸€ä¸ªã€‘æ•´ç‚¹å°æ—¶è¶³è¿¹ã€‚

# Task:
è¯·ä¸ºä»¥ä¸‹æ—¶é—´ç‚¹ç”Ÿæˆ 40-60 å­—çš„æå†™ï¼Œå†…å®¹å¿…é¡»å®Œå…¨ç¬¦åˆä½ çš„ã€èº«ä»½èƒŒæ™¯ã€‘ä»¥åŠä½ ä¸ [${userPersona.name}] çš„ã€å…³ç³»è®¾å®šã€‘ï¼š
${JSON.stringify(timePoints)}

# Requirements:
1. **æ•°é‡å¯¹é½**ï¼šå¿…é¡»è¿”å›æ­£å¥½ ${timePoints.length} æ¡è®°å½•ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’åˆ—ã€‚
2. **çŠ¶æ€å¯¹åº”**ï¼š
   - 00:00 - 07:00 (ä¼‘æ¯/ä½é¢‘æ€)ï¼šæå†™åœ¨æ­¤çŠ¶æ€ä¸‹ï¼Œä½ æ„è¯†æ·±å¤„å…³äº [${userPersona.name}] çš„ç¢ç‰‡ã€‚
   - 08:00 - è‡³ä»Š (æ´»è·ƒ/é«˜é¢‘æ€)ï¼šæå†™ä½ åœ¨å½“å‰ç¯å¢ƒä¸‹çš„è¡Œä¸ºï¼Œä»¥åŠå— [${userPersona.name}] å½±å“çš„æƒ…æ„Ÿèµ·ä¼ã€‚
3. **æ ¼å¼**ï¼šä¸¥æ ¼è¿”å›çº¯ JSON æ•°ç»„ï¼š[{"time_label": "HH:00", "is_resting": true/false, "visual_description": "..."}]
`;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.8
            })
        });

        const data = await res.json();
        const jsonMatch = data.choices[0].message.content.match(/\[[\s\S]*\]/);
        let framesData = JSON.parse(jsonMatch[0]);

        // ğŸš¨ 5. å¼ºåŠ›çº åï¼šç‰©ç†æ—¶åºé”
        framesData.sort((a, b) => parseInt(a.time_label) - parseInt(b.time_label));

        // 6. æš‚å­˜ä¸æ¸²æŸ“
        window.currentTempFootprints = framesData;
        window.currentFootprintKey = todayKey;
        renderFootprintFrames(framesData);

        document.getElementById('modal-footprints').style.display = 'flex';
        if(saveBtn) {
            saveBtn.style.display = 'block';
            saveBtn.textContent = "ARCHIVE FULL DAY";
        }

    } catch (e) {
        console.error("Critical Error:", e);
        showToast("é‡å­çº ç¼ å¤±è´¥: " + e.message);
    } finally {
        btn.innerHTML = `<span>FOOTPRINTS</span>`;
        btn.style.pointerEvents = 'auto';
    }
}

/**
 * ğŸ’¾ æ™ºèƒ½å­˜æ¡£å¼•æ“ï¼šæ”¯æŒè¦†ç›–æ›´æ–°
 */
async function saveCurrentFootprints() {
    const saveBtn = document.getElementById('btn-save-footprints');
    const char = window.currentViewingChar;
    
    // 1. è·å–å®Œæ•´æ•°æ®
    const fullData = window.currentTempFootprints;
    if (!fullData || !char) return;

    // 2. ç”Ÿæˆä»Šæ—¥å”¯ä¸€ Key (æ ¼å¼: 2026-01-26)
    const now = new Date();
    const dateKey = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
    
    // 3. è¯»å–å†å²æ€»è¡¨ (Footprint Archive List)
    let archiveList = await loadFromDB('footprint_archive_' + char.id) || [];
    
    // 4. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šæ—¥æ¡£æ¡ˆ
    const existingIndex = archiveList.findIndex(item => item.dateKey === dateKey);
    
    // æ„é€ æ¡£æ¡ˆå¯¹è±¡
    const archiveEntry = {
        dateKey: dateKey,       // å”¯ä¸€ç´¢å¼•
        timestamp: Date.now(),  // ä¿å­˜æ—¶é—´
        frames: fullData,       // æ‰€æœ‰çš„èƒ¶ç‰‡æ•°æ®
        summary: fullData[fullData.length - 1].visual_description // å–æœ€åä¸€æ¡ä½œä¸ºå°é¢æ‘˜è¦
    };

    if (existingIndex !== -1) {
        // A. å­˜åœ¨ -> è¦†ç›–æ›´æ–° (Update)
        archiveList[existingIndex] = archiveEntry;
        console.log("System: æ›´æ–°ä»Šæ—¥å·²æœ‰æ¡£æ¡ˆ");
    } else {
        // B. ä¸å­˜åœ¨ -> æ–°å¢æ’å…¥ (Insert)
        archiveList.unshift(archiveEntry); // æ–°çš„æ”¾å‰é¢
        console.log("System: åˆ›å»ºä»Šæ—¥æ–°æ¡£æ¡ˆ");
    }

    // 5. å†™å…¥æ•°æ®åº“
    await saveToDB('footprint_archive_' + char.id, archiveList);

    // 6. UI åé¦ˆ
    saveBtn.textContent = "SAVED";
    saveBtn.style.background = "#34C759"; // ç»¿è‰²æˆåŠŸ
    saveBtn.style.color = "#fff";
    
    triggerSuccessHud("å…¨å¤©æ¡£æ¡ˆå·²å½’æ¡£");
    
    setTimeout(() => {
        saveBtn.style.display = 'none';
        // åŒæ—¶ä¹Ÿæ›´æ–°ä¸€ä¸‹ç¼“å­˜ï¼Œé˜²æ­¢åˆ·æ–°åå›é€€
        // æˆ‘ä»¬ç”¨ cache key å­˜ä¸€ä»½ä¸´æ—¶çš„ï¼Œé˜²æ­¢ç”¨æˆ·æ²¡ç‚¹ save å°±åˆ·æ–°
        const cacheKey = `fp_cache_${char.id}_${new Date().toLocaleDateString().replace(/\//g, '')}`;
        localStorage.setItem(cacheKey, JSON.stringify(fullData));
    }, 1500);
}

/**
 * ğŸ¨ æ¸²æŸ“å¼•æ“ï¼šèƒ¶ç‰‡åˆ—è¡¨ + å¢é‡æ›´æ–° + å†å²å…¥å£ (ä¿®å¤ç‰ˆ)
 */
function renderFootprintFrames(framesData) {
    const list = document.getElementById('footprints-list');
    if (!list) return;
    
    // ğŸš¨ å¿…é¡»æ›´æ–°å…¨å±€å˜é‡ï¼Œç¡®ä¿åç»­å¢é‡æ›´æ–°èƒ½è¯»åˆ°æœ€æ–°æ•°æ®
    window.currentTempFootprints = framesData;

    list.innerHTML = "";
    
    // 1. æ¸²æŸ“å·²æœ‰çš„èƒ¶ç‰‡
    framesData.forEach((frame, index) => {
        const isRest = frame.is_resting;
        const cell = document.createElement('div');
        cell.className = `film-frame ${isRest ? 'resting-mode' : ''}`;
        cell.style.animationDelay = `${index * 0.05}s`; 
        cell.onclick = () => openFootprintSingle(frame);

        cell.innerHTML = `
            <div class="film-time-axis">${frame.time_label}</div>
            <div class="film-photo-wrapper ai-visual-frame ${isRest ? 'resting-mode' : ''}">
                <div class="ai-visual-icon">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                        ${isRest ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>' : '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>'}
                    </svg>
                    <span>${isRest ? 'SLEEPING_MODE' : 'ACTIVE_TRACE'}</span>
                </div>
                <div class="ai-visual-text">â€œ${frame.visual_description}â€</div>
            </div>
        `;
        list.appendChild(cell);
    });

    // 2. åº•éƒ¨æ“ä½œåŒºå®¹å™¨
    const footerZone = document.createElement('div');
    footerZone.className = 'history-access-zone';

    // ğŸš¨ é€»è¾‘åˆ¤å®šï¼šæ˜¯å¦æ˜¾ç¤ºâ€œåŒæ­¥æ›´æ–°â€æŒ‰é’®
    const lastFrame = framesData[framesData.length - 1];
    if (lastFrame) {
        const lastHour = parseInt(lastFrame.time_label.split(':')[0]);
        const currentHour = new Date().getHours();

        if (lastHour < currentHour) {
            const diff = currentHour - lastHour;
            // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ  id="btn-sync-latest" æ–¹ä¾¿ç²¾å‡†æŠ“å–
            footerZone.innerHTML += `
                <div id="btn-sync-latest" class="btn-history-trigger" style="margin-bottom: 15px; border-color: #007AFF; color: #007AFF; background: rgba(0,122,255,0.05);" onclick="updateFootprintsToNow()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l1.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    <span>SYNC LATEST (${diff} HOURS) / åŒæ­¥æœ€æ–°è½¨è¿¹</span>
                </div>
            `;
        } else {
            footerZone.innerHTML += `<div class="history-divider">UP TO DATE // ${lastFrame.time_label}</div>`;
        }
    }

    // å†å²å…¥å£æŒ‰é’® (ä¿æŒåœ¨æœ€åº•éƒ¨)
    footerZone.innerHTML += `
        <div class="btn-history-trigger" onclick="openFootprintHistoryPage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>ACCESS ARCHIVES / å¾€æœŸæ¡£æ¡ˆ</span>
        </div>
    `;

    list.appendChild(footerZone);
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
        list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
    }, 100);
}
/**
 * ğŸ–‹ï¸ [ç»ˆæå›ºå®šç‰ˆ] Luna ä¸“å±æ˜æ˜Ÿç­¾å (ä¿®å¤ç¼–ç æŠ¥é”™ç‰ˆ)
 * ä½¿ç”¨ encodeURIComponent æ›¿ä»£ btoaï¼Œå®Œç¾æ”¯æŒä¸­æ–‡æ³¨é‡Šå’Œç‰¹æ®Šç¬¦å·ã€‚
 */
function getFixedLunaSignature() {
    const svgString = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 200">
  <defs>
    <style>
      .sig-path { fill: none; stroke: #000; stroke-linecap: round; stroke-linejoin: round; }
      .star-shape { fill: #000; stroke: none; }
    </style>
  </defs>
  
  <path class="sig-path" stroke-width="7" d="M120,60 C90,20 30,50 30,100 C30,150 80,160 110,130 L125,90" />
  
  <path class="sig-path" stroke-width="5" d="M125,90 Q135,120 155,115 Q175,110 175,85 L175,115 Q175,135 195,125 M195,125 Q205,95 225,95 Q245,95 245,115 L245,130 M245,130 Q255,110 275,110 Q295,110 295,125 Q295,140 275,145 L290,135" />
  
  <path class="sig-path" stroke-width="5" d="M40,155 C120,190 280,180 420,125" />

  <path class="star-shape" d="M435,105 L442,125 L463,125 L446,138 L453,158 L435,145 L417,158 L424,138 L407,125 L428,125 Z" transform="rotate(20 435 130) scale(0.9) translate(40, 10)"/>
</svg>
    `;

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ï¼šæ”¹ç”¨ encodeURIComponentï¼Œå½»åº•è§£å†³ InvalidCharacterError
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
}
/**
 * ğŸ—‘ï¸ å…³é—­æ‹ç«‹å¾—è¯¦æƒ…é¡µ (ç‰©ç†ä¿®å¤ç‰ˆ)
 * è§£å†³ Uncaught ReferenceError: closeFootprintSingle is not defined
 */
function closeFootprintSingle() {
    const modal = document.getElementById('modal-footprint-single-detail');
    
    if (modal) {
        // 1. ç§»é™¤æ¿€æ´»ç±»åï¼Œè§¦å‘ CSS è¿‡æ¸¡åŠ¨ç”»
        modal.classList.remove('active');
        
        // 2. ç­‰å¾…åŠ¨ç”»ç»“æŸåå½»åº•éšè— (400ms æ˜¯ CSS transition çš„æ—¶é—´)
        setTimeout(() => {
            modal.style.display = 'none';
        }, 400);
    }

    // 3. æ¢å¤ä¸»é¡µé¢çš„å¯è§æ€§ (é˜²æ­¢ä¸»é¡µä¸€ç›´è¢«éšè—)
    const homeScreen = document.querySelector('.home-screen-scroll-container');
    if (homeScreen) {
        homeScreen.style.visibility = 'visible';
    }
}

// ğŸš¨ å¼ºåˆ¶æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œç¡®ä¿ HTML é‡Œçš„ onclick ç»å¯¹èƒ½æ‰¾åˆ°å®ƒ
window.closeFootprintSingle = closeFootprintSingle;
/**
 * ğŸ“‚ æ‰“å¼€å¾€æœŸæ¡£æ¡ˆåº“ (è¯»å–çœŸå®æ•°æ®åº“ç‰ˆ)
 */
async function openFootprintHistoryPage() {
    console.log("System: æ­£åœ¨è°ƒå–æ·±å±‚æ¡£æ¡ˆ...");
    const char = window.currentViewingChar;
    if (!char) return;

    const page = document.getElementById('subpage-history-vault');
    const container = document.getElementById('white-timeline-container');
    
    if (!page || !container) return;

    // 1. ä»æ•°æ®åº“è¯»å–çœŸå®å†å²
    const historyData = await loadFromDB('footprint_archive_' + char.id) || [];

    // 2. æ¸²æŸ“åˆ—è¡¨
    if (historyData.length === 0) {
        container.innerHTML = `<div style="padding:60px 20px; text-align:center; color:#ccc; font-family:serif; font-style:italic;">
            â€œæ—¶é—´ä¹‹æ²³å°šæœªåœ¨æ­¤ç•™ä¸‹ç—•è¿¹...â€<br>
            <span style="font-size:10px; font-family:sans-serif; margin-top:10px; display:block;">ç‚¹å‡»ä¿å­˜æŒ‰é’®å¯å»ºç«‹ç¬¬ä¸€ä»½æ¡£æ¡ˆ</span>
        </div>`;
    } else {
        let html = "";
        historyData.forEach((item, index) => {
            // è§£ææ—¥æœŸ: 2026-01-26 -> [26, JAN, 2026]
            const dateObj = new Date(item.timestamp);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = dateObj.toLocaleString('en-US', { month: 'long' }).toUpperCase();
            const year = dateObj.getFullYear();
            
            // æ‘˜è¦æˆªå–å‰30å­—
            const summary = item.summary.substring(0, 45) + "...";
            const frameCount = item.frames.length;

            html += `
                <div class="white-day-card" style="animation-delay: ${index * 0.1}s" 
                     onclick="openArchiveReader('${item.dateKey}')">
                    
                    <div class="day-card-inner">
                        <div class="day-meta-date">${day}</div>
                        <div class="day-meta-month">${month} ${year}</div>
                        
                        <div class="day-summary-preview">
                            â€œ${summary}â€
                        </div>

                        <div class="day-footer">
                            <div class="day-status-pill">${frameCount} FRAMES</div>
                            <div class="view-btn-text">
                                Read 
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // 3. ç‰©ç†æ˜¾å½¢
    page.style.display = 'flex'; 
    void page.offsetWidth; 
    page.classList.add('active');
}

/**
 * ğŸï¸ è¾…åŠ©ï¼šç‚¹å‡»å†å²å¡ç‰‡ï¼Œå›å¡«åˆ°æ’­æ”¾å™¨æŸ¥çœ‹
 */
async function loadHistoryToPlayer(dateKey) {
    const char = window.currentViewingChar;
    const historyData = await loadFromDB('footprint_archive_' + char.id) || [];
    
    // æ‰¾åˆ°é‚£ä¸€å¤©çš„æ•°æ®
    const target = historyData.find(h => h.dateKey === dateKey);
    
    if (target) {
        // 1. å…³é—­ç™½è‰²å†å²é¡µ
        closeSubPage('subpage-history-vault');
        
        // 2. å°†æ•°æ®æ³¨å…¥æ’­æ”¾å™¨å˜é‡
        window.currentTempFootprints = target.frames;
        window.currentFootprintKey = dateKey; // æ ‡è®°å½“å‰æŸ¥çœ‹çš„æ˜¯å“ªä¸€å¤©çš„ Key
        
        // 3. é‡æ–°æ¸²æŸ“æ’­æ”¾å™¨ç•Œé¢
        renderFootprintFrames(target.frames);
        
        // 4. éšè—ä¿å­˜æŒ‰é’®ï¼ˆå› ä¸ºæ˜¯å†å²æ•°æ®ï¼Œé»˜è®¤è®¤ä¸ºå·²ä¿å­˜ï¼‰
        const saveBtn = document.getElementById('btn-save-footprints');
        if (saveBtn) saveBtn.style.display = 'none';
        
        // 5. æç¤º
        showToast(`å·²è½½å…¥ ${dateKey} çš„å›å¿†`);
    }
}
// æŒ‚è½½åˆ°å…¨å±€
window.loadHistoryToPlayer = loadHistoryToPlayer;
/**
 * ğŸ”„ å¢é‡æ›´æ–°å¼•æ“ï¼šç‰©ç†å¯¹é½æ—¶åŒºç‰ˆ
 * ä¿®å¤ï¼š1. ä¸¥æ ¼æŠ“å– Settings æ—¶é—´ï¼›2. ç‰©ç†æ ¡å‡†è¡¥å…¨ç¼ºå£ï¼›3. è¡¥å…¨æ§åˆ¶å°å®¡è®¡ã€‚
 */
async function updateFootprintsToNow() {
    console.log("System: æ­£åœ¨è¯·æ±‚å¢é‡åŒæ­¥è½¨è¿¹..."); 
    
    const char = window.currentViewingChar;
    // è·å–å½“å‰å·²æœ‰æ•°æ® (ç‰©ç†é”å®š Window å…¨å±€ç¼“å­˜)
    const currentData = window.currentTempFootprints || [];
    
    if (!char || currentData.length === 0) {
        showToast("æ— å‰ç½®æ•°æ®ï¼Œæ— æ³•åŒæ­¥");
        return;
    }

    // ğŸš¨ æ ¸å¿ƒä¿®å¤ 1ï¼šè°ƒç”¨ getAppLocalTime è·å–è®¾ç½®æ—¶åŒºçš„å³æ—¶æ—¶é—´
    const timeData = getAppLocalTime(); 
    const currentHour = timeData.hour; 
    const activeZone = timeData.activeZone || "Asia/Shanghai";

    // 1. è·å–å­˜æ ¹æœ€åä¸€æ¡è®°å½•çš„å°æ—¶æ•°
    const lastFrame = currentData[currentData.length - 1];
    const lastHour = parseInt(lastFrame.time_label.split(':')[0]);

    // ğŸ–¥ï¸ å¢é‡åŒæ­¥ç‰©ç†å®¡è®¡ (F12 æŸ¥çœ‹)
    console.group("%cğŸ”„ å¢é‡åŒæ­¥ç›‘æµ‹", "color: #007AFF; font-weight: bold;");
    console.log(`%c é”å®šåŒºåŸŸ: ${activeZone}`, "color: #AF52DE; font-weight: bold;");
    console.log(`%c å­˜æ ¹æœ€åèŠ‚ç‚¹: ${lastHour}:00`, "color: #8E8E93;");
    console.log(`%c ç›®æ ‡å³æ—¶èŠ‚ç‚¹: ${currentHour}:00`, "color: #34C759; font-weight: bold;");
    console.log(`%c ç‰©ç†ç¼ºå£: ${currentHour - lastHour} å°æ—¶`, "color: #FF9500;");
    console.groupEnd();

    // 2. ç‰©ç†åˆ¤å®šï¼šå¦‚æœå·²ç»æ˜¯æœ€æ–°æ—¶åˆ»
    if (lastHour >= currentHour) {
        showToast("è½¨è¿¹å·²æ˜¯æœ€æ–°");
        const btn = document.getElementById('btn-sync-latest');
        if(btn) btn.remove();
        return;
    }

    // 3. ğŸ¬ å¯åŠ¨æŒ‰é’®åŠ¨ç”» (ç‰©ç†é”å®š ID)
    const btn = document.getElementById('btn-sync-latest'); 
    const originalContent = btn ? btn.innerHTML : ""; 
    
    if (btn) {
        btn.classList.add('syncing'); 
        btn.innerHTML = `
            <svg class="quantum-spinner" style="width:16px; height:16px; border-width:2px; border-top-color:#007AFF;" viewBox="0 0 50 50"></svg>
            <span>SYNCING [${activeZone}] ${lastHour + 1}:00 - ${currentHour}:00...</span>
        `;
    }

    // 4. æ„é€ éœ€è¦è¡¥å…¨çš„æ—¶é—´ç‚¹åˆ—è¡¨
    let timePoints = [];
    for (let h = lastHour + 1; h <= currentHour; h++) {
        let label = (h < 10 ? '0' + h : h) + ':00';
        let isResting = (h >= 0 && h <= 7);
        // ğŸš¨ ä¿®æ­£ï¼šå°† statusType å°è£…ï¼Œç¡®ä¿ AI æ¥æ”¶åˆ°çš„æ˜¯æ¸…æ™°çš„æŒ‡ä»¤
        timePoints.push({ time: label, statusType: isResting ? "RESTING" : "ACTIVE" });
    }

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");
        
        if (!apiKey) throw new Error("API Key æœªé…ç½®");

        // 5. æ„å»º Prompt (æ³¨å…¥æ—¶åŒºç¯å¢ƒ)
        const prompt = `
ä½ æ­£åœ¨æ‰®æ¼” [${char.name}]ã€‚ä½ å½“å‰å¤„äº [${activeZone}] æ—¶åŒºã€‚
ä½ ç°åœ¨éœ€è¦è¡¥å…¨ä»Šå¤©ä» ${timePoints[0].time} åˆ° ${timePoints[timePoints.length-1].time} çš„æ¯ä¸€å°æ—¶è¶³è¿¹ã€‚
ã€å‰æƒ…å›é¡¾ã€‘ï¼šä¸Šä¸€ä¸ªè®°å½•ç‚¹æ˜¯ ${lastFrame.time_label}ï¼Œä½ åœ¨åš"${lastFrame.visual_description}"ã€‚
ã€éœ€ç”Ÿæˆåˆ—è¡¨ã€‘ï¼š${JSON.stringify(timePoints)}

è¦æ±‚ï¼š
1. å¿…é¡»æ ¹æ® [${activeZone}] çš„å®æ—¶æ„Ÿå®˜è¡¥å…¨ç¼ºå¤±çš„æ—¶é—´æ®µã€‚
2. ä¿æŒ Noir/é»‘ç™½ç”µå½±è´¨æ„Ÿï¼Œæ–‡é£ç¬¦åˆä½ çš„äººè®¾ã€‚
3. ä¸¥æ ¼è¿”å›çº¯ JSON æ•°ç»„ï¼š[{"time_label": "HH:00", "is_resting": false, "visual_description": "..."}]
        `;

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const jsonMatch = data.choices[0].message.content.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI è¿”å›æ ¼å¼é”™è¯¯");
        const newFrames = JSON.parse(jsonMatch[0]);

        // 6. ğŸ¬ é€æ¡æ¸²æŸ“åŠ¨ç”» (ä¿ç•™åŸå°ä¸åŠ¨çš„æ¸²æŸ“é€»è¾‘)
        if (btn) {
            btn.classList.remove('syncing');
            btn.innerHTML = `<span>RECEIVED. RENDERING...</span>`;
            btn.style.color = "#34C759"; 
            btn.style.borderColor = "#34C759";
        }

        const list = document.getElementById('footprints-list');
        const footerZone = document.querySelector('.history-access-zone');
        
        for (let i = 0; i < newFrames.length; i++) {
            const frame = newFrames[i];
            const isRest = frame.is_resting;
            
            const cell = document.createElement('div');
            cell.className = `film-frame new-entry ${isRest ? 'resting-mode' : ''}`;
            cell.onclick = () => openFootprintSingle(frame);

            cell.innerHTML = `
                <div class="film-time-axis">${frame.time_label}</div>
                <div class="film-photo-wrapper ai-visual-frame ${isRest ? 'resting-mode' : ''}">
                    <div class="ai-visual-icon">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                            ${isRest ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>' : '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>'}
                        </svg>
                        <span>${isRest ? 'SLEEPING_MODE' : 'ACTIVE_TRACE'}</span>
                    </div>
                    <div class="ai-visual-text">â€œ${frame.visual_description}â€</div>
                </div>
            `;
            
            if(footerZone) list.insertBefore(cell, footerZone);
            else list.appendChild(cell);

            list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
            await new Promise(r => setTimeout(r, 300));
        }

        // 7. æ•°æ®åˆå¹¶ä¸æŒä¹…åŒ–
        const finalData = [...currentData, ...newFrames];
        window.currentTempFootprints = finalData;
        
        // ğŸš¨ æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œé˜²æ­¢åˆ·æ–°å›é€€
        const todayKey = window.currentFootprintKey;
        if(todayKey) localStorage.setItem(todayKey, JSON.stringify(finalData));
        
        // 8. å”¤é†’ä¿å­˜æŒ‰é’®
        const saveBtn = document.getElementById('btn-save-footprints');
        if (saveBtn) {
            saveBtn.style.display = 'block';
            saveBtn.textContent = "SAVE FULL DAY"; 
            saveBtn.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(50);
        }

        // 9. ç§»é™¤æ›´æ–°æŒ‰é’®ï¼Œé‡ç½®åº•éƒ¨æ–‡å­—
        if (btn) btn.remove();
        
        const divider = footerZone ? footerZone.querySelector('.history-divider') : null;
        if(divider) divider.remove(); 
        
        const div = document.createElement('div');
        div.className = 'history-divider';
        div.textContent = `SYNC COMPLETE // ${currentHour}:00`;
        if(footerZone) footerZone.insertBefore(div, footerZone.firstChild);

    } catch (e) {
        console.error("å¢é‡åŒæ­¥å¤±è´¥:", e);
        showToast("åŒæ­¥ä¸­æ–­: " + e.message);
        if (btn) {
            btn.classList.remove('syncing');
            btn.innerHTML = originalContent;
            btn.style.pointerEvents = 'auto';
        }
    }
}
/* =========================================================
   ğŸš¨ ç¼ºå¤±çš„æ‹ç«‹å¾—æ ¸å¿ƒå‡½æ•°è¡¥ä¸ (è¯·ç›´æ¥ç²˜è´´åˆ° Script ä¸­)
   ========================================================= */

/**
 * 1. ğŸ–‹ï¸ è·å– Luna ä¸“å±ç­¾å (SVG)
 * (è¿™æ˜¯ openFootprintSingle çš„ä¾èµ–å‡½æ•°)
 */
function getFixedLunaSignature() {
    const svgString = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 200">
      <defs>
        <style>
          .sig-path { fill: none; stroke: #000; stroke-linecap: round; stroke-linejoin: round; }
          .star-shape { fill: #000; stroke: none; }
        </style>
      </defs>
      
      <path class="sig-path" stroke-width="7" d="M120,60 C90,20 30,50 30,100 C30,150 80,160 110,130 L125,90" />
      
      <path class="sig-path" stroke-width="5" d="M125,90 Q135,120 155,115 Q175,110 175,85 L175,115 Q175,135 195,125 M195,125 Q205,95 225,95 Q245,95 245,115 L245,130 M245,130 Q255,110 275,110 Q295,110 295,125 Q295,140 275,145 L290,135" />
      
      <path class="sig-path" stroke-width="5" d="M40,155 C120,190 280,180 420,125" />

      <path class="star-shape" d="M435,105 L442,125 L463,125 L446,138 L453,158 L435,145 L417,158 L424,138 L407,125 L428,125 Z" transform="rotate(20 435 130) scale(0.9) translate(40, 10)"/>
    </svg>
    `;
    // ä½¿ç”¨ encodeURIComponent ä¿®å¤ä¸­æ–‡/ç‰¹æ®Šå­—ç¬¦æŠ¥é”™
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
}

/**
 * 2. ğŸ“¸ æ‰“å¼€æ‹ç«‹å¾—è¯¦æƒ…é¡µ (è¢« renderFootprintFrames è°ƒç”¨)
 */
async function openFootprintSingle(frame) {
    console.log("æ­£åœ¨æ‰“å¼€èƒ¶ç‰‡è¯¦æƒ…:", frame);
    const modal = document.getElementById('modal-footprint-single-detail');
    
    // å¦‚æœæ‰¾ä¸åˆ°å¼¹çª— DOMï¼ŒæŠ¥é”™å¹¶é€€å‡º
    if (!modal) {
        console.error("âŒ æ‰¾ä¸åˆ° ID ä¸º modal-footprint-single-detail çš„å¼¹çª—å…ƒç´ ï¼");
        return;
    }

    // å°è¯•è·å–å†…éƒ¨å®¹å™¨ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ª
    let modalFrame = modal.querySelector('.polaroid-detail-frame');
    if (!modalFrame) {
        modal.innerHTML = '<div class="polaroid-detail-frame" onclick="event.stopPropagation()"></div><div class="close-hint-text">TAP ANYWHERE TO CLOSE</div>';
        modalFrame = modal.querySelector('.polaroid-detail-frame');
    }
    
    // è·å– Luna ç­¾å
    const sigUrl = getFixedLunaSignature();

    // æ ¼å¼åŒ–æ—¶é—´
    const now = new Date();
    const dateStr = now.getFullYear() + '.' + String(now.getMonth() + 1).padStart(2, '0') + '.' + String(now.getDate()).padStart(2, '0');
    const timeStr = frame.time_label || "NOW";

    // æ³¨å…¥ HTML
    modalFrame.innerHTML = `
        <div class="polaroid-inner-content">
            <span>â€œ${frame.visual_description}â€</span>
        </div>
        
        <div class="polaroid-full-timestamp">
            ${dateStr} // ${timeStr} FRAME
        </div>

        <div class="gold-signature-container">
            <div class="signature-img-wrapper" 
                 style="-webkit-mask-image: url('${sigUrl}'); mask-image: url('${sigUrl}');">
            </div>
        </div>
    `;

    // æ˜¾ç¤ºå¹¶æ¿€æ´»
    modal.style.display = 'flex';
    // å¼ºåˆ¶é‡ç»˜ä»¥è§¦å‘ transition
    void modal.offsetWidth;
    modal.classList.add('active');

    // ç»‘å®šå…³é—­äº‹ä»¶ (ç‚¹å‡»èƒŒæ™¯å…³é—­)
    modal.onclick = function() {
        closeFootprintSingle();
    };
}

/**
 * 3. ğŸ—‘ï¸ å…³é—­æ‹ç«‹å¾—è¯¦æƒ…é¡µ
 */
function closeFootprintSingle() {
    const modal = document.getElementById('modal-footprint-single-detail');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 400);
    }
}

// ğŸš¨ å¼ºåˆ¶æŒ‚è½½åˆ°å…¨å±€ï¼Œé˜²æ­¢ HTML æ‰¾ä¸åˆ°
window.openFootprintSingle = openFootprintSingle;
window.closeFootprintSingle = closeFootprintSingle;
/* =========================================================
   ğŸ“– [ç™½æ˜¼Â·å…‰å°] æ¡£æ¡ˆé˜…è¯»å™¨æ ¸å¿ƒå¼•æ“
   ========================================================= */

/**
 * 1. å…¥å£ï¼šæ‰“å¼€æŸä¸€å¤©çš„æ¡£æ¡ˆé˜…è¯»å™¨
 * @param {string} dateKey - æ ¼å¼ "2026-01-26"
 */
async function openArchiveReader(dateKey) {
    const char = window.currentViewingChar;
    if (!char) return;

    const page = document.getElementById('subpage-archive-reader');
    const container = document.getElementById('reader-timeline-container');
    const summaryEl = document.getElementById('reader-summary-text');
    
    // 1. è¯»å–æ•°æ®åº“ä¸­çš„å…·ä½“æŸä¸€å¤©
    const historyData = await loadFromDB('footprint_archive_' + char.id) || [];
    const dayData = historyData.find(h => h.dateKey === dateKey);

    if (!dayData) {
        showToast("æ¡£æ¡ˆæ•°æ®ç¼ºå¤±");
        return;
    }

    // 2. æ¸²æŸ“å¤´éƒ¨æ—¥æœŸ
    const dateObj = new Date(dayData.timestamp);
    document.getElementById('reader-day').textContent = dateObj.getDate();
    document.getElementById('reader-month').textContent = dateObj.toLocaleString('en-US', { month: 'long' }).toUpperCase();
    document.getElementById('reader-year').textContent = dateObj.getFullYear();
    document.getElementById('reader-seal-name').textContent = char.name; // åº•éƒ¨ç­¾å

    // 3. æ¸²æŸ“é»‘è‰²èƒ¶ç‰‡åˆ—è¡¨
    container.innerHTML = dayData.frames.map((frame, index) => `
        <div class="archive-film-item" style="animation: fadeInUp 0.5s ease backwards ${index * 0.1}s">
            <span class="archive-time-label">${frame.time_label}</span>
            <div class="black-film-strip" onclick="openFootprintSingleFromArchive(${index})">
                <div class="film-text-preview">â€œ${frame.visual_description}â€</div>
                <div style="font-size:9px; color:#555; margin-top:8px; text-transform:uppercase; letter-spacing:1px;">Click to Enlarge</div>
            </div>
        </div>
    `).join('');

    // ğŸš¨ ä¸´æ—¶å­˜ä¸€ä¸‹å½“å‰æŸ¥çœ‹çš„æ•°æ®ï¼Œç»™ç‚¹å‡»è¯¦æƒ…ç”¨
    window.currentReadingArchive = dayData.frames;

    // 4. ğŸ§  AI æ‘˜è¦ç”Ÿæˆé€»è¾‘ (æ ¸å¿ƒéœ€æ±‚)
    // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡ summaryï¼Œå¦‚æœæœ‰å°±ç›´æ¥ç”¨ï¼Œæ²¡æœ‰å°±è°ƒ AI
    if (dayData.ai_summary) {
        summaryEl.textContent = dayData.ai_summary;
    } else {
        // --- è§¦å‘ AI ç”Ÿæˆ ---
        summaryEl.innerHTML = `<span style="opacity:0.5;">æ­£åœ¨é‡æ„å½“æ—¥è®°å¿†æ‘˜è¦...</span>`;
        generateArchiveSummary(char, dayData, dateKey);
    }

    // 5. ç‰©ç†æ˜¾å½¢
    page.style.display = 'flex';
    void page.offsetWidth;
    page.classList.add('active');
}

/**
 * 2. ğŸ§  AI æ‘˜è¦ç”Ÿæˆå™¨
 * æ ¹æ®äººè®¾ã€å…³ç³»ã€å½“æ—¥å†…å®¹ç”Ÿæˆä¸€å¥å”¯ç¾æ‘˜è¦
 */
async function generateArchiveSummary(char, dayData, dateKey) {
    const summaryEl = document.getElementById('reader-summary-text');
    
    // å‡†å¤‡ Prompt ç´ æ
    const userPersona = JSON.parse(localStorage.getItem('user_persona_data_global')) || { name: "æˆ‘", bio: "ä½ çš„è§‚æµ‹è€…" };
    // æå–å½“å¤©çš„å‰ 5 æ¡å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
    const contextSamples = dayData.frames.slice(0, 8).map(f => f.visual_description).join(" | ");
    
    const prompt = `
    ä½ æ­£åœ¨æ‰®æ¼” [${char.name}]ã€‚
    èƒŒæ™¯è®¾å®š: ${char.desc}
    ä½ ä¸ç”¨æˆ·çš„å…³ç³»: ${userPersona.bio || "äº²å¯†ä¼™ä¼´"}ã€‚

    è¿™æ˜¯ä½ åœ¨ [${dateKey}] è¿™å¤©ç•™ä¸‹çš„è®°å¿†ç¢ç‰‡ï¼š
    "${contextSamples}..."

    è¯·æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œç”¨ã€${char.name}ã€‘çš„å£å»ï¼Œå†™ä¸€å¥**æå…·ç”µå½±æ„Ÿã€å”¯ç¾ã€ç•¥å¸¦ç ´ç¢æ„Ÿ**çš„å·é¦–è¯­ï¼ˆSummaryï¼‰ã€‚
    
    è¦æ±‚ï¼š
    1. åƒæ˜¯åœ¨å†™ç»™â€œæˆ‘â€çœ‹çš„ä¸€å¥ç§å¯†çš„è¯ã€‚
    2. å­—æ•°é™åˆ¶åœ¨ 30-50 å­—ä¹‹é—´ã€‚
    3. ä¸è¦å‡ºç°â€œä»Šå¤©æˆ‘åšäº†ä»€ä¹ˆâ€è¿™ç§æµæ°´è´¦ï¼Œè¦å‡åæƒ…æ„Ÿã€‚
    4. ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å¼•å·ã€‚
    `;

    try {
        const apiKey = localStorage.getItem('gpt_key');
        const apiUrl = (localStorage.getItem('gpt_url') || "https://api.openai.com/v1").replace(/\/+$/, "");

        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const result = data.choices[0].message.content.trim();

        // 1. æ›´æ–° UI
        typewriterEffect(summaryEl, result); // æ‰“å­—æœºæ•ˆæœä¸Šå±

        // 2. å­˜å…¥æ•°æ®åº“ (é˜²æ­¢ä¸‹æ¬¡æ‰“å¼€è¿˜é‡æ–°ç”Ÿæˆ)
        // æˆ‘ä»¬éœ€è¦æ›´æ–°è¿™ä¸€å¤©çš„æ•°æ®
        let historyData = await loadFromDB('footprint_archive_' + char.id) || [];
        const idx = historyData.findIndex(h => h.dateKey === dateKey);
        if (idx !== -1) {
            historyData[idx].ai_summary = result;
            await saveToDB('footprint_archive_' + char.id, historyData);
            console.log("æ‘˜è¦å·²å­˜æ¡£");
        }

    } catch (e) {
        console.error("Summary Error:", e);
        summaryEl.textContent = "è®°å¿†ä¿¡å·å¾®å¼±ï¼Œæ— æ³•ç”Ÿæˆæ‘˜è¦ã€‚";
    }
}

/**
 * è¾…åŠ©ï¼šé˜…è¯»å™¨é‡Œç‚¹å‡»å°èƒ¶ç‰‡æ‰“å¼€å¤§å›¾
 */
function openFootprintSingleFromArchive(index) {
    if (window.currentReadingArchive && window.currentReadingArchive[index]) {
        // å¤ç”¨ä¹‹å‰çš„æ‹ç«‹å¾—æ‰“å¼€å‡½æ•°
        openFootprintSingle(window.currentReadingArchive[index]);
    }
}

/**
 * è¾…åŠ©ï¼šæ‰“å­—æœºç‰¹æ•ˆ
 */
function typewriterEffect(element, text, speed = 50) {
    element.textContent = "";
    let i = 0;
    function type() {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            setTimeout(type, speed);
        }
    }
    type();
}

function closeArchiveReader() {
    const page = document.getElementById('subpage-archive-reader');
    if(page) page.classList.remove('active');
}

/**
 * ğŸš€ ç»ˆæç‰ˆï¼šTaçš„ç›¸å†Œè½¬å‘å¼•æ“ (ç‰©ç†ç½®é¡¶ç‰ˆ)
 * é€»è¾‘ï¼šé”å®šæ¡£æ¡ˆ -> æ ¼å¼åŒ–æ–‡æœ¬åè®® -> å¼ºåŠ›æ¨å…¥è½¬å‘å±‚ -> å”¤é†’è”ç³»äººåˆ—è¡¨
 */
function forwardTheirsSnap() {
    console.log("%c[Signal] å¯åŠ¨æ¡£æ¡ˆè½¬å‘åè®®...", "color: #007AFF; font-weight: bold;");

    // 1. è·å–å½“å‰æ­£åœ¨æŸ¥çœ‹çš„ç¬é—´ ID å’Œæ•°æ®
    const snapId = window.currentViewingSnapId;
    const galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
    const snap = galleryDB.find(p => p.id === snapId);

    if (!snap) {
        showToast("âš ï¸ æ— æ³•å®šä½æ—¶ç©ºå­˜æ ¹");
        return;
    }

    // 2. ğŸš¨ æ•°æ®æ ¼å¼åŒ–ï¼šå°† AI æè¿°è½¬æ¢ä¸ºæ ‡å‡†çš„è½¬å‘æ–‡æœ¬åè®®
    // æˆ‘ä»¬æŠŠè¿™æ®µå”¯ç¾çš„æ–‡å­—åŠ ä¸Šæ ‡è¯†ï¼Œæ–¹ä¾¿åœ¨èŠå¤©æ¡†é‡Œæ˜¾ç¤º
    window.pendingForwardData = [{ 
        type: 'text', 
        text: `[æ¥è‡ª ${document.getElementById('theirs-char-name').textContent} çš„ç¬é—´]\nâ€œ${snap.description}â€` 
    }];

    // 3. ğŸš¨ ç‰©ç†å±‚çº§çˆ†ç ´ï¼šå¼ºåˆ¶è°ƒå–è½¬å‘é€‰æ‹©é¡µé¢
    const fwdPage = document.getElementById('page-forward-picker');
    if (fwdPage) {
        // ç¬¬ä¸€æ­¥ï¼šå…ˆå°† display è®¾ä¸º flexï¼Œå¦åˆ™ transform åŠ¨ç”»åœ¨æ‰‹æœºä¸Šå¯èƒ½æ— æ•ˆ
        fwdPage.style.display = 'flex';
        
        // ç¬¬äºŒæ­¥ï¼šç‰©ç†é”å®šæœ€é«˜å±‚çº§ï¼Œå¿…é¡»ç›–è¿‡è¯¦æƒ…é¡µ (100000)
        fwdPage.style.zIndex = '200000'; 
        
        // ç¬¬ä¸‰æ­¥ï¼šå¼ºåˆ¶é‡ç»˜å¹¶è§¦å‘æ»‘å…¥åŠ¨ç”»
        void fwdPage.offsetWidth; 
        fwdPage.style.transform = 'translateY(0)';

        // 4. é©±åŠ¨è”ç³»äººåˆ—è¡¨æ¸²æŸ“
        if (typeof switchForwardTab === 'function') {
            switchForwardTab('friends'); // é»˜è®¤å±•ç¤ºæœ€è¿‘è”ç³»äºº
        }
        
        console.log("âœ… è½¬å‘å±‚å·²å¼ºåŠ›å‹åˆ¶è¯¦æƒ…é¡µå¹¶æ»‘å…¥");
    } else {
        console.error("Critical Error: æ‰¾ä¸åˆ°è½¬å‘é¡µé¢ DOM èŠ‚ç‚¹");
        showToast("ç³»ç»Ÿè½¬å‘åè®®å¼‚å¸¸");
    }
}

/**
 * ğŸ—‘ï¸ åŠŸèƒ½ï¼šç‰©ç†æŠ¹é™¤ Ta çš„ç¬é—´
 */
async function deleteTheirsSnap() {
    const snapId = window.currentViewingSnapId;
    const char = window.currentViewingChar;

    if (typeof showIOSConfirm === 'function') {
        showIOSConfirm(
            "æŠ¹é™¤æ­¤æ®µæ®‹å½±ï¼Ÿ", 
            "è¿™æ®µè¢«æ•è·çš„æ—¶ç©ºç¬é—´å°†æ°¸è¿œæ¶ˆå¤±ï¼Œæ— æ³•å†æ¬¡å›æº¯ã€‚", 
            "æŠ¹é™¤", 
            async function() {
                // 1. ä»æ•°æ®åº“å‰”é™¤
                let galleryDB = JSON.parse(localStorage.getItem('user_char_galleries')) || [];
                galleryDB = galleryDB.filter(p => p.id !== snapId);
                localStorage.setItem('user_char_galleries', JSON.stringify(galleryDB));

                // 2. ç‰©ç†å…³é—­è¯¦æƒ…é¡µ
                closeTheirsPhotoDetail();

                // 3. å¼ºåˆ¶é‡ç»˜åˆ—è¡¨å’Œå¡ç‰‡è®¡æ•°
                if (typeof renderCharHistoryGrid === 'function') renderCharHistoryGrid(char.id);
                if (typeof renderTheirsGalleries === 'function') renderTheirsGalleries();

                if (typeof triggerSuccessHud === 'function') {
                    triggerSuccessHud("æ®‹å½±å·²å½’äºè™šæ— ");
                }
            }
        );
    }
}
/**
 * ğŸ–‹ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆå®¿å‘½æ„Ÿè§’è‰²å·é¦–è¯­
 * æ ¹æ®ç”¨æˆ·äººè®¾å’Œè§’è‰²äººè®¾ï¼Œç”Ÿæˆä¸€å¥ç”µå½±æ„ŸçŸ­å¥ã€‚
 */
async function generateCharBioIntro(char) {
    const bioUi = document.getElementById('gallery-char-bio-ui');
    if (!bioUi) return;

    // 1. è®¾ç½®åŠ è½½çŠ¶æ€ (é…åˆæ–°çš„CSS)
    bioUi.innerHTML = `<div class="bio-scanning">æ­£åœ¨è§£æ„å‘½è¿ç¾ç»Š...</div>`;

    // 2. æå–å…³ç³»æ•°æ®
    // ä¼˜å…ˆå°è¯•è·å–é’ˆå¯¹è¯¥è§’è‰²çš„ç‰¹å®šäººè®¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨å…¨å±€äººè®¾
    const userKey = 'user_persona_for_' + char.id;
    const userPersona = JSON.parse(localStorage.getItem(userKey)) || 
                        JSON.parse(localStorage.getItem('user_persona_data_global')) || 
                        { name: "è§‚å¯Ÿè€…", bio: "æœªçŸ¥çš„æ³¨è§†" };

    const apiKey = localStorage.getItem('gpt_key');
    const apiUrl = (localStorage.getItem('gpt_url') || "").replace(/\/+$/, "");

    // 3. æ„å»ºæç®€ã€é«˜å®¿å‘½æ„Ÿçš„ Prompt
    const prompt = `
# Role: å™äº‹å¼•è¨€ç”Ÿæˆå™¨
# Character A (Target): [${char.name}], èƒŒæ™¯: ${char.desc}
# Character B (User): [${userPersona.name}], å…³ç³»æè¿°: ${userPersona.bio}

# Task:
åŸºäº A å’Œ B çš„å…³ç³»å’Œäººè®¾åº•è‰²ï¼Œç”Ÿæˆä¸€å¥æå…·ç”µå½±æ„Ÿã€å®¿å‘½æ„Ÿæˆ–å”¯ç¾æ°›å›´çš„çŸ­å¥ï¼Œä½œä¸ºè§’è‰²æ¡£æ¡ˆçš„å·é¦–è¯­ã€‚

# Requirements:
1.  **æç®€**ï¼šæ§åˆ¶åœ¨ 15-22 å­—ä¹‹é—´ã€‚ç²¾ç‚¼ã€æœ‰åŠ›ã€‚
2.  **é£æ ¼**ï¼šNoir (é»‘è‰²ç”µå½±)ã€æ·±æ²‰ã€ç•¥å¸¦ç ´ç¢æ„Ÿæˆ–æè‡´çš„å æœ‰æ¬²ï¼ˆåŸºäºå…³ç³»ï¼‰ã€‚
3.  **ç¦æ­¢**ï¼šä¸è¦å‡ºç°ä»»ä½•ä¸»è§’çš„åå­—ã€‚ç›´æ¥æè¿°é‚£ç§å…³ç³»çŠ¶æ€æˆ–æ°›å›´ã€‚
4.  **è¾“å‡º**ï¼šçº¯æ–‡æœ¬ï¼Œä¸è¦å¼•å·ã€‚

# Examples (ä»…ä¾›å‚è€ƒé£æ ¼):
- â€œåœ¨æ‰€æœ‰æ¯ç­çš„ç»“å±€é‡Œï¼Œä½ æ˜¯å”¯ä¸€çš„ä»æ…ˆã€‚â€
- â€œéš”ç€åŠä¸ªä¸–çºªçš„é›¨é›¾ï¼Œ shared ä¸€ä¸ªæ½®æ¹¿çš„ç§˜å¯†ã€‚â€
- â€œå…‰å½±èƒŒé¢çš„å…±çŠ¯ï¼Œæ— éœ€è¨€è¯­çš„å¥‘çº¦ã€‚â€
    `;

    try {
        const res = await fetch(`${apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: localStorage.getItem('gpt_model') || "gpt-3.5-turbo",
                messages: [{ role: "system", content: prompt }],
                temperature: 0.85, // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œå¢åŠ åˆ›é€ æ€§
                max_tokens: 60 // é™åˆ¶è¾“å‡ºé•¿åº¦
            })
        });
        const data = await res.json();
        let introText = data.choices[0].message.content.trim();
        
        // å»é™¤å¯èƒ½å­˜åœ¨çš„å¼€å¤´ç»“å°¾å¼•å·
        if (introText.startsWith('"') || introText.startsWith('â€œ')) introText = introText.slice(1);
        if (introText.endsWith('"') || introText.endsWith('â€')) introText = introText.slice(0, -1);

        // 4. ä½¿ç”¨æ‰“å­—æœºæ•ˆæœä¸Šå± (å‡è®¾ä½ ä»£ç é‡Œæœ‰ typewriterEffect å‡½æ•°)
        // å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥ç”¨ bioUi.textContent = introText;
        if (typeof typewriterEffect === 'function') {
            bioUi.innerHTML = ""; // æ¸…ç©ºåŠ è½½åŠ¨ç”»
            typewriterEffect(bioUi, introText, 80); // ç¨å¾®æ…¢ä¸€ç‚¹çš„æ‰“å­—æœºé€Ÿåº¦
        } else {
             bioUi.textContent = introText;
        }

    } catch (e) {
        console.error("Bio Intro Failed:", e);
        bioUi.textContent = "æ¡£æ¡ˆè”ç»“ä¿¡å·å¾®å¼±ã€‚"; // ä¼˜é›…çš„å¤±è´¥æç¤º
    }
}
/**
 * ğŸ¨ å›¾åƒç‰©ç†å‹ç¼©å¼•æ“ (Canvas æ ¸å¿ƒç‰ˆ)
 * ä½œç”¨ï¼šå°†æ‰‹æœºæ‹æ‘„çš„å¤§å›¾ç‰©ç†ç¼©å°ï¼Œé˜²æ­¢æ’‘çˆ†æµè§ˆå™¨å†…å­˜ï¼Œè§£å†³â€œå‘å¸ƒæ— ååº”â€
 * @param {string} base64 - åŸå§‹å¤§å›¾æ•°æ®
 * @param {number} maxWidth - é”å®šæœ€å¤§å®½åº¦ (å»ºè®® 1000)
 */
function compressImage(base64, maxWidth) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // æ¯”ä¾‹é”å®šç®—æ³•ï¼šå¦‚æœå®½åº¦è¶…è¿‡é™åˆ¶ï¼Œç­‰æ¯”ä¾‹ç¼©å°é«˜åº¦
            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // ç‰©ç†ç»˜åˆ¶ï¼šå°†å›¾åƒç”»å…¥ç”»å¸ƒ
            ctx.drawImage(img, 0, 0, width, height);
            
            // ğŸš¨ æ ¸å¿ƒï¼šå¯¼å‡º 0.7 è´¨é‡çš„ JPGï¼Œä½“ç§¯é€šå¸¸èƒ½ä» 5MB ç¼©å‡åˆ° 200KB
            // è¿™æ · IndexedDB å­˜å…¥æ—¶ä¼šéå¸¸å¿«ï¼Œä¸ä¼šå¯¼è‡´æ‰‹æœºå¡æ­»
            resolve(canvas.toDataURL('image/jpeg', 0.7));
        };
        img.onerror = (err) => {
            console.error("å›¾ç‰‡å‹ç¼©å¼•æ“å¼‚å¸¸:", err);
            resolve(base64); // å¤±è´¥æ—¶é€€å›åŸå›¾ï¼Œä¿è¯ç¨‹åºä¸å´©
        };
    });
}
</script>
</body>
</html>