<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Phone UI</title>
    <style>
        /* --- 全局设置 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            /* 换个稍微亮一点的壁纸图，更能显出磨砂玻璃效果 */
            background: url('https://images.unsplash.com/photo-1620121692029-d088224ddc74?q=80&w=2832&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            color: white; position: relative;
        }

        /* --- 1. 状态栏 --- */
        .status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 44px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 22px; z-index: 600;
            font-size: 15px; font-weight: 600; pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .status-right { display: flex; align-items: center; gap: 8px; }
        .battery-group { display: flex; align-items: center; gap: 5px; }
        .battery-shell {
            width: 25px; height: 12px; border: 1px solid rgba(255,255,255,0.5);
            border-radius: 3px; position: relative; padding: 1px; display: flex; align-items: center;
        }
        .battery-shell::after {
            content: ''; position: absolute; right: -4px; top: 50%; transform: translateY(-50%);
            width: 2px; height: 4px; background: rgba(255,255,255,0.5); border-radius: 0 2px 2px 0;
        }
        .battery-level { height: 100%; width: 100%; background-color: white; border-radius: 1px; }
        .charging-icon { display: none; font-size: 10px; color: #FFD700; }
        .signal-bars { display: flex; align-items: flex-end; gap: 2px; height: 12px; }
        .bar { width: 3px; background: rgba(255,255,255,0.3); border-radius: 1px; }
        .bar.active { background: white; }
        .bar:nth-child(1) { height: 4px; } .bar:nth-child(2) { height: 6px; }
        .bar:nth-child(3) { height: 9px; } .bar:nth-child(4) { height: 12px; }

        /* --- 2. 主屏幕滑动容器 --- */
        .home-slider {
            width: 100%; height: 100%; display: flex; overflow-x: auto;
            scroll-snap-type: x mandatory; padding-top: 50px;
        }
        .home-slider::-webkit-scrollbar { display: none; }

        .home-page {
            min-width: 100vw; height: 100%; scroll-snap-align: start;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 15px;
        }

        /* --- 3. 天气小组件 (完美复刻版) --- */
        .widget-weather {
            grid-column: span 2; grid-row: span 2;

            /* [关键] 高斯模糊 + 极淡的白色背景 */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); /* 毛玻璃核心 */
            border: 1px solid rgba(255, 255, 255, 0.15); /* 极细的边框 */
            border-radius: 22px;

            position: relative; /* 为了绝对定位城市名 */
            display: flex; flex-direction: column;
            align-items: center; /* 水平居中 */
            justify-content: center; /* 垂直居中 */

            padding: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* 城市名：固定左上角 */
        .weather-city {
            position: absolute;
            top: 15px; left: 18px;
            font-size: 15px; font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        /* 中间内容包裹层 */
        .weather-center-content {
            display: flex; flex-direction: column; align-items: center;
            margin-top: 30px; /* 稍微避开顶部的城市名 */
        }

        /* 图标 */
        .weather-svg {
            width: 52px; height: 52px;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* 温度：大号白色字体 */
        .weather-temp {
            font-size: 34px; font-weight: 300;
            margin-bottom: 2px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* 描述：稍微小一点，带透明度 */
        .weather-desc {
            font-size: 13px; font-weight: 400;
            opacity: 0.8; /* 灰色质感 */
            margin-bottom: 15px;
        }

        /* 底部日期：堆叠居中 */
        .weather-date-info {
            display: flex; flex-direction: column; align-items: center;
            font-size: 12px;
            opacity: 0.6; /* 也是灰色质感 */
            font-weight: 500;
            margin-top: auto; /* 推到底部 */
        }
        .date-row { margin-top: 2px; }


        /* --- 4. Dock 栏 (配合整体风格) --- */
        .dock-container {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 88%; height: 85px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 26px;
            display: flex; justify-content: space-evenly; align-items: center; z-index: 200;
        }
        .app-icon {
            width: 54px; height: 54px; border-radius: 14px;
            background: rgba(255, 255, 255, 0.95);
            display: flex; justify-content: center; align-items: center;
            font-size: 26px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.9); }

        /* --- 5. 升级版弹窗样式 (替换原来的弹窗样式) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4); z-index: 500;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); opacity: 0; transition: all 0.3s;
        }
        .modal-overlay.active { opacity: 1; }

        .modal-content {
            width: 85%; max-height: 70%;
            background: rgba(30,30,35,0.9);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            color: white; transform: scale(0.95); transition: all 0.3s;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        /* 标题栏 */
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: 600; }

        /* 搜索栏 */
        .search-box {
            width: 100%; padding: 10px 15px; margin-bottom: 15px;
            background: rgba(255,255,255,0.1); border-radius: 12px;
            border: none; outline: none; color: white; font-size: 14px;
        }
        .search-box::placeholder { color: rgba(255,255,255,0.4); }

        /* 地区分类 Tab */
        .tab-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn {
            flex: 1; padding: 8px; border-radius: 8px;
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.6); font-size: 13px; cursor: pointer;
        }
        .tab-btn.active { background: white; color: black; border-color: white; font-weight: 600; }

        /* 城市列表 (滚动区域) */
        .city-list {
            flex: 1; overflow-y: auto; margin-bottom: 15px;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;
        }
        .city-item {
            padding: 12px; margin-bottom: 5px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background 0.2s;
        }
        .city-item:active { background: rgba(255,255,255,0.1); }
        .city-item.selected { background: rgba(33, 150, 243, 0.3); border: 1px solid #2196F3; }
        .city-name { font-size: 15px; }
        .city-sub { font-size: 12px; opacity: 0.5; }

        /* 底部按钮组 */
        .modal-footer { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            font-size: 15px; font-weight: 500; cursor: pointer;
        }
        .btn-cancel { background: rgba(255,255,255,0.1); color: white; }
        .btn-save { background: #2196F3; color: white; }

        /* --- 照片小组件样式 --- */
        .widget-photo {
            /* 同样占据 2x2 的格子 */
            grid-column: span 2;
            grid-row: span 2;

            /* 保持和天气组件一样的玻璃风格 */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 22px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);

            /* 布局设置 */
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; /* 保证图片圆角不溢出 */
            cursor: pointer; position: relative;
            transition: transform 0.1s;
        }
        .widget-photo:active { transform: scale(0.96); }

        /* 默认显示的加号提示 */
        .photo-placeholder {
            display: flex; flex-direction: column; align-items: center;
            color: white; opacity: 0.7;
        }
        .plus-icon { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .add-text { font-size: 13px; font-weight: 500; }

        /* 真正显示图片的区域 (默认隐藏) */
        .photo-display {
            width: 100%; height: 100%;
            background-size: cover; background-position: center;
            display: none; /* 选了图再显示 */
        }

        /* --- 5. 音乐小组件 (精修版) --- */
        .widget-music {
            /* 1. 位置和背景 */
            grid-row: span 2;
            grid-column: span 4;
            background: rgba(255, 255, 255, 0.1); /* 背景淡一点 */
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); /* 阴影加重，更有立体感 */

            /* 2. 内部布局 */
            display: flex;
            align-items: center; /* 垂直居中 */
            padding: 20px 25px; /* 增加左右内边距 */
            gap: 20px; /* 封面和右边的间距 */
        }

        /* 封面图 */
        .music-cover {
            width: 85px; height: 85px; /* 稍微放大一点 */
            flex-shrink: 0;
            border-radius: 18px;
            background-size: cover; background-position: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* 封面阴影 */
            cursor: pointer; position: relative; overflow: hidden;
        }
        .music-cover:active { transform: scale(0.95); transition: 0.1s; }

        /* 右侧容器：核心修改 */
        .music-details-container {
            flex: 1;
            height: 85px; /* 强制高度和封面一样，方便对齐 */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 关键：让 歌名(上) 进度条(中) 按钮(下) 均匀分布 */
            overflow: hidden;
        }

        /* 歌名和歌手 */
        .music-text-group { cursor: pointer; }
        .song-title {
            font-size: 17px; font-weight: 700; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .artist-name {
            font-size: 13px; color: rgba(255,255,255,0.7);
            margin-top: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 进度条 */
        .progress-bar-bg {
            width: 100%; height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            cursor: pointer;
            margin-top: auto; margin-bottom: auto; /* 自动居中 */
        }
        .progress-bar-fill {
            width: 0%; height: 100%;
            background: white;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5); /* 进度条发光 */
            transition: width 0.1s linear;
        }

        /* 控制按钮 */
        .music-controls {
            display: flex;
            align-items: center;
            justify-content: center; /* 按钮居中 */
            gap: 25px; /* 按钮之间的间距加大 */
        }
        .control-btn {
            background: none; border: none; padding: 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .control-btn:active { transform: scale(0.85); opacity: 0.8; }

        /* 图标样式 */
        .ctrl-svg {
            width: 24px; height: 24px;
            fill: white; opacity: 0.8;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        .play-pause-btn .ctrl-svg {
            width: 32px; height: 32px; /* 播放键更大 */
            opacity: 1;
        }
        /* --- 6. 个人信息小组件 (透明背景) --- */
        .widget-profile {
            /* 占据第5行，第1-2列 */
            grid-row: 5; grid-column: span 2;

            /* 透明背景，无边框阴影 */
            background: transparent;
            box-shadow: none; border: none;

            /* 布局：垂直居中 */
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 10px;
        }

        /* 头像区域 */
        .profile-avatar {
            width: 70px; height: 70px;
            border-radius: 50%; /* 圆形 */
            /* 默认头像占位图 (灰色人像) */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" opacity="0.5"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
            background-size: cover; background-position: center;
            background-color: rgba(255,255,255,0.1); /* 微弱底色 */
            border: 2px solid rgba(255,255,255,0.3); /* 细白边框 */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; position: relative; overflow: hidden;
            margin-bottom: 10px; transition: transform 0.1s;
        }
        .profile-avatar:active { transform: scale(0.95); }

        /* 文字区域容器 */
        .profile-text { text-align: center; }

        /* 昵称样式 */
        .profile-nickname {
            font-size: 18px; font-weight: 700; color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;
            margin-bottom: 4px;
        }

        /* 个性签名样式 */
        .profile-signature {
            font-size: 13px; color: rgba(255,255,255,0.7);
            cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;
        }

        /* --- 编辑弹窗专用样式 (复用基础结构，微调输入框) --- */
        #profile-edit-input {
            background: rgba(255,255,255,0.15);
            font-size: 16px; padding: 15px;
            text-align: center;
        }

        /* --- 7. App 图标 (液态玻璃终极版) --- */
        .grid-app-item {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }

        /* 液态玻璃主体 */
        .app-icon-shape {
            width: 64px; height: 64px;
            border-radius: 18px; /* 圆角稍微大一点，更像水滴 */
            display: flex; align-items: center; justify-content: center;

            /* 核心1：强力毛玻璃 */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);

            /* 核心2：玻璃质感的边框 (上亮下暗) */
            border-top: 1.5px solid rgba(255, 255, 255, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);

            /* 核心3：内发光 + 外部投影 (制造液态厚度感) */
            box-shadow:
                inset 0 0 15px rgba(255, 255, 255, 0.2), /* 内部通透光 */
                0 8px 20px rgba(0, 0, 0, 0.15); /* 底部柔和投影 */

            margin-bottom: 6px;
            transition: transform 0.1s; cursor: pointer;
            position: relative; overflow: hidden;
        }

        /* 增加一个流光高光层，让它看起来更润 */
        .app-icon-shape::before {
            content: ''; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 40%);
            pointer-events: none;
        }

        .app-icon-shape:active { transform: scale(0.92); filter: brightness(1.1); }

        /* 图标里的 SVG */
        .app-svg {
            width: 30px; height: 30px;
            fill: white;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); /* 图标悬浮感 */
            z-index: 2; /* 浮在流光上面 */
        }

        .app-label {
            font-size: 12px; font-weight: 500; color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.6);
            letter-spacing: 0.3px;
        }

        /* --- 液态特调色 (半透明渐变，透出背景) --- */

        /* 壁纸：液态紫粉 */
        .bg-wallpaper {
            background: linear-gradient(135deg, rgba(199, 158, 253, 0.5) 0%, rgba(246, 128, 132, 0.5) 100%);
        }

        /* 设置：液态银灰 (带一点冷蓝) */
        .bg-settings {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(155, 197, 195, 0.4) 100%);
        }

        /* 聊天：液态薄荷绿 */
        .bg-chat {
            background: linear-gradient(135deg, rgba(66, 230, 149, 0.5) 0%, rgba(59, 178, 184, 0.5) 100%);
        }

        /* 音乐：液态果冻橙 */
        .bg-music {
            background: linear-gradient(135deg, rgba(255, 154, 158, 0.5) 0%, rgba(254, 207, 239, 0.5) 100%);
        }

        /* --- 8. Dock 栏图标 (液态玻璃版) --- */
        .dock-icon {
            width: 55px; height: 55px;
            border-radius: 16px; /* 稍微圆润一点 */
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;

            /* 核心：液态玻璃质感 (和上面保持一致) */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1.5px solid rgba(255, 255, 255, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.4);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.25), 0 5px 15px rgba(0, 0, 0, 0.2);

            position: relative; overflow: hidden; transition: transform 0.1s;
        }

        /* 流光效果 */
        .dock-icon::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 50%);
            pointer-events: none;
        }

        .dock-icon:active { transform: scale(0.9); filter: brightness(1.1); }

        /* --- 专属颜色 (半透明液态) --- */

        /* 1. 角色书 (Role Book): 梦幻蓝紫 -> 代表人物灵魂 */
        .bg-role { background: linear-gradient(135deg, rgba(64, 196, 255, 0.6) 0%, rgba(101, 31, 255, 0.6) 100%); }

        /* 2. 世界书 (World Book): 深邃青绿 -> 代表宏大世界 */
        .bg-world { background: linear-gradient(135deg, rgba(29, 233, 182, 0.6) 0%, rgba(0, 105, 92, 0.6) 100%); }

        /* 3. 说明书 (Manual): 温暖琥珀 -> 代表指引 */
        .bg-manual { background: linear-gradient(135deg, rgba(255, 215, 64, 0.6) 0%, rgba(255, 111, 0, 0.6) 100%); }

        /* 4. 图标App (Icons): 炫彩粉红 -> 代表设计与美 */
        .bg-gallery { background: linear-gradient(135deg, rgba(255, 64, 129, 0.6) 0%, rgba(197, 17, 98, 0.6) 100%); }

        /* --- 9. 壁纸 App (全屏覆盖) --- */
        .app-window {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(20, 20, 25, 0.95); /* 深色背景，突出内容 */
            backdrop-filter: blur(20px);
            z-index: 400; /* 盖住主屏幕 */
            display: none; flex-direction: column;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .app-window.active { opacity: 1; }

        /* --- 修改后的头部样式 (适配状态栏) --- */
        .app-header {
            /* 高度加高：44px(状态栏) + 46px(实际标题栏) = 90px */
            height: 90px;
            /* 顶部留白：把内容往下顶，避开状态栏 */
            padding-top: 44px;

            display: flex; align-items: center; justify-content: center;
            position: relative;
            border-bottom: 1px solid rgba(255,255,255,0.1);

            /* 加深一点背景，防止壁纸太花导致看不清状态栏 */
            background: rgba(20, 20, 25, 0.8);
            backdrop-filter: blur(20px);
        }

        .app-back-btn {
            position: absolute;
            left: 15px;
            /* 关键修改：按钮往下移，不再和时间重叠 */
            top: 58px;

            font-size: 16px; color: #2196F3; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
            z-index: 10;
        }

        /* 内容区域 */
        .wallpaper-content {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* 分类标题 */
        .section-title { font-size: 20px; font-weight: 700; margin-bottom: 10px; color: white; }

        /* 预览卡片 */
        .preview-card {
            background: rgba(255,255,255,0.1);
            border-radius: 18px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* 预览视窗 (模拟手机屏幕比例) */
        .preview-viewport {
            width: 160px; height: 284px; /* 约 9:16 比例 */
            background: #333; border-radius: 12px; margin-bottom: 15px;
            overflow: hidden; position: relative;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* 预览图/视频 */
        .preview-img, .preview-video { width: 100%; height: 100%; object-fit: cover; }

        /* 按钮组 */
        .btn-group { display: flex; gap: 10px; width: 100%; }
        .action-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-upload { background: rgba(255,255,255,0.15); color: white; }
        .btn-apply { background: #2196F3; color: white; opacity: 0.5; pointer-events: none; } /* 默认禁用 */
        .btn-apply.ready { opacity: 1; pointer-events: all; }

        /* --- 12. 设置页高级 UI (iOS 分组风格) --- */

        /* 搜索栏容器 */
        .search-container {
            padding: 10px 16px;
            background: #1c1c1e; /* 与页面背景一致 */
            position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid rgba(255,255,255,0.05); /* 极细分割线 */
        }
        /* 搜索输入框 */
        .settings-search {
            width: 100%; height: 38px;
            background: #2c2c2e; /* 稍微亮一点的灰 */
            border-radius: 10px; border: none; outline: none;
            color: white; font-size: 16px; text-align: center;
            transition: all 0.2s;
        }
        .settings-search:focus { text-align: left; padding-left: 36px; background: #3a3a3c; }

        /* 列表容器 */
        #timezone-list-container {
            padding: 0 16px 40px 16px; /* 给底部留点空 */
            background: #000000; /* 纯黑背景，对比卡片 */
        }

        /* 分类标题 (如：亚洲) */
        .group-header {
            font-size: 13px; color: #8e8e93; font-weight: 500;
            margin: 20px 0 8px 12px; /* 留出一点缩进 */
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 卡片分组容器 */
        .settings-group {
            background: #1c1c1e; /* 卡片颜色 */
            border-radius: 12px;
            overflow: hidden;
        }

        /* 单个列表项 */
        .settings-item {
            background: transparent;
            padding: 14px 16px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; position: relative;
            transition: background 0.2s;
        }
        .settings-item:active { background: #3a3a3c; }

        /* 分割线 (核心高级感来源：左侧缩进) */
        .settings-item:not(:last-child)::after {
            content: ''; position: absolute;
            bottom: 0; right: 0; height: 0.5px; /* 极细 */
            width: calc(100% - 16px); /* 左侧留出间距 */
            background: #38383a;
        }

        /* 城市文字 */
        .city-name { font-size: 17px; color: white; font-weight: 400; }
        .city-detail { font-size: 12px; color: #8e8e93; margin-top: 2px; }

        /* 选中状态 */
        .check-icon { color: #0a84ff; font-weight: 600; font-size: 16px; display: none; }
        .settings-item.selected .check-icon { display: block; }
        .settings-item.selected .city-name { color: #0a84ff; font-weight: 500; }

        /* --- 关键修复：子页面样式 (没这个点击就没反应) --- */
        .sub-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #1c1c1e; /* 纯黑背景 */
            z-index: 500; /* 层级要高 */
            display: flex; flex-direction: column;
            transform: translateX(100%); /* 默认藏在右边 */
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); /* 滑动动画 */
        }
        .sub-page.active { transform: translateX(0); /* 激活时滑出来 */ }

        /* --- 关键修复：胶囊通知样式 (没这个保存会报错) --- */
        .toast-capsule {
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(255, 255, 255, 0.95); color: #333;
            padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: all 0.4s;
        }
        .toast-capsule.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-icon {
            width: 18px; height: 18px; background: #4CAF50; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;
        }

        /* --- 14. 主题系统 & 代码编辑器 --- */

        /* 浅色模式 (Light Mode) 的覆盖样式 */
        /* 当 body 带有 .light-theme 类名时生效 */
        body.light-theme {
            color: #000000; /* 全局文字变黑 */
        }
        body.light-theme .app-window,
        body.light-theme .sub-page,
        body.light-theme .app-header,
        body.light-theme .search-container,
        body.light-theme .settings-group,
        body.light-theme .preview-card,
        body.light-theme .chat-input-area {
            background: rgba(242, 242, 247, 0.95) !important; /* 变成亮灰白 */
            color: #000;
        }
        body.light-theme .settings-item {
            background: white !important; /* 列表项变纯白 */
            color: #000;
        }
        body.light-theme .app-title,
        body.light-theme .city-name,
        body.light-theme .settings-search {
            color: #000 !important;
        }
        body.light-theme .settings-search {
            background: rgba(118, 118, 128, 0.12); /* 搜索框变浅 */
        }
        body.light-theme .item-value,
        body.light-theme .city-detail,
        body.light-theme .item-arrow {
            color: rgba(60, 60, 67, 0.6) !important;
        }
        body.light-theme .chat-input {
            background: rgba(0,0,0,0.05); color: black;
        }
        body.light-theme .chat-input::placeholder { color: rgba(0,0,0,0.3); }

        /* 代码编辑器样式 */
        .code-editor-container {
            width: 100%; height: 300px;
            background: #1e1e1e; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px; margin-top: 15px;
            font-family: 'Courier New', monospace;
            display: none; /* 默认隐藏，选自定义时显示 */
        }
        .code-textarea {
            width: 100%; height: 100%;
            background: transparent; border: none; outline: none;
            color: #d4d4d4; font-size: 13px; line-height: 1.5;
            resize: none;
        }
        .theme-options { display: flex; gap: 10px; margin-bottom: 15px; }
        .theme-btn {
            flex: 1; padding: 15px; border-radius: 12px;
            background: rgba(255,255,255,0.1); border: 2px solid transparent;
            color: white; font-size: 14px; cursor: pointer; text-align: center;
        }
        .theme-btn.active { border-color: #0a84ff; background: rgba(10, 132, 255, 0.1); }

        /* --- 修复浅色模式下的时区列表背景 --- */
        body.light-theme #timezone-list-container,
        body.light-theme #lang-list-container {
            background: #f2f2f7 !important; /* 变成浅灰色背景 */
        }

        /* 修复浅色模式下的分组标题颜色 */
        body.light-theme .group-header {
            color: #6d6d72 !important; /* 深灰色文字 */
        }

        /* 修复浅色模式下的分割线 */
        body.light-theme .settings-item:not(:last-child)::after {
            background: #c6c6c8 !important;
        }

       /* ================== AI 设置页 (防弹修复版) ================== */

        /* 1. 页面容器：强制允许滚动 */
        #sub-ai-model .wallpaper-content {
            padding: 20px 16px 150px 16px !important; /* 底部留足空间 */
            overflow-y: auto !important;
            height: 100% !important;
            display: block !important; /* 防止 flex 布局导致被挤压 */
        }

        /* 2. 分组卡片：深色背景 */
        .ai-group-card {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            margin-bottom: 24px !important;
            overflow: hidden !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
        }

        /* 3. 单行列表：标准高度，白色文字 */
        .ai-list-item {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 16px !important;
            min-height: 54px !important; /* 保证高度 */
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1) !important;
            background: transparent !important;
        }
        .ai-list-item:last-child { border-bottom: none !important; }
        .ai-list-item:active { background: rgba(255,255,255,0.1) !important; }

        /* 4. 左侧标签 */
        .ai-item-label {
            font-size: 16px !important;
            color: white !important;
            white-space: nowrap !important;
            width: 80px !important; /* 固定宽度 */
            flex-shrink: 0 !important;
        }
        .ai-item-label.blue { color: #0a84ff !important; width: auto !important; flex: 1 !important; }

        /* 5. 右侧输入框/文字：强制白色，无背景 */
        .ai-item-input {
            flex: 1 !important;
            width: 100% !important;
            background: transparent !important;
            border: none !important;
            outline: none !important;
            text-align: right !important;
            font-size: 16px !important;
            color: rgba(255,255,255,0.8) !important; /* 亮灰色 */
            padding: 0 !important;
            height: auto !important;
        }
        .ai-item-input:focus { color: white !important; }
        /* 占位符颜色 */
        .ai-item-input::placeholder { color: rgba(255,255,255,0.3) !important; }

        /* 6. 测试面板：黑底绿字 */
        .ai-test-box {
            background: #1c1c1e !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }
        .ai-test-log {
            background: #000 !important;
            color: #00ff00 !important;
            font-family: monospace !important;
            padding: 15px !important;
            height: 150px !important; /* 固定高度 */
            overflow-y: auto !important;
            font-size: 12px !important;
        }
        .ai-test-input-bar {
            padding: 10px !important;
            background: #2c2c2e !important;
            display: flex !important;
            gap: 10px !important;
        }
        .ai-test-input {
            flex: 1 !important;
            height: 36px !important;
            background: rgba(118, 118, 128, 0.5) !important; /* 灰色背景 */
            border-radius: 18px !important;
            border: none !important;
            padding: 0 15px !important;
            color: white !important;
        }

        /* 标题 */
        .ai-header-text {
            font-size: 13px !important; color: #8e8e93 !important;
            margin: 0 0 8px 12px !important; text-transform: uppercase !important;
        }

        /* ================== 21. AI 设置页浅色模式适配 (Light Mode Patch) ================== */

        /* 1. 页面背景变亮灰 */
        body.light-theme #sub-ai-model,
        body.light-theme #sub-model-select,
        body.light-theme #sub-config-list {
            background: #f2f2f7 !important; /* iOS 浅色背景 */
        }

        /* 2. 卡片变纯白 */
        body.light-theme .ai-group-card {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important; /* 极淡的边框 */
        }

        /* 3. 分割线变浅 */
        body.light-theme .ai-list-item {
            border-bottom: 0.5px solid rgba(60, 60, 67, 0.18) !important; /* 浅灰分割线 */
        }

        /* 4. 左侧文字变黑 */
        body.light-theme .ai-item-label {
            color: #000000 !important;
        }
        /* 蓝色文字保持蓝色，不用改 */

        /* 5. 右侧输入框/文字变深灰 */
        body.light-theme .ai-item-input {
            color: rgba(60, 60, 67, 0.6) !important; /* 次级文字深灰 */
        }
        /* 输入时全黑 */
        body.light-theme .ai-item-input:focus {
            color: #000000 !important;
        }
        /* 占位符浅灰 */
        body.light-theme .ai-item-input::placeholder {
            color: rgba(60, 60, 67, 0.3) !important;
        }

        /* 6. 分组标题变深灰 */
        body.light-theme .ai-header-text {
            color: #6d6d72 !important;
        }

        /* 7. 测试面板适配 */
        body.light-theme .ai-test-box {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
        }
        /* 底部输入栏变浅灰 */
        body.light-theme .ai-test-input-bar {
            background: #f2f2f7 !important;
        }
        /* 输入框变白 */
        body.light-theme .ai-test-input {
            background: #ffffff !important;
            color: #000000 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* 加一点小投影 */
        }

        /* 8. 顶部导航栏适配 */
        body.light-theme .app-header {
            background: rgba(249, 249, 249, 0.9) !important;
            border-bottom: 1px solid rgba(0,0,0,0.1) !important;
        }
        body.light-theme .app-title {
            color: #000000 !important;
        }

        /* ================== 22. 字体设置页 (Font Settings) ================== */

        /* 1. 定义全局变量 (默认值) */
        :root {
            --ui-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --ui-weight: 400;
            --ui-size-adjust: 0px; /* 字体大小微调值 */
        }

        /* 2. 强制应用到全局 */
        body, button, input, select, textarea {
            font-family: var(--ui-font) !important;
            font-weight: var(--ui-weight) !important;
            /* 这里我们用 transform 或者 calc 来微调大小，防止布局炸裂 */
            /* 但为了简单有效，我们在 body 上微调 fontSize */
        }

        /* 3. 字体预览卡片 */
        .font-preview-card {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            padding: 30px 20px !important;
            margin: 0 16px 24px 16px !important;
            text-align: center !important;
            border: 1px solid rgba(255,255,255,0.05) !important;
            transition: all 0.2s;
        }
        .preview-text-en { font-size: 24px; margin-bottom: 10px; display: block; }
        .preview-text-cn { font-size: 20px; opacity: 0.8; display: block; }

        /* 4. 滑块容器 */
        .slider-container {
            background: #2c2c2e !important;
            border-radius: 12px !important;
            padding: 16px !important;
            margin: 0 16px 24px 16px !important;
        }
        .slider-header {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-size: 14px; color: white;
        }

        /* 5. 美化滑块 (Range Input) */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]:focus { outline: none; }
        /* 轨道 */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: rgba(118, 118, 128, 0.24); border-radius: 3px;
        }
        /* 滑块头 */
        input[type=range]::-webkit-slider-thumb {
            height: 24px; width: 24px; border-radius: 50%;
            background: #ffffff; cursor: pointer;
            -webkit-appearance: none; margin-top: -9px; /* 居中 */
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* 浅色模式适配 */
        body.light-theme .font-preview-card,
        body.light-theme .slider-container {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important;
        }
        body.light-theme .slider-header { color: black !important; }

        /* --- 23. 字体页滑动修复补丁 --- */

        /* 强制给字体页内容区加超大底部留白，保证按钮能滑上来 */
        #sub-font .wallpaper-content {
            padding-bottom: 180px !important;
            overflow-y: auto !important;
            height: 100% !important;
            display: block !important; /* 防止 Flex 布局导致无法滚动 */
        }

        /* 修复预览卡片在小屏幕可能太高的问题 */
        .font-preview-card {
            padding: 20px !important;
            margin-bottom: 20px !important;
        }

        /* ================== 24. 字体大小全局联动补丁 ================== */

        :root {
            /* 定义一个默认值，防止JS未加载时变乱 */
            --app-font-size: 16px;
        }

        /* 1. 强制所有主要文字跟随变量 */
        body,
        .settings-item,
        .ai-label,
        .ai-input,
        .form-label,
        .form-input,
        .city-name,
        .chat-input,
        .msg-bubble,
        .song-title,
        .profile-nickname {
            /* 使用 calc 计算，确保优先级最高 */
            font-size: var(--app-font-size) !important;
        }

        /* 2. 标题类 (比正文大 2px) */
        .app-title,
        .preview-text-en,
        .preview-text-cn {
            font-size: calc(var(--app-font-size) + 4px) !important;
        }

        /* 3. 辅助文字类 (比正文小 3px) */
        .city-detail,
        .item-value,
        .ios-header,
        .group-header,
        .ai-section-header,
        .app-label,
        .profile-signature,
        .artist-name {
            font-size: calc(var(--app-font-size) - 3px) !important;
        }

        /* 4. 预览卡片文字跟随 */
        #font-preview-box span {
            font-family: var(--ui-font) !important;
            font-weight: var(--ui-weight) !important;
        }
                /* --- 25. 按钮样式强制补丁 --- */

        /* 按钮容器 */
        .ai-btn-group {
            display: flex !important;
            gap: 15px !important;
            margin: 20px 16px 40px 16px !important;
        }

        /* 按钮通用样式 */
        .ai-btn {
            flex: 1 !important;
            height: 48px !important;
            border-radius: 12px !important;
            border: none !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: opacity 0.2s !important;
        }
        .ai-btn:active { opacity: 0.7 !important; transform: scale(0.98) !important; }

        /* 主按钮 (深蓝) */
        .ai-btn-primary {
            background: #0a84ff !important;
            color: white !important;
        }

        /* 次按钮 (浅蓝透明) */
        .ai-btn-secondary {
            background: rgba(10, 132, 255, 0.15) !important;
            color: #0a84ff !important;
        }

        /* 浅色模式适配 */
        body.light-theme .ai-btn-secondary {
            background: rgba(0, 122, 255, 0.1) !important;
        }

        /* ================== 26. 图标设置 App 样式 ================== */

        /* 图标预览容器 (复用 preview-card，但更紧凑) */
        .icon-preview-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 16px !important;
            padding: 15px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            margin-bottom: 15px !important;
        }

        /* 左侧：图标名称和预览 */
        .icon-info-group {
            display: flex; align-items: center; gap: 15px;
        }

        /* 预览图标本身的形状 (复用主屏幕图标样式) */
        .preview-icon-shape {
            width: 54px; height: 54px;
            border-radius: 14px;
            /* 默认样式，会被 JS 覆盖 */
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
            background-size: cover; background-position: center;
            position: relative; overflow: hidden;
        }

        /* 预览图标里的默认SVG */
        .preview-icon-svg {
            width: 24px; height: 24px; fill: white; opacity: 0.8;
            z-index: 2;
        }

        /* 右侧：按钮组 */
        .icon-btn-group {
            display: flex; gap: 10px;
        }
        /* 小按钮样式 */
        .icon-btn {
            padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: none;
        }
        .btn-change { background: rgba(10, 132, 255, 0.15); color: #0a84ff; }
        .btn-reset { background: rgba(255, 59, 48, 0.15); color: #FF3B30; }

        /* 浅色模式适配 */
        body.light-theme .icon-preview-card {
            background: #ffffff !important; border-color: rgba(0,0,0,0.05) !important;
        }
        body.light-theme .preview-icon-shape {
            border-top-color: rgba(255,255,255,0.8);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* ================== 28. 图标显示强制修复补丁 (Final Fix) ================== */

        /* 1. 强制设置背景图大小和位置 (没了这句，图片会放大几十倍导致看不见) */
        #icon-home-wallpaper, #icon-home-settings, #icon-home-chat, #icon-home-music,
        #icon-dock-role, #icon-dock-world, #icon-dock-manual, #icon-dock-gallery,
        .preview-icon-shape {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        /* 2. 当有背景图时，移除默认背景色和模糊 (避免透底) */
        /* 注意：这里使用属性选择器来检测行内样式 */
        .app-icon-shape[style*="background-image"],
        .dock-icon[style*="background-image"],
        .preview-icon-shape[style*="background-image"] {
            background-color: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important; /* 可选：去掉阴影让图片更纯粹 */
            border: none !important;     /* 可选：去掉边框 */
        }

        /* ================== 29. 角色书 App 样式 (列表版) ================== */

        /* 1. 列表容器：改为垂直排列 */
        .role-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
            padding: 10px 0 80px 0 !important; /* 底部留白 */
        }

        /* 2. 角色卡片：横向布局 (左图右文) */
        .role-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 16px !important;
            padding: 15px !important;
            display: flex !important;
            flex-direction: row !important; /* 横向排列 */
            align-items: center !important; /* 垂直居中 */
            border: 1px solid rgba(255,255,255,0.1) !important;
            cursor: pointer !important;
            transition: background 0.2s !important;
        }
        .role-card:active { background: rgba(255,255,255,0.15) !important; }

        /* 3. 头像：变成圆形，固定大小 */
        .role-card-img {
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important; /* 圆形 */
            object-fit: cover !important;
            background-color: #333 !important;
            background-size: cover !important;
            background-position: center !important;
            flex-shrink: 0 !important; /* 禁止压缩 */
            margin-right: 15px !important; /* 和文字的间距 */
            border: 1px solid rgba(255,255,255,0.2) !important;
        }

        /* 4. 文字信息区 */
        .role-card-info {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            overflow: hidden !important; /* 防止文字溢出 */
            padding: 0 !important; /* 去掉之前的内边距 */
        }

        /* 名字 */
        .role-card-name {
            font-size: 17px !important;
            font-weight: 600 !important;
            color: white !important;
            margin-bottom: 4px !important;
        }

        /* 描述 (单行省略) */
        .role-card-desc {
            font-size: 13px !important;
            color: rgba(255,255,255,0.6) !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* --- 角色详情页样式 (保持不变，但确保适配) --- */
        .role-header-bg {
            width: 100%; height: 240px;
            background-color: #333;
            background-size: cover; background-position: center;
            position: relative;
        }
        .role-header-bg::after {
            content: '点击更换背景'; position: absolute; bottom: 10px; right: 10px;
            font-size: 10px; color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.4); padding: 4px 8px; border-radius: 4px;
            backdrop-filter: blur(4px);
        }
        .role-avatar-container {
            margin-top: -60px; display: flex; justify-content: center; position: relative; z-index: 10;
        }
        .role-big-avatar {
            width: 110px; height: 110px; border-radius: 50%;
            border: 4px solid #1c1c1e; /* 深色模式下的描边 */
            background-size: cover; background-position: center; background-color: #444;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .role-detail-content { padding: 15px 20px 100px 20px; text-align: center; }
        .role-detail-name { font-size: 24px; font-weight: 700; color: white; margin-bottom: 10px; }
        .role-detail-desc {
            font-size: 15px; color: rgba(255,255,255,0.85); line-height: 1.6; text-align: left;
            white-space: pre-wrap; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px;
        }

        /* --- 浅色模式适配 (关键要求) --- */
        body.light-theme .role-card {
            background: #ffffff !important; /* 白底 */
            border: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05) !important;
        }
        body.light-theme .role-card-name { color: #000000 !important; }
        body.light-theme .role-card-desc { color: rgba(60,60,67,0.6) !important; }

        /* 详情页浅色适配 */
        body.light-theme .role-big-avatar { border-color: #f2f2f7 !important; } /* 头像描边变白 */
        body.light-theme .role-detail-name { color: #000000 !important; }
        body.light-theme .role-detail-desc { background: #ffffff !important; color: #333 !important; }

        /* ================== 30. 世界书 App 样式 ================== */

        /* 1. 世界书列表项 */
        .world-card {
            background: rgba(255,255,255,0.08) !important;
            border-radius: 12px !important;
            padding: 16px !important;
            margin-bottom: 12px !important;
            display: flex !important;
            align-items: flex-start !important;
            cursor: pointer !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            transition: background 0.2s !important;
        }
        .world-card:active { background: rgba(255,255,255,0.15) !important; }

        /* 左侧固定图标 */
        .world-icon-box {
            width: 40px; height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #11998e, #38ef7d); /* 青绿色渐变 */
            display: flex; justify-content: center; align-items: center;
            margin-right: 15px; flex-shrink: 0;
        }

        /* 右侧文字 */
        .world-info { flex: 1; overflow: hidden; }
        .world-title { font-size: 17px; font-weight: 600; color: white; margin-bottom: 6px; }
        .world-preview {
            font-size: 13px; color: rgba(255,255,255,0.5);
            display: -webkit-box; -webkit-line-clamp: 2; /* 最多显示2行 */
            -webkit-box-orient: vertical; overflow: hidden;
            line-height: 1.5;
        }

        /* 2. 世界书详情页 */
        .world-detail-container {
            padding: 20px;
            height: 100%;
            display: flex; flex-direction: column;
        }
        .world-detail-header {
            font-size: 28px; font-weight: 800; color: white;
            margin-bottom: 20px; padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .world-detail-body {
            font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.9);
            white-space: pre-wrap; /* 保留换行符 */
            flex: 1; overflow-y: auto;
        }

        /* 浅色模式适配 */
        body.light-theme .world-card { background: white !important; border-color: rgba(0,0,0,0.05) !important; }
        body.light-theme .world-title, body.light-theme .world-detail-header { color: black !important; }
        body.light-theme .world-preview, body.light-theme .world-detail-body { color: #333 !important; }

        /* ================== 音乐 App 终极修复 CSS ================== */

        /* 1. 弹窗层级修复 (强制置顶) */
        .modal-overlay {
            z-index: 2000 !important; /* 必须最高，防止点不动 */
        }

        /* 2. 音乐 App 主窗口容器 */
        #app-music {
            background: #121212; /* 默认黑底 */
            overflow: hidden;
        }

        /* 3. 列表视图 (层级 10) */
        #music-view-list {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex; flex-direction: column;
            background: linear-gradient(180deg, rgba(30,30,30,0.8) 0%, #000 100%); /* 列表自带渐变底 */
        }

        /* 列表头部按钮 (修复重叠元凶) */
        .header-add-btn {
            position: absolute; right: 15px; top: 58px;
            width: 32px; height: 32px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; /* 只要比列表背景高就行 */
        }

        /* 4. 全屏播放器 (层级 100 - 彻底盖住列表) */
        #music-view-full {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; /* 比列表高 */
            display: flex; flex-direction: column;

            /* 关键修复：给一个实心背景，不再依赖透明遮罩 */
            background-color: #1c1c1e;
            /* 动态背景图会覆盖在上面，这里是保底色 */

            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            background: transparent; /* 关键：变成透明，让下面的图片透出来 */
        }

        #music-view-full.active {
            transform: translateY(0);
        }

        /* 全屏动态背景层 */
        /* 修改后：*/
        #full-player-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1c1c1e; /* 关键：默认底色移到这里 */
            background-size: cover; background-position: center;
            z-index: -1;
            /* 如果不想让背景太模糊，可以把 blur(30px) 改小或者去掉 */
            filter: blur(30px);
            transition: background-image 0.5s;
        }

        /* 5. 布局优化 (解决下方空隙) */
        .full-player-content {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: space-evenly; /* 均匀分布 */
            align-items: center;
            padding: 0 30px 40px 30px;
        }

        /* 唱片 (加大尺寸) */
        .disk-wrapper {
            flex: 2; display: flex; align-items: center; justify-content: center;
            width: 100%;
        }
        .disk-cover {
            width: 280px; height: 280px; border-radius: 50%;
            background-color: #333; background-size: cover; background-position: center;
            border: 4px solid rgba(255,255,255,0.1);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            animation: rotate 24s linear infinite; animation-play-state: paused;
        }
        .disk-cover.playing { animation-play-state: running; }

        /* 进度条 */
        .fp-progress-container { width: 100%; margin: 20px 0; }
        .fp-slider {
            width: 100%; height: 4px; background: rgba(255,255,255,0.2);
            border-radius: 2px; -webkit-appearance: none;
        }
        .fp-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: white; border-radius: 50%;
        }
        .time-row {
            display: flex; justify-content: space-between;
            font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;
        }

        /* 6. 图标按钮美化 */
        .fp-controls {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
        }
        .fp-ctrl-btn {
            background: none; border: none; padding: 0; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: white; /* 确保 SVG 继承颜色 */
        }
        .fp-ctrl-btn svg { fill: white; width: 26px; height: 26px; }
        .fp-ctrl-btn.small svg { width: 22px; height: 22px; opacity: 0.5; }
        .fp-ctrl-btn.big svg { width: 60px; height: 60px; } /* 播放键加大 */
        .fp-ctrl-btn:active { opacity: 0.7; transform: scale(0.95); }

        /* 头部功能按钮 */
        .fp-icon-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: none;
            display: flex; align-items: center; justify-content: center;
            margin-left: 10px; cursor: pointer;
        }
        .fp-icon-btn svg { width: 20px; height: 20px; fill: white; }
                /* --- 1. 修复音乐列表样式 --- */
        .music-list-item {
            display: flex;             /* 让图片和文字横排 */
            align-items: center;       /* 垂直居中 */
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.08); /* 玻璃半透明背景 */
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
        }
        .music-list-item:active { background: rgba(255,255,255,0.15); }
        .music-list-item.active-playing { border-color: #0a84ff; background: rgba(10,132,255,0.1); }

        /* 列表里的封面小图 */
        .song-img-box {
            width: 50px; height: 50px;
            border-radius: 8px;
            background-size: cover; background-position: center;
            background-color: #333;
            margin-right: 15px; flex-shrink: 0;
        }

        /* 列表里的文字区 */
        .song-info-box {
            flex: 1;
            display: flex; flex-direction: column; justify-content: center;
            overflow: hidden;
        }
        .song-list-title { font-size: 16px; font-weight: 600; color: white; margin-bottom: 4px; }
        .song-list-artist { font-size: 13px; color: rgba(255,255,255,0.6); }

        /* 列表里的按钮 */
        .song-action-btn {
            width: 36px; height: 36px;
            border-radius: 50%; border: none; background: transparent;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: pointer;
        }

        /* --- 2. 修复迷你播放器样式 --- */
        .mini-player {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 64px;
            background: rgba(40,40,45,0.95); /* 深色背景 */
            border-radius: 32px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; padding: 0 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            z-index: 50; /* 保证浮在列表上面 */
        }
        .mini-cover {
            width: 48px; height: 48px; border-radius: 50%;
            background-color: #333; background-size: cover; background-position: center;
            margin-right: 12px; margin-left: 2px;
        }
        .mini-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .mini-title { font-size: 14px; font-weight: 600; color: white; }
        .mini-artist { font-size: 12px; color: #888; }
        .mini-controls { display: flex; gap: 5px; margin-right: 5px; }
        .mini-btn { background: none; border: none; font-size: 20px; color: white; padding: 5px; cursor: pointer; }

        /* --- 3. 修复旋转动画 (如果没转就是少了这段) --- */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
                /* --- 底部动作菜单样式 (Action Sheet) --- */
        .action-sheet-content {
            width: 95%; max-width: 400px;
            z-index: 2100; /* 比遮罩层高 */
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* 激活时滑上来 */
        #modal-song-menu.active .action-sheet-content {
            transform: translateY(0);
        }

        .sheet-group {
            background: rgba(30, 30, 35, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 14px;
            overflow: hidden;
        }

        .sheet-item {
            height: 56px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; color: white;
            cursor: pointer;
            background: transparent;
        }
        .sheet-item:active { background: rgba(255,255,255,0.1); }
                /* ================== 修复补丁：去模糊 & 浅色模式适配 ================== */

        /* 1. 【核心修复】去背景虚化 */
        #full-player-bg {
            filter: none !important; /* 强制去掉模糊 */
            opacity: 1 !important;   /* 强制不透明，显示原图色彩 */
            background-color: #222;  /* 如果没图时的保底色 */
        }

        /* 2. 【核心修复】浅色模式适配 (Light Mode) */

        /* 列表页背景变白 */
        body.light-theme #app-music {
            background: #f2f2f7 !important; /* 浅灰底 */
        }
        body.light-theme #music-view-list {
            background: transparent !important; /* 去掉之前的深色渐变 */
        }

        /* 列表头部文字和按钮变黑 */
        body.light-theme .app-title,
        body.light-theme .app-back-btn {
            color: #000000 !important;
        }
        body.light-theme .app-back-btn svg,
        body.light-theme .header-add-btn svg {
            fill: #000000 !important;
        }
        body.light-theme .header-add-btn {
            background: rgba(0,0,0,0.05) !important;
        }

        /* 列表项变白底黑字 */
        body.light-theme .music-list-item {
            background: #ffffff !important;
            border: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        body.light-theme .song-list-title {
            color: #000000 !important;
        }
        body.light-theme .song-list-artist {
            color: rgba(60,60,67,0.6) !important;
        }

        /* 列表右侧的三个点和插队图标 -> 变成黑色 */
        /* 这里使用滤镜直接反转白色图标，省去改 JS 的麻烦 */
        body.light-theme .song-action-btn svg {
            filter: invert(1) !important; /* 白色变黑色 */
            opacity: 0.6;
        }

        /* 迷你播放器适配 */
        body.light-theme .mini-player {
            background: rgba(255,255,255,0.95) !important;
            border: 1px solid rgba(0,0,0,0.1) !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1) !important;
        }
        body.light-theme .mini-title { color: #000 !important; }
        body.light-theme .mini-controls svg {
            fill: #000 !important; /* 按钮变黑 */
        }

        /* --- 全屏播放器浅色适配 (仅在没有自定义背景图时生效) --- */
        /* 如果用户没传背景图，背景也是浅色的 */
        body.light-theme #full-player-bg {
            background-color: #f2f2f7 !important;
        }

        /* 全屏播放器文字变黑 (为了防止自定义背景图也是浅色看不清，加一点文字阴影) */
        body.light-theme .fp-title {
            color: #000 !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        body.light-theme .fp-artist {
            color: rgba(0,0,0,0.6) !important;
            text-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        body.light-theme #current-lyric-line {
            color: rgba(0,0,0,0.8) !important;
        }
        body.light-theme .time-text,
        body.light-theme #time-current,
        body.light-theme #time-total {
            color: rgba(0,0,0,0.5) !important;
        }

        /* 全屏控制按钮变黑 */
        body.light-theme .fp-ctrl-btn svg,
        body.light-theme .fp-btn svg,
        body.light-theme .fp-icon-btn svg {
            fill: #000000 !important;
        }
        body.light-theme .fp-icon-btn {
            background: rgba(0,0,0,0.05) !important;
        }

        /* 进度条底色变深一点 */
        body.light-theme .fp-slider {
            background: rgba(0,0,0,0.1) !important;
        }
        body.light-theme .fp-slider::-webkit-slider-thumb {
            background: #000000 !important; /* 滑块变黑 */
        }

        /* 底部弹窗 (Action Sheet) 浅色适配 */
        body.light-theme .sheet-group {
            background: rgba(255,255,255,0.95) !important;
        }
        body.light-theme .sheet-item {
            color: #000000 !important;
            border-top-color: rgba(0,0,0,0.1) !important;
        }
                /* --- 迷你播放器图标修复 --- */

        /* 默认样式 (深色模式) */
        .mini-btn svg {
            width: 28px; height: 28px;
            fill: white; /* 默认为白 */
            transition: fill 0.2s;
        }

        /* 浅色模式适配 (核心修复) */
        body.light-theme .mini-btn svg {
            fill: #333333 !important; /* 强制变深灰/黑 */
        }

        /* 按钮点击反馈 */
        .mini-btn:active { opacity: 0.6; transform: scale(0.9); }
                /* ================== 灵动岛逻辑修正 CSS ================== */

        /* 1. 灵动岛容器基础 */
        .island-container {
            position: absolute;
            top: 11px; left: 50%; transform: translateX(-50%);
            background: black;
            border-radius: 20px;
            z-index: 9999;
            /* 关键：默认高度和宽度 */
            width: 0; height: 0; opacity: 0; /* 默认完全隐藏 */

            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        border-radius 0.4s,
                        opacity 0.2s;
            overflow: hidden;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: white;
            pointer-events: none; /* 平时能不能点 */
        }

        /* 状态 A: 待机 (只有开了设置才显示这个小黑条) */
        .island-container.idle-show {
            width: 120px; height: 35px; border-radius: 18px; opacity: 1;
        }

        /* 状态 B: 音乐常驻 (播放音乐时，即使收缩了也要显示波形) */
        .island-container.music-active {
            width: 150px; height: 35px; border-radius: 18px; opacity: 1;
            cursor: pointer; pointer-events: auto;
        }

        /* 状态 C: 展开 (通知弹窗) */
        .island-container.active {
            width: 340px; height: 60px; border-radius: 30px; opacity: 1;
            z-index: 10000;
        }

        /* 内容区域 */
        .island-content {
            width: 100%; height: 100%;
            display: flex; justify-content: space-between; align-items: center;
            opacity: 0; transition: opacity 0.2s;
        }
        /* 展开或音乐常驻时显示内容 */
        .island-container.active .island-content,
        .island-container.music-active .island-content {
            opacity: 1;
        }

        /* 只有在音乐常驻模式下，隐藏中间和右边的文字，只留左边波形 */
        .island-container.music-active .island-center,
        .island-container.music-active .island-right {
            display: none;
        }
        /* 但如果展开了，就显示 */
        .island-container.active .island-center,
        .island-container.active .island-right {
            display: block;
        }
                /* ================== 灵动岛显示修复补丁 ================== */

        /* 1. 音乐常驻状态 (播放中收缩状态) */
        .island-container.music-active {
            width: 130px !important; /* 宽度适中 */
            height: 35px !important;
            border-radius: 18px !important;
            opacity: 1 !important;
            cursor: pointer;
            pointer-events: auto;
            background: black; /* 确保背景黑 */
        }

        /* 2. 核心修复：波形颜色和位置 */
        /* 只要是在灵动岛里的波形，全部强制显示颜色 */
        .island-sound-wave span {
            background-color: #34C759 !important; /* 亮绿色，黑底上很明显 */
            width: 3px !important;
            border-radius: 2px;
            /* 确保动画运行 */
            animation: wave 1s infinite ease-in-out;
        }

        /* 3. 布局控制：常驻模式下只显示左边的波形 */
        .island-container.music-active .island-content {
            opacity: 1 !important;
            justify-content: center !important; /* 居中显示 */
        }

        /* 隐藏中间和右边的文字，防止挤压 */
        .island-container.music-active #island-text,
        .island-container.music-active #island-info {
            display: none !important;
        }

        /* 确保左侧图标区显示 */
        .island-container.music-active #island-icon {
            display: flex !important;
            align-items: center;
            justify-content: center;
            width: 100%; /* 占满整个小岛 */
        }

        /* 4. 动画定义 (防止动画丢失) */
        @keyframes wave {
            0%, 100% { height: 6px; }
            50% { height: 16px; }
        }

        /* 针对不同柱子的延迟，产生律动感 */
        .island-sound-wave span:nth-child(1) { animation-delay: 0.0s; }
        .island-sound-wave span:nth-child(2) { animation-delay: 0.2s; }
        .island-sound-wave span:nth-child(3) { animation-delay: 0.4s; }
        .island-sound-wave span:nth-child(4) { animation-delay: 0.1s; }

                /* ================== 灵动岛显示强制修复 ================== */

        /* 1. 确保灵动岛在最顶层，不被遮挡 */
        #dynamic-island {
            z-index: 2147483647 !important; /* 浏览器允许的最大 Z-Index */
            background: black !important;
        }

        /* 2. 强制波形可见 (关键修复) */
        .island-sound-wave {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 20px !important;
            gap: 3px !important;
        }

        .island-sound-wave span {
            display: block !important;
            background-color: #34C759 !important; /* 亮绿色 */
            width: 3px !important;
            height: 10px !important; /* 给一个默认高度，防止动画没加载时看不见 */
            border-radius: 2px !important;
            animation: wave 1s infinite ease-in-out !important;
        }

        /* 3. 确保常驻模式下的布局正确 */
        .island-container.music-active {
            width: 130px !important;
            height: 35px !important;
            opacity: 1 !important;
            display: flex !important;
        }

        /* 强制显示左侧区域，并居中 */
        .island-container.music-active #island-icon {
            display: flex !important;
            width: 100% !important;
            justify-content: center !important;
            align-items: center !important;
        }

        /* 隐藏不需要的文字 */
        .island-container.music-active #island-text,
        .island-container.music-active #island-info {
            display: none !important;
        }

        /* 定义动画 (防止动画丢失) */
        @keyframes wave {
            0%, 100% { height: 6px; }
            50% { height: 18px; }
        }
                /* ================== 灵动岛动效增强包 (注入灵魂) ================== */

        /* 1. 定义更剧烈的跳动动画 (Wave Rhythm) */
        @keyframes wave-rhythm {
            0% {
                height: 3px;
                opacity: 0.6;
                transform: scaleY(1);
            }
            50% {
                height: 18px; /* 拉得更高，动感更强 */
                opacity: 1;
                transform: scaleY(1.1);
            }
            100% {
                height: 3px;
                opacity: 0.6;
                transform: scaleY(1);
            }
        }

        /* 2. 强制应用动画到波形条 */
        .island-sound-wave span {
            display: block !important;
            width: 3px !important;
            background-color: #34C759 !important; /* 荧光绿 */
            border-radius: 10px !important;
            margin: 0 2px !important; /* 增加间距，别挤在一起 */

            /* 关键：引用上面的新动画，速度加快到 0.6s */
            animation: wave-rhythm 0.6s infinite ease-in-out !important;

            /* 默认起始高度，防止动画加载前不可见 */
            height: 6px;
        }

        /* 3. 错开时间差 (制造波浪感，而不是整齐划一的起立蹲下) */
        .island-sound-wave span:nth-child(1) { animation-delay: 0.0s !important; animation-duration: 0.6s !important; }
        .island-sound-wave span:nth-child(2) { animation-delay: 0.2s !important; animation-duration: 0.8s !important; }
        .island-sound-wave span:nth-child(3) { animation-delay: 0.4s !important; animation-duration: 0.7s !important; }
        .island-sound-wave span:nth-child(4) { animation-delay: 0.1s !important; animation-duration: 0.9s !important; }

        /* 4. 灵动岛容器的“Q弹”变形效果 */
        .island-container {
            /* 使用贝塞尔曲线 (Cubic Bezier) 模拟物理弹簧效果 */
            transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        border-radius 0.5s ease !important;
        }

        /* 5. 确保常驻模式下的容器高度足够容纳跳动 */
        .island-container.music-active {
            align-items: center !important; /* 垂直居中 */
            display: flex !important;
            /* 确保背景纯黑，不然看不清绿色 */
            background: #000000 !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
        }
                /* ================== 灵动岛悬浮播放器 UI (高级深色版) ================== */

        /* 1. 悬浮卡片本体 */
        .island-popup {
            position: fixed;
            top: 11px; left: 50%; transform: translateX(-50%) scale(0.9);
            width: 350px; height: 190px; /* 高度稍微加一点容纳进度条 */
            border-radius: 32px;
            z-index: 9998;
            opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.15);
            transform-origin: top center;
        }

        .island-popup.active {
            opacity: 1; pointer-events: auto;
            top: 55px;
            transform: translateX(-50%) scale(1);
        }

        /* 2. 玻璃背景 */
        .popup-backdrop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 30, 35, 0.85); /* 深色半透明 */
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: 32px;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 0;
        }

        /* 3. 内容布局 */
        .popup-content {
            position: relative; z-index: 1;
            padding: 20px 24px;
            display: flex; flex-direction: column; justify-content: space-between;
            height: 100%;
        }

        /* 上半部分 */
        .popup-top { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }

        .popup-cover {
            width: 56px; height: 56px; border-radius: 10px;
            background-color: #333; background-size: cover; background-position: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .popup-info { flex: 1; overflow: hidden; }
        .popup-title {
            font-size: 17px; font-weight: 600; color: white; margin-bottom: 3px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .popup-artist {
            font-size: 13px; color: rgba(255,255,255,0.6);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 右上角列表按钮 */
        .popup-icon-btn {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white;
        }
        .popup-icon-btn svg { width: 18px; height: 18px; fill: white; opacity: 0.8; }

        /* 进度条区域 */
        .popup-progress {
            display: flex; align-items: center; gap: 8px;
            margin-top: auto; margin-bottom: 10px;
        }
        .time-tiny { font-size: 10px; color: rgba(255,255,255,0.4); width: 25px; text-align: center; }
        .popup-slider {
            flex: 1; height: 3px; border-radius: 2px;
            background: rgba(255,255,255,0.2);
            -webkit-appearance: none;
        }
        .popup-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 10px; height: 10px;
            background: white; border-radius: 50%;
        }

        /* 底部按钮组 */
        .popup-controls {
            display: flex; justify-content: center; align-items: center; gap: 30px;
        }
        .popup-btn {
            background: none; border: none; cursor: pointer;
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
        }
        .popup-btn svg { width: 26px; height: 26px; fill: white; }
        .popup-btn.big svg { width: 42px; height: 42px; }
        .popup-btn:active { opacity: 0.7; transform: scale(0.9); }

        /* 浅色模式适配 (Light Mode) */
        body.light-theme .popup-backdrop {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(0,0,0,0.1);
        }
        body.light-theme .popup-title { color: black; }
        body.light-theme .popup-artist { color: rgba(0,0,0,0.6); }
        body.light-theme .popup-btn svg,
        body.light-theme .popup-icon-btn svg { fill: black; }
        body.light-theme .popup-icon-btn { background: rgba(0,0,0,0.05); }
        body.light-theme .popup-slider { background: rgba(0,0,0,0.1); }
        body.light-theme .popup-slider::-webkit-slider-thumb { background: black; }
        body.light-theme .time-tiny { color: rgba(0,0,0,0.5); }

                /* ================== 一起听歌 UI ================== */

        /* 1. 核心可视化区 */
        .listen-visualizer {
            height: 180px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            position: relative;
            margin-top: 20px;
        }

        /* 头像盒子 */
        .visual-avatar-box {
            display: flex; flex-direction: column; align-items: center;
            z-index: 2; /* 在线上面 */
        }
        .visual-avatar {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #888;
            background-size: cover; background-position: center;
            cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .visual-avatar:active { transform: scale(0.95); }
        .visual-name {
            margin-top: 8px; font-size: 13px; color: white; font-weight: 600;
            max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* 1. 连接线区域 (修复居中问题) */
        .visual-connection {
            position: absolute;
            top: 50%; /* 垂直居中基准线 */
            transform: translateY(-50%); /* 向上拉回自身高度的一半，实现完美居中 */

            left: 80px; /* 避开左侧头像宽度 */
            right: 80px; /* 避开右侧头像宽度 */
            height: 100px;

            display: flex; align-items: center; justify-content: center;
            z-index: 1; /* 在头像后面 */
        }

        /* 爱心 */
        .visual-heart {
            font-size: 24px; z-index: 3;
            animation: heart-beat 1.5s infinite ease-in-out;
            filter: drop-shadow(0 0 10px rgba(255,0,0,0.5));
        }
        @keyframes heart-beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* 静态横线 (暂停时显示) */
        .line-static {
            position: absolute; width: 100%; height: 2px;
            background: rgba(255,255,255,0.2);
            display: block;
        }

        /* 2. 心电图线条 (优化描边效果) */
        .line-ekg {
            position: absolute; width: 100%; height: 100%;
            overflow: visible; /* 允许波峰超出一点点 */
            display: none;
        }

        .ekg-path {
            fill: none;
            stroke: #0a84ff;
            stroke-width: 2px; /* 线条细一点更像心率仪 */
            stroke-linejoin: round;
            stroke-linecap: round;

            /* 动画参数 */
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;

            /* 发光效果 */
            filter: drop-shadow(0 0 4px rgba(10, 132, 255, 0.8));
        }

        /* 播放动画：像电流一样快速流过 */
        .visual-connection.playing .line-ekg { display: block; }
        .visual-connection.playing .ekg-path {
            animation: ekg-flow 1.5s linear infinite; /* 加快速度到 1.5s */
        }

        @keyframes ekg-flow {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }

        /* 2. 聊天区域 */
        .listen-chat-area {
            flex: 1; overflow-y: auto;
            padding: 15px; margin-bottom: 10px;
        }
        .chat-msg {
            margin-bottom: 15px; display: flex;
        }
        .chat-msg.system { justify-content: center; opacity: 0.5; font-size: 12px; }
        .chat-msg.left { justify-content: flex-start; }
        .chat-msg.right { justify-content: flex-end; }

        .msg-bubble-listen {
            padding: 10px 14px; border-radius: 18px;
            max-width: 75%; font-size: 15px; line-height: 1.4;
            position: relative;
        }
        .left .msg-bubble-listen { background: rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .right .msg-bubble-listen { background: #0a84ff; color: white; border-bottom-right-radius: 4px; }

        /* 3. 底部输入区 */
        .listen-input-wrapper {
            padding: 10px 15px 30px 15px;
            background: rgba(30,30,35,0.9);
        }
        .listen-input-bar {
            display: flex; gap: 10px; align-items: center;
        }
        #listen-input {
            flex: 1; height: 44px; border-radius: 22px;
            background: rgba(255,255,255,0.1); border: none; outline: none;
            color: white; padding: 0 15px; font-size: 15px;
        }
        .listen-icon-btn {
            width: 44px; height: 44px; border-radius: 50%;
            border: none; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .listen-icon-btn:active { transform: scale(0.9); }
        .listen-icon-btn svg { width: 22px; height: 22px; fill: white; }

        .magic-btn { background: linear-gradient(135deg, #FF2E93, #FF7D54); }
        .send-btn { background: #0a84ff; }

        .listen-clear-btn {
            text-align: center; font-size: 12px; color: rgba(255,255,255,0.4);
            margin-top: 15px; cursor: pointer;
        }
                /* ================== 一起听歌页面的强制修复 ================== */

        #sub-listen-together {
            /* 1. 强制层级最高 (比全屏播放器100高，比弹窗2000低) */
            z-index: 1500 !important;

            /* 2. 强制动画方向：从下往上 (覆盖默认的从右往左) */
            transform: translateY(100%) !important;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) !important;

            /* 3. 确保背景不透明 */
            background-color: #121212 !important;

            /* 4. 确保位置占满全屏 */
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            display: flex !important; /* 确保是 flex 布局 */
        }

        /* 激活状态：滑上来 */
        #sub-listen-together.active {
            transform: translateY(0) !important;
        }
                /* ================== 一起听歌 UI 重构 (浅色适配 & 动效增强) ================== */

        /* 1. 浅色模式适配 (Light Mode) */
        body.light-theme #sub-listen-together {
            background-color: #f2f2f7 !important; /* 背景变灰白 */
        }
        body.light-theme #sub-listen-together .app-title,
        body.light-theme #sub-listen-together .visual-name,
        body.light-theme .chat-msg.system span {
            color: #000000 !important; /* 文字变黑 */
        }
        body.light-theme .app-back-btn svg {
            fill: #000000 !important; /* 返回按钮变黑 */
        }
        body.light-theme .listen-input-wrapper {
            background: #ffffff !important; /* 输入框底色变白 */
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        body.light-theme #listen-input {
            background: #f2f2f7 !important;
            color: #000 !important;
        }
        body.light-theme .line-static {
            background: rgba(0,0,0,0.1) !important; /* 静态线变深灰 */
        }

        /* 2. 可视化区域布局微调 */
        .listen-visualizer {
            height: 200px; /* 高度增加一点 */
            margin-top: 40px;
            padding: 0 30px; /* 两侧留白增加 */
        }

        /* 3. 动感爱心 (重绘) */
        .visual-heart-wrapper {
            position: relative;
            width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            z-index: 5;
            background: #121212; /* 默认黑背景遮挡线条 */
            border-radius: 50%; /* 圆形背景 */
        }
        /* 浅色模式下爱心背景变白 */
        body.light-theme .visual-heart-wrapper { background: #f2f2f7; }

        .visual-heart-icon {
            width: 32px; height: 32px;
            fill: #FF2E93; /* 玫红色 */
            filter: drop-shadow(0 2px 5px rgba(255, 46, 147, 0.4));
            transform-origin: center;
        }

        /* 心跳动画 (Heartbeat) */
        @keyframes heart-pump {
            0% { transform: scale(1); }
            15% { transform: scale(1.25); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
            60% { transform: scale(1); }
            100% { transform: scale(1); }
        }

        /* 播放时心跳 */
        .visual-connection.playing .visual-heart-icon {
            animation: heart-pump 1.2s infinite ease-in-out;
        }

        /* 4. 心电图线条 (ECG) */
        .line-ekg {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            z-index: 1;
            display: none; /* 默认隐藏 */
        }
        .ekg-path {
            fill: none;
            stroke: #0a84ff; /* 科技蓝 */
            stroke-width: 2.5px;
            stroke-linecap: round;
            stroke-linejoin: round;
            /* 虚线效果，用于流动动画 */
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.6)); /* 发光效果 */
        }

        /* 播放时显示线条并开始流动 */
        .visual-connection.playing .line-ekg { display: block; }
        .visual-connection.playing .line-static { display: none; }
        .visual-connection.playing .ekg-path {
            animation: ekg-flow 2.5s linear infinite;
        }

        @keyframes ekg-flow {
            0% { stroke-dashoffset: 1000; }
            100% { stroke-dashoffset: 0; }
        }

        /* 3. 静态线 (暂停时) */
        .line-static {
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 2px;
            margin-top: -1px; /* 精确微调 */
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }
        /* 浅色模式适配静态线 */
        body.light-theme .line-static { background: rgba(0,0,0,0.1) !important; }

        /* 6. 修复头像点击区域和样式 */
        .visual-avatar {
            width: 80px; height: 80px; /* 加大头像 */
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.1); /* 更明显的边框 */
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .visual-name { font-size: 14px; margin-top: 12px; opacity: 0.8; }

        /* --- 一起听歌：物理搭桥+动效最终版 --- */

.listen-visualizer {
    height: 160px;
    width: 100%;
    margin-top: 40px;
    position: relative;
    /* 没有任何 flex 干扰，纯绝对定位 */
}

/* --- 1. 头像定位 --- */
.visual-avatar-box {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    width: 70px;
    display: flex; flex-direction: column; align-items: center;
    z-index: 10;
}
.left-box { left: 30px; }
.right-box { right: 30px; }

.visual-avatar {
    width: 64px; height: 64px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; color: rgba(255,255,255,0.5);
    background-color: rgba(30,30,30,0.5);
    border: 2px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s;
}
.visual-name { margin-top: 8px; font-size: 13px; color: #aaa; }

/* 状态样式 */
.visual-avatar.empty { box-shadow: none; }
.visual-avatar.active-me, .visual-avatar.active-role {
    border-color: #FF3B30; color: white;
    /* 增加头像的呼吸光效 */
    box-shadow: 0 0 15px rgba(255, 59, 48, 0.5);
    animation: avatar-glow 2s infinite alternate;
}

/* --- 2. 爱心定位 --- */
.visual-heart-center {
    position: absolute;
    left: 50%; top: 50%;
    transform: translate(-50%, -50%);
    width: 50px; height: 50px;
    z-index: 10;
    display: flex; align-items: center; justify-content: center;
}
.visual-heart-icon-red {
    width: 42px; height: 42px; fill: #FF3B30;
    filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
    /* 爱心默认跳动 */
    animation: heart-beat-normal 1.2s infinite ease-in-out;
}

/* --- 3. 桥梁连线 (关键动效) --- */
.connection-bridge {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    height: 60px;
    z-index: 5;
    overflow: visible; /* 允许光晕溢出 */
}

.left-bridge {
    left: 100px; right: 50%; margin-right: 25px;
    opacity: 1; transition: opacity 0.5s ease;
}
/* JS 控制显示 */
.left-bridge.show { opacity: 1 !important; }

.right-bridge {
    left: 50%; right: 100px; margin-left: 25px;
}

/* SVG 容器 */
.bridge-svg { width: 100%; height: 100%; overflow: visible; }

/* --- 核心：线条动画 --- */
.line-path {
    fill: none;
    stroke: #FF3B30; /* 红色 */
    stroke-width: 2.5px; /* 线条加粗 */
    stroke-linecap: round;
    stroke-linejoin: round;

    /* 霓虹发光效果 */
    filter: drop-shadow(0 0 6px rgba(255, 59, 48, 0.9));

    /* 关键属性：防止拉伸变形 */
    vector-effect: non-scaling-stroke;

    /* === 动效魔法 === */
    /* 定义虚线：实线段 300px (足够长覆盖整条线)，空隙 300px */
    stroke-dasharray: 300 300;
    /* 初始偏移 300，相当于把实线藏在左边 */
    stroke-dashoffset: 300;
    /* 动画：让偏移量变到 0，实线就会像画出来一样流过去 */
    animation: ekg-draw-anim 1.5s linear infinite;
}

/* 动效关键帧：不断从左往右画线 */
@keyframes ekg-draw-anim {
    to { stroke-dashoffset: 0; }
}

/* 头像呼吸光 */
@keyframes avatar-glow {
    from { box-shadow: 0 0 10px rgba(255, 59, 48, 0.3); }
    to { box-shadow: 0 0 20px rgba(255, 59, 48, 0.8); }
}

/* 爱心跳动 */
@keyframes heart-beat-normal {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}

/* 播放时爱心狂跳 */
.visual-heart-center.beating .visual-heart-icon-red {
    animation: heart-beat-strong 0.8s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
}
@keyframes heart-beat-strong {
    0%, 100% { transform: scale(1); }
    15% { transform: scale(1.35); }
    50% { transform: scale(1); }
}

/* 浅色模式适配 */
body.light-theme .visual-avatar.empty {
    border-color: rgba(0,0,0,0.1); color: #999; background: rgba(0,0,0,0.05);
}

        /* --- 一起听歌：时长计时器样式 --- */
.listen-timer-box {
    text-align: center;
    margin-top: -5px; /* 稍微往上提一点，紧贴着心电图 */
    margin-bottom: 15px;
    z-index: 10;
    color: rgba(255, 255, 255, 0.5); /* 文字稍微暗一点 */
    font-size: 13px;
    /* 关键：防止数字变化时左右抖动 */
    font-variant-numeric: tabular-nums;
    letter-spacing: 1px;
}

#listen-timer-text {
    font-weight: 600;
    color: #FF3B30; /* 和心跳一样的红色，突出时间 */
    margin-left: 6px;
    font-size: 15px;
    text-shadow: 0 0 10px rgba(255, 59, 48, 0.3); /* 微微发光 */
}

/* 浅色模式适配 */
body.light-theme .listen-timer-box {
    color: rgba(0,0,0,0.4);
}

        /* --- 灵动岛悬浮窗遮罩 (点击空白关闭) --- */
#island-popup-mask {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.3); /* 深色半透明背景 */
    z-index: 9990; /* 必须比悬浮窗(9998)低，但比其他元素高 */
    opacity: 0;
    pointer-events: none; /* 默认点透 */
    transition: opacity 0.3s;
}

#island-popup-mask.active {
    opacity: 1;
    pointer-events: auto; /* 激活时阻挡点击 */
}

/* 右上角关闭按钮样式 */
.btn-close-popup {
    width: 32px; height: 32px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: white;
    margin-left: 8px; /* 和播放列表按钮拉开距离 */
}
.btn-close-popup:active { background: rgba(255, 255, 255, 0.3); }

        /* --- 角色选择弹窗 & 列表适配 --- */

/* 1. 列表项布局 (头像+名字) */
.role-select-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: background 0.2s;
    border-radius: 12px;
    margin-bottom: 5px;
}
.role-select-item:active { background: rgba(255,255,255,0.1); }

/* 列表里的微型头像 */
.role-tiny-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background-color: #333;
    background-size: cover; background-position: center;
    margin-right: 15px;
    border: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; color: #888;
}

/* 列表里的名字 */
.role-select-name {
    font-size: 16px;
    color: white; /* 默认深色模式为白字 */
    font-weight: 500;
}

/* --- 2. 浅色模式适配 (Light Mode) --- */

/* 弹窗背景变白 */
body.light-theme .modal-content {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15) !important;
}

/* 弹窗标题变黑 */
body.light-theme .modal-title {
    color: #000000 !important;
}

/* 列表项边框变浅 */
body.light-theme .role-select-item {
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
body.light-theme .role-select-item:active {
    background: rgba(0,0,0,0.05);
}

/* 列表文字变黑 (核心修复) */
body.light-theme .role-select-name {
    color: #000000 !important;
}

/* 列表头像边框变浅 */
body.light-theme .role-tiny-avatar {
    border-color: rgba(0,0,0,0.1);
    background-color: #f2f2f7;
}

/* 暂无数据的提示文字变黑 */
body.light-theme #listen-role-list div[style*="color:#666"] {
    color: rgba(0,0,0,0.4) !important;
}

        /* ================== 浅色模式头像修复 (安全版) ================== */

/* 1. 默认状态 (无图片时)：显示白底 + 虚线框 */
body.light-theme .visual-avatar,
body.light-theme .role-card-img,
body.light-theme .role-tiny-avatar {
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #333 !important;
}

/* 2. 空状态：显示浅灰 */
body.light-theme .visual-avatar.empty {
    background-color: #f2f2f7 !important;
    color: #999 !important;
    border: 2px dashed rgba(0,0,0,0.1) !important;
}

/* 3. 【核心】当检测到有图片时：强制背景透明 */
/* 只要 HTML 里有 style="...url..."，就说明 JS 设置了图片 */
body.light-theme .visual-avatar[style*="url"],
body.light-theme .role-card-img[style*="url"],
body.light-theme .role-tiny-avatar[style*="url"],
body.light-theme .profile-avatar[style*="url"] {

    background-color: transparent !important; /* 关键：底色变透明 */

    /* 强制重申图片属性，防止被干扰 */
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;

    border: 1px solid rgba(0,0,0,0.1) !important; /* 保持浅色边框 */
}

/* 4. 选中状态/自己：红圈 (背景依然根据有没有图变透明) */
body.light-theme .visual-avatar.active-me,
body.light-theme .visual-avatar.active-role {
    border: 2px solid #FF3B30 !important;
    color: #FF3B30 !important;
    box-shadow: 0 5px 15px rgba(255, 59, 48, 0.2) !important;
}

        /* ================== 浅色模式输入框看不见修复 ================== */

/* 1. 针对所有通用输入框 (.search-box) 和特定的编辑框 */
body.light-theme .search-box,
body.light-theme #profile-edit-input,
body.light-theme .code-textarea,
body.light-theme input[type="text"],
body.light-theme input[type="password"] {

    /* 核心：文字变成黑色 */
    color: #000000 !important;

    /* 背景变成淡淡的灰色，跟白底区分开 */
    background-color: rgba(0, 0, 0, 0.05) !important;

    /* 加一个极淡的边框，让输入框轮廓更清晰 */
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
}

/* 2. 修复占位符 (Placeholder) 的颜色 */
/* 就是 "请输入昵称" 这种提示文字，也要变成深灰色 */
body.light-theme .search-box::placeholder,
body.light-theme input::placeholder,
body.light-theme textarea::placeholder {
    color: rgba(0, 0, 0, 0.4) !important;
}

/* 3. 输入时的光标颜色 */
body.light-theme input,
body.light-theme textarea {
    caret-color: #007aff !important; /* iOS 蓝光标 */
}

        /* ================== 浅色模式按钮文字修复 ================== */

/* 1. 修复所有弹窗里的“取消”按钮 */
body.light-theme .btn-cancel {
    /* 背景变浅灰，和白底区分开 */
    background-color: rgba(0, 0, 0, 0.05) !important;
    /* 文字变深灰，确保能看见 */
    color: #333333 !important;
}

/* 2. 修复“一起听”页面底部的“清空聊天记录”文字 */
body.light-theme .listen-clear-btn {
    /* 之前的白色半透明改成黑色半透明 */
    color: rgba(0, 0, 0, 0.5) !important;
}

/* 按下时的反馈颜色 */
body.light-theme .listen-clear-btn:active {
    color: #000000 !important;
}

        /* --- 倒数日小组件 (Photo Style) --- */
.widget-countdown {
    grid-column: span 4;
    grid-row: span 2;

    /* 默认背景：极淡的玻璃，不再是灰蒙蒙的 */
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 26px;

    position: relative; overflow: hidden;
    cursor: pointer; transition: transform 0.2s;
    /* 给个阴影让它浮起来 */
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}
.widget-countdown:active { transform: scale(0.98); }

/* 背景图片层 */
.cd-bg-image {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center;
    z-index: 0; display: none; /* 默认隐藏 */
}

/* 黑色渐变遮罩 (保证有图时文字也能看清) */
.cd-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.6));
    z-index: 1;
    pointer-events: none;
}

/* 内容层 (浮在最上面) */
.cd-content-layer {
    position: relative; z-index: 2;
    height: 100%; width: 100%;
    padding: 20px 24px;
    display: flex; flex-direction: column; justify-content: space-between;
    color: white; /* 强制白色文字 */
}

/* 顶部：图标+标题 */
.cd-top-row { display: flex; align-items: center; gap: 10px; }

/* 新设计的图标 */
.cd-icon-box {
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.2); /* 半透明白底 */
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px);
}
.cd-svg-icon {
    width: 18px; height: 18px; fill: white;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.cd-name {
    font-size: 16px; font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
}

/* 中间数字 */
.cd-main-content {
    display: flex; align-items: baseline;
    margin-top: -5px;
}
.cd-number {
    font-size: 68px; font-weight: 300; /* 细体大字 */
    line-height: 1; margin-right: 10px;
    text-shadow: 0 5px 15px rgba(0,0,0,0.3);
    font-variant-numeric: tabular-nums;
}
.cd-meta {
    display: flex; flex-direction: column; justify-content: center;
    font-size: 11px; font-weight: 700; letter-spacing: 1.5px; opacity: 0.8;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* 底部日期 */
.cd-bottom-row {
    display: flex; justify-content: space-between; align-items: center;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 12px;
}
.cd-target-date {
    font-size: 13px; font-family: monospace; opacity: 0.8;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.cd-arrow-icon { width: 18px; height: 18px; fill: white; opacity: 0.6; }

/* 浅色模式适配 */
/* 只有在没背景图时，才变黑字；有背景图时依然保持白字 */
body.light-theme .widget-countdown:not(.has-bg) {
    background: #ffffff;
    border-color: rgba(0,0,0,0.05);
}
body.light-theme .widget-countdown:not(.has-bg) .cd-content-layer {
    color: #333;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-icon-box {
    background: #f0f0f0;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-svg-icon {
    fill: #333;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-bottom-row {
    border-top-color: rgba(0,0,0,0.1);
}
body.light-theme .widget-countdown:not(.has-bg) .cd-arrow-icon {
    fill: #333;
}

        /* ================== 倒数日组件：高颜值重制版 CSS ================== */

.widget-countdown {
    grid-column: span 4;
    grid-row: span 2;

    /* 1. 背景优化：更白的磨砂玻璃，不再发灰 */
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(35px) saturate(180%);
    -webkit-backdrop-filter: blur(35px) saturate(180%);

    border: 1px solid rgba(255, 255, 255, 0.3); /* 亮边框 */
    border-radius: 24px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.15); /* 柔和投影 */

    padding: 24px;
    display: flex; flex-direction: column; justify-content: space-between;
    position: relative; overflow: hidden;
    cursor: pointer; transition: all 0.2s;
    color: white; /* 默认白字 */
}
.widget-countdown:active { transform: scale(0.98); }

/* 背景图片层 */
.cd-bg-image {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-size: cover; background-position: center;
    z-index: 0; display: none; transition: opacity 0.3s;
}
/* 有图片时显示的遮罩 */
.cd-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.5));
    z-index: 1; display: none;
}
/* 当有背景图时显示遮罩 */
.widget-countdown.has-bg .cd-overlay { display: block; }

/* 内容层 */
.cd-content-layer {
    position: relative; z-index: 2;
    height: 100%; display: flex; flex-direction: column; justify-content: space-between;
}

/* 顶部：图标 + 标题 */
.cd-top-row { display: flex; align-items: center; gap: 12px; }

.cd-icon-box {
    width: 36px; height: 36px;
    background: rgba(255,255,255,0.9); /* 纯白底色图标 */
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/* 换个好看的图标颜色 */
.cd-svg-icon { width: 20px; height: 20px; fill: #FF3B30; }

.cd-name {
    font-size: 17px; font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    letter-spacing: 0.5px;
}

/* 中间数字 */
.cd-main-content { display: flex; align-items: baseline; margin-top: 5px; }
.cd-number {
    font-size: 64px; font-weight: 400;
    line-height: 1; margin-right: 8px;
    /* 数字带一点渐变光泽 */
    text-shadow: 0 5px 20px rgba(0,0,0,0.2);
    font-family: -apple-system, sans-serif;
}
.cd-meta {
    display: flex; flex-direction: column;
    font-size: 12px; font-weight: 700; opacity: 0.9;
    letter-spacing: 1px;
}

/* 底部 */
.cd-bottom-row {
    border-top: 1px solid rgba(255,255,255,0.3);
    padding-top: 12px; display: flex; justify-content: space-between;
}
.cd-target-date { font-size: 13px; font-weight: 500; opacity: 0.9; }

/* --- 浅色模式适配 (如果没有背景图) --- */
body.light-theme .widget-countdown:not(.has-bg) {
    background: #ffffff !important; /* 纯白卡片 */
    border: 1px solid rgba(0,0,0,0.05) !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08) !important;
}
body.light-theme .widget-countdown:not(.has-bg) .cd-content-layer { color: #333 !important; text-shadow: none !important; }
body.light-theme .widget-countdown:not(.has-bg) .cd-icon-box { background: #f2f2f7 !important; }
body.light-theme .widget-countdown:not(.has-bg) .cd-bottom-row { border-top-color: rgba(0,0,0,0.1) !important; }

        /* --- 新增 App 专属液态渐变色 --- */

/* 日记: 温暖的日记本 (杏色/淡粉) */
.bg-diary { background: linear-gradient(135deg, rgba(255, 226, 159, 0.6) 0%, rgba(255, 167, 81, 0.6) 100%); }

/* 钱包: 金融质感 (宝石蓝) */
.bg-wallet { background: linear-gradient(135deg, rgba(58, 123, 213, 0.6) 0%, rgba(58, 96, 115, 0.6) 100%); }

/* 购物: 促销活力 (橙红色) */
.bg-shop { background: linear-gradient(135deg, rgba(255, 81, 47, 0.6) 0%, rgba(221, 36, 118, 0.6) 100%); }

/* 备忘录: 便签纸 (柠檬黄) */
.bg-memo { background: linear-gradient(135deg, rgba(255, 242, 0, 0.5) 0%, rgba(247, 148, 29, 0.5) 100%); }

/* 论坛: 交流气泡 (紫罗兰) */
.bg-forum { background: linear-gradient(135deg, rgba(161, 140, 209, 0.6) 0%, rgba(251, 194, 235, 0.6) 100%); }

/* 电话: 通讯绿 (青草绿) */
.bg-phone { background: linear-gradient(135deg, rgba(17, 153, 142, 0.6) 0%, rgba(56, 239, 125, 0.6) 100%); }

/* 陪伴: 爱心温暖 (樱花粉) */
.bg-companion { background: linear-gradient(135deg, rgba(255, 154, 158, 0.6) 0%, rgba(254, 207, 239, 0.6) 100%); }

/* 抽卡: 稀有度金光 (彩虹/金) */
.bg-gacha { background: linear-gradient(135deg, rgba(255, 215, 0, 0.6) 0%, rgba(252, 246, 186, 0.6) 50%, rgba(191, 155, 48, 0.6) 100%); }

        /* --- 语音小组件 (Row 5 专属版) --- */
.widget-voice-card {
    grid-column: span 4; /* 占满整行 */
    grid-row: span 1;    /* 占一行高度 */

    /* 玻璃拟态背景 */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 24px;

    display: flex; align-items: center; justify-content: space-between;
    padding: 0 16px; /* 稍微减小内边距 */
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    margin-top: 10px; /* 与上方图标拉开一点距离 */
}

/* 左侧：圆形封面 (上传图片) */
.v-cover-box {
    width: 50px; height: 50px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.15);
    background-size: cover; background-position: center;
    border: 2px solid rgba(255,255,255,0.4);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-shrink: 0;
    transition: transform 0.1s;
}
.v-cover-box:active { transform: scale(0.9); }
.v-plus-mark { font-size: 24px; color: white; font-weight: 300; opacity: 0.8; }

/* 中间：声波区域 (播放/暂停) */
.v-wave-container {
    flex: 1; height: 100%;
    display: flex; align-items: center; justify-content: center;
    gap: 5px; margin: 0 15px;
    cursor: pointer; /* 提示可点击 */
    /* 增加一个隐形的热区背景，方便点击 */
    border-radius: 12px;
}
.v-wave-container:active { background: rgba(255,255,255,0.05); }

/* 波纹条 */
.v-bar {
    width: 4px; border-radius: 4px;
    background: #fff; opacity: 0.9;
    height: 6px; /* 默认静止高度 */
    transition: height 0.2s;
    box-shadow: 0 0 8px rgba(255,255,255,0.4);
}

/* 播放时的律动动画 */
.v-wave-container.playing .v-bar {
    animation: voice-rhythm 1s infinite ease-in-out;
}

@keyframes voice-rhythm {
    0%, 100% { height: 6px; opacity: 0.6; }
    50% { height: 28px; opacity: 1; }
}

/* 给波纹加延迟，制造波浪感 */
.v-bar:nth-child(1) { animation-delay: 0s; }
.v-bar:nth-child(2) { animation-delay: 0.1s; }
.v-bar:nth-child(3) { animation-delay: 0.2s; }
.v-bar:nth-child(4) { animation-delay: 0.3s; }
.v-bar:nth-child(5) { animation-delay: 0.4s; }
.v-bar:nth-child(6) { animation-delay: 0.2s; }
.v-bar:nth-child(7) { animation-delay: 0.1s; }

/* 右侧：星星按钮 (上传音频) - 透明版 */
.v-btn-star {
    width: 50px; height: 50px; /* 稍微加大一点，与左侧对称 */
    border-radius: 50%;

    /* --- 修改部分 开始 --- */
    background: rgba(255, 255, 255, 0.15); /* 透明玻璃背景 */
    border: 2px solid rgba(255,255,255,0.4); /* 与左侧一致的边框 */
    box-shadow: none; /* 去掉金色的阴影 */
    /* --- 修改部分 结束 --- */

    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: transform 0.1s, background-color 0.2s;
}

/* 点击时的效果 */
.v-btn-star:active {
    transform: scale(0.9);
    background-color: rgba(255,255,255,0.3); /* 点击时稍微变亮一点 */
}

/* 星星图标保持白色 */
.v-star-icon {
    width: 24px; height: 24px;
    fill: white;
    opacity: 0.9;
    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
}

/* 浅色模式适配 */
body.light-theme .widget-voice-card { background: #ffffff; border-color: rgba(0,0,0,0.05); }
body.light-theme .v-cover-box { border-color: rgba(0,0,0,0.1); background-color: #f2f2f7; }
body.light-theme .v-bar { background: #333; box-shadow: none; }
body.light-theme .v-plus-mark { color: #999; }
/* 浅色模式下，星星按钮依然保持金色，因为它是特色按钮 */

        /* ================== 28. 图标显示强制修复补丁 (Final Fix) ================== */

        /* 1. 强制设置背景图大小和位置 (关键修复) */
        /* 把所有图标的 ID 都列在这里，确保图片自动缩放适应 */
        #icon-home-wallpaper, #icon-home-settings, #icon-home-chat, #icon-home-music,
        #icon-dock-role, #icon-dock-world, #icon-dock-manual, #icon-dock-gallery,
        /* --- 下面是第二页新增的 8 个 App --- */
        #icon-home-diary, #icon-home-wallet, #icon-home-shop, #icon-home-memo,
        #icon-home-forum, #icon-home-phone, #icon-home-companion, #icon-home-gacha,
        /* 预览框 */
        .preview-icon-shape {
            background-size: cover !important;
            background-position: center !important;
            background-repeat: no-repeat !important;
        }

        /* 2. 当有背景图时，移除默认背景色和模糊 (避免透底) */
        /* 只要检测到有背景图，就让玻璃变透明 */
        .app-icon-shape[style*="background-image"],
        .dock-icon[style*="background-image"],
        .preview-icon-shape[style*="background-image"] {
            background-color: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* ================== 组件背景设置专用 CSS ================== */

/* 1. 核心补丁：当组件有背景图时，移除毛玻璃和默认背景色 */
/* 这样你的图片才能清晰显示，不会被半透明白色遮挡 */
#widget-weather-box[style*="background-image"],
#widget-music-box[style*="background-image"],
#widget-voice-a-box[style*="background-image"],
.widget-preview-shape[style*="background-image"] {
    background-color: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    background-size: cover !important;
    background-position: center !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
    border: none !important; /* 可选：如果有图，去掉边框更沉浸 */
}

/* 2. 设置页里的预览卡片 */
.widget-set-card {
    background: #2c2c2e;
    border-radius: 18px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.1);
}

/* 3. 模拟组件形状的预览框 */
.widget-preview-box {
    width: 100%;
    background: #333; /* 默认深灰底 */
    border-radius: 20px;
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid rgba(255,255,255,0.1);
}

/* 模拟不同组件的比例 */
.ratio-square { aspect-ratio: 1/1; width: 140px; margin: 0 auto 15px auto; } /* 天气 2x2 */
.ratio-rect   { aspect-ratio: 2/1; } /* 音乐 4x2 */
.ratio-strip  { aspect-ratio: 4/1; } /* 语音 4x1 */

/* 预览框里的占位文字 */
.widget-preview-text {
    color: rgba(255,255,255,0.3); font-size: 13px; font-weight: 500; pointer-events: none;
}

/* 预览框本身也要支持毛玻璃 (默认状态) */
.widget-preview-shape {
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    display: flex; align-items: center; justify-content: center;
}

/* 浅色模式适配 */
body.light-theme .widget-set-card { background: #ffffff; border-color: rgba(0,0,0,0.05); }
body.light-theme .widget-preview-box { background: #f2f2f7; border-color: rgba(0,0,0,0.1); }
body.light-theme .widget-preview-shape { background: rgba(255,255,255,0.5); }
body.light-theme .widget-preview-text { color: rgba(0,0,0,0.3); }

        /* ================== 聊天 App 专属样式 ================== */

/* ================== 聊天主窗口全屏背景修复 ================== */

/* 1. 父容器：负责显示全屏背景 */
#app-chat {
    background-color: #1c1c1e; /* 默认底色 */
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    transition: background-image 0.3s ease; /* 切换 Tab 时背景丝滑过渡 */
}

/* 2. 头部：完全透明 (让背景透出来) */
#app-chat .app-header {
    background: transparent !important;
    /* 为了防止背景太花看不清字，可以加一点点渐变阴影，或者依靠图片本身 */
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent) !important;
}

/* 3. 子模块：背景透明 (否则会挡住父容器的背景) */
.chat-module-container {
    background: transparent !important;
}

/* 4. 个性化设置里的预览框：确保显示模式正确 */
.bg-upload-card {
    background-size: cover !important; /* 预览卡片也用 cover */
}

/* 2. 顶部选项卡 (Segmented Control) */
.chat-top-tabs-container {
    padding: 10px 16px;
    /* 玻璃背景 */
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    margin: 0 16px 10px 16px;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.15);

    display: flex; gap: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.chat-tab-btn {
    flex: 1;
    padding: 8px 0;
    text-align: center;
    font-size: 14px; color: rgba(255,255,255,0.7);
    border-radius: 10px;
    transition: all 0.2s;
    cursor: pointer;
}

/* 选中状态：更亮，轻微背景 */
.chat-tab-btn.active {
    background: rgba(255, 255, 255, 0.2);
    color: white; font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* 3. 中间内容视窗 */
.chat-page-content {
    flex: 1; overflow-y: auto;
    padding: 0 16px 100px 16px; /* 底部留出导航栏的高度 */
    display: none; /* 默认隐藏，JS控制显示 */
}
.chat-page-content.active { display: block; }

/* 占位提示 */
.chat-placeholder-text {
    text-align: center; margin-top: 50px; color: rgba(255,255,255,0.5); font-size: 14px;
}

/* 4. 底部导航栏 (Floating Dock Style) */
.chat-bottom-nav {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    width: 90%; height: 70px;

    /* 强力玻璃质感 */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 35px; /* 两头圆 */
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);

    display: flex; justify-content: space-around; align-items: center;
    z-index: 50;
}

.chat-nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    width: 60px; height: 100%;
    opacity: 0.6; transition: all 0.2s; cursor: pointer;
}
.chat-nav-item.active {
    opacity: 1; transform: translateY(-2px);
}
.chat-nav-item.active svg { fill: #0a84ff; filter: drop-shadow(0 0 8px rgba(10,132,255,0.5)); }
.chat-nav-item.active span { color: white; font-weight: 500; }

.chat-nav-icon { width: 24px; height: 24px; fill: white; margin-bottom: 2px; transition: fill 0.2s; }
.chat-nav-text { font-size: 10px; color: white; }
        /* ================== 聊天 App 背景适配 ================== */

/* ================== 聊天主窗口全屏背景修复 ================== */

/* 1. 父容器：负责显示全屏背景 */
#app-chat {
    background-color: #1c1c1e; /* 默认底色 */
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    transition: background-image 0.3s ease; /* 切换 Tab 时背景丝滑过渡 */
}

/* 2. 头部：完全透明 (让背景透出来) */
#app-chat .app-header {
    background: transparent !important;
    /* 为了防止背景太花看不清字，可以加一点点渐变阴影，或者依靠图片本身 */
    background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent) !important;
}

/* 3. 子模块：背景透明 (否则会挡住父容器的背景) */
.chat-module-container {
    background: transparent !important;
}

/* 4. 个性化设置里的预览框：确保显示模式正确 */
.bg-upload-card {
    background-size: cover !important; /* 预览卡片也用 cover */
}

        /* ================== 聊天 App 浅色模式字体/图标修复 ================== */

/* 1. 头部导航栏 (Header) */
body.light-theme #app-chat .app-title {
    color: #000000 !important; /* 标题变黑 */
}
body.light-theme #app-chat .app-back-btn {
    color: #007aff !important; /* 返回按钮变 iOS 蓝 */
}
body.light-theme #app-chat .app-back-btn svg {
    fill: #007aff !important; /* 图标变蓝 */
}
/* 右上角的加号 */
body.light-theme #app-chat .app-header div[style*="right: 20px"] {
    color: #007aff !important;
}

/* 2. 顶部选项卡 (Top Tabs) */
body.light-theme .chat-top-tabs-container {
    background: rgba(255, 255, 255, 0.8) !important; /* 背景变白 */
    border: 1px solid rgba(0,0,0,0.05) !important;
}
/* 未选中的 Tab 文字 */
body.light-theme .chat-tab-btn {
    color: #8e8e93 !important; /* 深灰色 */
}
/* 选中的 Tab */
body.light-theme .chat-tab-btn.active {
    background: #ffffff !important; /* 纯白底 */
    color: #000000 !important;      /* 纯黑字 */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

/* 3. 中间内容区 (Content) */
/* 占位文字 (暂无消息...) */
body.light-theme .chat-placeholder-text {
    color: rgba(60, 60, 67, 0.4) !important;
}

/* 好友列表项修复 */
/* 列表背景变白 */
body.light-theme #view-chat-friend div[style*="background:rgba(255,255,255,0.1)"] {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.05) !important;
}
/* 列表文字变黑 */
body.light-theme #view-chat-friend div[style*="color:white"] {
    color: #000000 !important;
}
/* 默认头像背景变浅灰 */
body.light-theme #view-chat-friend div[style*="background:#333"] {
    background: #f2f2f7 !important;
    color: #999 !important;
}

/* 4. 底部导航栏 (Bottom Nav) */
body.light-theme .chat-bottom-nav {
    background: rgba(255, 255, 255, 0.9) !important; /* 变白 */
    border: 1px solid rgba(0,0,0,0.1) !important;
}

/* 未选中的图标和文字 -> 灰色 */
body.light-theme .chat-nav-item .chat-nav-icon {
    fill: #999999 !important;
}
body.light-theme .chat-nav-item .chat-nav-text {
    color: #999999 !important;
}

/* 选中的图标和文字 -> 蓝色 */
body.light-theme .chat-nav-item.active .chat-nav-icon {
    fill: #007aff !important;
}
body.light-theme .chat-nav-item.active .chat-nav-text {
    color: #007aff !important;
}

        /* ================== 聊天创建相关样式 ================== */

/* 1. 操作菜单 (Action Sheet) 复用现有逻辑，增加样式 */
.sheet-icon { width: 20px; height: 20px; margin-right: 10px; fill: #0a84ff; }

/* 2. 创建窗口通用布局 */
.create-chat-tabs {
    display: flex; background: rgba(0,0,0,0.2);
    padding: 4px; border-radius: 10px; margin-bottom: 20px;
}
.create-chat-tab {
    flex: 1; text-align: center; padding: 8px 0;
    font-size: 13px; color: rgba(255,255,255,0.6);
    border-radius: 8px; cursor: pointer; transition: all 0.2s;
}
.create-chat-tab.active {
    background: rgba(255,255,255,0.2); color: white; font-weight: 600;
}

/* 3. 头像上传圆圈 */
.chat-avatar-upload {
    width: 80px; height: 80px; border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 1px dashed rgba(255,255,255,0.3);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; background-size: cover; background-position: center;
    margin: 0 auto 15px auto; transition: all 0.2s;
}
.chat-avatar-upload:active { transform: scale(0.95); }
.chat-avatar-icon { font-size: 24px; color: rgba(255,255,255,0.5); }

/* 4. 群成员动态列表 */
.group-member-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px; background: rgba(255,255,255,0.05);
    border-radius: 12px; margin-bottom: 8px;
}
.group-member-avatar-small {
    width: 44px; height: 44px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    background-size: cover; flex-shrink: 0; cursor: pointer;
}

/* 5. 角色选择列表 (支持多选) */
.role-select-check {
    width: 20px; height: 20px; border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.3);
    margin-left: auto; display: flex; align-items: center; justify-content: center;
}
.role-select-item.selected .role-select-check {
    background: #0a84ff; border-color: #0a84ff;
}
.role-select-item.selected .role-select-check::after {
    content: '✔'; font-size: 12px; color: white;
}

/* --- 浅色模式适配 --- */
body.light-theme .create-chat-tabs { background: rgba(0,0,0,0.05); }
body.light-theme .create-chat-tab { color: #666; }
body.light-theme .create-chat-tab.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
body.light-theme .chat-avatar-upload { background: #f2f2f7; border-color: rgba(0,0,0,0.1); }
body.light-theme .chat-avatar-icon { color: #999; }
body.light-theme .group-member-row { background: rgba(0,0,0,0.03); }
body.light-theme .group-member-avatar-small { background: white; border-color: rgba(0,0,0,0.1); }
body.light-theme .role-select-check { border-color: rgba(0,0,0,0.2); }

        /* ================== 弹窗显示强制修复 ================== */

/* 1. 强制激活时的动画位置 */
/* 这一句是之前漏掉的关键，加上它，弹窗就会乖乖滑上来 */
#modal-chat-type.active .action-sheet-content {
    transform: translateY(0) !important;
}

/* 2. 优化底部间距，防止贴底太紧不好看 */
#modal-chat-type {
    padding-bottom: 30px !important; /* 底部留白 */
    align-items: flex-end !important; /* 确保从底部对齐 */
}

/* 3. 确保内容区样式正确 */
#modal-chat-type .action-sheet-content {
    width: 95% !important;
    max-width: 400px !important;
    margin: 0 auto !important; /* 水平居中 */
    transform: translateY(100%); /* 默认藏在下面 */
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 10001 !important; /* 内容层级最高 */
}

        /* ================== 列表左滑菜单 & 置顶样式 ================== */

/* 1. 列表项容器 (作为滚动容器) */
.chat-swipe-wrapper {
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory; /* 关键：滚动吸附 */
    width: 100%;
    border-radius: 16px;
    margin-bottom: 10px;
    background: transparent;
    /* 隐藏滚动条 */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE */
}
.chat-swipe-wrapper::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
}

/* 2. 聊天卡片主体 (宽度占满 100%) */
.chat-main-card {
    min-width: 100%; /* 强制占满视窗宽度 */
    scroll-snap-align: start; /* 吸附点：左边 */

    /* 复用之前的卡片样式，但要去掉 margin，因为 margin 在 wrapper 上了 */
    background: rgba(255,255,255,0.1);
    padding: 15px;
    display: flex; align-items: center;
    box-sizing: border-box;
    transition: background 0.2s;
}
.chat-main-card:active { background: rgba(255,255,255,0.15); }

/* ================== 置顶样式增强版 ================== */

/* 1. 置顶卡片背景：蓝紫色渐变光晕 */
.chat-swipe-wrapper.pinned .chat-main-card {
    /* 深色模式：带有蓝色的磨砂感 */
    background: linear-gradient(90deg, rgba(10, 132, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%) !important;
    border: 1px solid rgba(10, 132, 255, 0.3) !important; /* 蓝色细边框 */
    position: relative; /* 确保角标能定位 */
    overflow: hidden;   /* 确保角标不溢出圆角 */
}

/* 2. 右上角：蓝色三角角标 (用 CSS 画出来的) */
.chat-swipe-wrapper.pinned .chat-main-card::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 0; height: 0;
    /* 画一个三角形 */
    border-style: solid;
    border-width: 0 30px 30px 0;
    border-color: transparent #0a84ff transparent transparent;
    z-index: 2;
}

/* 3. 角标里的小图钉图标 (SVG) */
.chat-swipe-wrapper.pinned .chat-main-card::before {
    content: '';
    position: absolute;
    top: 3px; right: 3px;
    width: 12px; height: 12px;
    /* 白色图钉图标 */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M16 12V4H17V2H7V4H8V12L6 14V16H11V22H13V16H18V14L16 12Z'/%3E%3C/svg%3E");
    background-size: cover;
    z-index: 3;
    transform: rotate(45deg); /* 让图钉正过来 */
}

/* --- 浅色模式适配 (置顶) --- */
body.light-theme .chat-swipe-wrapper.pinned .chat-main-card {
    /* 浅色模式：淡蓝色背景 */
    background: #f0f8ff !important; /* 爱丽丝蓝 */
    border-color: rgba(10, 132, 255, 0.2) !important;
    border-bottom: 1px solid rgba(10, 132, 255, 0.2) !important;
}

/* 3. 右侧操作按钮区 */
.chat-swipe-actions {
    display: flex;
    scroll-snap-align: end; /* 吸附点：右边 */
}

/* 通用按钮样式 */
.swipe-btn {
    width: 70px; /* 两个按钮共 140px */
    height: 100%;
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 600; font-size: 14px;
    letter-spacing: 1px;
}

/* 置顶按钮 (灰色/蓝色) */
.btn-pin { background: #5E5CE6; }
/* 删除按钮 (红色) */
.btn-del { background: #FF453A; }

/* --- 浅色模式适配 --- */
body.light-theme .chat-main-card {
    background: #ffffff; border-bottom: 1px solid rgba(0,0,0,0.05);
}
body.light-theme .chat-main-card:active { background: #f2f2f7; }
body.light-theme .chat-swipe-wrapper.pinned .chat-main-card {
    background: #f2f2f7; border-color: rgba(0,0,0,0.1);
}
/* 浅色模式下按钮保持鲜艳颜色，不用改 */
        /* 删除页浅色适配 */
body.light-theme #sub-chat-delete { background: #f2f2f7 !important; }
body.light-theme #sub-chat-delete .app-title { color: #FF3B30 !important; } /* 标题红 */
body.light-theme #del-chat-target-name { color: black !important; }
body.light-theme .ai-btn-secondary { color: #000 !important; background: rgba(0,0,0,0.05) !important; }

        /* ================== 聊天详情页 (对话界面) ================== */

/* 1. 聊天详情页容器 (修复：去掉 !important，允许 JS 覆盖背景) */
#sub-chat-detail {
    background-color: #1c1c1e; /* 默认深色底 */
    display: flex;
    flex-direction: column;
    /* 关键：确保背景图能铺满 */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}
/* 如果是深色模式，为了看清文字，加一层淡淡的渐变遮罩 */
#sub-chat-detail::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    /* ✅ 改好了：删掉了干扰字符 */
    background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 20%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.4) 100%);
    pointer-events: none; z-index: -1;
}

/* 2. 头部特殊设计 */
.chat-detail-header {
    height: 100px; /* 含状态栏高度 */
    padding-top: 44px; padding-left: 15px; padding-right: 15px;
    display: flex; align-items: center; justify-content: space-between;
    z-index: 50;
}

/* 液态玻璃圆形按钮 (返回键) */
.glass-circle-btn {
    width: 40px; height: 40px; border-radius: 50%;
    background: rgba(255, 255, 255, 0.15); /* 淡淡的玻璃白 */
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: transform 0.1s;
}
.glass-circle-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.25); }
.glass-circle-btn svg { width: 20px; height: 20px; fill: white; }

/* 中间用户信息 */
.chat-user-info {
    display: flex; flex-direction: column; align-items: center;
}
.chat-user-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background-size: cover; background-position: center; background-color: #333;
    margin-bottom: 2px; border: 1px solid rgba(255,255,255,0.2);
}
.chat-user-name { font-size: 14px; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
.chat-user-status { font-size: 10px; color: #4CD964; font-weight: 500; display:flex; align-items:center; gap:3px;}
.chat-user-status::before { content:''; width:6px; height:6px; background:#4CD964; border-radius:50%; }

/* 3. 消息内容区 */
.chat-detail-body {
    flex: 1; overflow-y: auto;
    padding: 10px 15px 20px 15px;
    display: flex; flex-direction: column; gap: 15px;
}

/* 4. 底部输入栏 (完全透明布局) */
.chat-detail-footer {
    padding: 10px 15px 30px 15px; /* 底部留白给 Home Bar */
    display: flex; align-items: center; gap: 10px;
    background: transparent; /* 背景完全透明 */
}

/* 透明图标按钮 (+, AI, 发送) */
.chat-footer-btn {
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none; /* 无背景 */
    cursor: pointer; transition: transform 0.1s;
}
.chat-footer-btn:active { transform: scale(0.9); opacity: 0.7; }
.chat-footer-btn svg { width: 26px; height: 26px; fill: white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }

/* 长条圆角输入框 */
.chat-input-pill {
    flex: 1; height: 40px;
    background: rgba(255, 255, 255, 0.15); /* 半透明底 */
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    display: flex; align-items: center; padding: 0 15px;
}
.chat-input-real {
    width: 100%; height: 100%;
    background: transparent; border: none; outline: none;
    color: white; font-size: 15px;
}
.chat-input-real::placeholder { color: rgba(255,255,255,0.5); }

/* 2. 浅色模式适配 (修复：只设底色，不挡图片) */
body.light-theme #sub-chat-detail {
    background-color: #f2f2f7 !important; /* 只覆盖颜色，不重置图片 */
    color: #000000 !important;
}
body.light-theme #sub-chat-detail::before { display: none; }

/* 头部适配 */
body.light-theme .glass-circle-btn {
    background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.05);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
body.light-theme .glass-circle-btn svg { fill: #000; }
body.light-theme .chat-user-name { color: #000; text-shadow: none; }

/* 底部适配 */
body.light-theme .chat-footer-btn svg { fill: #007aff; filter: none; }
body.light-theme .chat-input-pill {
    background: #ffffff; border-color: rgba(0,0,0,0.1);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
body.light-theme .chat-input-real { color: #000; }
body.light-theme .chat-input-real::placeholder { color: #999; }

        /* ================== 消息上下文菜单样式 (Popover Style) ================== */

/* === 修复：确保 Action Sheet 完整显示，增加底部留白 === */

#modal-message-menu {
    /* 核心 FIX：增加底部留白，防止被浏览器或系统 UI 裁切 */
    padding-bottom: 500px !important; /* 从 20px 增加到 40px */

    /* 确保对齐方式正确 */
    align-items: flex-end !important;

    /* 确保层级最高 */
    z-index: 3001 !important;
}

/* 2. 定义 Popover 菜单主体样式 */
.message-popover-menu {
    position: absolute; /* 绝对定位，由 JS 负责坐标 */

    /* 玻璃背景：比气泡主体更深一点的颜色 */
    background: rgba(30, 30, 35, 0.9);
    backdrop-filter: blur(15px);
    border-radius: 12px;
    padding: 5px 0; /* 内部留白 */
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    z-index: 3001; /* 确保菜单在所有内容之上 */
    overflow: hidden;
}

/* 3. 菜单项样式 */
.popover-item {
    padding: 8px 15px;
    font-size: 15px;
    color: white;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.1s;
}
.popover-item:hover, .popover-item:active {
    background: rgba(255, 255, 255, 0.15); /* 悬浮高亮 */
}
.popover-item.action-delete {
    color: #FF3B30; /* 删除键用红色 */
    font-weight: 500;
}

/* 浅色模式适配 */
body.light-theme .message-popover-menu {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0,0,0,0.1);
}
body.light-theme .popover-item { color: #000; }
body.light-theme .popover-item:hover { background: #f2f2f7; }

        /* ================== 聊天输入栏功能菜单样式 (固定 Grid 布局) ================== */

/* 1. 菜单容器 (绝对定位在输入栏上方) */
#chat-input-menu {
    position: absolute;
    bottom: 70px; /* 位于输入框上方，高度刚好避开输入栏 */
    left: 10px;
    right: 10px;

    background: rgba(30, 30, 35, 0.9); /* Opaque dark background */
    backdrop-filter: blur(15px);
    border-radius: 18px; /* 大圆角 */

    padding: 18px 16px 20px 16px; /* 内部留白 */
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);

    /* 动画控制 */
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    z-index: 40;

    display: none; /* 默认隐藏 */
}
#chat-input-menu.active {
    transform: translateY(0);
    display: block; /* 激活时显示 Grid */
}

/* 2. 核心：4x3 网格布局 */
.input-menu-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 列固定 */
    gap: 20px 0; /* 垂直和水平间距 */
    text-align: center;
}

/* 3. 单个菜单项样式 */
.input-menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    opacity: 0.9;
    transition: opacity 0.1s;
}

/* 4. 图标方块和文字 (深色模式) */
.input-menu-icon-square {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.1); /* 玻璃背景，匹配你的深色 App */
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 5px;
}
.input-menu-icon-square svg {
    width: 26px; height: 26px; fill: white;
}
.input-menu-text {
    font-size: 13px;
    color: white;
}

/* 浅色模式适配 */
body.light-theme #chat-input-menu { background: rgba(249, 249, 249, 0.95); }
body.light-theme .input-menu-icon-square { background: #e5e5ea; }
body.light-theme .input-menu-icon-square svg { fill: #333; }
body.light-theme .input-menu-text { color: #333; }

        /* ================== 聊天功能菜单 (横向滑动胶囊版) ================== */

/* 1. 菜单外层容器 (定位) */
#chat-input-menu {
    position: absolute;
    bottom: 70px;
    left: 10px;
    right: 10px;

    /* 这里的样式保持不变 */
    background: transparent;
    z-index: 40;
    transform: translateY(120%); /* 默认藏得更深一点 */
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    display: none;
}

#chat-input-menu.active {
    transform: translateY(0);
    display: block;
}

/* 2. 横向滚动容器 (Flex Row) */
.chat-scroll-menu {
    display: flex;
    flex-direction: row;       /* 强制横向排列 */
    overflow-x: auto;          /* 允许横向滚动 */
    overflow-y: hidden;        /* 禁止纵向滚动 */
    white-space: nowrap;       /* 防止换行 */
    gap: 12px;                 /* 卡片间距 */
    padding-bottom: 10px;      /* 预留滚动条空间(虽然隐藏了) */

    /* 隐藏滚动条 */
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.chat-scroll-menu::-webkit-scrollbar {
    display: none;
}

/* 3. 单个胶囊卡片 (Pill Card) - 透明版 */
.menu-pill-card {
    flex: 0 0 auto;            /* 禁止压缩，保持宽度 */
    height: 56px;
    min-width: 120px;          /* 最小宽度 */

    /* === 核心改动：极度透明的背景和边框 === */
    background: rgba(255, 255, 255, 0.05); /* 只有 5% 不透明度的白色，极淡 */
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); /* 轻微的磨砂模糊 */
    border: 1px solid rgba(255, 255, 255, 0.08); /* 极细微的边框 */
    border-radius: 28px;       /* 胶囊圆角 */

    /* 内部布局：左图右文 */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 20px;
    cursor: pointer;
    transition: transform 0.1s, background 0.2s;
}

.menu-pill-card:active {
    transform: scale(0.96);
    /* 点击时稍微亮一点点，提供反馈 */
    background: rgba(255, 255, 255, 0.15);
}

/* ... (中间的图标和文字样式不用变) ... */

/* 浅色模式适配 (透明版) */
body.light-theme .menu-pill-card {
    /* 浅色模式下用极淡的黑色背景 */
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.05);
    box-shadow: none; /* 移除阴影，更扁平透明 */
}
body.light-theme .menu-pill-card:active {
    background: rgba(0, 0, 0, 0.1);
}

/* 4. 图标与文字 */
.pill-icon {
    width: 24px; height: 24px;
    fill: white;
    margin-right: 10px;        /* 图标和文字的间距 */
}

.pill-text {
    font-size: 15px;
    font-weight: 500;
    color: white;
    letter-spacing: 0.5px;
}

/* 浅色模式适配 */
body.light-theme .menu-pill-card {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
body.light-theme .pill-icon { fill: #333; }
body.light-theme .pill-text { color: #333; }

        /* ================== 强制修复：功能菜单容器透明化 ================== */

#chat-input-menu {
    /* 1. 强制背景透明，去掉之前的深色底 */
    background: transparent !important;

    /* 2. 去掉外层的高斯模糊 (模糊只加在胶囊按钮上) */
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;

    /* 3. 去掉外层的阴影和边框 */
    box-shadow: none !important;
    border: none !important;

    /* 4. 调整位置 (确保紧贴输入框上方) */
    padding: 10px 0 !important;
    bottom: 60px !important;
}

/* 确保胶囊卡片本身有淡淡的背景 */
.menu-pill-card {
    /* 极淡的白色背景，透出壁纸 */
    background: rgba(255, 255, 255, 0.08) !important;
    backdrop-filter: blur(10px) !important;
    -webkit-backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

/* 浅色模式适配 */
body.light-theme #chat-input-menu {
    background: transparent !important;
    border: none !important;
}
body.light-theme .menu-pill-card {
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.05) !important;
}

        /* ================== 聊天设置页进阶样式 ================== */

/* ================== 修复：人设预览样式 (省略号版) ================== */
.setting-text-preview {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;

    /* 核心：超过 3 行显示省略号 (...) */
    display: -webkit-box;
    -webkit-line-clamp: 3;  /* 只显示3行 */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;

    border: 1px solid rgba(255,255,255,0.1);
    transition: background 0.2s;
}
.setting-text-preview:active { background: rgba(255,255,255,0.1); }

/* 新增：完整显示样式 (给 User 用) */
.setting-text-full {
    font-size: 14px;
    color: rgba(255,255,255,0.8);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;

    /* 核心：完整显示，不折叠 */
    display: block;
    white-space: pre-wrap; /* 保留换行 */

    border: 1px solid rgba(255,255,255,0.1);
}

/* 世界观标签 (优化版) */
.world-tag {
    padding: 6px 14px;
    border-radius: 20px; /* 更圆润 */
    font-size: 13px;
    color: rgba(255,255,255,0.9);

    /* 核心修改：改成深色玻璃，而不是亮蓝色 */
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);

    display: inline-flex; /* 防止换行错位 */
    align-items: center;
    gap: 8px;
    cursor: default;
    transition: background 0.2s;
}

/* 鼠标悬停效果 */
.world-tag:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* 删除按钮 X */
.world-tag-remove {
    cursor: pointer;
    opacity: 0.6;
    font-weight: bold;
    font-size: 14px;
    padding: 2px; /* 增加一点点击面积 */
}
.world-tag-remove:hover {
    opacity: 1;
    color: #FF3B30; /* 悬停变红 */
}

/* 3. 气泡样式选择器 */
.bubble-style-scroll {
    display: flex; overflow-x: auto; gap: 10px; padding: 5px 0;
    scrollbar-width: none;
}
.bubble-preset-item {
    min-width: 80px; height: 60px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: rgba(255,255,255,0.7);
    border: 2px solid transparent; cursor: pointer;
    flex-direction: column; gap: 5px;
}
.bubble-preset-item.active {
    border-color: #0a84ff; background: rgba(10, 132, 255, 0.1); color: white;
}
/* 预览小气泡 */
.mini-bubble-preview {
    width: 40px; height: 24px; border-radius: 12px;
    background: #0a84ff;
}

/* 4. 危险按钮区域 */
.danger-zone {
    margin-top: 30px;
    display: flex; flex-direction: column; gap: 15px;
}
.btn-danger-outline {
    background: transparent; border: 1px solid #FF3B30; color: #FF3B30;
    padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
}
.btn-danger-fill {
    background: #FF3B30; border: none; color: white;
    padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
}

/* 浅色适配 */
body.light-theme .setting-text-preview { background: rgba(0,0,0,0.05); color: #666; }
body.light-theme .world-tag { background: rgba(0, 122, 255, 0.1); color: #007aff; }
body.light-theme .bubble-preset-item { background: #fff; border-color: rgba(0,0,0,0.1); color: #333; }
body.light-theme .bubble-preset-item.active { border-color: #007aff; background: #f0f8ff; }

        /* ================== 强制修复：功能菜单透明化 (High Priority) ================== */

/* 1. 菜单容器：完全透明，无背景，无阴影 */
#chat-input-menu {
    background: transparent !important; /* 关键：去掉深色背景 */
    backdrop-filter: none !important;   /* 去掉外层模糊 */
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;        /* 去掉外层阴影 */
    border: none !important;            /* 去掉边框 */

    /* 位置调整：紧贴输入框上方 */
    bottom: 65px !important;
    padding: 10px 0 !important;
}

/* 2. 胶囊卡片：保持半透明玻璃感 */
.menu-pill-card {
    /* 这里的背景色要非常淡，才能透出壁纸 */
    background: rgba(30, 30, 35, 0.8) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;

    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 28px !important; /* 确保是圆角胶囊 */

    /* 阴影 */
    box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
}

/* 3. 滚动容器：去掉多余的内边距 */
.chat-scroll-menu {
    padding: 0 16px !important; /* 两侧留白 */
    overflow-x: auto !important;
    display: flex !important;
    gap: 12px !important;
}

/* 浅色模式适配 */
body.light-theme .menu-pill-card {
    background: rgba(255, 255, 255, 0.9) !important;
    border-color: rgba(0,0,0,0.1) !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05) !important;
}

        /* ================== 修复：人设文本改为滚动显示 ================== */
.setting-text-preview {
    font-size: 14px;
    color: rgba(255,255,255,0.7);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 12px;
    margin-top: 8px;
    cursor: pointer;

    /* 🚨 核心修改：不再截断，而是限制高度并允许滚动 */
    display: block;          /* 恢复块级显示 */
    max-height: 120px;       /* 限制最大高度 (约5-6行) */
    overflow-y: auto;        /* 内容多了显示滚动条 */
    white-space: pre-wrap;   /* 保留换行符 */

    /* 移除之前的截断属性 */
    -webkit-line-clamp: unset;
    -webkit-box-orient: unset;
    text-overflow: unset;

    border: 1px solid rgba(255,255,255,0.1);
}
        /* ================== 聊天设置页：强制显形补丁 ================== */

/* 1. 让卡片背景变亮，与底色区分开 */
#sub-chat-settings .settings-group {
    background-color: #2c2c2e !important; /* 亮一点的灰色 */
    border: 1px solid rgba(255,255,255,0.1) !important; /* 加个边框 */
    overflow: visible !important; /* 🚨 关键：禁止截断内容！ */
}

/* 2. 修复头像显示 (强制大小和占位色) */
#sub-chat-settings .v-cover-box {
    width: 50px !important;
    height: 50px !important;
    min-width: 50px !important; /* 防止被压缩 */
    background-color: rgba(255,255,255,0.2) !important; /* 明显的底色 */
    border: 2px solid rgba(255,255,255,0.3) !important;
    border-radius: 50% !important;

    /* 如果没图，显示一个加号 */
    display: flex !important;
    align-items: center;
    justify-content: center;
}
/* 给没图的头像加个图标提示 */
#sub-chat-settings .v-cover-box:empty::after {
    content: '+'; color: white; font-size: 24px; opacity: 0.5;
}

/* 3. 修复输入框 (加背景和边框，让它能被看见) */
#sub-chat-settings input[type="text"] {
    background: rgba(0, 0, 0, 0.3) !important; /* 深色底 */
    border: 1px solid rgba(255, 255, 255, 0.2) !important; /* 亮边框 */
    border-radius: 8px !important;
    color: white !important;
    padding: 8px 10px !important;
    height: 36px !important;
    width: 100% !important;
}

/* 4. 修复按钮显示 (防止被截断) */
#sub-chat-settings .tab-btn {
    background: rgba(255,255,255,0.1) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: white !important;
    padding: 8px 15px !important;
    border-radius: 8px !important;
}

/* 浅色模式适配 */
body.light-theme #sub-chat-settings .settings-group {
    background-color: #ffffff !important;
    border-color: rgba(0,0,0,0.1) !important;
}
body.light-theme #sub-chat-settings input[type="text"] {
    background: rgba(0,0,0,0.05) !important;
    border-color: rgba(0,0,0,0.1) !important;
    color: black !important;
}
body.light-theme #sub-chat-settings .v-cover-box {
    background-color: #f2f2f7 !important;
    border-color: rgba(0,0,0,0.1) !important;
}
body.light-theme #sub-chat-settings .v-cover-box:empty::after {
    color: #999;
}
        /* ================== 1. 人设文本统一截断样式 ================== */
.setting-text-preview {
    font-size: 14px;
    color: rgba(255,255,255,0.6);
    line-height: 1.6;
    background: rgba(255,255,255,0.05);
    padding: 12px;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;

    /* 核心：强制只显示 3 行，超出省略 */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;

    border: 1px solid rgba(255,255,255,0.1);
    transition: background 0.2s;
}
.setting-text-preview:active { background: rgba(255,255,255,0.1); }

/* 浅色模式适配 */
body.light-theme .setting-text-preview {
    background: rgba(0,0,0,0.05); color: #666;
}

        /* ================== 修复：浅色模式背景被遮挡 ================== */
body.light-theme #sub-chat-detail {
    /* 🚨 核心修复：去掉 !important，让 JS 设置的背景图能显示出来 */
    background-color: #f2f2f7;
}

/* ================== 优化：世界观选择列表 ================== */
#world-select-list .world-select-item {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: background 0.2s;
}
#world-select-list .world-select-item:active {
    background: rgba(255,255,255,0.1);
}
/* 标题 */
.world-select-title {
    font-size: 16px; font-weight: 600; color: white; margin-bottom: 4px;
}
/* 内容预览 (限制2行) */
.world-select-desc {
    font-size: 13px; color: rgba(255,255,255,0.6);
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden; line-height: 1.4;
}

/* 浅色适配 */
body.light-theme .world-select-item { border-bottom-color: rgba(0,0,0,0.05); }
body.light-theme .world-select-title { color: black; }
body.light-theme .world-select-desc { color: #666; }

        /* ================== 最终样式修复补丁 ================== */

/* 1. 修复：浅色模式聊天背景 (只设底色，不挡图片) */
body.light-theme #sub-chat-detail {
    background-color: #f2f2f7 !important; /* 关键：不能用 background 简写 */
    background-image: none; /* 默认无图，JS 会覆盖这个属性 */
}

/* 2. 修复：浅色模式世界观标签 (变深色字) */
body.light-theme .world-tag {
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.1) !important;
    color: #333 !important; /* 关键：文字变黑 */
}

/* 3. 新增：聊天气泡头像样式 */
.chat-msg-avatar {
    width: 38px; height: 38px;
    border-radius: 50%;
    flex-shrink: 0;
    background-size: cover; background-position: center;
    background-color: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.1);
}
/* 头像位置调整 */
.chat-msg.left .chat-msg-avatar { margin-right: 10px; }
.chat-msg.right .chat-msg-avatar { margin-left: 10px; }

/* 浅色模式头像边框 */
body.light-theme .chat-msg-avatar {
    border-color: rgba(0,0,0,0.1);
    background-color: #fff;
}

/* 4. 功能类：隐藏头像 (当设置关闭时) */
.hide-avatars .chat-msg-avatar {
    display: none !important;
}

        /* ================== 终极修复：聊天设置页浅色适配 ================== */

/* 1. 修复“选择设定”和“自定义”按钮 (优先级覆盖之前的强制白色) */
body.light-theme #sub-chat-settings .tab-btn {
    color: #007aff !important; /* 变回蓝色 */
    background: rgba(0, 0, 0, 0.05) !important; /* 浅灰背景 */
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    box-shadow: none !important;
}

/* 2. 修复已添加的世界观标签 (确保深色字) */
body.light-theme #sub-chat-settings .world-tag {
    color: #333333 !important; /* 深灰字 */
    background: rgba(0, 0, 0, 0.05) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
}

/* 3. 修复人设预览框的文字颜色 */
body.light-theme #sub-chat-settings .setting-text-preview,
body.light-theme #sub-chat-settings .setting-text-full {
    color: #333333 !important;
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.1) !important;
}

/* 4. 修复输入框 (昵称编辑框) */
body.light-theme #sub-chat-settings input[type="text"] {
    color: #000000 !important;
    background: rgba(0, 0, 0, 0.05) !important;
    border-color: rgba(0, 0, 0, 0.1) !important;
}

        /* --- 多选模式专用样式 --- */

/* 1. 消息容器进入多选模式 */
.chat-detail-body.selection-mode .chat-msg {
    cursor: pointer; /* 变成手型 */
}
/* 修改前：pointer-events: none; (这句导致了点击失效) */
/* 修改后：改为禁止文字选择，但允许点击 */
.chat-detail-body.selection-mode .msg-bubble-listen {
    user-select: none;          /* 禁止文字反白选中 */
    pointer-events: auto;       /* 👈 关键：允许点击事件穿透 */
}
/* 2. 选择圈圈 (默认隐藏) */
.msg-checkbox {
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.3);
    margin: 0 15px;
    flex-shrink: 0;
    display: none; /* 平时不显示 */
    align-items: center; justify-content: center;
    transition: all 0.2s;
}

/* 选中状态的圈圈 */
.chat-msg.selected .msg-checkbox {
    background: #0a84ff;
    border-color: #0a84ff;
}
.chat-msg.selected .msg-checkbox::after {
    content: '✔'; font-size: 12px; color: white;
}

/* 进入模式时显示圈圈 */
.chat-detail-body.selection-mode .msg-checkbox {
    display: flex;
}

/* 3. 底部批量操作栏 (初始隐藏) */
#batch-action-bar {
    position: absolute; bottom: 0; left: 0; width: 100%;
    height: 80px;
    background: rgba(30, 30, 35, 0.95);
    border-top: 1px solid rgba(255,255,255,0.1);
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 30px 20px 30px; /* 避开 Home Indicator */
    z-index: 100;
    transform: translateY(100%); /* 默认藏在下面 */
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
#batch-action-bar.active {
    transform: translateY(0);
}

/* 浅色模式适配 */
body.light-theme .msg-checkbox { border-color: rgba(0,0,0,0.2); }
body.light-theme #batch-action-bar { background: rgba(255,255,255,0.95); border-top-color: rgba(0,0,0,0.1); }

        /* --- 引用功能专用样式 --- */

/* 1. 输入框上方的预览条 */
#quote-preview-bar {
    position: absolute;
    bottom: 70px; left: 15px; right: 15px;
    background: rgba(40, 40, 45, 0.95);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 12px 15px;
    display: none; /* 默认隐藏 */
    align-items: center; justify-content: space-between;
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 35;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
#quote-content-box {
    flex: 1; overflow: hidden;
    display: flex; flex-direction: column;
}
.quote-title { font-size: 12px; color: #0a84ff; margin-bottom: 2px; font-weight: 600; }
.quote-text {
    font-size: 13px; color: rgba(255,255,255,0.8);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.btn-close-quote {
    width: 24px; height: 24px;
    background: rgba(255,255,255,0.1); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; margin-left: 10px; font-size: 14px; color: #888;
}

/* 2. 气泡内部的灰色引用块 */
.msg-quote-block {
    background: rgba(0, 0, 0, 0.15); /* 深色背景 */
    border-left: 3px solid rgba(255, 255, 255, 0.5); /* 左侧竖线 */
    padding: 6px 10px;
    margin-bottom: 8px; /* 和正文拉开距离 */
    border-radius: 6px;
    font-size: 13px;
    display: flex; flex-direction: column;
    cursor: pointer;
    user-select: none;
}
.msg-quote-sender { font-size: 11px; opacity: 0.7; margin-bottom: 2px; font-weight: 600; }
.msg-quote-text { opacity: 0.9; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}

/* 浅色模式适配 */
body.light-theme #quote-preview-bar { background: rgba(255,255,255,0.95); border-color: rgba(0,0,0,0.1); }
body.light-theme .quote-text { color: #333; }
body.light-theme .msg-quote-block { background: rgba(0,0,0,0.05); border-left-color: rgba(0,0,0,0.2); }
body.light-theme .msg-quote-text { color: #555; }

        /* ================== Instagram 风格 Stories 样式 ================== */

/* 1. 容器：横向滚动 */
.ig-stories-container {
    height: 110px; /* 固定高度 */
    width: 100%;
    display: flex;
    align-items: center;
    overflow-x: auto; /* 允许横向滚动 */
    overflow-y: hidden;
    padding: 10px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1); /* 底部细线 */
    scrollbar-width: none; /* 隐藏滚动条 */
    flex-shrink: 0; /* 防止被挤压 */
}
.ig-stories-container::-webkit-scrollbar { display: none; }

/* 2. 单个 Story 项目 */
.story-item {
    display: flex; flex-direction: column; align-items: center;
    margin-right: 15px; /* 间距 */
    cursor: pointer;
    width: 72px; /* 占位宽度 */
    flex-shrink: 0;
}

/* 3. 头像外面的圈 (容器) */
.story-ring-wrap {
    width: 68px; height: 68px;
    border-radius: 50%;
    padding: 2px; /* 圈的粗细 */
    /* 默认：未发布的浅灰色 */
    border: 2px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center;
    position: relative;
}

/* 4. 激活状态：彩虹圈 (IG 经典渐变) */
.story-ring-wrap.active {
    border: none; /* 去掉边框，改用背景模拟 */
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    padding: 2px; /* 保持内间距 */
}

/* 5. 头像本体 */
.story-avatar {
    width: 100%; height: 100%;
    border-radius: 50%;
    background-color: #1c1c1e; /* 与背景同色，形成隔离带 */
    border: 2px solid #1c1c1e; /* 内描边，把头像和彩虹圈隔开 */
    background-size: cover; background-position: center;
}

/* 6. 名字 */
.story-name {
    font-size: 11px; margin-top: 4px;
    color: rgba(255,255,255,0.9);
    width: 70px; text-align: center;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* 7. 【关键】User 专属样式：右下角加号 */
.story-add-badge {
    position: absolute;
    bottom: 0; right: 0;
    width: 20px; height: 20px;
    background: #0a84ff; /* 蓝色 */
    border-radius: 50%;
    border: 2px solid #1c1c1e; /* 与背景同色的边框 */
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 16px; font-weight: bold;
    z-index: 10;
}
/* User 的圈不显示彩虹，也不显示灰圈，或者是透明 */
.story-ring-wrap.user-mode {
    border-color: transparent;
    padding: 0;
}
.story-ring-wrap.user-mode .story-avatar {
    border: none; /* User 头像不需要内隔离 */
    width: 64px; height: 64px; /* 稍微大一点点或保持一致 */
}

/* 浅色模式适配 */
body.light-theme .ig-stories-container { border-bottom-color: rgba(0,0,0,0.1); }
body.light-theme .story-ring-wrap { border-color: rgba(0,0,0,0.1); }
body.light-theme .story-name { color: #000; }
body.light-theme .story-avatar { border-color: #f2f2f7; } /* 隔离带变白 */
body.light-theme .story-add-badge { border-color: #f2f2f7; }

        /* ================== 现代玻璃拟态 Feed (原创风格) ================== */

/* --- 1. 顶部限时动态 (Holographic Cards) --- */
.status-flow-container {
    height: 150px; /* 增加高度以容纳动效 */
    width: 100%;
    display: flex;
    align-items: center;
    overflow-x: auto;
    padding: 10px 16px;
    gap: 14px; /* 卡片间距 */
    scrollbar-width: none;
}
.status-flow-container::-webkit-scrollbar { display: none; }

/* 基础卡片结构 */
.status-card {
    width: 90px; height: 120px;
    border-radius: 18px;
    position: relative;
    flex-shrink: 0;
    cursor: pointer;
    overflow: hidden; /* 裁剪圆角 */

    /* 默认状态 (已读/无新动态) */
    background: #2c2c2e;
    border: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}
.status-card:active { transform: scale(0.95); }

/* --- 🌟 核心设计：未读动态 (流光边框) --- */
.status-card.unread {
    border: 1px solid transparent; /* 透明边框 */
    /* 利用双层背景模拟渐变边框 */
    background-image: linear-gradient(#1c1c1e, #1c1c1e),
                      linear-gradient(135deg, #0a84ff 0%, #B620E0 50%, #F7B500 100%);
    background-origin: border-box;
    background-clip: content-box, border-box;
    /* 发光投影 */
    box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
}

/* 动态背景图 */
.status-bg-img {
    width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0.8;
    transition: opacity 0.2s;
}
/* 未读时图片稍微亮一点 */
.status-card.unread .status-bg-img { opacity: 1; }

/* 底部渐变遮罩 (让文字看清) */
.status-card::after {
    content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 50%;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    pointer-events: none;
}

/* 左上角：发布者头像 (加大增强版) */
.status-mini-avatar {
    position: absolute;
    top: 6px; left: 6px;

    width: 36px; height: 36px;

    border-radius: 50%;
    border: 2px solid #ffffff;

    /* ✅ 改好了：删掉了那个 style="..." */
    z-index: 5;
    background-color: #333;

    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

/* 右上角：限时倒计时 */
.status-time-pill {
    position: absolute;
    top: 6px; right: 6px; /* 与左边头像对齐 */

    /* ... 其他属性保持不变 ... */
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    border-radius: 6px;
    padding: 2px 6px; /*稍微加宽一点padding*/
    font-size: 10px; /* 字体稍微大一丢丢，更容易看清 */
    font-weight: 700; color: rgba(255,255,255,0.9);
    z-index: 5;
    border: 0.5px solid rgba(255,255,255,0.2);
}

/* 底部：名字 */
.status-name {
    position: absolute; bottom: 10px; left: 0; width: 100%;
    text-align: center;
    font-size: 11px; color: white; font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    padding: 0 5px;
    z-index: 5;
}

/* --- "我"的发布卡片 (特殊样式) --- */
.status-card.my-card {
    border: 1px dashed rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.05);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.status-card.my-card::after { display: none; } /* 去掉遮罩 */

.my-add-btn {
    width: 36px; height: 36px;
    background: #0a84ff;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 20px;
    box-shadow: 0 4px 10px rgba(10, 132, 255, 0.4);
    margin-bottom: 8px;
    z-index: 10;
}
.my-card-text { font-size: 11px; color: rgba(255,255,255,0.6); font-weight: 500; }

/* 浅色模式适配 */
body.light-theme .status-card {
    background: #fff; border-color: rgba(0,0,0,0.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
body.light-theme .status-card.unread {
    /* 浅色模式下，未读边框更明显 */
    box-shadow: 0 4px 15px rgba(10, 132, 255, 0.25);
}
body.light-theme .status-card.my-card {
    background: #f2f2f7; border-color: rgba(0,0,0,0.1);
}
body.light-theme .my-card-text { color: #666; }

/* --- 2. 帖子列表 (Feed) --- */
.feed-list-container {
    padding: 0 16px 80px 16px; /* 底部留白 */
}

/* 玻璃卡片主体 */
.feed-card {
    background: rgba(255, 255, 255, 0.08); /* 极淡的背景 */
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px; /* 大圆角 */
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

/* 头部：更像杂志排版 */
.feed-header {
    display: flex; align-items: center; margin-bottom: 12px;
}
.feed-avatar {
    width: 40px; height: 40px; border-radius: 12px; /* 方圆形头像 */
    background-size: cover; background-position: center;
    margin-right: 12px;
    border: 1px solid rgba(255,255,255,0.1);
}
.feed-user-info { flex: 1; }
.feed-username { font-size: 15px; font-weight: 700; color: white; display: block;}
.feed-time { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 2px; display: block;}

/* 内容区 */
.feed-text {
    font-size: 15px; color: rgba(255,255,255,0.9);
    line-height: 1.6; margin-bottom: 12px;
}
.feed-media {
    width: 100%; aspect-ratio: 4/3; /* 4:3 比例，更像摄影作品 */
    border-radius: 16px;
    object-fit: cover;
    background-color: #2c2c2e;
    display: block; margin-bottom: 15px;
    cursor: pointer;
}

/* 底部操作区 (胶囊风格) */
.feed-actions {
    display: flex; gap: 10px;
}

/* 胶囊按钮 */
.action-pill {
    height: 36px;
    padding: 0 14px;
    border-radius: 18px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center;
    gap: 6px;
    cursor: pointer; transition: all 0.2s;
    color: rgba(255,255,255,0.8);
    font-size: 13px; font-weight: 500;
}
.action-pill:active { background: rgba(255,255,255,0.15); transform: scale(0.96); }

/* 激活状态 (点赞/收藏) */
.action-pill.active-like {
    background: rgba(255, 59, 48, 0.15);
    color: #FF3B30;
    border-color: rgba(255, 59, 48, 0.2);
}
.action-pill.active-save {
    background: rgba(255, 214, 10, 0.15);
    color: #FFD60A;
    border-color: rgba(255, 214, 10, 0.2);
}

.action-icon { width: 18px; height: 18px; fill: currentColor; }

/* 浅色模式适配 */
body.light-theme .status-card { border-color: rgba(0,0,0,0.05); background: rgba(0,0,0,0.03); }
body.light-theme .status-name { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
body.light-theme .status-add-overlay { background: rgba(255,255,255,0.6); }

body.light-theme .feed-card {
    background: #ffffff;
    border-color: rgba(0,0,0,0.05);
    box-shadow: 0 5px 20px rgba(0,0,0,0.05);
}
body.light-theme .feed-username { color: #000; }
body.light-theme .feed-text { color: #333; }
body.light-theme .action-pill {
    background: #f2f2f7; color: #666; border-color: transparent;
}
body.light-theme .action-pill:active { background: #e5e5ea; }

        /* --- 修复：强制点赞/收藏变色 (优先级补丁) --- */
.action-pill.active-like {
    background: rgba(255, 59, 48, 0.15) !important;
    color: #FF3B30 !important;
    border-color: rgba(255, 59, 48, 0.2) !important;
}
.action-pill.active-save {
    background: rgba(255, 214, 10, 0.15) !important;
    color: #FFD60A !important;
    border-color: rgba(255, 214, 10, 0.2) !important;
}
/* 确保图标跟随文字变色 */
.action-pill.active-like svg,
.action-pill.active-save svg {
    fill: currentColor !important;
}

        /* ================== 1. 顶部发布按钮重构 (区别于创建角色) ================== */
/* 修改 .my-add-btn 的样式 */
.my-add-btn {
    width: 40px; height: 40px;
    /* 渐变色背景，更有活力 */
    background: linear-gradient(135deg, #0a84ff 0%, #007aff 100%);
    border-radius: 12px; /* 方圆形，区别于纯圆的角色头像 */
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 24px;
    box-shadow: 0 4px 15px rgba(10, 132, 255, 0.4);
    margin-bottom: 8px;
    z-index: 10;
    transition: transform 0.1s;
}
.my-add-btn:active { transform: scale(0.9); }

/* 给加号换个图标 (可选，用伪元素画一个更细致的加号) */
.my-add-btn::before, .my-add-btn::after {
    content: ''; position: absolute; background: white; border-radius: 2px;
}
.my-add-btn::before { width: 16px; height: 3px; }
.my-add-btn::after { width: 3px; height: 16px; }

/* 调整底部文字 */
.my-card-text {
    font-size: 10px; font-weight: 600;
    color: rgba(255,255,255,0.8);
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

/* ================== 2. 发帖页面 (Create Moment) ================== */

/* 文本输入区 */
.moment-textarea {
    width: 100%; min-height: 120px;
    background: transparent; border: none; outline: none;
    color: white; font-size: 16px; line-height: 1.6;
    padding: 15px; resize: none;
    font-family: inherit;
}
.moment-textarea::placeholder { color: rgba(255,255,255,0.3); }

/* 九宫格上传区 */
.moment-upload-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3列 */
    gap: 8px;
    padding: 0 15px 30px 15px;
}

/* 单个图片预览块 */
.upload-preview-item {
    aspect-ratio: 1/1; /* 正方形 */
    border-radius: 8px;
    background-color: rgba(255,255,255,0.05);
    background-size: cover; background-position: center;
    position: relative;
    overflow: hidden;
}

/* 删除按钮 (右上角小叉) */
.btn-remove-img {
    position: absolute; top: 4px; right: 4px;
    width: 20px; height: 20px;
    background: rgba(0,0,0,0.6); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 12px; cursor: pointer;
    backdrop-filter: blur(4px);
}

/* 上传按钮 (方块+) */
.upload-add-btn {
    aspect-ratio: 1/1;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    border: 1px dashed rgba(255,255,255,0.3);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
}
.upload-add-btn:active { background: rgba(255,255,255,0.1); }
.upload-add-icon { font-size: 30px; color: rgba(255,255,255,0.4); font-weight: 300; }

/* 浅色模式适配 */
body.light-theme .moment-textarea { color: #000; }
body.light-theme .moment-textarea::placeholder { color: rgba(0,0,0,0.4); }
body.light-theme .upload-preview-item { background-color: #f2f2f7; }
body.light-theme .upload-add-btn { background: #f2f2f7; border-color: rgba(0,0,0,0.1); }
body.light-theme .upload-add-icon { color: #999; }
body.light-theme .my-add-btn { box-shadow: 0 4px 15px rgba(10, 132, 255, 0.2); }
body.light-theme .my-card-text { color: #666; }

        /* ================== 多图轮播 (Carousel) 样式 ================== */

/* 1. 轮播容器 */
.feed-gallery {
    width: 100%;
    aspect-ratio: 4/3; /* 保持 4:3 比例 */
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory; /* 关键：强制按页吸附 */
    scrollbar-width: none; /* 隐藏滚动条 */
    border-radius: 16px;
    margin-bottom: 15px;
    background-color: #2c2c2e;
    position: relative;
}
.feed-gallery::-webkit-scrollbar { display: none; }

/* 2. 单张图片项 */
.feed-gallery-item {
    min-width: 100%; /* 强制占满宽度 */
    height: 100%;
    object-fit: cover;
    scroll-snap-align: start; /* 吸附点 */
}

/* 3. 图片计数器 (右上角显示 1/9) */
.feed-counter {
    position: absolute;
    top: 15px; right: 15px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px; color: white; font-weight: 600;
    pointer-events: none;
    z-index: 5;
}

/* 覆盖之前的 .feed-media 样式 (防止冲突) */
.feed-media { display: none; }

        /* ================== 多图轮播 (自适应高度版) ================== */

/* 1. 轮播容器 */
.feed-gallery {
    width: 100%;
    /* 🌟 默认高度 (JS会动态覆盖它) */
    height: 400px;
    /* 🌟 背景透明：这样短图留白的地方就是卡片颜色 */
    background-color: transparent;

    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    border-radius: 12px;
    margin-bottom: 15px;
    position: relative;

    /* 增加一个过渡，高度变化时丝滑一点 */
    transition: height 0.3s ease;
}
.feed-gallery::-webkit-scrollbar { display: none; }

/* 2. 单张图片项 */
.feed-gallery-item {
    min-width: 100%;
    height: 100%;
    /* 🌟 核心：包含模式，完整显示 */
    object-fit: contain;
    scroll-snap-align: center;
    display: block;
}

/* 3. 计数器样式保持不变 */
.feed-counter {
    position: absolute;
    top: 15px; right: 15px;
    background: rgba(0, 0, 0, 0.4); /*稍微淡一点*/
    backdrop-filter: blur(8px);
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 11px; color: rgba(255,255,255,0.9); font-weight: 600;
    pointer-events: none;
    z-index: 5;
    border: 0.5px solid rgba(255,255,255,0.1);
}

        /* ================== 全屏图片预览器 (Image Viewer) ================== */
.image-viewer-overlay {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background-color: rgba(0, 0, 0, 0.95); /* 深黑背景 */
    z-index: 10000; /* 最高层级 */
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none; /* 默认穿透 */
    transition: opacity 0.3s ease;
    backdrop-filter: blur(10px);
}

.image-viewer-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

#image-viewer-target {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain; /* 保证完整显示 */
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.image-viewer-overlay.active #image-viewer-target {
    transform: scale(1);
}

/* 关闭按钮 (右上角) */
.viewer-close-btn {
    position: absolute;
    top: 40px; right: 20px;
    width: 40px; height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    font-size: 24px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    z-index: 10001;
}

        /* ================== 全屏画廊预览器 (Gallery Viewer) ================== */
.image-viewer-overlay {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background-color: #000; /* 纯黑沉浸 */
    z-index: 10000;
    display: flex; flex-direction: column; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s ease;
}
.image-viewer-overlay.active {
    opacity: 1; pointer-events: auto;
}

/* 轮播容器 */
.viewer-gallery {
    display: flex;
    width: 100%; height: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory; /* 强制分页 */
    scrollbar-width: none;
    align-items: center; /* 垂直居中 */
}
.viewer-gallery::-webkit-scrollbar { display: none; }

/* 单张图片项 */
.viewer-img-item {
    min-width: 100vw; /* 占满全屏宽 */
    height: 100vh;    /* 占满全屏高 */
    object-fit: contain; /* 完整显示 */
    scroll-snap-align: center; /* 居中吸附 */
    transform: scale(1);
}

/* 关闭按钮 */
.viewer-close-btn {
    position: absolute; top: 40px; right: 20px;
    width: 40px; height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%; color: white; font-size: 24px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 10002;
}

/* 页码计数器 */
.viewer-counter {
    position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px; border-radius: 12px;
    font-size: 14px; color: white; font-weight: 600;
    z-index: 10002; pointer-events: none;
}

        /* ================== 帖子详情页与评论样式 ================== */

/* 1. 详情页容器微调 */
#sub-moment-detail .wallpaper-content {
    padding: 0;
    display: flex; flex-direction: column;
    height: 100%;
}

/* 2. 详情页里的帖子样式微调 */
.detail-post-wrapper {
    padding-top: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 10px;
}
/* 去掉详情页里帖子的圆角和阴影，让它更像原生页面的头部 */
.detail-post-wrapper .feed-card {
    background: transparent;
    border: none;
    box-shadow: none;
    margin-bottom: 0;
    border-radius: 0;
}

/* 3. 评论区容器 */
.comments-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 0 16px 80px 16px; /* 底部留白给输入框 */
}

/* 4. 单条评论 */
.comment-item {
    display: flex; gap: 12px;
    margin-bottom: 16px;
}
.comment-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background-color: #333; background-size: cover; background-position: center;
    flex-shrink: 0; border: 1px solid rgba(255,255,255,0.1);
}
.comment-content { flex: 1; }
.comment-user {
    font-size: 13px; color: rgba(255,255,255,0.6);
    font-weight: 600; margin-bottom: 2px;
}
.comment-text {
    font-size: 14px; color: rgba(255,255,255,0.9);
    line-height: 1.5; white-space: pre-wrap;
}
.comment-meta {
    font-size: 11px; color: rgba(255,255,255,0.3); margin-top: 4px;
    display: flex; gap: 10px;
}
.comment-reply-btn { cursor: pointer; font-weight: 500; }

/* 5. 底部固定输入栏 (复用聊天输入栏样式，微调背景) */
.moment-footer-input {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: rgba(30, 30, 35, 0.95);
    backdrop-filter: blur(20px);
    padding: 10px 16px 30px 16px; /* 适配全面屏底部 */
    display: flex; align-items: center; gap: 10px;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 50;
}

/* 浅色模式适配 */
body.light-theme .moment-footer-input { background: rgba(255,255,255,0.95); border-top-color: rgba(0,0,0,0.1); }
body.light-theme .comment-user { color: rgba(0,0,0,0.6); }
body.light-theme .comment-text { color: #333; }
body.light-theme .detail-post-wrapper { border-bottom-color: rgba(0,0,0,0.05); }

        /* ================== 修复：详情页分割线 & 评论样式 ================== */

/* 1. 详情页帖子与评论的分割线 (加深颜色，确保可见) */
.detail-post-wrapper {
    border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
    padding-bottom: 20px;
    margin-bottom: 20px;
}

/* 2. 评论删除按钮 (默认红色小字) */
.comment-del-btn {
    color: #FF3B30;
    margin-left: 10px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
}

/* 3. 评论时间样式 */
.comment-time {
    font-size: 11px;
    opacity: 0.6;
}

/* --- 浅色模式适配 (关键修复) --- */
body.light-theme .detail-post-wrapper {
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important; /* 浅色模式下的灰线 */
}
body.light-theme .comment-time {
    color: rgba(0,0,0,0.5);
}

        /* ================== 🚨 浅色模式终极修复补丁 (发布页 & 详情页) 🚨 ================== */

/* --- 1. 发布动态页 (Create Moment) --- */
body.light-theme #sub-create-moment {
    background-color: #f2f2f7 !important; /* 浅灰底 */
}
body.light-theme #sub-create-moment .app-title {
    color: #000000 !important; /* 标题变黑 */
}
body.light-theme #sub-create-moment .app-back-btn {
    color: #007aff !important; /* 取消按钮变蓝 */
}
/* 输入框文字 */
body.light-theme .moment-textarea {
    color: #000000 !important;
}
body.light-theme .moment-textarea::placeholder {
    color: rgba(0, 0, 0, 0.4) !important;
}
/* 图片预览格 */
body.light-theme .moment-upload-grid .upload-add-btn {
    border-color: rgba(0,0,0,0.1) !important;
    background-color: #ffffff !important;
}
body.light-theme .moment-upload-grid .upload-add-icon {
    color: rgba(0,0,0,0.3) !important;
}

/* --- 2. 帖子详情页 (Detail Page) --- */
body.light-theme #sub-moment-detail {
    background-color: #f2f2f7 !important;
}
body.light-theme #sub-moment-detail .app-title {
    color: #000000 !important;
}
body.light-theme #sub-moment-detail .app-back-btn {
    color: #007aff !important;
}

/* 帖子内容适配 */
body.light-theme #moment-detail-card-container .feed-username {
    color: #000000 !important;
}
body.light-theme #moment-detail-card-container .feed-text {
    color: #333333 !important;
}
body.light-theme #moment-detail-card-container .feed-time {
    color: rgba(0,0,0,0.5) !important;
}
/* 分割线 */
body.light-theme .detail-post-wrapper {
    border-bottom: 1px solid rgba(0,0,0,0.1) !important;
}
/* “全部评论”小标题 */
body.light-theme #moment-detail-scroll-area div[style*="color:rgba(255,255,255,0.5)"] {
    color: rgba(0,0,0,0.5) !important;
}

/* --- 3. 评论区适配 --- */
body.light-theme .comment-user {
    color: rgba(0,0,0,0.6) !important; /* 昵称深灰 */
}
body.light-theme .comment-text {
    color: #000000 !important; /* 内容纯黑 */
}
body.light-theme .comment-time {
    color: rgba(0,0,0,0.4) !important;
}
body.light-theme .comment-reply-btn {
    color: #007aff !important; /* 回复按钮蓝色 */
}
body.light-theme .comment-avatar {
    border-color: rgba(0,0,0,0.1) !important;
    background-color: #ffffff !important;
}

/* --- 4. 底部评论输入框 --- */
body.light-theme .moment-footer-input {
    background-color: rgba(255, 255, 255, 0.95) !important; /* 白底 */
    border-top: 1px solid rgba(0,0,0,0.1) !important;
}
/* 输入框本体 */
body.light-theme #moment-reply-input {
    color: #000000 !important;
    background: transparent !important; /* 去掉 input 自身背景，依赖外层 pill */
}
/* 输入框外壳 (圆角条) */
body.light-theme .moment-footer-input .chat-input-pill {
    background-color: rgba(0,0,0,0.05) !important; /* 浅灰条 */
    border: 1px solid rgba(0,0,0,0.05) !important;
}
body.light-theme #moment-reply-input::placeholder {
    color: rgba(0,0,0,0.4) !important;
}

        /* ================== 修复：帖子时间与更多按钮 ================== */

/* 1. 定义更多按钮的样式类 (替代之前的内联样式) */
.feed-more-btn {
    font-size: 20px;
    color: rgba(255,255,255,0.5); /* 默认深色模式：半透明白 */
    cursor: pointer;
    padding: 0 10px;
    line-height: 1;
}

/* 2. 浅色模式适配 (核心修复) */
body.light-theme .feed-time {
    color: rgba(0, 0, 0, 0.4) !important; /* 时间变深灰 */
}
body.light-theme .feed-more-btn {
    color: rgba(0, 0, 0, 0.5) !important; /* 按钮变黑 */
}

        /* 修复：动态更多选项弹窗动画 */
#modal-post-menu.active .action-sheet-content {
    transform: translateY(0) !important;
}

/* 确保它在最上层，防止被底部导航栏遮挡 */
#modal-post-menu {
    z-index: 3000 !important;
}

        /* ================== 浅色模式弹窗文字强制修复 ================== */

/* 1. 通用确认弹窗 (删除帖子/评论/清空记录 用这个) */
body.light-theme #gen-confirm-title {
    color: #000000 !important; /* 强制标题变黑 */
}

body.light-theme #gen-confirm-desc {
    color: rgba(0, 0, 0, 0.6) !important; /* 强制描述变深灰 */
}

/* 2. 删除歌曲/好友的特定弹窗 (防止那个也看不见) */
body.light-theme #modal-delete-confirm div[style*="color: white"],
body.light-theme #modal-delete-confirm div[style*="color:white"] {
    color: #000000 !important;
}

body.light-theme #modal-delete-confirm div[style*="color: rgba(255,255,255,0.6)"] {
    color: rgba(0, 0, 0, 0.6) !important;
}

/* 3. 选中文字高亮 (比如 "删除xxx吗") */
body.light-theme #del-song-name,
body.light-theme #del-chat-target-name {
    color: #000000 !important;
    font-weight: bold !important;
}

        /* ================== 浅色模式弹窗文字强制修复 ================== */

/* 1. 通用确认弹窗 (删除帖子/评论/清空记录 用这个) */
body.light-theme #gen-confirm-title {
    color: #000000 !important; /* 强制标题变黑 */
}

body.light-theme #gen-confirm-desc {
    color: rgba(0, 0, 0, 0.6) !important; /* 强制描述变深灰 */
}

/* 2. 删除歌曲/好友的特定弹窗 (防止那个也看不见) */
body.light-theme #modal-delete-confirm div[style*="color: white"],
body.light-theme #modal-delete-confirm div[style*="color:white"] {
    color: #000000 !important;
}

body.light-theme #modal-delete-confirm div[style*="color: rgba(255,255,255,0.6)"] {
    color: rgba(0, 0, 0, 0.6) !important;
}

/* 3. 选中文字高亮 (比如 "删除xxx吗") */
body.light-theme #del-song-name,
body.light-theme #del-chat-target-name {
    color: #000000 !important;
    font-weight: bold !important;
}

        /* ================== 🌈 Instagram 风格光圈 (修复增强版) ================== */

/* 1. 消息列表头像容器 */
.role-card-img-wrapper {
    position: relative;
    width: 56px; height: 56px; /* 容器定宽 */
    margin-right: 15px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;

    /* 默认透明边框 (占位，防止抖动) */
    border: 2px solid transparent;
}

/* 2. 激活状态：彩虹渐变背景 */
.role-card-img-wrapper.has-story {
    /* 核心：利用 padding 挤出光圈 */
    padding: 3px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
}

/* 3. 头像本体 (强制覆盖) */
.role-card-img-wrapper .role-card-img {
    width: 100% !important;
    height: 100% !important;
    border-radius: 50% !important;

    /* 内描边 (黑色)，把头像和光圈隔开 */
    border: 2px solid #1c1c1e !important;

    background-color: #333;
    background-size: cover;
    background-position: center;
    margin: 0 !important; /* 去掉旧样式的边距 */
    display: block;
}

/* 4. 详情页头部头像容器 */
#chat-header-avatar-wrap {
    width: 42px; height: 42px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid transparent; /* 默认无圈 */
}
#chat-header-avatar-wrap.has-story {
    padding: 2px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
}
#chat-header-avatar-wrap .chat-user-avatar {
    width: 100% !important; height: 100% !important;
    border: 2px solid #1c1c1e !important; /* 隔离线 */
    margin: 0 !important;
}

/* 浅色模式适配 */
body.light-theme .role-card-img-wrapper .role-card-img,
body.light-theme #chat-header-avatar-wrap .chat-user-avatar {
    border-color: #ffffff !important; /* 白底隔离线 */
}

        /* ================== 修复：限时动态光圈 (移至头像) ================== */

/* 1. 卡片本身去掉发光边框 */
.status-card.unread {
    box-shadow: none !important; /* 去掉大卡片的阴影 */
    border: 1px solid rgba(255,255,255,0.1) !important; /* 恢复普通边框 */
    background: #2c2c2e !important;
}
/* 去掉图片的透明度变化，保持清晰 */
.status-card .status-bg-img { opacity: 0.8; }
.status-card.unread .status-bg-img { opacity: 0.8; }

/* 2. 小头像：未读状态 (彩虹圈) */
.status-mini-avatar.has-story {
    /* 核心：利用 box-shadow 模拟彩虹光圈，不占布局空间 */
    box-shadow: 0 0 0 2px #1c1c1e, 0 0 0 4px #dc2743;
    /* 或者用渐变模拟更像 IG 的效果 */
    padding: 1.5px; /* 留出空隙 */
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    border: none !important; /* 去掉原来的白边 */

    /* 确保背景图也就是头像本身被裁切在内部 */
    background-clip: content-box;
    /* content-box 让背景色(彩虹)显示在 padding 区域，图片显示在 content 区域 */
}

/* 3. 恢复“我的发布按钮”样式 */
.status-card.my-card {
    border: 1px dashed rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.05) !important;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

        /* --- 修复 My Card 激活样式 --- */

/* 1. 发布按钮外部的容器 (用于承载渐变和动画) */
.my-add-btn-wrapper {
    position: relative;
    z-index: 2;
    padding: 2px;
    border-radius: 12px; /* 方圆形 */
    display: inline-block;
    transition: all 0.3s;
}

/* 2. 激活状态：渐变光晕 */
.my-add-btn-wrapper.has-story {
    background: linear-gradient(45deg, #0a84ff, #B620E0); /* 蓝紫渐变 */
    /* 增加一个明显的投影光晕 */
    box-shadow: 0 0 15px rgba(10, 132, 255, 0.8);
}
.my-add-btn-wrapper.has-story .my-add-btn {
    /* 确保加号按钮本身有隔离边框 */
    border: 2px solid #1c1c1e;
}

/* 3. 浅色模式适配 */
body.light-theme .my-add-btn-wrapper.has-story .my-add-btn {
    border-color: #ffffff;
}

        /* 左上角：发布者头像 (修复版：完整显示图片) */
.status-mini-avatar {
    position: absolute;
    top: 6px; left: 6px;

    width: 36px; height: 36px;

    border-radius: 50%;
    border: 2px solid #ffffff;

    /* 🚨 核心修复：从 cover 改为 contain，确保图片完整显示 */
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat; /* 防止图片重复 */

    z-index: 5;
    background-color: #333; /* 占位背景色 */
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}

/* 如果你的 CSS 还有下面的 .status-mini-avatar.has-story，请保持不动 */
/* 保持 .status-mini-avatar.has-story 的样式不变 */

        /* ================== Story Creation UI (Final) ================== */

/* 1. 顶部工具栏 (模式切换) */
.story-mode-toolbar {
    height: 60px;
    display: flex; align-items: center; justify-content: center;
    background: rgba(30, 30, 35, 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    flex-shrink: 0;

    /* 🚨 核心修改：删除 margin-top: 90px; 或确保其不存在 */
    /* margin-top: 0; */
}
/* ... 其他样式保持不变 ... */
.story-mode-toolbar .mode-btn {
    background: none; border: none; color: rgba(255,255,255,0.5);
    font-size: 14px; font-weight: 700; padding: 8px 15px; cursor: pointer;
    border-radius: 15px;
    transition: all 0.2s;
}
.story-mode-toolbar .mode-btn.active {
    color: white;
    background: rgba(255,255,255,0.1);
}

/* 2. 全屏内容区域 */
.story-content-area {
    flex: 1; position: relative;
    overflow: hidden;
}
.story-mode-pane {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: all 0.3s;
}

/* 文本模式核心 */
.story-full-textarea {
    width: 90%; height: 80%;
    background: transparent; border: none; outline: none;
    color: white; font-size: 32px; font-weight: 700;
    text-align: center; line-height: 1.3;
    resize: none;
    font-family: inherit;
    /* 允许换行 */
    white-space: pre-wrap;
}
.story-full-textarea::placeholder { color: rgba(255,255,255,0.7); }
.story-text-tip { position: absolute; bottom: 30px; font-size: 12px; color: rgba(255,255,255,0.5); }

/* 3. 图片模式核心 */
.story-image-preview-box {
    width: 100%; height: 100%;
    background-color: #222;
    background-size: contain; /* 完整显示图片 */
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
}
.story-image-upload-btn {
    position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
    background: #0a84ff; color: white; padding: 8px 15px; border-radius: 20px;
    font-size: 14px; cursor: pointer; z-index: 10;
}
.story-overlay-textarea {
    /* 叠加在图片上方的输入框 */
    width: 90%;
    height: 100px;
    background: transparent; border: none; outline: none;
    color: white; font-size: 24px; font-weight: 600;
    text-align: center; padding: 10px;
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
    resize: none;
    font-family: inherit;
}

/* 4. 文本模式颜色预设 (点击背景切换) */
.color-1 { background: linear-gradient(135deg, #FF9A9E 0%, #FAD0C4 100%); } /* 橙粉 */
.color-2 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); } /* 蓝绿 */
.color-3 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); } /* 紫粉 */
.color-4 { background: linear-gradient(135deg, #f7ff00 0%, #db36a4 100%); } /* 霓虹 */
.color-5 { background: linear-gradient(135deg, #232526 0%, #414345 100%); } /* 暗黑 */

/* 浅色模式适配 */
body.light-theme .story-mode-toolbar { background: rgba(249, 249, 249, 0.95); border-bottom-color: rgba(0,0,0,0.1); }
body.light-theme .story-mode-toolbar .mode-btn { color: rgba(0,0,0,0.5); }
body.light-theme .story-mode-toolbar .mode-btn.active { color: #000; background: rgba(0,0,0,0.1); }

        /* ================== 修复：进度条与图片显示 ================== */

/* 1. 进度条容器：固定在最顶部，极细 */
.viewer-progress-bar-container {
    position: absolute;
    top: 8px; /* 距离顶部一点点距离 */
    left: 5px; right: 5px; /* 左右留出空隙 */
    width: auto; /* 自动宽度 */
    height: 2px; /* 🌟 核心：高度只有 2px */
    z-index: 2000; /* 保证在最上层 */

    display: flex;
    gap: 4px; /* 分段之间的间隙 */
    pointer-events: none;
}

/* 2. 单个分段背景 (未读部分：半透明灰) */
.progress-segment {
    flex: 1; /* 平分宽度 */
    height: 100%;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    overflow: hidden;
}

/* 3. 进度条填充 (已读/正在读部分：纯白) */
.progress-fill-inner {
    height: 100%;
    background: #ffffff;
    width: 0%;
    /* 动画由 JS 控制，CSS不加 transition */
    border-radius: 2px;
    box-shadow: 0 0 2px rgba(0,0,0,0.3); /* 增加一点点阴影让白条更明显 */
}

/* 4. 图片显示模式修复：完整显示 (Contain) */
#viewer-image-img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* 🌟 核心：确保图片完整显示，不裁剪 */
    background: #000; /* 留白部分显示黑色 */
}

/* 5. 调整顶部用户信息的层级，防止被进度条挡住 */
.viewer-controls {
    top: 15px !important; /* 稍微往下挪一点，避开进度条 */
    z-index: 1004;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent) !important; /* 加一点渐变阴影让文字看清 */
    padding-top: 10px;
}

        /* ================== Story Viewer 按钮样式 ================== */

/* 顶部操作按钮容器 */
.viewer-action-buttons {
    display: flex; gap: 8px; /* 按钮之间的间距 */
    align-items: center;
}
.viewer-action-btn {
    background: none; border: none; cursor: pointer;
    padding: 5px; opacity: 0.8;
    transition: opacity 0.2s;
}
.viewer-action-btn:hover { opacity: 1; }
.viewer-action-btn svg { width: 22px; height: 22px; fill: white; }

        /* 修复顶部黑边和底部操作栏 */
.image-viewer-overlay {
    /* 确保预览器能占满全屏 */
    background-color: #000;
}

/* 顶部控制栏 (只负责头像和关闭按钮，完全透明) */
.viewer-controls {
    top: 0 !important; /* 强制贴顶 */
    height: 90px; /* 容纳状态栏 */
    padding-top: 44px; /* 推送内容避开状态栏 */
    background: transparent !important;
    z-index: 1004;
}
.viewer-controls .viewer-close-btn {
    /* 右上角关闭按钮的 z-index 要高于其他内容 */
    z-index: 1005;
}

/* 底部操作栏 */
.story-viewer-footer {
    position: absolute; bottom: 0; left: 0; width: 100%;
    padding: 10px 15px 30px 15px; /* 底部留白给 Home Bar */
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); /* 底部渐变透明背景 */
    display: flex; align-items: center; justify-content: space-between;
    z-index: 1003;
}
.viewer-reply-input {
    flex: 1; height: 38px;
    background: rgba(255,255,255,0.2); border: none; outline: none;
    border-radius: 19px;
    color: white; padding: 0 15px; margin-right: 15px;
}

        /* --- 灰圈样式 (已读但未过期) --- */

/* 1. 针对外层容器 (My Card) 的灰圈 */
.my-add-btn-wrapper.read-story {
    /* 只改变渐变背景为灰色，不影响内部 */
    background: linear-gradient(45deg, #8e8e93, #636366) !important;
    box-shadow: none !important; /* 去掉发光 */
}

/* 2. 针对头像 (Status Avatar) 的灰圈 */
.status-mini-avatar.read-story {
    /* 关键修复：只改 box-shadow (模拟边框)，绝对不要动 background */
    box-shadow: 0 0 0 2px #1c1c1e, 0 0 0 4px #8e8e93 !important;
    padding: 0; /* 灰圈模式下不需要留白，或者保持一致 */
}

/* 3. 针对聊天列表 (Chat List) 的灰圈 */
.role-card-img-wrapper.read-story,
#chat-header-avatar-wrap.read-story {
    background: linear-gradient(45deg, #8e8e93, #636366) !important;
    padding: 2px;
}
        /* ================== Story Viewer 布局强制修复 ================== */

/* 1. 核心内容容器：强制占满全屏 */
.story-viewer-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1; /* 放在最底层，让进度条和按钮浮在上面 */
    overflow: hidden;
}

/* 2. 纯文本模式容器：强制全屏 + 垂直水平居中 */
.viewer-text-box {
    width: 100% !important;
    height: 100% !important;

    /* 弹性布局实现居中 */
    display: flex !important;
    flex-direction: column;
    justify-content: center; /* 垂直居中 */
    align-items: center;     /* 水平居中 */

    padding: 40px;           /* 两侧留白 */
    box-sizing: border-box;  /* 确保 padding 不撑破宽高 */

    /* 文字样式优化 */
    color: white;
    font-size: 28px;       /* 字体调大一点 */
    font-weight: 700;
    text-align: center;
    line-height: 1.5;
    white-space: pre-wrap; /* 允许换行 */
}

/* 3. 图片模式容器 */
.viewer-image-box {
    width: 100% !important;
    height: 100% !important;
    position: relative;
    background: #000;      /* 图片没填满的地方显示黑色 */
    display: flex !important;
    justify-content: center;
    align-items: center;
}

/* 4. 图片显示优化 */
#viewer-image-img {
    width: 100%;
    height: 100%;
    object-fit: contain;   /* 保证图片完整显示，不被裁剪 */
}

/* 5. 图片上的文字叠加层 */
.viewer-image-overlay-text {
    position: absolute;
    /* 默认居中，会被 JS 的具体坐标覆盖 */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);

    color: white;
    font-size: 24px;
    font-weight: 600;
    text-shadow: 0 2px 8px rgba(0,0,0,0.6); /* 加阴影防背景太亮看不清 */
    text-align: center;
    pointer-events: none; /* 防止挡住图片点击 */
    max-width: 90%;
}

        /* ================== Story Viewer 头部修复 ================== */
.viewer-controls {
    position: absolute;
    top: 0; left: 0; width: 100%;
    /* 关键修复：增加顶部内边距，避开手机状态栏/刘海 */
    padding: 55px 15px 15px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 100; /* 保证在最上层 */
    /* 顶部渐变黑遮罩，防止白色文字在亮背景看不清 */
    background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 100%);
}

.viewer-user-info {
    display: flex;
    align-items: center;
    gap: 10px; /* 头像和文字的间距 */
}

.viewer-avatar-mini {
    width: 36px; height: 36px;
    border-radius: 50%;
    background-color: #333;
    border: 1px solid rgba(255,255,255,0.5);
    background-size: cover;
    background-position: center;
}

.viewer-text-col {
    display: flex;
    flex-direction: column;
}

.viewer-username {
    font-size: 14px; font-weight: 600; color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    line-height: 1.2;
}

.viewer-time {
    font-size: 11px; color: rgba(255,255,255,0.8);
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

.viewer-close-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.3); /* 半透明黑底 */
    backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    color: white; border: none; cursor: pointer;
}

/* ================== Story Viewer 底部修复 ================== */
.story-viewer-footer {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    /* 增加底部内边距，避开手机小白条 */
    padding: 10px 15px 35px 15px;
    /* 底部渐变黑遮罩 */
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
    display: flex;
    align-items: center;
    gap: 12px; /* 元素间距 */
    z-index: 100;
}

/* 输入框容器 */
.viewer-input-box {
    flex: 1; /* 占据剩余空间 */
    height: 44px;
    background: rgba(255, 255, 255, 0.15); /* 磨砂半透明 */
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 22px;
    display: flex;
    align-items: center;
    padding: 0 5px 0 15px; /* 右边留少点给发送按钮 */
}

.viewer-reply-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: white;
    font-size: 14px;
}
.viewer-reply-input::placeholder { color: rgba(255,255,255,0.6); }

/* 发送按钮 (圆形) */
.viewer-send-btn {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: none;
    display: flex; align-items: center; justify-content: center;
    color: white;
    cursor: pointer;
}
.viewer-send-btn:active { background: #0a84ff; }

/* 底部图标按钮组 */
.viewer-icon-group {
    display: flex;
    gap: 15px; /* 图标之间的间距 */
    align-items: center;
}

.viewer-action-btn {
    background: none; border: none; padding: 0;
    cursor: pointer; opacity: 0.9;
}
.viewer-action-btn:active { transform: scale(0.9); opacity: 1; }
.viewer-action-btn svg {
    width: 28px; height: 28px; fill: white;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); /* 加阴影让图标更清晰 */
}

        /* ================== 修复：时长选择对勾 ================== */
/* 默认隐藏所有对勾 */
#story-duration-options .check-icon {
    display: none !important;
}
/* 只有被选中的项才显示对勾 */
#story-duration-options .ai-list-item.selected .check-icon {
    display: block !important;
    color: #0a84ff;
    font-weight: bold;
}

        /* ================== Story Viewer 显示冲突修复 ================== */

/* 1. 默认隐藏两个容器 */
.viewer-text-box,
.viewer-image-box {
    display: none !important; /* 默认都不显示 */
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
}

/* 2. 激活状态：文本模式 */
.viewer-text-box.active-mode {
    display: flex !important; /* 只有加了 active-mode 才显示 */
    z-index: 10;
    /* 保持之前的全屏居中样式 */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
    box-sizing: border-box;
    color: white;
    font-size: 28px;
    font-weight: 700;
    text-align: center;
    white-space: pre-wrap;
}

/* 3. 激活状态：图片模式 */
.viewer-image-box.active-mode {
    display: flex !important; /* 只有加了 active-mode 才显示 */
    z-index: 10;
    background: #000;
    justify-content: center;
    align-items: center;
}

        /* --- 1. 顶部更多按钮 (三个点) --- */
.viewer-menu-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    color: white; border: none; cursor: pointer;
    margin-right: 10px; /* 和关闭按钮的间距 */
}
.viewer-menu-btn svg { width: 24px; height: 24px; fill: white; }

/* --- 2. 爱心点赞特效 (红色发光 + 跳动) --- */
.viewer-action-btn.active-like svg {
    fill: #FF3B30 !important; /* 变红 */
    /* 红色外发光 */
    filter: drop-shadow(0 0 8px rgba(255, 59, 48, 0.8));
    /* Q弹动画 */
    animation: heart-bounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes heart-bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

/* --- 3. 评论/弹幕滚动区 --- */
.viewer-comments-layer {
    position: absolute;
    bottom: 80px; /* 在输入栏上方 */
    left: 15px;
    width: 70%; /* 宽度限制，不遮挡右边按钮 */
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* 从底部堆叠 */
    gap: 8px;
    z-index: 90;
    pointer-events: none; /* 让点击穿透，不影响看图 */
    /* 隐藏滚动条 */
    scrollbar-width: none;
}
.viewer-comment-pill {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    padding: 6px 12px;
    border-radius: 16px;
    color: white;
    font-size: 13px;
    align-self: flex-start; /* 左对齐 */
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    animation: slide-up 0.3s ease-out;
}
@keyframes slide-up {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- 4. 分享弹窗列表样式 --- */
.share-friend-item {
    display: flex; align-items: center;
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
}
.share-friend-item:active { background: rgba(255,255,255,0.1); }
.share-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    background-color: #333; background-size: cover; margin-right: 12px;
}
.share-name { font-size: 15px; color: white; flex: 1; }
/* 选中状态 */
.share-friend-item.selected .share-name { color: #0a84ff; font-weight: 600; }
.share-friend-item.selected::after { content: '✔'; color: #0a84ff; }

        /* ================== 快拍分享卡片样式 ================== */
.msg-story-card {
    width: 160px;
    height: 240px; /* 9:16 比例 */
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    background-color: #2c2c2e;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

/* 卡片主体内容 (图片或文字背景) */
.story-card-body {
    flex: 1;
    width: 100%;
    background-size: cover;
    background-position: center;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    box-sizing: border-box;
}

/* 文本模式下的文字 */
.story-card-text {
    font-size: 16px;
    font-weight: 600;
    color: white;
    text-align: center;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;
}

/* 底部标签栏 */
.story-card-footer {
    height: 36px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    padding: 0 10px;
    gap: 6px;
}

/* 底部小图标 */
.story-card-icon {
    width: 16px; height: 16px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.5);
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}

.story-card-label {
    font-size: 11px;
    color: rgba(255,255,255,0.8);
    font-weight: 500;
    display: flex;
    flex-direction: column;
    justify-content: center;
    line-height: 1.2;
}
.story-card-label span { opacity: 0.6; font-size: 9px; }

/* 浅色模式适配 */
body.light-theme .msg-story-card {
    background-color: #fff;
    border-color: rgba(0,0,0,0.1);
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}
body.light-theme .story-card-footer {
    background: rgba(255,255,255,0.9);
    border-top-color: rgba(0,0,0,0.05);
}
body.light-theme .story-card-label { color: #333; }

        /* ================== 修复：快拍头部按钮重叠问题 ================== */

/* 1. 强制重置快拍页面关闭按钮的定位 */
/* 因为全屏图片预览器里把 .viewer-close-btn 设为了 absolute，这里要改回 static */
.viewer-controls .viewer-close-btn {
    position: static !important; /* 关键：取消绝对定位，让它回到 Flex 排列中 */
    margin-left: 10px;           /* 给它和左边的菜单按钮留点距离 */
    transform: none !important;  /* 移除可能的位移 */
    top: auto !important;
    right: auto !important;
    z-index: 10;
    background: rgba(0, 0, 0, 0.3); /* 确保背景色一致 */
}

/* 2. 确保右侧按钮组排列正确 */
.viewer-controls > div:last-child {
    display: flex;
    align-items: center;
    gap: 5px; /* 按钮之间的间隙 */
}

        /* ================== 动态通知 & 浏览者样式 ================== */

/* ================== 动态页头部 & 按钮样式优化 ================== */

/* 头部容器 (Flex 布局，两端对齐) */
.moments-header-bar {
    padding: 50px 16px 10px 16px; /* 避开刘海屏的高度 */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* 左侧标题 */
.moments-header-title {
    font-size: 24px;
    font-weight: 800;
    color: white;
    letter-spacing: 0.5px;
}

/* 右侧按钮组容器 (关键：让按钮横向排列并有间距) */
.moments-header-actions {
    display: flex;
    align-items: center;
    gap: 12px; /* 铃铛和加号之间的间距 */
}

/* 通用圆形按钮样式 (铃铛和加号共用) */
.feed-header-btn {
    width: 38px; height: 38px; /* 稍微加大一点点，更有质感 */
    border-radius: 50%;
    background: rgba(255,255,255,0.1); /* 半透明玻璃底 */
    backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    position: relative;
    color: white;
    transition: background 0.2s;
    border: 1px solid rgba(255,255,255,0.05);
}
.feed-header-btn:active {
    background: rgba(255,255,255,0.2);
    transform: scale(0.96);
}

/* 图标通用设置 */
.feed-header-btn svg {
    width: 22px; height: 22px;
    fill: currentColor; /* 跟随文字颜色 */
}
/* 加号特殊设置 (如果是文字加号，调整大小) */
.feed-header-btn.add-text-btn {
    font-size: 28px;
    font-weight: 300;
    line-height: 1;
    padding-bottom: 2px; /* 微调垂直居中 */
}

/* 红点提醒 (位置微调更精致) */
.feed-header-btn.has-new::after {
    content: '';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 8px; height: 8px;
    background: #FF3B30; /* 官方红 */
    border-radius: 50%;
    border: 2px solid #1c1c1e; /* 加个描边让红点更突出 */
}

/* 2. 浏览量 (眼睛) 图标样式 */
.action-pill.view-count {
    background: transparent; border: none; padding-left: 0;
    margin-right: auto; /* 靠左排列 */
    opacity: 0.6; font-size: 12px; gap: 4px;
}
.action-pill.view-count svg { width: 16px; height: 16px; }

/* 3. 通用列表项 (用于浏览者列表 & 通知列表) */
.user-list-item {
    display: flex; align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    background: rgba(255,255,255,0.02);
}
.user-list-item:last-child { border-bottom: none; }

.user-list-avatar {
    width: 44px; height: 44px; border-radius: 50%;
    background-size: cover; background-position: center;
    background-color: #333; margin-right: 12px;
    flex-shrink: 0;
}

.user-list-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
.user-list-name { font-size: 15px; font-weight: 600; color: white; margin-bottom: 2px; }
.user-list-desc { font-size: 13px; color: rgba(255,255,255,0.5); }

/* 右侧的附带信息 (如：时间或帖子缩略图) */
.user-list-extra {
    font-size: 12px; color: rgba(255,255,255,0.3);
    display: flex; align-items: center;
}
.notification-thumb {
    width: 40px; height: 40px; border-radius: 6px;
    background-size: cover; background-position: center;
    margin-left: 10px; background-color: #333;
}

/* 浅色模式适配 */
body.light-theme .feed-header-btn { background: rgba(0,0,0,0.05); }
body.light-theme .feed-header-btn svg { fill: black; }
body.light-theme .action-pill.view-count { color: rgba(0,0,0,0.5); }
body.light-theme .user-list-item { background: white; border-bottom-color: rgba(0,0,0,0.05); }
body.light-theme .user-list-name { color: black; }
body.light-theme .user-list-desc { color: rgba(0,0,0,0.5); }

        /* ================== 修复：头部右侧按钮组 ================== */

/* 1. 右侧容器：绝对定位在右上角 */
.header-right-group {
    position: absolute;
    right: 15px;
    bottom: 12px; /* 距离底部留点空隙 (Header高度固定) */
    display: flex;
    align-items: center;
    gap: 15px; /* 铃铛和加号的间距 */
    z-index: 60;
}

/* 2. 铃铛图标按钮样式 */
.header-icon-btn {
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    background: rgba(255,255,255,0.1); /* 淡淡的背景 */
    border-radius: 50%;
    position: relative; /* 为了放红点 */
}
.header-icon-btn svg {
    width: 20px; height: 20px; fill: white;
}

/* 红点样式 (有新消息时显示) */
.header-icon-btn.has-new::after {
    content: ''; position: absolute; top: 6px; right: 6px;
    width: 8px; height: 8px; background: #FF3B30;
    border-radius: 50%; border: 1px solid #1c1c1e;
}

/* 3. 加号文字按钮样式 (保持原有风格) */
.header-text-btn {
    font-size: 28px; color: white; cursor: pointer; font-weight: 300;
    line-height: 1;
    display: flex; align-items: center; justify-content: center;
}

/* 浅色模式适配 */
body.light-theme .header-icon-btn { background: rgba(0,0,0,0.05); }
body.light-theme .header-icon-btn svg { fill: #007aff; } /* 蓝色图标 */
body.light-theme .header-text-btn { color: #007aff; }

        /* ================== 个性化中心 (Beautify Center) ================== */

/* 1. 选项卡切换栏 */
.beautify-tabs {
    display: flex; gap: 10px; padding: 10px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    background: rgba(0,0,0,0.2);
}
.beautify-tab {
    padding: 8px 12px; font-size: 13px; color: rgba(255,255,255,0.6);
    border-radius: 8px; cursor: pointer; transition: all 0.2s;
    border: 1px solid transparent;
}
.beautify-tab.active {
    background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.1); font-weight: 600;
}

/* 2. 背景上传卡片 */
.bg-upload-card {
    height: 120px; border-radius: 12px;
    background-size: cover; background-position: center;
    position: relative; overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; margin-bottom: 10px;
}
.bg-upload-overlay {
    background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
    padding: 8px 15px; border-radius: 20px;
    display: flex; align-items: center; gap: 6px;
    transition: background 0.2s;
}
.bg-upload-card:hover .bg-upload-overlay { background: rgba(0,0,0,0.6); }

/* 3. 实时预览容器 (Phone Mockup) */
.preview-stage-wrapper {
    width: 100%; height: 350px; /* 预览高度 */
    background: #000;
    border: 8px solid #333; /* 模拟手机边框 */
    border-radius: 20px;
    margin-bottom: 15px;
    position: relative; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* 预览舞台内部 (模拟 App 视窗) */
#preview-stage {
    width: 100%; height: 100%;
    overflow-y: auto; overflow-x: hidden;
    position: relative;
    background-color: #1c1c1e; /* 默认底色 */
    background-size: cover; background-position: center;
}

/* 4. 代码编辑器 */
.code-editor-box {
    background: #1e1e1e; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; flex-direction: column;
    height: 250px;
}
.editor-header {
    padding: 8px 12px; background: rgba(255,255,255,0.05);
    font-size: 12px; color: #888; display: flex; justify-content: space-between;
}
.real-code-input {
    flex: 1; width: 100%; background: transparent; border: none; outline: none;
    color: #d4d4d4; font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    font-size: 13px; line-height: 1.5; padding: 10px; resize: none;
}

/* 浅色模式适配 */
body.light-theme .code-editor-box { background: #fff; border-color: rgba(0,0,0,0.1); }
body.light-theme .real-code-input { color: #333; background: #f5f5f5; }
body.light-theme .preview-stage-wrapper { border-color: #e5e5e5; }

        /* ================== 🚨 浅色模式背景完美修复补丁 🚨 ================== */

/* 1. 默认状态：没有背景图时，显示浅灰底 */
body.light-theme #app-chat,
body.light-theme #sub-chat-detail {
    background-color: #f2f2f7 !important;
    transition: background-color 0.3s;
}

/* 2. 激活状态：当 JS 设置了背景图 (添加了 .has-custom-bg 类) */
body.light-theme #app-chat.has-custom-bg,
body.light-theme #sub-chat-detail.has-custom-bg {
    /* 核心：强制背景色透明，让 JS 的 background-image (inline style) 露出来 */
    background-color: transparent !important;

    /* 注意：这里不需要再写 background-image，因为 JS 已经强制写在标签上了 */
}

/* 3. 头部导航栏适配：有背景图时，头部必须半透明，否则会挡住顶部 */
body.light-theme #app-chat.has-custom-bg .app-header,
body.light-theme #sub-chat-detail.has-custom-bg .app-header {
    background: rgba(255, 255, 255, 0.6) !important;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* 4. 确保中间内容容器是透明的 */
#chat-module-msg,
#chat-module-moments,
#chat-module-me,
.chat-module-container {
    background: transparent !important;
    box-shadow: none !important;
}

        /* ================== 消息收藏卡片样式 ================== */
.fav-msg-card {
    background: rgba(255,255,255,0.05);
    padding: 16px;
    margin: 0 16px 12px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.fav-msg-card:active { background: rgba(255,255,255,0.1); }

/* 头部信息 (谁发的，在哪发的) */
.fav-msg-header {
    display: flex; align-items: center; justify-content: space-between;
    font-size: 12px; color: rgba(255,255,255,0.4);
}
.fav-msg-source {
    display: flex; align-items: center; gap: 6px;
    color: #0a84ff; font-weight: 500;
}
.fav-msg-avatar {
    width: 20px; height: 20px; border-radius: 50%;
    background-color: #333; background-size: cover;
}

/* 消息内容 (限制高度，多行省略) */
.fav-msg-body {
    font-size: 15px; color: rgba(255,255,255,0.9);
    line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 底部时间与操作 */
.fav-msg-footer {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 4px;
}
.fav-msg-time { font-size: 11px; color: rgba(255,255,255,0.3); }
.fav-btn-del {
    color: #FF3B30; font-size: 12px; padding: 4px 8px;
    border-radius: 6px; background: rgba(255,59,48,0.1);
}

/* 浅色模式适配 */
body.light-theme .fav-msg-card {
    background: #ffffff; border-color: rgba(0,0,0,0.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}
body.light-theme .fav-msg-body { color: #333; }
body.light-theme .fav-msg-header { color: rgba(0,0,0,0.4); }

        /* ================== 修复：详情页层级 (必须比收藏页 750 高) ================== */

/* 1. 帖子详情页 */
#sub-moment-detail {
    z-index: 800 !important; /* 提权：盖住收藏页 */
}

/* 2. 聊天详情页 */
#sub-chat-detail {
    z-index: 800 !important; /* 提权：盖住收藏页 */
}

/* 3. 确保图片预览器更高 */
#image-viewer {
    z-index: 900 !important;
}

        /* ================== 日记 App 样式 ================== */

/* 1. 时光轴容器 */
.diary-timeline-container {
    position: relative;
    padding-left: 20px; /* 左侧留出线的空间 */
    padding-top: 10px;
}

/* 贯穿线 */
.diary-timeline-container::before {
    content: ''; position: absolute;
    top: 0; bottom: 0; left: 6px; /* 线的位置 */
    width: 2px; background: rgba(255,255,255,0.1);
    border-radius: 2px;
}

/* 2. 单个日记卡片 */
.diary-card {
    position: relative;
    margin-bottom: 25px;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 15px;
    margin-left: 15px; /* 避开左边的线 */
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}
.diary-card:active { transform: scale(0.98); }

/* 时间轴上的圆点 */
.diary-dot {
    position: absolute;
    left: -21px; top: 20px;
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #0a84ff; /* 默认蓝色 */
    border: 2px solid #1c1c1e; /* 隔离圈 */
    box-shadow: 0 0 8px rgba(10,132,255,0.5);
}

/* 3. 卡片内部布局 */
.diary-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 8px;
}
.diary-date { font-size: 16px; font-weight: 700; color: white; }
.diary-time { font-size: 12px; color: rgba(255,255,255,0.5); }
.diary-mood { font-size: 18px; }

.diary-body {
    font-size: 15px; color: rgba(255,255,255,0.85);
    line-height: 1.6; white-space: pre-wrap;
}

/* 4. 心情选择器 */
.mood-selector {
    display: flex; justify-content: space-between;
    background: rgba(255,255,255,0.05);
    border-radius: 12px; padding: 10px; margin-bottom: 15px;
}
.mood-item {
    font-size: 24px; padding: 5px; cursor: pointer;
    border-radius: 50%; transition: transform 0.2s, background 0.2s;
    opacity: 0.5;
}
.mood-item.active { opacity: 1; transform: scale(1.2); background: rgba(255,255,255,0.1); }

/* 5. 不同的心情颜色 (点和背景微调) */
.diary-card.mood-happy .diary-dot { background: #FFD60A; box-shadow: 0 0 8px rgba(255,214,10,0.5); }
.diary-card.mood-sad .diary-dot { background: #0a84ff; }
.diary-card.mood-angry .diary-dot { background: #FF3B30; box-shadow: 0 0 8px rgba(255,59,48,0.5); }
.diary-card.mood-love .diary-dot { background: #FF2E93; box-shadow: 0 0 8px rgba(255,46,147,0.5); }

/* 浅色适配 */
body.light-theme .diary-timeline-container::before { background: rgba(0,0,0,0.1); }
body.light-theme .diary-card { background: white; border-color: rgba(0,0,0,0.05); }
body.light-theme .diary-date { color: black; }
body.light-theme .diary-body { color: #333; }
body.light-theme .diary-dot { border-color: #f2f2f7; }

        /* ================== 日记交互升级样式 ================== */

/* 1. 写日记弹窗：好友选择器 (横向滚动) */
.diary-share-list {
    display: flex; gap: 12px;
    overflow-x: auto; padding: 5px 2px;
    margin-bottom: 15px;
    scrollbar-width: none;
}
.diary-share-item {
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer; opacity: 0.5; transition: all 0.2s;
}
.diary-share-item.selected { opacity: 1; transform: scale(1.05); }

.diary-share-avatar {
    width: 44px; height: 44px; border-radius: 50%;
    background-size: cover; background-position: center;
    border: 2px solid transparent;
    margin-bottom: 4px;
}
.diary-share-item.selected .diary-share-avatar {
    border-color: #0a84ff; box-shadow: 0 0 10px rgba(10,132,255,0.3);
}
.diary-share-name { font-size: 10px; color: white; max-width: 50px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* 2. 日记卡片：互动留言区 */
.diary-comments-box {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.1);
    display: flex; flex-direction: column; gap: 8px;
}

.diary-comment-row {
    display: flex; gap: 8px; align-items: flex-start;
    font-size: 13px; animation: slide-in 0.3s ease;
}
.d-cmt-avatar {
    width: 24px; height: 24px; border-radius: 50%;
    background-size: cover; background-position: center;
    background-color: #333; flex-shrink: 0;
}
.d-cmt-content {
    background: rgba(255,255,255,0.1);
    padding: 6px 10px; border-radius: 4px 12px 12px 12px;
    color: rgba(255,255,255,0.9); line-height: 1.4;
}
.d-cmt-name {
    font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 2px;
}

@keyframes slide-in { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

/* 浅色适配 */
body.light-theme .d-cmt-content { background: rgba(0,0,0,0.05); color: #333; }
body.light-theme .d-cmt-name { color: rgba(0,0,0,0.5); }

        /* ================== 🚨 层级与状态栏终极修复 🚨 ================== */

/* 1. 状态栏必须在所有页面之上 (除了弹窗) */
.status-bar {
    z-index: 2000 !important; /* 提到最高 */
}

/* 2. 聊天设置页 (必须比聊天详情页 800 高) */
#sub-chat-settings {
    z-index: 850 !important;
}

/* 3. 角色日记删除按钮样式 */
.char-diary-del {
    position: absolute;
    top: 10px; right: 10px;
    font-size: 12px; color: rgba(255, 59, 48, 0.6);
    cursor: pointer;
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}
.char-diary-del:hover {
    color: #FF3B30;
    background: rgba(255, 59, 48, 0.1);
}

        /* ================== 钱包 App (Cyber Finance Design) ================== */

/* 1. 核心资产卡片 (全息黑金风格) */
.wallet-card-premium {
    width: 100%;
    height: 200px;
    border-radius: 24px;
    position: relative;
    margin-bottom: 25px;
    overflow: hidden;

    /* 高级渐变底色 (深邃蓝紫 -> 赛博黑) */
    background: linear-gradient(135deg, #2b2e4a 0%, #1a1a1a 100%);

    /* 玻璃质感边框 */
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);

    display: flex; flex-direction: column; justify-content: space-between;
    padding: 25px;
    transition: transform 0.2s;
}
.wallet-card-premium:active { transform: scale(0.98); }

/* 卡片背景的光晕装饰 (不用图片，纯CSS画) */
.wallet-card-premium::before {
    content: ''; position: absolute; top: -50%; right: -50%;
    width: 300px; height: 300px;
    background: radial-gradient(circle, rgba(10, 132, 255, 0.4) 0%, transparent 70%);
    filter: blur(40px); z-index: 0;
}
.wallet-card-premium::after {
    content: ''; position: absolute; bottom: -30%; left: -20%;
    width: 250px; height: 250px;
    background: radial-gradient(circle, rgba(182, 32, 224, 0.3) 0%, transparent 70%);
    filter: blur(40px); z-index: 0;
}

/* 卡片内容层 (浮在光晕上) */
.card-layer { position: relative; z-index: 2; width: 100%; }

/* 芯片装饰 (纯CSS画个芯片，增加真实感) */
.card-chip {
    width: 45px; height: 32px;
    background: linear-gradient(135deg, #e6cfa3 0%, #d1b464 100%);
    border-radius: 6px;
    margin-bottom: 20px;
    position: relative;
    box-shadow: inset 0 1px 4px rgba(0,0,0,0.2);
}
/* 芯片纹路 */
.card-chip::before {
    content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px;
    background: rgba(0,0,0,0.2);
}
.card-chip::after {
    content: ''; position: absolute; left: 50%; top: 0; height: 100%; width: 1px;
    background: rgba(0,0,0,0.2);
}

/* 余额大数字 */
.card-balance-label { font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
.card-balance-value {
    font-size: 36px; font-weight: 700; color: white;
    font-family: 'Courier New', monospace; /* 就像真的信用卡字体 */
    letter-spacing: -1px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

/* 卡号装饰 */
.card-number-mask {
    font-family: monospace; font-size: 14px; color: rgba(255,255,255,0.4);
    letter-spacing: 2px; margin-top: auto;
}

/* 2. 快捷操作栏 (悬浮玻璃条) */
.wallet-quick-actions {
    display: flex; justify-content: space-around;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 15px 10px;
    margin-bottom: 25px;
    border: 1px solid rgba(255,255,255,0.1);
}

.w-action-item {
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    cursor: pointer; opacity: 0.9; transition: all 0.2s;
}
.w-action-item:active { opacity: 0.6; transform: scale(0.95); }

.w-icon-circle {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    border: 1px solid rgba(255,255,255,0.1);
}
.w-action-text { font-size: 12px; color: white; font-weight: 500; }

/* 特殊颜色 */
.w-icon-circle.add { background: #0a84ff; color: white; box-shadow: 0 4px 12px rgba(10,132,255,0.3); }
.w-icon-circle svg { width: 22px; height: 22px; fill: white; }

/* 3. 交易记录列表 */
.trans-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 40px; }

.trans-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.trans-left { display: flex; align-items: center; gap: 12px; }
.trans-icon-box {
    width: 40px; height: 40px; border-radius: 10px;
    background: rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
}
.trans-title { font-size: 15px; color: white; font-weight: 500; margin-bottom: 3px; }
.trans-date { font-size: 11px; color: rgba(255,255,255,0.4); }
.trans-amount { font-size: 16px; font-weight: 600; }
.trans-amount.plus { color: #34C759; } /* 绿色 */
.trans-amount.minus { color: #FF3B30; } /* 红色 */

/* 4. 充值页面专用样式 */
.recharge-input-wrapper {
    background: rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 30px 20px;
    text-align: center;
    margin-top: 30px;
    border: 1px solid rgba(255,255,255,0.1);
}
.money-symbol { font-size: 30px; font-weight: 300; opacity: 0.5; vertical-align: middle; }
#recharge-input-real {
    background: transparent; border: none; outline: none;
    font-size: 40px; color: white; font-weight: 700; width: 150px;
    text-align: center; vertical-align: middle;
    font-family: 'Courier New', monospace;
}
#recharge-input-real::placeholder { opacity: 0.3; }

/* 浅色模式适配 */
body.light-theme .wallet-card-premium {
    /* 浅色下用亮黑卡，或者银色卡 */
    background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border-color: rgba(0,0,0,0.05);
}
body.light-theme .wallet-card-premium::before,
body.light-theme .wallet-card-premium::after { opacity: 0.3; }
body.light-theme .card-balance-value,
body.light-theme .card-number-mask,
body.light-theme .card-balance-label { color: #333; text-shadow: none; }

body.light-theme .wallet-quick-actions { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.05); }
body.light-theme .w-icon-circle { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.05); }
body.light-theme .w-icon-circle svg { fill: #333; }
body.light-theme .w-icon-circle.add { background: #007aff; }
body.light-theme .w-icon-circle.add svg { fill: white; }
body.light-theme .w-action-text { color: #333; }

body.light-theme .trans-item { background: white; border-color: rgba(0,0,0,0.05); }
body.light-theme .trans-icon-box { background: #f2f2f7; }
body.light-theme .trans-icon-box svg { fill: #333; }
body.light-theme .trans-title { color: #000; }

        /* ================== 购物 App 样式 ================== */

/* 1. 分类 Tab */
.shop-tab-scroll {
    display: flex; gap: 10px;
}
.shop-tab {
    padding: 6px 16px;
    border-radius: 18px;
    background: rgba(255,255,255,0.1);
    font-size: 13px; color: rgba(255,255,255,0.7);
    cursor: pointer; transition: all 0.2s;
    border: 1px solid rgba(255,255,255,0.05);
}
.shop-tab.active {
    background: #ffffff; color: #000; font-weight: 600;
}

/* 2. 商品网格 (双列) */
.shop-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 两列等宽 */
    gap: 15px;
    padding: 10px 16px;
}

/* 3. 商品卡片 */
.shop-item-card {
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; flex-direction: column;
    cursor: pointer; transition: transform 0.2s;
}
.shop-item-card:active { transform: scale(0.96); }

/* 图片区 */
.shop-img-box {
    width: 100%; aspect-ratio: 1/1; /* 正方形 */
    background-color: #333;
    background-size: cover; background-position: center;
    position: relative;
}

/* 信息区 */
.shop-info-box {
    padding: 10px;
    display: flex; flex-direction: column; gap: 4px;
}
.shop-title { font-size: 14px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.shop-desc { font-size: 11px; color: rgba(255,255,255,0.5); }

/* 价格行 */
.shop-price-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 6px;
}
.shop-price { font-size: 15px; color: #FF3B30; font-weight: 700; }
.shop-buy-btn {
    width: 24px; height: 24px; border-radius: 50%;
    background: rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 14px;
}

/* 浅色模式适配 */
body.light-theme .shop-tab { background: rgba(0,0,0,0.05); color: #666; }
body.light-theme .shop-tab.active { background: #000; color: #fff; }
body.light-theme .shop-item-card { background: white; border-color: rgba(0,0,0,0.05); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
body.light-theme .shop-title { color: black; }
body.light-theme .shop-buy-btn { background: #f2f2f7; color: #000; }

        /* ================== 备忘录 App 样式 ================== */

/* 1. 笔记列表容器 */
.memo-list {
    padding: 10px 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* 2. 笔记卡片 */
.memo-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    flex-direction: column;
}
.memo-card:active { background: rgba(255, 255, 255, 0.15); }

/* 卡片内容 */
.memo-card-title {
    font-size: 16px; font-weight: 700; color: white;
    margin-bottom: 6px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.memo-card-preview {
    font-size: 13px; color: rgba(255, 255, 255, 0.6);
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.5;
}
.memo-card-date {
    font-size: 11px; color: rgba(255, 255, 255, 0.3);
    margin-top: 10px;
}

/* 3. 编辑器样式 */
.memo-editor {
    width: 100%; height: 100%;
    background: transparent; border: none; outline: none;
    color: white; font-size: 17px; line-height: 1.6;
    resize: none; font-family: inherit;
    padding-bottom: 300px; /* 底部留白方便打字 */
}
.memo-editor::placeholder { color: rgba(255,255,255,0.3); }

/* 浅色模式适配 */
body.light-theme .memo-card {
    background: #ffffff;
    border-color: rgba(0,0,0,0.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}
body.light-theme .memo-card-title { color: #000; }
body.light-theme .memo-card-preview { color: #666; }
body.light-theme .memo-card-date { color: #999; }
body.light-theme .memo-editor { color: #000; }
body.light-theme .memo-editor::placeholder { color: rgba(0,0,0,0.3); }

        /* ================== 电话 App 样式 (Cyber Style) ================== */

/* 1. 视图容器 */
.phone-view {
    flex: 1; height: 100%; width: 100%;
    overflow: hidden;
    padding-bottom: 80px; /* 留出底部导航空间 */
}

/* 2. 拨号盘区域 */
.phone-display-area {
    width: 100%; padding: 20px 40px;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 20px;
    position: relative;
}
#phone-number-display {
    background: transparent; border: none; outline: none;
    font-size: 36px; color: white; font-weight: 600;
    text-align: center; width: 100%;
    letter-spacing: 2px;
}
.phone-backspace {
    position: absolute; right: 40px; top: 50%; transform: translateY(-50%);
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; opacity: 0; transition: opacity 0.2s;
}
.phone-backspace.show { opacity: 1; }
.phone-backspace svg { width: 24px; height: 24px; fill: rgba(255,255,255,0.6); }

/* 3. 键盘网格 */
.phone-keypad-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px 30px; /* 垂直间距, 水平间距 */
    margin-bottom: 30px;
}

.phone-key {
    width: 75px; height: 75px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 32px; font-weight: 400; color: white;
    cursor: pointer; transition: background 0.1s, transform 0.1s;
    user-select: none;
    border: 1px solid rgba(255,255,255,0.05);
}
.phone-key:active { background: rgba(255, 255, 255, 0.3); transform: scale(0.95); }
.phone-key .sub {
    font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.5);
    margin-top: -2px; letter-spacing: 1px;
}

/* 4. 呼叫按钮 */
.phone-call-btn {
    width: 75px; height: 75px;
    border-radius: 50%;
    background: #34C759; /* 电话绿 */
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 5px 20px rgba(52, 199, 89, 0.4);
    cursor: pointer; transition: transform 0.1s;
}
.phone-call-btn:active { transform: scale(0.9); filter: brightness(0.9); }
.phone-call-btn svg { width: 36px; height: 36px; fill: white; }

/* 5. 通话记录列表 */
.recent-call-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
}
.recent-call-item:active { background: rgba(255,255,255,0.05); }
.call-info-left { display: flex; align-items: center; gap: 12px; }
.call-type-icon { width: 16px; height: 16px; fill: rgba(255,255,255,0.4); }
.call-type-icon.missed { fill: #FF3B30; } /* 未接红色 */
.call-name { font-size: 16px; font-weight: 600; color: white; }
.call-name.missed { color: #FF3B30; }
.call-label { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 2px; }
.call-time { font-size: 14px; color: rgba(255,255,255,0.4); }
.call-info-btn {
    width: 24px; height: 24px; border-radius: 50%; border: 1px solid #0a84ff;
    color: #0a84ff; display: flex; align-items: center; justify-content: center; font-size: 12px;
}

/* 6. 短信列表 (加密简讯风) */
.sms-item {
    background: rgba(255,255,255,0.05);
    border-left: 3px solid #0a84ff; /* 蓝色条标记 */
    padding: 15px; margin-bottom: 10px;
    border-radius: 4px 12px 12px 4px;
    cursor: pointer;
}
.sms-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
.sms-sender { font-size: 15px; font-weight: 700; color: white; }
.sms-time { font-size: 11px; color: rgba(255,255,255,0.4); }
.sms-preview { font-size: 13px; color: rgba(255,255,255,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* 浅色模式适配 */
body.light-theme .phone-key { background: rgba(0,0,0,0.05); color: black; border-color: rgba(0,0,0,0.05); }
body.light-theme .phone-key:active { background: rgba(0,0,0,0.1); }
body.light-theme .phone-key .sub { color: rgba(0,0,0,0.4); }
body.light-theme #phone-number-display { color: black; }
body.light-theme .phone-backspace svg { fill: rgba(0,0,0,0.4); }
body.light-theme .recent-call-item { border-bottom-color: rgba(0,0,0,0.05); }
body.light-theme .call-name { color: black; }
body.light-theme .call-name.missed { color: #FF3B30; }
body.light-theme .sms-item { background: white; border-color: rgba(0,0,0,0.05); border-left-color: #0a84ff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
body.light-theme .sms-sender { color: black; }
body.light-theme .sms-preview { color: #666; }

/* --- 聊天图片美化 --- */

/* 图片本身的样式 */
.chat-content-image {
    max-width: 100%; /* 让图片宽度撑满气泡 */
    height: auto;    /* 高度自动，保持比例 */
    border-radius: 16px; /* 更大的圆角，看起来更柔和 */
    display: block;  /* 消除图片底部的微小空隙 */
    
    /* 可选：给图片加一点点阴影，增加立体感 */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* 重要：当气泡里包含图片时，我们需要调整气泡文本容器的样式。
   我们可以通过 :has() 选择器来实现（现代浏览器支持）。
   如果你的环境不支持 :has()，可能需要用 JS 给父级加类名，
   但鉴于这是手机端项目，现代浏览器通常都支持。
*/

/* 当 .chat-bubble-text 内部直接包含 .chat-content-image 时 */
.chat-bubble-text:has(> .chat-content-image) {
    padding: 0 !important;       /* 移除内边距，让图片贴边 */
    background: transparent !important; /* 移除背景色，只显示图片 */
    box-shadow: none !important; /* 移除气泡本身的阴影 */
    border: none !important;     /* 移除可能的边框 */
}

/* 备用方案：如果上面的 :has() 不起作用，
   你可以尝试这种较老的方法，但效果可能略差，
   因为它不能完美去除父级的背景和内边距。
*/
/*
.chat-content-image {
    max-width: 220px; 
    border-radius: 16px;
    margin: -8px;  /* 尝试抵消气泡的 padding 
}
*/

/* ================== 语音条样式 ================== */

/* 语音条容器 */
.voice-bubble-container {
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 60px; /* 最小宽度 */
    cursor: pointer;
    user-select: none;
}

/* 播放图标 (三角形) */
.voice-icon-play {
    width: 0; 
    height: 0; 
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 10px solid currentColor; /* 跟随文字颜色 */
    opacity: 0.9;
}

/* 声波纹路容器 */
.voice-wave-box {
    display: flex;
    align-items: center;
    gap: 3px;
    height: 16px;
    flex: 1; /* 撑开中间 */
}

/* 单根声波条 */
.voice-bar {
    width: 2px;
    background-color: currentColor; /* 跟随文字颜色 */
    border-radius: 1px;
    opacity: 0.6;
    animation: none; /* 默认不动 */
}

/* 播放时的动画 */
.voice-playing .voice-bar {
    animation: voice-play-anim 0.8s infinite ease-in-out;
}
@keyframes voice-play-anim {
    0%, 100% { height: 4px; opacity: 0.5; }
    50% { height: 12px; opacity: 1; }
}

/* 给声波加随机高度 (模拟真实感) */
.voice-bar:nth-child(1) { height: 6px; }
.voice-bar:nth-child(2) { height: 10px; }
.voice-bar:nth-child(3) { height: 5px; }
.voice-bar:nth-child(4) { height: 8px; }
.voice-bar:nth-child(5) { height: 12px; }
.voice-bar:nth-child(6) { height: 4px; }
.voice-bar:nth-child(7) { height: 9px; }

/* 时长文字 */
.voice-duration-text {
    font-size: 13px;
    font-weight: 500;
    opacity: 0.8;
}

/* 隐藏的真实文本 (点击后显示) */
.voice-real-text {
    display: none; /* 默认隐藏 */
    font-size: 14px;
    line-height: 1.4;
    border-top: 1px solid rgba(255,255,255,0.2);
    margin-top: 8px;
    padding-top: 8px;
    opacity: 0.9;
    white-space: pre-wrap; /* 允许换行 */
    color: white; /* 确保文字是白色的 */
}
/* 浅色模式适配 */
body.light-theme .voice-real-text {
    color: black;
    border-top-color: rgba(0,0,0,0.1);
}

/* --- 自定义表情包面板样式 --- */
        #custom-sticker-panel {
            position: absolute;
            bottom: 70px; /* 在输入栏上方 */
            left: 10px; right: 10px;
            height: 220px; /* 固定高度 */
            background: rgba(30, 30, 35, 0.95); /* 深色背景 */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 50;
            display: none; /* 默认隐藏 */
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slide-up 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #custom-sticker-panel.active { display: flex; }

        .sticker-header-bar {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between;
            color: white;
        }
        .btn-close-sticker {
            width: 24px; height: 24px; background: rgba(255,255,255,0.1);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #aaa;
        }

        .sticker-grid-container {
            flex: 1; overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4列 */
            gap: 12px;
        }
        
        /* 单个表情格子 */
        .sticker-item {
            aspect-ratio: 1/1;
            border-radius: 12px;
            background-color: rgba(255,255,255,0.05);
            background-size: cover; background-position: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
        }
        .sticker-item:active { transform: scale(0.95); }

        /* 加号按钮样式 */
        .sticker-item.add-btn {
            border: 2px dashed rgba(255,255,255,0.2);
            background: transparent;
            display: flex; align-items: center; justify-content: center;
        }

        /* 浅色模式适配 */
        body.light-theme #custom-sticker-panel {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(0,0,0,0.1);
        }
        body.light-theme .sticker-header-bar {
            border-bottom-color: rgba(0,0,0,0.1); color: black;
        }
        body.light-theme .sticker-item.add-btn {
            border-color: rgba(0,0,0,0.2);
        }
        body.light-theme .sticker-item.add-btn svg {
            fill: rgba(0,0,0,0.4) !important;
        }
        
        /* --- 表情面板强制修复样式 --- */
#custom-sticker-panel {
    position: absolute !important;
    bottom: 80px !important; /* 在输入栏上方 */
    left: 10px !important; 
    right: 10px !important;
    height: 240px !important;
    background: rgba(30, 30, 35, 0.98) !important; /* 不透明一点，防止看不清 */
    border-radius: 18px !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    z-index: 9999 !important; /* 提到最高层级 */
    display: none; /* 默认隐藏，JS控制 flex */
    flex-direction: column !important;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5) !important;
}

/* 头部样式 */
.sticker-header-bar {
    padding: 10px 15px !important;
    border-bottom: 1px solid rgba(255,255,255,0.1) !important;
    display: flex !important; 
    justify-content: space-between !important;
    align-items: center !important;
    color: white !important;
}

/* 列表容器 */
.sticker-grid-container {
    flex: 1 !important;
    overflow-y: auto !important;
    padding: 15px !important;
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 12px !important;
}

/* 每一项 */
.sticker-item {
    aspect-ratio: 1/1 !important;
    border-radius: 12px !important;
    background-color: rgba(255,255,255,0.1) !important;
    background-size: cover !important; 
    background-position: center !important;
    cursor: pointer !important;
}

/* 浅色模式适配 */
body.light-theme #custom-sticker-panel {
    background: #ffffff !important;
    border-color: rgba(0,0,0,0.1) !important;
}
body.light-theme .sticker-header-bar {
    color: black !important;
    border-bottom-color: rgba(0,0,0,0.1) !important;
}

/* --- 表情包专用样式 (终极无气泡版) --- */
.sticker-wrapper {
    /* 移除所有容器装饰 */
    background: transparent !important;
    padding: 0 !important;
    border: none !important;
    box-shadow: none !important;
    margin: 5px 0;
}

.chat-sticker-img {
    /* 限制大小，表情包通常比照片小 */
    max-width: 130px !important; 
    height: auto !important;
    display: block !important;
    
    /* 强制移除圆角和边框 */
    border-radius: 0 !important; 
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;
    
    /* 👇【黑科技】👇：如果是深色背景，这行代码会让图片的白色背景变透明！ */
    /* 这样你上传白底表情包看起来也像透明的 */
    mix-blend-mode: multiply; 
    
    cursor: pointer;
}

/* 浅色模式下，multiply 会导致图片消失，所以要切回正常模式 */
body.light-theme .chat-sticker-img {
    mix-blend-mode: normal !important; 
    /* 浅色模式下白底本来就看不出来，所以不用处理 */
}

/* ================== 表情面板最终修正样式 ================== */

/* 1. 面板容器：调整高度和圆角 */
#custom-sticker-panel {
    position: absolute !important;
    bottom: 80px !important;       /* 紧贴输入栏上方 */
    left: 15px !important;         /* 左右留出空隙 */
    right: 15px !important;
    height: 320px !important;      /* 🟢 高度加高，方便上下滑动 */
    background: rgba(30, 30, 35, 0.98) !important; /* 深色背景 */
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border-radius: 24px !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    z-index: 9999 !important;      /* 确保最顶层 */
    display: none;                 /* 默认隐藏，JS控制 flex */
    flex-direction: column !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6) !important;
    overflow: hidden !important;   /* 防止圆角溢出 */
}

/* 2. 头部样式 */
.sticker-header-bar {
    padding: 15px 20px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    color: white !important;
    background: rgba(255, 255, 255, 0.02) !important;
    flex-shrink: 0 !important; /* 防止头部被压缩 */
}

/* 3. 列表容器：强制 3 列 */
.sticker-grid-container {
    flex: 1 !important;
    overflow-y: auto !important;   /* 🟢 开启上下滚动 */
    padding: 20px !important;      /* 内边距加大 */
    display: grid !important;
    
    /* 🟢 核心：强制一行 3 个 */
    grid-template-columns: repeat(3, 1fr) !important; 
    
    /* 🟢 核心：加大间距，让布局更宽松 */
    gap: 20px !important; 
    
    align-content: start !important; /* 内容从上往下排 */
}

/* 4. 单个表情格子：缩小图片显示 */
.sticker-item {
    aspect-ratio: 1/1 !important;  /* 保持正方形 */
    border-radius: 16px !important;
    background-color: rgba(255, 255, 255, 0.08) !important; /* 淡淡的底色框 */
    border: 1px solid rgba(255, 255, 255, 0.05) !important;
    
    /* 🟢 核心：图片只显示 60% 大小，并居中 */
    background-size: 60% !important; 
    background-position: center !important;
    background-repeat: no-repeat !important;
    
    cursor: pointer !important;
    transition: transform 0.1s, background-color 0.2s !important;
}

/* 点击反馈 */
.sticker-item:active {
    transform: scale(0.92) !important;
    background-color: rgba(255, 255, 255, 0.15) !important;
}

/* 5. 加号按钮特殊处理 */
.sticker-item.add-btn {
    border: 2px dashed rgba(255, 255, 255, 0.3) !important;
    background-color: transparent !important;
    background-image: none !important; /* 加号不需要背景图 */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}
.sticker-item.add-btn svg {
    width: 28px !important;
    height: 28px !important;
    fill: rgba(255, 255, 255, 0.5) !important;
}

/* 6. 浅色模式适配 */
body.light-theme #custom-sticker-panel {
    background: #ffffff !important;
    border-color: rgba(0,0,0,0.1) !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
}
body.light-theme .sticker-header-bar {
    color: black !important;
    border-bottom-color: rgba(0,0,0,0.05) !important;
    background: #f9f9f9 !important;
}
body.light-theme .sticker-item {
    background-color: #f2f2f7 !important;
    border-color: rgba(0,0,0,0.05) !important;
}
body.light-theme .sticker-item.add-btn {
    border-color: rgba(0,0,0,0.2) !important;
}
body.light-theme .sticker-item.add-btn svg {
    fill: rgba(0,0,0,0.3) !important;
}

/* ================== 表情包终极样式 (去气泡 + 去白底) ================== */

/* 1. 外层容器：彻底隐形 */
.sticker-wrapper {
    background: transparent !important; /* 去掉背景色 */
    padding: 0 !important;              /* 去掉内边距 */
    border: none !important;            /* 去掉边框 */
    box-shadow: none !important;        /* 去掉阴影 */
    margin: 5px 0;
}

/* 2. 图片本体：混合模式去白底 */
.chat-sticker-img {
    /* 大小调整：你觉得太大，这里改小一点，比如 120px */
    max-width: 120px !important; 
    height: auto !important;
    display: block !important;
    
    /* 去掉图片的圆角和边框，让它看起来像贴纸 */
    border-radius: 0 !important; 
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;
    
    /* 👇👇👇【核心黑科技】👇👇👇 */
    /* 这行代码会让图片里的“白色”变成“透明”，透出底下的聊天背景！ */
    /* 注意：如果表情包本身有大面积白色(比如Hello Kitty的脸)，脸也会变半透明，这是纯代码处理的唯一代价 */
    mix-blend-mode: multiply !important; 
    
    cursor: pointer;
}

/* 浅色模式下不需要混合模式 (因为背景本来就是白的) */
body.light-theme .chat-sticker-img {
    mix-blend-mode: normal !important; 
}

/* --- 表情包终极补丁：强制去白底 --- */
.chat-sticker-img {
    /* 1. 确保没有圆角和边框 */
    border-radius: 0 !important;
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;

    /* 2. 核心：正片叠底 (让白色变透明) */
    /* 无论深色还是浅色模式，都开启这个，这样白底图片就能透出聊天背景 */
    mix-blend-mode: multiply !important; 
    
    /* 3. 稍微调整对比度，让表情更清晰 */
    filter: contrast(1.05);
}

/* 修复：确保浅色模式下也生效 (覆盖之前的 normal 设置) */
body.light-theme .chat-sticker-img {
    mix-blend-mode: multiply !important; 
}

/* 优化：表情面板里的预览图也去白底 */
.sticker-item {
    /* 让面板里的预览图也把白色变透明，融入格子背景 */
    background-blend-mode: multiply !important;
}

/* ================== 表情包专用样式 (终极修复版) ================== */

/* 1. 外层容器：彻底隐形，没有任何背景色和边框 */
.sticker-wrapper {
    background: transparent !important;
    padding: 0 !important;
    border: none !important;
    box-shadow: none !important;
    margin: 5px 0;
}

/* 2. 图片本体：去白底核心代码 */
.chat-sticker-img {
    max-width: 130px !important;
    height: auto !important;
    display: block !important;
    
    /* 强制去掉圆角和边框 */
    border-radius: 0 !important; 
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;
    
    /* 🔥【核心】正片叠底：这行代码会让白底变透明！ */
    mix-blend-mode: multiply !important; 
    
    cursor: pointer;
}

/* 浅色模式下修正 */
body.light-theme .chat-sticker-img {
    mix-blend-mode: multiply !important; 
}

/* 3. 表情面板右上角的删除小按钮 */
.sticker-item {
    position: relative !important;
    overflow: visible !important; /* 允许按钮超出格子一点点 */
}
.sticker-del-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 20px;
    height: 20px;
    background-color: #FF3B30; /* 红色 */
    border: 2px solid #333;    /* 深色描边，防止看不清 */
    border-radius: 50%;
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}
/* 浅色模式下描边变白 */
body.light-theme .sticker-del-btn {
    border-color: #fff;
}

/* ================== 表情包终极修复样式 (请复制到 <style> 最底部) ================== */

/* 1. 表情面板：容器 */
#custom-sticker-panel {
    position: absolute !important;
    bottom: 80px !important;
    left: 10px !important;
    right: 10px !important;
    height: 240px !important;
    background: rgba(30, 30, 35, 0.98) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    border-radius: 18px !important;
    border: 1px solid rgba(255,255,255,0.15) !important;
    z-index: 9999 !important;
    display: none; /* 默认隐藏 */
    flex-direction: column !important;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5) !important;
    overflow: hidden !important;
}

/* 2. 表情面板：列表格子 */
.sticker-grid-container {
    flex: 1 !important;
    overflow-y: auto !important;
    padding: 15px !important;
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 12px !important;
    align-content: start !important;
}

/* 3. 单个表情项 */
.sticker-item {
    aspect-ratio: 1/1 !important;
    border-radius: 12px !important;
    background-color: rgba(255,255,255,0.08) !important;
    background-size: cover !important;
    background-position: center !important;
    cursor: pointer !important;
    position: relative !important; /* 关键：为了定位删除按钮 */
    overflow: visible !important;  /* 关键：允许删除按钮超出格子 */
}

/* 4. 删除按钮 (红色小叉) */
.sticker-del-btn {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 22px;
    height: 22px;
    background-color: #FF3B30;
    border: 2px solid #333; /* 深色描边 */
    border-radius: 50%;
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* 5. 聊天气泡：表情包专用 (去气泡+去白底) */
.sticker-wrapper {
    background: transparent !important;
    padding: 0 !important;
    border: none !important;
    box-shadow: none !important;
    margin: 5px 0;
}

.chat-sticker-img {
    max-width: 130px !important;
    height: auto !important;
    display: block !important;
    border-radius: 0 !important;
    border: none !important;
    box-shadow: none !important;
    background-color: transparent !important;
    
    /* 核心：正片叠底去白底 */
    mix-blend-mode: multiply !important; 
    filter: contrast(1.05); /*稍微增加对比度*/
    cursor: pointer;
}

/* 浅色模式适配 */
body.light-theme .sticker-del-btn { border-color: #fff; }
/* 浅色模式下也要保持 multiply，让白底透明 */
body.light-theme .chat-sticker-img { mix-blend-mode: multiply !important; }

/* ================== 最终修复补丁 (请粘贴到 style 最下方) ================== */

/* 1. 修复表情包显示：取消透明，恢复白底 */
.chat-sticker-img {
    /* 改回 normal，这样白色背景就会显示出来，不会变成透明 */
    mix-blend-mode: normal !important; 
    
    /* 保持原来的大小限制 */
    max-width: 130px !important;
    height: auto !important;
    
    /* 给图片加一点圆角，看起来不那么生硬 */
    border-radius: 8px !important;
    
    /* 加一点阴影，让它和聊天背景区分开 */
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

/* 2. 修复删除按钮不显示的问题 */
.sticker-item {
    /* 关键：允许子元素超出格子显示 (解决被切掉的问题) */
    overflow: visible !important; 
    position: relative !important;
    z-index: 10;
}

.sticker-del-btn {
    /* 调整位置：为了保险起见，稍微往里挪一点点，确保不被边缘遮挡 */
    position: absolute !important;
    top: -8px !important; 
    right: -8px !important;
    
    /* 样式美化 */
    width: 22px !important;
    height: 22px !important;
    background-color: #FF3B30 !important; /* 鲜艳的红色 */
    color: white !important;
    border: 2px solid #2c2c2e !important; /* 加个深色描边，防止和背景混色 */
    border-radius: 50% !important;
    font-size: 16px !important;
    font-weight: bold !important;
    
    /* 居中叉号 */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    
    /* 确保层级最高，点得到 */
    z-index: 100 !important;
    cursor: pointer !important;
    
    /* 加个阴影 */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3) !important;
}

/* 3. 确保表情面板容器层级够高 */
#custom-sticker-panel {
    z-index: 9999 !important;
    overflow: visible !important; /* 防止面板本身切掉边缘的按钮 */
}

/* ================== 表情包：多选模式选中框样式 ================== */

/* 1. 表情面板顶部多选按钮样式 (垃圾桶) */
#btn-sticker-delete-mode {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}
#btn-sticker-delete-mode:hover {
    background: rgba(255, 255, 255, 0.2);
}
#btn-sticker-delete-mode.active {
    background: #FF3B30; /* 选中时变红色 */
}

/* 2. 单个表情项：多选状态容器 */
.sticker-item {
    position: relative; /* 确保选中框能定位 */
    /* 保持原来的 overflow: hidden 或不设置，确保删除按钮不外溢 */
}

/* 3. 选中框的样式 (默认隐藏) */
.sticker-checkbox {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #aaa;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20;
    pointer-events: none; /* 允许点击穿透 */
    opacity: 0; /* 默认隐藏 */
    transition: opacity 0.2s, background 0.2s;
}

/* 4. 多选模式激活时，显示选中框 */
#custom-sticker-panel.multi-select-mode .sticker-checkbox {
    opacity: 1; 
}

/* 5. 选中状态样式 */
.sticker-item.selected .sticker-checkbox {
    background: #FF3B30;
    border-color: #FF3B30;
}
.sticker-item.selected .sticker-checkbox::after {
    content: '✔';
    font-size: 14px;
    color: white;
    font-weight: bold;
}

/* ================== 沉浸式视频通话样式 (修复顶部空白) ================== */

/* 确保子页面在视频模式下全屏且无padding */
.sub-page.immersive-mode {
    padding: 0 !important; /* 强制去除内边距 */
    background: #000;
}

/* 1. 全屏背景层 */
#video-remote-container-fullscreen {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1; overflow: hidden;
}
/* 极光背景全屏铺满 */
.aurora-bg.full {
    position: absolute; top: -10%; left: -10%; width: 120%; height: 120%;
    background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
    background-image: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
    filter: blur(60px); opacity: 0.7;
    animation: aurora-spin 15s infinite linear;
}
@keyframes aurora-spin { from {transform: rotate(0deg);} to {transform: rotate(360deg);}}

/* 视频上的渐变蒙版，让顶部和底部的白色文字更清晰 */
.video-overlay-gradient {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.8) 100%);
    pointer-events: none; z-index: 2;
}

/* 2. 顶部悬浮栏 */
.video-top-bar {
    position: absolute; top: 20px; /* 留出一点状态栏空间，可根据需要调整为 0 */
    left: 20px; right: 20px;
    display: flex; align-items: center;
    z-index: 50; color: white;
}
.video-top-btn {
    width: 40px; height: 40px; background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; margin-right: 15px;
}
.video-top-btn svg { width: 24px; }
.video-top-info { font-size: 16px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

/* 3. 右上角本地小窗 (PIP) */
.video-local-pip {
    position: absolute; top: 80px; right: 20px;
    width: 90px; height: 144px; /* 9:16 */
    background: #333; border-radius: 12px;
    overflow: hidden; z-index: 60;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    border: 2px solid rgba(255,255,255,0.2);
    transition: all 0.2s; cursor: pointer;
}
.video-local-pip:active { transform: scale(0.95); }

/* 4. 底部控制区容器 */
.video-bottom-area {
    position: absolute; bottom: 0; left: 0; width: 100%;
    z-index: 50; padding-bottom: 30px;
    display: flex; flex-direction: column; align-items: center;
}

/* 底部按钮栏 (Dock) */
.video-controls-dock {
    display: flex; align-items: center; gap: 25px;
    padding: 10px 30px;
    background: rgba(0,0,0,0.3); backdrop-filter: blur(20px);
    border-radius: 40px;
}
.v-dock-btn {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: white; font-size: 12px; cursor: pointer;
    width: 60px; height: 60px; border-radius: 50%;
    transition: transform 0.1s;
}
.v-dock-btn:active { transform: scale(0.9); }
.v-dock-btn svg { width: 28px; height: 28px; margin-bottom: 4px; }
.v-dock-btn.blur { background: rgba(255,255,255,0.15); }
.v-dock-btn.red { background: #ff3b30; width: 70px; height: 70px; box-shadow: 0 5px 15px rgba(255,59,48,0.5); }
.v-dock-btn.red svg { width: 32px; height: 32px; margin: 0; }

/* 悬浮输入框 */
.video-input-float {
    width: 85%; margin-bottom: 20px;
    display: flex; gap: 10px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px); padding: 10px 15px;
    border-radius: 25px; transition: all 0.3s;
}
.video-input-float.hidden { opacity: 0; transform: translateY(30px); pointer-events: none; }
#video-chat-input {
    flex: 1; background: transparent; border: none; outline: none;
    color: white; font-size: 16px;
}
#video-chat-input::placeholder { color: rgba(255,255,255,0.6); }
.video-input-float button {
    background: #0a84ff; color: white; border: none;
    padding: 8px 20px; border-radius: 20px; font-size: 14px;
}

/* 5. 浮动字幕 (AI回复) */
.video-subtitle-float {
    position: absolute; bottom: 160px; /* 在输入框上面 */
    width: 100%; display: flex; justify-content: center;
    z-index: 40; transition: all 0.3s;
}
.video-subtitle-float.hidden { opacity: 0; transform: translateY(20px); }
.subtitle-card {
    display: flex; align-items: center; gap: 10px;
    background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px);
    padding: 10px 20px; border-radius: 30px;
    max-width: 80%;
}
.subtitle-avatar {
    width: 36px; height: 36px; border-radius: 50%; background: #ddd;
    background-size: cover; flex-shrink: 0;
}
.subtitle-content { color: white; font-size: 16px; line-height: 1.4; }

/* 6. 全屏呼叫遮罩 */
.fullscreen-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100; background: rgba(0,0,0,0.75); backdrop-filter: blur(25px);
    display: flex; justify-content: center; align-items: center;
    transition: opacity 0.5s;
}
.fullscreen-overlay.connected { opacity: 0; pointer-events: none; }
.calling-center { text-align: center; color: white; }
.calling-avatar-box { position: relative; width: 120px; height: 120px; margin: 0 auto 30px; }
.calling-avatar-img {
    width: 100%; height: 100%; border-radius: 50%;
    background-size: cover; background-position: center;
    position: relative; z-index: 2; border: 3px solid white;
}
.calling-ripple {
    position: absolute; top: -10%; left: -10%; width: 120%; height: 120%;
    border-radius: 50%; border: 2px solid rgba(255,255,255,0.5);
    animation: ripple-big 2s infinite ease-out; z-index: 1;
}
.calling-ripple.delay { animation-delay: 1s; }
@keyframes ripple-big {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(2); opacity: 0; }
}
.calling-name-txt { font-size: 28px; font-weight: 700; margin-bottom: 10px; }
.calling-status-txt { font-size: 16px; opacity: 0.8; }

/* 视频通话记录样式 */
.video-log-item {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    border: 1px solid rgba(255,255,255,0.05);
}
.v-log-header {
    display: flex; justify-content: space-between; margin-bottom: 6px;
    font-size: 12px; color: rgba(255,255,255,0.4);
}
.v-log-content {
    font-size: 14px; color: white; line-height: 1.4;
}
.v-log-role { color: #0a84ff; font-weight: bold; margin-right: 5px; }
.v-log-me { color: #34C759; font-weight: bold; margin-right: 5px; }

/* 浅色模式适配 */
body.light-theme #sub-video-history-log { background: #f2f2f7 !important; }
body.light-theme .video-log-item { background: white; border-color: rgba(0,0,0,0.05); }
body.light-theme .v-log-content { color: #333; }

/* ================== 补全缺失的动画 (视频聊天气泡) ================== */
@keyframes slide-up-fade {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ================== 修复补丁：视频记录页层级 ================== */
#sub-video-history-log {
    z-index: 900 !important; /* 必须比设置页(850)高 */
}

/* 优化记录列表的样式，防止太挤 */
.video-log-item {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 8px;
}

/* ================== 赛博 3D 雷达地图 (最终还原版) ================== */

/* 1. 地图容器 */
.map-simulation-container {
    width: 100%;
    /* 核心修复：如果是查看页，高度设为 100% 填满屏幕；如果是选择页，固定 350px */
    height: 100%; 
    min-height: 350px;
    background: #0b0f19 !important; /* 深黑底色 */
    position: relative;
    overflow: hidden;
    perspective: 800px; /* 3D 透视 */
    z-index: 1;
}

/* 2. 3D 网格 */
.cyber-grid-plane {
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background-image: 
        linear-gradient(rgba(10, 132, 255, 0.2) 1px, transparent 1px),
        linear-gradient(90deg, rgba(10, 132, 255, 0.2) 1px, transparent 1px);
    background-size: 60px 60px;
    transform: rotateX(60deg) translateY(-100px);
    mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 80%);
    -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 80%);
    animation: grid-move 20s linear infinite;
    pointer-events: none;
}
@keyframes grid-move { 0% {background-position: 0 0;} 100% {background-position: 0 60px;} }

/* 3. 雷达 */
.map-radar-scan {
    position: absolute; top: 50%; left: 50%; width: 500px; height: 500px;
    transform: translate(-50%, -50%) rotateX(60deg);
    border-radius: 50%; border: 1px solid rgba(10, 132, 255, 0.1);
    background: conic-gradient(from 0deg, transparent 0%, transparent 80%, rgba(10, 132, 255, 0.3) 100%);
    animation: radar-spin 4s infinite linear;
    pointer-events: none;
}
@keyframes radar-spin { from {transform: translate(-50%, -50%) rotateX(60deg) rotate(0deg);} to {transform: translate(-50%, -50%) rotateX(60deg) rotate(360deg);} }

/* 4. 中心红点 (查看页专用样式) */
.map-center-pin.viewer-mode .pin-point {
    width: 20px; height: 20px;
    box-shadow: 0 0 30px #FF3B30; /* 更强的光晕 */
}

/* 5. 装饰点 (周边POI) */
.deco-point {
    position: absolute; width: 6px; height: 6px;
    background: #0a84ff; border-radius: 50%;
    box-shadow: 0 0 5px #0a84ff;
}
.p1 { top: 30%; left: 20%; opacity: 0.6; }
.p2 { top: 60%; left: 80%; opacity: 0.8; }
.p3 { top: 20%; left: 70%; opacity: 0.5; }
.p4 { top: 75%; left: 30%; opacity: 0.7; }

/* 6. UI 文字装饰 */
.map-ui-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
}
.ui-top-left { position: absolute; top: 15px; left: 15px; font-size: 10px; color: rgba(255,255,255,0.5); font-family: monospace; }
.ui-top-right { position: absolute; top: 15px; right: 15px; font-size: 10px; color: #34C759; font-weight: bold; animation: blink 2s infinite; }
.ui-bottom-left { position: absolute; bottom: 15px; left: 15px; font-size: 10px; color: rgba(255,255,255,0.4); font-family: monospace; }
.ui-crosshair {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 200px; height: 200px;
    border: 1px dashed rgba(255,255,255,0.1);
    border-radius: 50%;
    pointer-events: none;
}
@keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }

/* 7. 浅色模式适配 */
body.light-theme .map-simulation-container {
    background: #f0f2f5 !important;
}
body.light-theme .cyber-grid-plane {
    background-image: 
        linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
    mask-image: none; -webkit-mask-image: none; 
}
body.light-theme .map-radar-scan {
    background: conic-gradient(from 0deg, transparent 0%, transparent 80%, rgba(0, 0, 0, 0.1) 100%);
    border-color: rgba(0,0,0,0.05);
}
body.light-theme .ui-top-left, body.light-theme .ui-bottom-left { color: #666; }

/* ================== 地理位置 & 赛博地图完整样式 ================== */

/* 1. 地图容器 (3D 视窗) */
.map-simulation-container {
    width: 100%;
    height: 350px; /* 固定高度 */
    background: #050505; /* 深黑底色 */
    position: relative;
    overflow: hidden;
    perspective: 800px; /* 3D 透视核心 */
    border-bottom: 1px solid rgba(255,255,255,0.1);
    flex-shrink: 0;
}

/* 2. 3D 地面网格 (无限滚动) */
.cyber-grid-plane {
    position: absolute;
    top: 0; left: -50%; width: 200%; height: 200%;
    background-image: 
        linear-gradient(rgba(10, 132, 255, 0.2) 1px, transparent 1px),
        linear-gradient(90deg, rgba(10, 132, 255, 0.2) 1px, transparent 1px);
    background-size: 60px 60px;
    transform: rotateX(60deg) translateY(-100px);
    mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 80%);
    -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,0) 80%);
    animation: grid-flow 20s linear infinite;
}
@keyframes grid-flow {
    0% { background-position: 0 0; }
    100% { background-position: 0 60px; }
}

/* 3. 雷达扫描圈 */
.map-radar-scan {
    position: absolute;
    top: 50%; left: 50%;
    width: 500px; height: 500px;
    transform: translate(-50%, -50%) rotateX(60deg);
    border-radius: 50%;
    border: 1px solid rgba(10, 132, 255, 0.1);
    background: conic-gradient(from 0deg, transparent 0%, transparent 70%, rgba(10, 132, 255, 0.3) 100%);
    animation: radar-spin 4s infinite linear;
    pointer-events: none;
    z-index: 2;
}
@keyframes radar-spin {
    from { transform: translate(-50%, -50%) rotateX(60deg) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotateX(60deg) rotate(360deg); }
}

/* 4. 中心定位点 (呼吸灯) */
.map-center-pin {
    position: absolute; top: 45%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    display: flex; flex-direction: column; align-items: center;
}
.pin-core {
    width: 12px; height: 12px; background: #FF3B30;
    border-radius: 50%; box-shadow: 0 0 15px #FF3B30;
    position: relative; z-index: 2; border: 2px solid white;
}
.pin-ring {
    position: absolute; top: -14px; left: -14px;
    width: 40px; height: 40px;
    border: 1px solid #FF3B30; border-radius: 50%;
    opacity: 0; animation: pin-ripple 2s infinite;
}
.pin-label {
    margin-top: 8px; font-size: 10px; font-weight: bold; 
    color: #FF3B30; letter-spacing: 1px;
    text-shadow: 0 0 5px rgba(255, 59, 48, 0.5);
}
@keyframes pin-ripple {
    0% { transform: scale(0.1); opacity: 1; }
    100% { transform: scale(1.2); opacity: 0; }
}

/* 5. 装饰光点 */
.deco-point {
    position: absolute; width: 4px; height: 4px;
    background: #0a84ff; border-radius: 50%;
    box-shadow: 0 0 8px #0a84ff; animation: blink 3s infinite;
}
.p1 { top: 30%; left: 20%; animation-delay: 0s; }
.p2 { top: 60%; left: 80%; animation-delay: 1s; }
.p3 { top: 20%; left: 70%; animation-delay: 2s; }
.p4 { top: 75%; left: 30%; animation-delay: 0.5s; }
@keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }

/* 6. UI 文字覆盖 */
.map-ui-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
}
.ui-top-left { position: absolute; top: 15px; left: 15px; font-size: 10px; color: rgba(255,255,255,0.5); font-family: monospace; }
.ui-top-right { position: absolute; top: 15px; right: 15px; font-size: 10px; color: #34C759; font-weight: bold; animation: blink 2s infinite; }
.ui-bottom-left { position: absolute; bottom: 15px; left: 15px; font-size: 10px; color: rgba(255,255,255,0.4); font-family: monospace; }
.ui-crosshair {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 200px; height: 200px;
    border: 1px dashed rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;
}

/* 7. 地点列表样式 */
.location-list-container {
    flex: 1; overflow-y: auto; background: #1c1c1e;
}
.poi-item {
    padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer; display: flex; align-items: flex-start; gap: 12px;
}
.poi-item:active { background: rgba(255,255,255,0.05); }
.poi-icon {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.poi-icon svg { width: 20px; height: 20px; fill: white; opacity: 0.7; }
.poi-info { flex: 1; }
.poi-name { font-size: 15px; font-weight: 600; color: white; margin-bottom: 4px; }
.poi-addr { font-size: 12px; color: rgba(255,255,255,0.5); }

/* 选中状态 */
.poi-item.selected .poi-name { color: #0a84ff; }
.poi-item.selected .poi-icon { background: #0a84ff; }
.poi-item.selected .poi-icon svg { fill: white; opacity: 1; }

/* 8. 聊天气泡里的地图卡片 */
.msg-location-card {
    width: 220px; border-radius: 12px; overflow: hidden;
    background: #2c2c2e; border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
}
.loc-card-map {
    height: 100px; width: 100%;
    background: #0b0f19;
    background-image: 
        linear-gradient(rgba(10, 132, 255, 0.2) 1px, transparent 1px),
        linear-gradient(90deg, rgba(10, 132, 255, 0.2) 1px, transparent 1px);
    background-size: 20px 20px;
    position: relative; display: flex; align-items: center; justify-content: center;
}
.loc-card-info { padding: 10px; }
.loc-card-title { font-size: 14px; font-weight: 600; color: white; margin-bottom: 2px; }
.loc-card-addr { font-size: 11px; color: rgba(255,255,255,0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* 底部详情卡 */
.location-detail-card {
    position: absolute; bottom: 30px; left: 15px; right: 15px;
    background: rgba(30,30,35,0.95); backdrop-filter: blur(20px);
    border-radius: 20px; padding: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

/* 9. 浅色模式适配 */
body.light-theme .map-simulation-container { background: #f0f2f5; }
body.light-theme .cyber-grid-plane {
    background-image: 
        linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
    mask-image: none; -webkit-mask-image: none;
}
body.light-theme .map-radar-scan {
    background: conic-gradient(from 0deg, transparent 0%, transparent 80%, rgba(0, 0, 0, 0.1) 100%);
    border-color: rgba(0,0,0,0.05);
}
body.light-theme .location-list-container { background: #f2f2f7; }
body.light-theme .poi-item { background: white; border-bottom-color: rgba(0,0,0,0.05); }
body.light-theme .poi-name { color: black; }
body.light-theme .poi-addr { color: rgba(0,0,0,0.5); }
body.light-theme .poi-icon { background: #f2f2f7; }
body.light-theme .poi-icon svg { fill: #666; }
body.light-theme .msg-location-card { background: white; border-color: rgba(0,0,0,0.1); }
body.light-theme .loc-card-title { color: black; }
body.light-theme .loc-card-addr { color: rgba(0,0,0,0.5); }
body.light-theme .loc-card-map { background: #e5e5ea; background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px); }
body.light-theme .location-detail-card { background: rgba(255,255,255,0.95); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }

/* ================== 赛博高密度地图样式 (High-Density City) ================== */

/* 1. 地图主容器 */
.map-simulation-container {
    width: 100%;
    /* 默认高度，查看页会覆盖为 100% */
    height: 350px; 
    background-color: #0E1013; /* 深色地基 */
    position: relative;
    overflow: hidden;
    /* 取消强透视，改用俯视视角，更像地图 */
    z-index: 1;
}

/* 2. 城市肌理 (街区 + 小路) */
.map-layer-blocks {
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    /* 利用重复渐变模拟密集的建筑块 */
    background-image: 
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 20px 20px; /* 小格子大小 */
    transform: rotate(15deg); /* 整体稍微倾斜，更有设计感 */
}

/* 3. 城市主干道 (粗线) */
.map-layer-roads {
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background-image: 
        linear-gradient(rgba(255,255,255,0.08) 4px, transparent 4px),
        linear-gradient(90deg, rgba(255,255,255,0.08) 4px, transparent 4px);
    background-size: 120px 120px; /* 大格子间距 */
    transform: rotate(15deg); /* 与街区保持一致 */
    pointer-events: none;
}

/* 4. 河流 (贯穿城市的蓝色带子) */
.map-layer-river {
    position: absolute;
    top: 20%; left: -20%; width: 140%; height: 120px;
    background: linear-gradient(180deg, rgba(10, 132, 255, 0.1), rgba(10, 132, 255, 0.3), rgba(10, 132, 255, 0.1));
    transform: rotate(-25deg);
    filter: blur(5px);
    pointer-events: none;
}

/* 5. 绿地公园 (绿色块) */
.map-layer-park {
    position: absolute;
    background-color: rgba(52, 199, 89, 0.15);
    border: 1px dashed rgba(52, 199, 89, 0.3);
    border-radius: 8px;
    pointer-events: none;
}

/* 6. 路名/地名标签 */
.map-label-group {
    position: absolute; width: 100%; height: 100%; pointer-events: none;
}
.map-street-name {
    position: absolute;
    font-size: 10px; color: rgba(255,255,255,0.4);
    font-family: monospace; letter-spacing: 1px;
    transform: rotate(15deg); /* 沿着路的方向 */
}
.map-poi-name {
    position: absolute;
    font-size: 11px; color: #fff; font-weight: 600;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    display: flex; align-items: center; gap: 4px;
}
.map-poi-name::before {
    content: ''; display: block; width: 6px; height: 6px; 
    background: #0a84ff; border-radius: 50%;
}

/* 7. 中心主角 (呼吸光标) */
.map-center-pin {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10; pointer-events: none;
    display: flex; flex-direction: column; align-items: center;
}
.pin-core {
    width: 16px; height: 16px; background: #FF3B30;
    border: 3px solid white; border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.pin-ripple {
    position: absolute; bottom: -5px;
    width: 40px; height: 40px;
    background: rgba(255, 59, 48, 0.4);
    border-radius: 50%;
    transform: scaleX(2); /* 压扁一点更有立体感 */
    animation: map-pulse 2s infinite;
    z-index: -1;
}
@keyframes map-pulse {
    0% { transform: scaleX(2) scaleY(0.5) scale(0.5); opacity: 1; }
    100% { transform: scaleX(2) scaleY(0.5) scale(2); opacity: 0; }
}

/* 浅色模式适配 */
body.light-theme .map-simulation-container { background: #f2f2f7; }
body.light-theme .map-layer-blocks { 
    background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px); 
}
body.light-theme .map-layer-roads {
    background-image: linear-gradient(rgba(255,255,255,0.8) 4px, transparent 4px), linear-gradient(90deg, rgba(255,255,255,0.8) 4px, transparent 4px);
}
body.light-theme .map-street-name { color: rgba(0,0,0,0.4); }
body.light-theme .map-poi-name { color: #333; text-shadow: 0 1px 0 rgba(255,255,255,0.8); }

/* ================== 赛博地图终极版样式 ================== */

/* 1. 地图视窗 */
.cyber-map-visual {
    width: 100%;
    height: 300px; /* 发送页高度 */
    background: #0b0f19; /* 深空黑 */
    position: relative;
    overflow: hidden;
    perspective: 1000px;
    flex-shrink: 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.cyber-map-visual.full-screen {
    height: 100%; /* 查看页全屏 */
}

/* 2. 地面网格 (透视效果) */
.cyber-grid-floor {
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background-image: 
        linear-gradient(rgba(10, 132, 255, 0.3) 1px, transparent 1px),
        linear-gradient(90deg, rgba(10, 132, 255, 0.3) 1px, transparent 1px);
    background-size: 50px 50px;
    transform: rotateX(60deg); /* 倒伏 */
    mask-image: linear-gradient(to bottom, black 20%, transparent 80%);
    -webkit-mask-image: linear-gradient(to bottom, black 20%, transparent 80%);
    transition: background-position 0.5s ease-out; /* 移动时的平滑过渡 */
    z-index: 1;
}

/* 3. 雷达圈 */
.cyber-radar-ring {
    position: absolute; top: 50%; left: 50%;
    width: 400px; height: 400px;
    transform: translate(-50%, -50%) rotateX(60deg);
    border: 2px solid rgba(10, 132, 255, 0.2);
    border-radius: 50%;
    background: radial-gradient(circle, rgba(10,132,255,0.1) 0%, transparent 60%);
    box-shadow: 0 0 30px rgba(10, 132, 255, 0.1);
    z-index: 2;
    pointer-events: none;
}

/* 4. 中心大头针 */
.cyber-pin-center {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -100%); /* 针尖对准中心 */
    display: flex; flex-direction: column; align-items: center;
    z-index: 100; /* 🌟 保证在最上层 */
}
.pin-head {
    width: 32px; height: 32px;
    background: #0a84ff;
    border: 3px solid white;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
.pin-head.red { background: #FF3B30; }

.pin-pulse {
    width: 10px; height: 10px; background: #0a84ff;
    border-radius: 50%; position: absolute; bottom: -5px;
    opacity: 0.5; animation: pin-pulse 1.5s infinite;
}
.pin-pulse.red { background: #FF3B30; }

/* 5. 核心：大头针上方的文字标签 */
.pin-tooltip {
    position: absolute; top: -35px; 
    background: rgba(255,255,255,0.9); color: black;
    padding: 4px 10px; border-radius: 6px;
    font-size: 12px; font-weight: bold;
    white-space: nowrap;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.pin-tooltip::after { /* 小三角 */
    content: ''; position: absolute; bottom: -4px; left: 50%; margin-left: -4px;
    border-width: 4px 4px 0; border-style: solid;
    border-color: rgba(255,255,255,0.9) transparent transparent transparent;
}

/* 6. 地图上的装饰文字 (强制显示) */
.map-label-item {
    position: absolute;
    color: rgba(255,255,255,0.4);
    font-size: 12px; font-weight: 700; letter-spacing: 1px;
    font-family: monospace;
    z-index: 5;
    pointer-events: none;
    text-shadow: 0 1px 2px black;
}

/* 7. 动画 */
@keyframes pin-pulse { 0% {transform: scale(1); opacity:0.8;} 100% {transform: scale(3); opacity:0;} }

/* ================== 地图细节装饰包 (追加样式) ================== */

/* 1. 虚拟建筑块 (半透明方块，模拟楼房) */
.cyber-building {
    position: absolute;
    background: rgba(10, 132, 255, 0.15); /* 淡蓝色 */
    border: 1px solid rgba(10, 132, 255, 0.3);
    box-shadow: 0 0 10px rgba(10, 132, 255, 0.1);
    transform: translateZ(0); /* 开启硬件加速 */
    pointer-events: none;
}

/* 2. 街道名称 (像印在地面上一样) */
.cyber-street-text {
    position: absolute;
    color: rgba(255, 255, 255, 0.3);
    font-size: 10px;
    font-family: monospace;
    font-weight: bold;
    letter-spacing: 2px;
    transform: rotate(-15deg); /* 稍微倾斜，配合网格 */
    pointer-events: none;
    white-space: nowrap;
}

/* 3. 动态扫描线 (上下移动的光条) */
.cyber-scan-line {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, #0a84ff, transparent);
    opacity: 0.5;
    animation: scan-move 3s linear infinite;
    pointer-events: none;
    z-index: 3;
}
@keyframes scan-move {
    0% { top: 0%; opacity: 0; }
    20% { opacity: 0.8; }
    80% { opacity: 0.8; }
    100% { top: 100%; opacity: 0; }
}

/* 4. 警告区域 (红色禁区) */
.cyber-danger-zone {
    position: absolute;
    background: repeating-linear-gradient(
        45deg,
        rgba(255, 59, 48, 0.1),
        rgba(255, 59, 48, 0.1) 10px,
        rgba(255, 59, 48, 0.2) 10px,
        rgba(255, 59, 48, 0.2) 20px
    );
    border: 1px dashed rgba(255, 59, 48, 0.4);
    pointer-events: none;
}

/* ================== 🌌 赛博地图终极样式 v3.0 ================== */

/* 1. 地图视窗 */
.cyber-map-visual {
    width: 100%;
    height: 350px;
    background: #05070a; /* 极深蓝黑 */
    position: relative;
    overflow: hidden;
    perspective: 1200px; /* 增强透视感 */
    border-bottom: 1px solid rgba(255,255,255,0.1);
    flex-shrink: 0;
}
/* 查看页全屏容器 */
.map-container-placeholder {
    width: 100%; height: 100%;
    background: #05070a;
    position: relative;
    overflow: hidden;
    perspective: 1200px;
}

/* 2. 地面网格 (流光效果) */
.cyber-grid-floor {
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    /* 蓝色 + 紫色微光 */
    background-image: 
        linear-gradient(rgba(10, 132, 255, 0.3) 1px, transparent 1px),
        linear-gradient(90deg, rgba(10, 132, 255, 0.3) 1px, transparent 1px);
    background-size: 60px 60px;
    transform: rotateX(60deg) translateY(0);
    /* 远处渐隐 */
    mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 20%, rgba(0,0,0,0) 80%);
    -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 20%, rgba(0,0,0,0) 80%);
    animation: grid-scroll 20s linear infinite;
    z-index: 1;
}
@keyframes grid-scroll {
    0% { background-position: 0 0; }
    100% { background-position: 0 60px; }
}

/* 3. 动态扫描线 (新功能) */
.cyber-scan-line {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, #34C759, transparent);
    box-shadow: 0 0 10px #34C759;
    opacity: 0.8;
    z-index: 3;
    animation: scan-down 3s ease-in-out infinite;
    pointer-events: none;
}
@keyframes scan-down {
    0% { top: 0%; opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { top: 100%; opacity: 0; }
}

/* 4. 雷达圈 (加大加亮) */
.cyber-radar-ring {
    position: absolute; top: 50%; left: 50%;
    width: 450px; height: 450px;
    transform: translate(-50%, -50%) rotateX(60deg);
    border: 2px solid rgba(10, 132, 255, 0.15);
    border-radius: 50%;
    /* 扫描扇区 */
    background: conic-gradient(from 0deg, transparent 0%, transparent 60%, rgba(10, 132, 255, 0.4) 100%);
    box-shadow: 0 0 50px rgba(10, 132, 255, 0.1);
    z-index: 2;
    animation: radar-rotate 4s infinite linear;
    pointer-events: none;
}
@keyframes radar-rotate {
    from { transform: translate(-50%, -50%) rotateX(60deg) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotateX(60deg) rotate(360deg); }
}

/* 5. 中心大头针 */
.cyber-pin-center {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -100%);
    display: flex; flex-direction: column; align-items: center;
    z-index: 100;
}
.pin-head {
    width: 36px; height: 36px;
    background: #34C759; /* 默认绿色 */
    border: 3px solid white;
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    box-shadow: 0 5px 20px rgba(0,0,0,0.6);
    transition: background 0.3s;
}
.pin-head.red { background: #FF3B30; }

.pin-pulse {
    width: 14px; height: 7px; background: #34C759;
    border-radius: 50%; position: absolute; bottom: -8px;
    opacity: 0.6; filter: blur(2px);
    animation: pin-breath 1.5s infinite;
}
.pin-pulse.red { background: #FF3B30; }

.pin-tooltip {
    position: absolute; top: -45px; 
    background: rgba(255,255,255,0.95); color: black;
    padding: 6px 12px; border-radius: 8px;
    font-size: 13px; font-weight: bold; white-space: nowrap;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.2s;
}
.pin-tooltip::after {
    content: ''; position: absolute; bottom: -5px; left: 50%; margin-left: -5px;
    border-width: 5px 5px 0; border-style: solid;
    border-color: rgba(255,255,255,0.95) transparent transparent transparent;
}

/* 6. 装饰文字 */
.map-label-item {
    position: absolute; color: rgba(255,255,255,0.3);
    font-size: 10px; font-family: monospace; letter-spacing: 1px;
    font-weight: 700; text-shadow: 0 1px 2px black;
}
@keyframes pin-breath { 0%,100% {transform: scale(1); opacity:0.6;} 50% {transform: scale(1.5); opacity:0.3;} }

/* ================== 💸 Ins 风转账卡片 (终极美化版) ================== */
/* Ins 风转账卡片 */
.msg-transfer-card {
    min-width: 220px; height: 72px;
    border-radius: 18px; display: flex; align-items: center; padding: 0 16px;
    cursor: pointer; position: relative; overflow: hidden;
    /* 核心：橙紫渐变 */
    background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #FCB045 100%);
    box-shadow: 0 4px 15px rgba(253, 29, 29, 0.3);
    border: 1px solid rgba(255,255,255,0.1);
}
.msg-transfer-card.received {
    background: #3a3a3c !important; /* 领完变灰 */
    box-shadow: none;
}
.trans-amount-text { font-size: 20px; font-weight: 700; color: white; }
.trans-desc-text { font-size: 12px; color: rgba(255,255,255,0.9); }
.trans-icon-area { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
.trans-svg { width: 20px; height: 20px; fill: white; }

/* 左侧图标容器 */
.trans-icon-area {
    width: 40px; height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin-right: 14px;
    backdrop-filter: blur(5px);
}
.trans-svg {
    width: 22px; height: 22px; fill: white;
}

/* 右侧文字区 */
.trans-info-area {
    display: flex; flex-direction: column; justify-content: center;
    color: white;
}

/* 金额文字 */
.trans-amount-text {
    font-size: 20px; font-weight: 700;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    line-height: 1.1;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* 描述文字 */
.trans-desc-text {
    font-size: 12px; opacity: 0.9;
    margin-top: 2px;
    font-weight: 500;
}

/* 浅色模式适配 */
body.light-theme .msg-transfer-card.received {
    background: #e5e5ea !important; /* 浅灰 */
}
body.light-theme .msg-transfer-card.received .trans-amount-text,
body.light-theme .msg-transfer-card.received .trans-desc-text {
    color: rgba(0,0,0,0.4);
}
body.light-theme .msg-transfer-card.received .trans-svg {
    fill: rgba(0,0,0,0.3);
}

/* ================== ❤️ 读心术 UI (杂志级排版) ================== */

/* 1. 弹窗卡片主体 */
.heart-modal-card {
    width: 85%; max-width: 340px;
    background: rgba(20, 20, 25, 0.85); /* 深色磨砂 */
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 32px;
    padding: 40px 30px 90px 30px; /* 底部留空间给按钮 */
    position: relative;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; align-items: center;
}

/* 2. 背景光效 */
.heart-bg-glow {
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle, rgba(255, 46, 99, 0.2) 0%, transparent 70%);
    animation: slow-rotate 15s infinite linear;
    pointer-events: none; z-index: 0;
}

/* 3. 头部信息 */
.heart-header { position: relative; z-index: 2; text-align: center; margin-bottom: 30px; }
.heart-avatar-wrap { position: relative; width: 88px; height: 88px; margin: 0 auto 15px; }
.heart-avatar {
    width: 100%; height: 100%; border-radius: 50%;
    background-size: cover; background-position: center;
    border: 3px solid rgba(255,255,255,0.15);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}
.heart-beat-icon {
    position: absolute; bottom: 0; right: 0;
    width: 32px; height: 32px; background: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    animation: heartbeat 1.5s infinite ease-in-out;
}
.heart-role-name { font-size: 22px; font-weight: 700; color: white; letter-spacing: 0.5px; }
.heart-role-label { font-size: 10px; color: rgba(255,255,255,0.4); letter-spacing: 2px; margin-top: 4px; text-transform: uppercase; }

/* 4. 心声文本区 (核心：CSS引号) */
.heart-quote-box {
    position: relative; z-index: 2; width: 100%;
    margin-bottom: 30px;
}
/* 使用伪元素做超大引号，不用担心乱码 */
.heart-quote-box::before {
    content: "“";
    position: absolute; top: -20px; left: -10px;
    font-family: Georgia, serif; font-size: 60px; line-height: 1;
    color: rgba(255,255,255,0.15);
}
.heart-quote-box::after {
    content: "”";
    position: absolute; bottom: -40px; right: -10px;
    font-family: Georgia, serif; font-size: 60px; line-height: 1;
    color: rgba(255,255,255,0.15);
}
.heart-content-text {
    font-size: 17px; line-height: 1.6; color: rgba(255,255,255,0.9);
    text-align: center; font-style: italic; font-weight: 300;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    min-height: 60px; display: flex; align-items: center; justify-content: center;
}

/* 5. 底部数据行 */
.heart-stats-row {
    display: flex; align-items: center; justify-content: center; gap: 20px;
    position: relative; z-index: 2; width: 100%;
}
.stat-box { text-align: center; }
.stat-num { font-size: 18px; font-weight: 700; font-family: monospace; }
.stat-name { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 2px; }
.stat-line { width: 1px; height: 20px; background: rgba(255,255,255,0.1); }

/* 6. 关闭按钮 (圆形悬浮) */
.heart-close-btn {
    position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
    width: 50px; height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 10;
    transition: all 0.2s ease;
}
.heart-close-btn:active { transform: translateX(-50%) scale(0.9); background: rgba(255,255,255,0.2); }

/* 动画 */
@keyframes heartbeat { 0%,100%{transform:scale(1);} 50%{transform:scale(1.1);} }
@keyframes slow-rotate { 0%{transform:translate(-50%,-50%) rotate(0deg);} 100%{transform:translate(-50%,-50%) rotate(360deg);} }

/* 浅色模式适配 */
body.light-theme .heart-modal-card { background: rgba(255,255,255,0.85); box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
body.light-theme .heart-role-name { color: #000; }
body.light-theme .heart-content-text { color: #333; }
body.light-theme .heart-quote-box::before, 
body.light-theme .heart-quote-box::after { color: rgba(0,0,0,0.05); }
body.light-theme .heart-close-btn { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.05); }
body.light-theme .heart-close-btn svg { stroke: #333; }
    </style>
</head>
<body>
<div id="dynamic-island" class="island-container idle-show">
    <div class="island-content">
        <div class="island-left" id="island-icon"></div>
        <div class="island-center" id="island-text"></div>
        <div class="island-right" id="island-info"></div>
    </div>
</div>
<video id="global-video-bg" autoplay loop muted playsinline style="
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; z-index: -1; display: none; pointer-events: none;
"></video>

<div class="status-bar">
    <div id="clock">15:36</div>
    <div class="status-right">
        <div class="signal-bars">
            <div class="bar active"></div><div class="bar active"></div><div class="bar active"></div><div class="bar active"></div>
        </div>
        <div class="battery-group">
            <span class="charging-icon" id="charging-bolt">⚡</span>
            <span id="battery-text" style="font-size: 12px; margin-right: 2px;">--%</span>
            <div class="battery-shell"><div class="battery-level" id="battery-fill"></div></div>
        </div>
    </div>
</div>

<div class="home-slider">
    <div class="home-page">

        <div class="widget-weather" id="widget-weather-box">
            <div class="weather-city" onclick="openCityModal()">
                <span id="current-city">曼谷</span>
            </div>

            <div class="weather-center-content">
                <div id="weather-icon-container">
                    <svg class="weather-svg" viewBox="0 0 64 64" fill="none">
                        <circle cx="32" cy="32" r="14" fill="#FFC107" />
                        <g stroke="#FF9800" stroke-width="4" stroke-linecap="round">
                            <path d="M32 6V10 M32 54V58 M6 32H10 M54 32H58 M13.6 13.6L16.4 16.4 M47.6 47.6L50.4 50.4 M13.6 50.4L16.4 47.6 M47.6 16.4L50.4 13.6" />
                        </g>
                    </svg>
                </div>
                <div class="weather-temp">28°C</div>
                <div class="weather-desc">局部多云</div>
            </div>

            <div class="weather-date-info">
                <span id="weekday-text" class="date-row">星期二</span>
                <span id="date-text" class="date-row">11月25日</span>
            </div>
        </div>

        <div class="widget-photo" onclick="triggerPhotoUpload()">
    
            <div class="photo-placeholder" id="photo-placeholder">
                <span class="plus-icon">+</span>
                <span class="add-text">添加照片</span>
            </div>

            <div class="photo-display" id="photo-display"></div>

            <input type="file" id="photo-input" accept="image/*" style="display: none;" onchange="handlePhotoUpload(this)">
        </div>

        <div class="widget-music" id="widget-music-box">

            <div class="music-cover" id="music-cover" onclick="triggerCoverUpload()"></div>

            <div class="music-details-container">

                <div class="music-text-group" onclick="openMusicModal()">
                    <div class="song-title">Midnight City</div>
                    <div class="artist-name">M83 · Hurry Up, We're Dreaming</div>
                </div>

                <div class="progress-bar-bg">
                    <div class="progress-bar-fill"></div>
                </div>

                <div class="music-controls">
                    <button class="control-btn">
                        <svg class="ctrl-svg" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>

                    <button class="control-btn play-pause-btn" id="playPauseBtn">
                        <svg class="ctrl-svg" id="play-icon" viewBox="0 0 24 24" style="display: block;">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg class="ctrl-svg" id="pause-icon" viewBox="0 0 24 24" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>

                    <button class="control-btn">
                        <svg class="ctrl-svg" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="widget-profile">

            <div class="profile-avatar" id="profile-avatar" onclick="triggerProfileUpload()"></div>
            <input type="file" id="profile-input" accept="image/*" style="display: none;" onchange="handleProfileUpload(this)">

            <div class="profile-text">
                <div class="profile-nickname" id="profile-nickname" onclick="openProfileEditModal('nickname')">点击设置昵称</div>
                <div class="profile-signature" id="profile-signature" onclick="openProfileEditModal('signature')">点击设置个性签名</div>
            </div>

        </div>

        <div class="grid-app-item" style="grid-row: 5; grid-column: 3; transform: translateY(-35px);">
            <div class="app-icon-shape bg-wallpaper" id="icon-home-wallpaper" onclick="openApp('app-wallpaper')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_wp">壁纸</span>
        </div>

        <div class="grid-app-item" style="grid-row: 5; grid-column: 4; transform: translateY(-35px);">
            <div class="app-icon-shape bg-settings" id="icon-home-settings" onclick="openApp('app-settings')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .36.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.17 0-.36-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_set">设置</span>
        </div>

        <div class="grid-app-item" style="grid-row: 6; grid-column: 3; transform: translateY(-80px);">
            <div class="app-icon-shape bg-chat" id="icon-home-chat" onclick="openApp('app-chat')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_chat">聊天</span>
        </div>

        <div class="grid-app-item" style="grid-row: 6; grid-column: 4; transform: translateY(-80px);">
            <div class="app-icon-shape bg-music" id="icon-home-music" onclick="openApp('app-music')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>
            <span class="app-label" data-i18n="home_music">音乐</span>
        </div>

    </div>
    <div class="home-page">
        <div class="widget-countdown" id="widget-countdown-card" onclick="openCountdownModal()">
            <div class="cd-bg-image" id="cd-bg-layer"></div>
            <div class="cd-overlay"></div>
            <div class="cd-content-layer">
                <div class="cd-top-row">
                    <div class="cd-icon-box">
                        <svg class="cd-svg-icon" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"/></svg>
                    </div>
                    <span class="cd-name" id="widget-cd-title">点击设置纪念日</span>
                </div>
                <div class="cd-main-content">
                    <span class="cd-number" id="widget-cd-days">0</span>
                    <div class="cd-meta"><span class="cd-unit">DAYS</span><span class="cd-label">LEFT</span></div>
                </div>
                <div class="cd-bottom-row">
                    <span class="cd-target-date" id="widget-cd-date">YYYY-MM-DD</span>
                    <svg class="cd-arrow-icon" viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
            </div>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-diary" id="icon-home-diary" onclick="openApp('app-diary')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
            </div>
            <span class="app-label">日记</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-wallet" id="icon-home-wallet" onclick="openApp('app-wallet')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8z"/></svg>
            </div>
            <span class="app-label">钱包</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-shop" id="icon-home-shop" onclick="openApp('app-shop'); initShop();">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </div>
            <span class="app-label">购物</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-memo" id="icon-home-memo" onclick="openApp('app-memo'); initMemo();">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M3 18h12v-2H3v2zM3 6v2h18V6H3zm0 7h18v-2H3v2z"/></svg>
            </div>
            <span class="app-label">备忘录</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-forum" id="icon-home-forum" onclick="showToast('论坛')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
            </div>
            <span class="app-label">论坛</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-phone" id="icon-home-phone" onclick="openApp('app-phone'); initPhoneApp();">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
            </div>
            <span class="app-label">电话</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-companion" id="icon-home-companion" onclick="showToast('陪伴')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
            <span class="app-label">陪伴</span>
        </div>

        <div class="grid-app-item">
            <div class="app-icon-shape bg-gacha" id="icon-home-gacha" onclick="showToast('抽卡')">
                <svg class="app-svg" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
            </div>
            <span class="app-label">抽卡</span>
        </div>

        <div class="widget-voice-card" id="widget-voice-a-box">
            <div class="v-cover-box" id="voice-a-cover" onclick="triggerVoiceCover('A')">
                <span class="v-plus-mark">+</span>
            </div>

            <div class="v-wave-container" id="voice-a-wave" onclick="toggleVoicePlay('A')">
                <div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div><div class="v-bar"></div>
            </div>

            <div class="v-btn-star" onclick="triggerVoiceUpload('A')">
                <svg class="v-star-icon" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
            </div>

            <input type="file" id="input-voice-a-img" accept="image/*" hidden onchange="saveVoiceImg('A', this)">
            <input type="file" id="input-voice-a-audio" accept="audio/*" hidden onchange="saveVoiceAudio('A', this)">
        </div>
    </div>
</div>

<div class="dock-container">

    <div class="dock-icon bg-role" id="icon-dock-role" onclick="openApp('app-rolebook')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
    </div>
    <div class="dock-icon bg-world" id="icon-dock-world" onclick="openApp('app-worldbook')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    </div>
    <div class="dock-icon bg-manual" id="icon-dock-manual">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
    </div>
    <div class="dock-icon bg-gallery" id="icon-dock-gallery" onclick="openApp('app-icons')">
        <svg class="app-svg" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
    </div>

</div>

<div class="modal-overlay" id="city-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">选择城市</span>
        </div>

        <input type="text" class="search-box" id="city-search" placeholder="搜索城市 (如: 东京, 纽约)..." oninput="filterCities()">

        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('domestic')">国内</button>
            <button class="tab-btn" onclick="switchTab('international')">国际</button>
        </div>

        <div class="city-list" id="city-list-container">
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeCityModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveCitySelection()">保存</button>
        </div>
    </div>
</div>

<input type="file" id="cover-input" accept="image/*" style="display: none;">
<input type="file" id="mp3-input" accept="audio/mpeg,audio/mp3" style="display: none;">

<div class="modal-overlay" id="music-modal">
    <div class="modal-content" style="width: 90%;">
        <div class="modal-header"><span class="modal-title">编辑歌曲信息</span></div>

        <label class="modal-label">歌曲名称</label>
        <input type="text" class="search-box" id="edit-song-title" placeholder="例如: Midnight City">

        <label class="modal-label">歌手 / 专辑</label>
        <input type="text" class="search-box" id="edit-artist-name" placeholder="例如: M83">

        <label class="modal-label">音频来源</label>
        <button class="file-upload-btn" onclick="document.getElementById('mp3-input').click()">选择本地 MP3 文件</button>
        <div id="music-file-name">未选择文件</div>

        <div style="text-align: center; margin: 10px 0; opacity: 0.5;">- 或 -</div>
        <input type="text" class="search-box" id="edit-music-url" placeholder="输入在线音乐链接 (URL)">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeMusicModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveMusicInfo()">保存并播放</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="profile-modal">
    <div class="modal-content" style="width: 80%; max-width: 300px;">
        <div class="modal-header">
            <span class="modal-title" id="profile-modal-title">编辑</span>
        </div>

        <input type="text" class="search-box" id="profile-edit-input" placeholder="请输入内容...">
        <input type="hidden" id="current-edit-type">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeProfileModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveProfileText()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-wallpaper">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-wallpaper')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">壁纸设置</div>
    </div>

    <div class="wallpaper-content">

        <div>
            <div class="section-title">静态壁纸 (图片)</div>
            <div class="preview-card">
                <div class="preview-viewport">
                    <div id="wp-img-preview" style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#666;">预览</div>
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-upload" onclick="document.getElementById('wp-img-input').click()">
                        选择图片
                    </button>
                    <button class="action-btn btn-apply" id="btn-apply-img" onclick="applyWallpaper('image')">
                        设为壁纸
                    </button>
                </div>
                <input type="file" id="wp-img-input" accept="image/*" hidden onchange="handleWpPreview('image', this)">
            </div>
        </div>

        <div>
            <div class="section-title">动态壁纸 (视频)</div>
            <div class="preview-card">
                <div class="preview-viewport">
                    <video id="wp-video-preview" loop muted playsinline style="width:100%; height:100%; object-fit: cover; display:none;"></video>
                    <div id="wp-video-placeholder" style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#666;">预览</div>
                </div>
                <div class="btn-group">
                    <button class="action-btn btn-upload" onclick="document.getElementById('wp-video-input').click()">
                        选择视频
                    </button>
                    <button class="action-btn btn-apply" id="btn-apply-video" onclick="applyWallpaper('video')">
                        设为动态壁纸
                    </button>
                </div>
                <input type="file" id="wp-video-input" accept="video/mp4,video/webm" hidden onchange="handleWpPreview('video', this)">
            </div>
        </div>

    </div>
</div>

<div class="app-window" id="app-settings">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-settings')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">设置</div>
    </div>

    <div class="wallpaper-content" style="padding-top: 20px;">
        <div class="settings-list">
            <div class="settings-item" onclick="openSubPage('sub-timezone')">
                <span>日期与时间</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-timezone-label">自动</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-theme')">
                <span data-i18n="set_theme">主题</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-theme-label">深色</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-ai-model')">
                <span data-i18n="set_model">AI 模型</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-model-label">未配置</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-font')">
                <span data-i18n="set_font">字体</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="current-font-label">系统默认</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-island')">
                <span style="display:flex; align-items:center; gap:8px;">
                    <span style="background:black; border-radius:8px; width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
                        <div style="width:12px; height:4px; background:white; border-radius:2px;"></div>
                    </span>
                    灵动岛
                </span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value" id="island-status-label">已开启</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>

            <div class="settings-item" onclick="openSubPage('sub-widget-bg')">
                <span data-i18n="set_widget">组件背景</span>
                <div style="display:flex; align-items:center;">
                    <span class="item-value">自定义</span>
                    <span class="item-arrow">›</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-timezone" style="background: #1c1c1e;">

    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-timezone')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">选择时区</div>
    </div>

    <div class="search-container">
        <input type="text" class="settings-search" id="timezone-search" placeholder="搜索城市或国家" oninput="filterTimeZones()">
    </div>

    <div id="timezone-list-container" style="flex:1; overflow-y: auto;">
    </div>
</div>
<div class="toast-capsule" id="global-toast">
    <div class="toast-icon">✔</div>
    <span id="toast-text">设置成功</span>
</div>

<div class="sub-page" id="sub-theme" style="background: #1c1c1e;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-theme')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title">主题设置</div>
    </div>

    <div class="wallpaper-content">

        <div class="theme-options">
            <div class="theme-btn active" id="btn-theme-dark" onclick="switchTheme('dark')">
                深色
            </div>
            <div class="theme-btn" id="btn-theme-light" onclick="switchTheme('light')">
                浅色
            </div>
            <div class="theme-btn" id="btn-theme-custom" onclick="switchTheme('custom')">
                自定义
            </div>
        </div>

        <div class="code-editor-container" id="custom-css-area">
            <div style="color:#666; font-size:12px; margin-bottom:5px;">输入 CSS 代码 (实时覆盖):</div>
            <textarea class="code-textarea" id="css-input" placeholder="/* 例如: */
                .app-window { background: rgba(50,0,0,0.9) !important; }
                .settings-item { border-radius: 0 !important; }"></textarea>

            <button class="action-btn btn-apply" style="margin-top:10px; opacity:1; pointer-events:all; background:#4CAF50;" onclick="applyCustomCSS()">
                ⚡ 应用并保存
            </button>
        </div>

    </div>
</div>

<div class="sub-page" id="sub-ai-model" style="background: #1c1c1e;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-ai-model')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title" data-i18n="ai_set_title">模型设置</div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">

        <div class="ai-header-text">配置管理</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="renderConfigList(); openSubPage('sub-config-list')">
                <div class="ai-item-label blue">切换已保存的配置</div>
                <div class="ai-item-input" id="current-config-name" style="pointer-events:none; color:white;">默认</div>
                <span style="color:#666; font-size:14px; margin-left:8px;">›</span>
            </div>
        </div>

        <div class="ai-header-text">服务器参数</div>
        <div class="ai-group-card">
            <div class="ai-list-item">
                <div class="ai-item-label">地址</div>
                <input type="text" class="ai-item-input" id="ai-endpoint" placeholder="https://api.openai.com">
            </div>
            <div class="ai-list-item">
                <div class="ai-item-label">密钥</div>
                <input type="password" class="ai-item-input" id="ai-key" placeholder="sk-...">
            </div>
        </div>

        <div class="ai-header-text">模型</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="fetchModelList()">
                <div class="ai-item-label blue">拉取模型列表</div>
            </div>
            <div class="ai-list-item" onclick="if(typeof cachedModelList!=='undefined' && cachedModelList.length>0) openSubPage('sub-model-select'); else fetchModelList();">
                <div class="ai-item-label">当前</div>
                <div class="ai-item-input" id="display-current-model" style="pointer-events:none; color:white;">未选择</div>
                <span style="color:#666; font-size:14px; margin-left:8px;">›</span>
            </div>
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 30px;">
            <button onclick="saveAISettings()" style="flex:1; height:48px; background:#0a84ff; color:white; border:none; border-radius:12px; font-size:16px; font-weight:600;">保存配置</button>
            <button onclick="testSimpleConnection()" style="flex:1; height:48px; background:rgba(10,132,255,0.15); color:#0a84ff; border:none; border-radius:12px; font-size:16px; font-weight:600;">连接测试</button>
        </div>

        <div class="ai-header-text">对话测试</div>
        <div class="ai-test-box">
            <div class="ai-test-log" id="ai-test-log">// Ready...</div>
            <div class="ai-test-input-bar">
                <input type="text" class="ai-test-input" id="ai-test-msg" placeholder="发送测试内容...">
                <button onclick="testAIConnection()" style="width:36px; height:36px; background:#0a84ff; border-radius:50%; border:none; display:flex; align-items:center; justify-content:center;">
                    <svg style="width:16px;height:16px;fill:white; margin-left:2px;" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>

    </div>
</div>
<div class="sub-page" id="sub-model-select" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-model-select')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">选择模型</div>
    </div>

    <div class="search-container">
        <input type="text" class="settings-search" id="model-search" placeholder="搜索模型 (gpt, claude...)" oninput="renderModelList()">
    </div>

    <div id="model-list-container" style="flex:1; overflow-y: auto; padding-bottom: 40px;">
        <div style="text-align:center; color:#666; padding:40px;">请先在上一页点击“拉取”</div>
    </div>
</div>

<div class="sub-page" id="sub-config-list" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-config-list')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">我的配置</div>
    </div>

    <div id="config-list-container" style="flex:1; overflow-y: auto; padding-bottom: 40px;">
    </div>
</div>

<div class="sub-page" id="sub-font" style="background: #1c1c1e;">

    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-font')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            <span data-i18n="set_title">设置</span>
        </div>
        <div class="app-title" data-i18n="font_title">字体显示</div>
    </div>

    <div class="wallpaper-content" style="padding: 0; padding-bottom: 150px;">

        <div class="ai-header-text">效果预览</div>
        <div class="font-preview-card" id="font-preview-box">
            <span class="preview-text-en">The quick brown fox</span>
            <span class="preview-text-cn">永和九年，岁在癸丑</span>
        </div>

        <div class="ai-header-text">显示调整</div>
        <div class="slider-container">
            <div class="slider-header">
                <span>大小</span>
                <span id="val-size">16px</span>
            </div>
            <input type="range" id="range-size" min="12" max="24" step="1" value="16" oninput="updateFontConfig()">

            <div class="slider-header" style="margin-top: 20px;">
                <span>粗细</span>
                <span id="val-weight">400</span>
            </div>
            <input type="range" id="range-weight" min="100" max="900" step="100" value="400" oninput="updateFontConfig()">
        </div>

        <div class="ai-header-text">选择字体</div>
        <div class="ai-group-card" id="font-list-container">
        </div>

        <div class="ai-header-text">自定义</div>
        <div class="ai-group-card">
            <div class="ai-list-item" onclick="document.getElementById('font-file-input').click()">
                <div class="ai-item-label blue">上传字体文件 (.ttf/.otf)</div>
                <span class="ai-arrow">›</span>
            </div>
        </div>
        <input type="file" id="font-file-input" accept=".ttf,.otf,.woff,.woff2" style="display:none;" onchange="handleFontUpload(this)">

        <div class="ai-btn-group">
            <button class="ai-btn ai-btn-secondary" onclick="resetFontSettings()">恢复默认</button>
            <button class="ai-btn ai-btn-primary" onclick="showToast('✅ 字体设置已保存')">保存设置</button>
        </div>

    </div>
</div>

<div class="modal-overlay" id="config-name-modal">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">保存配置</span>
        </div>

        <div style="margin-bottom: 10px; color: rgba(255,255,255,0.6); font-size: 14px;">给当前配置起个名字：</div>

        <input type="text" class="search-box" id="config-name-input" placeholder="例如: DeepSeek 官方" style="background: rgba(255,255,255,0.1); color: white; text-align: left; padding-left: 15px;">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeConfigNameModal()">取消</button>
            <button class="modal-btn btn-save" onclick="confirmSaveConfig()">确认保存</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-island" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-island')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">灵动岛</div>
    </div>

    <div class="wallpaper-content">
        <div class="group-header">总开关</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>启用灵动岛</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-master" onchange="toggleIslandMaster()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="group-header">交互场景</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>充电提示</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-charge" onchange="saveIslandConfig()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <span>音乐播放可视化</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-island-music" onchange="saveIslandConfig()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="group-header">调试</div>
        <div class="ai-btn-group" style="margin:0;">
            <button class="ai-btn ai-btn-secondary" onclick="testIsland('charge')">测试充电动画</button>
            <button class="ai-btn ai-btn-secondary" onclick="testIsland('music')">测试音乐动画</button>
        </div>
        <div style="text-align:center; color:#666; font-size:12px; margin-top:10px;">
            点击测试按钮查看效果
        </div>
    </div>
</div>

<div class="modal-overlay" id="clear-config-modal">
    <div class="modal-content" style="width: 80%; max-width: 300px;">
        <div class="modal-header">
            <span class="modal-title" style="color: #FF3B30;">危险操作</span>
        </div>

        <div style="text-align: center; margin: 10px 0 25px 0; color: rgba(255,255,255,0.7); font-size: 14px; line-height: 1.5;">
            确定要删除所有保存的模型配置吗？<br>此操作<b>无法撤销</b>。
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeClearConfigModal()">取消</button>
            <button class="modal-btn" onclick="confirmClearConfig()" style="background: #FF3B30; color: white; font-weight: 600;">
                删除全部
            </button>
        </div>
    </div>
</div>

<div class="app-window" id="app-icons">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-icons')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">图标设置</div>
    </div>

    <div class="wallpaper-content">

        <div class="ai-header-text">主屏幕应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-wallpaper" id="preview-home-wallpaper">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </div>
                <div class="city-name">壁纸</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-wallpaper')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-wallpaper')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-settings" id="preview-home-settings">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .36.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.04-.17 0-.36-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                </div>
                <div class="city-name">设置</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-settings')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-settings')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-chat" id="preview-home-chat">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                </div>
                <div class="city-name">聊天</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-chat')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-chat')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-music" id="preview-home-music">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                <div class="city-name">音乐</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-music')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-music')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">第二页应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-diary" id="preview-home-diary">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                </div>
                <div class="city-name">日记</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-diary')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-diary')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-wallet" id="preview-home-wallet">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8z"/></svg>
                </div>
                <div class="city-name">钱包</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-wallet')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-wallet')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-shop" id="preview-home-shop">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                </div>
                <div class="city-name">购物</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-shop')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-shop')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-memo" id="preview-home-memo">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M3 18h12v-2H3v2zM3 6v2h18V6H3zm0 7h18v-2H3v2z"/></svg>
                </div>
                <div class="city-name">备忘录</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-memo')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-memo')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-forum" id="preview-home-forum">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
                </div>
                <div class="city-name">论坛</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-forum')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-forum')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-phone" id="preview-home-phone">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
                </div>
                <div class="city-name">电话</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-phone')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-phone')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-companion" id="preview-home-companion">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </div>
                <div class="city-name">陪伴</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-companion')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-companion')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape app-icon-shape bg-gacha" id="preview-home-gacha">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
                </div>
                <div class="city-name">抽卡</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('home-gacha')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('home-gacha')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">Dock 栏应用</div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-role" id="preview-dock-role" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <div class="city-name">角色书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-role')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-role')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-world" id="preview-dock-world" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="city-name">世界书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-world')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-world')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-manual" id="preview-dock-manual" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                </div>
                <div class="city-name">说明书</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-manual')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-manual')">还原</button>
            </div>
        </div>

        <div class="icon-preview-card">
            <div class="icon-info-group">
                <div class="preview-icon-shape dock-icon bg-gallery" id="preview-dock-gallery" style="border-radius: 16px;">
                    <svg class="preview-icon-svg" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
                </div>
                <div class="city-name">图标</div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" onclick="triggerIconUpload('dock-gallery')">更换</button>
                <button class="icon-btn btn-reset" onclick="resetIcon('dock-gallery')">还原</button>
            </div>
        </div>

        <input type="file" id="icon-file-input" accept="image/png,image/jpeg,image/jpg" style="display:none;" onchange="handleIconFileSelect(this)">
    </div>
</div>

<div class="app-window" id="app-rolebook">
    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-rolebook')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">角色书</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-size: 28px; cursor: pointer; font-weight: 300;" onclick="openRoleEditModal()">+</div>
    </div>

    <div class="wallpaper-content">
        <div class="role-grid" id="role-list-container">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-role-detail" style="background: #1c1c1e;">
    <div style="position: absolute; top: 50px; left: 15px; z-index: 20;">
        <div onclick="closeSubPage('sub-role-detail')" style="background: rgba(0,0,0,0.5); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">
        <div class="role-header-bg" id="role-detail-bg" onclick="triggerRoleBgUpload()"></div>
        <input type="file" id="role-bg-input" accept="image/*" hidden onchange="handleRoleBgUpload(this)">

        <div class="role-avatar-container">
            <div class="role-big-avatar" id="role-detail-avatar"></div>
        </div>

        <div class="role-detail-content">
            <div class="role-detail-name" id="role-detail-name">角色名</div>
            <div class="role-detail-desc" id="role-detail-desc">人设详情...</div>

            <div class="ai-btn-group" style="margin-top: 40px;">
                <button class="ai-btn ai-btn-secondary" style="color: #FF3B30; background: rgba(255, 59, 48, 0.1);" onclick="deleteCurrentRole()">删除角色</button>
                <button class="ai-btn ai-btn-primary" onclick="editCurrentRole()">编辑资料</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-role-edit">
    <div class="modal-content" style="width: 90%; max-height: 85%;">
        <div class="modal-header">
            <span class="modal-title" id="role-modal-title">新建角色</span>
        </div>

        <div style="overflow-y: auto; flex: 1;">
            <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                <div id="role-edit-avatar-preview" onclick="document.getElementById('role-avatar-input').click()"
                     style="width: 80px; height: 80px; border-radius: 50%; background: #333; border: 2px dashed #666; display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center;">
                    <span style="font-size: 24px; color: #666;">+</span>
                </div>
                <input type="file" id="role-avatar-input" accept="image/*" hidden onchange="previewRoleAvatar(this)">
            </div>

            <div class="ai-item-label" style="margin-bottom: 5px;">昵称</div>
            <input type="text" class="search-box" id="role-edit-name" placeholder="角色名字" style="text-align: left; padding-left: 10px;">

            <div class="ai-item-label" style="margin: 15px 0 5px 0;">人设详情</div>
            <textarea class="code-textarea" id="role-edit-desc" placeholder="输入详细设定..." style="height: 150px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; font-family: inherit; font-size: 15px;"></textarea>
        </div>

        <div class="modal-footer" style="margin-top: 15px;">
            <button class="modal-btn btn-cancel" onclick="closeRoleModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveRoleData()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-worldbook">
    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-worldbook')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">世界书</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-size: 28px; cursor: pointer; font-weight: 300;" onclick="openWorldEditModal()">+</div>
    </div>

    <div class="wallpaper-content">
        <div id="world-list-container">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-world-detail" style="background: #1c1c1e;">
    <div class="app-header" style="background: #1c1c1e; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-world-detail')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">设定详情</div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">
        <div class="world-detail-container">
            <div class="world-detail-header" id="view-world-title">标题</div>
            <div class="world-detail-body" id="view-world-content">内容...</div>

            <div class="ai-btn-group" style="margin-top: 30px;">
                <button class="ai-btn ai-btn-secondary" style="color: #FF3B30; background: rgba(255, 59, 48, 0.1);" onclick="deleteCurrentWorld()">删除</button>
                <button class="ai-btn ai-btn-primary" onclick="editCurrentWorld()">编辑</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-world-edit">
    <div class="modal-content" style="width: 90%; max-height: 85%;">
        <div class="modal-header">
            <span class="modal-title" id="world-modal-title">新建设定</span>
        </div>

        <div style="flex: 1; overflow-y: auto;">
            <div class="ai-item-label" style="margin-bottom: 5px;">设定名称</div>
            <input type="text" class="search-box" id="world-edit-title" placeholder="例如: 魔法体系、地理环境" style="text-align: left; padding-left: 10px;">

            <div class="ai-item-label" style="margin: 15px 0 5px 0;">详细内容</div>
            <textarea class="code-textarea" id="world-edit-content" placeholder="输入详细的世界观设定..." style="height: 300px; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; font-family: inherit; font-size: 15px; line-height: 1.6;"></textarea>
        </div>

        <div class="modal-footer" style="margin-top: 15px;">
            <button class="modal-btn btn-cancel" onclick="closeWorldModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveWorldData()">保存</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-music">

    <div id="music-view-list">
        <div class="app-header" style="background:transparent; border-bottom:none;">
            <div class="app-back-btn" onclick="closeApp('app-music')">
                <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                主屏幕
            </div>
            <div class="app-title" style="color:white;">音乐库</div>

            <div class="header-add-btn" onclick="openMusicUploadModal()">
                <svg style="width:18px;height:18px;fill:white;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
        </div>

        <div class="wallpaper-content" id="app-music-list-container" style="padding-bottom: 120px;">
        </div>

        <div class="mini-player" id="mini-player-bar" onclick="openFullPlayer()">
            <div class="mini-cover" id="mini-cover"></div>
            <div class="mini-info">
                <div class="mini-title" id="mini-title">未播放</div>
                <div class="mini-artist" id="mini-artist">--</div>
            </div>
            <div class="mini-controls">
                <button class="mini-btn" onclick="event.stopPropagation(); togglePlayState()" id="mini-play-btn">
                    <svg id="mini-icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="mini-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <button class="mini-btn" onclick="event.stopPropagation(); playNextSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="music-view-full">
        <div id="full-player-bg"></div>

        <div class="full-player-header" style="padding: 50px 20px 0 20px; display:flex; justify-content:space-between; align-items:center;">
            <div class="fp-btn" onclick="closeFullPlayer()">
                <svg viewBox="0 0 24 24" fill="white" width="30" height="30"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            </div>
            <div class="fp-actions" style="display:flex;">
                <button class="fp-icon-btn" onclick="triggerMusicBgUpload()">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </button>
                <button class="fp-icon-btn" onclick="openListenTogetherPage()">
                    <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                </button>
            </div>
            <input type="file" id="music-bg-input" accept="image/*" hidden onchange="handleMusicBgUpload(this)">
        </div>

        <div class="full-player-content">
            <div class="disk-wrapper">
                <div class="disk-cover" id="full-cover"></div>
            </div>

            <div style="width:100%; text-align:left; margin-bottom:10px;">
                <div class="fp-title" id="full-title" style="font-size:24px; font-weight:700; color:white; margin-bottom:5px;">Song Name</div>
                <div class="fp-artist" id="full-artist" style="font-size:16px; color:rgba(255,255,255,0.6);">Artist</div>
            </div>

            <div class="lyrics-box" onclick="openLyricsModal()" style="height:40px; color:rgba(255,255,255,0.8);">
                <span id="current-lyric-line">暂无歌词 - 点击添加</span>
            </div>

            <div class="fp-progress-container">
                <input type="range" class="fp-slider" id="music-slider" min="0" value="0" max="100" oninput="seekAudio(this.value)">
                <div class="time-row">
                    <span id="time-current">0:00</span>
                    <span id="time-total">0:00</span>
                </div>
            </div>

            <div class="fp-controls">
                <button class="fp-ctrl-btn small" onclick="togglePlayMode()">
                    <svg id="icon-mode-0" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    <svg id="icon-mode-1" viewBox="0 0 24 24" style="display:none"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2V9h-1l-2 1v1h1.5v4H13z"/></svg>
                    <svg id="icon-mode-2" viewBox="0 0 24 24" style="display:none"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                </button>

                <button class="fp-ctrl-btn" onclick="playPrevSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>

                <button class="fp-ctrl-btn big" onclick="togglePlayState()" id="full-play-btn">
                    <svg id="fp-icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="fp-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>

                <button class="fp-ctrl-btn" onclick="playNextSong()">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>

                <button class="fp-ctrl-btn small" onclick="openPlaylistSheet()">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-music-upload">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">添加歌曲</span></div>
        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div id="upload-cover-preview" onclick="document.getElementById('new-song-cover').click()"
                 style="width:70px; height:70px; background:rgba(255,255,255,0.1); border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover;">
                <span style="font-size:24px; color:rgba(255,255,255,0.5);">+</span>
            </div>
            <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                <input type="text" class="search-box" id="new-song-title" placeholder="歌曲名称" style="margin:0;">
                <input type="text" class="search-box" id="new-song-artist" placeholder="歌手" style="margin:0;">
            </div>
        </div>
        <input type="file" id="new-song-cover" accept="image/*" hidden onchange="previewNewSongCover(this)">

        <div class="ai-item-label" style="margin-bottom:5px;">音频来源</div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="tab-btn active" onclick="switchAudioSource('file')" id="btn-src-file">本地文件</button>
            <button class="tab-btn" onclick="switchAudioSource('url')" id="btn-src-url">在线 URL</button>
        </div>

        <div id="src-file-area" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 12px;">
            <button class="file-upload-btn" onclick="document.getElementById('new-song-file').click()">选择 MP3 文件</button>
            <div id="new-song-filename" style="font-size:12px; color:#999; margin-top:5px;">未选择</div>
            <input type="file" id="new-song-file" accept="audio/*" hidden onchange="handleNewSongFile(this)">
        </div>
        <div id="src-url-area" style="display:none; margin-top: 15px;">
            <input type="text" class="search-box" id="new-song-url" placeholder="https://example.com/music.mp3">
        </div>

        <div class="modal-footer" style="margin-top:20px;">
            <button class="modal-btn btn-cancel" onclick="closeMusicUploadModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveNewSong()">保存</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-lyrics">
    <div class="modal-content" style="height:70%;">
        <div class="modal-header"><span class="modal-title">编辑歌词</span></div>
        <textarea class="code-textarea" id="lyrics-input" placeholder="在此粘贴歌词..." style="height:100%; margin-bottom:15px;"></textarea>
        <div class="modal-footer" style="justify-content: space-between;">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('lrc-file').click()">📂 导入 LRC</button>
            <input type="file" id="lrc-file" accept=".lrc,.txt" hidden onchange="handleLrcFile(this)">

            <div style="display:flex; gap:10px;">
                <button class="modal-btn btn-save" onclick="saveLyrics()">保存</button>
                <button class="modal-btn btn-cancel" onclick="document.getElementById('modal-lyrics').classList.remove('active'); setTimeout(()=>document.getElementById('modal-lyrics').style.display='none',300);">关闭</button>
            </div>
        </div>
    </div>
</div>

<div class="sub-page" id="sheet-playlist" style="top:auto; bottom:0; height:60vh; border-radius:24px 24px 0 0; transform:translateY(100%); transition:transform 0.3s; background:#1c1c1e; z-index:900;">
    <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; font-size:18px; color:white;">播放列表</span>
        <span onclick="closePlaylistSheet()" style="cursor:pointer; padding:5px; color:#0a84ff;">关闭</span>
    </div>
    <div id="sheet-list-content" style="overflow-y:auto; height:calc(100% - 60px); padding:10px;"></div>
</div>
<div class="modal-overlay" id="modal-song-menu" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closeSongMenu()"></div>

    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="openEditSongModal()">
                <span style="color: #0a84ff;">编辑歌曲信息</span>
            </div>
            <div class="sheet-item" onclick="openDeleteConfirmModal()" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #FF3B30;">删除歌曲</span>
            </div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closeSongMenu()" style="font-weight: 600;">
                取消
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-edit-song">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">编辑信息</span>
        </div>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">歌曲名称</div>
                <input type="text" class="search-box" id="edit-title-input" style="margin:0;">
            </div>
            <div>
                <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">歌手 / 专辑</div>
                <input type="text" class="search-box" id="edit-artist-input" style="margin:0;">
            </div>
        </div>

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeEditSongModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveSongEdit()">保存修改</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-delete-confirm">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 20px;">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">删除歌曲</div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 25px; line-height: 1.5;">
            确定要删除 <span id="del-song-name" style="color:white;">这首歌</span> 吗？<br>此操作无法恢复。
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeDeleteConfirmModal()">取消</button>
            <button class="modal-btn" onclick="confirmDeleteSong()" style="background: #FF3B30; color: white; border: none;">删除</button>
        </div>
    </div>
</div>
<div id="island-popup-mask" onclick="closeIslandPopup()"></div>

<div id="island-popup-player" class="island-popup">
    <div class="popup-backdrop"></div>

    <div class="popup-content">
        <div class="popup-top">
            <div class="popup-cover" id="popup-cover"></div>

            <div class="popup-info">
                <div class="popup-title" id="popup-title">Song Name</div>
                <div class="popup-artist" id="popup-artist">Artist</div>
            </div>

            <div style="display:flex; align-items:center;">
                <button class="popup-icon-btn" onclick="openPlaylistSheet(); closeIslandPopup();">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                </button>

                <button class="btn-close-popup" onclick="closeIslandPopup()">
                    <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
        </div>

        <div class="popup-progress">
            <span class="time-tiny" id="popup-time-current">0:00</span>
            <input type="range" class="fp-slider popup-slider" id="popup-slider" min="0" value="0" max="100" oninput="seekAudio(this.value)">
            <span class="time-tiny" id="popup-time-total">0:00</span>
        </div>

        <div class="popup-controls">
            <button class="popup-btn" onclick="playPrevSong()">
                <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </button>

            <button class="popup-btn big" onclick="togglePlayState()" id="popup-play-btn">
                <svg id="popup-icon-play" viewBox="0 0 24 24" style="margin-left:2px;"><path d="M8 5v14l11-7z"/></svg>
                <svg id="popup-icon-pause" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>

            <button class="popup-btn" onclick="playNextSong()">
                <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-listen-together" style="background: #121212; z-index: 300;">

    <div class="app-header" style="background: transparent; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-listen-together')">
            <svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
        </div>
        <div class="app-title">一起听</div>
    </div>

    <div class="listen-visualizer">
        <div class="visual-avatar-box left-box">
            <div class="visual-avatar empty" id="listen-role-avatar" onclick="openListenRoleSelector()">
                <span>+</span>
            </div>
            <div class="visual-name" id="listen-role-name">点击选择</div>
        </div>

        <div class="connection-bridge left-bridge" id="bridge-left">
            <svg class="bridge-svg" preserveAspectRatio="none" viewBox="0 0 100 60">
                <path class="line-path" d="M0,30 L40,30 L50,10 L60,50 L70,30 L100,30" />
            </svg>
        </div>

        <div class="visual-heart-center">
            <svg class="visual-heart-icon-red" viewBox="0 0 24 24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        </div>

        <div class="connection-bridge right-bridge">
            <svg class="bridge-svg" preserveAspectRatio="none" viewBox="0 0 100 60">
                <path class="line-path" d="M0,30 L30,30 L40,10 L50,50 L60,30 L100,30" />
            </svg>
        </div>

        <div class="visual-avatar-box right-box">
            <div class="visual-avatar active-me" id="listen-user-avatar" onclick="openListenUserEdit()">
                <span style="font-size: 16px; font-weight:600;">Me</span>
            </div>
            <div class="visual-name" id="listen-user-name">我</div>
        </div>
    </div>

    <div class="listen-timer-box">
        <span class="timer-label">一起听时长</span>
        <span id="listen-timer-text">00:00</span>
    </div>

    <div class="listen-chat-area" id="listen-chat-box">
        <div class="chat-msg system">
            <span>开始一起听歌吧~</span>
        </div>
    </div>

    <div class="listen-input-wrapper">
        <div class="listen-input-bar">
            <input type="text" id="listen-input" placeholder="说点什么...">
            <button class="listen-icon-btn magic-btn" onclick="triggerAiReply()">
                <svg viewBox="0 0 24 24"><path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/></svg>
            </button>
            <button class="listen-icon-btn send-btn" onclick="sendListenMessage()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
        <div class="listen-clear-btn" onclick="clearListenChat()">
            清空聊天记录
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-select-role">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">选择角色</span></div>
        <div id="listen-role-list" style="max-height: 300px; overflow-y: auto;">
        </div>
        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-select-role')">取消</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-edit-user">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">完善我的信息</span></div>

        <div style="display:flex; justify-content:center; margin-bottom:15px;">
            <div id="edit-user-preview" onclick="document.getElementById('listen-user-file').click()"
                 style="width:80px; height:80px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover;">
                📷
            </div>
            <input type="file" id="listen-user-file" accept="image/*" hidden onchange="previewListenUserAvatar(this)">
        </div>

        <div class="ai-item-label" style="margin-bottom:5px;">昵称</div>
        <input type="text" class="search-box" id="listen-user-nick-input" style="margin:0;">

        <div class="ai-item-label" style="margin:10px 0 5px 0;">身份/设定</div>
        <input type="text" class="search-box" id="listen-user-identity-input" placeholder="例如: 你的同学" style="margin:0;">

        <div class="modal-footer" style="margin-top:20px;">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-edit-user')">取消</button>
            <button class="modal-btn btn-save" onclick="saveListenUser()">保存</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-countdown">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">倒数日设置</span>
        </div>

        <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">事件名称</div>
        <input type="text" class="search-box" id="input-cd-title" placeholder="例如: 恋爱纪念日" style="margin-bottom:15px;">

        <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">目标日期</div>
        <input type="date" class="search-box" id="input-cd-date" style="background:rgba(255,255,255,0.1); color:white; margin-bottom:15px;">

        <div class="ai-item-label" style="font-size:12px; color:#888; margin-bottom:5px;">背景图片 (可选)</div>
        <div class="settings-item" onclick="document.getElementById('input-cd-bg').click()" style="border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:10px; justify-content:center;">
            <span style="color:#0a84ff;">📷 更换背景图</span>
        </div>
        <input type="file" id="input-cd-bg" accept="image/*" hidden onchange="handleCdBgUpload(this)">

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeCountdownModal()">取消</button>
            <button class="modal-btn btn-save" onclick="saveCountdown()">保存</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-widget-bg" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-widget-bg')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            设置
        </div>
        <div class="app-title">组件背景</div>
    </div>

    <div class="wallpaper-content">
        <div style="font-size:13px; color:#888; margin:0 0 20px 5px; line-height:1.4;">
            为组件设置背景图后，将自动移除原本的磨砂玻璃效果。
        </div>

        <div class="ai-header-text">天气</div>
        <div class="widget-set-card">
            <div class="widget-preview-box ratio-square">
                <div class="widget-preview-shape" id="preview-widget-weather">
                    <span class="widget-preview-text">天气组件预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="triggerWidgetBgUpload('weather')">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetWidgetBg('weather')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">音乐</div>
        <div class="widget-set-card">
            <div class="widget-preview-box ratio-rect">
                <div class="widget-preview-shape" id="preview-widget-music">
                    <span class="widget-preview-text">音乐组件预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="triggerWidgetBgUpload('music')">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetWidgetBg('music')">还原</button>
            </div>
        </div>

        <div class="ai-header-text">语音条 (第二页)</div>
        <div class="widget-set-card">
            <div class="widget-preview-box ratio-strip">
                <div class="widget-preview-shape" id="preview-widget-voice-a">
                    <span class="widget-preview-text">语音组件预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="triggerWidgetBgUpload('voice-a')">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetWidgetBg('voice-a')">还原</button>
            </div>
        </div>

        <input type="file" id="input-widget-bg" accept="image/*" hidden onchange="handleWidgetBgFile(this)">
    </div>
</div>

<div class="modal-overlay" id="modal-reset-widget">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 25px 20px;">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">还原默认样式</div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 25px; line-height: 1.5;">
            确定要移除背景图片，恢复默认的毛玻璃效果吗？
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeResetModal()">取消</button>
            <button class="modal-btn" onclick="confirmResetExec()" style="background: #FF3B30; color: white;">还原</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-chat">

    <div class="app-header" style="background: transparent; border-bottom: none; z-index: 60;">
        <div class="app-back-btn" id="chat-back-btn" onclick="closeApp('app-chat')">
            <svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
            主屏幕
        </div>

        <div class="app-title" style="color:white; font-weight:600;">聊天</div>

        <div class="header-right-group">

            <div class="header-icon-btn" id="btn-moment-bell" onclick="openActivityPage()" style="display:none;">
                <svg viewBox="0 0 24 24"><path d="M20 17H22V19H2V17H4V10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10V17ZM18 17V10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10V17H18ZM9 21H15V23H9V21Z"></path></svg>
            </div>

            <div id="chat-header-action-btn" class="header-text-btn" onclick="openChatTypeMenu()">
                +
            </div>
        </div>
    </div>

    <!-- 2. 主体内容区 (Message 模块) -->
    <!-- 只有当底部选“消息”时显示 -->
    <div id="chat-module-msg" class="chat-module-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">

        <!-- 顶部圆角选项卡 (只在消息页显示) -->
        <div class="chat-top-tabs-container">
            <div class="chat-tab-btn active" onclick="switchChatTopTab('list')">消息列表</div>
            <div class="chat-tab-btn" onclick="switchChatTopTab('group')">群聊</div>
            <div class="chat-tab-btn" onclick="switchChatTopTab('friend')">好友</div>
        </div>

        <!-- 2.1 消息列表视图 -->
        <div class="chat-page-content active" id="view-chat-list">
            <div class="chat-placeholder-text">暂无消息<br>找个好友聊聊天吧</div>
            <!-- 这里以后放真正的消息列表 -->
        </div>

        <!-- 2.2 群聊视图 -->
        <div class="chat-page-content" id="view-chat-group">
            <div class="chat-placeholder-text">暂无群聊</div>
        </div>

        <!-- 2.3 好友视图 (角色列表) -->
        <div class="chat-page-content" id="view-chat-friend">
            <div class="chat-placeholder-text">好友列表加载中...</div>
        </div>
    </div>

    <!-- 3. 动态模块 -->
    <div id="chat-module-moments" class="chat-module-container" style="flex:1; display:none; flex-direction:column; overflow:hidden;">

        <div class="status-flow-container">
        </div>

        <div id="ig-feed-list" class="feed-list-container" style="flex:1; overflow-y:auto;">
        </div>
    </div>

    <!-- 4. 我的模块 -->
    <div id="chat-module-me" class="chat-module-container" style="flex:1; display:none; padding-top:20px;">

        <div class="wallpaper-content" style="padding: 0 16px;">

            <div class="group-header" style="margin-top: 0;">我的名片</div>
            <div class="ai-group-card" id="my-profile-card">
            </div>

            <div class="group-header" style="margin-top: 30px;">互动与个性化</div>
            <div class="ai-group-card">

                <div class="ai-list-item" onclick="openMyFavorites()">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:30px; height:30px; background:rgba(255,214,10,0.15); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                            <svg style="width:18px; height:18px; fill:#FFD60A;" viewBox="0 0 24 24"><path d="M12 18.26l-7.053 3.948 1.575-7.928L.587 8.792l8.027-.952L12 .5l3.386 7.34 8.027.952-5.935 5.488 1.575 7.928z"/></svg>
                        </div>
                        <span class="ai-item-label">我的收藏</span>
                    </div>
                    <span style="color:rgba(255,255,255,0.3); font-size:14px;">›</span>
                </div>

                <div class="ai-list-item" onclick="openMyLikes()">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:30px; height:30px; background:rgba(255,59,48,0.15); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                            <svg style="width:18px; height:18px; fill:#FF3B30;" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </div>
                        <span class="ai-item-label">我的点赞</span>
                    </div>
                    <span style="color:rgba(255,255,255,0.3); font-size:14px;">›</span>
                </div>

                <div class="ai-list-item" onclick="openBeautifyCenter()">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:30px; height:30px; background:rgba(10,132,255,0.15); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                            <svg style="width:18px; height:18px; fill:#0a84ff;" viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 0 18c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                        </div>
                        <span class="ai-item-label">个性美化</span>
                    </div>
                    <span style="color:rgba(255,255,255,0.3); font-size:14px;">›</span>
                </div>

            </div>
        </div>
        <input type="file" id="profile-bg-input" accept="image/*" hidden onchange="handleProfileBgUpload(this)">
    </div>

    <!-- 5. 底部悬浮导航栏 -->
    <div class="chat-bottom-nav">
        <!-- 消息 -->
        <div class="chat-nav-item active" onclick="switchChatBottomNav('msg', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
            <span class="chat-nav-text">消息</span>
        </div>
        <!-- 动态 -->
        <div class="chat-nav-item" onclick="switchChatBottomNav('moments', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
            <span class="chat-nav-text">动态</span>
        </div>
        <!-- 我的 -->
        <div class="chat-nav-item" onclick="switchChatBottomNav('me', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span class="chat-nav-text">我的</span>
        </div>
    </div>

</div>

<div class="modal-overlay" id="modal-chat-type" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closeChatTypeMenu()"></div>
    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="openCreateSingleModal()">
                <span style="font-weight:600;">单人聊天</span>
            </div>
            <div class="sheet-item" onclick="openCreateGroupModal()" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <span style="font-weight:600;">群组聊天</span>
            </div>
        </div>
        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closeChatTypeMenu()" style="font-weight: 600;">取消</div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-create-single" style="background: #1c1c1e;">
    <div class="app-header" style="background:inherit; border-bottom:none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-create-single')">取消</div>
        <div class="app-title">创建单聊</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-weight: 600;" onclick="saveSingleChat()">完成</div>
    </div>

    <div class="wallpaper-content">
        <div class="create-chat-tabs">
            <div class="create-chat-tab active" onclick="switchSingleTab('custom', this)">自定义创建</div>
            <div class="create-chat-tab" onclick="switchSingleTab('import', this)">从角色书导入</div>
        </div>

        <div id="single-custom-area">
            <div class="chat-avatar-upload" id="single-avatar-preview" onclick="document.getElementById('input-single-avatar').click()">
                <span class="chat-avatar-icon">+</span>
            </div>
            <input type="file" id="input-single-avatar" accept="image/*" hidden onchange="previewChatAvatar('single-avatar-preview', this)">

            <div class="settings-group">
                <div class="settings-item">
                    <span>昵称</span>
                    <input type="text" id="input-single-name" placeholder="请输入名字" style="border:none; background:transparent; color:white; text-align:right; outline:none;">
                </div>
            </div>
        </div>

        <div id="single-import-area" style="display:none; overflow-y:auto; height:calc(100vh - 200px);">
            <div id="import-role-list-single"></div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-create-group" style="background: #1c1c1e;">
    <div class="app-header" style="background:inherit; border-bottom:none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-create-group')">取消</div>
        <div class="app-title">创建群聊</div>
        <div style="position: absolute; right: 15px; top: 55px; color: #0a84ff; font-weight: 600;" onclick="saveGroupChat()">完成</div>
    </div>

    <div class="wallpaper-content">
        <div class="settings-group" style="margin-bottom:15px;">
            <div class="settings-item">
                <span>群名称</span>
                <input type="text" id="input-group-name" placeholder="例如: 摸鱼小分队" style="border:none; background:transparent; color:white; text-align:right; outline:none;">
            </div>
        </div>

        <div class="create-chat-tabs">
            <div class="create-chat-tab active" onclick="switchGroupTab('custom', this)">自定义成员</div>
            <div class="create-chat-tab" onclick="switchGroupTab('import', this)">从角色书选择</div>
        </div>

        <div id="group-custom-area">
            <div class="settings-group">
                <div class="settings-item">
                    <span>群成员数量</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="icon-btn" style="background:rgba(255,255,255,0.1);" onclick="adjustMemberCount(-1)">-</button>
                        <span id="group-member-count" style="width:20px; text-align:center;">3</span>
                        <button class="icon-btn" style="background:rgba(255,255,255,0.1);" onclick="adjustMemberCount(1)">+</button>
                    </div>
                </div>
            </div>
            <div style="margin:10px 0 5px 5px; font-size:12px; color:#888;">成员信息设置</div>
            <div id="group-custom-list">
            </div>
        </div>

        <div id="group-import-area" style="display:none; overflow-y:auto; height:calc(100vh - 300px);">
            <div id="import-role-list-group"></div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-chat-delete" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-chat-delete')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title" style="color: #FF3B30;">删除聊天</div>
    </div>

    <div class="wallpaper-content" style="display: flex; flex-direction: column; align-items: center; padding-top: 60px;">

        <div style="width: 80px; height: 80px; background: rgba(255, 59, 48, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <svg style="width: 40px; height: 40px; fill: #FF3B30;" viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
        </div>

        <div style="font-size: 20px; font-weight: 600; color: white; margin-bottom: 10px;">
            删除该对话？
        </div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); text-align: center; max-width: 80%; line-height: 1.5;">
            删除后，您将无法查看与 <span id="del-chat-target-name" style="color:white; font-weight:bold;"></span> 的聊天记录。<br>此操作不可撤销。
        </div>

        <div style="position: absolute; bottom: 50px; width: 90%; display: flex; flex-direction: column; gap: 15px;">
            <button class="ai-btn" onclick="confirmDeleteChatAction()" style="background: #FF3B30; color: white;">
                确认删除
            </button>
            <button class="ai-btn ai-btn-secondary" onclick="closeSubPage('sub-chat-delete')" style="background: rgba(255,255,255,0.1); color: white;">
                取消
            </button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-chat-detail">

    <div id="chat-input-menu">
        <div class="chat-scroll-menu">

            <div class="menu-pill-card" onclick="handleMenuAction('photo')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                <span class="pill-text">Photo</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('voice')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3.9-3.23 6.9-7.3 6.9S4.7 13.9 4.7 11H3c0 4.1 3.5 7.5 8 8v3h2v-3c4.5-.5 8-3.9 8-8h-1.7z"/></svg>
                <span class="pill-text">Voice</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('emoji')">
                <svg class="pill-icon" viewBox="0 0 24 24">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                </svg>
                <span class="pill-text">Emoji</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('video')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                <span class="pill-text">Video</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('location')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                <span class="pill-text">Location</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('money')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-3-6c0-1.1-.9-2-2-2H9v-2h4v1h2V7H9v2H7v-2H5v2H9c1.1 0 2 .9 2 2v4h6v-4h-4v-1h4v-2z"/></svg>
                <span class="pill-text">Money</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('heart')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span class="pill-text">Heart</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('shop')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                <span class="pill-text">Shop</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('gift')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20 9H4v2h16V9zm-1 5H5v-2h14v2zm-1 4H5v-2h14v2zM21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H3V6h18v12z"/></svg>
                <span class="pill-text">Gift</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('game')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20 6h-8v4H8V6H4v4H2v10h2v-3h2v-1h4v-2h2v4h8V6zm0 12h-8v-4h4v2h2v-2h2v2zm-4-8h-4V6h4v4z"/></svg>
                <span class="pill-text">Game</span>
            </div>

            <div class="menu-pill-card" onclick="handleMenuAction('phone')">
                <svg class="pill-icon" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
                <span class="pill-text">Phone</span>
            </div>

        </div>
    </div>

    <div id="custom-sticker-panel" style="display:none;">
        <div class="sticker-header-bar">
            <span style="font-weight:600; font-size:14px;">我的表情</span>

            <div style="display: flex; gap: 10px;">
                <div id="btn-sticker-delete-mode" onclick="toggleStickerMultiSelect()" title="多选删除">
                    <svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </div>

                <div class="btn-close-sticker" onclick="toggleStickerPanel()">×</div>
            </div>
        </div>
        
        <div class="sticker-grid-container" id="sticker-grid-view">
            <div class="sticker-item add-btn" onclick="document.getElementById('sticker-file-input').click()">
                <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:rgba(255,255,255,0.5)"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
        </div>
        <input type="file" id="sticker-file-input" accept="image/*" style="display:none;" onchange="handleStickerUpload(this)">
    </div>
    <div class="chat-detail-footer">
        </div>

    <div class="chat-detail-header">
        <div class="glass-circle-btn" onclick="closeSubPage('sub-chat-detail')">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>

        <div class="chat-user-info">
            <div id="chat-header-avatar-wrap" class="chat-user-avatar-wrap">
                <div class="chat-user-avatar" id="chat-detail-avatar"></div>
            </div>
            <div class="chat-user-name" id="chat-detail-name">用户名称</div>
            <div class="chat-user-status">Online</div>
        </div>

        <div class="glass-circle-btn" onclick="openChatSettings()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </div>
    </div>

    <div class="chat-detail-body" id="chat-detail-msgs">
        <div class="chat-msg system"><span>2月26日 16:20</span></div>
        <div class="chat-msg left"><div class="msg-bubble-listen">你好呀！最近怎么样？</div></div>
        <div class="chat-msg right"><div class="msg-bubble-listen">挺好的，刚刚在听歌。</div></div>
    </div>

    <div id="quote-preview-bar">
        <div id="quote-content-box">
            <span class="quote-title">回复 用户名:</span>
            <span class="quote-text" id="quote-preview-content">引用内容...</span>
        </div>
        <div class="btn-close-quote" onclick="cancelQuote()">×</div>
    </div>

    <div class="chat-detail-footer">
        <button class="chat-footer-btn" onclick="toggleInputMenu()">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </button>

        <div class="chat-input-pill">
            <input type="text" class="chat-input-real" id="chat-msg-input" placeholder="发消息...">
        </div>

        <button class="chat-footer-btn" onclick="triggerChatDetailAI()">
            <svg viewBox="0 0 24 24">
                <path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/>
            </svg>
        </button>

        <button class="chat-footer-btn" onclick="sendChatDetailMsg()">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>

    <div id="batch-action-bar">
        <div style="font-size:16px; color:#0a84ff; font-weight:500; cursor:pointer;" onclick="exitMultiSelectMode()">取消</div>
        <div style="font-size:16px; color:white; font-weight:600;" id="batch-select-count">已选 0 项</div>
        <div style="width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="confirmBatchDelete()">
            <svg style="width:24px; height:24px; fill:#FF3B30;" viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
        </div>
    </div>

</div>

<div class="sub-page" id="sub-create-moment" style="background: #1c1c1e; z-index: 600;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-create-moment')">取消</div>
        <div class="app-title">发布动态</div>
        <div style="position: absolute; right: 15px; top: 55px;">
            <button class="ai-btn ai-btn-primary" onclick="publishMoment()"
                    style="height: 32px; padding: 0 15px; font-size: 14px; border-radius: 16px;">
                发布
            </button>
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">

        <textarea id="moment-caption" class="moment-textarea" placeholder="分享当下的想法..."></textarea>

        <div class="moment-upload-grid" id="moment-upload-container">
        </div>

        <input type="file" id="moment-file-input" accept="image/*" multiple hidden onchange="handleMomentImages(this)">
    </div>
</div>

<div class="sub-page" id="sub-moment-detail" style="background: #1c1c1e; z-index: 650;">

    <div class="app-header" style="background: inherit; border-bottom: 1px solid rgba(255,255,255,0.05);">
        <div class="app-back-btn" onclick="closeSubPage('sub-moment-detail')">返回</div>
        <div class="app-title">详情</div>
    </div>

    <div class="wallpaper-content" style="padding: 0; display:flex; flex-direction:column; overflow:hidden;">
        <div id="moment-detail-scroll-area" style="flex:1; overflow-y:auto;">
            <div id="moment-detail-card-container" class="detail-post-wrapper"></div>

            <div style="padding: 15px 16px 5px 16px; font-size:13px; color:rgba(255,255,255,0.5); font-weight:600;">全部评论</div>

            <div id="moment-comment-list" class="comments-list-container">
            </div>
        </div>
    </div>

    <div class="moment-footer-input">
        <div class="chat-input-pill">
            <input type="text" class="chat-input-real" id="moment-reply-input" placeholder="说点好听的...">
        </div>
        <button class="chat-footer-btn" onclick="sendMomentComment()" style="width:auto; padding:0 10px;">
            <svg style="width:24px;height:24px;fill:#0a84ff;" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>
</div>

<div class="modal-overlay" id="modal-message-menu" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closeMessageMenu()"></div>

    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="handleMessageAction('quote')">引用 (Quote)</div>
            <div class="sheet-item" onclick="handleMessageAction('forward')">转发 (Forward)</div>
            <div class="sheet-item" onclick="handleMessageAction('favorite')">收藏 (Favorite)</div>
            <div class="sheet-item" onclick="handleMessageAction('edit')">编辑 (Edit)</div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="handleMessageAction('recall')">撤回 (Recall)</div>
            <div class="sheet-item" onclick="handleMessageAction('delete')">删除 (Delete)</div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="handleMessageAction('multi-select')">多选 (Multi-select)</div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closeMessageMenu()" style="font-weight: 600;">取消</div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-chat-settings" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-chat-settings')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">聊天设置</div>
        <div style="position:absolute; right:15px; color:#0a84ff; font-weight:600; cursor:pointer;" onclick="saveChatSettingsDetail()">保存</div>
    </div>

    <div class="wallpaper-content">

        <div class="group-header">聊天背景</div>
        <div class="widget-set-card">
            <div class="widget-preview-box" style="aspect-ratio: 16/9; height: 150px;">
                <div class="widget-preview-shape" id="preview-chat-bg" style="width:100%; height:100%; border-radius: 12px; background-size: cover; background-position: center;">
                    <span class="widget-preview-text">当前背景预览</span>
                </div>
            </div>
            <div class="icon-btn-group">
                <button class="icon-btn btn-change" style="flex:1;" onclick="document.getElementById('input-chat-bg').click()">更换图片</button>
                <button class="icon-btn btn-reset" onclick="resetChatBackground()">恢复默认</button>
            </div>
        </div>

        <input type="file" id="input-chat-bg" accept="image/*" hidden onchange="handleChatBgUpload(this)">

        <div style="padding: 0 10px; font-size: 13px; color: #666; line-height: 1.5;">
            提示：设置背景图后，聊天气泡和输入栏会自动适应背景，保持磨砂玻璃效果。
        </div>

        <div class="group-header">对方设定 (Char)</div>
        <div class="settings-group" style="padding: 15px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <div class="v-cover-box" id="setting-char-avatar" onclick="triggerSettingAvatar('char')"></div>
                <input type="file" id="input-setting-char-avatar" hidden onchange="previewSettingAvatar('char', this)">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">昵称 (点击修改)</div>
                    <input type="text" id="setting-char-name" class="search-box" style="margin:0; text-align:left; background:rgba(255,255,255,0.05);">
                </div>
            </div>

            <div style="font-size:12px; color:#888;">人设详情 (点击展开编辑)</div>
            <div class="setting-text-preview" id="setting-char-desc-preview" onclick="openTextEditModal('char-desc')">
                暂无人设信息...
            </div>
        </div>

        <div class="group-header">世界观 (World)</div>
        <div class="settings-group" style="padding: 15px;">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="tab-btn active" onclick="openWorldSelectModal()">+ 选择设定</button>
                <button class="tab-btn" onclick="addCustomWorldTag()">+ 自定义</button>
            </div>
            <div class="world-tags-container" id="setting-world-tags">
            </div>
        </div>

        <div class="group-header">我的设定 (User)</div>
        <div class="settings-group" style="padding: 15px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                <div class="v-cover-box" id="setting-user-avatar" onclick="triggerSettingAvatar('user')"></div>
                <input type="file" id="input-setting-user-avatar" hidden onchange="previewSettingAvatar('user', this)">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">我的昵称</div>
                    <input type="text" id="setting-user-name" class="search-box" style="margin:0; text-align:left; background:rgba(255,255,255,0.05);">
                </div>
            </div>
            <div style="font-size:12px; color:#888;">我的人设</div>
            <div class="setting-text-preview" id="setting-user-desc-preview" onclick="openTextEditModal('user-desc')">
                暂无...
            </div>
        </div>

        <div class="group-header">显示与气泡</div>
        <div class="settings-group">
            <div class="settings-item">
                <span>聊天显示头像</span>
                <label class="ios-switch">
                    <input type="checkbox" id="switch-show-avatar" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-group" style="padding:15px; margin-top:10px;">
            <div style="font-size:12px; color:#888; margin-bottom:10px;">气泡样式</div>
            <div class="bubble-style-scroll">
                <div class="bubble-preset-item active" onclick="selectBubbleStyle('default', this)">
                    <div class="mini-bubble-preview" style="border-radius:18px;"></div>
                    <span>默认</span>
                </div>
                <div class="bubble-preset-item" onclick="selectBubbleStyle('box', this)">
                    <div class="mini-bubble-preview" style="border-radius:4px;"></div>
                    <span>方块</span>
                </div>
                <div class="bubble-preset-item" onclick="selectBubbleStyle('trans', this)">
                    <div class="mini-bubble-preview" style="background:rgba(255,255,255,0.2); border:1px solid white;"></div>
                    <span>透明</span>
                </div>
                <div class="bubble-preset-item" onclick="selectBubbleStyle('custom', this)">
                    <span>自定义CSS</span>
                </div>
            </div>
            <textarea id="custom-bubble-css" class="code-textarea" style="height:80px; margin-top:10px; display:none;" placeholder="输入 .msg-bubble-listen { ... }"></textarea>
        </div>

        <div class="group-header">记录与管理</div>

            <button class="btn-danger-outline" style="color:white; border-color:rgba(255,255,255,0.3); margin-bottom:15px;" onclick="openVideoHistoryLog()">
                    📹 查看视频通话记录
            </button>

        <div class="search-container" style="border-radius:12px; padding:0; margin-bottom:10px;">
            <input type="text" class="settings-search" id="chat-history-search" placeholder="🔍 搜索聊天记录..." oninput="searchChatHistory(this.value)">
        </div>
        <div id="search-result-box" style="max-height:150px; overflow-y:auto; display:none; background:rgba(0,0,0,0.2); border-radius:10px; padding:10px;"></div>

        <div class="danger-zone">
            <button class="btn-danger-outline" onclick="clearCurrentChatHistory()">清空聊天记录</button>
            <button class="btn-danger-outline" id="btn-block-user" onclick="toggleBlockUser()">拉黑该好友</button>
            <button class="btn-danger-fill" onclick="deleteCurrentChatAndFriend()">删除好友并退出</button>
        </div>

        <div style="height:50px;"></div>
    </div>
</div>

<div class="modal-overlay" id="modal-text-edit">
    <div class="modal-content" style="height:60%;">
        <div class="modal-header"><span class="modal-title">编辑内容</span></div>
        <textarea class="code-textarea" id="big-text-input" style="height:100%; font-size:16px;"></textarea>
        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeTextEditModal()">取消</button>
            <button class="modal-btn btn-save" onclick="confirmTextEdit()">确定</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-world-select">
    <div class="modal-content">
        <div class="modal-header"><span class="modal-title">选择世界观</span></div>
        <div id="world-select-list" style="max-height:300px; overflow-y:auto;"></div>
        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="document.getElementById('modal-world-select').classList.remove('active')">关闭</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-general-input">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title" id="gen-input-title">标题</span>
        </div>

        <div class="ai-item-label" id="gen-input-label" style="margin-bottom:10px;">请输入内容</div>
        <input type="text" class="search-box" id="gen-input-field" style="margin-bottom:20px; text-align:left;">

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeGenInputModal()">取消</button>
            <button class="modal-btn btn-save" id="gen-input-confirm-btn">确定</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-general-confirm">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 25px 20px;">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;" id="gen-confirm-title">确认操作</div>
        <div style="font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 25px; line-height: 1.5;" id="gen-confirm-desc">
            描述文本
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeGenConfirmModal()">取消</button>
            <button class="modal-btn" id="gen-confirm-btn" style="background: #FF3B30; color: white;">确认</button>
        </div>
    </div>
</div>

<div class="image-viewer-overlay" id="image-viewer" onclick="closeImagePreview()">
    <div class="viewer-close-btn">×</div>

    <div id="viewer-counter" class="viewer-counter">1/1</div>

    <div id="viewer-gallery-container" class="viewer-gallery" onclick="event.stopPropagation()">
    </div>
</div>

<div class="modal-overlay" id="modal-post-menu" style="align-items: flex-end; padding-bottom: 20px;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%;" onclick="closePostMenu()"></div>

    <div class="action-sheet-content">
        <div class="sheet-group">
            <div class="sheet-item" onclick="handlePostMenuAction('edit')">
                <span style="color: #0a84ff;">编辑内容</span>
            </div>
            <div class="sheet-item" onclick="handlePostMenuAction('delete')" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #FF3B30;">删除帖子</span>
            </div>
        </div>

        <div class="sheet-group" style="margin-top: 10px;">
            <div class="sheet-item" onclick="closePostMenu()" style="font-weight: 600;">取消</div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-create-story" style="background: #1c1c1e; z-index: 680;">

    <div class="app-header" style="background: rgba(30, 30, 35, 0.9); border-bottom: none; z-index: 20; backdrop-filter: blur(20px);">
        <div class="app-back-btn" onclick="closeSubPage('sub-create-story')">取消</div>
        <div class="app-title" id="story-creator-title">发布快拍</div>

        <button class="ai-btn ai-btn-primary" onclick="publishStory()"
                style="
                    height: 32px; padding: 0 15px; font-size: 14px; border-radius: 16px;

                    /* 垂直居中 FIX：向下推 50% (从顶部 44px 算起)，再向上拉回自身高度 */
                    position: absolute; right: 15px; top: 50%; transform: translateY(-50%) translateY(22px);
                ">
            发布
        </button>
    </div>

    <div class="story-mode-toolbar">
        <button onclick="switchStoryMode('text')" id="btn-mode-text" class="mode-btn active">文字模式</button>
        <button onclick="switchStoryMode('image')" id="btn-mode-image" class="mode-btn">图片快拍</button>
    </div>

    <div class="story-content-area" id="story-content-area">

        <div id="story-mode-text" class="story-mode-pane active color-1" onclick="cycleStoryColor(this)">
            <textarea id="story-text-input" placeholder="输入文字... (点击背景切换颜色)" maxlength="150" class="story-full-textarea"></textarea>
            <span class="story-text-tip">点击背景切换颜色</span>
        </div>

        <div id="story-mode-image" class="story-mode-pane" style="display:none;">
            <div id="story-image-preview" class="story-image-preview-box">
                <textarea id="story-image-text-input" placeholder="点此添加文字 (可选)" class="story-overlay-textarea" maxlength="150"></textarea>
            </div>

            <div class="story-image-upload-btn" onclick="document.getElementById('story-image-input').click()">
                📷 选择照片
            </div>
        </div>

    </div>

    <input type="file" id="story-image-input" accept="image/*" hidden onchange="handleStoryImageUpload(this)">
</div>

<div class="sub-page" id="sub-story-viewer" style="background: #000; z-index: 1000;">

    <div class="viewer-progress-bar-container">
        <div class="progress-segment" id="story-progress-fill"></div>
    </div>

    <div class="viewer-controls">
        <div class="viewer-user-info">
            <div class="viewer-avatar-mini" id="viewer-avatar"></div>
            <div class="viewer-text-col">
                <span class="viewer-username" id="viewer-username">用户名称</span>
                <span class="viewer-time" id="viewer-time">刚刚</span>
            </div>
        </div>

        <div style="display: flex; align-items: center;">
            <button class="viewer-menu-btn" onclick="openStoryMoreMenu(); event.stopPropagation();">
                <svg viewBox="0 0 24 24"><path d="M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            </button>

            <button class="viewer-close-btn" onclick="closeSubPage('sub-story-viewer')">
                <svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
    </div>

    <div class="story-viewer-content" id="story-viewer-content">
        <div id="viewer-text-content" class="viewer-text-box" style="display:none;">
            <p id="viewer-text-p"></p>
        </div>
        <div id="viewer-image-content" class="viewer-image-box" style="display:none;">
            <img id="viewer-image-img" src="">
            <p id="viewer-image-text-p" class="viewer-image-overlay-text"></p>
        </div>
    </div>

    <div class="viewer-comments-layer" id="viewer-comments-box">
    </div>

    <div class="story-viewer-footer" id="story-viewer-footer">
        <div class="viewer-input-box">
            <input type="text" id="story-reply-input" class="viewer-reply-input" placeholder="发送消息..." onclick="event.stopPropagation(); pauseStory();">
            <button class="viewer-send-btn" onclick="sendStoryReply(); event.stopPropagation();">
                <svg viewBox="0 0 24 24" fill="white" width="18" height="18"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>

        <div class="viewer-icon-group">
            <button class="viewer-action-btn" id="story-like-btn" onclick="likeStory(); event.stopPropagation();">
                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </button>
            <button class="viewer-action-btn" onclick="openShareModal(); event.stopPropagation(); pauseStory();">
                <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-share-story">
    <div class="modal-content" style="height: 60%; display: flex; flex-direction: column;">
        <div class="modal-header"><span class="modal-title">发送给...</span></div>

        <input type="text" class="search-box" id="share-search" placeholder="搜索好友" oninput="renderShareList()">

        <div id="share-friend-list" style="flex: 1; overflow-y: auto; margin-bottom: 15px;">
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-share-story'); playStory();">取消</button>
            <button class="modal-btn btn-save" onclick="confirmShareStory()">发送</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-story-duration">
    <div class="modal-content" style="width: 85%; max-width: 320px;">
        <div class="modal-header">
            <span class="modal-title">快拍有效期</span>
        </div>

        <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">
            请选择你的快拍在动态流中显示的时长：
        </div>

        <div class="ai-group-card" id="story-duration-options" style="background:transparent; border:none; margin-bottom:0;">
        </div>

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-story-duration')">取消</button>
            <button class="modal-btn btn-save" id="btn-confirm-duration">确认发布</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-moment-activity" style="background: #1c1c1e; z-index: 700;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-moment-activity')">返回</div>
        <div class="app-title">互动消息</div>
    </div>
    <div class="wallpaper-content" style="padding: 0;">
        <div id="activity-list-container" style="padding-bottom: 50px;">
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-post-viewers">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header"><span class="modal-title">浏览记录</span></div>
        <div id="viewer-list-container" style="flex:1; overflow-y:auto;">
        </div>
        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-post-viewers')">关闭</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-beautify" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-beautify')">返回</div>
        <div class="app-title">个性美化</div>
        <div style="position:absolute; right:15px; color:#0a84ff; font-weight:600; cursor:pointer;" onclick="saveAllBeautifySettings()">保存</div>
    </div>

    <div class="beautify-tabs">
        <div class="beautify-tab active" onclick="switchBeautifyTab('msg', this)">消息页</div>
        <div class="beautify-tab" onclick="switchBeautifyTab('moments', this)">动态页</div>
        <div class="beautify-tab" onclick="switchBeautifyTab('me', this)">我的</div>
        <div class="beautify-tab" onclick="switchBeautifyTab('global', this)">全局CSS</div>
    </div>

    <div class="wallpaper-content" style="padding: 16px;">

        <div class="ai-header-text">背景设置</div>
        <div class="bg-upload-card" id="preview-bg-card" onclick="triggerBeautifyBgUpload()">
            <div class="bg-upload-overlay">
                <svg style="width:16px;height:16px;fill:white" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                <span>更换当前页面背景</span>
            </div>
        </div>
        <input type="file" id="beautify-bg-input" accept="image/*" hidden onchange="handleBeautifyBgUpload(this)">

        <div class="ai-btn-group" style="margin: 10px 0 20px 0;">
            <button class="ai-btn ai-btn-secondary" onclick="resetCurrentBg()" style="height:36px; font-size:13px;">恢复默认</button>
            <button class="ai-btn ai-btn-secondary" onclick="applyBgToAll()" style="height:36px; font-size:13px;">应用到所有页面</button>
        </div>

        <div id="component-editor-area">
            <div class="ai-header-text">组件样式微调 (CSS)</div>

            <div class="preview-stage-wrapper">
                <div id="preview-stage"></div>
            </div>

            <div class="code-editor-box">
                <div class="editor-header">
                    <span>自定义 CSS</span>
                    <span style="font-size:10px; opacity:0.6;">实时预览生效</span>
                </div>
                <textarea class="real-code-input" id="css-live-input"
                          placeholder="例如: .app-header { background: red; }&#10;无需担心影响其他页面，已自动隔离。"
                          oninput="handleCssInput(this.value)"></textarea>
            </div>
        </div>

        <div style="height: 50px;"></div>
    </div>
</div>

<style id="preview-sandbox-style"></style>
<style id="user-custom-css-final"></style>

<div class="sub-page" id="sub-my-likes" style="background: #1c1c1e; z-index: 750;">

    <div class="app-header" style="background: inherit; border-bottom: 1px solid rgba(255,255,255,0.05);">
        <div class="app-back-btn" onclick="closeSubPage('sub-my-likes')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">我的点赞</div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">
        <div id="liked-posts-list" class="feed-list-container" style="padding-top: 10px;">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-my-favorites" style="background: #1c1c1e; z-index: 750;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="closeSubPage('sub-my-favorites')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title">我的收藏</div>
    </div>

    <div class="wallpaper-content" style="padding: 0; display:flex; flex-direction:column; height:100%;">

        <div style="padding: 10px 16px;">
            <div class="chat-top-tabs-container" style="margin:0;">
                <div class="chat-tab-btn active" onclick="switchFavTab('moments', this)">动态</div>
                <div class="chat-tab-btn" onclick="switchFavTab('messages', this)">消息</div>
            </div>
        </div>

        <div id="fav-content-area" style="flex:1; overflow-y:auto; padding: 10px 0;">
        </div>
    </div>
</div>

<div class="app-window" id="app-diary">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-diary')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">时光手帐</div>
        <div style="position: absolute; right: 15px; top: 55px; cursor: pointer;" onclick="openWriteDiaryModal()">
            <svg style="width:24px;height:24px;fill:#0a84ff;" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        </div>
    </div>

    <div style="padding: 10px 20px;">
        <div class="chat-top-tabs-container" style="margin:0; background:rgba(255,255,255,0.1);">
            <div class="chat-tab-btn active" id="tab-diary-user" onclick="switchDiaryTab('user')">我的心事</div>
            <div class="chat-tab-btn" id="tab-diary-char" onclick="switchDiaryTab('char')">TA 的日记</div>
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0 20px 40px 20px;">

        <div id="diary-list-user" class="diary-timeline-container">
        </div>

        <div id="diary-list-char" class="diary-timeline-container" style="display:none;">
            <div style="text-align:center; margin-top:50px; color:rgba(255,255,255,0.5); font-size:14px;">
                TA 还没有写日记哦<br>
                <button class="ai-btn ai-btn-secondary" style="margin-top:20px; width:auto; padding:0 20px;" onclick="generateCharDiary()">✨ 让 TA 写一篇</button>
            </div>
        </div>

    </div>
</div>

<div class="modal-overlay" id="modal-write-diary">
    <div class="modal-content" style="height: 80%; display: flex; flex-direction: column;">
        <div class="modal-header">
            <span class="modal-title">记录心情</span>
            <span style="font-size:12px; color:rgba(255,255,255,0.5);" id="diary-date-label">今天</span>
        </div>

        <div class="mood-selector">
            <div class="mood-item active" onclick="selectMood('happy', this)">😄</div>
            <div class="mood-item" onclick="selectMood('neutral', this)">😐</div>
            <div class="mood-item" onclick="selectMood('sad', this)">😔</div>
            <div class="mood-item" onclick="selectMood('angry', this)">😡</div>
            <div class="mood-item" onclick="selectMood('love', this)">🥰</div>
        </div>

        <textarea class="code-textarea" id="diary-input-content" placeholder="今天发生了什么..." style="flex:1; background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; font-size:16px; line-height:1.6; resize:none; margin-bottom:15px;"></textarea>

        <div style="font-size:12px; color:rgba(255,255,255,0.5); margin-bottom:8px;">分享给 (TA会回应你哦):</div>
        <div class="diary-share-list" id="diary-friend-selector">
        </div>

        <div class="modal-footer">
            <button class="modal-btn btn-cancel" onclick="closeModal('modal-write-diary')">取消</button>
            <button class="modal-btn btn-save" onclick="saveDiaryEntry()">保存</button>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-diary-char-detail" style="background: #1c1c1e; z-index: 720;">

    <div class="app-header" style="background: inherit; border-bottom: 1px solid rgba(255,255,255,0.05);">
        <div class="app-back-btn" onclick="closeSubPage('sub-diary-char-detail')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            返回
        </div>
        <div class="app-title" id="diary-char-title">TA 的日记</div>
    </div>

    <div class="wallpaper-content" style="padding: 0 20px 100px 20px;">

        <div style="padding: 20px 0; display:flex; justify-content:center;">
            <button class="ai-btn ai-btn-primary" id="btn-generate-diary" onclick="startGeneratingDiary()"
                    style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);">
                ✨ 偷看 TA 今天的心事 (AI 生成)
            </button>
        </div>

        <div id="diary-char-timeline" class="diary-timeline-container">
        </div>
    </div>
</div>

<div class="app-window" id="app-wallet">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-wallet')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">数字钱包</div>
        <div class="header-right-group" style="position:absolute; right:15px; bottom: 12px;">
            <div class="header-text-btn" onclick="openWalletSubpage('sub-wallet-history')" style="font-size: 16px; font-weight: 500;">记录</div>
        </div>
    </div>

    <div class="wallpaper-content" id="wallet-main-content">
    </div>
</div>

<div class="sub-page" id="sub-wallet-recharge">
</div>

<div class="sub-page" id="sub-wallet-history">
</div>

<div class="app-window" id="app-shop">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-shop')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">未来商店</div>

        <div style="position: absolute; right: 15px; top: 55px; font-size:14px; font-weight:600; color:#4CD964; display:flex; align-items:center; gap:4px;">
            <span style="font-size:10px; opacity:0.8;">余额:</span>
            <span id="shop-balance-display">¥0.00</span>
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">

        <div style="padding: 10px 16px; overflow-x: auto; white-space: nowrap; scrollbar-width: none;">
            <div class="shop-tab-scroll">
                <div class="shop-tab active" onclick="filterShop('all', this)">全部</div>
                <div class="shop-tab" onclick="filterShop('digital', this)">数码</div>
                <div class="shop-tab" onclick="filterShop('food', this)">补给</div>
                <div class="shop-tab" onclick="filterShop('gift', this)">礼物</div>
                <div class="shop-tab" onclick="filterShop('virtual', this)">虚拟</div>
            </div>
        </div>

        <div id="shop-grid-container" class="shop-grid">
        </div>

        <div style="height: 40px;"></div>
    </div>
</div>

<div class="modal-overlay" id="modal-buy-confirm">
    <div class="modal-content" style="width: 280px; text-align: center; padding: 25px 20px;">
        <div style="width:60px; height:60px; background:rgba(10,132,255,0.1); border-radius:12px; margin:0 auto 15px auto; background-size:cover; background-position:center;" id="buy-confirm-img"></div>

        <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;" id="buy-confirm-title">商品名</div>
        <div style="font-size: 24px; font-weight: 700; color:#FF3B30; margin-bottom: 20px;" id="buy-confirm-price">¥0.00</div>

        <div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 25px;">
            确定要购买吗？<br>将从数字钱包扣款。
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="modal-btn btn-cancel" onclick="closeBuyModal()">再想想</button>
            <button class="modal-btn btn-save" onclick="confirmPurchase()">立即支付</button>
        </div>
    </div>
</div>

<div class="app-window" id="app-memo">

    <div class="app-header">
        <div class="app-back-btn" onclick="closeApp('app-memo')">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title">灵感笔记</div>
        <div style="position: absolute; right: 15px; top: 55px; color:#0a84ff; font-size:28px; font-weight:300; cursor: pointer;" onclick="openEditMemo()">
            +
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0;">

        <div class="search-container">
            <input type="text" class="settings-search" id="memo-search" placeholder="搜索笔记..." oninput="renderMemoList()">
        </div>

        <div id="memo-list-container" class="memo-list">
        </div>

        <div style="height: 40px;"></div>
    </div>
</div>

<div class="sub-page" id="sub-memo-edit" style="background: #1c1c1e; z-index: 750;">

    <div class="app-header" style="background: inherit; border-bottom: none;">
        <div class="app-back-btn" onclick="saveAndCloseMemo()">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            列表
        </div>
        <div class="app-title" style="font-size:14px; opacity:0.6;" id="memo-edit-time">编辑中...</div>
        <div style="position: absolute; right: 15px; top: 58px; cursor: pointer;" onclick="deleteCurrentMemo()">
            <svg style="width:22px;height:22px;fill:#FF3B30;" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        </div>
    </div>

    <div class="wallpaper-content" style="padding: 0 20px;">
        <textarea id="memo-textarea" class="memo-editor" placeholder="在此输入内容...&#10;第一行自动作为标题"></textarea>
    </div>
</div>

<!-- 电话 App -->
<div class="app-window" id="app-phone">

    <!-- 头部 (内容动态变化) -->
    <div class="app-header" id="phone-app-header">
        <!-- 返回按钮 (仅拨号盘显示) -->
        <div class="app-back-btn" id="phone-back-btn" onclick="closeApp('app-phone')" style="display:none;">
            <svg style="width:20px;height:20px;fill:#2196F3" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            主屏幕
        </div>
        <div class="app-title" id="phone-app-title">拨号</div>
        <!-- 右上角占位，保持标题居中 -->
        <div style="width: 60px;"></div>
    </div>

    <!-- 主内容区域 -->
    <div class="wallpaper-content" style="padding: 0; display:flex; flex-direction:column; height:100%; overflow:hidden;">

        <!-- 1. 通话记录 (Recents) -->
        <div id="phone-view-recents" class="phone-view" style="display:none;">
            <div style="padding: 10px 20px;">
                <div class="ai-header-text">最近通话</div>
                <div id="phone-recents-list">
                    <!-- JS 填充 -->
                </div>
            </div>
        </div>

        <!-- 2. 拨号盘 (Keypad) - 默认显示 -->
        <div id="phone-view-keypad" class="phone-view" style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding-bottom:80px;">

            <!-- 显示输入的号码 -->
            <div class="phone-display-area">
                <input type="text" id="phone-number-display" readonly value="">
                <div class="phone-backspace" onclick="phoneDeleteNumber()">
                    <svg viewBox="0 0 24 24"><path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 12 11.41 6.41 17 5 15.59 10.59 10 5 4.41 6.41 3 12 8.59 17.59 3 19 4.41 13.41 10 19 15.59z"/></svg>
                </div>
            </div>

            <!-- 数字键盘 grid -->
            <div class="phone-keypad-grid">
                <div class="phone-key" onclick="phonePress('1')">1<span class="sub"></span></div>
                <div class="phone-key" onclick="phonePress('2')">2<span class="sub">ABC</span></div>
                <div class="phone-key" onclick="phonePress('3')">3<span class="sub">DEF</span></div>
                <div class="phone-key" onclick="phonePress('4')">4<span class="sub">GHI</span></div>
                <div class="phone-key" onclick="phonePress('5')">5<span class="sub">JKL</span></div>
                <div class="phone-key" onclick="phonePress('6')">6<span class="sub">MNO</span></div>
                <div class="phone-key" onclick="phonePress('7')">7<span class="sub">PQRS</span></div>
                <div class="phone-key" onclick="phonePress('8')">8<span class="sub">TUV</span></div>
                <div class="phone-key" onclick="phonePress('9')">9<span class="sub">WXYZ</span></div>
                <div class="phone-key" onclick="phonePress('*')">*</div>
                <div class="phone-key" onclick="phonePress('0')">0<span class="sub">+</span></div>
                <div class="phone-key" onclick="phonePress('#')">#</div>
            </div>

            <!-- 呼叫按钮 -->
            <div class="phone-call-btn" onclick="makePhoneCall()">
                <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
            </div>
        </div>

        <!-- 3. 联系人 & 信息 (Contacts) -->
        <div id="phone-view-contacts" class="phone-view" style="display:none; flex-direction:column;">

            <!-- 顶部子导航 (联系人 | 信息) -->
            <div style="padding: 10px 20px;">
                <div class="chat-top-tabs-container" style="margin:0; background:rgba(255,255,255,0.05);">
                    <div class="chat-tab-btn active" onclick="switchContactSubTab('list', this)">通讯录</div>
                    <div class="chat-tab-btn" onclick="switchContactSubTab('sms', this)">简讯</div>
                </div>
            </div>

            <!-- 联系人列表 -->
            <div id="phone-sub-list" class="phone-sub-view" style="flex:1; overflow-y:auto; padding: 0 20px;">
                <!-- JS 填充 -->
            </div>

            <!-- 短信列表 -->
            <div id="phone-sub-sms" class="phone-sub-view" style="display:none; flex:1; overflow-y:auto; padding: 0 20px;">
                <!-- JS 填充 -->
            </div>
        </div>

    </div>

    <!-- 底部导航栏 (Recents | Keypad | Contacts) -->
    <div class="chat-bottom-nav">
        <div class="chat-nav-item" onclick="switchPhoneTab('recents', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
            <span class="chat-nav-text">记录</span>
        </div>
        <div class="chat-nav-item active" onclick="switchPhoneTab('keypad', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
            <span class="chat-nav-text">拨号</span>
        </div>
        <div class="chat-nav-item" onclick="switchPhoneTab('contacts', this)">
            <svg class="chat-nav-icon" viewBox="0 0 24 24"><path d="M20 0H4v2h16V0zM4 24h16v-2H4v2zM20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 2.75c1.24 0 2.25 1.01 2.25 2.25s-1.01 2.25-2.25 2.25S9.75 9 9.75 7.75 10.76 5.25 12 5.25zM17 17H7v-.98c0-1.66 3.33-2.5 5-2.5s5 .84 5 2.5V17z"/></svg>
            <span class="chat-nav-text">联系人</span>
        </div>
    </div>
</div>

<!-- 呼叫中弹窗 -->
<div class="modal-overlay" id="modal-calling" style="z-index: 3000;">
    <div class="modal-content" style="height:100%; width:100%; border-radius:0; background: linear-gradient(180deg, #1c1c1e 0%, #000 100%); align-items:center; justify-content:space-around; padding: 60px 20px;">
        <div style="text-align:center;">
            <div id="calling-avatar" style="width:120px; height:120px; border-radius:50%; background:#333; margin:0 auto 20px auto; background-size:cover; background-position:center; box-shadow:0 10px 40px rgba(0,0,0,0.5);"></div>
            <div id="calling-name" style="font-size:32px; font-weight:700; color:white; margin-bottom:10px;">未知号码</div>
            <div id="calling-status" style="font-size:16px; color:rgba(255,255,255,0.6);">正在呼叫...</div>
        </div>

        <div style="display:flex; gap:40px;">
            <button onclick="endPhoneCall()" style="width:70px; height:70px; border-radius:50%; background:#FF3B30; border:none; display:flex; align-items:center; justify-content:center; box-shadow:0 5px 20px rgba(255, 59, 48, 0.4);">
                <svg style="width:32px;height:32px;fill:white;transform:rotate(135deg);" viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-2.2 2.2c-3.23-1.61-5.81-4.19-7.41-7.41l2.2-2.2c.27-.27.35-.66.24-1.01-.36-1.11-.56-2.3-.56-3.53 0-.54-.45-1-1-1H4.39c-.55 0-1 .45-1 1 0 8.73 7.07 15.8 15.8 15.8.55 0 1-.45 1-1v-3.32c0-.54-.45-1-1-1z"/></svg>
            </button>
        </div>
    </div>
</div>

<input type="file" id="chat-photo-input" accept="image/*" style="display: none;" onchange="handleChatPhotoUpload(this)">


<div class="sub-page immersive-mode" id="sub-video-call" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: #000;">
    
    <div id="video-remote-container-fullscreen">
        <div class="aurora-bg full"></div>
        <video id="video-remote-player" loop muted playsinline style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;"></video>
        <div class="video-overlay-gradient"></div>
    </div>

    <div id="video-timer-display" style="
        position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
        font-size: 18px; font-weight: 500; color: rgba(255,255,255,0.9);
        text-shadow: 0 1px 2px rgba(0,0,0,0.5); z-index: 50;
        font-feature-settings: 'tnum'; font-variant-numeric: tabular-nums;
    ">00:00</div>

    <div class="video-local-pip" onclick="triggerLocalPhotoUpload()">
        <div id="video-local-image-bg" style="width:100%; height:100%; background-size:cover; background-position:center; background-color:#555;"></div>
        <input type="file" id="input-local-photo" accept="image/*" hidden onchange="handleLocalPhotoUpload(this)">
    </div>

    <div id="video-chat-overlay-container" style="
        position: absolute; bottom: 180px; left: 20px; right: 20px; 
        height: 250px; 
        overflow-y: auto; 
        display: flex; flex-direction: column; justify-content: flex-end; 
        gap: 8px; z-index: 15; pointer-events: none; 
        mask-image: linear-gradient(to top, transparent 0%, black 20%, black 100%);
        -webkit-mask-image: linear-gradient(to top, transparent 0%, black 20%, black 100%);
    "></div>

    <div id="video-call-overlay" class="fullscreen-overlay">
        <div class="calling-center">
            <div class="calling-avatar-box">
                <div class="calling-avatar-img" id="video-call-avatar"></div>
                <div class="calling-ripple"></div>
                <div class="calling-ripple delay"></div>
            </div>
            <div class="calling-name-txt" id="video-call-name">对方名字</div>
            <div class="calling-status-txt" id="video-call-status">正在等待对方接受邀请...</div>
        </div>
    </div>

    <div class="video-bottom-area">
        <div id="video-chat-input-bar" class="video-input-float hidden">
            <input type="text" id="video-chat-input" placeholder="输入文字与 TA 对话..." onkeydown="if(event.key==='Enter') sendVideoChatMessage()">
            <button onclick="sendVideoChatMessage()">发送</button>
        </div>

        <div class="video-controls-dock">
            <div class="v-dock-btn blur" onclick="toggleVideoChatInput()">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" fill="#fff"/></svg>
                <span>对话</span>
            </div>
            
            <div class="v-dock-btn red big" onclick="endVideoCall()">
                 <svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.52 7.46 7 12 7s8.66 1.52 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.7l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z" fill="#fff"/></svg>
            </div>

            <div class="v-dock-btn blur" onclick="triggerRemoteVideoUpload()">
                 <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                 <span>换背景</span>
            </div>
            <input type="file" id="input-remote-video" accept="video/*" hidden onchange="handleRemoteVideoUpload(this)">
        </div>
    </div>
</div>

<div class="sub-page" id="sub-video-history-log" style="background: #1c1c1e;">
    <div class="app-header" style="background: inherit; border-bottom: 1px solid rgba(255,255,255,0.05);">
        <div class="app-back-btn" onclick="closeSubPage('sub-video-history-log')">返回</div>
        <div class="app-title">视频通话记录</div>
        <div style="position:absolute; right:15px; font-size:14px; color:#FF3B30;" onclick="clearVideoHistory()">清空</div>
    </div>
    <div class="wallpaper-content" style="padding: 0;">
        <div id="video-history-list" style="padding: 15px;"></div>
    </div>
</div>

<div class="sub-page" id="sub-location-picker" style="background: #0b0f19; z-index: 1000;">
    <div class="app-header" style="background: rgba(11, 15, 25, 0.9); backdrop-filter: blur(10px);">
        <div class="app-back-btn" onclick="closeSubPage('sub-location-picker')">取消</div>
        <div class="app-title">发送位置</div>
        <div style="position: absolute; right: 15px; color: #34C759; font-weight: 600; cursor: pointer;" onclick="confirmSendLocation()">发送</div>
    </div>

    <div class="wallpaper-content" style="padding: 0; display:flex; flex-direction:column; height:100%;">
        
        <div style="padding: 10px 15px; background: #0b0f19; z-index: 20;">
            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; display: flex; align-items: center; padding: 8px 12px;">
                <svg style="width:16px; height:16px; fill:#888; margin-right:8px;" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="location-search-input" placeholder="搜索地点或街道..." 
                       style="background: transparent; border: none; color: white; flex: 1; outline: none; font-size: 14px;"
                       oninput="handleLocationSearch(this.value)">
            </div>
        </div>

        <div class="cyber-map-visual" id="picker-map-visual">
            <div class="cyber-grid-floor" id="picker-grid"></div>
            <div class="cyber-radar-ring"></div>
            
            <div class="cyber-pin-center">
                <div class="pin-head"></div>
                <div class="pin-pulse"></div>
                <div class="pin-tooltip" id="picker-pin-label">正在定位...</div>
            </div>

            <div class="cyber-labels">
                <div class="map-label-item" style="top:20%; left:10%;">SECTOR 7</div>
                <div class="map-label-item" style="bottom:30%; right:10%;">ZONE B</div>
                <div class="map-label-item" style="top:15%; right:20%;">DATA HUB</div>
            </div>
        </div>

        <div class="location-list-container">
            <div id="poi-list">
                </div>
        </div>
    </div>
</div>

<div class="sub-page" id="sub-location-viewer" style="background: #0b0f19; z-index: 1100;">
    <div class="app-header" style="background: rgba(11, 15, 25, 0.9); backdrop-filter: blur(10px); position:absolute; top:0; width:100%; z-index:50;">
        <div class="app-back-btn" onclick="closeSubPage('sub-location-viewer')">返回</div>
        <div class="app-title">位置详情</div>
    </div>

    <div class="map-container-placeholder" style="width: 100%; height: 100%; position: relative;">
        </div>
    
    <div class="location-detail-card" style="z-index: 60;">
        <div class="loc-card-title" id="viewer-loc-name" style="font-size: 18px;">地点名称</div>
        <div class="loc-card-addr" id="viewer-loc-addr" style="font-size: 13px; opacity: 0.7; margin-top: 5px;">详细地址信息...</div>
        <button class="ai-btn ai-btn-primary" style="margin-top:20px; height:48px;" onclick="showToast('正在打开导航...')">
            <svg style="width:20px; height:20px; fill:white; margin-right:8px;" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg> 
            开始导航
        </button>
    </div>
</div>

<div class="modal-overlay" id="modal-heart-link" style="backdrop-filter: blur(40px); background: rgba(0,0,0,0.4);">
    <div class="heart-modal-card">
        
        <div class="heart-bg-glow"></div>

        <div class="heart-header">
            <div class="heart-avatar-wrap">
                <div class="heart-avatar" id="heart-target-avatar"></div>
                <div class="heart-beat-icon">❤️</div>
            </div>
            <div class="heart-role-name" id="heart-target-name">Character</div>
            <div class="heart-role-label">INNER VOICE / 心声</div>
        </div>

        <div class="heart-quote-box">
            <div class="heart-content-text" id="heart-content-text">
                正在连接对方潜意识...
            </div>
        </div>

        <div class="heart-stats-row">
            <div class="stat-box">
                <div class="stat-num" style="color:#ff2e63">98%</div>
                <div class="stat-name">同步率</div>
            </div>
            <div class="stat-line"></div>
            <div class="stat-box">
                <div class="stat-num" style="color:#08d9d6">波动</div>
                <div class="stat-name">情绪值</div>
            </div>
        </div>

        <div class="heart-close-btn" onclick="closeModal('modal-heart-link')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
    </div>
</div>
<script>

    // 🚨 全局头像 URL 助手：兼容 Base64/Blob，解决头像不显示的问题
const getSafeUrl = async (key) => {
    try {
        const data = await dbHelper.get(key);
        if (!data) return '';

        if (data instanceof Blob || data instanceof File) {
            return URL.createObjectURL(data);
        }
        if (typeof data === 'string' && data.startsWith('data:image')) {
            return data;
        }
    } catch(e) {
        console.warn(`[Avatar Load Error] Key ${key}:`, e);
    }
    return '';
};

// 🚨 关键助手：优先查找 Chat Avatar Key，没有则回退到 Role Book Key
const getRoleChatAvatarUrl = async (roleId) => {
    // 1. 尝试查找聊天会话头像 (最新的/已同步的)
    let url = await getSafeUrl(`chat_avatar_${roleId}`);

    // 2. 如果聊天 Key 为空，则回退查找角色书的 Key
    if (!url) {
        url = await getSafeUrl(`role_${roleId}_avatar`);
    }
    return url;
};
    let currentQuoteData = null;

    // --- 补上通用的弹窗函数 ---
    function showToast(msg) {
        const toast = document.getElementById('global-toast');
        const text = document.getElementById('toast-text');
        if (toast && text) {
            text.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        } else {
            // 如果还没加 HTML，就退化成普通弹窗，防止报错
            alert(msg);
        }
    }
    // --- 0. 数据库工具 (升级版) ---
    const dbName = "AIPhoneDB_V2";
    const storeName = "media_files";
    const dbHelper = {
        open: function() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName);
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        },
        save: async function(key, value) {
            const db = await this.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readwrite");
                const request = tx.objectStore(storeName).put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e);
            });
        },
        get: async function(key) {
            const db = await this.open();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], "readonly");
                const request = tx.objectStore(storeName).get(key);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }
    };
    // --- 1. 基础 UI 逻辑 (时钟/电池) ---
    // ================== 全局时钟与时区逻辑 (修复完整版) ==================

    // 1. 海量时区数据库 (必须包含 name, detail, id)
    const timeZones = [
        // 亚洲
        { name: "北京", detail: "中国标准时间", id: "Asia/Shanghai" },
        { name: "香港", detail: "香港时间", id: "Asia/Hong_Kong" },
        { name: "台北", detail: "台北时间", id: "Asia/Taipei" },
        { name: "东京", detail: "日本", id: "Asia/Tokyo" },
        { name: "首尔", detail: "韩国", id: "Asia/Seoul" },
        { name: "新加坡", detail: "新加坡", id: "Asia/Singapore" },
        { name: "曼谷", detail: "泰国", id: "Asia/Bangkok" },
        { name: "迪拜", detail: "阿联酋", id: "Asia/Dubai" },
        { name: "新德里", detail: "印度", id: "Asia/Kolkata" },

        // 美洲
        { name: "纽约", detail: "美国东部", id: "America/New_York" },
        { name: "洛杉矶", detail: "美国太平洋", id: "America/Los_Angeles" },
        { name: "芝加哥", detail: "美国中部", id: "America/Chicago" },
        { name: "温哥华", detail: "加拿大", id: "America/Vancouver" },
        { name: "多伦多", detail: "加拿大", id: "America/Toronto" },
        { name: "墨西哥城", detail: "墨西哥", id: "America/Mexico_City" },
        { name: "圣保罗", detail: "巴西", id: "America/Sao_Paulo" },

        // 欧洲
        { name: "伦敦", detail: "英国", id: "Europe/London" },
        { name: "巴黎", detail: "法国", id: "Europe/Paris" },
        { name: "柏林", detail: "德国", id: "Europe/Berlin" },
        { name: "罗马", detail: "意大利", id: "Europe/Rome" },
        { name: "莫斯科", detail: "俄罗斯", id: "Europe/Moscow" },
        { name: "阿姆斯特丹", detail: "荷兰", id: "Europe/Amsterdam" },
        { name: "马德里", detail: "西班牙", id: "Europe/Madrid" },
        { name: "苏黎世", detail: "瑞士", id: "Europe/Zurich" },

        // 大洋洲
        { name: "悉尼", detail: "澳大利亚", id: "Australia/Sydney" },
        { name: "墨尔本", detail: "澳大利亚", id: "Australia/Melbourne" },
        { name: "奥克兰", detail: "新西兰", id: "Pacific/Auckland" },

        // 非洲
        { name: "开罗", detail: "埃及", id: "Africa/Cairo" },
        { name: "约翰内斯堡", detail: "南非", id: "Africa/Johannesburg" }
    ];

    // 2. 地区名称映射表
    const regionMap = {
        "Asia": "亚洲",
        "America": "美洲",
        "Europe": "欧洲",
        "Australia": "大洋洲",
        "Pacific": "大洋洲",
        "Africa": "非洲",
        "Etc": "其他"
    };

    // 3. 渲染时区列表 (修复版逻辑)
    function initTimeZoneList() {
        filterTimeZones(); // 初始化时渲染一次
    }

    function filterTimeZones() {
        const container = document.getElementById('timezone-list-container');
        const searchInput = document.getElementById('timezone-search');
        // 防止报错：如果还没加载输入框，就默认为空
        const keyword = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const currentZone = localStorage.getItem('userTimeZone') || 'Asia/Shanghai';

        container.innerHTML = ''; // 清空列表

        // 过滤数据
        let filteredList = timeZones.filter(tz => {
            if (!keyword) return true;
            // 这里的 detail 必须存在，否则会报错。上面的数据里我已经补全了 detail
            return tz.name.toLowerCase().includes(keyword) || (tz.detail && tz.detail.toLowerCase().includes(keyword));
        });

        if (filteredList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:40px; font-size:14px;">未找到结果</div>';
            return;
        }

        // 分组逻辑
        const groups = {};
        filteredList.forEach(tz => {
            const regionKey = tz.id.split('/')[0];
            const regionName = regionMap[regionKey] || "其他地区";
            if (!groups[regionName]) groups[regionName] = [];
            groups[regionName].push(tz);
        });

        const regionOrder = ["亚洲", "欧洲", "美洲", "大洋洲", "非洲", "其他地区"];
        const sortedKeys = regionOrder.filter(k => groups[k]).concat(Object.keys(groups).filter(k => !regionOrder.includes(k)));

        sortedKeys.forEach(regionName => {
            const cityList = groups[regionName];

            // 分组标题
            const header = document.createElement('div');
            header.className = 'group-header';
            header.textContent = regionName;
            container.appendChild(header);

            // 分组卡片
            const groupCard = document.createElement('div');
            groupCard.className = 'settings-group';

            cityList.forEach(tz => {
                const isSelected = tz.id === currentZone;
                const item = document.createElement('div');
                item.className = `settings-item ${isSelected ? 'selected' : ''}`;
                item.onclick = () => setTimeZone(tz.id, tz.name);

                item.innerHTML = `
                    <div>
                        <div class="city-name">${tz.name}</div>
                        <div class="city-detail">${tz.detail}</div>
                    </div>
                    <span class="check-icon">✔</span>
                `;
                groupCard.appendChild(item);
            });
            container.appendChild(groupCard);
        });
    }

    // 4. 设置时区功能
    function setTimeZone(zoneId, zoneName) {
        localStorage.setItem('userTimeZone', zoneId);

        // 清空搜索框
        const searchInput = document.getElementById('timezone-search');
        if(searchInput) searchInput.value = '';

        filterTimeZones();
        updateTime();
        showToast(`时区已切换至 ${zoneName}`);
        closeSubPage('sub-timezone');
    }

    // 打开子页面的功能
    function openSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.add('active');
        } else {
            console.error("找不到子页面:", id);
        }
    }

    // 关闭子页面的功能
    function closeSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.remove('active');
        }
    }

    // 6. 核心时间更新
    function updateTime() {
        const userZone = localStorage.getItem('userTimeZone') || 'Asia/Shanghai';
        const now = new Date();

        try {
            // 更新时钟
            const timeString = new Intl.DateTimeFormat('en-US', {
                hour: '2-digit', minute: '2-digit', hour12: false, timeZone: userZone
            }).format(now);

            const clockEl = document.getElementById('clock');
            if(clockEl) clockEl.textContent = timeString;

            // 更新日期
            const dateParts = new Intl.DateTimeFormat('zh-CN', {
                month: 'numeric', day: 'numeric', weekday: 'long', timeZone: userZone
            }).formatToParts(now);

            const weekdayEl = document.getElementById('weekday-text');
            const dateEl = document.getElementById('date-text');

            if (weekdayEl && dateEl) {
                weekdayEl.textContent = dateParts.find(p => p.type === 'weekday').value;
                dateEl.textContent = `${dateParts.find(p => p.type === 'month').value}月${dateParts.find(p => p.type === 'day').value}日`;
            }

            // 更新设置页当前状态
            const currentObj = timeZones.find(t => t.id === userZone);
            const label = document.getElementById('current-timezone-label');
            if(label) label.textContent = currentObj ? currentObj.name : '未知';

        } catch(e) {
            console.error("时间更新出错:", e);
        }
    }

    // 启动
    initTimeZoneList();
    // 这里的 setInterval 是为了防止重复定义，先清除再设置
    if (window.clockInterval) clearInterval(window.clockInterval);
    window.clockInterval = setInterval(updateTime, 1000);
    updateTime();

    function initBattery() {
        const batteryLevel = document.getElementById('battery-fill');
        const batteryText = document.getElementById('battery-text');
        const chargingIcon = document.getElementById('charging-bolt');
        if('getBattery' in navigator) navigator.getBattery().then(b => {
            const update = () => {
                const level = b.level * 100;
                batteryText.textContent = Math.round(level) + "%";
                batteryLevel.style.width = level + "%";
                if(b.charging) { batteryLevel.style.backgroundColor = "#4CD964"; chargingIcon.style.display = "block"; }
                else if(level <= 20) { batteryLevel.style.backgroundColor = "#FF3B30"; chargingIcon.style.display = "none"; }
                else { batteryLevel.style.backgroundColor = "white"; chargingIcon.style.display = "none"; }
            };
            update(); b.addEventListener('levelchange', update); b.addEventListener('chargingchange', update);
        });
    }
    initBattery();

    // --- 2. 城市数据 (超大杯完整版) ---
    const cityDatabase = {
        domestic: [
            // --- 一线/新一线 ---
            { name: "北京", lat: 39.9042, lon: 116.4074 },
            { name: "上海", lat: 31.2304, lon: 121.4737 },
            { name: "广州", lat: 23.1291, lon: 113.2644 },
            { name: "深圳", lat: 22.5431, lon: 114.0579 },
            { name: "成都", lat: 30.5728, lon: 104.0668 },
            { name: "重庆", lat: 29.5627, lon: 106.5528 },
            { name: "杭州", lat: 30.2741, lon: 120.1551 },
            { name: "武汉", lat: 30.5928, lon: 114.3055 },
            { name: "西安", lat: 34.3416, lon: 108.9398 },
            { name: "南京", lat: 32.0603, lon: 118.7969 },
            { name: "天津", lat: 39.0842, lon: 117.2009 },
            { name: "苏州", lat: 31.2989, lon: 120.5853 },
            { name: "长沙", lat: 28.2282, lon: 112.9388 },
            { name: "郑州", lat: 34.7466, lon: 113.6253 },

            // --- 东部沿海 ---
            { name: "青岛", lat: 36.0671, lon: 120.3826 },
            { name: "大连", lat: 38.9140, lon: 121.6147 },
            { name: "厦门", lat: 24.4798, lon: 118.0894 },
            { name: "宁波", lat: 29.8683, lon: 121.5440 },
            { name: "福州", lat: 26.0745, lon: 119.2965 },
            { name: "济南", lat: 36.6512, lon: 117.1201 },

            // --- 东北/西北 ---
            { name: "哈尔滨", lat: 45.8038, lon: 126.5349 },
            { name: "沈阳", lat: 41.8057, lon: 123.4315 },
            { name: "长春", lat: 43.8171, lon: 125.3235 },
            { name: "兰州", lat: 36.0611, lon: 103.8343 },
            { name: "乌鲁木齐", lat: 43.8256, lon: 87.6168 },
            { name: "呼和浩特", lat: 40.8419, lon: 111.7492 },

            // --- 西南/旅游热门 ---
            { name: "昆明", lat: 24.8801, lon: 102.8329 },
            { name: "丽江", lat: 26.8721, lon: 100.2297 },
            { name: "大理", lat: 25.6065, lon: 100.2676 },
            { name: "拉萨", lat: 29.6525, lon: 91.1721 },
            { name: "贵阳", lat: 26.6470, lon: 106.6302 },
            { name: "三亚", lat: 18.2528, lon: 109.5120 },
            { name: "海口", lat: 20.0440, lon: 110.1999 },
            { name: "桂林", lat: 25.2345, lon: 110.1800 },

            // --- 港澳台 ---
            { name: "香港", lat: 22.3193, lon: 114.1694 },
            { name: "澳门", lat: 22.1987, lon: 113.5439 },
            { name: "台北", lat: 25.0330, lon: 121.5654 },
            { name: "高雄", lat: 22.6273, lon: 120.3014 }
        ],
        international: [
            // --- 亚洲 ---
            { name: "东京", lat: 35.6895, lon: 139.6917 },
            { name: "大阪", lat: 34.6937, lon: 135.5023 },
            { name: "京都", lat: 35.0116, lon: 135.7681 },
            { name: "首尔", lat: 37.5665, lon: 126.9780 },
            { name: "曼谷", lat: 13.7563, lon: 100.5018 },
            { name: "新加坡", lat: 1.3521, lon: 103.8198 },
            { name: "吉隆坡", lat: 3.1390, lon: 101.6869 },
            { name: "胡志明市", lat: 10.8231, lon: 106.6297 },
            { name: "雅加达", lat: -6.2088, lon: 106.8456 },
            { name: "马尼拉", lat: 14.5995, lon: 120.9842 },
            { name: "新德里", lat: 28.6139, lon: 77.2090 },
            { name: "迪拜", lat: 25.2048, lon: 55.2708 },

            // --- 欧洲 ---
            { name: "伦敦", lat: 51.5074, lon: -0.1278 },
            { name: "巴黎", lat: 48.8566, lon: 2.3522 },
            { name: "柏林", lat: 52.5200, lon: 13.4050 },
            { name: "慕尼黑", lat: 48.1351, lon: 11.5820 },
            { name: "罗马", lat: 41.9028, lon: 12.4964 },
            { name: "米兰", lat: 45.4642, lon: 9.1900 },
            { name: "马德里", lat: 40.4168, lon: -3.7038 },
            { name: "巴塞罗那", lat: 41.3851, lon: 2.1734 },
            { name: "莫斯科", lat: 55.7558, lon: 37.6173 },
            { name: "阿姆斯特丹", lat: 52.3676, lon: 4.9041 },
            { name: "苏黎世", lat: 47.3769, lon: 8.5417 },

            // --- 北美 ---
            { name: "纽约", lat: 40.7128, lon: -74.0060 },
            { name: "洛杉矶", lat: 34.0522, lon: -118.2437 },
            { name: "旧金山", lat: 37.7749, lon: -122.4194 },
            { name: "芝加哥", lat: 41.8781, lon: -87.6298 },
            { name: "西雅图", lat: 47.6062, lon: -122.3321 },
            { name: "多伦多", lat: 43.6510, lon: -79.3470 },
            { name: "温哥华", lat: 49.2827, lon: -123.1207 },

            // --- 其他 ---
            { name: "悉尼", lat: -33.8688, lon: 151.2093 },
            { name: "墨尔本", lat: -37.8136, lon: 144.9631 },
            { name: "奥克兰", lat: -36.8485, lon: 174.7633 },
            { name: "开罗", lat: 30.0444, lon: 31.2357 },
            { name: "里约热内卢", lat: -22.9068, lon: -43.1729 },
            { name: "布宜诺斯艾利斯", lat: -34.6037, lon: -58.3816 }
        ]
    };

    let currentTab = 'domestic';
    let selectedCity = null; // 临时选中的城市对象

    // --- 3. 弹窗与列表逻辑 ---
    const modal = document.getElementById('city-modal');
    const listContainer = document.getElementById('city-list-container');
    const searchInput = document.getElementById('city-search');

    function openCityModal() {
        modal.style.display = 'flex';
        renderCityList(); // 每次打开重新渲染列表
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeCityModal() {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
        selectedCity = null; // 重置选择
    }

    // 切换 国内/国际 Tab
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        searchInput.value = ''; // 切换时清空搜索
        renderCityList();
    }

    // 渲染列表 (支持搜索过滤)
    function renderCityList() {
        listContainer.innerHTML = '';
        const keyword = searchInput.value.trim();
        const cities = cityDatabase[currentTab];

        cities.forEach(city => {
            // 如果有搜索词，必须匹配名字
            if (keyword && !city.name.includes(keyword)) return;

            const item = document.createElement('div');
            item.className = 'city-item';
            if (selectedCity && selectedCity.name === city.name) {
                item.classList.add('selected');
            }

            item.innerHTML = `
                <div class="city-name">${city.name}</div>
                <div class="city-sub">Lat: ${city.lat.toFixed(1)}</div>
            `;

            item.onclick = () => {
                selectedCity = city;
                renderCityList(); // 重新渲染以更新高亮状态
            };
            listContainer.appendChild(item);
        });
    }

    function filterCities() {
        renderCityList();
    }

    // --- 4. 核心：真实天气 API 获取 ---
    function saveCitySelection() {
        if (selectedCity) {
            // 1. 获取天气
            fetchWeather(selectedCity);

            // 2. 【新增】把选中的城市存起来
            // JSON.stringify 是把对象变成字符串，因为 storage 只能存字符串
            localStorage.setItem('userCity', JSON.stringify(selectedCity));

            // 3. 关闭弹窗
            closeCityModal();
        } else {
            alert("请先选择一个城市！");
        }
    }

    // 调用 Open-Meteo 免费 API
    async function fetchWeather(city) {
        const cityEl = document.getElementById('current-city');
        const tempEl = document.querySelector('.weather-temp');
        const descEl = document.querySelector('.weather-desc');
        const iconEl = document.getElementById('weather-icon-container');

        // 先显示加载状态
        cityEl.textContent = city.name;
        descEl.textContent = "更新中...";

        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true&timezone=auto`;
            const response = await fetch(url);
            const data = await response.json();
            const weather = data.current_weather;

            // 更新 UI
            tempEl.textContent = Math.round(weather.temperature) + "°";
            const weatherInfo = getWeatherInfo(weather.weathercode);
            descEl.textContent = weatherInfo.desc;
            iconEl.innerHTML = weatherInfo.icon;

        } catch (error) {
            console.error(error);
            descEl.textContent = "获取失败";
        }
    }

    // --- 5. 天气代码映射 (全套图标) ---
    // 根据 WMO Code 返回对应图标和描述
    function getWeatherInfo(code) {
        // ☀️ 晴天 (0, 1)
        if (code <= 1) return {
            desc: "晴朗",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="14" fill="#FFC107"/><g stroke="#FF9800" stroke-width="4" stroke-linecap="round"><path d="M32 6V10 M32 54V58 M6 32H10 M54 32H58 M13.6 13.6L16.4 16.4 M47.6 47.6L50.4 50.4 M13.6 50.4L16.4 47.6 M47.6 16.4L50.4 13.6"/></g></svg>`
        };

        // ⛅ 多云 (2, 3)
        if (code <= 3) return {
            desc: "多云",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M18 42H46C51.5 42 56 37.5 56 32C56 26.5 51.5 22 46 22C46 16.5 41.5 12 36 12C30.5 12 26 16.5 26 22C20.5 22 16 26.5 16 32C16 37.5 20.5 42 26 42Z" fill="white" fill-opacity="0.9" filter="drop-shadow(0 4px 4px rgba(0,0,0,0.1))"/></svg>`
        };

        // 🌫️ 雾 (45, 48)
        if (code <= 48) return {
            desc: "有雾",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M16 24H48 M12 32H52 M16 40H48" stroke="white" stroke-width="4" stroke-linecap="round" stroke-opacity="0.6"/></svg>`
        };

        // 🌧️ 雨 (51-67, 80-82)
        if (code <= 67 || (code >= 80 && code <= 82)) return {
            desc: "降雨",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 32C20 25.3 25.3 20 32 20C38.6 20 44 25.3 44 32" fill="white" fill-opacity="0.9"/><path d="M20 32 H44 V34 H20 Z" fill="white" fill-opacity="0.9"/><path d="M24 40L22 48 M32 40L30 48 M40 40L38 48" stroke="#64B5F6" stroke-width="3" stroke-linecap="round"/></svg>`
        };

        // 🌨️ 雪 (71-77, 85-86)
        if (code <= 77 || (code >= 85 && code <= 86)) return {
            desc: "降雪",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 32C20 25.3 25.3 20 32 20C38.6 20 44 25.3 44 32" fill="white" fill-opacity="0.9"/><circle cx="24" cy="46" r="2" fill="white"/><circle cx="32" cy="50" r="2" fill="white"/><circle cx="40" cy="46" r="2" fill="white"/></svg>`
        };

        // ⛈️ 雷暴 (95-99)
        return {
            desc: "雷暴",
            icon: `<svg class="weather-svg" viewBox="0 0 64 64" fill="none"><path d="M20 30C20 23.3 25.3 18 32 18C38.6 18 44 23.3 44 30" fill="gray" fill-opacity="0.9"/><path d="M34 32L26 44H32L28 56L40 40H32L34 32Z" fill="#FFD700" stroke="#FFA000" stroke-width="1"/></svg>`
        };
    }

    // --- 启动时：检查有没有存过的城市 ---
    function initWeather() {
        // 1. 尝试从本地拿城市数据
        const savedCityStr = localStorage.getItem('userCity');

        if (savedCityStr) {
            // 2. 如果拿到了，就把它变回对象，然后查天气
            const savedCity = JSON.parse(savedCityStr);
            fetchWeather(savedCity);
        } else {
            // 3. 如果从没存过，默认显示北京
            fetchWeather(cityDatabase.domestic[0]);
        }
    }

    // 运行初始化
    initWeather();

    // --- 照片组件逻辑 ---

    // 1. 点击组件，触发隐藏的 file input 点击事件
    function triggerPhotoUpload() {
        document.getElementById('photo-input').click();
    }

    // 修改后的上传逻辑 (支持大文件)
    function handlePhotoUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                const imageData = e.target.result;

                // 1. 更新 UI
                const display = document.getElementById('photo-display');
                const placeholder = document.getElementById('photo-placeholder');
                display.style.backgroundImage = `url(${imageData})`;
                placeholder.style.display = 'none';
                display.style.display = 'block';

                // 2. 存入大容量数据库 (IndexedDB)
                try {
                    // 'userPhoto_1' 是这张图的ID，如果你以后有多个图，可以换名字
                    await dbHelper.save('userPhoto_1', imageData);
                    console.log("图片已保存到本地数据库");
                } catch (err) {
                    console.error("保存失败", err);
                    alert("保存失败，可能是空间不足");
                }
            }
            reader.readAsDataURL(file);
        }
    }

    // 修改后的初始化逻辑
    async function initSavedPhoto() {
        try {
            // 从大容量数据库读取
            const savedImage = await dbHelper.get('userPhoto_1');

            if (savedImage) {
                const display = document.getElementById('photo-display');
                const placeholder = document.getElementById('photo-placeholder');

                display.style.backgroundImage = `url(${savedImage})`;
                placeholder.style.display = 'none';
                display.style.display = 'block';
            }
        } catch (err) {
            console.log("还没有保存过照片");
        }
    }

    // 立即运行
    initSavedPhoto();

    // ================== 音乐组件核心逻辑 ==================
    const audioPlayer = new Audio();
    let isPlaying = false;
    let tempMp3File = null;

    // 1. 封面上传
    function triggerCoverUpload() { document.getElementById('cover-input').click(); }
    document.getElementById('cover-input').onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                document.getElementById('music-cover').style.backgroundImage = `url(${evt.target.result})`;
                await dbHelper.save('music_cover_img', evt.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    // 2. 弹窗控制
    const musicModal = document.getElementById('music-modal');
    const fileNameDisplay = document.getElementById('music-file-name');

    function openMusicModal() {
        const meta = JSON.parse(localStorage.getItem('musicMeta') || '{}');
        document.getElementById('edit-song-title').value = meta.title || '';
        document.getElementById('edit-artist-name').value = meta.artist || '';
        fileNameDisplay.textContent = "未选择新文件";
        tempMp3File = null;
        musicModal.style.display = 'flex';
        setTimeout(()=>musicModal.classList.add('active'), 10);
    }

    function closeMusicModal() {
        musicModal.classList.remove('active');
        setTimeout(()=>musicModal.style.display = 'none', 300);
    }

    // 3. 监听MP3选择
    document.getElementById('mp3-input').onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            tempMp3File = e.target.files[0];
            fileNameDisplay.textContent = "已选择: " + tempMp3File.name;
        }
    };

    // 4. 保存并播放
    async function saveMusicInfo() {
        const title = document.getElementById('edit-song-title').value || '未知歌曲';
        const artist = document.getElementById('edit-artist-name').value || '未知艺术家';
        const url = document.getElementById('edit-music-url').value;

        const meta = { title, artist, url, hasLocalFile: !!tempMp3File };
        localStorage.setItem('musicMeta', JSON.stringify(meta));

        // 更新文字
        document.querySelector('.song-title').textContent = title;
        document.querySelector('.artist-name').textContent = artist;

        // 处理音频
        if (tempMp3File) {
            await dbHelper.save('music_audio_file', tempMp3File); // 存入数据库
            loadAndPlayAudio(URL.createObjectURL(tempMp3File));
        } else if (url) {
            await dbHelper.save('music_audio_file', null);
            loadAndPlayAudio(url);
        }
        closeMusicModal();
    }

    function loadAndPlayAudio(src) {
        audioPlayer.src = src;
        audioPlayer.play().then(() => {
            isPlaying = true; updatePlayPauseIcon();
        }).catch(e => console.error("播放失败", e));
    }

    // 5. 播放控制按钮
    const playBtn = document.getElementById('playPauseBtn');
    playBtn.onclick = function() {
        if (!audioPlayer.src) { openMusicModal(); return; }
        if (isPlaying) audioPlayer.pause(); else audioPlayer.play();
        isPlaying = !isPlaying;
        updatePlayPauseIcon();
    };

    function updatePlayPauseIcon() {
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        if (isPlaying) {
            playIcon.style.display = 'none'; pauseIcon.style.display = 'block';
        } else {
            playIcon.style.display = 'block'; pauseIcon.style.display = 'none';
        }
    }

    // 6. 进度条更新
    const progressBar = document.querySelector('.progress-bar-fill');
    audioPlayer.ontimeupdate = function() {
        if (audioPlayer.duration) {
            progressBar.style.width = (audioPlayer.currentTime / audioPlayer.duration * 100) + '%';
        }
    };
    audioPlayer.onended = function() {
        isPlaying = false; updatePlayPauseIcon(); progressBar.style.width = '0%';
    };

    // 7. 初始化加载 (记忆功能)
    async function initMusicState() {
        const metaStr = localStorage.getItem('musicMeta');
        if (metaStr) {
            const meta = JSON.parse(metaStr);
            document.querySelector('.song-title').textContent = meta.title;
            document.querySelector('.artist-name').textContent = meta.artist;

            // 加载音频
            if (meta.hasLocalFile) {
                const audioBlob = await dbHelper.get('music_audio_file');
                if (audioBlob) audioPlayer.src = URL.createObjectURL(audioBlob);
            } else if (meta.url) {
                audioPlayer.src = meta.url;
            }
        }
        // 加载封面
        const savedCover = await dbHelper.get('music_cover_img');
        if (savedCover) document.getElementById('music-cover').style.backgroundImage = `url(${savedCover})`;
    }
    initMusicState();

    // ================== 个人信息组件逻辑 ==================

    // --- A. 头像上传逻辑 (存 IndexedDB 大仓库) ---
    function triggerProfileUpload() { document.getElementById('profile-input').click(); }

    document.getElementById('profile-input').onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function(evt) {
                // 1. 更新界面
                document.getElementById('profile-avatar').style.backgroundImage = `url(${evt.target.result})`;
                // 2. 存入数据库
                await dbHelper.save('userAvatar_main', evt.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    // --- B. 文字编辑弹窗逻辑 ---
    const profileModal = document.getElementById('profile-modal');
    const profileInput = document.getElementById('profile-edit-input');
    const modalTitle = document.getElementById('profile-modal-title');
    const editTypeHidden = document.getElementById('current-edit-type');

    // 打开弹窗 (type 传入 'nickname' 或 'signature')
    function openProfileEditModal(type) {
        // 根据类型设置标题和回显内容
        if (type === 'nickname') {
            modalTitle.textContent = "修改昵称";
            profileInput.value = document.getElementById('profile-nickname').textContent;
        } else {
            modalTitle.textContent = "修改个性签名";
            profileInput.value = document.getElementById('profile-signature').textContent;
        }
        // 记录当前编辑类型
        editTypeHidden.value = type;

        profileModal.style.display = 'flex';
        setTimeout(() => {
            profileModal.classList.add('active');
            profileInput.focus(); // 自动聚焦输入框
        }, 10);
    }

    // 关闭弹窗
    function closeProfileModal() {
        profileModal.classList.remove('active');
        setTimeout(() => profileModal.style.display = 'none', 300);
    }

    // 保存文字 (存 localStorage 小本子)
    function saveProfileText() {
        const type = editTypeHidden.value;
        const text = profileInput.value.trim();

        if (text) {
            if (type === 'nickname') {
                document.getElementById('profile-nickname').textContent = text;
                localStorage.setItem('userNickname', text);
            } else {
                document.getElementById('profile-signature').textContent = text;
                localStorage.setItem('userSignature', text);
            }
        }
        closeProfileModal();
    }

    // --- C. 初始化加载 (断电记忆) ---
    async function initProfileState() {
        // 1. 加载文字 (localStorage)
        const nick = localStorage.getItem('userNickname');
        const sign = localStorage.getItem('userSignature');
        if (nick) document.getElementById('profile-nickname').textContent = nick;
        if (sign) document.getElementById('profile-signature').textContent = sign;

        // 2. 加载头像 (IndexedDB)
        const savedAvatar = await dbHelper.get('userAvatar_main');
        if (savedAvatar) {
            document.getElementById('profile-avatar').style.backgroundImage = `url(${savedAvatar})`;
        }
    }

    // 启动时加载
    initProfileState();

    // ================== 壁纸 App 逻辑 ==================

    // 临时存储，用于预览后保存
    let tempWpImg = null;
    let tempWpVideo = null;

    // 1. 打开/关闭 App 动画
    function openApp(appId) {
        const app = document.getElementById(appId);
        app.style.display = 'flex';
        setTimeout(() => app.classList.add('active'), 10);
    }
    function closeApp(appId) {
        const app = document.getElementById(appId);
        app.classList.remove('active');
        setTimeout(() => app.style.display = 'none', 300);
    }

    // 2. 处理上传预览
    function handleWpPreview(type, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);

            if (type === 'image') {
                const preview = document.getElementById('wp-img-preview');
                preview.innerHTML = ''; // 清空文字
                preview.style.background = `url(${url}) center/cover no-repeat`;
                tempWpImg = file; // 存入临时变量
                document.getElementById('btn-apply-img').classList.add('ready'); // 激活按钮
            } else {
                const video = document.getElementById('wp-video-preview');
                const placeholder = document.getElementById('wp-video-placeholder');
                video.src = url;
                video.style.display = 'block';
                video.play();
                placeholder.style.display = 'none';
                tempWpVideo = file;
                document.getElementById('btn-apply-video').classList.add('ready');
            }
        }
    }

    // 3. 应用壁纸 (核心保存逻辑)
    async function applyWallpaper(type) {
        const body = document.body;
        const globalVideo = document.getElementById('global-video-bg');

        if (type === 'image' && tempWpImg) {
            // --- 静态逻辑 ---
            // 1. 存入数据库
            await dbHelper.save('wallpaper_file', tempWpImg);
            await dbHelper.save('wallpaper_type', 'image');

            // 2. 应用 UI
            const url = URL.createObjectURL(tempWpImg);
            body.style.backgroundImage = `url(${url})`;
            globalVideo.style.display = 'none'; // 隐藏视频层
            globalVideo.src = ""; // 停止视频节省资源

            alert("静态壁纸已应用！");
            closeApp('app-wallpaper');

        } else if (type === 'video' && tempWpVideo) {
            // --- 动态逻辑 ---
            if (tempWpVideo.size > 50 * 1024 * 1024) {
                alert("视频有点大(超过50MB)，保存可能会慢一点，请稍等...");
            }

            // 1. 存入数据库
            await dbHelper.save('wallpaper_file', tempWpVideo);
            await dbHelper.save('wallpaper_type', 'video');

            // 2. 应用 UI
            const url = URL.createObjectURL(tempWpVideo);
            globalVideo.src = url;
            globalVideo.style.display = 'block';
            globalVideo.play();
            // 把 body 背景图去掉，否则会挡住视频
            body.style.backgroundImage = 'none';

            alert("动态壁纸已应用！");
            closeApp('app-wallpaper');
        }
    }

    // 4. 初始化加载 (开机读取壁纸)
    async function initWallpaper() {
        try {
            const type = await dbHelper.get('wallpaper_type');
            const file = await dbHelper.get('wallpaper_file');

            if (type && file) {
                const url = URL.createObjectURL(file);
                const globalVideo = document.getElementById('global-video-bg');

                if (type === 'image') {
                    document.body.style.backgroundImage = `url(${url})`;
                    globalVideo.style.display = 'none';
                } else if (type === 'video') {
                    document.body.style.backgroundImage = 'none';
                    globalVideo.src = url;
                    globalVideo.style.display = 'block';
                    globalVideo.play();
                }
            }
        } catch (e) {
            console.log("使用默认壁纸");
        }
    }

    // 启动
    initWallpaper();

    // ================== 8. 主题系统逻辑 (静音修复版) ==================

    // 1. 切换主题模式 (增加 isSilent 参数)
    function switchTheme(mode, isSilent = false) {
        // 更新按钮状态
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-theme-${mode}`);
        if(btn) btn.classList.add('active');

        // 保存模式
        localStorage.setItem('userThemeMode', mode);

        // 更新设置页文字
        const label = document.getElementById('current-theme-label');
        if(label) label.textContent = (mode === 'dark' ? '深色' : (mode === 'light' ? '浅色' : '自定义'));

        // --- 执行模式切换 ---
        const body = document.body;
        const editor = document.getElementById('custom-css-area');

        // 重置状态
        body.classList.remove('light-theme');
        removeCustomStyle();

        if (mode === 'light') {
            body.classList.add('light-theme');
            editor.style.display = 'none';
            // 只有在不是静音(手动点击)时才弹窗
            if(!isSilent) showToast('已切换至浅色模式');
        }
        else if (mode === 'dark') {
            editor.style.display = 'none';
            if(!isSilent) showToast('已切换至深色模式');
        }
        else if (mode === 'custom') {
            editor.style.display = 'block';
            const savedCSS = localStorage.getItem('userCustomCSS') || '';
            document.getElementById('css-input').value = savedCSS;
            applyCustomCSS(true); // 加载代码时默认静音
        }
    }

    // 2. 应用自定义 CSS
    function applyCustomCSS(isSilent = false) {
        const cssText = document.getElementById('css-input').value;
        removeCustomStyle();

        const styleTag = document.createElement('style');
        styleTag.id = 'user-custom-style';
        styleTag.textContent = cssText;
        document.head.appendChild(styleTag);

        localStorage.setItem('userCustomCSS', cssText);

        if(!isSilent) showToast('自定义主题已应用');
    }

    // 移除自定义样式标签
    function removeCustomStyle() {
        const oldStyle = document.getElementById('user-custom-style');
        if (oldStyle) oldStyle.remove();
    }

    // 3. 初始化主题 (开机读取 - 开启静音模式)
    function initTheme() {
        const mode = localStorage.getItem('userThemeMode') || 'dark';
        // 这里传 true，表示静音加载，不弹窗
        switchTheme(mode, true);
    }

    // 启动
    initTheme();

    // ================== 9. AI 模型设置逻辑 (多配置版) ==================

    // 1. 初始化
    function initAISettings() {
        // 读取当前激活的配置
        const activeConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');

        document.getElementById('ai-endpoint').value = activeConfig.endpoint || '';
        document.getElementById('ai-key').value = activeConfig.key || '';

        // 更新UI显示
        if (activeConfig.model) {
            updateModelDisplay(activeConfig.model);
        }
        if (activeConfig.name) {
            document.getElementById('current-config-name').textContent = activeConfig.name;
        }
    }

    // 更新显示辅助函数
    function updateModelDisplay(name) {
        const el = document.getElementById('display-current-model');
        const label = document.getElementById('current-model-label');
        if(el) el.textContent = name || '未选择';
        if(label) label.textContent = name || '未配置';
    }

    // 2. 拉取模型列表 (保持不变)
    async function fetchModelList() {
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();

        if (!endpoint || !key) { showToast("请先填写地址和密钥"); return; }
        showToast("正在连接...");

        try {
            const response = await fetch(`${endpoint}/v1/models`, {
                method: 'GET', headers: { 'Authorization': `Bearer ${key}` }
            });
            if (!response.ok) throw new Error("HTTP " + response.status);
            const data = await response.json();
            const list = Array.isArray(data.data) ? data.data : data;

            if (list && list.length > 0) {
                cachedModelList = list.sort((a, b) => a.id.localeCompare(b.id));
                renderModelList();
                openSubPage('sub-model-select');
                showToast(`获取到 ${list.length} 个模型`);
            } else { throw new Error("列表为空"); }
        } catch (err) { showToast("拉取失败: " + err.message); }
    }

    // 3. 渲染模型列表 (保持不变)
    function renderModelList() {
        const container = document.getElementById('model-list-container');
        const keyword = document.getElementById('model-search').value.toLowerCase().trim();
        container.innerHTML = '';

        const group = document.createElement('div'); group.className = 'settings-group';

        cachedModelList.filter(m => !keyword || m.id.toLowerCase().includes(keyword)).forEach(m => {
            const item = document.createElement('div');
            item.className = 'settings-item';
            item.onclick = () => {
                document.getElementById('display-current-model').textContent = m.id;
                document.getElementById('display-current-model').dataset.value = m.id;
                closeSubPage('sub-model-select');
            };
            item.innerHTML = `<div class="city-name" style="font-size:15px;">${m.id}</div>`;
            group.appendChild(item);
        });
        container.appendChild(group);
    }

    // 4. 【核心】保存配置 (UI 弹窗版)

    // 步骤 A: 校验并打开弹窗
    function saveAISettings() {
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();
        const modelEl = document.getElementById('display-current-model');
        const model = modelEl.dataset.value || modelEl.textContent.trim();

        if (!endpoint || !key || model === '未选择') { showToast("配置不完整"); return; }

        // 获取当前名字作为默认值
        const currentName = document.getElementById('current-config-name').textContent;
        const input = document.getElementById('config-name-input');
        input.value = currentName === '默认' ? '' : currentName;

        // 打开命名弹窗
        const modal = document.getElementById('config-name-modal');
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
            input.focus(); // 自动聚焦
        }, 10);
    }

    // 步骤 B: 关闭弹窗
    function closeConfigNameModal() {
        const modal = document.getElementById('config-name-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // 步骤 C: 确认保存 (点击弹窗按钮触发)
    function confirmSaveConfig() {
        const nameInput = document.getElementById('config-name-input');
        const configName = nameInput.value.trim() || "我的配置"; // 默认名

        // 再次获取数据 (因为只是隔了一层弹窗，DOM里的数据还在)
        const endpoint = getCleanEndpoint();
        const key = document.getElementById('ai-key').value.trim();
        const modelEl = document.getElementById('display-current-model');
        const model = modelEl.dataset.value || modelEl.textContent.trim();

        // 1. 构建配置对象
        const newConfig = {
            id: Date.now(),
            name: configName,
            endpoint: endpoint,
            key: key,
            model: model
        };

        // 2. 保存到历史列表
        let configList = JSON.parse(localStorage.getItem('ai_config_list') || '[]');
        const existIndex = configList.findIndex(c => c.name === configName);
        if (existIndex >= 0) {
            configList[existIndex] = newConfig; // 覆盖旧的
        } else {
            configList.push(newConfig); // 新增
        }
        localStorage.setItem('ai_config_list', JSON.stringify(configList));

        // 3. 激活并关闭
        activateConfig(newConfig);
        showToast(`✅ 已保存: ${configName}`);
        closeConfigNameModal();
    }

    // 5. 激活配置
    function activateConfig(config) {
        localStorage.setItem('ai_active_config', JSON.stringify(config));

        // 兼容旧的存储方式 (给聊天App用)
        localStorage.setItem('ai_endpoint', config.endpoint);
        localStorage.setItem('ai_key', config.key);
        localStorage.setItem('ai_model', config.model);

        // 更新UI
        document.getElementById('ai-endpoint').value = config.endpoint;
        document.getElementById('ai-key').value = config.key;
        document.getElementById('current-config-name').textContent = config.name;
        updateModelDisplay(config.model);
        document.getElementById('current-model-label').textContent = config.model;
    }

    // 6. 渲染已保存的配置列表 (UI弹窗版)
    function renderConfigList() {
        const container = document.getElementById('config-list-container');
        const list = JSON.parse(localStorage.getItem('ai_config_list') || '[]');
        container.innerHTML = '';

        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:40px;">暂无保存的配置</div>';
            return;
        }

        const group = document.createElement('div'); group.className = 'settings-group';

        list.forEach(config => {
            const item = document.createElement('div');
            item.className = 'settings-item';

            // 点击加载配置
            item.onclick = () => {
                activateConfig(config);
                showToast(`已切换至: ${config.name}`);
                closeSubPage('sub-config-list');
            };

            item.innerHTML = `
                <div>
                    <div class="city-name">${config.name}</div>
                    <div class="city-detail">${config.model}</div>
                </div>
                <span style="color:#666; font-size:12px;">${config.endpoint.replace('https://', '').replace('http://', '')}</span>
            `;
            group.appendChild(item);
        });

        container.appendChild(group);

        // 底部清空按钮 (改为调用新弹窗)
        const clearBtn = document.createElement('div');
        clearBtn.style.textAlign = 'center';
        clearBtn.style.padding = '20px';
        clearBtn.style.color = '#FF3B30';
        clearBtn.style.cursor = 'pointer';
        clearBtn.style.fontSize = '14px';
        clearBtn.innerHTML = '清空所有配置';

        // 关键修改：不再用 confirm，而是打开自定义弹窗
        clearBtn.onclick = openClearConfigModal;

        container.appendChild(clearBtn);
    }

    // --- 清空确认弹窗逻辑 ---
    function openClearConfigModal() {
        const modal = document.getElementById('clear-config-modal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeClearConfigModal() {
        const modal = document.getElementById('clear-config-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function confirmClearConfig() {
        // 执行删除
        localStorage.removeItem('ai_config_list');
        // 刷新列表
        renderConfigList();
        // 提示并关闭
        showToast("已清空所有配置");
        closeClearConfigModal();
    }

    // 7. 测试逻辑 (保持不变)
    async function testSimpleConnection() { /* ...同前... */ }
    async function testAIConnection() { /* ...同前... */ }
    function getCleanEndpoint() { /* ...同前... */ return document.getElementById('ai-endpoint').value.trim().replace(/\/v1\/?$/, '').replace(/\/$/, ''); }
    function logTest(t) { const l=document.getElementById('ai-test-log'); l.innerText+=t+"\n"; l.scrollTop=l.scrollHeight; }

    // 启动
    initAISettings();

    // ================== 10. 字体设置逻辑 (Pro) ==================

    // 系统预设字体 (扩充版 - 安全无版权)
    const systemFonts = [
        { name: "系统默认", family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' },
        { name: "圆体 (Rounded)", family: 'ui-rounded, "Hiragino Maru Gothic ProN", "Quicksand", "Arial Rounded MT Bold", sans-serif' },
        { name: "黑体 (Sans)", family: '"Noto Sans SC", "Heiti SC", "Microsoft YaHei", sans-serif' },
        { name: "宋体 (Serif)", family: '"Songti SC", "Noto Serif SC", "SimSun", serif' },
        { name: "楷体 (KaiTi)", family: '"KaiTi", "STKaiti", "BiauKai", serif' },
        { name: "仿宋 (FangSong)", family: '"FangSong", "STFangsong", serif' },
        { name: "手写 (Handwriting)", family: '"Comic Sans MS", "Chalkboard SE", "Wawati SC", cursive' },
        { name: "代码 (Mono)", family: 'Monaco, Consolas, "Courier New", monospace' }
    ];

    // 当前配置
    let currentFontConfig = {
        family: systemFonts[0].family,
        name: systemFonts[0].name,
        size: 16,   // 实际上作为 base size 参考
        weight: 400,
        isCustom: false
    };

    // 1. 初始化字体
    async function initFontSettings() {
        const saved = JSON.parse(localStorage.getItem('userFontConfig') || 'null');

        if (saved) {
            currentFontConfig = saved;
            // 恢复滑块位置
            document.getElementById('range-size').value = saved.size;
            document.getElementById('range-weight').value = saved.weight;
        }

        // 如果是自定义字体，从数据库加载并注册
        if (currentFontConfig.isCustom) {
            await loadCustomFontFromDB();
        }

        applyFontToBody();
        renderFontList();
    }

    // 2. 应用到全局 (变量驱动版)
    function applyFontToBody() {
        const root = document.documentElement;

        // 1. 设置字体族 (Font Family)
        root.style.setProperty('--ui-font', currentFontConfig.family);

        // 2. 设置粗细 (Font Weight)
        root.style.setProperty('--ui-weight', currentFontConfig.weight);

        // 3. 【关键】设置全局字体大小变量
        // 这样 CSS 里的 var(--app-font-size) 就会收到通知
        root.style.setProperty('--app-font-size', currentFontConfig.size + "px");

        // 更新设置页的数字显示
        document.getElementById('current-font-label').textContent = currentFontConfig.name;
        const sizeLabel = document.getElementById('val-size');
        const weightLabel = document.getElementById('val-weight');

        if(sizeLabel) sizeLabel.textContent = currentFontConfig.size + "px";
        if(weightLabel) weightLabel.textContent = currentFontConfig.weight;
    }

    // 3. 实时调整 (滑块事件)
    function updateFontConfig() {
        const size = document.getElementById('range-size').value;
        const weight = document.getElementById('range-weight').value;

        currentFontConfig.size = size;
        currentFontConfig.weight = weight;

        applyFontToBody();
        saveFontConfig();
    }

    // 4. 选择字体
    function selectFont(index) {
        const font = systemFonts[index];
        currentFontConfig.family = font.family;
        currentFontConfig.name = font.name;
        currentFontConfig.isCustom = false;

        applyFontToBody();
        renderFontList();
        saveFontConfig();
        showToast("字体已切换");
    }

    // 5. 上传自定义字体
    async function handleFontUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const fontName = "UserCustomFont";

            showToast("正在处理字体...");

            try {
                const arrayBuffer = await file.arrayBuffer();
                // 1. 注册字体 (浏览器 API)
                const fontFace = new FontFace(fontName, arrayBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);

                // 2. 存入数据库
                await dbHelper.save('custom_font_blob', file); // 存原文件

                // 3. 应用
                currentFontConfig.family = fontName;
                currentFontConfig.name = "自定义 (" + file.name + ")";
                currentFontConfig.isCustom = true;

                applyFontToBody();
                renderFontList();
                saveFontConfig();
                showToast("✅ 字体上传成功");

            } catch (err) {
                showToast("❌ 字体加载失败: " + err.message);
            }
        }
    }

    // 6. 从数据库加载自定义字体 (开机用)
    async function loadCustomFontFromDB() {
        try {
            const file = await dbHelper.get('custom_font_blob');
            if (file) {
                const arrayBuffer = await file.arrayBuffer();
                const fontFace = new FontFace("UserCustomFont", arrayBuffer);
                await fontFace.load();
                document.fonts.add(fontFace);
            }
        } catch (e) {
            console.log("无自定义字体");
        }
    }

    // 7. 渲染列表
    function renderFontList() {
        const container = document.getElementById('font-list-container');
        if(!container) return;
        container.innerHTML = '';

        // 合并系统字体和当前自定义字体(如果存在)
        let displayList = [...systemFonts];
        if (currentFontConfig.isCustom) {
            displayList.push({ name: currentFontConfig.name, family: "UserCustomFont", isCustom: true });
        }

        displayList.forEach((font, index) => {
            const isSelected = currentFontConfig.family === font.family;
            const item = document.createElement('div');
            item.className = 'ai-list-item'; // 复用之前的样式

            // 点击逻辑
            item.onclick = () => {
                if(font.isCustom) return; // 自定义的是上传后自动选中的
                selectFont(index);
            };

            item.innerHTML = `
                <div class="ai-item-label full" style="font-family:${font.family}">${font.name}</div>
                ${isSelected ? '<span style="color:#0a84ff;font-weight:bold;">✔</span>' : ''}
            `;
            container.appendChild(item);
        });
    }

    function saveFontConfig() {
        localStorage.setItem('userFontConfig', JSON.stringify(currentFontConfig));
    }

    // 恢复默认字体
    function resetFontSettings() {
        // 1. 重置数据
        currentFontConfig = {
            family: systemFonts[0].family,
            name: systemFonts[0].name,
            size: 16,
            weight: 400,
            isCustom: false
        };

        // 2. 恢复 UI 状态
        document.getElementById('range-size').value = 16;
        document.getElementById('range-weight').value = 400;

        // 3. 应用并保存
        applyFontToBody();
        renderFontList();
        saveFontConfig();

        showToast("已恢复系统默认字体");
    }

    // 启动
    initFontSettings();

    // ================== 11. 图标自定义逻辑 (Pro Plus) ==================

    // 定义所有可修改图标的配置
    const iconConfig = {
        // 第一页
        'home-wallpaper': { defaultClass: 'bg-wallpaper' },
        'home-settings':  { defaultClass: 'bg-settings' },
        'home-chat':      { defaultClass: 'bg-chat' },
        'home-music':     { defaultClass: 'bg-music' },
        // Dock
        'dock-role':      { defaultClass: 'bg-role' },
        'dock-world':     { defaultClass: 'bg-world' },
        'dock-manual':    { defaultClass: 'bg-manual' },
        'dock-gallery':   { defaultClass: 'bg-gallery' },
        // 第二页 (新增)
        'home-diary':     { defaultClass: 'bg-diary' },
        'home-wallet':    { defaultClass: 'bg-wallet' },
        'home-shop':      { defaultClass: 'bg-shop' },
        'home-memo':      { defaultClass: 'bg-memo' },
        'home-forum':     { defaultClass: 'bg-forum' },
        'home-phone':     { defaultClass: 'bg-phone' },
        'home-companion': { defaultClass: 'bg-companion' },
        'home-gacha':     { defaultClass: 'bg-gacha' }
    };

    let currentEditIconId = null;

    // 1. 初始化
    async function initIconSettings() {
        for (const key in iconConfig) {
            try {
                const blob = await dbHelper.get(`icon_${key}`);
                if (blob) updateAppIconUI(key, blob);
            } catch (e) {}
        }
    }

    // 2. 触发上传
    function triggerIconUpload(key) {
        currentEditIconId = key;
        document.getElementById('icon-file-input').click();
    }

    // 3. 处理文件
    async function handleIconFileSelect(input) {
        if (input.files && input.files[0] && currentEditIconId) {
            const file = input.files[0];
            await dbHelper.save(`icon_${currentEditIconId}`, file);
            updateAppIconUI(currentEditIconId, file);
            showToast("✅ 图标已更换");
            input.value = '';
        }
    }

    // 4. 还原
    async function resetIcon(key) {
        if(confirm('还原为默认图标？')) {
            await dbHelper.save(`icon_${key}`, null);
            updateAppIconUI(key, null);
            showToast("已还原");
        }
    }

    // 5. 更新 UI (核心)
    function updateAppIconUI(key, blob) {
        const url = blob ? URL.createObjectURL(blob) : null;
        const defaultClass = iconConfig[key].defaultClass;

        // 1. 更新主屏幕/Dock上的真实图标
        const realIcon = document.getElementById(`icon-${key}`);
        if (realIcon) {
            const svg = realIcon.querySelector('.app-svg');
            if (url) {
                realIcon.style.backgroundImage = `url(${url})`;
                realIcon.classList.remove(defaultClass); // 移除默认渐变色
                if(svg) svg.style.display = 'none';      // 隐藏图标
            } else {
                realIcon.style.backgroundImage = 'none';
                realIcon.classList.add(defaultClass);    // 恢复默认渐变色
                if(svg) svg.style.display = 'block';     // 显示图标
            }
        }

        // 2. 更新设置页里的预览图标
        const previewIcon = document.getElementById(`preview-${key}`);
        if (previewIcon) {
            const svg = previewIcon.querySelector('.preview-icon-svg');
            if (url) {
                previewIcon.style.backgroundImage = `url(${url})`;
                previewIcon.classList.remove(defaultClass);
                if(svg) svg.style.display = 'none';
            } else {
                previewIcon.style.backgroundImage = 'none';
                previewIcon.classList.add(defaultClass);
                if(svg) svg.style.display = 'block';
            }
        }
    }

    initIconSettings();

    // ================== 12. 角色书逻辑 (Role Book) ==================

    let roleList = [];
    let currentRoleId = null; // 当前查看的角色ID
    let tempRoleAvatar = null; // 编辑时的临时头像

    // 1. 初始化：加载列表
    function initRoleBook() {
        const saved = localStorage.getItem('role_list_meta');
        roleList = saved ? JSON.parse(saved) : [];
        renderRoleList();
    }

    // 2. 渲染列表
    async function renderRoleList() {
        const container = document.getElementById('role-list-container');
        if(!container) return;
        container.innerHTML = '';

        if (roleList.length === 0) {
            container.innerHTML = '<div style="grid-column:span 2; text-align:center; color:#666; padding:50px;">点击右上角 + 新建角色</div>';
            return;
        }

        for (const role of roleList) {
            const card = document.createElement('div');
            card.className = 'role-card';
            card.onclick = () => openRoleDetail(role.id);

            // 获取头像 (从IndexedDB)
            let avatarUrl = '';
            try {
                const blob = await dbHelper.get(`role_${role.id}_avatar`);
                if (blob) avatarUrl = URL.createObjectURL(blob);
            } catch (e) {}

            card.innerHTML = `
                <div class="role-card-img" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : ''}"></div>
                <div class="role-card-info">
                    <div class="role-card-name">${role.name}</div>
                    <div class="role-card-desc">${role.desc}</div>
                </div>
            `;
            container.appendChild(card);
        }
    }

    // 3. 打开编辑弹窗 (新建或编辑)
    function openRoleEditModal(roleId = null) {
        const modal = document.getElementById('modal-role-edit');
        const title = document.getElementById('role-modal-title');
        const nameInput = document.getElementById('role-edit-name');
        const descInput = document.getElementById('role-edit-desc');
        const avatarPreview = document.getElementById('role-edit-avatar-preview');

        tempRoleAvatar = null; // 重置临时头像
        currentRoleId = roleId; // 标记当前ID (如果是null则为新建)

        if (roleId) {
            // 编辑模式：回显数据
            const role = roleList.find(r => r.id === roleId);
            title.textContent = "编辑角色";
            nameInput.value = role.name;
            descInput.value = role.desc;
            // 回显头像
            dbHelper.get(`role_${roleId}_avatar`).then(blob => {
                if(blob) avatarPreview.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                else avatarPreview.style.backgroundImage = 'none';
            });
        } else {
            // 新建模式
            title.textContent = "新建角色";
            nameInput.value = '';
            descInput.value = '';
            avatarPreview.style.backgroundImage = 'none';
            avatarPreview.innerHTML = '<span style="font-size: 24px; color: #666;">+</span>';
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeRoleModal() {
        document.getElementById('modal-role-edit').classList.remove('active');
        setTimeout(() => document.getElementById('modal-role-edit').style.display = 'none', 300);
    }

    // 4. 预览上传的头像
    function previewRoleAvatar(input) {
        if (input.files && input.files[0]) {
            tempRoleAvatar = input.files[0];
            const url = URL.createObjectURL(tempRoleAvatar);
            const preview = document.getElementById('role-edit-avatar-preview');
            preview.style.backgroundImage = `url(${url})`;
            preview.innerHTML = ''; // 清除加号
        }
    }

    // 5. 保存角色数据
    async function saveRoleData() {
        const name = document.getElementById('role-edit-name').value.trim();
        const desc = document.getElementById('role-edit-desc').value.trim();

        if (!name) { showToast("请输入角色昵称"); return; }

        let roleId = currentRoleId;
        if (!roleId) {
            // 新建：生成ID
            roleId = Date.now().toString();
            roleList.push({ id: roleId, name, desc });
        } else {
            // 编辑：更新列表
            const role = roleList.find(r => r.id === roleId);
            role.name = name;
            role.desc = desc;
        }

        // 保存元数据到 LocalStorage
        localStorage.setItem('role_list_meta', JSON.stringify(roleList));

        // 保存头像到 IndexedDB (如果有更新)
        if (tempRoleAvatar) {
            await dbHelper.save(`role_${roleId}_avatar`, tempRoleAvatar);
        }

        showToast("角色已保存");
        closeRoleModal();
        renderRoleList(); // 刷新列表

        // 如果是在详情页编辑的，刷新详情页
        if(document.getElementById('sub-role-detail').classList.contains('active')) {
            openRoleDetail(roleId);
        }
    }

    // 6. 打开详情页
    async function openRoleDetail(id) {
        currentRoleId = id;
        const role = roleList.find(r => r.id === id);
        if (!role) return;

        // 填充文字
        document.getElementById('role-detail-name').textContent = role.name;
        document.getElementById('role-detail-desc').textContent = role.desc;

        // 加载头像
        const avatarBlob = await dbHelper.get(`role_${id}_avatar`);
        const avatarEl = document.getElementById('role-detail-avatar');
        if (avatarBlob) avatarEl.style.backgroundImage = `url(${URL.createObjectURL(avatarBlob)})`;
        else avatarEl.style.backgroundImage = 'none';

        // 加载自定义背景
        const bgBlob = await dbHelper.get(`role_${id}_bg`);
        const bgEl = document.getElementById('role-detail-bg');
        if (bgBlob) bgEl.style.backgroundImage = `url(${URL.createObjectURL(bgBlob)})`;
        else bgEl.style.backgroundImage = 'none'; // 或者设一个默认图

        // 打开页面
        openSubPage('sub-role-detail');
    }

    // 7. 详情页：更换背景图
    function triggerRoleBgUpload() { document.getElementById('role-bg-input').click(); }
    async function handleRoleBgUpload(input) {
        if (input.files && input.files[0] && currentRoleId) {
            const file = input.files[0];
            await dbHelper.save(`role_${currentRoleId}_bg`, file);

            // 即时更新显示
            document.getElementById('role-detail-bg').style.backgroundImage = `url(${URL.createObjectURL(file)})`;
            showToast("背景已更新");
        }
    }

    // 8. 详情页：编辑当前
    function editCurrentRole() {
        openRoleEditModal(currentRoleId);
    }

    // 9. 详情页：删除当前
    async function deleteCurrentRole() {
        if (confirm("确定要删除这个角色吗？无法恢复。")) {
            // 删列表
            roleList = roleList.filter(r => r.id !== currentRoleId);
            localStorage.setItem('role_list_meta', JSON.stringify(roleList));

            // 删图片 (IndexedDB) - 存 null 覆盖
            await dbHelper.save(`role_${currentRoleId}_avatar`, null);
            await dbHelper.save(`role_${currentRoleId}_bg`, null);

            closeSubPage('sub-role-detail');
            renderRoleList();
            showToast("角色已删除");
        }
    }

    // 启动
    initRoleBook();

    // ================== 13. 世界书逻辑 (World Book) ==================

    let worldList = [];
    let currentWorldId = null;

    // 1. 初始化
    function initWorldBook() {
        const saved = localStorage.getItem('world_book_data');
        worldList = saved ? JSON.parse(saved) : [];
        renderWorldList();
    }

    // 2. 渲染列表
    function renderWorldList() {
        const container = document.getElementById('world-list-container');
        if(!container) return;
        container.innerHTML = '';

        if (worldList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:50px;">暂无设定<br>点击右上角 + 添加</div>';
            return;
        }

        // 按时间倒序排列
        const sortedList = [...worldList].reverse();

        sortedList.forEach(item => {
            const card = document.createElement('div');
            card.className = 'world-card';
            card.onclick = () => openWorldDetail(item.id);

            card.innerHTML = `
                <div class="world-icon-box">
                    <svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="world-info">
                    <div class="world-title">${item.title}</div>
                    <div class="world-preview">${item.content}</div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // 3. 打开/关闭 编辑弹窗
    function openWorldEditModal(id = null) {
        const modal = document.getElementById('modal-world-edit');
        const titleInput = document.getElementById('world-edit-title');
        const contentInput = document.getElementById('world-edit-content');
        const modalTitle = document.getElementById('world-modal-title');

        currentWorldId = id; // 标记当前编辑ID

        if (id) {
            const item = worldList.find(w => w.id === id);
            modalTitle.textContent = "编辑设定";
            titleInput.value = item.title;
            contentInput.value = item.content;
        } else {
            modalTitle.textContent = "新建设定";
            titleInput.value = '';
            contentInput.value = '';
        }

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeWorldModal() {
        document.getElementById('modal-world-edit').classList.remove('active');
        setTimeout(() => document.getElementById('modal-world-edit').style.display = 'none', 300);
    }

    // 5. 查看详情
    function openWorldDetail(id) {
        const item = worldList.find(w => w.id === id);
        if (!item) return;

        currentWorldId = id;
        document.getElementById('view-world-title').textContent = item.title;
        document.getElementById('view-world-content').textContent = item.content;

        openSubPage('sub-world-detail');
    }

    function editCurrentWorld() {
        openWorldEditModal(currentWorldId);
    }

    function deleteCurrentWorld() {
        if(confirm('确定要删除这条设定吗？')) {
            worldList = worldList.filter(w => w.id !== currentWorldId);
            localStorage.setItem('world_book_data', JSON.stringify(worldList));
            closeSubPage('sub-world-detail');
            renderWorldList();
            showToast("已删除");
        }
    }

    // 启动
    initWorldBook();

    // ================== 音乐 App 完整逻辑 (修复版) ==================

    // 全局变量定义
    let appMusicList = [];
    let appPlayQueue = [];
    let currentAppSongIndex = -1;
    let appPlayMode = 0; // 0:顺序, 1:单曲, 2:随机
    let tempSongFile = null;
    let tempSongCover = null;
    const appAudio = new Audio();

    // ================== 补回丢失的：音乐列表渲染函数 ==================
    async function renderAppMusicList() {
        const container = document.getElementById('app-music-list-container');
        const sheetContainer = document.getElementById('sheet-list-content');

        // 防止页面元素还没加载时报错
        if(!container) return;

        container.innerHTML = '';
        if(sheetContainer) sheetContainer.innerHTML = '';

        if (appMusicList.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; margin-top:100px;">暂无歌曲<br>点击右上角 + 添加</div>';
            return;
        }

        // 更新播放队列
        appPlayQueue = [...appMusicList];

        // 定义图标
        const iconInsert = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;opacity:0.7"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.89 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
        const iconMenu = '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;opacity:0.7"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>';

        for (let i = 0; i < appMusicList.length; i++) {
            const song = appMusicList[i];

            let coverUrl = '';
            try {
                const blob = await dbHelper.get('song_cover_' + song.id);
                if(blob) coverUrl = URL.createObjectURL(blob);
            } catch(e){}

            // 生成 HTML 字符串
            const itemHTML = `
                <div class="song-img-box" style="${coverUrl ? 'background-image:url('+coverUrl+')' : ''}"></div>
                <div class="song-info-box" onclick="playAppMusic(${i})">
                    <div class="song-list-title">${song.title}</div>
                    <div class="song-list-artist">${song.artist}</div>
                </div>

                <div style="display:flex; gap:0px; align-items:center;">
                    <button class="song-action-btn" onclick="event.stopPropagation(); playNextImmediately(${i})">
                         ${iconInsert}
                    </button>
                    <button class="song-action-btn" onclick="event.stopPropagation(); openSongMenu('${song.id}')">
                         ${iconMenu}
                    </button>
                </div>
            `;

            // 添加到主列表
            const item = document.createElement('div');
            item.className = 'music-list-item';
            if(i === currentAppSongIndex) item.classList.add('active-playing');
            item.innerHTML = itemHTML;
            container.appendChild(item);

            // 添加到底部 Sheet
            if(sheetContainer) {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'music-list-item';
                sheetItem.innerHTML = itemHTML;
                // Sheet 里点击是播放并关闭
                sheetItem.querySelector('.song-info-box').onclick = function() {
                    playAppMusic(i);
                    closePlaylistSheet();
                };
                sheetContainer.appendChild(sheetItem);
            }
        }
    }

    // 1. 初始化
    function initMusicApp() {
        // 恢复列表数据
        const savedList = localStorage.getItem('app_music_playlist');
        appMusicList = savedList ? JSON.parse(savedList) : [];

        // 恢复全屏背景
        dbHelper.get('music_app_bg').then(blob => {
            if(blob) {
                document.getElementById('full-player-bg').style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
            }
        });

        // 渲染列表 (这就是之前报错找不到的函数)
        renderAppMusicList();

        // 监听播放事件
        appAudio.onended = () => {
            if(appPlayMode === 1) { // 单曲循环
                appAudio.currentTime = 0;
                appAudio.play();
            } else {
                playNextSong();
            }
        };
        appAudio.ontimeupdate = updateFullPlayerUI;
    }

    // ================== 修复后的列表渲染函数 ==================

    // 补全这两个缺失的功能函数，防止点击报错
    function playNextImmediately(index) {
        if (index === currentAppSongIndex) return;
        const song = appPlayQueue[index];
        // 简单提示
        showToast('已设为下一首播放');
        // 如果你要做复杂的插队逻辑，可以在这里操作 appPlayQueue 数组
    }

    function openSongMenu(songId) {
        if(confirm("确定要删除这首歌吗？")) {
            const index = appMusicList.findIndex(s => s.id === songId);
            if(index > -1) deleteSong(index);
        }
    }

    // 3. 播放逻辑
    async function playAppMusic(index) {
        if (index < 0 || index >= appPlayQueue.length) return;

        currentAppSongIndex = index;
        const song = appPlayQueue[index];

        // A. 设置音频源
        if (song.type === 'file') {
            const audioBlob = await dbHelper.get(`song_audio_${song.id}`);
            if(audioBlob) {
                appAudio.src = URL.createObjectURL(audioBlob);
            } else {
                showToast("音频文件丢失");
                return;
            }
        } else {
            appAudio.src = song.url;
        }

        appAudio.play().catch(e => console.log("播放需要交互"));

        // B. 更新 UI
        updateMiniPlayer(song);
        updateFullPlayerInfo(song);
        renderAppMusicList(); // 更新高亮
    }

    async function updateMiniPlayer(song) {
        document.getElementById('mini-title').textContent = song.title;
        document.getElementById('mini-artist').textContent = song.artist;
        document.getElementById('mini-play-btn').textContent = "⏸"; // 这里如果有SVG图标会被文字覆盖，最好用 innerHTML 换图标

        const miniCover = document.getElementById('mini-cover');
        const blob = await dbHelper.get(`song_cover_${song.id}`);
        if(blob) miniCover.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
    }

    async function updateFullPlayerInfo(song) {
        document.getElementById('full-title').textContent = song.title;
        document.getElementById('full-artist').textContent = song.artist;

        // 更新大封面
        const fullCover = document.getElementById('full-cover');
        fullCover.classList.add('playing');
        const blob = await dbHelper.get(`song_cover_${song.id}`);
        if(blob) fullCover.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
        else fullCover.style.backgroundImage = 'none';

        // 歌词
        const lyrics = song.lyrics || "暂无歌词 - 点击添加";
        document.getElementById('current-lyric-line').textContent = lyrics.split('\n')[0];
    }

    // 4. 播放控制
    // --- 更新播放控制逻辑 (同步所有播放器) ---
    function togglePlayState() {
        // 1. 核心音频控制
        if (appAudio.paused) {
            appAudio.play();
        } else {
            appAudio.pause();
        }

        // 2. 同步全屏播放器图标
        const fullPlayIcon = document.getElementById('fp-icon-play');
        const fullPauseIcon = document.getElementById('fp-icon-pause');
        const fullCover = document.getElementById('full-cover');
        const miniCover = document.getElementById('mini-cover'); // 迷你封面

        if (appAudio.paused) {
            if(fullPlayIcon) fullPlayIcon.style.display = 'block';
            if(fullPauseIcon) fullPauseIcon.style.display = 'none';
            if(fullCover) fullCover.classList.remove('playing');
            if(miniCover) miniCover.classList.remove('playing');
        } else {
            if(fullPlayIcon) fullPlayIcon.style.display = 'none';
            if(fullPauseIcon) fullPauseIcon.style.display = 'block';
            if(fullCover) fullCover.classList.add('playing');
            if(miniCover) miniCover.classList.add('playing');
        }

        // 3. 同步迷你播放器图标
        const miniPlayIcon = document.getElementById('mini-icon-play');
        const miniPauseIcon = document.getElementById('mini-icon-pause');
        if(miniPlayIcon && miniPauseIcon) {
            if (appAudio.paused) {
                miniPlayIcon.style.display = 'block';
                miniPauseIcon.style.display = 'none';
            } else {
                miniPlayIcon.style.display = 'none';
                miniPauseIcon.style.display = 'block';
            }
        }

        // 4. 【关键】同步悬浮窗图标 (修复你的报错)
        syncPopupPlayIcon();
    }

    // 5. 弹窗与上传逻辑 (修复 TypeError)
    function openMusicUploadModal() {
        // 重置输入框
        document.getElementById('new-song-title').value = '';
        document.getElementById('new-song-artist').value = '';
        document.getElementById('new-song-filename').textContent = '未选择';
        tempSongFile = null;
        tempSongCover = null;

        const modal = document.getElementById('modal-music-upload');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeMusicUploadModal() {
        const modal = document.getElementById('modal-music-upload');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function handleNewSongFile(input) {
        if (input.files && input.files[0]) {
            tempSongFile = input.files[0];
            document.getElementById('new-song-filename').textContent = tempSongFile.name;
            switchAudioSource('file');
        }
    }

    function switchAudioSource(type) {
        if(type === 'file') {
            document.getElementById('src-file-area').style.display = 'block';
            document.getElementById('src-url-area').style.display = 'none';
            document.getElementById('btn-src-file').classList.add('active');
            document.getElementById('btn-src-url').classList.remove('active');
        } else {
            document.getElementById('src-file-area').style.display = 'none';
            document.getElementById('src-url-area').style.display = 'block';
            document.getElementById('btn-src-file').classList.remove('active');
            document.getElementById('btn-src-url').classList.add('active');
        }
    }

    function previewNewSongCover(input) {
        if (input.files && input.files[0]) {
            tempSongCover = input.files[0];
            document.getElementById('upload-cover-preview').style.backgroundImage = `url(${URL.createObjectURL(tempSongCover)})`;
        }
    }

    async function saveNewSong() {
        const title = document.getElementById('new-song-title').value.trim() || '未知歌曲';
        const artist = document.getElementById('new-song-artist').value.trim() || '未知歌手';
        const isFile = document.getElementById('btn-src-file').classList.contains('active');

        const songId = Date.now().toString();
        const newSong = { id: songId, title, artist, type: isFile ? 'file' : 'url', lyrics: '' };

        showToast("正在保存...");

        if (isFile) {
            if (!tempSongFile) { showToast("请选择MP3文件"); return; }
            await dbHelper.save(`song_audio_${songId}`, tempSongFile);
        } else {
            const url = document.getElementById('new-song-url').value;
            if (!url) { showToast("请输入URL"); return; }
            newSong.url = url;
        }

        if (tempSongCover) {
            await dbHelper.save(`song_cover_${songId}`, tempSongCover);
        }

        appMusicList.push(newSong);
        localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

        closeMusicUploadModal();
        renderAppMusicList();
        showToast("添加成功！");
    }

    // 删除歌曲
    async function deleteSong(index) {
        if(confirm('确定删除吗？')) {
            const song = appMusicList[index];
            appMusicList.splice(index, 1);
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));
            await dbHelper.save(`song_audio_${song.id}`, null);
            await dbHelper.save(`song_cover_${song.id}`, null);
            renderAppMusicList();
            showToast("已删除");
        }
    }

    // 6. 全屏界面交互
    function openFullPlayer() {
        document.getElementById('music-view-full').classList.add('active');

        // --- 新增：同步播放状态 ---
        const fullPlayIcon = document.getElementById('fp-icon-play');
        const fullPauseIcon = document.getElementById('fp-icon-pause');
        const fullCover = document.getElementById('full-cover');

        if (appAudio.paused) {
            // 如果是暂停的，显示播放(三角形)
            fullPlayIcon.style.display = 'block';
            fullPauseIcon.style.display = 'none';
            fullCover.classList.remove('playing');
        } else {
            // 如果正在播放，显示暂停(双竖线)
            fullPlayIcon.style.display = 'none';
            fullPauseIcon.style.display = 'block';
            fullCover.classList.add('playing');
        }
        // -----------------------
    }
    function closeFullPlayer() {
        document.getElementById('music-view-full').classList.remove('active');
    }

    // ================== 统一 UI 更新逻辑 (全屏 + 悬浮窗) ==================
    // --- 更新进度条逻辑 (包含悬浮窗) ---
    function updateFullPlayerUI() {
        if(!appAudio.duration) return;

        const current = appAudio.currentTime;
        const total = appAudio.duration;
        const percent = (current / total) * 100;

        // 格式化时间 00:00
        const fmt = (t) => {
            const m = Math.floor(t/60);
            const s = Math.floor(t%60);
            return `${m}:${s<10?'0':''}${s}`;
        };

        const timeStrCurrent = fmt(current);
        const timeStrTotal = fmt(total);

        // 1. 更新全屏播放器
        const fullSlider = document.getElementById('music-slider');
        if(fullSlider) {
            fullSlider.value = percent;
            document.getElementById('time-current').textContent = timeStrCurrent;
            document.getElementById('time-total').textContent = timeStrTotal;
        }

        // 2. 更新悬浮窗播放器 (新增)
        const popupSlider = document.getElementById('popup-slider');
        if(popupSlider) {
            popupSlider.value = percent;
            document.getElementById('popup-time-current').textContent = timeStrCurrent;
            document.getElementById('popup-time-total').textContent = timeStrTotal;
        }
    }

    function seekAudio(val) {
        if(appAudio.duration) {
            appAudio.currentTime = (val/100) * appAudio.duration;
        }
    }

    function openPlaylistSheet() {
        document.getElementById('sheet-playlist').style.transform = 'translateY(0)';
    }
    function closePlaylistSheet() {
        document.getElementById('sheet-playlist').style.transform = 'translateY(100%)';
    }

    function togglePlayMode() {
        document.getElementById(`icon-mode-${appPlayMode}`).style.display = 'none';
        appPlayMode = (appPlayMode + 1) % 3;
        document.getElementById(`icon-mode-${appPlayMode}`).style.display = 'block';
        showToast(["顺序播放", "单曲循环", "随机播放"][appPlayMode]);
    }

    // 歌词逻辑
    function openLyricsModal() {
        const song = appPlayQueue[currentAppSongIndex];
        if(!song) return;
        document.getElementById('lyrics-input').value = song.lyrics || '';
        const modal = document.getElementById('modal-lyrics');
        modal.style.display = 'flex';
        modal.style.zIndex = '2000';
        setTimeout(()=>modal.classList.add('active'), 10);
    }
    function saveLyrics() {
        const text = document.getElementById('lyrics-input').value;
        if(currentAppSongIndex >= 0) {
            appPlayQueue[currentAppSongIndex].lyrics = text;
            const id = appPlayQueue[currentAppSongIndex].id;
            const mainItem = appMusicList.find(s => s.id === id);
            if(mainItem) mainItem.lyrics = text;
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));
            document.getElementById('current-lyric-line').textContent = text.split('\n')[0];
        }
        document.getElementById('modal-lyrics').classList.remove('active');
        setTimeout(()=>document.getElementById('modal-lyrics').style.display='none',300);
    }

    // 处理歌词文件导入
    function handleLrcFile(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                // 把文件内容填入文本框
                document.getElementById('lyrics-input').value = e.target.result;
                showToast("歌词已导入，请点击保存");
            };
            reader.readAsText(input.files[0]);
        }
    }

    // 插队播放 (下一首)
    function playNextImmediately(index) {
        if (index === currentAppSongIndex) return; // 正在放的不用插队
        const song = appPlayQueue[index];

        // 简单的逻辑：先从列表删掉，再插到当前位置后面
        // 注意：这里只是演示逻辑，真实逻辑可能需要处理 appMusicList 和 appPlayQueue 的同步
        // 为了简单，我们只弹个窗提示，或者你可以只做逻辑不删原位置

        // 这里做最简单的：提示
        showToast(`已将《${song.title}》添加到下一首`);
        // 复杂逻辑你可以后续再加，先把按钮显示出来要紧
    }

    // 打开菜单 (三个点) - 之前写过，这里确认一下
    function openSongMenu(songId) {
        // 你的 HTML 里需要有 id="modal-song-menu" 的弹窗结构
        // 如果没有，可以先用 alert 代替，或者补上弹窗 HTML
        if(confirm("确定要删除这首歌吗？")) {
            // 找到 index
            const index = appMusicList.findIndex(s => s.id === songId);
            if(index > -1) deleteSong(index);
        }
    }

    // ================== 增强版菜单逻辑 ==================

    let activeMenuSongId = null; // 记录当前点击的是哪首歌的 ID

    // 1. 打开底部菜单
    function openSongMenu(songId) {
        activeMenuSongId = songId; // 记住ID
        const modal = document.getElementById('modal-song-menu');
        modal.style.display = 'flex';
        // 强制层级最高
        modal.style.zIndex = '2100';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeSongMenu() {
        const modal = document.getElementById('modal-song-menu');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // 2. 编辑歌曲逻辑
    function openEditSongModal() {
        closeSongMenu(); // 先关掉底部菜单

        // 找到当前歌曲信息
        const song = appMusicList.find(s => s.id === activeMenuSongId);
        if (!song) return;

        // 回显数据
        document.getElementById('edit-title-input').value = song.title;
        document.getElementById('edit-artist-input').value = song.artist;

        // 打开编辑弹窗
        const modal = document.getElementById('modal-edit-song');
        modal.style.display = 'flex';
        modal.style.zIndex = '2200';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeEditSongModal() {
        const modal = document.getElementById('modal-edit-song');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    function saveSongEdit() {
        const newTitle = document.getElementById('edit-title-input').value.trim();
        const newArtist = document.getElementById('edit-artist-input').value.trim();

        if (!newTitle) { showToast("标题不能为空"); return; }

        // 更新内存数据
        const songIndex = appMusicList.findIndex(s => s.id === activeMenuSongId);
        if (songIndex > -1) {
            appMusicList[songIndex].title = newTitle;
            appMusicList[songIndex].artist = newArtist;

            // 更新 localStorage
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

            // 刷新列表界面
            renderAppMusicList();

            // 如果正在放这首歌，顺便更新播放器界面
            if (currentAppSongIndex === songIndex) {
                document.getElementById('mini-title').textContent = newTitle;
                document.getElementById('mini-artist').textContent = newArtist;
                document.getElementById('full-title').textContent = newTitle;
                document.getElementById('full-artist').textContent = newArtist;
            }

            showToast("修改已保存");
            closeEditSongModal();
        }
    }

    // 3. 删除确认逻辑
    function openDeleteConfirmModal() {
        closeSongMenu(); // 先关掉底部菜单

        const song = appMusicList.find(s => s.id === activeMenuSongId);
        if(song) {
            document.getElementById('del-song-name').textContent = `《${song.title}》`;
        }

        const modal = document.getElementById('modal-delete-confirm');
        modal.style.display = 'flex';
        modal.style.zIndex = '2200';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeDeleteConfirmModal() {
        const modal = document.getElementById('modal-delete-confirm');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    async function confirmDeleteSong() {
        // 执行删除
        const index = appMusicList.findIndex(s => s.id === activeMenuSongId);
        if (index > -1) {
            // 1. 删数据
            appMusicList.splice(index, 1);
            localStorage.setItem('app_music_playlist', JSON.stringify(appMusicList));

            // 2. 删文件 (IndexedDB)
            await dbHelper.save(`song_audio_${activeMenuSongId}`, null);
            await dbHelper.save(`song_cover_${activeMenuSongId}`, null);

            // 3. 刷新界面
            renderAppMusicList();
            showToast("已删除");

            // 如果删的是当前正在放的，停止播放
            if (index === currentAppSongIndex) {
                appAudio.pause();
                appAudio.src = "";
                document.getElementById('mini-player-bar').style.display = 'none'; // 隐藏播放条
            }
        }
        closeDeleteConfirmModal();
    }

    // ================== 补全播放器背景上传功能 ==================

    // 1. 触发点击隐藏的 input
    function triggerMusicBgUpload() {
        const input = document.getElementById('music-bg-input');
        if (input) {
            input.click();
        } else {
            console.error("找不到 id='music-bg-input' 的元素，请检查 HTML");
        }
    }

    // 2. 处理图片文件
    function handleMusicBgUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];

            // 保存到数据库 (下次打开还能记得)
            dbHelper.save('music_app_bg', file);

            // 立即更新界面背景
            const url = URL.createObjectURL(file);

            // 注意：我们之前把背景层改到了 #full-player-bg
            const bgLayer = document.getElementById('full-player-bg');
            if (bgLayer) {
                bgLayer.style.backgroundImage = `url(${url})`;
                showToast("播放器背景已更新");
            }
        }
    }

    // 启动
    initMusicApp();

        // ================== 灵动岛核心逻辑 (修复完整版) ==================

    // 默认配置
    let islandConfig = {
        master: true,
        charge: true,
        music: true
    };
    let islandTimer = null;

    // 1. 初始化
    function initDynamicIsland() {
        const saved = localStorage.getItem('island_config');
        if (saved) islandConfig = JSON.parse(saved);

        // 初始化 UI 状态
        updateIslandState();

        // 更新设置页开关显示 (防止报错)
        const swCharge = document.getElementById('switch-island-charge');
        const swMusic = document.getElementById('switch-island-music');
        if(swCharge) swCharge.checked = islandConfig.charge;
        if(swMusic) swMusic.checked = islandConfig.music;

        // 绑定电池监听
        if ('getBattery' in navigator) {
            navigator.getBattery().then(b => {
                b.addEventListener('chargingchange', () => {
                    if (b.charging) {
                        triggerIsland('charge', { text: Math.round(b.level * 100) + '%' });
                    }
                });
            });
        }

        // 绑定音乐监听
        appAudio.addEventListener('play', () => {
            const currentSong = appPlayQueue[currentAppSongIndex];
            const title = currentSong ? currentSong.title : '正在播放';
            // 触发展开动画
            triggerIsland('music', { text: title });
        });

        appAudio.addEventListener('pause', () => {
            updateIslandState(); // 暂停时缩回
        });
    }

    // ================== 修复后的状态刷新函数 ==================
    function updateIslandState() {
        const island = document.getElementById('dynamic-island');
        const left = document.getElementById('island-icon');
        const center = document.getElementById('island-text');
        const right = document.getElementById('island-info');

        // A. 音乐常驻模式 (只要正在播放，且没播完)
        if (appAudio && !appAudio.paused && !appAudio.ended) {
            island.className = 'island-container music-active';

            // 核心修复：强制注入波形 HTML
            left.innerHTML = `
                <div class="island-sound-wave">
                    <span></span><span></span><span></span><span></span>
                </div>
            `;

            // 清空其他文字，防止干扰
            center.textContent = '';
            right.textContent = '';

            // 点击回音乐App
            island.onclick = () => openApp('app-music');
            return;
        }

        // B. 待机模式
        if (islandConfig.master) {
            island.className = 'island-container idle-show';
            // 清空所有内容
            left.innerHTML = '';
            center.textContent = '';
            right.textContent = '';
            island.onclick = null;
        } else {
            island.className = 'island-container'; // 隐藏
            island.onclick = null;
        }
    }

    // 3. 触发通知动画 (核心修改：音乐布局)
    function triggerIsland(type, data) {
        // 检查子开关 (如果没开对应的功能，就不弹窗，但如果是强制测试则忽略)
        if (type === 'charge' && !islandConfig.charge) return;
        if (type === 'music' && !islandConfig.music) return;

        const island = document.getElementById('dynamic-island');
        const left = document.getElementById('island-icon');
        const center = document.getElementById('island-text');
        const right = document.getElementById('island-info');

        if (islandTimer) clearTimeout(islandTimer);

        // --- 布局填充 ---
        if (type === 'charge') {
            // 充电：左闪电，中文字，右电量
            left.innerHTML = '<span style="color:#34C759">⚡</span>';
            center.innerHTML = 'Charging';
            right.innerHTML = `<span style="color:#34C759">${data.text}</span>`;
        }
        else if (type === 'music') {
            // 音乐：左音符，中歌名+波形，右空
            left.innerHTML = '🎵';
            // 核心修改：歌名旁边加律动效果
            center.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    <span>${data.text}</span>
                    <div class="island-sound-wave">
                        <span style="background:#fff"></span>
                        <span style="background:#fff"></span>
                        <span style="background:#fff"></span>
                    </div>
                </div>
            `;
            right.innerHTML = '';
        }

        // 强制展开
        island.classList.remove('idle-show', 'music-active');
        island.classList.add('active');

        // 3秒后自动收缩
        islandTimer = setTimeout(() => {
            island.classList.remove('active');
            updateIslandState(); // 恢复到该有的状态
        }, 3000);
    }

    // 4. 设置相关函数 (之前缺失的)
    function toggleIslandMaster() {
        islandConfig.master = document.getElementById('switch-island-master').checked;
        saveIslandConfig(); // 保存
        updateIslandState(); // 刷新显示
    }

    // 修复报错：定义保存函数
    function saveIslandConfig() {
        const swCharge = document.getElementById('switch-island-charge');
        const swMusic = document.getElementById('switch-island-music');

        // 更新配置
        if(swCharge) islandConfig.charge = swCharge.checked;
        if(swMusic) islandConfig.music = swMusic.checked;

        localStorage.setItem('island_config', JSON.stringify(islandConfig));
    }

    // 修复报错：定义测试函数
    function testIsland(mode) {
        if(mode === 'charge') {
            // 强制触发，忽略开关检查
            const island = document.getElementById('dynamic-island');
            // 临时模拟开关开启以确保能看到效果
            const oldState = islandConfig.charge;
            islandConfig.charge = true;
            triggerIsland('charge', { text: '100%' });
            islandConfig.charge = oldState;
        } else {
            const oldState = islandConfig.music;
            islandConfig.music = true;
            triggerIsland('music', { text: 'Test Song' });
            islandConfig.music = oldState;
        }
    }

    // ================== 修复版：灵动岛悬浮窗逻辑 ==================

    function openIslandPopup() {
        // 1. 安全检查：如果没有正在播放的歌，就不弹窗
        if (currentAppSongIndex < 0 || !appPlayQueue[currentAppSongIndex]) {
            console.log("当前没有播放歌曲");
            return;
        }
        const song = appPlayQueue[currentAppSongIndex];

        // 2. 填充数据
        const titleEl = document.getElementById('popup-title');
        const artistEl = document.getElementById('popup-artist');
        if (titleEl) titleEl.textContent = song.title;
        if (artistEl) artistEl.textContent = song.artist;

        // 填充封面
        dbHelper.get('song_cover_' + song.id).then(blob => {
            const img = blob ? URL.createObjectURL(blob) : '';
            const coverEl = document.getElementById('popup-cover');
            if (coverEl) {
                if (img) coverEl.style.backgroundImage = `url(${img})`;
                else coverEl.style.backgroundImage = 'none';
            }
        });

        // 同步播放按钮
        syncPopupPlayIcon();

        // 3. 显示动画 (核心修复：加了判断是否存在)
        const popup = document.getElementById('island-popup-player');
        const mask = document.getElementById('island-popup-mask');

        if (popup) popup.classList.add('active');
        else console.error("错误：HTML中找不到 id='island-popup-player'");

        if (mask) mask.classList.add('active');
    }

    function closeIslandPopup() {
        const popup = document.getElementById('island-popup-player');
        const mask = document.getElementById('island-popup-mask');

        if (popup) popup.classList.remove('active');
        if (mask) mask.classList.remove('active');
    }

    // ================== 修改 updateIslandState (核心绑定) ==================
    // 请找到原本的 updateIslandState 函数，修改 if 里的 onclick 绑定

    function updateIslandState() {
        const island = document.getElementById('dynamic-island');
        const left = document.getElementById('island-icon');

        // A. 音乐常驻模式
        if (appAudio && !appAudio.paused && !appAudio.ended) {
            island.className = 'island-container music-active';
            left.innerHTML = '<div class="island-sound-wave"><span></span><span></span><span></span><span></span></div>';

            // --- 修改这里：点击改为打开悬浮窗 ---
            island.onclick = () => openIslandPopup();
            // --------------------------------
            return;
        }

        // B. 待机模式
        if (islandConfig.master) {
            island.className = 'island-container idle-show';
            left.innerHTML = '';
            island.onclick = null;
        } else {
            island.className = 'island-container';
            island.onclick = null;
        }
    }

    // --- 补全缺失的辅助函数 ---
    function syncPopupPlayIcon() {
        const playIcon = document.getElementById('popup-icon-play');
        const pauseIcon = document.getElementById('popup-icon-pause');

        // 安全检查，防止报错
        if (!playIcon || !pauseIcon) return;

        if (appAudio.paused) {
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
        } else {
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
        }
    }

    // 启动
    initDynamicIsland();

        // ================== 【独立追加】一起听歌功能模块 ==================

    // 1. 打开页面逻辑
    function openListenTogetherPage() {
        console.log("正在尝试打开一起听..."); // 调试用

        const page = document.getElementById('sub-listen-together');

        if (page) {
            // 1. 强制弹出
            page.classList.add('active');

            // 2. 尝试同步心电图状态 (如果函数存在)
            if (typeof syncVisualizerState === 'function') {
                syncVisualizerState();
            }
        } else {
            // 如果找不到页面，弹窗提示你（说明HTML贴错位置了）
            alert("错误：找不到 id='sub-listen-together' 的页面！请检查HTML是否粘贴在 body 内。");
        }
    }

    // 关闭函数
    function closeSubPage(id) {
        const page = document.getElementById(id);
        if (page) {
            page.classList.remove('active');
        }
    }

    // 2. 心电图联动逻辑 (控制 .playing 类名)
    function syncVisualizerState() {
        const connection = document.querySelector('.visual-connection');
        // 如果 connection 存在，并且音乐正在播放，就加 playing 让它跳动
        if (connection) {
            if (appAudio && !appAudio.paused) {
                connection.classList.add('playing');
            } else {
                connection.classList.remove('playing');
            }
        }
    }

    // 3. 监听器：让心电图跟随音乐自动启停
    // (这段代码会自动挂载到你现有的播放器上)
    if (typeof appAudio !== 'undefined') {
        appAudio.addEventListener('play', syncVisualizerState);
        appAudio.addEventListener('pause', syncVisualizerState);
    }

    // 4. 角色选择与用户编辑 (逻辑补全)
    let currentListenRole = null;
    let currentListenUser = { name: '我', identity: 'User' };
    let tempListenUserAvatar = null;

    // ================== 角色选择逻辑修复版 ==================

// ================== 角色选择列表 (修复版：带头像+适配浅色) ==================

function openListenRoleSelector() {
    const list = document.getElementById('listen-role-list');
    if (!list) return;

    list.innerHTML = ''; // 清空列表

    // 检查是否有角色数据
    if (typeof roleList === 'undefined' || roleList.length === 0) {
        list.innerHTML = '<div style="padding:30px;text-align:center;color:#666;font-size:14px;">暂无角色<br>请先去角色书添加</div>';
    } else {
        // 遍历生成列表
        roleList.forEach((role, index) => {
            // 创建容器
            const div = document.createElement('div');
            div.className = 'role-select-item'; // 使用新定义的 CSS 类

            // 默认头像占位
            let avatarHtml = `<div class="role-tiny-avatar" id="temp-avatar-${role.id}">${role.name[0]}</div>`;

            // 插入 HTML (注意：这里不再写 style="color:white")
            div.innerHTML = `
                ${avatarHtml}
                <span class="role-select-name">${role.name}</span>
            `;

            // 绑定点击事件
            div.onclick = function() {
                selectListenRole(index);
            };

            list.appendChild(div);

            // 异步加载真实头像 (如果有)
            dbHelper.get('role_' + role.id + '_avatar').then(blob => {
                if (blob) {
                    const imgUrl = URL.createObjectURL(blob);
                    const avatarEl = document.getElementById(`temp-avatar-${role.id}`);
                    if (avatarEl) {
                        avatarEl.style.backgroundImage = `url(${imgUrl})`;
                        avatarEl.textContent = ''; // 有图就不显示文字了
                    }
                }
            });
        });
    }

    // 显示弹窗
    const modal = document.getElementById('modal-select-role');
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }
}

// 选择角色回调
    function selectListenRole(index) {
        // 兼容处理：如果传入的是对象(旧逻辑)还是索引(新逻辑)
        let role;
        if (typeof index === 'object') role = index;
        else role = roleList[index];

        if (!role) return;

        currentListenRole = role;
        document.getElementById('listen-role-name').textContent = role.name;

        // 加载头像
        dbHelper.get('role_' + role.id + '_avatar').then(blob => {
            const el = document.getElementById('listen-role-avatar');
            if(blob) {
                // 有图：设置图片
                el.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                el.style.backgroundColor = 'transparent'; // <--- 手动强制透明
                el.innerHTML = '';
            } else {
                // 没图
                el.style.backgroundImage = 'none';
                el.innerHTML = role.name[0];
            }
        });

        // 2. 激活样式 (关键)
        const leftAvatar = document.getElementById('listen-role-avatar');
        if(leftAvatar) {
            leftAvatar.classList.remove('empty');     // 移除“空”样式
            leftAvatar.classList.add('active-role');  // 添加“激活”样式
        }

        // 3. 激活连线
        const leftBridge = document.getElementById('bridge-left');
        if (leftBridge) leftBridge.classList.add('show');

        closeModal('modal-select-role');
        addChatMsg('system', `已邀请 ${role.name} 加入`);
    }

    function openListenUserEdit() {
        const modal = document.getElementById('modal-edit-user');
        if(modal) {
            modal.style.display = 'flex';
            setTimeout(()=>modal.classList.add('active'),10);
            document.getElementById('listen-user-nick-input').value = currentListenUser.name;
            document.getElementById('listen-user-identity-input').value = currentListenUser.identity || '';
        }
    }

    function saveListenUser() {
        const name = document.getElementById('listen-user-nick-input').value.trim();
        const identity = document.getElementById('listen-user-identity-input').value.trim();

        if(name) currentListenUser.name = name;
        if(identity) currentListenUser.identity = identity;

        // 处理头像
        if(tempListenUserAvatar) {
            const el = document.getElementById('listen-user-avatar');
            el.style.backgroundImage = `url(${URL.createObjectURL(tempListenUserAvatar)})`;
            el.innerHTML = '';
        }

        document.getElementById('listen-user-name').textContent = currentListenUser.name;
        closeModal('modal-edit-user');
    }

    function previewListenUserAvatar(input) {
        if(input.files && input.files[0]) {
            tempListenUserAvatar = input.files[0];
            const el = document.getElementById('edit-user-preview');
            el.style.backgroundImage = `url(${URL.createObjectURL(tempListenUserAvatar)})`;
            el.innerHTML = '';
        }
    }

    // 5. 聊天相关
    function sendListenMessage() {
        const input = document.getElementById('listen-input');
        const text = input.value.trim();
        if(!text) return;
        addChatMsg('right', text);
        input.value = '';
    }

    function triggerAiReply() {
        if(!currentListenRole) {
            showToast("请先选择左侧角色");
            return;
        }
        showToast("思考中...");
        setTimeout(() => {
            const replies = ["这首歌的旋律真不错。", "我也很喜欢听这首。", "和你一起听歌真好。"];
            const reply = replies[Math.floor(Math.random() * replies.length)];
            addChatMsg('left', reply);
        }, 1000);
    }

    function addChatMsg(side, text) {
        const box = document.getElementById('listen-chat-box');
        const div = document.createElement('div');
        if(side === 'system') {
            div.className = 'chat-msg system';
            div.innerHTML = `<span>${text}</span>`;
        } else {
            div.className = `chat-msg ${side}`;
            div.innerHTML = `<div class="msg-bubble-listen">${text}</div>`;
        }
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function clearListenChat() {
        if(confirm("清空记录？")) {
            document.getElementById('listen-chat-box').innerHTML = '<div class="chat-msg system"><span>记录已清空</span></div>';
        }
    }

    // 通用关闭
    function closeModal(id) {
        const m = document.getElementById(id);
        if(m) {
            m.classList.remove('active');
            setTimeout(()=>m.style.display='none', 300);
        }
    }

    // 心电图联动逻辑
function syncVisualizerState() {
    const connection = document.querySelector('.visual-connection');
    // 如果 connection 存在，并且音乐正在播放，就加 playing 让爱心狂跳
    if (connection) {
        if (appAudio && !appAudio.paused) {
            connection.classList.add('playing');
        } else {
            connection.classList.remove('playing');
        }
    }
}

// 确保监听了播放事件
if (typeof appAudio !== 'undefined') {
    appAudio.addEventListener('play', syncVisualizerState);
    appAudio.addEventListener('pause', syncVisualizerState);
}

    // ================== 一起听歌：强力计时器逻辑 ==================

// 1. 定义全局变量
window.listenTotalSeconds = 0;
window.listenTimerID = null;

// 2. 更新 UI 的函数
function updateTimerDisplay() {
    const el = document.getElementById('listen-timer-text');
    if (el) {
        window.listenTotalSeconds++;
        const m = Math.floor(window.listenTotalSeconds / 60).toString().padStart(2, '0');
        const s = (window.listenTotalSeconds % 60).toString().padStart(2, '0');
        el.textContent = `${m}:${s}`;
    }
}

// 3. 启动计时器
function startTimer() {
    if (!window.listenTimerID) {
        console.log("▶️ 计时器启动");
        window.listenTimerID = setInterval(updateTimerDisplay, 1000);

        // 同时让爱心跳动 (确保动效同步)
        const heart = document.querySelector('.visual-heart-icon-red');
        if (heart) heart.classList.add('beating');
    }
}

// 4. 停止计时器
function stopTimer() {
    if (window.listenTimerID) {
        console.log("⏸️ 计时器暂停");
        clearInterval(window.listenTimerID);
        window.listenTimerID = null;

        // 停止爱心跳动
        const heart = document.querySelector('.visual-heart-icon-red');
        if (heart) heart.classList.remove('beating');
    }
}

// 5. 绑定播放器事件 (确保 appAudio 存在)
if (typeof appAudio !== 'undefined') {
    // 监听播放
    appAudio.addEventListener('play', startTimer);
    // 监听暂停
    appAudio.addEventListener('pause', stopTimer);
    // 监听结束
    appAudio.addEventListener('ended', stopTimer);

    // ⚡️ 补救措施：如果刷新页面时音乐已经在放了，立即开始计时
    if (!appAudio.paused && !appAudio.ended) {
        startTimer();
    }
} else {
    console.error("❌ 错误：找不到 appAudio 播放器对象！请确保 JS 放在 appAudio 定义之后。");
}

    // ================== 一起听歌：AI 深度交互逻辑 ==================

// 定义一个专门用于一起听的聊天记录数组
let listenChatHistory = [];

// 1. 发送消息 (User) - 重写版
function sendListenMessage() {
    const input = document.getElementById('listen-input');
    const text = input.value.trim();
    if (!text) return;

    // A. 上屏
    addChatMsg('right', text);

    // B. 存入历史记录
    listenChatHistory.push({ role: "user", content: text });

    // C. 清空输入框
    input.value = '';
}

// 2. 触发 AI 回复 (AI) - 核心重写版
async function triggerAiReply() {
    // --- 步骤 1: 检查必要条件 ---

    // 检查角色
    if (!currentListenRole) {
        showToast("请先点击左侧圆圈选择一个角色");
        return;
    }

    // 检查 API 配置
    const aiConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');
    if (!aiConfig.key) {
        showToast("请先在【设置 -> AI模型】中配置 API Key");
        return;
    }

    // --- 步骤 2: 构建“环境信息” (Prompt) ---

    // A. 获取正在播放的歌曲信息
    let musicInfo = "当前环境安静，没有播放音乐。";
    if (typeof appAudio !== 'undefined' && !appAudio.paused && appPlayQueue[currentAppSongIndex]) {
        const song = appPlayQueue[currentAppSongIndex];
        musicInfo = `当前正在一起听的歌曲是：《${song.title}》，歌手是：${song.artist}。`;
    }

    // B. 构建系统提示词 (注入灵魂)
    // 包含：角色设定 + 用户设定 + 音乐环境
    const systemPrompt = `
        你现在需要进行一场沉浸式角色扮演。

        【你的身份】
        名字：${currentListenRole.name}
        人设详情：${currentListenRole.desc}

        【对话对象】
        名字：${currentListenUser.name}
        身份/关系：${currentListenUser.identity || '朋友'}

        【当前场景】
        你们正在“一起听”房间里听歌。
        ${musicInfo}

        【回复要求】
        1. 必须完全代入${currentListenRole.name}的语调和性格。
        2. 回复要简短、口语化，像在微信/即时通讯软件里聊天。
        3. 结合当前的音乐氛围，或者针对${currentListenUser.name}刚才说的话进行回复。
        4. 不要出现“AI语言”，不要说自己是模型。
    `.trim();

    // --- 步骤 3: 准备发送给模型的消息列表 ---

    // 组合：系统提示词 + 最近的聊天记录 (为了节省token，可以只取最近10条)
    const messagesToSend = [
        { role: "system", content: systemPrompt },
        ...listenChatHistory.slice(-10) // 取最后10条记录作为上下文
    ];

    // --- 步骤 4: 发起 API 请求 ---

    // 显示加载动画
    const loadingId = addChatMsg('left', '<span style="opacity:0.5;">正在思考...</span>');

    try {
        const response = await fetch(`${aiConfig.endpoint}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.key}`
            },
            body: JSON.stringify({
                model: aiConfig.model,
                messages: messagesToSend,
                temperature: 0.8, // 稍微高一点，让聊天更有趣
                max_tokens: 150   // 限制回复长度，避免长篇大论
            })
        });

        if (!response.ok) {
            throw new Error(`API错误: ${response.status}`);
        }

        const data = await response.json();
        const replyContent = data.choices[0].message.content;

        // --- 步骤 5: 处理结果 ---

        // 移除“正在思考”
        const loadingEl = document.getElementById(loadingId); // addChatMsg 需要稍作修改返回ID，下面会讲
        if(loadingEl) loadingEl.remove();

        // AI 回复上屏
        addChatMsg('left', replyContent);

        // 存入历史
        listenChatHistory.push({ role: "assistant", content: replyContent });

    } catch (error) {
        console.error(error);
        const loadingEl = document.getElementById(loadingId); // 简单的移除
        if(loadingEl) loadingEl.innerHTML = `<span style="color:#FF3B30;">连接断开: ${error.message}</span>`;
    }
}

// 3. 辅助函数：清空记录时也要清空内存
function clearListenChat() {
    if(confirm("清空记录？这会遗忘之前的对话记忆。")) {
        document.getElementById('listen-chat-box').innerHTML = '<div class="chat-msg system"><span>记录已清空</span></div>';
        listenChatHistory = []; // 关键：清空内存里的历史
    }
}

// 4. 修改 addChatMsg 让它返回元素 ID (为了能删除“正在思考”)
// 请替换掉原来的 addChatMsg 函数
function addChatMsg(side, text) {
    const box = document.getElementById('listen-chat-box');
    const div = document.createElement('div');
    const id = 'chat-msg-' + Date.now() + Math.random(); // 生成唯一ID
    div.id = id;

    if(side === 'system') {
        div.className = 'chat-msg system';
        div.innerHTML = `<span>${text}</span>`;
    } else {
        div.className = `chat-msg ${side}`;
        // 这里的头像逻辑：如果是左边，显示当前角色小头像
        let avatarHtml = '';
        /* 如果你想在气泡旁边显示小头像，可以在这里加逻辑，目前保持简洁 */

        div.innerHTML = `<div class="msg-bubble-listen">${text}</div>`;
    }
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    return id; // 返回ID方便后续操作
}

    // ================== AI 设置页：连接测试与调试逻辑 ==================

// 1. URL 清洗工具 (防止用户多填或少填斜杠)
function getCleanEndpoint() {
    let url = document.getElementById('ai-endpoint').value.trim();
    if (!url) return '';
    // 去掉末尾的 /
    while (url.endsWith('/')) url = url.slice(0, -1);
    // 去掉末尾的 /v1 (因为很多 API 习惯不同，我们统一标准)
    if (url.endsWith('/v1')) url = url.slice(0, -3);
    return url;
}

// 2. 简单的连接测试 (点击“连接测试”按钮)
async function testSimpleConnection() {
    const endpoint = getCleanEndpoint();
    const key = document.getElementById('ai-key').value.trim();

    if (!endpoint || !key) {
        showToast("❌ 请先填写服务器地址和密钥");
        return;
    }

    showToast("正在尝试连接服务器...");

    try {
        // 尝试请求模型列表，这是最轻量的验证方式
        const response = await fetch(`${endpoint}/v1/models`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${key}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            // 缓存模型列表，方便后续选择
            if (data && (data.data || Array.isArray(data))) {
                window.cachedModelList = data.data || data;
                showToast(`✅ 连接成功！获取到 ${window.cachedModelList.length} 个模型`);
                // 自动刷新一下模型选择列表
                renderModelList();
            } else {
                showToast("✅ 连接成功，但模型列表格式未知");
            }
        } else {
            throw new Error(`状态码 ${response.status}`);
        }
    } catch (error) {
        console.error(error);
        showToast(`❌ 连接失败: ${error.message}`);
        alert("连接失败，请检查：\n1. 地址是否正确 (不需要加 /chat/completions)\n2. 密钥是否有效\n3. 是否需要科学上网");
    }
}

// 3. 对话发送测试 (点击“发送”图标)
async function testAIConnection() {
    const input = document.getElementById('ai-test-msg');
    const logBox = document.getElementById('ai-test-log');
    const text = input.value.trim();

    if (!text) return;

    // 获取配置
    const endpoint = getCleanEndpoint();
    const key = document.getElementById('ai-key').value.trim();
    // 获取当前选中的模型 (显示在界面上的那个)
    const modelLabel = document.getElementById('display-current-model');
    const model = modelLabel.dataset.value || modelLabel.textContent;

    if (!endpoint || !key) {
        logTest("❌ 错误：请先配置地址和密钥");
        return;
    }
    if (model === '未选择' || !model) {
        logTest("❌ 错误：请先点击上方“拉取模型列表”并选择一个模型");
        return;
    }

    // UI 更新
    logTest(`User: ${text}`);
    input.value = ''; // 清空输入框
    logTest(`System: 正在发送请求给 [${model}]...`);

    try {
        const response = await fetch(`${endpoint}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify({
                model: model,
                messages: [{ role: "user", content: text }],
                temperature: 0.7,
                max_tokens: 100
            })
        });

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`HTTP ${response.status} - ${errText}`);
        }

        const data = await response.json();
        const reply = data.choices[0].message.content;

        logTest(`AI: ${reply}`);
        logTest(`------------------`);

        // 顺便保存一下这次成功的配置到 LocalStorage，防止刷新丢失
        localStorage.setItem('ai_active_config', JSON.stringify({
            endpoint: document.getElementById('ai-endpoint').value, // 存原始值
            key: key,
            model: model,
            name: document.getElementById('current-config-name').textContent
        }));

    } catch (error) {
        logTest(`❌ 请求失败: ${error.message}`);
    }
}

// 4. 辅助函数：向黑色日志框打印文字
function logTest(text) {
    const log = document.getElementById('ai-test-log');
    if (!log) return;

    // 如果是第一条日志，清空默认提示
    if (log.textContent.includes('Ready...')) log.textContent = '';

    const time = new Date().toLocaleTimeString('en-US', {hour12:false});
    log.innerText += `[${time}] ${text}\n`;
    log.scrollTop = log.scrollHeight; // 自动滚动到底部
}

    // ================== 倒数日小组件逻辑 (最终修正版) ==================

let tempCdBg = null; // 临时存储上传的图片

// 1. 初始化
function initCountdownWidget() {
    // 尝试读取保存的数据
    const data = JSON.parse(localStorage.getItem('widget_countdown_data') || 'null');
    if (data) {
        updateCountdownUI(data);
    }

    // 尝试读取保存的背景图
    dbHelper.get('widget_cd_bg').then(blob => {
        if (blob) {
            const url = URL.createObjectURL(blob);
            setCountdownBg(url);
        }
    });
}

// 2. 设置背景图 UI
function setCountdownBg(url) {
    const bgLayer = document.getElementById('cd-bg-layer');
    const widget = document.getElementById('widget-countdown-card');

    if (bgLayer && widget) {
        bgLayer.style.backgroundImage = `url(${url})`;
        bgLayer.style.display = 'block'; // 显示背景层
        widget.classList.add('has-bg');  // 添加标记，通知 CSS 适配浅色模式
    }
}

// 3. 预览上传的图片
function handleCdBgUpload(input) {
    if (input.files && input.files[0]) {
        tempCdBg = input.files[0]; // 存入临时变量
        showToast("已选择图片，保存后生效");
    }
}

// 4. 打开设置弹窗
function openCountdownModal() {
    const modal = document.getElementById('modal-countdown');
    if (!modal) return;

    // 回显数据
    const data = JSON.parse(localStorage.getItem('widget_countdown_data') || '{}');
    document.getElementById('input-cd-title').value = data.title || '';
    document.getElementById('input-cd-date').value = data.date || '';

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}

// 5. 关闭设置弹窗
function closeCountdownModal() {
    const modal = document.getElementById('modal-countdown');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }
}

// 6. 保存设置 (核心逻辑)
async function saveCountdown() {
    const title = document.getElementById('input-cd-title').value.trim();
    const date = document.getElementById('input-cd-date').value;

    if (!title || !date) {
        showToast("请填写完整信息");
        return;
    }

    // 保存文字数据
    const data = { title, date };
    localStorage.setItem('widget_countdown_data', JSON.stringify(data));

    // 保存图片数据 (如果有新上传的)
    if (tempCdBg) {
        await dbHelper.save('widget_cd_bg', tempCdBg);
        // 立即更新界面
        setCountdownBg(URL.createObjectURL(tempCdBg));
        tempCdBg = null; // 清空临时变量
    }

    // 刷新 UI 并关闭
    updateCountdownUI(data);
    closeCountdownModal();
    showToast("倒数日设置已保存");
}

// 7. 更新 UI 显示 (计算天数)
function updateCountdownUI(data) {
    document.getElementById('widget-cd-title').textContent = data.title;
    document.getElementById('widget-cd-date').textContent = "目标: " + data.date;

    const target = new Date(data.date);
    const now = new Date();
    // 清除时分秒，只计算日期差
    target.setHours(0,0,0,0);
    now.setHours(0,0,0,0);

    const diff = target - now;
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));

    const numEl = document.getElementById('widget-cd-days');
    const labelEl = document.querySelector('.cd-label');

    if (days >= 0) {
        numEl.textContent = days;
        if(labelEl) labelEl.textContent = "LEFT"; // 剩余
    } else {
        numEl.textContent = Math.abs(days);
        if(labelEl) labelEl.textContent = "AGO";  // 已过
    }
}

// 页面加载时启动
initCountdownWidget();

    // ================== 语音小组件逻辑 (更新版) ==================

    const voiceState = {
        A: { audio: new Audio(), hasFile: false, isPlaying: false }
    };

    // 1. 初始化
    async function initVoiceWidgets() {
        const id = 'A'; // 我们只保留了 A

        // 加载封面
        const imgBlob = await dbHelper.get(`voice_${id}_img`);
        if (imgBlob) {
            const el = document.getElementById(`voice-${id.toLowerCase()}-cover`);
            if(el) {
                el.style.backgroundImage = `url(${URL.createObjectURL(imgBlob)})`;
                el.querySelector('span').style.display = 'none';
            }
        }

        // 加载音频
        const audioBlob = await dbHelper.get(`voice_${id}_audio`);
        if (audioBlob) {
            voiceState[id].audio.src = URL.createObjectURL(audioBlob);
            voiceState[id].hasFile = true;
        }

        // 监听播放结束
        voiceState[id].audio.onended = () => {
            voiceState[id].isPlaying = false;
            document.getElementById(`voice-${id.toLowerCase()}-wave`).classList.remove('playing');
        };
    }

    // 2. 封面上传 (左侧圆形)
    function triggerVoiceCover(id) {
        document.getElementById(`input-voice-${id.toLowerCase()}-img`).click();
    }

    async function saveVoiceImg(id, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            await dbHelper.save(`voice_${id}_img`, file);

            const el = document.getElementById(`voice-${id.toLowerCase()}-cover`);
            el.style.backgroundImage = `url(${URL.createObjectURL(file)})`;
            el.querySelector('span').style.display = 'none';
        }
    }

    // 3. 音频上传 (右侧星星按钮)
    function triggerVoiceUpload(id) {
        document.getElementById(`input-voice-${id.toLowerCase()}-audio`).click();
    }

    async function saveVoiceAudio(id, input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            await dbHelper.save(`voice_${id}_audio`, file);

            voiceState[id].audio.src = URL.createObjectURL(file);
            voiceState[id].hasFile = true;

            // 上传成功后，重置播放状态
            voiceState[id].isPlaying = false;
            document.getElementById(`voice-${id.toLowerCase()}-wave`).classList.remove('playing');

            showToast("音频已上传，点击中间播放");
        }
    }

    // 4. 播放控制 (点击中间波纹)
    function toggleVoicePlay(id) {
        if (!voiceState[id].hasFile) {
            showToast("请先点击右侧星星上传音频");
            return;
        }

        const s = voiceState[id];
        const wave = document.getElementById(`voice-${id.toLowerCase()}-wave`);

        if (s.isPlaying) {
            s.audio.pause();
            s.isPlaying = false;
            wave.classList.remove('playing');
        } else {
            // 如果背景音乐正在放，先暂停背景音乐（可选）
            if (typeof appAudio !== 'undefined' && !appAudio.paused) {
                appAudio.pause();
                // 记得更新主播放器UI，如果需要的话可以调用 updatePlayPauseIcon()
            }

            s.audio.play();
            s.isPlaying = true;
            wave.classList.add('playing');
        }
    }

    // 启动
    initVoiceWidgets();

    // ================== 组件背景设置逻辑 ==================

    let currentWidgetBgId = null; // 当前正在修改哪个组件

    // 1. 初始化：加载所有组件背景
    async function initWidgetBackgrounds() {
        const widgets = ['weather', 'music', 'voice-a'];

        for (const id of widgets) {
            try {
                const blob = await dbHelper.get(`widget_bg_${id}`);
                if (blob) {
                    const url = URL.createObjectURL(blob);
                    applyWidgetBg(id, url);
                }
            } catch (e) { console.log(e); }
        }
    }

    // 2. 应用背景 (同时更新主屏幕真实组件 + 设置页预览)
    function applyWidgetBg(id, url) {
        // 更新主屏幕上的真实组件
        const realWidget = document.getElementById(`widget-${id}-box`);
        if (realWidget) {
            if (url) realWidget.style.backgroundImage = `url(${url})`;
            else realWidget.style.backgroundImage = 'none';
        }

        // 更新设置页里的预览
        const previewWidget = document.getElementById(`preview-widget-${id}`);
        if (previewWidget) {
            if (url) previewWidget.style.backgroundImage = `url(${url})`;
            else previewWidget.style.backgroundImage = 'none';
        }
    }

    // 3. 触发上传
    function triggerWidgetBgUpload(id) {
        currentWidgetBgId = id;
        document.getElementById('input-widget-bg').click();
    }

    // 4. 处理文件选择
    async function handleWidgetBgFile(input) {
        if (input.files && input.files[0] && currentWidgetBgId) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);

            // 存入数据库
            await dbHelper.save(`widget_bg_${currentWidgetBgId}`, file);

            // 应用
            applyWidgetBg(currentWidgetBgId, url);
            showToast("组件背景已更新");

            // 清空输入框，防止重复触发
            input.value = '';
        }
    }

    // ================== 还原逻辑修改版 (使用自定义弹窗) ==================

    let tempWidgetIdToReset = null; // 临时记录当前要还原哪个组件

    // 1. 点击“还原”按钮时触发：打开弹窗
    function resetWidgetBg(id) {
        tempWidgetIdToReset = id; // 记住是哪个组件（weather/music/voice-a）

        const modal = document.getElementById('modal-reset-widget');
        modal.style.display = 'flex';
        // 强制层级最高，遮住设置页
        modal.style.zIndex = '2000';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    // 2. 关闭弹窗
    function closeResetModal() {
        const modal = document.getElementById('modal-reset-widget');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // 3. 确认还原 (点击红色按钮时触发)
    async function confirmResetExec() {
        if (tempWidgetIdToReset) {
            // 删库
            await dbHelper.save(`widget_bg_${tempWidgetIdToReset}`, null);
            // 刷新 UI (传 null 会恢复 CSS 默认样式)
            applyWidgetBg(tempWidgetIdToReset, null);

            showToast("已还原默认样式");
        }
        closeResetModal();
    }

    // 启动加载
    initWidgetBackgrounds();

    // ================== 聊天 App 导航逻辑 ==================

    // 1. 切换顶部 Tab (列表/群聊/好友)
    function switchChatTopTab(tabId) {
        // 切换按钮样式
        document.querySelectorAll('.chat-top-tabs-container .chat-tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes(
                tabId === 'list' ? '消息' : (tabId === 'group' ? '群聊' : '好友')
            )) {
                btn.classList.add('active');
            }
        });

        // 切换内容显示
        document.querySelectorAll('.chat-page-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-chat-${tabId}`).classList.add('active');

        // 如果切到好友，刷新一下好友列表 (复用角色书数据)
        if (tabId === 'friend') {
            loadChatFriends();
        }
    }

    // ================== 导航切换逻辑 (终极修复版：强制最高优先级) ==================
async function switchChatBottomNav(moduleId, btnEl) {
    // 1. 切换按钮高亮
    if(btnEl) {
        document.querySelectorAll('.chat-nav-item').forEach(el => el.classList.remove('active'));
        btnEl.classList.add('active');
    }

    // 2. 切换主模块显示
    document.querySelectorAll('.chat-module-container').forEach(el => el.style.display = 'none');
    document.getElementById(`chat-module-${moduleId}`).style.display = 'flex';

    // 3. 更新标题和按钮
    const titleMap = { 'msg': '聊天', 'moments': '动态', 'me': '我的' };
    document.querySelector('#app-chat .app-title').textContent = titleMap[moduleId];

    const actionBtn = document.getElementById('chat-header-action-btn');
    const backBtn = document.getElementById('chat-back-btn');
    const bellBtn = document.getElementById('btn-moment-bell');

    if (moduleId === 'msg') {
        backBtn.style.display = 'flex';
        actionBtn.style.display = 'flex';
        actionBtn.innerHTML = '+';
        actionBtn.onclick = openChatTypeMenu;
        if(bellBtn) bellBtn.style.display = 'none';
    } else if (moduleId === 'moments') {
        backBtn.style.display = 'none';
        actionBtn.style.display = 'flex';
        actionBtn.innerHTML = '+';
        actionBtn.onclick = openCreateMoment;
        if(bellBtn) bellBtn.style.display = 'flex';
        initMoments();
    } else if (moduleId === 'me') {
        backBtn.style.display = 'none';
        actionBtn.style.display = 'none';
        if(bellBtn) bellBtn.style.display = 'none';
        renderMyProfileCard();
    }

    // 4. 🚨 核心修复：背景切换 (使用 setProperty + important) 🚨
    const appChat = document.getElementById('app-chat');

    try {
        const blob = await dbHelper.get(`bg_custom_${moduleId}`);
        if (blob) {
            const url = URL.createObjectURL(blob);

            // 🌟 关键：强制设置背景，优先级高于 CSS 的 !important
            appChat.style.setProperty('background-image', `url(${url})`, 'important');
            appChat.style.setProperty('background-size', 'cover', 'important');
            appChat.style.setProperty('background-position', 'center', 'important');
            appChat.style.setProperty('background-repeat', 'no-repeat', 'important');

            appChat.classList.add('has-custom-bg');
        } else {
            // 无背景图：清除行内样式，回退到 CSS 默认
            appChat.style.removeProperty('background-image');
            appChat.classList.remove('has-custom-bg');
        }
    } catch(e) {
        appChat.style.removeProperty('background-image');
        appChat.classList.remove('has-custom-bg');
    }
}
    // ================== 好友列表逻辑 (修复版：使用双重查找) ==================
async function loadChatFriends() {
    const container = document.getElementById('view-chat-friend');
    if (!container) return;

    let roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    if (roles.length === 0) {
        container.innerHTML = '<div class="chat-placeholder-text">暂无好友<br>去角色书创建几个吧</div>';
        return;
    }

    roles.sort((a, b) => {
        if (a.isPinned && !b.isPinned) return -1;
        if (!a.isPinned && b.isPinned) return 1;
        return 0;
    });

    container.innerHTML = '';

    for (const role of roles) {
        // 🚨 核心修复：使用双重查找助手
        let avatarUrl = await getRoleChatAvatarUrl(role.id);

        // 构造背景样式字符串，如果 URL 为空，则样式为 none
        const bgStyle = avatarUrl ? `background-image:url(${avatarUrl})` : 'background-image:none; background-color:#333';

        const wrapper = document.createElement('div');
        wrapper.className = `chat-swipe-wrapper ${role.isPinned ? 'pinned' : ''}`;

        const mainCard = document.createElement('div');
        mainCard.className = 'chat-main-card';

        mainCard.onclick = function() {
            createOrOpenChatFromFriend(role.id, role.name);
        };

        // 渲染头像
        mainCard.innerHTML = `
            <div class="role-card-img" style="${bgStyle}; width:50px; height:50px; border-radius:50%; margin-right:15px; background-size:cover; background-position:center; flex-shrink:0;">
                ${!avatarUrl ? `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#888;">${role.name[0]}</div>` : ''}
            </div>
            <div class="role-card-info" style="flex:1;">
                <div class="role-card-name" style="font-size:17px; font-weight:600;">${role.name}</div>
                <div class="role-card-desc" style="font-size:13px; opacity:0.6; margin-top:2px;">${role.desc || '暂无介绍'}</div>
            </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'chat-swipe-actions';

        const pinBtn = document.createElement('div');
        pinBtn.className = 'swipe-btn btn-pin';
        pinBtn.textContent = role.isPinned ? '取消' : '置顶';
        pinBtn.onclick = (e) => { e.stopPropagation(); toggleFriendPin(role.id); };

        const delBtn = document.createElement('div');
        delBtn.className = 'swipe-btn btn-del';
        delBtn.textContent = '删除';
        delBtn.onclick = (e) => { e.stopPropagation(); openDeletePageCommon('friend', role.id, role.name); };

        actions.appendChild(pinBtn);
        actions.appendChild(delBtn);
        wrapper.appendChild(mainCard);
        wrapper.appendChild(actions);
        container.appendChild(wrapper);
    }
}

    // ================== 聊天创建逻辑 (完整版) ==================

    // 临时存储
    let tempSingleAvatar = null;
    let tempGroupAvatars = {}; // { index: file }
    let selectedImportRoleId = null; // 单人导入选中
    let selectedImportRoleIds = [];  // 群聊导入选中

    // 1. 入口：点击聊天页右上角 + 号
    // (请确保HTML里那个加号的 onclick="openChatTypeMenu()")
    function openChatTypeMenu() {
        const modal = document.getElementById('modal-chat-type');
        modal.style.display = 'flex';
        modal.style.zIndex = '2100';
        setTimeout(() => modal.classList.add('active'), 10);
    }
    function closeChatTypeMenu() {
        const modal = document.getElementById('modal-chat-type');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // --- 单人聊天逻辑 ---

    function openCreateSingleModal() {
        closeChatTypeMenu();
        // 重置状态
        document.getElementById('input-single-name').value = '';
        document.getElementById('input-single-avatar').value = '';
        document.getElementById('single-avatar-preview').style.backgroundImage = 'none';
        document.getElementById('single-avatar-preview').innerHTML = '<span class="chat-avatar-icon">+</span>';
        tempSingleAvatar = null;
        selectedImportRoleId = null;

        // 渲染导入列表
        renderImportList('single');
        openSubPage('sub-create-single');
    }

    function switchSingleTab(mode, btn) {
        document.querySelectorAll('#sub-create-single .create-chat-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(mode === 'custom') {
            document.getElementById('single-custom-area').style.display = 'block';
            document.getElementById('single-import-area').style.display = 'none';
        } else {
            document.getElementById('single-custom-area').style.display = 'none';
            document.getElementById('single-import-area').style.display = 'block';
        }
    }

    // --- 群聊逻辑 ---

    let currentMemberCount = 3;

    function openCreateGroupModal() {
        closeChatTypeMenu();
        document.getElementById('input-group-name').value = '';
        currentMemberCount = 3;
        tempGroupAvatars = {};
        selectedImportRoleIds = [];

        renderGroupMemberInputs();
        renderImportList('group');
        openSubPage('sub-create-group');
    }

    function switchGroupTab(mode, btn) {
        document.querySelectorAll('#sub-create-group .create-chat-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(mode === 'custom') {
            document.getElementById('group-custom-area').style.display = 'block';
            document.getElementById('group-import-area').style.display = 'none';
        } else {
            document.getElementById('group-custom-area').style.display = 'none';
            document.getElementById('group-import-area').style.display = 'block';
        }
    }

    function adjustMemberCount(delta) {
        const newCount = currentMemberCount + delta;
        if(newCount >= 2 && newCount <= 20) {
            currentMemberCount = newCount;
            document.getElementById('group-member-count').textContent = currentMemberCount;
            renderGroupMemberInputs();
        }
    }

    // 动态生成群成员输入框
    function renderGroupMemberInputs() {
        const container = document.getElementById('group-custom-list');
        // 保留已输入的数据比较麻烦，这里简化为重新生成，或者只增减
        // 为了体验好，我们简单重绘，但实际项目可能需要保留值
        let html = '';
        for(let i=0; i<currentMemberCount; i++) {
            // 检查是否有临时预览图
            const hasImg = tempGroupAvatars[i];
            const bgStyle = hasImg ? `background-image:url(${URL.createObjectURL(hasImg)})` : '';
            const iconDisplay = hasImg ? 'none' : 'block';

            html += `
                <div class="group-member-row">
                    <div class="group-member-avatar-small" id="group-av-${i}" style="${bgStyle}" onclick="document.getElementById('input-g-av-${i}').click()">
                        <span style="display:${iconDisplay}">+</span>
                    </div>
                    <input type="file" id="input-g-av-${i}" accept="image/*" hidden onchange="handleGroupAvatar(${i}, this)">
                    <input type="text" id="input-g-name-${i}" placeholder="成员 ${i+1} 昵称" style="flex:1; border:none; background:transparent; color:white; outline:none;">
                </div>
            `;
        }
        container.innerHTML = html;
    }

    function handleGroupAvatar(index, input) {
        if(input.files && input.files[0]) {
            tempGroupAvatars[index] = input.files[0];
            const url = URL.createObjectURL(input.files[0]);
            const el = document.getElementById(`group-av-${index}`);
            el.style.backgroundImage = `url(${url})`;
            el.querySelector('span').style.display = 'none';
        }
    }

    // --- 通用：头像预览 ---
    function previewChatAvatar(viewId, input) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            if(viewId === 'single-avatar-preview') tempSingleAvatar = file;

            const el = document.getElementById(viewId);
            el.style.backgroundImage = `url(${URL.createObjectURL(file)})`;
            el.querySelector('span').style.display = 'none';
        }
    }

    // --- 通用：渲染角色导入列表 ---
    function renderImportList(type) {
        const container = document.getElementById(`import-role-list-${type}`);
        const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
        container.innerHTML = '';

        if(roles.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">角色书为空</div>';
            return;
        }

        roles.forEach(role => {
            const div = document.createElement('div');
            div.className = 'role-card role-select-item'; // 复用之前的样式
            div.style.marginBottom = '8px';

            // 点击逻辑
            div.onclick = () => {
                if(type === 'single') {
                    // 单选
                    document.querySelectorAll('#import-role-list-single .role-select-item').forEach(el=>el.classList.remove('selected'));
                    div.classList.add('selected');
                    selectedImportRoleId = role.id;
                } else {
                    // 多选
                    if(selectedImportRoleIds.includes(role.id)) {
                        selectedImportRoleIds = selectedImportRoleIds.filter(id => id !== role.id);
                        div.classList.remove('selected');
                    } else {
                        selectedImportRoleIds.push(role.id);
                        div.classList.add('selected');
                    }
                }
            };

            // 获取头像
            dbHelper.get(`role_${role.id}_avatar`).then(blob => {
                const imgStyle = blob ? `background-image:url(${URL.createObjectURL(blob)})` : '';
                div.innerHTML = `
                    <div class="role-card-img" style="${imgStyle}"></div>
                    <div class="role-card-info">
                        <div class="role-card-name">${role.name}</div>
                    </div>
                    <div class="role-select-check"></div>
                `;
            });
            container.appendChild(div);
        });
    }

    // ================== 保存与数据生成 ==================

    // 保存单聊
    // ================== 修复：自定义创建同时保存到好友列表 ==================

    async function saveSingleChat() {
        const activeTab = document.querySelector('#sub-create-single .create-chat-tab.active').innerText;

        // 生成一个通用 ID
        const commonId = Date.now().toString();

        let chatName = '';
        let avatarBlob = null;

        // --- 分支 A：自定义创建 ---
        if (activeTab.includes('自定义')) {
            chatName = document.getElementById('input-single-name').value.trim();
            if (!chatName) { showToast("请输入昵称"); return; }
            avatarBlob = tempSingleAvatar;

            // 【核心修复步骤】
            // 1. 把它存进角色书 (这样好友列表才能看到)
            let roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
            roles.push({
                id: commonId,
                name: chatName,
                desc: '自定义添加的好友'
            });
            localStorage.setItem('role_list_meta', JSON.stringify(roles));

            // 2. 存角色头像 (给好友列表用)
            if (avatarBlob) {
                await dbHelper.save(`role_${commonId}_avatar`, avatarBlob);
            }

            // 3. 顺便刷新一下角色书列表（如果后台开着的话）
            if (typeof renderRoleList === 'function') renderRoleList();
        }

        // --- 分支 B：从角色书导入 ---
        else {
            if (!selectedImportRoleId) { showToast("请选择一个角色"); return; }
            const roles = JSON.parse(localStorage.getItem('role_list_meta'));
            const role = roles.find(r => r.id === selectedImportRoleId);

            chatName = role.name;
            // 尝试获取原有角色的头像
            const existBlob = await dbHelper.get(`role_${role.id}_avatar`);
            if (existBlob) avatarBlob = existBlob;
        }

        // --- 公共步骤：创建会话 ---
        const chatData = {
            id: commonId,
            type: 'single',
            name: chatName,
            lastMsg: '我们已经是好友了，开始聊天吧',
            time: '刚刚'
        };

        // 存会话头像 (给消息列表用)
        if (avatarBlob) {
            await dbHelper.save(`chat_avatar_${commonId}`, avatarBlob);
        }

        // 添加到消息列表
        addChatToSessionList(chatData);

        // 【关键】强制刷新好友列表 UI
        loadChatFriends();

        closeSubPage('sub-create-single');
        showToast("创建成功，好友已添加");
    }

    // 保存群聊
    async function saveGroupChat() {
        const groupName = document.getElementById('input-group-name').value.trim();
        if(!groupName) { showToast("请输入群名称"); return; }

        const activeTab = document.querySelector('#sub-create-group .create-chat-tab.active').innerText;
        let members = []; // { name, avatarBlob? }

        if(activeTab.includes('自定义')) {
            // 收集输入框数据
            for(let i=0; i<currentMemberCount; i++) {
                const name = document.getElementById(`input-g-name-${i}`).value.trim();
                const blob = tempGroupAvatars[i];
                if(name) members.push({ name, blob });
            }
            if(members.length < 2) { showToast("至少需要2名成员"); return; }
        } else {
            // 收集导入数据
            if(selectedImportRoleIds.length < 2) { showToast("至少选择2个角色"); return; }
            const roles = JSON.parse(localStorage.getItem('role_list_meta'));
            for(const rid of selectedImportRoleIds) {
                const r = roles.find(x => x.id === rid);
                const blob = await dbHelper.get(`role_${rid}_avatar`);
                members.push({ name: r.name, blob });
            }
        }

        const chatId = Date.now().toString();
        // 保存群头像 (这里简单处理：用第一个成员的头像，或者默认图)
        if(members[0].blob) {
            await dbHelper.save(`chat_avatar_${chatId}`, members[0].blob);
        }

        const chatData = {
            id: chatId,
            type: 'group',
            name: groupName,
            memberCount: members.length, // 记录人数
            lastMsg: `${members[0].name}: (表情)`,
            time: '刚刚'
        };

        addChatToSessionList(chatData);
        closeSubPage('sub-create-group');
        showToast("群聊创建成功");
    }

    // 核心：添加到会话列表并刷新 UI
    function addChatToSessionList(chat) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        list.unshift(chat); // 加到最前面
        localStorage.setItem('chat_sessions', JSON.stringify(list));

        // 既然创建了，就应该刷新消息列表页
        renderChatSessionList();
    }

    // ================== 4. 【列表渲染逻辑】(修复版：带已读灰圈) ==================
async function renderChatSessionList() {
    const container = document.getElementById('view-chat-list');
    if (!container) return;

    let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
    if(list.length === 0) {
        container.innerHTML = '<div class="chat-placeholder-text">暂无消息<br>找个好友聊聊天吧</div>';
        return;
    }

    list.sort((a, b) => {
        if (a.isPinned && !b.isPinned) return -1;
        if (!a.isPinned && b.isPinned) return 1;
        return 0;
    });

    container.innerHTML = '';

    const stories = JSON.parse(localStorage.getItem('active_stories') || '{}');
    const readList = JSON.parse(localStorage.getItem('read_stories_list') || '{}');

    for(const chat of list) {
        let avatarUrl = '';
        try {
            const blob = await dbHelper.get(`chat_avatar_${chat.id}`);
            if(blob) avatarUrl = URL.createObjectURL(blob);
        } catch(e){}

        // 检查 Story 状态
        const hasStory = stories[chat.id] && (Date.now() - stories[chat.id] < 24 * 60 * 60 * 1000);
        // 检查是否已读
        const isRead = readList[chat.id] ? true : false;

        // 确定光圈 class
        let ringClass = '';
        if (hasStory) {
            ringClass = isRead ? 'read-story' : 'has-story';
        }

        const wrapper = document.createElement('div');
        wrapper.className = `chat-swipe-wrapper ${chat.isPinned ? 'pinned' : ''}`;

        const mainCard = document.createElement('div');
        mainCard.className = 'chat-main-card';
        // 点击头像看 Story，点击卡片进聊天
        mainCard.onclick = () => openChatDetail(chat.id, chat.name, `chat_avatar_${chat.id}`);

        mainCard.innerHTML = `
            <div class="role-card-img-wrapper ${ringClass}" ${hasStory ? `onclick="event.stopPropagation(); openStoryViewer('${chat.id}')"` : ''}>
                <div class="role-card-img" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : ''}">
                    ${!avatarUrl ? `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#888;">${chat.name[0]}</div>` : ''}
                </div>
            </div>

            <div class="role-card-info" style="flex:1;">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <div class="role-card-name" style="font-size:17px; font-weight:600;">${chat.name}</div>
                    <div style="font-size:12px; opacity:0.5;">${chat.time}</div>
                </div>
                <div class="role-card-desc" style="font-size:14px; opacity:0.7; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${chat.lastMsg}</div>
            </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'chat-swipe-actions';

        const pinBtn = document.createElement('div');
        pinBtn.className = 'swipe-btn btn-pin';
        pinBtn.textContent = chat.isPinned ? '取消' : '置顶';
        pinBtn.onclick = (e) => { e.stopPropagation(); toggleChatPin(chat.id); };

        const delBtn = document.createElement('div');
        delBtn.className = 'swipe-btn btn-del';
        delBtn.textContent = '删除';
        delBtn.onclick = (e) => { e.stopPropagation(); openDeletePageCommon('chat', chat.id, chat.name); };

        actions.appendChild(pinBtn);
        actions.appendChild(delBtn);
        wrapper.appendChild(mainCard);
        wrapper.appendChild(actions);
        container.appendChild(wrapper);
    }
}

    // ================== 列表功能：置顶 / 取消置顶 ==================

    function toggleChatPin(chatId) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        const index = list.findIndex(c => c.id === chatId);

        if (index > -1) {
            // 切换状态
            list[index].isPinned = !list[index].isPinned;
            localStorage.setItem('chat_sessions', JSON.stringify(list));

            // 重新渲染 (会自动排序和更新 UI)
            renderChatSessionList();
            showToast(list[index].isPinned ? "已置顶" : "已取消置顶");
        }
    }

    // ================== 通用删除逻辑 (会话 & 好友) ==================

    // 1. 打开删除确认页 (通用入口)
    // type: 'chat' | 'friend'
    function openDeletePageCommon(type, id, name) {
        deleteTargetType = type; // 标记当前要删什么
        tempChatIdToDelete = id; // 复用这个变量存 ID

        // 更新页面文案
        document.getElementById('del-chat-target-name').textContent = name;
        const titleEl = document.querySelector('#sub-chat-delete .app-title');

        if (type === 'friend') {
            titleEl.textContent = "删除好友";
            // 提示文案也可以微调
            document.querySelector('#sub-chat-delete .wallpaper-content div[style*="font-size: 20px"]').textContent = "删除该好友？";
        } else {
            titleEl.textContent = "删除聊天";
            document.querySelector('#sub-chat-delete .wallpaper-content div[style*="font-size: 20px"]').textContent = "删除该对话？";
        }

        openSubPage('sub-chat-delete');
    }

    // 为了兼容旧代码，保留这个旧函数名，直接转调通用函数
    function openChatDeletePage(chatId, name) {
        openDeletePageCommon('chat', chatId, name);
    }

    // 2. 确认删除 (执行动作)
    async function confirmDeleteChatAction() {
        if (!tempChatIdToDelete) return;

        if (deleteTargetType === 'chat') {
            // --- 删除会话逻辑 ---
            let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
            const newlist = list.filter(c => c.id !== tempChatIdToDelete);
            localStorage.setItem('chat_sessions', JSON.stringify(newlist));
            await dbHelper.save(`chat_avatar_${tempChatIdToDelete}`, null);
            renderChatSessionList();
            showToast("会话已删除");

        } else if (deleteTargetType === 'friend') {
            // --- 删除好友逻辑 (同步删除角色书) ---
            let roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
            const newRoles = roles.filter(r => r.id !== tempChatIdToDelete);
            localStorage.setItem('role_list_meta', JSON.stringify(newRoles));

            // 清理图片数据
            await dbHelper.save(`role_${tempChatIdToDelete}_avatar`, null);
            await dbHelper.save(`role_${tempChatIdToDelete}_bg`, null);

            // 刷新好友列表
            loadChatFriends();
            // 如果角色书页面也在后台，这里也可以尝试刷新一下
            if(typeof renderRoleList === 'function') renderRoleList();

            showToast("好友(角色)已删除");
        }

        closeSubPage('sub-chat-delete');
    }

    // ================== 聊天详情页逻辑 (修复版) ==================

    let currentChatId = null; // 当前正在聊天的 ID

    // ================== 气泡上屏工具 (修复版) ==================
async function appendChatBubble(side, text, doScroll = true, explicitId = null, quoteData = null, extraOptions = null) {
    const box = document.getElementById('chat-detail-msgs');
    if (!box) return;

    const msgId = explicitId || (Date.now().toString() + Math.random().toString(36).substr(2, 5));
    const div = document.createElement('div');
    div.className = `chat-msg ${side}`;
    div.id = `msg-node-${msgId}`;
    div.onclick = function(event) {
        if(typeof openMessageMenu === 'function') openMessageMenu(msgId, side, event);
    };

    if (side === 'system') {
        div.innerHTML = `<span>${text}</span>`;
    } else {
        const avatarHtml = `<div class="chat-msg-avatar" style="background-image: var(--avatar-${side})"></div>`;
        let contentHtml = '';

        // ➤ 1. 转账卡片 (Money) - [这里是你缺失的!]
        if (extraOptions && extraOptions.isTransfer) {
            const isReceived = extraOptions.isReceived || false;
            const amt = extraOptions.amount || '0.00';
            const desc = isReceived ? "已存入钱包" : (extraOptions.desc || '转账');
            // 调用 HTML 生成器
            contentHtml = getTransferCardHTML(amt, desc, isReceived);
        }
        // ➤ 2. 位置卡片 (Location)
        else if (extraOptions && extraOptions.isLocation) {
            const locData = { name: extraOptions.name, address: extraOptions.address };
            const safeLocStr = encodeURIComponent(JSON.stringify(locData));
            contentHtml = `
                <div class="msg-location-card" onclick="viewLocation(event, '${safeLocStr}')">
                    <div class="loc-card-map"><div class="pin-head" style="transform: scale(0.6) rotate(-45deg);"></div></div>
                    <div class="loc-card-info">
                        <div class="loc-card-title">${extraOptions.name}</div>
                        <div class="loc-card-addr">${extraOptions.address}</div>
                    </div>
                </div>`;
        }
        // ➤ 3. 表情包/快拍
        else if (extraOptions && extraOptions.isSticker) {
             contentHtml = `<div class="sticker-wrapper"><img src="${extraOptions.imgUrl}" class="chat-sticker-img"></div>`;
        }
        else if (extraOptions && extraOptions.isStoryShare) {
             const safeDataStr = encodeURIComponent(JSON.stringify(extraOptions.storyData));
             const bg = extraOptions.storyData.bgClass || '#333';
             contentHtml = `<div class="msg-story-card" onclick="viewSharedStory(event, '${safeDataStr}')"><div class="story-card-body" style="background:${bg}"><div class="story-card-text">${extraOptions.storyData.text}</div></div></div>`;
        }
        // ➤ 4. 普通文字
        else {
            let quoteHtml = '';
            if (quoteData && quoteData.text) {
                quoteHtml = `<div class="msg-quote-block"><div class="msg-quote-sender">${quoteData.name}:</div><div class="msg-quote-text">${quoteData.text}</div></div>`;
            }
            contentHtml = `<div class="msg-bubble-listen">${quoteHtml}${text}</div>`;
        }

        if (side === 'left') div.innerHTML = avatarHtml + contentHtml;
        else div.innerHTML = contentHtml + avatarHtml;
    }

    box.appendChild(div);
    if (doScroll) setTimeout(() => { box.scrollTop = box.scrollHeight; }, 50);
}
    // ================== 输入栏功能菜单逻辑 ==================

    function toggleInputMenu() {
        const menu = document.getElementById('chat-input-menu');
        const footer = document.querySelector('.chat-detail-footer');

        // 核心 FIX：确保菜单在显示时，输入栏不会被遮挡
        if (menu.classList.contains('active')) {
            // 隐藏菜单
            menu.classList.remove('active');
            menu.style.display = 'none'; // 确保鼠标事件不被阻挡
        } else {
            // 显示菜单
            // 1. 获取输入栏的底部位置 (包括 padding)
            const footerHeight = footer.offsetHeight;
            // 2. 将菜单定位到 footer 上方 (50px 是输入框的高度, 留出空间)
            menu.style.bottom = `${footerHeight}px`;

            menu.classList.add('active');
            menu.style.display = 'block';
        }
    }

    // ================== 表情包逻辑 (新增) ==================
    
    // 1. 切换表情面板显示/隐藏
    function toggleStickerPanel() {
        const panel = document.getElementById('custom-sticker-panel');
        // 如果输入栏菜单开着，先关掉
        const menu = document.getElementById('chat-input-menu');
        if (menu.classList.contains('active')) toggleInputMenu();

        if (panel.classList.contains('active')) {
            panel.classList.remove('active');
        } else {
            panel.classList.add('active');
            renderStickerGrid(); // 每次打开都刷新一下列表
        }
    }

    // ================== 2. 渲染表情列表 (多选模式支持) ==================
let isStickerMultiSelect = false;
let selectedStickerIds = new Set();

// 2. 渲染表情列表 (最终修复：确保按钮被创建且动作正确)
// 注意：isStickerMultiSelect, selectedStickerIds 必须在外部定义
async function renderStickerGrid() {
    const container = document.getElementById('sticker-grid-view');
    if(!container) return;

    // 清空内容并保留第一个加号按钮 (保持不变)
    container.innerHTML = `
        <div class="sticker-item add-btn" onclick="document.getElementById('sticker-file-input').click()" style="border: 2px dashed rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center;">
            <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:rgba(255,255,255,0.5)"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </div>
    `;
    
    // 更新面板的模式类名和按钮样式
    const panel = document.getElementById('custom-sticker-panel');
    panel.classList.toggle('multi-select-mode', isStickerMultiSelect);
    const delBtn = document.getElementById('btn-sticker-delete-mode');
    delBtn.classList.toggle('active', isStickerMultiSelect);

    const stickers = JSON.parse(localStorage.getItem('user_stickers_list') || '[]');

    for (const stickerId of stickers) {
        try {
            const blob = await dbHelper.get(stickerId);
            if (blob) {
                const url = URL.createObjectURL(blob);
                const div = document.createElement('div');
                // 检查是否已选中，添加选中类名
                div.className = `sticker-item ${selectedStickerIds.has(stickerId) ? 'selected' : ''}`;
                div.style.backgroundImage = `url(${url})`;
                
                // --- 核心修复：点击事件隔离 (防止发送) ---
                div.onclick = (e) => {
                    e.stopPropagation();
                    if (isStickerMultiSelect) {
                        toggleStickerSelection(stickerId, div); // 多选模式：选中/取消选中 
                    } else {
                        sendStickerMessage(stickerId); // 单选模式：发送
                    }
                };

                // 添加选中框
                const checkbox = document.createElement('div');
                checkbox.className = 'sticker-checkbox';
                div.appendChild(checkbox);

                container.appendChild(div);
            }
        } catch (e) { console.error(e); }
    }
}

    // 9. 智能表情包标签存储 (核心：只存储 ID 和用户输入的文字)
function saveStickerTags(stickerId, text) {
    const existingTags = JSON.parse(localStorage.getItem('sticker_tag_list') || '{}');
    existingTags[stickerId] = {
        text: text
    };
    localStorage.setItem('sticker_tag_list', JSON.stringify(existingTags));
}

// 3. 上传图片 (修改版：新增输入文字标签)
async function handleStickerUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const stickerId = `sticker_${Date.now()}`;
        
        await dbHelper.save(stickerId, file);
        
        let list = JSON.parse(localStorage.getItem('user_stickers_list') || '[]');
        list.push(stickerId);
        localStorage.setItem('user_stickers_list', JSON.stringify(list));
        
        // --- 🚨 关键新增逻辑：获取表情包上的文字 🚨 ---
        // 弹出通用输入框，要求用户输入表情包上的文字
        openGenInputModal(
            "表情包文字", 
            "请输入表情包上的主要文字/描述，供 AI 识别场景", 
            "文字/描述 (如：收获, 心累)", 
            (text) => {
                // 回调函数：保存标签并刷新列表
                saveStickerTags(stickerId, text); 
                renderStickerGrid(); 
            }
        );
        // ------------------------------------------

        input.value = '';
    }
}

    // 4. 发送表情 (修复版：正确触发无气泡+去白底模式)
    async function sendStickerMessage(stickerId) {
        // 关闭面板
        const panel = document.getElementById('custom-sticker-panel');
        if(panel) panel.style.display = 'none'; // 确保面板关闭

        const blob = await dbHelper.get(stickerId);
        if (!blob) return;

        const msgId = Date.now().toString();
        const msgImgKey = `msg_img_${msgId}`;
        
        // 保存图片数据
        await dbHelper.save(msgImgKey, blob);

        const imgUrl = URL.createObjectURL(blob);

        // 🚨【核心修复点】🚨
        // 之前这里传的是 imgHtml，导致它走了普通消息的逻辑（带气泡）。
        // 现在传空字符串 ''，并把 info 放在第6个参数 extraOptions 里！
        // 只有这样，appendChatBubble 才知道要用 "sticker-wrapper" (无气泡+去白底)
        appendChatBubble('right', '', true, msgId, null, {
            isSticker: true, 
            imgUrl: imgUrl
        });

        // 存入历史记录
        const history = await loadChatHistory(currentChatId);
        history.push({
            id: msgId,
            sender: 'right',
            text: '[表情]',
            isSticker: true, // 🚨 标记为表情包，加载历史时也会无气泡
            imgKey: msgImgKey,
            timestamp: Date.now()
        });
        await saveChatHistory(currentChatId, history);
        
        updateChatLastMessage(currentChatId, '[表情]');
    }
    // 5. 删除表情 (核心逻辑：从列表和数据库移除)
    async function deleteSticker(id) {
        // 1. 从列表索引中删除 ID
        let list = JSON.parse(localStorage.getItem('user_stickers_list') || '[]');
        list = list.filter(item => item !== id);
        localStorage.setItem('user_stickers_list', JSON.stringify(list));

        // 2. 从 IndexedDB 数据库中删除图片 Blob
        try {
            await dbHelper.save(id, null); 
        } catch(e) {
            console.error("删除数据库文件失败:", e);
        }
        
        // 3. 刷新表情列表，让 UI 上的格子消失
        renderStickerGrid();

        showToast("表情已删除");
    }

    // ================== 修改后的主菜单函数 ==================
    function handleMenuAction(action) {
        toggleInputMenu(); // 收起底部药丸菜单

        if (action === 'photo') {
            document.getElementById('chat-photo-input').click();
        } 
        else if (action === 'voice') {
             openGenInputModal(
                "发送语音", 
                "请输入语音内容 (将转换为语音条)", 
                "说点什么...", 
                (text) => {
                    sendVoiceMessage(text); 
                }
            );
        }
        // 👇👇👇 修改这里：打开表情面板 👇👇👇
        else if (action === 'emoji') {
            toggleStickerPanel();
        }
        // 👆👆👆 修改结束 👆👆👆
        else if (action === 'video') {
             startVideoCall(); // 调用新函数
        }
        else if (action === 'location') {
             openLocationPicker();
        }
        else if (action === 'money') {
            openMoneyModal();
        }
        else if (action === 'heart') {
            openHeartModal(); // 👈 改成这个
        }
        else if (action === 'shop') {
             openApp('app-shop');
        }
        else if (action === 'gift') {
             showToast("礼物功能开发中...");
        }
        else if (action === 'game') {
             showToast("游戏中心开发中...");
        }
        else if (action === 'phone') {
             openApp('app-phone');
        }
        else {
            showToast(`功能 [${action}] 开发中...`);
        }
    }

    // 2. 发送消息 (修复版：强制带上引用数据)
async function sendChatDetailMsg() {
    const input = document.getElementById('chat-msg-input');
    const text = input.value.trim();
    if(!text) return;

    const msgId = Date.now().toString();

    // 调试日志：按 F12 看看这里是不是 null
    console.log("正在发送消息，当前引用数据:", currentQuoteData);

    // 1. 上屏 (注意：第 5 个参数必须是 currentQuoteData)
    appendChatBubble('right', text, true, msgId, currentQuoteData);

    // 2. 存入历史
    const history = await loadChatHistory(currentChatId);
    history.push({
        id: msgId,
        sender: 'right',
        text: text,
        timestamp: Date.now(),
        quote: currentQuoteData // <--- 关键：存进去！
    });
    await saveChatHistory(currentChatId, history);

    updateChatLastMessage(currentChatId, text);

    input.value = '';

    // 3. 发送完关闭引用预览
    if (typeof cancelQuote === 'function') {
        cancelQuote();
    } else {
        // 防止报错的保底写法
        currentQuoteData = null;
        const bar = document.getElementById('quote-preview-bar');
        if(bar) bar.style.display = 'none';
    }
}

    // ================== AI 回复 (最终版：增强回复条数、恢复世界观、支持多格式) ==================
async function triggerChatDetailAI() {
    if (!currentChatId) return;

    // 1. 检查配置
    const aiConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');
    if (!aiConfig.key || !aiConfig.endpoint || !aiConfig.model) {
        showToast("请先在【设置 -> AI模型】中配置模型");
        return;
    }

    // 2. 读取设定和历史
    const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');
    const charName = settings.charName || document.getElementById('chat-detail-name').textContent || "对方";
    const history = await loadChatHistory(currentChatId);

    // --- 🚨 关键新增：随机选择表情包 (30% 概率) 🚨 ---
    const stickerList = JSON.parse(localStorage.getItem('user_stickers_list') || '[]');
    
    // 如果表情库有内容，且随机数满足条件，则发送表情包
    if (stickerList.length > 0 && Math.random() < 0.3) { 
        const randomIndex = Math.floor(Math.random() * stickerList.length);
        const stickerToSendId = stickerList[randomIndex];
        
        // 发送随机选择的表情包
        await sendStickerMessage(stickerToSendId, 'left'); 
        showToast(`✅ ${charName} 随机回复了表情包!`);
        return; // 立即返回，不进行文字回复
    }
    // ----------------------------------------------------
    
    // --- 3. 如果未发送表情包，执行文字回复流程 ---
    
    // 读取设定
    const charDesc = settings.charDesc || "暂无人设";
    const userName = settings.userName || "我";
    const userDesc = settings.userDesc || "暂无";
    let messagesToSend = [];

    // 读取世界观 (构建 worldContext)
    const allWorlds = JSON.parse(localStorage.getItem('world_book_data') || '[]');
    let worldContext = "";
    if (settings.worldviews && settings.worldviews.length > 0) {
        worldContext = allWorlds
            .filter(w => settings.worldviews.includes(w.title))
            .map(w => `[设定- ${w.title}]: ${w.content}`)
            .join('\n\n');
    } else {
        worldContext = "背景：现代日常交流。";
    }

    // 随机连发条数 (修正为 3~5 条)
    const targetCount = Math.floor(Math.random() * 3) + 3; // 3, 4, 5 条

    // 1. 定义赛博地点库 (让 AI 随机选，或者根据人设选)
    const cyberLocations = [
        "荒坂塔 (Arasaka Tower)|企业广场 · 绝对控制区",
        "来生酒吧 (Afterlife)|沃森区 · 地下二层",
        "超级摩天楼 H10|威斯特布鲁克 · 居住区",
        "维克多诊所|小唐人街 · 后巷",
        "丽姿酒吧 (Lizzie's)|歌舞伎区 · 2077号街",
        "月球基地 (Lunar Base)|第3轨道 · 宁静海",
        "数据要塞 (Data Fortress)|深网 · 核心层",
        "野狼酒吧 (El Coyote Cojo)|海伍德 · 谷底区"
    ].join('\n');

    if (history.length > 0) {
        const lastMsg = history[history.length - 1];
        if (lastMsg.sender === 'right' && lastMsg.extraOptions && lastMsg.extraOptions.isTransfer) {
             // 视觉上：找到那个气泡，变成已领取
             const bubble = document.getElementById(`msg-node-${lastMsg.id}`);
             if (bubble) {
                 const card = bubble.querySelector('.msg-transfer-card');
                 if (card && !card.classList.contains('received')) {
                     // 模拟点击领取
                     card.click();
                     showToast(`${charName} 领取了你的转账`);
                 }
             }
        }
    }

    // --- System Prompt (已恢复完整的角色扮演模板) ---
    const systemPrompt = `
【指令】
你正在进行沉浸式语C，扮演"${charName}"与"${userName}"对话。

=== 核心要素 A：角色灵魂 (必须带入此身份) ===
姓名：${charName}
人设：${charDesc}

=== 核心要素 B：世界观与规则 (请结合此设定回复) ===
${worldContext}

=== 交互对象 ===
对象：${userName}
信息：${userDesc}

【当前场景】
${worldContext}

【可用地点列表 (Cyberpunk Locations)】
${cyberLocations}

【特殊功能：读心术】
用户有一个"读心"按钮。你需要实时生成你的【内心真实想法】，这可能与你嘴上说的话完全不同（比如嘴硬心软、暗自窃喜、或者腹诽）。

【回复格式 (严格遵守)】
请按照以下格式输出：
<MIND>这里写你的内心独白(用户平时看不见，点击读心按钮才可见)</MIND>这里写你要直接发给用户的公开回复。

【示例】
用户：我走了。
AI回复：<MIND>别走啊笨蛋，快回头看我一眼！</MIND>哦，慢走不送。

【核心交互协议 (必须遵守)】
1. **自动发位置**：如果用户问"你在哪"、"发个定位"、"去找你"等，**必须**回复一条位置消息。
   - 格式：<LOC>地点名称|详细地址</LOC>
   - 示例：<LOC>荒坂塔|企业广场</LOC>
   - 注意：你可以从上面的列表里选一个符合你当前状态的地点

2. **自动转账 (Money Protocol)**：
   - 如果你想贿赂用户、还钱、给用户买东西的钱、或者表示感谢。
   - **必须**使用格式：<MONEY>金额|备注文案</MONEY>
   - 示例：<MONEY>5000|拿去买义体</MONEY>
   - 金额请符合你的人设（富人发大额，穷人发小额）。
=== 回复规则 (铁律) ===
1. **不要**每句话都发位置或转账。
2. **只有当**用户明确询问“你在哪”或剧情需要展示位置时，才回复：<LOC>地点名|地址</LOC>。
3. **只有当**你想贿赂用户、还钱或表示感谢时，才回复：<MONEY>金额|备注</MONEY>。
1. **多条回复**：本次回复**必须**拆分为 ${targetCount} 条独立消息。
2. **分隔符**：**必须**使用字符串 <<<SPLIT>>> 来分隔每一条消息。
3. **混合消息类型**：
   - 纯文字和 emoji 直接输出。
   - **发送语音（可选）**：使用 <VOICE>语音内容</VOICE> 指令。
4. **纯对话模式**：只输出你要说的内容或指令，不要使用括号，不要出现动作描写。
5. **口语化**：语气必须符合你的角色。
`.trim();

    // 4. 构建消息队列 (提取历史上下文)
    const recentHistory = history.slice(-20);

    messagesToSend = [
        { role: "system", content: systemPrompt }
    ];

    recentHistory.forEach(msg => {
        if (msg.sender === 'system') return;

        let finalContent = msg.text;

        // 🎤 语音消息：读取 rawText
        if (msg.htmlContent && msg.rawText && msg.text === '[语音]') {
            finalContent = `(用户发了一条语音说)："${msg.rawText}"`;
        }
        // 🖼️ 图片/表情消息
        else if (msg.imgKey) {
            finalContent = `(用户发了一张图片/表情)`;
        }
        // 💬 引用消息
        if (msg.quote && msg.quote.text) {
            finalContent = `「回复 ${msg.quote.name}: ${msg.quote.text}」\n${finalContent}`;
        }

        messagesToSend.push({
            role: msg.sender === 'right' ? 'user' : 'assistant',
            content: finalContent
        });
    });
    
    // UI Loading
    const loadingId = Date.now().toString();
    const box = document.getElementById('chat-detail-msgs');
    const loadingDiv = document.createElement('div');
    loadingDiv.id = loadingId;
    loadingDiv.className = 'chat-msg left';
    loadingDiv.innerHTML = `<div class="msg-bubble-listen" style="opacity:0.7;">${charName} 正在输入...</div>`;
    box.appendChild(loadingDiv);
    box.scrollTop = box.scrollHeight;

    // 5. 请求 API (发送文字/语音)
    try {
        let url = aiConfig.endpoint;
        if (url.endsWith('/')) url = url.slice(0, -1);
        if (!url.endsWith('/v1')) url += '/v1';

        const response = await fetch(`${url}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.key}`
            },
            body: JSON.stringify({
                model: aiConfig.model,
                messages: messagesToSend,
                temperature: 0.8,
                max_tokens: 1000
            })
        });

        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        let rawText = data.choices[0].message.content.trim();

        // 强力清洗（防止 AI 依然带括号）
        rawText = rawText.replace(/（[^）]*）/g, '')  
                       .replace(/\([^)]*\)/g, '')    
                       .replace(/【[^】]*】/g, '');   

        if (rawText.startsWith(`${charName}:`)) {
            rawText = rawText.replace(`${charName}:`, '').trim();
        }

        let replies = rawText.split('<<<SPLIT>>>')
                             .map(s => s.trim())
                             .filter(s => s !== '');

        if (typeof processAIReplies === 'function') {
            processAIReplies(replies, 0);
        } else {
            appendChatBubble('left', rawText, true);  
        }

    } catch (error) {
        console.error("AI Error:", error);
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingDiv.innerHTML = `<div class="msg-bubble-listen" style="color:#FF3B30;">出错: ${error.message}</div>`;
    }
}
    // ================== 🚨 补回丢失的连发助手函数 🚨 ==================
    // 这个函数负责把 AI 的长回复切开，一条条地发出来，模拟真人打字

    // ================== 连发助手函数 (升级版：带ID) ==================
    // 连发助手函数 (修复版：确保 AI 消息也有 ID)
async function processReplies(replies, index) {
    if (index >= replies.length) return;

    const text = replies[index].trim();
    if (!text) {
        processReplies(replies, index + 1);
        return;
    }

    // 1. 生成唯一 ID
    const msgId = Date.now().toString() + "_" + index;

    // 2. 上屏 (绑定 ID)
    appendChatBubble('left', text, true, msgId);

    // 3. 存入历史 (保存 ID)
    const history = await loadChatHistory(currentChatId);
    history.push({
        id: msgId,
        sender: 'left',
        text: text,
        timestamp: Date.now()
    });
    await saveChatHistory(currentChatId, history);

    updateChatLastMessage(currentChatId, text);

    const delay = 800 + (text.length * 50) + Math.random() * 500;
    setTimeout(() => {
        processReplies(replies, index + 1);
    }, Math.min(delay, 3000));
}

    // ================== 好友列表点击后的会话创建逻辑 ==================

    async function createOrOpenChatFromFriend(roleId, roleName) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        let chatSession = list.find(chat => chat.id === roleId); // 检查是否已存在会话

        // 如果会话不存在，则创建新会话
        if (!chatSession) {

            // 1. 获取角色头像 (用于会话列表显示)
            const avatarBlob = await dbHelper.get(`role_${roleId}_avatar`);

            // 2. 定义新会话数据
            chatSession = {
                id: roleId, // 使用 roleId 作为会话 ID
                type: 'single',
                name: roleName,
                lastMsg: '新会话已创建，开始聊天吧',
                time: new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'})
            };

            // 3. 💾 存入会话列表和缓存 (自动刷新消息列表)
            if (avatarBlob) {
                await dbHelper.save(`chat_avatar_${roleId}`, avatarBlob); // 存头像到聊天缓存
            }

            addChatToSessionList(chatSession);
            // addChatToSessionList 函数会自动把新的 session 加到 list 里并刷新 Message List

            showToast(`已创建与 ${roleName} 的新会话`);
        }

        // 4. 打开聊天详情页
        openChatDetail(roleId, chatSession.name, `chat_avatar_${roleId}`);
    }

    // ... (所有函数定义结束之后) ...
    // ===========================================
    // 【强制修复】聊天App 启动初始化
    // ===========================================

    function initChatAppLoad() {
        // 1. 强制初始化消息列表 (必须执行，负责从 localStorage 读数据并绘制)
        renderChatSessionList();

        // 2. 预加载好友列表 (确保好友数据和头像提前加载)
        loadChatFriends();

        // 3. 确保默认选中消息 Tab
        // 调用一次底部导航，强制进入消息页 (msg) 并激活顶部 Tab (list)
        switchChatBottomNav('msg', document.querySelector('.chat-bottom-nav .chat-nav-item.active'));
        switchChatTopTab('list');
    }

    // ===========================================
    // ... (可能还有其他 App 的初始化代码，确保放在这之后) ...

    // ================== 聊天记录持久化工具 (IndexedDB) ==================

    // 载入历史记录
    async function loadChatHistory(chatId) {
        return await dbHelper.get(`chat_history_${chatId}`) || [];
    }

    // 保存历史记录
    async function saveChatHistory(chatId, history) {
        await dbHelper.save(`chat_history_${chatId}`, history);
    }

    // 实时更新消息列表的最后一条消息 (LocalStorage) 并置顶
    function updateChatLastMessage(chatId, lastMsg) {
        let list = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        const index = list.findIndex(c => c.id === chatId);

        if (index > -1) {
            list[index].lastMsg = lastMsg;
            list[index].time = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'}); // 更新时间

            // 将该会话移到列表最顶部 (标准的聊天App行为)
            const chatToMove = list.splice(index, 1)[0];
            list.unshift(chatToMove);

            localStorage.setItem('chat_sessions', JSON.stringify(list));

            // 刷新消息列表 UI
            renderChatSessionList();
        }
    }

    // ================== 消息上下文菜单逻辑 ==================

    let currentMessageId = null; // 跟踪哪个消息气泡被点击了

    // 1. 打开菜单 (修复版：增加日志调试，确保 ID 被捕获)
// 1. 打开菜单 (适配多选模式)
function openMessageMenu(msgId, side, event) {
    // 防止冒泡
    if (event) event.stopPropagation();

    // 🚨 多选模式拦截：如果正在多选，直接切换选中状态，不弹窗
    if (isMultiSelectMode) {
        toggleMsgSelection(msgId);
        return;
    }

    // 正常模式：弹窗
    currentMessageId = msgId;
    const modal = document.getElementById('modal-message-menu');
    modal.style.display = 'flex';
    modal.style.zIndex = '3000';
    setTimeout(() => modal.classList.add('active'), 10);
}

// 2. 关闭菜单 (补回这个丢失的函数)
function closeMessageMenu() {
    const modal = document.getElementById('modal-message-menu');

    // 关闭动画
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // ⚠️ 关键修改：这里【不要】清空 currentMessageId
    // 因为 handleMessageAction 紧接着需要读取这个 ID 来执行删除
    // currentMessageId = null;  <-- 这行旧代码要去掉或注释掉
}

// ================== 3. 处理消息菜单操作 (终极整合版) ==================
async function handleMessageAction(action) {
    // 1. 先关闭菜单
    closeMessageMenu();

    // 安全检查
    if (!currentMessageId || !currentChatId) {
        console.error("缺少 ID:", currentMessageId, currentChatId);
        return;
    }

    // --- A. 撤回消息 (Recall) ---
    // 逻辑：不删除，而是把内容改成“撤回提示”
    if (action === 'recall') {
        try {
            let history = await loadChatHistory(currentChatId);
            const msgIndex = history.findIndex(m => String(m.id) === String(currentMessageId));

            if (msgIndex > -1) {
                const targetMsg = history[msgIndex];

                // 只有普通消息才能撤回，已经是系统消息就别撤了
                if (targetMsg.sender === 'system') {
                    showToast("系统消息无法撤回");
                    return;
                }

                // 1. 修改数据
                const oldSender = targetMsg.sender;
                targetMsg.sender = 'system'; // 变成系统消息类型

                // 设置提示语
                if (oldSender === 'right') targetMsg.text = "你撤回了一条消息";
                else targetMsg.text = "对方撤回了一条消息";

                // 2. 💾 存回数据库 (这样刷新后也是撤回状态)
                await saveChatHistory(currentChatId, history);

                // 3. 更新界面 (原地变身)
                const bubbleEl = document.getElementById(`msg-node-${currentMessageId}`);
                if (bubbleEl) {
                    bubbleEl.className = 'chat-msg system'; // 样式变灰
                    bubbleEl.innerHTML = `<span>${targetMsg.text}</span>`; // 内容变文字
                }

                // 4. 如果撤回的是最后一条，更新列表预览
                if (msgIndex === history.length - 1) {
                    updateChatLastMessage(currentChatId, targetMsg.text);
                }

                showToast("已撤回");
            }
        } catch (e) {
            console.error("撤回失败", e);
        }
    }

    // --- B. 删除消息 (Delete) ---
    // 逻辑：彻底从数据库移除
    else if (action === 'delete') {
        // 1. 视觉移除
        const bubbleEl = document.getElementById(`msg-node-${currentMessageId}`);
        if (bubbleEl) {
            bubbleEl.style.transition = "all 0.3s ease";
            bubbleEl.style.opacity = "0";
            bubbleEl.style.transform = "scale(0.9)";
            setTimeout(() => { if(bubbleEl) bubbleEl.remove(); }, 300);
        }

        // 2. 数据库移除
        try {
            let history = await loadChatHistory(currentChatId);
            // 🚨 强制 String 类型转换对比
            const newHistory = history.filter(msg => String(msg.id) !== String(currentMessageId));
            await saveChatHistory(currentChatId, newHistory);

            // 3. 更新预览
            if (newHistory.length > 0) {
                const lastMsg = newHistory[newHistory.length - 1];
                updateChatLastMessage(currentChatId, lastMsg.text || "[媒体消息]");
            } else {
                updateChatLastMessage(currentChatId, "暂无消息");
            }
            showToast("已删除");
        } catch (e) {
            console.error("删除失败:", e);
        }
    }

    // --- C. 编辑 (Edit) ---
    else if (action === 'edit') {
        try {
            let history = await loadChatHistory(currentChatId);
            const targetMsg = history.find(m => String(m.id) === String(currentMessageId));

            if (targetMsg && targetMsg.sender !== 'system') {
                editingTextField = 'chat-message';
                const input = document.getElementById('big-text-input');
                input.value = targetMsg.text;
                document.querySelector('#modal-text-edit .modal-title').textContent = "修改消息";

                const modal = document.getElementById('modal-text-edit');
                modal.style.display = 'flex';
                modal.style.zIndex = '3500';
                setTimeout(() => {
                    modal.classList.add('active');
                    input.focus();
                }, 10);
            } else {
                showToast("不可编辑");
            }
        } catch (e) { console.error(e); }
    }

    // --- 引用 (Quote) ---
    else if (action === 'quote') {
        try {
            let history = await loadChatHistory(currentChatId);
            const targetMsg = history.find(m => String(m.id) === String(currentMessageId));

            if (targetMsg && targetMsg.sender !== 'system') {
                // 1. 获取名字 (如果是右边发的就是"我"，左边就是对方名字)
                const name = targetMsg.sender === 'right' ? '我' : document.getElementById('chat-detail-name').textContent;

                // 2. 存入全局变量
                currentQuoteData = {
                    text: targetMsg.text,
                    name: name
                };

                // 3. 显示预览条
                document.querySelector('.quote-title').textContent = `回复 ${name}:`;
                document.getElementById('quote-preview-content').textContent = targetMsg.text;
                document.getElementById('quote-preview-bar').style.display = 'flex';

                // 4. 聚焦输入框并弹出键盘
                const input = document.getElementById('chat-msg-input');
                input.focus();
            } else {
                showToast("无法引用此消息");
            }
        } catch (e) { console.error(e); }
    }

    // --- 复制 (Copy) ---
    else if (action === 'copy') {
        const bubbleEl = document.getElementById(`msg-node-${currentMessageId}`);
        if (bubbleEl) {
            // 优先只复制正文，不复制引用块里的字
            let text = "";
            // 尝试找正文节点 (排除引用块)
            // 由于结构比较复杂，我们直接去 history 里找最稳
            let history = await loadChatHistory(currentChatId);
            const msg = history.find(m => String(m.id) === String(currentMessageId));
            if(msg) text = msg.text;

            if(!text) text = bubbleEl.innerText; // 保底

            const input = document.getElementById('chat-msg-input');
            input.value = text;
            showToast("已复制");
        }
    }

    // --- E. 多选 (Multi-Select) ---
    else if (action === 'multi-select') {
        enterMultiSelectMode();
    }

    // --- 收藏 (Favorite) [真实逻辑版] ---
    else if (action === 'favorite') {
        try {
            let history = await loadChatHistory(currentChatId);
            const targetMsg = history.find(m => String(m.id) === String(currentMessageId));

            if (targetMsg) {
                // 1. 获取上下文信息
                const chatName = document.getElementById('chat-detail-name').textContent;

                // 2. 构造收藏对象
                const favItem = {
                    id: targetMsg.id, // 消息ID
                    chatId: currentChatId, // 会话ID
                    chatName: chatName, // 会话名称
                    sender: targetMsg.sender,
                    text: targetMsg.text,
                    timestamp: targetMsg.timestamp || Date.now(),
                    savedAt: Date.now(),
                    type: 'message' // 标记类型
                };

                // 3. 存入收藏列表
                let favorites = JSON.parse(localStorage.getItem('my_favorites_list') || '[]');
                // 查重
                if (!favorites.some(f => f.id === favItem.id)) {
                    favorites.unshift(favItem); // 加到最前面
                    localStorage.setItem('my_favorites_list', JSON.stringify(favorites));
                    showToast("已加入收藏");
                } else {
                    showToast("该消息已在收藏夹中");
                }
            }
        } catch (e) { console.error(e); }
    }

    else {
        showToast(`功能 [${action}] 开发中...`);
    }
}

// ================== 多选功能核心逻辑 ==================

let isMultiSelectMode = false;
let selectedMsgIds = new Set(); // 用 Set 存储选中的 ID，自动去重

// 1. 进入多选模式
function enterMultiSelectMode() {
    isMultiSelectMode = true;
    selectedMsgIds.clear();

    // UI 变化
    document.getElementById('chat-detail-msgs').classList.add('selection-mode');
    document.querySelector('.chat-detail-footer').style.display = 'none'; // 隐藏输入栏
    document.getElementById('batch-action-bar').classList.add('active');  // 显示删除栏

    updateBatchCountUI();

    // 给所有现有消息添加圈圈 (如果还没加过)
    const msgs = document.querySelectorAll('.chat-msg');
    msgs.forEach(msg => {
        if (!msg.querySelector('.msg-checkbox')) {
            const checkbox = document.createElement('div');
            checkbox.className = 'msg-checkbox';
            // 圈圈放在最前面
            msg.insertBefore(checkbox, msg.firstChild);
        }
    });
}

// 2. 退出多选模式
function exitMultiSelectMode() {
    isMultiSelectMode = false;
    selectedMsgIds.clear();

    // UI 还原
    document.getElementById('chat-detail-msgs').classList.remove('selection-mode');
    document.querySelector('.chat-detail-footer').style.display = 'flex'; // 恢复输入栏
    document.getElementById('batch-action-bar').classList.remove('active');

    // 取消所有高亮
    document.querySelectorAll('.chat-msg.selected').forEach(el => el.classList.remove('selected'));
}

// 3. 拦截点击 (修改 openMessageMenu)
// 🚨 请注意：下面这个逻辑需要你修改原有的 openMessageMenu 函数
// 找到你代码里的 openMessageMenu，把开头改成这样：

/* function openMessageMenu(msgId, side, event) {
    if (event) event.stopPropagation();

    // --- 🆕 插入这段拦截逻辑 ---
    if (isMultiSelectMode) {
        toggleMsgSelection(msgId);
        return; // 直接结束，不弹菜单
    }
    // -------------------------

    currentMessageId = msgId;
    // ... 原有逻辑 ...
}
*/

// 4. 切换选中状态
function toggleMsgSelection(msgId) {
    const el = document.getElementById(`msg-node-${msgId}`);
    if (!el) return;

    if (selectedMsgIds.has(msgId)) {
        selectedMsgIds.delete(msgId);
        el.classList.remove('selected');
    } else {
        selectedMsgIds.add(msgId);
        el.classList.add('selected');
    }
    updateBatchCountUI();
}

// 5. 更新底部计数
function updateBatchCountUI() {
    document.getElementById('batch-select-count').textContent = `已选 ${selectedMsgIds.size} 项`;
}

// 6. 执行批量删除 (UI 弹窗版)
function confirmBatchDelete() {
    // 如果没选，就不弹窗
    if (selectedMsgIds.size === 0) return;

    // 🌟 核心修改：调用自定义弹窗 openGenConfirmModal
    // 参数依次是：标题、内容描述、按钮文字、回调函数
    openGenConfirmModal(
        "批量删除",
        `确定要删除选中的 <span style="color:#FF3B30; font-weight:bold;">${selectedMsgIds.size}</span> 条消息吗？<br>此操作不可撤销。`,
        "删除",
        async () => {
            // --- 这里是点击“确定”后执行的逻辑 ---
            try {
                // A. 视觉移除 (遍历 Set 里的 ID)
                selectedMsgIds.forEach(id => {
                    const el = document.getElementById(`msg-node-${id}`);
                    if (el) {
                        el.style.opacity = '0'; // 加个淡出
                        setTimeout(() => el.remove(), 200);
                    }
                });

                // B. 数据库移除
                let history = await loadChatHistory(currentChatId);

                // 过滤掉所有在 Set 里的 ID
                // 注意：必须转 String 对比，防止类型不匹配
                const newHistory = history.filter(msg => !selectedMsgIds.has(String(msg.id)));

                await saveChatHistory(currentChatId, newHistory);

                // C. 更新外面的列表预览 (取最后一条)
                if (newHistory.length > 0) {
                    const lastMsg = newHistory[newHistory.length-1];
                    updateChatLastMessage(currentChatId, lastMsg.text || "[媒体消息]");
                } else {
                    updateChatLastMessage(currentChatId, "暂无消息");
                }

                showToast("✅ 删除成功");

                // D. 退出多选模式
                exitMultiSelectMode();

            } catch (e) {
                console.error("批量删除失败:", e);
                showToast("❌ 删除出错");
            }
        }
    );
}

    // ================== 聊天背景设置逻辑 ==================

    // 1. 初始化：加载保存的背景 (打开设置页时调用)
    async function initChatBackground() {
        const previewEl = document.getElementById('preview-chat-bg');
        try {
            const blob = await dbHelper.get('chat_custom_bg');
            if (blob) {
                const url = URL.createObjectURL(blob);
                // 更新设置页里的预览
                if(previewEl) {
                    previewEl.style.backgroundImage = `url(${url})`;
                    previewEl.innerHTML = '';
                }
                // 顺便确保聊天页背景也应用了
                applyChatBg(url);
            } else {
                if(previewEl) {
                    previewEl.style.backgroundImage = 'none';
                    previewEl.innerHTML = '<span class="widget-preview-text">当前背景预览</span>';
                }
            }
        } catch (e) { console.log("无自定义聊天背景"); }
    }

    // 2. 处理上传
    async function handleChatBgUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);

            // 存入数据库
            await dbHelper.save('chat_custom_bg', file);

            // 应用到当前预览和页面
            applyChatBg(url);
            document.getElementById('preview-chat-bg').style.backgroundImage = `url(${url})`;
            document.getElementById('preview-chat-bg').innerHTML = '';

            showToast("聊天背景已更新");
            input.value = '';
        }
    }

    // 3. 应用聊天背景 (终极修复版)
function applyChatBg(url) {
    const chatPage = document.getElementById('sub-chat-detail');
    if (!chatPage) return;

    if (url) {
        // 🌟 关键：同样加上 important
        chatPage.style.setProperty('background-image', `url(${url})`, 'important');
        chatPage.style.setProperty('background-size', 'cover', 'important');
        chatPage.style.setProperty('background-position', 'center', 'important');

        chatPage.classList.add('has-custom-bg');
    } else {
        chatPage.style.removeProperty('background-image');
        chatPage.classList.remove('has-custom-bg');
    }
}

    // 4. 恢复默认
    async function resetChatBackground() {
        if(confirm("确定要恢复默认背景吗？")) {
            await dbHelper.save('chat_custom_bg', null);
            applyChatBg(null);
            // 重置预览
            const previewEl = document.getElementById('preview-chat-bg');
            if(previewEl) {
                previewEl.style.backgroundImage = 'none';
                previewEl.innerHTML = '<span class="widget-preview-text">当前背景预览</span>';
            }
            showToast("已恢复默认背景");
        }
    }

    // 页面加载时尝试应用一次背景
    initChatBackground();

    // ================== 聊天高级设置逻辑 ==================

    // 临时数据缓存
    let tempSettings = {};
    let editingTextField = ''; // 当前正在编辑哪个字段 (char-desc, user-desc)

    // 1. 打开设置页 (入口)
    async function openChatSettings() {
        if (!currentChatId) return;

        // 加载现有设置或默认值
        const savedSettings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');

        // 如果没有保存过，尝试从会话列表和角色书初始化
        const sessions = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        const session = sessions.find(c => c.id === currentChatId);

        // 初始化 tempSettings
        tempSettings = {
            charName: savedSettings.charName || session.name,
            charDesc: savedSettings.charDesc || "暂无人设",
            charAvatar: null, // Blob 稍后加载

            userName: savedSettings.userName || "我",
            userDesc: savedSettings.userDesc || "",
            userAvatar: null,

            worldviews: savedSettings.worldviews || [], // Array of strings

            showAvatar: savedSettings.hasOwnProperty('showAvatar') ? savedSettings.showAvatar : true,
            bubbleStyle: savedSettings.bubbleStyle || 'default',
            customCss: savedSettings.customCss || '',

            isBlocked: savedSettings.isBlocked || false
        };

        // 渲染 UI
        renderSettingsUI();

        // 加载头像预览
        loadSettingAvatar('char', `chat_avatar_${currentChatId}`);
        loadSettingAvatar('user', `user_avatar_${currentChatId}`); // 用户在这个聊天的专属头像

        dbHelper.get('chat_custom_bg').then(blob => {
        const previewEl = document.getElementById('preview-chat-bg');
        if (previewEl) {
            if (blob) {
                previewEl.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                previewEl.innerHTML = ''; // 有图就清空文字
            } else {
                previewEl.style.backgroundImage = 'none';
                previewEl.innerHTML = '<span class="widget-preview-text">当前背景预览</span>';
            }
        }
    });

        openSubPage('sub-chat-settings');
    }

    // 2. 渲染 UI 界面
    function renderSettingsUI() {
        // 填充文本
        document.getElementById('setting-char-name').value = tempSettings.charName;
        document.getElementById('setting-char-desc-preview').textContent = tempSettings.charDesc;

        document.getElementById('setting-user-name').value = tempSettings.userName;
        document.getElementById('setting-user-desc-preview').textContent = tempSettings.userDesc || "暂无...";

        // 填充开关
        document.getElementById('switch-show-avatar').checked = tempSettings.showAvatar;

        // 填充黑名单按钮状态
        const blockBtn = document.getElementById('btn-block-user');
        blockBtn.textContent = tempSettings.isBlocked ? "已拉黑 (点击解除)" : "拉黑该好友";
        blockBtn.style.background = tempSettings.isBlocked ? "#333" : "transparent";

        // 渲染世界观标签
        renderWorldTags();

        // 气泡样式高亮
        selectBubbleStyle(tempSettings.bubbleStyle, null, true); // true 表示仅渲染不保存
    }

    // 3. 头像加载与上传
    async function loadSettingAvatar(type, key) {
        try {
            const blob = await dbHelper.get(key);
            const el = document.getElementById(`setting-${type}-avatar`);
            if (blob) {
                el.style.backgroundImage = `url(${URL.createObjectURL(blob)})`;
                // 缓存到 temp (如果是读取的，就不存 blob 对象，只标记)
            } else {
                // 尝试默认头像
                if (type === 'user') {
                     const mainAvatar = await dbHelper.get('userAvatar_main');
                     if(mainAvatar) el.style.backgroundImage = `url(${URL.createObjectURL(mainAvatar)})`;
                }
            }
        } catch(e){}
    }

    function triggerSettingAvatar(type) {
        document.getElementById(`input-setting-${type}-avatar`).click();
    }

    function previewSettingAvatar(type, input) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            const url = URL.createObjectURL(file);
            document.getElementById(`setting-${type}-avatar`).style.backgroundImage = `url(${url})`;

            // 存入临时对象，保存时写入数据库
            tempSettings[`${type}AvatarBlob`] = file;
        }
    }

    // 4. 长文本编辑模态窗
    function openTextEditModal(field) {
        editingTextField = field;
        const val = field === 'char-desc' ? tempSettings.charDesc : tempSettings.userDesc;
        document.getElementById('big-text-input').value = val;

        const modal = document.getElementById('modal-text-edit');
        modal.style.display = 'flex';
        setTimeout(()=>modal.classList.add('active'),10);
    }

    // 确认编辑 (修复版：解决刷新后还原的问题)
    async function confirmTextEdit() {
        const val = document.getElementById('big-text-input').value.trim();

        // 1. 修改人设详情 (原逻辑保持不变)
        if (editingTextField === 'char-desc') {
            tempSettings.charDesc = val;
            document.getElementById('setting-char-desc-preview').textContent = val;
            closeTextEditModal();
        }
        // 2. 修改用户人设 (原逻辑保持不变)
        else if (editingTextField === 'user-desc') {
            tempSettings.userDesc = val;
            document.getElementById('setting-user-desc-preview').textContent = val;
            closeTextEditModal();
        }
        // 3. 🚨 修改聊天消息 (重点修复这里) 🚨
        else if (editingTextField === 'chat-message') {
            if (!val) { showToast("内容不能为空"); return; }

            // --- A. 界面更新 (视觉上先变，让你感觉很快) ---
            const bubbleEl = document.getElementById(`msg-node-${currentMessageId}`);
            if (bubbleEl) {
                const textDiv = bubbleEl.querySelector('.msg-bubble-listen');
                if (textDiv) textDiv.innerText = val;
            }

            // --- B. 数据库更新 (确保刷新后还在) ---
            try {
                // 安全检查：如果丢失了会话ID，就没法存
                if (!currentChatId) {
                    console.error("丢失 currentChatId，无法保存");
                    showToast("保存失败：会话状态丢失");
                    return;
                }

                // 1. 读取历史记录
                let history = await loadChatHistory(currentChatId);

                // 2. 查找要修改的那条消息
                // 💡 核心修复：把 id 都转成 String 再对比，防止一个是数字一个是字符串导致找不到
                const msgIndex = history.findIndex(m => String(m.id) === String(currentMessageId));

                if (msgIndex > -1) {
                    // 3. 修改内存中的数据
                    history[msgIndex].text = val;

                    // 4. 【关键】存回数据库
                    await saveChatHistory(currentChatId, history);

                    // 5. 如果改的是最后一条，顺便更新外面的“消息列表”预览
                    if (msgIndex === history.length - 1) {
                        updateChatLastMessage(currentChatId, val);
                    }

                    console.log("✅ 数据库保存成功"); // F12 控制台可以看到这个
                    showToast("已修改");
                } else {
                    console.error("❌ 错误：在数据库里没找到这条消息 ID:", currentMessageId);
                    console.log("当前历史记录:", history);
                }
            } catch (e) {
                console.error("保存过程出错:", e);
                showToast("保存出错");
            }

            // 关窗
            closeTextEditModal();
        }

        // ... (接在 chat-message 的判断后面) ...

        // 4. 🆕 新增：修改动态文字
        else if (editingTextField === 'moment-text') {
            if (currentMenuPostIndex !== -1 && igPostsData[currentMenuPostIndex]) {
                // 更新数据
                igPostsData[currentMenuPostIndex].text = val;
                saveMomentsData(); // 保存

                // 刷新界面
                renderFeedList();

                // 如果详情页开着，也要刷新详情页的内容
                // 简单粗暴的方法：重新调用 openMomentDetail 刷新 DOM
                // 或者手动更新 DOM
                const detailText = document.querySelector('#moment-detail-card-container .feed-text');
                if(detailText) detailText.textContent = val;

                showToast("已修改");
            }
            closeTextEditModal();
        }
    }

    // 5. 世界观管理
    function renderWorldTags() {
        const container = document.getElementById('setting-world-tags');
        container.innerHTML = '';
        tempSettings.worldviews.forEach((tag, index) => {
            const span = document.createElement('span');
            span.className = 'world-tag';
            span.innerHTML = `${tag} <span class="world-tag-remove" onclick="removeWorldTag(${index})">×</span>`;
            container.appendChild(span);
        });
    }

    function removeWorldTag(index) {
        tempSettings.worldviews.splice(index, 1);
        renderWorldTags();
    }

    // ================== 通用弹窗控制逻辑 ==================

    let genInputCallback = null;
    let genConfirmCallback = null;

    // 1. 打开输入弹窗
    function openGenInputModal(title, label, placeholder, callback) {
        document.getElementById('gen-input-title').textContent = title;
        document.getElementById('gen-input-label').textContent = label;
        const input = document.getElementById('gen-input-field');
        input.value = '';
        input.placeholder = placeholder;

        genInputCallback = callback;

        const modal = document.getElementById('modal-general-input');
        modal.style.display = 'flex';
        setTimeout(()=>modal.classList.add('active'),10);
        input.focus();
    }

    function closeTextEditModal() {
        document.getElementById('modal-text-edit').classList.remove('active');
        setTimeout(() => {
            document.getElementById('modal-text-edit').style.display = 'none';
            // 还原标题为默认
            document.querySelector('#modal-text-edit .modal-title').textContent = "编辑内容";
        }, 300);
    }

    // 绑定输入确认按钮
    document.getElementById('gen-input-confirm-btn').onclick = function() {
        const val = document.getElementById('gen-input-field').value.trim();
        if(val && genInputCallback) genInputCallback(val);
        closeGenInputModal();
    };

    // 2. 打开确认弹窗
    function openGenConfirmModal(title, desc, btnText, callback) {
        document.getElementById('gen-confirm-title').textContent = title;
        document.getElementById('gen-confirm-desc').innerHTML = desc;
        const btn = document.getElementById('gen-confirm-btn');
        btn.textContent = btnText;

        genConfirmCallback = callback;

        const modal = document.getElementById('modal-general-confirm');
        modal.style.display = 'flex';
        // 强制层级
        modal.style.zIndex = '2500';
        setTimeout(()=>modal.classList.add('active'),10);
    }

    function closeGenConfirmModal() {
        document.getElementById('modal-general-confirm').classList.remove('active');
        setTimeout(()=>document.getElementById('modal-general-confirm').style.display='none',300);
    }

    // 绑定确认按钮
    document.getElementById('gen-confirm-btn').onclick = function() {
        if(genConfirmCallback) genConfirmCallback();
        closeGenConfirmModal();
    };

    // 6. 气泡样式选择
    function selectBubbleStyle(style, el, isInit) {
        if (!isInit) {
            tempSettings.bubbleStyle = style;
            // UI 更新
            document.querySelectorAll('.bubble-preset-item').forEach(d => d.classList.remove('active'));
            if(el) el.classList.add('active');
        } else {
            // 初始化时根据 tempSettings 找元素
            // (这里简化，假设顺序对应，实际最好给 item 加 id)
        }

        const cssInput = document.getElementById('custom-bubble-css');
        if (style === 'custom') {
            cssInput.style.display = 'block';
            cssInput.value = tempSettings.customCss || '';
        } else {
            cssInput.style.display = 'none';
        }
    }

    // 7. 保存所有设置 (Core)
    async function saveChatSettingsDetail() {
        // 收集输入框最新值
        tempSettings.charName = document.getElementById('setting-char-name').value;
        tempSettings.userName = document.getElementById('setting-user-name').value;
        tempSettings.showAvatar = document.getElementById('switch-show-avatar').checked;
        if (tempSettings.bubbleStyle === 'custom') {
            tempSettings.customCss = document.getElementById('custom-bubble-css').value;
        }

        // 1. 存配置到 LocalStorage
        localStorage.setItem(`chat_settings_${currentChatId}`, JSON.stringify(tempSettings));

        // 2. 存图片到 IndexedDB
        if (tempSettings.charAvatarBlob) {
            await dbHelper.save(`chat_avatar_${currentChatId}`, tempSettings.charAvatarBlob);
        }
        if (tempSettings.userAvatarBlob) {
            await dbHelper.save(`user_avatar_${currentChatId}`, tempSettings.userAvatarBlob);
        }

        // 3. 应用样式 (立即生效)
        applyChatSettingsToView();

        // 4. 更新消息列表的名字预览
        updateChatLastMessage(currentChatId, "(设置已更新)"); // 触发列表刷新并更新名字显示逻辑需要修改列表渲染函数，这里暂时只刷列表

        closeSubPage('sub-chat-settings');
        showToast("设置已保存并应用");
    }

    // 3. 应用设置到视图 (背景、头像开关、头像更新、气泡样式) - 最终修复版
    async function applyChatSettingsToView() {
        if (!currentChatId) return;
        const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');
        const page = document.getElementById('sub-chat-detail');

        // A. 应用背景
        try {
            const blob = await dbHelper.get('chat_custom_bg');
            if (blob) {
                applyChatBg(URL.createObjectURL(blob));
            } else {
                applyChatBg(null);
            }
        } catch(e){ applyChatBg(null); }

        // B. 应用头像开关
        if (settings.showAvatar === false) {
            page.classList.add('hide-avatars');
        } else {
            page.classList.remove('hide-avatars');
        }

        // C. 更新头部名字
        if (settings.charName) {
             const nameEl = document.getElementById('chat-detail-name');
             if(nameEl) nameEl.textContent = settings.charName;
        }

        // D. 🚨 核心修复：实时更新头像 (注入 CSS 变量) 🚨

        // D1. 更新对方头像 (Char)
        try {
            // 优先读取该会话专属头像
            const charBlob = await dbHelper.get(`chat_avatar_${currentChatId}`);
            if (charBlob) {
                const url = URL.createObjectURL(charBlob);
                // 更新头部大图
                const headerAvatar = document.getElementById('chat-detail-avatar');
                if(headerAvatar) headerAvatar.style.backgroundImage = `url(${url})`;
                // 更新气泡旁的小图
                page.style.setProperty('--avatar-left', `url(${url})`);
            }
        } catch(e) {}

        // D2. 更新我的头像 (User)
        try {
            // 1. 先试着找“这个会话专属”的用户头像
            let userBlob = await dbHelper.get(`user_avatar_${currentChatId}`);
            // 2. 如果没有，就用“全局默认”的用户头像
            if (!userBlob) {
                userBlob = await dbHelper.get('userAvatar_main');
            }

            if (userBlob) {
                const url = URL.createObjectURL(userBlob);
                page.style.setProperty('--avatar-right', `url(${url})`);
            } else {
                page.style.setProperty('--avatar-right', 'none');
            }
        } catch(e) {}

        // E. 气泡样式应用
        let styleTag = document.getElementById('dynamic-bubble-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'dynamic-bubble-style';
            document.head.appendChild(styleTag);
        }

        let css = '';
        if (settings.bubbleStyle === 'box') {
            css = `.msg-bubble-listen { border-radius: 4px !important; }`;
        } else if (settings.bubbleStyle === 'trans') {
            css = `.msg-bubble-listen { background: rgba(255,255,255,0.1) !important; border: 1px solid rgba(255,255,255,0.3) !important; }`;
        } else if (settings.bubbleStyle === 'custom') {
            css = settings.customCss;
        }
        styleTag.textContent = css;
    }

    // 8. 应用设置到聊天视图 (Apply)
    // ================== 进入聊天详情 (最终修复版：支持位置/表情/快拍历史回显) ==================
async function openChatDetail(chatId, name, avatarBlobName) {
    currentChatId = chatId;

    // 1. 更新顶部名字
    const nameEl = document.getElementById('chat-detail-name');
    if(nameEl) nameEl.textContent = name;

    // 2. 应用聊天背景设置
    if (typeof applyChatSettingsToView === 'function') {
        await applyChatSettingsToView();
    }

    // --- 头部头像逻辑 (保持不变) ---
    let currentLeftAvatarUrl = '';
    if (avatarBlobName) {
        try {
            const blob = await dbHelper.get(avatarBlobName);
            if (blob) currentLeftAvatarUrl = URL.createObjectURL(blob);
        } catch(e) {}
    }
    const headerAvatar = document.getElementById('chat-detail-avatar');
    if (headerAvatar && currentLeftAvatarUrl) {
        headerAvatar.style.backgroundImage = `url(${currentLeftAvatarUrl})`;
    }

    // --- 头部光圈逻辑 (保持不变) ---
    const stories = JSON.parse(localStorage.getItem('active_stories') || '{}');
    const readMap = JSON.parse(localStorage.getItem('read_stories_map') || '{}');
    const wrapEl = document.getElementById('chat-header-avatar-wrap');
    if (wrapEl) {
        wrapEl.className = 'chat-user-avatar-wrap';
        wrapEl.onclick = null;
        const storyTime = stories[chatId];
        if (storyTime && (Date.now() - storyTime < 86400000)) {
            const lastRead = readMap[chatId] || 0;
            const isRead = lastRead >= storyTime;
            wrapEl.classList.add(isRead ? 'read-story' : 'has-story');
            wrapEl.onclick = () => openStoryViewer(chatId);
        }
    }

    // 3. 加载历史消息 (🔴 核心修复区域 🔴)
    const msgBox = document.getElementById('chat-detail-msgs');
    if(msgBox) {
        msgBox.innerHTML = '';
        const history = await loadChatHistory(chatId);

        if (history.length === 0) {
            msgBox.innerHTML = `<div class="chat-msg system"><span>新会话已开启</span></div>`;
        } else {
            // ... (在 openChatDetail 函数内，history.length check 之后)

            for (const msg of history) {
                let displayText = msg.text;
                let extra = msg.extraOptions || null; 

                // 1. 兼容旧数据
                if (msg.isSticker) extra = { isSticker: true, imgKey: msg.imgKey };
                
                // A. 判断表情包
                if (extra && extra.isSticker) {
                    try {
                        const blob = await dbHelper.get(extra.imgKey || msg.imgKey);
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            displayText = ''; 
                            extra.imgUrl = url; // 补全 URL
                        }
                    } catch(e) {}
                }
                // B. 判断普通图片
                else if (msg.imgKey && !extra) { // 纯图片
                    try {
                        const blob = await dbHelper.get(msg.imgKey);
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            displayText = `<img src="${url}" class="chat-content-image">`;
                        }
                    } catch(e) {}
                }
                // C. 判断语音
                else if (msg.htmlContent && msg.text === '[语音]') {
                    displayText = msg.htmlContent;
                }
                // D. 判断快拍
                else if (msg.isStoryShare && msg.storyData) {
                    displayText = '';
                    extra = { isStoryShare: true, storyData: msg.storyData };
                }
                // E. 判断位置
                else if (extra && extra.isLocation) {
                    displayText = ''; 
                }
                // F. 🔴 判断转账 (这里是你之前缺的！)
                else if (extra && extra.isTransfer) {
                    displayText = ''; // 清空文字，强制渲染卡片
                    // extra 已经包含了 amount, desc 等信息，直接透传即可
                }
                // G. 兼容旧版转账 (如果存的是 htmlContent)
                else if (msg.htmlContent && msg.text.includes('[转账]')) {
                    displayText = msg.htmlContent;
                    extra = { isTransfer: true }; // 补全标记
                }

                // 执行上屏
                await appendChatBubble(msg.sender, displayText, false, msg.id, msg.quote, extra);
            }
        }
        setTimeout(() => { msgBox.scrollTop = msgBox.scrollHeight; }, 100);
    }

    openSubPage('sub-chat-detail');
}

    // 9. 危险操作
    async function clearCurrentChatHistory() {
        if(confirm("清空所有记录？")) {
            await dbHelper.save(`chat_history_${currentChatId}`, []);
            document.getElementById('chat-detail-msgs').innerHTML = '';
            showToast("记录已清空");
        }
    }

    function toggleBlockUser() {
        tempSettings.isBlocked = !tempSettings.isBlocked;
        renderSettingsUI(); // 更新按钮文字
    }

    function deleteCurrentChatAndFriend() {
        if(confirm("删除当前好友及所有记录？")) {
            // 调用之前的删除逻辑
            openDeletePageCommon('friend', currentChatId, tempSettings.charName);
            closeSubPage('sub-chat-settings');
        }
    }

    // 10. 搜索聊天记录
    async function searchChatHistory(keyword) {
        const box = document.getElementById('search-result-box');
        if (!keyword) {
            box.style.display = 'none';
            return;
        }

        const history = await loadChatHistory(currentChatId);
        const results = history.filter(msg => msg.text.includes(keyword));

        box.innerHTML = '';
        if (results.length > 0) {
            box.style.display = 'block';
            results.forEach(msg => {
                const div = document.createElement('div');
                div.style.fontSize = '12px';
                div.style.color = 'white';
                div.style.padding = '5px 0';
                div.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                div.textContent = `${msg.sender==='right'?'我':'Ta'}: ${msg.text}`;
                box.appendChild(div);
            });
        } else {
             box.style.display = 'block';
             box.innerHTML = '<div style="color:#999;font-size:12px;">无搜索结果</div>';
        }
    }

    // ================== 世界观与弹窗逻辑修复版 ==================

    // 标记：是否是从聊天设置页发起的“添加世界观”操作
    let isAddingWorldFromChat = false;

    // 1. 打开世界观选择列表 (显示详情版)
    function openWorldSelectModal() {
        const modal = document.getElementById('modal-world-select');
        const list = document.getElementById('world-select-list');

        // 读取世界书
        const worlds = JSON.parse(localStorage.getItem('world_book_data') || '[]');
        list.innerHTML = '';

        if (worlds.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">暂无设定，请先去世界书或点击自定义添加</div>';
        }

        worlds.forEach(w => {
            const div = document.createElement('div');
            div.className = 'world-select-item';
            div.innerHTML = `
                <div class="world-select-title">${w.title}</div>
                <div class="world-select-desc">${w.content}</div>
            `;

            div.onclick = () => {
                // 选中逻辑：添加 Tag 并关闭
                if(!tempSettings.worldviews.includes(w.title)) {
                    tempSettings.worldviews.push(w.title);
                    renderWorldTags();
                }
                modal.classList.remove('active');
                setTimeout(()=>modal.style.display='none',300);
            };
            list.appendChild(div);
        });

        modal.style.display = 'flex';
        setTimeout(()=>modal.classList.add('active'),10);
    }

    // 2. 自定义世界观 (调用世界书的大弹窗)
    function addCustomWorldTag() {
        // 标记来源
        isAddingWorldFromChat = true;
        // 复用世界书的编辑弹窗
        openWorldEditModal();
    }

    // 3. 保存世界书数据 (修改版：支持回调到聊天设置)
    // ⚠️ 请替换掉原来的 saveWorldData 函数
    function saveWorldData() {
        const title = document.getElementById('world-edit-title').value.trim();
        const content = document.getElementById('world-edit-content').value.trim();

        if (!title) { showToast("请输入标题"); return; }

        // 保存到世界书列表
        if (currentWorldId) {
            // 编辑模式
            const item = worldList.find(w => w.id === currentWorldId);
            item.title = title;
            item.content = content;
        } else {
            // 新建模式
            worldList.push({
                id: Date.now().toString(),
                title: title,
                content: content
            });
        }

        localStorage.setItem('world_book_data', JSON.stringify(worldList));

        // --- 🆕 新增逻辑：如果是从聊天设置页来的 ---
        if (isAddingWorldFromChat) {
            // 自动把新标题加入到聊天设置的 Tag 里
            if(!tempSettings.worldviews.includes(title)) {
                tempSettings.worldviews.push(title);
                renderWorldTags(); // 刷新标签显示
            }
            isAddingWorldFromChat = false; // 重置标记
            showToast("已添加到世界观和当前聊天");
        } else {
            showToast("设定已保存");
            renderWorldList(); // 刷新世界书主页列表
        }

        closeWorldModal();
    }

    // 4. 恢复默认背景 (使用自定义弹窗)
    async function resetChatBackground() {
        // 必须确保 openGenConfirmModal 已定义 (上一步代码里有)
        openGenConfirmModal(
            "恢复默认背景",
            "确定要移除当前的聊天背景图片吗？<br>将恢复为默认样式。",
            "恢复",
            async () => {
                await dbHelper.save('chat_custom_bg', null);
                applyChatBg(null);
                showToast("已恢复默认背景");
            }
        );
    }

    // 5. 清空聊天记录 (使用自定义弹窗)
    async function clearCurrentChatHistory() {
        openGenConfirmModal(
            "清空记录",
            "确定要清空与该好友的所有聊天记录吗？<br>此操作不可撤销。",
            "清空",
            async () => {
                await dbHelper.save(`chat_history_${currentChatId}`, []);
                // 如果聊天页面开着，清空 DOM
                const msgBox = document.getElementById('chat-detail-msgs');
                if(msgBox) msgBox.innerHTML = '';
                showToast("记录已清空");
            }
        );
    }

    // 6. 删除好友并退出 (使用自定义弹窗)
    function deleteCurrentChatAndFriend() {
        openGenConfirmModal(
            "删除好友",
            `确定要删除好友 <b>${tempSettings.charName}</b> 吗？<br>所有数据将被永久删除。`,
            "删除",
            () => {
                openDeletePageCommon('friend', currentChatId, tempSettings.charName);
                // 关闭设置页
                closeSubPage('sub-chat-settings');
                // 关闭聊天详情页 (返回列表)
                closeSubPage('sub-chat-detail');
            }
        );
    }

    // ================== 修复：移除世界观标签 ==================
    function removeWorldTag(index) {
        // 从数组中删除
        tempSettings.worldviews.splice(index, 1);
        // 重新渲染界面
        renderWorldTags();
    }

    // ================== 🟢 动态/朋友圈 完整逻辑 (持久化版) 🟢 ==================

// 1. 【数据源】从 LocalStorage 读取，如果没有就是空数组 (删掉了自带的示例)
let igPostsData = JSON.parse(localStorage.getItem('moments_data') || '[]');

// 辅助函数：保存数据到本地
function saveMomentsData() {
    localStorage.setItem('moments_data', JSON.stringify(igPostsData));
}

// 2. 【初始化入口】
function initMoments() {
    // 安全调用：先检查函数是否存在
    if (typeof renderStatusFlow === 'function') renderStatusFlow();
    if (typeof renderFeedList === 'function') renderFeedList();
}

// ================== 渲染顶部卡片 (完整最终版) ==================
async function renderStatusFlow() {
    const container = document.querySelector('.status-flow-container');
    if (!container) return;
    container.innerHTML = '';

    const myId = 'user_me';

    // 1. 读取已读记录 (格式: { userId: lastReadTimestamp })
    const readMap = JSON.parse(localStorage.getItem('read_stories_map') || '{}');

    // ================== A. 处理“我”的动态 ==================
    let myStoriesList = JSON.parse(localStorage.getItem('my_stories_list') || '[]');
    // 过滤过期 (只保留24小时内的)
    myStoriesList = myStoriesList.filter(s => s.expirationTime > Date.now());

    // 排序：旧 -> 新 (确保播放顺序正确)
    myStoriesList.sort((a, b) => a.timestamp - b.timestamp);

    const hasMyStory = myStoriesList.length > 0;

    let myAvatarUrl = await getSafeUrl('userAvatar_main');
    let myProfileBgUrl = await getSafeUrl('user_profile_bg');

    // 确定背景图：如果有动态，显示最新的一张图；否则显示个人背景
    const latestStory = hasMyStory ? myStoriesList[myStoriesList.length - 1] : null;

    const finalStatusBgUrl = (latestStory && latestStory.mediaKey) ?
        await getSafeUrl(latestStory.mediaKey) :
        (myProfileBgUrl || myAvatarUrl);

    // --- 判断我的光圈状态 ---
    let myRingClass = 'user-mode'; // 默认无圈(发布按钮状态)

    if (hasMyStory) {
        const lastReadTime = readMap[myId] || 0;
        const latestStoryTime = latestStory.timestamp;

        // 如果 最后阅读时间 >= 最新一条的发布时间，说明都看过了 -> 灰圈
        if (lastReadTime >= latestStoryTime) {
            myRingClass = 'read-story';
        } else {
            myRingClass = 'has-story';
        }
    }

    const myName = localStorage.getItem('userNickname') || '我';
    const myCard = document.createElement('div');
    myCard.className = 'status-card my-card';
    myCard.onclick = () => openStoryViewer(myId);

    // 中间加号按钮：只有没动态时才显示
    const centerContent = hasMyStory ? '' : `<div class="my-add-btn-wrapper ${myRingClass}" onclick="openCreateStory(event)"><div class="my-add-btn">+</div></div>`;

    // 构建头像 HTML
    const avatarHtml = `
        <div class="status-mini-avatar ${myRingClass}"
            style="
                background-image:url(${myAvatarUrl || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuNSI+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg=='});
                background-size: cover; background-position: center; background-repeat: no-repeat;
                width: 36px; height: 36px; position: absolute; top: 6px; left: 6px; z-index: 5;
                border-radius: 50%; border: 2px solid #fff;
            "
        ></div>
    `;

    myCard.innerHTML = `
        <div class="status-bg-img" style="background-image:url(${finalStatusBgUrl}); background-size:cover; background-position:center;"></div>
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
            ${avatarHtml}
            <div class="status-name">${myName}</div>
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display:flex; justify-content:center; align-items:center;">
                ${centerContent}
            </div>
        </div>
    `;
    container.appendChild(myCard);

    // 如果有动态，后面补一个单独的“新增”按钮（可选，仿IG逻辑）
    if (hasMyStory) {
        const addBtn = document.createElement('div');
        addBtn.className = 'status-card my-card';
        addBtn.style.background = 'transparent';
        addBtn.style.border = 'none';
        addBtn.onclick = (e) => openCreateStory(e);
        addBtn.innerHTML = `
            <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                 <div class="my-add-btn-wrapper"><div class="my-add-btn">+</div></div>
                 <div class="my-card-text" style="margin-top:5px;">新增</div>
            </div>
        `;
        container.appendChild(addBtn);
    }

    // ================== B. 处理“好友”的动态 (完全补全版) ==================

    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    const activeStoriesMap = JSON.parse(localStorage.getItem('active_stories') || '{}'); // 格式: { roleId: timestamp }

    // 1. 筛选出有有效动态的好友
    let friendStories = [];

    for (const role of roles) {
        const storyTime = activeStoriesMap[role.id];
        // 检查是否存在且未过期 (24小时)
        if (storyTime && (Date.now() - storyTime < 86400000)) {
            // 计算是否已读
            const lastRead = readMap[role.id] || 0;
            const isRead = lastRead >= storyTime; // 如果已读时间 > 发布时间，就是读过了

            friendStories.push({
                role: role,
                timestamp: storyTime,
                isRead: isRead
            });
        }
    }

    // 2. 排序：未读的排前面，已读的排后面；同类中按时间倒序
    friendStories.sort((a, b) => {
        if (a.isRead === b.isRead) {
            return b.timestamp - a.timestamp; // 都是未读或都是已读，按时间新->旧
        }
        return a.isRead ? 1 : -1; // 未读(false)排前(-1)，已读(true)排后(1)
    });

    // 3. 循环渲染
    for (const item of friendStories) {
        const role = item.role;
        const isRead = item.isRead;

        // 异步获取头像
        let roleAvatarUrl = await getRoleChatAvatarUrl(role.id);

        const card = document.createElement('div');
        // 如果未读，加 unread 类（虽然现在主要靠下面的 ringClass 控制光圈）
        card.className = 'status-card';
        card.onclick = () => openStoryViewer(role.id);

        // 确定光圈样式
        const ringClass = isRead ? 'read-story' : 'has-story';

        // 背景图：如果有头像用头像，没头像用灰底
        const bgStyle = roleAvatarUrl ?
            `background-image:url(${roleAvatarUrl}); background-size:cover;` :
            'background-image:none; background-color:#333';

        // 头像样式字符串
        const avatarStyle = roleAvatarUrl ?
            `background-image:url(${roleAvatarUrl}); background-size: cover; background-repeat: no-repeat;` :
            'background-image:none; background-color:#333';

        card.innerHTML = `
            <div class="status-bg-img" style="${bgStyle}"></div>

            <div class="status-mini-avatar ${ringClass}"
                 style="${avatarStyle}; width: 36px; height: 36px; position: absolute; top: 6px; left: 6px; z-index: 5; border-radius: 50%; border: 2px solid #fff;">
            </div>

            <div class="status-name" style="position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center;">${role.name}</div>
        `;
        container.appendChild(card);
    }
}

// 4. 【渲染帖子列表】(持久化修复版：异步加载图片)
async function renderFeedList() {
    const container = document.getElementById('ig-feed-list');
    if (!container) return;
    container.innerHTML = '';

    if (!igPostsData || igPostsData.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#666; margin-top:50px; font-size:14px;">暂无动态<br>快去发布第一条吧</div>';
        return;
    }

    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

    for (let i = 0; i < igPostsData.length; i++) {
        const post = igPostsData[i];

        let avatarUrl = '';
        let username = '';

        // --- 获取头像 ---
        if (post.roleId === null) {
            username = localStorage.getItem('userNickname') || '我';
            try {
                const data = await dbHelper.get('userAvatar_main');
                if (data) avatarUrl = (data instanceof Blob) ? URL.createObjectURL(data) : data;
            } catch(e){}
        } else {
            const role = roles.find(r => r.id === post.roleId);
            username = role ? role.name : '未知';
            if (role) {
                try {
                    const data = await dbHelper.get(`role_${role.id}_avatar`);
                    if (data) avatarUrl = (data instanceof Blob) ? URL.createObjectURL(data) : data;
                } catch(e){}
            }
        }

        // 如果 post.time 存在就用它，不存在就显示 "刚刚"
        const displayTime = post.time || '刚刚';

        const card = document.createElement('div');
        card.className = 'feed-card';
        card.style.position = 'relative';

        // 图标 SVG
        const iconHeart = `<svg class="action-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
        const iconComment = `<svg class="action-icon" viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>`;
        const iconShare = `<svg class="action-icon" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>`;
        const iconSave = `<svg class="action-icon" viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>`;

        // --- 🖼️ 核心：从 DB 加载图片 ---
        let images = [];
        if (post.imgKeys && post.imgKeys.length > 0) {
            for (const key of post.imgKeys) {
                try {
                    const blob = await dbHelper.get(key);
                    if (blob) images.push(URL.createObjectURL(blob));
                } catch(e){}
            }
        }
        // 兼容旧数据 (为了不报错，如果只有 img URL 就用它)
        else if (post.img) {
            images = [post.img];
        }

        let galleryHtml = '';
        let galleryId = `feed-gallery-${post.id}`;

        if (images.length > 0) {
            let imgsHtml = images.map((url, idx) =>
                `<img class="feed-gallery-item" src="${url}"
                      onload="adjustGalleryHeight('${galleryId}', this)"
                      onclick="openImageViewer(${i}, ${idx})"
                      ondblclick="toggleFeedLike(${i}, true)">`
            ).join('');

            const counterHtml = images.length > 1 ? `<div class="feed-counter">1/${images.length}</div>` : '';

            galleryHtml = `
                <div style="position:relative;">
                    <div id="${galleryId}" class="feed-gallery" onscroll="updateFeedCounter(this, ${images.length})">
                        ${imgsHtml}
                    </div>
                    ${counterHtml}
                </div>
            `;
        }

        // ... (前面的代码不变) ...

        // 眼睛图标 SVG
        const iconEye = `<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;

        card.innerHTML = `
            <div class="feed-header">
                <div class="feed-avatar" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : 'background-color:#333'}"></div>
                <div class="feed-user-info">
                    <span class="feed-username">${username}</span>
                    <span class="feed-time">${displayTime}</span>
                </div>
                <div class="feed-more-btn" onclick="openPostMenu(${i})">···</div>
            </div>

            <div class="feed-text">${post.text}</div>
            ${galleryHtml}

            <div class="feed-actions">
                <div class="action-pill view-count" onclick="openPostViewers(${i})">
                    ${iconEye}
                    <span>${post.views || 0}</span>
                </div>

                <div class="action-pill ${post.isLiked ? 'active-like' : ''}" id="feed-like-${i}" onclick="toggleFeedLike(${i})">
                    ${iconHeart}
                    <span id="feed-like-count-${i}">${post.likes}</span>
                </div>
                <div class="action-pill" onclick="openMomentDetail(${i})">
                    ${iconComment}
                    <span>${post.comments}</span>
                </div>
                <div style="margin-left:auto; display:flex; gap:10px;">
                    <div class="action-pill" onclick="showToast('分享')">${iconShare}</div>
                    <div class="action-pill ${post.isSaved ? 'active-save' : ''}" id="feed-save-${i}" onclick="toggleFeedSave(${i})">${iconSave}</div>
                </div>
            </div>
        `;
        // ... (后面的代码不变) ...
        container.appendChild(card);
    }
}

// 🆕 新增：自动调整高度函数
function adjustGalleryHeight(galleryId, img) {
    const gallery = document.getElementById(galleryId);
    if (!gallery) return;

    // 获取图片的原始宽高比
    const ratio = img.naturalWidth / img.naturalHeight;
    // 获取容器当前的宽度 (通常是屏幕宽 - padding)
    const containerWidth = gallery.offsetWidth;

    // 计算适应的高度 = 宽度 / 比例
    const targetHeight = containerWidth / ratio;

    // 逻辑：
    // 我们只允许容器变高，不允许变矮（如果有多张图，取最高的那个）
    // 或者：可以设定一个最大高度限制 (比如 550px)，防止 9:16 长图占满整个手机屏太夸张

    const maxHeight = 550; // 最大限高 (约等于 9:16 在手机上的高度)
    const finalHeight = Math.min(targetHeight, maxHeight);

    // 获取当前容器的高度 (去掉 px 单位)
    const currentHeight = parseInt(gallery.style.height || 0);

    // 如果这张图算出来的高度 > 当前容器高度，就撑开容器
    // 这样多图混合时，容器会适配“最高”的那张图
    if (finalHeight > currentHeight) {
        gallery.style.height = `${finalHeight}px`;
    }
}

// 辅助：更新页码 (可选，简单的实现)
function updateFeedCounter(el, total) {
    // 找到这个 gallery 的父级里的 .feed-counter
    const counter = el.parentElement.querySelector('.feed-counter');
    if (!counter) return;

    const width = el.offsetWidth;
    const scroll = el.scrollLeft;
    // 计算当前是第几张 (四舍五入)
    const current = Math.round(scroll / width) + 1;
    counter.textContent = `${current}/${total}`;
}

// 6. 【收藏逻辑】(新增函数)
function toggleFeedSave(index) {
    if (typeof igPostsData === 'undefined' || !igPostsData[index]) return;

    const post = igPostsData[index];
    const btn = document.getElementById(`feed-save-${index}`);

    // 切换状态
    post.isSaved = !post.isSaved;

    // 更新 UI (黄色高亮)
    if (post.isSaved) {
        btn.classList.add('active-save');
        showToast("已加入收藏");
    } else {
        btn.classList.remove('active-save');
    }
}

// 5. 【点赞逻辑】(带保存)
function toggleFeedLike(index, isDoubleTap) {
    if (typeof igPostsData === 'undefined' || !igPostsData[index]) return;

    const post = igPostsData[index];
    const btn = document.getElementById(`feed-like-${index}`);
    const countEl = document.getElementById(`feed-like-count-${index}`);

    if (isDoubleTap) {
        if (!post.isLiked) {
            post.isLiked = true;
            post.likes++;
            showToast("❤️");
        }
    } else {
        post.isLiked = !post.isLiked;
        post.likes += post.isLiked ? 1 : -1;
    }

    if (post.isLiked) btn.classList.add('active-like');
    else btn.classList.remove('active-like');

    countEl.textContent = post.likes;

    saveMomentsData(); // 💾 保存状态！
}

// 6. 【收藏逻辑】(带保存)
function toggleFeedSave(index) {
    if (typeof igPostsData === 'undefined' || !igPostsData[index]) return;

    const post = igPostsData[index];
    const btn = document.getElementById(`feed-save-${index}`);

    post.isSaved = !post.isSaved;

    if (post.isSaved) {
        btn.classList.add('active-save');
        showToast("已加入收藏");
    } else {
        btn.classList.remove('active-save');
    }

    saveMomentsData(); // 💾 保存状态！
}

// ================== 发动态 (Create Moment) 逻辑 ==================

let draftImages = []; // 暂存选中的图片文件

// 1. 打开页面
function openCreateMoment() {
    draftImages = []; // 清空草稿
    document.getElementById('moment-caption').value = ''; // 清空文字
    renderMomentUploader(); // 渲染上传格
    openSubPage('sub-create-moment');
}

// 2. 渲染九宫格 (预览图 + 加号)
function renderMomentUploader() {
    const container = document.getElementById('moment-upload-container');
    container.innerHTML = '';

    // A. 渲染已选图片
    draftImages.forEach((file, index) => {
        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.className = 'upload-preview-item';
        div.style.backgroundImage = `url(${url})`;

        // 删除按钮
        div.innerHTML = `<div class="btn-remove-img" onclick="removeDraftImage(${index})">×</div>`;
        container.appendChild(div);
    });

    // B. 渲染加号按钮 (如果还没满9张)
    if (draftImages.length < 9) {
        const btn = document.createElement('div');
        btn.className = 'upload-add-btn';
        btn.onclick = () => document.getElementById('moment-file-input').click();
        btn.innerHTML = `<span class="upload-add-icon">+</span>`;
        container.appendChild(btn);
    }
}

// 3. 处理文件选择 (支持多选)
function handleMomentImages(input) {
    if (input.files && input.files.length > 0) {
        // 遍历新选择的文件
        Array.from(input.files).forEach(file => {
            if (draftImages.length < 9) { // 再次检查上限
                draftImages.push(file);
            }
        });
        renderMomentUploader(); // 刷新界面
    }
    input.value = ''; // 重置 input 以便下次能选同样的文件
}

// 4. 删除某张图
function removeDraftImage(index) {
    draftImages.splice(index, 1);
    renderMomentUploader();
}

// 5. 发布动态 (修复：时间格式优化)
async function publishMoment() {
    const text = document.getElementById('moment-caption').value.trim();

    if (!text && draftImages.length === 0) {
        showToast("请输入内容或配图");
        return;
    }

    showToast("正在发布...");

    // A. 处理图片
    let imgKeys = [];
    if (draftImages.length > 0) {
        for (let i = 0; i < draftImages.length; i++) {
            const file = draftImages[i];
            const fileId = `moment_img_${Date.now()}_${i}`;
            await dbHelper.save(fileId, file);
            imgKeys.push(fileId);
        }
    }

    // B. 生成详细时间 (例如: 11月25日 14:30)
    const now = new Date();
    const m = (now.getMonth()+1).toString();
    const d = now.getDate().toString();
    const hh = now.getHours().toString().padStart(2, '0');
    const mm = now.getMinutes().toString().padStart(2, '0');
    const timeStr = `${m}月${d}日 ${hh}:${mm}`;

    // C. 构建数据
    const newPost = {
        id: Date.now(),
        roleId: null,
        imgKeys: imgKeys,
        text: text,
        likes: 0,
        comments: 0,
        commentsList: [],
        time: timeStr,    // 写入优化后的时间
        isLiked: false,
        isSaved: false
    };

    igPostsData.unshift(newPost);
    saveMomentsData();

    await renderFeedList();
    closeSubPage('sub-create-moment');

    showToast("发布成功！");
    // ...
}

// ================== 全屏画廊逻辑 (升级版) ==================

// 1. 打开预览 (传入帖子Index 和 图片Index)
function openImageViewer(postIndex, imgIndex) {
    const viewer = document.getElementById('image-viewer');
    const container = document.getElementById('viewer-gallery-container');
    const counter = document.getElementById('viewer-counter');

    if (!viewer || !igPostsData[postIndex]) return;

    const post = igPostsData[postIndex];
    // 获取该帖子的所有图片
    const images = post.imgs || (post.img ? [post.img] : []);

    if (images.length === 0) return;

    // A. 生成 HTML
    container.innerHTML = images.map(url =>
        `<img class="viewer-img-item" src="${url}" draggable="false">`
    ).join('');

    // B. 显示预览器
    viewer.style.display = 'flex';
    setTimeout(() => viewer.classList.add('active'), 10);

    // C. 滚动到当前点击的那张图 (核心)
    // 这里的 window.innerWidth 就是一页的宽度
    const scrollPos = imgIndex * window.innerWidth;
    container.scrollLeft = scrollPos;

    // D. 更新页码
    updateViewerCounter(imgIndex + 1, images.length);

    // E. 绑定滚动监听 (滑动时更新页码)
    container.onscroll = () => {
        const index = Math.round(container.scrollLeft / window.innerWidth);
        updateViewerCounter(index + 1, images.length);
    };
}

// 2. 更新页码文字
function updateViewerCounter(current, total) {
    const counter = document.getElementById('viewer-counter');
    if(counter) counter.textContent = `${current} / ${total}`;
}

// 3. 关闭预览
function closeImagePreview() {
    const viewer = document.getElementById('image-viewer');
    if (!viewer) return;

    viewer.classList.remove('active');
    setTimeout(() => {
        viewer.style.display = 'none';
        document.getElementById('viewer-gallery-container').innerHTML = ''; // 清空内存
    }, 300);
}

// ================== 详情页与评论逻辑 ==================

let currentDetailIndex = -1; // 当前正在查看哪条帖子的详情

// 1. 打开帖子详情页 (修复版：异步加载图片内容)
async function openMomentDetail(index) {
    if (typeof igPostsData === 'undefined' || !igPostsData[index]) return;

    currentDetailIndex = index;
    const post = igPostsData[index];
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

    // 1. 获取帖子基础信息
    let avatarUrl = '';
    let username = '';

    // 确定帖子作者的头像和名字 (保持原逻辑)
    if (post.roleId === null) {
        username = localStorage.getItem('userNickname') || '我';
        try {
            const data = await dbHelper.get('userAvatar_main');
            if (data) avatarUrl = (data instanceof Blob) ? URL.createObjectURL(data) : data;
        } catch(e){}
    } else {
        const role = roles.find(r => r.id === post.roleId);
        username = role ? role.name : '未知';
        if (role) {
            try {
                const data = await dbHelper.get(`role_${role.id}_avatar`);
                if (data) avatarUrl = (data instanceof Blob) ? URL.createObjectURL(data) : data;
            } catch(e){}
        }
    }

    // --- 🚨 核心修复：加载图片内容 🚨 ---
    let images = [];

    if (post.imgKeys && post.imgKeys.length > 0) {
        // 遍历所有图片 Key，并异步从数据库加载 Blob
        for (const key of post.imgKeys) {
            try {
                const blob = await dbHelper.get(key);
                if (blob) images.push(URL.createObjectURL(blob));
            } catch(e){}
        }
    } else if (post.img) {
        // 兼容旧的单图 URL
        images = [post.img];
    }
    // ------------------------------------

    // 构建图集 HTML
    let galleryHtml = '';
    let galleryId = `detail-gallery-${post.id}`;
    if (images.length > 0) {
        let imgsHtml = images.map((url, idx) =>
            `<img class="feed-gallery-item" src="${url}"
                  onload="adjustGalleryHeight('${galleryId}', this)"
                  onclick="openImageViewerDetail(${idx})" >`
        ).join('');
        const counterHtml = images.length > 1 ? `<div class="feed-counter">1/${images.length}</div>` : '';

        galleryHtml = `
            <div style="position:relative;">
                <div id="${galleryId}" class="feed-gallery" onscroll="updateFeedCounter(this, ${images.length})">
                    ${imgsHtml}
                </div>
                ${counterHtml}
            </div>
        `;

        // 供全屏预览器使用的当前图集数据
        window.currentDetailImages = images;
    }

    // 帖子 HTML 模板
    const displayTime = post.time || '刚刚';
    const postHTML = `
        <div class="feed-card" style="box-shadow:none; border:none; background:transparent;">
            <div class="feed-header">
                <div class="feed-avatar" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : 'background-color:#333'}"></div>
                <div class="feed-user-info">
                    <span class="feed-username">${username}</span>
                    <span class="feed-time">${displayTime}</span>
                </div>
                <div class="feed-more-btn" onclick="openPostMenu(${index})">···</div>
            </div>
            <div class="feed-text">${post.text}</div>
            ${galleryHtml}
            <div class="feed-actions">
                <div class="action-pill ${post.isLiked ? 'active-like' : ''}" id="detail-like-btn" onclick="toggleFeedLike(${index}, false); openMomentDetail(${index});">
                    <svg class="action-icon" viewBox="0 0 24 24" style="fill:currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    <span>${post.likes}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('moment-detail-card-container').innerHTML = postHTML;

    // --- B. 渲染评论列表 ---
    renderCommentsList(post);

    // --- C. 打开页面 ---
    openSubPage('sub-moment-detail');
}

// 2. 渲染评论列表 (修复：显示时间 + 删除按钮)
async function renderCommentsList(post) {
    const listContainer = document.getElementById('moment-comment-list');
    listContainer.innerHTML = '';

    if (!post.commentsList || post.commentsList.length === 0) {
        listContainer.innerHTML = '<div style="text-align:center; color:rgba(255,255,255,0.3); margin-top:20px; font-size:13px;">暂无评论，快来抢沙发</div>';
        return;
    }

    // 获取我的头像
    let myAvatarUrl = '';
    try {
        const data = await dbHelper.get('userAvatar_main');
        if (data) myAvatarUrl = (data instanceof Blob) ? URL.createObjectURL(data) : data;
    } catch(e){}

    const displayTime = post.time || '刚刚';

    // 获取当前用户名，用于判断是否是自己发的
    const myName = localStorage.getItem('userNickname') || '我';

    post.commentsList.forEach((comment, index) => {
        const item = document.createElement('div');
        item.className = 'comment-item';

        // 判断是否是自己发的评论
        const isMe = (comment.user === myName);

        // 如果是自己发的，显示删除按钮
        // 注意：onclick 绑定了 deleteMomentComment，传入帖子ID和评论ID(timestamp)
        const deleteBtnHtml = isMe ?
            `<span class="comment-del-btn" onclick="deleteMomentComment(${post.id}, ${comment.id})">删除</span>` : '';

        item.innerHTML = `
            <div class="comment-avatar" style="${myAvatarUrl ? 'background-image:url('+myAvatarUrl+')' : ''}"></div>
            <div class="comment-content">
                <div class="comment-user">${comment.user}</div>
                <div class="comment-text">${comment.text}</div>
                <div class="comment-meta">
                    <span class="comment-time">${comment.time || '刚刚'}</span>
                    <span class="comment-reply-btn" onclick="document.getElementById('moment-reply-input').focus()">回复</span>
                    ${deleteBtnHtml}
                </div>
            </div>
        `;
        listContainer.appendChild(item);
    });
}

// 3. 发送评论
function sendMomentComment() {
    const input = document.getElementById('moment-reply-input');
    const text = input.value.trim();
    if (!text) return;

    if (currentDetailIndex === -1 || !igPostsData[currentDetailIndex]) return;

    const post = igPostsData[currentDetailIndex];

    // 初始化数组 (防止旧数据没有这个字段)
    if (!post.commentsList) post.commentsList = [];

    // 构建评论对象
    const newComment = {
        id: Date.now(),
        user: localStorage.getItem('userNickname') || '我',
        text: text,
        time: new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'})
    };

    // 1. 存入数据
    post.commentsList.push(newComment);
    post.comments++; // 更新计数

    // 2. 保存到本地
    saveMomentsData();

    // 3. 更新界面
    renderCommentsList(post); // 刷新评论区
    input.value = ''; // 清空输入框

    // 4. 同时刷新外面的列表页，更新评论数显示
    renderFeedList();
}

// 4. 删除评论逻辑 (修复：使用 UI 弹窗)
function deleteMomentComment(postId, commentId) {

    // 🌟 使用自定义弹窗，而不是 confirm()
    openGenConfirmModal(
        "删除评论",
        "确定要删除这条评论吗？",
        "删除",
        () => {
            // --- 这里是点击“确定”后的逻辑 ---

            // 1. 找到对应的帖子
            const post = igPostsData.find(p => p.id === postId);
            if (!post) return;

            // 2. 过滤掉这条评论
            post.commentsList = post.commentsList.filter(c => c.id !== commentId);

            // 3. 更新计数
            post.comments = post.commentsList.length;

            // 4. 保存并刷新
            saveMomentsData();

            // 刷新详情页的评论列表
            renderCommentsList(post);
            // 刷新外面的列表页（更新评论数字）
            renderFeedList();

            showToast("评论已删除");

            // 关闭确认弹窗 (openGenConfirmModal 内部可能没自动关，这里手动关一下保险)
            closeGenConfirmModal();
        }
    );
}

// 辅助：详情页里的图片预览 (需要读取 window.currentDetailImages)
function openImageViewerDetail(imgIndex) {
    const viewer = document.getElementById('image-viewer');
    const container = document.getElementById('viewer-gallery-container');
    const counter = document.getElementById('viewer-counter');

    const images = window.currentDetailImages || [];
    if (images.length === 0) return;

    container.innerHTML = images.map(url => `<img class="viewer-img-item" src="${url}" draggable="false">`).join('');
    viewer.style.display = 'flex';
    setTimeout(() => viewer.classList.add('active'), 10);

    const scrollPos = imgIndex * window.innerWidth;
    container.scrollLeft = scrollPos;

    if(counter) counter.textContent = `${imgIndex + 1} / ${images.length}`;

    container.onscroll = () => {
        const index = Math.round(container.scrollLeft / window.innerWidth);
        if(counter) counter.textContent = `${index + 1} / ${images.length}`;
    };
}

// ================== 动态帖子菜单逻辑 (编辑/删除) ==================

let currentMenuPostIndex = -1; // 当前正在操作哪个帖子

// 1. 打开菜单
function openPostMenu(index) {
    currentMenuPostIndex = index;
    const modal = document.getElementById('modal-post-menu');
    modal.style.display = 'flex';
    modal.style.zIndex = '2100'; // 保证层级够高
    setTimeout(() => modal.classList.add('active'), 10);
}

// 2. 关闭菜单
function closePostMenu() {
    const modal = document.getElementById('modal-post-menu');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
}

// 3. 处理菜单点击
function handlePostMenuAction(action) {
    closePostMenu(); // 先关菜单

    if (currentMenuPostIndex === -1 || !igPostsData[currentMenuPostIndex]) return;
    const post = igPostsData[currentMenuPostIndex];

    // --- 编辑功能 ---
    if (action === 'edit') {
        // 复用之前的文本编辑弹窗 (之前用于改人设和消息)
        // 我们设置一个全局标记，告诉 confirmTextEdit 函数我们现在是在改帖子
        editingTextField = 'moment-text';

        // 填充旧内容
        document.getElementById('big-text-input').value = post.text;

        // 修改弹窗标题
        document.querySelector('#modal-text-edit .modal-title').textContent = "编辑动态";

        // 打开弹窗
        const modal = document.getElementById('modal-text-edit');
        modal.style.display = 'flex';
        modal.style.zIndex = '2200';
        setTimeout(() => {
            modal.classList.add('active');
            document.getElementById('big-text-input').focus();
        }, 10);
    }

    // --- 删除功能 ---
    else if (action === 'delete') {
        openGenConfirmModal(
            "删除动态",
            "确定要删除这条动态吗？<br>此操作不可恢复。",
            "删除",
            () => {
                // 执行删除
                igPostsData.splice(currentMenuPostIndex, 1);
                saveMomentsData(); // 保存到本地

                // 刷新列表
                renderFeedList();

                // 如果是在详情页删除的，要关掉详情页
                const detailPage = document.getElementById('sub-moment-detail');
                if (detailPage.classList.contains('active')) { // 这里原本用style判断，现在用类名更稳
                     // 简单判断是否打开了详情页，直接关掉
                     closeSubPage('sub-moment-detail');
                }

                showToast("动态已删除");
                closeGenConfirmModal();
            }
        );
    }
}

// ================== 限时动态 (Story) 状态管理 ==================

// 获取所有有 Story 的用户 ID 列表
function getActiveStories() {
    return JSON.parse(localStorage.getItem('active_stories') || '{}');
}

// ================== 5. 【发布/激活限时动态】 ==================
function activateStory(roleId) {
    const stories = getActiveStories();
    stories[roleId] = Date.now();
    localStorage.setItem('active_stories', JSON.stringify(stories));

    // 核心逻辑：发布新动态时，移除“已读”标记，让光圈变回彩虹色
    let readList = JSON.parse(localStorage.getItem('read_stories_list') || '{}');
    if (readList[roleId]) {
        delete readList[roleId];
        localStorage.setItem('read_stories_list', JSON.stringify(readList));
    }

    renderChatSessionList();
    renderStatusFlow();
}

// ================== STORY CREATION/VIEWER 核心逻辑 (整合修复) ==================

let storyDraft = {
    mode: 'text', // 'text' or 'image'
    text: '',
    mediaFile: null, // File object for the image
    bgColorIndex: 1
};
const storyColors = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5']; // 背景色预设

let currentStoryViewer = {
    roleId: null,      // 当前正在查看谁的 Story
    stories: [],       // 该用户所有活跃的 Story 列表
    currentIndex: 0,   // 当前正在播放第几个 Story
    timer: null,       // 进度条计时器 ID
    isPlaying: false,
    isPaused: false,
    elapsedTime: 0,    // 当前 Story 已播放的时间
    storyDuration: 15000, // 每个 Story 播放时长 5秒
};

// ----------------------------------------------------
// --- 1. 状态管理与辅助函数 ---
// ----------------------------------------------------

// 格式化时间助手
function formatTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (minutes < 60) return minutes <= 1 ? "刚刚" : `${minutes}分钟前`;
    if (hours < 24) return `${hours}小时前`;
    return `${days}天前`;
}

// 清除 Story 状态 (标记为已读)
function clearStoryStatus(roleId) {
    const stories = JSON.parse(localStorage.getItem('active_stories') || '{}');
    delete stories[roleId];
    localStorage.setItem('active_stories', JSON.stringify(stories));

    renderChatSessionList();
    renderStatusFlow();
}

// 获取 Story 状态
function getActiveStories() {
    return JSON.parse(localStorage.getItem('active_stories') || '{}');
}

// ----------------------------------------------------
// --- 2. 计时器控制函数 (修复 ReferenceError) ---
// ----------------------------------------------------

// 启动计时器和进度条动画 (startStoryTimer)
// ================== 修复：快拍进度条与多段显示逻辑 ==================

// ================== 修复：快拍播放控制逻辑 (完整版) ==================

// 1. 播放入口
function playStory() {
    if (currentStoryViewer.isPlaying && !currentStoryViewer.isPaused) return;
    startStoryTimer();
}

// 2. 启动/恢复 进度条计时器
function startStoryTimer() {
    stopStoryTimer();

    const container = document.querySelector('.viewer-progress-bar-container');
    if (!container || !currentStoryViewer.stories.length) return;

    // --- A. 动态渲染分段进度条 ---
    container.innerHTML = '';

    const totalStories = currentStoryViewer.stories.length;
    const currentIndex = currentStoryViewer.currentIndex;

    for (let i = 0; i < totalStories; i++) {
        const segment = document.createElement('div');
        segment.className = 'progress-segment';
        const fill = document.createElement('div');
        fill.className = 'progress-fill-inner';

        if (i < currentIndex) {
            fill.style.width = '100%';
        } else if (i > currentIndex) {
            fill.style.width = '0%';
        } else {
            fill.id = 'current-story-progress';
            const initialPercent = (currentStoryViewer.elapsedTime / currentStoryViewer.storyDuration) * 100;
            fill.style.width = `${initialPercent}%`;
        }
        segment.appendChild(fill);
        container.appendChild(segment);
    }

    // --- B. 启动当前段的动画 ---
    const currentBar = document.getElementById('current-story-progress');
    if (currentBar) {
        const remainingTime = currentStoryViewer.storyDuration - currentStoryViewer.elapsedTime;
        currentBar.offsetWidth; // 强制重绘
        currentBar.style.transition = `width ${remainingTime}ms linear`;
        currentBar.style.width = '100%';

        // ... (inside startStoryTimer) ...
        currentStoryViewer.timer = setTimeout(() => {
            currentStoryViewer.elapsedTime = 0;

            // 🔥 每次播完一张，都标记这张为已读
            markStoryAsRead(currentStoryViewer.roleId);

            if (currentStoryViewer.currentIndex >= totalStories - 1) {
                // 全部播完
                closeSubPage('sub-story-viewer');
            } else {
                // 播下一张
                currentStoryViewer.currentIndex++;
                renderCurrentStory();
                playStory();
            }
        }, remainingTime);
        // ...
    } // <--- 🚨 之前就是漏掉了这个大括号！导致后面全部报错 🚨

    currentStoryViewer.isPlaying = true;
    currentStoryViewer.isPaused = false;
}

// 3. 暂停逻辑
function pauseStory() {
    if (!currentStoryViewer.isPlaying || currentStoryViewer.isPaused) return;

    currentStoryViewer.isPaused = true;

    if (currentStoryViewer.timer) {
        clearTimeout(currentStoryViewer.timer);
        currentStoryViewer.timer = null;
    }

    const currentBar = document.getElementById('current-story-progress');
    if (currentBar) {
        const computedStyle = window.getComputedStyle(currentBar);
        const widthPx = parseFloat(computedStyle.width);
        const parentWidth = parseFloat(window.getComputedStyle(currentBar.parentElement).width);
        const percent = (widthPx / parentWidth);

        currentStoryViewer.elapsedTime = percent * currentStoryViewer.storyDuration;

        currentBar.style.transition = 'none';
        currentBar.style.width = `${percent * 100}%`;
    }
}

// 4. 停止/重置逻辑
function stopStoryTimer() {
    if (currentStoryViewer.timer) {
        clearTimeout(currentStoryViewer.timer);
        currentStoryViewer.timer = null;
    }
}

// ----------------------------------------------------
// --- 3. 创作页面逻辑 (Creation) ---
// ----------------------------------------------------

// 核心入口：打开 Story 创作页面
function openCreateStory(event) {
    if (event) event.stopPropagation(); // 🚨 修正点 4：阻止冒泡，避免触发父级卡片的点击事件

        // 重置草稿状态
        storyDraft = { mode: 'text', text: '', mediaFile: null, bgColorIndex: 1 };

        // 初始化 UI
        switchStoryMode('text');
        document.getElementById('story-text-input').value = '';
        document.getElementById('story-image-text-input').value = '';
        document.getElementById('story-image-preview').style.backgroundImage = 'none';

        document.getElementById('story-creator-title').textContent = "发布快拍";
        openSubPage('sub-create-story');
}

// 切换模式
function switchStoryMode(mode) {
    storyDraft.mode = mode;

    // 更新按钮状态
    document.getElementById('btn-mode-text').classList.remove('active');
    document.getElementById('btn-mode-image').classList.remove('active');
    document.getElementById('story-mode-text').style.display = 'none';
    document.getElementById('story-mode-image').style.display = 'none';

    if (mode === 'text') {
        // 保存当前输入的内容
        storyDraft.text = document.getElementById('story-image-text-input').value.trim();

        document.getElementById('btn-mode-text').classList.add('active');
        document.getElementById('story-mode-text').style.display = 'flex';
        document.getElementById('story-text-input').value = storyDraft.text;
        document.getElementById('story-text-input').focus();

    } else { // image mode
        // 保存当前输入的内容
        storyDraft.text = document.getElementById('story-text-input').value.trim();

        document.getElementById('btn-mode-image').classList.add('active');
        document.getElementById('story-mode-image').style.display = 'block';
        document.getElementById('story-image-text-input').value = storyDraft.text;

        // 更新图片预览
        const preview = document.getElementById('story-image-preview');
        if (storyDraft.mediaFile) {
             const url = URL.createObjectURL(storyDraft.mediaFile);
             preview.style.backgroundImage = `url(${url})`;
        } else {
             preview.style.backgroundImage = 'none';
        }
        document.getElementById('story-image-text-input').focus();
    }
}

// 循环切换文本背景颜色
function cycleStoryColor(el) {
    storyDraft.bgColorIndex = (storyDraft.bgColorIndex % storyColors.length) + 1;
    // 移除所有颜色类
    storyColors.forEach(c => el.classList.remove(c));
    // 添加新的颜色类
    el.classList.add(storyColors[storyDraft.bgColorIndex - 1]);
}

// 处理图片上传
function handleStoryImageUpload(input) {
    if (input.files && input.files[0]) {
        storyDraft.mediaFile = input.files[0];
        const url = URL.createObjectURL(storyDraft.mediaFile);
        document.getElementById('story-image-preview').style.backgroundImage = `url(${url})`;

        // 自动聚焦文字输入
        document.getElementById('story-image-text-input').focus();
    }
}

// 发布 Story (核心保存逻辑)
async function publishStory() {
    // A. 收集数据
    let contentText = '';
    if (storyDraft.mode === 'text') {
        contentText = document.getElementById('story-text-input').value.trim();
    } else {
        contentText = document.getElementById('story-image-text-input').value.trim();
    }

    if (!contentText && !storyDraft.mediaFile) {
        showToast("请输入文字或选择图片");
        return;
    }

    showToast("正在发布快拍...");
    const storyId = Date.now().toString();

    // B. 保存媒体文件 (如果存在)
    let mediaKey = null;
    if (storyDraft.mediaFile) {
        mediaKey = `story_media_${storyId}`;
        await dbHelper.save(mediaKey, storyDraft.mediaFile);
    }

    // C. 构造 Story 数据对象 (存储在 active_stories_data)
    const storyData = {
        id: storyId,
        userId: 'user_me',
        type: storyDraft.mode,
        text: contentText,
        mediaKey: mediaKey,
        backgroundClass: storyDraft.mode === 'text' ? storyColors[storyDraft.bgColorIndex - 1] : 'image-custom',
        timestamp: Date.now()
    };

    // D. 存储内容
    localStorage.setItem('my_active_story_content', JSON.stringify(storyData));

    // E. 触发光圈点亮 (自己的头像)
    activateStory('user_me');

    // F. 刷新并关闭
    closeSubPage('sub-create-story');
    showToast("快拍发布成功！");

    promptStoryDuration();
}

// ----------------------------------------------------
// --- 4. 播放器逻辑 (Viewer) ---
// ----------------------------------------------------

// ================== 打开播放器 (逻辑修正版) ==================
async function openStoryViewer(targetRoleId) {
    currentStoryViewer.roleId = targetRoleId;
    currentStoryViewer.stories = [];
    currentStoryViewer.isPlaying = false;
    currentStoryViewer.isPaused = false;
    stopStoryTimer();

    // 1. 获取数据
    if (targetRoleId === 'user_me') {
        let myStories = JSON.parse(localStorage.getItem('my_stories_list') || '[]');
        myStories = myStories.filter(s => s.expirationTime > Date.now());

        // 🚨 强制排序：时间小的(旧)在前，时间大的(新)在后
        myStories.sort((a, b) => a.timestamp - b.timestamp);

        currentStoryViewer.stories = myStories;
    } else {
        // 🚨 彻底屏蔽好友模拟数据：只要不是 user_me，目前直接为空
        // 等你做了好友发布功能再改这里
        currentStoryViewer.stories = [];
    }

    if (currentStoryViewer.stories.length === 0) {
        showToast("暂无动态");
        if(targetRoleId === 'user_me') renderStatusFlow(); // 刷新状态
        return;
    }

    // 2. 确定播放起点
    const readMap = JSON.parse(localStorage.getItem('read_stories_map') || '{}');
    const lastReadTime = readMap[targetRoleId] || 0;

    // 找第一个“未读”的 (发布时间 > 最后阅读时间)
    let startIndex = currentStoryViewer.stories.findIndex(s => s.timestamp > lastReadTime);

    // 如果都读过了 (-1)，就从 0 (最旧的) 开始重播
    if (startIndex === -1) {
        startIndex = 0;
    }

    currentStoryViewer.currentIndex = startIndex;
    currentStoryViewer.elapsedTime = 0;

    // 3. 打开 UI
    document.getElementById('story-viewer-content').onclick = function() {
        if (currentStoryViewer.isPaused) playStory();
        else pauseStory();
    };

    openSubPage('sub-story-viewer');
    await renderCurrentStory();
    playStory();
}

// ================== 渲染当前 Story (层级修复版) ==================
async function renderCurrentStory() {
    const story = currentStoryViewer.stories[currentStoryViewer.currentIndex];
    if (!story) {
        // 全部播放完毕
        // 标记最后一张为已读
        if (currentStoryViewer.currentIndex > 0) {
             const lastStory = currentStoryViewer.stories[currentStoryViewer.currentIndex - 1];
             // 这里逻辑稍微复杂一点，简单起见直接调用关闭
        }

        closeSubPage('sub-story-viewer');
        return;
    }

    // --- 1. 获取 DOM 元素 ---
    const textPane = document.getElementById('viewer-text-content');
    const imagePane = document.getElementById('viewer-image-content');
    const userAvatar = document.getElementById('viewer-avatar');
    const userName = document.getElementById('viewer-username');
    const timeLabel = document.getElementById('viewer-time');
    const deleteBtn = document.getElementById('btn-delete-story');

    // --- 2. 填充头部信息 ---
    let avatarUrl = '';
    let usernameStr = '';

    if (story.userId === 'user_me') {
        avatarUrl = await getSafeUrl('userAvatar_main');
        usernameStr = localStorage.getItem('userNickname') || '我';
        if(deleteBtn) deleteBtn.style.display = 'block';
    } else {
        avatarUrl = await getRoleChatAvatarUrl(story.userId);
        // 这里需要获取角色名，为了性能简化，如果没传名字可能需要查表
        // 简单起见暂时显示 ID 或 "好友"
        usernameStr = story.userId;
        if(deleteBtn) deleteBtn.style.display = 'none';
    }

    if(userAvatar) userAvatar.style.backgroundImage = `url(${avatarUrl})`;
    if(userName) userName.textContent = usernameStr;
    if(timeLabel) timeLabel.textContent = formatTimeAgo(story.timestamp);

    // --- 3. 🚨 核心修复：切换显示模式 🚨 ---

    // 先重置：移除所有 active-mode 类
    textPane.classList.remove('active-mode');
    imagePane.classList.remove('active-mode');

    // 同时也强制隐藏 style.display (双重保险)
    textPane.style.display = 'none';
    imagePane.style.display = 'none';

    if (story.type === 'text') {
        // === 文本模式 ===
        textPane.classList.add('active-mode');
        textPane.style.display = 'flex'; // 强制显示

        // 应用背景色
        storyColors.forEach(c => textPane.classList.remove(c));
        textPane.classList.add(story.backgroundClass || 'color-1');

        document.getElementById('viewer-text-p').textContent = story.text;

    } else if (story.type === 'image') {
        // === 图片模式 ===
        imagePane.classList.add('active-mode');
        imagePane.style.display = 'flex'; // 强制显示

        // 加载图片
        const imgEl = document.getElementById('viewer-image-img');
        if (story.mediaKey) {
            const mediaUrl = await getSafeUrl(story.mediaKey);
            imgEl.src = mediaUrl;
        }

        // 设置叠加文字
        const textOverlay = document.getElementById('viewer-image-text-p');
        textOverlay.textContent = story.text;

        // 应用坐标位置
        if (story.position) {
            textOverlay.style.left = story.position.x + '%';
            textOverlay.style.top = story.position.y + '%';
            textOverlay.style.transform = 'translate(-50%, -50%)';
        } else {
            // 默认居中
            textOverlay.style.left = '50%';
            textOverlay.style.top = '50%';
            textOverlay.style.transform = 'translate(-50%, -50%)';
        }
    }

    // 4. 启动进度条
    startStoryTimer();
}

// 9. 点赞、转发、删除功能 (修复 ReferenceError)
// ================== 点赞特效逻辑 ==================
function likeStory() {
    const btn = document.getElementById('story-like-btn');
    // 切换类名触发 CSS 动画
    btn.classList.toggle('active-like');

    if (btn.classList.contains('active-like')) {
        showToast("❤️");
    }
}
function shareStory() { showToast("已转发！"); }
function deleteStory() {
    if (currentStoryViewer.roleId === 'user_me') {
        if (confirm("确定要删除你的快拍吗？")) {
            localStorage.removeItem('my_active_story_content');
            clearStoryStatus('user_me');
            closeSubPage('sub-story-viewer');
            showToast("快拍已删除！");
        }
    } else {
        showToast("你不能删除别人的快拍！");
    }
}

// ================== 14. 我的名片模块逻辑 (纯粹背景终极版) ==================

async function renderMyProfileCard() {
    const container = document.getElementById('my-profile-card');
    if (!container) return;

    // 1. 读取数据
    const nick = localStorage.getItem('userNickname') || '点击设置昵称';
    const sign = localStorage.getItem('userSignature') || '点击设置个性签名';
    let avatarUrl = '';
    let bgUrl = '';

    try {
        const savedAvatar = await dbHelper.get('userAvatar_main');
        if (savedAvatar) {
            avatarUrl = (savedAvatar instanceof Blob || savedAvatar instanceof File)
                ? URL.createObjectURL(savedAvatar)
                : savedAvatar;
        }
        // 读取名片自定义背景
        const savedBg = await dbHelper.get('user_profile_bg');
        if (savedBg) {
             bgUrl = (savedBg instanceof Blob || savedBg instanceof File)
                ? URL.createObjectURL(savedBg)
                : savedBg;
        }
    } catch(e) {}

    // 2. 构造样式变量
    const defaultBgGradient = 'linear-gradient(135deg, rgba(64, 196, 255, 0.2), rgba(255, 128, 191, 0.2))';
    const defaultBgImage = "url('https://images.unsplash.com/photo-1549491630-f965d070104e?q=80&w=2000&auto=format&fit=crop')";

    // 🚨 核心逻辑 1：外层卡片样式 🚨
    let outerCardStyles = `
        background: rgba(255, 255, 255, 0.15); /* 默认玻璃底色 */
        backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        background-image: ${bgUrl
            ? `url('${bgUrl}')` /* 有图：只用图 */
            : `${defaultBgGradient}, ${defaultBgImage}`}; /* 无图：用渐变+默认图 */
    `;

    // 🚨 核心逻辑 2：有自定义背景图时，移除所有玻璃效果 🚨
    if (bgUrl) {
        outerCardStyles = `
            background: transparent; /* 纯透明底 */
            backdrop-filter: none; -webkit-backdrop-filter: none; /* 移除模糊 */
            border: none; /* 移除边框 */
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); /* 保留柔和投影 */
            background-image: url('${bgUrl}'); /* 只保留图片 */
        `;
    }

    // 3. 构建 HTML
    container.innerHTML = `
        <div
            id="profile-card-inner-box"
            onclick="triggerProfileBgUpload()"
            style="
                ${outerCardStyles}
                border-radius: 20px;
                padding: 0;
                width: 100%;
                cursor: pointer;
                transition: transform 0.1s;
                background-size: cover;
                color: white;
            "
        >
            <div
                id="profile-content-area"
                style="
                    /* 顶层遮罩：有自定义背景时，用透明度更低的纯黑遮罩 */
                    background: ${bgUrl ? 'rgba(0, 0, 0, 0.35)' : 'rgba(0, 0, 0, 0.25)'};
                    padding: 20px;
                    border-radius: 20px;
                    text-align: center;
                "
            >
                <div
                    class="profile-avatar"
                    id="my-profile-avatar-display"
                    style="
                        width: 90px; height: 90px; margin: 10px auto 15px auto;
                        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
                        border: 4px solid rgba(255,255,255,0.9);
                        cursor: pointer;
                        /* ... 头像图片逻辑 ... */
                        background-image: ${avatarUrl ? 'url(' + avatarUrl + ')' : `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" opacity="0.5"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>')`};
                        background-size: ${avatarUrl ? 'cover' : 'contain'};
                        background-position: center;
                        background-repeat: no-repeat;
                        background-color: ${avatarUrl ? 'transparent' : 'rgba(255,255,255,0.1)'};
                    "
                    onclick="triggerProfileUpload(); return false;"
                >
                </div>

                <div
                    class="profile-nickname"
                    id="my-profile-nickname"
                    style="
                        font-size: 24px; font-weight: 800; text-shadow: 0 2px 5px rgba(0,0,0,0.5);
                        color: white; margin-bottom: 5px; cursor: pointer;
                    "
                    onclick="openProfileEditModal('nickname'); return false;"
                >${nick}</div>

                <div
                    class="profile-signature"
                    id="my-profile-signature"
                    style="
                        font-size: 15px; opacity: 0.9; color: rgba(255,255,255,0.9);
                        max-width: 100%; cursor: pointer; white-space: normal; overflow: visible; text-overflow: unset;
                    "
                    onclick="openProfileEditModal('signature'); return false;"
                >${sign}</div>
            </div>
        </div>
    `;

    // ... (点击反馈和浅色模式适配逻辑，保持不变) ...
    const innerBox = document.getElementById('profile-card-inner-box');
    if(innerBox) {
        innerBox.onmousedown = (e) => { e.stopPropagation(); innerBox.style.transform = 'scale(0.98)'; };
        innerBox.onmouseup = (e) => { e.stopPropagation(); innerBox.style.transform = 'scale(1)'; };
        innerBox.ontouchstart = (e) => { e.stopPropagation(); innerBox.style.transform = 'scale(0.98)'; };
        innerBox.ontouchend = (e) => { e.stopPropagation(); innerBox.style.transform = 'scale(1)'; };
    }

    if (document.body.classList.contains('light-theme')) {
         const cardInner = document.getElementById('profile-content-area');
         const avatarEl = document.getElementById('my-profile-avatar-display');

         if(cardInner) {
            // 浅色模式下，如果没背景图，内容区域的背景必须是透明的
            cardInner.style.background = 'transparent';
            cardInner.style.backdropFilter = 'none';
            cardInner.style.webkitBackdropFilter = 'none';
            cardInner.style.borderColor = 'rgba(0,0,0,0.1)';
            cardInner.style.color = '#333';
         }

         if(avatarEl) {
             avatarEl.style.borderColor = 'rgba(0,0,0,0.1)';
             if (!avatarUrl) {
                const newBgImage = avatarEl.style.backgroundImage.replace(/fill='w[^']*'/g, "fill='black'");
                avatarEl.style.backgroundImage = newBgImage.replace(/opacity:0.5/g, 'opacity:0.7');
                avatarEl.style.backgroundColor = 'rgba(0,0,0,0.05)';
             }
         }

         const nickEl = document.getElementById('my-profile-nickname');
         const signEl = document.getElementById('my-profile-signature');
         if(nickEl) {
             nickEl.style.color = '#000000';
             nickEl.style.textShadow = 'none';
         }
         if(signEl) signEl.style.color = 'rgba(0,0,0,0.7)';
    }
}

// ... (之前添加的代码，确保它还在您的文件中) ...

// 1. 触发背景上传（卡片点击事件）
function triggerProfileBgUpload() {
    const input = document.getElementById('profile-bg-input');
    if (input) {
        input.click();
    } else {
        // 如果找不到输入框，提示用户检查 HTML 结构
        console.error("Error: The element 'profile-bg-input' was not found. Please check your HTML structure.");
        showToast("无法上传：名片模块初始化失败，请检查代码结构。");
    }
}
// 2. 处理背景上传文件
function handleProfileBgUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // 1. 存入数据库
        dbHelper.save('user_profile_bg', file)
            .then(() => {
                showToast("名片背景已更换");
                // 2. 立即刷新 UI (调用 renderMyProfileCard 会加载新的背景图并显示)
                renderMyProfileCard();
            })
            .catch(e => {
                console.error("背景保存失败:", e);
                showToast("背景保存失败");
            });

        input.value = ''; // 清空 input 确保下次能再次选择相同文件
    }
}

// ================== 快拍发布和时长逻辑 ==================

let selectedDurationHours = 24; // 默认选择 24 小时
let draftContentForPublish = null; // 临时代存最终发布内容

// ================== 1. 渲染时长选项 (修复对勾逻辑) ==================
function renderDurationOptions() {
    const options = [
        { label: "12 小时", hours: 12 },
        { label: "24 小时 (默认)", hours: 24 },
        { label: "3 天", hours: 72 },
        { label: "7 天 (最长)", hours: 168 }
    ];
    const container = document.getElementById('story-duration-options');
    if (!container) return;
    container.innerHTML = '';

    options.forEach(opt => {
        const item = document.createElement('div');
        item.className = 'ai-list-item';
        // 如果当前选项等于全局变量 selectedDurationHours，加 selected 类
        if (opt.hours === selectedDurationHours) item.classList.add('selected');

        item.onclick = () => {
            // 1. 移除所有选中状态
            document.querySelectorAll('#story-duration-options .ai-list-item').forEach(e => e.classList.remove('selected'));
            // 2. 激活当前状态
            item.classList.add('selected');
            // 3. 更新变量
            selectedDurationHours = opt.hours;
        };

        // 这里的 check-icon 默认没有 style，全靠 CSS 控制
        item.innerHTML = `
            <div class="ai-item-label">${opt.label}</div>
            <span class="check-icon">✔</span>
        `;
        container.appendChild(item);
    });

    // 绑定确认按钮
    document.getElementById('btn-confirm-duration').onclick = confirmPublishStory;
}

// 2. 触发时长选择模态框 (替代 publishStory 的主要逻辑)
function promptStoryDuration() {
    // A. 收集数据 (与 publishStory 原来的数据收集逻辑相同)
    let contentText = '';
    if (storyDraft.mode === 'text') {
        contentText = document.getElementById('story-text-input').value.trim();
    } else {
        contentText = document.getElementById('story-image-text-input').value.trim();
    }
    if (!contentText && !storyDraft.mediaFile) {
        showToast("请输入文字或选择图片");
        return;
    }

    // 🚨 记录文字定位坐标（新增逻辑）🚨
    let position = { x: 0, y: 0 };
    if (storyDraft.mode === 'image') {
        const textarea = document.getElementById('story-image-text-input');
        if (textarea) {
            position.x = parseFloat(textarea.style.left) || 50;
            position.y = parseFloat(textarea.style.top) || 50;
        }
    }

    // 暂存所有数据
    draftContentForPublish = {
        contentText,
        position,
        mediaFile: storyDraft.mediaFile,
        mode: storyDraft.mode,
        backgroundClass: storyDraft.mode === 'text' ? storyColors[storyDraft.bgColorIndex - 1] : 'image-custom',
    };

    // B. 渲染并打开模态框
    renderDurationOptions();
    openModal('modal-story-duration');
}

// ================== 3. 确认发布 (顺序强制修正版) ==================
async function confirmPublishStory() {
    closeModal('modal-story-duration');

    if (!draftContentForPublish) return;

    showToast("正在发布快拍...");
    const { contentText, position, mediaFile, mode, backgroundClass } = draftContentForPublish;
    const storyId = Date.now().toString();
    const expirationTime = Date.now() + (selectedDurationHours * 60 * 60 * 1000);

    // A. 保存图片
    let mediaKey = null;
    if (mediaFile) {
        mediaKey = `story_media_${storyId}`;
        await dbHelper.save(mediaKey, mediaFile);
    }

    // B. 构造数据
    const storyData = {
        id: storyId,
        userId: 'user_me',
        type: mode,
        text: contentText,
        mediaKey: mediaKey,
        backgroundClass: backgroundClass,
        timestamp: Date.now(),
        expirationTime: expirationTime,
        position: position
    };

    // C. 存储逻辑 (🚨 关键：先读旧的，再 push 新的)
    let myStories = JSON.parse(localStorage.getItem('my_stories_list') || '[]');
    // 1. 清理过期
    myStories = myStories.filter(s => s.expirationTime > Date.now());

    // 2. 🚨 追加到末尾 (保证 0 是最旧，length-1 是最新)
    myStories.push(storyData);

    localStorage.setItem('my_stories_list', JSON.stringify(myStories));

    // D. 触发更新 (手动激活，确保光圈亮起)
    activateStory('user_me');

    closeSubPage('sub-create-story');
    showToast(`快拍发布成功！`);
}

// ================== 图片快拍文字拖动定位逻辑 ==================

let isDraggingText = false;
let currentTextElement = null;

// 初始化拖动监听
function initTextDragListeners() {
    const textarea = document.getElementById('story-image-text-input');
    if (!textarea) return;

    textarea.addEventListener('mousedown', startDrag);
    textarea.addEventListener('touchstart', startDrag);
}

function startDrag(e) {
    // 确保只有在图片模式下才开始拖动
    if (storyDraft.mode !== 'image') return;

    currentTextElement = e.target;
    isDraggingText = true;
    // e.preventDefault(); // 注释掉这行，否则可能无法聚焦输入文字

    document.addEventListener('mousemove', drag);
    document.addEventListener('touchmove', drag);
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
}

function drag(e) {
    if (!isDraggingText || !currentTextElement) return;

    const event = e.touches ? e.touches[0] : e;
    const parentRect = currentTextElement.parentElement.getBoundingClientRect();

    // 计算相对于父容器的百分比位置
    let x = event.clientX - parentRect.left;
    let y = event.clientY - parentRect.top;

    let xPercent = Math.min(100, Math.max(0, (x / parentRect.width) * 100));
    let yPercent = Math.min(100, Math.max(0, (y / parentRect.height) * 100));

    // 应用样式
    currentTextElement.style.left = `${xPercent}%`;
    currentTextElement.style.top = `${yPercent}%`;
    currentTextElement.style.transform = 'translate(-50%, -50%)';
}

function endDrag() {
    if (!isDraggingText) return;
    isDraggingText = false;

    document.removeEventListener('mousemove', drag);
    document.removeEventListener('touchmove', drag);
    document.removeEventListener('mouseup', endDrag);
    document.removeEventListener('touchend', endDrag);

    // 存储最终百分比位置在 DOM 样式里，发布时会读取
    currentTextElement = null;
}

// 确保在应用初始化时调用拖动监听初始化
document.addEventListener('DOMContentLoaded', initTextDragListeners);

// ================== 通用模态框函数 ==================

// 通用打开模态框函数
function openModal(id) {
    const m = document.getElementById(id);
    if (m) {
        m.style.display = 'flex';
        // 确保层级在最高 (针对 modal-overlay)
        m.style.zIndex = '2100';
        setTimeout(() => m.classList.add('active'), 10);
    } else {
        console.error("找不到模态框:", id);
    }
}

// 通用关闭模态框函数
function closeModal(id) {
    const m = document.getElementById(id);
    if(m) {
        m.classList.remove('active');
        setTimeout(()=>m.style.display='none', 300);
    }
}

// ================== 标记已读 (头部光圈同步版) ==================
function markStoryAsRead(roleId) {
    const currentStory = currentStoryViewer.stories[currentStoryViewer.currentIndex];
    if (!currentStory) return;

    // 1. 更新数据库
    let readMap = JSON.parse(localStorage.getItem('read_stories_map') || '{}');
    const oldTime = readMap[roleId] || 0;

    // 只有当 当前看的这条比记录的更新时，才更新记录
    if (currentStory.timestamp > oldTime) {
        readMap[roleId] = currentStory.timestamp;
        localStorage.setItem('read_stories_map', JSON.stringify(readMap));
    }

    // 2. 刷新首页顶栏 (My Card)
    renderStatusFlow();

    // 3. 刷新消息列表 (Message List)
    renderChatSessionList();

    // 4. 🚨 核心修复：如果正开着聊天详情页，直接把头顶的光圈变灰
    const detailPage = document.getElementById('sub-chat-detail');
    // 判断页面是否激活 且 当前聊天的对象就是正在看快拍的人
    if (detailPage && detailPage.classList.contains('active') && currentChatId === roleId) {
        const headerWrap = document.getElementById('chat-header-avatar-wrap');
        if (headerWrap) {
            // 暴力移除彩圈，加上灰圈
            headerWrap.classList.remove('has-story');
            headerWrap.classList.add('read-story');
        }
    }
}

// ================== 更多菜单 (删除功能) ==================
function openStoryMoreMenu() {
    pauseStory(); // 先暂停

    // 判断是不是自己的快拍
    if (currentStoryViewer.roleId === 'user_me') {
        openGenConfirmModal(
            "删除快拍",
            "确定要删除这条快拍吗？此操作无法撤销。",
            "删除",
            () => {
                deleteCurrentStory();
                closeGenConfirmModal();
            }
        );
    } else {
        // 如果是别人的，可以显示举报或取消关注等
        showToast("这是好友的动态");
    }
}

// ================== 删除当前快拍 (单条删除逻辑) ==================
async function deleteCurrentStory() {
    // 1. 获取当前正在播放的这条快拍的数据
    const currentStory = currentStoryViewer.stories[currentStoryViewer.currentIndex];

    // 安全检查：如果数据不对，直接停止，防止误删
    if (!currentStory || !currentStory.id) {
        showToast("无法获取当前快拍信息");
        return;
    }

    // 2. 读取本地存储的列表
    let myStories = JSON.parse(localStorage.getItem('my_stories_list') || '[]');

    // 3. 🚨 核心逻辑：只保留 ID 不等于当前 ID 的项 (即删除当前项)
    // filter 会返回一个新的数组，里面是被保留下来的项
    const newStories = myStories.filter(s => s.id !== currentStory.id);

    // 4. 保存回本地存储
    localStorage.setItem('my_stories_list', JSON.stringify(newStories));

    // 5. 同时也删掉对应的图片文件 (清理垃圾)
    if (currentStory.mediaKey) {
        await dbHelper.save(currentStory.mediaKey, null);
    }

    showToast("这条快拍已删除");

    // 6. 刷新首页光圈状态
    renderStatusFlow();

    // 7. 关闭播放器 (简单起见，删完直接关掉，避免索引错乱)
    closeSubPage('sub-story-viewer');
}

// ================== 评论/回复逻辑 ==================
function sendStoryReply() {
    const input = document.getElementById('story-reply-input');
    const text = input.value.trim();
    if (!text) return;

    // 1. 显示在屏幕上 (模拟弹幕)
    const box = document.getElementById('viewer-comments-box');
    const pill = document.createElement('div');
    pill.className = 'viewer-comment-pill';
    pill.textContent = `我: ${text}`;
    box.appendChild(pill);
    box.scrollTop = box.scrollHeight;

    // 2. (可选) 这里可以添加逻辑：把回复作为私信发送给对方
    // addChatMsg('right', `[回复快拍] ${text}`);

    input.value = '';
    showToast("已发送");
    playStory(); // 恢复播放
}

// ================== 分享给好友逻辑 ==================

let selectedShareFriendId = null; // 记录选中的好友ID

// 1. 打开分享弹窗
function openShareModal() {
    selectedShareFriendId = null;
    document.getElementById('share-search').value = '';
    renderShareList();
    openModal('modal-share-story');
}

// 2. 渲染好友列表
async function renderShareList() {
    const container = document.getElementById('share-friend-list');
    container.innerHTML = '';

    const keyword = document.getElementById('share-search').value.toLowerCase();
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

    for (const role of roles) {
        if (keyword && !role.name.toLowerCase().includes(keyword)) continue;

        let avatarUrl = await getRoleChatAvatarUrl(role.id);
        const bgStyle = avatarUrl ? `background-image:url(${avatarUrl})` : 'background-color:#333';

        const item = document.createElement('div');
        item.className = 'share-friend-item';
        item.onclick = () => {
            // 单选逻辑
            document.querySelectorAll('.share-friend-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            selectedShareFriendId = role.id;
        };

        item.innerHTML = `
            <div class="share-avatar" style="${bgStyle}"></div>
            <div class="share-name">${role.name}</div>
        `;
        container.appendChild(item);
    }
}

// ================== 3. 确认发送 (修复：带坐标位置 + 存入历史) ==================
async function confirmShareStory() {
    if (!selectedShareFriendId) {
        showToast("请选择一位好友");
        return;
    }

    const currentStory = currentStoryViewer.stories[currentStoryViewer.currentIndex];
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    const friend = roles.find(r => r.id === selectedShareFriendId);
    if (!friend) return;

    showToast("正在发送...");

    try {
        // 1. 确保会话存在
        let sessionList = JSON.parse(localStorage.getItem('chat_sessions') || '[]');
        let session = sessionList.find(c => c.id === selectedShareFriendId);

        if (!session) {
            session = {
                id: selectedShareFriendId, type: 'single', name: friend.name, lastMsg: '[快拍]', time: '刚刚'
            };
            const roleAvatarBlob = await dbHelper.get(`role_${selectedShareFriendId}_avatar`);
            if (roleAvatarBlob) await dbHelper.save(`chat_avatar_${selectedShareFriendId}`, roleAvatarBlob);
            sessionList.unshift(session);
            localStorage.setItem('chat_sessions', JSON.stringify(sessionList));
        }

        // 2. 构造历史记录 (🚨 核心修复：加入 position 字段)
        const msgId = Date.now().toString();
        const newMsg = {
            id: msgId,
            sender: 'right',
            text: '[快拍]',
            timestamp: Date.now(),
            isStoryShare: true,
            storyData: {
                id: currentStory.id,
                type: currentStory.type,
                content: currentStory.text,
                mediaKey: currentStory.mediaKey,
                bgClass: currentStory.backgroundClass,
                ownerId: currentStory.userId,
                // 👇👇👇 关键新增：把坐标也存进去！
                position: currentStory.position || {x: 50, y: 50}
            }
        };

        // 3. 存入数据库
        let history = await loadChatHistory(selectedShareFriendId);
        history.push(newMsg);
        await saveChatHistory(selectedShareFriendId, history);

        updateChatLastMessage(selectedShareFriendId, `[分享了快拍]`);

        // 4. 如果当前在聊天页，立即上屏
        const detailPage = document.getElementById('sub-chat-detail');
        if (detailPage && detailPage.classList.contains('active') && currentChatId === selectedShareFriendId) {
            await appendChatBubble('right', '', true, msgId, null, {
                isStoryShare: true,
                storyData: newMsg.storyData
            });
        }

        showToast(`已发送给 ${friend.name}`);

    } catch (e) {
        console.error("分享失败", e);
        showToast("发送失败");
    }

    closeModal('modal-share-story');
    playStory();
}

// ================== 查看分享的快拍 (修复：删除检测 + 坐标应用) ==================
function viewSharedStory(e, encodedData) {
    // 拦截多选模式
    if (typeof isMultiSelectMode !== 'undefined' && isMultiSelectMode) return;

    e.stopPropagation();

    try {
        const data = JSON.parse(decodeURIComponent(encodedData));

        // --- 🚨 1. 核心修复：检查快拍是否已删除 ---
        // 只有当快拍是“我”发的，或者属于“好友列表”时才检查
        if (data.ownerId === 'user_me') {
            const myStories = JSON.parse(localStorage.getItem('my_stories_list') || '[]');
            const exists = myStories.find(s => s.id === data.id);

            // 如果列表里找不到这个ID，说明被删了
            if (!exists) {
                showToast("该快拍已删除或过期");
                return; // ⛔️ 终止播放
            }
        }
        // (如果是好友发的，逻辑类似，但目前模拟数据不方便查，暂只检查自己的)

        // --- 2. 构造播放数据 (带坐标) ---
        const storyItem = {
            id: data.id,
            userId: data.ownerId,
            type: data.type,
            text: data.content,
            mediaKey: data.mediaKey,
            backgroundClass: data.bgClass,
            timestamp: Date.now(),
            // 👇👇👇 关键新增：读取存入的坐标
            position: data.position
        };

        // 3. 设置并播放
        currentStoryViewer.roleId = data.ownerId;
        currentStoryViewer.stories = [storyItem]; // 只播这一条
        currentStoryViewer.currentIndex = 0;
        currentStoryViewer.elapsedTime = 0;
        currentStoryViewer.isPlaying = false;
        currentStoryViewer.isPaused = false;

        const viewerContent = document.getElementById('story-viewer-content');
        if (viewerContent) {
            viewerContent.onclick = function() {
                if (currentStoryViewer.isPaused) playStory();
                else pauseStory();
            };
        }

        openSubPage('sub-story-viewer');
        renderCurrentStory();
        playStory();

    } catch (err) {
        console.error("查看快拍失败", err);
        showToast("数据已失效");
    }
}

// ================== 社交模拟核心引擎 ==================

// 模拟互动：让好友随机浏览、点赞、评论你的帖子
async function simulateSocialActivity() {
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    if (roles.length === 0 || igPostsData.length === 0) return;

    let hasChanges = false;

    // 遍历每一个帖子
    for (const post of igPostsData) {
        // 1. 初始化数据结构 (如果旧数据没有这些字段)
        if (!post.views) post.views = 0;
        if (!post.viewers) post.viewers = [];
        if (!post.notifications) post.notifications = []; // 存互动记录

        // 2. 模拟浏览 (View)
        // 每个角色有 50% 概率看过这个帖子
        for (const role of roles) {
            // 如果这个角色还没看过
            if (!post.viewers.find(v => v.id === role.id)) {
                if (Math.random() > 0.5) {
                    post.viewers.push({
                        id: role.id,
                        name: role.name,
                        time: Date.now() - Math.floor(Math.random() * 86400000) // 过去24小时内
                    });
                    post.views++;
                    hasChanges = true;

                    // 3. 模拟互动 (看过的人里，有概率点赞/收藏/评论)
                    const rand = Math.random();

                    // 30% 点赞
                    if (rand < 0.3) {
                        if (!post.likesList) post.likesList = []; // 确保字段存在
                        // 避免重复点赞
                        if (!post.likesList.includes(role.id)) {
                            post.likes++;
                            post.likesList.push(role.id);
                            // 添加通知
                            addNotification(post, role, 'like');
                        }
                    }

                    // 10% 收藏
                    if (rand < 0.1) {
                        if (!post.savesList) post.savesList = [];
                        if (!post.savesList.includes(role.id)) {
                            post.savesList.push(role.id);
                            addNotification(post, role, 'save');
                        }
                    }

                    // 15% 评论
                    if (rand > 0.85) {
                        const comments = ["不错！", "好看", "赞", "很有趣", "拍得真好", "这是哪里？", "厉害了"];
                        const text = comments[Math.floor(Math.random() * comments.length)];

                        // 避免每个人都评论，简单防刷
                        const hasCommented = post.commentsList && post.commentsList.some(c => c.user === role.name);
                        if (!hasCommented) {
                            if(!post.commentsList) post.commentsList = [];
                            post.commentsList.push({
                                id: Date.now(),
                                user: role.name, // 注意：这里存的是名字，为了兼容旧逻辑
                                text: text,
                                time: "刚刚"
                            });
                            post.comments++;
                            addNotification(post, role, 'comment', text);
                        }
                    }
                }
            }
        }
    }

    if (hasChanges) {
        saveMomentsData();
        // 如果正在显示列表，刷新一下
        const listEl = document.getElementById('ig-feed-list');
        if (listEl && listEl.innerHTML !== '') renderFeedList();
    }
}

// 辅助：添加一条通知记录
function addNotification(post, role, type, content = '') {
    // 构造通知对象
    const notif = {
        id: Date.now() + Math.random(),
        type: type, // 'like', 'save', 'comment'
        roleId: role.id,
        roleName: role.name,
        postId: post.id,
        postImg: (post.imgKeys && post.imgKeys.length > 0) ? post.imgKeys[0] : null,
        content: content,
        time: Date.now(),
        isRead: false
    };

    // 存入全局通知列表 (单独存储，方便聚合查询)
    let allNotifs = JSON.parse(localStorage.getItem('moments_notifications') || '[]');
    allNotifs.unshift(notif);
    localStorage.setItem('moments_notifications', JSON.stringify(allNotifs));
}

// 在 initMoments 里调用一次
const originalInitMoments = initMoments; // 备份旧的
initMoments = function() {
    simulateSocialActivity(); // 启动模拟
    if(typeof originalInitMoments === 'function') originalInitMoments();
};

// ================== 查看浏览者列表 ==================
async function openPostViewers(index) {
    if (typeof igPostsData === 'undefined' || !igPostsData[index]) return;
    const post = igPostsData[index];
    const viewers = post.viewers || [];

    const container = document.getElementById('viewer-list-container');
    container.innerHTML = '';

    if (viewers.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">暂无浏览记录</div>';
    } else {
        // 按时间倒序
        viewers.sort((a, b) => b.time - a.time);

        for (const v of viewers) {
            let avatarUrl = await getRoleChatAvatarUrl(v.id);
            const div = document.createElement('div');
            div.className = 'user-list-item';
            div.innerHTML = `
                <div class="user-list-avatar" style="background-image:url(${avatarUrl || ''})"></div>
                <div class="user-list-content">
                    <div class="user-list-name">${v.name}</div>
                    <div class="user-list-desc">浏览于 ${formatTimeAgo(v.time)}</div>
                </div>
            `;
            container.appendChild(div);
        }
    }

    openModal('modal-post-viewers');
}

// ================== 互动通知中心 ==================
async function openActivityPage() {
    const container = document.getElementById('activity-list-container');
    container.innerHTML = '';

    const list = JSON.parse(localStorage.getItem('moments_notifications') || '[]');

    if (list.length === 0) {
        container.innerHTML = '<div style="padding:50px; text-align:center; color:#666;">暂无互动消息</div>';
    } else {
        for (const notif of list) {
            let avatarUrl = await getRoleChatAvatarUrl(notif.roleId);

            // 帖子缩略图
            let thumbHtml = '';
            if (notif.postImg) {
                const blob = await dbHelper.get(notif.postImg);
                if (blob) {
                    thumbHtml = `<div class="notification-thumb" style="background-image:url(${URL.createObjectURL(blob)})"></div>`;
                }
            } else {
                // 如果是纯文字帖，显示一个文字图标或空
                thumbHtml = `<div class="notification-thumb" style="background:#333; display:flex; align-items:center; justify-content:center; color:#666; font-size:10px;">文</div>`;
            }

            // 构造文案
            let actionText = '';
            let icon = '';
            if (notif.type === 'like') { actionText = '赞了你的动态'; icon = '❤️'; }
            else if (notif.type === 'save') { actionText = '收藏了你的动态'; icon = '⭐'; }
            else if (notif.type === 'comment') { actionText = `评论: ${notif.content}`; icon = '💬'; }

            const div = document.createElement('div');
            div.className = 'user-list-item';
            div.innerHTML = `
                <div class="user-list-avatar" style="background-image:url(${avatarUrl || ''})"></div>
                <div class="user-list-content">
                    <div class="user-list-name">
                        ${notif.roleName} <span style="font-weight:400; font-size:13px; opacity:0.7;">${actionText}</span>
                    </div>
                    <div class="user-list-desc">${formatTimeAgo(notif.time)}</div>
                </div>
                <div class="user-list-extra">
                    ${thumbHtml}
                </div>
            `;
            container.appendChild(div);
        }
    }

    // ⬇️⬇️⬇️ 修改这一行 ⬇️⬇️⬇️
    // 标记全部已读 (去掉红点)
    const bellBtn = document.getElementById('btn-moment-activity');
    if (bellBtn) {
        bellBtn.classList.remove('has-new');
    }

    openSubPage('sub-moment-activity');
}

// ================== 我的页面：功能菜单逻辑 ==================

function openMyFavorites() {
    // 暂时用 Toast 提示，后续可以做一个专门的列表页
    // 这里可以统计一下收藏数量
    let count = 0;
    igPostsData.forEach(p => { if(p.isSaved) count++; });
    showToast(`你共收藏了 ${count} 条动态 (列表页开发中)`);
}

function openMyLikes() {
    let count = 0;
    igPostsData.forEach(p => { if(p.isLiked) count++; });
    showToast(`你共点赞了 ${count} 条动态 (列表页开发中)`);
}

function openBeautifyCenter() {
    // 直接跳转到现有的“设置 App”或者“主题设置页”
    // 这里我们直接打开【主题设置页】，因为它就是负责美化的
    openSubPage('sub-theme');
}

// ================== 个性美化中心逻辑 (Pro) ==================

let currentBeautifyTab = 'msg'; // 当前编辑的页面: msg, moments, me, global
let beautifyConfig = {
    msg: { css: '', bg: null },
    moments: { css: '', bg: null },
    me: { css: '', bg: null },
    global: { css: '' }
};

// 1. 初始化与打开
async function openBeautifyCenter() {
    // 加载已保存的配置
    const saved = localStorage.getItem('user_beautify_config');
    if (saved) beautifyConfig = JSON.parse(saved);

    // 默认打开消息页 tab
    switchBeautifyTab('msg', document.querySelector('.beautify-tab:first-child'));

    openSubPage('sub-beautify');
}

// 2. 切换 Tab (修复版：移除了未定义的 updateBgPreviewCard)
function switchBeautifyTab(tab, btnEl) {
    currentBeautifyTab = tab;

    // UI 高亮
    document.querySelectorAll('.beautify-tab').forEach(b => b.classList.remove('active'));
    if(btnEl) btnEl.classList.add('active');

    // 加载该页面的 CSS 到输入框
    const inputEl = document.getElementById('css-live-input');
    if (inputEl) {
        inputEl.value = beautifyConfig[tab].css || '';
    }

    // ❌ 删除这行报错的代码： updateBgPreviewCard();
    // 背景预览的更新已经在下面的 renderPreviewStage -> loadPreviewBackground 里处理了

    // 渲染对应的 HTML 预览结构 (这一步会自动调用 loadPreviewBackground 来更新背景)
    renderPreviewStage(tab);

    // 触发一次 CSS 预览渲染
    handleCssInput(beautifyConfig[tab].css || '');
}

// 3. 渲染预览舞台 (核心：生成模拟 HTML)
function renderPreviewStage(tab) {
    const stage = document.getElementById('preview-stage');
    stage.innerHTML = ''; // 清空
    stage.style.backgroundImage = 'none'; // 重置背景

    // 恢复背景图预览
    loadPreviewBackground(tab);

    if (tab === 'msg') {
        // 模拟消息列表页
        stage.innerHTML = `
            <div class="app-header" style="position:absolute; top:0; width:100%; z-index:10;">
                <div class="app-back-btn"><svg style="width:20px;height:20px;fill:white" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg> 主屏幕</div>
                <div class="app-title" style="color:white; font-weight:600;">聊天</div>
                <div class="header-right-group" style="position:absolute; right:15px;">+</div>
            </div>
            <div style="padding-top:60px; padding-left:15px; padding-right:15px;">
                <div class="chat-swipe-wrapper pinned">
                    <div class="chat-main-card" style="background:rgba(255,255,255,0.1); padding:15px; display:flex; align-items:center; border-radius:12px;">
                        <div class="role-card-img" style="width:50px; height:50px; background:#333; border-radius:50%; margin-right:15px; display:flex; align-items:center; justify-content:center;">A</div>
                        <div style="flex:1;">
                            <div class="role-card-name" style="font-weight:600; color:white;">置顶好友</div>
                            <div class="role-card-desc" style="font-size:13px; opacity:0.7;">这是一个置顶会话预览</div>
                        </div>
                    </div>
                </div>
                <div class="chat-swipe-wrapper" style="margin-top:10px;">
                    <div class="chat-main-card" style="background:rgba(255,255,255,0.1); padding:15px; display:flex; align-items:center; border-radius:12px;">
                        <div class="role-card-img" style="width:50px; height:50px; background:#555; border-radius:50%; margin-right:15px; display:flex; align-items:center; justify-content:center;">B</div>
                        <div style="flex:1;">
                            <div class="role-card-name" style="font-weight:600; color:white;">普通好友</div>
                            <div class="role-card-desc" style="font-size:13px; opacity:0.7;">这里显示最后一条消息...</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (tab === 'moments') {
        // 模拟动态页
        stage.innerHTML = `
            <div class="moments-header-bar" style="padding: 20px 16px 10px 16px;">
                <div class="moments-header-title">Moments</div>
                <div class="moments-header-actions">
                    <div class="feed-header-btn"><svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24"><path d="M20 17H22V19H2V17H4V10C4 5.58 7.58 2 12 2s8 3.58 8 8v7z"/></svg></div>
                    <div class="feed-header-btn add-text-btn">+</div>
                </div>
            </div>
            <div class="status-flow-container" style="height:120px; padding:10px 16px;">
                <div class="status-card my-card" style="width:80px; height:100px; background:rgba(255,255,255,0.1); border-radius:12px; display:flex; align-items:center; justify-content:center;">
                    <div class="my-add-btn" style="width:30px; height:30px; font-size:20px;">+</div>
                </div>
            </div>
            <div style="padding:16px;">
                <div class="feed-card" style="background:rgba(255,255,255,0.1); border-radius:18px; padding:15px;">
                    <div class="feed-header" style="display:flex; align-items:center; margin-bottom:10px;">
                        <div style="width:36px; height:36px; background:#444; border-radius:10px; margin-right:10px;"></div>
                        <div><div style="font-weight:600; font-size:14px;">用户名称</div><div style="font-size:10px; opacity:0.6;">刚刚</div></div>
                    </div>
                    <div class="feed-text" style="font-size:14px; margin-bottom:10px;">这是动态内容的预览效果。你可以在这里测试文字颜色、背景等样式。</div>
                    <div style="height:150px; background:#222; border-radius:12px; margin-bottom:10px;"></div>
                </div>
            </div>
        `;
    } else if (tab === 'me') {
        // 模拟我的页面
        stage.innerHTML = `
            <div style="padding: 40px 16px;">
                <div class="group-header">我的名片</div>
                <div style="background:rgba(255,255,255,0.15); border-radius:20px; padding:20px; text-align:center; border:1px solid rgba(255,255,255,0.2);">
                    <div style="width:80px; height:80px; background:#666; border-radius:50%; margin:0 auto 10px auto; border:3px solid white;"></div>
                    <div style="font-size:20px; font-weight:800;">我的昵称</div>
                    <div style="font-size:13px; opacity:0.8; margin-top:5px;">个性签名预览...</div>
                </div>
                <div class="group-header" style="margin-top:30px;">互动与个性化</div>
                <div class="ai-group-card" style="background:rgba(255,255,255,0.08); border-radius:12px; overflow:hidden;">
                    <div class="ai-list-item" style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between;">
                        <span>我的收藏</span><span>›</span>
                    </div>
                    <div class="ai-list-item" style="padding:15px; display:flex; justify-content:space-between;">
                        <span>我的点赞</span><span>›</span>
                    </div>
                </div>
            </div>
        `;
    } else if (tab === 'global') {
        stage.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">全局 CSS 无法预览<br>请保存后在实际页面查看</div>`;
    }
}

// 4. 实时 CSS 注入 (Magic!)
function handleCssInput(css) {
    beautifyConfig[currentBeautifyTab].css = css; // 暂存

    if (currentBeautifyTab === 'global') return; // 全局不预览

    // 核心黑科技：自动给 CSS 加前缀，限制在 #preview-stage 内部
    // 例如：.app-header -> #preview-stage .app-header
    // 简单的正则替换可能不完美，但在这种场景下够用了

    // 技巧：我们不解析 CSS，而是直接创建一个 scoped style (如果是 Shadow DOM)，
    // 但这里为了简单，我们假设用户写的是标准 CSS。
    // 我们用一个极其简陋但有效的方法：把 "}" 替换成 "} #preview-stage "，并在开头加 "#preview-stage "
    // 注意：这只对简单的选择器有效。对于 @media 或 keyframes 会有问题，但作为即时预览够了。

    // 更好的方法：不做替换，直接依靠 CSS Nesting (现代浏览器支持)
    // 或者直接提示用户 "预览仅供参考"

    // 这里我们采用最稳妥的方式：直接注入，但为了防止污染，我们应该尽量让用户写真实的类名
    // 为了实现“只在预览框生效”，我们尝试用 CSS Nesting 写法 (Chrome 80+ 支持)
    // #preview-stage { 用户CSS }

    const scopedCss = `#preview-stage { ${css} }`;
    document.getElementById('preview-sandbox-style').textContent = scopedCss;
}

// 5. 背景上传逻辑
async function loadPreviewBackground(tab) {
    const card = document.getElementById('preview-bg-card');
    const stage = document.getElementById('preview-stage');

    // 优先读取暂存的
    if (beautifyConfig[tab].bg) {
        // 这里只是 blob 引用，不用重新 read
        // 但由于 JSON.stringify 无法存 Blob，我们需要特殊的处理逻辑
        // 实际上，我们应该先去 DB 读
    }

    // 从 DB 读取当前页面的背景
    try {
        const blob = await dbHelper.get(`bg_custom_${tab}`);
        if (blob) {
            const url = URL.createObjectURL(blob);
            card.style.backgroundImage = `url(${url})`;
            stage.style.backgroundImage = `url(${url})`;
        } else {
            card.style.backgroundImage = 'none';
            stage.style.backgroundImage = 'none';
        }
    } catch(e) {
        card.style.backgroundImage = 'none';
    }
}

// 触发上传
function triggerBeautifyBgUpload() {
    document.getElementById('beautify-bg-input').click();
}

// 处理上传背景 (在美化页)
function handleBeautifyBgUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const url = URL.createObjectURL(file);

        // 1. 更新美化页的“小卡片”预览
        document.getElementById('preview-bg-card').style.backgroundImage = `url(${url})`;

        // 2. 更新美化页的“手机模型”预览
        document.getElementById('preview-stage').style.backgroundImage = `url(${url})`;

        // 3. 立即存入数据库 (关键！这样切出去就能看到了)
        if (currentBeautifyTab !== 'global') {
            dbHelper.save(`bg_custom_${currentBeautifyTab}`, file).then(() => {
                showToast("背景已保存");

                // 如果当前正在“聊天App”里，顺便刷新一下真机的背景
                // (判断当前 Tab 是否匹配)
                // 这一步是为了让你保存后，按“返回”能立马看到效果
                const appChat = document.getElementById('app-chat');
                if (appChat.style.display !== 'none') {
                    // 重新触发一次导航切换来加载背景
                    // 这里我们简单处理，直接设背景
                    // 但由于不知道你现在在哪一页，最稳妥的是不操作，等用户切 Tab 自动刷新
                }
            });
        }
    }
}

// 切换 Tab 时加载预览背景 (Helper)
async function loadPreviewBackground(tab) {
    const card = document.getElementById('preview-bg-card');
    const stage = document.getElementById('preview-stage');

    try {
        const blob = await dbHelper.get(`bg_custom_${tab}`);
        if (blob) {
            const url = URL.createObjectURL(blob);
            card.style.backgroundImage = `url(${url})`;
            stage.style.backgroundImage = `url(${url})`;
        } else {
            card.style.backgroundImage = 'none';
            stage.style.backgroundImage = 'none';
        }
    } catch(e) {
        card.style.backgroundImage = 'none';
        stage.style.backgroundImage = 'none';
    }
}

// 恢复默认背景
async function resetCurrentBg() {
    if (currentBeautifyTab === 'global') return;
    await dbHelper.save(`bg_custom_${currentBeautifyTab}`, null);
    loadPreviewBackground(currentBeautifyTab); // 刷新
    showToast("已恢复默认背景");
}

// 应用到所有
async function applyBgToAll() {
    if (currentBeautifyTab === 'global') return;
    try {
        const currentBlob = await dbHelper.get(`bg_custom_${currentBeautifyTab}`);
        if (currentBlob) {
            await dbHelper.save('bg_custom_msg', currentBlob);
            await dbHelper.save('bg_custom_moments', currentBlob);
            await dbHelper.save('bg_custom_me', currentBlob);
            showToast("背景已应用到所有页面");
        } else {
            showToast("当前没有背景图可应用");
        }
    } catch(e) {}
}

// 6. 保存所有设置 (CSS 部分)
function saveAllBeautifySettings() {
    // 保存配置到 LocalStorage
    localStorage.setItem('user_beautify_config', JSON.stringify(beautifyConfig));

    // 立即应用全局 CSS
    applyAllCustomStyles();

    showToast("所有美化设置已保存");
    closeSubPage('sub-beautify');
}

// 7. 应用样式到真实 App (开机启动 + 保存后调用)
async function applyAllCustomStyles() {
    const saved = localStorage.getItem('user_beautify_config');
    const config = saved ? JSON.parse(saved) : {};

    let finalCss = "";

    // 拼接 CSS
    // 注意：我们要利用 CSS 选择器来限定页面
    // 消息页 -> #chat-module-msg
    // 动态页 -> #chat-module-moments
    // 我的页 -> #chat-module-me

    if (config.global && config.global.css) {
        finalCss += `/* Global */ ${config.global.css} \n`;
    }

    // 使用 CSS Nesting 或手动加前缀
    if (config.msg && config.msg.css) {
        finalCss += `#chat-module-msg { ${config.msg.css} } \n`;
    }
    if (config.moments && config.moments.css) {
        finalCss += `#chat-module-moments { ${config.moments.css} } \n`;
    }
    if (config.me && config.me.css) {
        finalCss += `#chat-module-me { ${config.me.css} } \n`;
    }

    // 注入页面
    document.getElementById('user-custom-css-final').textContent = finalCss;

    // --- 应用背景图 ---
    const pages = ['msg', 'moments', 'me'];
    for (const page of pages) {
        try {
            const blob = await dbHelper.get(`bg_custom_${page}`);
            const el = document.getElementById(`chat-module-${page}`);
            if (el) {
                if (blob) {
                    const url = URL.createObjectURL(blob);
                    // 强制覆盖背景
                    el.style.backgroundImage = `url(${url})`;
                    el.style.backgroundSize = 'cover';
                    el.style.backgroundPosition = 'center';
                    // 如果有背景图，可能需要去掉默认的背景色
                    el.style.backgroundColor = 'transparent';
                } else {
                    el.style.backgroundImage = '';
                }
            }
        } catch(e) {}
    }
}

// 启动时加载
applyAllCustomStyles();

// ================== 我的点赞页面逻辑 (Pro版) ==================

async function openMyLikes() {
    const container = document.getElementById('liked-posts-list');
    if (!container) return;

    container.innerHTML = ''; // 清空列表

    // 1. 筛选出已点赞的帖子，并保留原始索引 (关键！)
    // map 加上原始 index，方便点击时跳转到正确的数据
    const likedPosts = igPostsData
        .map((post, index) => ({...post, originalIndex: index}))
        .filter(post => post.isLiked);

    // 2. 空状态处理
    if (likedPosts.length === 0) {
        container.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px; color:#666;">
                <svg style="width:60px; height:60px; fill:#333; margin-bottom:15px;" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <div style="font-size:14px;">还没有点赞过动态</div>
            </div>
        `;
        openSubPage('sub-my-likes');
        return;
    }

    // 3. 准备辅助数据 (角色列表)
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    let myAvatarUrl = await getSafeUrl('userAvatar_main');

    // 4. 循环渲染 (复用 Feed 卡片样式)
    for (const post of likedPosts) {
        let avatarUrl = '';
        let username = '';

        // 获取头像和名字
        if (post.roleId === null) {
            username = localStorage.getItem('userNickname') || '我';
            avatarUrl = myAvatarUrl;
        } else {
            const role = roles.find(r => r.id === post.roleId);
            username = role ? role.name : '未知';
            if (role) {
                avatarUrl = await getRoleChatAvatarUrl(role.id);
            }
        }

        const displayTime = post.time || '刚刚';

        // 处理图片 (从 Key 转 URL)
        let images = [];
        if (post.imgKeys && post.imgKeys.length > 0) {
            for (const key of post.imgKeys) {
                try {
                    const blob = await dbHelper.get(key);
                    if (blob) images.push(URL.createObjectURL(blob));
                } catch(e){}
            }
        } else if (post.img) {
            images = [post.img]; // 兼容旧数据
        }

        // 构建图片 HTML
        let galleryHtml = '';
        if (images.length > 0) {
            // 这里我们只显示第一张图作为封面，或者简单的 1张预览，点击进详情看全图
            // 为了“长得一模一样”，我们直接复用 gallery 结构
            // 注意：这里为了性能，如果是多图，在点赞列表里可以简化显示，但既然要求“一模一样”，我们就完整渲染
            let imgsHtml = images.map(url =>
                `<img class="feed-gallery-item" src="${url}" style="object-fit: cover;">`
            ).join('');

            // 生成唯一ID防止冲突
            const galleryId = `liked-gallery-${post.id}`;
            const counterHtml = images.length > 1 ? `<div class="feed-counter">1/${images.length}</div>` : '';

            galleryHtml = `
                <div style="position:relative; height: 300px; margin-bottom:15px;">
                    <div id="${galleryId}" class="feed-gallery" style="height:100%; pointer-events:none;">
                        ${imgsHtml}
                    </div>
                    ${counterHtml}
                </div>
            `;
        }

        // 构造卡片
        const card = document.createElement('div');
        card.className = 'feed-card';
        // 关键：点击整个卡片跳转到详情页 (使用原始索引)
        card.onclick = () => openMomentDetail(post.originalIndex);

        card.innerHTML = `
            <div class="feed-header">
                <div class="feed-avatar" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : 'background-color:#333'}"></div>
                <div class="feed-user-info">
                    <span class="feed-username">${username}</span>
                    <span class="feed-time">${displayTime}</span>
                </div>
                </div>

            <div class="feed-text">${post.text}</div>
            ${galleryHtml}

            <div class="feed-actions">
                <div class="action-pill active-like">
                    <svg class="action-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    <span>${post.likes}</span>
                </div>
                <div class="action-pill">
                    <svg class="action-icon" viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                    <span>${post.comments}</span>
                </div>
                <div style="font-size:12px; color:rgba(255,255,255,0.3); margin-left:auto; display:flex; align-items:center;">
                    点击查看详情 ›
                </div>
            </div>
        `;

        container.appendChild(card);
    }

    openSubPage('sub-my-likes');
}

// ================== 我的收藏页面逻辑 (完整版) ==================

let currentFavTab = 'moments'; // 默认看动态

// 1. 打开页面
function openMyFavorites() {
    // 重置为动态 Tab
    switchFavTab('moments', document.querySelector('#sub-my-favorites .chat-tab-btn:first-child'));
    openSubPage('sub-my-favorites');
}

// 2. 切换 Tab
function switchFavTab(tab, btn) {
    currentFavTab = tab;
    // UI 高亮
    document.querySelectorAll('#sub-my-favorites .chat-tab-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // 渲染内容
    if (tab === 'moments') {
        renderFavMoments();
    } else {
        renderFavMessages();
    }
}

// 3. 渲染收藏的动态 (逻辑复用)
async function renderFavMoments() {
    const container = document.getElementById('fav-content-area');
    container.innerHTML = '';

    // 筛选已收藏的帖子
    const savedPosts = igPostsData
        .map((post, index) => ({...post, originalIndex: index}))
        .filter(post => post.isSaved);

    if (savedPosts.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#666; padding-top:100px;">暂无收藏的动态</div>`;
        return;
    }

    // 复用之前的渲染逻辑 (这里为了代码复用，我们可以直接调用 renderMyLikes 的内部逻辑，或者简单重写)
    // 为了省事且保持一致，我们手动构造一下，和点赞列表基本一样
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    let myAvatarUrl = await getSafeUrl('userAvatar_main');

    for (const post of savedPosts) {
        let avatarUrl = myAvatarUrl;
        let username = localStorage.getItem('userNickname') || '我';

        if (post.roleId) {
            const role = roles.find(r => r.id === post.roleId);
            if(role) {
                username = role.name;
                avatarUrl = await getRoleChatAvatarUrl(role.id);
            }
        }

        // 处理图片封面
        let coverImg = '';
        if (post.imgKeys && post.imgKeys.length > 0) {
            try { const b = await dbHelper.get(post.imgKeys[0]); if(b) coverImg = URL.createObjectURL(b); } catch(e){}
        } else if (post.img) coverImg = post.img;

        const card = document.createElement('div');
        card.className = 'feed-card';
        card.style.margin = '0 16px 16px 16px'; // 修正边距
        card.onclick = () => openMomentDetail(post.originalIndex); // 点击跳转详情

        let galleryHtml = coverImg ?
            `<div style="height:200px; background-image:url(${coverImg}); background-size:cover; background-position:center; border-radius:12px; margin-bottom:10px;"></div>` : '';

        card.innerHTML = `
            <div class="feed-header">
                <div class="feed-avatar" style="${avatarUrl ? 'background-image:url('+avatarUrl+')' : 'background-color:#333'}"></div>
                <div class="feed-user-info">
                    <span class="feed-username">${username}</span>
                    <span class="feed-time">已收藏</span>
                </div>
            </div>
            <div class="feed-text" style="max-height:60px; overflow:hidden;">${post.text}</div>
            ${galleryHtml}
            <div style="font-size:12px; color:rgba(255,255,255,0.3);">点击查看详情 ›</div>
        `;
        container.appendChild(card);
    }
}

// 4. 渲染收藏的消息 (新功能)
async function renderFavMessages() {
    const container = document.getElementById('fav-content-area');
    container.innerHTML = '';

    const list = JSON.parse(localStorage.getItem('my_favorites_list') || '[]');

    if (list.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#666; padding-top:100px;">暂无收藏的消息</div>`;
        return;
    }

    for (const msg of list) {
        // 获取头像
        let avatarUrl = '';
        if (msg.sender === 'right') {
            avatarUrl = await getSafeUrl('userAvatar_main');
        } else {
            avatarUrl = await getRoleChatAvatarUrl(msg.chatId);
        }

        const div = document.createElement('div');
        div.className = 'fav-msg-card';

        // 点击跳转到对应聊天
        div.onclick = () => jumpToChat(msg.chatId, msg.id, msg.chatName);

        div.innerHTML = `
            <div class="fav-msg-header">
                <div class="fav-msg-source">
                    <div class="fav-msg-avatar" style="${avatarUrl?'background-image:url('+avatarUrl+')':''}"></div>
                    ${msg.chatName}
                </div>
                <div class="fav-btn-del" onclick="event.stopPropagation(); removeFavoriteMsg('${msg.id}')">删除</div>
            </div>
            <div class="fav-msg-body">${msg.text}</div>
            <div class="fav-msg-footer">
                <div class="fav-msg-time">收藏于 ${formatTimeAgo(msg.savedAt)}</div>
            </div>
        `;
        container.appendChild(div);
    }
}

// 5. 删除收藏的消息
function removeFavoriteMsg(msgId) {
    if(confirm("取消收藏这条消息？")) {
        let list = JSON.parse(localStorage.getItem('my_favorites_list') || '[]');
        list = list.filter(m => m.id !== msgId);
        localStorage.setItem('my_favorites_list', JSON.stringify(list));
        renderFavMessages(); // 刷新
        showToast("已取消收藏");
    }
}

// 6. 核心：跳转到聊天并定位 (Jump)
async function jumpToChat(chatId, msgId, chatName) {
    showToast("正在跳转...");

    // 1. 打开聊天详情页 (会触发加载历史记录)
    // 注意：这里我们得先猜一下头像 blob 名，或者重新获取一下
    await openChatDetail(chatId, chatName, `chat_avatar_${chatId}`);

    // 2. 等待 DOM 渲染完成
    setTimeout(() => {
        // 3. 查找该消息的 DOM 节点
        const targetEl = document.getElementById(`msg-node-${msgId}`);
        if (targetEl) {
            // 4. 滚动到该位置
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // 5. 高亮一下，提示用户是这条
            targetEl.style.transition = 'background 0.5s';
            targetEl.style.backgroundColor = 'rgba(10, 132, 255, 0.2)';
            setTimeout(() => { targetEl.style.backgroundColor = 'transparent'; }, 1000);
        } else {
            showToast("原消息可能已被删除");
        }
    }, 500); // 稍微等一下 appendChatBubble 执行完
}

// 启动初始化
initChatAppLoad();

    // ================== 日记 App 逻辑 (交互增强版) ==================

let currentDiaryTab = 'user';
let selectedMood = 'neutral';
let selectedDiaryShareIds = []; // 选中的分享好友ID

// 1. 切换 Tab
function switchDiaryTab(tab) {
    currentDiaryTab = tab;
    document.querySelectorAll('#app-diary .chat-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-diary-${tab}`).classList.add('active');
    document.getElementById('diary-list-user').style.display = tab === 'user' ? 'block' : 'none';
    document.getElementById('diary-list-char').style.display = tab === 'char' ? 'block' : 'none';
    renderDiaryList(tab);
}

// 2. 渲染列表 (带评论互动)
async function renderDiaryList(type) {
    const container = document.getElementById(`diary-list-${type}`);
    if (type === 'char' && (!localStorage.getItem('diary_char_data'))) return;

    const data = JSON.parse(localStorage.getItem(`diary_${type}_data`) || '[]');
    data.sort((a, b) => b.timestamp - a.timestamp); // 倒序

    if (type === 'user' && data.length === 0) {
        container.innerHTML = `<div style="text-align:center;color:#999;margin-top:50px;">点击右上角 + 记录第一篇日记</div>`;
        return;
    }

    let html = '';

    // 预加载所有需要的头像，防止列表闪烁
    // 这里简单处理，直接在循环里生成 promise，实际项目可以优化
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

    for (const item of data) {
        const dateObj = new Date(item.timestamp);
        const dateStr = `${dateObj.getMonth()+1}月${dateObj.getDate()}日`;
        const timeStr = `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
        const moodMap = { 'happy':'😄', 'neutral':'😐', 'sad':'😔', 'angry':'😡', 'love':'🥰' };
        const moodEmoji = moodMap[item.mood] || '😐';

        // 生成评论区 HTML
        let commentsHtml = '';
        if (item.comments && item.comments.length > 0) {
            let rows = '';
            for (const cmt of item.comments) {
                let avatarUrl = await getRoleChatAvatarUrl(cmt.roleId);
                rows += `
                    <div class="diary-comment-row">
                        <div class="d-cmt-avatar" style="background-image:url(${avatarUrl})"></div>
                        <div class="d-cmt-content">
                            <div class="d-cmt-name">${cmt.roleName}</div>
                            ${cmt.text}
                        </div>
                    </div>
                `;
            }
            commentsHtml = `<div class="diary-comments-box">${rows}</div>`;
        }

        // 修改 onclick 为点击删除/管理
        html += `
            <div class="diary-card mood-${item.mood}" onclick="handleDiaryClick('${type}', ${item.id})">
                <div class="diary-dot"></div>
                <div class="diary-header">
                    <div>
                        <span class="diary-date">${dateStr}</span>
                        <span class="diary-time">${timeStr}</span>
                    </div>
                    <div class="diary-mood">${moodEmoji}</div>
                </div>
                <div class="diary-body">${item.content}</div>
                ${commentsHtml}
            </div>
        `;
    }

    container.innerHTML = html;
}

// 3. 打开写日记弹窗 (加载好友)
async function openWriteDiaryModal() {
    if (currentDiaryTab === 'char') {
        showToast("请切换到“我的心事”再写日记");
        return;
    }
    // 重置
    document.getElementById('diary-input-content').value = '';
    selectMood('neutral', document.querySelectorAll('.mood-item')[1]);
    selectedDiaryShareIds = [];

    // 设置日期
    const now = new Date();
    document.getElementById('diary-date-label').textContent = `${now.getMonth()+1}月${now.getDate()}日 · 星期${"日一二三四五六"[now.getDay()]}`;

    // 渲染好友选择器
    const friendList = document.getElementById('diary-friend-selector');
    friendList.innerHTML = '';
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

    if (roles.length === 0) {
        friendList.innerHTML = '<span style="font-size:12px; color:#666;">暂无好友可分享</span>';
    } else {
        for (const role of roles) {
            let avatarUrl = await getRoleChatAvatarUrl(role.id);
            const item = document.createElement('div');
            item.className = 'diary-share-item';
            item.onclick = () => {
                // 切换选中状态
                if (selectedDiaryShareIds.includes(role.id)) {
                    selectedDiaryShareIds = selectedDiaryShareIds.filter(id => id !== role.id);
                    item.classList.remove('selected');
                } else {
                    selectedDiaryShareIds.push(role.id);
                    item.classList.add('selected');
                }
            };
            item.innerHTML = `
                <div class="diary-share-avatar" style="background-image:url(${avatarUrl})"></div>
                <div class="diary-share-name">${role.name}</div>
            `;
            friendList.appendChild(item);
        }
    }

    openModal('modal-write-diary');
}

// 4. 保存日记 (核心：触发互动)
function saveDiaryEntry() {
    const content = document.getElementById('diary-input-content').value.trim();
    if (!content) { showToast("写点什么吧..."); return; }

    const entryId = Date.now();
    const entry = {
        id: entryId,
        timestamp: Date.now(),
        content: content,
        mood: selectedMood,
        comments: [] // 初始化评论区
    };

    // 存入 User 数据
    let list = JSON.parse(localStorage.getItem('diary_user_data') || '[]');
    list.push(entry);
    localStorage.setItem('diary_user_data', JSON.stringify(list));

    closeModal('modal-write-diary');
    renderDiaryList('user');

    // 如果分享了，触发模拟回复
    if (selectedDiaryShareIds.length > 0) {
        showToast("日记已保存，分享给了 " + selectedDiaryShareIds.length + " 位好友");
        triggerDiaryInteractions(entryId, selectedDiaryShareIds, selectedMood, content);
    } else {
        showToast("日记已私密保存 📒");
    }
}

// 5. 触发日记互动 (接入真实 AI 模型)
async function triggerDiaryInteractions(entryId, roleIds, mood, content) {
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    const aiConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');
    const userName = localStorage.getItem('userNickname') || '我';
    const userDesc = localStorage.getItem('userSignature') || '暂无设定';

    // 如果没配置 AI，或者没联网，回退到模拟模式 (防止报错)
    if (!aiConfig.key || !aiConfig.endpoint) {
        console.warn("未配置 AI 模型，使用本地模拟回复");
        fallbackMockReply(entryId, roleIds, mood, content);
        return;
    }

    // 遍历每一个被选中的好友，依次请求 AI
    // 我们使用 for...of 循环配合 await，这样不会瞬间并发太多请求，防止卡顿
    for (const rid of roleIds) {
        const role = roles.find(r => r.id === rid);
        if (!role) continue;

        // 模拟真人的阅读延迟 (3~10秒随机，根据内容长度调整)
        const readDelay = 3000 + (content.length * 50) + (Math.random() * 5000);

        // 这是一个异步过程，不阻塞 UI，让它在后台跑
        setTimeout(async () => {
            try {
                // --- 1. 构建超强 Prompt ---

                // 计算用户字数，决定回复策略
                const userLen = content.length;
                let lengthInstruction = "";

                if (userLen < 15) {
                    lengthInstruction = `用户写的内容很短（约${userLen}字）。你的回复必须在 15~30 字之间。既要简洁，又不能比用户写的少，要表现出你在认真听。`;
                } else if (userLen < 50) {
                    lengthInstruction = `用户写了一段中等长度的心情。请用 40~80 字回复，温暖且有回应。`;
                } else {
                    lengthInstruction = `用户写了一篇长日记。请仔细阅读细节，针对其中的情感点进行深度回复，字数不限，但要充满关怀。`;
                }

                // 语气与心情映射
                const moodMap = {
                    'happy': '用户今天很开心，你要陪TA一起高兴，多用感叹号或庆祝的语气。',
                    'neutral': '用户今天心情平淡，像老朋友一样闲聊，或者给一点小确幸的分享。',
                    'sad': '用户今天很难过。你要给予温柔的安慰，抱抱TA，告诉TA你一直都在。',
                    'angry': '用户今天很生气。你要站在TA这边，帮TA出气，或者温柔地安抚情绪。',
                    'love': '用户今天充满了爱意（可能是恋爱或感动）。你要表现出被甜到了，或者回馈同样的爱意。'
                };

                const systemPrompt = `
【指令】
你正在扮演一个名为"${role.name}"的角色，正在阅读好友"${userName}"的私密日记。
请根据你的人设和用户的日记内容，在日记下方写一条“留言评论”。

【你的身份设定】
${role.desc}

【用户(写日记的人)】
昵称：${userName}
简介：${userDesc}

【当前情境】
1. 这是一条日记的评论区，不是即时聊天。
2. 用户标记的今日心情是：${mood}。
3. ${moodMap[mood] || ''}

【回复要求 - 严格执行】
1. **字数控制**：${lengthInstruction}
2. **语气**：完全代入你的角色设定。如果你的设定是高冷，就别太热情；如果是温柔，就极尽温柔。
3. **内容**：必须紧扣用户日记的内容，不要说通用的客套话。
4. **格式**：直接输出回复内容，不要带引号，不要带"回复："等前缀。
`.trim();

                // --- 2. 发起请求 ---
                let url = aiConfig.endpoint;
                if (url.endsWith('/')) url = url.slice(0, -1);
                if (!url.endsWith('/v1')) url += '/v1';

                const response = await fetch(`${url}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.key}`
                    },
                    body: JSON.stringify({
                        model: aiConfig.model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `我的日记内容：\n${content}` }
                        ],
                        temperature: 0.85, // 温度稍高，让回复更有感情色彩
                        max_tokens: 300
                    })
                });

                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                const aiReply = data.choices[0].message.content.trim();

                // --- 3. 存入数据 ---
                saveCommentToDiary(entryId, role, aiReply);

            } catch (error) {
                console.error("AI Reply Failed:", error);
                // 如果 AI 挂了，用简单的保底回复
                fallbackMockReply(entryId, [role.id], mood, content);
            }
        }, readDelay);
    }
}

// 辅助函数：把评论存进去并刷新 (独立出来方便复用)
function saveCommentToDiary(entryId, role, text) {
    let list = JSON.parse(localStorage.getItem('diary_user_data') || '[]');
    const targetEntry = list.find(e => e.id === entryId);

    if (targetEntry) {
        if (!targetEntry.comments) targetEntry.comments = [];

        targetEntry.comments.push({
            roleId: role.id,
            roleName: role.name,
            text: text,
            time: Date.now()
        });

        localStorage.setItem('diary_user_data', JSON.stringify(list));

        // 如果用户还停留在日记页，刷新列表显示新评论
        if (document.getElementById('app-diary').classList.contains('active') && currentDiaryTab === 'user') {
            renderDiaryList('user');
            // 只有当这是第一条回复时，才弹窗提示，避免刷屏
            if (targetEntry.comments.length === 1) {
                showToast(`${role.name} 回复了你的日记`);
            }
        }
    }
}

// 保底函数：如果 AI 配置不对，用旧的模拟逻辑
function fallbackMockReply(entryId, roleIds, mood, content) {
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

    setTimeout(() => {
        let list = JSON.parse(localStorage.getItem('diary_user_data') || '[]');
        const targetEntry = list.find(e => e.id === entryId);
        if (!targetEntry) return;

        roleIds.forEach(rid => {
            const role = roles.find(r => r.id === rid);
            if (role) {
                let replyText = "抱抱你~";
                if (mood === 'happy') replyText = "真棒！为你开心！🎉";
                if (mood === 'sad') replyText = "别难过，我在呢 ❤️";
                // 简单的字数适配
                if (content.length > 50) replyText += " (摸摸头)";

                if(!targetEntry.comments) targetEntry.comments = [];
                targetEntry.comments.push({
                    roleId: role.id,
                    roleName: role.name,
                    text: replyText,
                    time: Date.now()
                });
            }
        });
        localStorage.setItem('diary_user_data', JSON.stringify(list));
        if (document.getElementById('app-diary').classList.contains('active') && currentDiaryTab === 'user') {
            renderDiaryList('user');
        }
    }, 2000);
}

// 辅助函数保持不变
function selectMood(mood, el) {
    selectedMood = mood;
    document.querySelectorAll('.mood-item').forEach(d => d.classList.remove('active'));
    el.classList.add('active');
}
function handleDiaryClick(type, id) {
    // 复用之前的删除逻辑
    if (type === 'char') return;
    openGenConfirmModal("删除日记", "确定删除吗？", "删除", () => {
        let list = JSON.parse(localStorage.getItem('diary_user_data') || '[]');
        list = list.filter(i => i.id !== id);
        localStorage.setItem('diary_user_data', JSON.stringify(list));
        renderDiaryList('user');
        closeGenConfirmModal();
    });
}

    // ================== AI 角色日记核心逻辑 (Pro Max) ==================

let currentDiaryRoleId = null; // 当前正在看谁的日记

// 1. 修改 Tab 切换逻辑 (接入新的列表渲染)
// 请找到之前的 switchDiaryTab 函数，把 'char' 分支改成这样：
const oldSwitchDiaryTab = switchDiaryTab; // 备份一下防止覆盖报错(如果覆盖了就不用这行)
switchDiaryTab = function(tab) {
    currentDiaryTab = tab;
    document.querySelectorAll('#app-diary .chat-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-diary-${tab}`).classList.add('active');

    document.getElementById('diary-list-user').style.display = 'none';
    document.getElementById('diary-list-char').style.display = 'none';

    if (tab === 'user') {
        document.getElementById('diary-list-user').style.display = 'block';
        renderDiaryList('user');
    } else {
        document.getElementById('diary-list-char').style.display = 'block';
        renderCharListForDiary(); // <--- 关键：渲染好友列表
    }
}

// 2. 渲染好友列表 (点击进入详情)
async function renderCharListForDiary() {
    const container = document.getElementById('diary-list-char');
    container.innerHTML = '';

    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    if (roles.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#666; padding-top:50px;">暂无好友，请先去角色书添加</div>';
        return;
    }

    for (const role of roles) {
        let avatarUrl = await getRoleChatAvatarUrl(role.id);

        // 简单卡片样式
        const div = document.createElement('div');
        div.style.cssText = `
            display:flex; align-items:center; background:rgba(255,255,255,0.08);
            padding:15px; border-radius:16px; margin-bottom:12px; cursor:pointer;
            border:1px solid rgba(255,255,255,0.1); transition: background 0.2s;
        `;
        div.onclick = () => openCharDiaryDetail(role.id);

        div.innerHTML = `
            <div style="width:50px; height:50px; border-radius:50%; background-image:url(${avatarUrl}); background-size:cover; background-position:center; margin-right:15px; border:1px solid rgba(255,255,255,0.2);"></div>
            <div style="flex:1;">
                <div style="font-size:16px; font-weight:600; color:white;">${role.name}</div>
                <div style="font-size:12px; color:rgba(255,255,255,0.5); margin-top:4px;">点击查看日记本 ›</div>
            </div>
        `;
        container.appendChild(div);
    }
}

// 3. 打开详情页
function openCharDiaryDetail(roleId) {
    currentDiaryRoleId = roleId;
    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
    const role = roles.find(r => r.id === roleId);

    document.getElementById('diary-char-title').textContent = `${role.name} 的日记`;
    renderCharDiaryTimeline(roleId);

    openSubPage('sub-diary-char-detail');
}

// 4. 渲染具体日记内容 (修复：删除按钮不重叠)
function renderCharDiaryTimeline(roleId) {
    const container = document.getElementById('diary-char-timeline');
    const data = JSON.parse(localStorage.getItem(`diary_char_${roleId}`) || '[]');

    data.sort((a, b) => b.timestamp - a.timestamp); // 倒序

    if (data.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:rgba(255,255,255,0.3); margin-top:50px;">TA 的日记本是空的<br>点击上方按钮生成第一篇</div>';
        return;
    }

    let html = '';
    data.forEach(item => {
        const dateObj = new Date(item.timestamp);
        const dateStr = `${dateObj.getMonth()+1}月${dateObj.getDate()}日`;
        const timeStr = `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
        const moodEmoji = item.moodEmoji || '📝';

        html += `
            <div class="diary-card" style="border-left: 3px solid #764ba2; position:relative;">
                <div class="diary-dot" style="background:#764ba2; box-shadow:0 0 8px rgba(118,75,162,0.5);"></div>

                <div class="diary-header">
                    <div>
                        <span class="diary-date">${dateStr}</span>
                        <span class="diary-time">${timeStr}</span>
                    </div>

                    <div style="display:flex; align-items:center;">
                        <div class="char-diary-del"
                             style="position:static; margin-right:10px; transform:none;"
                             onclick="deleteCharDiary('${roleId}', ${item.id})">
                             删除
                        </div>
                        <div class="diary-mood">${moodEmoji}</div>
                    </div>
                </div>

                <div class="diary-body" style="font-size:14px; line-height:1.7;">${item.content}</div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// 新增：删除角色生成的日记
function deleteCharDiary(roleId, entryId) {
    if(confirm("确定要删除这条 AI 生成的日记吗？")) {
        let list = JSON.parse(localStorage.getItem(`diary_char_${roleId}`) || '[]');
        list = list.filter(i => i.id !== entryId);
        localStorage.setItem(`diary_char_${roleId}`, JSON.stringify(list));
        renderCharDiaryTimeline(roleId);
        showToast("已删除");
    }
}

// 5. 【核心】开始生成日记 (逻辑修正：只读聊天设置里的世界观)
async function startGeneratingDiary() {
    if (!currentDiaryRoleId) return;

    const btn = document.getElementById('btn-generate-diary');
    const aiConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');

    if (!aiConfig.key) {
        showToast("请先配置 AI 模型 Key");
        return;
    }

    // UI Loading
    btn.disabled = true;
    btn.textContent = "正在构思日记... (约需10-20秒)";
    btn.style.opacity = "0.7";

    try {
        const roleId = currentDiaryRoleId;
        const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');
        const role = roles.find(r => r.id === roleId);

        // 1. 聊天记录
        const chatHistory = await loadChatHistory(roleId);
        const recentChats = chatHistory.slice(-20).map(msg =>
            `${msg.sender === 'right' ? 'User' : role.name}: ${msg.text}`
        ).join('\n');

        // 2. 🚨 修正：读取【聊天设置】里的世界观
        const chatSettings = JSON.parse(localStorage.getItem(`chat_settings_${roleId}`) || '{}');
        const activeWorldTags = chatSettings.worldviews || []; // 获取勾选的标签 ["魔法", "校园"]

        // 读取所有世界书
        const allWorlds = JSON.parse(localStorage.getItem('world_book_data') || '[]');

        // 过滤：只保留聊天设置里有的设定
        let worldContext = "";
        if (activeWorldTags.length > 0) {
            worldContext = allWorlds
                .filter(w => activeWorldTags.includes(w.title))
                .map(w => `[设定- ${w.title}]: ${w.content}`)
                .join('\n\n');
        } else {
            worldContext = "无特殊世界观设定，现代日常背景。";
        }

        // 3. User 信息 (从聊天设置读，如果没有就读全局)
        const userName = chatSettings.userName || localStorage.getItem('userNickname') || 'User';
        const userDesc = chatSettings.userDesc || localStorage.getItem('userSignature') || '';

        // 4. 上一篇日记
        const pastDiaries = JSON.parse(localStorage.getItem(`diary_char_${roleId}`) || '[]');
        const lastDiary = pastDiaries.length > 0 ? pastDiaries[pastDiaries.length - 1].content : "无前文。";

        // --- B. 构建 Prompt ---
        const systemPrompt = `
【任务】
你现在是"${role.name}"。请以第一人称，写一篇你的【私人日记】。

【角色设定】
姓名：${role.name}
人设详情：${role.desc}

【当前生效的世界观】
${worldContext}

【关于 User】
你日记里提到的"TA"或"${userName}"是你的重要他人。
User设定：${userDesc}

【近期经历 (参考聊天记录)】
${recentChats}

【上一篇日记 (保持连贯性)】
${lastDiary}

【写作要求 - 必须严格遵守】
1. **字数限制**：必须在 300 字 ~ 600 字之间。不要太短，要有细节描写。
2. **逻辑一致性**：必须严格遵循【当前生效的世界观】。不要编造不符合设定的魔法或科技。
3. **内容深度**：包含心理活动、对User的看法、对近期发生事情的独特见解。
4. **语气风格**：完全符合你的人设。
5. **格式**：直接输出日记正文，开头第一行用一个Emoji代表心情。
`.trim();

        // --- C. 请求 AI ---
        let url = aiConfig.endpoint;
        if (url.endsWith('/')) url = url.slice(0, -1);
        if (!url.endsWith('/v1')) url += '/v1';

        const response = await fetch(`${url}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.key}`
            },
            body: JSON.stringify({
                model: aiConfig.model,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: "请开始写今天的日记。" }
                ],
                temperature: 0.9,
                max_tokens: 1000
            })
        });

        if (!response.ok) throw new Error("API Error");
        const data = await response.json();
        let content = data.choices[0].message.content.trim();

        // --- D. 解析与保存 ---
        let moodEmoji = '📝';
        const firstLineBreak = content.indexOf('\n');
        if (firstLineBreak > -1 && firstLineBreak < 10) {
            moodEmoji = content.substring(0, firstLineBreak).trim();
            content = content.substring(firstLineBreak).trim();
        }

        const newEntry = {
            id: Date.now(),
            timestamp: Date.now(),
            content: content,
            moodEmoji: moodEmoji
        };

        pastDiaries.push(newEntry);
        localStorage.setItem(`diary_char_${roleId}`, JSON.stringify(pastDiaries));

        renderCharDiaryTimeline(roleId);
        showToast("日记生成完毕");

    } catch (e) {
        console.error(e);
        showToast("生成失败: " + e.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "✨ 偷看 TA 今天的心事 ";
        btn.style.opacity = "1";
    }
}

    // ================== 钱包 App 核心逻辑 (高级版) ==================

let currentBalance = parseFloat(localStorage.getItem('wallet_balance') || '8848.00'); // 给个吉利的初始值
const currencySymbol = '¥'; // 换成人民币或者 $

// 1. 初始化和渲染主界面
function renderWalletMain() {
    const container = document.getElementById('wallet-main-content');
    if (!container) return;

    // 格式化余额 (每3位加逗号)
    const formattedBalance = currentBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // 读取最近3条记录
    let history = JSON.parse(localStorage.getItem('wallet_history') || '[]');
    let recentHistoryHTML = '';

    if (history.length === 0) {
        recentHistoryHTML = '<div style="text-align:center; color:rgba(255,255,255,0.3); font-size:13px; margin-top:20px;">暂无交易记录</div>';
    } else {
        recentHistoryHTML = history.slice(0, 3).map(item => getTransItemHTML(item)).join('');
    }

    container.innerHTML = `
        <div class="wallet-card-premium">
            <div class="card-layer">
                <div class="card-chip"></div>

                <div>
                    <div class="card-balance-label">Total Balance</div>
                    <div class="card-balance-value">${currencySymbol} ${formattedBalance}</div>
                </div>

                <div class="card-number-mask">•••• •••• •••• 8848</div>
            </div>
        </div>

        <div class="wallet-quick-actions">
            <div class="w-action-item" onclick="openWalletSubpage('sub-wallet-recharge')">
                <div class="w-icon-circle add">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </div>
                <span class="w-action-text">充值</span>
            </div>

            <div class="w-action-item" onclick="showToast('提现功能维护中')">
                <div class="w-icon-circle">
                    <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
                </div>
                <span class="w-action-text">转账</span>
            </div>

            <div class="w-action-item" onclick="showToast('账单功能开发中')">
                <div class="w-icon-circle">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.89 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                </div>
                <span class="w-action-text">账单</span>
            </div>

            <div class="w-action-item" onclick="openWalletSubpage('sub-wallet-history')">
                <div class="w-icon-circle">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                </div>
                <span class="w-action-text">明细</span>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:0 5px;">
            <span style="font-size:16px; font-weight:600; color:white;">最近交易</span>
            <span style="font-size:12px; color:rgba(255,255,255,0.5); cursor:pointer;" onclick="openWalletSubpage('sub-wallet-history')">查看全部 ›</span>
        </div>

        <div class="trans-list">
            ${recentHistoryHTML}
        </div>
    `;
}

// 辅助：生成单条记录 HTML
function getTransItemHTML(item) {
    const isPlus = item.type === '充值';
    const colorClass = isPlus ? 'plus' : 'minus'; // minus 留给支出
    const sign = isPlus ? '+' : '-';

    // 图标判断
    let iconSvg = '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>'; // 默认
    if (isPlus) iconSvg = '<path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.59 5.58L20 12l-8-8-8 8z"/>'; // 向上箭头

    return `
        <div class="trans-item">
            <div class="trans-left">
                <div class="trans-icon-box">
                    <svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24">${iconSvg}</svg>
                </div>
                <div>
                    <div class="trans-title">${item.type}</div>
                    <div class="trans-date">${item.time}</div>
                </div>
            </div>
            <div class="trans-amount ${colorClass}">${sign}${currencySymbol}${item.amount.toFixed(2)}</div>
        </div>
    `;
}

// 2. 充值页面渲染 (填数字的核心功能)
function renderRechargePage() {
    const page = document.getElementById('sub-wallet-recharge');
    page.innerHTML = `
        <div class="app-header" style="background:inherit; border-bottom:none;">
            <div class="app-back-btn" onclick="closeSubPage('sub-wallet-recharge')">取消</div>
            <div class="app-title">余额充值</div>
        </div>

        <div class="wallpaper-content" style="padding: 20px;">
            <div style="text-align:center; margin-top:20px;">
                <div style="font-size:14px; opacity:0.6; margin-bottom:5px;">存入金额</div>

                <div class="recharge-input-wrapper">
                    <span class="money-symbol">${currencySymbol}</span>
                    <input type="number" id="recharge-input-real" placeholder="0.00">
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="ai-btn ai-btn-secondary" onclick="setRechargeAmount(100)">100</button>
                <button class="ai-btn ai-btn-secondary" onclick="setRechargeAmount(500)">500</button>
                <button class="ai-btn ai-btn-secondary" onclick="setRechargeAmount(1000)">1000</button>
            </div>

            <button class="ai-btn ai-btn-primary"
                    onclick="confirmRecharge()"
                    style="margin-top: 40px; background: #34C759; box-shadow: 0 5px 20px rgba(52, 199, 89, 0.3);">
                确认充值
            </button>
        </div>
    `;
}

// 辅助：设置快捷金额
function setRechargeAmount(val) {
    document.getElementById('recharge-input-real').value = val;
}

// 3. 确认充值
function confirmRecharge() {
    const input = document.getElementById('recharge-input-real');
    const amount = parseFloat(input.value);

    if (isNaN(amount) || amount <= 0) {
        showToast("请输入有效金额");
        return;
    }

    currentBalance += amount;
    localStorage.setItem('wallet_balance', currentBalance.toFixed(2));

    // 记录历史
    let history = JSON.parse(localStorage.getItem('wallet_history') || '[]');
    history.unshift({
        type: '充值',
        amount: amount,
        time: new Date().toLocaleString()
    });
    localStorage.setItem('wallet_history', JSON.stringify(history));

    renderWalletMain();
    closeSubPage('sub-wallet-recharge');
    showToast(`成功充值 ${currencySymbol}${amount}`);
}

// 4. 全部记录页
function renderHistoryPage() {
    const page = document.getElementById('sub-wallet-history');
    let history = JSON.parse(localStorage.getItem('wallet_history') || '[]');

    const listHTML = history.length > 0
        ? history.map(item => getTransItemHTML(item)).join('')
        : '<div style="text-align:center; color:#666; padding-top:100px;">暂无记录</div>';

    page.innerHTML = `
        <div class="app-header" style="background:inherit; border-bottom:1px solid rgba(255,255,255,0.1);">
            <div class="app-back-btn" onclick="closeSubPage('sub-wallet-history')">返回</div>
            <div class="app-title">交易明细</div>
        </div>
        <div class="wallpaper-content" style="padding: 0;">
            <div class="trans-list" style="padding-top:10px;">
                ${listHTML}
            </div>
        </div>
    `;
}

    // ================== 🚨 补全缺失的钱包跳转函数 🚨 ==================

function openWalletSubpage(id) {
    const page = document.getElementById(id);
    if (page) {
        // 1. 根据 ID 刷新对应页面的内容
        if (id === 'sub-wallet-recharge') {
            renderRechargePage(); // 刷新充值页
        }
        else if (id === 'sub-wallet-history') {
            renderHistoryPage();  // 刷新记录页
        }

        // 2. 打开页面 (滑入动画)
        // 强制设置 display flex 确保内容可见，然后再加 active 类触发动画
        page.style.display = 'flex';
        setTimeout(() => {
            page.classList.add('active');
        }, 10);
    } else {
        console.error("找不到子页面:", id);
        showToast("页面未找到");
    }
}

// 确保页面加载时渲染一次钱包主页，防止黑屏
document.addEventListener('DOMContentLoaded', () => {
    if(typeof renderWalletMain === 'function') renderWalletMain();
});

    // ================== 购物 App 逻辑 ==================

// 1. 模拟商品数据
const shopData = [
    { id: 1, type: 'digital', name: '全息投影仪', desc: '桌面级 3D 显示设备', price: 2999.00, img: 'https://images.unsplash.com/photo-1535303311164-664fc9ec6532?auto=format&fit=crop&w=600&q=80' },
    { id: 2, type: 'digital', name: '量子耳机', desc: '降噪效果提升 200%', price: 1299.00, img: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?auto=format&fit=crop&w=600&q=80' },
    { id: 3, type: 'food', name: '能量饮料', desc: '恢复 50 点体力', price: 15.00, img: 'https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=600&q=80' },
    { id: 4, type: 'food', name: '深夜拉面', desc: '抚慰心灵的美食', price: 48.00, img: 'https://images.unsplash.com/photo-1569718212165-3a8278d5f624?auto=format&fit=crop&w=600&q=80' },
    { id: 5, type: 'gift', name: '机械玫瑰', desc: '送给仿生人的礼物', price: 520.00, img: 'https://images.unsplash.com/photo-1559563362-c667ba5f5480?auto=format&fit=crop&w=600&q=80' },
    { id: 6, type: 'virtual', name: 'SVIP 月卡', desc: '解锁所有高级功能', price: 30.00, img: 'https://images.unsplash.com/photo-1611162617474-5b21e879e113?auto=format&fit=crop&w=600&q=80' },
    { id: 7, type: 'fashion', name: '赛博夹克', desc: '夜之城限定款', price: 888.00, img: 'https://images.unsplash.com/photo-1551028919-ac7edd05b6ea?auto=format&fit=crop&w=600&q=80' }
];

let currentShopFilter = 'all';
let pendingItem = null; // 待支付的商品

// 2. 初始化与渲染
function initShop() {
    renderShopGrid();
    updateShopBalanceDisplay();
}

// 刷新右上角的余额显示
function updateShopBalanceDisplay() {
    const bal = parseFloat(localStorage.getItem('wallet_balance') || '0');
    document.getElementById('shop-balance-display').textContent = `¥${bal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
}

// 渲染商品列表
function renderShopGrid() {
    const container = document.getElementById('shop-grid-container');
    container.innerHTML = '';

    const list = currentShopFilter === 'all'
        ? shopData
        : shopData.filter(item => item.type === currentShopFilter);

    list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shop-item-card';
        div.onclick = () => openBuyModal(item);

        div.innerHTML = `
            <div class="shop-img-box" style="background-image:url(${item.img})"></div>
            <div class="shop-info-box">
                <div class="shop-title">${item.name}</div>
                <div class="shop-desc">${item.desc}</div>
                <div class="shop-price-row">
                    <div class="shop-price">¥${item.price}</div>
                    <div class="shop-buy-btn">+</div>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

// 3. 筛选功能
function filterShop(type, btn) {
    currentShopFilter = type;
    document.querySelectorAll('.shop-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderShopGrid();
}

// 4. 购买流程
function openBuyModal(item) {
    pendingItem = item;

    document.getElementById('buy-confirm-title').textContent = item.name;
    document.getElementById('buy-confirm-price').textContent = `¥${item.price.toFixed(2)}`;
    document.getElementById('buy-confirm-img').style.backgroundImage = `url(${item.img})`;

    const modal = document.getElementById('modal-buy-confirm');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}

function closeBuyModal() {
    const modal = document.getElementById('modal-buy-confirm');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
    pendingItem = null;
}

// 核心：确认支付
function confirmPurchase() {
    if (!pendingItem) return;

    // 1. 获取钱包余额
    let balance = parseFloat(localStorage.getItem('wallet_balance') || '0');

    // 2. 检查余额
    if (balance >= pendingItem.price) {
        // --- 支付成功逻辑 ---

        // 扣款
        balance -= pendingItem.price;
        localStorage.setItem('wallet_balance', balance.toFixed(2));

        // 写入交易记录 (调用 Wallet App 的逻辑，或者直接操作 storage)
        let history = JSON.parse(localStorage.getItem('wallet_history') || '[]');
        history.unshift({
            id: Date.now(),
            type: '消费', // 类型
            amount: -pendingItem.price, // 负数代表支出
            status: `购买 ${pendingItem.name}`,
            time: new Date().toLocaleString()
        });
        localStorage.setItem('wallet_history', JSON.stringify(history));

        // 刷新 UI
        updateShopBalanceDisplay();
        showToast("✅ 支付成功，商品已发货");
        closeBuyModal();

        // 刷新钱包主页 (如果它在后台开着)
        if(typeof renderWalletMain === 'function') renderWalletMain();

    } else {
        // --- 余额不足 ---
        showToast("❌ 余额不足，请去钱包充值");
        // 还可以做一个抖动动画提示
    }
}

// 初始化
initShop();

    // ================== 备忘录 App 逻辑 ==================

let currentMemoId = null; // 当前编辑的笔记ID (null表示新建)

// 1. 初始化与渲染列表
function initMemo() {
    renderMemoList();
}

function renderMemoList() {
    const container = document.getElementById('memo-list-container');
    const searchVal = document.getElementById('memo-search').value.toLowerCase().trim();
    if (!container) return;

    // 读取数据
    let memos = JSON.parse(localStorage.getItem('memo_data') || '[]');

    // 排序：按时间倒序 (新的在前面)
    memos.sort((a, b) => b.time - a.time);

    // 过滤
    if (searchVal) {
        memos = memos.filter(m => m.content.toLowerCase().includes(searchVal));
    }

    container.innerHTML = '';

    if (memos.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#666; padding-top:100px;">${searchVal ? '未找到笔记' : '暂无笔记<br>点击右上角 + 新建'}</div>`;
        return;
    }

    memos.forEach(memo => {
        // 智能提取标题：第一行
        const lines = memo.content.split('\n');
        const title = lines[0] || '无标题';
        const preview = lines.slice(1).join(' ') || '无附加文本';
        const dateStr = new Date(memo.time).toLocaleString('zh-CN', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});

        const div = document.createElement('div');
        div.className = 'memo-card';
        div.onclick = () => openEditMemo(memo.id);

        div.innerHTML = `
            <div class="memo-card-title">${title}</div>
            <div class="memo-card-preview">${preview}</div>
            <div class="memo-card-date">${dateStr}</div>
        `;
        container.appendChild(div);
    });
}

// 2. 打开编辑页
function openEditMemo(id = null) {
    currentMemoId = id;
    const textarea = document.getElementById('memo-textarea');
    const timeLabel = document.getElementById('memo-edit-time');

    if (id) {
        // 编辑已有
        const memos = JSON.parse(localStorage.getItem('memo_data') || '[]');
        const target = memos.find(m => m.id === id);
        if (target) {
            textarea.value = target.content;
            timeLabel.textContent = "上次编辑: " + new Date(target.time).toLocaleString();
        }
    } else {
        // 新建
        textarea.value = '';
        timeLabel.textContent = "新笔记";
    }

    openSubPage('sub-memo-edit');
}

// 3. 保存并关闭
function saveAndCloseMemo() {
    const content = document.getElementById('memo-textarea').value.trim();

    let memos = JSON.parse(localStorage.getItem('memo_data') || '[]');

    if (content) {
        if (currentMemoId) {
            // 更新旧的
            const index = memos.findIndex(m => m.id === currentMemoId);
            if (index > -1) {
                memos[index].content = content;
                memos[index].time = Date.now();
            }
        } else {
            // 创建新的
            memos.push({
                id: Date.now(),
                content: content,
                time: Date.now()
            });
        }
        localStorage.setItem('memo_data', JSON.stringify(memos));
    } else {
        // 如果内容为空且是旧笔记，询问是否删除？这里简单处理：不保存空笔记
        // 也可以选择如果不写字就直接忽略
    }

    renderMemoList(); // 刷新列表
    closeSubPage('sub-memo-edit');
}

// 4. 删除当前笔记
function deleteCurrentMemo() {
    if (!currentMemoId) {
        // 如果是新建状态还没保存，直接关掉
        closeSubPage('sub-memo-edit');
        return;
    }

    openGenConfirmModal(
        "删除笔记",
        "确定要删除这条笔记吗？",
        "删除",
        () => {
            let memos = JSON.parse(localStorage.getItem('memo_data') || '[]');
            memos = memos.filter(m => m.id !== currentMemoId);
            localStorage.setItem('memo_data', JSON.stringify(memos));

            renderMemoList();
            closeSubPage('sub-memo-edit');
            showToast("已删除");
            closeGenConfirmModal();
        }
    );
}

// 初始化
initMemo();

    // ================== 电话 App 逻辑 ==================

let currentPhoneTab = 'keypad';
let currentPhoneNumber = '';

// 1. 启动初始化
function initPhoneApp() {
    switchPhoneTab('keypad'); // 默认进拨号
}

// 2. 底部导航切换 (核心：控制头部返回按钮)
function switchPhoneTab(tab, btn) {
    currentPhoneTab = tab;

    // UI高亮
    if(btn) {
        document.querySelectorAll('#app-phone .chat-nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
    }

    // 切换内容
    document.querySelectorAll('.phone-view').forEach(el => el.style.display = 'none');
    document.getElementById(`phone-view-${tab}`).style.display = (tab === 'keypad' || tab === 'contacts') ? 'flex' : 'block';

    // 🚨 核心需求：只有 Keypad 显示返回按钮，其他隐藏
    const backBtn = document.getElementById('phone-back-btn');
    const title = document.getElementById('phone-app-title');

    if (tab === 'keypad') {
        backBtn.style.display = 'flex';
        title.textContent = "拨号";
    } else if (tab === 'recents') {
        backBtn.style.display = 'none'; // 隐藏
        title.textContent = "通话记录";
        renderRecentsList();
    } else if (tab === 'contacts') {
        backBtn.style.display = 'none'; // 隐藏
        title.textContent = "通讯录";
        // 默认显示列表
        switchContactSubTab('list', document.querySelector('#app-phone .chat-tab-btn:first-child'));
    }
}

// 3. 拨号盘逻辑
function phonePress(key) {
    if (currentPhoneNumber.length < 15) {
        currentPhoneNumber += key;
        updatePhoneDisplay();
    }
}

function phoneDeleteNumber() {
    currentPhoneNumber = currentPhoneNumber.slice(0, -1);
    updatePhoneDisplay();
}

function updatePhoneDisplay() {
    const display = document.getElementById('phone-number-display');
    const backspace = document.querySelector('.phone-backspace');
    display.value = currentPhoneNumber;

    if (currentPhoneNumber.length > 0) backspace.classList.add('show');
    else backspace.classList.remove('show');
}

// 4. 模拟拨打
function makePhoneCall(number = null, name = null, avatar = null) {
    const targetNum = number || currentPhoneNumber;
    if (!targetNum) return;

    // 打开呼叫弹窗
    const modal = document.getElementById('modal-calling');
    document.getElementById('calling-name').textContent = name || targetNum;
    document.getElementById('calling-status').textContent = "正在呼叫...";

    // 头像处理
    const avatarEl = document.getElementById('calling-avatar');
    if (avatar) {
        avatarEl.style.backgroundImage = `url(${avatar})`;
    } else {
        avatarEl.style.backgroundImage = 'none'; // 默认灰底
    }

    modal.style.display = 'flex';
    setTimeout(()=>modal.classList.add('active'), 10);

    // 记录历史
    addRecentCall(name || targetNum, 'outgoing');
}

function endPhoneCall() {
    const modal = document.getElementById('modal-calling');
    modal.classList.remove('active');
    setTimeout(()=>modal.style.display='none', 300);
}

// 5. 记录通话历史
function addRecentCall(name, type) {
    let recents = JSON.parse(localStorage.getItem('phone_recents') || '[]');
    recents.unshift({
        id: Date.now(),
        name: name,
        type: type, // 'outgoing', 'missed', 'incoming'
        time: new Date().toLocaleString(),
        label: '手机'
    });
    localStorage.setItem('phone_recents', JSON.stringify(recents));
}

function renderRecentsList() {
    const container = document.getElementById('phone-recents-list');
    const recents = JSON.parse(localStorage.getItem('phone_recents') || '[]');

    if (recents.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#666; padding-top:50px;">无通话记录</div>';
        return;
    }

    container.innerHTML = recents.map(r => `
        <div class="recent-call-item" onclick="makePhoneCall('${r.name}', '${r.name}')">
            <div class="call-info-left">
                <!-- 图标判断 -->
                <svg class="call-type-icon ${r.type === 'missed' ? 'missed' : ''}" viewBox="0 0 24 24">
                    ${r.type === 'outgoing'
                        ? '<path d="M9 5v2h6.59L4 18.59 5.41 20 17 8.41V15h2V5z"/>' // 箭头右上
                        : '<path d="M19 13h-2V9H9.36L20 19.64 18.64 21 8 10.36V15H6V5h10z"/>' // 箭头左下(模拟进来)
                    }
                </svg>
                <div>
                    <div class="call-name ${r.type === 'missed' ? 'missed' : ''}">${r.name}</div>
                    <div class="call-label">${r.label}</div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="call-time">${r.time.split(' ')[1]}</div>
                <div class="call-info-btn">i</div>
            </div>
        </div>
    `).join('');
}

// 6. 联系人子页面切换
function switchContactSubTab(subTab, btn) {
    document.querySelectorAll('#app-phone .chat-tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    document.getElementById('phone-sub-list').style.display = subTab === 'list' ? 'block' : 'none';
    document.getElementById('phone-sub-sms').style.display = subTab === 'sms' ? 'block' : 'none';

    if (subTab === 'list') renderPhoneContacts();
    else renderPhoneSMS();
}

// 渲染联系人 (读取角色书)
async function renderPhoneContacts() {
    const container = document.getElementById('phone-sub-list');
    container.innerHTML = '';

    const roles = JSON.parse(localStorage.getItem('role_list_meta') || '[]');

    // 按首字母排序(略)，这里简单遍历
    for (const role of roles) {
        let avatarUrl = await getRoleChatAvatarUrl(role.id);

        const div = document.createElement('div');
        div.className = 'recent-call-item'; // 复用样式
        div.onclick = () => makePhoneCall('10086', role.name, avatarUrl); // 模拟拨打

        div.innerHTML = `
            <div class="call-info-left">
                <div style="width:40px; height:40px; border-radius:50%; background-image:url(${avatarUrl}); background-size:cover; background-position:center; background-color:#333;"></div>
                <div class="call-name" style="font-size:16px;">${role.name}</div>
            </div>
            <div class="call-info-btn" style="border:none;">📞</div>
        `;
        container.appendChild(div);
    }
}

// 渲染模拟短信
function renderPhoneSMS() {
    const container = document.getElementById('phone-sub-sms');
    // 模拟数据
    const smsData = [
        { sender: "运营商", text: "【流量提醒】您本月流量已使用 80%...", time: "昨天" },
        { sender: "快递", text: "您的包裹已放入丰巢柜，取件码 8848...", time: "10:30" }
    ];

    container.innerHTML = smsData.map(sms => `
        <div class="sms-item" onclick="showToast('短信详情功能开发中')">
            <div class="sms-header">
                <span class="sms-sender">${sms.sender}</span>
                <span class="sms-time">${sms.time}</span>
            </div>
            <div class="sms-preview">${sms.text}</div>
        </div>
    `).join('');
}

// --- 处理聊天图片上传 ---
async function handleChatPhotoUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        // 1. 生成唯一ID
        const msgId = Date.now().toString();
        
        // 2. 保存图片文件到 IndexedDB (防止刷新后丢失)
        const imgKey = `msg_img_${msgId}`;
        try {
            await dbHelper.save(imgKey, file);
            
            // 3. 生成预览 URL
            const imgUrl = URL.createObjectURL(file);
            
            // 4. 构建图片 HTML 代码
            const imgHtml = `<img src="${imgUrl}" class="chat-content-image">`;

            // 5. 立即上屏显示
            appendChatBubble('right', imgHtml, true, msgId);

            // 6. 存入历史记录
            // 注意：我们额外存一个 imgKey 字段，方便下次加载时读取
            const history = await loadChatHistory(currentChatId);
            history.push({
                id: msgId,
                sender: 'right',
                text: '[图片]',   // 列表预览时显示的文字
                htmlContent: imgHtml, // 实际显示的 HTML
                imgKey: imgKey,   // 数据库里的图片索引
                timestamp: Date.now()
            });
            await saveChatHistory(currentChatId, history);

            // 更新外部列表的预览文字
            updateChatLastMessage(currentChatId, '[图片]');

        } catch (e) {
            console.error("图片发送失败", e);
            showToast("图片保存失败");
        }

        input.value = ''; // 清空选择，以便下次能选同一张图
    }
}

// --- 发送语音消息 (修复版：动态长度) ---
async function sendVoiceMessage(text) {
    // 1. 强制关闭弹窗
    closeGenInputModal();

    if (!text) return;
    
    // 2. 核心算法：
    // 时长：每3个字1秒，最少2秒，最多60秒
    const duration = Math.min(60, Math.max(2, Math.floor(text.length / 3)));
    
    // 宽度：基础宽度 70px + 每秒增加 6px，最大不超过 240px
    // 这样短语音短，长语音长
    const calcWidth = 70 + (duration * 6); 
    const finalWidth = Math.min(calcWidth, 240); 

    const msgId = Date.now().toString();

    // 3. 构建语音条 HTML (注意看 style="width: ${finalWidth}px")
    const voiceHtml = `
        <div class="voice-wrapper" onclick="toggleVoiceContent(event, this)">
            <div class="voice-bubble-container" style="width: ${finalWidth}px; justify-content: space-between;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div class="voice-icon-play"></div>
                    <div class="voice-wave-box">
                        <div class="voice-bar"></div><div class="voice-bar"></div>
                        <div class="voice-bar"></div><div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                    </div>
                </div>
                <div class="voice-duration-text">${duration}"</div>
            </div>
            <div class="voice-real-text" style="display:none;">${text}</div>
        </div>
    `;

    // 4. 立即上屏
    appendChatBubble('right', voiceHtml, true, msgId);

    // 5. 存入数据库
    const history = await loadChatHistory(currentChatId);
    history.push({
        id: msgId,
        sender: 'right',
        text: '[语音]',
        htmlContent: voiceHtml,
        rawText: text,
        timestamp: Date.now()
    });
    await saveChatHistory(currentChatId, history);

    // 6. 更新列表预览
    updateChatLastMessage(currentChatId, '[语音]');
}

// ================== 修复：通用输入弹窗逻辑 ==================

// 1. 【补全缺失的函数】关闭输入弹窗
function closeGenInputModal() {
    const modal = document.getElementById('modal-general-input');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    }
}

// 2. 确保打开函数也存在 (防止其他地方报错)
function openGenInputModal(title, label, placeholder, callback) {
    document.getElementById('gen-input-title').textContent = title;
    document.getElementById('gen-input-label').textContent = label;
    
    const input = document.getElementById('gen-input-field');
    input.value = '';
    input.placeholder = placeholder;

    // 将回调函数挂载到 window 对象上，确保全局可访问
    window.currentGenInputCallback = callback;

    const modal = document.getElementById('modal-general-input');
    modal.style.display = 'flex';
    modal.style.zIndex = '3000'; // 确保在最上层
    setTimeout(() => modal.classList.add('active'), 10);
    
    input.focus();
}

// 3. 重新绑定确认按钮的点击事件 (确保能触发回调和关闭)
const genConfirmBtn = document.getElementById('gen-input-confirm-btn');
if (genConfirmBtn) {
    genConfirmBtn.onclick = function() {
        const val = document.getElementById('gen-input-field').value.trim();
        
        // 如果有回调函数，执行它 (把输入文字传回去)
        if (typeof window.currentGenInputCallback === 'function') {
            window.currentGenInputCallback(val);
        }
        
        // 关窗
        closeGenInputModal();
    };
}

// ================== AI 连发助手 (逻辑修复版：优先识别指令) ==================
async function processAIReplies(replies, index) {
    if (index >= replies.length) return;

    let content = replies[index].trim();
    if (!content) {
        processAIReplies(replies, index + 1);
        return;
    }

    const msgId = Date.now().toString() + "_" + index;
    
    // --- 1. 正则匹配所有指令 ---
    const locMatch = content.match(/<LOC>(.*?)<\/LOC>/i);
    const moneyMatch = content.match(/<MONEY>(.*?)<\/MONEY>/i);
    const stickerMatch = content.match(/<STICKER:(sticker_\d+)>/i);
    const voiceMatch = content.match(/<VOICE>(.*?)<\/VOICE>/i);

    // 🆕 新增：匹配心声
    const mindMatch = content.match(/<MIND>(.*?)<\/MIND>/s); // s模式允许换行

    let textForHistory = content; // 用于存入历史记录的预览文本

    // --- 2. 优先处理特殊指令 (if ... else if ...) ---

    // 🆕 处理心声 (提取并保存，然后从正文中删掉)
    if (mindMatch) {
        const mindText = mindMatch[1].trim();
        // 存入当前会话的“最新心声”缓存
        localStorage.setItem(`latest_mind_${currentChatId}`, mindText);
        
        // 从回复内容中剔除，不让用户在气泡里看到
        content = content.replace(mindMatch[0], '').trim();
    }

    // ➤ 情况 A: 命中位置 (Location) - 修复版
    if (locMatch) {
        const [name, addr] = locMatch[1].split('|');
        const extra = { 
            isLocation: true, 
            name: name || '未知地点', 
            address: addr || '信号屏蔽区' 
        };
        
        // 1. 上屏
        appendChatBubble('left', '', true, msgId, null, extra);
        
        // 2. 存历史 (🔴 必须带上 extraOptions 才能持久化)
        const history = await loadChatHistory(currentChatId);
        history.push({ 
            id: msgId, 
            sender: 'left', 
            text: '[位置]', 
            timestamp: Date.now(), 
            extraOptions: extra // 👈 加上这句就修好了！
        });
        await saveChatHistory(currentChatId, history);
        
        updateChatLastMessage(currentChatId, '[位置]');
        
        // 移除指令
        content = content.replace(locMatch[0], '').trim();
    }

    // ➤ 情况 B: AI 发转账 (Money) - 🔴 提到前面来！
    else if (moneyMatch) {
        const [amt, desc] = moneyMatch[1].split('|');
        const amount = amt || '88';
        const text = desc || '转账';
        
        // 构造数据
        const extra = { 
            isTransfer: true, 
            amount: amount, 
            desc: text,
            isReceived: false 
        };
        
        // 生成 HTML 用于上屏 (不存入 extraOptions，由 appendChatBubble 生成)
        // 但为了保险，我们让 appendChatBubble 根据 extra 自动生成
        appendChatBubble('left', '', true, msgId, null, extra);
        
        // 存历史
        const history = await loadChatHistory(currentChatId);
        history.push({ 
            id: msgId, 
            sender: 'left', 
            text: `[转账] ¥${amount}`, 
            timestamp: Date.now(),
            extraOptions: extra // 关键：存入 extra
        });
        await saveChatHistory(currentChatId, history);

        content = content.replace(moneyMatch[0], '').trim();
    }

    // ➤ 情况 C: AI 发表情
    else if (stickerMatch) {
        const stickerId = stickerMatch[1];
        // 调用发送函数 (内部已包含上屏和存历史)
        await sendStickerMessage(stickerId, 'left');
        content = content.replace(stickerMatch[0], '').trim();
    }

    // ➤ 情况 D: AI 发语音
    else if (voiceMatch) {
        const voiceText = voiceMatch[1]; 
        const duration = Math.min(60, Math.max(2, Math.floor(voiceText.length / 3)));
        const finalWidth = Math.min(70 + (duration * 6), 240);
        
        const voiceHtml = `
            <div class="voice-wrapper" onclick="toggleVoiceContent(event, this)">
                <div class="voice-bubble-container" style="width: ${finalWidth}px; justify-content: space-between;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div class="voice-icon-play"></div>
                        <div class="voice-wave-box">
                            <div class="voice-bar"></div><div class="voice-bar"></div>
                            <div class="voice-bar"></div><div class="voice-bar"></div>
                        </div>
                    </div>
                    <div class="voice-duration-text">${duration}"</div>
                </div>
                <div class="voice-real-text" style="display:none;">${voiceText}</div>
            </div>
        `;

        appendChatBubble('left', voiceHtml, true, msgId);

        const history = await loadChatHistory(currentChatId);
        history.push({
            id: msgId, 
            sender: 'left', 
            text: '[语音]', 
            htmlContent: voiceHtml, 
            rawText: voiceText, 
            timestamp: Date.now()
        });
        await saveChatHistory(currentChatId, history);

        content = content.replace(voiceMatch[0], '').trim();
    }

    // --- 3. 最后处理普通文字 (保底) ---
    // 只有当 content 里还有剩余文本时才执行
    if (content && content.length > 0) {
        appendChatBubble('left', content, true, msgId);

        const history = await loadChatHistory(currentChatId);
        history.push({
            id: msgId, 
            sender: 'left', 
            text: content, 
            timestamp: Date.now()
        });
        await saveChatHistory(currentChatId, history);
        
        updateChatLastMessage(currentChatId, content);
    }
    
    // 递归处理下一条
    const delay = 1000 + Math.random() * 1000;
    setTimeout(() => {
        processAIReplies(replies, index + 1);
    }, Math.min(delay, 3000));
}

// 辅助：存历史的简写函数 (避免重复代码)
async function saveMsgToHistory(id, sender, text, extra = null) {
    const history = await loadChatHistory(currentChatId);
    history.push({
        id: id,
        sender: sender,
        text: text,
        timestamp: Date.now(),
        extraOptions: extra // 👈 关键：把 extra 存进去！
    });
    await saveChatHistory(currentChatId, history);
    updateChatLastMessage(currentChatId, text);
}
// --- 语音条交互逻辑 (核心修复：解决点击报错) ---
// 必须挂载到 window 上，HTML 中的 onclick 才能找到它
window.toggleVoiceContent = function(event, wrapper) {
    // 1. 如果用户点击的是【文字区域】
    // 我们不阻止冒泡，让它触发外层 .chat-msg 的 onclick (从而打开删除/撤回菜单)
    if (event.target.classList.contains('voice-real-text')) {
        return; 
    }

    // 2. 如果用户点击的是【语音条区域】
    // 阻止冒泡，防止误触菜单。只执行播放动画和展开/收起
    event.stopPropagation(); 

    const textBox = wrapper.querySelector('.voice-real-text');
    const container = wrapper.querySelector('.voice-bubble-container');

    // 切换播放状态
    if (container.classList.contains('voice-playing')) {
        // 停止播放，收起文字
        container.classList.remove('voice-playing');
        textBox.style.display = 'none'; 
    } else {
        // 开始播放，展开文字
        container.classList.add('voice-playing');
        textBox.style.display = 'block'; 
        
        // 3秒后自动停止动画 (模拟播放结束)，但保留文字显示方便阅读
        setTimeout(() => {
            if(container.classList.contains('voice-playing')) {
                container.classList.remove('voice-playing');
            }
        }, 3000);
    }
};

// ================== 表情包修复逻辑 ==================

// 1. 开关面板
function toggleStickerPanel() {
    console.log("尝试切换表情面板...");
    const panel = document.getElementById('custom-sticker-panel');
    const menu = document.getElementById('chat-input-menu');

    if (!panel) {
        alert("错误：找不到 id='custom-sticker-panel' 的元素，请检查 HTML 位置！");
        return;
    }

    // 如果药丸菜单开着，先关掉
    if (menu && menu.classList.contains('active')) {
        toggleInputMenu();
    }

    // 切换显示状态 (直接操作 style.display 最稳)
    if (panel.style.display === 'flex') {
        panel.style.display = 'none';
    } else {
        panel.style.display = 'flex';
        renderStickerGrid(); // 刷新列表
    }
}

// 2. 渲染表情列表 (最终修复：强制隔离发送和选中动作)
// 注意：isStickerMultiSelect, selectedStickerIds 必须在外部定义
async function renderStickerGrid() {
    const container = document.getElementById('sticker-grid-view');
    if(!container) return;

    // 清空内容并保留第一个加号按钮 (保持不变)
    container.innerHTML = `
        <div class="sticker-item add-btn" onclick="document.getElementById('sticker-file-input').click()" style="border: 2px dashed rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center;">
            <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:rgba(255,255,255,0.5)"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </div>
    `;
    
    // 更新面板的模式类名和按钮样式
    const panel = document.getElementById('custom-sticker-panel');
    panel.classList.toggle('multi-select-mode', isStickerMultiSelect);
    const delBtn = document.getElementById('btn-sticker-delete-mode');
    delBtn.classList.toggle('active', isStickerMultiSelect);

    const stickers = JSON.parse(localStorage.getItem('user_stickers_list') || '[]');

    for (const stickerId of stickers) {
        try {
            const blob = await dbHelper.get(stickerId);
            if (blob) {
                const url = URL.createObjectURL(blob);
                const div = document.createElement('div');
                // 检查是否已选中，添加选中类名
                div.className = `sticker-item ${selectedStickerIds.has(stickerId) ? 'selected' : ''}`;
                div.style.backgroundImage = `url(${url})`;
                
                // --- 🚨 核心修复：点击事件隔离 🚨 ---
                div.onclick = (e) => {
                    e.stopPropagation();
                    if (isStickerMultiSelect) {
                        toggleStickerSelection(stickerId, div); // 多选模式：选中/取消选中
                    } else {
                        sendStickerMessage(stickerId); // 单选模式：发送
                    }
                };

                // 🚨 移除长按/右键菜单 (防止电脑端冲突) 🚨
                div.oncontextmenu = (e) => {
                    e.preventDefault(); // 阻止浏览器右键菜单
                    toggleStickerMultiSelect(); // 长按也进入多选模式
                };

                // 添加选中框
                const checkbox = document.createElement('div');
                checkbox.className = 'sticker-checkbox';
                div.appendChild(checkbox);

                container.appendChild(div);
            }
        } catch (e) { console.error(e); }
    }
}
// 3. 上传图片
async function handleStickerUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const stickerId = `sticker_${Date.now()}`;
        
        await dbHelper.save(stickerId, file);
        
        let list = JSON.parse(localStorage.getItem('user_stickers_list') || '[]');
        list.push(stickerId);
        localStorage.setItem('user_stickers_list', JSON.stringify(list));
        
        renderStickerGrid(); // 刷新
        input.value = '';
    }
}

// 4. 发送表情 (最终版：允许 AI 指定 senderSide 为 'left')
async function sendStickerMessage(stickerId, senderSide = 'right') {
    // 关闭面板
    const panel = document.getElementById('custom-sticker-panel');
    if(panel && senderSide === 'right') panel.style.display = 'none'; // 只有用户自己发时才关面板

    const blob = await dbHelper.get(stickerId);
    if (!blob) return;

    const msgId = Date.now().toString();
    const msgImgKey = `msg_img_${msgId}`;
    
    // 保存图片数据
    await dbHelper.save(msgImgKey, blob);

    const imgUrl = URL.createObjectURL(blob);

    // 🚨 核心修复：将发送方 side 设为变量 senderSide 🚨
    appendChatBubble(senderSide, '', true, msgId, null, {
        isSticker: true, 
        imgUrl: imgUrl
    });

    // 存入历史记录
    const history = await loadChatHistory(currentChatId);
    history.push({
        id: msgId,
        sender: senderSide, // 🚨 关键：存入正确的发送方
        text: '[表情]',
        isSticker: true,
        imgKey: msgImgKey,
        timestamp: Date.now()
    });
    await saveChatHistory(currentChatId, history);
    
    updateChatLastMessage(currentChatId, '[表情]');
}
// ================== ⚠️ 必须重新覆盖这个主菜单函数 ⚠️ ==================
// 请确保这段代码覆盖了之前那个报错的 handleMenuAction
function handleMenuAction(action) {
    toggleInputMenu(); // 收起底部药丸菜单

    if (action === 'photo') {
        document.getElementById('chat-photo-input').click();
    } 
    else if (action === 'voice') {
         openGenInputModal(
            "发送语音", "请输入内容", "说点什么...", 
            (text) => sendVoiceMessage(text)
        );
    }
    // 👇 关键：这里调用我们刚写的 toggleStickerPanel
    else if (action === 'emoji') {
        toggleStickerPanel();
    }
    // 👆
    // 👇👇👇【这里改了！】把原来的 showToast 改成调用 startVideoCall 👇👇👇
    else if (action === 'video') {
         // 检查 startVideoCall 是否已定义
         if (typeof startVideoCall === 'function') {
             startVideoCall(); 
         } else {
             alert("错误：视频通话功能代码(startVideoCall)未找到，请检查是否已粘贴上一轮的 JS 代码！");
         }
    }
    // 👇👇👇 修改这里：连接到新的位置选择页面 👇👇👇
    else if (action === 'location') {
        // 检查函数是否存在，防止报错
        if (typeof openLocationPicker === 'function') {
            openLocationPicker(); 
        } else {
            alert("错误：请确保你已经复制了上一条回复里的 JS 代码 (openLocationPicker函数)！");
        }
    }
    else if (action === 'money') {
        openMoneyModal(); 
    }
    else if (action === 'heart') {
        openHeartModal(); // 👈 改成这个
    }
    else if (action === 'shop') openApp('app-shop');
    else if (action === 'gift') showToast("礼物功能开发中...");
    else if (action === 'game') showToast("游戏中心开发中...");
    else if (action === 'phone') openApp('app-phone');
    else showToast(`功能 [${action}] 开发中...`);
}

// 6. 切换多选模式 (最终版：确保模式切换和删除按钮联动)

function toggleStickerMultiSelect() {
    isStickerMultiSelect = !isStickerMultiSelect;
    
    // 如果进入多选模式，清空之前的选中项
    if (isStickerMultiSelect) {
        selectedStickerIds.clear();
        showToast("已进入多选删除模式，点击表情选择");
        
        // 关键：设置垃圾桶按钮的点击事件为执行删除 (确认按钮)
        document.getElementById('btn-sticker-delete-mode').onclick = confirmBatchStickerDelete; 

    } else {
        showToast("已退出多选模式");
        
        // 恢复垃圾桶按钮的点击事件为切换模式 (让下次点击继续切换)
        document.getElementById('btn-sticker-delete-mode').onclick = toggleStickerMultiSelect; 
    }

    renderStickerGrid(); // 刷新 UI 状态
}
// 7. 切换表情的选中状态
function toggleStickerSelection(id, el) {
    if (selectedStickerIds.has(id)) {
        selectedStickerIds.delete(id);
        el.classList.remove('selected');
    } else {
        selectedStickerIds.add(id);
        el.classList.add('selected');
    }
    
    // 更新垃圾桶图标的提示
    const delBtn = document.getElementById('btn-sticker-delete-mode');
    delBtn.title = `删除选中 (${selectedStickerIds.size} 项)`;
}

// 8. 确认批量删除
async function confirmBatchStickerDelete() {
    if (selectedStickerIds.size === 0) {
        showToast("请先选择要删除的表情");
        return;
    }

    openGenConfirmModal(
        "批量删除表情",
        `确定要删除选中的 <span style="color:#FF3B30; font-weight:bold;">${selectedStickerIds.size}</span> 个表情包吗？`,
        "确认删除",
        async () => {
            let list = JSON.parse(localStorage.getItem('user_stickers_list') || '[]');
            
            // 批量删除数据库中的文件，并从列表中移除
            selectedStickerIds.forEach(async (id) => {
                try { await dbHelper.save(id, null); } catch(e){}
                list = list.filter(item => item !== id);
            });
            
            localStorage.setItem('user_stickers_list', JSON.stringify(list));
            
            toggleStickerMultiSelect(); // 退出多选模式
            renderStickerGrid(); // 刷新列表
            showToast(`成功删除了 ${selectedStickerIds.size} 个表情`);
        }
    );
}


// ================== 视频通话逻辑 (最终版：持久化背景+计时器+历史记录) ==================

let videoCallTimer = null;
let callDurationTimer = null; // 通话时长计时器
let callSeconds = 0;

// 1. 发起视频通话
async function startVideoCall() {
    if (!currentChatId) { showToast("请先进入一个聊天窗口"); return; }

    const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');
    const charName = settings.charName || document.getElementById('chat-detail-name').textContent || "对方";
    
    // UI 初始化
    document.getElementById('video-call-name').textContent = charName;
    
    // 加载头像
    let avatarUrl = '';
    try {
        const blob = await dbHelper.get(`chat_avatar_${currentChatId}`);
        if(blob) avatarUrl = URL.createObjectURL(blob);
    } catch(e){}

    const avatarEl = document.getElementById('video-call-avatar');
    if(avatarUrl) avatarEl.style.backgroundImage = `url(${avatarUrl})`;
    else avatarEl.style.backgroundImage = 'none';

    // 清空聊天层
    document.getElementById('video-chat-overlay-container').innerHTML = '';
    
    // 重置计时器 UI
    document.getElementById('video-timer-display').textContent = "00:00";
    document.getElementById('video-timer-display').style.display = 'none'; // 接通前隐藏

    // 加载本地用户照片
    loadLocalUserImage(); 

    // 🔴 核心：加载持久化的背景视频 🔴
    loadPersistentVideoBg();

    // 重置状态
    document.getElementById('video-call-overlay').classList.remove('connected');
    document.getElementById('video-call-status').textContent = "正在等待对方接受邀请...";
    document.getElementById('video-chat-input-bar').classList.add('hidden');

    openSubPage('sub-video-call');

    // 3秒后自动接通
    if (videoCallTimer) clearTimeout(videoCallTimer);
    videoCallTimer = setTimeout(connectVideoCall, 3000);
}

// 2. 接通
function connectVideoCall() {
    document.getElementById('video-call-overlay').classList.add('connected');
    showToast("通话已接通");
    
    // 显示并启动计时器
    document.getElementById('video-timer-display').style.display = 'block';
    startCallTimer();

    const remoteVideo = document.getElementById('video-remote-player');
    if (remoteVideo.style.display !== 'none') remoteVideo.play().catch(e=>{});
}

// 3. 挂断
function endVideoCall() {
    if (videoCallTimer) clearTimeout(videoCallTimer);
    stopCallTimer();

    closeSubPage('sub-video-call');
    
    const remoteVideo = document.getElementById('video-remote-player');
    remoteVideo.pause();

    // 在主聊天界面添加系统消息
    const msgId = Date.now().toString();
    const durationStr = formatDuration(callSeconds);
    appendChatBubble('system', `视频通话已结束，时长 ${durationStr}`, true, msgId);
    
    loadChatHistory(currentChatId).then(history => {
        history.push({
            id: msgId, sender: 'system', text: `视频通话已结束，时长 ${durationStr}`, timestamp: Date.now()
        });
        saveChatHistory(currentChatId, history);
    });
}

// --- 计时器逻辑 ---
function startCallTimer() {
    callSeconds = 0;
    if (callDurationTimer) clearInterval(callDurationTimer);
    callDurationTimer = setInterval(() => {
        callSeconds++;
        document.getElementById('video-timer-display').textContent = formatDuration(callSeconds);
    }, 1000);
}

function stopCallTimer() {
    if (callDurationTimer) clearInterval(callDurationTimer);
    callDurationTimer = null;
}

function formatDuration(sec) {
    const m = Math.floor(sec / 60).toString().padStart(2, '0');
    const s = (sec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}

// --- 背景视频持久化 ---
function triggerRemoteVideoUpload() { document.getElementById('input-remote-video').click(); }

async function handleRemoteVideoUpload(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        // 1. 存入数据库
        await dbHelper.save(`video_bg_${currentChatId}`, file);
        // 2. 应用
        applyVideoBg(file);
        showToast("背景已更换并保存");
    }
}

// 修复版：加载持久化背景
async function loadPersistentVideoBg() {
    const aurora = document.querySelector('.aurora-bg.full');
    const videoEl = document.getElementById('video-remote-player');
    
    // 还没进聊天就别加载
    if (!currentChatId) return;

    try {
        console.log("正在加载视频背景，ChatID:", currentChatId);
        // 从数据库读取
        const blob = await dbHelper.get(`video_bg_${currentChatId}`);
        
        if (blob) {
            console.log("找到背景视频，正在应用...");
            const url = URL.createObjectURL(blob);
            
            if(videoEl) {
                videoEl.src = url;
                videoEl.style.display = 'block';
                videoEl.play().catch(e => console.error("自动播放失败(需交互):", e));
            }
            if(aurora) aurora.style.display = 'none';
        } else {
            console.log("未找到背景视频，使用默认极光");
            // 没存过，恢复默认极光
            if(videoEl) {
                videoEl.style.display = 'none';
                videoEl.src = "";
            }
            if(aurora) aurora.style.display = 'block';
        }
    } catch(e) {
        console.error("加载视频背景失败:", e);
        // 出错也恢复默认
        if(aurora) aurora.style.display = 'block';
    }
}

function applyVideoBg(blob) {
    const url = URL.createObjectURL(blob);
    const videoEl = document.getElementById('video-remote-player');
    const aurora = document.querySelector('.aurora-bg.full');
    
    videoEl.src = url;
    videoEl.style.display = 'block';
    aurora.style.display = 'none';
    
    // 如果已经接通，立即播放
    if (document.getElementById('video-call-overlay').classList.contains('connected')) {
        videoEl.play();
    }
}

// --- 视频内聊天 & 历史记录 ---

function toggleVideoChatInput() {
    const bar = document.getElementById('video-chat-input-bar');
    bar.classList.toggle('hidden');
    if (!bar.classList.contains('hidden')) document.getElementById('video-chat-input').focus();
}

function sendVideoChatMessage() {
    const input = document.getElementById('video-chat-input');
    const text = input.value.trim();
    if (!text) return;

    // A. 上屏
    addVideoBubble('right', text);
    // B. 🔴 存入视频通话记录
    saveVideoChatLog('me', text);

    input.value = '';
    document.getElementById('video-chat-input-bar').classList.add('hidden');

    // C. 触发 AI
    fetchSimpleAIReply(text).then(reply => {
        if (reply) {
            addVideoBubble('left', reply);
            saveVideoChatLog('ai', reply); // 存入记录
        }
    });
}

function addVideoBubble(side, text) {
    const container = document.getElementById('video-chat-overlay-container');
    if (!container) return;

    const div = document.createElement('div');
    const bgStyle = side === 'right' 
        ? 'background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); align-self: flex-end; border-bottom-right-radius: 4px;' 
        : 'background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px;';
    
    div.style.cssText = `
        ${bgStyle}
        padding: 8px 12px; border-radius: 16px; color: white; font-size: 14px;
        max-width: 80%; backdrop-filter: blur(5px); pointer-events: auto;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-bottom: 4px;
    `;
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// --- 历史记录查看逻辑 ---

// 保存单条记录
function saveVideoChatLog(sender, text) {
    const key = `video_log_${currentChatId}`;
    let logs = JSON.parse(localStorage.getItem(key) || '[]');
    
    logs.push({
        sender: sender, // 'me' or 'ai'
        text: text,
        time: new Date().toLocaleString()
    });
    
    localStorage.setItem(key, JSON.stringify(logs));
}

// 打开记录页
function openVideoHistoryLog() {
    if(!currentChatId) return;
    
    const container = document.getElementById('video-history-list');
    const key = `video_log_${currentChatId}`;
    const logs = JSON.parse(localStorage.getItem(key) || '[]');
    
    const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');
    const charName = settings.charName || "对方";

    container.innerHTML = '';
    
    if (logs.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">暂无视频通话内的对话记录</div>';
    } else {
        // 倒序显示（新的在上面）
        [...logs].reverse().forEach(log => {
            const roleLabel = log.sender === 'me' 
                ? `<span class="v-log-me">我:</span>` 
                : `<span class="v-log-role">${charName}:</span>`;
            
            const div = document.createElement('div');
            div.className = 'video-log-item';
            div.innerHTML = `
                <div class="v-log-header">
                    <span>${log.time}</span>
                </div>
                <div class="v-log-content">
                    ${roleLabel} ${log.text}
                </div>
            `;
            container.appendChild(div);
        });
    }
    
    openSubPage('sub-video-history-log');
}

function clearVideoHistory() {
    if(confirm("清空视频对话记录？")) {
        localStorage.removeItem(`video_log_${currentChatId}`);
        openVideoHistoryLog(); // 刷新
        showToast("已清空");
    }
}

// 本地照片加载逻辑 (复用之前的)
async function loadLocalUserImage() {
    const localImgBox = document.getElementById('video-local-image-bg');
    try {
        const callPhoto = await dbHelper.get('video_call_local_photo');
        if (callPhoto) {
             localImgBox.style.backgroundImage = `url(${URL.createObjectURL(callPhoto)})`;
             return;
        }
        const avatar = await dbHelper.get('userAvatar_main');
        if (avatar) localImgBox.style.backgroundImage = `url(${URL.createObjectURL(avatar)})`;
    } catch(e) {}
}
function triggerLocalPhotoUpload() { document.getElementById('input-local-photo').click(); }
function handleLocalPhotoUpload(input) {
    if (input.files && input.files[0]) {
        dbHelper.save('video_call_local_photo', input.files[0]).then(() => {
            loadLocalUserImage(); showToast("形象已更新");
        });
    }
}

// 复用 fetchSimpleAIReply 
async function fetchSimpleAIReply(userText) {
    // ... (保持你现有的 fetchSimpleAIReply 逻辑不变，或者复制上一轮的) ...
    // 为了节省篇幅，这里不重复写，请确保代码里有这个函数
    const aiConfig = JSON.parse(localStorage.getItem('ai_active_config') || '{}');
    if (!aiConfig.key) return "（点头微笑）"; 
    try {
        let url = aiConfig.endpoint;
        if (url.endsWith('/')) url = url.slice(0, -1);
        if (!url.endsWith('/v1')) url += '/v1';
        const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');
        const charName = settings.charName || "对方";
        const response = await fetch(`${url}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.key}` },
            body: JSON.stringify({
                model: aiConfig.model,
                messages: [
                    { role: "system", content: `你正在和用户进行视频通话。请用非常简短、口语化的句子回复。扮演：${charName}。字数限制：20字以内。` },
                    { role: "user", content: userText }
                ],
                max_tokens: 60
            })
        });
        const data = await response.json();
        return data.choices[0].message.content.trim();
    } catch (e) { console.error(e); return null; }
}

// ================== 📍 赛博地理位置系统 (终极修正版) ==================

// 1. 纯虚构赛博地点库 (移除所有现实地名)
const cyberPOIs = [
    { name: "当前定位: 第七区 · 2077号街", address: "Sector 7, Night City Blvd 2077", type: "me" },
    { name: "星际咖啡 (Starbase Coffee)", address: "中央枢纽区 - 3层甲板", type: "place" },
    { name: "量子数据中心 (Quantum Data)", address: "北区 / 核心机房路 101号", type: "work" },
    { name: "赛博夜市 (Neon Market)", address: "下城区 / 旧货街 4号入口", type: "life" },
    { name: "全息艺术馆 (Holo Gallery)", address: "云端大道 / 虚拟现实中心", type: "art" },
    { name: "地下中转站 (Metro Station)", address: "B2层 / 快速轨道连接点", type: "trans" },
    { name: "天际线公寓 (Skyline Apt)", address: "上城区 / 观景台 88楼", type: "home" },
    { name: "荒坂塔 (Arasaka Tower)", address: "企业广场 / 绝对控制区", type: "corp" },
    { name: "义体维修站 (Ripperdoc)", address: "瓦森区 / 阴暗小巷 12号", type: "med" }
];

// 当前列表状态 (支持搜索)
let currentDisplayPOIs = [...cyberPOIs];
let selectedLocIndex = 0; // 当前选中的索引

// 2. 打开位置选择器
window.openLocationPicker = function() {
    // 重置搜索
    const searchInput = document.getElementById('location-search-input');
    if(searchInput) searchInput.value = '';
    
    // 重置列表数据
    currentDisplayPOIs = [...cyberPOIs];
    
    // 渲染 UI
    renderPickerMapHTML(false); // 渲染地图 HTML
    renderPickerList();         // 渲染列表
    
    openSubPage('sub-location-picker');
    
    // 默认选中第一项 (当前位置)
    selectLocation(0);
};

// 3. 搜索功能 (本地过滤)
window.handleLocationSearch = function(text) {
    text = text.trim();
    if (!text) {
        currentDisplayPOIs = [...cyberPOIs];
    } else {
        // 搜索逻辑：保留匹配项，并允许自定义“搜索结果”
        const matches = cyberPOIs.filter(p => p.name.includes(text) || p.address.includes(text));
        // 如果想把用户的输入也当作一个临时地点：
        currentDisplayPOIs = [
            { name: text, address: "搜索结果 · 自定义坐标", type: "search" },
            ...matches
        ];
    }
    selectedLocIndex = 0; // 重置选中
    renderPickerList();
    selectLocation(0);
};

// 4. 渲染地点列表
function renderPickerList() {
    const container = document.getElementById('poi-list');
    if (!container) return;
    container.innerHTML = '';

    currentDisplayPOIs.forEach((poi, index) => {
        const div = document.createElement('div');
        div.className = 'poi-item';
        div.id = `picker-item-${index}`;
        div.onclick = () => selectLocation(index);

        // 根据类型分配图标
        let iconStr = '📍';
        if (poi.type === 'me') iconStr = '💠';
        if (poi.type === 'place') iconStr = '☕';
        if (poi.type === 'work') iconStr = '🏢';
        if (poi.type === 'life') iconStr = '🛍️';

        div.innerHTML = `
            <div class="poi-icon">${iconStr}</div>
            <div class="poi-info">
                <div class="poi-name">${poi.name}</div>
                <div class="poi-addr">${poi.address}</div>
            </div>
        `;
        container.appendChild(div);
    });
}

// 5. 选中逻辑 (联动地图)
window.selectLocation = function(index) {
    if (!currentDisplayPOIs[index]) return;
    
    selectedLocIndex = index;
    const poi = currentDisplayPOIs[index];

    // A. 列表高亮
    document.querySelectorAll('.poi-item').forEach(el => el.classList.remove('selected'));
    const item = document.getElementById(`picker-item-${index}`);
    if(item) item.classList.add('selected');

    // B. 地图联动 (核心视觉)
    const pinLabel = document.getElementById('picker-pin-label');
    if(pinLabel) {
        // 如果是第一项(当前位置)，显示 YOU，否则显示地名
        pinLabel.textContent = (poi.type === 'me') ? 'YOU' : 'TARGET';
        pinLabel.style.color = (poi.type === 'me') ? '#34C759' : '#FF3B30';
    }

    // 切换地图中心点的颜色
    const pinHead = document.querySelector('.cyber-pin-center .pin-head');
    if(pinHead) {
        if (poi.type === 'me') pinHead.classList.remove('red');
        else pinHead.classList.add('red');
    }

    // 模拟地图移动效果 (随机偏移背景网格)
    const grid = document.querySelector('.cyber-grid-floor');
    if(grid) {
        grid.style.backgroundPosition = `${Math.random() * 50}px ${Math.random() * 50}px`;
    }
};

// 6. 确认发送 (修复数据源 Bug)
window.confirmSendLocation = function() {
    // 🚨 核心修复：从 currentDisplayPOIs 获取数据，而不是原始列表
    // 这样搜索后的结果也能正确发送
    const poi = currentDisplayPOIs[selectedLocIndex];
    
    if (!poi) {
        showToast("请选择一个有效位置");
        return;
    }

    const msgId = Date.now().toString();
    
    // 构造数据
    const extra = {
        isLocation: true,
        name: poi.name,
        address: poi.address
    };

    // 上屏
    if (typeof appendChatBubble === 'function') {
        appendChatBubble('right', '', true, msgId, null, extra);
    }

    // 存入历史
    if (typeof loadChatHistory === 'function' && typeof currentChatId !== 'undefined') {
        loadChatHistory(currentChatId).then(history => {
            history.push({
                id: msgId,
                sender: 'right',
                text: '[位置]',
                timestamp: Date.now(),
                extraOptions: extra
            });
            saveChatHistory(currentChatId, history);
            updateChatLastMessage(currentChatId, '[位置]');
        });
    }

    closeSubPage('sub-location-picker');
    showToast("位置已发送");
};

// 7. 查看位置详情
window.viewLocation = function(e, encodedData) {
    if(e) e.stopPropagation();
    if(typeof isMultiSelectMode !== 'undefined' && isMultiSelectMode) return;

    try {
        const data = JSON.parse(decodeURIComponent(encodedData));
        
        // 填充文字
        document.getElementById('viewer-loc-name').textContent = data.name;
        document.getElementById('viewer-loc-addr').textContent = data.address;
        
        // 渲染全屏地图
        renderPickerMapHTML(true); 

        openSubPage('sub-location-viewer');
    } catch(err) {
        console.error(err);
    }
};

// 8. 动态注入地图 HTML (共用渲染器)
function renderPickerMapHTML(isViewer) {
    // 根据是“选择页”还是“查看页”决定注入到哪里
    const containerSelector = isViewer ? 
        '#sub-location-viewer .map-container-placeholder' : 
        '#sub-location-picker .cyber-map-visual';
        
    const container = document.querySelector(containerSelector);
    if (!container) return;

    // 不同的样式类
    const pinClass = isViewer ? 'red' : '';
    const labelText = isViewer ? 'TARGET' : 'YOU';
    const radarStyle = isViewer ? 'width:600px; height:600px; opacity:0.8;' : '';

    container.innerHTML = `
        <div class="cyber-grid-floor"></div>
        
        <div class="cyber-radar-ring" style="${radarStyle}"></div>
        
        <div class="cyber-deco"></div>

        <div class="cyber-scan-line"></div>

        <div class="cyber-labels" style="pointer-events:none;">
            <div class="map-label-item" style="top:20%; left:10%;">SECTOR 09</div>
            <div class="map-label-item" style="bottom:30%; right:10%;">DATA: OK</div>
            <div class="map-label-item" style="top:15%; right:20%;">GPS: LOCK</div>
        </div>

        <div class="cyber-pin-center">
            <div class="pin-head ${pinClass}"></div>
            <div class="pin-pulse ${pinClass}"></div>
            <div class="pin-tooltip" id="${isViewer ? 'viewer-pin-label' : 'picker-pin-label'}">
                ${labelText}
            </div>
        </div>
    `;
}

// ================== 💰 赛博转账系统 ==================

// 1. 打开转账输入框 (点击 Money 菜单触发)
function openMoneyModal() {
    // 复用之前的通用输入框，稍微改下配置
    openGenInputModal(
        "转账金额", 
        "请输入转账数额 (Credits)", 
        "888", 
        (amount) => {
            // 验证输入是否为数字
            if (isNaN(amount) || amount <= 0) {
                showToast("请输入有效的数字");
                return;
            }
            sendMoneyMessage(amount, "转账");
        }
    );
    // 小技巧：把输入框类型临时改成 number，方便手机输入
    const input = document.getElementById('gen-input-field');
    if(input) input.type = 'number';
}

// 2. 发送转账消息 (核心)
async function sendMoneyMessage(amount, desc = "转账") {
    // 扣款逻辑 (模拟)
    let balance = parseFloat(localStorage.getItem('wallet_balance') || '8848.00');
    if (balance < amount) {
        showToast("余额不足，交易驳回");
        return;
    }
    balance -= parseFloat(amount);
    localStorage.setItem('wallet_balance', balance.toFixed(2));
    
    // 刷新钱包余额显示 (如果在钱包页)
    if(typeof updateShopBalanceDisplay === 'function') updateShopBalanceDisplay();

    const msgId = Date.now().toString();
    const formattedAmount = parseFloat(amount).toFixed(2);
    
    // 构建卡片 HTML
    const html = getTransferCardHTML(formattedAmount, desc, false);

    // 上屏
    appendChatBubble('right', html, true, msgId, null, {
        isTransfer: true,
        amount: formattedAmount,
        desc: desc
    });

    // 存历史
    const history = await loadChatHistory(currentChatId);
    history.push({
        id: msgId,
        sender: 'right',
        text: `[转账] ¥${formattedAmount}`,
        htmlContent: html, // 直接存 HTML 方便回显
        isTransfer: true,
        amount: formattedAmount,
        timestamp: Date.now()
    });
    await saveChatHistory(currentChatId, history);
    
    updateChatLastMessage(currentChatId, `[转账] ¥${formattedAmount}`);
    showToast(`已转账 ¥${formattedAmount}`);
}

// ================== 生成 Ins 风转账卡片 ==================
function getTransferCardHTML(amount, desc, isReceived) {
    const receivedClass = isReceived ? 'received' : '';
    // 如果已收款，描述文字变一下
    const displayDesc = isReceived ? '已存入钱包' : (desc || '转账');
    
    return `
        <div class="msg-transfer-card ${receivedClass}" onclick="receiveMoney(this, ${amount})">
            <div class="trans-icon-area">
                <svg class="trans-svg" viewBox="0 0 24 24">
                    <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V8h16v10zm-2-6c0 1.1-.9 2-2 2h-2v2h-2v-2H8v-2h2v-2H8v-2h2v-2h2v2h2c1.1 0 2 .9 2 2v2zm-4 0h-2v2h2v-2zm0-4h-2v2h2V8z"/>
                </svg>
            </div>
            <div class="trans-info-area">
                <div class="trans-amount-text">¥ ${amount}</div>
                <div class="trans-desc-text">${displayDesc}</div>
            </div>
        </div>
    `;
}

// 4. 收款逻辑 (修复版：限制自己不能领)
function receiveMoney(el, amount) {
    // 1. 防止重复领取
    if (el.classList.contains('received')) return; 

    // 2. 🔴 判断是谁发的
    // 找到卡片的父级气泡，检查是否有 'right' 类名
    const chatMsg = el.closest('.chat-msg');
    if (chatMsg && chatMsg.classList.contains('right')) {
        showToast("这是你发出的红包，待对方领取");
        return; // ❌ 终止执行
    }

    // 播放音效 (可选)
    // new Audio('coin.mp3').play(); 

    el.classList.add('received');
    el.querySelector('.trans-desc-text').textContent = "已存入钱包";
    
    // 加余额
    let balance = parseFloat(localStorage.getItem('wallet_balance') || '0');
    balance += parseFloat(amount);
    localStorage.setItem('wallet_balance', balance.toFixed(2));
    
    showToast(`收款成功 +${amount}`);
}

// ================== 3. 收款逻辑 (终极交互版：变色+系统提示+存历史) ==================
window.receiveMoney = async function(el, amount) {
    // 1. 防止重复领取
    if (el.classList.contains('received')) return;

    // 2. 找到消息ID (用于更新历史记录)
    const msgNode = el.closest('.chat-msg');
    if (!msgNode) return;
    
    // 3. 判断是谁发的
    // 如果是 'right' (我发的)，禁止领取，并提示
    if (msgNode.classList.contains('right')) {
        showToast("这是你发出的红包，待对方领取");
        return;
    }

    // --- 执行收款动画 ---
    
    // A. 卡片视觉变化 (原地变灰)
    el.classList.add('received');
    const descEl = el.querySelector('.trans-desc-text');
    if (descEl) descEl.textContent = "已存入钱包";
    const iconEl = el.querySelector('.trans-svg');
    if (iconEl) iconEl.style.fill = "rgba(255,255,255,0.3)"; // 图标变暗

    // B. 钱包加钱
    let balance = parseFloat(localStorage.getItem('wallet_balance') || '0');
    balance += parseFloat(amount);
    localStorage.setItem('wallet_balance', balance.toFixed(2));
    if(typeof updateShopBalanceDisplay === 'function') updateShopBalanceDisplay();

    // C. 💥 关键：发送系统提示消息 (类似视频结束)
    const sysId = Date.now().toString();
    appendChatBubble('system', `你领取了 ¥${amount}`, true, sysId);
    
    // D. 💾 核心：更新数据库状态 (让刷新后也显示已领取)
    const msgIdRaw = msgNode.id.replace('msg-node-', '');
    const history = await loadChatHistory(currentChatId);
    
    // 找到这条转账消息
    const targetMsg = history.find(m => String(m.id) === String(msgIdRaw));
    if (targetMsg && targetMsg.extraOptions) {
        targetMsg.extraOptions.isReceived = true; // 标记为已领取
        targetMsg.extraOptions.desc = "已存入钱包"; // 更新文案
    }
    
    // 把系统提示也存进去
    history.push({
        id: sysId,
        sender: 'system',
        text: `你领取了 ¥${amount}`,
        timestamp: Date.now()
    });

    await saveChatHistory(currentChatId, history);
    
    showToast(`💰 已收款 +${amount}`);
};

// ================== ❤️ 读心术功能逻辑 ==================

// 1. 打开心声弹窗 (点击菜单 Heart 触发)
async function openHeartModal() {
    toggleInputMenu(); // 关菜单

    if (!currentChatId) { showToast("请先进入聊天"); return; }

    const settings = JSON.parse(localStorage.getItem(`chat_settings_${currentChatId}`) || '{}');
    const charName = settings.charName || "对方";
    
    // 获取头像
    let avatarUrl = '';
    try {
        const blob = await dbHelper.get(`chat_avatar_${currentChatId}`);
        if(blob) avatarUrl = URL.createObjectURL(blob);
    } catch(e){}

    // 读取最新心声
    let mindText = localStorage.getItem(`latest_mind_${currentChatId}`);
    
    // 如果没有心声 (比如刚开始聊)，显示默认提示
    if (!mindText) {
        mindText = "（似乎在发呆，没有任何心事...）";
    }

    // 更新 UI
    document.getElementById('heart-target-name').textContent = charName;
    const avatarEl = document.getElementById('heart-target-avatar');
    if (avatarUrl) avatarEl.style.backgroundImage = `url(${avatarUrl})`;
    
    // 模拟打字机效果显示文字
    const textEl = document.getElementById('heart-content-text');
    textEl.textContent = '';
    typewriterEffect(textEl, mindText);

    // 打开弹窗
    openModal('modal-heart-link');
}

// 2. 打字机特效 helper
function typewriterEffect(el, text, speed = 50) {
    let i = 0;
    el.textContent = '';
    function type() {
        if (i < text.length) {
            el.textContent += text.charAt(i);
            i++;
            setTimeout(type, speed);
        }
    }
    type();
}
</script>
</body>
</html>
